<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>捐款專區</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
    body {
        font-family: 'Noto Sans TC', sans-serif;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    .donation-card {
        border: none;
        border-radius: 25px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 20px;
    }
    .amount-btn {
        border: 2px solid #28a745;
        border-radius: 20px;
        padding: 20px;
        margin: 10px;
        background: white;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .amount-btn:hover, .amount-btn.selected {
        background: #28a745;
        color: white;
        transform: translateY(-3px);
    }
    .custom-amount {
        border: 2px solid #28a745;
        border-radius: 15px;
        padding: 15px;
        font-size: 18px;
        text-align: center;
    }
    .donation-history {
        max-height: 400px;
        overflow-y: auto;
    }
    .history-item {
        border-left: 4px solid #28a745;
        padding: 15px;
        margin-bottom: 10px;
        background: white;
        border-radius: 0 15px 15px 0;
    }
    .alert {
        border-radius: 15px;
        margin-bottom: 20px;
    }
</style>
</head>
<body>
<div class="container" style="max-width: 500px;">
    <!-- 錯誤/成功訊息 -->
    <div id="errorAlert" class="alert alert-danger" style="display: none;">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span id="errorMessage"></span>
    </div>
    
    <div id="successAlert" class="alert alert-success" style="display: none;">
        <i class="bi bi-check-circle me-2"></i>
        <span id="successMessage"></span>
    </div>

    <!-- 捐款表單 -->
    <div class="card donation-card">
        <div class="card-header text-center" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 25px;">
            <h3><i class="bi bi-heart-fill me-2"></i>愛心捐款</h3>
            <p class="mb-0">支持帕金森病友權益促進</p>
        </div>
        <div class="card-body p-4">
            <form id="donationForm">
                <div class="mb-4">
                    <label class="form-label fw-bold">選擇捐款金額：</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="amount-btn text-center" data-amount="500">
                                <h4>$500</h4>
                                <small>支持活動</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="amount-btn text-center" data-amount="1000">
                                <h4>$1,000</h4>
                                <small>年費會員</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="amount-btn text-center" data-amount="2000">
                                <h4>$2,000</h4>
                                <small>贊助會員</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="amount-btn text-center" data-amount="5000">
                                <h4>$5,000</h4>
                                <small>榮譽會員</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <input type="number" class="form-control custom-amount" id="customAmount" placeholder="或輸入其他金額" min="100">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">捐款類型：</label>
                    <select class="form-select" id="donationType" required>
                        <option value="">請選擇</option>
                        <option value="一般捐款">一般捐款</option>
                        <option value="會費">會費</option>
                        <option value="活動贊助">活動贊助</option>
                        <option value="設備捐贈">設備捐贈</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">付款方式：</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="bankTransfer" value="銀行轉帳" checked>
                                <label class="form-check-label" for="bankTransfer">
                                    <i class="bi bi-bank me-1"></i>銀行轉帳
                                </label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="linePay" value="LINE Pay">
                                <label class="form-check-label" for="linePay">
                                    <i class="bi bi-credit-card me-1"></i>LINE Pay
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">備註：</label>
                    <textarea class="form-control" id="donationNote" rows="3" placeholder="感謝您的愛心支持"></textarea>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>轉帳資訊：</strong><br>
                    第一銀行三重埔分行 (007)<br>
                    帳號：21110150402<br>
                    戶名：社團法人台灣帕金森病友權益促進會
                </div>
                
                <button type="submit" class="btn btn-success w-100 py-3" style="border-radius: 15px; font-size: 18px;">
                    <i class="bi bi-heart-fill me-2"></i>確認捐款
                </button>
            </form>
        </div>
    </div>
    
    <!-- 捐款紀錄 -->
    <div class="card donation-card">
        <div class="card-header" style="background: #f8f9fa;">
            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>我的捐款紀錄</h5>
        </div>
        <div class="card-body donation-history" id="donationHistory">
            <div class="text-center p-4">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">載入中...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let userId = null;
    let selectedAmount = 0;
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxZJIhCIgLvckUFDntuvI9eplWHH3aJNTsqCRLTpUgk6dN8cV3HBuZWB_BrgtG12N-X2A/exec';
    
    // 初始化 LIFF
    liff.init({ liffId: '1656516134-X9oq92g9' }).then(() => {
        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }
        
        liff.getProfile().then(profile => {
            userId = profile.userId;
            loadDonationHistory();
        }).catch(err => {
            console.error('取得用戶資料失敗:', err);
            showError('無法取得用戶資料，請重新開啟頁面');
        });
    }).catch(err => {
        console.error('LIFF初始化失敗:', err);
        showError('系統初始化失敗，請重新開啟頁面');
    });
    
    // 金額選擇
    document.querySelectorAll('.amount-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedAmount = parseInt(btn.dataset.amount);
            document.getElementById('customAmount').value = '';
        });
    });
    
    // 自訂金額
    document.getElementById('customAmount').addEventListener('input', (e) => {
        if (e.target.value) {
            document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
            selectedAmount = parseInt(e.target.value) || 0;
        }
    });
    
    // 載入捐款紀錄
    async function loadDonationHistory() {
        try {
            const response = await fetch(`${GAS_URL}?action=getDonations&userId=${encodeURIComponent(userId)}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            const historyDiv = document.getElementById('donationHistory');
            
            if (!result.success || result.data.length === 0) {
                historyDiv.innerHTML = `
                    <div class="text-center p-4 text-muted">
                        <i class="bi bi-inbox" style="font-size: 48px;"></i>
                        <p class="mt-2">尚無捐款紀錄</p>
                    </div>
                `;
            } else {
                historyDiv.innerHTML = result.data.map(donation => `
                    <div class="history-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${donation.捐款類型}</h6>
                                <small class="text-muted">${formatDate(donation.捐款時間)}</small>
                            </div>
                            <div class="text-end">
                                <h5 class="text-success mb-0">$${donation.捐款金額.toLocaleString()}</h5>
                                <small class="text-muted">${donation.付款方式}</small>
                            </div>
                        </div>
                        ${donation.備註 ? `<p class="mt-2 mb-0 small">${donation.備註}</p>` : ''}
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('載入捐款紀錄失敗:', error);
            document.getElementById('donationHistory').innerHTML = `
                <div class="text-center p-4 text-danger">
                    <i class="bi bi-exclamation-triangle" style="font-size: 48px;"></i>
                    <p class="mt-2">載入捐款紀錄失敗</p>
                </div>
            `;
        }
    }
    
    // 提交捐款
    document.getElementById('donationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const amount = selectedAmount || parseInt(document.getElementById('customAmount').value);
        if (!amount || amount < 100) {
            showError('請選擇或輸入捐款金額（最少100元）');
            return;
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>處理中...';
        submitBtn.disabled = true;
        
        const donationData = {
            action: 'addDonation',
            userId: userId,
            amount: amount,
            type: document.getElementById('donationType').value,
            paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
            note: document.getElementById('donationNote').value
        };
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(donationData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('捐款登記成功！感謝您的愛心支持！');
                document.getElementById('donationForm').reset();
                document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
                selectedAmount = 0;
                loadDonationHistory();
            } else {
                throw new Error(result.message || '登記失敗');
            }
        } catch (error) {
            console.error('捐款登記失敗:', error);
            showError(`登記失敗：${error.message}`);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW');
    }
    
    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorAlert').style.display = 'block';
        document.getElementById('successAlert').style.display = 'none';
        
        setTimeout(() => {
            document.getElementById('errorAlert').style.display = 'none';
        }, 5000);
    }
    
    function showSuccess(message) {
        document.getElementById('successMessage').textContent = message;
        document.getElementById('successAlert').style.display = 'block';
        document.getElementById('errorAlert').style.display = 'none';
        
        setTimeout(() => {
            document.getElementById('successAlert').style.display = 'none';
        }, 3000);
    }
</script>
</body>
</html>
