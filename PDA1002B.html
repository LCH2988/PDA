<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>帕金森病友會後台管理</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    :root {
      --primary-color: #4a90e2;
      --secondary-color: #50c878;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --light-bg: #f8f9fa;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f3f6fb;
      min-height: 100vh;
    }
    .navbar {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    }
    .navbar-brand, .nav-link, .navbar .btn {
      color: #fff !important;
    }
    .main-container { max-width: 1100px; margin: 30px auto; padding: 0 15px; }
    .content-section { display: none; }
    .content-card {
      background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    }
    .table thead th { background: #f0f6ff; }
    .status-badge { padding: 6px 12px; border-radius: 20px; }
    .loading-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center; z-index: 9999;
    }
    .notification {
      position: fixed; top: 20px; right: 20px; z-index: 10000; min-width: 320px; animation: slideIn .3s ease-out;
    }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .empty-state { text-align: center; padding: 40px 20px; color: #6c757d; }
    .empty-state i { font-size: 64px; margin-bottom: 20px; opacity: 0.3; }
    .menu-link.active { font-weight: 600; text-decoration: underline; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="bi bi-shield-lock me-2"></i>後台管理</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMenu">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link menu-link active" href="#" onclick="showSection('dashboard', event)"><i class="bi bi-speedometer2 me-1"></i>儀表板</a></li>
          <li class="nav-item"><a class="nav-link menu-link" href="#" onclick="showSection('members', event)"><i class="bi bi-people me-1"></i>會員管理</a></li>
          <li class="nav-item"><a class="nav-link menu-link" href="#" onclick="showSection('activities', event)"><i class="bi bi-calendar-event me-1"></i>活動管理</a></li>
          <li class="nav-item"><a class="nav-link menu-link" href="#" onclick="showSection('volunteers', event)"><i class="bi bi-heart me-1"></i>志工管理</a></li>
          <li class="nav-item"><a class="nav-link menu-link" href="#" onclick="showSection('finance', event)"><i class="bi bi-wallet2 me-1"></i>財務管理</a></li>
          <li class="nav-item"><a class="nav-link menu-link" href="#" onclick="showSection('feedback', event)"><i class="bi bi-chat-dots me-1"></i>回饋總覽</a></li>
          <li class="nav-item"><a class="nav-link menu-link" href="#" onclick="showSection('system', event)"><i class="bi bi-gear me-1"></i>系統工具</a></li>
        </ul>
        <button class="btn btn-outline-light btn-sm" onclick="refreshAdminData()"><i class="bi bi-arrow-clockwise me-1"></i>重新整理</button>
      </div>
    </div>
  </nav>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="text-center text-white">
      <div class="spinner-border"></div>
      <div class="mt-3">載入中...</div>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer"></div>

  <div class="main-container">
    <!-- Dashboard Section -->
    <div id="dashboardSection" class="content-section" style="display:block;">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>總覽</h5>
          <small class="text-muted">僅管理員可見</small>
        </div>
        <div id="dashboardCards" class="row mt-3 g-3">
          <!-- Cards rendered by JS -->
        </div>
      </div>
      <div class="content-card">
        <h6 class="mb-3">最近交易</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>日期</th><th>類型</th><th>金額</th><th>分類</th><th>描述</th><th>會員</th><th>狀態</th>
              </tr>
            </thead>
            <tbody id="recentTransactionsTbody">
              <!-- Transactions rendered by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Members Section -->
    <div id="membersSection" class="content-section">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-people me-2"></i>會員管理</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-primary btn-sm" onclick="exportMembers()"><i class="bi bi-download me-1"></i>匯出 CSV</button>
            <button class="btn btn-outline-primary btn-sm" onclick="refreshAdminData()"><i class="bi bi-arrow-clockwise me-1"></i>重新整理</button>
          </div>
        </div>
        <div class="table-responsive mt-3">
          <table class="table">
            <thead><tr><th>姓名</th><th>LINE 名稱</th><th>會員類型</th><th>電話</th><th>Email</th><th>狀態</th><th>加入日期</th></tr></thead>
            <tbody id="membersTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Activities Section -->
    <div id="activitiesSection" class="content-section">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>活動管理</h5>
          <button class="btn btn-primary btn-sm" onclick="showCreateActivityModal()"><i class="bi bi-plus-circle me-1"></i>新增活動</button>
        </div>
        <div class="table-responsive mt-3">
          <table class="table">
            <thead><tr><th>標題</th><th>日期</th><th>地點</th><th>名額</th><th>狀態</th><th>操作</th></tr></thead>
            <tbody id="activitiesTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Volunteers Section -->
    <div id="volunteersSection" class="content-section">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-heart me-2"></i>志工管理</h5>
          <button class="btn btn-primary btn-sm" onclick="showCreateVolunteerModal()"><i class="bi bi-plus-circle me-1"></i>新增志工需求</button>
        </div>
        <div class="table-responsive mt-3">
          <table class="table">
            <thead><tr><th>標題</th><th>日期</th><th>需求人數</th><th>已報名</th><th>時數</th><th>狀態</th></tr></thead>
            <tbody id="volunteersTbody"></tbody>
          </table>
        </div>
        <div class="content-card mt-3">
          <h6 class="mb-3">志工記錄總覽</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead><tr><th>志工</th><th>需求標題</th><th>日期</th><th>時數</th><th>狀態</th></tr></thead>
              <tbody id="volunteerRecordsTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Finance Section -->
    <div id="financeSection" class="content-section">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-wallet2 me-2"></i>財務管理</h5>
          <small class="text-muted">審核支出、查看捐款</small>
        </div>
        <div class="row g-3 mt-1">
          <div class="col-md-6">
            <div class="content-card">
              <h6 class="mb-3">捐款列表</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead><tr><th>日期</th><th>會員</th><th>金額</th><th>分類</th><th>描述</th></tr></thead>
                  <tbody id="donationsTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="content-card">
              <h6 class="mb-3">待審核支出</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead><tr><th>日期</th><th>會員</th><th>金額</th><th>分類</th><th>描述</th><th>狀態</th><th>操作</th></tr></thead>
                  <tbody id="expensesTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Feedback Section -->
    <div id="feedbackSection" class="content-section">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-chat-dots me-2"></i>回饋總覽</h5>
          <button class="btn btn-outline-primary btn-sm" onclick="refreshAdminData()"><i class="bi bi-arrow-clockwise me-1"></i>重新整理</button>
        </div>
        <div class="table-responsive mt-3">
          <table class="table">
            <thead><tr><th>活動</th><th>會員</th><th>評分</th><th>意見</th><th>時間</th></tr></thead>
            <tbody id="feedbackTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- System Section -->
    <div id="systemSection" class="content-section">
      <div class="content-card">
        <h5 class="mb-3"><i class="bi bi-gear me-2"></i>系統工具</h5>
        <div class="d-flex gap-2">
          <button class="btn btn-primary" onclick="backupSystem()"><i class="bi bi-cloud-download me-1"></i>建立備份</button>
          <button class="btn btn-outline-primary" onclick="exportMembers()"><i class="bi bi-download me-1"></i>匯出會員 CSV</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity Modal -->
  <div class="modal fade" id="activityModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增活動</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="activityForm">
            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="activityTitle" placeholder="標題" required>
              <label>標題</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" id="activityDescription" placeholder="描述" style="height:100px"></textarea>
              <label>描述</label>
            </div>
            <div class="form-floating mb-3">
              <input type="date" class="form-control" id="activityDate" required>
              <label>日期</label>
            </div>
            <div class="form-floating mb-3">
              <input type="time" class="form-control" id="activityTime">
              <label>時間</label>
            </div>
            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="activityLocation" placeholder="地點">
              <label>地點</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="activityMaxParticipants" placeholder="名額" required min="1">
              <label>名額</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="activityFee" placeholder="費用" min="0">
              <label>費用</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary" onclick="createActivity()">建立</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Volunteer Modal -->
  <div class="modal fade" id="volunteerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增志工需求</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="volunteerForm">
            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="volTitle" placeholder="標題" required>
              <label>標題</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" id="volDescription" placeholder="描述" style="height:100px"></textarea>
              <label>描述</label>
            </div>
            <div class="form-floating mb-3">
              <input type="date" class="form-control" id="volDate" required>
              <label>日期</label>
            </div>
            <div class="form-floating mb-3">
              <input type="time" class="form-control" id="volTime">
              <label>時間</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="volNeedCount" placeholder="需求人數" required min="1">
              <label>需求人數</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="volHours" placeholder="時數" required min="1">
              <label>時數</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary" onclick="createVolunteerNeed()">建立</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 設定
    const CONFIG = {
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycbxuUV4oK258Pxr_rhu-SV9dveRng4CissASK38ff_zqGFIwdhGXHH13KtpVJQ20b-pCTQ/exec',
      API_KEY: 'AAbb8520258185202581',
      // 管理端通常不走 LIFF；請用管理員的 LineId 或在後端以 ADMIN_LINE_IDS 管控
      ADMIN_LINE_ID: 'U09b4c2535730fbb5643274ba1526ec9c'
    };

    let adminData = null;

    // 通用
    function showLoading(show = true) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }
    function showNotification(message, type = 'success') {
      const container = document.getElementById('notificationContainer');
      const cls = {
        success: 'bg-success', error: 'bg-danger', warning: 'bg-warning', info:'bg-info'
      }[type] || 'bg-info';
      const el = document.createElement('div');
      el.className = `notification alert ${cls} text-white alert-dismissible fade show`;
      el.innerHTML = `${message}<button class="btn-close btn-close-white" data-bs-dismiss="alert"></button>`;
      container.appendChild(el);
      setTimeout(() => el.remove(), 5000);
    }
    async function callAPI(action, data = {}) {
      const payload = {
        action,
        apiKey: CONFIG.API_KEY,
        timestamp: Date.now(),
        lineId: CONFIG.ADMIN_LINE_ID,
        ...data
      };
      const res = await fetch(CONFIG.API_BASE_URL, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
      });
      const json = await res.json();
      if (!json.success) throw new Error(json.message || '操作失敗');
      return json.data;
    }

    // 導航
    function showSection(sectionName, event) {
      document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
      document.getElementById(sectionName + 'Section').style.display = 'block';
      document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
      if (event && event.target) {
        event.target.closest('.menu-link').classList.add('active');
      }
      loadSectionData(sectionName);
    }

    async function loadSectionData(section) {
      switch (section) {
        case 'dashboard':
          renderDashboard();
          break;
        case 'members':
          renderMembers();
          break;
        case 'activities':
          renderActivities();
          break;
        case 'volunteers':
          renderVolunteers();
          break;
        case 'finance':
          renderFinance();
          break;
        case 'feedback':
          renderFeedback();
          break;
        case 'system':
          // no data render
          break;
      }
    }

    // 初始化
    window.addEventListener('load', async () => {
      try {
        showLoading(true);
        adminData = await callAPI('getAdminData');
        renderDashboard();
      } catch (e) {
        showNotification('載入後台資料失敗：' + e.message, 'error');
      } finally {
        showLoading(false);
      }
    });

    async function refreshAdminData() {
      try {
        showLoading(true);
        adminData = await callAPI('getAdminData');
        const activeLink = document.querySelector('.menu-link.active');
        const section = activeLink ? activeLink.textContent.trim() : '儀表板';
        const map = {
          '儀表板': 'dashboard',
          '會員管理': 'members',
          '活動管理': 'activities',
          '志工管理': 'volunteers',
          '財務管理': 'finance',
          '回饋總覽': 'feedback',
          '系統工具': 'system'
        };
        loadSectionData(map[section] || 'dashboard');
        showNotification('資料已更新', 'success');
      } catch (e) {
        showNotification('更新失敗：' + e.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // Dashboard
    function renderDashboard() {
      if (!adminData) return;
      const members = adminData.members || [];
      const activities = adminData.activities || [];
      const transactions = adminData.transactions || [];
      const donations = transactions.filter(t => t.type === '收入');
      const expenses = transactions.filter(t => t.type === '支出');

      const cards = [
        { icon: 'bi-people', label: '會員數', value: members.length, color: 'primary' },
        { icon: 'bi-calendar-event', label: '活動數', value: activities.length, color: 'success' },
        { icon: 'bi-currency-dollar', label: '捐款筆數', value: donations.length, color: 'warning' },
        { icon: 'bi-file-earmark-minus', label: '支出筆數', value: expenses.length, color: 'danger' }
      ];

      const container = document.getElementById('dashboardCards');
      container.innerHTML = cards.map(c => `
        <div class="col-6 col-md-3">
          <div class="content-card text-center">
            <div class="text-${c.color}"><i class="bi ${c.icon}" style="font-size:28px;"></i></div>
            <div class="h4 mt-2">${c.value}</div>
            <div class="text-muted small">${c.label}</div>
          </div>
        </div>
      `).join('');

      const tbody = document.getElementById('recentTransactionsTbody');
      tbody.innerHTML = transactions.slice(0, 20).map(t => `
        <tr>
          <td>${t.date ? new Date(t.date).toLocaleDateString('zh-TW') : '-'}</td>
          <td><span class="badge ${t.type === '收入' ? 'bg-success' : 'bg-danger'}">${t.type}</span></td>
          <td class="${t.type === '收入' ? 'text-success' : 'text-danger'}">${Number(t.amount||0).toLocaleString()}</td>
          <td>${t.category || '-'}</td>
          <td>${t.description || '-'}</td>
          <td>${t.lineId || '-'}</td>
          <td>${t.status || '-'}</td>
        </tr>
      `).join('') || '<tr><td colspan="7" class="text-center text-muted">目前沒有交易資料</td></tr>';
    }

    // Members
    function renderMembers() {
      const members = adminData?.members || [];
      const tbody = document.getElementById('membersTbody');
      if (members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">尚無會員資料</td></tr>';
        return;
      }
      tbody.innerHTML = members.map(m => `
        <tr>
          <td>${m.realName || '-'}</td>
          <td>${m.lineName || '-'}</td>
          <td>${m.memberType || '-'}</td>
          <td>${m.phone || '-'}</td>
          <td>${m.email || '-'}</td>
          <td>${m.status || '-'}</td>
          <td>${m.joinDate ? new Date(m.joinDate).toLocaleDateString('zh-TW') : '-'}</td>
        </tr>
      `).join('');
    }

    // Activities
    function renderActivities() {
      const activities = adminData?.activities || [];
      const tbody = document.getElementById('activitiesTbody');
      if (activities.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">尚無活動</td></tr>';
        return;
      }
      tbody.innerHTML = activities.map(a => `
        <tr>
          <td>${a.title || '-'}</td>
          <td>${a.date || '-'}</td>
          <td>${a.location || '-'}</td>
          <td>${Number(a.currentCount||0)}/${Number(a.maxParticipants||0)}</td>
          <td><span class="badge ${a.status === '開放報名' ? 'bg-success' : a.status === '已刪除' ? 'bg-secondary' : 'bg-warning'}">${a.status || '-'}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="showEditActivityModal('${a.id}')"><i class="bi bi-pencil"></i></button>
          </td>
        </tr>
      `).join('');
    }
    function showCreateActivityModal() {
      document.getElementById('activityForm').reset();
      new bootstrap.Modal(document.getElementById('activityModal')).show();
    }
    async function createActivity() {
      const form = document.getElementById('activityForm');
      if (!form.checkValidity()) { form.reportValidity(); return; }
      try {
        showLoading(true);
        await callAPI('createActivity', {
          title: document.getElementById('activityTitle').value,
          description: document.getElementById('activityDescription').value,
          date: document.getElementById('activityDate').value,
          time: document.getElementById('activityTime').value,
          location: document.getElementById('activityLocation').value,
          maxParticipants: document.getElementById('activityMaxParticipants').value,
          fee: document.getElementById('activityFee').value
        });
        showNotification('活動已建立', 'success');
        bootstrap.Modal.getInstance(document.getElementById('activityModal')).hide();
        await refreshAdminData();
      } catch (e) {
        showNotification(e.message, 'error');
      } finally {
        showLoading(false);
      }
    }
    function showEditActivityModal(activityId) {
      const a = (adminData?.activities || []).find(x => x.id === activityId);
      if (!a) return;
      // 重用建立 modal 作為簡易編輯
      document.getElementById('activityTitle').value = a.title || '';
      document.getElementById('activityDescription').value = a.description || '';
      document.getElementById('activityDate').value = a.date || '';
      document.getElementById('activityTime').value = a.time || '';
      document.getElementById('activityLocation').value = a.location || '';
      document.getElementById('activityMaxParticipants').value = a.maxParticipants || 0;
      document.getElementById('activityFee').value = a.fee || 0;
      new bootstrap.Modal(document.getElementById('activityModal')).show();
      // 將建立按鈕改為更新
      const footer = document.querySelector('#activityModal .modal-footer');
      const oldBtn = footer.querySelector('.btn-primary');
      oldBtn.innerText = '更新';
      oldBtn.onclick = async () => {
        try {
          showLoading(true);
          await callAPI('updateActivity', {
            activityId,
            title: document.getElementById('activityTitle').value,
            description: document.getElementById('activityDescription').value,
            date: document.getElementById('activityDate').value,
            time: document.getElementById('activityTime').value,
            location: document.getElementById('activityLocation').value,
            maxParticipants: document.getElementById('activityMaxParticipants').value,
            fee: document.getElementById('activityFee').value,
            status: a.status
          });
          showNotification('活動已更新', 'success');
          bootstrap.Modal.getInstance(document.getElementById('activityModal')).hide();
          await refreshAdminData();
        } catch (e) {
          showNotification(e.message, 'error');
        } finally {
          showLoading(false);
        }
      };
    }

    // Volunteers
    function renderVolunteers() {
      const volunteers = adminData?.volunteers || [];
      const records = adminData?.volunteerRecords || [];
      const vtBody = document.getElementById('volunteersTbody');
      const vrBody = document.getElementById('volunteerRecordsTbody');

      vtBody.innerHTML = volunteers.length ? volunteers.map(v => `
        <tr>
          <td>${v.title || '-'}</td>
          <td>${v.date || '-'}</td>
          <td>${Number(v.needCount||0)}</td>
          <td>${Number(v.currentCount||0)}</td>
          <td>${Number(v.hours||0)}</td>
          <td><span class="badge ${v.status === '開放報名' ? 'bg-success' : 'bg-secondary'}">${v.status || '-'}</span></td>
        </tr>
      `).join('') : '<tr><td colspan="6" class="text-center text-muted">尚無志工需求</td></tr>';

      vrBody.innerHTML = records.length ? records.map(r => `
        <tr>
          <td>${r.lineId || '-'}</td>
          <td>${r.title || '-'}</td>
          <td>${r.date || '-'}</td>
          <td>${Number(r.hours||0)}</td>
          <td><span class="badge ${
            r.status === '已完成' ? 'bg-success' :
            r.status === '已取消' ? 'bg-secondary' : 'bg-warning'
          }">${r.status || '-'}</span></td>
        </tr>
      `).join('') : '<tr><td colspan="5" class="text-center text-muted">尚無志工記錄</td></tr>';
    }
    function showCreateVolunteerModal() {
      document.getElementById('volunteerForm').reset();
      new bootstrap.Modal(document.getElementById('volunteerModal')).show();
    }
    async function createVolunteerNeed() {
      const form = document.getElementById('volunteerForm');
      if (!form.checkValidity()) { form.reportValidity(); return; }
      try {
        showLoading(true);
        await callAPI('createVolunteerNeed', {
          title: document.getElementById('volTitle').value,
          description: document.getElementById('volDescription').value,
          date: document.getElementById('volDate').value,
          time: document.getElementById('volTime').value,
          needCount: document.getElementById('volNeedCount').value,
          hours: document.getElementById('volHours').value
        });
        showNotification('志工需求已建立', 'success');
        bootstrap.Modal.getInstance(document.getElementById('volunteerModal')).hide();
        await refreshAdminData();
      } catch (e) {
        showNotification(e.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // Finance
    function renderFinance() {
      const transactions = adminData?.transactions || [];
      const donations = transactions.filter(t => t.type === '收入');
      const expenses = transactions.filter(t => t.type === '支出');

      const dBody = document.getElementById('donationsTbody');
      const eBody = document.getElementById('expensesTbody');

      dBody.innerHTML = donations.length ? donations.map(d => `
        <tr>
          <td>${d.date ? new Date(d.date).toLocaleDateString('zh-TW') : '-'}</td>
          <td>${d.lineId || '-'}</td>
          <td class="text-success">${Number(d.amount||0).toLocaleString()}</td>
          <td>${d.category || '-'}</td>
          <td>${d.description || '-'}</td>
        </tr>
      `).join('') : '<tr><td colspan="5" class="text-center text-muted">尚無捐款</td></tr>';

      eBody.innerHTML = expenses.length ? expenses.map(ex => `
        <tr>
          <td>${ex.date ? new Date(ex.date).toLocaleDateString('zh-TW') : '-'}</td>
          <td>${ex.lineId || '-'}</td>
          <td class="text-danger">${Number(ex.amount||0).toLocaleString()}</td>
          <td>${ex.category || '-'}</td>
          <td>${ex.description || '-'}</td>
          <td><span class="badge ${
            ex.status === '已核准' ? 'bg-success' :
            ex.status === '審核中' ? 'bg-warning' :
            ex.status === '已拒絕' ? 'bg-danger' : 'bg-secondary'
          }">${ex.status || '-'}</span></td>
          <td>
            ${
              ex.status === '審核中'
              ? `
                <button class="btn btn-sm btn-outline-success me-1" onclick="approveExpense('${ex.id}')"><i class="bi bi-check2"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="rejectExpense('${ex.id}')"><i class="bi bi-x"></i></button>
              `
              : '<span class="text-muted">—</span>'
            }
          </td>
        </tr>
      `).join('') : '<tr><td colspan="7" class="text-center text-muted">尚無支出</td></tr>';
    }
    async function approveExpense(expenseId) {
      if (!confirm('確定核准此支出？')) return;
      try {
        showLoading(true);
        await callAPI('approveExpense', { expenseId });
        showNotification('已核准支出', 'success');
        await refreshAdminData();
      } catch (e) {
        showNotification(e.message, 'error');
      } finally {
        showLoading(false);
      }
    }
    async function rejectExpense(expenseId) {
      if (!confirm('確定拒絕此支出？')) return;
      try {
        showLoading(true);
        await callAPI('rejectExpense', { expenseId });
        showNotification('已拒絕支出', 'success');
        await refreshAdminData();
      } catch (e) {
        showNotification(e.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // Feedback
    async function renderFeedback() {
      try {
        showLoading(true);
        const list = await callAPI('getAllFeedback');
        const tbody = document.getElementById('feedbackTbody');
        tbody.innerHTML = list.length ? list.map(f => `
          <tr>
            <td>${f.activityTitle || '-'}</td>
            <td>${f.lineId || '-'}</td>
            <td>${'⭐'.repeat(Number(f.rating||0))}</td>
            <td>${f.comment || '-'}</td>
            <td>${f.createdAt ? new Date(f.createdAt).toLocaleDateString('zh-TW') : '-'}</td>
          </tr>
        `).join('') : '<tr><td colspan="5" class="text-center text-muted">尚無回饋</td></tr>';
      } catch (e) {
        showNotification('載入回饋失敗：' + e.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // 系統工具
    async function exportMembers() {
      try {
        showLoading(true);
        const data = await callAPI('exportMembers');
        showNotification('匯出成功：' + (data?.fileUrl || ''), 'success');
        if (data?.fileUrl) window.open(data.fileUrl, '_blank');
      } catch (e) {
        showNotification('匯出失敗：' + e.message, 'error');
      } finally {
        showLoading(false);
      }
    }
    async function backupSystem() {
      try {
        showLoading(true);
        const data = await callAPI('backupSystem');
        showNotification('備份完成：' + (data?.name || ''), 'success');
      } catch (e) {
        showNotification('備份失敗：' + e.message, 'error');
      } finally {
        showLoading(false);
      }
    }
  </script>
</body>
</html>
