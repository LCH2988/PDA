<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友權益促進會 - 管理系統</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      color: #667eea;
      font-size: 24px;
    }
    
    .admin-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .admin-name {
      color: #666;
      font-size: 14px;
    }
    
    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .logout-btn:hover {
      background: #c82333;
    }
    
    .nav-tabs {
      background: white;
      padding: 15px 20px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .nav-tab {
      padding: 12px 25px;
      background: #f8f9fa;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      color: #666;
      transition: all 0.3s;
    }
    
    .nav-tab:hover {
      background: #e9ecef;
    }
    
    .nav-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .content-area {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      min-height: 500px;
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .stat-card h3 {
      font-size: 16px;
      margin-bottom: 10px;
      opacity: 0.9;
    }
    
    .stat-card .number {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-card .label {
      font-size: 14px;
      opacity: 0.8;
    }
    
    .section-title {
      font-size: 22px;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid #667eea;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background: #218838;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .data-table th {
      background: #f8f9fa;
      color: #333;
      font-weight: 600;
    }
    
    .data-table tr:hover {
      background: #f8f9fa;
    }
    
    .badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }
    
    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
    }
    
    .search-box {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }
    
    .search-box input {
      flex: 1;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    
    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      color: #333;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #999;
    }
    
    .close-modal:hover {
      color: #333;
    }
    
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .nav-tabs {
        overflow-x: auto;
      }
      
      .data-table {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🏥 帕金森病友權益促進會 - 管理系統</h1>
      <div class="admin-info">
        <span class="admin-name">👤 管理員：<span id="adminName">系統管理員</span></span>
        <button class="logout-btn" onclick="logout()">登出</button>
      </div>
    </div>
    
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showPage('dashboard')">📊 儀表板</button>
      <button class="nav-tab" onclick="showPage('members')">👥 會員管理</button>
      <button class="nav-tab" onclick="showPage('activities')">📅 活動管理</button>
      <button class="nav-tab" onclick="showPage('volunteers')">🤝 志工管理</button>
      <button class="nav-tab" onclick="showPage('donations')">💰 捐款管理</button>
      <button class="nav-tab" onclick="showPage('financial')">💳 財務管理</button>
      <button class="nav-tab" onclick="showPage('reports')">📈 報表分析</button>
    </div>
    
    <div class="content-area">
      <div id="dashboard" class="page active">
        <h2 class="section-title">系統概覽</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <h3>總會員數</h3>
            <div class="number" id="totalMembers">0</div>
            <div class="label">位會員</div>
          </div>
          <div class="stat-card">
            <h3>本月活動</h3>
            <div class="number" id="monthActivities">0</div>
            <div class="label">場活動</div>
          </div>
          <div class="stat-card">
            <h3>志工人數</h3>
            <div class="number" id="totalVolunteers">0</div>
            <div class="label">位志工</div>
          </div>
          <div class="stat-card">
            <h3>本月捐款</h3>
            <div class="number" id="monthDonations">$0</div>
            <div class="label">元</div>
          </div>
        </div>
        <h3 class="section-title">最新活動報名</h3>
        <div id="recentRegistrations"><div class="loading">載入中</div></div>
      </div>
      
      <div id="members" class="page">
        <h2 class="section-title">會員管理</h2>
        <div class="search-box">
          <input type="text" id="memberSearch" placeholder="搜尋會員（姓名、電話、編號）">
          <button class="btn btn-primary" onclick="searchMembers()">🔍 搜尋</button>
          <button class="btn btn-success" onclick="showAddMemberModal()">➕ 新增會員</button>
        </div>
        <div id="membersList"><div class="loading">載入中</div></div>
      </div>
      
      <div id="activities" class="page">
        <h2 class="section-title">活動管理</h2>
        <button class="btn btn-success" onclick="showAddActivityModal()" style="margin-bottom: 20px;">➕ 新增活動</button>
        <div id="activitiesList"><div class="loading">載入中</div></div>
      </div>
      
      <div id="volunteers" class="page">
        <h2 class="section-title">志工管理</h2>
        <div class="search-box">
          <input type="text" id="volunteerSearch" placeholder="搜尋志工">
          <button class="btn btn-primary" onclick="searchVolunteers()">🔍 搜尋</button>
        </div>
        <div id="volunteersList"><div class="loading">載入中</div></div>
      </div>
      
      <div id="donations" class="page">
        <h2 class="section-title">捐款管理</h2>
        <button class="btn btn-success" onclick="showAddDonationModal()" style="margin-bottom: 20px;">➕ 新增捐款紀錄</button>
        <div id="donationsList"><div class="loading">載入中</div></div>
      </div>
      
      <div id="financial" class="page">
        <h2 class="section-title">財務管理</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
          <button class="btn btn-success" onclick="showAddIncomeModal()">➕ 新增收入</button>
          <button class="btn btn-danger" onclick="showAddExpenseModal()">➕ 新增支出</button>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <h3>總收入</h3>
            <div class="number" id="totalIncome">$0</div>
          </div>
          <div class="stat-card">
            <h3>總支出</h3>
            <div class="number" id="totalExpense">$0</div>
          </div>
          <div class="stat-card">
            <h3>結餘</h3>
            <div class="number" id="balance">$0</div>
          </div>
        </div>
        <h3 class="section-title">收支明細</h3>
        <div id="financialList"><div class="loading">載入中</div></div>
      </div>
      
      <div id="reports" class="page">
        <h2 class="section-title">報表分析</h2>
        <div class="form-row" style="margin-bottom: 20px;">
          <div class="form-group">
            <label>報表類型</label>
            <select id="reportType">
              <option value="member">會員統計</option>
              <option value="activity">活動統計</option>
              <option value="donation">捐款統計</option>
              <option value="financial">財務統計</option>
            </select>
          </div>
          <div class="form-group">
            <label>時間範圍</label>
            <select id="reportPeriod">
              <option value="month">本月</option>
              <option value="quarter">本季</option>
              <option value="year">本年</option>
              <option value="all">全部</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary" onclick="generateReport()">📊 產生報表</button>
        <button class="btn btn-secondary" onclick="exportReport()">📥 匯出報表</button>
        <div id="reportContent" style="margin-top: 30px;">
          <p style="text-align: center; color: #999;">請選擇報表類型並產生報表</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modals -->
  <div id="addMemberModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>新增會員</h2>
        <button class="close-modal" onclick="closeModal('addMemberModal')">&times;</button>
      </div>
      <form id="addMemberForm" onsubmit="addMember(event)">
        <div class="form-group">
          <label>姓名 *</label>
          <input type="text" id="newMemberName" required>
        </div>
        <div class="form-group">
          <label>電話 *</label>
          <input type="tel" id="newMemberPhone" required>
        </div>
        <div class="form-group">
          <label>電子郵件</label>
          <input type="email" id="newMemberEmail">
        </div>
        <div class="form-group">
          <label>地址</label>
          <input type="text" id="newMemberAddress">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>緊急聯絡人</label>
            <input type="text" id="newMemberEmergencyContact">
          </div>
          <div class="form-group">
            <label>緊急聯絡電話</label>
            <input type="tel" id="newMemberEmergencyPhone">
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="submit" class="btn btn-primary">✓ 新增</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('addMemberModal')">取消</button>
        </div>
      </form>
    </div>
  </div>
  
  <div id="addActivityModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>新增活動</h2>
        <button class="close-modal" onclick="closeModal('addActivityModal')">&times;</button>
      </div>
      <form id="addActivityForm" onsubmit="addActivity(event)">
        <div class="form-group">
          <label>活動名稱 *</label>
          <input type="text" id="newActivityName" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>活動日期 *</label>
            <input type="date" id="newActivityDate" required>
          </div>
          <div class="form-group">
            <label>活動時間 *</label>
            <input type="time" id="newActivityTime" required>
          </div>
        </div>
        <div class="form-group">
          <label>活動地點 *</label>
          <input type="text" id="newActivityLocation" required>
        </div>
        <div class="form-group">
          <label>活動說明</label>
          <textarea id="newActivityDescription"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>人數上限</label>
            <input type="number" id="newActivityMaxParticipants" value="50">
          </div>
          <div class="form-group">
            <label>報名截止日</label>
            <input type="date" id="newActivityDeadline">
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="submit" class="btn btn-primary">✓ 新增</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('addActivityModal')">取消</button>
        </div>
      </form>
    </div>
  </div>
  
  <div id="addIncomeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>新增收入</h2>
        <button class="close-modal" onclick="closeModal('addIncomeModal')">&times;</button>
      </div>
      <form id="addIncomeForm" onsubmit="addIncome(event)">
        <div class="form-group">
          <label>收入項目 *</label>
          <input type="text" id="newIncomeItem" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>金額 *</label>
            <input type="number" id="newIncomeAmount" required>
          </div>
          <div class="form-group">
            <label>日期 *</label>
            <input type="date" id="newIncomeDate" required>
          </div>
        </div>
        <div class="form-group">
          <label>收入來源</label>
          <input type="text" id="newIncomeSource">
        </div>
        <div class="form-group">
          <label>經手人</label>
          <input type="text" id="newIncomeHandler">
        </div>
        <div class="form-group">
          <label>備註</label>
          <textarea id="newIncomeNote"></textarea>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="submit" class="btn btn-primary">✓ 新增</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('addIncomeModal')">取消</button>
        </div>
      </form>
    </div>
  </div>
  
  <div id="addExpenseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>新增支出</h2>
        <button class="close-modal" onclick="closeModal('addExpenseModal')">&times;</button>
      </div>
      <form id="addExpenseForm" onsubmit="addExpense(event)">
        <div class="form-group">
          <label>支出項目 *</label>
          <input type="text" id="newExpenseItem" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>金額 *</label>
            <input type="number" id="newExpenseAmount" required>
          </div>
          <div class="form-group">
            <label>日期 *</label>
            <input type="date" id="newExpenseDate" required>
          </div>
        </div>
        <div class="form-group">
          <label>支出對象</label>
          <input type="text" id="newExpenseRecipient">
        </div>
        <div class="form-group">
          <label>經手人</label>
          <input type="text" id="newExpenseHandler">
        </div>
        <div class="form-group">
          <label>備註</label>
          <textarea id="newExpenseNote"></textarea>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="submit" class="btn btn-primary">✓ 新增</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('addExpenseModal')">取消</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwEbScN-r1UVwppUwbTwULuq6M1Vm2eko4EkCZpD_CCI8WkTInQk5O752ENwRTIchj70Q/exec';
    let allMembers = [];
    let allActivities = [];
    
    window.onload = function() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('newActivityDate').value = today;
      document.getElementById('newActivityDeadline').value = today;
      document.getElementById('newIncomeDate').value = today;
      document.getElementById('newExpenseDate').value = today;
      loadDashboard();
    };
    
    async function callAPI(action, data) {
      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          body: JSON.stringify({ action, ...data })
        });
        return await response.json();
      } catch (error) {
        return { success: false, message: '系統錯誤: ' + error };
      }
    }
    
    function showPage(pageName) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.getElementById(pageName).classList.add('active');
      event.target.classList.add('active');
      
      switch(pageName) {
        case 'dashboard': loadDashboard(); break;
        case 'members': loadMembers(); break;
        case 'activities': loadActivities(); break;
        case 'volunteers': loadVolunteers(); break;
        case 'donations': loadDonations(); break;
        case 'financial': loadFinancial(); break;
      }
    }
    
    async function loadDashboard() {
      document.getElementById('totalMembers').textContent = '載入中...';
      // 實際載入邏輯
    }
    
    async function loadMembers() {
      const result = await callAPI('getMembers', {});
      if (result.success) {
        allMembers = result.members || [];
        displayMembers(allMembers);
      }
    }
    
    function displayMembers(members) {
      let html = '<table class="data-table"><thead><tr><th>會員編號</th><th>姓名</th><th>電話</th><th>電子郵件</th><th>會員類型</th><th>狀態</th><th>操作</th></tr></thead><tbody>';
      members.forEach(m => {
        html += `<tr>
          <td>${m.memberId}</td>
          <td>${m.name}</td>
          <td>${m.phone}</td>
          <td>${m.email || '-'}</td>
          <td>${m.memberType}</td>
          <td><span class="badge badge-success">${m.status}</span></td>
          <td><button class="action-btn btn-primary" onclick="viewMember('${m.memberId}')">檢視</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('membersList').innerHTML = html;
    }
    
    async function loadActivities() {
      const result = await callAPI('getActivities', { showAll: true });
      if (result.success) {
        allActivities = result.activities || [];
        displayActivities(allActivities);
      }
    }
    
    function displayActivities(activities) {
      let html = '<table class="data-table"><thead><tr><th>活動名稱</th><th>日期</th><th>時間</th><th>地點</th><th>人數</th><th>狀態</th><th>操作</th></tr></thead><tbody>';
      activities.forEach(a => {
        html += `<tr><td>${a.name}</td>
            <td>${a.date}</td>
            <td>${a.time}</td>
            <td>${a.location}</td>
            <td>${a.currentParticipants}/${a.maxParticipants}</td>
            <td><span class="badge badge-${a.status === '開放報名' ? 'success' : 'warning'}">${a.status}</span></td>
            <td>
              <button class="action-btn btn-primary" onclick="viewActivity('${a.activityId}')">檢視</button>
              <button class="action-btn btn-secondary" onclick="editActivity('${a.activityId}')">編輯</button>
            </td>
          </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('activitiesList').innerHTML = html;
      }
      
      async function loadVolunteers() {
        const result = await callAPI('getVolunteerRecords', {});
        if (result.success) {
          displayVolunteers(result.records || []);
        }
      }
      
      function displayVolunteers(volunteers) {
        let html = '<table class="data-table"><thead><tr><th>會員編號</th><th>活動名稱</th><th>日期</th><th>時數</th><th>服務內容</th><th>狀態</th></tr></thead><tbody>';
        volunteers.forEach(v => {
          html += `<tr>
            <td>${v.memberId}</td>
            <td>${v.activityName}</td>
            <td>${v.date}</td>
            <td>${v.hours}</td>
            <td>${v.content}</td>
            <td><span class="badge badge-info">${v.status}</span></td>
          </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('volunteersList').innerHTML = html;
      }
      
      async function loadDonations() {
        const result = await callAPI('getDonations', {});
        if (result.success) {
          displayDonations(result.donations || []);
        }
      }
      
      function displayDonations(donations) {
        let html = '<table class="data-table"><thead><tr><th>捐款編號</th><th>會員編號</th><th>日期</th><th>金額</th><th>方式</th><th>收據編號</th></tr></thead><tbody>';
        donations.forEach(d => {
          html += `<tr>
            <td>${d.donationId}</td>
            <td>${d.memberId}</td>
            <td>${d.date}</td>
            <td>$${d.amount.toLocaleString()}</td>
            <td>${d.method}</td>
            <td>${d.receiptNo}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('donationsList').innerHTML = html;
      }
      
      async function loadFinancial() {
        const result = await callAPI('getFinancialRecords', {});
        if (result.success) {
          const income = result.income || [];
          const expense = result.expense || [];
          
          const totalIncome = income.reduce((sum, i) => sum + Number(i.amount), 0);
          const totalExpense = expense.reduce((sum, e) => sum + Number(e.amount), 0);
          const balance = totalIncome - totalExpense;
          
          document.getElementById('totalIncome').textContent = '$' + totalIncome.toLocaleString();
          document.getElementById('totalExpense').textContent = '$' + totalExpense.toLocaleString();
          document.getElementById('balance').textContent = '$' + balance.toLocaleString();
          
          displayFinancial(income, expense);
        }
      }
      
      function displayFinancial(income, expense) {
        let html = '<h4>收入紀錄</h4><table class="data-table"><thead><tr><th>日期</th><th>項目</th><th>金額</th><th>來源</th><th>經手人</th></tr></thead><tbody>';
        income.forEach(i => {
          html += `<tr>
            <td>${i.date}</td>
            <td>${i.item}</td>
            <td class="text-success">+$${Number(i.amount).toLocaleString()}</td>
            <td>${i.source}</td>
            <td>${i.handler}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        
        html += '<h4 style="margin-top: 30px;">支出紀錄</h4><table class="data-table"><thead><tr><th>日期</th><th>項目</th><th>金額</th><th>對象</th><th>經手人</th></tr></thead><tbody>';
        expense.forEach(e => {
          html += `<tr>
            <td>${e.date}</td>
            <td>${e.item}</td>
            <td class="text-danger">-$${Number(e.amount).toLocaleString()}</td>
            <td>${e.recipient}</td>
            <td>${e.handler}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        
        document.getElementById('financialList').innerHTML = html;
      }
      
      function showAddMemberModal() {
        document.getElementById('addMemberModal').classList.add('active');
      }
      
      function showAddActivityModal() {
        document.getElementById('addActivityModal').classList.add('active');
      }
      
      function showAddIncomeModal() {
        document.getElementById('addIncomeModal').classList.add('active');
      }
      
      function showAddExpenseModal() {
        document.getElementById('addExpenseModal').classList.add('active');
      }
      
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
      }
      
      async function addMember(event) {
        event.preventDefault();
        const result = await callAPI('register', {
          name: document.getElementById('newMemberName').value,
          phone: document.getElementById('newMemberPhone').value,
          email: document.getElementById('newMemberEmail').value,
          address: document.getElementById('newMemberAddress').value,
          emergencyContact: document.getElementById('newMemberEmergencyContact').value,
          emergencyPhone: document.getElementById('newMemberEmergencyPhone').value,
          lineId: 'ADMIN_' + Date.now()
        });
        
        if (result.success) {
          alert('會員新增成功！');
          closeModal('addMemberModal');
          loadMembers();
          document.getElementById('addMemberForm').reset();
        } else {
          alert('新增失敗：' + result.message);
        }
      }
      
      async function addActivity(event) {
        event.preventDefault();
        const result = await callAPI('createActivity', {
          name: document.getElementById('newActivityName').value,
          date: document.getElementById('newActivityDate').value,
          time: document.getElementById('newActivityTime').value,
          location: document.getElementById('newActivityLocation').value,
          description: document.getElementById('newActivityDescription').value,
          maxParticipants: document.getElementById('newActivityMaxParticipants').value,
          deadline: document.getElementById('newActivityDeadline').value
        });
        
        if (result.success) {
          alert('活動新增成功！');
          closeModal('addActivityModal');
          loadActivities();
          document.getElementById('addActivityForm').reset();
        } else {
          alert('新增失敗：' + result.message);
        }
      }
      
      async function addIncome(event) {
        event.preventDefault();
        const result = await callAPI('addIncome', {
          item: document.getElementById('newIncomeItem').value,
          amount: document.getElementById('newIncomeAmount').value,
          date: document.getElementById('newIncomeDate').value,
          source: document.getElementById('newIncomeSource').value,
          handler: document.getElementById('newIncomeHandler').value,
          note: document.getElementById('newIncomeNote').value
        });
        
        if (result.success) {
          alert('收入紀錄新增成功！收據編號：' + result.receiptNo);
          closeModal('addIncomeModal');
          loadFinancial();
          document.getElementById('addIncomeForm').reset();
        } else {
          alert('新增失敗：' + result.message);
        }
      }
      
      async function addExpense(event) {
        event.preventDefault();
        const result = await callAPI('addExpense', {
          item: document.getElementById('newExpenseItem').value,
          amount: document.getElementById('newExpenseAmount').value,
          date: document.getElementById('newExpenseDate').value,
          recipient: document.getElementById('newExpenseRecipient').value,
          handler: document.getElementById('newExpenseHandler').value,
          note: document.getElementById('newExpenseNote').value
        });
        
        if (result.success) {
          alert('支出紀錄新增成功！憑證編號：' + result.voucherNo);
          closeModal('addExpenseModal');
          loadFinancial();
          document.getElementById('addExpenseForm').reset();
        } else {
          alert('新增失敗：' + result.message);
        }
      }
      
      function searchMembers() {
        const keyword = document.getElementById('memberSearch').value.toLowerCase();
        const filtered = allMembers.filter(m => 
          m.name.toLowerCase().includes(keyword) ||
          m.phone.includes(keyword) ||
          m.memberId.toLowerCase().includes(keyword)
        );
        displayMembers(filtered);
      }
      
      function searchVolunteers() {
        const keyword = document.getElementById('volunteerSearch').value.toLowerCase();
        // 實作搜尋邏輯
      }
      
      function viewMember(memberId) {
        alert('檢視會員：' + memberId);
        // 實作檢視會員詳細資料
      }
      
      function viewActivity(activityId) {
        alert('檢視活動：' + activityId);
        // 實作檢視活動詳細資料
      }
      
      function editActivity(activityId) {
        alert('編輯活動：' + activityId);
        // 實作編輯活動功能
      }
      
      function generateReport() {
        const reportType = document.getElementById('reportType').value;
        const reportPeriod = document.getElementById('reportPeriod').value;
        
        let html = '<div class="alert alert-info">正在產生報表...</div>';
        document.getElementById('reportContent').innerHTML = html;
        
        setTimeout(() => {
          html = `<h3>${getReportTitle(reportType)} - ${getPeriodTitle(reportPeriod)}</h3>`;
          html += '<div class="stats-grid">';
          html += '<div class="stat-card"><h3>統計項目1</h3><div class="number">123</div></div>';
          html += '<div class="stat-card"><h3>統計項目2</h3><div class="number">456</div></div>';
          html += '<div class="stat-card"><h3>統計項目3</h3><div class="number">789</div></div>';
          html += '</div>';
          document.getElementById('reportContent').innerHTML = html;
        }, 1000);
      }
      
      function getReportTitle(type) {
        const titles = {
          member: '會員統計報表',
          activity: '活動統計報表',
          donation: '捐款統計報表',
          financial: '財務統計報表'
        };
        return titles[type] || '統計報表';
      }
      
      function getPeriodTitle(period) {
        const titles = {
          month: '本月',
          quarter: '本季',
          year: '本年',
          all: '全部期間'
        };
        return titles[period] || '全部';
      }
      
      function exportReport() {
        alert('報表匯出功能開發中...');
        // 實作匯出為 Excel 或 PDF
      }
      
      function logout() {
        if (confirm('確定要登出嗎？')) {
          window.location.href = 'login.html';
        }
      }
    </script>
  </body>
  </html>

          
