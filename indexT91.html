<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿—å·¥å ±å - æ–°å¹´ç†±è¡€ä¸æ–·é›»</title>
  <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          background: linear-gradient(135deg, #DC143C, #FF6347);
          min-height: 100vh;
          padding: 20px;
          font-size: 16px;
      }
      .container {
          max-width: 900px;
          margin: 0 auto;
          background: white;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          overflow: hidden;
      }
      .header {
          background: linear-gradient(135deg, #DC143C, #FF4500);
          color: white;
          padding: 30px;
          text-align: center;
      }
      .header h1 {
          font-size: 2em;
          margin-bottom: 10px;
      }
      .header p {
          font-size: 1.2em;
          opacity: 0.9;
      }
      .status-info {
          background: #f0f8ff;
          padding: 15px;
          margin: 20px;
          border-radius: 10px;
          border-left: 5px solid #4169E1;
      }
      .status-success { border-left-color: #28a745; background: #d4edda; }
      .status-error { border-left-color: #dc3545; background: #f8d7da; }
      .status-warning { border-left-color: #FF8C00; background: #fff3cd; }
      
      /* ==================== å³æ™‚æ’ç­åå–®å€å¡Š ==================== */
      .schedule-status {
          background: linear-gradient(135deg, #f8f9fa, #e9ecef);
          padding: 25px;
          margin: 20px;
          border-radius: 15px;
          border: 3px solid #4169E1;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      }
      .schedule-status h3 {
          color: #DC143C;
          margin-bottom: 20px;
          font-size: 1.5em;
          text-align: center;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
      }
      .schedule-summary {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 15px;
          margin-bottom: 25px;
      }
      .summary-card {
          background: white;
          padding: 15px;
          border-radius: 10px;
          text-align: center;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          border-left: 4px solid #4169E1;
      }
      .summary-card.all-day { border-left-color: #FFD700; }
      .summary-card.morning { border-left-color: #FF6347; }
      .summary-card.afternoon { border-left-color: #4169E1; }
      .summary-card h4 {
          font-size: 0.9em;
          color: #666;
          margin-bottom: 8px;
      }
      .summary-card .count {
          font-size: 2em;
          font-weight: bold;
          color: #DC143C;
      }
      .summary-card .unlimited {
          font-size: 0.85em;
          color: #28a745;
          margin-top: 5px;
          font-weight: bold;
      }
      
      .schedule-tabs {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
          border-bottom: 2px solid #ddd;
      }
      .schedule-tab {
          flex: 1;
          padding: 12px;
          background: white;
          border: none;
          border-radius: 8px 8px 0 0;
          cursor: pointer;
          font-size: 1em;
          font-weight: bold;
          transition: all 0.3s;
          color: #666;
      }
      .schedule-tab:hover {
          background: #f0f0f0;
      }
      .schedule-tab.active {
          background: linear-gradient(135deg, #DC143C, #FF4500);
          color: white;
          border-bottom: 3px solid #DC143C;
      }
      .schedule-tab.all-day.active {
          background: linear-gradient(135deg, #FFD700, #FFA500);
      }
      .schedule-tab.morning.active {
          background: linear-gradient(135deg, #FF6347, #FF4500);
      }
      .schedule-tab.afternoon.active {
          background: linear-gradient(135deg, #4169E1, #1E90FF);
      }
      
      .schedule-content {
          display: none;
      }
      .schedule-content.active {
          display: block;
      }
      
      .volunteer-list {
          display: grid;
          gap: 8px;
      }
      .volunteer-item {
          display: flex;
          align-items: center;
          padding: 10px;
          background: white;
          border-radius: 8px;
          transition: all 0.3s;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      .volunteer-item:hover {
          background: #f0f8ff;
          transform: translateX(5px);
      }
      .volunteer-number {
          background: #DC143C;
          color: white;
          width: 30px;
          height: 30px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          font-size: 0.9em;
          margin-right: 12px;
      }
      .volunteer-info {
          flex: 1;
      }
      .volunteer-name {
          font-weight: bold;
          color: #333;
          margin-bottom: 3px;
      }
      .volunteer-details {
          font-size: 0.85em;
          color: #666;
      }
      .volunteer-badge {
          background: #FF8C00;
          color: white;
          padding: 3px 8px;
          border-radius: 5px;
          font-size: 0.75em;
          margin-left: 5px;
      }
      .volunteer-badge.lunch-meat { background: #dc3545; }
      .volunteer-badge.lunch-veg { background: #28a745; }
      
      .empty-shift {
          text-align: center;
          padding: 30px;
          color: #999;
          font-style: italic;
          background: white;
          border-radius: 10px;
      }
      
      .refresh-btn {
          background: linear-gradient(135deg, #4169E1, #1E90FF);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 0.9em;
          font-weight: bold;
          display: flex;
          align-items: center;
          gap: 8px;
          margin: 0 auto 15px;
          transition: all 0.3s;
      }
      .refresh-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(65,105,225,0.3);
      }
      .refresh-btn:disabled {
          background: #ccc;
          cursor: not-allowed;
          transform: none;
      }
      .refresh-icon {
          display: inline-block;
          transition: transform 0.5s;
      }
      .refresh-icon.spinning {
          animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
      }
      
      .toggle-schedule {
          background: linear-gradient(135deg, #6c757d, #495057);
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 10px;
          cursor: pointer;
          font-size: 1em;
          font-weight: bold;
          width: 100%;
          margin: 20px 0;
          transition: all 0.3s;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
      }
      .toggle-schedule:hover {
          background: linear-gradient(135deg, #495057, #343a40);
          transform: translateY(-2px);
      }
      .toggle-icon {
          transition: transform 0.3s;
      }
      .toggle-icon.expanded {
          transform: rotate(180deg);
      }
      
      /* ==================== åŸæœ‰æ¨£å¼ ==================== */
      .existing-registration {
          background: #fff3cd;
          border-left: 5px solid #FF8C00;
          padding: 20px;
          margin: 20px;
          border-radius: 10px;
      }
      .existing-registration h3 {
          color: #FF8C00;
          margin-bottom: 15px;
      }
      .existing-info {
          background: white;
          padding: 15px;
          border-radius: 8px;
          margin: 10px 0;
      }
      .existing-info p {
          margin: 8px 0;
          color: #333;
      }
      .existing-info strong {
          color: #DC143C;
      }
      .action-buttons {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
          margin-top: 15px;
      }
      .action-btn {
          padding: 12px;
          border: none;
          border-radius: 8px;
          font-size: 1em;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s;
      }
      .btn-edit {
          background: #FF8C00;
          color: white;
      }
      .btn-edit:hover {
          background: #FF6347;
      }
      .btn-cancel {
          background: #dc3545;
          color: white;
      }
      .btn-cancel:hover {
          background: #c82333;
      }
      
      .form-section { padding: 40px; }
      .info-box {
          background: #fff0f0;
          border-left: 5px solid #DC143C;
          padding: 20px;
          margin-bottom: 30px;
          border-radius: 8px;
      }
      .info-box h3 {
          color: #DC143C;
          margin-bottom: 15px;
      }
      .info-box ul {
          list-style: none;
          padding-left: 0;
      }
      .info-box li {
          padding: 8px 0;
          border-bottom: 1px solid #ffe4e4;
      }
      .info-box li:last-child {
          border-bottom: none;
      }
      .form-group { margin-bottom: 30px; }
      .form-group label {
          display: block;
          margin-bottom: 10px;
          font-weight: bold;
          color: #333;
          font-size: 1.1em;
      }
      .required { color: #DC143C; }
      input[type="text"], input[type="tel"], select, textarea {
          width: 100%;
          padding: 15px;
          border: 2px solid #ddd;
          border-radius: 10px;
          font-size: 1em;
          transition: border-color 0.3s;
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
      }
      input:focus, select:focus, textarea:focus {
          outline: none;
          border-color: #DC143C;
          box-shadow: 0 0 10px rgba(220,20,60,0.3);
      }
      
      .shift-grid {
          display: grid;
          grid-template-columns: 1fr;
          gap: 15px;
          margin-top: 15px;
      }
      .shift-category {
          border: 3px solid #ddd;
          border-radius: 15px;
          padding: 20px;
          background: #f8f9fa;
          transition: all 0.3s;
      }
      .shift-category:hover {
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      }
      .shift-category.all-day {
          background: linear-gradient(135deg, #fff8dc, #fffacd);
          border-color: #FFD700;
      }
      .shift-category.morning {
          background: linear-gradient(135deg, #fff0f0, #ffe4e4);
          border-color: #FF6347;
      }
      .shift-category.afternoon {
          background: linear-gradient(135deg, #f0f8ff, #e6f2ff);
          border-color: #4169E1;
      }
      .shift-category h4 {
          margin-bottom: 15px;
          color: #333;
          font-size: 1.3em;
          display: flex;
          align-items: center;
          gap: 10px;
      }
      .shift-option {
          background: white;
          border: 3px solid #ddd;
          border-radius: 12px;
          padding: 20px;
          cursor: pointer;
          transition: all 0.3s;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      .shift-option:hover {
          border-color: #DC143C;
          transform: translateX(5px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
      .shift-option.selected {
          background: linear-gradient(135deg, #DC143C, #FF4500);
          color: white;
          border-color: #DC143C;
          transform: translateX(5px) scale(1.02);
          box-shadow: 0 6px 20px rgba(220,20,60,0.3);
      }
      .shift-info {
          flex: 1;
      }
      .shift-info strong {
          font-size: 1.2em;
          display: block;
          margin-bottom: 5px;
      }
      .shift-info .shift-desc {
          font-size: 0.9em;
          margin-top: 5px;
          opacity: 0.8;
      }
      .shift-count {
          background: rgba(0,0,0,0.1);
          padding: 8px 15px;
          border-radius: 8px;
          font-size: 1em;
          font-weight: bold;
          min-width: 80px;
          text-align: center;
      }
      .shift-option.selected .shift-count {
          background: rgba(255,255,255,0.3);
      }
      .unlimited-badge {
          background: #28a745;
          color: white;
          padding: 5px 12px;
          border-radius: 20px;
          font-size: 0.85em;
          font-weight: bold;
      }
      
      .lunch-options {
          display: none;
          margin-top: 20px;
          padding: 20px;
          background: #fffaf0;
          border-radius: 10px;
          border: 2px solid #FFD700;
      }
      .lunch-options.show {
          display: block;
      }
      .lunch-options h4 {
          color: #FF8C00;
          margin-bottom: 15px;
      }
      .radio-group {
          display: flex;
          gap: 15px;
          flex-wrap: wrap;
      }
      .radio-option {
          flex: 1;
          min-width: 100px;
      }
      .radio-option input[type="radio"] {
          display: none;
      }
      .radio-option label {
          display: block;
          padding: 12px;
          background: white;
          border: 2px solid #ddd;
          border-radius: 8px;
          cursor: pointer;
          text-align: center;
          transition: all 0.3s;
          font-size: 0.95em;
      }
      .radio-option input[type="radio"]:checked + label {
          background: #DC143C;
          color: white;
          border-color: #DC143C;
      }
      
      .submit-btn {
          background: linear-gradient(135deg, #DC143C, #FF4500);
          color: #fff;
          padding: 18px 40px;
          border: none;
          border-radius: 12px;
          font-size: 1.3em;
          font-weight: bold;
          cursor: pointer;
          width: 100%;
          transition: all 0.3s;
          box-shadow: 0 5px 20px rgba(220,20,60,0.3);
          margin-top: 30px;
      }
      .submit-btn:hover {
          transform: translateY(-3px);
          box-shadow: 0 8px 25px rgba(220,20,60,0.4);
      }
      .submit-btn:disabled {
          background: #ccc;
          cursor: not-allowed;
          transform: none;
      }
      
      .modal {
          display: none;
          position: fixed;
          top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.6);
          z-index: 1000;
          align-items: center;
          justify-content: center;
      }
      .modal.show {
          display: flex;
      }
      .modal-content {
          background: white;
          padding: 40px;
          border-radius: 20px;
          text-align: center;
          max-width: 500px;
          width: 90%;
          animation: slideIn 0.3s ease;
      }
      @keyframes slideIn {
          from {
              transform: translateY(-50px);
              opacity: 0;
          }
          to {
              transform: translateY(0);
              opacity: 1;
          }
      }
      .success-icon {
          font-size: 4em;
          margin-bottom: 20px;
      }
      .success-icon.success { color: #28a745; }
      .success-icon.warning { color: #FF8C00; }
      .modal-content h3 {
          font-size: 1.8em;
          margin-bottom: 20px;
          color: #333;
      }
      .modal-content p {
          font-size: 1.1em;
          line-height: 1.6;
          margin-bottom: 15px;
          color: #666;
      }
      .modal-btn {
          margin-top: 25px;
          padding: 15px 40px;
          background: #DC143C;
          color: white;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          font-size: 1.2em;
          font-weight: bold;
          transition: all 0.3s;
      }
      .modal-btn:hover {
          background: #FF4500;
          transform: scale(1.05);
      }
      
      .loading {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid rgba(255, 255, 255, .3);
          border-radius: 50%;
          border-top-color: #fff;
          animation: spin 1s ease-in-out infinite;
          margin-left: 10px;
      }
      
      .hidden { display: none !important; }
      
      @media (max-width: 768px) {
          body { font-size: 14px; padding: 10px; }
          .header h1 { font-size: 1.5em; }
          .form-section { padding: 25px; }
          .radio-group {
              flex-direction: column;
          }
          .action-buttons {
              grid-template-columns: 1fr;
          }
          .schedule-summary {
              grid-template-columns: repeat(2, 1fr);
          }
          .schedule-tabs {
              flex-direction: column;
          }
          .schedule-tab {
              border-radius: 8px;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>ğŸ™‹ å¿—å·¥æ‹›å‹Ÿ</h1>
          <p>æ–°å¹´ç†±è¡€ä¸æ–·é›» æè¡€å…¬ç›Šæ´»å‹•</p>
      </div>

      <div id="liffStatus" class="status-info">
          <div>ğŸ”„ æ­£åœ¨åˆå§‹åŒ–...</div>
      </div>

      <!-- ==================== å³æ™‚æ’ç­åå–®å€å¡Š ==================== -->
      <div class="schedule-status" id="scheduleStatus">
          <h3>
              <span>ğŸ“Š å³æ™‚æ’ç­ç‹€æ…‹</span>
          </h3>
          
          <!-- çµ±è¨ˆæ‘˜è¦ -->
          <div class="schedule-summary">
              <div class="summary-card all-day">
                  <h4>ğŸŒŸ å…¨å¤©ç­</h4>
                  <div class="count" id="allDayCount">0</div>
                  <div class="unlimited">ä¸é™äººæ•¸</div>
              </div>
              <div class="summary-card morning">
                  <h4>â˜€ï¸ ä¸Šåˆç­</h4>
                  <div class="count" id="morningCount">0</div>
                  <div class="unlimited">ä¸é™äººæ•¸</div>
              </div>
              <div class="summary-card afternoon">
                  <h4>ğŸŒ™ ä¸‹åˆç­</h4>
                  <div class="count" id="afternoonCount">0</div>
                  <div class="unlimited">ä¸é™äººæ•¸</div>
              </div>
              <div class="summary-card">
                  <h4>ğŸ‘¥ ç¸½å¿—å·¥</h4>
                  <div class="count" id="totalCount">0</div>
                  <div class="unlimited">äºº</div>
              </div>
          </div>

          <button class="refresh-btn" onclick="refreshSchedule()" id="refreshBtn">
              <span class="refresh-icon" id="refreshIcon">ğŸ”„</span>
              <span>é‡æ–°æ•´ç†</span>
          </button>

          <!-- åˆ‡æ›æŒ‰éˆ• -->
          <button class="toggle-schedule" onclick="toggleScheduleDetail()">
              <span>æŸ¥çœ‹è©³ç´°åå–®</span>
              <span class="toggle-icon" id="toggleIcon">â–¼</span>
          </button>

          <!-- è©³ç´°æ’ç­å…§å®¹ -->
          <div id="scheduleDetail" class="hidden">
              <!-- åˆ†é æ¨™ç±¤ -->
              <div class="schedule-tabs">
                  <button class="schedule-tab all-day active" onclick="switchTab('allDay')">
                      ğŸŒŸ å…¨å¤©ç­
                  </button>
                  <button class="schedule-tab morning" onclick="switchTab('morning')">
                      â˜€ï¸ ä¸Šåˆç­
                  </button>
                  <button class="schedule-tab afternoon" onclick="switchTab('afternoon')">
                      ğŸŒ™ ä¸‹åˆç­
                  </button>
              </div>

              <!-- å…¨å¤©ç­å…§å®¹ -->
              <div class="schedule-content active" id="allDayContent">
                  <div id="allDayVolunteers">
                      <div class="empty-shift">è¼‰å…¥ä¸­...</div>
                  </div>
              </div>

              <!-- ä¸Šåˆç­å…§å®¹ -->
              <div class="schedule-content" id="morningContent">
                  <div id="morningVolunteers">
                      <div class="empty-shift">è¼‰å…¥ä¸­...</div>
                  </div>
              </div>

              <!-- ä¸‹åˆç­å…§å®¹ -->
              <div class="schedule-content" id="afternoonContent">
                  <div id="afternoonVolunteers">
                      <div class="empty-shift">è¼‰å…¥ä¸­...</div>
                  </div>
              </div>
          </div>
      </div>

      <!-- å·²å ±åæç¤ºå€ -->
      <div id="existingRegistration" class="existing-registration hidden">
          <h3>ğŸ“‹ æ‚¨å·²å®Œæˆå ±å</h3>
          <div class="existing-info">
              <p><strong>å§“åï¼š</strong><span id="existingName"></span></p>
              <p><strong>é›»è©±ï¼š</strong><span id="existingPhone"></span></p>
              <p><strong>å·¥ä½œç­æ¬¡ï¼š</strong><span id="existingShift"></span></p>
              <p><strong>åˆé¤éœ€æ±‚ï¼š</strong><span id="existingLunch"></span></p>
              <p><strong>å ±ååºè™Ÿï¼š</strong><span id="existingId"></span></p>
              <p><strong>å ±åæ™‚é–“ï¼š</strong><span id="existingTime"></span></p>
          </div>
          <div class="action-buttons">
              <button class="action-btn btn-edit" onclick="switchToEditMode()">âœï¸ ä¿®æ”¹æ’ç­</button>
              <button class="action-btn btn-cancel" onclick="confirmCancel()">âŒ å–æ¶ˆå ±å</button>
          </div>
      </div>

      <div class="form-section" id="formSection">
          <div class="info-box">
              <h3>ğŸ“… æ´»å‹•è³‡è¨Š</h3>
              <ul>
                  <li><strong>æ—¥æœŸï¼š</strong>2026å¹´3æœˆ21æ—¥ (å…­)</li>
                  <li><strong>æ™‚é–“ï¼š</strong>09:00ï½17:00</li>
                  <li><strong>ğŸŒŸ å…¨å¤©ç­ï¼š</strong>08:30ï½17:00 (å«åˆé¤)</li>
                  <li><strong>â˜€ï¸ ä¸Šåˆç­ï¼š</strong>08:30ï½13:00 (å«åˆé¤)</li>
                  <li><strong>ğŸŒ™ ä¸‹åˆç­ï¼š</strong>13:00ï½17:00 (å«é»å¿ƒ)</li>
                  <li><strong>âœ¨ ä¸é™äººæ•¸ï¼š</strong>æ­¡è¿è¸´èºå ±åï¼</li>
                  <li><strong>æ´»å‹•æ¬¡æ•¸ï¼š</strong>å¯è¨˜éŒ„ä¸¦ç´¯åŠ </li>
              </ul>
          </div>

          <form id="volunteerForm">
              <input type="hidden" id="formMode" value="new">
              <input type="hidden" id="existingRowIndex" value="">
              
              <div class="form-group">
                  <label for="name">å§“å <span class="required">*</span></label>
                  <input type="text" id="name" name="name" required placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
              </div>

              <div class="form-group">
                  <label for="phone">é›»è©± <span class="required">*</span></label>
                  <input type="tel" id="phone" name="phone" required pattern="09\d{8}" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ (09xxxxxxxx)">
              </div>

              <div class="form-group">
                  <label>å·¥ä½œç­æ¬¡ <span class="required">*</span></label>
                  
                  <div class="shift-grid">
                      <!-- å…¨å¤©ç­ -->
                      <div class="shift-category all-day">
                          <h4>
                              <span>ğŸŒŸ å…¨å¤©ç­</span>
                              <span class="unlimited-badge">ä¸é™äººæ•¸</span>
                          </h4>
                          <div class="shift-option" data-shift="å…¨å¤©ç­" onclick="selectShift(this)">
                              <div class="shift-info">
                                  <strong>08:30ï½17:00</strong>
                                  <div class="shift-desc">å”åŠ©æ´»å‹•å…¨ç¨‹é‹ä½œ â€¢ å«åˆé¤ä¾¿ç•¶</div>
                              </div>
                              <div class="shift-count" id="allDayShiftCount">0 äºº</div>
                          </div>
                      </div>

                      <!-- ä¸Šåˆç­ -->
                      <div class="shift-category morning">
                          <h4>
                              <span>â˜€ï¸ ä¸Šåˆç­</span>
                              <span class="unlimited-badge">ä¸é™äººæ•¸</span>
                          </h4>
                          <div class="shift-option" data-shift="ä¸Šåˆç­" onclick="selectShift(this)">
                              <div class="shift-info">
                                  <strong>08:30ï½13:00</strong>
                                  <div class="shift-desc">å”åŠ©ä¸Šåˆæ™‚æ®µæ´»å‹• â€¢ å«åˆé¤ä¾¿ç•¶</div>
                              </div>
                              <div class="shift-count" id="morningShiftCount">0 äºº</div>
                          </div>
                      </div>

                      <!-- ä¸‹åˆç­ -->
                      <div class="shift-category afternoon">
                          <h4>
                              <span>ğŸŒ™ ä¸‹åˆç­</span>
                              <span class="unlimited-badge">ä¸é™äººæ•¸</span>
                          </h4>
                          <div class="shift-option" data-shift="ä¸‹åˆç­" onclick="selectShift(this)">
                              <div class="shift-info">
                                  <strong>13:00ï½17:00</strong>
                                  <div class="shift-desc">å”åŠ©ä¸‹åˆæ™‚æ®µæ´»å‹• â€¢ å«é»å¿ƒé£²æ–™</div>
                              </div>
                              <div class="shift-count" id="afternoonShiftCount">0 äºº</div>
                          </div>
                      </div>
                  </div>
                  <input type="hidden" id="workShift" name="workShift" required>
              </div>

              <div class="form-group lunch-options" id="lunchOptions">
                  <h4>ğŸ± åˆé¤éœ€æ±‚ <span class="required">*</span></h4>
                  <div class="radio-group">
                      <div class="radio-option">
                          <input type="radio" id="lunch-meat" name="lunch" value="è‘·é£Ÿ">
                          <label for="lunch-meat">ğŸ– è‘·é£Ÿ</label>
                      </div>
                      <div class="radio-option">
                          <input type="radio" id="lunch-veg" name="lunch" value="ç´ é£Ÿ">
                          <label for="lunch-veg">ğŸ¥— ç´ é£Ÿ</label>
                      </div>
                      <div class="radio-option">
                          <input type="radio" id="lunch-self" name="lunch" value="è‡ªç†">
                          <label for="lunch-self">ğŸš« è‡ªç†</label>
                      </div>
                  </div>
              </div>

              <div class="form-group">
                  <label for="remarks">å‚™è¨»</label>
                  <textarea id="remarks" name="remarks" rows="4" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚æˆ–æƒ³èªªçš„è©±ï¼Œè«‹åœ¨æ­¤å¡«å¯«..."></textarea>
              </div>

              <button type="submit" class="submit-btn" id="submitBtn">
                  ğŸ™‹ ç¢ºèªå ±å
              </button>
          </form>
      </div>
  </div>

  <!-- æˆåŠŸè¨Šæ¯å½ˆçª— -->
  <div id="successModal" class="modal">
      <div class="modal-content">
          <div class="success-icon success" id="modalIcon">âœ…</div>
          <h3 id="modalTitle">å ±åæˆåŠŸï¼</h3>
          <p id="successMessage"></p>
          <button class="modal-btn" onclick="closeSuccessModal()">ç¢ºå®š</button>
      </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
      let liffReady = false;
      let isSubmitting = false;
      let userProfile = null;
      let selectedShift = '';
      let editMode = false;
      let existingData = null;
      let scheduleDetailExpanded = false;
      let currentTab = 'allDay';
      let allVolunteers = [];

      // âš ï¸ è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš›å€¼
      const liffId = "2007905012-NXJEXmda";
      const gasUrl = "https://script.google.com/macros/s/AKfycbwIntX3Zei_f45o8neaRPaNb63If5YKzjrZjgdtetxDuwq0mzSisckuYelVRQbKtJpUjg/exec";

      // ==================== å³æ™‚æ’ç­åŠŸèƒ½ ====================
      
      // åˆ‡æ›è©³ç´°åå–®é¡¯ç¤º
      function toggleScheduleDetail() {
          scheduleDetailExpanded = !scheduleDetailExpanded;
          const detail = document.getElementById('scheduleDetail');
          const icon = document.getElementById('toggleIcon');
          
          if (scheduleDetailExpanded) {
              detail.classList.remove('hidden');
              icon.classList.add('expanded');
              loadScheduleDetails();
          } else {
              detail.classList.add('hidden');
              icon.classList.remove('expanded');
          }
      }

      // åˆ‡æ›åˆ†é 
      function switchTab(tab) {
          currentTab = tab;
          
          // æ›´æ–°æ¨™ç±¤æ¨£å¼
          document.querySelectorAll('.schedule-tab').forEach(t => {
              t.classList.remove('active');
          });
          document.querySelector(`.schedule-tab.${tab}`).classList.add('active');
          
          // æ›´æ–°å…§å®¹é¡¯ç¤º
          document.querySelectorAll('.schedule-content').forEach(c => {
              c.classList.remove('active');
          });
          document.getElementById(`${tab}Content`).classList.add('active');
      }

      // é‡æ–°æ•´ç†æ’ç­
      async function refreshSchedule() {
          const btn = document.getElementById('refreshBtn');
          const icon = document.getElementById('refreshIcon');
          
          btn.disabled = true;
          icon.classList.add('spinning');
          
          try {
              await loadScheduleSummary();
              if (scheduleDetailExpanded) {
                  await loadScheduleDetails();
              }
          } catch (error) {
              console.error('é‡æ–°æ•´ç†å¤±æ•—:', error);
          } finally {
              btn.disabled = false;
              icon.classList.remove('spinning');
          }
      }

      // è¼‰å…¥æ’ç­æ‘˜è¦
      async function loadScheduleSummary() {
          try {
              const result = await callAPI({ action: 'getVolunteerList' });
              
              if (result.success) {
                  allVolunteers = result.volunteers || [];
                  
                  // çµ±è¨ˆå„é¡åˆ¥äººæ•¸
                  let allDayCount = 0;
                  let morningCount = 0;
                  let afternoonCount = 0;
                  
                  allVolunteers.forEach(v => {
                      if (v.workShift === 'å…¨å¤©ç­') {
                          allDayCount++;
                      } else if (v.workShift === 'ä¸Šåˆç­') {
                          morningCount++;
                      } else if (v.workShift === 'ä¸‹åˆç­') {
                          afternoonCount++;
                      }
                  });
                  
                  // æ›´æ–°é¡¯ç¤º
                  document.getElementById('allDayCount').textContent = allDayCount;
                  document.getElementById('morningCount').textContent = morningCount;
                  document.getElementById('afternoonCount').textContent = afternoonCount;
                  document.getElementById('totalCount').textContent = allVolunteers.length;
                  
                  // æ›´æ–°ç­æ¬¡é¸é …çš„äººæ•¸é¡¯ç¤º
                  document.getElementById('allDayShiftCount').textContent = allDayCount + ' äºº';
                  document.getElementById('morningShiftCount').textContent = morningCount + ' äºº';
                  document.getElementById('afternoonShiftCount').textContent = afternoonCount + ' äºº';
              }
          } catch (error) {
              console.error('è¼‰å…¥æ’ç­æ‘˜è¦éŒ¯èª¤:', error);
          }
      }

      // è¼‰å…¥è©³ç´°æ’ç­
      async function loadScheduleDetails() {
          try {
              // æŒ‰ç­æ¬¡åˆ†çµ„
              const allDayVols = allVolunteers.filter(v => v.workShift === 'å…¨å¤©ç­');
              const morningVols = allVolunteers.filter(v => v.workShift === 'ä¸Šåˆç­');
              const afternoonVols = allVolunteers.filter(v => v.workShift === 'ä¸‹åˆç­');
              
              // æ¸²æŸ“å„é¡åˆ¥
              renderVolunteerList('allDayVolunteers', allDayVols, 'ğŸŒŸ å…¨å¤©ç­');
              renderVolunteerList('morningVolunteers', morningVols, 'â˜€ï¸ ä¸Šåˆç­');
              renderVolunteerList('afternoonVolunteers', afternoonVols, 'ğŸŒ™ ä¸‹åˆç­');
              
          } catch (error) {
              console.error('è¼‰å…¥è©³ç´°æ’ç­éŒ¯èª¤:', error);
          }
      }

      // æ¸²æŸ“å¿—å·¥åˆ—è¡¨
      function renderVolunteerList(containerId, volunteers, title) {
          const container = document.getElementById(containerId);
          
          if (volunteers.length === 0) {
              container.innerHTML = `<div class="empty-shift">ç›®å‰ ${title} å°šç„¡å¿—å·¥å ±å</div>`;
              return;
          }
          
          let html = '<div class="volunteer-list">';
          
          volunteers.forEach((v, index) => {
              const lunchBadge = v.lunch && v.lunch !== 'ç„¡' 
                  ? `<span class="volunteer-badge lunch-${v.lunch === 'è‘·é£Ÿ' ? 'meat' : 'veg'}">${v.lunch}</span>`
                  : '';
              
              html += `
                  <div class="volunteer-item">
                      <div class="volunteer-number">${index + 1}</div>
                      <div class="volunteer-info">
                          <div class="volunteer-name">
                              ${v.name}
                              ${lunchBadge}
                          </div>
                          <div class="volunteer-details">
                              ${v.phone} â€¢ #V${v.registrationId}
                          </div>
                      </div>
                  </div>
              `;
          });
          
          html += '</div>';
          container.innerHTML = html;
      }

      // ==================== åŸæœ‰åŠŸèƒ½ ====================

      // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
      function updateStatus(message, type = 'info') {
          const statusDiv = document.getElementById('liffStatus');
          statusDiv.className = `status-info status-${type}`;
          statusDiv.innerHTML = `<div>${message}</div>`;
      }

      // é¸æ“‡ç­æ¬¡
      function selectShift(element) {
          const shift = element.getAttribute('data-shift');
          selectedShift = shift;
          document.getElementById('workShift').value = shift;

          document.querySelectorAll('.shift-option').forEach(option => {
              option.classList.remove('selected');
          });
          element.classList.add('selected');

          const lunchOptions = document.getElementById('lunchOptions');
          if (shift === 'å…¨å¤©ç­' || shift === 'ä¸Šåˆç­') {
              lunchOptions.classList.add('show');
              if (!document.querySelector('input[name="lunch"]:checked')) {
                  document.getElementById('lunch-meat').checked = true;
              }
          } else {
              lunchOptions.classList.remove('show');
              document.querySelectorAll('input[name="lunch"]').forEach(radio => {
                  radio.checked = false;
              });
          }
      }

      // æª¢æŸ¥æ˜¯å¦å·²å ±å
      async function checkExistingRegistration(userId) {
          try {
              const result = await callAPI({ 
                  action: 'getMyRegistration',
                  userId: userId
              });

              if (result.success && result.registered) {
                  existingData = result.data;
                  showExistingRegistration(result.data);
                  return true;
              }
              return false;
          } catch (error) {
              console.error('æª¢æŸ¥å ±åè¨˜éŒ„éŒ¯èª¤:', error);
              return false;
          }
      }

      // é¡¯ç¤ºå·²å ±åè³‡è¨Š
      function showExistingRegistration(data) {
          document.getElementById('existingName').textContent = data.name;
          document.getElementById('existingPhone').textContent = data.phone;
          document.getElementById('existingShift').textContent = data.workShift;
          document.getElementById('existingLunch').textContent = data.lunch || 'ç„¡';
          document.getElementById('existingId').textContent = '#V' + data.registrationId;
          document.getElementById('existingTime').textContent = data.registrationTime;

          document.getElementById('existingRegistration').classList.remove('hidden');
          document.getElementById('formSection').classList.add('hidden');
      }

      // åˆ‡æ›åˆ°ç·¨è¼¯æ¨¡å¼
      function switchToEditMode() {
          editMode = true;
          document.getElementById('formMode').value = 'edit';
          document.getElementById('existingRowIndex').value = existingData.rowIndex;

          document.getElementById('name').value = existingData.name;
          document.getElementById('phone').value = existingData.phone;
          document.getElementById('remarks').value = existingData.remarks || '';

          setTimeout(() => {
              const shiftElement = document.querySelector(`[data-shift="${existingData.workShift}"]`);
              if (shiftElement) {
                  selectShift(shiftElement);
              }

              if (existingData.lunch && existingData.lunch !== 'ç„¡') {
                  const lunchRadio = document.querySelector(`input[name="lunch"][value="${existingData.lunch}"]`);
                  if (lunchRadio) {
                      lunchRadio.checked = true;
                  }
              }
          }, 500);

          document.getElementById('existingRegistration').classList.add('hidden');
          document.getElementById('formSection').classList.remove('hidden');
          document.getElementById('submitBtn').innerHTML = 'âœï¸ ç¢ºèªä¿®æ”¹';

          updateStatus('âœï¸ ç·¨è¼¯æ¨¡å¼ï¼šä¿®æ”¹æ‚¨çš„æ’ç­è³‡è¨Š', 'warning');
      }

      // ç¢ºèªå–æ¶ˆå ±å
      function confirmCancel() {
          if (confirm('ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ\n\nå–æ¶ˆå¾Œéœ€è¦é‡æ–°å ±åæ‰èƒ½åƒåŠ æ´»å‹•ã€‚')) {
              cancelRegistration();
          }
      }

      // å–æ¶ˆå ±å
      async function cancelRegistration() {
          try {
              const submitBtn = document.querySelector('.btn-cancel');
              submitBtn.disabled = true;
              submitBtn.innerHTML = 'è™•ç†ä¸­...';

              const result = await callAPI({
                  type: 'cancel_volunteer',
                  userId: userProfile.userId
              });

              if (result.success) {
                  showModal('warning', 'å·²å–æ¶ˆå ±å', 'æ‚¨çš„å¿—å·¥å ±åå·²å–æ¶ˆ\n\næœŸå¾…ä¸‹æ¬¡å†è¦‹ï¼');
                  setTimeout(() => {
                      if (liff.isInClient()) {
                          liff.closeWindow();
                      }
                  }, 2000);
              } else {
                  alert('å–æ¶ˆå¤±æ•—ï¼š' + result.message);
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = 'âŒ å–æ¶ˆå ±å';
              }
          } catch (error) {
              console.error('å–æ¶ˆå ±åéŒ¯èª¤:', error);
              alert('å–æ¶ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
          }
      }

      // ä½¿ç”¨ JSONP å‘¼å« API
      function callAPI(params) {
          return new Promise((resolve, reject) => {
              const callbackName = 'jsonpCallback_' + Date.now();
              
              window[callbackName] = function(result) {
                  delete window[callbackName];
                  document.body.removeChild(script);
                  resolve(result);
              };

              const script = document.createElement('script');
              const urlParams = new URLSearchParams({
                  callback: callbackName,
                  ...params
              });
              script.src = `${gasUrl}?${urlParams.toString()}`;
              
              script.onerror = function() {
                  delete window[callbackName];
                  document.body.removeChild(script);
                  reject(new Error('ç¶²è·¯é€£ç·šå¤±æ•—'));
              };
              
              document.body.appendChild(script);
          });
      }

      // é¡¯ç¤ºå½ˆçª—
      function showModal(type, title, message) {
          const icon = document.getElementById('modalIcon');
          icon.className = 'success-icon ' + type;
          icon.textContent = type === 'success' ? 'âœ…' : 'âš ï¸';
          
          document.getElementById('modalTitle').textContent = title;
          document.getElementById('successMessage').innerHTML = message.replace(/\n/g, '<br>');
          document.getElementById('successModal').classList.add('show');
      }

      // LIFF åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function() {
          console.log('é–‹å§‹åˆå§‹åŒ– LIFF...');
          
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.get('mode') === 'edit') {
              editMode = true;
          }
          
          liff.init({ liffId: liffId })
              .then(() => {
                  liffReady = true;
                  console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');
                  updateStatus('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ', 'success');

                  if (liff.isLoggedIn()) {
                      return liff.getProfile();
                  } else {
                      liff.login();
                      return null;
                  }
              })
              .then(async (profile) => {
                  if (profile) {
                      userProfile = profile;
                      console.log('ç”¨æˆ¶è³‡æ–™:', profile);
                      updateStatus(`âœ… ä½¿ç”¨è€…ï¼š${profile.displayName}`, 'success');
                      
                      document.getElementById('name').value = profile.displayName;

                      // è¼‰å…¥æ’ç­æ‘˜è¦
                      await loadScheduleSummary();

                      // æª¢æŸ¥æ˜¯å¦å·²å ±å
                      const hasRegistered = await checkExistingRegistration(profile.userId);
                      
                      if (!hasRegistered) {
                          updateStatus('âœ… è«‹é¸æ“‡ç­æ¬¡ä¸¦å¡«å¯«å ±åè³‡æ–™', 'success');
                      }
                  }
              })
              .catch((err) => {
                  console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', err);
                  updateStatus('âŒ LIFF åˆå§‹åŒ–å¤±æ•—: ' + err.message, 'error');
              });

          // è¡¨å–®æäº¤
          document.getElementById('volunteerForm').addEventListener('submit', async function(e) {
              e.preventDefault();

              if (isSubmitting) {
                  return;
              }

              if (!selectedShift) {
                  alert('è«‹é¸æ“‡å·¥ä½œç­æ¬¡');
                  return;
              }

              if (selectedShift === 'å…¨å¤©ç­' || selectedShift === 'ä¸Šåˆç­') {
                  const lunchSelected = document.querySelector('input[name="lunch"]:checked');
                  if (!lunchSelected) {
                      alert('è«‹é¸æ“‡åˆé¤éœ€æ±‚');
                      return;
                  }
              }

              isSubmitting = true;
              const submitBtn = document.getElementById('submitBtn');
              submitBtn.disabled = true;
              submitBtn.innerHTML = (editMode ? 'ä¿®æ”¹ä¸­...' : 'å ±åä¸­...') + ' <span class="loading"></span>';

              try {
                  const formData = {
                      type: editMode ? 'update_volunteer' : 'blood_volunteer',
                      userId: userProfile?.userId || '',
                      name: document.getElementById('name').value.trim(),
                      phone: document.getElementById('phone').value.trim(),
                      workShift: selectedShift,
                      lunch: document.querySelector('input[name="lunch"]:checked')?.value || 'ç„¡',
                      remarks: document.getElementById('remarks').value.trim(),
                      liffUserId: userProfile?.userId || '',
                      liffDisplayName: userProfile?.displayName || '',
                      timestamp: new Date().toLocaleString('zh-TW')
                  };

                  console.log('æº–å‚™ç™¼é€è³‡æ–™:', formData);

                  const result = await callAPI(formData);
                  console.log('æ”¶åˆ°å›æ‡‰:', result);

                  if (result.success) {
                      const shiftTime = selectedShift === 'å…¨å¤©ç­' ? '08:30ï½17:00' : 
                                      selectedShift === 'ä¸Šåˆç­' ? '08:30ï½13:00' : '13:00ï½17:00';
                      
                      const message = editMode 
                          ? `<strong>ğŸ‘¤ ${formData.name}</strong><br>âœ… æ’ç­è³‡æ–™å·²æ›´æ–°<br><br>â° ${formData.workShift} (${shiftTime})<br>${formData.lunch !== 'ç„¡' ? `ğŸ± åˆé¤ï¼š${formData.lunch}<br>` : ''}<br>æ„Ÿè¬æ‚¨çš„é…åˆï¼`
                          : `<strong>ğŸ‘¤ ${formData.name}</strong><br>ğŸ“‹ åºè™Ÿï¼š#V${result.registrationId}<br>â° å·¥ä½œç­æ¬¡ï¼š${formData.workShift} (${shiftTime})<br>${formData.lunch !== 'ç„¡' ? `ğŸ± åˆé¤ï¼š${formData.lunch}<br>` : ''}<br>âœ¨ ä¸é™äººæ•¸ï¼Œæ­¡è¿æ›´å¤šå¿—å·¥åŠ å…¥ï¼<br><br>æ„Ÿè¬æ‚¨çš„ç†±å¿ƒåƒèˆ‡ï¼<br>æˆ‘å€‘æœƒåœ¨æ´»å‹•å‰ä¸€å¤©æé†’æ‚¨ ğŸ™`;
                      
                      showModal('success', editMode ? 'ä¿®æ”¹æˆåŠŸï¼' : 'å ±åæˆåŠŸï¼', message);

                      // é‡æ–°è¼‰å…¥æ’ç­ç‹€æ…‹
                      await loadScheduleSummary();
                      if (scheduleDetailExpanded) {
                          await loadScheduleDetails();
                      }

                      setTimeout(() => {
                          if (liff.isInClient()) {
                              liff.closeWindow();
                          }
                      }, 2000);
                  } else {
                      alert((editMode ? 'ä¿®æ”¹' : 'å ±å') + 'å¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
                  }

              } catch (error) {
                  console.error((editMode ? 'ä¿®æ”¹' : 'å ±å') + 'éŒ¯èª¤:', error);
                  alert((editMode ? 'ä¿®æ”¹' : 'å ±å') + 'æ™‚ç™¼ç”ŸéŒ¯èª¤\n\nè«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«ç®¡ç†å“¡\n\néŒ¯èª¤è¨Šæ¯: ' + error.message);
              } finally {
                  isSubmitting = false;
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = editMode ? 'âœï¸ ç¢ºèªä¿®æ”¹' : 'ğŸ™‹ ç¢ºèªå ±å';
              }
          });
      });

      function closeSuccessModal() {
          document.getElementById('successModal').classList.remove('show');
          if (liff.isInClient()) {
              liff.closeWindow();
          }
      }
  </script>
</body>
</html>
