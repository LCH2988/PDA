<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>電子印章生成系統</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          background: white;
          border-radius: 20px;
          box-shadow: 0 20px 40px rgba(0,0,0,0.1);
          overflow: hidden;
      }

      .header {
          background: linear-gradient(45deg, #C00000, #B50000);
          color: white;
          padding: 30px;
          text-align: center;
      }

      .header h1 {
          font-size: 2.5em;
          margin-bottom: 10px;
          text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      }

      .header p {
          font-size: 1.1em;
          opacity: 0.9;
      }

      .main-content {
          padding: 40px;
      }

      .tab-container {
          margin-bottom: 30px;
      }

      .tab-buttons {
          display: flex;
          border-bottom: 3px solid #f0f0f0;
          margin-bottom: 30px;
      }

      .tab-button {
          flex: 1;
          padding: 15px 20px;
          background: none;
          border: none;
          font-size: 1.1em;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          position: relative;
      }

      .tab-button.active {
          color: #C00000;
      }

      .tab-button.active::after {
          content: '';
          position: absolute;
          bottom: -3px;
          left: 0;
          right: 0;
          height: 3px;
          background: #C00000;
      }

      .tab-button:hover {
          background: #f8f9fa;
      }

      .tab-content {
          display: none;
      }

      .tab-content.active {
          display: block;
      }

      .form-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 30px;
          margin-bottom: 30px;
      }

      .form-section {
          background: #f8f9fa;
          padding: 25px;
          border-radius: 15px;
          border-left: 5px solid #C00000;
      }

      .form-section h3 {
          color: #333;
          margin-bottom: 20px;
          font-size: 1.3em;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #555;
      }

      .form-group input,
      .form-group select {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          font-size: 1em;
          transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus {
          outline: none;
          border-color: #C00000;
          box-shadow: 0 0 0 3px rgba(192, 0, 0, 0.1);
      }

      .btn {
          padding: 12px 30px;
          border: none;
          border-radius: 8px;
          font-size: 1em;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          margin-right: 10px;
          margin-bottom: 10px;
      }

      .btn-primary {
          background: linear-gradient(45deg, #C00000, #B50000);
          color: white;
      }

      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(192, 0, 0, 0.3);
      }

      .btn-secondary {
          background: #6c757d;
          color: white;
      }

      .btn-secondary:hover {
          background: #5a6268;
      }

      .btn-success {
          background: #28a745;
          color: white;
      }

      .btn-info {
          background: #17a2b8;
          color: white;
      }

      .result-area {
          margin-top: 30px;
          padding: 20px;
          background: #f8f9fa;
          border-radius: 10px;
          border-left: 5px solid #28a745;
          display: none;
      }

      .result-area.show {
          display: block;
      }

      .result-area h4 {
          color: #155724;
          margin-bottom: 15px;
      }

      .result-item {
          margin-bottom: 10px;
          padding: 10px;
          background: white;
          border-radius: 5px;
          border: 1px solid #d4edda;
      }

      .preview-area {
          text-align: center;
          padding: 30px;
          background: #f8f9fa;
          border-radius: 15px;
          margin-top: 20px;
      }

      .seal-preview {
          max-width: 300px;
          margin: 0 auto;
          border: 3px solid #C00000;
          border-radius: 50%;
          padding: 20px;
          background: white;
      }

      .loading {
          display: none;
          text-align: center;
          padding: 20px;
      }

      .loading.show {
          display: block;
      }

      .spinner {
          border: 4px solid #f3f3f3;
          border-top: 4px solid #C00000;
          border-radius: 50%;
          width: 50px;
          height: 50px;
          animation: spin 1s linear infinite;
          margin: 0 auto 15px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .error-message {
          background: #f8d7da;
          color: #721c24;
          padding: 15px;
          border-radius: 8px;
          border-left: 5px solid #dc3545;
          margin-top: 15px;
          display: none;
      }

      .success-message {
          background: #d4edda;
          color: #155724;
          padding: 15px;
          border-radius: 8px;
          border-left: 5px solid #28a745;
          margin-top: 15px;
          display: none;
      }

      .batch-section {
          margin-top: 30px;
      }

      .employee-row {
          display: grid;
          grid-template-columns: 1fr 1fr 1fr 1fr auto;
          gap: 15px;
          align-items: end;
          margin-bottom: 15px;
          padding: 15px;
          background: white;
          border-radius: 8px;
          border: 2px solid #e0e0e0;
      }

      .verify-section {
          background: #e3f2fd;
          padding: 25px;
          border-radius: 15px;
          border-left: 5px solid #2196f3;
      }

      .status-indicator {
          display: inline-block;
          width: 12px;
          height: 12px;
          border-radius: 50%;
          margin-right: 8px;
      }

      .status-success { background: #28a745; }
      .status-error { background: #dc3545; }
      .status-warning { background: #ffc107; }

      @media (max-width: 768px) {
          .form-grid {
              grid-template-columns: 1fr;
          }
          
          .employee-row {
              grid-template-columns: 1fr;
          }
          
          .tab-buttons {
              flex-direction: column;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>🔴 電子印章生成系統</h1>
          <p>台灣帕金森病友權益促進會 - 數位印章管理平台</p>
      </div>

      <div class="main-content">
          <div class="tab-container">
              <div class="tab-buttons">
                  <button class="tab-button active" onclick="switchTab('personal')">個人印章</button>
                  <button class="tab-button" onclick="switchTab('association')">協會大章</button>
                  <button class="tab-button" onclick="switchTab('batch')">批量建立</button>
                  <button class="tab-button" onclick="switchTab('verify')">印章驗證</button>
                  <button class="tab-button" onclick="switchTab('manage')">印章管理</button>
              </div>

              <!-- 個人印章頁面 -->
              <div id="personal" class="tab-content active">
                  <div class="form-grid">
                      <div class="form-section">
                          <h3>📝 個人資訊</h3>
                          <div class="form-group">
                              <label for="personal-name">姓名 *</label>
                              <input type="text" id="personal-name" placeholder="請輸入姓名" required>
                          </div>
                          <div class="form-group">
                              <label for="personal-title">職稱 *</label>
                              <select id="personal-title" required>
                                  <option value="">請選擇職稱</option>
                                  <option value="理事長">理事長</option>
                                  <option value="副理事長">副理事長</option>
                                  <option value="秘書長">秘書長</option>
                                  <option value="理事">理事</option>
                                  <option value="監事">監事</option>
                                  <option value="經理">經理</option>
                                  <option value="主任">主任</option>
                                  <option value="組長">組長</option>
                                  <option value="專員">專員</option>
                                  <option value="其他">其他</option>
                              </select>
                          </div>
                          <div class="form-group">
                              <label for="personal-department">部門</label>
                              <input type="text" id="personal-department" placeholder="台灣帕金森病友權益促進會" value="台灣帕金森病友權益促進會">
                          </div>
                          <div class="form-group">
                              <label for="personal-id">員工編號</label>
                              <input type="text" id="personal-id" placeholder="例：EMP001">
                          </div>
                      </div>

                      <div class="form-section">
                          <h3>⚙️ 印章設定</h3>
                          <div class="form-group">
                              <label for="personal-color">印章顏色</label>
                              <select id="personal-color">
                                  <option value="#C00000">傳統紅色</option>
                                  <option value="#B50000">深紅色</option>
                                  <option value="#003366">藍色</option>
                              </select>
                          </div>
                          <div class="form-group">
                              <label>
                                  <input type="checkbox" id="personal-qr" checked> 包含 QR 碼驗證
                              </label>
                          </div>
                          <div class="form-group">
                              <label>
                                  <input type="checkbox" id="personal-watermark" checked> 防偽浮水印
                              </label>
                          </div>
                          <button class="btn btn-primary" onclick="generatePersonalSeal()">🎯 生成個人印章</button>
                          <button class="btn btn-secondary" onclick="previewPersonalSeal()">👁️ 預覽</button>
                      </div>
                  </div>

                  <div class="preview-area" id="personal-preview" style="display: none;">
                      <h4>印章預覽</h4>
                      <div class="seal-preview" id="personal-seal-display"></div>
                  </div>

                  <div class="loading" id="personal-loading">
                      <div class="spinner"></div>
                      <p>正在生成印章...</p>
                  </div>

                  <div class="result-area" id="personal-result">
                      <h4>✅ 印章生成成功</h4>
                      <div id="personal-result-content"></div>
                  </div>

                  <div class="error-message" id="personal-error"></div>
                  <div class="success-message" id="personal-success"></div>
              </div>

              <!-- 協會大章頁面 -->
              <div id="association" class="tab-content">
                  <div class="form-grid">
                      <div class="form-section">
                          <h3>🏢 組織資訊</h3>
                          <div class="form-group">
                              <label for="org-name">組織名稱 *</label>
                              <input type="text" id="org-name" placeholder="台灣帕金森病友權益促進會" value="台灣帕金森病友權益促進會" required>
                          </div>
                          <div class="form-group">
                              <label for="org-taxid">統一編號 *</label>
                              <input type="text" id="org-taxid" placeholder="85202581" value="85202581" required>
                          </div>
                          <div class="form-group">
                              <label for="org-type">印章類型</label>
                              <select id="org-type">
                                  <option value="協會大章">協會大章</option>
                                  <option value="理事會章">理事會章</option>
                                  <option value="財務專用章">財務專用章</option>
                                  <option value="業務專用章">業務專用章</option>
                              </select>
                          </div>
                          <div class="form-group">
                              <label for="org-authorizer">授權人</label>
                              <input type="text" id="org-authorizer" placeholder="理事長" value="理事長">
                          </div>
                      </div>

                      <div class="form-section">
                          <h3>🎨 設計選項</h3>
                          <div class="form-group">
                              <label for="org-color">印章顏色</label>
                              <select id="org-color">
                                  <option value="#C00000">傳統紅色</option>
                                  <option value="#B50000">深紅色</option>
                                  <option value="#003366">藍色</option>
                              </select>
                          </div>
                          <div class="form-group">
                              <label>
                                  <input type="checkbox" id="org-guilloche" checked> Guilloche 防偽裝飾
                              </label>
                          </div>
                          <div class="form-group">
                              <label>
                                  <input type="checkbox" id="org-timestamp" checked> 時間戳記
                              </label>
                          </div>
                          <button class="btn btn-primary" onclick="generateAssociationSeal()">🏛️ 生成協會大章</button>
                          <button class="btn btn-secondary" onclick="previewAssociationSeal()">👁️ 預覽</button>
                      </div>
                  </div>

                  <div class="preview-area" id="association-preview" style="display: none;">
                      <h4>印章預覽</h4>
                      <div class="seal-preview" id="association-seal-display"></div>
                  </div>

                  <div class="loading" id="association-loading">
                      <div class="spinner"></div>
                      <p>正在生成印章...</p>
                  </div>

                  <div class="result-area" id="association-result">
                      <h4>✅ 印章生成成功</h4>
                      <div id="association-result-content"></div>
                  </div>

                  <div class="error-message" id="association-error"></div>
                  <div class="success-message" id="association-success"></div>
              </div>

              <!-- 批量建立頁面 -->
              <div id="batch" class="tab-content">
                  <div class="form-section">
                      <h3>📋 批量建立印章</h3>
                      <p style="margin-bottom: 20px; color: #666;">一次建立多個員工的個人印章</p>
                      
                      <div class="batch-section">
                          <div class="form-group">
                              <button class="btn btn-info" onclick="addEmployeeRow()">➕ 新增員工</button>
                              <button class="btn btn-secondary" onclick="importFromCSV()">📁 從 CSV 匯入</button>
                              <button class="btn btn-success" onclick="generateBatchSeals()">🚀 批量生成</button>
                          </div>

                          <div id="employee-list">
                              <div class="employee-row">
                                  <div class="form-group">
                                      <label>姓名</label>
                                      <input type="text" placeholder="王小明" class="employee-name">
                                  </div>
                                  <div class="form-group">
                                      <label>職稱</label>
                                      <select class="employee-title">
                                          <option value="理事長">理事長</option>
                                          <option value="副理事長">副理事長</option>
                                          <option value="秘書長">秘書長</option>
                                          <option value="理事">理事</option>
                                          <option value="監事">監事</option>
                                          <option value="經理">經理</option>
                                          <option value="主任">主任</option>
                                          <option value="組長">組長</option>
                                          <option value="專員">專員</option>
                                      </select>
                                  </div>
                                  <div class="form-group">
                                      <label>部門</label>
                                      <input type="text" placeholder="台灣帕金森病友權益促進會" class="employee-department" value="台灣帕金森病友權益促進會">
                                  </div>
                                  <div class="form-group">
                                      <label>員工編號</label>
                                      <input type="text" placeholder="EMP001" class="employee-id">
                                  </div>
                                  <div class="form-group">
                                      <button class="btn btn-secondary" onclick="removeEmployeeRow(this)">❌</button>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <div class="loading" id="batch-loading">
                          <div class="spinner"></div>
                          <p>正在批量生成印章...</p>
                      </div>

                      <div class="result-area" id="batch-result">
                          <h4>✅ 批量生成完成</h4>
                          <div id="batch-result-content"></div>
                      </div>

                      <div class="error-message" id="batch-error"></div>
                      <div class="success-message" id="batch-success"></div>
                  </div>
              </div>

              <!-- 印章驗證頁面 -->
              <div id="verify" class="tab-content">
                  <div class="verify-section">
                      <h3>🔍 印章真偽驗證</h3>
                      <p style="margin-bottom: 20px; color: #666;">輸入印章 Hash 或 ID 來驗證印章的真實性</p>

                      <div class="form-grid">
                          <div class="form-group">
                              <label for="verify-hash">印章 Hash</label>
                              <input type="text" id="verify-hash" placeholder="請輸入印章 Hash 值">
                          </div>
                          <div class="form-group">
                              <label for="verify-id">印章 ID</label>
                              <input type="text" id="verify-id" placeholder="請輸入印章 ID">
                          </div>
                      </div>

                      <button class="btn btn-primary" onclick="verifySeal()">🔍 驗證印章</button>
                      <button class="btn btn-info" onclick="scanQRCode()">📱 掃描 QR 碼</button>

                      <div class="loading" id="verify-loading">
                          <div class="spinner"></div>
                          <p>正在驗證印章...</p>
                      </div>

                      <div class="result-area" id="verify-result">
                          <h4 id="verify-result-title">驗證結果</h4>
                          <div id="verify-result-content"></div>
                      </div>

                      <div class="error-message" id="verify-error"></div>
                      <div class="success-message" id="verify-success"></div>
                  </div>
              </div>

              <!-- 印章管理頁面 -->
              <div id="manage" class="tab-content">
                  <div class="form-section">
                      <h3>📊 印章管理</h3>
                      
                      <div class="form-group">
                          <button class="btn btn-info" onclick="loadSealList()">📋 載入印章清單</button>
                          <button class="btn btn-secondary" onclick="exportSealData()">💾 匯出資料</button>
                          <button class="btn btn-success" onclick="viewUsageLog()">📈 使用記錄</button>
                      </div>

                      <div class="result-area" id="manage-result">
                          <h4>印章清單</h4>
                          <div id="manage-result-content">
                              <p>點擊「載入印章清單」來查看所有印章</p>
                          </div>
                      </div>

                      <div class="loading" id="manage-loading">
                          <div class="spinner"></div>
                          <p>正在載入資料...</p>
                      </div>

                      <div class="error-message" id="manage-error"></div>
                      <div class="success-message" id="manage-success"></div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <script>
      // 全域變數
      let currentTab = 'personal';

      // 頁籤切換
      function switchTab(tabName) {
          document.querySelectorAll('.tab-content').forEach(content => {
              content.classList.remove('active');
          });
          
          document.querySelectorAll('.tab-button').forEach(button => {
              button.classList.remove('active');
          });
          
          document.getElementById(tabName).classList.add('active');
          event.target.classList.add('active');
          
          currentTab = tabName;
      }

      // 顯示載入動畫
      function showLoading(type) {
          document.getElementById(`${type}-loading`).classList.add('show');
          hideMessages(type);
      }

      // 隱藏載入動畫
      function hideLoading(type) {
          document.getElementById(`${type}-loading`).classList.remove('show');
      }

      // 顯示結果
      function showResult(type, content) {
          const resultArea = document.getElementById(`${type}-result`);
          const resultContent = document.getElementById(`${type}-result-content`);
          resultContent.innerHTML = content;
          resultArea.classList.add('show');
      }

      // 顯示錯誤訊息
      function showError(type, message) {
          const errorElement = document.getElementById(`${type}-error`);
          errorElement.textContent = message;
          errorElement.style.display = 'block';
      }

      // 顯示成功訊息
      function showSuccess(type, message) {
          const successElement = document.getElementById(`${type}-success`);
          successElement.textContent = message;
          successElement.style.display = 'block';
      }

      // 隱藏所有訊息
      function hideMessages(type) {
          document.getElementById(`${type}-error`).style.display = 'none';
          document.getElementById(`${type}-success`).style.display = 'none';
          document.getElementById(`${type}-result`).classList.remove('show');
      }

      // 生成個人印章
      async function generatePersonalSeal() {
          const name = document.getElementById('personal-name').value;
          const title = document.getElementById('personal-title').value;
          const department = document.getElementById('personal-department').value;
          const employeeId = document.getElementById('personal-id').value;

          if (!name || !title) {
              showError('personal', '請填寫必要欄位：姓名和職稱');
              return;
          }

          showLoading('personal');

          try {
              // 模擬 Google Apps Script 呼叫
              const response = await fetch('https://script.google.com/macros/s/AKfycbw-3K2hr2Qc88XSejYG1txWUPXIOsHtpHmJID44iO2cgYhe26eEErOPhO6BKuZvSgYR/exec', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'createPersonal',
                      name: name,
                      title: title,
                      department: department,
                      employeeId: employeeId
                  })
              });

              const result = await response.json();
              hideLoading('personal');

              if (result.success) {
                  const resultHTML = `
                      <div class="result-item">
                          <strong>印章 ID：</strong>${result.sealId}
                      </div>
                      <div class="result-item">
                          <strong>Hash 值：</strong>${result.hash}
                      </div>
                      <div class="result-item">
                          <strong>SVG 檔案 ID：</strong>${result.files.svgFileId}
                      </div>
                      <div class="result-item">
                          <strong>Metadata 檔案 ID：</strong>${result.files.metadataFileId}
                      </div>
                      <div class="result-item">
                          <button class="btn btn-info" onclick="downloadSeal('${result.files.svgFileId}')">下載 SVG</button>
                          <button class="btn btn-secondary" onclick="downloadMetadata('${result.files.metadataFileId}')">下載 Metadata</button>
                      </div>
                  `;
                  
                  showResult('personal', resultHTML);
                  showSuccess('personal', `${name} 的個人印章已成功生成！`);
              } else {
                  showError('personal', result.error || '生成印章失敗');
              }
              
          } catch (error) {
              hideLoading('personal');
              showError('personal', '連接服務器失敗：' + error.message);
          }
      }

      // 預覽個人印章
      function previewPersonalSeal() {
          const name = document.getElementById('personal-name').value || '預覽姓名';
          const title = document.getElementById('personal-title').value || '預覽職稱';
          
          const previewHTML = `
              <div style="width: 200px; height: 200px; border: 3px solid #C00000; border-radius: 50%; 
                         display: flex; flex-direction: column; justify-content: center; align-items: center;
                         background: white; margin: 0 auto; position: relative;">
                  <div style="font-size: 12px; color: #C00000; position: absolute; top: 20px;">台灣帕金森病友權益促進會</div>
                  <div style="font-size: 24px; font-weight: bold; color: #C00000; margin: 10px 0;">${name}</div>
                  <div style="font-size: 12px; color: #C00000; position: absolute; bottom: 30px;">${title} 專 用 章</div>
                  <div style="position: absolute; bottom: 10px; font-size: 8px; color: #C00000;">EMP001</div>
              </div>
          `;
          
          document.getElementById('personal-seal-display').innerHTML = previewHTML;
          document.getElementById('personal-preview').style.display = 'block';
      }

        // 生成協會大章
        async function generateAssociationSeal() {
            const orgName = document.getElementById('org-name').value;
            const taxId = document.getElementById('org-taxid').value;
            const sealType = document.getElementById('org-type').value;
            const authorizer = document.getElementById('org-authorizer').value;

            if (!orgName || !taxId) {
                showError('association', '請填寫必要欄位：組織名稱和統一編號');
                return;
            }

            showLoading('association');

            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbw-3K2hr2Qc88XSejYG1txWUPXIOsHtpHmJID44iO2cgYhe26eEErOPhO6BKuZvSgYR/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'createAssociation',
                        orgName: orgName,
                        taxId: taxId,
                        sealType: sealType,
                        authorizer: authorizer
                    })
                });

                const result = await response.json();
                hideLoading('association');

                if (result.success) {
                    const resultHTML = `
                        <div class="result-item">
                            <strong>印章 ID：</strong>${result.sealId}
                        </div>
                        <div class="result-item">
                            <strong>Hash 值：</strong>${result.hash}
                        </div>
                        <div class="result-item">
                            <strong>SVG 檔案 ID：</strong>${result.files.svgFileId}
                        </div>
                        <div class="result-item">
                            <button class="btn btn-info" onclick="downloadSeal('${result.files.svgFileId}')">下載 SVG</button>
                            <button class="btn btn-secondary" onclick="downloadMetadata('${result.files.metadataFileId}')">下載 Metadata</button>
                        </div>
                    `;
                    
                    showResult('association', resultHTML);
                    showSuccess('association', `${orgName} 的協會大章已成功生成！`);
                } else {
                    showError('association', result.error || '生成印章失敗');
                }
                
            } catch (error) {
                hideLoading('association');
                showError('association', '連接服務器失敗：' + error.message);
            }
        }

        // 預覽協會大章
        function previewAssociationSeal() {
            const orgName = document.getElementById('org-name').value || '預覽組織';
            const taxId = document.getElementById('org-taxid').value || '12345678';
            const sealType = document.getElementById('org-type').value || '協會大章';
            
            const previewHTML = `
                <div style="width: 250px; height: 250px; border: 4px solid #C00000; border-radius: 50%; 
                           display: flex; flex-direction: column; justify-content: center; align-items: center;
                           background: white; margin: 0 auto; position: relative;">
                    <div style="font-size: 14px; color: #C00000; position: absolute; top: 25px; text-align: center; width: 200px;">${orgName}</div>
                    <div style="font-size: 16px; color: #C00000; margin-bottom: 5px;">統一編號</div>
                    <div style="font-size: 20px; font-weight: bold; color: #C00000; margin-bottom: 10px;">${taxId}</div>
                    <div style="font-size: 12px; color: #C00000; position: absolute; bottom: 25px;">${sealType}</div>
                </div>
            `;
            
            document.getElementById('association-seal-display').innerHTML = previewHTML;
            document.getElementById('association-preview').style.display = 'block';
        }

        // 新增員工行
        function addEmployeeRow() {
            const employeeList = document.getElementById('employee-list');
            const newRow = document.createElement('div');
            newRow.className = 'employee-row';
            newRow.innerHTML = `
                <div class="form-group">
                    <label>姓名</label>
                    <input type="text" placeholder="請輸入姓名" class="employee-name">
                </div>
                <div class="form-group">
                    <label>職稱</label>
                    <select class="employee-title">
                        <option value="理事長">理事長</option>
                        <option value="副理事長">副理事長</option>
                        <option value="秘書長">秘書長</option>
                        <option value="理事">理事</option>
                        <option value="監事">監事</option>
                        <option value="經理">經理</option>
                        <option value="主任">主任</option>
                        <option value="組長">組長</option>
                        <option value="專員">專員</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>部門</label>
                    <input type="text" placeholder="台灣帕金森病友權益促進會" class="employee-department" value="台灣帕金森病友權益促進會">
                </div>
                <div class="form-group">
                    <label>員工編號</label>
                    <input type="text" placeholder="EMP002" class="employee-id">
                </div>
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="removeEmployeeRow(this)">❌</button>
                </div>
            `;
            employeeList.appendChild(newRow);
        }

        // 移除員工行
        function removeEmployeeRow(button) {
            button.closest('.employee-row').remove();
        }

        // 從 CSV 匯入
        function importFromCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        const employeeList = document.getElementById('employee-list');
                        
                        // 清空現有列表
                        employeeList.innerHTML = '';
                        
                        // 解析 CSV (假設格式：姓名,職稱,部門,員工編號)
                        for (let i = 1; i < lines.length; i++) { // 跳過標題行
                            const data = lines[i].split(',');
                            if (data.length >= 4 && data[0].trim()) {
                                const newRow = document.createElement('div');
                                newRow.className = 'employee-row';
                                newRow.innerHTML = `
                                    <div class="form-group">
                                        <label>姓名</label>
                                        <input type="text" value="${data[0].trim()}" class="employee-name">
                                    </div>
                                    <div class="form-group">
                                        <label>職稱</label>
                                        <select class="employee-title">
                                            <option value="理事長" ${data[1].trim() === '理事長' ? 'selected' : ''}>理事長</option>
                                            <option value="副理事長" ${data[1].trim() === '副理事長' ? 'selected' : ''}>副理事長</option>
                                            <option value="秘書長" ${data[1].trim() === '秘書長' ? 'selected' : ''}>秘書長</option>
                                            <option value="理事" ${data[1].trim() === '理事' ? 'selected' : ''}>理事</option>
                                            <option value="監事" ${data[1].trim() === '監事' ? 'selected' : ''}>監事</option>
                                            <option value="經理" ${data[1].trim() === '經理' ? 'selected' : ''}>經理</option>
                                            <option value="主任" ${data[1].trim() === '主任' ? 'selected' : ''}>主任</option>
                                            <option value="組長" ${data[1].trim() === '組長' ? 'selected' : ''}>組長</option>
                                            <option value="專員" ${data[1].trim() === '專員' ? 'selected' : ''}>專員</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>部門</label>
                                        <input type="text" value="${data[2].trim()}" class="employee-department">
                                    </div>
                                    <div class="form-group">
                                        <label>員工編號</label>
                                        <input type="text" value="${data[3].trim()}" class="employee-id">
                                    </div>
                                    <div class="form-group">
                                        <button class="btn btn-secondary" onclick="removeEmployeeRow(this)">❌</button>
                                    </div>
                                `;
                                employeeList.appendChild(newRow);
                            }
                        }
                        
                        showSuccess('batch', `成功匯入 ${employeeList.children.length} 筆員工資料`);
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // 批量生成印章
        async function generateBatchSeals() {
            const employeeRows = document.querySelectorAll('.employee-row');
            const employees = [];
            
            employeeRows.forEach(row => {
                const name = row.querySelector('.employee-name').value;
                const title = row.querySelector('.employee-title').value;
                const department = row.querySelector('.employee-department').value;
                const employeeId = row.querySelector('.employee-id').value;
                
                if (name && title) {
                    employees.push({ name, title, department, employeeId });
                }
            });
            
            if (employees.length === 0) {
                showError('batch', '請至少新增一位員工資料');
                return;
            }
            
            showLoading('batch');
            
            try {
                const results = [];
                
                for (let i = 0; i < employees.length; i++) {
                    const emp = employees[i];
                    const response = await fetch('https://script.google.com/macros/s/AKfycbw-3K2hr2Qc88XSejYG1txWUPXIOsHtpHmJID44iO2cgYhe26eEErOPhO6BKuZvSgYR/exec', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'createPersonal',
                            name: emp.name,
                            title: emp.title,
                            department: emp.department,
                            employeeId: emp.employeeId
                        })
                    });
                    
                    const result = await response.json();
                    results.push({
                        employee: emp,
                        result: result
                    });
                    
                    // 避免 API 限制
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                hideLoading('batch');
                
                let resultHTML = '<table style="width: 100%; border-collapse: collapse;">';
                resultHTML += '<tr style="background: #f8f9fa;"><th style="padding: 10px; border: 1px solid #ddd;">姓名</th><th style="padding: 10px; border: 1px solid #ddd;">狀態</th><th style="padding: 10px; border: 1px solid #ddd;">印章 ID</th><th style="padding: 10px; border: 1px solid #ddd;">操作</th></tr>';
                
                results.forEach(item => {
                    const status = item.result.success ? 
                        '<span class="status-indicator status-success"></span>成功' : 
                        '<span class="status-indicator status-error"></span>失敗';
                    
                    resultHTML += `
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">${item.employee.name}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${status}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${item.result.sealId || 'N/A'}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">
                                ${item.result.success ? 
                                    `<button class="btn btn-info" onclick="downloadSeal('${item.result.files.svgFileId}')">下載</button>` : 
                                    '無法下載'
                                }
                            </td>
                        </tr>
                    `;
                });
                
                resultHTML += '</table>';
                
                showResult('batch', resultHTML);
                showSuccess('batch', `批量生成完成！成功：${results.filter(r => r.result.success).length} 個，失敗：${results.filter(r => !r.result.success).length} 個`);
                
            } catch (error) {
                hideLoading('batch');
                showError('batch', '批量生成失敗：' + error.message);
            }
        }

        // 驗證印章
        async function verifySeal() {
            const hash = document.getElementById('verify-hash').value;
            const sealId = document.getElementById('verify-id').value;
            
            if (!hash && !sealId) {
                showError('verify', '請輸入印章 Hash 或 ID');
                return;
            }
            
            showLoading('verify');
            
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbw-3K2hr2Qc88XSejYG1txWUPXIOsHtpHmJID44iO2cgYhe26eEErOPhO6BKuZvSgYR/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'verify',
                        hash: hash,
                        sealId: sealId
                    })
                });
                
                const result = await response.json();
                hideLoading('verify');
                
                if (result.valid) {
                    document.getElementById('verify-result-title').innerHTML = '✅ 驗證成功';
                    document.getElementById('verify-result-title').style.color = '#155724';
                    
                    const resultHTML = `
                        <div class="result-item">
                            <strong>印章類型：</strong>${result.sealType}
                        </div>
                        <div class="result-item">
                            <strong>使用者：</strong>${result.user}
                        </div>
                        <div class="result-item">
                            <strong>文件名稱：</strong>${result.documentName}
                        </div>
                        <div class="result-item">
                            <strong>建立時間：</strong>${new Date(result.timestamp).toLocaleString('zh-TW')}
                        </div>
                    `;
                    
                    showResult('verify', resultHTML);
                    showSuccess('verify', '印章驗證通過，此為有效印章！');
                } else {
                    document.getElementById('verify-result-title').innerHTML = '❌ 驗證失敗';
                    document.getElementById('verify-result-title').style.color = '#721c24';
                    
                    showResult('verify', `<div class="result-item" style="color: #721c24;">${result.message}</div>`);
                    showError('verify', '印章驗證失敗，可能為偽造印章！');
                }
                
            } catch (error) {
                hideLoading('verify');
                showError('verify', '驗證過程發生錯誤：' + error.message);
            }
        }

        // 掃描 QR 碼
        function scanQRCode() {
            alert('QR 碼掃描功能需要攝像頭權限，請使用手機掃描 QR 碼後手動輸入資訊');
        }

        // 載入印章清單
        async function loadSealList() {
            showLoading('manage');
            
            try {
                // 模擬載入印章清單
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const mockData = [
                    { name: '王小明', type: '個人章', sealId: 'PERSONAL-20241201-1430-ABC', status: '有效', createTime: '2024-12-01 14:30:00' },
                    { name: '李小華', type: '個人章', sealId: 'PERSONAL-20241201-1435-DEF', status: '有效', createTime: '2024-12-01 14:35:00' },
                    { name: '台灣帕金森病友權益促進會', type: '協會大章', sealId: 'ASSOCIATION-20241201-1440-GHI', status: '有效', createTime: '2024-12-01 14:40:00' }
                ];
                
                hideLoading('manage');
                
                let resultHTML = '<table style="width: 100%; border-collapse: collapse;">';
                resultHTML += '<tr style="background: #f8f9fa;"><th style="padding: 10px; border: 1px solid #ddd;">名稱</th><th style="padding: 10px; border: 1px solid #ddd;">類型</th><th style="padding: 10px; border: 1px solid #ddd;">印章 ID</th><th style="padding: 10px; border: 1px solid #ddd;">狀態</th><th style="padding: 10px; border: 1px solid #ddd;">建立時間</th></tr>';
                
                mockData.forEach(item => {
                    resultHTML += `
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">${item.name}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${item.type}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${item.sealId}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;"><span class="status-indicator status-success"></span>${item.status}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${item.createTime}</td>
                        </tr>
                    `;
                });
                
                resultHTML += '</table>';
                
                showResult('manage', resultHTML);
                showSuccess('manage', `載入完成！共找到 ${mockData.length} 個印章`);
                
            } catch (error) {
                hideLoading('manage');
                showError('manage', '載入印章清單失敗：' + error.message);
            }
        }

        // 匯出印章資料
        function exportSealData() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "名稱,類型,印章ID,狀態,建立時間\n" +
                "王小明,個人章,PERSONAL-20241201-1430-ABC,有效,2024-12-01 14:30:00\n" +
                "李小華,個人章,PERSONAL-20241201-1435-DEF,有效,2024-12-01 14:35:00\n" +
                "台灣帕金森病友權益促進會,協會大章,ASSOCIATION-20241201-1440-GHI,有效,2024-12-01 14:40:00";
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "印章清單_" + new Date().toISOString().substring(0,10) + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess('manage', 'CSV 檔案已下載完成！');
        }

        // 查看使用記錄
        async function viewUsageLog() {
            showLoading('manage');
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const logData = [
                    { time: '2024-12-01 14:30:15', type: '個人章', user: '王小明', document: '個人章_王小明_PERSONAL-20241201-1430-ABC', ip: '192.168.1.100' },
                    { time: '2024-12-01 14:35:22', type: '個人章', user: '李小華', document: '個人章_李小華_PERSONAL-20241201-1435-DEF', ip: '192.168.1.101' },
                    { time: '2024-12-01 14:40:33', type: '協會大章', user: '理事長', document: '協會章_台灣帕金森病友權益促進會_ASSOCIATION-20241201-1440-GHI', ip: '192.168.1.102' }
                ];
                
                hideLoading('manage');
                
                let resultHTML = '<h4>📈 印章使用記錄</h4>';
                resultHTML += '<table style="width: 100%; border-collapse: collapse;">';
                resultHTML += '<tr style="background: #f8f9fa;"><th style="padding: 10px; border: 1px solid #ddd;">時間</th><th style="padding: 10px; border: 1px solid #ddd;">類型</th><th style="padding: 10px; border: 1px solid #ddd;">使用者</th><th style="padding: 10px; border: 1px solid #ddd;">文件名稱</th><th style="padding: 10px; border: 1px solid #ddd;">IP位址</th></tr>';
                
                logData.forEach(log => {
                    resultHTML += `
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">${log.time}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${log.type}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${log.user}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${log.document}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${log.ip}</td>
                        </tr>
                    `;
                });
                
                resultHTML += '</table>';
                
                showResult('manage', resultHTML);
                showSuccess('manage', `載入完成！共 ${logData.length} 筆使用記錄`);
                
            } catch (error) {
                hideLoading('manage');
                showError('manage', '載入使用記錄失敗：' + error.message);
            }
        }

        // 下載印章檔案
        function downloadSeal(fileId) {
            const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
            window.open(downloadUrl, '_blank');
        }

        // 下載 Metadata
        function downloadMetadata(fileId) {
            const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
            window.open(downloadUrl, '_blank');
        }

        // 頁面載入完成後的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('電子印章生成系統已載入');
            
            // 設定預設值
            document.getElementById('personal-department').value = '台灣帕金森病友權益促進會';
            document.getElementById('org-name').value = '台灣帕金森病友權益促進會';
            document.getElementById('org-taxid').value = '85202581';
            document.getElementById('org-authorizer').value = '理事長';
        });
    </script>
</body>
</html>
