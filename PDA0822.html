
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>組織管理系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- 核心套件 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root { --primary-color:#2c3e50; --secondary-color:#3498db; --success-color:#27ae60;
            --warning-color:#f39c12; --danger-color:#e74c3c; --sidebar-width:280px; }
    body { font-family:'Segoe UI',sans-serif; background:#f8f9fa; margin:0; }
    .sidebar { position:fixed; top:0; left:0; height:100vh; width:var(--sidebar-width);
               background:linear-gradient(135deg,var(--primary-color),#34495e); color:#fff;
               z-index:1000; transition:.3s; overflow-y:auto; }
    .sidebar.collapsed { transform:translateX(-100%); }
    .sidebar-header { padding:1.5rem; text-align:center; border-bottom:1px solid rgba(255,255,255,.1); }
    .nav-link { display:block; padding:.75rem 1.5rem; color:rgba(255,255,255,.85); text-decoration:none;
                transition:.3s; border-left:3px solid transparent; }
    .nav-link:hover { background:rgba(255,255,255,.12); color:#fff; border-left-color:var(--secondary-color); }
    .nav-link.active { background:rgba(52,152,219,.25); color:#fff; border-left-color:var(--secondary-color); }
    .main-content { margin-left:var(--sidebar-width); min-height:100vh; transition:.3s; }
    .main-content.expanded { margin-left:0; }
    .top-navbar { background:#fff; padding:1rem 1.5rem; display:flex; justify-content:space-between;
                  box-shadow:0 2px 4px rgba(0,0,0,.08); }
    .content-area { padding:1.5rem 2rem; }
    .stats-card { background:#fff; padding:1.2rem; border-radius:12px;
                  box-shadow:0 2px 8px rgba(0,0,0,.08); text-align:center; }
    .stats-card:hover { transform:translateY(-4px); transition:.3s; }
    .stats-number { font-size:1.9rem; font-weight:700; color:var(--primary-color); }
    .card { border:none; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.08); margin-bottom:1.5rem; }
    .card-header { background:#fff; border-bottom:1px solid #eee; border-radius:12px 12px 0 0!important; }
    .loading-overlay { position:fixed; inset:0; background:rgba(0,0,0,.65); display:none;
                       justify-content:center; align-items:center; z-index:2000; }
    .spinner { width:54px; height:54px; border:5px solid #f3f3f3; border-top:5px solid var(--secondary-color);
               border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    @media (max-width:768px) {
      .sidebar { transform:translateX(-100%); }
      .sidebar.show { transform:translateX(0); }
      .main-content { margin-left:0; }
    }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div></div>
  <nav id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <h4><i class="fas fa-users-cog me-2"></i>組織管理系統</h4>
      <small>v1.1.0</small>
    </div>
    <div class="nav-menu">
      <a href="#" class="nav-link active" onclick="AppLayout.showSection('dashboard')"><i class="fas fa-tachometer-alt"></i>儀表板</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('transactions')"><i class="fas fa-money-bill-wave"></i>財務管理</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('members')"><i class="fas fa-users"></i>會員管理</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('activities')"><i class="fas fa-calendar-alt"></i>活動管理</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('announcements')"><i class="fas fa-bullhorn"></i>公告管理</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('forms')"><i class="fas fa-file-alt"></i>表單管理</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('accounts')"><i class="fas fa-university"></i>帳戶管理</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('reports')"><i class="fas fa-chart-bar"></i>報表分析</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('settings')"><i class="fas fa-cog"></i>系統設定</a>
    </div>
  </nav>
  <div id="mainContent" class="main-content">
    <div class="top-navbar">
      <div>
        <button class="btn btn-outline-secondary d-md-none" onclick="AppLayout.toggleSidebar()">
          <i class="fas fa-bars"></i>
        </button>
        <span class="ms-2 fw-bold">組織管理系統</span>
      </div>
      <div>
        <button class="btn btn-outline-primary me-2" onclick="AppLayout.refreshData()" title="重新整理">
          <i class="fas fa-sync-alt"></i>
        </button>
          <button class="btn btn-outline-info me-2" onclick="AppLayout.showHelp()"><i class="fas fa-question-circle"></i></button>
        <div class="dropdown d-inline">
          <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
            <i class="fas fa-user-circle"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="AppLayout.showProfile()"><i class="fas fa-user me-2"></i>個人資料</a></li>
            <li><a class="dropdown-item" href="#" onclick="AppLayout.showSection('settings')"><i class="fas fa-cog me-2"></i>設定</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="AppLayout.logout()"><i class="fas fa-sign-out-alt me-2"></i>登出</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div id="contentArea" class="content-area"></div>
  </div>

  <script>
    /*********** 設定 ***********/
    const CONFIG = {
      // 若後端有啟用 API_KEY，則在 URL 後加 ?apiKey=XXXX
      GAS_URL: 'https://script.google.com/macros/s/AKfycbwLQxfTR35EeRSCU4KG1KQo7GAPaYJQjdmle_NvFptgsT6XpUz0pvoGNH1nj3IoJS3Q1w/exec',
      DEBUG: true,
      VERSION: '1.1.0'
    };
    let globalData = {
      transactions: [],
      members: [],
      activities: [],
      announcements: [],
      forms: [],
      accounts: [],
      registrations: [],
      settings: {},
      lastUpdate: null
    };

    /*********** API 包裝（簡單請求避免 CORS） ***********/
    const API = {
      async request(action, data={}) {
        // 為保持 Simple Request：不加自訂 headers / 不用 application/json
        const body = JSON.stringify({ action, data });
        try {
          AppLayout.showLoading(true);
          const res = await fetch(CONFIG.GAS_URL, {
            method: 'POST',
            body // Content-Type 預設 text/plain
          });
          if (!res.ok) throw new Error('HTTP 狀態碼: ' + res.status);
          const json = await res.json();
          if (!json.success) throw new Error(json.error || '未知後端錯誤');
          return json.data;
        } catch (err) {
          if (CONFIG.DEBUG) console.error('API 請求錯誤:', err);
          throw err;
        } finally {
          AppLayout.showLoading(false);
        }
      },
      getAllData(){ return this.request('getAllData'); },
      getTransactions(){ return this.request('getTransactions'); },
      getMembers(){ return this.request('getMembers'); },
      getActivities(){ return this.request('getActivities'); },
      getAnnouncements(){ return this.request('getAnnouncements'); },
      getForms(){ return this.request('getForms'); },
      getAccounts(){ return this.request('getAccounts'); },
      getRegistrations(){ return this.request('getRegistrations'); },
      getDashboardData(){ return this.request('getDashboardData'); },
      addTransaction(d){ return this.request('addTransaction', d); },
      addMember(d){ return this.request('addMember', d); },
      addActivity(d){ return this.request('addActivity', d); },
      addAnnouncement(d){ return this.request('addAnnouncement', d); },
      addForm(d){ return this.request('addForm', d); },
      addAccount(d){ return this.request('addAccount', d); },
      addRegistration(d){ return this.request('addRegistration', d); },
      updateTransaction(d){ return this.request('updateTransaction', d); },
      updateMember(d){ return this.request('updateMember', d); },
      updateActivity(d){ return this.request('updateActivity', d); },
      updateAnnouncement(d){ return this.request('updateAnnouncement', d); },
      updateForm(d){ return this.request('updateForm', d); },
      updateAccount(d){ return this.request('updateAccount', d); },
      deleteTransaction(id){ return this.request('deleteTransaction', { id }); },
      deleteMember(id){ return this.request('deleteMember', { id }); },
      deleteActivity(id){ return this.request('deleteActivity', { id }); },
      deleteAnnouncement(id){ return this.request('deleteAnnouncement', { id }); },
      deleteForm(id){ return this.request('deleteForm', { id }); },
      deleteAccount(id){ return this.request('deleteAccount', { id }); },
      batchImport(type, records){ return this.request('batchImport', { type, records }); },
      exportData(type){ return this.request('exportData', { type }); },
      getAnalytics(){ return this.request('getAnalytics'); },
      generateReport(p){ return this.request('generateReport', p); },
      getSettings(){ return this.request('getSettings'); },
      updateSettings(d){ return this.request('updateSettings', d); },
      testConnection(){ return this.request('testConnection'); }
    };

    /*********** 版面控制 ***********/
    const AppLayout = {
      currentSection: 'dashboard',
      async init() {
        try {
          await API.testConnection();
          await this.loadInitialData();
          this.showSection('dashboard');
          this.bindEvents();
        } catch (err) {
          this.showError('系統初始化失敗：' + err.message);
        }
      },
      async loadInitialData() {
        const d = await API.getAllData();
          Object.assign(globalData, d);
        globalData.lastUpdate = new Date().toISOString();
      },
      showSection(section) {
        document.querySelectorAll('.sidebar .nav-link').forEach(a=>a.classList.remove('active'));
        const link = Array.from(document.querySelectorAll('.sidebar .nav-link'))
          .find(a => a.getAttribute('onclick')?.includes(section));
        if (link) link.classList.add('active');
        this.currentSection = section;
        switch(section) {
          case 'dashboard': this.renderDashboard(); break;
          case 'transactions': Transactions.render(); break;
          case 'members': Members.render(); break;
          case 'activities': Activities.render(); break;
          case 'announcements': Announcements.render(); break;
          case 'forms': Forms.render(); break;
          case 'accounts': Accounts.render(); break;
          case 'reports': Reports.render(); break;
          case 'settings': Settings.render(); break;
          default: this.renderDashboard();
        }
      },
      async renderDashboard() {
        try {
          const d = await API.getDashboardData();
          const html = `
            <div class="fade-in">
              <div class="row mb-4">
                <div class="col-md-3 mb-3">
                  <div class="stats-card">
                    <div class="stats-number">${d.members?.active||0}</div>
                    <div><i class="fas fa-users me-1"></i>活躍會員</div>
                  </div>
                </div>
                <div class="col-md-3 mb-3">
                  <div class="stats-card">
                    <div class="stats-number">${d.activities?.upcoming||0}</div>
                    <div><i class="fas fa-calendar me-1"></i>即將活動</div>
                  </div>
                </div>
                <div class="col-md-3 mb-3">
                  <div class="stats-card">
                    <div class="stats-number text-success">$${this.formatNumber(d.financial?.monthIncome||0)}</div>
                    <div><i class="fas fa-arrow-up me-1"></i>本月收入</div>
                  </div>
                </div>
                <div class="col-md-3 mb-3">
                  <div class="stats-card">
                    <div class="stats-number text-primary">$${this.formatNumber(d.totalBalance||0)}</div>
                    <div><i class="fas fa-wallet me-1"></i>帳戶餘額</div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-8 mb-4">
                  <div class="card">
                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>財務趨勢</h5></div>
                    <div class="card-body"><canvas id="financialChart" height="120"></canvas></div>
                  </div>
                </div>
                <div class="col-md-4 mb-4">
                  <div class="card">
                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>最新公告</h5></div>
                    <div class="card-body">${this.renderLatestAnnouncements(d.latestAnnouncements||[])}</div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-4">
                  <div class="card">
                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>近期活動</h5></div>
                    <div class="card-body">${this.renderUpcomingActivities(d.upcomingActivities||[])}</div>
                  </div>
                </div>
                <div class="col-md-6 mb-4">
                  <div class="card">
                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-pie-chart me-2"></i>會員統計</h5></div>
                    <div class="card-body"><canvas id="memberChart" height="200"></canvas></div>
                  </div>
                </div>
              </div>
            </div>`;
          document.getElementById('contentArea').innerHTML = html;
          this.renderFinancialChart(d.financial);
          this.renderMemberChart(d.members);
        } catch (err) {
          this.showError('載入儀表板失敗：' + err.message);
        }
      },
      renderLatestAnnouncements(list) {
        if (!list.length) return '<p class="text-muted">暫無公告</p>';
        return list.map(a=>`
          <div class="border-bottom pb-2 mb-2">
            <h6 class="mb-1">${a['標題']}</h6>
            <small class="text-muted">${this.formatDate(a['發布日期'])}</small>
          </div>
        `).join('');
      },
      renderUpcomingActivities(list) {
        if (!list.length) return '<p class="text-muted">暫無活動</p>';
        return list.map(a=>`
          <div class="border-bottom pb-2 mb-2">
            <h6 class="mb-1">${a['活動名稱']}</h6>
            <small class="text-muted">
              <i class="fas fa-calendar me-1"></i>${this.formatDate(a['日期'])}
              <i class="fas fa-map-marker-alt ms-2 me-1"></i>${a['地點']||'待定'}
            </small>
          </div>
        `).join('');
      },
      renderFinancialChart(financial) {
        const ctx = document.getElementById('financialChart');
        if (!ctx) return;
        // 示意：最後一個月使用當月收入支出，其餘為假資料（可改由後端提供月度序列）
        new Chart(ctx, {
          type:'line',
          data:{
            labels:['1月','2月','3月','4月','5月','本月'],
            datasets:[
              {
                label:'收入',
                data:[12000,15000,18000,14000,16000, financial?.monthIncome||0],
                borderColor:'rgb(39,174,96)',
                backgroundColor:'rgba(39,174,96,.15)',
                tension:.35
              },
              {
                label:'支出',
                data:[8000,12000,15000,11000,13000, financial?.monthExpense||0],
                borderColor:'rgb(231,76,60)',
                backgroundColor:'rgba(231,76,60,.15)',
                tension:.35
              }
            ]
          },
          options:{ responsive:true, maintainAspectRatio:false }
        });
      },
      renderMemberChart(members) {
        const ctx = document.getElementById('memberChart');
        if (!ctx) return;
        new Chart(ctx, {
          type:'doughnut',
          data:{
            labels:['活躍','非活躍'],
            datasets:[{
              data:[members?.active||0, members?.inactive||0],
              backgroundColor:['rgb(52,152,219)','rgb(149,165,166)']
            }]
          },
          options:{ responsive:true, maintainAspectRatio:false }
        });
      },
      toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('show');
        document.getElementById('sidebar').classList.toggle('collapsed');
        document.getElementById('mainContent').classList.toggle('expanded');
      },
      showLoading(b) { document.getElementById('loadingOverlay').style.display = b?'flex':'none'; },
      showSuccess(msg) { Swal.fire({ icon:'success', title:'成功', text:msg, timer:1800, showConfirmButton:false }); },
      showError(msg) { Swal.fire({ icon:'error', title:'錯誤', text:msg }); },
      showConfirm(msg, cb) {
        Swal.fire({ title:'確認', text:msg, icon:'question', showCancelButton:true, confirmButtonText:'確定', cancelButtonText:'取消'})
          .then(r=>{ if(r.isConfirmed && cb) cb(); });
      },
      formatDate(s) { if(!s)return '-'; const d=new Date(s); return d.toLocaleDateString('zh-TW'); },
      formatNumber(n) { return new Intl.NumberFormat('zh-TW').format(n); },
      formatCurrency(n){ return new Intl.NumberFormat('zh-TW',{ style:'currency', currency:'TWD'}).format(Number(n||0)); },
      async refreshData() {
        try { await this.loadInitialData(); this.showSection(this.currentSection); this.showSuccess('資料已更新'); }
        catch(e){ this.showError('更新失敗：'+e.message); }
      },
      showHelp() {
        Swal.fire({
          title:'系統說明',
          html:`<div class="text-start">
            <ul><li>財務 / 會員 / 活動 / 公告 / 帳戶 / 表單 / 報表 / 設定</li></ul>
            <p class="mb-1"><strong>快捷鍵</strong></p>
            <ul>
              <li>Ctrl + R：重新整理</li>
              <li>Ctrl + F：聚焦第一個搜尋框</li>
            </ul>
          </div>`,
          width:'600px'
        });
      },
      showProfile(){ Swal.fire({ icon:'info', title:'個人資料', text:'功能開發中...' }); },
      logout(){ this.showConfirm('確定要重新載入頁面（模擬登出）？', ()=> location.reload()); },
      bindEvents() {
        document.addEventListener('keydown', e=>{
          if (e.ctrlKey) {
            if (e.key==='r') { e.preventDefault(); this.refreshData(); }
            if (e.key==='f') { e.preventDefault(); const input=document.querySelector('input[type="text"]'); if(input) input.focus(); }
          }
        });
        window.addEventListener('resize', ()=>{
          if (window.innerWidth>768) document.getElementById('sidebar').classList.remove('show');
        });
      }
    };

    /*********** 活動管理 ***********/
    const Activities = {
      currentData: [],
      async render() {
        const html = `
          <div class="fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="fas fa-calendar-alt me-2"></i>活動管理</h2>
              <div>
                <button class="btn btn-success me-2" onclick="Activities.showAddModal()"><i class="fas fa-plus me-1"></i>新增活動</button>
                <button class="btn btn-info me-2" onclick="BatchImport.open('activities')"><i class="fas fa-upload me-1"></i>批次匯入</button>
                <button class="btn btn-secondary me-2" onclick="Activities.exportData()"><i class="fas fa-download me-1"></i>匯出</button>
                <button class="btn btn-outline-secondary" onclick="Activities.showFilter()"><i class="fas fa-filter"></i></button>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="row align-items-center">
                  <div class="col-md-6"><h5 class="mb-0">活動列表</h5></div>
                  <div class="col-md-6">
                    <div class="input-group">
                      <input type="text" class="form-control" id="activitySearch" placeholder="搜尋活動..." onkeyup="Activities.search()">
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body" id="activityTable"></div>
            </div>
          </div>`;
        document.getElementById('contentArea').innerHTML = html;
        await this.loadData();
      },
      async loadData() {
        try {
          this.currentData = await API.getActivities();
          this.renderTable(this.currentData);
        } catch (err) {
          AppLayout.showError('載入活動失敗：'+err.message);
        }
      },
      renderTable(data) {
        const tbody = data.map(a=>`
          <tr>
            <td><strong>${a['活動名稱']||'-'}</strong></td>
            <td>${a['類型']||'-'}</td>
            <td>${AppLayout.formatDate(a['日期'])}</td>
            <td>${a['地點']||'-'}</td>
            <td><span class="badge bg-info">${a['目前人數']||0}/${a['最大人數']||'∞'}</span></td>
            <td>${AppLayout.formatCurrency(a['費用']||0)}</td>
            <td><span class="badge ${this.getStatusClass(a['狀態'])}">${this.getStatusText(a['狀態'])}</span></td>
            <td>${a['負責人']||'-'}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="Activities.showEditModal('${a['ID']}')"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="Activities.deleteActivity('${a['ID']}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `).join('');
        const html = `
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr><th>活動名稱</th><th>類型</th><th>日期</th><th>地點</th><th>人數</th><th>費用</th><th>狀態</th><th>負責人</th><th>操作</th></tr>
              </thead>
              <tbody>${tbody}</tbody>
            </table>
          </div>`;
        document.getElementById('activityTable').innerHTML = html;
      },
      getStatusClass(s) {
        return {
          planning:'bg-warning', published:'bg-success', ongoing:'bg-info',
          completed:'bg-secondary', cancelled:'bg-danger'
        }[s] || 'bg-secondary';
      },
      getStatusText(s) {
        return {
          planning:'規劃中', published:'已發布', ongoing:'進行中',
          completed:'已完成', cancelled:'已取消'
        }[s] || '未知';
      },
      showAddModal() {
        Swal.fire({
          title:'新增活動',
          html:this.getActivityForm(),
          width:'900px',
          showCancelButton:true,
          confirmButtonText:'新增',
          cancelButtonText:'取消',
          preConfirm:()=>this.validateActivityForm()
        }).then(async r=>{
          if (r.isConfirmed) {
            try {
              await API.addActivity(r.value);
              AppLayout.showSuccess('已新增');
              this.loadData();
            } catch (err) { AppLayout.showError('新增失敗：'+err.message); }
          }
        });
      },
      getActivityForm(d={}) {
        return `
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">活動名稱 *</label>
              <input id="act_name" class="form-control" value="${d['活動名稱']||''}">
            </div>
            <div class="col-md-6">
              <label class="form-label">活動類型</label>
              <select id="act_type" class="form-select">
                ${['','講座','工作坊','聚會','戶外活動','志工服務','其他'].map(x=>`<option value="${x}" ${d['類型']===x?'selected':''}>${x||'請選擇'}</option>`).join('')}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">日期 *</label>
              <input type="date" id="act_date" class="form-control" value="${d['日期']||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">開始時間</label>
              <input type="time" id="act_start" class="form-control" value="${d['開始時間']||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">結束時間</label>
              <input type="time" id="act_end" class="form-control" value="${d['結束時間']||''}">
            </div>
            <div class="col-md-8">
              <label class="form-label">地點</label>
              <input id="act_loc" class="form-control" value="${d['地點']||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">最大人數</label>
              <input type="number" id="act_max" class="form-control" value="${d['最大人數']||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">費用</label>
              <input type="number" id="act_fee" class="form-control" value="${d['費用']||0}">
            </div>
            <div class="col-md-4">
              <label class="form-label">負責人</label>
              <input id="act_owner" class="form-control" value="${d['負責人']||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">狀態</label>
              <select id="act_status" class="form-select">
                ${['planning','published','ongoing','completed','cancelled'].map(s=>`
                  <option value="${s}" ${d['狀態']===s?'selected':''}>${Activities.getStatusText(s)}</option>`).join('')}
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">描述</label>
              <textarea id="act_desc" rows="3" class="form-control">${d['描述']||''}</textarea>
            </div>
          </div>`;
      },
      validateActivityForm() {
        const name = document.getElementById('act_name').value.trim();
        const date = document.getElementById('act_date').value;
        if (!name) { Swal.showValidationMessage('請輸入活動名稱'); return false; }
        if (!date) { Swal.showValidationMessage('請選擇日期'); return false; }
        return {
          name,
          type: document.getElementById('act_type').value,
          date,
          startTime: document.getElementById('act_start').value,
          endTime: document.getElementById('act_end').value,
          location: document.getElementById('act_loc').value,
          maxParticipants: parseInt(document.getElementById('act_max').value)||0,
          fee: parseFloat(document.getElementById('act_fee').value)||0,
          organizer: document.getElementById('act_owner').value,
          description: document.getElementById('act_desc').value,
          status: document.getElementById('act_status').value,
          currentParticipants: 0
        };
      },
      search() {
        const kw = document.getElementById('activitySearch').value.toLowerCase();
        if (!kw) return this.renderTable(this.currentData);
        const filtered = this.currentData.filter(a =>
          Object.values(a).some(v=> String(v).toLowerCase().includes(kw))
        );
        this.renderTable(filtered);
      },
      async deleteActivity(id) {
        AppLayout.showConfirm('確定刪除活動？', async ()=>{
          try { await API.deleteActivity(id); AppLayout.showSuccess('已刪除'); this.loadData(); }
          catch(e){ AppLayout.showError('刪除失敗：'+e.message); }
        });
      },
      async exportData() {
        try {
          const r = await API.exportData('activities');
          const blob = new Blob([JSON.stringify(r.data,null,2)], { type:'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'activities_'+new Date().toISOString().slice(0,10)+'.json';
          a.click();
          URL.revokeObjectURL(url);
          AppLayout.showSuccess('匯出完成');
        } catch(err) {
          AppLayout.showError('匯出失敗：'+err.message);
        }
      },
      showFilter() {
        Swal.fire({
          title:'篩選條件',
          html: `
            <div class="text-start">
              <label class="form-label">狀態</label>
              <select id="flt_status" class="form-select mb-2">
                <option value="">(全部)</option>
                <option value="planning">規劃中</option>
                <option value="published">已發布</option>
                <option value="ongoing">進行中</option>
                <option value="completed">已完成</option>
                <option value="cancelled">已取消</option>
              </select>
              <label class="form-label">類型</label>
              <input id="flt_type" class="form-control mb-2" placeholder="輸入類型關鍵字">
              <label class="form-label">起始日期</label>
              <input type="date" id="flt_start" class="form-control mb-2">
              <label class="form-label">結束日期</label>
              <input type="date" id="flt_end" class="form-control">
            </div>`,
          showCancelButton:true,
          confirmButtonText:'套用',
          cancelButtonText:'取消',
          preConfirm:()=>{
            return {
              status: document.getElementById('flt_status').value,
              type: document.getElementById('flt_type').value.trim().toLowerCase(),
              start: document.getElementById('flt_start').value,
              end: document.getElementById('flt_end').value
            };
          }
        }).then(r=>{
          if (r.isConfirmed) {
            const {status,type,start,end} = r.value;
            let filtered = [...this.currentData];
            if (status) filtered = filtered.filter(a=>a['狀態']===status);
            if (type) filtered = filtered.filter(a=>(a['類型']||'').toLowerCase().includes(type));
            if (start) filtered = filtered.filter(a=> new Date(a['日期']) >= new Date(start));
            if (end) filtered = filtered.filter(a=> new Date(a['日期']) <= new Date(end));
            this.renderTable(filtered);
          }
        });
      },
      showEditModal(id) {
        const act = this.currentData.find(a=>a['ID']===id);
        if (!act) return AppLayout.showError('找不到活動');
        Swal.fire({
          title:'編輯活動',
          html:this.getActivityForm(act),
          width:'900px',
          showCancelButton:true,
          confirmButtonText:'儲存',
          cancelButtonText:'取消',
          preConfirm:()=>this.validateActivityForm()
        }).then(async r=>{
          if (r.isConfirmed) {
            try {
              const payload = { id, ...r.value };
              await API.updateActivity(payload);
              AppLayout.showSuccess('已更新');
              this.loadData();
            } catch (e) {
              AppLayout.showError('更新失敗：'+e.message);
            }
          }
        });
      }
    };

    /*********** 公告管理（保留精簡版） ***********/
    const Announcements = {
      currentData: [],
      async render() {
        const html = `
          <div class="fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="fas fa-bullhorn me-2"></i>公告管理</h2>
              <div>
                <button class="btn btn-success me-2" onclick="Announcements.showAddModal()"><i class="fas fa-plus me-1"></i>新增公告</button>
                <button class="btn btn-secondary" onclick="Announcements.exportData()"><i class="fas fa-download me-1"></i>匯出</button>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="row">
                  <div class="col-md-6"><h5 class="mb-0">公告列表</h5></div>
                  <div class="col-md-6">
                    <input id="announcementSearch" class="form-control" placeholder="搜尋公告..." onkeyup="Announcements.search()">
                  </div>
                </div>
              </div>
              <div class="card-body" id="announcementTable"></div>
            </div>
          </div>`;
        document.getElementById('contentArea').innerHTML = html;
        await this.loadData();
      },
      async loadData() {
        try { this.currentData = await API.getAnnouncements(); this.renderTable(this.currentData); }
        catch(e){ AppLayout.showError('載入公告失敗：'+e.message); }
      },
      renderTable(data) {
        const rows = data.map(a=>`
          <tr>
            <td><strong>${a['標題']||'-'}</strong></td>
            <td>${a['分類']||'-'}</td>
            <td>${AppLayout.formatDate(a['發布日期'])}</td>
            <td><span class="badge ${this.priorityClass(a['重要性'])}">${this.priorityText(a['重要性'])}</span></td>
            <td><span class="badge ${this.statusClass(a['狀態'])}">${this.statusText(a['狀態'])}</span></td>
            <td>${a['發布者']||'-'}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="Announcements.showEditModal('${a['ID']}')"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="Announcements.deleteAnnouncement('${a['ID']}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>`).join('');
        document.getElementById('announcementTable').innerHTML = `
          <div class="table-responsive">
            <table class="table table-hover">
              <thead><tr><th>標題</th><th>分類</th><th>發布日期</th><th>重要性</th><th>狀態</th><th>發布者</th><th>操作</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      },
      priorityClass(p){ return { high:'bg-danger', normal:'bg-info', low:'bg-secondary'}[p]||'bg-info'; },
      priorityText(p){ return { high:'重要', normal:'一般', low:'低'}[p]||'一般'; },
      statusClass(s){ return { draft:'bg-warning', published:'bg-success', archived:'bg-secondary'}[s]||'bg-warning'; },
      statusText(s){ return { draft:'草稿', published:'已發布', archived:'已封存'}[s]||'草稿'; },
      showAddModal() {
        Swal.fire({
          title:'新增公告',
          html:this.formHtml(),
          width:'800px',
          showCancelButton:true,
          confirmButtonText:'新增',
          preConfirm:()=>this.collectForm()
        }).then(async r=>{
          if(r.isConfirmed){
            try { await API.addAnnouncement(r.value); AppLayout.showSuccess('新增完成'); this.loadData(); }
            catch(e){ AppLayout.showError('新增失敗：'+e.message); }
          }
        });
      },
      formHtml(d={}) {
        return `
          <div class="mb-2">
            <label class="form-label">標題 *</label>
            <input id="ann_title" class="form-control" value="${d['標題']||''}">
          </div>
          <div class="mb-2">
            <label class="form-label">分類</label>
            <input id="ann_cat" class="form-control" value="${d['分類']||''}">
          </div>
          <div class="mb-2">
            <label class="form-label">內容 *</label>
            <textarea id="ann_content" class="form-control" rows="5">${d['內容']||''}</textarea>
          </div>
          <div class="row">
            <div class="col-md-4 mb-2">
              <label class="form-label">發布日期</label>
              <input type="date" id="ann_date" class="form-control" value="${d['發布日期']||new Date().toISOString().slice(0,10)}">
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-label">重要性</label>
              <select id="ann_priority" class="form-select">
                ${['normal','high','low'].map(x=>`<option value="${x}" ${d['重要性']===x?'selected':''}>${this.priorityText(x)}</option>`).join('')}
              </select>
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-label">狀態</label>
              <select id="ann_status" class="form-select">
                ${['draft','published','archived'].map(x=>`<option value="${x}" ${d['狀態']===x?'selected':''}>${this.statusText(x)}</option>`).join('')}
              </select>
            </div>
          </div>`;
      },
      collectForm() {
        const title = document.getElementById('ann_title').value.trim();
        const content = document.getElementById('ann_content').value.trim();
        if (!title) { Swal.showValidationMessage('請輸入標題'); return false; }
        if (!content) { Swal.showValidationMessage('請輸入內容'); return false; }
        return {
          title,
          content,
          category: document.getElementById('ann_cat').value.trim(),
          publishDate: document.getElementById('ann_date').value,
          priority: document.getElementById('ann_priority').value,
          status: document.getElementById('ann_status').value,
          publisher:'System'
        };
      },
      search() {
        const kw = document.getElementById('announcementSearch').value.toLowerCase();
        if (!kw) return this.renderTable(this.currentData);
        const f = this.currentData.filter(a=> Object.values(a).some(v=>String(v).toLowerCase().includes(kw)));
        this.renderTable(f);
      },
      async deleteAnnouncement(id) {
        AppLayout.showConfirm('確定刪除公告？', async ()=>{
          try { await API.deleteAnnouncement(id); AppLayout.showSuccess('已刪除'); this.loadData(); }
          catch(e){ AppLayout.showError('刪除失敗：'+e.message); }
        });
      },
      showEditModal(id) {
        const ann = this.currentData.find(a=>a['ID']===id);
        if (!ann) return AppLayout.showError('找不到公告');
        Swal.fire({
          title:'編輯公告',
          html:this.formHtml(ann),
          width:'800px',
          showCancelButton:true,
          confirmButtonText:'儲存',
          preConfirm:()=>this.collectForm()
        }).then(async r=>{
          if (r.isConfirmed) {
            try { await API.updateAnnouncement({ id, ...r.value }); AppLayout.showSuccess('已更新'); this.loadData(); }
            catch(e){ AppLayout.showError('更新失敗：'+e.message); }
          }
        });
      },
      async exportData() {
        try {
          const r = await API.exportData('announcements');
          const blob = new Blob([JSON.stringify(r.data,null,2)],{type:'application/json'});
          const url = URL.createObjectURL(blob);
          const a=document.createElement('a');
          a.href=url; a.download='announcements_'+new Date().toISOString().slice(0,10)+'.json'; a.click();
          URL.revokeObjectURL(url);
          AppLayout.showSuccess('匯出完成');
        } catch (e) {
          AppLayout.showError('匯出失敗：'+e.message);
        }
      }
    };

    /*********** 會員管理（簡化展示） ***********/
    const Members = {
      currentData: [],
      async render() {
        const html = `
          <div class="fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="fas fa-users me-2"></i>會員管理</h2>
              <div>
                <button class="btn btn-success me-2" onclick="Members.showAddModal()"><i class="fas fa-plus me-1"></i>新增會員</button>
                <button class="btn btn-info me-2" onclick="BatchImport.open('members')"><i class="fas fa-upload me-1"></i>批次匯入</button>
                <button class="btn btn-secondary" onclick="Members.exportData()"><i class="fas fa-download me-1"></i>匯出</button>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="row">
                  <div class="col-md-6"><h5 class="mb-0">會員列表</h5></div>
                  <div class="col-md-6">
                    <input id="memberSearch" class="form-control" placeholder="搜尋會員..." onkeyup="Members.search()">
                  </div>
                </div>
              </div>
              <div class="card-body" id="memberTable"></div>
            </div>
          </div>`;
        document.getElementById('contentArea').innerHTML = html;
        await this.loadData();
      },
      async loadData() {
        try { this.currentData = await API.getMembers(); this.renderTable(this.currentData); }
        catch(e){ AppLayout.showError('載入會員失敗：'+e.message); }
      },
      renderTable(data) {
        const rows = data.map(m=>`
          <tr>
            <td><strong>${m['姓名']||'-'}</strong></td>
            <td>${m['電話']||'-'}</td>
            <td>${m['Email']||'-'}</td>
            <td><span class="badge ${this.typeClass(m['會員類型'])}">${this.typeText(m['會員類型'])}</span></td>
            <td>${AppLayout.formatDate(m['加入日期'])}</td>
            <td><span class="badge ${this.statusClass(m['狀態'])}">${this.statusText(m['狀態'])}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="Members.showEditModal('${m['ID']}')"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="Members.deleteMember('${m['ID']}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>`).join('');
        document.getElementById('memberTable').innerHTML = `
          <div class="table-responsive">
            <table class="table table-hover">
              <thead><tr><th>姓名</th><th>電話</th><th>Email</th><th>會員類型</th><th>加入日期</th><th>狀態</th><th>操作</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      },
      typeClass(t){ return { regular:'bg-info', vip:'bg-warning', lifetime:'bg-success'}[t]||'bg-info'; },
      typeText(t){ return { regular:'一般會員', vip:'VIP會員', lifetime:'終身會員'}[t]||'一般會員'; },
      statusClass(s){ return { active:'bg-success', inactive:'bg-secondary', suspended:'bg-danger'}[s]||'bg-success'; },
      statusText(s){ return { active:'活躍', inactive:'非活躍', suspended:'暫停'}[s]||'活躍'; },
      showAddModal() {
        Swal.fire({
          title:'新增會員',
          html:this.formHtml(),
          showCancelButton:true,
          confirmButtonText:'新增',
          preConfirm:()=>this.collectForm()
        }).then(async r=>{
          if (r.isConfirmed) {
            try { await API.addMember(r.value); AppLayout.showSuccess('新增完成'); this.loadData(); }
            catch(e){ AppLayout.showError('新增失敗：'+e.message); }
          }
        });
      },
      formHtml(d={}) {
        return `
          <div class="mb-2"><label class="form-label">姓名 *</label><input id="m_name" class="form-control" value="${d['姓名']||''}"></div>
          <div class="mb-2"><label class="form-label">電話 *</label><input id="m_phone" class="form-control" value="${d['電話']||''}"></div>
          <div class="mb-2"><label class="form-label">Email</label><input id="m_email" class="form-control" value="${d['Email']||''}"></div>
          <div class="row">
            <div class="col-md-6 mb-2"><label class="form-label">加入日期</label><input type="date" id="m_join" class="form-control" value="${d['加入日期']||new Date().toISOString().slice(0,10)}"></div>
            <div class="col-md-6 mb-2"><label class="form-label">會員類型</label>
              <select id="m_type" class="form-select">
                <option value="regular" ${d['會員類型']==='regular'?'selected':''}>一般</option>
                <option value="vip" ${d['會員類型']==='vip'?'selected':''}>VIP</option>
                <option value="lifetime" ${d['會員類型']==='lifetime'?'selected':''}>終身</option>
              </select>
            </div>
          </div>
          <div class="mb-2"><label class="form-label">狀態</label>
            <select id="m_status" class="form-select">
              <option value="active" ${d['狀態']==='active'?'selected':''}>活躍</option>
              <option value="inactive" ${d['狀態']==='inactive'?'selected':''}>非活躍</option>
              <option value="suspended" ${d['狀態']==='suspended'?'selected':''}>暫停</option>
            </select>
          </div>
          <div class="mb-2"><label class="form-label">備註</label><textarea id="m_notes" class="form-control" rows="3">${d['備註']||''}</textarea></div>`;
      },
      collectForm() {
        const name=document.getElementById('m_name').value.trim();
        const phone=document.getElementById('m_phone').value.trim();
        if (!name) { Swal.showValidationMessage('請輸入姓名'); return false; }
        if (!phone) { Swal.showValidationMessage('請輸入電話'); return false; }
        return {
          name, phone,
          email: document.getElementById('m_email').value.trim(),
          joinDate: document.getElementById('m_join').value,
          type: document.getElementById('m_type').value,
          status: document.getElementById('m_status').value,
          notes: document.getElementById('m_notes').value
        };
      },
      showEditModal(id) {
        const m = this.currentData.find(x=>x['ID']===id);
        if (!m) return AppLayout.showError('找不到會員');
        Swal.fire({
          title:'編輯會員',
          html:this.formHtml(m),
          showCancelButton:true,
          confirmButtonText:'儲存',
          preConfirm:()=>this.collectForm()
        }).then(async r=>{
          if (r.isConfirmed) {
            try { await API.updateMember({ id, ...r.value }); AppLayout.showSuccess('已更新'); this.loadData(); }
            catch(e){ AppLayout.showError('更新失敗：'+e.message); }
          }
        });
      },
      search() {
        const kw = document.getElementById('memberSearch').value.toLowerCase();
        if (!kw) return this.renderTable(this.currentData);
        const f = this.currentData.filter(m=> Object.values(m).some(v=>String(v).toLowerCase().includes(kw)));
        this.renderTable(f);
      },
      async deleteMember(id) {
        AppLayout.showConfirm('確定刪除會員？', async ()=>{
          try { await API.deleteMember(id); AppLayout.showSuccess('已刪除'); this.loadData(); }
          catch(e){ AppLayout.showError('刪除失敗：'+e.message); }
        });
      },
      async exportData() {
        try {
          const r = await API.exportData('members');
          const blob = new Blob([JSON.stringify(r.data,null,2)],{type:'application/json'});
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a');
          a.href=url; a.download='members_'+new Date().toISOString().slice(0,10)+'.json'; a.click();
          URL.revokeObjectURL(url);
          AppLayout.showSuccess('匯出完成');
        } catch(e){ AppLayout.showError('匯出失敗：'+e.message); }
      }
    };

    /*********** 財務 / 其他模組（僅保留主要片段，依需要擴充） ***********/
    const Transactions = {
      currentData: [],
      async render() {
        const html = `
          <div class="fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="fas fa-money-bill-wave me-2"></i>財務管理</h2>
              <div>
                <button class="btn btn-success me-2" onclick="Transactions.showAddModal()"><i class="fas fa-plus me-1"></i>新增交易</button>
                <button class="btn btn-info me-2" onclick="BatchImport.open('transactions')"><i class="fas fa-upload me-1"></i>批次匯入</button>
                <button class="btn btn-secondary" onclick="Transactions.exportData()"><i class="fas fa-download me-1"></i>匯出</button>
              </div>
            </div>
            <div class="row mb-4">
              <div class="col-md-3"><div class="stats-card"><div id="totalIncome" class="stats-number text-success">$0</div><div>總收入</div></div></div>
              <div class="col-md-3"><div class="stats-card"><div id="totalExpense" class="stats-number text-danger">$0</div><div>總支出</div></div></div>
              <div class="col-md-3"><div class="stats-card"><div id="netProfit" class="stats-number text-primary">$0</div><div>淨利潤</div></div></div>
              <div class="col-md-3"><div class="stats-card"><div id="transactionCount" class="stats-number">0</div><div>交易筆數</div></div></div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="row">
                  <div class="col-md-6"><h5 class="mb-0">交易記錄</h5></div>
                  <div class="col-md-6"><input id="transactionSearch" class="form-control" placeholder="搜尋交易..." onkeyup="Transactions.search()"></div>
                </div>
              </div>
              <div class="card-body" id="transactionTable"></div>
            </div>
          </div>`;
        document.getElementById('contentArea').innerHTML = html;
        await this.loadData();
      },
      async loadData() {
        try {
          this.currentData = await API.getTransactions();
          this.renderTable(this.currentData);
          this.updateStats();
        } catch (e) { AppLayout.showError('載入交易失敗：'+e.message); }
      },
      renderTable(data) {
        const rows = data.map(t=>`
          <tr>
            <td>${AppLayout.formatDate(t['日期'])}</td>
            <td><span class="badge ${t['類型']==='收入'?'bg-success':'bg-danger'}">${t['類型']}</span></td>
            <td>${t['類別']||'-'}</td>
            <td class="${t['類型']==='收入'?'text-success':'text-danger'}">${AppLayout.formatCurrency(t['金額']||0)}</td>
            <td>${t['對象']||'-'}</td>
            <td>${t['帳戶']||'-'}</td>
            <td>${t['說明']||'-'}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="Transactions.showEditModal('${t['ID']}')"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="Transactions.deleteTransaction('${t['ID']}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>`).join('');
        document.getElementById('transactionTable').innerHTML = `
          <div class="table-responsive">
            <table class="table table-hover">
              <thead><tr><th>日期</th><th>類型</th><th>類別</th><th>金額</th><th>對象</th><th>帳戶</th><th>說明</th><th>操作</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      },
      updateStats() {
        let income=0, expense=0;
          this.currentData.forEach(t=>{
          const amt=Number(t['金額']||0);
          if(t['類型']==='收入') income+=amt;
          else if(t['類型']==='支出') expense+=amt;
        });
        document.getElementById('totalIncome').textContent=AppLayout.formatCurrency(income);
        document.getElementById('totalExpense').textContent=AppLayout.formatCurrency(expense);
        document.getElementById('netProfit').textContent=AppLayout.formatCurrency(income-expense);
        document.getElementById('transactionCount').textContent=this.currentData.length;
      },
      search() {
        const kw = document.getElementById('transactionSearch').value.toLowerCase();
        if(!kw) return this.renderTable(this.currentData);
        const f = this.currentData.filter(t=> Object.values(t).some(v=> String(v).toLowerCase().includes(kw)));
        this.renderTable(f);
      },
      showAddModal() {
        Swal.fire({
          title:'新增交易',
          html:this.formHtml(),
          showCancelButton:true,
          confirmButtonText:'新增',
          preConfirm:()=>this.collectForm()
        }).then(async r=>{
          if(r.isConfirmed) {
            try { await API.addTransaction(r.value); AppLayout.showSuccess('已新增'); this.loadData(); }
            catch(e){ AppLayout.showError('新增失敗：'+e.message); }
          }
        });
      },
      formHtml(d={}) {
        return `
          <div class="mb-2"><label class="form-label">日期 *</label><input type="date" id="trx_date" class="form-control" value="${d['日期']||new Date().toISOString().slice(0,10)}"></div>
          <div class="mb-2"><label class="form-label">類型 *</label>
            <select id="trx_type" class="form-select">
              <option value="收入" ${d['類型']==='收入'?'selected':''}>收入</option>
              <option value="支出" ${d['類型']==='支出'?'selected':''}>支出</option>
            </select>
          </div>
          <div class="mb-2"><label class="form-label">類別</label><input id="trx_cat" class="form-control" value="${d['類別']||''}"></div>
          <div class="mb-2"><label class="form-label">金額 *</label><input type="number" id="trx_amt" class="form-control" value="${d['金額']||''}"></div>
          <div class="mb-2"><label class="form-label">對象</label><input id="trx_cp" class="form-control" value="${d['對象']||''}"></div>
          <div class="mb-2"><label class="form-label">帳戶</label><input id="trx_acc" class="form-control" value="${d['帳戶']||''}"></div>
          <div class="mb-2"><label class="form-label">說明</label><textarea id="trx_desc" class="form-control" rows="3">${d['說明']||''}</textarea></div>`;
      },
      collectForm() {
        const date=document.getElementById('trx_date').value;
        const type=document.getElementById('trx_type').value;
        const amt=document.getElementById('trx_amt').value;
        if(!date){ Swal.showValidationMessage('請輸入日期'); return false; }
        if(!amt){ Swal.showValidationMessage('請輸入金額'); return false; }
        return {
          date,
          type,
          category: document.getElementById('trx_cat').value,
          amount: parseFloat(amt),
          counterparty: document.getElementById('trx_cp').value,
          account: document.getElementById('trx_acc').value,
          description: document.getElementById('trx_desc').value
        };
      },
      showEditModal(id) {
        const t = this.currentData.find(x=>x['ID']===id);
        if(!t) return AppLayout.showError('找不到交易');
        Swal.fire({
          title:'編輯交易',
          html:this.formHtml(t),
          showCancelButton:true,
          confirmButtonText:'儲存',
          preConfirm:()=>this.collectForm()
        }).then(async r=>{
          if(r.isConfirmed){
            try { await API.updateTransaction({ id, ...r.value }); AppLayout.showSuccess('已更新'); this.loadData(); }
            catch(e){ AppLayout.showError('更新失敗：'+e.message); }
          }
        });
      },
      async deleteTransaction(id) {
        AppLayout.showConfirm('確定刪除交易？', async ()=>{
          try { await API.deleteTransaction(id); AppLayout.showSuccess('已刪除'); this.loadData(); }
          catch(e){ AppLayout.showError('刪除失敗：'+e.message); }
        });
      },
      async exportData() {
        try {
          const r = await API.exportData('transactions');
          const blob = new Blob([JSON.stringify(r.data,null,2)],{type:'application/json'});
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a');
          a.href=url; a.download='transactions_'+new Date().toISOString().slice(0,10)+'.json'; a.click();
          URL.revokeObjectURL(url);
          AppLayout.showSuccess('匯出完成');
        } catch(e){ AppLayout.showError('匯出失敗：'+e.message); }
      }
    };

    // 其餘模組（Forms, Accounts, Reports, Settings, BatchImport）可沿用你原有版本，此處保留核心展示。你若需要我補全再告訴我。
    const Forms = { render(){ document.getElementById('contentArea').innerHTML='<h3>表單管理（待擴充）</h3>'; } };
    const Accounts = { render(){ document.getElementById('contentArea').innerHTML='<h3>帳戶管理（待擴充）</h3>'; } };
    const Reports = {
      render() {
        document.getElementById('contentArea').innerHTML=`
          <div class="fade-in">
            <h2><i class="fas fa-chart-bar me-2"></i>報表分析</h2>
            <div class="row">
              <div class="col-md-4 mb-3">
                <div class="card text-center p-3">
                  <i class="fas fa-money-bill-wave fa-3x text-success mb-2"></i>
                  <h5>財務報表</h5>
                  <button class="btn btn-success mt-2" onclick="Reports.genFinancial()">產生</button>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card text-center p-3">
                  <i class="fas fa-users fa-3x text-primary mb-2"></i>
                  <h5>會員報表</h5>
                  <button class="btn btn-primary mt-2" onclick="Reports.genMember()">產生</button>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card text-center p-3">
                  <i class="fas fa-calendar-alt fa-3x text-info mb-2"></i>
                  <h5>活動報表</h5>
                  <button class="btn btn-info mt-2" onclick="Reports.genActivity()">產生</button>
                </div>
              </div>
            </div>
          </div>`;
      },
      async genFinancial() {
        try {
          const r = await API.generateReport({
            type:'financial',
            startDate:'2024-01-01',
            endDate:new Date().toISOString().slice(0,10)
          });
          Swal.fire({
            title:'財務報表',
            html:`<div class="text-start">
              期間：${r.period.startDate} ~ ${r.period.endDate}<hr>
              總收入：<span class="text-success">${AppLayout.formatCurrency(r.summary.totalIncome)}</span><br>
              總支出：<span class="text-danger">${AppLayout.formatCurrency(r.summary.totalExpense)}</span><br>
              淨利潤：<span class="text-primary">${AppLayout.formatCurrency(r.summary.netProfit)}</span><br>
              交易筆數：${r.summary.transactionCount}
            </div>`
          });
        } catch(e){ AppLayout.showError('產生報表失敗：'+e.message); }
      },
      async genMember() {
        try {
          const r = await API.generateReport({ type:'member' });
          Swal.fire({
            title:'會員報表',
            html:`<div class="text-start">
              總會員：${r.stats.total}<br>
              活躍：${r.stats.active} / 非活躍：${r.stats.inactive}<hr>
              依類型：<pre>${JSON.stringify(r.stats.byType,null,2)}</pre>
              依性別：<pre>${JSON.stringify(r.stats.byGender,null,2)}</pre>
            </div>`,
            width:'650px'
          });
        } catch(e){ AppLayout.showError('產生報表失敗：'+e.message); }
      },
      async genActivity() {
        try {
          const r = await API.generateReport({
            type:'activity',
            startDate:'2024-01-01',
            endDate:new Date().toISOString().slice(0,10)
          });
          Swal.fire({
            title:'活動報表',
            html:`<div class="text-start">
              期間：${r.period.startDate} ~ ${r.period.endDate}<hr>
              活動數：${r.stats.total}<br>
              已完成：${r.stats.completed} / 已取消：${r.stats.cancelled}<br>
              總參與人數：${r.stats.totalParticipants}<br>
              總收入 (估)：${AppLayout.formatCurrency(r.stats.totalRevenue)}
            </div>`
          });
        } catch(e){ AppLayout.showError('產生報表失敗：'+e.message); }
      }
    };
    const Settings = {
      async render() {
        const s = await API.getSettings();
        const html = `
          <div class="fade-in">
            <h2><i class="fas fa-cog me-2"></i>系統設定</h2>
            <div class="card">
              <div class="card-header"><h5 class="mb-0">基本設定</h5></div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">組織名稱</label>
                    <input id="set_org" class="form-control" value="${s.organization_name||''}">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">貨幣</label>
                    <select id="set_currency" class="form-select">
                      ${['TWD','USD','CNY'].map(c=>`<option value="${c}" ${s.currency===c?'selected':''}>${c}</option>`).join('')}
                    </select>
                  </div>
                </div>
                <button class="btn btn-primary" onclick="Settings.save()"><i class="fas fa-save me-1"></i>儲存</button>
                <button class="btn btn-secondary ms-2" onclick="Settings.test()"><i class="fas fa-plug me-1"></i>測試連線</button>
              </div>
            </div>
          </div>`;
        document.getElementById('contentArea').innerHTML = html;
      },
      async save() {
        try {
          await API.updateSettings({
            organization_name: document.getElementById('set_org').value,
            currency: document.getElementById('set_currency').value
          });
          AppLayout.showSuccess('設定已儲存');
          await AppLayout.loadInitialData();
        } catch(e){ AppLayout.showError('儲存失敗：'+e.message); }
      },
      async test() {
        try {
          const r = await API.testConnection();
          AppLayout.showSuccess(`連線成功：${r.spreadsheetName}`);
        } catch(e){ AppLayout.showError('測試失敗：'+e.message); }
      }
    };
    const BatchImport = {
      open(type) {
        Swal.fire({
          title:'批次匯入',
          html:`<input type="file" accept=".csv" id="csv_file" class="form-control mb-2">
                <div class="alert alert-info p-2 mb-0"><small>請確保第一行為欄位標題。簡易 CSV 解析（不支援含引號逗號複雜情況）。</small></div>`,
          showCancelButton:true,
          confirmButtonText:'匯入',
          preConfirm:()=>{
            const f = document.getElementById('csv_file').files[0];
            if(!f){ Swal.showValidationMessage('請選擇檔案'); return false; }
            return f;
          }
        }).then(async r=>{
          if(r.isConfirmed){
            try {
              const records = await this.parseCSV(r.value);
              const res = await API.batchImport(type, records);
              AppLayout.showSuccess(`匯入完成：成功 ${res.successCount} / 失敗 ${res.errorCount}`);
              AppLayout.refreshData();
            } catch(e){ AppLayout.showError('匯入失敗：'+e.message); }
          }
        });
      },
      parseCSV(file) {
        return new Promise((resolve, reject)=>{
          const reader = new FileReader();
          reader.onload = e => {
            try {
              let text = e.target.result;
              text = text.replace(/^\uFEFF/,''); // 去 BOM
              const lines = text.split(/\r?\n/).filter(l=>l.trim());
              if (!lines.length) return resolve([]);
              const headers = lines[0].split(',').map(h=>h.trim());
              const out = [];
              for (let i=1;i<lines.length;i++){
                const cols = lines[i].split(',');
                const obj={};
                headers.forEach((h,idx)=> obj[h]= (cols[idx]||'').trim());
                out.push(obj);
              }
              resolve(out);
            } catch(err){ reject(err); }
          };
          reader.onerror = ()=> reject(new Error('檔案讀取失敗'));
          reader.readAsText(file, 'UTF-8');
        });
      }
    };

    document.addEventListener('DOMContentLoaded', ()=> AppLayout.init());
  </script>
</body>
</html>

<!-- 
# 使用步驟簡要

1. 後端：開啟 Apps Script 專案 → 貼上新版 Code.gs → 修改 SPREADSHEET_ID → 部署「新版」Web App（執行者 Me，存取 Anyone）。
2. 前端：更新 CONFIG.GAS_URL 為部署後網址；如開啟 API_KEY，於 GAS_URL 後加 ?apiKey=KEY。
3. 推到 GitHub Pages；重新載入頁面測試。
4. 若仍遇到 CORS，確認：
   - 是否意外加入自訂 header（例如 Authorization、X- 開頭）
   - 是否仍用 Content-Type: application/json
   - 確認 Web App 版本已重新部署並使用最新 URL。

# 後續可選加強
- 新增月度趨勢 API（避免前端硬編 1~6 月）
- 前端表格分頁與快取
- 權限角色管理
- 完整 CSV 引號處理（導入 PapaParse）
- 報名 / 活動轉換率指標
- 背景備份排程（time-driven trigger）

若你想讓我再補：Forms / Accounts 全功能化、月度財務趨勢 API、或安全性（token 旋轉）實作，直接告訴我。

祝開發順利！需要更多優化我再幫你延伸。 (gpt-5) -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>組織管理系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- 核心套件 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root { --primary-color:#2c3e50; --secondary-color:#3498db; --success-color:#27ae60;
            --warning-color:#f39c12; --danger-color:#e74c3c; --sidebar-width:280px; }
    body { font-family:'Segoe UI',sans-serif; background:#f8f9fa; margin:0; }
    .sidebar { position:fixed; top:0; left:0; height:100vh; width:var(--sidebar-width);
               background:linear-gradient(135deg,var(--primary-color),#34495e); color:#fff;
               z-index:1000; transition:.3s; overflow-y:auto; }
    .sidebar.collapsed { transform:translateX(-100%); }
    .sidebar-header { padding:1.5rem; text-align:center; border-bottom:1px solid rgba(255,255,255,.1); }
    .nav-link { display:block; padding:.75rem 1.5rem; color:rgba(255,255,255,.85); text-decoration:none;
                transition:.3s; border-left:3px solid transparent; }
    .nav-link:hover { background:rgba(255,255,255,.12); color:#fff; border-left-color:var(--secondary-color); }
    .nav-link.active { background:rgba(52,152,219,.25); color:#fff; border-left-color:var(--secondary-color); }
    .main-content { margin-left:var(--sidebar-width); min-height:100vh; transition:.3s; }
    .main-content.expanded { margin-left:0; }
    .top-navbar { background:#fff; padding:1rem 1.5rem; display:flex; justify-content:space-between;
                  box-shadow:0 2px 4px rgba(0,0,0,.08); }
    .content-area { padding:1.5rem 2rem; }
    .stats-card { background:#fff; padding:1.2rem; border-radius:12px;
                  box-shadow:0 2px 8px rgba(0,0,0,.08); text-align:center; }
    .stats-card:hover { transform:translateY(-4px); transition:.3s; }
    .stats-number { font-size:1.9rem; font-weight:700; color:var(--primary-color); }
    .card { border:none; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.08); margin-bottom:1.5rem; }
    .card-header { background:#fff; border-bottom:1px solid #eee; border-radius:12px 12px 0 0!important; }
    .loading-overlay { position:fixed; inset:0; background:rgba(0,0,0,.65); display:none;
                       justify-content:center; align-items:center; z-index:2000; }
    .spinner { width:54px; height:54px; border:5px solid #f3f3f3; border-top:5px solid var(--secondary-color);
               border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    @media (max-width:768px) {
      .sidebar { transform:translateX(-100%); }
      .sidebar.show { transform:translateX(0); }
      .main-content { margin-left:0; }
    }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div></div>
  <nav id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <h4><i class="fas fa-users-cog me-2"></i>組織管理系統</h4>
      <small>v1.1.0</small>
    </div>
    <div class="nav-menu">
      <a href="#" class="nav-link active" onclick="AppLayout.showSection('dashboard')"><i class="fas fa-tachometer-alt"></i>儀表板</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('transactions')"><i class="fas fa-money-bill-wave"></i>財務管理</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('members')"><i class="fas fa-users"></i>會員管理</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('activities')"><i class="fas fa-calendar-alt"></i>活動管理</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('announcements')"><i class="fas fa-bullhorn"></i>公告管理</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('forms')"><i class="fas fa-file-alt"></i>表單管理</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('accounts')"><i class="fas fa-university"></i>帳戶管理</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('reports')"><i class="fas fa-chart-bar"></i>報表分析</a>
      <a href="#" class="nav-link" onclick="AppLayout.showSection('settings')"><i class="fas fa-cog"></i>系統設定</a>
    </div>
  </nav>
  <div id="mainContent" class="main-content">
    <div class="top-navbar">
      <div>
        <button class="btn btn-outline-secondary d-md-none" onclick="AppLayout.toggleSidebar()">
          <i class="fas fa-bars"></i>
        </button>
        <span class="ms-2 fw-bold">組織管理系統</span>
      </div>
      <div>
        <button class="btn btn-outline-primary me-2" onclick="AppLayout.refreshData()" title="重新整理">
          <i class="fas fa-sync-alt"></i>
        </button>
          <button class="btn btn-outline-info me-2" onclick="AppLayout.showHelp()"><i class="fas fa-question-circle"></i></button>
        <div class="dropdown d-inline">
          <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
            <i class="fas fa-user-circle"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="AppLayout.showProfile()"><i class="fas fa-user me-2"></i>個人資料</a></li>
            <li><a class="dropdown-item" href="#" onclick="AppLayout.showSection('settings')"><i class="fas fa-cog me-2"></i>設定</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="AppLayout.logout()"><i class="fas fa-sign-out-alt me-2"></i>登出</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div id="contentArea" class="content-area"></div>
  </div>

  <script>
    /*********** 設定 ***********/
    const CONFIG = {
      // 若後端有啟用 API_KEY，則在 URL 後加 ?apiKey=XXXX
      GAS_URL: 'https://script.google.com/macros/s/AKfycbwLQxfTR35EeRSCU4KG1KQo7GAPaYJQjdmle_NvFptgsT6XpUz0pvoGNH1nj3IoJS3Q1w/exec',
      DEBUG: true,
      VERSION: '1.1.0'
    };
    let globalData = {
      transactions: [],
      members: [],
      activities: [],
      announcements: [],
      forms: [],
      accounts: [],
      registrations: [],
      settings: {},
      lastUpdate: null
    };

    /*********** API 包裝（簡單請求避免 CORS） ***********/
    const API = {
      async request(action, data={}) {
        // 為保持 Simple Request：不加自訂 headers / 不用 application/json
        const body = JSON.stringify({ action, data });
        try {
          AppLayout.showLoading(true);
          const res = await fetch(CONFIG.GAS_URL, {
            method: 'POST',
            body // Content-Type 預設 text/plain
          });
          if (!res.ok) throw new Error('HTTP 狀態碼: ' + res.status);
          const json = await res.json();
          if (!json.success) throw new Error(json.error || '未知後端錯誤');
          return json.data;
        } catch (err) {
          if (CONFIG.DEBUG) console.error('API 請求錯誤:', err);
          throw err;
        } finally {
          AppLayout.showLoading(false);
        }
      },
      getAllData(){ return this.request('getAllData'); },
      getTransactions(){ return this.request('getTransactions'); },
      getMembers(){ return this.request('getMembers'); },
      getActivities(){ return this.request('getActivities'); },
      getAnnouncements(){ return this.request('getAnnouncements'); },
      getForms(){ return this.request('getForms'); },
      getAccounts(){ return this.request('getAccounts'); },
      getRegistrations(){ return this.request('getRegistrations'); },
      getDashboardData(){ return this.request('getDashboardData'); },
      addTransaction(d){ return this.request('addTransaction', d); },
      addMember(d){ return this.request('addMember', d); },
      addActivity(d){ return this.request('addActivity', d); },
      addAnnouncement(d){ return this.request('addAnnouncement', d); },
      addForm(d){ return this.request('addForm', d); },
      addAccount(d){ return this.request('addAccount', d); },
      addRegistration(d){ return this.request('addRegistration', d); },
      updateTransaction(d){ return this.request('updateTransaction', d); },
      updateMember(d){ return this.request('updateMember', d); },
      updateActivity(d){ return this.request('updateActivity', d); },
      updateAnnouncement(d){ return this.request('updateAnnouncement', d); },
      updateForm(d){ return this.request('updateForm', d); },
      updateAccount(d){ return this.request('updateAccount', d); },
      deleteTransaction(id){ return this.request('deleteTransaction', { id }); },
      deleteMember(id){ return this.request('deleteMember', { id }); },
      deleteActivity(id){ return this.request('deleteActivity', { id }); },
      deleteAnnouncement(id){ return this.request('deleteAnnouncement', { id }); },
      deleteForm(id){ return this.request('deleteForm', { id }); },
      deleteAccount(id){ return this.request('deleteAccount', { id }); },
      batchImport(type, records){ return this.request('batchImport', { type, records }); },
      exportData(type){ return this.request('exportData', { type }); },
      getAnalytics(){ return this.request('getAnalytics'); },
      generateReport(p){ return this.request('generateReport', p); },
      getSettings(){ return this.request('getSettings'); },
      updateSettings(d){ return this.request('updateSettings', d); },
      testConnection(){ return this.request('testConnection'); }
    };

    /*********** 版面控制 ***********/
    const AppLayout = {
      currentSection: 'dashboard',
      async init() {
        try {
          await API.testConnection();
          await this.loadInitialData();
          this.showSection('dashboard');
          this.bindEvents();
        } catch (err) {
          this.showError('系統初始化失敗：' + err.message);
        }
      },
      async loadInitialData() {
        const d = await API.getAllData();
          Object.assign(globalData, d);
        globalData.lastUpdate = new Date().toISOString();
      },
      showSection(section) {
        document.querySelectorAll('.sidebar .nav-link').forEach(a=>a.classList.remove('active'));
        const link = Array.from(document.querySelectorAll('.sidebar .nav-link'))
          .find(a => a.getAttribute('onclick')?.includes(section));
        if (link) link.classList.add('active');
        this.currentSection = section;
        switch(section) {
          case 'dashboard': this.renderDashboard(); break;
          case 'transactions': Transactions.render(); break;
          case 'members': Members.render(); break;
          case 'activities': Activities.render(); break;
          case 'announcements': Announcements.render(); break;
          case 'forms': Forms.render(); break;
          case 'accounts': Accounts.render(); break;
          case 'reports': Reports.render(); break;
          case 'settings': Settings.render(); break;
          default: this.renderDashboard();
        }
      },
      async renderDashboard() {
        try {
          const d = await API.getDashboardData();
          const html = `
            <div class="fade-in">
              <div class="row mb-4">
                <div class="col-md-3 mb-3">
                  <div class="stats-card">
                    <div class="stats-number">${d.members?.active||0}</div>
                    <div><i class="fas fa-users me-1"></i>活躍會員</div>
                  </div>
                </div>
                <div class="col-md-3 mb-3">
                  <div class="stats-card">
                    <div class="stats-number">${d.activities?.upcoming||0}</div>
                    <div><i class="fas fa-calendar me-1"></i>即將活動</div>
                  </div>
                </div>
                <div class="col-md-3 mb-3">
                  <div class="stats-card">
                    <div class="stats-number text-success">$${this.formatNumber(d.financial?.monthIncome||0)}</div>
                    <div><i class="fas fa-arrow-up me-1"></i>本月收入</div>
                  </div>
                </div>
                <div class="col-md-3 mb-3">
                  <div class="stats-card">
                    <div class="stats-number text-primary">$${this.formatNumber(d.totalBalance||0)}</div>
                    <div><i class="fas fa-wallet me-1"></i>帳戶餘額</div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-8 mb-4">
                  <div class="card">
                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>財務趨勢</h5></div>
                    <div class="card-body"><canvas id="financialChart" height="120"></canvas></div>
                  </div>
                </div>
                <div class="col-md-4 mb-4">
                  <div class="card">
                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>最新公告</h5></div>
                    <div class="card-body">${this.renderLatestAnnouncements(d.latestAnnouncements||[])}</div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-4">
                  <div class="card">
                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>近期活動</h5></div>
                    <div class="card-body">${this.renderUpcomingActivities(d.upcomingActivities||[])}</div>
                  </div>
                </div>
                <div class="col-md-6 mb-4">
                  <div class="card">
                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-pie-chart me-2"></i>會員統計</h5></div>
                    <div class="card-body"><canvas id="memberChart" height="200"></canvas></div>
                  </div>
                </div>
              </div>
            </div>`;
          document.getElementById('contentArea').innerHTML = html;
          this.renderFinancialChart(d.financial);
          this.renderMemberChart(d.members);
        } catch (err) {
          this.showError('載入儀表板失敗：' + err.message);
        }
      },
      renderLatestAnnouncements(list) {
        if (!list.length) return '<p class="text-muted">暫無公告</p>';
        return list.map(a=>`
          <div class="border-bottom pb-2 mb-2">
            <h6 class="mb-1">${a['標題']}</h6>
            <small class="text-muted">${this.formatDate(a['發布日期'])}</small>
          </div>
        `).join('');
      },
      renderUpcomingActivities(list) {
        if (!list.length) return '<p class="text-muted">暫無活動</p>';
        return list.map(a=>`
          <div class="border-bottom pb-2 mb-2">
            <h6 class="mb-1">${a['活動名稱']}</h6>
            <small class="text-muted">
              <i class="fas fa-calendar me-1"></i>${this.formatDate(a['日期'])}
              <i class="fas fa-map-marker-alt ms-2 me-1"></i>${a['地點']||'待定'}
            </small>
          </div>
        `).join('');
      },
      renderFinancialChart(financial) {
        const ctx = document.getElementById('financialChart');
        if (!ctx) return;
        // 示意：最後一個月使用當月收入支出，其餘為假資料（可改由後端提供月度序列）
        new Chart(ctx, {
          type:'line',
          data:{
            labels:['1月','2月','3月','4月','5月','本月'],
            datasets:[
              {
                label:'收入',
                data:[12000,15000,18000,14000,16000, financial?.monthIncome||0],
                borderColor:'rgb(39,174,96)',
                backgroundColor:'rgba(39,174,96,.15)',
                tension:.35
              },
              {
                label:'支出',
                data:[8000,12000,15000,11000,13000, financial?.monthExpense||0],
                borderColor:'rgb(231,76,60)',
                backgroundColor:'rgba(231,76,60,.15)',
                tension:.35
              }
            ]
          },
          options:{ responsive:true, maintainAspectRatio:false }
        });
      },
      renderMemberChart(members) {
        const ctx = document.getElementById('memberChart');
        if (!ctx) return;
        new Chart(ctx, {
          type:'doughnut',
          data:{
            labels:['活躍','非活躍'],
            datasets:[{
              data:[members?.active||0, members?.inactive||0],
              backgroundColor:['rgb(52,152,219)','rgb(149,165,166)']
            }]
          },
          options:{ responsive:true, maintainAspectRatio:false }
        });
      },
      toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('show');
        document.getElementById('sidebar').classList.toggle('collapsed');
        document.getElementById('mainContent').classList.toggle('expanded');
      },
      showLoading(b) { document.getElementById('loadingOverlay').style.display = b?'flex':'none'; },
      showSuccess(msg) { Swal.fire({ icon:'success', title:'成功', text:msg, timer:1800, showConfirmButton:false }); },
      showError(msg) { Swal.fire({ icon:'error', title:'錯誤', text:msg }); },
      showConfirm(msg, cb) {
        Swal.fire({ title:'確認', text:msg, icon:'question', showCancelButton:true, confirmButtonText:'確定', cancelButtonText:'取消'})
          .then(r=>{ if(r.isConfirmed && cb) cb(); });
      },
      formatDate(s) { if(!s)return '-'; const d=new Date(s); return d.toLocaleDateString('zh-TW'); },
      formatNumber(n) { return new Intl.NumberFormat('zh-TW').format(n); },
      formatCurrency(n){ return new Intl.NumberFormat('zh-TW',{ style:'currency', currency:'TWD'}).format(Number(n||0)); },
      async refreshData() {
        try { await this.loadInitialData(); this.showSection(this.currentSection); this.showSuccess('資料已更新'); }
        catch(e){ this.showError('更新失敗：'+e.message); }
      },
      showHelp() {
        Swal.fire({
          title:'系統說明',
          html:`<div class="text-start">
            <ul><li>財務 / 會員 / 活動 / 公告 / 帳戶 / 表單 / 報表 / 設定</li></ul>
            <p class="mb-1"><strong>快捷鍵</strong></p>
            <ul>
              <li>Ctrl + R：重新整理</li>
              <li>Ctrl + F：聚焦第一個搜尋框</li>
            </ul>
          </div>`,
          width:'600px'
        });
      },
      showProfile(){ Swal.fire({ icon:'info', title:'個人資料', text:'功能開發中...' }); },
      logout(){ this.showConfirm('確定要重新載入頁面（模擬登出）？', ()=> location.reload()); },
      bindEvents() {
        document.addEventListener('keydown', e=>{
          if (e.ctrlKey) {
            if (e.key==='r') { e.preventDefault(); this.refreshData(); }
            if (e.key==='f') { e.preventDefault(); const input=document.querySelector('input[type="text"]'); if(input) input.focus(); }
          }
        });
        window.addEventListener('resize', ()=>{
          if (window.innerWidth>768) document.getElementById('sidebar').classList.remove('show');
        });
      }
    };

    /*********** 活動管理 ***********/
    const Activities = {
      currentData: [],
      async render() {
        const html = `
          <div class="fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="fas fa-calendar-alt me-2"></i>活動管理</h2>
              <div>
                <button class="btn btn-success me-2" onclick="Activities.showAddModal()"><i class="fas fa-plus me-1"></i>新增活動</button>
                <button class="btn btn-info me-2" onclick="BatchImport.open('activities')"><i class="fas fa-upload me-1"></i>批次匯入</button>
                <button class="btn btn-secondary me-2" onclick="Activities.exportData()"><i class="fas fa-download me-1"></i>匯出</button>
                <button class="btn btn-outline-secondary" onclick="Activities.showFilter()"><i class="fas fa-filter"></i></button>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="row align-items-center">
                  <div class="col-md-6"><h5 class="mb-0">活動列表</h5></div>
                  <div class="col-md-6">
                    <div class="input-group">
                      <input type="text" class="form-control" id="activitySearch" placeholder="搜尋活動..." onkeyup="Activities.search()">
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body" id="activityTable"></div>
            </div>
          </div>`;
        document.getElementById('contentArea').innerHTML = html;
        await this.loadData();
      },
      async loadData() {
        try {
          this.currentData = await API.getActivities();
          this.renderTable(this.currentData);
        } catch (err) {
          AppLayout.showError('載入活動失敗：'+err.message);
        }
      },
      renderTable(data) {
        const tbody = data.map(a=>`
          <tr>
            <td><strong>${a['活動名稱']||'-'}</strong></td>
            <td>${a['類型']||'-'}</td>
            <td>${AppLayout.formatDate(a['日期'])}</td>
            <td>${a['地點']||'-'}</td>
            <td><span class="badge bg-info">${a['目前人數']||0}/${a['最大人數']||'∞'}</span></td>
            <td>${AppLayout.formatCurrency(a['費用']||0)}</td>
            <td><span class="badge ${this.getStatusClass(a['狀態'])}">${this.getStatusText(a['狀態'])}</span></td>
            <td>${a['負責人']||'-'}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="Activities.showEditModal('${a['ID']}')"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="Activities.deleteActivity('${a['ID']}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `).join('');
        const html = `
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr><th>活動名稱</th><th>類型</th><th>日期</th><th>地點</th><th>人數</th><th>費用</th><th>狀態</th><th>負責人</th><th>操作</th></tr>
              </thead>
              <tbody>${tbody}</tbody>
            </table>
          </div>`;
        document.getElementById('activityTable').innerHTML = html;
      },
      getStatusClass(s) {
        return {
          planning:'bg-warning', published:'bg-success', ongoing:'bg-info',
          completed:'bg-secondary', cancelled:'bg-danger'
        }[s] || 'bg-secondary';
      },
      getStatusText(s) {
        return {
          planning:'規劃中', published:'已發布', ongoing:'進行中',
          completed:'已完成', cancelled:'已取消'
        }[s] || '未知';
      },
      showAddModal() {
        Swal.fire({
          title:'新增活動',
          html:this.getActivityForm(),
          width:'900px',
          showCancelButton:true,
          confirmButtonText:'新增',
          cancelButtonText:'取消',
          preConfirm:()=>this.validateActivityForm()
        }).then(async r=>{
          if (r.isConfirmed) {
            try {
              await API.addActivity(r.value);
              AppLayout.showSuccess('已新增');
              this.loadData();
            } catch (err) { AppLayout.showError('新增失敗：'+err.message); }
          }
        });
      },
      getActivityForm(d={}) {
        return `
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">活動名稱 *</label>
              <input id="act_name" class="form-control" value="${d['活動名稱']||''}">
            </div>
            <div class="col-md-6">
              <label class="form-label">活動類型</label>
              <select id="act_type" class="form-select">
                ${['','講座','工作坊','聚會','戶外活動','志工服務','其他'].map(x=>`<option value="${x}" ${d['類型']===x?'selected':''}>${x||'請選擇'}</option>`).join('')}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">日期 *</label>
              <input type="date" id="act_date" class="form-control" value="${d['日期']||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">開始時間</label>
              <input type="time" id="act_start" class="form-control" value="${d['開始時間']||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">結束時間</label>
              <input type="time" id="act_end" class="form-control" value="${d['結束時間']||''}">
            </div>
            <div class="col-md-8">
              <label class="form-label">地點</label>
              <input id="act_loc" class="form-control" value="${d['地點']||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">最大人數</label>
              <input type="number" id="act_max" class="form-control" value="${d['最大人數']||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">費用</label>
              <input type="number" id="act_fee" class="form-control" value="${d['費用']||0}">
            </div>
            <div class="col-md-4">
              <label class="form-label">負責人</label>
              <input id="act_owner" class="form-control" value="${d['負責人']||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">狀態</label>
              <select id="act_status" class="form-select">
                ${['planning','published','ongoing','completed','cancelled'].map(s=>`
                  <option value="${s}" ${d['狀態']===s?'selected':''}>${Activities.getStatusText(s)}</option>`).join('')}
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">描述</label>
              <textarea id="act_desc" rows="3" class="form-control">${d['描述']||''}</textarea>
            </div>
          </div>`;
      },
      validateActivityForm() {
        const name = document.getElementById('act_name').value.trim();
        const date = document.getElementById('act_date').value;
        if (!name) { Swal.showValidationMessage('請輸入活動名稱'); return false; }
        if (!date) { Swal.showValidationMessage('請選擇日期'); return false; }
        return {
          name,
          type: document.getElementById('act_type').value,
          date,
          startTime: document.getElementById('act_start').value,
          endTime: document.getElementById('act_end').value,
          location: document.getElementById('act_loc').value,
          maxParticipants: parseInt(document.getElementById('act_max').value)||0,
          fee: parseFloat(document.getElementById('act_fee').value)||0,
          organizer: document.getElementById('act_owner').value,
          description: document.getElementById('act_desc').value,
          status: document.getElementById('act_status').value,
          currentParticipants: 0
        };
      },
      search() {
        const kw = document.getElementById('activitySearch').value.toLowerCase();
        if (!kw) return this.renderTable(this.currentData);
        const filtered = this.currentData.filter(a =>
          Object.values(a).some(v=> String(v).toLowerCase().includes(kw))
        );
        this.renderTable(filtered);
      },
      async deleteActivity(id) {
        AppLayout.showConfirm('確定刪除活動？', async ()=>{
          try { await API.deleteActivity(id); AppLayout.showSuccess('已刪除'); this.loadData(); }
          catch(e){ AppLayout.showError('刪除失敗：'+e.message); }
        });
      },
      async exportData() {
        try {
          const r = await API.exportData('activities');
          const blob = new Blob([JSON.stringify(r.data,null,2)], { type:'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'activities_'+new Date().toISOString().slice(0,10)+'.json';
          a.click();
          URL.revokeObjectURL(url);
          AppLayout.showSuccess('匯出完成');
        } catch(err) {
          AppLayout.showError('匯出失敗：'+err.message);
        }
      },
      showFilter() {
        Swal.fire({
          title:'篩選條件',
          html: `
            <div class="text-start">
              <label class="form-label">狀態</label>
              <select id="flt_status" class="form-select mb-2">
                <option value="">(全部)</option>
                <option value="planning">規劃中</option>
                <option value="published">已發布</option>
                <option value="ongoing">進行中</option>
                <option value="completed">已完成</option>
                <option value="cancelled">已取消</option>
              </select>
              <label class="form-label">類型</label>
              <input id="flt_type" class="form-control mb-2" placeholder="輸入類型關鍵字">
              <label class="form-label">起始日期</label>
              <input type="date" id="flt_start" class="form-control mb-2">
              <label class="form-label">結束日期</label>
              <input type="date" id="flt_end" class="form-control">
            </div>`,
          showCancelButton:true,
          confirmButtonText:'套用',
          cancelButtonText:'取消',
          preConfirm:()=>{
            return {
              status: document.getElementById('flt_status').value,
              type: document.getElementById('flt_type').value.trim().toLowerCase(),
              start: document.getElementById('flt_start').value,
              end: document.getElementById('flt_end').value
            };
          }
        }).then(r=>{
          if (r.isConfirmed) {
            const {status,type,start,end} = r.value;
            let filtered = [...this.currentData];
            if (status) filtered = filtered.filter(a=>a['狀態']===status);
            if (type) filtered = filtered.filter(a=>(a['類型']||'').toLowerCase().includes(type));
            if (start) filtered = filtered.filter(a=> new Date(a['日期']) >= new Date(start));
            if (end) filtered = filtered.filter(a=> new Date(a['日期']) <= new Date(end));
            this.renderTable(filtered);
          }
        });
      },
      showEditModal(id) {
        const act = this.currentData.find(a=>a['ID']===id);
        if (!act) return AppLayout.showError('找不到活動');
        Swal.fire({
          title:'編輯活動',
          html:this.getActivityForm(act),
          width:'900px',
          showCancelButton:true,
          confirmButtonText:'儲存',
          cancelButtonText:'取消',
          preConfirm:()=>this.validateActivityForm()
        }).then(async r=>{
          if (r.isConfirmed) {
            try {
              const payload = { id, ...r.value };
              await API.updateActivity(payload);
              AppLayout.showSuccess('已更新');
              this.loadData();
            } catch (e) {
              AppLayout.showError('更新失敗：'+e.message);
            }
          }
        });
      }
    };

    /*********** 公告管理（保留精簡版） ***********/
    const Announcements = {
      currentData: [],
      async render() {
        const html = `
          <div class="fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="fas fa-bullhorn me-2"></i>公告管理</h2>
              <div>
                <button class="btn btn-success me-2" onclick="Announcements.showAddModal()"><i class="fas fa-plus me-1"></i>新增公告</button>
                <button class="btn btn-secondary" onclick="Announcements.exportData()"><i class="fas fa-download me-1"></i>匯出</button>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="row">
                  <div class="col-md-6"><h5 class="mb-0">公告列表</h5></div>
                  <div class="col-md-6">
                    <input id="announcementSearch" class="form-control" placeholder="搜尋公告..." onkeyup="Announcements.search()">
                  </div>
                </div>
              </div>
              <div class="card-body" id="announcementTable"></div>
            </div>
          </div>`;
        document.getElementById('contentArea').innerHTML = html;
        await this.loadData();
      },
      async loadData() {
        try { this.currentData = await API.getAnnouncements(); this.renderTable(this.currentData); }
        catch(e){ AppLayout.showError('載入公告失敗：'+e.message); }
      },
      renderTable(data) {
        const rows = data.map(a=>`
          <tr>
            <td><strong>${a['標題']||'-'}</strong></td>
            <td>${a['分類']||'-'}</td>
            <td>${AppLayout.formatDate(a['發布日期'])}</td>
            <td><span class="badge ${this.priorityClass(a['重要性'])}">${this.priorityText(a['重要性'])}</span></td>
            <td><span class="badge ${this.statusClass(a['狀態'])}">${this.statusText(a['狀態'])}</span></td>
            <td>${a['發布者']||'-'}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="Announcements.showEditModal('${a['ID']}')"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="Announcements.deleteAnnouncement('${a['ID']}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>`).join('');
        document.getElementById('announcementTable').innerHTML = `
          <div class="table-responsive">
            <table class="table table-hover">
              <thead><tr><th>標題</th><th>分類</th><th>發布日期</th><th>重要性</th><th>狀態</th><th>發布者</th><th>操作</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      },
      priorityClass(p){ return { high:'bg-danger', normal:'bg-info', low:'bg-secondary'}[p]||'bg-info'; },
      priorityText(p){ return { high:'重要', normal:'一般', low:'低'}[p]||'一般'; },
      statusClass(s){ return { draft:'bg-warning', published:'bg-success', archived:'bg-secondary'}[s]||'bg-warning'; },
      statusText(s){ return { draft:'草稿', published:'已發布', archived:'已封存'}[s]||'草稿'; },
      showAddModal() {
        Swal.fire({
          title:'新增公告',
          html:this.formHtml(),
          width:'800px',
          showCancelButton:true,
          confirmButtonText:'新增',
          preConfirm:()=>this.collectForm()
        }).then(async r=>{
          if(r.isConfirmed){
            try { await API.addAnnouncement(r.value); AppLayout.showSuccess('新增完成'); this.loadData(); }
            catch(e){ AppLayout.showError('新增失敗：'+e.message); }
          }
        });
      },
      formHtml(d={}) {
        return `
          <div class="mb-2">
            <label class="form-label">標題 *</label>
            <input id="ann_title" class="form-control" value="${d['標題']||''}">
          </div>
          <div class="mb-2">
            <label class="form-label">分類</label>
            <input id="ann_cat" class="form-control" value="${d['分類']||''}">
          </div>
          <div class="mb-2">
            <label class="form-label">內容 *</label>
            <textarea id="ann_content" class="form-control" rows="5">${d['內容']||''}</textarea>
          </div>
          <div class="row">
            <div class="col-md-4 mb-2">
              <label class="form-label">發布日期</label>
              <input type="date" id="ann_date" class="form-control" value="${d['發布日期']||new Date().toISOString().slice(0,10)}">
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-label">重要性</label>
              <select id="ann_priority" class="form-select">
                ${['normal','high','low'].map(x=>`<option value="${x}" ${d['重要性']===x?'selected':''}>${this.priorityText(x)}</option>`).join('')}
              </select>
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-label">狀態</label>
              <select id="ann_status" class="form-select">
                ${['draft','published','archived'].map(x=>`<option value="${x}" ${d['狀態']===x?'selected':''}>${this.statusText(x)}</option>`).join('')}
              </select>
            </div>
          </div>`;
      },
      collectForm() {
        const title = document.getElementById('ann_title').value.trim();
        const content = document.getElementById('ann_content').value.trim();
        if (!title) { Swal.showValidationMessage('請輸入標題'); return false; }
        if (!content) { Swal.showValidationMessage('請輸入內容'); return false; }
        return {
          title,
          content,
          category: document.getElementById('ann_cat').value.trim(),
          publishDate: document.getElementById('ann_date').value,
          priority: document.getElementById('ann_priority').value,
          status: document.getElementById('ann_status').value,
          publisher:'System'
        };
      },
      search() {
        const kw = document.getElementById('announcementSearch').value.toLowerCase();
        if (!kw) return this.renderTable(this.currentData);
        const f = this.currentData.filter(a=> Object.values(a).some(v=>String(v).toLowerCase().includes(kw)));
        this.renderTable(f);
      },
      async deleteAnnouncement(id) {
        AppLayout.showConfirm('確定刪除公告？', async ()=>{
          try { await API.deleteAnnouncement(id); AppLayout.showSuccess('已刪除'); this.loadData(); }
          catch(e){ AppLayout.showError('刪除失敗：'+e.message); }
        });
      },
      showEditModal(id) {
        const ann = this.currentData.find(a=>a['ID']===id);
        if (!ann) return AppLayout.showError('找不到公告');
        Swal.fire({
          title:'編輯公告',
          html:this.formHtml(ann),
          width:'800px',
          showCancelButton:true,
          confirmButtonText:'儲存',
          preConfirm:()=>this.collectForm()
        }).then(async r=>{
          if (r.isConfirmed) {
            try { await API.updateAnnouncement({ id, ...r.value }); AppLayout.showSuccess('已更新'); this.loadData(); }
            catch(e){ AppLayout.showError('更新失敗：'+e.message); }
          }
        });
      },
      async exportData() {
        try {
          const r = await API.exportData('announcements');
          const blob = new Blob([JSON.stringify(r.data,null,2)],{type:'application/json'});
          const url = URL.createObjectURL(blob);
          const a=document.createElement('a');
          a.href=url; a.download='announcements_'+new Date().toISOString().slice(0,10)+'.json'; a.click();
          URL.revokeObjectURL(url);
          AppLayout.showSuccess('匯出完成');
        } catch (e) {
          AppLayout.showError('匯出失敗：'+e.message);
        }
      }
    };

    /*********** 會員管理（簡化展示） ***********/
    const Members = {
      currentData: [],
      async render() {
        const html = `
          <div class="fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="fas fa-users me-2"></i>會員管理</h2>
              <div>
                <button class="btn btn-success me-2" onclick="Members.showAddModal()"><i class="fas fa-plus me-1"></i>新增會員</button>
                <button class="btn btn-info me-2" onclick="BatchImport.open('members')"><i class="fas fa-upload me-1"></i>批次匯入</button>
                <button class="btn btn-secondary" onclick="Members.exportData()"><i class="fas fa-download me-1"></i>匯出</button>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="row">
                  <div class="col-md-6"><h5 class="mb-0">會員列表</h5></div>
                  <div class="col-md-6">
                    <input id="memberSearch" class="form-control" placeholder="搜尋會員..." onkeyup="Members.search()">
                  </div>
                </div>
              </div>
              <div class="card-body" id="memberTable"></div>
            </div>
          </div>`;
        document.getElementById('contentArea').innerHTML = html;
        await this.loadData();
      },
      async loadData() {
        try { this.currentData = await API.getMembers(); this.renderTable(this.currentData); }
        catch(e){ AppLayout.showError('載入會員失敗：'+e.message); }
      },
      renderTable(data) {
        const rows = data.map(m=>`
          <tr>
            <td><strong>${m['姓名']||'-'}</strong></td>
            <td>${m['電話']||'-'}</td>
            <td>${m['Email']||'-'}</td>
            <td><span class="badge ${this.typeClass(m['會員類型'])}">${this.typeText(m['會員類型'])}</span></td>
            <td>${AppLayout.formatDate(m['加入日期'])}</td>
            <td><span class="badge ${this.statusClass(m['狀態'])}">${this.statusText(m['狀態'])}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="Members.showEditModal('${m['ID']}')"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="Members.deleteMember('${m['ID']}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>`).join('');
        document.getElementById('memberTable').innerHTML = `
          <div class="table-responsive">
            <table class="table table-hover">
              <thead><tr><th>姓名</th><th>電話</th><th>Email</th><th>會員類型</th><th>加入日期</th><th>狀態</th><th>操作</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      },
      typeClass(t){ return { regular:'bg-info', vip:'bg-warning', lifetime:'bg-success'}[t]||'bg-info'; },
      typeText(t){ return { regular:'一般會員', vip:'VIP會員', lifetime:'終身會員'}[t]||'一般會員'; },
      statusClass(s){ return { active:'bg-success', inactive:'bg-secondary', suspended:'bg-danger'}[s]||'bg-success'; },
      statusText(s){ return { active:'活躍', inactive:'非活躍', suspended:'暫停'}[s]||'活躍'; },
      showAddModal() {
        Swal.fire({
          title:'新增會員',
          html:this.formHtml(),
          showCancelButton:true,
          confirmButtonText:'新增',
          preConfirm:()=>this.collectForm()
        }).then(async r=>{
          if (r.isConfirmed) {
            try { await API.addMember(r.value); AppLayout.showSuccess('新增完成'); this.loadData(); }
            catch(e){ AppLayout.showError('新增失敗：'+e.message); }
          }
        });
      },
      formHtml(d={}) {
        return `
          <div class="mb-2"><label class="form-label">姓名 *</label><input id="m_name" class="form-control" value="${d['姓名']||''}"></div>
          <div class="mb-2"><label class="form-label">電話 *</label><input id="m_phone" class="form-control" value="${d['電話']||''}"></div>
          <div class="mb-2"><label class="form-label">Email</label><input id="m_email" class="form-control" value="${d['Email']||''}"></div>
          <div class="row">
            <div class="col-md-6 mb-2"><label class="form-label">加入日期</label><input type="date" id="m_join" class="form-control" value="${d['加入日期']||new Date().toISOString().slice(0,10)}"></div>
            <div class="col-md-6 mb-2"><label class="form-label">會員類型</label>
              <select id="m_type" class="form-select">
                <option value="regular" ${d['會員類型']==='regular'?'selected':''}>一般</option>
                <option value="vip" ${d['會員類型']==='vip'?'selected':''}>VIP</option>
                <option value="lifetime" ${d['會員類型']==='lifetime'?'selected':''}>終身</option>
              </select>
            </div>
          </div>
          <div class="mb-2"><label class="form-label">狀態</label>
            <select id="m_status" class="form-select">
              <option value="active" ${d['狀態']==='active'?'selected':''}>活躍</option>
              <option value="inactive" ${d['狀態']==='inactive'?'selected':''}>非活躍</option>
              <option value="suspended" ${d['狀態']==='suspended'?'selected':''}>暫停</option>
            </select>
          </div>
          <div class="mb-2"><label class="form-label">備註</label><textarea id="m_notes" class="form-control" rows="3">${d['備註']||''}</textarea></div>`;
      },
      collectForm() {
        const name=document.getElementById('m_name').value.trim();
        const phone=document.getElementById('m_phone').value.trim();
        if (!name) { Swal.showValidationMessage('請輸入姓名'); return false; }
        if (!phone) { Swal.showValidationMessage('請輸入電話'); return false; }
        return {
          name, phone,
          email: document.getElementById('m_email').value.trim(),
          joinDate: document.getElementById('m_join').value,
          type: document.getElementById('m_type').value,
          status: document.getElementById('m_status').value,
          notes: document.getElementById('m_notes').value
        };
      },
      showEditModal(id) {
        const m = this.currentData.find(x=>x['ID']===id);
        if (!m) return AppLayout.showError('找不到會員');
        Swal.fire({
          title:'編輯會員',
          html:this.formHtml(m),
          showCancelButton:true,
          confirmButtonText:'儲存',
          preConfirm:()=>this.collectForm()
        }).then(async r=>{
          if (r.isConfirmed) {
            try { await API.updateMember({ id, ...r.value }); AppLayout.showSuccess('已更新'); this.loadData(); }
            catch(e){ AppLayout.showError('更新失敗：'+e.message); }
          }
        });
      },
      search() {
        const kw = document.getElementById('memberSearch').value.toLowerCase();
        if (!kw) return this.renderTable(this.currentData);
        const f = this.currentData.filter(m=> Object.values(m).some(v=>String(v).toLowerCase().includes(kw)));
        this.renderTable(f);
      },
      async deleteMember(id) {
        AppLayout.showConfirm('確定刪除會員？', async ()=>{
          try { await API.deleteMember(id); AppLayout.showSuccess('已刪除'); this.loadData(); }
          catch(e){ AppLayout.showError('刪除失敗：'+e.message); }
        });
      },
      async exportData() {
        try {
          const r = await API.exportData('members');
          const blob = new Blob([JSON.stringify(r.data,null,2)],{type:'application/json'});
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a');
          a.href=url; a.download='members_'+new Date().toISOString().slice(0,10)+'.json'; a.click();
          URL.revokeObjectURL(url);
          AppLayout.showSuccess('匯出完成');
        } catch(e){ AppLayout.showError('匯出失敗：'+e.message); }
      }
    };

    /*********** 財務 / 其他模組（僅保留主要片段，依需要擴充） ***********/
    const Transactions = {
      currentData: [],
      async render() {
        const html = `
          <div class="fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="fas fa-money-bill-wave me-2"></i>財務管理</h2>
              <div>
                <button class="btn btn-success me-2" onclick="Transactions.showAddModal()"><i class="fas fa-plus me-1"></i>新增交易</button>
                <button class="btn btn-info me-2" onclick="BatchImport.open('transactions')"><i class="fas fa-upload me-1"></i>批次匯入</button>
                <button class="btn btn-secondary" onclick="Transactions.exportData()"><i class="fas fa-download me-1"></i>匯出</button>
              </div>
            </div>
            <div class="row mb-4">
              <div class="col-md-3"><div class="stats-card"><div id="totalIncome" class="stats-number text-success">$0</div><div>總收入</div></div></div>
              <div class="col-md-3"><div class="stats-card"><div id="totalExpense" class="stats-number text-danger">$0</div><div>總支出</div></div></div>
              <div class="col-md-3"><div class="stats-card"><div id="netProfit" class="stats-number text-primary">$0</div><div>淨利潤</div></div></div>
              <div class="col-md-3"><div class="stats-card"><div id="transactionCount" class="stats-number">0</div><div>交易筆數</div></div></div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="row">
                  <div class="col-md-6"><h5 class="mb-0">交易記錄</h5></div>
                  <div class="col-md-6"><input id="transactionSearch" class="form-control" placeholder="搜尋交易..." onkeyup="Transactions.search()"></div>
                </div>
              </div>
              <div class="card-body" id="transactionTable"></div>
            </div>
          </div>`;
        document.getElementById('contentArea').innerHTML = html;
        await this.loadData();
      },
      async loadData() {
        try {
          this.currentData = await API.getTransactions();
          this.renderTable(this.currentData);
          this.updateStats();
        } catch (e) { AppLayout.showError('載入交易失敗：'+e.message); }
      },
      renderTable(data) {
        const rows = data.map(t=>`
          <tr>
            <td>${AppLayout.formatDate(t['日期'])}</td>
            <td><span class="badge ${t['類型']==='收入'?'bg-success':'bg-danger'}">${t['類型']}</span></td>
            <td>${t['類別']||'-'}</td>
            <td class="${t['類型']==='收入'?'text-success':'text-danger'}">${AppLayout.formatCurrency(t['金額']||0)}</td>
            <td>${t['對象']||'-'}</td>
            <td>${t['帳戶']||'-'}</td>
            <td>${t['說明']||'-'}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="Transactions.showEditModal('${t['ID']}')"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="Transactions.deleteTransaction('${t['ID']}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>`).join('');
        document.getElementById('transactionTable').innerHTML = `
          <div class="table-responsive">
            <table class="table table-hover">
              <thead><tr><th>日期</th><th>類型</th><th>類別</th><th>金額</th><th>對象</th><th>帳戶</th><th>說明</th><th>操作</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      },
      updateStats() {
        let income=0, expense=0;
          this.currentData.forEach(t=>{
          const amt=Number(t['金額']||0);
          if(t['類型']==='收入') income+=amt;
          else if(t['類型']==='支出') expense+=amt;
        });
        document.getElementById('totalIncome').textContent=AppLayout.formatCurrency(income);
        document.getElementById('totalExpense').textContent=AppLayout.formatCurrency(expense);
        document.getElementById('netProfit').textContent=AppLayout.formatCurrency(income-expense);
        document.getElementById('transactionCount').textContent=this.currentData.length;
      },
      search() {
        const kw = document.getElementById('transactionSearch').value.toLowerCase();
        if(!kw) return this.renderTable(this.currentData);
        const f = this.currentData.filter(t=> Object.values(t).some(v=> String(v).toLowerCase().includes(kw)));
        this.renderTable(f);
      },
      showAddModal() {
        Swal.fire({
          title:'新增交易',
          html:this.formHtml(),
          showCancelButton:true,
          confirmButtonText:'新增',
          preConfirm:()=>this.collectForm()
        }).then(async r=>{
          if(r.isConfirmed) {
            try { await API.addTransaction(r.value); AppLayout.showSuccess('已新增'); this.loadData(); }
            catch(e){ AppLayout.showError('新增失敗：'+e.message); }
          }
        });
      },
      formHtml(d={}) {
        return `
          <div class="mb-2"><label class="form-label">日期 *</label><input type="date" id="trx_date" class="form-control" value="${d['日期']||new Date().toISOString().slice(0,10)}"></div>
          <div class="mb-2"><label class="form-label">類型 *</label>
            <select id="trx_type" class="form-select">
              <option value="收入" ${d['類型']==='收入'?'selected':''}>收入</option>
              <option value="支出" ${d['類型']==='支出'?'selected':''}>支出</option>
            </select>
          </div>
          <div class="mb-2"><label class="form-label">類別</label><input id="trx_cat" class="form-control" value="${d['類別']||''}"></div>
          <div class="mb-2"><label class="form-label">金額 *</label><input type="number" id="trx_amt" class="form-control" value="${d['金額']||''}"></div>
          <div class="mb-2"><label class="form-label">對象</label><input id="trx_cp" class="form-control" value="${d['對象']||''}"></div>
          <div class="mb-2"><label class="form-label">帳戶</label><input id="trx_acc" class="form-control" value="${d['帳戶']||''}"></div>
          <div class="mb-2"><label class="form-label">說明</label><textarea id="trx_desc" class="form-control" rows="3">${d['說明']||''}</textarea></div>`;
      },
      collectForm() {
        const date=document.getElementById('trx_date').value;
        const type=document.getElementById('trx_type').value;
        const amt=document.getElementById('trx_amt').value;
        if(!date){ Swal.showValidationMessage('請輸入日期'); return false; }
        if(!amt){ Swal.showValidationMessage('請輸入金額'); return false; }
        return {
          date,
          type,
          category: document.getElementById('trx_cat').value,
          amount: parseFloat(amt),
          counterparty: document.getElementById('trx_cp').value,
          account: document.getElementById('trx_acc').value,
          description: document.getElementById('trx_desc').value
        };
      },
      showEditModal(id) {
        const t = this.currentData.find(x=>x['ID']===id);
        if(!t) return AppLayout.showError('找不到交易');
        Swal.fire({
          title:'編輯交易',
          html:this.formHtml(t),
          showCancelButton:true,
          confirmButtonText:'儲存',
          preConfirm:()=>this.collectForm()
        }).then(async r=>{
          if(r.isConfirmed){
            try { await API.updateTransaction({ id, ...r.value }); AppLayout.showSuccess('已更新'); this.loadData(); }
            catch(e){ AppLayout.showError('更新失敗：'+e.message); }
          }
        });
      },
      async deleteTransaction(id) {
        AppLayout.showConfirm('確定刪除交易？', async ()=>{
          try { await API.deleteTransaction(id); AppLayout.showSuccess('已刪除'); this.loadData(); }
          catch(e){ AppLayout.showError('刪除失敗：'+e.message); }
        });
      },
      async exportData() {
        try {
          const r = await API.exportData('transactions');
          const blob = new Blob([JSON.stringify(r.data,null,2)],{type:'application/json'});
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a');
          a.href=url; a.download='transactions_'+new Date().toISOString().slice(0,10)+'.json'; a.click();
          URL.revokeObjectURL(url);
          AppLayout.showSuccess('匯出完成');
        } catch(e){ AppLayout.showError('匯出失敗：'+e.message); }
      }
    };

    // 其餘模組（Forms, Accounts, Reports, Settings, BatchImport）可沿用你原有版本，此處保留核心展示。你若需要我補全再告訴我。
    const Forms = { render(){ document.getElementById('contentArea').innerHTML='<h3>表單管理（待擴充）</h3>'; } };
    const Accounts = { render(){ document.getElementById('contentArea').innerHTML='<h3>帳戶管理（待擴充）</h3>'; } };
    const Reports = {
      render() {
        document.getElementById('contentArea').innerHTML=`
          <div class="fade-in">
            <h2><i class="fas fa-chart-bar me-2"></i>報表分析</h2>
            <div class="row">
              <div class="col-md-4 mb-3">
                <div class="card text-center p-3">
                  <i class="fas fa-money-bill-wave fa-3x text-success mb-2"></i>
                  <h5>財務報表</h5>
                  <button class="btn btn-success mt-2" onclick="Reports.genFinancial()">產生</button>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card text-center p-3">
                  <i class="fas fa-users fa-3x text-primary mb-2"></i>
                  <h5>會員報表</h5>
                  <button class="btn btn-primary mt-2" onclick="Reports.genMember()">產生</button>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card text-center p-3">
                  <i class="fas fa-calendar-alt fa-3x text-info mb-2"></i>
                  <h5>活動報表</h5>
                  <button class="btn btn-info mt-2" onclick="Reports.genActivity()">產生</button>
                </div>
              </div>
            </div>
          </div>`;
      },
      async genFinancial() {
        try {
          const r = await API.generateReport({
            type:'financial',
            startDate:'2024-01-01',
            endDate:new Date().toISOString().slice(0,10)
          });
          Swal.fire({
            title:'財務報表',
            html:`<div class="text-start">
              期間：${r.period.startDate} ~ ${r.period.endDate}<hr>
              總收入：<span class="text-success">${AppLayout.formatCurrency(r.summary.totalIncome)}</span><br>
              總支出：<span class="text-danger">${AppLayout.formatCurrency(r.summary.totalExpense)}</span><br>
              淨利潤：<span class="text-primary">${AppLayout.formatCurrency(r.summary.netProfit)}</span><br>
              交易筆數：${r.summary.transactionCount}
            </div>`
          });
        } catch(e){ AppLayout.showError('產生報表失敗：'+e.message); }
      },
      async genMember() {
        try {
          const r = await API.generateReport({ type:'member' });
          Swal.fire({
            title:'會員報表',
            html:`<div class="text-start">
              總會員：${r.stats.total}<br>
              活躍：${r.stats.active} / 非活躍：${r.stats.inactive}<hr>
              依類型：<pre>${JSON.stringify(r.stats.byType,null,2)}</pre>
              依性別：<pre>${JSON.stringify(r.stats.byGender,null,2)}</pre>
            </div>`,
            width:'650px'
          });
        } catch(e){ AppLayout.showError('產生報表失敗：'+e.message); }
      },
      async genActivity() {
        try {
          const r = await API.generateReport({
            type:'activity',
            startDate:'2024-01-01',
            endDate:new Date().toISOString().slice(0,10)
          });
          Swal.fire({
            title:'活動報表',
            html:`<div class="text-start">
              期間：${r.period.startDate} ~ ${r.period.endDate}<hr>
              活動數：${r.stats.total}<br>
              已完成：${r.stats.completed} / 已取消：${r.stats.cancelled}<br>
              總參與人數：${r.stats.totalParticipants}<br>
              總收入 (估)：${AppLayout.formatCurrency(r.stats.totalRevenue)}
            </div>`
          });
        } catch(e){ AppLayout.showError('產生報表失敗：'+e.message); }
      }
    };
    const Settings = {
      async render() {
        const s = await API.getSettings();
        const html = `
          <div class="fade-in">
            <h2><i class="fas fa-cog me-2"></i>系統設定</h2>
            <div class="card">
              <div class="card-header"><h5 class="mb-0">基本設定</h5></div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">組織名稱</label>
                    <input id="set_org" class="form-control" value="${s.organization_name||''}">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">貨幣</label>
                    <select id="set_currency" class="form-select">
                      ${['TWD','USD','CNY'].map(c=>`<option value="${c}" ${s.currency===c?'selected':''}>${c}</option>`).join('')}
                    </select>
                  </div>
                </div>
                <button class="btn btn-primary" onclick="Settings.save()"><i class="fas fa-save me-1"></i>儲存</button>
                <button class="btn btn-secondary ms-2" onclick="Settings.test()"><i class="fas fa-plug me-1"></i>測試連線</button>
              </div>
            </div>
          </div>`;
        document.getElementById('contentArea').innerHTML = html;
      },
      async save() {
        try {
          await API.updateSettings({
            organization_name: document.getElementById('set_org').value,
            currency: document.getElementById('set_currency').value
          });
          AppLayout.showSuccess('設定已儲存');
          await AppLayout.loadInitialData();
        } catch(e){ AppLayout.showError('儲存失敗：'+e.message); }
      },
      async test() {
        try {
          const r = await API.testConnection();
          AppLayout.showSuccess(`連線成功：${r.spreadsheetName}`);
        } catch(e){ AppLayout.showError('測試失敗：'+e.message); }
      }
    };
    const BatchImport = {
      open(type) {
        Swal.fire({
          title:'批次匯入',
          html:`<input type="file" accept=".csv" id="csv_file" class="form-control mb-2">
                <div class="alert alert-info p-2 mb-0"><small>請確保第一行為欄位標題。簡易 CSV 解析（不支援含引號逗號複雜情況）。</small></div>`,
          showCancelButton:true,
          confirmButtonText:'匯入',
          preConfirm:()=>{
            const f = document.getElementById('csv_file').files[0];
            if(!f){ Swal.showValidationMessage('請選擇檔案'); return false; }
            return f;
          }
        }).then(async r=>{
          if(r.isConfirmed){
            try {
              const records = await this.parseCSV(r.value);
              const res = await API.batchImport(type, records);
              AppLayout.showSuccess(`匯入完成：成功 ${res.successCount} / 失敗 ${res.errorCount}`);
              AppLayout.refreshData();
            } catch(e){ AppLayout.showError('匯入失敗：'+e.message); }
          }
        });
      },
      parseCSV(file) {
        return new Promise((resolve, reject)=>{
          const reader = new FileReader();
          reader.onload = e => {
            try {
              let text = e.target.result;
              text = text.replace(/^\uFEFF/,''); // 去 BOM
              const lines = text.split(/\r?\n/).filter(l=>l.trim());
              if (!lines.length) return resolve([]);
              const headers = lines[0].split(',').map(h=>h.trim());
              const out = [];
              for (let i=1;i<lines.length;i++){
                const cols = lines[i].split(',');
                const obj={};
                headers.forEach((h,idx)=> obj[h]= (cols[idx]||'').trim());
                out.push(obj);
              }
              resolve(out);
            } catch(err){ reject(err); }
          };
          reader.onerror = ()=> reject(new Error('檔案讀取失敗'));
          reader.readAsText(file, 'UTF-8');
        });
      }
    };

    document.addEventListener('DOMContentLoaded', ()=> AppLayout.init());
  </script>
</body>
</html>

<!-- 
# 使用步驟簡要

1. 後端：開啟 Apps Script 專案 → 貼上新版 Code.gs → 修改 SPREADSHEET_ID → 部署「新版」Web App（執行者 Me，存取 Anyone）。
2. 前端：更新 CONFIG.GAS_URL 為部署後網址；如開啟 API_KEY，於 GAS_URL 後加 ?apiKey=KEY。
3. 推到 GitHub Pages；重新載入頁面測試。
4. 若仍遇到 CORS，確認：
   - 是否意外加入自訂 header（例如 Authorization、X- 開頭）
   - 是否仍用 Content-Type: application/json
   - 確認 Web App 版本已重新部署並使用最新 URL。

# 後續可選加強
- 新增月度趨勢 API（避免前端硬編 1~6 月）
- 前端表格分頁與快取
- 權限角色管理
- 完整 CSV 引號處理（導入 PapaParse）
- 報名 / 活動轉換率指標
- 背景備份排程（time-driven trigger）

若你想讓我再補：Forms / Accounts 全功能化、月度財務趨勢 API、或安全性（token 旋轉）實作，直接告訴我。

祝開發順利！需要更多優化我再幫你延伸。 (gpt-5) -->
