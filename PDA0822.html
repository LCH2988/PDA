<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>組織管理系統</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <style>
      :root {
          --primary-color: #2c3e50;
          --secondary-color: #3498db;
          --success-color: #27ae60;
          --warning-color: #f39c12;
          --danger-color: #e74c3c;
          --sidebar-width: 280px;
      }

      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background-color: #f8f9fa;
          margin: 0;
          padding: 0;
      }

      .sidebar {
          position: fixed;
          top: 0;
          left: 0;
          height: 100vh;
          width: var(--sidebar-width);
          background: linear-gradient(135deg, var(--primary-color), #34495e);
          color: white;
          z-index: 1000;
          transition: transform 0.3s ease;
          overflow-y: auto;
      }

      .sidebar.collapsed {
          transform: translateX(-100%);
      }

      .sidebar-header {
          padding: 1.5rem;
          text-align: center;
          border-bottom: 1px solid rgba(255,255,255,0.1);
      }

      .sidebar-header h4 {
          margin: 0;
          font-weight: 600;
      }

      .nav-menu {
          padding: 1rem 0;
      }

      .nav-link {
          display: block;
          padding: 0.75rem 1.5rem;
          color: rgba(255,255,255,0.8);
          text-decoration: none;
          transition: all 0.3s ease;
          border-left: 3px solid transparent;
      }

      .nav-link:hover {
          background-color: rgba(255,255,255,0.1);
          color: white;
          border-left-color: var(--secondary-color);
      }

      .nav-link.active {
          background-color: rgba(52, 152, 219, 0.2);
          color: white;
          border-left-color: var(--secondary-color);
      }

      .nav-link i {
          width: 20px;
          margin-right: 0.75rem;
      }

      .main-content {
          margin-left: var(--sidebar-width);
          min-height: 100vh;
          transition: margin-left 0.3s ease;
      }

      .main-content.expanded {
          margin-left: 0;
      }

      .top-navbar {
          background: white;
          padding: 1rem 2rem;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .content-area {
          padding: 2rem;
      }

      .stats-card {
          background: white;
          padding: 1.5rem;
          border-radius: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          text-align: center;
          transition: transform 0.3s ease;
      }

      .stats-card:hover {
          transform: translateY(-5px);
      }

      .stats-number {
          font-size: 2rem;
          font-weight: bold;
          color: var(--primary-color);
          margin-bottom: 0.5rem;
      }

      .card {
          border: none;
          border-radius: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          margin-bottom: 2rem;
      }

      .card-header {
          background: white;
          border-bottom: 1px solid #eee;
          padding: 1.25rem;
          border-radius: 10px 10px 0 0 !important;
      }

      .btn {
          border-radius: 6px;
          padding: 0.5rem 1rem;
          font-weight: 500;
          transition: all 0.3s ease;
      }

      .btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      }

      .table {
          margin-bottom: 0;
      }

      .table th {
          border-top: none;
          background-color: #f8f9fa;
          font-weight: 600;
          color: var(--primary-color);
      }

      .badge {
          padding: 0.5rem 0.75rem;
          border-radius: 20px;
          font-size: 0.75rem;
      }

      .fade-in {
          animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.7);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }

      .spinner {
          width: 50px;
          height: 50px;
          border: 5px solid #f3f3f3;
          border-top: 5px solid var(--secondary-color);
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      @media (max-width: 768px) {
          .sidebar {
              transform: translateX(-100%);
          }
          
          .sidebar.show {
              transform: translateX(0);
          }
          
          .main-content {
              margin-left: 0;
          }
          
          .content-area {
              padding: 1rem;
          }
          
          .top-navbar {
              padding: 1rem;
          }
      }

      .alert {
          border: none;
          border-radius: 10px;
      }

      .form-control, .form-select {
          border-radius: 6px;
          border: 1px solid #ddd;
          padding: 0.75rem;
      }

      .form-control:focus, .form-select:focus {
          border-color: var(--secondary-color);
          box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
      }

      .modal-content {
          border-radius: 15px;
          border: none;
      }

      .modal-header {
          border-bottom: 1px solid #eee;
          border-radius: 15px 15px 0 0;
      }

      .modal-footer {
          border-top: 1px solid #eee;
      }

      .text-primary { color: var(--primary-color) !important; }
      .text-secondary { color: var(--secondary-color) !important; }
      .bg-primary { background-color: var(--primary-color) !important; }
      .bg-secondary { background-color: var(--secondary-color) !important; }
      .btn-primary { background-color: var(--secondary-color); border-color: var(--secondary-color); }
      .btn-primary:hover { background-color: #2980b9; border-color: #2980b9; }
  </style>
</head>
<body>
  <!-- 載入遮罩 -->
  <div id="loadingOverlay" class="loading-overlay">
      <div class="spinner"></div>
  </div>

  <!-- 側邊欄 -->
  <nav id="sidebar" class="sidebar">
      <div class="sidebar-header">
          <h4><i class="fas fa-users-cog me-2"></i>組織管理系統</h4>
          <small>v1.0.0</small>
      </div>
      
      <div class="nav-menu">
          <a href="#" class="nav-link active" onclick="AppLayout.showSection('dashboard')">
              <i class="fas fa-tachometer-alt"></i>儀表板
          </a>
          <a href="#" class="nav-link" onclick="AppLayout.showSection('transactions')">
              <i class="fas fa-money-bill-wave"></i>財務管理
          </a>
          <a href="#" class="nav-link" onclick="AppLayout.showSection('members')">
              <i class="fas fa-users"></i>會員管理
          </a>
          <a href="#" class="nav-link" onclick="AppLayout.showSection('activities')">
              <i class="fas fa-calendar-alt"></i>活動管理
          </a>
          <a href="#" class="nav-link" onclick="AppLayout.showSection('announcements')">
              <i class="fas fa-bullhorn"></i>公告管理
          </a>
          <a href="#" class="nav-link" onclick="AppLayout.showSection('forms')">
              <i class="fas fa-file-alt"></i>表單管理
          </a>
          <a href="#" class="nav-link" onclick="AppLayout.showSection('accounts')">
              <i class="fas fa-university"></i>帳戶管理
          </a>
          <a href="#" class="nav-link" onclick="AppLayout.showSection('reports')">
              <i class="fas fa-chart-bar"></i>報表分析
          </a>
          <a href="#" class="nav-link" onclick="AppLayout.showSection('settings')">
              <i class="fas fa-cog"></i>系統設定
          </a>
      </div>
  </nav>

  <!-- 主要內容區域 -->
  <div id="mainContent" class="main-content">
      <!-- 頂部導航 -->
      <div class="top-navbar">
          <div>
              <button class="btn btn-outline-secondary d-md-none" onclick="AppLayout.toggleSidebar()">
                  <i class="fas fa-bars"></i>
              </button>
              <span class="ms-2 fw-bold">組織管理系統</span>
          </div>
          <div>
              <button class="btn btn-outline-primary me-2" onclick="AppLayout.refreshData()" title="重新整理">
                  <i class="fas fa-sync-alt"></i>
              </button>
              <button class="btn btn-outline-info me-2" onclick="AppLayout.showHelp()" title="說明">
                  <i class="fas fa-question-circle"></i>
              </button>
              <div class="dropdown d-inline">
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      <i class="fas fa-user-circle"></i>
                  </button>
                  <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#" onclick="AppLayout.showProfile()">
                          <i class="fas fa-user me-2"></i>個人資料
                      </a></li>
                      <li><a class="dropdown-item" href="#" onclick="AppLayout.showSettings()">
                          <i class="fas fa-cog me-2"></i>設定
                      </a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item" href="#" onclick="AppLayout.logout()">
                          <i class="fas fa-sign-out-alt me-2"></i>登出
                      </a></li>
                  </ul>
              </div>
          </div>
      </div>

      <!-- 內容區域 -->
      <div id="contentArea" class="content-area">
          <!-- 內容將動態載入 -->
      </div>
  </div>

  <script>
      // ==================== 設定區域 ====================
      const CONFIG = {
          GAS_URL: 'https://script.google.com/macros/s/AKfycbybUuWBqvGX159YSlz0uBJ321mAw3sOTqErg3nsp0eEi9A4PJHm5NY4sX14oie5tc9rrw/exec', // 請替換為實際的 GAS URL
          DEBUG: true,
          TIMEOUT: 30000,
          VERSION: '1.0.0'
      };

      // ==================== 全域資料 ====================
      let globalData = {
          transactions: [],
          members: [],
          activities: [],
          announcements: [],
          forms: [],
          accounts: [],
          registrations: [],
          settings: {},
          lastUpdate: null
      };

      // ==================== API 介面 ====================
      const API = {
          async request(action, data = {}) {
              try {
                  AppLayout.showLoading(true);
                  
                  const response = await fetch(CONFIG.GAS_URL, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({ action, data })
                  });

                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }

                  const result = await response.json();
                  
                  if (!result.success) {
                      throw new Error(result.error || '請求失敗');
                  }

                  return result.data;
              } catch (error) {
                  console.error('API 請求錯誤:', error);
                  throw error;
              } finally {
                  AppLayout.showLoading(false);
              }
          },

          // 資料查詢
          async getAllData() {
              return await this.request('getAllData');
          },

          async getTransactions() {
              return await this.request('getTransactions');
          },

          async getMembers() {
              return await this.request('getMembers');
          },

          async getActivities() {
              return await this.request('getActivities');
          },

          async getAnnouncements() {
              return await this.request('getAnnouncements');
          },

          async getForms() {
              return await this.request('getForms');
          },

          async getAccounts() {
              return await this.request('getAccounts');
          },

          async getRegistrations() {
              return await this.request('getRegistrations');
          },

          async getDashboardData() {
              return await this.request('getDashboardData');
          },

          // 資料新增
          async addTransaction(data) {
              return await this.request('addTransaction', data);
          },

          async addMember(data) {
              return await this.request('addMember', data);
          },

          async addActivity(data) {
              return await this.request('addActivity', data);
          },

          async addAnnouncement(data) {
              return await this.request('addAnnouncement', data);
          },

          async addForm(data) {
              return await this.request('addForm', data);
          },

          async addAccount(data) {
              return await this.request('addAccount', data);
          },

          async addRegistration(data) {
              return await this.request('addRegistration', data);
          },

          // 資料更新
          async updateTransaction(data) {
              return await this.request('updateTransaction', data);
          },

          async updateMember(data) {
              return await this.request('updateMember', data);
          },

          async updateActivity(data) {
              return await this.request('updateActivity', data);
          },

          async updateAnnouncement(data) {
              return await this.request('updateAnnouncement', data);
          },

          async updateForm(data) {
              return await this.request('updateForm', data);
          },

          async updateAccount(data) {
              return await this.request('updateAccount', data);
          },

          // 資料刪除
          async deleteTransaction(id) {
              return await this.request('deleteTransaction', { id });
          },

          async deleteMember(id) {
              return await this.request('deleteMember', { id });
          },

          async deleteActivity(id) {
              return await this.request('deleteActivity', { id });
          },

          async deleteAnnouncement(id) {
              return await this.request('deleteAnnouncement', { id });
          },

          async deleteForm(id) {
              return await this.request('deleteForm', { id });
          },

          async deleteAccount(id) {
              return await this.request('deleteAccount', { id });
          },

          // 批次操作
          async batchImport(type, records) {
              return await this.request('batchImport', { type, records });
          },

          async exportData(type) {
              return await this.request('exportData', { type });
          },

          // 統計分析
          async getAnalytics() {
              return await this.request('getAnalytics');
          },

          async generateReport(params) {
              return await this.request('generateReport', params);
          },

          // 系統功能
          async getSettings() {
              return await this.request('getSettings');
          },

          async updateSettings(data) {
              return await this.request('updateSettings', data);
          },

          async testConnection() {
              return await this.request('testConnection');
          }
      };

      // ==================== 應用程式布局管理 ====================
      const AppLayout = {
          currentSection: 'dashboard',
          
          async init() {
              try {
                  // 測試連線
                  await API.testConnection();
                  
                  // 載入初始資料
                  await this.loadInitialData();
                  
                  // 顯示儀表板
                  this.showSection('dashboard');
                  
                  // 綁定事件
                  this.bindEvents();
                  
                  console.log('系統初始化完成');
              } catch (error) {
                  console.error('系統初始化失敗:', error);
                  this.showError('系統初始化失敗，請檢查網路連線和設定');
              }
          },

          async loadInitialData() {
              try {
                  const data = await API.getAllData();
                  this.updateGlobalData(data);
              } catch (error) {
                  console.error('初始資料載入失敗:', error);
                  throw error;
              }
          },

          updateGlobalData(data) {
              Object.assign(globalData, data);
              globalData.lastUpdate = new Date().toISOString();
          },

          showSection(sectionName) {
              // 更新導航狀態
              document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                  link.classList.remove('active');
              });
              
              const activeLink = document.querySelector(`[onclick*="${sectionName}"]`);
              if (activeLink) {
                  activeLink.classList.add('active');
              }

              this.currentSection = sectionName;

              // 載入對應的內容
              switch (sectionName) {
                  case 'dashboard':
                      this.renderDashboard();
                      break;
                  case 'transactions':
                      Transactions.render();
                      break;
                  case 'members':
                      Members.render();
                      break;
                  case 'activities':
                      Activities.render();
                      break;
                  case 'announcements':
                      Announcements.render();
                      break;
                  case 'forms':
                      Forms.render();
                      break;
                  case 'accounts':
                      Accounts.render();
                      break;
                  case 'reports':
                      Reports.render();
                      break;
                  case 'settings':
                      Settings.render();
                      break;
                  default:
                      this.renderDashboard();
              }
          },

          async renderDashboard() {
              try {
                  const dashboardData = await API.getDashboardData();
                  
                  const html = `
                      <div class="fade-in">
                          <div class="row mb-4">
                              <div class="col-md-3 mb-3">
                                  <div class="stats-card">
                                      <div class="stats-number">${dashboardData.members?.active || 0}</div>
                                      <div><i class="fas fa-users me-1"></i>活躍會員</div>
                                  </div>
                              </div>
                              <div class="col-md-3 mb-3">
                                  <div class="stats-card">
                                      <div class="stats-number">${dashboardData.activities?.upcoming || 0}</div>
                                      <div><i class="fas fa-calendar me-1"></i>即將舉行活動</div>
                                  </div>
                              </div>
                              <div class="col-md-3 mb-3">
                                  <div class="stats-card">
                                      <div class="stats-number text-success">$${this.formatNumber(dashboardData.financial?.monthIncome || 0)}</div>
                                      <div><i class="fas fa-arrow-up me-1"></i>本月收入</div>
                                  </div>
                              </div>
                              <div class="col-md-3 mb-3">
                                  <div class="stats-card">
                                      <div class="stats-number text-primary">$${this.formatNumber(dashboardData.totalBalance || 0)}</div>
                                      <div><i class="fas fa-wallet me-1"></i>帳戶餘額</div>
                                  </div>
                              </div>
                          </div>

                          <div class="row">
                              <div class="col-md-8 mb-4">
                                  <div class="card">
                                      <div class="card-header">
                                          <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>財務趨勢</h5>
                                      </div>
                                      <div class="card-body">
                                          <canvas id="financialChart" height="100"></canvas>
                                      </div>
                                  </div>
                              </div>
                              <div class="col-md-4 mb-4">
                                  <div class="card">
                                      <div class="card-header">
                                          <h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>最新公告</h5>
                                      </div>
                                      <div class="card-body">
                                          <div id="latestAnnouncements">
                                              ${this.renderLatestAnnouncements(dashboardData.latestAnnouncements || [])}
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>

                          <div class="row">
                              <div class="col-md-6 mb-4">
                                  <div class="card">
                                      <div class="card-header">
                                          <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>近期活動</h5>
                                      </div>
                                      <div class="card-body">
                                          <div id="upcomingActivities">
                                              ${this.renderUpcomingActivities(dashboardData.upcomingActivities || [])}
                                          </div>
                                      </div>
                                  </div>
                              </div>
                              <div class="col-md-6 mb-4">
                                  <div class="card">
                                      <div class="card-header">
                                          <h5 class="mb-0"><i class="fas fa-pie-chart me-2"></i>會員統計</h5>
                                      </div>
                                      <div class="card-body">
                                          <canvas id="memberChart" height="200"></canvas>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  `;

                  document.getElementById('contentArea').innerHTML = html;
                  
                  // 繪製圖表
                  this.renderFinancialChart(dashboardData.financial);
                  this.renderMemberChart(dashboardData.members);
                  
              } catch (error) {
                  this.showError('載入儀表板失敗: ' + error.message);
              }
          },

          renderLatestAnnouncements(announcements) {
              if (announcements.length === 0) {
                  return '<p class="text-muted">暫無公告</p>';
              }

              return announcements.map(ann => `
                  <div class="border-bottom pb-2 mb-2">
                      <h6 class="mb-1">${ann['標題']}</h6>
                      <small class="text-muted">${this.formatDate(ann['發布日期'])}</small>
                  </div>
              `).join('');
          },

          renderUpcomingActivities(activities) {
              if (activities.length === 0) {
                  return '<p class="text-muted">暫無活動</p>';
              }

              return activities.map(act => `
                  <div class="border-bottom pb-2 mb-2">
                      <h6 class="mb-1">${act['活動名稱']}</h6>
                      <small class="text-muted">
                          <i class="fas fa-calendar me-1"></i>${this.formatDate(act['日期'])}
                          <i class="fas fa-map-marker-alt ms-2 me-1"></i>${act['地點'] || '待定'}
                      </small>
                  </div>
              `).join('');
          },

          renderFinancialChart(financial) {
              const ctx = document.getElementById('financialChart');
              if (!ctx) return;

              new Chart(ctx, {
                  type: 'line',
                  data: {
                      labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                      datasets: [{
                          label: '收入',
                          data: [12000, 15000, 18000, 14000, 16000, financial?.monthIncome || 0],
                          borderColor: 'rgb(39, 174, 96)',
                          backgroundColor: 'rgba(39, 174, 96, 0.1)',
                          tension: 0.4
                      }, {
                          label: '支出',
                          data: [8000, 12000, 15000, 11000, 13000, financial?.monthExpense || 0],
                          borderColor: 'rgb(231, 76, 60)',
                          backgroundColor: 'rgba(231, 76, 60, 0.1)',
                          tension: 0.4
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                          legend: {
                              position: 'top',
                          }
                      },
                      scales: {
                          y: {
                              beginAtZero: true
                          }
                      }
                  }
              });
          },

          renderMemberChart(members) {
              const ctx = document.getElementById('memberChart');
              if (!ctx) return;

              new Chart(ctx, {
                  type: 'doughnut',
                  data: {
                      labels: ['活躍會員', '非活躍會員'],
                      datasets: [{
                          data: [members?.active || 0, members?.inactive || 0],
                          backgroundColor: [
                              'rgb(52, 152, 219)',
                              'rgb(149, 165, 166)'
                          ]
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                          legend: {
                              position: 'bottom'
                          }
                      }
                  }
              });
          },

          toggleSidebar() {
              const sidebar = document.getElementById('sidebar');
              const mainContent = document.getElementById('mainContent');
              
              sidebar.classList.toggle('show');
              sidebar.classList.toggle('collapsed');
              mainContent.classList.toggle('expanded');
          },

          showLoading(show) {
              const overlay = document.getElementById('loadingOverlay');
              overlay.style.display = show ? 'flex' : 'none';
          },

          showSuccess(message) {
              Swal.fire({
                  icon: 'success',
                  title: '成功',
                  text: message,
                  timer: 2000,
                  showConfirmButton: false
              });
          },

          showError(message) {
              Swal.fire({
                  icon: 'error',
                  title: '錯誤',
                  text: message
              });
          },

          showConfirm(message, callback) {
              Swal.fire({
                  title: '確認',
                  text: message,
                  icon: 'question',
                  showCancelButton: true,
                  confirmButtonText: '確定',
                  cancelButtonText: '取消'
              }).then((result) => {
                  if (result.isConfirmed && callback) {
                      callback();
                  }
              });
          },

          formatDate(dateString) {
              if (!dateString) return '-';
              const date = new Date(dateString);
              return date.toLocaleDateString('zh-TW');
          },

          formatNumber(number) {
              return new Intl.NumberFormat('zh-TW').format(number);
          },

          formatCurrency(amount) {
              return new Intl.NumberFormat('zh-TW', {
                  style: 'currency',
                  currency: 'TWD'
              }).format(amount);
          },

          async refreshData() {
              try {
                  await this.loadInitialData();
                  this.showSection(this.currentSection);
                  this.showSuccess('資料已更新');
              } catch (error) {
                  this.showError('更新資料失敗: ' + error.message);
              }
          },

          showHelp() {
              Swal.fire({
                  title: '系統說明',
                  html: `
                      <div class="text-start">
                          <h6>主要功能：</h6>
                          <ul>
                              <li>財務管理：記錄收支交易</li>
                              <li>會員管理：會員資料維護</li>
                              <li>活動管理：活動規劃與報名</li>
                              <li>公告管理：發布組織公告</li>
                              <li>表單管理：自訂表單收集</li>
                              <li>帳戶管理：多帳戶資金管理</li>
                              <li>報表分析：各類統計報表</li>
                          </ul>
                          <h6>快捷鍵：</h6>
                          <ul>
                              <li>Ctrl + R：重新整理資料</li>
                              <li>Ctrl + N：新增記錄</li>
                              <li>Ctrl + F：搜尋</li>
                          </ul>
                      </div>
                  `,
                  width: '600px'
              });
          },

          showProfile() {
              Swal.fire({
                  title: '個人資料',
                  text: '個人資料管理功能開發中...',
                  icon: 'info'
              });
          },

          showSettings() {
              this.showSection('settings');
          },

          logout() {
              this.showConfirm('確定要登出嗎？', () => {
                  window.location.reload();
              });
          },

          bindEvents() {
              // 鍵盤快捷鍵
              document.addEventListener('keydown', (e) => {
                  if (e.ctrlKey) {
                      switch (e.key) {
                          case 'r':
                              e.preventDefault();
                              this.refreshData();
                              break;
                          case 'f':
                              e.preventDefault();
                              const searchInput = document.querySelector('input[type="text"]');
                              if (searchInput) searchInput.focus();
                              break;
                      }
                  }
              });

              // 響應式處理
              window.addEventListener('resize', () => {
                  if (window.innerWidth > 768) {
                      document.getElementById('sidebar').classList.remove('show');
                  }
              });
          }
      };

      // ==================== 活動管理模組 ====================
      const Activities = {
          currentData: [],
          
          render() {
              const html = `
                  <div class="fade-in">
                      <div class="d-flex justify-content-between align-items-center mb-4">
                          <h2><i class="fas fa-calendar-alt me-2"></i>活動管理</h2>
                          <div>
                              <button class="btn btn-success me-2" onclick="Activities.showAddModal()">
                                  <i class="fas fa-plus me-1"></i>新增活動
                              </button>
                              <button class="btn btn-info me-2" onclick="BatchImport.open('activities')">
                                  <i class="fas fa-upload me-1"></i>批次匯入
                              </button>
                              <button class="btn btn-secondary" onclick="Activities.exportData()">
                                  <i class="fas fa-download me-1"></i>匯出資料
                              </button>
                          </div>
                      </div>

                      <div class="card">
                          <div class="card-header">
                              <div class="row align-items-center">
                                  <div class="col-md-6">
                                      <h5 class="mb-0">活動列表</h5>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="input-group">
                                          <input type="text" class="form-control" id="activitySearch" 
                                                 placeholder="搜尋活動..." onkeyup="Activities.search()">
                                          <button class="btn btn-outline-secondary" onclick="Activities.showFilter()">
                                              <i class="fas fa-filter"></i>
                                          </button>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <div class="card-body">
                              <div id="activityTable">
                                  <!-- 表格內容將動態載入 -->
                              </div>
                          </div>
                      </div>
                  </div>
              `;

              document.getElementById('contentArea').innerHTML = html;
              this.loadData();
          },

          async loadData() {
              try {
                  this.currentData = await API.getActivities();
                  this.renderTable();
              } catch (error) {
                  AppLayout.showError('載入活動資料失敗: ' + error.message);
              }
          },

          renderTable() {
              const tableHtml = `
                  <div class="table-responsive">
                      <table class="table table-hover">
                          <thead>
                              <tr>
                                  <th>活動名稱</th>
                                  <th>類型</th>
                                  <th>日期</th>
                                  <th>地點</th>
                                  <th>人數</th>
                                  <th>費用</th>
                                  <th>狀態</th>
                                  <th>負責人</th>
                                  <th>操作</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${this.currentData.map(activity => `
                                  <tr>
                                      <td><strong>${activity['活動名稱'] || '-'}</strong></td>
                                      <td>${activity['類型'] || '-'}</td>
                                      <td>${AppLayout.formatDate(activity['日期'])}</td>
                                      <td>${activity['地點'] || '-'}</td>
                                      <td>
                                          <span class="badge bg-info">
                                              ${activity['目前人數'] || 0}/${activity['最大人數'] || '∞'}
                                          </span>
                                      </td>
                                      <td>${AppLayout.formatCurrency(activity['費用'] || 0)}</td>
                                      <td>
                                          <span class="badge ${this.getStatusClass(activity['狀態'])}">
                                              ${this.getStatusText(activity['狀態'])}
                                          </span>
                                      </td>
                                      <td>${activity['負責人'] || '-'}</td>
                                      <td>
                                          <button class="btn btn-sm btn-outline-info me-1" 
                                                  onclick="Activities.showDetailModal('${activity['ID']}')">
                                              <i class="fas fa-eye"></i>
                                          </button>
                                          <button class="btn btn-sm btn-outline-primary me-1" 
                                                  onclick="Activities.showEditModal('${activity['ID']}')">
                                              <i class="fas fa-edit"></i>
                                          </button>
                                          <button class="btn btn-sm btn-outline-success me-1" 
                                                  onclick="Activities.showRegistrations('${activity['ID']}')">
                                              <i class="fas fa-users"></i>
                                          </button>
                                          <button class="btn btn-sm btn-outline-danger" 
                                                  onclick="Activities.deleteActivity('${activity['ID']}')">
                                              <i class="fas fa-trash"></i>
                                          </button>
                                      </td>
                                  </tr>
                              `).join('')}
                          </tbody>
                      </table>
                  </div>
              `;

              document.getElementById('activityTable').innerHTML = tableHtml;
          },

          getStatusClass(status) {
              const statusMap = {
                  'planning': 'bg-warning',
                  'published': 'bg-success',
                  'ongoing': 'bg-info',
                  'completed': 'bg-secondary',
                  'cancelled': 'bg-danger'
              };
              return statusMap[status] || 'bg-secondary';
          },

          getStatusText(status) {
              const statusMap = {
                  'planning': '規劃中',
                  'published': '已發布',
                  'ongoing': '進行中',
                  'completed': '已完成',
                  'cancelled': '已取消'
              };
              return statusMap[status] || '未知';
          },

          showAddModal() {
              Swal.fire({
                  title: '新增活動',
                  html: this.getActivityForm(),
                  width: '900px',
                  showCancelButton: true,
                  confirmButtonText: '新增',
                  cancelButtonText: '取消',
                  preConfirm: () => {
                      return this.validateActivityForm();
                  }
              }).then(async (result) => {
                  if (result.isConfirmed) {
                      try {
                          await API.addActivity(result.value);
                          AppLayout.showSuccess('活動已新增');
                          this.loadData();
                      } catch (error) {
                          AppLayout.showError('新增失敗: ' + error.message);
                      }
                  }
              });
          },

          getActivityForm(data = {}) {
              return `
                  <div class="row">
                      <div class="col-md-6">
                          <div class="mb-3">
                              <label class="form-label">活動名稱 *</label>
                              <input type="text" class="form-control" id="activityName" 
                                     value="${data['活動名稱'] || ''}" required>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="mb-3">
                              <label class="form-label">活動類型</label>
                              <select class="form-select" id="activityType">
                                  <option value="">請選擇</option>
                                  <option value="講座" ${data['類型'] === '講座' ? 'selected' : ''}>講座</option>
                                  <option value="工作坊" ${data['類型'] === '工作坊' ? 'selected' : ''}>工作坊</option>
                                  <option value="聚會" ${data['類型'] === '聚會' ? 'selected' : ''}>聚會</option>
                                  <option value="戶外活動" ${data['類型'] === '戶外活動' ? 'selected' : ''}>戶外活動</option>
                                  <option value="志工服務" ${data['類型'] === '志工服務' ? 'selected' : ''}>志工服務</option>
                                  <option value="其他" ${data['類型'] === '其他' ? 'selected' : ''}>其他</option>
                              </select>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="mb-3">
                              <label class="form-label">活動日期 *</label>
                              <input type="date" class="form-control" id="activityDate" 
                                     value="${data['日期'] || ''}" required>
                          </div>
                      </div>
                      <div class="col-md-3">
                          <div class="mb-3">
                              <label class="form-label">開始時間</label>
                              <input type="time" class="form-control" id="activityStartTime" 
                                     value="${data['開始時間'] || ''}">
                          </div>
                      </div>
                      <div class="col-md-3">
                          <div class="mb-3">
                              <label class="form-label">結束時間</label>
                              <input type="time" class="form-control" id="activityEndTime" 
                                     value="${data['結束時間'] || ''}">
                          </div>
                      </div>
                      <div class="col-md-8">
                          <div class="mb-3">
                              <label class="form-label">活動地點</label>
                              <input type="text" class="form-control" id="activityLocation" 
                                     value="${data['地點'] || ''}">
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="mb-3">
                              <label class="form-label">最大人數</label>
                              <input type="number" class="form-control" id="activityMaxParticipants" 
                                     value="${data['最大人數'] || ''}" min="1">
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="mb-3">
                              <label class="form-label">活動費用</label>
                              <input type="number" class="form-control" id="activityFee" 
                                     value="${data['費用'] || 0}" min="0" step="0.01">
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="mb-3">
                              <label class="form-label">負責人</label>
                              <input type="text" class="form-control" id="activityOrganizer" 
                                     value="${data['負責人'] || ''}">
                          </div>
                      </div>
                      <div class="col-12">
                          <div class="mb-3">
                              <label class="form-label">活動描述</label>
                              <textarea class="form-control" id="activityDescription" rows="4">${data['描述'] || ''}</textarea>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="mb-3">
                              <label class="form-label">活動狀態</label>
                              <select class="form-select" id="activityStatus">
                                  <option value="planning" ${data['狀態'] === 'planning' ? 'selected' : ''}>規劃中</option>
                                  <option value="published" ${data['狀態'] === 'published' ? 'selected' : ''}>已發布</option>
                                  <option value="ongoing" ${data['狀態'] === 'ongoing' ? 'selected' : ''}>進行中</option>
                                  <option value="completed" ${data['狀態'] === 'completed' ? 'selected' : ''}>已完成</option>
                                  <option value="cancelled" ${data['狀態'] === 'cancelled' ? 'selected' : ''}>已取消</option>
                              </select>
                          </div>
                      </div>
                  </div>
              `;
          },

          validateActivityForm() {
              const name = document.getElementById('activityName').value.trim();
              const date = document.getElementById('activityDate').value;

              if (!name) {
                  Swal.showValidationMessage('請輸入活動名稱');
                  return false;
              }

              if (!date) {
                  Swal.showValidationMessage('請選擇活動日期');
                  return false;
              }

              return {
                  name,
                  type: document.getElementById('activityType').value,
                  date,
                  startTime: document.getElementById('activityStartTime').value,
                  endTime: document.getElementById('activityEndTime').value,
                  location: document.getElementById('activityLocation').value,
                  maxParticipants: parseInt(document.getElementById('activityMaxParticipants').value) || 0,
                  fee: parseFloat(document.getElementById('activityFee').value) || 0,
                  organizer: document.getElementById('activityOrganizer').value,
                  description: document.getElementById('activityDescription').value,
                  status: document.getElementById('activityStatus').value,
                  currentParticipants: 0
              };
          },

          search() {
              const keyword = document.getElementById('activitySearch').value.toLowerCase();
              
              if (!keyword) {
                  this.renderTable();
                  return;
              }

              const filteredData = this.currentData.filter(activity => {
                  return Object.values(activity).some(value => 
                      String(value).toLowerCase().includes(keyword)
                  );
              });

              const originalData = this.currentData;
              this.currentData = filteredData;
              this.renderTable();
              this.currentData = originalData;
          },

          async deleteActivity(id) {
              AppLayout.showConfirm('確定要刪除這個活動嗎？', async () => {
                  try {
                      await API.deleteActivity(id);
                      AppLayout.showSuccess('活動已刪除');
                      this.loadData();
                  } catch (error) {
                      AppLayout.showError('刪除失敗: ' + error.message);
                  }
              });
          },

          async exportData() {
              try {
                  const result = await API.exportData('activities');
                  const blob = new Blob([JSON.stringify(result.data, null, 2)], { type: 'application/json' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `activities_${new Date().toISOString().split('T')[0]}.json`;
                  a.click();
                  URL.revokeObjectURL(url);
                  AppLayout.showSuccess('資料匯出完成');
              } catch (error) {
                  AppLayout.showError('匯出失敗: ' + error.message);
              }
          }
      };

      // ==================== 公告管理模組 ====================
      const Announcements = {
          currentData: [],
          
          render() {
              const html = `
                  <div class="fade-in">
                      <div class="d-flex justify-content-between align-items-center mb-4">
                          <h2><i class="fas fa-bullhorn me-2"></i>公告管理</h2>
                          <div>
                              <button class="btn btn-success me-2" onclick="Announcements.showAddModal()">
                                  <i class="fas fa-plus me-1"></i>新增公告
                              </button>
                              <button class="btn btn-secondary" onclick="Announcements.exportData()">
                                  <i class="fas fa-download me-1"></i>匯出資料
                              </button>
                          </div>
                      </div>

                      <div class="card">
                          <div class="card-header">
                              <div class="row align-items-center">
                                  <div class="col-md-6">
                                      <h5 class="mb-0">公告列表</h5>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="input-group">
                                          <input type="text" class="form-control" id="announcementSearch" 
                                                 placeholder="搜尋公告..." onkeyup="Announcements.search()">
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <div class="card-body">
                              <div id="announcementTable">
                                  <!-- 表格內容將動態載入 -->
                              </div>
                          </div>
                      </div>
                  </div>
              `;

              document.getElementById('contentArea').innerHTML = html;
              this.loadData();
          },

          async loadData() {
              try {
                  this.currentData = await API.getAnnouncements();
                  this.renderTable();
              } catch (error) {
                  AppLayout.showError('載入公告資料失敗: ' + error.message);
              }
          },

          renderTable() {
              const tableHtml = `
                  <div class="table-responsive">
                      <table class="table table-hover">
                          <thead>
                              <tr>
                                  <th>標題</th>
                                  <th>分類</th>
                                  <th>發布日期</th>
                                  <th>重要性</th>
                                  <th>狀態</th>
                                  <th>發布者</th>
                                  <th>操作</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${this.currentData.map(announcement => `
                                  <tr>
                                      <td><strong>${announcement['標題'] || '-'}</strong></td>
                                      <td>${announcement['分類'] || '-'}</td>
                                      <td>${AppLayout.formatDate(announcement['發布日期'])}</td>
                                      <td>
                                          <span class="badge ${this.getPriorityClass(announcement['重要性'])}">
                                              ${this.getPriorityText(announcement['重要性'])}
                                          </span>
                                      </td>
                                      <td>
                                          <span class="badge ${this.getStatusClass(announcement['狀態'])}">
                                              ${this.getStatusText(announcement['狀態'])}
                                          </span>
                                      </td>
                                      <td>${announcement['發布者'] || '-'}</td>
                                      <td>
                                          <button class="btn btn-sm btn-outline-info me-1" 
                                                  onclick="Announcements.showDetailModal('${announcement['ID']}')">
                                              <i class="fas fa-eye"></i>
                                          </button>
                                          <button class="btn btn-sm btn-outline-primary me-1" 
                                                  onclick="Announcements.showEditModal('${announcement['ID']}')">
                                              <i class="fas fa-edit"></i>
                                          </button>
                                          <button class="btn btn-sm btn-outline-danger" 
                                                  onclick="Announcements.deleteAnnouncement('${announcement['ID']}')">
                                              <i class="fas fa-trash"></i>
                                          </button>
                                      </td>
                                  </tr>
                              `).join('')}
                          </tbody>
                      </table>
                  </div>
              `;

              document.getElementById('announcementTable').innerHTML = tableHtml;
          },

          getPriorityClass(priority) {
              const priorityMap = {
                  'high': 'bg-danger',
                  'normal': 'bg-info',
                  'low': 'bg-secondary'
              };
              return priorityMap[priority] || 'bg-info';
          },

          getPriorityText(priority) {
              const priorityMap = {
                  'high': '重要',
                  'normal': '一般',
                  'low': '低'
              };
              return priorityMap[priority] || '一般';
          },

          getStatusClass(status) {
              const statusMap = {
                  'draft': 'bg-warning',
                  'published': 'bg-success',
                  'archived': 'bg-secondary'
              };
              return statusMap[status] || 'bg-warning';
          },

          getStatusText(status) {
              const statusMap = {
                  'draft': '草稿',
                  'published': '已發布',
                  'archived': '已封存'
              };
              return statusMap[status] || '草稿';
          },

          showAddModal() {
              Swal.fire({
                  title: '新增公告',
                  html: this.getAnnouncementForm(),
                  width: '800px',
                  showCancelButton: true,
                  confirmButtonText: '新增',
                  cancelButtonText: '取消',
                  preConfirm: () => {
                      return this.validateAnnouncementForm();
                  }
              }).then(async (result) => {
                  if (result.isConfirmed) {
                      try {
                          await API.addAnnouncement(result.value);
                          AppLayout.showSuccess('公告已新增');
                          this.loadData();
                      } catch (error) {
                          AppLayout.showError('新增失敗: ' + error.message);
                      }
                  }
              });
          },

          getAnnouncementForm(data = {}) {
              return `
                  <div class="row">
                      <div class="col-md-8">
                          <div class="mb-3">
                              <label class="form-label">公告標題 *</label>
                              <input type="text" class="form-control" id="announcementTitle" 
                                     value="${data['標題'] || ''}" required>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="mb-3">
                              <label class="form-label">分類</label>
                              <select class="form-select" id="announcementCategory">
                                  <option value="">請選擇</option>
                                  <option value="一般公告" ${data['分類'] === '一般公告' ? 'selected' : ''}>一般公告</option>
                                  <option value="活動通知" ${data['分類'] === '活動通知' ? 'selected' : ''}>活動通知</option>
                                  <option value="重要通知" ${data['分類'] === '重要通知' ? 'selected' : ''}>重要通知</option>
                                  <option value="系統公告" ${data['分類'] === '系統公告' ? 'selected' : ''}>系統公告</option>
                              </select>
                          </div>
                      </div>
                      <div class="col-12">
                          <div class="mb-3">
                              <label class="form-label">公告內容 *</label>
                              <textarea class="form-control" id="announcementContent" rows="6" required>${data['內容'] || ''}</textarea>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="mb-3">
                              <label class="form-label">發布日期</label>
                              <input type="date" class="form-control" id="announcementDate" 
                                     value="${data['發布日期'] || new Date().toISOString().split('T')[0]}">
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="mb-3">
                              <label class="form-label">重要性</label>
                              <select class="form-select" id="announcementPriority">
                                  <option value="normal" ${data['重要性'] === 'normal' ? 'selected' : ''}>一般</option>
                                  <option value="high" ${data['重要性'] === 'high' ? 'selected' : ''}>重要</option>
                                  <option value="low" ${data['重要性'] === 'low' ? 'selected' : ''}>低</option>
                              </select>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="mb-3">
                              <label class="form-label">狀態</label>
                              <select class="form-select" id="announcementStatus">
                                  <option value="draft" ${data['狀態'] === 'draft' ? 'selected' : ''}>草稿</option>
                                  <option value="published" ${data['狀態'] === 'published' ? 'selected' : ''}>已發布</option>
                                  <option value="archived" ${data['狀態'] === 'archived' ? 'selected' : ''}>已封存</option>
                              </select>
                          </div>
                      </div>
                  </div>
              `;
          },

          validateAnnouncementForm() {
              const title = document.getElementById('announcementTitle').value.trim();
              const content = document.getElementById('announcementContent').value.trim();

              if (!title) {
                  Swal.showValidationMessage('請輸入公告標題');
                  return false;
              }

              if (!content) {
                  Swal.showValidationMessage('請輸入公告內容');
                  return false;
              }

              return {
                  title,
                  content,
                  category: document.getElementById('announcementCategory').value,
                  publishDate: document.getElementById('announcementDate').value,
                  priority: document.getElementById('announcementPriority').value,
                  status: document.getElementById('announcementStatus').value,
                  publisher: 'System'
              };
          },

          search() {
              const keyword = document.getElementById('announcementSearch').value.toLowerCase();
              
              if (!keyword) {
                  this.renderTable();
                  return;
              }

              const filteredData = this.currentData.filter(announcement => {
                  return Object.values(announcement).some(value => 
                      String(value).toLowerCase().includes(keyword)
                  );
              });

              const originalData = this.currentData;
              this.currentData = filteredData;
              this.renderTable();
              this.currentData = originalData;
          },

          async deleteAnnouncement(id) {
              AppLayout.showConfirm('確定要刪除這個公告嗎？', async () => {
                  try {
                      await API.deleteAnnouncement(id);
                      AppLayout.showSuccess('公告已刪除');
                      this.loadData();
                  } catch (error) {
                      AppLayout.showError('刪除失敗: ' + error.message);
                  }
              });
          }
      };

      // ==================== 會員管理模組 ====================
      const Members = {
          currentData: [],
          
          render() {
              const html = `
                  <div class="fade-in">
                      <div class="d-flex justify-content-between align-items-center mb-4">
                          <h2><i class="fas fa-users me-2"></i>會員管理</h2>
                          <div>
                              <button class="btn btn-success me-2" onclick="Members.showAddModal()">
                                  <i class="fas fa-plus me-1"></i>新增會員
                              </button>
                              <button class="btn btn-info me-2" onclick="BatchImport.open('members')">
                                  <i class="fas fa-upload me-1"></i>批次匯入
                              </button>
                              <button class="btn btn-secondary" onclick="Members.exportData()">
                                  <i class="fas fa-download me-1"></i>匯出資料
                              </button>
                          </div>
                      </div>

                      <div class="card">
                          <div class="card-header">
                              <div class="row align-items-center">
                                  <div class="col-md-6">
                                      <h5 class="mb-0">會員列表</h5>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="input-group">
                                          <input type="text" class="form-control" id="memberSearch" 
                                                 placeholder="搜尋會員..." onkeyup="Members.search()">
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <div class="card-body">
                              <div id="memberTable">
                                  <!-- 表格內容將動態載入 -->
                              </div>
                          </div>
                      </div>
                  </div>
              `;

              document.getElementById('contentArea').innerHTML = html;
              this.loadData();
          },

          async loadData() {
              try {
                  this.currentData = await API.getMembers();
                  this.renderTable();
              } catch (error) {
                  AppLayout.showError('載入會員資料失敗: ' + error.message);
              }
          },

          renderTable() {
              const tableHtml = `
                  <div class="table-responsive">
                      <table class="table table-hover">
                          <thead>
                              <tr>
                                  <th>姓名</th>
                                  <th>電話</th>
                                  <th>Email</th>
                                  <th>會員類型</th>
                                  <th>加入日期</th>
                                  <th>狀態</th>
                                  <th>操作</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${this.currentData.map(member => `
                                  <tr>
                                      <td><strong>${member['姓名'] || '-'}</strong></td>
                                      <td>${member['電話'] || '-'}</td>
                                      <td>${member['Email'] || '-'}</td>
                                      <td>
                                          <span class="badge ${this.getTypeClass(member['會員類型'])}">
                                              ${this.getTypeText(member['會員類型'])}
                                          </span>
                                      </td>
                                      <td>${AppLayout.formatDate(member['加入日期'])}</td>
                                      <td>
                                          <span class="badge ${this.getStatusClass(member['狀態'])}">
                                              ${this.getStatusText(member['狀態'])}
                                          </span>
                                      </td>
                                      <td>
                                          <button class="btn btn-sm btn-outline-info me-1" 
                                                  onclick="Members.showDetailModal('${member['ID']}')">
                                              <i class="fas fa-eye"></i>
                                          </button>
                                          <button class="btn btn-sm btn-outline-primary me-1" 
                                                  onclick="Members.showEditModal('${member['ID']}')">
                                              <i class="fas fa-edit"></i>
                                          </button>
                                          <button class="btn btn-sm btn-outline-danger" 
                                                  onclick="Members.deleteMember('${member['ID']}')">
                                              <i class="fas fa-trash"></i>
                                          </button>
                                      </td>
                                  </tr>
                              `).join('')}
                          </tbody>
                      </table>
                  </div>
              `;

              document.getElementById('memberTable').innerHTML = tableHtml;
          },

          getTypeClass(type) {
              const typeMap = {
                  'regular': 'bg-info',
                  'vip': 'bg-warning',
                  'lifetime': 'bg-success'
              };
              return typeMap[type] || 'bg-info';
          },

          getTypeText(type) {
              const typeMap = {
                  'regular': '一般會員',
                  'vip': 'VIP會員',
                  'lifetime': '終身會員'
              };
              return typeMap[type] || '一般會員';
          },

          getStatusClass(status) {
              const statusMap = {
                  'active': 'bg-success',
                  'inactive': 'bg-secondary',
                  'suspended': 'bg-danger'
              };
              return statusMap[status] || 'bg-success';
          },

          getStatusText(status) {
              const statusMap = {
                  'active': '活躍',
                  'inactive': '非活躍',
                  'suspended': '暫停'
              };
              return statusMap[status] || '活躍';
          }
      };

      // ==================== 財務管理模組 ====================
      const Transactions = {
          currentData: [],
          
          render() {
              const html = `
                  <div class="fade-in">
                      <div class="d-flex justify-content-between align-items-center mb-4">
                          <h2><i class="fas fa-money-bill-wave me-2"></i>財務管理</h2>
                          <div>
                              <button class="btn btn-success me-2" onclick="Transactions.showAddModal()">
                                  <i class="fas fa-plus me-1"></i>新增交易
                              </button>
                              <button class="btn btn-info me-2" onclick="BatchImport.open('transactions')">
                                  <i class="fas fa-upload me-1"></i>批次匯入
                              </button>
                              <button class="btn btn-secondary" onclick="Transactions.exportData()">
                                  <i class="fas fa-download me-1"></i>匯出資料
                              </button>
                          </div>
                      </div>

                      <div class="row mb-4">
                          <div class="col-md-3">
                              <div class="stats-card">
                                  <div class="stats-number text-success" id="totalIncome">$0</div>
                                  <div><i class="fas fa-arrow-up me-1"></i>總收入</div>
                              </div>
                          </div>
                          <div class="col-md-3">
                              <div class="stats-card">
                                  <div class="stats-number text-danger" id="totalExpense">$0</div>
                                  <div><i class="fas fa-arrow-down me-1"></i>總支出</div>
                              </div>
                          </div>
                          <div class="col-md-3">
                              <div class="stats-card">
                                  <div class="stats-number text-primary" id="netProfit">$0</div>
                                  <div><i class="fas fa-chart-line me-1"></i>淨利潤</div>
                              </div>
                          </div>
                          <div class="col-md-3">
                              <div class="stats-card">
                                  <div class="stats-number" id="transactionCount">0</div>
                                  <div><i class="fas fa-list me-1"></i>交易筆數</div>
                              </div>
                          </div>
                      </div>

                      <div class="card">
                          <div class="card-header">
                              <div class="row align-items-center">
                                  <div class="col-md-6">
                                      <h5 class="mb-0">交易記錄</h5>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="input-group">
                                          <input type="text" class="form-control" id="transactionSearch" 
                                                 placeholder="搜尋交易..." onkeyup="Transactions.search()">
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <div class="card-body">
                              <div id="transactionTable">
                                  <!-- 表格內容將動態載入 -->
                              </div>
                          </div>
                      </div>
                  </div>
              `;

              document.getElementById('contentArea').innerHTML = html;
              this.loadData();
          },

          async loadData() {
              try {
                  this.currentData = await API.getTransactions();
                  this.renderTable();
                  this.updateStats();
              } catch (error) {
                  AppLayout.showError('載入交易資料失敗: ' + error.message);
              }
          },

          updateStats() {
              let totalIncome = 0;
              let totalExpense = 0;

              this.currentData.forEach(transaction => {
                  const amount = parseFloat(transaction['金額']) || 0;
                  if (transaction['類型'] === '收入') {
                      totalIncome += amount;
                  } else if (transaction['類型'] === '支出') {
                      totalExpense += amount;
                  }
              });

              const netProfit = totalIncome - totalExpense;

              document.getElementById('totalIncome').textContent = AppLayout.formatCurrency(totalIncome);
              document.getElementById('totalExpense').textContent = AppLayout.formatCurrency(totalExpense);
              document.getElementById('netProfit').textContent = AppLayout.formatCurrency(netProfit);
              document.getElementById('transactionCount').textContent = this.currentData.length;
          },

          renderTable() {
              const tableHtml = `
                  <div class="table-responsive">
                      <table class="table table-hover">
                          <thead>
                              <tr>
                                  <th>日期</th>
                                  <th>類型</th>
                                  <th>類別</th>
                                  <th>金額</th>
                                  <th>對象</th>
                                  <th>帳戶</th>
                                  <th>說明</th>
                                  <th>操作</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${this.currentData.map(transaction => `
                                  <tr>
                                      <td>${AppLayout.formatDate(transaction['日期'])}</td>
                                      <td>
                                          <span class="badge ${transaction['類型'] === '收入' ? 'bg-success' : 'bg-danger'}">
                                              ${transaction['類型']}
                                          </span>
                                      </td>
                                      <td>${transaction['類別'] || '-'}</td>
                                      <td class="${transaction['類型'] === '收入' ? 'text-success' : 'text-danger'}">
                                          ${AppLayout.formatCurrency(transaction['金額'] || 0)}
                                      </td>
                                      <td>${transaction['對象'] || '-'}</td>
                                      <td>${transaction['帳戶'] || '-'}</td>
                                      <td>${transaction['說明'] || '-'}</td>
                                      <td>
                                          <button class="btn btn-sm btn-outline-primary me-1" 
                                                  onclick="Transactions.showEditModal('${transaction['ID']}')">
                                              <i class="fas fa-edit"></i>
                                          </button>
                                          <button class="btn btn-sm btn-outline-danger" 
                                                  onclick="Transactions.deleteTransaction('${transaction['ID']}')">
                                              <i class="fas fa-trash"></i>
                                          </button>
                                      </td>
                                  </tr>
                              `).join('')}
                          </tbody>
                      </table>
                  </div>
              `;

              document.getElementById('transactionTable').innerHTML = tableHtml;
          }
      };

      // ==================== 系統設定模組 ====================
      const Settings = {
          render() {
              const html = `
                  <div class="fade-in">
                      <h2><i class="fas fa-cog me-2"></i>系統設定</h2>
                      
                      <div class="card">
                          <div class="card-header">
                              <h5 class="mb-0">基本設定</h5>
                          </div>
                          <div class="card-body">
                              <div class="row">
                                  <div class="col-md-6">
                                      <div class="mb-3">
                                          <label class="form-label">組織名稱</label>
                                          <input type="text" class="form-control" id="orgName" 
                                                 value="${globalData.settings.organization_name || ''}">
                                      </div>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="mb-3">
                                          <label class="form-label">貨幣</label>
                                          <select class="form-select" id="currency">
                                              <option value="TWD" ${globalData.settings.currency === 'TWD' ? 'selected' : ''}>台幣 (TWD)</option>
                                              <option value="USD" ${globalData.settings.currency === 'USD' ? 'selected' : ''}>美元 (USD)</option>
                                              <option value="CNY" ${globalData.settings.currency === 'CNY' ? 'selected' : ''}>人民幣 (CNY)</option>
                                          </select>
                                      </div>
                                  </div>
                              </div>
                              
                              <div class="row">
                                  <div class="col-12">
                                      <button class="btn btn-primary" onclick="Settings.saveSettings()">
                                          <i class="fas fa-save me-1"></i>儲存設定
                                      </button>
                                      <button class="btn btn-secondary ms-2" onclick="Settings.testConnection()">
                                          <i class="fas fa-plug me-1"></i>測試連線
                                      </button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              `;

              document.getElementById('contentArea').innerHTML = html;
          },

          async saveSettings() {
              try {
                  const settings = {
                      organization_name: document.getElementById('orgName').value,
                      currency: document.getElementById('currency').value
                  };

                  await API.updateSettings(settings);
                  AppLayout.showSuccess('設定已儲存');
                  await AppLayout.loadInitialData();
              } catch (error) {
                  AppLayout.showError('儲存設定失敗: ' + error.message);
              }
          },

          async testConnection() {
              try {
                  const result = await API.testConnection();
                  AppLayout.showSuccess(`連線測試成功\n試算表: ${result.spreadsheetName}\n版本: ${result.version}`);
              } catch (error) {
                  AppLayout.showError('連線測試失敗: ' + error.message);
              }
          }
      };

      // ==================== 批次匯入模組 ====================
      const BatchImport = {
          open(type) {
              Swal.fire({
                  title: '批次匯入',
                  html: `
                      <div class="mb-3">
                          <label class="form-label">選擇 CSV 檔案</label>
                          <input type="file" class="form-control" id="importFile" accept=".csv">
                      </div>
                      <div class="alert alert-info">
                          <small>請確保 CSV 檔案格式正確，第一行為標題行</small>
                      </div>
                  `,
                  showCancelButton: true,
                  confirmButtonText: '匯入',
                  cancelButtonText: '取消',
                  preConfirm: () => {
                      const file = document.getElementById('importFile').files[0];
                      if (!file) {
                          Swal.showValidationMessage('請選擇檔案');
                          return false;
                      }
                      return file;
                  }
              }).then(async (result) => {
                  if (result.isConfirmed) {
                      try {
                          const data = await this.parseCSV(result.value);
                          const importResult = await API.batchImport(type, data);
                          AppLayout.showSuccess(`匯入完成\n成功: ${importResult.successCount}\n失敗: ${importResult.errorCount}`);
                          AppLayout.refreshData();
                      } catch (error) {
                          AppLayout.showError('匯入失敗: ' + error.message);
                      }
                  }
              });
          },

          parseCSV(file) {
              return new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onload = (e) => {
                      try {
                          const csv = e.target.result;
                          const lines = csv.split('\n');
                          const headers = lines[0].split(',');
                          const data = [];

                          for (let i = 1; i < lines.length; i++) {
                              if (lines[i].trim()) {
                                  const values = lines[i].split(',');
                                  const obj = {};
                                  headers.forEach((header, index) => {
                                      obj[header.trim()] = values[index] ? values[index].trim() : '';
                                  });
                                  data.push(obj);
                              }
                          }

                          resolve(data);
                      } catch (error) {
                          reject(error);
                      }
                  };
                  reader.onerror = () => reject(new Error('檔案讀取失敗'));
                  reader.readAsText(file, 'UTF-8');
              });
          }
      };

      // ==================== 報表模組 ====================
      const Reports = {
          render() {
              const html = `
                  <div class="fade-in">
                      <h2><i class="fas fa-chart-bar me-2"></i>報表分析</h2>
                      
                      <div class="row">
                          <div class="col-md-4 mb-4">
                              <div class="card">
                                  <div class="card-body text-center">
                                      <i class="fas fa-money-bill-wave fa-3x text-success mb-3"></i>
                                      <h5>財務報表</h5>
                                      <p class="text-muted">收支統計與分析</p>
                                      <button class="btn btn-success" onclick="Reports.generateFinancialReport()">
                                          產生報表
                                      </button>
                                  </div>
                              </div>
                          </div>
                          
                          <div class="col-md-4 mb-4">
                              <div class="card">
                                  <div class="card-body text-center">
                                      <i class="fas fa-users fa-3x text-primary mb-3"></i>
                                      <h5>會員報表</h5>
                                      <p class="text-muted">會員統計與分析</p>
                                      <button class="btn btn-primary" onclick="Reports.generateMemberReport()">
                                          產生報表
                                      </button>
                                  </div>
                              </div>
                          </div>
                          
                          <div class="col-md-4 mb-4">
                              <div class="card">
                                  <div class="card-body text-center">
                                      <i class="fas fa-calendar-alt fa-3x text-info mb-3"></i>
                                      <h5>活動報表</h5>
                                      <p class="text-muted">活動統計與分析</p>
                                      <button class="btn btn-info" onclick="Reports.generateActivityReport()">
                                          產生報表
                                      </button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              `;

              document.getElementById('contentArea').innerHTML = html;
          },

          async generateFinancialReport() {
              try {
                  const result = await API.generateReport({
                      type: 'financial',
                      startDate: '2024-01-01',
                      endDate: new Date().toISOString().split('T')[0]
                  });

                  Swal.fire({
                      title: '財務報表',
                      html: `
                          <div class="text-start">
                              <h6>報表期間: ${result.period.startDate} ~ ${result.period.endDate}</h6>
                              <hr>
                              <div class="row">
                                  <div class="col-6">
                                      <strong>總收入:</strong><br>
                                      <span class="text-success fs-5">${AppLayout.formatCurrency(result.summary.totalIncome)}</span>
                                  </div>
                                  <div class="col-6">
                                      <strong>總支出:</strong><br>
                                      <span class="text-danger fs-5">${AppLayout.formatCurrency(result.summary.totalExpense)}</span>
                                  </div>
                              </div>
                              <hr>
                              <div class="row">
                                  <div class="col-6">
                                      <strong>淨利潤:</strong><br>
                                      <span class="text-primary fs-5">${AppLayout.formatCurrency(result.summary.netProfit)}</span>
                                  </div>
                                  <div class="col-6">
                                      <strong>交易筆數:</strong><br>
                                      <span class="fs-5">${result.summary.transactionCount}</span>
                                  </div>
                              </div>
                          </div>
                      `,
                      width: '600px'
                  });
              } catch (error) {
                  AppLayout.showError('產生報表失敗: ' + error.message);
              }
          }
      };

      // ==================== 系統初始化 ====================
      document.addEventListener('DOMContentLoaded', function() {
          AppLayout.init();
      });
  </script>
</body>
</html>
