<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>台灣帕金森病友權益促進會 - 會計暨營運整合管理系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="非營利組織整合：財務 / 會員 / 活動 / 公告 / 表單 / 雲端備份管理系統">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <style>
    :root {
      --primary:#2c5aa0;
      --primary-dark:#1e3d6f;
      --gradient-primary:linear-gradient(135deg,#2c5aa0,#4a90e2);
      --gradient-green:linear-gradient(135deg,#28a745,#20c997);
      --gradient-orange:linear-gradient(135deg,#ff9f40,#ffb347);
      --secondary-bg:#f8f9fa;
      --radius-lg:15px;
      --radius-md:10px;
      --radius-sm:6px;
    }
    body {background:var(--secondary-bg);font-family:"Microsoft JhengHei","Noto Sans TC",system-ui,sans-serif;font-size:14.5px;}
    .navbar-brand {font-weight:600;color:var(--primary)!important;}
    .sidebar {min-height:100vh;background:linear-gradient(180deg,#2c5aa0,#1e3d6f);color:#fff;}
    .sidebar .nav-link {color:rgba(255,255,255,.82);border-radius:8px;margin:3px 0;font-weight:500;transition:.25s;}
    .sidebar .nav-link:hover,.sidebar .nav-link.active {background:rgba(255,255,255,0.12);color:#fff;transform:translateX(4px);}
    .content-section {animation:fadeIn .35s ease;}
    @keyframes fadeIn {from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
    .stat-card {background:var(--gradient-primary);color:#fff;border:none;border-radius:var(--radius-lg);box-shadow:0 4px 14px -4px rgba(0,0,0,.18);position:relative;overflow:hidden;}
    .stat-card.alt-green{background:var(--gradient-green);}
    .stat-card.alt-orange{background:var(--gradient-orange);}
    .stat-card .icon-bg{position:absolute;right:-10px;top:-10px;font-size:72px;opacity:.16;}
    .card-hoverable{transition:.25s;border:none;border-radius:var(--radius-lg);}
    .card-hoverable:hover{transform:translateY(-4px);box-shadow:0 8px 24px -6px rgba(0,0,0,.15);}
    .table thead th {background:#f1f4f8;border-top:none;font-weight:600;}
    .badge-rounded{border-radius:20px;font-weight:500;letter-spacing:.5px;}
    .member-avatar,.participant-avatar{width:40px;height:40px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;color:#666;font-weight:600;box-shadow:0 0 0 1px rgba(0,0,0,.05);}
    .small-avatar{width:32px;height:32px;font-size:12px;}
    .voucher-preview img{max-width:100px;max-height:100px;object-fit:cover;border-radius:6px;margin:4px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.15);}
    .loading-overlay{position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;}
    .pagination .page-link{border:none;border-radius:8px;color:var(--primary);}
    .pagination .page-item.active .page-link{background:var(--primary);}
    .chart-container{position:relative;height:380px;}
    .separator-title{font-size:15px;font-weight:600;margin:16px 0 10px;display:flex;align-items:center;gap:.5rem;}
    .separator-title:before,.separator-title:after{content:"";flex:1;height:1px;background:linear-gradient(90deg,#d0d3d9,#ffffff);}
    .activity-card{border:none;border-radius:var(--radius-lg);overflow:hidden;box-shadow:0 3px 10px -2px rgba(0,0,0,.12);position:relative;}
    .activity-card .progress{height:6px;border-radius:3px;background:#e9ecef;overflow:hidden;}
    .activity-card .progress-bar{background:var(--gradient-green);}
    .announcement-card{border-left:5px solid #ffc107;border-radius:var(--radius-md);}
    .announcement-card.urgent{border-left-color:#dc3545;background:linear-gradient(135deg,#fff5f5,#ffffff);}
    .row-invalid{background:#fff5f5!important;}
    .row-duplicate{background:#fff9e6!important;}
    .spin{animation:spin 1s linear infinite;}
    @keyframes spin {from{transform:rotate(0)}to{transform:rotate(360deg)}}
    @media print {.no-print,.sidebar,.navbar,.modal-backdrop{display:none!important;}body{background:#fff}.main-content{margin:0!important;padding:0!important}.card{box-shadow:none!important}}
    @media (max-width: 992px){.sidebar{position:fixed;left:0;top:0;transform:translateX(-100%);transition:.35s;z-index:1100;width:250px}.sidebar.show{transform:translateX(0)}}
    .receipt-seal-placeholder{width:60px;height:60px;border:2px solid #c00;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#c00;}
  </style>
</head>
<body>
<!-- 全螢幕載入遮罩 -->
<div id="loadingOverlay" class="loading-overlay" style="display:none;">
  <div class="text-center text-white">
    <div class="mb-3"><i class="bi bi-arrow-clockwise spin" style="font-size:48px;"></i></div>
    <div>系統載入中，請稍候…</div>
  </div>
</div>

<!-- 導覽列 -->
<nav class="navbar navbar-expand-lg bg-white shadow-sm no-print">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="#" onclick="AppLayout.showSection('dashboard')">
      <i class="bi bi-heart-pulse me-2"></i> 台灣帕金森病友權益促進會
    </a>
    <button class="navbar-toggler" type="button" onclick="AppLayout.toggleSidebar()">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto align-items-lg-center">
        <li class="nav-item me-2">
          <div class="input-group input-group-sm">
            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
            <input id="globalSearchInput" type="text" class="form-control" placeholder="全域搜尋 (交易 / 會員 / 活動 / 公告)" onkeydown="if(event.key==='Enter') GlobalSearch.exec()">
          </div>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle fw-semibold" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-gear"></i> 系統
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" onclick="SettingsUI.open()"><i class="bi bi-sliders"></i> 系統設定</a></li>
            <li><a class="dropdown-item" href="#" onclick="AccountUI.openManager()"><i class="bi bi-bank"></i> 帳戶管理</a></li>
            <li><a class="dropdown-item" href="#" onclick="GoogleSync.open()"><i class="bi bi-cloud-arrow-up"></i> 雲端同步</a></li>
            <li><a class="dropdown-item" href="#" onclick="BatchImport.open('transactions')"><i class="bi bi-cloud-upload"></i> 批次匯入</a></li>
            <li><a class="dropdown-item" href="#" onclick="DataPort.exportAll()"><i class="bi bi-download"></i> 匯出資料</a></li>
            <li><a class="dropdown-item" href="#" onclick="DataPort.importAll()"><i class="bi bi-upload"></i> 匯入資料</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="Shortcuts.show()"><i class="bi bi-keyboard"></i> 快捷鍵</a></li>
            <li><a class="dropdown-item" href="#" onclick="About.show()"><i class="bi bi-info-circle"></i> 關於</a></li>
            <li><a class="dropdown-item" href="#" onclick="ConfirmReset.show()"><i class="bi bi-exclamation-triangle"></i> 系統重置</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <!-- 側邊欄 -->
    <aside id="sidebar" class="sidebar col-lg-2 col-md-3 p-3">
      <h6 class="text-center mt-2 mb-4 fw-semibold">管理選單</h6>
      <nav class="nav flex-column">
        <a class="nav-link active" href="#" onclick="AppLayout.showSection('dashboard',this)"><i class="bi bi-speedometer2 me-2"></i>儀表板</a>
        <a class="nav-link" href="#" onclick="AppLayout.showSection('transactions',this)"><i class="bi bi-receipt me-2"></i>交易記錄</a>
          <a class="nav-link" href="#" onclick="AppLayout.showSection('members',this)"><i class="bi bi-people me-2"></i>會員管理</a>
        <a class="nav-link" href="#" onclick="AppLayout.showSection('activities',this)"><i class="bi bi-calendar-event me-2"></i>活動管理</a>
        <a class="nav-link" href="#" onclick="AppLayout.showSection('announcements',this)"><i class="bi bi-megaphone me-2"></i>公告管理</a>
        <a class="nav-link" href="#" onclick="AppLayout.showSection('forms',this)"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單</a>
        <a class="nav-link" href="#" onclick="AppLayout.showSection('analytics',this)"><i class="bi bi-graph-up me-2"></i>統計分析</a>
        <a class="nav-link" href="#" onclick="AppLayout.showSection('reports',this)"><i class="bi bi-file-earmark-text me-2"></i>報表中心</a>
      </nav>
    </aside>

    <!-- 主要內容 -->
    <main id="mainContent" class="col-lg-10 col-md-9 p-4">
      <!-- 儀表板 -->
      <section id="dashboardSection" class="content-section">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>儀表板</h4>
          <div class="d-flex gap-2">
            <div class="d-flex gap-1 me-3">
              <span id="syncIndicator" class="badge bg-success"><i class="bi bi-cloud-check"></i> 已同步</span>
              <span id="cloudIndicator" class="badge bg-info"><i class="bi bi-cloud"></i> 雲端未連線</span>
              <span id="offlineIndicator" class="badge bg-danger d-none"><i class="bi bi-wifi-off"></i> 離線</span>
            </div>
            <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
            <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
            <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-6 col-md-3">
            <div class="stat-card p-3 h-100">
              <div class="icon-bg"><i class="bi bi-cash-coin"></i></div>
              <small>總收入</small>
              <h3 id="dashTotalIncome" class="mb-1">$0</h3>
              <div class="d-flex justify-content-between">
                <span class="small opacity-75">本月</span>
                <span id="dashMonthIncome" class="small fw-semibold">$0</span>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stat-card p-3 h-100 alt-orange">
              <div class="icon-bg"><i class="bi bi-credit-card-2-front"></i></div>
              <small>總支出</small>
              <h3 id="dashTotalExpense" class="mb-1">$0</h3>
              <div class="d-flex justify-content-between">
                <span class="small opacity-75">本月</span>
                <span id="dashMonthExpense" class="small fw-semibold">$0</span>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stat-card p-3 h-100 alt-green">
              <div class="icon-bg"><i class="bi bi-bank"></i></div>
              <small>帳戶總餘額</small>
              <h3 id="dashTotalBalance" class="mb-1">$0</h3>
              <div class="d-flex justify-content-between">
                <span class="small opacity-75">帳戶數</span>
                <span id="dashAccountCount" class="small fw-semibold">0</span>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stat-card p-3 h-100">
              <div class="icon-bg"><i class="bi bi-people"></i></div>
              <small>會員總數</small>
              <h3 id="dashMemberTotal" class="mb-1">0</h3>
              <div class="d-flex justify-content-between">
                <span class="small opacity-75">逾期會費</span>
                <span id="dashMemberOverdue" class="badge bg-danger rounded-pill">0</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-hoverable mb-3">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-bank me-1"></i>帳戶餘額概覽</h6>
            <button class="btn btn-sm btn-outline-primary" onclick="AccountUI.openManager()"><i class="bi bi-gear"></i> 管理帳戶</button>
          </div>
          <div class="card-body">
            <div id="dashboardAccountBalances" class="row g-3"></div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-lg-4">
            <div class="card card-hoverable h-100">
              <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-arrows-expand me-1"></i>最近交易</h6>
              </div>
              <div class="card-body p-2" id="dashboardRecentTx">
                <div class="text-center text-muted py-4">
                  <i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card card-hoverable h-100">
              <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-person-plus me-1"></i>新加入會員</h6>
              </div>
              <div class="card-body p-2" id="dashboardRecentMembers">
                <div class="text-center text-muted py-4">
                  <i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card card-hoverable h-100">
              <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-calendar-event me-1"></i>近期活動</h6>
              </div>
              <div class="card-body p-2" id="dashboardRecentActivities">
                <div class="text-center text-muted py-4">
                  <i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 交易記錄 -->
      <section id="transactionsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-receipt me-2"></i>交易記錄</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="AdvancedSearch.open()"><i class="bi bi-search"></i> 進階搜尋</button>
            <button class="btn btn-outline-success btn-sm" onclick="BatchImport.open('transactions')"><i class="bi bi-cloud-upload"></i> 批次匯入</button>
            <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
          </div>
        </div>

        <div class="card card-hoverable mb-3">
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-md-2">
                <label class="form-label mb-1">年份</label>
                <select id="txFilterYear" class="form-select form-select-sm" onchange="Transactions.renderTable()">
                  <option value="">全部</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label mb-1">月份</label>
                <select id="txFilterMonth" class="form-select form-select-sm" onchange="Transactions.renderTable()">
                  <option value="">全部</option>
                  <option value="1">1月</option>
                  <option value="2">2月</option>
                  <option value="3">3月</option>
                  <option value="4">4月</option>
                  <option value="5">5月</option>
                  <option value="6">6月</option>
                  <option value="7">7月</option>
                  <option value="8">8月</option>
                  <option value="9">9月</option>
                  <option value="10">10月</option>
                  <option value="11">11月</option>
                  <option value="12">12月</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label mb-1">類型</label>
                <select id="txFilterType" class="form-select form-select-sm" onchange="Transactions.renderTable()">
                  <option value="">全部</option>
                  <option value="收入">收入</option>
                  <option value="支出">支出</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label mb-1">關鍵字</label>
                <input id="txFilterKeyword" type="text" class="form-control form-control-sm" placeholder="類別 / 對象 / 說明 / 編號" oninput="Transactions.renderTable()">
              </div>
              <div class="col-md-2 d-grid">
                <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportTransactions()"><i class="bi bi-download"></i> 匯出</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-hoverable">
          <div class="card-body">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
              <div><span id="txRecordCount" class="fw-semibold">0 筆</span></div>
              <div class="d-flex gap-2">
                <select id="txBatchAction" class="form-select form-select-sm">
                  <option value="">批次操作</option>
                  <option value="delete">刪除</option>
                  <option value="export">匯出</option>
                  <option value="print">列印收據</option>
                  <option value="voucher">列印憑證</option>
                </select>
                <button class="btn btn-outline-primary btn-sm" onclick="Transactions.batchAction()">
                  <i class="bi bi-check2-square"></i> 執行
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-2">
                <thead>
                  <tr>
                    <th style="width:30px;"><input type="checkbox" id="txSelectAll" onclick="Transactions.toggleSelectAll(this)"></th>
                    <th>日期</th><th>類型</th><th>類別</th><th class="text-end">金額</th><th>對象</th><th>帳戶</th><th>說明</th><th>編號/附件</th><th>操作</th>
                  </tr>
                </thead>
                <tbody id="txTableBody">
                  <tr><td colspan="10" class="text-center py-5 text-muted">
                    <i class="bi bi-inbox display-6 d-block mb-2"></i> 尚無資料
                  </td></tr>
                </tbody>
              </table>
            </div>
            <nav class="d-flex justify-content-center">
              <ul id="txPagination" class="pagination pagination-sm mb-0"></ul>
            </nav>
          </div>
        </div>
      </section>

      <!-- 會員管理 -->
      <section id="membersSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-people me-2"></i>會員管理</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-success btn-sm" onclick="BatchImport.open('members')"><i class="bi bi-cloud-upload"></i> 批次匯入</button>
            <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-6 col-md-3">
            <div class="card text-center card-hoverable p-2">
              <small class="text-muted">總會員</small>
              <h4 id="mStatTotal" class="mb-0">0</h4>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card text-center card-hoverable p-2">
              <small class="text-muted">正常</small>
              <h4 id="mStatActive" class="text-success mb-0">0</h4>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card text-center card-hoverable p-2">
              <small class="text-muted">逾期會費</small>
              <h4 id="mStatOverdue" class="text-danger mb-0">0</h4>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card text-center card-hoverable p-2">
              <small class="text-muted">本月新增</small>
              <h4 id="mStatNew" class="mb-0">0</h4>
            </div>
          </div>
        </div>

        <div class="card card-hoverable mb-3">
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-md-3">
                <label class="form-label mb-1">狀態</label>
                <select id="memberFilterStatus" class="form-select form-select-sm" onchange="Members.renderTable()">
                  <option value="">全部</option>
                  <option value="active">正常</option>
                  <option value="inactive">停權</option>
                  <option value="pending">待審核</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label mb-1">會員類型</label>
                <select id="memberFilterType" class="form-select form-select-sm" onchange="Members.renderTable()">
                  <option value="">全部</option>
                  <option value="regular">一般會員</option>
                  <option value="honorary">榮譽會員</option>
                  <option value="life">終身會員</option>
                  <option value="family">家屬會員</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label mb-1">關鍵字</label>
                <input id="memberFilterKeyword" type="text" class="form-control form-control-sm" placeholder="姓名 / 電話 / Email / 標籤" oninput="Members.renderTable()">
              </div>
              <div class="col-md-2 d-grid">
                <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportMembers()"><i class="bi bi-download"></i> 匯出</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-hoverable">
          <div class="card-body">
            <div class="d-flex flex-wrap justify-content-between mb-2 gap-2">
              <span id="memberRecordCount" class="fw-semibold">0 筆記錄</span>
              <div class="d-flex gap-2">
                <select id="memberBatchAction" class="form-select form-select-sm">
                  <option value="">批次操作</option>
                  <option value="delete">刪除</option>
                  <option value="export">匯出</option>
                  <option value="status-active">設為正常</option>
                  <option value="status-inactive">設為停權</option>
                </select>
                <button class="btn btn-outline-primary btn-sm" onclick="Members.batchAction()"><i class="bi bi-check2-square"></i> 執行</button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th style="width:30px;"><input type="checkbox" id="memberSelectAll" onclick="Members.toggleSelectAll(this)"></th>
                    <th>基本資料</th><th>聯絡</th><th>年齡/性別</th><th>加入</th><th>狀態</th><th>會費</th><th>標籤</th><th>操作</th>
                  </tr>
                </thead>
                <tbody id="memberTableBody">
                  <tr><td colspan="9" class="text-center text-muted py-5">
                    <i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員資料
                  </td></tr>
                </tbody>
              </table>
            </div>
            <nav class="d-flex justify-content-center">
              <ul id="memberPagination" class="pagination pagination-sm mb-0"></ul>
            </nav>
          </div>
        </div>
      </section>

      <!-- 活動管理 -->
      <section id="activitiesSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-calendar-event me-2"></i>活動管理</h4>
          <div class="d-flex align-items-center gap-3">
            <span id="actRecordCount" class="badge bg-secondary">0 活動</span>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportActivities()"><i class="bi bi-download"></i> 匯出</button>
              <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
            </div>
          </div>
        </div>

        <div class="card card-hoverable mb-3">
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-md-2">
                <label class="form-label mb-1">狀態</label>
                <select id="actFilterStatus" class="form-select form-select-sm" onchange="Activities.renderGrid()">
                  <option value="">全部</option>
                  <option value="draft">草稿</option>
                  <option value="published">已發布</option>
                  <option value="registration">報名中</option>
                  <option value="full">已額滿</option>
                  <option value="closed">已結束</option>
                  <option value="cancelled">已取消</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label mb-1">類型</label>
                <select id="actFilterType" class="form-select form-select-sm" onchange="Activities.renderGrid()">
                  <option value="">全部</option>
                  <option value="講座">講座</option>
                  <option value="聚會">聚會</option>
                  <option value="旅遊">旅遊</option>
                  <option value="運動">運動</option>
                  <option value="志工">志工服務</option>
                  <option value="其他">其他</option>
                </select>
              </div>
              <div class="col-md-5">
                <label class="form-label mb-1">關鍵字</label>
                <input id="actFilterKeyword" type="text" class="form-control form-control-sm" placeholder="名稱 / 地點 / 描述" oninput="Activities.renderGrid()">
              </div>
              <div class="col-md-3">
                <label class="form-label mb-1">排序</label>
                <select id="actFilterSort" class="form-select form-select-sm" onchange="Activities.renderGrid()">
                  <option value="date_desc">日期(新→舊)</option>
                  <option value="date_asc">日期(舊→新)</option>
                  <option value="name_asc">名稱</option>
                  <option value="regs_desc">報名多→少</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div id="activitiesGrid" class="row g-4">
          <div class="col-12 text-center py-5 text-muted">
            <i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動
          </div>
        </div>
        <nav class="d-flex justify-content-center mt-3">
          <ul id="actPagination" class="pagination pagination-sm mb-0"></ul>
        </nav>
      </section>

      <!-- 公告管理 -->
      <section id="announcementsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-megaphone me-2"></i>公告管理</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportAnnouncements()"><i class="bi bi-download"></i> 匯出</button>
            <button class="btn btn-warning btn-sm" onclick="AnnouncementUI.open()"><i class="bi bi-plus-circle"></i> 新增公告</button>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-6 col-md-4">
            <div class="card p-2 text-center card-hoverable">
              <small class="text-muted">公告總數</small>
              <h5 id="annStatTotal" class="mb-0">0</h5>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="card p-2 text-center card-hoverable">
              <small class="text-muted">有效公告</small>
              <h5 id="annStatActive" class="text-success mb-0">0</h5>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="card p-2 text-center card-hoverable">
              <small class="text-muted">緊急公告</small>
              <h5 id="annStatUrgent" class="text-danger mb-0">0</h5>
            </div>
          </div>
        </div>

        <div class="card card-hoverable mb-3">
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-md-3">
                <label class="form-label mb-1">狀態</label>
                <select id="annFilterStatus" class="form-select form-select-sm" onchange="Announcements.render()">
                  <option value="">全部</option>
                  <option value="draft">草稿</option>
                  <option value="published">已發布</option>
                  <option value="expired">已過期</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label mb-1">類型</label>
                <select id="annFilterType" class="form-select form-select-sm" onchange="Announcements.render()">
                  <option value="">全部</option>
                  <option value="normal">一般</option>
                  <option value="urgent">緊急</option>
                  <option value="event">活動相關</option>
                  <option value="system">系統公告</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label mb-1">關鍵字</label>
                <input id="annFilterKeyword" type="text" class="form-control form-control-sm" placeholder="標題 / 內容關鍵字" oninput="Announcements.render()">
              </div>
            </div>
          </div>
        </div>

        <div id="announcementsGrid" class="row g-4">
          <div class="col-12 text-center py-5 text-muted">
            <i class="bi bi-megaphone display-6 d-block mb-2"></i> 尚無公告
          </div>
        </div>
        <nav class="d-flex justify-content-center mt-3">
          <ul id="annPagination" class="pagination pagination-sm mb-0"></ul>
        </nav>
      </section>

      <!-- 行政表單 -->
      <section id="formsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單下載</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-primary btn-sm" onclick="FormUI.openManager()"><i class="bi bi-gear"></i> 管理表單</button>
          </div>
        </div>

        <div class="card card-hoverable mb-3">
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-md-8">
                <label class="form-label mb-1">關鍵字</label>
                <input id="formFilterKeyword" type="text" class="form-control form-control-sm" placeholder="搜尋表單名稱 / 關鍵字" oninput="Forms.render()">
              </div>
              <div class="col-md-4">
                <label class="form-label mb-1">分類</label>
                <select id="formFilterCategory" class="form-select form-select-sm" onchange="Forms.render()">
                  <option value="">全部</option>
                  <option value="會員">會員相關</option>
                  <option value="財務">財務相關</option>
                  <option value="活動">活動相關</option>
                  <option value="行政">行政相關</option>
                  <option value="其他">其他</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div id="formsList" class="row g-3">
          <div class="col-12 text-center py-5 text-muted">
            <i class="bi bi-file-earmark-arrow-down display-6 d-block mb-2"></i> 尚無表單
          </div>
        </div>
      </section>

      <!-- 統計分析 -->
      <section id="analyticsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-graph-up me-2"></i>統計分析</h4>
          <div>
            <select id="analyticsYear" class="form-select form-select-sm d-inline-block w-auto" onchange="Analytics.refresh()">
              <option value="">全部年度</option>
            </select>
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-6 col-md-3">
            <div class="card text-center p-2 card-hoverable">
              <small>年度收入</small>
              <h5 id="anaTotalIncome" class="text-success mb-0">$0</h5>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card text-center p-2 card-hoverable">
              <small>年度支出</small>
              <h5 id="anaTotalExpense" class="text-danger mb-0">$0</h5>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card text-center p-2 card-hoverable">
              <small>年度結餘</small>
              <h5 id="anaBalance" class="mb-0">$0</h5>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card text-center p-2 card-hoverable">
              <small>平均月度</small>
              <h5 id="anaAvgMonthly" class="mb-0">$0</h5>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-lg-6">
            <div class="card card-hoverable">
              <div class="card-header bg-white"><h6 class="mb-0">收支趨勢</h6></div>
              <div class="card-body"><div class="chart-container"><canvas id="chartTrend"></canvas></div></div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card card-hoverable">
              <div class="card-header bg-white"><h6 class="mb-0">支出類別占比</h6></div>
              <div class="card-body"><div class="chart-container"><canvas id="chartExpenseCategory"></canvas></div></div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card card-hoverable">
              <div class="card-header bg-white"><h6 class="mb-0">月度收支對比</h6></div>
              <div class="card-body"><div class="chart-container"><canvas id="chartMonthlyCompare"></canvas></div></div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card card-hoverable">
              <div class="card-header bg-white"><h6 class="mb-0">會員成長趨勢</h6></div>
              <div class="card-body"><div class="chart-container"><canvas id="chartMemberGrowth"></canvas></div></div>
            </div>
          </div>
        </div>
      </section>

      <!-- 報表中心 -->
      <section id="reportsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>報表中心</h4>
          <div class="d-flex gap-2">
            <input id="reportStartDate" type="date" class="form-control form-control-sm">
            <input id="reportEndDate" type="date" class="form-control form-control-sm">
            <button class="btn btn-primary btn-sm" onclick="Reports.quickDate('thisMonth')">本月</button>
            <button class="btn btn-outline-primary btn-sm" onclick="Reports.quickDate('thisYear')">今年</button>
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <div class="card card-hoverable h-100">
              <div class="card-body text-center">
                <i class="bi bi-cash-stack display-5 text-primary mb-2"></i>
                <h6 class="fw-semibold">現金出納帳</h6>
                <p class="small text-muted mb-2">現金帳戶收支逐筆紀錄</p>
                <button class="btn btn-primary btn-sm" onclick="Reports.generate('cashbook')"><i class="bi bi-download"></i> 生成</button>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card card-hoverable h-100">
              <div class="card-body text-center">
                <i class="bi bi-bar-chart-line display-5 text-success mb-2"></i>
                <h6 class="fw-semibold">收支決算表</h6>
                <p class="small text-muted mb-2">期間收入支出與結餘</p>
                <button class="btn btn-success btn-sm" onclick="Reports.generate('incomeExpense')"><i class="bi bi-download"></i> 生成</button>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card card-hoverable h-100">
              <div class="card-body text-center">
                <i class="bi bi-building display-5 text-warning mb-2"></i>
                <h6 class="fw-semibold">資產負債表</h6>
                <p class="small text-muted mb-2">截至日期財務結構</p>
                <button class="btn btn-warning btn-sm" onclick="Reports.generate('balanceSheet')"><i class="bi bi-download"></i> 生成</button>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card card-hoverable h-100">
              <div class="card-body text-center">
                <i class="bi bi-journal-text display-5 text-info mb-2"></i>
                <h6 class="fw-semibold">年度分類帳</h6>
                <p class="small text-muted mb-2">各類別借貸彙總</p>
                <button class="btn btn-info btn-sm text-white" onclick="Reports.generate('ledger')"><i class="bi bi-download"></i> 生成</button>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card card-hoverable h-100">
              <div class="card-body text-center">
                <i class="bi bi-list-ul display-5 text-secondary mb-2"></i>
                <h6 class="fw-semibold">綜合流水帳</h6>
                <p class="small text-muted mb-2">所有交易明細列表</p>
                <button class="btn btn-secondary btn-sm" onclick="Reports.generate('journal')"><i class="bi bi-download"></i> 生成</button>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card card-hoverable h-100">
              <div class="card-body text-center">
                <i class="bi bi-people-fill display-5 text-dark mb-2"></i>
                <h6 class="fw-semibold">會員報表</h6>
                <p class="small text-muted mb-2">會員結構統計</p>
                <button class="btn btn-dark btn-sm" onclick="Reports.generate('member')"><i class="bi bi-download"></i> 生成</button>
              </div>
            </div>
          </div>
        </div>
        <div id="reportResult" class="mt-3"></div>
      </section>

      <!-- MODALS 匯總 (交易、會員、活動、公告、帳戶、表單、設定、批次匯入、報表、同步) -->

      <!-- 交易 Modal -->
      <div class="modal fade" id="transactionModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h6 class="modal-title"><i class="bi bi-receipt me-2"></i><span id="txModalTitle">新增交易</span></h6>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="txForm">
                <input type="hidden" id="txId">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">日期 *</label>
                    <input id="txDate" type="date" class="form-control" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">類型 *</label>
                    <select id="txType" class="form-select" required onchange="TransactionUI.onTypeChange()">
                      <option value="">請選擇</option>
                      <option value="收入">收入</option>
                      <option value="支出">支出</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">帳戶 *</label>
                    <select id="txAccount" class="form-select" required></select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">類別 *</label>
                    <select id="txCategory" class="form-select" required></select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">金額 *</label>
                    <input id="txAmount" type="number" min="0" step="1" class="form-control" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">對象</label>
                    <input id="txCounterparty" type="text" class="form-control" list="counterpartyDatalist">
                    <datalist id="counterpartyDatalist"></datalist>
                  </div>
                  <div class="col-12">
                    <label class="form-label">說明</label>
                    <textarea id="txDescription" rows="2" class="form-control" placeholder="可留空"></textarea>
                  </div>
                  <div class="col-md-6">
                    <label id="txNumberLabel" for="txNumber" class="form-label">收據編號</label>
                    <input id="txNumber" type="text" class="form-control" placeholder="自動帶入，可覆寫">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">附件(憑證) 上傳</label>
                    <input id="txVouchers" type="file" class="form-control" multiple accept="image/*,application/pdf" onchange="TransactionUI.handleVoucherUpload(event)">
                    <div class="form-text">支援多檔：圖片 / PDF</div>
                  </div>
                  <div class="col-12">
                    <div id="txVoucherPreview" class="voucher-preview"></div>
                  </div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
              <button class="btn btn-primary btn-sm" onclick="TransactionUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 會員 Modal -->
      <div class="modal fade" id="memberModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header bg-success text-white">
              <h6 class="modal-title"><i class="bi bi-person me-2"></i><span id="memberModalTitle">新增會員</span></h6>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="memberForm">
                <input type="hidden" id="memberId">
                <div class="row g-3">
                  <div class="col-md-4">
                    <h6 class="fw-semibold">基本資料</h6>
                    <label class="form-label mt-2">姓名 *</label>
                    <input id="memberName" class="form-control" required>
                    <label class="form-label mt-2">電話 *</label>
                    <input id="memberPhone" class="form-control" required>
                    <label class="form-label mt-2">電子郵件</label>
                    <input id="memberEmail" type="email" class="form-control">
                    <div class="row mt-2 g-2">
                      <div class="col-6">
                        <label class="form-label">出生日期</label>
                        <input id="memberBirthDate" type="date" class="form-control">
                      </div>
                      <div class="col-6">
                        <label class="form-label">性別</label>
                        <select id="memberGender" class="form-select">
                          <option value="">未指定</option>
                          <option value="男">男</option>
                          <option value="女">女</option>
                          <option value="其他">其他</option>
                        </select>
                      </div>
                    </div>
                    <label class="form-label mt-2">身分證字號</label>
                    <input id="memberIdNumber" maxlength="10" class="form-control">
                  </div>
                  <div class="col-md-4">
                    <h6 class="fw-semibold">聯絡資訊</h6>
                    <label class="form-label mt-2">地址</label>
                    <textarea id="memberAddress" rows="3" class="form-control"></textarea>
                    <label class="form-label mt-2">緊急聯絡人</label>
                    <input id="emergencyContact" class="form-control">
                    <label class="form-label mt-2">緊急聯絡電話</label>
                    <input id="emergencyPhone" class="form-control">
                    <label class="form-label mt-2">備註</label>
                    <textarea id="memberNotes" rows="3" class="form-control"></textarea>
                  </div>
                  <div class="col-md-4">
                    <h6 class="fw-semibold">會員資訊</h6>
                    <label class="form-label mt-2">加入日期 *</label>
                    <input id="memberJoinDate" type="date" class="form-control" required>
                    <label class="form-label mt-2">狀態</label>
                    <select id="memberStatus" class="form-select">
                      <option value="active">正常</option>
                      <option value="inactive">停權</option>
                      <option value="pending">待審核</option>
                    </select>
                    <label class="form-label mt-2">會員類型</label>
                    <select id="memberType" class="form-select">
                      <option value="regular">一般會員</option>
                      <option value="honorary">榮譽會員</option>
                      <option value="life">終身會員</option>
                      <option value="family">家屬會員</option>
                    </select>
                    <label class="form-label mt-2">年費金額</label>
                    <input id="membershipFee" type="number" class="form-control" value="1000" min="0">
                    <label class="form-label mt-2">最後繳費日期</label>
                    <input id="lastPaymentDate" type="date" class="form-control">
                    <label class="form-label mt-2">標籤（逗號分隔）</label>
                    <input id="memberTags" class="form-control" placeholder="例：病友,志工">
                  </div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
              <button class="btn btn-success btn-sm" onclick="MemberUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 會員詳情 Modal -->
      <div class="modal fade" id="memberDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header bg-dark text-white">
              <h6 class="modal-title"><i class="bi bi-person-badge me-2"></i>會員詳情</h6>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="memberDetailContent"></div>
            <div class="modal-footer">
              <button class="btn btn-outline-success btn-sm" onclick="Members.recordFee()"><i class="bi bi-credit-card"></i> 紀錄繳費</button>
              <button class="btn btn-outline-primary btn-sm" onclick="Members.printCard()"><i class="bi bi-printer"></i> 會員卡</button>
              <button class="btn btn-primary btn-sm" onclick="MemberUI.editFromDetail()"><i class="bi bi-pencil"></i> 編輯</button>
              <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 活動 Modal -->
      <div class="modal fade" id="activityModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header bg-info text-white">
              <h6 class="modal-title"><i class="bi bi-calendar-event me-2"></i><span id="activityModalTitle">新增活動</span></h6>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="activityForm">
                <input type="hidden" id="activityId">
                <div class="row g-3">
                  <div class="col-lg-8">
                    <label class="form-label">活動名稱 *</label>
                    <input id="activityName" class="form-control" required>
                    <div class="row g-2 mt-2">
                      <div class="col-md-6">
                        <label class="form-label">活動類型 *</label>
                        <select id="activityType" class="form-select" required>
                          <option value="">選擇</option>
                          <option value="講座">講座</option>
                          <option value="聚會">聚會</option>
                          <option value="旅遊">旅遊</option>
                          <option value="運動">運動</option>
                          <option value="志工">志工服務</option>
                          <option value="其他">其他</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">狀態</label>
                        <select id="activityStatus" class="form-select">
                          <option value="draft">草稿</option>
                          <option value="published">已發布</option>
                          <option value="registration">報名中</option>
                          <option value="full">已額滿</option>
                          <option value="closed">已結束</option>
                          <option value="cancelled">已取消</option>
                        </select>
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-md-6">
                        <label class="form-label">活動日期 *</label>
                        <input id="activityDate" type="date" class="form-control" required>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">活動時間</label>
                        <input id="activityTime" type="time" class="form-control">
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-md-6">
                        <label class="form-label">報名開始</label>
                        <input id="regStartDate" type="date" class="form-control">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">報名截止</label>
                        <input id="regEndDate" type="date" class="form-control">
                      </div>
                    </div>
                    <label class="form-label mt-2">地點</label>
                    <input id="activityLocation" class="form-control" placeholder="可留空">
                    <label class="form-label mt-2">活動描述</label>
                    <textarea id="activityDescription" rows="4" class="form-control"></textarea>
                  </div>
                  <div class="col-lg-4">
                    <label class="form-label">活動圖片 (僅前端預覽)</label>
                    <input id="activityImage" type="file" accept="image/*" class="form-control" onchange="ActivityUI.previewImage(event)">
                    <div id="activityImagePreview" class="mt-2"></div>
                    <div class="row g-2 mt-1">
                      <div class="col-6">
                        <label class="form-label mt-2">人數上限</label>
                        <input id="activityMax" type="number" min="1" value="50" class="form-control">
                      </div>
                      <div class="col-6">
                        <label class="form-label mt-2">費用</label>
                        <input id="activityFee" type="number" min="0" value="0" class="form-control">
                      </div>
                    </div>
                    <label class="form-label mt-2">聯絡人</label>
                    <input id="activityContact" class="form-control">
                    <label class="form-label mt-2">聯絡電話</label>
                    <input id="activityContactPhone" class="form-control">
                    <label class="form-label mt-2">備註</label>
                    <textarea id="activityNotes" rows="3" class="form-control"></textarea>
                  </div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
              <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 活動詳情 -->
      <div class="modal fade" id="activityDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header bg-info text-white">
              <h6 class="modal-title"><i class="bi bi-info-circle me-2"></i>活動詳情</h6>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="activityDetailContent"></div>
            <div class="modal-footer">
              <button id="activityRegisterBtn" class="btn btn-success btn-sm" onclick="Registrations.openRegister()" style="display:none;"><i class="bi bi-person-plus"></i> 我要報名</button>
              <button class="btn btn-outline-primary btn-sm" onclick="ActivityUI.editFromDetail()"><i class="bi bi-pencil"></i> 編輯</button>
              <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 活動報名 (現有會員 / 新報名者) -->
      <div class="modal fade" id="registrationModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header bg-success text-white">
              <h6 class="modal-title"><i class="bi bi-person-plus me-2"></i>活動報名</h6>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div id="registrationActivityInfo" class="alert alert-info small mb-3"></div>
              <form id="registrationForm">
                <input type="hidden" id="registrationActivityId">
                <div class="mb-2 fw-semibold">報名身份</div>
                <div class="d-flex gap-3 mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="regType" id="regExisting" value="existing" checked onchange="RegistrationUI.toggleMode()">
                    <label class="form-check-label" for="regExisting">現有會員</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="regType" id="regNew" value="new" onchange="RegistrationUI.toggleMode()">
                    <label class="form-check-label" for="regNew">新報名者</label>
                  </div>
                </div>
                <div id="regExistingBox" class="mb-3">
                  <label class="form-label">選擇會員 *</label>
                  <select id="regMemberSelect" class="form-select"></select>
                </div>
                <div id="regNewBox" class="mb-3" style="display:none;">
                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="form-label">姓名 *</label>
                      <input id="regName" class="form-control">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">電話 *</label>
                      <input id="regPhone" class="form-control">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Email</label>
                      <input id="regEmail" type="email" class="form-control">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">緊急聯絡人</label>
                      <input id="regEmergency" class="form-control">
                    </div>
                  </div>
                </div>
                <label class="form-label">備註 / 特殊需求</label>
                <textarea id="regNotes" rows="2" class="form-control" placeholder="飲食限制 / 行動協助等"></textarea>
                <div class="form-check mt-3">
                  <input id="regAgree" type="checkbox" class="form-check-input">
                  <label for="regAgree" class="form-check-label">我同意活動條款並確認資料正確</label>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
              <button class="btn btn-success btn-sm" onclick="RegistrationUI.submit()"><i class="bi bi-check-circle me-1"></i>送出</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 公告 Modal -->
      <div class="modal fade" id="announcementModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header bg-warning">
              <h6 class="modal-title"><i class="bi bi-megaphone me-2"></i><span id="announcementModalTitle">新增公告</span></h6>
              <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="announcementForm">
                <input type="hidden" id="announcementId">
                <label class="form-label">標題 *</label>
                <input id="announcementTitle" class="form-control" required>
                <div class="row g-2 mt-2">
                  <div class="col-md-4">
                    <label class="form-label">類型</label>
                    <select id="announcementType" class="form-select">
                      <option value="normal">一般</option>
                      <option value="urgent">緊急</option>
                      <option value="event">活動相關</option>
                      <option value="system">系統公告</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">狀態</label>
                    <select id="announcementStatus" class="form-select">
                      <option value="draft">草稿</option>
                      <option value="published">已發布</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">置頂</label>
                    <div class="form-check">
                      <input id="announcementPinned" type="checkbox" class="form-check-input">
                      <label class="form-check-label" for="announcementPinned">置頂公告</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label mt-2">發布日期</label>
                    <input id="announcementPublishDate" type="date" class="form-control">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label mt-2">過期日期</label>
                    <input id="announcementExpireDate" type="date" class="form-control">
                  </div>
                </div>
                <label class="form-label mt-2">內容 *</label>
                <textarea id="announcementContent" rows="6" class="form-control" required></textarea>
                <label class="form-label mt-2">相關連結</label>
                <input id="announcementLink" type="url" class="form-control" placeholder="https://">
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
              <button class="btn btn-warning btn-sm" onclick="AnnouncementUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 帳戶管理 Modal -->
      <div class="modal fade" id="accountManagerModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h6 class="modal-title"><i class="bi bi-bank me-2"></i>帳戶管理</h6>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="d-flex justify-content-end mb-2">
                <button class="btn btn-sm btn-primary" onclick="AccountUI.openEditor()"><i class="bi bi-plus-circle"></i> 新增帳戶</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th>名稱</th><th>說明</th><th class="text-end">初始</th><th class="text-end">目前</th><th>狀態</th><th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="accountTableBody">
                    <tr><td colspan="6" class="text-center text-muted py-4">尚無帳戶</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="small text-muted">提示：有交易的帳戶不可刪除，可改停用。</div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 帳戶編輯 Modal -->
      <div class="modal fade" id="accountEditModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h6 class="modal-title"><i class="bi bi-wallet2 me-2"></i><span id="accountEditTitle">新增帳戶</span></h6>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="accountForm">
                <input type="hidden" id="accountId">
                <label class="form-label">帳戶名稱 *</label>
                <input id="accountName" class="form-control" required>
                <label class="form-label mt-2">說明</label>
                <textarea id="accountDesc" rows="2" class="form-control"></textarea>
                <label class="form-label mt-2">初始餘額</label>
                <input id="accountInitial" type="number" step="0.01" value="0" class="form-control">
                <label class="form-label mt-2">備註</label>
                <textarea id="accountNotes" rows="2" class="form-control"></textarea>
                <div class="form-check mt-2">
                  <input id="accountActive" type="checkbox" class="form-check-input" checked>
                  <label class="form-check-label" for="accountActive">啟用帳戶</label>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
              <button class="btn btn-primary btn-sm" onclick="AccountUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 行政表單管理 Modal -->
      <div class="modal fade" id="formManagerModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h6 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>表單管理</h6>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="d-flex justify-content-end mb-2">
                <button class="btn btn-sm btn-primary" onclick="FormUI.openEditor()"><i class="bi bi-plus-circle"></i> 新增表單</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th>名稱</th><th>分類</th><th>連結</th><th>關鍵字</th><th>狀態</th><th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="formTableBody">
                    <tr><td colspan="6" class="text-center text-muted py-4">尚無表單</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 表單編輯 Modal -->
      <div class="modal fade" id="formEditModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h6 class="modal-title"><i class="bi bi-file-plus me-2"></i><span id="formEditTitle">新增表單</span></h6>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="formEditForm">
                <input type="hidden" id="formId">
                <label class="form-label">名稱 *</label>
                <input id="formName" class="form-control" required>
                <label class="form-label mt-2">分類 *</label>
                <select id="formCategory" class="form-select" required>
                  <option value="">選擇</option>
                  <option value="會員">會員</option>
                  <option value="財務">財務</option>
                  <option value="活動">活動</option>
                  <option value="行政">行政</option>
                  <option value="其他">其他</option>
                </select>
                <label class="form-label mt-2">檔案連結 *</label>
                <input id="formUrl" type="url" class="form-control" placeholder="https://" required>
                <label class="form-label mt-2">關鍵字 (逗號)</label>
                <input id="formKeywords" class="form-control">
                <label class="form-label mt-2">說明</label>
                <textarea id="formDescription" rows="3" class="form-control"></textarea>
                <div class="form-check mt-2">
                  <input id="formActive" type="checkbox" class="form-check-input" checked>
                  <label class="form-check-label" for="formActive">啟用</label>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
              <button class="btn btn-primary btn-sm" onclick="FormUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 系統設定 Modal -->
      <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h6 class="modal-title"><i class="bi bi-sliders me-2"></i>系統設定</h6>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="settingsForm" class="row gy-3">
                <div class="col-md-6">
                  <h6 class="fw-semibold mb-2">組織資訊</h6>
                  <label class="form-label">組織名稱</label>
                  <input id="setOrgName" class="form-control">
                  <label class="form-label mt-2">地址</label>
                  <textarea id="setOrgAddress" rows="2" class="form-control"></textarea>
                  <label class="form-label mt-2">電話</label>
                  <input id="setOrgPhone" class="form-control">
                  <label class="form-label mt-2">Email</label>
                  <input id="setOrgEmail" type="email" class="form-control">
                  <label class="form-label mt-2">預設年費</label>
                  <input id="setDefaultFee" type="number" class="form-control" value="1000" min="0">
                </div>
                <div class="col-md-6">
                  <h6 class="fw-semibold mb-2">系統 / 編號 / 印章</h6>
                  <label class="form-label">收據前綴</label>
                  <input id="setReceiptPrefix" class="form-control" maxlength="5">
                  <label class="form-label mt-2">憑證前綴</label>
                  <input id="setVoucherPrefix" class="form-control" maxlength="5">
                  <label class="form-label mt-2">出納章文字</label>
                  <input id="setSealTreasurer" class="form-control">
                  <label class="form-label mt-2">會計章文字</label>
                  <input id="setSealAccountant" class="form-control">
                  <label class="form-label mt-2">理事長章文字</label>
                  <input id="setSealChairman" class="form-control">
                  <div class="form-check mt-3">
                    <input id="setAutoBackup" type="checkbox" class="form-check-input">
                    <label for="setAutoBackup" class="form-check-label">啟用自動備份</label>
                  </div>
                  <div class="form-check mt-2">
                    <input id="setNotifications" type="checkbox" class="form-check-input">
                    <label for="setNotifications" class="form-check-label">啟用通知提醒</label>
                  </div>
                </div>
                <div class="col-12">
                  <h6 class="fw-semibold mt-3 mb-2">交易類別管理</h6>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <div class="border p-2 rounded">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                          <span class="fw-semibold">收入類別</span>
                          <div class="input-group input-group-sm" style="width:180px;">
                            <input id="newIncomeCat" class="form-control" placeholder="新增">
                            <button class="btn btn-outline-primary" onclick="SettingsUI.addCategory('收入');return false;">+</button>
                          </div>
                        </div>
                        <div id="incomeCategoryList" class="d-flex flex-wrap gap-1"></div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="border p-2 rounded">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                          <span class="fw-semibold">支出類別</span>
                          <div class="input-group input-group-sm" style="width:180px;">
                            <input id="newExpenseCat" class="form-control" placeholder="新增">
                            <button class="btn btn-outline-primary" onclick="SettingsUI.addCategory('支出');return false;">+</button>
                          </div>
                        </div>
                        <div id="expenseCategoryList" class="d-flex flex-wrap gap-1"></div>
                      </div>
                    </div>
                  </div>
                  <div class="small text-muted mt-2">點擊標籤可刪除類別。（刪除不影響既有交易）</div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline-danger btn-sm me-auto" onclick="SettingsUI.resetCategoryConfirm()">重置預設類別</button>
              <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
              <button class="btn btn-primary btn-sm" onclick="SettingsUI.save()"><i class="bi bi-save me-1"></i>儲存設定</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 批次匯入 Modal -->
      <div class="modal fade" id="batchImportModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-lg-down modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
              <h6 class="modal-title"><i class="bi bi-cloud-upload me-2"></i>批次匯入</h6>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <ul class="nav nav-tabs" id="batchTabs">
                <li class="nav-item">
                  <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#batchTxnTab">交易匯入</button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#batchMemberTab">會員匯入</button>
                </li>
              </ul>
              <div class="tab-content pt-3">
                <!-- 交易匯入 -->
                <div id="batchTxnTab" class="tab-pane fade show active">
                  <div class="row g-3">
                    <div class="col-lg-3">
                      <div class="border p-3 rounded h-100">
                        <h6 class="fw-semibold mb-2"><i class="bi bi-file-earmark-spreadsheet"></i> 上傳檔案</h6>
                        <input id="batchTxFile" type="file" accept=".xlsx,.xls,.csv" class="form-control form-control-sm mb-2" onchange="BatchImport.handleFile('transactions')">
                        <div class="d-grid gap-2 mb-2">
                          <button class="btn btn-outline-secondary btn-sm" onclick="BatchImport.downloadTemplate('transactions')"><i class="bi bi-download"></i> 範本</button>
                          <button class="btn btn-outline-primary btn-sm" onclick="BatchImport.reparse('transactions')"><i class="bi bi-arrow-clockwise"></i> 重新解析</button>
                          <button class="btn btn-outline-danger btn-sm" onclick="BatchImport.clear('transactions')"><i class="bi bi-x-circle"></i> 清除</button>
                        </div>
                        <hr>
                        <h6 class="fw-semibold mb-2"><i class="bi bi-link"></i> 欄位對應</h6>
                        <div id="batchTxFieldMap" class="small"></div>
                        <hr>
                        <div class="form-check">
                          <input id="batchTxSkipError" type="checkbox" class="form-check-input" checked>
                          <label class="form-check-label" for="batchTxSkipError">略過錯誤列</label>
                        </div>
                        <div class="form-check">
                          <input id="batchTxSkipDup" type="checkbox" class="form-check-input" checked>
                          <label class="form-check-label" for="batchTxSkipDup">略過重複</label>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-9">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <span id="batchTxStats" class="badge bg-secondary">尚未載入資料</span>
                        <div class="d-flex gap-2">
                          <button class="btn btn-sm btn-outline-warning" onclick="BatchImport.filterPreview('transactions','errors')"><i class="bi bi-exclamation-triangle"></i> 錯誤</button>
                          <button class="btn btn-sm btn-outline-info" onclick="BatchImport.filterPreview('transactions','duplicates')"><i class="bi bi-files"></i> 重複</button>
                          <button class="btn btn-sm btn-outline-secondary" onclick="BatchImport.filterPreview('transactions','all')"><i class="bi bi-list-ul"></i> 全部</button>
                          <button class="btn btn-sm btn-success" onclick="BatchImport.commit('transactions')"><i class="bi bi-check-circle"></i> 匯入</button>
                        </div>
                      </div>
                      <div class="table-responsive" style="max-height:420px;overflow:auto;">
                        <table class="table table-sm table-hover align-middle mb-0">
                          <thead id="batchTxHead" class="table-light"></thead>
                          <tbody id="batchTxBody">
                            <tr><td class="text-muted">尚未載入檔案</td></tr>
                          </tbody>
                        </table>
                      </div>
                      <div class="small text-muted mt-1">預覽僅顯示前 200 筆，實際匯入包含全部已選資料。</div>
                    </div>
                  </div>
                </div>
                <!-- 會員匯入 -->
                <div id="batchMemberTab" class="tab-pane fade">
                  <div class="row g-3">
                    <div class="col-lg-3">
                      <div class="border p-3 rounded h-100">
                        <h6 class="fw-semibold mb-2"><i class="bi bi-file-earmark-person"></i> 上傳檔案</h6>
                        <input id="batchMemberFile" type="file" accept=".xlsx,.xls,.csv" class="form-control form-control-sm mb-2" onchange="BatchImport.handleFile('members')">
                        <div class="d-grid gap-2 mb-2">
                          <button class="btn btn-outline-secondary btn-sm" onclick="BatchImport.downloadTemplate('members')"><i class="bi bi-download"></i> 範本</button>
                          <button class="btn btn-outline-primary btn-sm" onclick="BatchImport.reparse('members')"><i class="bi bi-arrow-clockwise"></i> 重解析</button>
                          <button class="btn btn-outline-danger btn-sm" onclick="BatchImport.clear('members')"><i class="bi bi-x-circle"></i> 清除</button>
                        </div>
                        <hr>
                        <h6 class="fw-semibold mb-2"><i class="bi bi-link"></i> 欄位對應</h6>
                        <div id="batchMemberFieldMap" class="small"></div>
                        <hr>
                        <div class="form-check">
                          <input id="batchMemberSkipError" type="checkbox" class="form-check-input" checked>
                          <label class="form-check-label" for="batchMemberSkipError">略過錯誤列</label>
                        </div>
                        <div class="form-check">
                          <input id="batchMemberSkipDup" type="checkbox" class="form-check-input" checked>
                          <label class="form-check-label" for="batchMemberSkipDup">略過重複</label>
                        </div>
                        <div class="mt-2">
                          <label class="form-label small">預設年費（若匯入未填）</label>
                          <input id="batchMemberDefaultFee" type="number" value="1000" class="form-control form-control-sm">
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-9">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <span id="batchMemberStats" class="badge bg-secondary">尚未載入資料</span>
                        <div class="d-flex gap-2">
                          <button class="btn btn-sm btn-outline-warning" onclick="BatchImport.filterPreview('members','errors')"><i class="bi bi-exclamation-triangle"></i> 錯誤</button>
                          <button class="btn btn-sm btn-outline-info" onclick="BatchImport.filterPreview('members','duplicates')"><i class="bi bi-files"></i> 重複</button>
                          <button class="btn btn-sm btn-outline-secondary" onclick="BatchImport.filterPreview('members','all')"><i class="bi bi-list-ul"></i> 全部</button>
                          <button class="btn btn-sm btn-success" onclick="BatchImport.commit('members')"><i class="bi bi-check-circle"></i> 匯入</button>
                        </div>
                      </div>
                      <div class="table-responsive" style="max-height:420px;overflow:auto;">
                        <table class="table table-sm table-hover align-middle mb-0">
                          <thead id="batchMemberHead" class="table-light"></thead>
                          <tbody id="batchMemberBody">
                            <tr><td class="text-muted">尚未載入檔案</td></tr>
                          </tbody>
                        </table>
                      </div>
                      <div class="small text-muted mt-1">預覽僅顯示前 200 筆，實際匯入包含全部已選資料。</div>
                    </div>
                  </div>
                </div>
              </div>
              <hr>
              <div class="alert alert-info small mb-0">
                提示：匯入後請至對應頁面確認結果。欄位未對應者會忽略。可透過「略過錯誤」與「略過重複」加速處理。
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 報表 Modal -->
      <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header bg-dark text-white">
              <h6 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i><span id="reportModalTitle">報表</span></h6>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="reportModalBody"></div>
            <div class="modal-footer">
              <button class="btn btn-outline-primary btn-sm" onclick="Reports.print()"><i class="bi bi-printer"></i> 列印</button>
              <button class="btn btn-primary btn-sm" onclick="Reports.exportHTML()"><i class="bi bi-download"></i> 匯出</button>
              <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Google Sync Modal -->
      <div class="modal fade" id="googleSyncModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-info text-white">
              <h6 class="modal-title"><i class="bi bi-cloud-arrow-up me-2"></i>雲端同步設定</h6>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-info small">
                此為示意設定，正式串接 Google Drive / API 時於 GoogleSync.connect / sync / restore 實作。
              </div>
              <div class="form-check mb-2">
                <input id="gsEnable" type="checkbox" class="form-check-input" onchange="GoogleSync.togglePanel()">
                <label class="form-check-label" for="gsEnable">啟用雲端同步</label>
              </div>
              <div id="gsPanel" style="display:none;">
                <label class="form-label">同步頻率</label>
                <select id="gsInterval" class="form-select form-select-sm mb-2">
                  <option value="manual">手動</option>
                  <option value="5">每 5 分鐘</option>
                  <option value="15">每 15 分鐘</option>
                  <option value="30">每 30 分鐘</option>
                  <option value="60">每小時</option>
                </select>
                <div class="d-flex gap-2 flex-wrap">
                  <button id="gsConnectBtn" class="btn btn-outline-primary btn-sm" onclick="GoogleSync.connect()"><i class="bi bi-link-45deg"></i> 連接</button>
                  <button id="gsSyncBtn" class="btn btn-outline-success btn-sm" disabled onclick="GoogleSync.sync()"><i class="bi bi-cloud-upload"></i> 立即同步</button>
                  <button id="gsRestoreBtn" class="btn btn-outline-warning btn-sm" disabled onclick="GoogleSync.restore()"><i class="bi bi-cloud-download"></i> 雲端還原</button>
                </div>
                <div class="small text-muted mt-2" id="gsStatus">尚未連線</div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
              <button class="btn btn-info btn-sm text-white" onclick="GoogleSync.saveSettings()"><i class="bi bi-save"></i> 儲存設定</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Toast -->
      <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:2000;">
        <div id="toastSuccess" class="toast align-items-center border-0" role="alert">
          <div class="d-flex">
            <div class="toast-body"><i class="bi bi-check-circle text-success me-2"></i><span id="toastSuccessMsg">成功</span></div>
            <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
        <div id="toastError" class="toast align-items-center border-0" role="alert">
          <div class="d-flex">
            <div class="toast-body"><i class="bi bi-exclamation-triangle text-danger me-2"></i><span id="toastErrorMsg">錯誤</span></div>
            <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- 依賴套件 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/***********************
 *  API 端點 (請替換)
 ************************/
const API_URL = 'https://script.google.com/macros/s/AKfycbzJEjCzmcbcs01Xbx2Q4ngESAsKBUbm8QuiTOpSkjKFnRsvik3SW3ATnBx5kIIvUVRLZA/exec';

/***********************
 * 公用工具
 ************************/
const Util = {
  uuid: ()=>'id_'+Math.random().toString(36).slice(2,10),
  today: ()=> new Date().toISOString().split('T')[0],
  fmtNum: n=> (Number(n)||0).toLocaleString(),
  toNumber: v=> isNaN(parseFloat(v))?0:parseFloat(v),
  pad:(n,l=2)=> String(n).padStart(l,'0'),
  age(birth){
    if(!birth) return '';
    const d=new Date(birth); if(isNaN(d.getTime())) return '';
    const t=new Date();
    let a=t.getFullYear()-d.getFullYear();
    if(t.getMonth()<d.getMonth()||(t.getMonth()==d.getMonth()&&t.getDate()<d.getDate())) a--;
    return a;
  },
  showToast(type,msg){
    const id = type==='success'?'toastSuccess':'toastError';
    const el = document.getElementById(id);
    if(!el){ alert(msg); return; }
    (type==='success'?document.getElementById('toastSuccessMsg'):document.getElementById('toastErrorMsg')).textContent=msg;
    new bootstrap.Toast(el,{delay:3000}).show();
  },
  confirm(opts){
    return Swal.fire({
      icon:opts.icon||'warning',
      title:opts.title||'確定？',
      html:opts.html||opts.text||'',
      showCancelButton:true,
      confirmButtonText:opts.confirmText||'確定',
      cancelButtonText:opts.cancelText||'取消',
      confirmButtonColor:opts.confirmColor||'#0d6efd'
    });
  },
  downloadBlob(filename, data, type='text/plain'){
    const blob = new Blob([data],{type});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download=filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),1000);
  }
};

/***********************
 * 後端 API 呼叫封裝
 ************************/
const API = {
  async call(action, data = {}) {
    try {
      const res = await fetch(API_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ action, ...data })
      });
      const json = await res.json();
      if(json.error) throw new Error(json.error);
      return json;
    } catch(err){
      console.error(err);
      Util.showToast('error','API 錯誤：'+err.message);
      throw err;
    }
  },
  // CRUD
  getTransactions(){ return this.call('getTransactions'); },
  saveTransaction(transaction){ return this.call('saveTransaction',{transaction}); },
  deleteTransaction(id){ return this.call('deleteTransaction',{id}); },
  getMembers(){ return this.call('getMembers'); },
  saveMember(member){ return this.call('saveMember',{member}); },
  deleteMember(id){ return this.call('deleteMember',{id}); },
  getAccounts(){ return this.call('getAccounts'); },
  saveAccount(account){ return this.call('saveAccount',{account}); },
  deleteAccount(id){ return this.call('deleteAccount',{id}); },
  getActivities(){ return this.call('getActivities'); },
  saveActivity(activity){ return this.call('saveActivity',{activity}); },
  deleteActivity(id){ return this.call('deleteActivity',{id}); },
  getRegistrations(){ return this.call('getRegistrations'); },
  saveRegistration(registration){ return this.call('saveRegistration',{registration}); },
  getAnnouncements(){ return this.call('getAnnouncements'); },
  saveAnnouncement(announcement){ return this.call('saveAnnouncement',{announcement}); },
  deleteAnnouncement(id){ return this.call('deleteAnnouncement',{id}); },
  getForms(){ return this.call('getForms'); },
  saveForm(form){ return this.call('saveForm',{form}); },
  deleteForm(id){ return this.call('deleteForm',{id}); },
  getSettings(){ return this.call('getSettings'); },
  saveSettings(settings){ return this.call('saveSettings',{settings}); }
};

/***********************
 * 本地資料 Store
 ************************/
const Store = {
  data:{
    transactions:[],
    members:[],
    accounts:[],
    activities:[],
    registrations:[],
    announcements:[],
    forms:[],
    settings:{
      organizationName:'台灣帕金森病友權益促進會',
      organizationAddress:'',
      organizationPhone:'',
      organizationEmail:'',
      defaultMembershipFee:1000,
      receiptPrefix:'R',
      voucherPrefix:'V',
      treasurerSeal:'出納',
      accountantSeal:'會計',
      chairmanSeal:'理事長',
      categories:{ '收入':['會費','捐款','活動收入','政府補助','利息收入','其他收入'], '支出':['活動費用','辦公費用','交通費','餐費','場地費','設備費','印刷費','郵電費','保險費','其他支出'] }
    }
  },
  async load(){
    document.getElementById('loadingOverlay').style.display='flex';
    try {
      const [
        transactions, members, accounts, activities,
        registrations, announcements, forms, settings
      ] = await Promise.all([
        API.getTransactions().catch(()=>[]),
        API.getMembers().catch(()=>[]),
        API.getAccounts().catch(()=>[]),
        API.getActivities().catch(()=>[]),
        API.getRegistrations().catch(()=>[]),
        API.getAnnouncements().catch(()=>[]),
        API.getForms().catch(()=>[]),
        API.getSettings().catch(()=>null)
      ]);
      this.data.transactions = transactions||[];
      this.data.members = members||[];
      this.data.accounts = accounts||[];
      this.data.activities = activities||[];
      this.data.registrations = registrations||[];
      this.data.announcements = announcements||[];
      this.data.forms = forms||[];
      if(settings){
        this.data.settings = {
          ...this.data.settings,
          ...settings,
          categories: settings.categories || this.data.settings.categories
        };
      }
    } finally {
      document.getElementById('loadingOverlay').style.display='none';
      SyncIndicator.bump();
    }
  }
};

/***********************
 * 同步指示
 ************************/
const SyncIndicator = {
  timer:null,
  bump(){
    const el=document.getElementById('syncIndicator');
    if(!el) return;
    el.className='badge bg-warning';
    el.innerHTML='<i class="bi bi-cloud-upload"></i> 同步中';
    clearTimeout(this.timer);
    this.timer=setTimeout(()=>{
      el.className='badge bg-success';
      el.innerHTML='<i class="bi bi-cloud-check"></i> 已同步';
    },600);
  }
};

/***********************
 * 編號產生
 ************************/
const Numbering = {
  receipt(){
    const s=Store.data.settings;
    const d=new Date();
    const dateStr = d.getFullYear()+Util.pad(d.getMonth()+1)+Util.pad(d.getDate());
    const count = Store.data.transactions.filter(t=>t.type==='收入' && t.date===Util.today()).length + 1;
    return (s.receiptPrefix||'R')+dateStr+Util.pad(count,3);
  },
  voucher(){
    const s=Store.data.settings;
    const d=new Date();
    const dateStr = d.getFullYear()+Util.pad(d.getMonth()+1)+Util.pad(d.getDate());
    const count = Store.data.transactions.filter(t=>t.type==='支出' && t.date===Util.today()).length + 1;
    return (s.voucherPrefix||'V')+dateStr+Util.pad(count,3);
  }
};

/***********************
 * Layout
 ************************/
const AppLayout = {
  showSection(name,link){
    document.querySelectorAll('.content-section').forEach(s=>s.style.display='none');
    const target = document.getElementById(name+'Section');
    if(target) target.style.display='block';
    document.querySelectorAll('.sidebar .nav-link').forEach(a=>a.classList.remove('active'));
    if(link) link.classList.add('active');
    switch(name){
      case 'dashboard': Dashboard.refresh(); break;
      case 'transactions': Transactions.initFilters(); Transactions.renderTable(); break;
      case 'members': Members.renderTable(); break;
      case 'activities': Activities.renderGrid(); break;
      case 'announcements': Announcements.render(); break;
      case 'forms': Forms.render(); break;
      case 'analytics': Analytics.refresh(); break;
      case 'reports': Reports.initDateOnce(); break;
    }
    if(window.innerWidth<992) this.toggleSidebar(false);
  },
  toggleSidebar(force){
    const sb=document.getElementById('sidebar');
    if(typeof force==='boolean') sb.classList.toggle('show',force);
    else sb.classList.toggle('show');
  }
};

/***********************
 * Dashboard
 ************************/
const Dashboard = {
  refresh(){
    const tx=Store.data.transactions;
    const members=Store.data.members;
    const accounts=Store.data.accounts;
    const now=new Date();
    const monthStr=now.getFullYear()+'-'+Util.pad(now.getMonth()+1);
    let totalIncome=0,totalExpense=0,monthIncome=0,monthExpense=0;

    tx.forEach(t=>{
      const amt=Util.toNumber(t.amount);
      if(t.type==='收入'){ totalIncome+=amt; if(t.date.startsWith(monthStr)) monthIncome+=amt; }
      else { totalExpense+=amt; if(t.date.startsWith(monthStr)) monthExpense+=amt; }
    });

    Accounts.recalcBalances();
    const totalBalance = accounts.reduce((s,a)=>s+(a.currentBalance||0),0);
    const overdue = members.filter(m=>Members.isOverdue(m)).length;

    document.getElementById('dashTotalIncome').textContent='$'+Util.fmtNum(totalIncome);
    document.getElementById('dashTotalExpense').textContent='$'+Util.fmtNum(totalExpense);
    document.getElementById('dashMonthIncome').textContent='$'+Util.fmtNum(monthIncome);
    document.getElementById('dashMonthExpense').textContent='$'+Util.fmtNum(monthExpense);
    document.getElementById('dashTotalBalance').textContent='$'+Util.fmtNum(totalBalance);
    document.getElementById('dashAccountCount').textContent=accounts.length;
    document.getElementById('dashMemberTotal').textContent=members.length;
    document.getElementById('dashMemberOverdue').textContent=overdue;

    this.renderAccounts();
    this.recentTransactions();
    this.recentMembers();
    this.recentActivities();
  },
  renderAccounts(){
    const container=document.getElementById('dashboardAccountBalances');
    const accounts=Store.data.accounts;
    if(!accounts.length){
      container.innerHTML='<div class="col-12 text-muted">尚無帳戶</div>';
      return;
    }
    container.innerHTML=accounts.map(a=>`
      <div class="col-6 col-md-3">
        <div class="border rounded p-2 h-100 small bg-white">
          <div class="d-flex justify-content-between">
            <span class="fw-semibold">${a.name}</span>
            <span class="badge ${a.active?'bg-success':'bg-secondary'}">${a.active?'啟用':'停用'}</span>
          </div>
          <div class="mt-1">
            <span class="text-muted">餘額：</span>
            <span class="${(a.currentBalance||0)>=0?'text-success':'text-danger'} fw-semibold">$${Util.fmtNum(a.currentBalance||0)}</span>
          </div>
        </div>
      </div>
    `).join('');
  },
  recentTransactions(){
    const box=document.getElementById('dashboardRecentTx');
    const arr=[...Store.data.transactions].sort((a,b)=> b.date.localeCompare(a.date)|| (b.updatedAt||'').localeCompare(a.updatedAt||'')).slice(0,6);
    if(!arr.length){
      box.innerHTML='<div class="text-center text-muted py-4"><i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易</div>';return;
    }
    box.innerHTML=arr.map(t=>`
      <div class="d-flex justify-content-between align-items-center border-bottom py-2 small">
        <div>
          <div class="fw-semibold">${t.category}</div>
          <div class="text-muted">${t.date} ${t.counterparty||''}</div>
        </div>
        <div class="text-end">
          <span class="badge ${t.type==='收入'?'bg-success':'bg-danger'}">${t.type==='收入'?'+':'-'}$${Util.fmtNum(t.amount)}</span>
        </div>
      </div>
    `).join('');
  },
  recentMembers(){
    const box=document.getElementById('dashboardRecentMembers');
    const arr=[...Store.data.members].sort((a,b)=> b.joinDate.localeCompare(a.joinDate)).slice(0,6);
    if(!arr.length){
      box.innerHTML='<div class="text-center text-muted py-4"><i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員</div>';return;
    }
    box.innerHTML=arr.map(m=>`
      <div class="d-flex align-items-center border-bottom py-2 small">
        <div class="member-avatar me-2"><i class="bi bi-person"></i></div>
          <div class="flex-grow-1">
            <div class="fw-semibold">${m.name}</div>
            <div class="text-muted">${m.joinDate}</div>
          </div>
          <span class="badge ${Members.badgeClass(m.status)}">${Members.statusText(m.status)}</span>
      </div>
    `).join('');
  },
  recentActivities(){
    const box=document.getElementById('dashboardRecentActivities');
    const arr=[...Store.data.activities].sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||'')).slice(0,6);
    if(!arr.length){
      box.innerHTML='<div class="text-center text-muted py-4"><i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動</div>';return;
    }
    box.innerHTML=arr.map(a=>`
      <div class="d-flex align-items-center border-bottom py-2 small">
        <div class="me-2 text-info"><i class="bi bi-calendar-event"></i></div>
        <div class="flex-grow-1">
          <div class="fw-semibold">${a.name}</div>
          <div class="text-muted">${a.date}</div>
        </div>
        <span class="badge ${Activities.statusBadge(a.status)}">${Activities.statusText(a.status)}</span>
      </div>
    `).join('');
  }
};

/***********************
 * 交易模組
 ************************/
const Transactions = {
  state:{page:1,per:10,filtered:[]},
  initFilters(){
    const yearSel=document.getElementById('txFilterYear');
    if(yearSel && yearSel.options.length===1){
      // 依交易自動補年份
      const years=[...new Set(Store.data.transactions.map(t=> (t.date||'').slice(0,4)).filter(Boolean))].sort().reverse();
      years.forEach(y=>{
        const opt=document.createElement('option');opt.value=y;opt.textContent=y;yearSel.appendChild(opt);
      });
    }
  },
  filter(){
    const year=document.getElementById('txFilterYear').value;
    const month=document.getElementById('txFilterMonth').value;
    const type=document.getElementById('txFilterType').value;
    const kw=document.getElementById('txFilterKeyword').value.trim().toLowerCase();
    this.state.filtered = Store.data.transactions.filter(t=>{
      const d=t.date||'';
      if(year && !d.startsWith(year+'-')) return false;
      if(month && d.slice(5,7)!==Util.pad(month)) return false;
      if(type && t.type!==type) return false;
      if(kw){
        const text=(t.category+' '+(t.counterparty||'')+' '+(t.description||'')+' '+(t.receiptNumber||'')+' '+(t.voucherNumber||'')).toLowerCase();
        if(!text.includes(kw)) return false;
      }
      return true;
    }).sort((a,b)=> b.date.localeCompare(a.date) || (b.createdAt||'').localeCompare(a.createdAt||''));
  },
  renderTable(){
    this.filter();
    const total=this.state.filtered.length;
    const per=this.state.per;
    const pages=Math.max(1,Math.ceil(total/per));
    if(this.state.page>pages) this.state.page=pages;
    const start=(this.state.page-1)*per;
    const rows=this.state.filtered.slice(start,start+per);
    document.getElementById('txRecordCount').textContent=`${total} 筆記錄`;
    const tb=document.getElementById('txTableBody');
    if(!rows.length){
      tb.innerHTML=`<tr><td colspan="10" class="text-center text-muted py-5"><i class="bi bi-inbox display-6 d-block mb-2"></i> 無符合資料</td></tr>`;
    } else {
      tb.innerHTML=rows.map(t=>{
        const num = t.type==='收入'? (t.receiptNumber||'-') : (t.voucherNumber||'-');
        return `<tr>
          <td><input type="checkbox" data-id="${t.id}" class="tx-check"></td>
          <td>${t.date}</td>
          <td><span class="badge ${t.type==='收入'?'bg-success':'bg-danger'}">${t.type}</span></td>
          <td>${t.category}</td>
          <td class="text-end fw-semibold ${t.type==='收入'?'text-success':'text-danger'}">${t.type==='收入'?'+':'-'}$${Util.fmtNum(t.amount)}</td>
          <td>${t.counterparty||'-'}</td>
          <td>${t.account||'-'}</td>
          <td class="small">${t.description||'-'}</td>
          <td class="small">${num} ${t.vouchers?.length?'<i class="bi bi-paperclip text-primary"></i>':''}</td>
          <td>
            <div class="d-flex flex-wrap gap-1">
              <button class="btn btn-sm btn-outline-primary" title="編輯" onclick="TransactionUI.open('${t.id}')"><i class="bi bi-pencil"></i></button>
              ${
                t.type==='收入'
                  ? `<button class="btn btn-sm btn-outline-secondary" title="列印收據" onclick="Transactions.printReceipt('${t.id}')"><i class="bi bi-printer"></i></button>`
                  : `<button class="btn btn-sm btn-outline-secondary" title="列印支出憑證" onclick="Transactions.printVoucher('${t.id}')"><i class="bi bi-printer"></i></button>`
              }
              <button class="btn btn-sm btn-outline-danger" title="刪除" onclick="Transactions.remove('${t.id}')"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        </tr>`;
      }).join('');
    }
    this.renderPagination(pages);
  },
  renderPagination(pages){
    const ul=document.getElementById('txPagination');
    if(!ul) return;
    let h='';
    for(let i=1;i<=pages;i++){
      h+=`<li class="page-item ${i===this.state.page?'active':''}">
        <a class="page-link" href="#" onclick="Transactions.goto(${i});return false;">${i}</a>
      </li>`;
    }
    ul.innerHTML=h;
  },
  goto(p){ this.state.page=p; this.renderTable(); },
  toggleSelectAll(el){
    document.querySelectorAll('#txTableBody .tx-check').forEach(c=> c.checked=el.checked);
  },
  getSelectedIds(){
    return [...document.querySelectorAll('#txTableBody .tx-check:checked')].map(c=>c.dataset.id);
  },
  batchAction(){
    const action=document.getElementById('txBatchAction').value;
    if(!action){ Util.showToast('error','請選擇操作'); return; }
    const ids=this.getSelectedIds();
    if(!ids.length){ Util.showToast('error','未勾選資料'); return; }
    if(action==='delete'){
      Util.confirm({title:'刪除確認',text:`確定刪除 ${ids.length} 筆交易？`}).then(r=>{
        if(!r.isConfirmed) return;
        ids.forEach(id=>{
          const idx=Store.data.transactions.findIndex(t=>t.id===id);
            if(idx>-1) Store.data.transactions.splice(idx,1);
        });
        SyncIndicator.bump();
        this.renderTable();
        Dashboard.refresh();
        Util.showToast('success','已刪除');
      });
    } else if(action==='export'){
      const rows=Store.data.transactions.filter(t=>ids.includes(t.id));
      const csv = ['id,date,type,category,amount,counterparty,account,description,receiptNumber,voucherNumber'].concat(
        rows.map(t=>[
          t.id,t.date,t.type,t.category,t.amount,t.counterparty||'',t.account||'',(t.description||'').replace(/,/g,' '),
          t.receiptNumber||'',t.voucherNumber||''
        ].join(','))
      ).join('\n');
      Util.downloadBlob('transactions_selected.csv',csv,'text/csv');
      Util.showToast('success','已匯出');
    } else if(action==='print'){
      ids.forEach(id=>{ const t=Store.data.transactions.find(x=>x.id===id); if(t && t.type==='收入') this.printReceipt(id); });
    } else if(action==='voucher'){
      ids.forEach(id=>{ const t=Store.data.transactions.find(x=>x.id===id); if(t && t.type==='支出') this.printVoucher(id); });
    }
    document.getElementById('txBatchAction').value='';
  },
  remove(id){
    Util.confirm({title:'刪除交易',text:'此操作無法復原，確定？'}).then(r=>{
      if(!r.isConfirmed) return;
      const idx=Store.data.transactions.findIndex(t=>t.id===id);
      if(idx>-1){
        Store.data.transactions.splice(idx,1);
        SyncIndicator.bump();
        this.renderTable();
        Dashboard.refresh();
        Util.showToast('success','已刪除');
      }
    });
  },
  printReceipt(id){
    const t=Store.data.transactions.find(x=>x.id===id);
    if(!t){ Util.showToast('error','找不到交易'); return; }
    if(t.type!=='收入'){ Util.showToast('error','此交易非收入'); return; }
    const s=Store.data.settings;
    const w=window.open('','_blank','width=720');
    const seals = `
      <div style="display:flex;justify-content:flex-end;gap:40px;margin-top:40px;">
        <div style="text-align:center;">出納<br><div class="receipt-seal-placeholder">${s.treasurerSeal||'出納'}</div></div>
        <div style="text-align:center;">會計<br><div class="receipt-seal-placeholder">${s.accountantSeal||'會計'}</div></div>
        <div style="text-align:center;">理事長<br><div class="receipt-seal-placeholder">${s.chairmanSeal||'理事長'}</div></div>
      </div>`;
    w.document.write(`
      <html><head><title>收據 ${t.receiptNumber||''}</title>
      <style>
        body{font-family:"Microsoft JhengHei",sans-serif;padding:24px;}
        h2{margin:0 0 12px;}
        table{width:100%;border-collapse:collapse;margin-top:12px;}
        td,th{border:1px solid #333;padding:6px;font-size:14px;}
        .right{text-align:right;}
      </style></head><body>
      <h2>${s.organizationName||'組織'} 收入收據</h2>
      <div>收據編號：${t.receiptNumber||''}</div>
      <div>日期：${t.date}</div>
      <table>
        <thead><tr><th>類別</th><th>對象</th><th>說明</th><th>金額</th></tr></thead>
        <tbody><tr><td>${t.category}</td><td>${t.counterparty||''}</td><td>${t.description||''}</td><td class="right">$${Util.fmtNum(t.amount)}</td></tr></tbody>
        <tfoot><tr><th colspan="3">合計</th><th class="right">$${Util.fmtNum(t.amount)}</th></tr></tfoot>
      </table>
      ${seals}
      <script>window.print();</script>
      </body></html>
    `);
    w.document.close();
  },
  printVoucher(id){
    const t=Store.data.transactions.find(x=>x.id===id);
    if(!t){ Util.showToast('error','找不到交易'); return; }
    if(t.type!=='支出'){ Util.showToast('error','此交易非支出'); return; }
    const s=Store.data.settings;
    const w=window.open('','_blank','width=720');
    w.document.write(`
      <html><head><title>支出憑證 ${t.voucherNumber||''}</title>
      <style>
        body{font-family:"Microsoft JhengHei",sans-serif;padding:24px;}
        h2{margin:0 0 12px;}
        table{width:100%;border-collapse:collapse;margin-top:12px;}
        td,th{border:1px solid #333;padding:6px;font-size:14px;}
        .right{text-align:right;}
      </style></head><body>
      <h2>${s.organizationName||'組織'} 支出憑證</h2>
      <div>憑證編號：${t.voucherNumber||''}</div>
      <div>日期：${t.date}</div>
      <table>
        <thead><tr><th>類別</th><th>對象</th><th>說明</th><th>金額</th></tr></thead>
        <tbody><tr><td>${t.category}</td><td>${t.counterparty||''}</td><td>${t.description||''}</td><td class="right">$${Util.fmtNum(t.amount)}</td></tr></tbody>
        <tfoot><tr><th colspan="3">合計</th><th class="right">$${Util.fmtNum(t.amount)}</th></tr></tfoot>
      </table>
      <div style="display:flex;justify-content:flex-end;gap:40px;margin-top:40px;">
        <div style="text-align:center;">出納<br><div class="receipt-seal-placeholder">${s.treasurerSeal||'出納'}</div></div>
        <div style="text-align:center;">會計<br><div class="receipt-seal-placeholder">${s.accountantSeal||'會計'}</div></div>
        <div style="text-align:center;">理事長<br><div class="receipt-seal-placeholder">${s.chairmanSeal||'理事長'}</div></div>
      </div>
      <script>window.print();</script>
      </body></html>
    `);
    w.document.close();
  }
};

/* ===================== Transaction UI ===================== */
const TransactionUI = {
  modal:null,
  open(id){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('transactionModal'));
    document.getElementById('txForm').reset();
    document.getElementById('txVoucherPreview').innerHTML='';
    document.getElementById('txId').value=id||'';
    const accountSel=document.getElementById('txAccount');
    accountSel.innerHTML=Store.data.accounts.filter(a=>a.active!==false).map(a=>`<option value="${a.name}">${a.name}</option>`).join('');
    // 類別
    this.fillCategories();
    if(id){
      const t=Store.data.transactions.find(x=>x.id===id);
      if(t){
        document.getElementById('txModalTitle').textContent='編輯交易';
        document.getElementById('txDate').value=t.date;
        document.getElementById('txType').value=t.type;
        this.onTypeChange();
        document.getElementById('txAccount').value=t.account||'';
        document.getElementById('txCategory').value=t.category;
        document.getElementById('txAmount').value=t.amount;
        document.getElementById('txCounterparty').value=t.counterparty||'';
        document.getElementById('txDescription').value=t.description||'';
        document.getElementById('txNumber').value= t.type==='收入' ? (t.receiptNumber||'') : (t.voucherNumber||'');
        if(t.vouchers?.length){
          document.getElementById('txVoucherPreview').innerHTML = t.vouchers.map((v,i)=>`<img src="${v.data}" title="${v.name}" data-idx="${i}">`).join('');
        }
      }
    } else {
      document.getElementById('txModalTitle').textContent='新增交易';
      document.getElementById('txDate').value=Util.today();
    }
    this.modal.show();
  },
  fillCategories(){
    const type=document.getElementById('txType').value;
    const catSel=document.getElementById('txCategory');
    let cats=[];
    if(type==='收入') cats=Store.data.settings.categories['收入']||[];
    else if(type==='支出') cats=Store.data.settings.categories['支出']||[];
    catSel.innerHTML='<option value="">請選擇</option>'+cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  },
  onTypeChange(){
    this.fillCategories();
    const type=document.getElementById('txType').value;
    const label=document.getElementById('txNumberLabel');
    if(type==='收入'){
      label.textContent='收據編號';
      if(!document.getElementById('txNumber').value) document.getElementById('txNumber').value=Numbering.receipt();
    } else if(type==='支出'){
      label.textContent='憑證編號';
      if(!document.getElementById('txNumber').value) document.getElementById('txNumber').value=Numbering.voucher();
    } else {
      label.textContent='收據 / 憑證編號';
    }
  },
  handleVoucherUpload(e){
    const files=[...e.target.files];
    const preview=document.getElementById('txVoucherPreview');
    preview.innerHTML='';
    files.forEach(f=>{
      const reader=new FileReader();
      reader.onload=ev=>{
        if(f.type==='application/pdf'){
          preview.innerHTML+=`<div class="d-inline-block border rounded p-1 m-1 small">${f.name}</div>`;
        } else {
          preview.innerHTML+=`<img src="${ev.target.result}" alt="${f.name}" title="${f.name}">`;
        }
      };
      reader.readAsDataURL(f);
    });
  },
  save(){
    const id=document.getElementById('txId').value || Util.uuid();
    const type=document.getElementById('txType').value;
    if(!type){ Util.showToast('error','請選擇類型'); return; }
    const date=document.getElementById('txDate').value;
    const amount=parseFloat(document.getElementById('txAmount').value)||0;
    const obj={
      id,
      date,
      type,
      account:document.getElementById('txAccount').value,
      category:document.getElementById('txCategory').value,
      amount,
      counterparty:document.getElementById('txCounterparty').value.trim(),
      description:document.getElementById('txDescription').value.trim(),
      updatedAt:new Date().toISOString()
    };
    const num=document.getElementById('txNumber').value.trim();
    if(type==='收入') obj.receiptNumber=num;
    else obj.voucherNumber=num;
    // vouchers
    const files=[...document.getElementById('txVouchers').files];
    if(files.length){
      obj.vouchers=[];
      files.forEach(f=>{
        const reader=new FileReader();
        reader.onload=ev=>{
          obj.vouchers.push({name:f.name,type:f.type,data:ev.target.result});
        };
        reader.readAsDataURL(f);
      });
    }
    const idx=Store.data.transactions.findIndex(t=>t.id===id);
    if(idx>-1) Store.data.transactions[idx]={...Store.data.transactions[idx],...obj};
    else {
      obj.createdAt=new Date().toISOString();
      Store.data.transactions.push(obj);
    }
    SyncIndicator.bump();
    Transactions.renderTable();
    Dashboard.refresh();
    Util.showToast('success','已儲存');
    this.modal.hide();
  }
};

/* ===================== Accounts ===================== */
const Accounts = {
  recalcBalances(){
    // 簡單計算：初始 + 所有收入 - 支出
    Store.data.accounts.forEach(a=>{
      const income=Store.data.transactions.filter(t=>t.account===a.name && t.type==='收入').reduce((s,t)=>s+Util.toNumber(t.amount),0);
      const expense=Store.data.transactions.filter(t=>t.account===a.name && t.type==='支出').reduce((s,t)=>s+Util.toNumber(t.amount),0);
      a.currentBalance = Util.toNumber(a.initialBalance||0)+income-expense;
    });
  }
};

/* ===================== Account UI ===================== */
const AccountUI = {
  managerModal:null,
  editModal:null,
  openManager(){
    if(!this.managerModal) this.managerModal=new bootstrap.Modal(document.getElementById('accountManagerModal'));
    this.renderTable();
    this.managerModal.show();
  },
  renderTable(){
    Accounts.recalcBalances();
    const tb=document.getElementById('accountTableBody');
    if(!Store.data.accounts.length){
      tb.innerHTML='<tr><td colspan="6" class="text-center text-muted py-4">尚無帳戶</td></tr>';return;
    }
    tb.innerHTML=Store.data.accounts.map(a=>`
      <tr>
        <td>${a.name}</td>
        <td class="small">${a.description||''}</td>
        <td class="text-end">$${Util.fmtNum(a.initialBalance||0)}</td>
        <td class="text-end fw-semibold ${a.currentBalance>=0?'text-success':'text-danger'}">$${Util.fmtNum(a.currentBalance)}</td>
        <td><span class="badge ${a.active!==false?'bg-success':'bg-secondary'}">${a.active!==false?'啟用':'停用'}</span></td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="AccountUI.openEditor('${a.id}')"><i class="bi bi-pencil"></i></button>
            ${ Store.data.transactions.some(t=>t.account===a.name) ? '' : `<button class="btn btn-outline-danger" onclick="AccountUI.remove('${a.id}')"><i class="bi bi-trash"></i></button>`}
          </div>
        </td>
      </tr>
    `).join('');
  },
  openEditor(id){
    if(!this.editModal) this.editModal=new bootstrap.Modal(document.getElementById('accountEditModal'));
    document.getElementById('accountForm').reset();
    document.getElementById('accountId').value=id||'';
    if(id){
      const a=Store.data.accounts.find(x=>x.id===id);
      if(a){
        document.getElementById('accountEditTitle').textContent='編輯帳戶';
        document.getElementById('accountName').value=a.name;
        document.getElementById('accountDesc').value=a.description||'';
        document.getElementById('accountInitial').value=a.initialBalance||0;
        document.getElementById('accountNotes').value=a.notes||'';
        document.getElementById('accountActive').checked=a.active!==false;
      }
    } else {
      document.getElementById('accountEditTitle').textContent='新增帳戶';
    }
    this.editModal.show();
  },
  save(){
    const id=document.getElementById('accountId').value || Util.uuid();
    const obj={
      id,
      name:document.getElementById('accountName').value.trim(),
      description:document.getElementById('accountDesc').value.trim(),
      initialBalance:Util.toNumber(document.getElementById('accountInitial').value),
      notes:document.getElementById('accountNotes').value.trim(),
      active:document.getElementById('accountActive').checked
    };
    if(!obj.name){ Util.showToast('error','帳戶名稱必填'); return; }
    const idx=Store.data.accounts.findIndex(a=>a.id===id);
    if(idx>-1) Store.data.accounts[idx]={...Store.data.accounts[idx],...obj};
    else Store.data.accounts.push(obj);
    Accounts.recalcBalances();
    this.renderTable();
    Dashboard.refresh();
    SyncIndicator.bump();
    Util.showToast('success','帳戶已儲存');
    this.editModal.hide();
  },
  remove(id){
    Util.confirm({title:'刪除帳戶',text:'確定刪除此帳戶？'}).then(r=>{
      if(!r.isConfirmed) return;
      const idx=Store.data.accounts.findIndex(a=>a.id===id);
      if(idx>-1){
        Store.data.accounts.splice(idx,1);
        this.renderTable();
        Dashboard.refresh();
        SyncIndicator.bump();
        Util.showToast('success','已刪除');
      }
    });
  }
};

/* ===================== Members ===================== */
const Members = {
  state:{page:1,per:10,filtered:[]},
  statusText(s){
    return {active:'正常',inactive:'停權',pending:'待審核'}[s]||s;
  },
  badgeClass(s){
    return {active:'bg-success',inactive:'bg-secondary',pending:'bg-warning'}[s]||'bg-secondary';
  },
  isOverdue(m){
    const feeInterval=365; // 年費
    if(!m.lastPaymentDate) return true;
    const d=new Date(m.lastPaymentDate);
    const now=new Date();
    return (now - d) > feeInterval*24*60*60*1000;
  },
  filter(){
    const status=document.getElementById('memberFilterStatus').value;
    const type=document.getElementById('memberFilterType').value;
    const kw=document.getElementById('memberFilterKeyword').value.trim().toLowerCase();
    this.state.filtered=Store.data.members.filter(m=>{
      if(status && m.status!==status) return false;
      if(type && m.type!==type) return false;
      if(kw){
        const txt=(m.name+' '+(m.phone||'')+' '+(m.email||'')+' '+(m.tags||'')).toLowerCase();
        if(!txt.includes(kw)) return false;
      }
      return true;
    }).sort((a,b)=> b.joinDate.localeCompare(a.joinDate));
  },
  renderTable(){
    this.filter();
    const total=this.state.filtered.length;
    const per=this.state.per;
    const pages=Math.max(1,Math.ceil(total/per));
    if(this.state.page>pages) this.state.page=pages;
    const start=(this.state.page-1)*per;
    const rows=this.state.filtered.slice(start,start+per);
    document.getElementById('memberRecordCount').textContent=`${total} 筆記錄`;
    const tb=document.getElementById('memberTableBody');
    if(!rows.length){
      tb.innerHTML='<tr><td colspan="9" class="text-center text-muted py-5"><i class="bi bi-people display-6 d-block mb-2"></i> 無符合資料</td></tr>';
    } else {
      tb.innerHTML=rows.map(m=>{
        const overdue=this.isOverdue(m);
        return `<tr>
          <td><input type="checkbox" class="member-check" data-id="${m.id}"></td>
          <td>
            <div class="d-flex align-items-center">
              <div class="member-avatar me-2 small-avatar"><i class="bi bi-person"></i></div>
              <div>
                <div class="fw-semibold">${m.name}</div>
                <div class="text-muted small">${m.idNumber||''}</div>
              </div>
            </div>
          </td>
          <td class="small">${m.phone||''}<br>${m.email||''}</td>
          <td>${m.birthDate? Util.age(m.birthDate)+'歲':''}/${m.gender||''}</td>
          <td>${m.joinDate||''}</td>
          <td><span class="badge ${this.badgeClass(m.status)}">${this.statusText(m.status)}</span></td>
          <td>${overdue?'<span class="badge bg-danger">逾期</span>':'<span class="badge bg-success">正常</span>'}</td>
          <td class="small">${(m.tags||'').split(',').filter(Boolean).map(t=>`<span class="badge bg-info text-dark me-1">${t}</span>`).join('')}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="Members.detail('${m.id}')"><i class="bi bi-eye"></i></button>
              <button class="btn btn-outline-success" onclick="MemberUI.open('${m.id}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-outline-danger" onclick="Members.remove('${m.id}')"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        </tr>`;
      }).join('');
    }
    this.renderPagination(pages);
    // 更新統計
    document.getElementById('mStatTotal').textContent=Store.data.members.length;
    document.getElementById('mStatActive').textContent=Store.data.members.filter(m=>m.status==='active').length;
    document.getElementById('mStatOverdue').textContent=Store.data.members.filter(m=>this.isOverdue(m)).length;
    const nowMonth=new Date().toISOString().slice(0,7);
    document.getElementById('mStatNew').textContent=Store.data.members.filter(m=> (m.joinDate||'').startsWith(nowMonth)).length;
  },
  renderPagination(pages){
    const ul=document.getElementById('memberPagination');
    let h='';
    for(let i=1;i<=pages;i++){
      h+=`<li class="page-item ${i===this.state.page?'active':''}"><a href="#" class="page-link" onclick="Members.goto(${i});return false;">${i}</a></li>`;
    }
    ul.innerHTML=h;
  },
  goto(p){ this.state.page=p; this.renderTable(); },
  toggleSelectAll(el){
    document.querySelectorAll('#memberTableBody .member-check').forEach(c=>c.checked=el.checked);
  },
  getSelected(){ return [...document.querySelectorAll('#memberTableBody .member-check:checked')].map(c=>c.dataset.id); },
  batchAction(){
    const action=document.getElementById('memberBatchAction').value;
    if(!action){ Util.showToast('error','請選擇操作'); return; }
    const ids=this.getSelected();
    if(!ids.length){ Util.showToast('error','未勾選'); return; }
    if(action==='delete'){
      Util.confirm({title:'刪除會員',text:`確定刪除 ${ids.length} 筆？`}).then(r=>{
        if(!r.isConfirmed) return;
        ids.forEach(id=>{
          const idx=Store.data.members.findIndex(m=>m.id===id);
          if(idx>-1) Store.data.members.splice(idx,1);
        });
        SyncIndicator.bump();
        this.renderTable();
        Dashboard.refresh();
        Util.showToast('success','已刪除');
      });
    } else if(action.startsWith('status-')){
      const st=action.split('-')[1];
      ids.forEach(id=>{
        const m=Store.data.members.find(mm=>mm.id===id);
        if(m) m.status=st==='active'?'active':'inactive';
      });
      SyncIndicator.bump();
      this.renderTable();
      Util.showToast('success','已更新狀態');
    } else if(action==='export'){
      const rows=Store.data.members.filter(m=>ids.includes(m.id));
      const csv=['id,name,phone,email,gender,birthDate,joinDate,status,type,lastPaymentDate,tags'].concat(
        rows.map(m=>[
          m.id,m.name,m.phone||'',m.email||'',m.gender||'',m.birthDate||'',m.joinDate||'',m.status||'',m.type||'',m.lastPaymentDate||'',(m.tags||'').replace(/,/g,';')
        ].join(','))
      ).join('\n');
      Util.downloadBlob('members_selected.csv',csv,'text/csv');
      Util.showToast('success','已匯出');
    }
    document.getElementById('memberBatchAction').value='';
  },
  detail(id){
    const m=Store.data.members.find(x=>x.id===id);
    if(!m) return;
    const box=document.getElementById('memberDetailContent');
    const overdue=this.isOverdue(m);
    box.innerHTML=`
      <div class="row g-3">
        <div class="col-md-4">
          <h6 class="fw-semibold">基本資料</h6>
          <div>姓名：${m.name}</div>
          <div>電話：${m.phone||''}</div>
          <div>Email：${m.email||''}</div>
          <div>性別：${m.gender||''}</div>
          <div>生日：${m.birthDate||''} (${m.birthDate?Util.age(m.birthDate)+'歲':''})</div>
          <div>加入：${m.joinDate||''}</div>
          <div>狀態：<span class="badge ${this.badgeClass(m.status)}">${this.statusText(m.status)}</span></div>
          <div>身份證：${m.idNumber||''}</div>
        </div>
        <div class="col-md-4">
          <h6 class="fw-semibold">聯絡/其他</h6>
          <div>地址：${m.address||''}</div>
          <div>緊急聯絡人：${m.emergencyContact||''}</div>
            <div>緊急電話：${m.emergencyPhone||''}</div>
          <div>備註：<div class="small">${(m.notes||'').replace(/\n/g,'<br>')}</div></div>
        </div>
        <div class="col-md-4">
          <h6 class="fw-semibold">會籍</h6>
          <div>類型：${m.type||''}</div>
          <div>年費：$${Util.fmtNum(m.membershipFee||Store.data.settings.defaultMembershipFee||0)}</div>
          <div>最後繳費：${m.lastPaymentDate||''} ${overdue?'<span class="badge bg-danger ms-1">逾期</span>':''}</div>
          <div>標籤：${(m.tags||'').split(',').filter(Boolean).map(t=>`<span class="badge bg-info text-dark me-1">${t}</span>`).join('')}</div>
        </div>
      </div>
    `;
    if(!this.detailModal) this.detailModal=new bootstrap.Modal(document.getElementById('memberDetailModal'));
    this.detailModal.show();
    // 暫存目前查看對象以便 detail -> edit
    this.currentDetailId=id;
  },
  remove(id){
    Util.confirm({title:'刪除會員',text:'確定刪除？'}).then(r=>{
      if(!r.isConfirmed) return;
      const idx=Store.data.members.findIndex(m=>m.id===id);
      if(idx>-1){
        Store.data.members.splice(idx,1);
        SyncIndicator.bump();
        this.renderTable();
        Dashboard.refresh();
        Util.showToast('success','已刪除');
      }
    });
  },
  recordFee(){
    if(!this.currentDetailId) return;
    const m=Store.data.members.find(x=>x.id===this.currentDetailId);
    if(!m) return;
    m.lastPaymentDate=Util.today();
    SyncIndicator.bump();
    this.detail(this.currentDetailId);
    this.renderTable();
    Dashboard.refresh();
    Util.showToast('success','已紀錄繳費');
  },
  printCard(){
    if(!this.currentDetailId) return;
    const m=Store.data.members.find(x=>x.id===this.currentDetailId);
    if(!m) return;
    const s=Store.data.settings;
    const w=window.open('','_blank','width=480');
    w.document.write(`
      <html><head><title>會員卡-${m.name}</title>
      <style>
        body{font-family:"Microsoft JhengHei",sans-serif;padding:0;margin:0;}
        .card{width:340px;height:200px;border:2px solid #2c5aa0;border-radius:10px;padding:16px;position:relative;margin:12px auto;}
        h3{margin:0 0 10px;font-size:20px;color:#2c5aa0;}
        .line{font-size:14px;margin:2px 0;}
        .logo{position:absolute;right:12px;top:12px;font-size:12px;color:#2c5aa0;}
      </style></head><body>
        <div class="card">
          <div class="logo">${s.organizationName||''}</div>
          <h3>會員卡</h3>
          <div class="line">姓名：${m.name}</div>
          <div class="line">電話：${m.phone||''}</div>
          <div class="line">加入：${m.joinDate||''}</div>
          <div class="line">類型：${m.type||''}</div>
          <div class="line">狀態：${this.statusText(m.status)}</div>
          <div class="line">編號：${m.id}</div>
        </div>
        <script>window.print();</script>
      </body></html>
    `);
    w.document.close();
  }
};

/* ===================== Member UI ===================== */
const MemberUI = {
  modal:null,
  open(id){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('memberModal'));
    document.getElementById('memberForm').reset();
    document.getElementById('memberId').value=id||'';
    if(id){
      const m=Store.data.members.find(x=>x.id===id);
      if(m){
        document.getElementById('memberModalTitle').textContent='編輯會員';
        document.getElementById('memberName').value=m.name;
        document.getElementById('memberPhone').value=m.phone||'';
        document.getElementById('memberEmail').value=m.email||'';
        document.getElementById('memberBirthDate').value=m.birthDate||'';
        document.getElementById('memberGender').value=m.gender||'';
        document.getElementById('memberIdNumber').value=m.idNumber||'';
        document.getElementById('memberAddress').value=m.address||'';
        document.getElementById('emergencyContact').value=m.emergencyContact||'';
        document.getElementById('emergencyPhone').value=m.emergencyPhone||'';
        document.getElementById('memberNotes').value=m.notes||'';
        document.getElementById('memberJoinDate').value=m.joinDate||'';
        document.getElementById('memberStatus').value=m.status||'active';
        document.getElementById('memberType').value=m.type||'regular';
        document.getElementById('membershipFee').value=m.membershipFee||Store.data.settings.defaultMembershipFee||1000;
        document.getElementById('lastPaymentDate').value=m.lastPaymentDate||'';
        document.getElementById('memberTags').value=m.tags||'';
      }
    } else {
      document.getElementById('memberModalTitle').textContent='新增會員';
      document.getElementById('memberJoinDate').value=Util.today();
      document.getElementById('membershipFee').value=Store.data.settings.defaultMembershipFee||1000;
    }
    this.modal.show();
  },
  save(){
    const id=document.getElementById('memberId').value || Util.uuid();
    const obj={
      id,
      name:document.getElementById('memberName').value.trim(),
      phone:document.getElementById('memberPhone').value.trim(),
      email:document.getElementById('memberEmail').value.trim(),
      birthDate:document.getElementById('memberBirthDate').value,
      gender:document.getElementById('memberGender').value,
      idNumber:document.getElementById('memberIdNumber').value.trim(),
      address:document.getElementById('memberAddress').value.trim(),
      emergencyContact:document.getElementById('emergencyContact').value.trim(),
      emergencyPhone:document.getElementById('emergencyPhone').value.trim(),
      notes:document.getElementById('memberNotes').value.trim(),
      joinDate:document.getElementById('memberJoinDate').value,
      status:document.getElementById('memberStatus').value,
      type:document.getElementById('memberType').value,
      membershipFee:Util.toNumber(document.getElementById('membershipFee').value),
      lastPaymentDate:document.getElementById('lastPaymentDate').value,
      tags:document.getElementById('memberTags').value.trim()
    };
    if(!obj.name || !obj.phone){ Util.showToast('error','姓名與電話必填'); return; }
    const idx=Store.data.members.findIndex(m=>m.id===id);
    if(idx>-1) Store.data.members[idx]={...Store.data.members[idx],...obj};
    else {
      obj.createdAt=new Date().toISOString();
      Store.data.members.push(obj);
    }
    SyncIndicator.bump();
    Members.renderTable();
    Dashboard.refresh();
    Util.showToast('success','已儲存');
    this.modal.hide();
  },
  editFromDetail(){
    if(!Members.currentDetailId) return;
    this.open(Members.currentDetailId);
  }
};

/* ===================== Activities ===================== */
const Activities = {
  state:{page:1,per:8,filtered:[]},
  statusText(s){
    return {draft:'草稿',published:'已發布',registration:'報名中',full:'已額滿',closed:'已結束',cancelled:'已取消'}[s]||s;
  },
  statusBadge(s){
    return {
      draft:'bg-secondary',
      published:'bg-primary',
      registration:'bg-success',
      full:'bg-warning',
      closed:'bg-dark',
      cancelled:'bg-danger'
    }[s]||'bg-secondary';
  },
  filter(){
    const status=document.getElementById('actFilterStatus').value;
    const type=document.getElementById('actFilterType').value;
    const kw=document.getElementById('actFilterKeyword').value.trim().toLowerCase();
    const sort=document.getElementById('actFilterSort').value;
    this.state.filtered=Store.data.activities.filter(a=>{
      if(status && a.status!==status) return false;
      if(type && a.type!==type) return false;
      if(kw){
        const txt=(a.name+' '+(a.location||'')+' '+(a.description||'')).toLowerCase();
        if(!txt.includes(kw)) return false;
      }
      return true;
    });
    switch(sort){
      case 'date_desc': this.state.filtered.sort((a,b)=> b.date.localeCompare(a.date)); break;
      case 'date_asc': this.state.filtered.sort((a,b)=> a.date.localeCompare(b.date)); break;
      case 'name_asc': this.state.filtered.sort((a,b)=> a.name.localeCompare(b.name)); break;
      case 'regs_desc':
        this.state.filtered.sort((a,b)=> (this.regCount(b.id)-this.regCount(a.id)));
        break;
    }
  },
  regCount(id){
    return Store.data.registrations.filter(r=>r.activityId===id).length;
  },
  renderGrid(){
    this.filter();
    const total=this.state.filtered.length;
    const per=this.state.per;
    const pages=Math.max(1,Math.ceil(total/per));
    if(this.state.page>pages) this.state.page=pages;
    const start=(this.state.page-1)*per;
    const list=this.state.filtered.slice(start,start+per);
    document.getElementById('actRecordCount').textContent=`${total} 活動`;
    const grid=document.getElementById('activitiesGrid');
    if(!list.length){
      grid.innerHTML='<div class="col-12 text-center py-5 text-muted"><i class="bi bi-calendar-event display-6 d-block mb-2"></i> 無符合活動</div>';
    } else {
      grid.innerHTML=list.map(a=>{
        const regs=this.regCount(a.id);
        const percent=a.max?(Math.min(100,Math.round(regs/a.max*100))):0;
        return `<div class="col-md-6 col-lg-3">
          <div class="activity-card bg-white h-100">
            ${a.imageData? `<img src="${a.imageData}" class="w-100" style="height:120px;object-fit:cover;">` : `<div class="bg-light d-flex align-items-center justify-content-center" style="height:120px;"><i class="bi bi-image text-muted fs-1"></i></div>`}
            <div class="p-2">
              <div class="d-flex justify-content-between align-items-start">
                <h6 class="mb-1">${a.name}</h6>
                <span class="badge ${this.statusBadge(a.status)}">${this.statusText(a.status)}</span>
              </div>
              <div class="small text-muted mb-1"><i class="bi bi-calendar-event"></i> ${a.date}</div>
              <div class="small mb-1">${a.location||''}</div>
              <div class="progress mb-2">
                <div class="progress-bar" style="width:${percent}%"></div>
              </div>
              <div class="d-flex justify-content-between small">
                <span>報名：${regs}/${a.max||'-'}</span>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary" onclick="Activities.detail('${a.id}')"><i class="bi bi-eye"></i></button>
                  <button class="btn btn-outline-success" onclick="ActivityUI.open('${a.id}')"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-outline-danger" onclick="Activities.remove('${a.id}')"><i class="bi bi-trash"></i></button>
                </div>
              </div>
            </div>
          </div>
        </div>`;
      }).join('');
    }
    this.renderPagination(pages);
  },
  renderPagination(pages){
    const ul=document.getElementById('actPagination');
    let h='';
    for(let i=1;i<=pages;i++){
      h+=`<li class="page-item ${i===this.state.page?'active':''}">
        <a href="#" class="page-link" onclick="Activities.goto(${i});return false;">${i}</a>
      </li>`;
    }
    ul.innerHTML=h;
  },
  goto(p){ this.state.page=p; this.renderGrid(); },
  detail(id){
    const a=Store.data.activities.find(x=>x.id===id);
    if(!a) return;
    const regs=Store.data.registrations.filter(r=>r.activityId===id);
    const box=document.getElementById('activityDetailContent');
    box.innerHTML=`
      <h5 class="fw-semibold">${a.name}</h5>
      <div class="small text-muted mb-2">${a.type||''} | ${this.statusText(a.status)} | 日期：${a.date} ${a.time||''}</div>
      <div class="mb-2">${a.description? a.description.replace(/\n/g,'<br>') : ''}</div>
      <div class="mb-2">地點：${a.location||''}</div>
      <div class="mb-2">報名期間：${a.regStartDate||''} ~ ${a.regEndDate||''}</div>
      <div class="mb-2">人數上限：${a.max||'-'} | 已報名：${regs.length}</div>
      <div class="mb-3">聯絡：${a.contact||''} ${a.contactPhone||''}</div>
      <h6 class="fw-semibold">報名名單 (${regs.length})</h6>
      <div class="border rounded p-2" style="max-height:200px;overflow:auto;">
        ${
          regs.length
            ? regs.map(r=>`<div class="d-flex align-items-center border-bottom py-1 small">
                <div class="participant-avatar me-2 small-avatar"><i class="bi bi-person"></i></div>
                <div class="flex-grow-1">
                  <div class="fw-semibold">${r.memberName||r.name}</div>
                  <div class="text-muted">${r.phone||''}</div>
                </div>
                <div class="small">${r.createdAt? r.createdAt.slice(0,10):''}</div>
              </div>`).join('')
            : '<div class="text-muted small">尚無報名</div>'
        }
      </div>
    `;
    if(!this.detailModal) this.detailModal=new bootstrap.Modal(document.getElementById('activityDetailModal'));
    this.detailModal.show();
    // 可報名判斷
    const btn=document.getElementById('activityRegisterBtn');
    const now=Util.today();
    const inRange = (!a.regStartDate || a.regStartDate<=now) && (!a.regEndDate || a.regEndDate>=now);
    const notFull = !a.max || regs.length < a.max;
    if(a.status==='registration' && inRange && notFull){
      btn.style.display='inline-block';
      RegistrationUI.currentActivityId=id;
    } else {
      btn.style.display='none';
    }
    this.currentDetailId=id;
  },
  remove(id){
    Util.confirm({title:'刪除活動',text:'確定刪除？'}).then(r=>{
      if(!r.isConfirmed) return;
      const idx=Store.data.activities.findIndex(a=>a.id===id);
      if(idx>-1){
        Store.data.activities.splice(idx,1);
        SyncIndicator.bump();
        this.renderGrid();
        Dashboard.refresh();
        Util.showToast('success','已刪除');
      }
    });
  }
};

/* ===================== Activity UI ===================== */
const ActivityUI = {
  modal:null,
  open(id){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('activityModal'));
    document.getElementById('activityForm').reset();
    document.getElementById('activityId').value=id||'';
    document.getElementById('activityImagePreview').innerHTML='';
    if(id){
      const a=Store.data.activities.find(x=>x.id===id);
      if(a){
        document.getElementById('activityModalTitle').textContent='編輯活動';
        document.getElementById('activityName').value=a.name;
        document.getElementById('activityType').value=a.type||'';
        document.getElementById('activityStatus').value=a.status||'draft';
        document.getElementById('activityDate').value=a.date||'';
        document.getElementById('activityTime').value=a.time||'';
        document.getElementById('regStartDate').value=a.regStartDate||'';
        document.getElementById('regEndDate').value=a.regEndDate||'';
        document.getElementById('activityLocation').value=a.location||'';
        document.getElementById('activityDescription').value=a.description||'';
        document.getElementById('activityMax').value=a.max||50;
        document.getElementById('activityFee').value=a.fee||0;
        document.getElementById('activityContact').value=a.contact||'';
        document.getElementById('activityContactPhone').value=a.contactPhone||'';
        document.getElementById('activityNotes').value=a.notes||'';
        if(a.imageData){
          document.getElementById('activityImagePreview').innerHTML=`<img src="${a.imageData}" class="img-fluid rounded">`;
        }
      }
    } else {
      document.getElementById('activityModalTitle').textContent='新增活動';
      document.getElementById('activityDate').value=Util.today();
    }
    this.modal.show();
  },
  previewImage(e){
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=ev=>{
      document.getElementById('activityImagePreview').innerHTML=`<img src="${ev.target.result}" class="img-fluid rounded">`;
    };
    reader.readAsDataURL(file);
  },
  save(){
    const id=document.getElementById('activityId').value || Util.uuid();
    const obj={
      id,
      name:document.getElementById('activityName').value.trim(),
      type:document.getElementById('activityType').value,
      status:document.getElementById('activityStatus').value,
      date:document.getElementById('activityDate').value,
      time:document.getElementById('activityTime').value,
      regStartDate:document.getElementById('regStartDate').value,
      regEndDate:document.getElementById('regEndDate').value,
      location:document.getElementById('activityLocation').value.trim(),
      description:document.getElementById('activityDescription').value.trim(),
      max:Util.toNumber(document.getElementById('activityMax').value),
      fee:Util.toNumber(document.getElementById('activityFee').value),
      contact:document.getElementById('activityContact').value.trim(),
      contactPhone:document.getElementById('activityContactPhone').value.trim(),
      notes:document.getElementById('activityNotes').value.trim()
    };
    if(!obj.name || !obj.type || !obj.date){ Util.showToast('error','必填欄位未填'); return; }
    const file=document.getElementById('activityImage').files[0];
    if(file){
      const reader=new FileReader();
      reader.onload=ev=>{
        obj.imageData=ev.target.result;
        this._saveObj(obj);
      };
      reader.readAsDataURL(file);
    } else {
      const old=Store.data.activities.find(a=>a.id===id);
      if(old && old.imageData && !file) obj.imageData=old.imageData;
      this._saveObj(obj);
    }
  },
  _saveObj(obj){
    const idx=Store.data.activities.findIndex(a=>a.id===obj.id);
    if(idx>-1) Store.data.activities[idx]={...Store.data.activities[idx],...obj};
    else {
      obj.createdAt=new Date().toISOString();
      Store.data.activities.push(obj);
    }
    SyncIndicator.bump();
    Activities.renderGrid();
    Dashboard.refresh();
    Util.showToast('success','活動已儲存');
    this.modal.hide();
  },
  editFromDetail(){
    if(!Activities.currentDetailId) return;
    this.open(Activities.currentDetailId);
  }
};

/* ===================== Registration UI ===================== */
const RegistrationUI = {
  modal:null,
  currentActivityId:null,
  openRegister(){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('registrationModal'));
    if(!this.currentActivityId) return;
    const a=Store.data.activities.find(x=>x.id===this.currentActivityId);
    if(!a) return;
    const info=document.getElementById('registrationActivityInfo');
    info.innerHTML=`活動：<strong>${a.name}</strong> | 日期：${a.date} | 已報名 ${Activities.regCount(a.id)} / ${a.max||'-'}`;
    // 會員選單
    const sel=document.getElementById('regMemberSelect');
    sel.innerHTML='<option value="">選擇會員</option>'+Store.data.members.map(m=>`<option value="${m.id}">${m.name} (${m.phone||''})</option>`).join('');
    document.getElementById('registrationActivityId').value=this.currentActivityId;
    document.getElementById('registrationForm').reset();
    document.getElementById('regExisting').checked=true;
    this.toggleMode();
    this.modal.show();
  },
  toggleMode(){
    const existing=document.getElementById('regExisting').checked;
    document.getElementById('regExistingBox').style.display=existing?'block':'none';
    document.getElementById('regNewBox').style.display=existing?'none':'block';
  },
  submit(){
    const activityId=document.getElementById('registrationActivityId').value;
    const existing=document.getElementById('regExisting').checked;
    const agree=document.getElementById('regAgree').checked;
    if(!agree){ Util.showToast('error','請勾選同意條款'); return; }
    let obj={
      id:Util.uuid(),
      activityId,
      createdAt:new Date().toISOString(),
      notes:document.getElementById('regNotes').value.trim()
    };
    if(existing){
      const memberId=document.getElementById('regMemberSelect').value;
      if(!memberId){ Util.showToast('error','請選擇會員'); return; }
      const m=Store.data.members.find(x=>x.id===memberId);
      obj.memberId=memberId;
      obj.memberName=m?.name||'';
      obj.phone=m?.phone||'';
    } else {
      const name=document.getElementById('regName').value.trim();
      const phone=document.getElementById('regPhone').value.trim();
      if(!name||!phone){ Util.showToast('error','姓名電話必填'); return; }
      obj.name=name;
      obj.phone=phone;
      obj.email=document.getElementById('regEmail').value.trim();
      obj.emergency=document.getElementById('regEmergency').value.trim();
    }
    Store.data.registrations.push(obj);
    SyncIndicator.bump();
    Util.showToast('success','報名成功');
    this.modal.hide();
    // 若正在顯示詳情，更新
    if(Activities.currentDetailId===activityId){
      Activities.detail(activityId);
      Activities.renderGrid();
    }
  }
};

/* ===================== Announcements ===================== */
const Announcements = {
  state:{page:1,per:8,filtered:[]},
  filter(){
    const status=document.getElementById('annFilterStatus').value;
    const type=document.getElementById('annFilterType').value;
    const kw=document.getElementById('annFilterKeyword').value.trim().toLowerCase();
    const today=Util.today();
    this.state.filtered=Store.data.announcements.filter(a=>{
      if(status){
        if(status==='expired'){
          if(!a.expireDate || a.expireDate>=today) return false;
        } else if(a.status!==status) return false;
      }
      if(type && a.type!==type) return false;
      if(kw){
        const txt=(a.title+' '+(a.content||'')).toLowerCase();
        if(!txt.includes(kw)) return false;
      }
      return true;
    }).sort((a,b)=> (b.pinned?1:0)-(a.pinned?1:0) || (b.publishDate||'').localeCompare(a.publishDate||''));
  },
  render(){
    this.filter();
    const total=this.state.filtered.length;
    const per=this.state.per;
    const pages=Math.max(1,Math.ceil(total/per));
    if(this.state.page>pages) this.state.page=pages;
    const start=(this.state.page-1)*per;
    const list=this.state.filtered.slice(start,start+per);
    const grid=document.getElementById('announcementsGrid');
    if(!list.length){
      grid.innerHTML='<div class="col-12 text-center py-5 text-muted"><i class="bi bi-megaphone display-6 d-block mb-2"></i> 無符合公告</div>';
    } else {
      grid.innerHTML=list.map(a=>{
        const expired = a.expireDate && a.expireDate < Util.today();
        return `<div class="col-md-6 col-lg-3">
          <div class="announcement-card p-3 h-100 ${a.type==='urgent'?'urgent':''}">
            <div class="d-flex justify-content-between">
              <h6 class="mb-1">${a.title}</h6>
              <div>
                ${a.pinned?'<i class="bi bi-pin-angle-fill text-danger" title="置頂"></i>':''}
                <span class="badge ${a.type==='urgent'?'bg-danger':'bg-warning text-dark'}">${a.type==='urgent'?'緊急':'公告'}</span>
              </div>
            </div>
            <div class="small text-muted mb-2">${a.publishDate||''}${expired?'<span class="badge bg-secondary ms-1">已過期</span>':''}</div>
            <div class="small mb-2" style="max-height:70px;overflow:hidden;">${(a.content||'').replace(/\n/g,'<br>')}</div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="small">${a.link? `<a href="${a.link}" target="_blank">連結</a>`:''}</div>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="AnnouncementUI.open('${a.id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-outline-danger" onclick="Announcements.remove('${a.id}')"><i class="bi bi-trash"></i></button>
              </div>
            </div>
          </div>
        </div>`;
      }).join('');
    }
    this.renderPagination(pages);
    // 統計
    document.getElementById('annStatTotal').textContent=Store.data.announcements.length;
    document.getElementById('annStatActive').textContent=Store.data.announcements.filter(a=>a.status==='published').length;
    document.getElementById('annStatUrgent').textContent=Store.data.announcements.filter(a=>a.type==='urgent').length;
  },
  renderPagination(pages){
    const ul=document.getElementById('annPagination');
    let h='';
    for(let i=1;i<=pages;i++){
      h+=`<li class="page-item ${i===this.state.page?'active':''}">
        <a href="#" class="page-link" onclick="Announcements.goto(${i});return false;">${i}</a>
      </li>`;
    }
    ul.innerHTML=h;
  },
  goto(p){ this.state.page=p; this.render(); },
  remove(id){
    Util.confirm({title:'刪除公告',text:'確定刪除？'}).then(r=>{
      if(!r.isConfirmed) return;
      const idx=Store.data.announcements.findIndex(a=>a.id===id);
      if(idx>-1){
        Store.data.announcements.splice(idx,1);
        SyncIndicator.bump();
        this.render();
        Util.showToast('success','已刪除');
      }
    });
  }
};

/* ===================== Announcement UI ===================== */
const AnnouncementUI = {
  modal:null,
  open(id){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('announcementModal'));
    document.getElementById('announcementForm').reset();
    document.getElementById('announcementId').value=id||'';
    if(id){
      const a=Store.data.announcements.find(x=>x.id===id);
      if(a){
        document.getElementById('announcementModalTitle').textContent='編輯公告';
        document.getElementById('announcementTitle').value=a.title;
        document.getElementById('announcementType').value=a.type||'normal';
        document.getElementById('announcementStatus').value=a.status||'draft';
        document.getElementById('announcementPinned').checked=!!a.pinned;
        document.getElementById('announcementPublishDate').value=a.publishDate||'';
        document.getElementById('announcementExpireDate').value=a.expireDate||'';
        document.getElementById('announcementContent').value=a.content||'';
        document.getElementById('announcementLink').value=a.link||'';
      }
    } else {
      document.getElementById('announcementModalTitle').textContent='新增公告';
      document.getElementById('announcementPublishDate').value=Util.today();
    }
    this.modal.show();
  },
  save(){
    const id=document.getElementById('announcementId').value || Util.uuid();
    const obj={
      id,
      title:document.getElementById('announcementTitle').value.trim(),
      type:document.getElementById('announcementType').value,
      status:document.getElementById('announcementStatus').value,
      pinned:document.getElementById('announcementPinned').checked,
      publishDate:document.getElementById('announcementPublishDate').value,
      expireDate:document.getElementById('announcementExpireDate').value,
      content:document.getElementById('announcementContent').value.trim(),
      link:document.getElementById('announcementLink').value.trim()
    };
    if(!obj.title || !obj.content){ Util.showToast('error','標題/內容必填'); return; }
    const idx=Store.data.announcements.findIndex(a=>a.id===id);
    if(idx>-1) Store.data.announcements[idx]={...Store.data.announcements[idx],...obj};
    else {
      obj.createdAt=new Date().toISOString();
      Store.data.announcements.push(obj);
    }
    SyncIndicator.bump();
    Announcements.render();
    Util.showToast('success','公告已儲存');
    this.modal.hide();
  }
};

/* ===================== Forms ===================== */
const Forms = {
  filter(){
    const kw=document.getElementById('formFilterKeyword').value.trim().toLowerCase();
    const cat=document.getElementById('formFilterCategory').value;
    return Store.data.forms.filter(f=>{
      if(cat && f.category!==cat) return false;
      if(kw){
        const txt=(f.name+' '+(f.keywords||'')).toLowerCase();
        if(!txt.includes(kw)) return false;
      }
      return true;
    }).sort((a,b)=> (b.active?1:0)-(a.active?1:0) || a.name.localeCompare(b.name));
  },
  render(){
    const list=this.filter();
    const box=document.getElementById('formsList');
    if(!list.length){
      box.innerHTML='<div class="col-12 text-center py-5 text-muted"><i class="bi bi-file-earmark-arrow-down display-6 d-block mb-2"></i> 無符合表單</div>';return;
    }
    box.innerHTML=list.map(f=>`
      <div class="col-md-4 col-lg-3">
        <div class="border rounded p-2 h-100 bg-white d-flex flex-column">
          <div class="d-flex justify-content-between">
            <h6 class="mb-1">${f.name}</h6>
            <span class="badge ${f.active!==false?'bg-success':'bg-secondary'}">${f.active!==false?'啟用':'停用'}</span>
          </div>
          <div class="small text-muted mb-1">${f.category}</div>
          <div class="small flex-grow-1">${(f.description||'').slice(0,60)}</div>
          <div class="mt-2 d-flex justify-content-between align-items-center">
            <a href="${f.url}" target="_blank" class="small">下載</a>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="FormUI.open('${f.id}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-outline-danger" onclick="Forms.remove('${f.id}')"><i class="bi bi-trash"></i></button>
            </div>
          </div>
        </div>
      </div>
    `).join('');
  },
  remove(id){
    Util.confirm({title:'刪除表單',text:'確定刪除？'}).then(r=>{
      if(!r.isConfirmed) return;
      const idx=Store.data.forms.findIndex(f=>f.id===id);
      if(idx>-1){
        Store.data.forms.splice(idx,1);
        SyncIndicator.bump();
        this.render();
        Util.showToast('success','已刪除');
      }
    });
  }
};

/* ===================== Form UI ===================== */
const FormUI = {
  modal:null,
  openManager(){
    if(!this.managerModal) this.managerModal=new bootstrap.Modal(document.getElementById('formManagerModal'));
    this.renderTable();
    this.managerModal.show();
  },
  renderTable(){
    const tb=document.getElementById('formTableBody');
    if(!Store.data.forms.length){
      tb.innerHTML='<tr><td colspan="6" class="text-center text-muted py-4">尚無表單</td></tr>';return;
    }
    tb.innerHTML=Store.data.forms.map(f=>`
      <tr>
        <td>${f.name}</td>
        <td>${f.category}</td>
        <td class="small"><a href="${f.url}" target="_blank">連結</a></td>
        <td class="small">${f.keywords||''}</td>
        <td><span class="badge ${f.active!==false?'bg-success':'bg-secondary'}">${f.active!==false?'啟用':'停用'}</span></td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="FormUI.open('${f.id}')"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-outline-danger" onclick="Forms.remove('${f.id}')"><i class="bi bi-trash"></i></button>
          </div>
        </td>
      </tr>
    `).join('');
  },
  open(id){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('formEditModal'));
    document.getElementById('formEditForm').reset();
    document.getElementById('formId').value=id||'';
    if(id){
      const f=Store.data.forms.find(x=>x.id===id);
      if(f){
        document.getElementById('formEditTitle').textContent='編輯表單';
        document.getElementById('formName').value=f.name;
        document.getElementById('formCategory').value=f.category;
        document.getElementById('formUrl').value=f.url;
        document.getElementById('formKeywords').value=f.keywords||'';
        document.getElementById('formDescription').value=f.description||'';
        document.getElementById('formActive').checked=f.active!==false;
      }
    } else {
      document.getElementById('formEditTitle').textContent='新增表單';
    }
    this.modal.show();
  },
  save(){
    const id=document.getElementById('formId').value || Util.uuid();
    const obj={
      id,
      name:document.getElementById('formName').value.trim(),
      category:document.getElementById('formCategory').value,
      url:document.getElementById('formUrl').value.trim(),
      keywords:document.getElementById('formKeywords').value.trim(),
      description:document.getElementById('formDescription').value.trim(),
      active:document.getElementById('formActive').checked
    };
    if(!obj.name || !obj.category || !obj.url){ Util.showToast('error','必填欄位未填'); return; }
    const idx=Store.data.forms.findIndex(f=>f.id===id);
    if(idx>-1) Store.data.forms[idx]={...Store.data.forms[idx],...obj};
    else Store.data.forms.push(obj);
    SyncIndicator.bump();
    Forms.render();
    if(this.managerModal?._isShown) this.renderTable();
    Util.showToast('success','表單已儲存');
    this.modal.hide();
  }
};

/* ===================== Analytics ===================== */
const Analytics = {
  charts:{},
  refresh(){
    // 年份篩選
    const sel=document.getElementById('analyticsYear');
    if(sel && sel.options.length===1){
      const years=[...new Set(Store.data.transactions.map(t=> (t.date||'').slice(0,4)).filter(Boolean))].sort().reverse();
      years.forEach(y=>{
        const opt=document.createElement('option');opt.value=y;opt.textContent=y; sel.appendChild(opt);
      });
    }
    const year=sel.value;
    const filtered = year ? Store.data.transactions.filter(t=>t.date.startsWith(year+'-')) : Store.data.transactions;
    let totalIncome=0,totalExpense=0;
    filtered.forEach(t=>{
      const amt=Util.toNumber(t.amount);
      if(t.type==='收入') totalIncome+=amt; else totalExpense+=amt;
    });
    const months=Array.from({length:12},(_,i)=>i+1);
    const monthIncome=months.map(m=>{
      const prefix=(year||new Date().getFullYear())+'-'+Util.pad(m);
      return filtered.filter(t=>t.type==='收入' && t.date.startsWith(prefix)).reduce((s,t)=>s+Util.toNumber(t.amount),0);
    });
    const monthExpense=months.map(m=>{
      const prefix=(year||new Date().getFullYear())+'-'+Util.pad(m);
      return filtered.filter(t=>t.type==='支出' && t.date.startsWith(prefix)).reduce((s,t)=>s+Util.toNumber(t.amount),0);
    });
    const balance=totalIncome-totalExpense;
    const avg=(totalIncome+totalExpense)? Math.round(balance / (months.filter((_,i)=> monthIncome[i]||monthExpense[i]).length||1)) : 0;
    document.getElementById('anaTotalIncome').textContent='$'+Util.fmtNum(totalIncome);
    document.getElementById('anaTotalExpense').textContent='$'+Util.fmtNum(totalExpense);
    document.getElementById('anaBalance').textContent='$'+Util.fmtNum(balance);
    document.getElementById('anaAvgMonthly').textContent='$'+Util.fmtNum(avg);

    // 收支趨勢
    this.chartLine('chartTrend',months.map(m=>m+'月'),[
      {label:'收入',data:monthIncome,borderColor:'#28a745',backgroundColor:'rgba(40,167,69,.2)'},
      {label:'支出',data:monthExpense,borderColor:'#dc3545',backgroundColor:'rgba(220,53,69,.2)'}
    ]);
    // 支出類別占比
    const expenseCats={};
    filtered.filter(t=>t.type==='支出').forEach(t=>{
      expenseCats[t.category]= (expenseCats[t.category]||0) + Util.toNumber(t.amount);
    });
    this.chartPie('chartExpenseCategory',Object.keys(expenseCats),Object.values(expenseCats));
    // 月度收支對比 (長條)
    this.chartBar('chartMonthlyCompare',months.map(m=>m+'月'),monthIncome,monthExpense);
    // 會員成長
    const memberMonths={};
    Store.data.members.forEach(m=>{
      const ym=(m.joinDate||'').slice(0,7);
      if(!ym) return;
      memberMonths[ym]=(memberMonths[ym]||0)+1;
    });
    const sortedMonths=Object.keys(memberMonths).sort();
    let cumulative=0;
    const growth=sortedMonths.map(m=>{
      cumulative += memberMonths[m];
      return cumulative;
    });
    this.chartLineSingle('chartMemberGrowth',sortedMonths,growth,'會員累計','rgba(44,90,160,0.4)');
  },
  _ensureCtx(id){
    const el=document.getElementById(id);
    if(!el) return null;
    if(this.charts[id]) this.charts[id].destroy();
    return el.getContext('2d');
  },
  chartLine(id,labels,datasets){
    const ctx=this._ensureCtx(id); if(!ctx) return;
    this.charts[id]=new Chart(ctx,{
      type:'line',
      data:{labels,datasets},
      options:{responsive:true,plugins:{legend:{position:'top'}}}
    });
  },
  chartLineSingle(id,labels,data,label,color){
    const ctx=this._ensureCtx(id); if(!ctx) return;
    this.charts[id]=new Chart(ctx,{
      type:'line',
      data:{labels,datasets:[{label,data,borderColor:color,backgroundColor:color,fill:true,tension:.3}]},
      options:{responsive:true}
    });
  },
  chartPie(id,labels,data){
    const ctx=this._ensureCtx(id); if(!ctx) return;
    const colors=labels.map((_,i)=>`hsl(${i*50%360} 70% 55%)`);
    this.charts[id]=new Chart(ctx,{
      type:'doughnut',
      data:{labels,datasets:[{data,backgroundColor:colors}]},
      options:{responsive:true}
    });
  },
  chartBar(id,labels,income,expense){
    const ctx=this._ensureCtx(id); if(!ctx) return;
    this.charts[id]=new Chart(ctx,{
      type:'bar',
      data:{labels,datasets:[
        {label:'收入',data:income,backgroundColor:'rgba(40,167,69,.6)'},
        {label:'支出',data:expense,backgroundColor:'rgba(220,53,69,.6)'}
      ]},
      options:{responsive:true}
    });
  }
};

/* ===================== Reports ===================== */
const Reports = {
  initDateOnce(){
    if(this._inited) return;
    this._inited=true;
    const start=document.getElementById('reportStartDate');
    const end=document.getElementById('reportEndDate');
    const today=Util.today();
    start.value=today.slice(0,4)+'-01-01';
    end.value=today;
  },
  quickDate(type){
    const start=document.getElementById('reportStartDate');
    const end=document.getElementById('reportEndDate');
    const now=new Date();
    if(type==='thisMonth'){
      const y=now.getFullYear(); const m=Util.pad(now.getMonth()+1);
      start.value=`${y}-${m}-01`;
      end.value=Util.today();
    } else if(type==='thisYear'){
      const y=now.getFullYear();
      start.value=`${y}-01-01`;
      end.value=Util.today();
    }
  },
  generate(kind){
    const start=document.getElementById('reportStartDate').value;
    const end=document.getElementById('reportEndDate').value;
    const tx=Store.data.transactions.filter(t=> (!start || t.date>=start) && (!end || t.date<=end));
    let html='';
    if(kind==='cashbook'){
      const cashAccounts=Store.data.accounts.filter(a=>a.active!==false); // 可再標記現金帳戶
      html=`<h5>現金出納帳 (${start} ~ ${end})</h5>
        <table class="table table-sm table-bordered">
          <thead><tr><th>日期</th><th>類型</th><th>類別</th><th>帳戶</th><th>摘要</th><th class="text-end">金額</th></tr></thead>
          <tbody>
            ${
              tx.map(t=> `<tr>
                <td>${t.date}</td>
                <td>${t.type}</td>
                <td>${t.category}</td>
                <td>${t.account||''}</td>
                <td class="small">${t.description||''}</td>
                <td class="text-end ${t.type==='收入'?'text-success':'text-danger'}">${t.type==='收入'?'+':'-'}$${Util.fmtNum(t.amount)}</td>
              </tr>`).join('')
            }
          </tbody>
        </table>`;
    } else if(kind==='incomeExpense'){
      const income=tx.filter(t=>t.type==='收入').reduce((s,t)=>s+Util.toNumber(t.amount),0);
      const expense=tx.filter(t=>t.type==='支出').reduce((s,t)=>s+Util.toNumber(t.amount),0);
      html=`<h5>收支決算表 (${start} ~ ${end})</h5>
      <table class="table table-sm table-bordered w-auto">
        <tbody>
          <tr><th>總收入</th><td class="text-success">$${Util.fmtNum(income)}</td></tr>
          <tr><th>總支出</th><td class="text-danger">$${Util.fmtNum(expense)}</td></tr>
          <tr><th>結餘</th><td class="${income-expense>=0?'text-success':'text-danger'}">$${Util.fmtNum(income-expense)}</td></tr>
        </tbody>
      </table>`;
    } else if(kind==='balanceSheet'){
      Accounts.recalcBalances();
      html=`<h5>資產負債表 (截至 ${end}) - 簡化</h5>
        <table class="table table-sm table-bordered w-auto">
          <thead><tr><th>帳戶</th><th class="text-end">餘額</th></tr></thead>
          <tbody>
            ${
              Store.data.accounts.map(a=> `<tr><td>${a.name}</td><td class="text-end">$${Util.fmtNum(a.currentBalance||0)}</td></tr>`).join('')
            }
            <tr><th>合計</th><th class="text-end">$${Util.fmtNum(Store.data.accounts.reduce((s,a)=>s+(a.currentBalance||0),0))}</th></tr>
          </tbody>
        </table>`;
    } else if(kind==='ledger'){
      // 按類別彙總
      const map={};
      tx.forEach(t=>{
        const key=t.type+'-'+t.category;
        map[key]=(map[key]||0)+Util.toNumber(t.amount);
      });
      html=`<h5>年度分類帳 (${start} ~ ${end})</h5>
        <table class="table table-sm table-bordered w-auto">
          <thead><tr><th>方向</th><th>類別</th><th class="text-end">金額</th></tr></thead>
          <tbody>
            ${
              Object.entries(map).map(([k,v])=>{
                const [type,cat]=k.split('-');
                return `<tr><td>${type}</td><td>${cat}</td><td class="text-end">$${Util.fmtNum(v)}</td></tr>`;
              }).join('')
            }
          </tbody>
        </table>`;
    } else if(kind==='journal'){
      html=`<h5>綜合流水帳 (${start} ~ ${end})</h5>
      <table class="table table-sm table-bordered">
        <thead><tr><th>日期</th><th>類型</th><th>類別</th><th>帳戶</th><th>對象</th><th>摘要</th><th class="text-end">金額</th></tr></thead>
        <tbody>
        ${
          tx.map(t=> `<tr>
            <td>${t.date}</td><td>${t.type}</td><td>${t.category}</td><td>${t.account||''}</td>
            <td>${t.counterparty||''}</td><td class="small">${t.description||''}</td>
            <td class="text-end ${t.type==='收入'?'text-success':'text-danger'}">${t.type==='收入'?'+':'-'}$${Util.fmtNum(t.amount)}</td>
          </tr>`).join('')
        }
        </tbody>
      </table>`;
    } else if(kind==='member'){
      const total=Store.data.members.length;
      const byType={};
      Store.data.members.forEach(m=>{
        byType[m.type]= (byType[m.type]||0)+1;
      });
      html=`<h5>會員報表 (截至 ${end})</h5>
        <div>會員總數：${total}</div>
        <table class="table table-sm table-bordered w-auto mt-2">
          <thead><tr><th>類型</th><th class="text-end">人數</th><th class="text-end">占比</th></tr></thead>
          <tbody>
            ${
              Object.entries(byType).map(([k,v])=>`<tr><td>${k}</td><td class="text-end">${v}</td><td class="text-end">${((v/total)*100).toFixed(1)}%</td></tr>`).join('')
            }
          </tbody>
        </table>`;
    }
    document.getElementById('reportResult').innerHTML=`
      <div class="card card-hoverable">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <h6 class="fw-semibold mb-3"><i class="bi bi-file-earmark-text me-1"></i>報表結果</h6>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="Reports.openModal()">放大</button>
              <button class="btn btn-outline-secondary" onclick="Reports.exportHTML()">匯出 HTML</button>
              <button class="btn btn-outline-secondary" onclick="Reports.print()">列印</button>
            </div>
          </div>
          <div id="reportHTML">${html}</div>
        </div>
      </div>`;
    this.currentHTML=html;
  },
  openModal(){
    const body=document.getElementById('reportModalBody');
    body.innerHTML=this.currentHTML||'尚未生成';
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('reportModal'));
    document.getElementById('reportModalTitle').textContent='報表預覽';
    this.modal.show();
  },
  print(){
    const win=window.open('','_blank');
    win.document.write(`<html><head><title>報表</title><style>
      body{font-family:"Microsoft JhengHei",sans-serif;padding:24px;}
      table{border-collapse:collapse;width:100%;}th,td{border:1px solid #555;padding:4px;font-size:13px;}
    </style></head><body>${this.currentHTML||''}<script>window.print();</script></body></html>`);
    win.document.close();
  },
  exportHTML(){
    Util.downloadBlob('report.html',this.currentHTML||'','text/html');
  }
};

/* ===================== DataPort (簡化匯出全部) ===================== */
const DataPort = {
  exportTransactions(){
    const rows=Store.data.transactions;
    const csv=['id,date,type,category,amount,counterparty,account,description,receiptNumber,voucherNumber'].concat(
      rows.map(t=>[
        t.id,t.date,t.type,t.category,t.amount,t.counterparty||'',t.account||'',(t.description||'').replace(/,/g,' '),
        t.receiptNumber||'',t.voucherNumber||''
      ].join(','))
    ).join('\n');
    Util.downloadBlob('transactions.csv',csv,'text/csv');
  },
  exportMembers(){
    const rows=Store.data.members;
    const csv=['id,name,phone,email,gender,birthDate,joinDate,status,type,lastPaymentDate,tags'].concat(
      rows.map(m=>[
        m.id,m.name,m.phone||'',m.email||'',m.gender||'',m.birthDate||'',m.joinDate||'',m.status||'',m.type||'',m.lastPaymentDate||'',(m.tags||'').replace(/,/g,';')
      ].join(','))
    ).join('\n');
    Util.downloadBlob('members.csv',csv,'text/csv');
  },
  exportActivities(){
    const rows=Store.data.activities;
    const csv=['id,name,type,status,date,time,max,fee,location'].concat(
      rows.map(a=>[
        a.id,a.name,a.type,a.status,a.date,a.time||'',a.max||'',a.fee||'',(a.location||'').replace(/,/g,' ')
      ].join(','))
    ).join('\n');
    Util.downloadBlob('activities.csv',csv,'text/csv');
  },
  exportAnnouncements(){
    const rows=Store.data.announcements;
    const csv=['id,title,type,status,publishDate,expireDate,pinned'].concat(
      rows.map(a=>[
        a.id,a.title.replace(/,/g,' '),a.type,a.status,a.publishDate||'',a.expireDate||'',a.pinned?1:0
      ].join(','))
    ).join('\n');
    Util.downloadBlob('announcements.csv',csv,'text/csv');
  },
  exportForms(){
    const rows=Store.data.forms;
    const csv=['id,name,category,url,keywords,active'].concat(
      rows.map(f=>[
        f.id,f.name.replace(/,/g,' '),f.category,f.url,f.keywords||'',f.active!==false?1:0
      ].join(','))
    ).join('\n');
    Util.downloadBlob('forms.csv',csv,'text/csv');
  },
  exportAll(){
    const all={
      transactions:Store.data.transactions,
      members:Store.data.members,
      accounts:Store.data.accounts,
      activities:Store.data.activities,
      registrations:Store.data.registrations,
      announcements:Store.data.announcements,
      forms:Store.data.forms,
      settings:Store.data.settings
    };
    Util.downloadBlob('all_data.json',JSON.stringify(all,null,2),'application/json');
  },
  importAll(){
    const input=document.createElement('input');
    input.type='file';
    input.accept='.json';
    input.onchange=e=>{
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=ev=>{
        try{
          const json=JSON.parse(ev.target.result);
          Object.assign(Store.data,json);
          SyncIndicator.bump();
          Dashboard.refresh();
          Members.renderTable();
          Transactions.renderTable();
          Activities.renderGrid();
          Announcements.render();
          Forms.render();
          Util.showToast('success','匯入完成');
        }catch(err){ Util.showToast('error','JSON 解析失敗'); }
      };
      reader.readAsText(file,'utf-8');
    };
    input.click();
  }
};

/* ===================== BatchImport (示意簡化) ===================== */
const BatchImport = {
  open(tab){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('batchImportModal'));
    this.modal.show();
    if(tab==='members'){
      const t=document.querySelector('#batchMemberTab');
      const trigger=document.querySelector('[data-bs-target="#batchMemberTab"]');
      bootstrap.Tab.getOrCreateInstance(trigger).show();
    }
  },
  handleFile(kind){
    const file = document.getElementById(kind==='transactions'?'batchTxFile':'batchMemberFile').files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=ev=>{
      const data=new Uint8Array(ev.target.result);
      const wb=XLSX.read(data,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const json=XLSX.utils.sheet_to_json(ws,{defval:''});
      if(kind==='transactions') this.previewTransactions(json);
      else this.previewMembers(json);
    };
    reader.readAsArrayBuffer(file);
  },
  previewTransactions(rows){
    this.txRows=rows.map((r,i)=>({
      raw:r,
      id:Util.uuid(),
      date:r['日期']||r['date']||'',
      type:r['類型']||r['type']||'',
      category:r['類別']||r['category']||'',
      amount:Util.toNumber(r['金額']||r['amount']),
      counterparty:r['對象']||r['counterparty']||'',
      account:r['帳戶']||r['account']||'',
      description:r['說明']||r['description']||'',
      _row:i+2
    }));
    const head=document.getElementById('batchTxHead');
    head.innerHTML='<tr><th>#</th><th>日期</th><th>類型</th><th>類別</th><th>金額</th><th>帳戶</th><th>對象</th><th>說明</th><th>狀態</th></tr>';
    const body=document.getElementById('batchTxBody');
    body.innerHTML=this.txRows.slice(0,200).map(r=>{
      const errors=[];
      if(!r.date) errors.push('缺日期');
      if(!r.type) errors.push('缺類型');
      if(!r.category) errors.push('缺類別');
      if(!r.amount) errors.push('金額0');
      return `<tr class="${errors.length?'row-invalid':''}">
        <td>${r._row}</td><td>${r.date}</td><td>${r.type}</td><td>${r.category}</td>
        <td>${r.amount}</td><td>${r.account}</td><td>${r.counterparty}</td><td class="small">${r.description}</td>
        <td class="small">${errors.join(',')}</td>
      </tr>`;
    }).join('');
    document.getElementById('batchTxStats').textContent=`共 ${this.txRows.length} 筆 (預覽最多200)`;
  },
  previewMembers(rows){
    this.memberRows=rows.map((r,i)=>({
      raw:r,
      id:Util.uuid(),
      name:r['姓名']||'',
      phone:r['電話']||'',
      email:r['Email']||r['email']||'',
      joinDate:r['加入日期']||r['joinDate']||Util.today(),
      type:r['會員類型']||r['type']||'regular',
      status:'active',
      membershipFee:Util.toNumber(r['年費']||r['membershipFee']||Store.data.settings.defaultMembershipFee||1000),
      _row:i+2
    }));
    const head=document.getElementById('batchMemberHead');
    head.innerHTML='<tr><th>#</th><th>姓名</th><th>電話</th><th>Email</th><th>加入</th><th>類型</th><th>年費</th><th>狀態</th></tr>';
    const body=document.getElementById('batchMemberBody');
    body.innerHTML=this.memberRows.slice(0,200).map(r=>{
      const errors=[];
      if(!r.name) errors.push('缺姓名');
      if(!r.phone) errors.push('缺電話');
      return `<tr class="${errors.length?'row-invalid':''}">
        <td>${r._row}</td><td>${r.name}</td><td>${r.phone}</td><td>${r.email}</td>
        <td>${r.joinDate}</td><td>${r.type}</td><td>${r.membershipFee}</td><td class="small">${errors.join(',')}</td>
      </tr>`;
    }).join('');
    document.getElementById('batchMemberStats').textContent=`共 ${this.memberRows.length} 筆 (預覽最多200)`;
  },
  commit(kind){
    if(kind==='transactions'){
      if(!this.txRows?.length){ Util.showToast('error','無資料'); return; }
      let imported=0;
      this.txRows.forEach(r=>{
        if(!r.date||!r.type||!r.category||!r.amount) return;
        Store.data.transactions.push({
          id:r.id, date:r.date, type:r.type, category:r.category, amount:r.amount,
          account:r.account,counterparty:r.counterparty,description:r.description,createdAt:new Date().toISOString()
        });
        imported++;
      });
      Util.showToast('success',`交易匯入完成(${imported})`);
      Transactions.renderTable();
      Dashboard.refresh();
    } else {
      if(!this.memberRows?.length){ Util.showToast('error','無資料'); return; }
      let imported=0;
      this.memberRows.forEach(r=>{
        if(!r.name || !r.phone) return;
        Store.data.members.push({
          id:r.id,name:r.name,phone:r.phone,email:r.email,joinDate:r.joinDate,
          type:r.type,status:r.status,membershipFee:r.membershipFee,createdAt:new Date().toISOString()
        });
        imported++;
      });
      Util.showToast('success',`會員匯入完成(${imported})`);
      Members.renderTable();
      Dashboard.refresh();
    }
    SyncIndicator.bump();
  },
  reparse(kind){
    this.handleFile(kind);
  },
  clear(kind){
    if(kind==='transactions'){
      this.txRows=[]; document.getElementById('batchTxHead').innerHTML=''; document.getElementById('batchTxBody').innerHTML='<tr><td class="text-muted">尚未載入檔案</td></tr>';
      document.getElementById('batchTxStats').textContent='尚未載入資料';
    } else {
      this.memberRows=[]; document.getElementById('batchMemberHead').innerHTML=''; document.getElementById('batchMemberBody').innerHTML='<tr><td class="text-muted">尚未載入檔案</td></tr>';
      document.getElementById('batchMemberStats').textContent='尚未載入資料';
    }
  },
  downloadTemplate(kind){
    if(kind==='transactions'){
      const csv='日期,類型,類別,金額,帳戶,對象,說明\n2025-01-01,收入,會費,1000,銀行,張三,年度會費';
      Util.downloadBlob('transactions_template.csv',csv,'text/csv');
    } else {
      const csv='姓名,電話,Email,加入日期,會員類型,年費\n王小明,0912345678,test@example.com,2025-01-01,regular,1000';
      Util.downloadBlob('members_template.csv',csv,'text/csv');
    }
  },
  filterPreview(){ /* 簡化：此示例未實作按鈕篩選，可自行擴充 */ }
};

/* ===================== Global Search ===================== */
const GlobalSearch = {
  exec(){
    const kw=document.getElementById('globalSearchInput').value.trim().toLowerCase();
    if(!kw) return;
    const tx=Store.data.transactions.filter(t=> (t.description||'').toLowerCase().includes(kw) || (t.category||'').toLowerCase().includes(kw));
    const members=Store.data.members.filter(m=> (m.name||'').toLowerCase().includes(kw) || (m.phone||'').includes(kw));
    const activities=Store.data.activities.filter(a=> (a.name||'').toLowerCase().includes(kw));
    const anns=Store.data.announcements.filter(a=> (a.title||'').toLowerCase().includes(kw));
    Swal.fire({
      width:720,
      title:`全域搜尋：${kw}`,
      html:`
        <div class="text-start">
          <h6>交易 (${tx.length})</h6>
          <div class="small mb-2" style="max-height:120px;overflow:auto;">${tx.slice(0,10).map(t=>`${t.date} ${t.type} ${t.category} $${t.amount}`).join('<br>')||'無'}</div>
          <h6>會員 (${members.length})</h6>
          <div class="small mb-2" style="max-height:120px;overflow:auto;">${members.slice(0,10).map(m=>`${m.name} ${m.phone||''}`).join('<br>')||'無'}</div>
          <h6>活動 (${activities.length})</h6>
          <div class="small mb-2" style="max-height:120px;overflow:auto;">${activities.slice(0,10).map(a=>`${a.date} ${a.name}`).join('<br>')||'無'}</div>
          <h6>公告 (${anns.length})</h6>
          <div class="small" style="max-height:120px;overflow:auto;">${anns.slice(0,10).map(a=>`${a.title}`).join('<br>')||'無'}</div>
        </div>
      `
    });
  }
};

/* ===================== Advanced Search (示意) ===================== */
const AdvancedSearch = {
  open(){
    Swal.fire({
      title:'進階搜尋 (示意)',
      html:'<div class="text-start small text-muted">此處可實作複合條件搜尋 UI</div>',
      confirmButtonText:'關閉'
    });
  }
};

/* ===================== Settings UI (對應 settingsModal) ===================== */
const SettingsUI = {
  modal:null,
  open(){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('settingsModal'));
    this.load();
    this.modal.show();
  },
  load(){
    const s=Store.data.settings;
    document.getElementById('setOrgName').value=s.organizationName||'';
    document.getElementById('setOrgAddress').value=s.organizationAddress||'';
    document.getElementById('setOrgPhone').value=s.organizationPhone||'';
    document.getElementById('setOrgEmail').value=s.organizationEmail||'';
    document.getElementById('setDefaultFee').value=s.defaultMembershipFee||1000;
    document.getElementById('setReceiptPrefix').value=s.receiptPrefix||'R';
    document.getElementById('setVoucherPrefix').value=s.voucherPrefix||'V';
    document.getElementById('setSealTreasurer').value=s.treasurerSeal||'出納';
    document.getElementById('setSealAccountant').value=s.accountantSeal||'會計';
    document.getElementById('setSealChairman').value=s.chairmanSeal||'理事長';
    document.getElementById('setAutoBackup').checked=!!s.autoBackup;
    document.getElementById('setNotifications').checked=!!s.notifications;
    this.renderCategories();
  },
  save(){
    const s=Store.data.settings;
    s.organizationName=document.getElementById('setOrgName').value.trim();
    s.organizationAddress=document.getElementById('setOrgAddress').value.trim();
    s.organizationPhone=document.getElementById('setOrgPhone').value.trim();
    s.organizationEmail=document.getElementById('setOrgEmail').value.trim();
    s.defaultMembershipFee=Util.toNumber(document.getElementById('setDefaultFee').value)||1000;
    s.receiptPrefix=document.getElementById('setReceiptPrefix').value.trim()||'R';
    s.voucherPrefix=document.getElementById('setVoucherPrefix').value.trim()||'V';
    s.treasurerSeal=document.getElementById('setSealTreasurer').value.trim()||'出納';
    s.accountantSeal=document.getElementById('setSealAccountant').value.trim()||'會計';
    s.chairmanSeal=document.getElementById('setSealChairman').value.trim()||'理事長';
    s.autoBackup=document.getElementById('setAutoBackup').checked;
    s.notifications=document.getElementById('setNotifications').checked;
    SyncIndicator.bump();
    Dashboard.refresh();
    Util.showToast('success','設定已儲存');
    this.modal.hide();
  },
  renderCategories(){
    const incomeBox=document.getElementById('incomeCategoryList');
    const expenseBox=document.getElementById('expenseCategoryList');
    incomeBox.innerHTML=(Store.data.settings.categories['收入']||[]).map(c=>`<span class="badge bg-primary" style="cursor:pointer" onclick="SettingsUI.removeCategory('收入','${c}')">${c}</span>`).join(' ');
    expenseBox.innerHTML=(Store.data.settings.categories['支出']||[]).map(c=>`<span class="badge bg-danger" style="cursor:pointer" onclick="SettingsUI.removeCategory('支出','${c}')">${c}</span>`).join(' ');
  },
  addCategory(type){
    const id= type==='收入' ? 'newIncomeCat':'newExpenseCat';
    const v=document.getElementById(id).value.trim();
    if(!v) return;
    const arr=Store.data.settings.categories[type]||(Store.data.settings.categories[type]=[]);
    if(!arr.includes(v)) arr.push(v);
    document.getElementById(id).value='';
    this.renderCategories();
    SyncIndicator.bump();
  },
  removeCategory(type,name){
    const arr=Store.data.settings.categories[type];
    if(!arr) return;
    const idx=arr.indexOf(name);
    if(idx>-1){
      arr.splice(idx,1);
      this.renderCategories();
      SyncIndicator.bump();
    }
  },
  resetCategoryConfirm(){
    Util.confirm({title:'重置類別',text:'將還原預設收入/支出類別，確定？'}).then(r=>{
      if(!r.isConfirmed) return;
      Store.data.settings.categories={
        '收入':['會費','捐款','活動收入','政府補助','利息收入','其他收入'],
        '支出':['活動費用','辦公費用','交通費','餐費','場地費','設備費','印刷費','郵電費','保險費','其他支出']
      };
      this.renderCategories();
      SyncIndicator.bump();
      Util.showToast('success','已重置');
    });
  }
};

/* ===================== Google Sync (示意) ===================== */
const GoogleSync = {
  modal:null,
  open(){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('googleSyncModal'));
    this.modal.show();
  },
  togglePanel(){
    const enabled=document.getElementById('gsEnable').checked;
    document.getElementById('gsPanel').style.display=enabled?'block':'none';
  },
  connect(){
    document.getElementById('gsStatus').textContent='模擬：已連線';
    document.getElementById('gsSyncBtn').disabled=false;
    document.getElementById('gsRestoreBtn').disabled=false;
  },
  sync(){
    document.getElementById('gsStatus').textContent='模擬：同步完成 '+new Date().toLocaleTimeString();
    Util.showToast('success','同步成功 (示意)');
  },
  restore(){
    document.getElementById('gsStatus').textContent='模擬：已還原 '+new Date().toLocaleTimeString();
    Util.showToast('success','還原成功 (示意)');
  },
  saveSettings(){
    Util.showToast('success','雲端設定已儲存 (示意)');
    this.modal.hide();
  }
};

/* ===================== Shortcuts / About / ConfirmReset ===================== */
const Shortcuts = {
  show(){
    Swal.fire({
      title:'快捷鍵 (示意)',
      html:`<div class="text-start small">
        <div><kbd>Ctrl</kbd> + <kbd>F</kbd>：焦點到全域搜尋</div>
        <div><kbd>Alt</kbd> + <kbd>N</kbd>：新增交易 (示意)</div>
      </div>`
    });
  }
};
const About = {
  show(){
    Swal.fire({
      title:'關於系統',
      html:`<div class="text-start small">
        <p>非營利組織整合管理示例系統。</p>
        <p>版本：2025.08 Demo</p>
      </div>`
    });
  }
};
const ConfirmReset = {
  show(){
    Util.confirm({title:'系統重置',text:'將清空所有目前資料（僅前端記憶），確定？',confirmColor:'#dc3545'}).then(r=>{
      if(!r.isConfirmed) return;
      Store.data.transactions=[];
      Store.data.members=[];
      Store.data.accounts=[];
      Store.data.activities=[];
      Store.data.registrations=[];
      Store.data.announcements=[];
      Store.data.forms=[];
      SyncIndicator.bump();
      Dashboard.refresh();
      Transactions.renderTable();
      Members.renderTable();
      Activities.renderGrid();
      Announcements.render();
      Forms.render();
      Util.showToast('success','已重置');
    });
  }
};

/* ===================== Counterparty (對象自動完成) ===================== */
const Counterparty = {
  refreshDatalist(){
    const dl=document.getElementById('counterpartyDatalist');
    if(!dl) return;
    const set=new Set(Store.data.transactions.map(t=>t.counterparty).filter(Boolean));
    dl.innerHTML=[...set].map(v=>`<option value="${v}">`).join('');
  }
};

/* ===================== 將模組掛到 window (若尚未掛載) ===================== */
Object.assign(window,{
  Transactions, TransactionUI, Accounts, AccountUI,
  Members, MemberUI, Activities, ActivityUI,
  RegistrationUI, Announcements, AnnouncementUI,
  Forms, FormUI, Analytics, Reports, DataPort,
  BatchImport, GlobalSearch, AdvancedSearch,
  SettingsUI, GoogleSync, Shortcuts, About, ConfirmReset,
  Counterparty
});

/* ===================== DOMContentLoaded 追加初始化（如你尾端已寫可略） ===================== */
document.addEventListener('DOMContentLoaded', ()=>{
  Counterparty.refreshDatalist();
});

/* ===================== END ===================== */


  </script>
</body>
</html>
