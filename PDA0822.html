<!-- =========================================================
     PART 1/5  ─────────────  HEAD / 基礎結構與樣式
     ========================================================= -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>台灣帕金森病友權益促進會 - 會計暨營運整合管理系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="非營利組織整合：財務 / 會員 / 活動 / 公告 / 表單 / 雲端備份管理系統">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <style>
    :root {
      --primary:#2c5aa0;
      --primary-dark:#1e3d6f;
      --gradient-primary:linear-gradient(135deg,#2c5aa0,#4a90e2);
      --gradient-green:linear-gradient(135deg,#28a745,#20c997);
      --gradient-orange:linear-gradient(135deg,#ff9f40,#ffb347);
      --secondary-bg:#f8f9fa;
      --radius-lg:15px;
      --radius-md:10px;
      --radius-sm:6px;
    }
    body {
      background:var(--secondary-bg);
      font-family:"Microsoft JhengHei","Noto Sans TC",system-ui,sans-serif;
      font-size:14.5px;
    }
    .navbar-brand { font-weight:600; color:var(--primary)!important; }
    .sidebar {
      min-height:100vh;
      background:linear-gradient(180deg,#2c5aa0,#1e3d6f);
      color:#fff;
    }
    .sidebar .nav-link {
      color:rgba(255,255,255,.82);
      border-radius:8px;
      margin:3px 0;
      font-weight:500;
      transition:.25s;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background:rgba(255,255,255,0.12);
      color:#fff;
      transform:translateX(4px);
    }
    .content-section { animation:fadeIn .35s ease; }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(12px); }
      to { opacity:1; transform:translateY(0); }
    }
    .stat-card {
      background:var(--gradient-primary);
      color:#fff;
      border:none;
      border-radius:var(--radius-lg);
      box-shadow:0 4px 14px -4px rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
    }
    .stat-card.alt-green { background:var(--gradient-green); }
    .stat-card.alt-orange{ background:var(--gradient-orange); }
    .stat-card .icon-bg {
      position:absolute;
      right:-10px; top:-10px;
      font-size:72px;
      opacity:.16;
    }
    .card-hoverable { transition:.25s; border:none; border-radius:var(--radius-lg); }
    .card-hoverable:hover { transform:translateY(-4px); box-shadow:0 8px 24px -6px rgba(0,0,0,.15); }
    .table thead th { background:#f1f4f8; border-top:none; font-weight:600; }
    .badge-rounded { border-radius:20px; font-weight:500; letter-spacing:.5px; }
    .member-avatar, .participant-avatar {
      width:40px;height:40px;border-radius:50%;background:#fff;
      display:flex;align-items:center;justify-content:center;
      color:#666;font-weight:600;
      box-shadow:0 0 0 1px rgba(0,0,0,.05);
    }
    .small-avatar { width:32px;height:32px;font-size:12px; }
    .action-buttons .btn { padding:.25rem .5rem; }
    .voucher-preview img {
      max-width:100px;max-height:100px;object-fit:cover;border-radius:6px;margin:4px;cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    .loading-overlay {
      position:fixed; inset:0; z-index:2000;
      background:rgba(0,0,0,.45); display:flex;align-items:center;justify-content:center;
    }
    .pagination .page-link { border:none; border-radius:8px; color:var(--primary); }
    .pagination .page-item.active .page-link { background:var(--primary); }
    .chart-container { position:relative; height:380px; }
    .separator-title {
      font-size:15px;font-weight:600;margin:16px 0 10px;display:flex;align-items:center;gap:.5rem;
    }
    .separator-title:before, .separator-title:after {
      content:""; flex:1; height:1px; background:linear-gradient(90deg,#d0d3d9,#ffffff);
    }
    .form-download-item {
      border:1px solid #e2e6eb; padding:14px 16px; border-radius:var(--radius-md);
      background:#fff; position:relative; transition:.25s;
    }
    .form-download-item:hover { box-shadow:0 6px 18px -6px rgba(0,0,0,.15); transform:translateY(-3px); }
    .activity-card { border:none;border-radius:var(--radius-lg);overflow:hidden;box-shadow:0 3px 10px -2px rgba(0,0,0,.12);position:relative; }
    .activity-card .progress { height:6px; border-radius:3px; background:#e9ecef; overflow:hidden; }
    .activity-card .progress-bar { background:var(--gradient-green); }
    .announcement-card { border-left:5px solid #ffc107; border-radius:var(--radius-md); }
    .announcement-card.urgent { border-left-color:#dc3545; background:linear-gradient(135deg,#fff5f5,#ffffff); }
    .dual-col { columns:2 320px; column-gap:14px; }
    /* Batch import indicators */
    .row-invalid { background:#fff5f5!important; }
    .row-duplicate { background:#fff9e6!important; }
    .preview-status-badge { font-size:10px; }
    .mapping-select { width:100%; margin-bottom:6px; }
    /* Print friendly */
    @media print {
      .no-print, .sidebar, .navbar, .modal-backdrop { display:none!important; }
      body { background:#fff; }
      .main-content { margin:0!important; padding:0!important; }
      .card { box-shadow:none!important; }
    }
    /* Mobile */
    @media (max-width: 992px){
      .sidebar { position:fixed; left:0; top:0; transform:translateX(-100%); transition:.35s; z-index:1100; width:250px; }
      .sidebar.show { transform:translateX(0); }
    }
    /* Utility */
    .spin { animation:spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
    /* Seal / Receipt simplified container placeholder (styling improved in print module) */
    .receipt-seal-placeholder { width:60px; height:60px; border:2px solid #c00; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:#c00; }
  </style>
</head>
<body>
  <!-- 全螢幕載入遮罩 -->
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="text-center text-white">
      <div class="mb-3">
        <i class="bi bi-arrow-clockwise spin" style="font-size:48px;"></i>
      </div>
      <div>系統載入中，請稍候…</div>
    </div>
  </div>

  <!-- 同步指示
  <div class="position-fixed top-0 end-0 p-2 d-flex flex-column gap-1 no-print" style="z-index:1200;">
    <span id="syncIndicator" class="badge bg-success"><i class="bi bi-cloud-check"></i> 已同步</span>
    <span id="cloudIndicator" class="badge bg-info"><i class="bi bi-cloud"></i> 雲端未連線</span>
    <span id="offlineIndicator" class="badge bg-danger d-none"><i class="bi bi-wifi-off"></i> 離線</span>
  </div> -->

  <!-- 導覽列 -->
  <nav class="navbar navbar-expand-lg bg-white shadow-sm no-print">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <i class="bi bi-heart-pulse me-2"></i> 台灣帕金森病友權益促進會
      </a>
      <button class="navbar-toggler" type="button" onclick="AppLayout.toggleSidebar()">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item me-2">
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
              <input id="globalSearchInput" type="text" class="form-control" placeholder="全域搜尋 (交易 / 會員 / 活動 / 公告)" onkeydown="if(event.key==='Enter') GlobalSearch.exec()">
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle fw-semibold" href="#" data-bs-toggle="dropdown">
              <i class="bi bi-gear"></i> 系統
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" onclick="SettingsUI.open()"><i class="bi bi-sliders"></i> 系統設定</a></li>
              <li><a class="dropdown-item" href="#" onclick="AccountUI.openManager()"><i class="bi bi-bank"></i> 帳戶管理</a></li>
              <li><a class="dropdown-item" href="#" onclick="GoogleSync.open()"><i class="bi bi-cloud-arrow-up"></i> 雲端同步</a></li>
              <li><a class="dropdown-item" href="#" onclick="BatchImport.open('transactions')"><i class="bi bi-cloud-upload"></i> 批次匯入</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.exportAll()"><i class="bi bi-download"></i> 匯出資料</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.importAll()"><i class="bi bi-upload"></i> 匯入資料</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="Shortcuts.show()"><i class="bi bi-keyboard"></i> 快捷鍵</a></li>
              <li><a class="dropdown-item" href="#" onclick="About.show()"><i class="bi bi-info-circle"></i> 關於</a></li>
              <li><a class="dropdown-item" href="#" onclick="ConfirmReset.show()"><i class="bi bi-exclamation-triangle"></i> 系統重置</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- 側邊欄 -->
      <aside id="sidebar" class="sidebar col-lg-2 col-md-3 p-3">
        <h6 class="text-center mt-2 mb-4 fw-semibold">管理選單</h6>
        <nav class="nav flex-column">
          <a class="nav-link active" href="#" data-section="dashboard" onclick="AppLayout.showSection('dashboard',this)"><i class="bi bi-speedometer2 me-2"></i>儀表板</a>
          <a class="nav-link" href="#" data-section="transactions" onclick="AppLayout.showSection('transactions',this)"><i class="bi bi-receipt me-2"></i>交易記錄</a>
          <a class="nav-link" href="#" data-section="members" onclick="AppLayout.showSection('members',this)"><i class="bi bi-people me-2"></i>會員管理</a>
          <a class="nav-link" href="#" data-section="activities" onclick="AppLayout.showSection('activities',this)"><i class="bi bi-calendar-event me-2"></i>活動管理</a>
          <a class="nav-link" href="#" data-section="announcements" onclick="AppLayout.showSection('announcements',this)"><i class="bi bi-megaphone me-2"></i>公告管理</a>
          <a class="nav-link" href="#" data-section="forms" onclick="AppLayout.showSection('forms',this)"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單</a>
          <a class="nav-link" href="#" data-section="analytics" onclick="AppLayout.showSection('analytics',this)"><i class="bi bi-graph-up me-2"></i>統計分析</a>
          <a class="nav-link" href="#" data-section="reports" onclick="AppLayout.showSection('reports',this)"><i class="bi bi-file-earmark-text me-2"></i>報表中心</a>
        </nav>
      </aside>

      <!-- 主要內容 -->
      <main id="mainContent" class="col-lg-10 col-md-9 p-4">
        <!-- =========================================================
             PART 2/5  ─────────────  主內容各 Section
             ========================================================= -->

        <!-- 儀表板 -->
        <section id="dashboardSection" class="content-section">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>儀表板</h4>
            <div class="d-flex gap-2">
                <div class="d-flex gap-1 me-3">
                  <span id="syncIndicator" class="badge bg-success"><i class="bi bi-cloud-check"></i> 已同步</span>
                  <span id="cloudIndicator" class="badge bg-info"><i class="bi bi-cloud"></i> 雲端未連線</span>
                  <span id="offlineIndicator" class="badge bg-danger d-none"><i class="bi bi-wifi-off"></i> 離線</span>
                </div>
              <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
              <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
              <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
            </div>
          </div>

          <!-- 統計卡片列 -->
          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100">
                <div class="icon-bg"><i class="bi bi-cash-coin"></i></div>
                <small>總收入</small>
                <h3 id="dashTotalIncome" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">本月</span>
                  <span id="dashMonthIncome" class="small fw-semibold">$0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100 alt-orange">
                <div class="icon-bg"><i class="bi bi-credit-card-2-front"></i></div>
                <small>總支出</small>
                <h3 id="dashTotalExpense" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">本月</span>
                  <span id="dashMonthExpense" class="small fw-semibold">$0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100 alt-green">
                <div class="icon-bg"><i class="bi bi-bank"></i></div>
                <small>帳戶總餘額</small>
                <h3 id="dashTotalBalance" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">帳戶數</span>
                  <span id="dashAccountCount" class="small fw-semibold">0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100">
                <div class="icon-bg"><i class="bi bi-people"></i></div>
                <small>會員總數</small>
                <h3 id="dashMemberTotal" class="mb-1">0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">逾期會費</span>
                  <span id="dashMemberOverdue" class="badge bg-danger rounded-pill">0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 帳戶餘額 -->
          <div class="card card-hoverable mb-3">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h6 class="mb-0"><i class="bi bi-bank me-1"></i>帳戶餘額概覽</h6>
              <button class="btn btn-sm btn-outline-primary" onclick="AccountUI.openManager()"><i class="bi bi-gear"></i> 管理帳戶</button>
            </div>
            <div class="card-body">
              <div id="dashboardAccountBalances" class="row g-3">
                <!-- 動態填入 -->
              </div>
            </div>
          </div>

          <!-- 最新交易 / 最新會員 / 最新活動 -->
          <div class="row g-3">
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-arrows-expand me-1"></i>最近交易</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentTx">
                  <!-- 動態 -->
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-person-plus me-1"></i>新加入會員</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentMembers">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-calendar-event me-1"></i>近期活動</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentActivities">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 交易記錄 -->
        <section id="transactionsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-receipt me-2"></i>交易記錄</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="AdvancedSearch.open()"><i class="bi bi-search"></i> 進階搜尋</button>
              <button class="btn btn-outline-success btn-sm" onclick="BatchImport.open('transactions')"><i class="bi bi-cloud-upload"></i> 批次匯入</button>
              <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
            </div>
          </div>

          <div class="card card-hoverable mb-3">
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <div class="col-md-2">
                  <label class="form-label mb-1">年份</label>
                  <select id="txFilterYear" class="form-select form-select-sm" onchange="Transactions.renderTable()">
                    <option value="">全部</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label mb-1">月份</label>
                  <select id="txFilterMonth" class="form-select form-select-sm" onchange="Transactions.renderTable()">
                    <option value="">全部</option>
                    ${[...Array(12)].map((_,i)=>`<option value="${i+1}">${i+1}月</option>`).join('')}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label mb-1">類型</label>
                  <select id="txFilterType" class="form-select form-select-sm" onchange="Transactions.renderTable()">
                    <option value="">全部</option>
                    <option value="收入">收入</option>
                    <option value="支出">支出</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label mb-1">關鍵字</label>
                  <input id="txFilterKeyword" type="text" class="form-control form-control-sm" placeholder="類別 / 對象 / 說明 / 編號" oninput="Transactions.renderTable()">
                </div>
                <div class="col-md-2 d-grid">
                  <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportTransactions()"><i class="bi bi-download"></i> 匯出</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card card-hoverable">
            <div class="card-body">
              <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
                <div><span id="txRecordCount" class="fw-semibold">0 筆</span></div>
                <div class="d-flex gap-2">
                  <select id="txBatchAction" class="form-select form-select-sm">
                    <option value="">批次操作</option>
                    <option value="delete">刪除</option>
                    <option value="export">匯出</option>
                    <option value="print">列印收據</option>
                    <option value="voucher">列印憑證</option>
                  </select>
                  <button class="btn btn-outline-primary btn-sm" onclick="Transactions.batchAction()">
                    <i class="bi bi-check2-square"></i> 執行
                  </button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-2">
                  <thead>
                    <tr>
                      <th style="width:30px;"><input type="checkbox" id="txSelectAll" onclick="Transactions.toggleSelectAll(this)"></th>
                      <th>日期</th><th>類型</th><th>類別</th><th class="text-end">金額</th><th>對象</th><th>帳戶</th><th>說明</th><th>編號/附件</th><th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="txTableBody">
                    <tr><td colspan="10" class="text-center py-5 text-muted">
                      <i class="bi bi-inbox display-6 d-block mb-2"></i> 尚無資料
                    </td></tr>
                  </tbody>
                </table>
              </div>
              <nav class="d-flex justify-content-center">
                <ul id="txPagination" class="pagination pagination-sm mb-0"></ul>
              </nav>
            </div>
          </div>
        </section>

        <!-- 會員管理 -->
        <section id="membersSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-people me-2"></i>會員管理</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-success btn-sm" onclick="BatchImport.open('members')"><i class="bi bi-cloud-upload"></i> 批次匯入</button>
              <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
              <div class="card text-center card-hoverable p-2">
                <small class="text-muted">總會員</small>
                <h4 id="mStatTotal" class="mb-0">0</h4>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center card-hoverable p-2">
                <small class="text-muted">正常</small>
                <h4 id="mStatActive" class="text-success mb-0">0</h4>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center card-hoverable p-2">
                <small class="text-muted">逾期會費</small>
                <h4 id="mStatOverdue" class="text-danger mb-0">0</h4>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center card-hoverable p-2">
                <small class="text-muted">本月新增</small>
                <h4 id="mStatNew" class="mb-0">0</h4>
              </div>
            </div>
          </div>

          <div class="card card-hoverable mb-3">
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <div class="col-md-3">
                  <label class="form-label mb-1">狀態</label>
                  <select id="memberFilterStatus" class="form-select form-select-sm" onchange="Members.renderTable()">
                    <option value="">全部</option>
                    <option value="active">正常</option>
                    <option value="inactive">停權</option>
                    <option value="pending">待審核</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label mb-1">會員類型</label>
                  <select id="memberFilterType" class="form-select form-select-sm" onchange="Members.renderTable()">
                    <option value="">全部</option>
                    <option value="regular">一般會員</option>
                    <option value="honorary">榮譽會員</option>
                    <option value="life">終身會員</option>
                    <option value="family">家屬會員</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label mb-1">關鍵字</label>
                  <input id="memberFilterKeyword" type="text" class="form-control form-control-sm" placeholder="姓名 / 電話 / Email / 標籤" oninput="Members.renderTable()">
                </div>
                <div class="col-md-2 d-grid">
                  <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportMembers()"><i class="bi bi-download"></i> 匯出</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card card-hoverable">
            <div class="card-body">
              <div class="d-flex flex-wrap justify-content-between mb-2 gap-2">
                <span id="memberRecordCount" class="fw-semibold">0 筆記錄</span>
                <div class="d-flex gap-2">
                  <select id="memberBatchAction" class="form-select form-select-sm">
                    <option value="">批次操作</option>
                    <option value="delete">刪除</option>
                    <option value="export">匯出</option>
                    <option value="status-active">設為正常</option>
                    <option value="status-inactive">設為停權</option>
                  </select>
                  <button class="btn btn-outline-primary btn-sm" onclick="Members.batchAction()"><i class="bi bi-check2-square"></i> 執行</button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th style="width:30px;"><input type="checkbox" id="memberSelectAll" onclick="Members.toggleSelectAll(this)"></th>
                      <th>基本資料</th><th>聯絡</th><th>年齡/性別</th><th>加入</th><th>狀態</th><th>會費</th><th>標籤</th><th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="memberTableBody">
                    <tr><td colspan="9" class="text-center text-muted py-5">
                      <i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員資料
                    </td></tr>
                  </tbody>
                </table>
              </div>
              <nav class="d-flex justify-content-center">
                <ul id="memberPagination" class="pagination pagination-sm mb-0"></ul>
              </nav>
            </div>
          </div>
        </section>

        <!-- 活動管理 -->
        <section id="activitiesSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-calendar-event me-2"></i>活動管理</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportActivities()"><i class="bi bi-download"></i> 匯出</button>
              <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
              <div class="card p-2 text-center card-hoverable">
                <small class="text-muted">總活動數</small>
                <h5 id="actStatTotal" class="mb-0">0</h5>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card p-2 text-center card-hoverable">
                <small class="text-muted">報名中</small>
                <h5 id="actStatOpen" class="mb-0 text-success">0</h5>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card p-2 text-center card-hoverable">
                <small class="text-muted">即將開始(7日)</small>
                <h5 id="actStatUpcoming" class="mb-0">0</h5>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card p-2 text-center card-hoverable">
                <small class="text-muted">總報名</small>
                <h5 id="actStatRegistrations" class="mb-0">0</h5>
              </div>
            </div>
          </div>

          <div class="card card-hoverable mb-3">
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <div class="col-md-2">
                  <label class="form-label mb-1">狀態</label>
                  <select id="actFilterStatus" class="form-select form-select-sm" onchange="Activities.renderGrid()">
                    <option value="">全部</option>
                    <option value="draft">草稿</option>
                    <option value="published">已發布</option>
                    <option value="registration">報名中</option>
                    <option value="full">已額滿</option>
                    <option value="closed">已結束</option>
                    <option value="cancelled">已取消</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label mb-1">類型</label>
                  <select id="actFilterType" class="form-select form-select-sm" onchange="Activities.renderGrid()">
                    <option value="">全部</option>
                    <option value="講座">講座</option>
                    <option value="聚會">聚會</option>
                    <option value="旅遊">旅遊</option>
                    <option value="運動">運動</option>
                    <option value="志工">志工服務</option>
                    <option value="其他">其他</option>
                  </select>
                </div>
                <div class="col-md-5">
                  <label class="form-label mb-1">關鍵字</label>
                  <input id="actFilterKeyword" type="text" class="form-control form-control-sm" placeholder="名稱 / 地點 / 描述" oninput="Activities.renderGrid()">
                </div>
                <div class="col-md-3">
                  <label class="form-label mb-1">排序</label>
                  <select id="actFilterSort" class="form-select form-select-sm" onchange="Activities.renderGrid()">
                    <option value="date_desc">日期(新→舊)</option>
                    <option value="date_asc">日期(舊→新)</option>
                    <option value="name_asc">名稱</option>
                    <option value="regs_desc">報名多→少</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div id="activitiesGrid" class="row g-4">
            <div class="col-12 text-center py-5 text-muted">
              <i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動
            </div>
          </div>
          <nav class="d-flex justify-content-center mt-3">
            <ul id="actPagination" class="pagination pagination-sm mb-0"></ul>
          </nav>
        </section>

        <!-- 公告管理 -->
        <section id="announcementsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-megaphone me-2"></i>公告管理</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportAnnouncements()"><i class="bi bi-download"></i> 匯出</button>
              <button class="btn btn-warning btn-sm" onclick="AnnouncementUI.open()"><i class="bi bi-plus-circle"></i> 新增公告</button>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-6 col-md-4">
              <div class="card p-2 text-center card-hoverable">
                <small class="text-muted">公告總數</small>
                <h5 id="annStatTotal" class="mb-0">0</h5>
              </div>
            </div>
            <div class="col-6 col-md-4">
              <div class="card p-2 text-center card-hoverable">
                <small class="text-muted">有效公告</small>
                <h5 id="annStatActive" class="text-success mb-0">0</h5>
              </div>
            </div>
            <div class="col-6 col-md-4">
              <div class="card p-2 text-center card-hoverable">
                <small class="text-muted">緊急公告</small>
                <h5 id="annStatUrgent" class="text-danger mb-0">0</h5>
              </div>
            </div>
          </div>

          <div class="card card-hoverable mb-3">
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <div class="col-md-3">
                  <label class="form-label mb-1">狀態</label>
                  <select id="annFilterStatus" class="form-select form-select-sm" onchange="Announcements.render()">
                    <option value="">全部</option>
                    <option value="draft">草稿</option>
                    <option value="published">已發布</option>
                    <option value="expired">已過期</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label mb-1">類型</label>
                  <select id="annFilterType" class="form-select form-select-sm" onchange="Announcements.render()">
                    <option value="">全部</option>
                    <option value="normal">一般</option>
                    <option value="urgent">緊急</option>
                    <option value="event">活動相關</option>
                    <option value="system">系統公告</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label mb-1">關鍵字</label>
                  <input id="annFilterKeyword" type="text" class="form-control form-control-sm" placeholder="標題 / 內容關鍵字" oninput="Announcements.render()">
                </div>
              </div>
            </div>
          </div>

          <div id="announcementsGrid" class="row g-4">
            <div class="col-12 text-center py-5 text-muted">
              <i class="bi bi-megaphone display-6 d-block mb-2"></i> 尚無公告
            </div>
          </div>
          <nav class="d-flex justify-content-center mt-3">
            <ul id="annPagination" class="pagination pagination-sm mb-0"></ul>
          </nav>
        </section>

        <!-- 行政表單 -->
        <section id="formsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單下載</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-primary btn-sm" onclick="FormUI.openManager()"><i class="bi bi-gear"></i> 管理表單</button>
            </div>
          </div>

          <div class="card card-hoverable mb-3">
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <div class="col-md-8">
                  <label class="form-label mb-1">關鍵字</label>
                  <input id="formFilterKeyword" type="text" class="form-control form-control-sm" placeholder="搜尋表單名稱 / 關鍵字" oninput="Forms.render()">
                </div>
                <div class="col-md-4">
                  <label class="form-label mb-1">分類</label>
                  <select id="formFilterCategory" class="form-select form-select-sm" onchange="Forms.render()">
                    <option value="">全部</option>
                    <option value="會員">會員相關</option>
                    <option value="財務">財務相關</option>
                    <option value="活動">活動相關</option>
                    <option value="行政">行政相關</option>
                    <option value="其他">其他</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div id="formsList" class="row g-3">
            <div class="col-12 text-center py-5 text-muted">
              <i class="bi bi-file-earmark-arrow-down display-6 d-block mb-2"></i> 尚無表單
            </div>
          </div>
        </section>

        <!-- 統計分析 -->
        <section id="analyticsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-graph-up me-2"></i>統計分析</h4>
            <div>
              <select id="analyticsYear" class="form-select form-select-sm d-inline-block w-auto" onchange="Analytics.refresh()">
                <option value="">選擇年份</option>
              </select>
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
              <div class="card text-center p-2 card-hoverable">
                <small>年度收入</small>
                <h5 id="anaTotalIncome" class="text-success mb-0">$0</h5>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center p-2 card-hoverable">
                <small>年度支出</small>
                <h5 id="anaTotalExpense" class="text-danger mb-0">$0</h5>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center p-2 card-hoverable">
                <small>年度結餘</small>
                <h5 id="anaBalance" class="mb-0">$0</h5>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center p-2 card-hoverable">
                <small>平均月度</small>
                <h5 id="anaAvgMonthly" class="mb-0">$0</h5>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-6">
              <div class="card card-hoverable">
                <div class="card-header bg-white"><h6 class="mb-0">收支趨勢</h6></div>
                <div class="card-body">
                  <div class="chart-container"><canvas id="chartTrend"></canvas></div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card card-hoverable">
                <div class="card-header bg-white"><h6 class="mb-0">支出類別占比</h6></div>
                <div class="card-body">
                  <div class="chart-container"><canvas id="chartExpenseCategory"></canvas></div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card card-hoverable">
                <div class="card-header bg-white"><h6 class="mb-0">月度收支對比</h6></div>
                <div class="card-body">
                  <div class="chart-container"><canvas id="chartMonthlyCompare"></canvas></div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card card-hoverable">
                <div class="card-header bg-white"><h6 class="mb-0">會員成長趨勢</h6></div>
                <div class="card-body">
                  <div class="chart-container"><canvas id="chartMemberGrowth"></canvas></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 報表中心 -->
        <section id="reportsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>報表中心</h4>
            <div class="d-flex gap-2">
              <input id="reportStart" type="date" class="form-control form-control-sm">
              <input id="reportEnd" type="date" class="form-control form-control-sm">
              <button class="btn btn-primary btn-sm" onclick="Reports.quickDate('thisMonth')">本月</button>
              <button class="btn btn-outline-primary btn-sm" onclick="Reports.quickDate('thisYear')">今年</button>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <div class="card card-hoverable h-100">
                <div class="card-body text-center">
                  <i class="bi bi-cash-stack display-5 text-primary mb-2"></i>
                  <h6 class="fw-semibold">現金出納帳</h6>
                  <p class="small text-muted">現金帳戶收支逐筆紀錄</p>
                  <button class="btn btn-primary btn-sm" onclick="Reports.generate('cashbook')"><i class="bi bi-download"></i> 生成</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-hoverable h-100">
                <div class="card-body text-center">
                  <i class="bi bi-bar-chart-line display-5 text-success mb-2"></i>
                  <h6 class="fw-semibold">收支決算表</h6>
                  <p class="small text-muted">期間收入支出與結餘</p>
                  <button class="btn btn-success btn-sm" onclick="Reports.generate('incomeExpense')"><i class="bi bi-download"></i> 生成</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-hoverable h-100">
                <div class="card-body text-center">
                  <i class="bi bi-building display-5 text-warning mb-2"></i>
                  <h6 class="fw-semibold">資產負債表</h6>
                  <p class="small text-muted">截至日期財務結構</p>
                  <button class="btn btn-warning btn-sm" onclick="Reports.generate('balanceSheet')"><i class="bi bi-download"></i> 生成</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-hoverable h-100">
                <div class="card-body text-center">
                  <i class="bi bi-journal-text display-5 text-info mb-2"></i>
                  <h6 class="fw-semibold">年度分類帳</h6>
                  <p class="small text-muted">各類別借貸彙總</p>
                  <button class="btn btn-info btn-sm text-white" onclick="Reports.generate('ledger')"><i class="bi bi-download"></i> 生成</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-hoverable h-100">
                <div class="card-body text-center">
                  <i class="bi bi-list-ul display-5 text-secondary mb-2"></i>
                  <h6 class="fw-semibold">綜合流水帳</h6>
                  <p class="small text-muted">所有交易明細列表</p>
                  <button class="btn btn-secondary btn-sm" onclick="Reports.generate('journal')"><i class="bi bi-download"></i> 生成</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-hoverable h-100">
                <div class="card-body text-center">
                  <i class="bi bi-people-fill display-5 text-dark mb-2"></i>
                  <h6 class="fw-semibold">會員報表</h6>
                  <p class="small text-muted">會員結構統計</p>
                  <button class="btn btn-dark btn-sm" onclick="Reports.generate('member')"><i class="bi bi-download"></i> 生成</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- =========================================================
             PART 3/5  ─────────────  MODALS
             ========================================================= -->

        <!-- 交易 Modal -->
        <div class="modal fade" id="transactionModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h6 class="modal-title"><i class="bi bi-receipt me-2"></i><span id="txModalTitle">新增交易</span></h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="txForm">
                  <input type="hidden" id="txId">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">日期 *</label>
                      <input id="txDate" type="date" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">類型 *</label>
                      <select id="txType" class="form-select" required onchange="TransactionUI.onTypeChange()">
                        <option value="">請選擇</option>
                        <option value="收入">收入</option>
                        <option value="支出">支出</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">帳戶 *</label>
                      <select id="txAccount" class="form-select" required></select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">類別 *</label>
                      <select id="txCategory" class="form-select" required></select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">金額 *</label>
                      <input id="txAmount" type="number" min="0" step="1" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">對象</label>
                      <input id="txCounterparty" type="text" class="form-control" list="counterpartyDatalist">
                      <datalist id="counterpartyDatalist"></datalist>
                    </div>
                    <div class="col-12">
                      <label class="form-label">說明</label>
                      <textarea id="txDescription" rows="2" class="form-control" placeholder="可留空"></textarea>
                    </div>
                    <div class="col-md-6">
                      <label id="txNumberLabel" for="txNumber" class="form-label">收據編號</label>
                      <input id="txNumber" type="text" class="form-control" placeholder="自動帶入，可覆寫">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">附件(憑證) 上傳</label>
                      <input id="txVouchers" type="file" class="form-control" multiple accept="image/*,application/pdf" onchange="TransactionUI.handleVoucherUpload(event)">
                      <div class="form-text">支援多檔：圖片 / PDF</div>
                    </div>
                    <div class="col-12">
                      <div id="txVoucherPreview" class="voucher-preview"></div>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-primary btn-sm" onclick="TransactionUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 會員 Modal -->
        <div class="modal fade" id="memberModal" tabindex="-1">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-success text-white">
                <h6 class="modal-title"><i class="bi bi-person me-2"></i><span id="memberModalTitle">新增會員</span></h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="memberForm">
                  <input type="hidden" id="memberId">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <h6 class="fw-semibold">基本資料</h6>
                      <label class="form-label mt-2">姓名 *</label>
                      <input id="memberName" class="form-control" required>
                      <label class="form-label mt-2">電話 *</label>
                      <input id="memberPhone" class="form-control" required>
                      <label class="form-label mt-2">電子郵件</label>
                      <input id="memberEmail" type="email" class="form-control">
                      <div class="row mt-2 g-2">
                        <div class="col-6">
                          <label class="form-label">出生日期</label>
                          <input id="memberBirthDate" type="date" class="form-control">
                        </div>
                        <div class="col-6">
                          <label class="form-label">性別</label>
                          <select id="memberGender" class="form-select">
                            <option value="">未指定</option>
                            <option value="男">男</option>
                            <option value="女">女</option>
                            <option value="其他">其他</option>
                          </select>
                        </div>
                      </div>
                      <label class="form-label mt-2">身分證字號</label>
                      <input id="memberIdNumber" maxlength="10" class="form-control">
                    </div>
                    <div class="col-md-4">
                      <h6 class="fw-semibold">聯絡資訊</h6>
                      <label class="form-label mt-2">地址</label>
                      <textarea id="memberAddress" rows="3" class="form-control"></textarea>
                      <label class="form-label mt-2">緊急聯絡人</label>
                      <input id="emergencyContact" class="form-control">
                      <label class="form-label mt-2">緊急聯絡電話</label>
                      <input id="emergencyPhone" class="form-control">
                      <label class="form-label mt-2">備註</label>
                      <textarea id="memberNotes" rows="3" class="form-control"></textarea>
                    </div>
                    <div class="col-md-4">
                      <h6 class="fw-semibold">會員資訊</h6>
                      <label class="form-label mt-2">加入日期 *</label>
                      <input id="memberJoinDate" type="date" class="form-control" required>
                      <label class="form-label mt-2">狀態</label>
                      <select id="memberStatus" class="form-select">
                        <option value="active">正常</option>
                        <option value="inactive">停權</option>
                        <option value="pending">待審核</option>
                      </select>
                      <label class="form-label mt-2">會員類型</label>
                      <select id="memberType" class="form-select">
                        <option value="regular">一般會員</option>
                        <option value="honorary">榮譽會員</option>
                        <option value="life">終身會員</option>
                        <option value="family">家屬會員</option>
                      </select>
                      <label class="form-label mt-2">年費金額</label>
                      <input id="membershipFee" type="number" class="form-control" value="1000" min="0">
                      <label class="form-label mt-2">最後繳費日期</label>
                      <input id="lastPaymentDate" type="date" class="form-control">
                      <label class="form-label mt-2">標籤（逗號分隔）</label>
                      <input id="memberTags" class="form-control" placeholder="例：病友,志工">
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-success btn-sm" onclick="MemberUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 會員詳情 Modal -->
        <div class="modal fade" id="memberDetailModal" tabindex="-1">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-dark text-white">
                <h6 class="modal-title"><i class="bi bi-person-badge me-2"></i>會員詳情</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="memberDetailContent">
                <!-- 動態填入 -->
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-success btn-sm" onclick="Members.recordFee()"><i class="bi bi-credit-card"></i> 紀錄繳費</button>
                <button class="btn btn-outline-primary btn-sm" onclick="Members.printCard()"><i class="bi bi-printer"></i> 會員卡</button>
                <button class="btn btn-primary btn-sm" onclick="MemberUI.editFromDetail()"><i class="bi bi-pencil"></i> 編輯</button>
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 活動 Modal -->
        <div class="modal fade" id="activityModal" tabindex="-1">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-info text-white">
                <h6 class="modal-title"><i class="bi bi-calendar-event me-2"></i><span id="activityModalTitle">新增活動</span></h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="activityForm">
                  <input type="hidden" id="activityId">
                  <div class="row g-3">
                    <div class="col-lg-8">
                      <label class="form-label">活動名稱 *</label>
                      <input id="activityName" class="form-control" required>
                      <div class="row g-2 mt-2">
                        <div class="col-md-6">
                          <label class="form-label">活動類型 *</label>
                          <select id="activityType" class="form-select" required>
                            <option value="">選擇</option>
                            <option value="講座">講座</option>
                            <option value="聚會">聚會</option>
                            <option value="旅遊">旅遊</option>
                            <option value="運動">運動</option>
                            <option value="志工">志工服務</option>
                            <option value="其他">其他</option>
                          </select>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">狀態</label>
                          <select id="activityStatus" class="form-select">
                            <option value="draft">草稿</option>
                            <option value="published">已發布</option>
                            <option value="registration">報名中</option>
                            <option value="full">已額滿</option>
                            <option value="closed">已結束</option>
                            <option value="cancelled">已取消</option>
                          </select>
                        </div>
                      </div>
                      <div class="row g-2 mt-2">
                        <div class="col-md-6">
                          <label class="form-label">活動日期 *</label>
                          <input id="activityDate" type="date" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">活動時間</label>
                          <input id="activityTime" type="time" class="form-control">
                        </div>
                      </div>
                      <div class="row g-2 mt-2">
                        <div class="col-md-6">
                          <label class="form-label">報名開始</label>
                          <input id="regStartDate" type="date" class="form-control">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">報名截止</label>
                          <input id="regEndDate" type="date" class="form-control">
                        </div>
                      </div>
                      <label class="form-label mt-2">地點</label>
                      <input id="activityLocation" class="form-control" placeholder="可留空">
                      <label class="form-label mt-2">活動描述</label>
                      <textarea id="activityDescription" rows="4" class="form-control"></textarea>
                    </div>
                    <div class="col-lg-4">
                      <label class="form-label">活動圖片</label>
                      <input id="activityImage" type="file" accept="image/*" class="form-control" onchange="ActivityUI.previewImage(event)">
                      <div id="activityImagePreview" class="mt-2"></div>
                      <div class="row g-2 mt-1">
                        <div class="col-6">
                          <label class="form-label mt-2">人數上限</label>
                          <input id="activityMax" type="number" min="1" value="50" class="form-control">
                        </div>
                        <div class="col-6">
                          <label class="form-label mt-2">費用</label>
                          <input id="activityFee" type="number" min="0" value="0" class="form-control">
                        </div>
                      </div>
                      <label class="form-label mt-2">聯絡人</label>
                      <input id="activityContact" class="form-control">
                      <label class="form-label mt-2">聯絡電話</label>
                      <input id="activityContactPhone" class="form-control">
                      <label class="form-label mt-2">備註</label>
                      <textarea id="activityNotes" rows="3" class="form-control"></textarea>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 活動詳情 -->
        <div class="modal fade" id="activityDetailModal" tabindex="-1">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-info text-white">
                <h6 class="modal-title"><i class="bi bi-info-circle me-2"></i>活動詳情</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="activityDetailContent"></div>
              <div class="modal-footer">
                <button id="activityRegisterBtn" class="btn btn-success btn-sm" onclick="Registrations.openRegister()" style="display:none;"><i class="bi bi-person-plus"></i> 我要報名</button>
                <button class="btn btn-outline-primary btn-sm" onclick="ActivityUI.editFromDetail()"><i class="bi bi-pencil"></i> 編輯</button>
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 活動報名 -->
        <div class="modal fade" id="registrationModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-success text-white">
                <h6 class="modal-title"><i class="bi bi-person-plus me-2"></i>活動報名</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div id="registrationActivityInfo" class="alert alert-info small mb-3"></div>
                <form id="registrationForm">
                  <input type="hidden" id="registrationActivityId">
                  <div class="mb-2 fw-semibold">報名身份</div>
                  <div class="d-flex gap-3 mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="regType" id="regExisting" value="existing" checked onchange="Registrations.toggleMode()">
                      <label class="form-check-label" for="regExisting">現有會員</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="regType" id="regNew" value="new" onchange="Registrations.toggleMode()">
                      <label class="form-check-label" for="regNew">新報名者</label>
                    </div>
                  </div>
                  <div id="regExistingBox" class="mb-3">
                    <label class="form-label">選擇會員 *</label>
                    <select id="regMemberSelect" class="form-select"></select>
                  </div>
                  <div id="regNewBox" class="mb-3" style="display:none;">
                    <div class="row g-2">
                      <div class="col-md-6">
                        <label class="form-label">姓名 *</label>
                        <input id="regName" class="form-control">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">電話 *</label>
                        <input id="regPhone" class="form-control">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input id="regEmail" type="email" class="form-control">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">緊急聯絡人</label>
                        <input id="regEmergency" class="form-control">
                      </div>
                    </div>
                  </div>
                  <label class="form-label">備註 / 特殊需求</label>
                  <textarea id="regNotes" rows="2" class="form-control" placeholder="飲食限制 / 行動協助等"></textarea>
                  <div class="form-check mt-3">
                    <input id="regAgree" type="checkbox" class="form-check-input">
                    <label for="regAgree" class="form-check-label">我同意活動條款並確認資料正確</label>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-success btn-sm" onclick="Registrations.submit()"><i class="bi bi-check-circle me-1"></i>送出</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 公告 Modal -->
        <div class="modal fade" id="announcementModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-warning">
                <h6 class="modal-title"><i class="bi bi-megaphone me-2"></i><span id="announcementModalTitle">新增公告</span></h6>
                <button class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="announcementForm">
                  <input type="hidden" id="announcementId">
                  <label class="form-label">標題 *</label>
                  <input id="announcementTitle" class="form-control" required>
                  <div class="row g-2 mt-2">
                    <div class="col-md-4">
                      <label class="form-label">類型</label>
                      <select id="announcementType" class="form-select">
                        <option value="normal">一般</option>
                        <option value="urgent">緊急</option>
                        <option value="event">活動相關</option>
                        <option value="system">系統公告</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">狀態</label>
                      <select id="announcementStatus" class="form-select">
                        <option value="draft">草稿</option>
                        <option value="published">已發布</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">置頂</label>
                      <div class="form-check">
                        <input id="announcementPinned" type="checkbox" class="form-check-input">
                        <label class="form-check-label" for="announcementPinned">置頂公告</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label mt-2">發布日期</label>
                      <input id="announcementPublishDate" type="date" class="form-control">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label mt-2">過期日期</label>
                      <input id="announcementExpireDate" type="date" class="form-control">
                    </div>
                  </div>
                  <label class="form-label mt-2">內容 *</label>
                  <textarea id="announcementContent" rows="6" class="form-control" required></textarea>
                  <label class="form-label mt-2">相關連結</label>
                  <input id="announcementLink" type="url" class="form-control" placeholder="https://">
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-warning btn-sm" onclick="AnnouncementUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 帳戶管理 Modal -->
        <div class="modal fade" id="accountManagerModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h6 class="modal-title"><i class="bi bi-bank me-2"></i>帳戶管理</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="d-flex justify-content-end mb-2">
                  <button class="btn btn-sm btn-primary" onclick="AccountUI.openEditor()"><i class="bi bi-plus-circle"></i> 新增帳戶</button>
                </div>
                <div class="table-responsive">
                  <table class="table table-hover align-middle">
                    <thead>
                      <tr>
                        <th>名稱</th><th>說明</th><th class="text-end">初始</th><th class="text-end">目前</th><th>狀態</th><th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="accountTableBody">
                      <tr><td colspan="6" class="text-center text-muted py-4">尚無帳戶</td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="small text-muted">提示：有交易的帳戶不可刪除，可改停用。</div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 帳戶編輯 Modal -->
        <div class="modal fade" id="accountEditModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h6 class="modal-title"><i class="bi bi-wallet2 me-2"></i><span id="accountEditTitle">新增帳戶</span></h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="accountForm">
                  <input type="hidden" id="accountId">
                  <label class="form-label">帳戶名稱 *</label>
                  <input id="accountName" class="form-control" required>
                  <label class="form-label mt-2">說明</label>
                  <textarea id="accountDesc" rows="2" class="form-control"></textarea>
                  <label class="form-label mt-2">初始餘額</label>
                  <input id="accountInitial" type="number" step="0.01" value="0" class="form-control">
                  <label class="form-label mt-2">備註</label>
                  <textarea id="accountNotes" rows="2" class="form-control"></textarea>
                  <div class="form-check mt-2">
                    <input id="accountActive" type="checkbox" class="form-check-input" checked>
                    <label class="form-check-label" for="accountActive">啟用帳戶</label>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-primary btn-sm" onclick="AccountUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 行政表單管理 Modal -->
        <div class="modal fade" id="formManagerModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h6 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>表單管理</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="d-flex justify-content-end mb-2">
                  <button class="btn btn-sm btn-primary" onclick="FormUI.openEditor()"><i class="bi bi-plus-circle"></i> 新增表單</button>
                </div>
                <div class="table-responsive">
                  <table class="table table-hover align-middle">
                    <thead>
                      <tr>
                        <th>名稱</th><th>分類</th><th>連結</th><th>關鍵字</th><th>狀態</th><th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="formTableBody">
                      <tr><td colspan="6" class="text-center text-muted py-4">尚無表單</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 表單編輯 Modal -->
        <div class="modal fade" id="formEditModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h6 class="modal-title"><i class="bi bi-file-plus me-2"></i><span id="formEditTitle">新增表單</span></h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="formEditForm">
                  <input type="hidden" id="formId">
                  <label class="form-label">名稱 *</label>
                  <input id="formName" class="form-control" required>
                  <label class="form-label mt-2">分類 *</label>
                  <select id="formCategory" class="form-select" required>
                    <option value="">選擇</option>
                    <option value="會員">會員</option>
                    <option value="財務">財務</option>
                    <option value="活動">活動</option>
                    <option value="行政">行政</option>
                    <option value="其他">其他</option>
                  </select>
                  <label class="form-label mt-2">檔案連結 *</label>
                  <input id="formUrl" type="url" class="form-control" placeholder="https://" required>
                  <label class="form-label mt-2">關鍵字 (逗號)</label>
                  <input id="formKeywords" class="form-control">
                  <label class="form-label mt-2">說明</label>
                  <textarea id="formDescription" rows="3" class="form-control"></textarea>
                  <div class="form-check mt-2">
                    <input id="formActive" type="checkbox" class="form-check-input" checked>
                    <label class="form-check-label" for="formActive">啟用</label>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-primary btn-sm" onclick="FormUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 系統設定 Modal -->
        <div class="modal fade" id="settingsModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h6 class="modal-title"><i class="bi bi-sliders me-2"></i>系統設定</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="settingsForm" class="row gy-3">
                  <div class="col-md-6">
                    <h6 class="fw-semibold mb-2">組織資訊</h6>
                    <label class="form-label">組織名稱</label>
                    <input id="setOrgName" class="form-control">
                    <label class="form-label mt-2">地址</label>
                    <textarea id="setOrgAddress" rows="2" class="form-control"></textarea>
                    <label class="form-label mt-2">電話</label>
                    <input id="setOrgPhone" class="form-control">
                    <label class="form-label mt-2">Email</label>
                    <input id="setOrgEmail" type="email" class="form-control">
                    <label class="form-label mt-2">預設年費</label>
                    <input id="setDefaultFee" type="number" class="form-control" value="1000" min="0">
                  </div>
                  <div class="col-md-6">
                    <h6 class="fw-semibold mb-2">系統 / 編號 / 印章</h6>
                    <label class="form-label">收據前綴</label>
                    <input id="setReceiptPrefix" class="form-control" maxlength="5">
                    <label class="form-label mt-2">憑證前綴</label>
                    <input id="setVoucherPrefix" class="form-control" maxlength="5">
                    <label class="form-label mt-2">出納章文字</label>
                    <input id="setSealTreasurer" class="form-control">
                    <label class="form-label mt-2">會計章文字</label>
                    <input id="setSealAccountant" class="form-control">
                    <label class="form-label mt-2">理事長章文字</label>
                    <input id="setSealChairman" class="form-control">
                    <div class="form-check mt-3">
                      <input id="setAutoBackup" type="checkbox" class="form-check-input">
                      <label for="setAutoBackup" class="form-check-label">啟用自動備份</label>
                    </div>
                    <div class="form-check mt-2">
                      <input id="setNotifications" type="checkbox" class="form-check-input">
                      <label for="setNotifications" class="form-check-label">啟用通知提醒</label>
                    </div>
                  </div>

                  <div class="col-12">
                    <h6 class="fw-semibold mt-3 mb-2">交易類別管理</h6>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <div class="border p-2 rounded">
                          <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-semibold">收入類別</span>
                            <div class="input-group input-group-sm" style="width:180px;">
                              <input id="newIncomeCat" class="form-control" placeholder="新增">
                              <button class="btn btn-outline-primary" onclick="SettingsUI.addCategory('收入')">+</button>
                            </div>
                          </div>
                          <div id="incomeCategoryList" class="d-flex flex-wrap gap-1"></div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="border p-2 rounded">
                          <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-semibold">支出類別</span>
                            <div class="input-group input-group-sm" style="width:180px;">
                              <input id="newExpenseCat" class="form-control" placeholder="新增">
                              <button class="btn btn-outline-primary" onclick="SettingsUI.addCategory('支出')">+</button>
                            </div>
                          </div>
                          <div id="expenseCategoryList" class="d-flex flex-wrap gap-1"></div>
                        </div>
                      </div>
                    </div>
                    <div class="small text-muted mt-2">點擊標籤可刪除類別（刪除不影響既有交易，但建議先確認不再使用）。</div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-danger btn-sm me-auto" onclick="SettingsUI.resetCategoryConfirm()">重置預設類別</button>
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-primary btn-sm" onclick="SettingsUI.save()"><i class="bi bi-save me-1"></i>儲存設定</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 批次匯入 Modal -->
        <div class="modal fade" id="batchImportModal" tabindex="-1">
          <div class="modal-dialog modal-fullscreen-lg-down modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-secondary text-white">
                <h6 class="modal-title"><i class="bi bi-cloud-upload me-2"></i>批次匯入</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <ul class="nav nav-tabs" id="batchTabs">
                  <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#batchTxnTab">交易匯入</button>
                  </li>
                  <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#batchMemberTab">會員匯入</button>
                  </li>
                </ul>
                <div class="tab-content pt-3">
                  <!-- 交易匯入 -->
                  <div id="batchTxnTab" class="tab-pane fade show active">
                    <div class="row g-3">
                      <div class="col-lg-3">
                        <div class="border p-3 rounded h-100">
                          <h6 class="fw-semibold mb-2"><i class="bi bi-file-earmark-spreadsheet"></i> 上傳檔案</h6>
                          <input id="batchTxFile" type="file" accept=".xlsx,.xls,.csv" class="form-control form-control-sm mb-2" onchange="BatchImport.handleFile('transactions')">
                          <div class="d-grid gap-2 mb-2">
                            <button class="btn btn-outline-secondary btn-sm" onclick="BatchImport.downloadTemplate('transactions')"><i class="bi bi-download"></i> 範本</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="BatchImport.reparse('transactions')"><i class="bi bi-arrow-clockwise"></i> 重新解析</button>
                            <button class="btn btn-outline-danger btn-sm" onclick="BatchImport.clear('transactions')"><i class="bi bi-x-circle"></i> 清除</button>
                          </div>
                          <hr>
                          <h6 class="fw-semibold mb-2"><i class="bi bi-link"></i> 欄位對應</h6>
                          <div id="batchTxFieldMap" class="small"></div>
                          <hr>
                          <div class="form-check">
                            <input id="batchTxSkipError" type="checkbox" class="form-check-input" checked>
                            <label class="form-check-label" for="batchTxSkipError">略過錯誤列</label>
                          </div>
                          <div class="form-check">
                            <input id="batchTxSkipDup" type="checkbox" class="form-check-input" checked>
                            <label class="form-check-label" for="batchTxSkipDup">略過重複</label>
                          </div>
                        </div>
                      </div>
                      <div class="col-lg-9">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <span id="batchTxStats" class="badge bg-secondary">尚未載入資料</span>
                          <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-warning" onclick="BatchImport.filterPreview('transactions','errors')"><i class="bi bi-exclamation-triangle"></i> 錯誤</button>
                            <button class="btn btn-sm btn-outline-info" onclick="BatchImport.filterPreview('transactions','duplicates')"><i class="bi bi-files"></i> 重複</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="BatchImport.filterPreview('transactions','all')"><i class="bi bi-list-ul"></i> 全部</button>
                            <button class="btn btn-sm btn-success" onclick="BatchImport.commit('transactions')"><i class="bi bi-check-circle"></i> 匯入</button>
                          </div>
                        </div>
                        <div class="table-responsive" style="max-height:420px;overflow:auto;">
                          <table class="table table-sm table-hover align-middle mb-0">
                            <thead id="batchTxHead" class="table-light"></thead>
                            <tbody id="batchTxBody">
                              <tr><td class="text-muted">尚未載入檔案</td></tr>
                            </tbody>
                          </table>
                        </div>
                        <div class="small text-muted mt-1">預覽僅顯示前 200 筆，實際匯入包含全部已選資料。</div>
                      </div>
                    </div>
                  </div>
                  <!-- 會員匯入 -->
                  <div id="batchMemberTab" class="tab-pane fade">
                    <div class="row g-3">
                      <div class="col-lg-3">
                        <div class="border p-3 rounded h-100">
                          <h6 class="fw-semibold mb-2"><i class="bi bi-file-earmark-person"></i> 上傳檔案</h6>
                          <input id="batchMemberFile" type="file" accept=".xlsx,.xls,.csv" class="form-control form-control-sm mb-2" onchange="BatchImport.handleFile('members')">
                          <div class="d-grid gap-2 mb-2">
                            <button class="btn btn-outline-secondary btn-sm" onclick="BatchImport.downloadTemplate('members')"><i class="bi bi-download"></i> 範本</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="BatchImport.reparse('members')"><i class="bi bi-arrow-clockwise"></i> 重解析</button>
                            <button class="btn btn-outline-danger btn-sm" onclick="BatchImport.clear('members')"><i class="bi bi-x-circle"></i> 清除</button>
                          </div>
                          <hr>
                          <h6 class="fw-semibold mb-2"><i class="bi bi-link"></i> 欄位對應</h6>
                          <div id="batchMemberFieldMap" class="small"></div>
                          <hr>
                          <div class="form-check">
                            <input id="batchMemberSkipError" type="checkbox" class="form-check-input" checked>
                            <label class="form-check-label" for="batchMemberSkipError">略過錯誤列</label>
                          </div>
                          <div class="form-check">
                            <input id="batchMemberSkipDup" type="checkbox" class="form-check-input" checked>
                            <label class="form-check-label" for="batchMemberSkipDup">略過重複</label>
                          </div>
                          <div class="mt-2">
                            <label class="form-label small">預設年費（若匯入未填）</label>
                            <input id="batchMemberDefaultFee" type="number" value="1000" class="form-control form-control-sm">
                          </div>
                        </div>
                      </div>
                      <div class="col-lg-9">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <span id="batchMemberStats" class="badge bg-secondary">尚未載入資料</span>
                          <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-warning" onclick="BatchImport.filterPreview('members','errors')"><i class="bi bi-exclamation-triangle"></i> 錯誤</button>
                            <button class="btn btn-sm btn-outline-info" onclick="BatchImport.filterPreview('members','duplicates')"><i class="bi bi-files"></i> 重複</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="BatchImport.filterPreview('members','all')"><i class="bi bi-list-ul"></i> 全部</button>
                            <button class="btn btn-sm btn-success" onclick="BatchImport.commit('members')"><i class="bi bi-check-circle"></i> 匯入</button>
                          </div>
                        </div>
                        <div class="table-responsive" style="max-height:420px;overflow:auto;">
                          <table class="table table-sm table-hover align-middle mb-0">
                            <thead id="batchMemberHead" class="table-light"></thead>
                            <tbody id="batchMemberBody">
                              <tr><td class="text-muted">尚未載入檔案</td></tr>
                            </tbody>
                          </table>
                        </div>
                        <div class="small text-muted mt-1">預覽僅顯示前 200 筆，實際匯入包含全部已選資料。</div>
                      </div>
                    </div>
                  </div>
                </div>
                <hr>
                <div class="alert alert-info small mb-0">
                  提示：匯入後請至對應頁面確認結果。欄位未對應者會忽略。可透過「略過錯誤」與「略過重複」加速處理。
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 報表 Modal -->
        <div class="modal fade" id="reportModal" tabindex="-1">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-dark text-white">
                <h6 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i><span id="reportModalTitle">報表</span></h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="reportModalBody">
                <!-- 動態報表 -->
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-primary btn-sm" onclick="Reports.print()"><i class="bi bi-printer"></i> 列印</button>
                <button class="btn btn-primary btn-sm" onclick="Reports.exportHTML()"><i class="bi bi-download"></i> 匯出</button>
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Google Sync Modal -->
        <div class="modal fade" id="googleSyncModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header bg-info text-white">
                <h6 class="modal-title"><i class="bi bi-cloud-arrow-up me-2"></i>雲端同步設定</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="alert alert-info small">
                  此為示意設定，正式串接 Google Drive / API 時於 GoogleSync.connect / sync / restore 介面實作。
                </div>
                <div class="form-check mb-2">
                  <input id="gsEnable" type="checkbox" class="form-check-input" onchange="GoogleSync.togglePanel()">
                  <label class="form-check-label" for="gsEnable">啟用雲端同步</label>
                </div>
                <div id="gsPanel" style="display:none;">
                  <label class="form-label">同步頻率</label>
                  <select id="gsInterval" class="form-select form-select-sm mb-2">
                    <option value="manual">手動</option>
                    <option value="5">每 5 分鐘</option>
                    <option value="15">每 15 分鐘</option>
                    <option value="30">每 30 分鐘</option>
                    <option value="60">每小時</option>
                  </select>
                  <div class="d-flex gap-2 flex-wrap">
                    <button id="gsConnectBtn" class="btn btn-outline-primary btn-sm" onclick="GoogleSync.connect()"><i class="bi bi-link-45deg"></i> 連接</button>
                    <button id="gsSyncBtn" class="btn btn-outline-success btn-sm" disabled onclick="GoogleSync.sync()"><i class="bi bi-cloud-upload"></i> 立即同步</button>
                    <button id="gsRestoreBtn" class="btn btn-outline-warning btn-sm" disabled onclick="GoogleSync.restore()"><i class="bi bi-cloud-download"></i> 雲端還原</button>
                  </div>
                  <div class="small text-muted mt-2" id="gsStatus">尚未連線</div>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
                <button class="btn btn-info btn-sm text-white" onclick="GoogleSync.saveSettings()"><i class="bi bi-save"></i> 儲存設定</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 全域 Toast 容器 -->
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:2000;">
          <div id="toastSuccess" class="toast align-items-center border-0" role="alert">
            <div class="d-flex">
              <div class="toast-body"><i class="bi bi-check-circle text-success me-2"></i><span id="toastSuccessMsg">成功</span></div>
              <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
          <div id="toastError" class="toast align-items-center border-0" role="alert">
            <div class="d-flex">
              <div class="toast-body"><i class="bi bi-exclamation-triangle text-danger me-2"></i><span id="toastErrorMsg">錯誤</span></div>
              <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
        </div>

        <!-- =========================================================
             PART 4/5  ─────────────  核心 JavaScript
             ========================================================= -->
      </main>
    </div>
  </div>

  <!-- 依賴套件 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
// ============================================================================
// 配置設定
// ============================================================================
    const CONFIG = {
      GAS_URL: 'https://script.google.com/macros/s/AKfycbxzlDi02TVjxwjzfbsRwwwyHEPDb6dLTuY7fSeBqMzNMzSuRCnRNDbu_FyipWiB5ei4bw/exec', // 請替換為實際的GAS URL
      TIMEOUT: 30000 // 30秒超時
    };

    // ============================================================================
    // API 核心
    // ============================================================================
    const API = {
      async call(action, data = {}) {
        try {
          UI.showLoading(true);
          
          const payload = { action, params: data };
          const response = await fetch(CONFIG.GAS_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const result = await response.json();
          
          if (!result.success) {
            throw new Error(result.error || '未知錯誤');
          }
          
          return result;
        } catch (error) {
          console.error('API Error:', error);
          UI.showToast('error', `API 錯誤: ${error.message}`);
          throw error;
        } finally {
          UI.showLoading(false);
        }
      },

      // 初始化資料庫
      async initializeSheets() {
        try {
          const result = await this.call('initializeSheets');
          UI.showToast('success', result.data.message || '資料庫初始化完成');
          return result;
        } catch (error) {
          UI.showToast('error', '資料庫初始化失敗');
          throw error;
        }
      },

      // 交易相關
      async getTransactions(params = {}) {
        const result = await this.call('getTransactions', params);
        return result.data;
      },

      async saveTransaction(data) {
        const result = await this.call('saveTransaction', data);
        return result.data;
      },

      async deleteTransaction(id) {
        const result = await this.call('deleteTransaction', { id });
        return result.data;
      },

      // 會員相關
      async getMembers(params = {}) {
        const result = await this.call('getMembers', params);
        return result.data;
      },

      async saveMember(data) {
        const result = await this.call('saveMember', data);
        return result.data;
      },

      async deleteMember(id) {
        const result = await this.call('deleteMember', { id });
        return result.data;
      },

      // 帳戶相關
      async getAccounts() {
        const result = await this.call('getAccounts');
        return result.data;
      },

      async saveAccount(data) {
        const result = await this.call('saveAccount', data);
        return result.data;
      },

      async deleteAccount(id) {
        const result = await this.call('deleteAccount', { id });
        return result.data;
      },

      // 活動相關
      async getActivities(params = {}) {
        const result = await this.call('getActivities', params);
        return result.data;
      },

      async saveActivity(data) {
        const result = await this.call('saveActivity', data);
        return result.data;
      },

      async deleteActivity(id) {
        const result = await this.call('deleteActivity', { id });
        return result.data;
      },

      // 報名相關
      async getRegistrations(params = {}) {
        const result = await this.call('getRegistrations', params);
        return result.data;
      },

      async saveRegistration(data) {
        const result = await this.call('saveRegistration', data);
        return result.data;
      },

      async deleteRegistration(id) {
        const result = await this.call('deleteRegistration', { id });
        return result.data;
      },

      // 公告相關
      async getAnnouncements(params = {}) {
        const result = await this.call('getAnnouncements', params);
        return result.data;
      },

      async saveAnnouncement(data) {
        const result = await this.call('saveAnnouncement', data);
        return result.data;
      },

      async deleteAnnouncement(id) {
        const result = await this.call('deleteAnnouncement', { id });
        return result.data;
      },

      // 表單相關
      async getForms() {
        const result = await this.call('getForms');
        return result.data;
      },

      async saveForm(data) {
        const result = await this.call('saveForm', data);
        return result.data;
      },

      async deleteForm(id) {
        const result = await this.call('deleteForm', { id });
        return result.data;
      },

      // 設定相關
      async getSettings() {
        const result = await this.call('getSettings');
        return result.data;
      },

      async saveSettings(data) {
        const result = await this.call('saveSettings', data);
        return result.data;
      },

      // 統計相關
      async getDashboardStats() {
        const result = await this.call('getDashboardStats');
        return result.data;
      },

      async getAnalyticsData(params) {
        const result = await this.call('getAnalyticsData', params);
        return result.data;
      },

      // 報表相關
      async generateReport(params) {
        const result = await this.call('generateReport', params);
        return result.data;
      }
    };

    // ============================================================================
    // UI 工具函數
    // ============================================================================
    const UI = {
      formatNumber(num) {
        return (Number(num) || 0).toLocaleString();
      },

      formatDate(date) {
        if (!date) return '';
        const d = new Date(date);
        return d.toISOString().split('T')[0];
      },

      showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          overlay.style.display = show ? 'flex' : 'none';
        }
      },

      showToast(type, message) {
        const toastId = type === 'success' ? 'toastSuccess' : 'toastError';
        const msgId = type === 'success' ? 'toastSuccessMsg' : 'toastErrorMsg';
        
        const toastEl = document.getElementById(toastId);
        const msgEl = document.getElementById(msgId);
        
        if (toastEl && msgEl) {
          msgEl.textContent = message;
          const toast = new bootstrap.Toast(toastEl);
          toast.show();
        } else {
          // 備用方案
          alert(`${type.toUpperCase()}: ${message}`);
        }
      },

      confirm(options) {
        return Swal.fire({
          title: options.title,
          text: options.text,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: options.confirmColor || '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: '確定',
          cancelButtonText: '取消'
        });
      },

      prompt(options) {
        return Swal.fire({
          title: options.title,
          input: options.input || 'text',
          inputLabel: options.inputLabel,
          inputValue: options.inputValue || '',
          showCancelButton: true,
          confirmButtonText: '確定',
          cancelButtonText: '取消',
          inputValidator: options.validator
        });
      }
    };

    // ============================================================================
    // 儀表板模組
    // ============================================================================
    const Dashboard = {
      async refresh() {
        try {
          const stats = await API.getDashboardStats();
          
          // 更新統計卡片
          this.updateStatsCards(stats);
          
          // 更新帳戶餘額
          this.renderAccountBalances(stats.accounts || []);
          
          // 更新最近資料
          this.renderRecentTransactions(stats.recentTransactions || []);
          this.renderRecentMembers(stats.recentMembers || []);
          
        } catch (error) {
          console.error('載入儀表板失敗:', error);
          document.getElementById('dashboardContent').innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>載入儀表板失敗: ${error.message}
            </div>
          `;
        }
      },

      updateStatsCards(stats) {
        const elements = {
          'dashTotalIncome': stats.totalIncome,
          'dashTotalExpense': stats.totalExpense,
          'dashMonthIncome': stats.monthIncome,
          'dashMonthExpense': stats.monthExpense,
          'dashTotalBalance': stats.totalBalance,
          'dashAccountCount': stats.accountCount,
          'dashMemberTotal': stats.memberTotal,
          'dashMemberOverdue': stats.overdueMembers
        };

        Object.entries(elements).forEach(([id, value]) => {
          const el = document.getElementById(id);
          if (el) {
            if (id.includes('Count') || id.includes('Total') || id.includes('Overdue')) {
              el.textContent = value || 0;
            } else {
              el.textContent = '$' + UI.formatNumber(value || 0);
            }
          }
        });
      },

      renderAccountBalances(accounts) {
        const container = document.getElementById('dashboardAccountBalances');
        if (!container) return;

        if (!accounts.length) {
          container.innerHTML = '<div class="col-12 text-muted">尚無帳戶</div>';
          return;
        }
        
        container.innerHTML = accounts.map(account => `
          <div class="col-6 col-md-3">
            <div class="border rounded p-2 h-100 small bg-white">
              <div class="d-flex justify-content-between">
                <span class="fw-semibold">${account['名稱'] || ''}</span>
                <span class="badge ${account['狀態'] === '啟用' ? 'bg-success' : 'bg-secondary'}">${account['狀態'] || ''}</span>
              </div>
              <div class="mt-1">
                <span class="text-muted">餘額：</span>
                <span class="${(account['目前餘額'] || 0) >= 0 ? 'text-success' : 'text-danger'} fw-semibold">$${UI.formatNumber(account['目前餘額'] || 0)}</span>
              </div>
            </div>
          </div>
        `).join('');
      },

      renderRecentTransactions(transactions) {
        const container = document.getElementById('dashboardRecentTx');
        if (!container) return;

        if (!transactions.length) {
          container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易</div>';
          return;
        }
        
        container.innerHTML = transactions.map(tx => `
          <div class="d-flex justify-content-between align-items-center border-bottom py-2 small">
            <div>
              <div class="fw-semibold">${tx['類別'] || ''}</div>
              <div class="text-muted">${tx['日期'] || ''} ${tx['對象'] || ''}</div>
            </div>
            <div class="text-end">
              <span class="badge ${tx['類型'] === '收入' ? 'bg-success' : 'bg-danger'}">${tx['類型'] === '收入' ? '+' : '-'}$${UI.formatNumber(tx['金額'] || 0)}</span>
            </div>
          </div>
        `).join('');
      },

      renderRecentMembers(members) {
        const container = document.getElementById('dashboardRecentMembers');
        if (!container) return;

        if (!members.length) {
          container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員</div>';
          return;
        }
        
        container.innerHTML = members.map(member => `
          <div class="d-flex align-items-center border-bottom py-2 small">
            <div class="member-avatar me-2">${(member['姓名'] || '').charAt(0)}</div>
            <div class="flex-grow-1">
              <div class="fw-semibold">${member['姓名'] || ''}</div>
              <div class="text-muted">${member['加入日期'] || ''}</div>
            </div>
            <span class="badge ${this.getStatusBadgeClass(member['狀態'])}">${this.getStatusText(member['狀態'])}</span>
          </div>
        `).join('');
      },

      getStatusBadgeClass(status) {
        const classes = {
          'active': 'bg-success',
          'inactive': 'bg-danger',
          'pending': 'bg-warning text-dark'
        };
        return classes[status] || 'bg-secondary';
      },

      getStatusText(status) {
        const texts = {
          'active': '正常',
          'inactive': '停權',
          'pending': '待審核'
        };
        return texts[status] || '未知';
      }
    };

    // ============================================================================
    // 交易模組
    // ============================================================================
    const Transactions = {
      data: [],
      currentPage: 1,
      pageSize: 20,
      filters: {},

      async load(params = {}) {
        try {
          this.data = await API.getTransactions(params);
          this.render();
        } catch (error) {
          document.getElementById('transactionsContent').innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>載入交易記錄失敗: ${error.message}
            </div>
          `;
        }
      },

      render() {
        const container = document.getElementById('transactionsContent');
        if (!container) return;

        if (!this.data.length) {
          container.innerHTML = `
            <div class="text-center py-5 text-muted">
              <i class="bi bi-inbox display-6 d-block mb-2"></i>
              <div>尚無交易記錄</div>
              <button class="btn btn-primary mt-3" onclick="TransactionUI.open()">
                <i class="bi bi-plus-circle me-1"></i>新增第一筆交易
              </button>
            </div>
          `;
          return;
        }

        const startIndex = (this.currentPage - 1) * this.pageSize;
        const endIndex = startIndex + this.pageSize;
        const pageData = this.data.slice(startIndex, endIndex);

        container.innerHTML = `
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>日期</th>
                      <th>類型</th>
                      <th>類別</th>
                      <th>金額</th>
                      <th>對象</th>
                      <th>帳戶</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${pageData.map(tx => `
                      <tr>
                        <td>${tx['日期'] || ''}</td>
                        <td><span class="badge ${tx['類型'] === '收入' ? 'bg-success' : 'bg-danger'}">${tx['類型'] || ''}</span></td>
                        <td>${tx['類別'] || ''}</td>
                        <td class="text-end fw-semibold">${tx['類型'] === '收入' ? '+' : '-'}$${UI.formatNumber(tx['金額'] || 0)}</td>
                        <td>${tx['對象'] || '-'}</td>
                        <td>${tx['帳戶'] || ''}</td>
                        <td>
                          <button class="btn btn-sm btn-outline-primary me-1" onclick="TransactionUI.edit('${tx.ID}')">
                            <i class="bi bi-pencil"></i>
                          </button>
                          <button class="btn btn-sm btn-outline-danger" onclick="Transactions.delete('${tx.ID}')">
                            <i class="bi bi-trash"></i>
                          </button>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
              ${this.renderPagination()}
            </div>
          </div>
        `;
      },

      renderPagination() {
        const totalPages = Math.ceil(this.data.length / this.pageSize);
        if (totalPages <= 1) return '';

        let pagination = '<nav class="mt-3"><ul class="pagination justify-content-center">';
        
        // 上一頁
        pagination += `
          <li class="page-item ${this.currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="Transactions.goToPage(${this.currentPage - 1})">上一頁</a>
          </li>
        `;

        // 頁碼
        for (let i = 1; i <= totalPages; i++) {
          if (i === this.currentPage || i === 1 || i === totalPages || Math.abs(i - this.currentPage) <= 2) {
            pagination += `
              <li class="page-item ${i === this.currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="Transactions.goToPage(${i})">${i}</a>
              </li>
            `;
          } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
            pagination += '<li class="page-item disabled"><span class="page-link">...</span></li>';
          }
        }

        // 下一頁
        pagination += `
          <li class="page-item ${this.currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="Transactions.goToPage(${this.currentPage + 1})">下一頁</a>
          </li>
        `;

        pagination += '</ul></nav>';
        return pagination;
      },

      goToPage(page) {
        const totalPages = Math.ceil(this.data.length / this.pageSize);
        if (page < 1 || page > totalPages) return;
        
        this.currentPage = page;
        this.render();
      },

      async delete(id) {
        const result = await UI.confirm({
          title: '刪除交易',
          text: '確定要刪除此筆交易嗎？',
          confirmColor: '#dc3545'
        });

        if (result.isConfirmed) {
          try {
            await API.deleteTransaction(id);
            UI.showToast('success', '交易已刪除');
            await this.load();
            await Dashboard.refresh();
          } catch (error) {
            UI.showToast('error', '刪除失敗');
          }
        }
      },

      async search(keyword) {
        if (!keyword.trim()) {
          await this.load();
          return;
        }
        
        const filtered = this.data.filter(tx => 
          Object.values(tx).some(value => 
            value && value.toString().toLowerCase().includes(keyword.toLowerCase())
          )
        );
        
        this.data = filtered;
        this.currentPage = 1;
        this.render();
      }
    };

    // ============================================================================
    // 會員模組
    // ============================================================================
    const Members = {
      data: [],
      currentPage: 1,
      pageSize: 20,

      async load(params = {}) {
        try {
          this.data = await API.getMembers(params);
          this.render();
        } catch (error) {
          document.getElementById('membersContent').innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>載入會員資料失敗: ${error.message}
            </div>
          `;
        }
      },

      render() {
        const container = document.getElementById('membersContent');
        if (!container) return;

        if (!this.data.length) {
          container.innerHTML = `
            <div class="text-center py-5 text-muted">
              <i class="bi bi-people display-6 d-block mb-2"></i>
              <div>尚無會員資料</div>
              <button class="btn btn-success mt-3" onclick="MemberUI.open()">
                <i class="bi bi-person-plus me-1"></i>新增第一位會員
              </button>
            </div>
          `;
          return;
        }

        const startIndex = (this.currentPage - 1) * this.pageSize;
        const endIndex = startIndex + this.pageSize;
        const pageData = this.data.slice(startIndex, endIndex);

        container.innerHTML = `
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>姓名</th>
                      <th>電話</th>
                      <th>Email</th>
                      <th>加入日期</th>
                      <th>會員類型</th>
                      <th>狀態</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${pageData.map(member => `
                      <tr>
                        <td>
                          <div class="d-flex align-items-center">
                            <div class="member-avatar me-2">${(member['姓名'] || '').charAt(0)}</div>
                            <div>${member['姓名'] || ''}</div>
                          </div>
                        </td>
                        <td>${member['電話'] || ''}</td>
                        <td>${member['Email'] || '-'}</td>
                        <td>${member['加入日期'] || ''}</td>
                        <td>${this.getMemberTypeText(member['會員類型'])}</td>
                        <td><span class="badge ${Dashboard.getStatusBadgeClass(member['狀態'])}">${Dashboard.getStatusText(member['狀態'])}</span></td>
                        <td>
                          <button class="btn btn-sm btn-outline-primary me-1" onclick="MemberUI.edit('${member.ID}')">
                            <i class="bi bi-pencil"></i>
                          </button>
                          <button class="btn btn-sm btn-outline-danger" onclick="Members.delete('${member.ID}')">
                            <i class="bi bi-trash"></i>
                          </button>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
              ${this.renderPagination()}
            </div>
          </div>
        `;
      },

      renderPagination() {
        const totalPages = Math.ceil(this.data.length / this.pageSize);
        if (totalPages <= 1) return '';

        let pagination = '<nav class="mt-3"><ul class="pagination justify-content-center">';
        
        pagination += `
          <li class="page-item ${this.currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="Members.goToPage(${this.currentPage - 1})">上一頁</a>
          </li>
        `;

        for (let i = 1; i <= totalPages; i++) {
          if (i === this.currentPage || i === 1 || i === totalPages || Math.abs(i - this.currentPage) <= 2) {
            pagination += `
              <li class="page-item ${i === this.currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="Members.goToPage(${i})">${i}</a>
              </li>
            `;
          } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
            pagination += '<li class="page-item disabled"><span class="page-link">...</span></li>';
          }
        }

        pagination += `
          <li class="page-item ${this.currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="Members.goToPage(${this.currentPage + 1})">下一頁</a>
          </li>
        `;

        pagination += '</ul></nav>';
        return pagination;
      },

      goToPage(page) {
        const totalPages = Math.ceil(this.data.length / this.pageSize);
        if (page < 1 || page > totalPages) return;
        
        this.currentPage = page;
        this.render();
      },

      getMemberTypeText(type) {
        const types = {
          'regular': '一般會員',
          'honorary': '榮譽會員',
          'lifetime': '終身會員'
        };
        return types[type] || '一般會員';
      },

      async delete(id) {
        const result = await UI.confirm({
          title: '刪除會員',
          text: '確定要刪除此會員嗎？相關的報名記錄也會一併刪除。',
          confirmColor: '#dc3545'
        });

        if (result.isConfirmed) {
          try {
            await API.deleteMember(id);
            UI.showToast('success', '會員已刪除');
            await this.load();
            await Dashboard.refresh();
          } catch (error) {
            UI.showToast('error', '刪除失敗');
          }
        }
      }
    };

    // ============================================================================
    // 活動模組
    // ============================================================================
    const Activities = {
      data: [],

      async load(params = {}) {
        try {
          this.data = await API.getActivities(params);
          this.render();
        } catch (error) {
          document.getElementById('activitiesContent').innerHTML = `
            <div class="alert alert-danger">載入活動資料失敗: ${error.message}</div>
          `;
        }
      },

      render() {
        const container = document.getElementById('activitiesContent');
        if (!container) return;

        if (!this.data.length) {
          container.innerHTML = `
            <div class="text-center py-5 text-muted">
              <i class="bi bi-calendar-event display-6 d-block mb-2"></i>
              <div>尚無活動</div>
              <button class="btn btn-info text-white mt-3" onclick="ActivityUI.open()">
                <i class="bi bi-calendar-plus me-1"></i>新增第一個活動
              </button>
            </div>
          `;
          return;
        }
        
        container.innerHTML = `
          <div class="row g-3">
            ${this.data.slice(0, 12).map(activity => `
              <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h6 class="card-title">${activity['名稱'] || ''}</h6>
                    <p class="card-text small text-muted">
                      <i class="bi bi-calendar me-1"></i>${activity['日期'] || ''}<br>
                      <i class="bi bi-geo-alt me-1"></i>${activity['地點'] || ''}<br>
                      <i class="bi bi-people me-1"></i>人數上限: ${activity['人數上限'] || '無限制'}
                    </p>
                    <p class="card-text small">${(activity['描述'] || '').substring(0, 80)}${(activity['描述'] || '').length > 80 ? '...' : ''}</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge ${this.getStatusBadgeClass(activity['狀態'])}">${activity['狀態'] || ''}</span>
                      <div>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="ActivityUI.edit('${activity.ID}')">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="Activities.delete('${activity.ID}')">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
          ${this.data.length > 12 ? '<div class="text-muted text-center mt-3">僅顯示前 12 個活動</div>' : ''}
        `;
      },

      getStatusBadgeClass(status) {
        const classes = {
          '報名中': 'bg-success',
          '已結束': 'bg-secondary',
          '已取消': 'bg-danger',
          '籌備中': 'bg-warning text-dark'
        };
        return classes[status] || 'bg-primary';
      },

      async delete(id) {
        const result = await UI.confirm({
          title: '刪除活動',
          text: '確定要刪除此活動嗎？相關的報名記錄也會一併刪除。',
          confirmColor: '#dc3545'
        });

        if (result.isConfirmed) {
          try {
            await API.deleteActivity(id);
            UI.showToast('success', '活動已刪除');
            await this.load();
          } catch (error) {
        UI.showToast('error', '刪除失敗');
      }
    }
  }
};

// ============================================================================
// 公告模組
// ============================================================================
const Announcements = {
  data: [],

  async load(params = {}) {
    try {
      this.data = await API.getAnnouncements(params);
      this.render();
    } catch (error) {
      document.getElementById('announcementsContent').innerHTML = `
        <div class="alert alert-danger">載入公告失敗: ${error.message}</div>
      `;
    }
  },

  render() {
    const container = document.getElementById('announcementsContent');
    if (!container) return;

    if (!this.data.length) {
      container.innerHTML = `
        <div class="text-center py-5 text-muted">
          <i class="bi bi-megaphone display-6 d-block mb-2"></i>
          <div>尚無公告</div>
          <button class="btn btn-warning mt-3" onclick="AnnouncementUI.open()">
            <i class="bi bi-plus-circle me-1"></i>新增第一則公告
          </button>
        </div>
      `;
      return;
    }
    
    container.innerHTML = `
      <div class="row g-3">
        ${this.data.slice(0, 12).map(ann => `
          <div class="col-md-6 col-lg-4">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-title">${ann['標題'] || ''}</h6>
                <p class="card-text small">${(ann['內容'] || '').substring(0, 100)}${(ann['內容'] || '').length > 100 ? '...' : ''}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="badge ${this.getTypeBadgeClass(ann['類型'])}">${ann['類型'] || ''}</span>
                  <small class="text-muted">${ann['發布日期'] || ''}</small>
                </div>
                <div class="mt-2">
                  <button class="btn btn-sm btn-outline-primary me-1" onclick="AnnouncementUI.edit('${ann.ID}')">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="Announcements.delete('${ann.ID}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
      ${this.data.length > 12 ? '<div class="text-muted text-center mt-3">僅顯示前 12 則公告</div>' : ''}
    `;
  },

  getTypeBadgeClass(type) {
    const classes = {
      '重要': 'bg-danger',
      '一般': 'bg-primary',
      '活動': 'bg-info',
      '通知': 'bg-warning text-dark'
    };
    return classes[type] || 'bg-secondary';
  },

  async delete(id) {
    const result = await UI.confirm({
      title: '刪除公告',
      text: '確定要刪除此公告嗎？',
      confirmColor: '#dc3545'
    });

    if (result.isConfirmed) {
      try {
        await API.deleteAnnouncement(id);
        UI.showToast('success', '公告已刪除');
        await this.load();
      } catch (error) {
        UI.showToast('error', '刪除失敗');
      }
    }
  }
};

// ============================================================================
// 表單模組
// ============================================================================
const Forms = {
  data: [],

  async load() {
    try {
      this.data = await API.getForms();
      this.render();
    } catch (error) {
      document.getElementById('formsContent').innerHTML = `
        <div class="alert alert-danger">載入表單失敗: ${error.message}</div>
      `;
    }
  },

  render() {
    const container = document.getElementById('formsContent');
    if (!container) return;

    if (!this.data.length) {
      container.innerHTML = `
        <div class="text-center py-5 text-muted">
          <i class="bi bi-file-earmark-arrow-down display-6 d-block mb-2"></i>
          <div>尚無表單</div>
          <button class="btn btn-primary mt-3" onclick="FormUI.open()">
            <i class="bi bi-plus-circle me-1"></i>新增第一個表單
          </button>
        </div>
      `;
      return;
    }
    
    container.innerHTML = `
      <div class="row g-3">
        ${this.data.map(form => `
          <div class="col-md-6 col-lg-4">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="bi bi-file-earmark-text me-1"></i>
                  ${form['名稱'] || ''}
                </h6>
                <p class="card-text small">${form['說明'] || ''}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="badge bg-secondary">${form['分類'] || ''}</span>
                  <div>
                    <a href="${form['連結'] || '#'}" target="_blank" class="btn btn-sm btn-primary me-1">
                      <i class="bi bi-download"></i> 下載
                    </a>
                    <button class="btn btn-sm btn-outline-danger" onclick="Forms.delete('${form.ID}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  },

  async delete(id) {
    const result = await UI.confirm({
      title: '刪除表單',
      text: '確定要刪除此表單嗎？',
      confirmColor: '#dc3545'
    });

    if (result.isConfirmed) {
      try {
        await API.deleteForm(id);
        UI.showToast('success', '表單已刪除');
        await this.load();
      } catch (error) {
        UI.showToast('error', '刪除失敗');
      }
    }
  }
};

// ============================================================================
// 統計分析模組
// ============================================================================
const Analytics = {
  async load() {
    try {
      const data = await API.getAnalyticsData();
      this.render(data);
    } catch (error) {
      document.getElementById('analyticsContent').innerHTML = `
        <div class="alert alert-danger">載入統計資料失敗: ${error.message}</div>
      `;
    }
  },

  render(data) {
    const container = document.getElementById('analyticsContent');
    if (!container) return;

    container.innerHTML = `
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>月度收支統計</h6>
            </div>
            <div class="card-body">
              <canvas id="monthlyChart" width="400" height="200"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>支出類別分析</h6>
            </div>
            <div class="card-body">
              <canvas id="categoryChart" width="400" height="200"></canvas>
            </div>
          </div>
        </div>
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>會員成長趨勢</h6>
            </div>
            <div class="card-body">
              <canvas id="memberChart" width="800" height="300"></canvas>
            </div>
          </div>
        </div>
      </div>
    `;

    // 這裡可以使用 Chart.js 或其他圖表庫來繪製圖表
    // 目前顯示開發中訊息
    setTimeout(() => {
      document.getElementById('monthlyChart').getContext('2d').fillText('圖表功能開發中', 50, 100);
      document.getElementById('categoryChart').getContext('2d').fillText('圖表功能開發中', 50, 100);
      document.getElementById('memberChart').getContext('2d').fillText('圖表功能開發中', 50, 150);
    }, 100);
  }
};

// ============================================================================
// 報表模組
// ============================================================================
const Reports = {
  async load() {
    const container = document.getElementById('reportsContent');
    if (!container) return;

    container.innerHTML = `
      <div class="row g-4">
        <div class="col-md-6 col-lg-4">
          <div class="card h-100">
            <div class="card-body text-center">
              <i class="bi bi-file-earmark-spreadsheet display-4 text-success mb-3"></i>
              <h6>財務報表</h6>
              <p class="text-muted small">收支明細、資產負債表</p>
              <button class="btn btn-success btn-sm" onclick="Reports.generate('financial')">
                <i class="bi bi-download me-1"></i>產生報表
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-4">
          <div class="card h-100">
            <div class="card-body text-center">
              <i class="bi bi-people-fill display-4 text-primary mb-3"></i>
              <h6>會員報表</h6>
              <p class="text-muted small">會員清單、統計資料</p>
              <button class="btn btn-primary btn-sm" onclick="Reports.generate('member')">
                <i class="bi bi-download me-1"></i>產生報表
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-4">
          <div class="card h-100">
            <div class="card-body text-center">
              <i class="bi bi-calendar-event-fill display-4 text-info mb-3"></i>
              <h6>活動報表</h6>
              <p class="text-muted small">活動清單、報名統計</p>
              <button class="btn btn-info btn-sm text-white" onclick="Reports.generate('activity')">
                <i class="bi bi-download me-1"></i>產生報表
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  },

  async generate(type) {
    try {
      UI.showLoading(true);
      const report = await API.generateReport({ type });
      
      // 創建下載連結
      const blob = new Blob([report.content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = report.filename || `${type}_report_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      
      UI.showToast('success', '報表已下載');
    } catch (error) {
      UI.showToast('error', '報表產生失敗');
    }
  }
};

// ============================================================================
// UI 控制器
// ============================================================================
const TransactionUI = {
  open() {
    Swal.fire({
      title: '新增交易',
      html: `
        <div class="text-start">
          <div class="mb-2">
            <label class="form-label">日期 *</label>
            <input id="txDate" type="date" class="form-control" value="${new Date().toISOString().split('T')[0]}">
          </div>
          <div class="mb-2">
            <label class="form-label">類型 *</label>
            <select id="txType" class="form-select">
              <option value="收入">收入</option>
              <option value="支出">支出</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">類別 *</label>
            <input id="txCategory" class="form-control" placeholder="例：會費、辦公費用、活動費用">
          </div>
          <div class="mb-2">
            <label class="form-label">金額 *</label>
            <input id="txAmount" type="number" class="form-control" min="0" step="0.01">
          </div>
          <div class="mb-2">
            <label class="form-label">對象</label>
            <input id="txCounterparty" class="form-control" placeholder="付款人或收款人">
          </div>
          <div class="mb-2">
            <label class="form-label">帳戶</label>
            <select id="txAccount" class="form-select">
              <option value="現金">現金</option>
              <option value="銀行">銀行</option>
              <option value="郵局">郵局</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">說明</label>
            <textarea id="txDescription" class="form-control" rows="2" placeholder="詳細說明（可選）"></textarea>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: '儲存',
      cancelButtonText: '取消',
      width: '500px',
      preConfirm: () => {
        const data = {
          '日期': document.getElementById('txDate').value,
          '類型': document.getElementById('txType').value,
          '類別': document.getElementById('txCategory').value,
          '金額': parseFloat(document.getElementById('txAmount').value) || 0,
          '對象': document.getElementById('txCounterparty').value,
          '帳戶': document.getElementById('txAccount').value,
          '說明': document.getElementById('txDescription').value
        };
        
        if (!data['日期'] || !data['類別'] || !data['金額']) {
          Swal.showValidationMessage('請填寫必要欄位（日期、類別、金額）');
          return false;
        }
        
        return data;
      }
    }).then(async (result) => {
      if (result.isConfirmed) {
        try {
          await API.saveTransaction(result.value);
          UI.showToast('success', '交易已儲存');
          if (AppLayout.currentSection === 'transactions') {
            await Transactions.load();
          }
          await Dashboard.refresh();
        } catch (error) {
          UI.showToast('error', '儲存失敗');
        }
      }
    });
  },

  edit(id) {
    UI.showToast('info', '編輯功能開發中');
  }
};

const MemberUI = {
  open() {
    Swal.fire({
      title: '新增會員',
      html: `
        <div class="text-start">
          <div class="mb-2">
            <label class="form-label">姓名 *</label>
            <input id="memberName" class="form-control" placeholder="請輸入會員姓名">
          </div>
          <div class="mb-2">
            <label class="form-label">電話 *</label>
            <input id="memberPhone" class="form-control" placeholder="請輸入聯絡電話">
          </div>
          <div class="mb-2">
            <label class="form-label">Email</label>
            <input id="memberEmail" type="email" class="form-control" placeholder="請輸入電子郵件">
          </div>
          <div class="mb-2">
            <label class="form-label">地址</label>
            <input id="memberAddress" class="form-control" placeholder="請輸入地址">
          </div>
          <div class="mb-2">
            <label class="form-label">會員類型</label>
            <select id="memberType" class="form-select">
              <option value="regular">一般會員</option>
              <option value="honorary">榮譽會員</option>
              <option value="lifetime">終身會員</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">年費</label>
            <input id="memberFee" type="number" class="form-control" value="1000" min="0">
          </div>
          <div class="mb-2">
            <label class="form-label">加入日期</label>
            <input id="memberJoinDate" type="date" class="form-control" value="${new Date().toISOString().split('T')[0]}">
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: '儲存',
      cancelButtonText: '取消',
      width: '500px',
      preConfirm: () => {
        const data = {
          '姓名': document.getElementById('memberName').value,
          '電話': document.getElementById('memberPhone').value,
          'Email': document.getElementById('memberEmail').value,
          '地址': document.getElementById('memberAddress').value,
          '會員類型': document.getElementById('memberType').value,
          '年費': parseFloat(document.getElementById('memberFee').value) || 0,
          '加入日期': document.getElementById('memberJoinDate').value,
          '狀態': 'active'
        };
        
        if (!data['姓名'] || !data['電話']) {
          Swal.showValidationMessage('請填寫姓名和電話');
          return false;
        }
        
        return data;
      }
    }).then(async (result) => {
      if (result.isConfirmed) {
        try {
          await API.saveMember(result.value);
          UI.showToast('success', '會員已新增');
          if (AppLayout.currentSection === 'members') {
            await Members.load();
          }
          await Dashboard.refresh();
        } catch (error) {
          UI.showToast('error', '新增失敗');
        }
      }
    });
  },

  edit(id) {
    UI.showToast('info', '編輯功能開發中');
  }
};

const ActivityUI = {
  open() {
    Swal.fire({
      title: '新增活動',
      html: `
        <div class="text-start">
          <div class="mb-2">
            <label class="form-label">活動名稱 *</label>
            <input id="activityName" class="form-control" placeholder="請輸入活動名稱">
          </div>
          <div class="mb-2">
            <label class="form-label">活動日期 *</label>
            <input id="activityDate" type="date" class="form-control">
          </div>
          <div class="mb-2">
            <label class="form-label">活動地點</label>
            <input id="activityLocation" class="form-control" placeholder="請輸入活動地點">
          </div>
          <div class="mb-2">
            <label class="form-label">人數上限</label>
            <input id="activityLimit" type="number" class="form-control" min="0" placeholder="0表示無限制">
          </div>
          <div class="mb-2">
            <label class="form-label">報名費用</label>
            <input id="activityFee" type="number" class="form-control" min="0" value="0">
          </div>
          <div class="mb-2">
            <label class="form-label">活動描述</label>
            <textarea id="activityDescription" class="form-control" rows="3" placeholder="請輸入活動詳細說明"></textarea>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: '儲存',
      cancelButtonText: '取消',
      width: '500px',
      preConfirm: () => {
        const data = {
          '名稱': document.getElementById('activityName').value,
          '日期': document.getElementById('activityDate').value,
          '地點': document.getElementById('activityLocation').value,
          '人數上限': parseInt(document.getElementById('activityLimit').value) || 0,
          '報名費用': parseFloat(document.getElementById('activityFee').value) || 0,
          '描述': document.getElementById('activityDescription').value,
          '狀態': '報名中',
          '建立日期': new Date().toISOString().split('T')[0]
        };
        
        if (!data['名稱'] || !data['日期']) {
          Swal.showValidationMessage('請填寫活動名稱和日期');
          return false;
        }
        
        return data;
      }
    }).then(async (result) => {
      if (result.isConfirmed) {
        try {
          await API.saveActivity(result.value);
          UI.showToast('success', '活動已新增');
          if (AppLayout.currentSection === 'activities') {
            await Activities.load();
          }
        } catch (error) {
          UI.showToast('error', '新增失敗');
        }
      }
    });
  },

  edit(id) {
    UI.showToast('info', '編輯功能開發中');
  }
};

const AnnouncementUI = {
  open() {
    Swal.fire({
      title: '新增公告',
      html: `
        <div class="text-start">
          <div class="mb-2">
            <label class="form-label">公告標題 *</label>
            <input id="announcementTitle" class="form-control" placeholder="請輸入公告標題">
          </div>
          <div class="mb-2">
            <label class="form-label">公告類型</label>
            <select id="announcementType" class="form-select">
              <option value="一般">一般</option>
              <option value="重要">重要</option>
              <option value="活動">活動</option>
              <option value="通知">通知</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">公告內容 *</label>
            <textarea id="announcementContent" class="form-control" rows="4" placeholder="請輸入公告內容"></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">發布日期</label>
            <input id="announcementDate" type="date" class="form-control" value="${new Date().toISOString().split('T')[0]}">
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: '發布',
      cancelButtonText: '取消',
      width: '500px',
      preConfirm: () => {
        const data = {
          '標題': document.getElementById('announcementTitle').value,
          '類型': document.getElementById('announcementType').value,
          '內容': document.getElementById('announcementContent').value,
          '發布日期': document.getElementById('announcementDate').value,
          '狀態': '已發布'
        };
        
        if (!data['標題'] || !data['內容']) {
          Swal.showValidationMessage('請填寫標題和內容');
          return false;
        }
        
        return data;
      }
    }).then(async (result) => {
      if (result.isConfirmed) {
        try {
          await API.saveAnnouncement(result.value);
          UI.showToast('success', '公告已發布');
          if (AppLayout.currentSection === 'announcements') {
            await Announcements.load();
          }
        } catch (error) {
          UI.showToast('error', '發布失敗');
        }
      }
    });
  },

  edit(id) {
    UI.showToast('info', '編輯功能開發中');
  }
};

const FormUI = {
  open() {
    Swal.fire({
      title: '新增表單',
      html: `
        <div class="text-start">
          <div class="mb-2">
            <label class="form-label">表單名稱 *</label>
            <input id="formName" class="form-control" placeholder="請輸入表單名稱">
          </div>
          <div class="mb-2">
            <label class="form-label">表單分類</label>
            <select id="formCategory" class="form-select">
              <option value="會員">會員相關</option>
              <option value="活動">活動相關</option>
              <option value="財務">財務相關</option>
              <option value="其他">其他</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">表單連結 *</label>
            <input id="formLink" class="form-control" placeholder="請輸入表單下載連結">
          </div>
          <div class="mb-2">
            <label class="form-label">表單說明</label>
            <textarea id="formDescription" class="form-control" rows="2" placeholder="請輸入表單說明"></textarea>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: '儲存',
      cancelButtonText: '取消',
      width: '500px',
      preConfirm: () => {
        const data = {
          '名稱': document.getElementById('formName').value,
          '分類': document.getElementById('formCategory').value,
          '連結': document.getElementById('formLink').value,
          '說明': document.getElementById('formDescription').value,
          '建立日期': new Date().toISOString().split('T')[0]
        };
        
        if (!data['名稱'] || !data['連結']) {
          Swal.showValidationMessage('請填寫表單名稱和連結');
          return false;
        }
        
        return data;
      }
    }).then(async (result) => {
      if (result.isConfirmed) {
        try {
          await API.saveForm(result.value);
          UI.showToast('success', '表單已新增');
          if (AppLayout.currentSection === 'forms') {
            await Forms.load();
          }
        } catch (error) {
          UI.showToast('error', '新增失敗');
        }
      }
    });
  },

  openManager() {
    UI.showToast('info', '表單管理功能開發中');
  }
};

// ============================================================================
// 應用程式佈局控制
// ============================================================================
const AppLayout = {
  currentSection: 'dashboard',
  
  showSection(name, link) {
    this.currentSection = name;
    
    // 隱藏所有區塊
    document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
    
    // 顯示目標區塊
    const targetSection = document.getElementById(name + 'Section');
    if (targetSection) {
      targetSection.style.display = 'block';
    }
    
    // 更新導航狀態
    document.querySelectorAll('.sidebar .nav-link').forEach(a => a.classList.remove('active'));
    if (link) link.classList.add('active');
    
    // 載入對應資料
    switch (name) {
      case 'dashboard': Dashboard.refresh(); break;
      case 'transactions': Transactions.load(); break;
      case 'members': Members.load(); break;
      case 'activities': Activities.load(); break;
      case 'announcements': Announcements.load(); break;
      case 'forms': Forms.load(); break;
      case 'analytics': Analytics.load(); break;
      case 'reports': Reports.load(); break;
    }
    
    // 手機版自動收合側邊欄
    if (window.innerWidth < 992) {
      this.toggleSidebar(false);
    }
  },
  
  toggleSidebar(force) {
    const sidebar = document.getElementById('sidebar');
    if (!sidebar) return;
    
    if (typeof force === 'boolean') {
      sidebar.classList.toggle('show', force);
    } else {
      sidebar.classList.toggle('show');
    }
  }
};

// ============================================================================
// 其他功能模組
// ============================================================================
const GlobalSearch = {
  exec() {
    const keyword = document.getElementById('globalSearchInput')?.value.trim();
    if (!keyword) {
      UI.showToast('error', '請輸入搜尋關鍵字');
      return;
    }
    UI.showToast('info', '全域搜尋功能開發中');
  }
};

const Settings = {
  async open() {
    try {
      const settings = await API.getSettings();
      
      Swal.fire({
        title: '系統設定',
        html: `
          <div class="text-start">
            <div class="mb-3">
              <label class="form-label">組織名稱</label>
              <input id="settingOrgName" class="form-control" value="${settings.orgName || ''}">
            </div>
            <div class="mb-3">
              <label class="form-label">聯絡電話</label>
              <input id="settingPhone" class="form-control" value="${settings.phone || ''}">
            </div>
            <div class="mb-3">
              <label class="form-label">組織地址</label>
              <input id="settingAddress" class="form-control" value="${settings.address || ''}">
            </div>
            <div class="mb-3">
              <label class="form-label">預設年費</label>
              <input id="settingDefaultFee" type="number" class="form-control" value="${settings.defaultFee || 1000}">
            </div>
            <div class="mb-3">
              <label class="form-label">財務年度開始月份</label>
              <select id="settingFiscalMonth" class="form-select">
                ${Array.from({length: 12}, (_, i) => {
                  const month = i + 1;
                  const selected = (settings.fiscalMonth || 1) === month ? 'selected' : '';
                  return `<option value="${month}" ${selected}>${month}月</option>`;
                }).join('')}
              </select>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '儲存',
        cancelButtonText: '取消',
        width: '500px',
        preConfirm: () => {
          return {
            orgName: document.getElementById('settingOrgName').value,
            phone: document.getElementById('settingPhone').value,
            address: document.getElementById('settingAddress').value,
            defaultFee: parseFloat(document.getElementById('settingDefaultFee').value) || 1000,
            fiscalMonth: parseInt(document.getElementById('settingFiscalMonth').value) || 1
          };
        }
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await API.saveSettings(result.value);
            UI.showToast('success', '設定已儲存');
          } catch (error) {
            UI.showToast('error', '儲存失敗');
          }
        }
      });
    } catch (error) {
      UI.showToast('error', '載入設定失敗');
    }
  }
};

const DataManager = {
  async backup() {
    const result = await UI.confirm({
      title: '資料備份',
      text: '確定要備份所有資料嗎？',
      confirmColor: '#28a745'
    });

    if (result.isConfirmed) {
      try {
        UI.showLoading(true);
        const backupData = {
          transactions: await API.getTransactions(),
          members: await API.getMembers(),
          activities: await API.getActivities(),
          announcements: await API.getAnnouncements(),
          forms: await API.getForms(),
          settings: await API.getSettings(),
          timestamp: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
        link.click();

        UI.showToast('success', '資料備份完成');
      } catch (error) {
        UI.showToast('error', '備份失敗');
      }
    }
  },

  async restore() {
    const { value: file } = await Swal.fire({
      title: '資料還原',
      html: `
        <div class="text-start">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>警告：</strong>還原資料將覆蓋現有資料，請確保已備份重要資料。
          </div>
          <input type="file" id="restoreFile" class="form-control" accept=".json">
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: '還原',
      cancelButtonText: '取消',
      confirmButtonColor: '#dc3545',
      preConfirm: () => {
        const fileInput = document.getElementById('restoreFile');
        if (!fileInput.files[0]) {
          Swal.showValidationMessage('請選擇備份檔案');
          return false;
        }
        return fileInput.files[0];
      }
    });

    if (file) {
      try {
        UI.showLoading(true);
        const text = await file.text();
        const backupData = JSON.parse(text);
        
        // 這裡應該實作資料還原邏輯
        UI.showToast('info', '資料還原功能開發中');
      } catch (error) {
        UI.showToast('error', '還原失敗：檔案格式錯誤');
      }
    }
  },

  async clearAll() {
    const result = await UI.confirm({
      title: '清除所有資料',
      text: '此操作將刪除所有資料且無法復原！請確保已備份重要資料。',
      confirmColor: '#dc3545'
    });

    if (result.isConfirmed) {
      const confirm2 = await UI.prompt({
        title: '最終確認',
        input: 'text',
        inputLabel: '請輸入 "DELETE" 確認刪除',
        validator: (value) => {
          if (value !== 'DELETE') {
            return '請輸入 DELETE 確認刪除';
          }
        }
      });

      if (confirm2.isConfirmed) {
        UI.showToast('info', '清除資料功能開發中');
      }
    }
  }
};

// ============================================================================
// 應用程式初始化
// ============================================================================
const App = {
  async init() {
    try {
      // 顯示載入畫面
      UI.showLoading(true);
      
      // 檢查並初始化資料庫
      await this.checkDatabase();
      
      // 設定事件監聽器
      this.setupEventListeners();
      
      // 載入初始頁面
      AppLayout.showSection('dashboard');
      
      // 隱藏載入畫面
      UI.showLoading(false);
      
      UI.showToast('success', '系統載入完成');
      
    } catch (error) {
      console.error('應用程式初始化失敗:', error);
      UI.showLoading(false);
      
      document.body.innerHTML = `
        <div class="container-fluid vh-100 d-flex align-items-center justify-content-center">
          <div class="text-center">
            <i class="bi bi-exclamation-triangle display-1 text-danger mb-4"></i>
            <h3>系統初始化失敗</h3>
            <p class="text-muted mb-4">${error.message}</p>
            <button class="btn btn-primary" onclick="location.reload()">
              <i class="bi bi-arrow-clockwise me-2"></i>重新載入
            </button>
          </div>
        </div>
      `;
    }
  },

  async checkDatabase() {
    try {
      // 嘗試載入基本資料來檢查資料庫狀態
      await API.getDashboardStats();
    } catch (error) {
      // 如果失敗，嘗試初始化資料庫
      console.log('資料庫未初始化，開始初始化...');
      await API.initializeSheets();
    }
  },

  setupEventListeners() {
    // 全域搜尋
    const searchInput = document.getElementById('globalSearchInput');
    if (searchInput) {
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          GlobalSearch.exec();
        }
      });
    }

    // 側邊欄切換
    const sidebarToggle = document.getElementById('sidebarToggle');
    if (sidebarToggle) {
      sidebarToggle.addEventListener('click', () => {
        AppLayout.toggleSidebar();
      });
    }

    // 點擊遮罩關閉側邊欄（手機版）
    document.addEventListener('click', (e) => {
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebarToggle');
      
      if (window.innerWidth < 992 && 
          sidebar && 
          sidebar.classList.contains('show') && 
          !sidebar.contains(e.target) && 
          e.target !== sidebarToggle) {
        AppLayout.toggleSidebar(false);
      }
    });

    // 響應式處理
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 992) {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
          sidebar.classList.remove('show');
        }
      }
    });

    // 鍵盤快捷鍵
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + K 開啟搜尋
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const searchInput = document.getElementById('globalSearchInput');
        if (searchInput) {
          searchInput.focus();
        }
      }
      
      // ESC 關閉側邊欄
      if (e.key === 'Escape') {
        AppLayout.toggleSidebar(false);
      }
    });

    // 防止表單意外提交
    document.addEventListener('submit', (e) => {
      e.preventDefault();
    });

    // 處理網路狀態變化
    window.addEventListener('online', () => {
      UI.showToast('success', '網路連線已恢復');
    });

    window.addEventListener('offline', () => {
      UI.showToast('error', '網路連線中斷');
    });
  }
};

// ============================================================================
// 工具函數
// ============================================================================
const Utils = {
  // 生成唯一ID
  generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  },

  // 格式化檔案大小
  formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  },

  // 深拷貝物件
  deepClone(obj) {
    return JSON.parse(JSON.stringify(obj));
  },

  // 防抖函數
  debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  },

  // 節流函數
  throttle(func, limit) {
    let inThrottle;
    return function() {
      const args = arguments;
      const context = this;
      if (!inThrottle) {
        func.apply(context, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    };
  },

  // 匯出為CSV
  exportToCSV(data, filename) {
    if (!data.length) {
      UI.showToast('error', '沒有資料可匯出');
      return;
    }

    const headers = Object.keys(data[0]);
    const csvContent = [
      headers.join(','),
      ...data.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
    ].join('\n');

    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename || `export_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  },

  // 驗證Email格式
  isValidEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  },

  // 驗證電話格式
  isValidPhone(phone) {
    const re = /^[\d\-\(\)\+\s]+$/;
    return re.test(phone) && phone.replace(/\D/g, '').length >= 8;
  }
};

// ============================================================================
// 錯誤處理
// ============================================================================
window.addEventListener('error', (e) => {
  console.error('全域錯誤:', e.error);
  UI.showToast('error', '系統發生錯誤，請重新整理頁面');
});

window.addEventListener('unhandledrejection', (e) => {
  console.error('未處理的Promise錯誤:', e.reason);
  UI.showToast('error', '操作失敗，請稍後再試');
});

// ============================================================================
// 應用程式啟動
// ============================================================================
document.addEventListener('DOMContentLoaded', () => {
  // 檢查必要的依賴
  if (typeof bootstrap === 'undefined') {
    alert('Bootstrap 未載入，請檢查網路連線');
    return;
  }
  
  if (typeof Swal === 'undefined') {
    alert('SweetAlert2 未載入，請檢查網路連線');
    return;
  }

  // 啟動應用程式
  App.init();
});

// ============================================================================
// 全域函數（供HTML調用）
// ============================================================================
window.showSection = AppLayout.showSection.bind(AppLayout);
window.toggleSidebar = AppLayout.toggleSidebar.bind(AppLayout);
window.globalSearch = GlobalSearch.exec.bind(GlobalSearch);
window.openSettings = Settings.open.bind(Settings);
window.backupData = DataManager.backup.bind(DataManager);
window.restoreData = DataManager.restore.bind(DataManager);
window.clearAllData = DataManager.clearAll.bind(DataManager);

// 匯出主要模組供外部使用
window.API = API;
window.UI = UI;
window.Utils = Utils;
window.Dashboard = Dashboard;
window.Transactions = Transactions;
window.Members = Members;
window.Activities = Activities;
window.Announcements = Announcements;
window.Forms = Forms;
window.Analytics = Analytics;
window.Reports = Reports;



  </script>
</body>
</html>
