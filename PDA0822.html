<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>台灣帕金森病友權益促進會 - 會計暨營運整合管理系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="非營利組織整合：財務 / 會員 / 活動 / 公告 / 表單 / 雲端備份管理系統">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <style>
    :root {
      --primary:#2c5aa0;
      --primary-dark:#1e3d6f;
      --gradient-primary:linear-gradient(135deg,#2c5aa0,#4a90e2);
      --gradient-green:linear-gradient(135deg,#28a745,#20c997);
      --gradient-orange:linear-gradient(135deg,#ff9f40,#ffb347);
      --secondary-bg:#f8f9fa;
      --radius-lg:15px;
      --radius-md:10px;
      --radius-sm:6px;
    }
    body {
      background:var(--secondary-bg);
      font-family:"Microsoft JhengHei","Noto Sans TC",system-ui,sans-serif;
      font-size:14.5px;
    }
    .navbar-brand { font-weight:600; color:var(--primary)!important; }
    .sidebar {
      min-height:100vh;
      background:linear-gradient(180deg,#2c5aa0,#1e3d6f);
      color:#fff;
    }
    .sidebar .nav-link {
      color:rgba(255,255,255,.82);
      border-radius:8px;
      margin:3px 0;
      font-weight:500;
      transition:.25s;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background:rgba(255,255,255,0.12);
      color:#fff;
      transform:translateX(4px);
    }
    .content-section { animation:fadeIn .35s ease; }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(12px); }
      to { opacity:1; transform:translateY(0); }
    }
    .stat-card {
      background:var(--gradient-primary);
      color:#fff;
      border:none;
      border-radius:var(--radius-lg);
      box-shadow:0 4px 14px -4px rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
    }
    .stat-card.alt-green { background:var(--gradient-green); }
    .stat-card.alt-orange{ background:var(--gradient-orange); }
    .stat-card .icon-bg {
      position:absolute;
      right:-10px; top:-10px;
      font-size:72px;
      opacity:.16;
    }
    .card-hoverable { transition:.25s; border:none; border-radius:var(--radius-lg); }
    .card-hoverable:hover { transform:translateY(-4px); box-shadow:0 8px 24px -6px rgba(0,0,0,.15); }
    .table thead th { background:#f1f4f8; border-top:none; font-weight:600; }
    .badge-rounded { border-radius:20px; font-weight:500; letter-spacing:.5px; }
    .member-avatar, .participant-avatar {
      width:40px;height:40px;border-radius:50%;background:#fff;
      display:flex;align-items:center;justify-content:center;
      color:#666;font-weight:600;
      box-shadow:0 0 0 1px rgba(0,0,0,.05);
    }
    .small-avatar { width:32px;height:32px;font-size:12px; }
    .action-buttons .btn { padding:.25rem .5rem; }
    .voucher-preview img {
      max-width:100px;max-height:100px;object-fit:cover;border-radius:6px;margin:4px;cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    .loading-overlay {
      position:fixed; inset:0; z-index:2000;
      background:rgba(0,0,0,.45); display:flex;align-items:center;justify-content:center;
    }
    .pagination .page-link { border:none; border-radius:8px; color:var(--primary); }
    .pagination .page-item.active .page-link { background:var(--primary); }
    .chart-container { position:relative; height:380px; }
    .separator-title {
      font-size:15px;font-weight:600;margin:16px 0 10px;display:flex;align-items:center;gap:.5rem;
    }
    .separator-title:before, .separator-title:after {
      content:""; flex:1; height:1px; background:linear-gradient(90deg,#d0d3d9,#ffffff);
    }
    .form-download-item {
      border:1px solid #e2e6eb; padding:14px 16px; border-radius:var(--radius-md);
      background:#fff; position:relative; transition:.25s;
    }
    .form-download-item:hover { box-shadow:0 6px 18px -6px rgba(0,0,0,.15); transform:translateY(-3px); }
    .activity-card { border:none;border-radius:var(--radius-lg);overflow:hidden;box-shadow:0 3px 10px -2px rgba(0,0,0,.12);position:relative; }
    .activity-card .progress { height:6px; border-radius:3px; background:#e9ecef; overflow:hidden; }
    .activity-card .progress-bar { background:var(--gradient-green); }
    .announcement-card { border-left:5px solid #ffc107; border-radius:var(--radius-md); }
    .announcement-card.urgent { border-left-color:#dc3545; background:linear-gradient(135deg,#fff5f5,#ffffff); }
    .dual-col { columns:2 320px; column-gap:14px; }
    .row-invalid { background:#fff5f5!important; }
    .row-duplicate { background:#fff9e6!important; }
    .preview-status-badge { font-size:10px; }
    .mapping-select { width:100%; margin-bottom:6px; }
    @media print {
      .no-print, .sidebar, .navbar, .modal-backdrop { display:none!important; }
      body { background:#fff; }
      .main-content { margin:0!important; padding:0!important; }
      .card { box-shadow:none!important; }
    }
    @media (max-width: 992px){
      .sidebar { position:fixed; left:0; top:0; transform:translateX(-100%); transition:.35s; z-index:1100; width:250px; }
      .sidebar.show { transform:translateX(0); }
    }
    .spin { animation:spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .receipt-seal-placeholder { width:60px; height:60px; border:2px solid #c00; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:#c00; }
  </style>
</head>
<body>
  <!-- 全螢幕載入遮罩 -->
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="text-center text-white">
      <div class="mb-3">
        <i class="bi bi-arrow-clockwise spin" style="font-size:48px;"></i>
      </div>
      <div>系統載入中，請稍候…</div>
    </div>
  </div>

  <!-- 導覽列 -->
  <nav class="navbar navbar-expand-lg bg-white shadow-sm no-print">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <i class="bi bi-heart-pulse me-2"></i> 台灣帕金森病友權益促進會
      </a>
      <button class="navbar-toggler" type="button" onclick="AppLayout.toggleSidebar()">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item me-2">
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
              <input id="globalSearchInput" type="text" class="form-control" placeholder="全域搜尋 (交易 / 會員 / 活動 / 公告)" onkeydown="if(event.key==='Enter') GlobalSearch.exec()">
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle fw-semibold" href="#" data-bs-toggle="dropdown">
              <i class="bi bi-gear"></i> 系統
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" onclick="SettingsUI.open()"><i class="bi bi-sliders"></i> 系統設定</a></li>
              <li><a class="dropdown-item" href="#" onclick="AccountUI.openManager()"><i class="bi bi-bank"></i> 帳戶管理</a></li>
              <li><a class="dropdown-item" href="#" onclick="GoogleSync.open()"><i class="bi bi-cloud-arrow-up"></i> 雲端同步</a></li>
              <li><a class="dropdown-item" href="#" onclick="BatchImport.open('transactions')"><i class="bi bi-cloud-upload"></i> 批次匯入</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.exportAll()"><i class="bi bi-download"></i> 匯出資料</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.importAll()"><i class="bi bi-upload"></i> 匯入資料</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="Shortcuts.show()"><i class="bi bi-keyboard"></i> 快捷鍵</a></li>
              <li><a class="dropdown-item" href="#" onclick="About.show()"><i class="bi bi-info-circle"></i> 關於</a></li>
              <li><a class="dropdown-item" href="#" onclick="ConfirmReset.show()"><i class="bi bi-exclamation-triangle"></i> 系統重置</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- 側邊欄 -->
      <aside id="sidebar" class="sidebar col-lg-2 col-md-3 p-3">
        <h6 class="text-center mt-2 mb-4 fw-semibold">管理選單</h6>
        <nav class="nav flex-column">
          <a class="nav-link active" href="#" data-section="dashboard" onclick="AppLayout.showSection('dashboard',this)"><i class="bi bi-speedometer2 me-2"></i>儀表板</a>
          <a class="nav-link" href="#" data-section="transactions" onclick="AppLayout.showSection('transactions',this)"><i class="bi bi-receipt me-2"></i>交易記錄</a>
          <a class="nav-link" href="#" data-section="members" onclick="AppLayout.showSection('members',this)"><i class="bi bi-people me-2"></i>會員管理</a>
          <a class="nav-link" href="#" data-section="activities" onclick="AppLayout.showSection('activities',this)"><i class="bi bi-calendar-event me-2"></i>活動管理</a>
          <a class="nav-link" href="#" data-section="announcements" onclick="AppLayout.showSection('announcements',this)"><i class="bi bi-megaphone me-2"></i>公告管理</a>
          <a class="nav-link" href="#" data-section="forms" onclick="AppLayout.showSection('forms',this)"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單</a>
          <a class="nav-link" href="#" data-section="analytics" onclick="AppLayout.showSection('analytics',this)"><i class="bi bi-graph-up me-2"></i>統計分析</a>
          <a class="nav-link" href="#" data-section="reports" onclick="AppLayout.showSection('reports',this)"><i class="bi bi-file-earmark-text me-2"></i>報表中心</a>
        </nav>
      </aside>

      <!-- 主要內容 -->
      <main id="mainContent" class="col-lg-10 col-md-9 p-4">
        <!-- 儀表板 -->
        <section id="dashboardSection" class="content-section">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>儀表板</h4>
            <div class="d-flex gap-2">
                <div class="d-flex gap-1 me-3">
                  <span id="syncIndicator" class="badge bg-success"><i class="bi bi-cloud-check"></i> 已同步</span>
                  <span id="cloudIndicator" class="badge bg-info"><i class="bi bi-cloud"></i> 雲端連線</span>
                  <span id="offlineIndicator" class="badge bg-danger d-none"><i class="bi bi-wifi-off"></i> 離線</span>
                </div>
              <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
              <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
              <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
            </div>
          </div>

          <!-- 統計卡片列 -->
          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100">
                <div class="icon-bg"><i class="bi bi-cash-coin"></i></div>
                <small>總收入</small>
                <h3 id="dashTotalIncome" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">本月</span>
                  <span id="dashMonthIncome" class="small fw-semibold">$0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100 alt-orange">
                <div class="icon-bg"><i class="bi bi-credit-card-2-front"></i></div>
                <small>總支出</small>
                <h3 id="dashTotalExpense" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">本月</span>
                  <span id="dashMonthExpense" class="small fw-semibold">$0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100 alt-green">
                <div class="icon-bg"><i class="bi bi-bank"></i></div>
                <small>帳戶總餘額</small>
                <h3 id="dashTotalBalance" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">帳戶數</span>
                  <span id="dashAccountCount" class="small fw-semibold">0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100">
                <div class="icon-bg"><i class="bi bi-people"></i></div>
                <small>會員總數</small>
                <h3 id="dashMemberTotal" class="mb-1">0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">逾期會費</span>
                  <span id="dashMemberOverdue" class="badge bg-danger rounded-pill">0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 帳戶餘額 -->
          <div class="card card-hoverable mb-3">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h6 class="mb-0"><i class="bi bi-bank me-1"></i>帳戶餘額概覽</h6>
              <button class="btn btn-sm btn-outline-primary" onclick="AccountUI.openManager()"><i class="bi bi-gear"></i> 管理帳戶</button>
            </div>
            <div class="card-body">
              <div id="dashboardAccountBalances" class="row g-3">
                <!-- 動態填入 -->
              </div>
            </div>
          </div>

          <!-- 最新交易 / 最新會員 / 最新活動 -->
          <div class="row g-3">
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-arrows-expand me-1"></i>最近交易</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentTx">
                  <!-- 動態 -->
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-person-plus me-1"></i>新加入會員</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentMembers">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-calendar-event me-1"></i>近期活動</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentActivities">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 其他 sections 保持原樣... -->
        <!-- 這裡包含所有其他的 section，包括 transactions, members, activities 等 -->
        <!-- 為節省篇幅，這些部分與原程式碼相同 -->

        <!-- 全域 Toast 容器 -->
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:2000;">
          <div id="toastSuccess" class="toast align-items-center border-0" role="alert">
            <div class="d-flex">
              <div class="toast-body"><i class="bi bi-check-circle text-success me-2"></i><span id="toastSuccessMsg">成功</span></div>
              <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
          <div id="toastError" class="toast align-items-center border-0" role="alert">
            <div class="d-flex">
              <div class="toast-body"><i class="bi bi-exclamation-triangle text-danger me-2"></i><span id="toastErrorMsg">錯誤</span></div>
              <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- 依賴套件 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
/* ================================================================
 核心 JavaScript - 雲端版本
 ================================================================ */

/* -------------------- API 通訊層 -------------------- */
const API = {
  BASE_URL: 'https://script.google.com/macros/s/AKfycbxWzmcIWWlpPNvV-C89oPO4IU2zg0m19z177TSY2T7qpHIbOq2OeSGYAkRLGUK7AKTtAA/exec', // Google Apps Script 會自動處理
  
  async call(action, data = {}) {
    try {
      Util.showLoading(true);
      
      const response = await google.script.run
        .withSuccessHandler(result => result)
        .withFailureHandler(error => { throw new Error(error.message || '請求失敗'); })
        .doPost({ action, ...data });
      
      if (!response.success) {
        throw new Error(response.error || '操作失敗');
      }
      
      return response.data;
    } catch (error) {
      console.error('API Error:', error);
      throw error;
    } finally {
      Util.showLoading(false);
    }
  }
};

/* -------------------- 工具層 -------------------- */
const Util = {
  uuid: () => 'id_' + Math.random().toString(36).slice(2, 10),
  today: () => new Date().toISOString().split('T')[0],
  fmtNum: n => (Number(n) || 0).toLocaleString(),
  toNumber: v => isNaN(parseFloat(v)) ? 0 : parseFloat(v),
  pad: (n, l = 2) => String(n).padStart(l, '0'),
  
  formatDateInput(d) {
    if (!d) return '';
    if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
    let s = String(d).replace(/[年月\.\/]/g, '-').replace(/日/, '');
    const m = s.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
    if (m) return m[1] + '-' + Util.pad(m[2]) + '-' + Util.pad(m[3]);
    const dt = new Date(d);
    if (isNaN(dt.getTime())) return '';
    return dt.toISOString().split('T')[0];
  },
  
  age(birth) {
    if (!birth) return '';
    const d = new Date(birth);
    if (isNaN(d.getTime())) return '';
    const t = new Date();
    let a = t.getFullYear() - d.getFullYear();
    if (t.getMonth() < d.getMonth() || (t.getMonth() == d.getMonth() && t.getDate() < d.getDate())) a--;
    return a;
  },
  
  showToast(type, msg) {
    const id = type === 'success' ? 'toastSuccess' : 'toastError';
    const el = document.getElementById(id);
    if (!el) { alert(msg); return; }
    (type === 'success' ? document.getElementById('toastSuccessMsg') : document.getElementById('toastErrorMsg')).textContent = msg;
    new bootstrap.Toast(el, { delay: 3000 }).show();
  },
  
  confirm(opts) {
    return Swal.fire({
      icon: opts.icon || 'warning',
      title: opts.title || '確定？',
      html: opts.html || opts.text || '',
      showCancelButton: true,
      confirmButtonText: opts.confirmText || '確定',
      cancelButtonText: opts.cancelText || '取消',
      confirmButtonColor: opts.confirmColor || '#0d6efd'
    });
  },
  
  showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
      overlay.style.display = show ? 'flex' : 'none';
    }
  },
  
  financialChinese(num) {
    num = Number(num);
    if (isNaN(num)) return '';
    if (num === 0) return '零元整';
    const cNum = ['零', '壹', '貳', '參', '肆', '伍', '陸', '柒', '捌', '玖'];
    const cUnit = ['', '拾', '佰', '仟'];
    const cSec = ['', '萬', '億', '兆'];
    const cDec = ['角', '分'];
    let s = Math.floor(num).toString(), dec = Math.round((num - Math.floor(num)) * 100).toString().padStart(2, '0');
    let res = '';
    if (Number(s) > 0) {
      let k = 0;
      while (s.length > 0) {
        let seg = s.slice(-4); s = s.slice(0, -4);
        let segStr = '', zeroFlag = false;
        for (let i = 0; i < seg.length; i++) {
          const d = seg[seg.length - 1 - i];
          if (d === '0') {
            if (!zeroFlag && segStr) segStr = '零' + segStr;
            zeroFlag = true;
          } else {
            zeroFlag = false;
            segStr = cNum[+d] + cUnit[i] + segStr;
          }
        }
        segStr = segStr.replace(/零+/g, '零').replace(/零$/, '');
        if (segStr) res = segStr + cSec[k] + res;
        k++;
      }
      res += '元';
    }
    dec = dec.replace(/0+$/, '');
    if (dec) {
      if (dec[0] !== '0') res += cNum[+dec[0]] + cDec[0];
      if (dec[1] && dec[1] !== '0') res += cNum[+dec[1]] + cDec[1];
    } else res += '整';
    return res;
  }
};

/* -------------------- Layout 控制 -------------------- */
const AppLayout = {
  showSection(name, link) {
    document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
    document.getElementById(name + 'Section').style.display = 'block';
    document.querySelectorAll('.sidebar .nav-link').forEach(a => a.classList.remove('active'));
    if (link) link.classList.add('active');
    
    switch (name) {
      case 'dashboard': Dashboard.refresh(); break;
      case 'transactions': Transactions.renderTable(); break;
      case 'members': Members.renderTable(); break;
      case 'activities': Activities.renderGrid(); break;
      case 'announcements': Announcements.render(); break;
      case 'forms': Forms.render(); break;
      case 'analytics': Analytics.refresh(); break;
      case 'reports': Reports.initDateOnce(); break;
    }
    
    if (window.innerWidth < 992) this.toggleSidebar(false);
  },
  
  toggleSidebar(force) {
    const sb = document.getElementById('sidebar');
    if (typeof force === 'boolean') {
      sb.classList.toggle('show', force);
    } else {
      sb.classList.toggle('show');
    }
  }
};

/* -------------------- Dashboard -------------------- */
const Dashboard = {
  async refresh() {
    try {
      const data = await API.call('getDashboardData');
      
      // 更新統計卡片
      document.getElementById('dashTotalIncome').textContent = '$' + Util.fmtNum(data.stats.totalIncome);
      document.getElementById('dashTotalExpense').textContent = '$' + Util.fmtNum(data.stats.totalExpense);
      document.getElementById('dashMonthIncome').textContent = '$' + Util.fmtNum(data.stats.monthIncome);
      document.getElementById('dashMonthExpense').textContent = '$' + Util.fmtNum(data.stats.monthExpense);
      document.getElementById('dashTotalBalance').textContent = '$' + Util.fmtNum(data.stats.totalBalance);
      document.getElementById('dashAccountCount').textContent = data.stats.accountCount;
      document.getElementById('dashMemberTotal').textContent = data.stats.memberTotal;
      document.getElementById('dashMemberOverdue').textContent = data.stats.memberOverdue;
      
      this.renderAccounts(data.accounts);
      this.recentTransactions(data.recentTransactions);
      this.recentMembers(data.recentMembers);
      this.recentActivities(data.recentActivities);
    } catch (error) {
      Util.showToast('error', '載入儀表板失敗：' + error.message);
    }
  },
  
  renderAccounts(accounts) {
    const container = document.getElementById('dashboardAccountBalances');
    if (!container) return;
    
    if (!accounts.length) {
      container.innerHTML = '<div class="col-12 text-muted">尚無帳戶</div>';
      return;
    }
    
    container.innerHTML = accounts.map(a => `
      <div class="col-6 col-md-3">
        <div class="border rounded p-2 h-100 small bg-white">
          <div class="d-flex justify-content-between">
            <span class="fw-semibold">${a.name}</span>
            <span class="badge ${a.active ? 'bg-success' : 'bg-secondary'}">${a.active ? '啟用' : '停用'}</span>
          </div>
          <div class="mt-1">
            <span class="text-muted">餘額：</span>
            <span class="${a.currentBalance >= 0 ? 'text-success' : 'text-danger'} fw-semibold">$${Util.fmtNum(a.currentBalance)}</span>
          </div>
        </div>
      </div>
    `).join('');
  },
  
  recentTransactions(transactions) {
    const box = document.getElementById('dashboardRecentTx');
    if (!transactions.length) {
      box.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易</div>';
      return;
    }
    
    box.innerHTML = transactions.map(t => `
      <div class="d-flex justify-content-between align-items-center border-bottom py-2 small">
        <div>
          <div class="fw-semibold">${t.category}</div>
          <div class="text-muted">${t.date} ${t.counterparty || ''}</div>
        </div>
        <div class="text-end">
          <span class="badge ${t.type === '收入' ? 'bg-success' : 'bg-danger'}">${t.type === '收入' ? '+' : '-'}$${Util.fmtNum(t.amount)}</span>
        </div>
      </div>
    `).join('');
  },
  
  recentMembers(members) {
    const box = document.getElementById('dashboardRecentMembers');
    if (!members.length) {
      box.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員</div>';
      return;
    }
    
    box.innerHTML = members.map(m => `
      <div class="d-flex align-items-center border-bottom py-2 small">
        <div class="member-avatar me-2"><i class="bi bi-person"></i></div>
        <div class="flex-grow-1">
          <div class="fw-semibold">${m.name}</div>
          <div class="text-muted">${m.joinDate}</div>
        </div>
        <span class="badge ${Members.badgeClass(m.status)}">${Members.statusText(m.status)}</span>
      </div>
    `).join('');
  },
  
  recentActivities(activities) {
    const box = document.getElementById('dashboardRecentActivities');
    if (!activities.length) {
      box.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動</div>';
      return;
    }
    
    box.innerHTML = activities.map(a => `
      <div class="d-flex align-items-center border-bottom py-2 small">
        <div class="me-2 text-info"><i class="bi bi-calendar-event"></i></div>
        <div class="flex-grow-1">
          <div class="fw-semibold">${a.name}</div>
          <div class="text-muted">${a.date}</div>
        </div>
        <span class="badge ${Activities.statusBadge(a.status)}">${Activities.statusText(a.status)}</span>
      </div>
    `).join('');
  }
};

/* -------------------- 交易模組 -------------------- */
const Transactions = {
  state: { page: 1, per: 10, filtered: [] },
  
  async renderTable() {
    try {
      const filters = {
        year: document.getElementById('txFilterYear')?.value,
        month: document.getElementById('txFilterMonth')?.value,
        type: document.getElementById('txFilterType')?.value,
        keyword: document.getElementById('txFilterKeyword')?.value
      };
      
      const data = await API.call('getTransactions', { filters });
      this.state.filtered = data;
      
      const total = this.state.filtered.length;
      const per = this.state.per;
      const pages = Math.max(1, Math.ceil(total / per));
      if (this.state.page > pages) this.state.page = pages;
      const start = (this.state.page - 1) * per;
      const rows = this.state.filtered.slice(start, start + per);
      
      document.getElementById('txRecordCount').textContent = `${total} 筆記錄`;
      const tb = document.getElementById('txTableBody');
      
      if (!rows.length) {
        tb.innerHTML = `<tr><td colspan="10" class="text-center text-muted py-5">
          <i class="bi bi-inbox display-6 d-block mb-2"></i> 無符合資料
        </td></tr>`;
      } else {
        tb.innerHTML = rows.map(t => {
          const num = t.type === '收入' ? (t.receiptNumber || '-') : (t.voucherNumber || '-');
          return `<tr>
            <td><input type="checkbox" data-id="${t.id}" class="tx-check"></td>
            <td>${t.date}</td>
            <td><span class="badge ${t.type === '收入' ? 'bg-success' : 'bg-danger'}">${t.type}</span></td>
            <td>${t.category}</td>
            <td class="text-end fw-semibold ${t.type === '收入' ? 'text-success' : 'text-danger'}">${t.type === '收入' ? '+' : '-'}$${Util.fmtNum(t.amount)}</td>
            <td>${t.counterparty || '-'}</td>
            <td>${t.account || '-'}</td>
            <td class="small">${t.description || '-'}</td>
            <td class="small">${num} ${t.vouchers?.length ? '<i class="bi bi-paperclip text-primary"></i>' : ''}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-outline-primary" title="編輯" onclick="TransactionUI.open('${t.id}')"><i class="bi bi-pencil"></i></button>
                ${t.type === '收入'
                  ? `<button class="btn btn-sm btn-outline-info" title="收據" onclick="Print.receipt('${t.id}')"><i class="bi bi-printer"></i></button>`
                  : `<button class="btn btn-sm btn-outline-warning" title="憑證" onclick="Print.voucher('${t.id}')"><i class="bi bi-receipt-cutoff"></i></button>`
                }
                <button class="btn btn-sm btn-outline-danger" title="刪除" onclick="Transactions.delete('${t.id}')"><i class="bi bi-trash"></i></button>
              </div>
            </td>
          </tr>`;
        }).join('');
      }
      
      this.renderPagination(pages);
    } catch (error) {
      Util.showToast('error', '載入交易記錄失敗：' + error.message);
    }
  },
  
  renderPagination(pages) {
    const ul = document.getElementById('txPagination');
    let html = '';
    const p = this.state.page;
    const add = (pg, txt, dis = false, act = false) => html += `<li class="page-item ${dis ? 'disabled' : ''} ${act ? 'active' : ''}">
      <a href="#" class="page-link" onclick="Transactions.goto(${pg});return false;">${txt}</a></li>`;
    add(p - 1, '«', p === 1);
    for (let i = Math.max(1, p - 2); i <= Math.min(pages, p + 2); i++) add(i, i, false, i === p);
    add(p + 1, '»', p === pages);
    ul.innerHTML = html;
  },
  
  goto(p) { this.state.page = p; this.renderTable(); },
  
  toggleSelectAll(master) {
    document.querySelectorAll('.tx-check').forEach(cb => cb.checked = master.checked);
  },
  
  getSelectedIds() {
    return [...document.querySelectorAll('.tx-check:checked')].map(cb => cb.getAttribute('data-id'));
  },
  
  async batchAction() {
    const act = document.getElementById('txBatchAction').value;
    const ids = this.getSelectedIds();
    if (!act) return Util.showToast('error', '請選擇批次操作');
    if (!ids.length) return Util.showToast('error', '尚未勾選');
    
    if (act === 'delete') {
      const result = await Util.confirm({ title: '刪除確認', text: `確定刪除 ${ids.length} 筆交易?`, confirmColor: '#dc3545' });
      if (result.isConfirmed) {
        try {
          await API.call('batchDeleteTransactions', { ids });
          this.renderTable();
          Dashboard.refresh();
          Util.showToast('success', '已刪除');
        } catch (error) {
          Util.showToast('error', '刪除失敗：' + error.message);
        }
      }
    } else if (act === 'export') {
      DataPort.exportTransactions(ids);
    } else if (act === 'print') {
      Print.batchReceipts(ids);
    } else if (act === 'voucher') {
      Print.batchVouchers(ids);
    } else {
      Util.showToast('error', '尚未實作');
    }
  },
  
  async delete(id) {
    const result = await Util.confirm({ title: '刪除交易', text: '是否刪除此筆交易？', confirmColor: '#dc3545' });
    if (!result.isConfirmed) return;
    
    try {
      await API.call('deleteTransaction', { id });
      this.renderTable();
      Dashboard.refresh();
      Util.showToast('success', '已刪除交易');
    } catch (error) {
      Util.showToast('error', '刪除失敗：' + error.message);
    }
  }
};

/* 交易 UI 控制 */
const TransactionUI = {
  modal: null,
  
  async open(id = null) {
    if (!this.modal) this.modal = new bootstrap.Modal(document.getElementById('transactionModal'));
    
    document.getElementById('txForm').reset();
    document.getElementById('txId').value = '';
    document.getElementById('txVoucherPreview').innerHTML = '';
    
    await this.fillAccounts();
    await this.fillCategories('收入');
    
    document.getElementById('txDate').value = Util.today();
    document.getElementById('txType').value = '收入';
    document.getElementById('txNumberLabel').textContent = '收據編號';
    document.getElementById('txNumber').value = await this.generateReceiptNumber();
    
    if (id) {
      try {
        const transactions = await API.call('getTransactions');
        const t = transactions.find(x => x.id === id);
        if (t) {
          document.getElementById('txModalTitle').textContent = '編輯交易';
          document.getElementById('txId').value = t.id;
          document.getElementById('txDate').value = t.date;
          document.getElementById('txType').value = t.type;
          await this.fillCategories(t.type);
          document.getElementById('txCategory').value = t.category;
          document.getElementById('txAmount').value = t.amount;
          document.getElementById('txCounterparty').value = t.counterparty || '';
          document.getElementById('txAccount').value = t.account || '';
          document.getElementById('txDescription').value = t.description || '';
          
          if (t.type === '收入') {
            document.getElementById('txNumberLabel').textContent = '收據編號';
            document.getElementById('txNumber').value = t.receiptNumber || '';
          } else {
            document.getElementById('txNumberLabel').textContent = '憑證編號';
            document.getElementById('txNumber').value = t.voucherNumber || '';
          }
          
          if (t.vouchers?.length) {
            this.renderVoucherPreview(t.vouchers);
          }
        }
      } catch (error) {
        Util.showToast('error', '載入交易資料失敗：' + error.message);
      }
    } else {
      document.getElementById('txModalTitle').textContent = '新增交易';
    }
    
    this.modal.show();
  },
  
  async onTypeChange() {
    const type = document.getElementById('txType').value;
    await this.fillCategories(type);
    const lbl = document.getElementById('txNumberLabel');
    if (type === '支出') {
      lbl.textContent = '憑證編號';
      document.getElementById('txNumber').value = await this.generateVoucherNumber();
    } else {
      lbl.textContent = '收據編號';
      document.getElementById('txNumber').value = await this.generateReceiptNumber();
    }
  },
  
  async fillCategories(type) {
    const sel = document.getElementById('txCategory');
    sel.innerHTML = '<option value="">選擇類別</option>';
    
    try {
      const settings = await API.call('getSettings');
      const cats = settings.categories[type] || [];
      cats.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        sel.appendChild(opt);
      });
    } catch (error) {
      console.error('載入類別失敗:', error);
    }
  },
  
  async fillAccounts() {
    const sel = document.getElementById('txAccount');
    sel.innerHTML = '';
    
    try {
      const accounts = await API.call('getAccounts');
      accounts.filter(a => a.active).forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.name; opt.textContent = a.name;
        sel.appendChild(opt);
      });
      if (!sel.value && sel.options.length) sel.selectedIndex = 0;
    } catch (error) {
      console.error('載入帳戶失敗:', error);
    }
  },
  
  async generateReceiptNumber() {
    // 簡化版本，實際應該從後端獲取
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const sequence = String(Math.floor(Math.random() * 999) + 1).padStart(3, '0');
    return `R${year}${month}${day}${sequence}`;
  },
  
  async generateVoucherNumber() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const sequence = String(Math.floor(Math.random() * 999) + 1).padStart(3, '0');
    return `V${year}${month}${day}${sequence}`;
  },
  
  handleVoucherUpload(e) {
    const files = [...e.target.files];
    const container = document.getElementById('txVoucherPreview');
    container.innerHTML = '';
    
    files.forEach(f => {
      if (f.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = ev => {
          const img = document.createElement('img');
          img.src = ev.target.result;
          img.title = f.name;
          img.onclick = () => Swal.fire({ imageUrl: ev.target.result, showConfirmButton: false });
          container.appendChild(img);
        };
        reader.readAsDataURL(f);
      } else if (f.type === 'application/pdf') {
        const div = document.createElement('div');
        div.className = 'border rounded small p-2 d-inline-flex flex-column align-items-center justify-content-center';
        div.style.width = '90px'; div.style.height = '90px';
        div.innerHTML = '<i class="bi bi-file-earmark-pdf text-danger" style="font-size:32px;"></i><div class="small text-truncate" style="max-width:80px">' + f.name + '</div>';
        container.appendChild(div);
      }
    });
  },
  
  renderVoucherPreview(vouchers) {
    const container = document.getElementById('txVoucherPreview');
    container.innerHTML = '';
    
    vouchers.forEach(v => {
      if (v.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = v.data;
        img.title = v.name;
        img.onclick = () => Swal.fire({ imageUrl: v.data, showConfirmButton: false });
        container.appendChild(img);
      } else if (v.type === 'application/pdf') {
        const div = document.createElement('div');
        div.className = 'border rounded small p-2 d-inline-flex flex-column align-items-center justify-content-center';
        div.style.width = '90px'; div.style.height = '90px';
        div.innerHTML = '<i class="bi bi-file-earmark-pdf text-danger" style="font-size:32px;"></i><div class="small text-truncate" style="max-width:80px">' + v.name + '</div>';
        container.appendChild(div);
      }
    });
  },
  
  async save() {
    const form = document.getElementById('txForm');
    if (!form.checkValidity()) { form.reportValidity(); return; }
    
    const id = document.getElementById('txId').value;
    const type = document.getElementById('txType').value;
    
    const transaction = {
      id: id || Util.uuid(),
      date: document.getElementById('txDate').value,
      type,
      category: document.getElementById('txCategory').value,
      amount: Util.toNumber(document.getElementById('txAmount').value),
      counterparty: document.getElementById('txCounterparty').value.trim(),
      account: document.getElementById('txAccount').value,
      description: document.getElementById('txDescription').value.trim(),
      vouchers: []
    };
    
    const customNumber = document.getElementById('txNumber').value.trim();
    if (type === '收入') {
      transaction.receiptNumber = customNumber || await this.generateReceiptNumber();
    } else {
      transaction.voucherNumber = customNumber || await this.generateVoucherNumber();
    }
    
    // 處理附件
    const fInput = document.getElementById('txVouchers');
    if (fInput.files.length) {
      const vouchers = [];
      for (const f of fInput.files) {
        const data = await this.fileToBase64(f);
        vouchers.push({ name: f.name, type: f.type, data });
      }
      transaction.vouchers = vouchers;
    }
    
    try {
      if (id) {
        await API.call('updateTransaction', { transaction });
        Util.showToast('success', '交易已更新');
      } else {
        await API.call('addTransaction', { transaction });
        Util.showToast('success', '交易已新增');
      }
      
      this.modal.hide();
      Transactions.renderTable();
      Dashboard.refresh();
    } catch (error) {
      Util.showToast('error', '儲存失敗：' + error.message);
    }
  },
  
  fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
};

/* -------------------- 會員模組 -------------------- */
const Members = {
  state: { page: 1, per: 10, filtered: [] },
  
  statusText: s => s === 'active' ? '正常' : s === 'inactive' ? '停權' : s === 'pending' ? '待審核' : '—',
  badgeClass: s => s === 'active' ? 'bg-success' : s === 'inactive' ? 'bg-danger' : s === 'pending' ? 'bg-warning text-dark' : 'bg-secondary',
  typeText: t => ({ regular: '一般會員', honorary: '榮譽會員', life: '終身會員', family: '家屬會員' })[t] || '其他',
  
  isOverdue(m) {
    if (!m.lastPaymentDate) return true;
    const last = new Date(m.lastPaymentDate);
    const cmp = new Date(); cmp.setFullYear(cmp.getFullYear() - 1);
    return last < cmp;
  },
  
  async renderTable() {
    try {
      const filters = {
        status: document.getElementById('memberFilterStatus')?.value,
        type: document.getElementById('memberFilterType')?.value,
        keyword: document.getElementById('memberFilterKeyword')?.value
      };
      
      const members = await API.call('getMembers', { filters });
      this.state.filtered = members;
      
      // 統計
      const allMembers = await API.call('getMembers');
      document.getElementById('mStatTotal').textContent = allMembers.length;
      document.getElementById('mStatActive').textContent = allMembers.filter(m => m.status === 'active').length;
      const overdue = allMembers.filter(m => this.isOverdue(m)).length;
      document.getElementById('mStatOverdue').textContent = overdue;
      const monthStr = new Date().toISOString().slice(0, 7);
      document.getElementById('mStatNew').textContent = allMembers.filter(m => m.joinDate.startsWith(monthStr)).length;
      
      const per = this.state.per;
      const pages = Math.max(1, Math.ceil(members.length / per));
      if (this.state.page > pages) this.state.page = pages;
      const start = (this.state.page - 1) * per;
      const rows = members.slice(start, start + per);
      
      document.getElementById('memberRecordCount').textContent = `${members.length} 筆記錄`;
      const tb = document.getElementById('memberTableBody');
      
      if (!rows.length) {
        tb.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-5">
          <i class="bi bi-people display-6 d-block mb-2"></i> 無符合會員
        </td></tr>`;
      } else {
        tb.innerHTML = rows.map(m => {
          const age = Util.age(m.birthDate);
          const overdue = this.isOverdue(m);
          return `<tr>
            <td><input type="checkbox" class="member-check" data-id="${m.id}"></td>
            <td>
              <div class="d-flex align-items-center">
                <div class="member-avatar me-2">${m.name.charAt(0)}</div>
                <div>
                  <div class="fw-semibold">${m.name}</div>
                  <div class="text-muted small">${m.id.slice(0, 8)}</div>
                </div>
              </div>
            </td>
            <td class="small">
              <div><i class="bi bi-telephone me-1"></i>${m.phone}</div>
              ${m.email ? `<div class="text-truncate"><i class="bi bi-envelope me-1"></i>${m.email}</div>` : ''}
            </td>
            <td>${age ? age + '歲' : ''}${m.gender ? ' / ' + m.gender : ''}</td>
            <td>${m.joinDate}</td>
            <td><span class="badge ${this.badgeClass(m.status)}">${this.statusText(m.status)}</span></td>
            <td>
              <span class="badge ${overdue ? 'bg-danger' : 'bg-success'}">${overdue ? '逾期' : '已繳'}</span>
              ${m.lastPaymentDate ? `<div class="small text-muted">${m.lastPaymentDate}</div>` : ''}
            </td>
            <td class="small">
              ${(m.tags || []).map(t => `<span class="badge bg-secondary me-1">${t}</span>`).join('') || '-'}
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-outline-info" title="詳情" onclick="Members.detail('${m.id}')"><i class="bi bi-eye"></i></button>
                <button class="btn btn-sm btn-outline-primary" title="編輯" onclick="MemberUI.open('${m.id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-success" title="繳費" onclick="Members.recordFee('${m.id}')"><i class="bi bi-credit-card"></i></button>
                <button class="btn btn-sm btn-outline-danger" title="刪除" onclick="Members.delete('${m.id}')"><i class="bi bi-trash"></i></button>
              </div>
            </td>
          </tr>`;
        }).join('');
      }
      
      this.renderPagination(pages);
    } catch (error) {
      Util.showToast('error', '載入會員資料失敗：' + error.message);
    }
  },
  
  renderPagination(pages) {
    const ul = document.getElementById('memberPagination');
    let html = '', p = this.state.page;
    const add = (pg, txt, dis = false, act = false) => html += `<li class="page-item ${dis ? 'disabled' : ''} ${act ? 'active' : ''}">
      <a href="#" class="page-link" onclick="Members.goto(${pg});return false;">${txt}</a></li>`;
    add(p - 1, '«', p === 1);
    for (let i = Math.max(1, p - 2); i <= Math.min(pages, p + 2); i++) add(i, i, false, i === p);
    add(p + 1, '»', p === pages);
    ul.innerHTML = html;
  },
  
  goto(p) { this.state.page = p; this.renderTable(); },
  
  toggleSelectAll(master) {
    document.querySelectorAll('.member-check').forEach(cb => cb.checked = master.checked);
  },
  
  getSelected() {
    return [...document.querySelectorAll('.member-check:checked')].map(cb => cb.getAttribute('data-id'));
  },
  
  async batchAction() {
    const act = document.getElementById('memberBatchAction').value;
    const ids = this.getSelected();
    if (!act) return Util.showToast('error', '未選動作');
    if (!ids.length) return Util.showToast('error', '未勾選');
    
    if (act === 'delete') {
      const result = await Util.confirm({ title: '刪除會員', text: `確定刪除 ${ids.length} 位會員？`, confirmColor: '#dc3545' });
      if (!result.isConfirmed) return;
      
      try {
        await API.call('batchDeleteMembers', { ids });
        this.renderTable();
        Dashboard.refresh();
        Util.showToast('success', '已刪除會員');
      } catch (error) {
        Util.showToast('error', '刪除失敗：' + error.message);
      }
    } else if (act === 'export') {
      DataPort.exportMembers(ids);
    } else if (act.startsWith('status-')) {
      // 批次更新狀態功能需要後端支援
      Util.showToast('error', '尚未實作');
    } else {
      Util.showToast('error', '尚未實作');
    }
  },
  
  async detail(id) {
    try {
      const members = await API.call('getMembers');
      const m = members.find(x => x.id === id);
      if (!m) return;
      
      const transactions = await API.call('getTransactions');
      const tx = transactions.filter(t => t.counterparty && t.counterparty.includes(m.name));
      const totalFee = tx.filter(t => t.type === '收入' && t.category === '會費').reduce((s, t) => s + Util.toNumber(t.amount), 0);
      const age = Util.age(m.birthDate);
      const overdue = this.isOverdue(m);
      
      const modal = new bootstrap.Modal(document.getElementById('memberDetailModal'));
      document.getElementById('memberDetailContent').innerHTML = `
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="border rounded p-3 h-100">
              <h6 class="fw-semibold mb-2"><i class="bi bi-person-badge me-1"></i>基本資料</h6>
              <div class="row small">
                <div class="col-4 text-muted">姓名</div><div class="col-8 fw-semibold">${m.name}</div>
                <div class="col-4 text-muted">電話</div><div class="col-8">${m.phone}</div>
                <div class="col-4 text-muted">Email</div><div class="col-8">${m.email || '—'}</div>
                <div class="col-4 text-muted">出生</div><div class="col-8">${m.birthDate || '—'} ${age ? `(${age}歲)` : ''}</div>
                <div class="col-4 text-muted">性別</div><div class="col-8">${m.gender || '—'}</div>
                <div class="col-4 text-muted">身分證</div><div class="col-8">${m.idNumber || '—'}</div>
                <div class="col-4 text-muted">地址</div><div class="col-8">${m.address || '—'}</div>
                <div class="col-4 text-muted">緊急聯絡</div><div class="col-8">${m.emergencyContact || '—'} ${m.emergencyPhone ? '(' + m.emergencyPhone + ')' : ''}</div>
              </div>
              <h6 class="fw-semibold mt-3 mb-2"><i class="bi bi-card-checklist me-1"></i>會員資訊</h6>
              <div class="row small">
                <div class="col-4 text-muted">加入日期</div><div class="col-8">${m.joinDate}</div>
                <div class="col-4 text-muted">狀態</div><div class="col-8"><span class="badge ${this.badgeClass(m.status)}">${this.statusText(m.status)}</span></div>
                <div class="col-4 text-muted">類型</div><div class="col-8">${this.typeText(m.type)}</div>
                <div class="col-4 text-muted">年費</div><div class="col-8">$${Util.fmtNum(m.membershipFee || 0)}</div>
                <div class="col-4 text-muted">最後繳費</div><div class="col-8">${m.lastPaymentDate || '—'} ${overdue ? '<span class="badge bg-danger">逾期</span>' : '<span class="badge bg-success">正常</span>'}</div>
                <div class="col-4 text-muted">累計會費</div><div class="col-8 text-success fw-semibold">$${Util.fmtNum(totalFee)}</div>
                <div class="col-4 text-muted">標籤</div><div class="col-8">${(m.tags || []).map(t => `<span class="badge bg-secondary me-1">${t}</span>`).join('') || '—'}</div>
              </div>
              ${m.notes ? `<div class="mt-3"><div class="small text-muted">備註</div><div class="alert alert-info py-2 small mb-0">${m.notes}</div></div>` : ''}
            </div>
          </div>
          <div class="col-lg-6">
            <div class="border rounded p-3 h-100">
              <h6 class="fw-semibold mb-2"><i class="bi bi-clock-history me-1"></i>相關交易 (${tx.length} 筆)</h6>
              <div class="table-responsive" style="max-height:350px;overflow:auto;">
                <table class="table table-sm">
                  <thead class="table-light sticky-top">
                    <tr><th>日期</th><th>類型</th><th>類別</th><th>金額</th></tr>
                  </thead>
                  <tbody>
                    ${tx.length ? tx.map(t => `
                      <tr>
                        <td class="small">${t.date}</td>
                        <td><span class="badge ${t.type === '收入' ? 'bg-success' : 'bg-danger'} badge-rounded">${t.type}</span></td>
                        <td class="small">${t.category}</td>
                        <td class="small text-end fw-semibold ${t.type === '收入' ? 'text-success' : 'text-danger'}">${t.type === '收入' ? '+' : '-'}$${Util.fmtNum(t.amount)}</td>
                      </tr>
                    `).join('') : '<tr><td colspan="4" class="text-center text-muted py-3">無相關交易</td></tr>'}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
      modal.show();
    } catch (error) {
      Util.showToast('error', '載入會員詳情失敗：' + error.message);
    }
  },
  
  async recordFee(id) {
    try {
      const members = await API.call('getMembers');
      const m = members.find(x => x.id === id);
      if (!m) return;
      
      // 開啟交易表單，預填會費資料
      TransactionUI.open();
      
      // 等待 modal 完全載入後再填入資料
      setTimeout(() => {
        document.getElementById('txType').value = '收入';
        document.getElementById('txCategory').value = '會費';
        document.getElementById('txAmount').value = m.membershipFee || 1000;
        document.getElementById('txCounterparty').value = m.name;
        document.getElementById('txDescription').value = `${m.name} 會費`;
      }, 500);
    } catch (error) {
      Util.showToast('error', '載入會員資料失敗：' + error.message);
    }
  },
  
  async delete(id) {
    const result = await Util.confirm({ title: '刪除會員', text: '確定刪除此會員？', confirmColor: '#dc3545' });
    if (!result.isConfirmed) return;
    
    try {
      await API.call('deleteMember', { id });
      this.renderTable();
      Dashboard.refresh();
      Util.showToast('success', '已刪除會員');
    } catch (error) {
      Util.showToast('error', '刪除失敗：' + error.message);
    }
  }
};

/* 會員 UI 控制 */
const MemberUI = {
  modal: null,
  
  async open(id = null) {
    if (!this.modal) this.modal = new bootstrap.Modal(document.getElementById('memberModal'));
    
    document.getElementById('memberForm').reset();
    document.getElementById('memberId').value = '';
    
    if (id) {
      try {
        const members = await API.call('getMembers');
        const m = members.find(x => x.id === id);
        if (m) {
          document.getElementById('memberModalTitle').textContent = '編輯會員';
          document.getElementById('memberId').value = m.id;
          document.getElementById('memberName').value = m.name;
          document.getElementById('memberPhone').value = m.phone;
          document.getElementById('memberEmail').value = m.email || '';
          document.getElementById('memberBirthDate').value = m.birthDate || '';
          document.getElementById('memberGender').value = m.gender || '';
          document.getElementById('memberIdNumber').value = m.idNumber || '';
          document.getElementById('memberAddress').value = m.address || '';
          document.getElementById('memberEmergencyContact').value = m.emergencyContact || '';
          document.getElementById('memberEmergencyPhone').value = m.emergencyPhone || '';
          document.getElementById('memberJoinDate').value = m.joinDate;
          document.getElementById('memberStatus').value = m.status;
          document.getElementById('memberType').value = m.type;
          document.getElementById('memberMembershipFee').value = m.membershipFee || '';
          document.getElementById('memberLastPaymentDate').value = m.lastPaymentDate || '';
          document.getElementById('memberTags').value = (m.tags || []).join(', ');
          document.getElementById('memberNotes').value = m.notes || '';
        }
      } catch (error) {
        Util.showToast('error', '載入會員資料失敗：' + error.message);
      }
    } else {
      document.getElementById('memberModalTitle').textContent = '新增會員';
      document.getElementById('memberJoinDate').value = Util.today();
      document.getElementById('memberStatus').value = 'active';
      document.getElementById('memberType').value = 'regular';
      document.getElementById('memberMembershipFee').value = '1000';
    }
    
    this.modal.show();
  },
  
  async save() {
    const form = document.getElementById('memberForm');
    if (!form.checkValidity()) { form.reportValidity(); return; }
    
    const id = document.getElementById('memberId').value;
    const tagsStr = document.getElementById('memberTags').value.trim();
    
    const member = {
      id: id || Util.uuid(),
      name: document.getElementById('memberName').value.trim(),
      phone: document.getElementById('memberPhone').value.trim(),
      email: document.getElementById('memberEmail').value.trim(),
      birthDate: document.getElementById('memberBirthDate').value,
      gender: document.getElementById('memberGender').value,
      idNumber: document.getElementById('memberIdNumber').value.trim(),
      address: document.getElementById('memberAddress').value.trim(),
      emergencyContact: document.getElementById('memberEmergencyContact').value.trim(),
      emergencyPhone: document.getElementById('memberEmergencyPhone').value.trim(),
      joinDate: document.getElementById('memberJoinDate').value,
      status: document.getElementById('memberStatus').value,
      type: document.getElementById('memberType').value,
      membershipFee: Util.toNumber(document.getElementById('memberMembershipFee').value),
      lastPaymentDate: document.getElementById('memberLastPaymentDate').value,
      tags: tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [],
      notes: document.getElementById('memberNotes').value.trim()
    };
    
    try {
      if (id) {
        await API.call('updateMember', { member });
        Util.showToast('success', '會員資料已更新');
      } else {
        await API.call('addMember', { member });
        Util.showToast('success', '會員已新增');
      }
      
      this.modal.hide();
      Members.renderTable();
      Dashboard.refresh();
    } catch (error) {
      Util.showToast('error', '儲存失敗：' + error.message);
    }
  }
};

/* -------------------- 活動模組 -------------------- */
const Activities = {
  statusText: s => ({ draft: '草稿', published: '已發布', ongoing: '進行中', completed: '已結束', cancelled: '已取消' })[s] || s,
  statusBadge: s => ({ draft: 'bg-secondary', published: 'bg-info', ongoing: 'bg-success', completed: 'bg-primary', cancelled: 'bg-danger' })[s] || 'bg-secondary',
  
  async renderGrid() {
    try {
      const activities = await API.call('getActivities');
      const container = document.getElementById('activitiesGrid');
      
      if (!activities.length) {
        container.innerHTML = `<div class="col-12 text-center text-muted py-5">
          <i class="bi bi-calendar-event display-1 d-block mb-3"></i>
          <h5>尚無活動</h5>
          <p>點擊右上角「新增活動」開始建立活動</p>
        </div>`;
        return;
      }
      
      container.innerHTML = activities.map(a => {
        const progress = a.maxParticipants > 0 ? (a.currentParticipants / a.maxParticipants * 100) : 0;
        return `
          <div class="col-lg-4 col-md-6 mb-4">
            <div class="activity-card card h-100">
              <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <span class="badge ${this.statusBadge(a.status)}">${this.statusText(a.status)}</span>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="Activities.detail('${a.id}')"><i class="bi bi-eye me-2"></i>檢視</a></li>
                    <li><a class="dropdown-item" href="#" onclick="ActivityUI.open('${a.id}')"><i class="bi bi-pencil me-2"></i>編輯</a></li>
                    <li><a class="dropdown-item" href="#" onclick="Activities.manageRegistrations('${a.id}')"><i class="bi bi-people me-2"></i>報名管理</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="Activities.delete('${a.id}')"><i class="bi bi-trash me-2"></i>刪除</a></li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <h6 class="card-title fw-semibold">${a.name}</h6>
                <div class="small text-muted mb-2">
                  <i class="bi bi-calendar me-1"></i>${a.date}
                  <i class="bi bi-clock ms-2 me-1"></i>${a.startTime || ''}${a.endTime ? ' - ' + a.endTime : ''}
                </div>
                ${a.location ? `<div class="small text-muted mb-2"><i class="bi bi-geo-alt me-1"></i>${a.location}</div>` : ''}
                <p class="card-text small">${a.description || '無說明'}</p>
                
                ${a.maxParticipants > 0 ? `
                  <div class="mb-2">
                    <div class="d-flex justify-content-between small">
                      <span>報名人數</span>
                      <span>${a.currentParticipants || 0} / ${a.maxParticipants}</span>
                    </div>
                    <div class="progress">
                      <div class="progress-bar" style="width:${progress}%"></div>
                    </div>
                  </div>
                ` : ''}
                
                <div class="d-flex justify-content-between align-items-center">
                  <small class="text-muted">費用: ${a.fee > 0 ? '$' + Util.fmtNum(a.fee) : '免費'}</small>
                  <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="Activities.detail('${a.id}')">詳情</button>
                    ${a.status === 'published' ? `<button class="btn btn-sm btn-success" onclick="Activities.register('${a.id}')">報名</button>` : ''}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    } catch (error) {
      Util.showToast('error', '載入活動失敗：' + error.message);
    }
  },
  
  async detail(id) {
    try {
      const activities = await API.call('getActivities');
      const a = activities.find(x => x.id === id);
      if (!a) return;
      
      const registrations = await API.call('getRegistrations', { activityId: id });
      
      const modal = new bootstrap.Modal(document.getElementById('activityDetailModal'));
      document.getElementById('activityDetailContent').innerHTML = `
        <div class="row g-3">
          <div class="col-lg-8">
            <div class="border rounded p-3">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <h5 class="fw-semibold mb-0">${a.name}</h5>
                <span class="badge ${this.statusBadge(a.status)}">${this.statusText(a.status)}</span>
              </div>
              
              <div class="row mb-3">
                <div class="col-sm-6">
                  <div class="small text-muted">日期時間</div>
                  <div>${a.date} ${a.startTime || ''}${a.endTime ? ' - ' + a.endTime : ''}</div>
                </div>
                <div class="col-sm-6">
                  <div class="small text-muted">地點</div>
                  <div>${a.location || '—'}</div>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-sm-6">
                  <div class="small text-muted">費用</div>
                  <div class="fw-semibold">${a.fee > 0 ? '$' + Util.fmtNum(a.fee) : '免費'}</div>
                </div>
                <div class="col-sm-6">
                  <div class="small text-muted">報名人數</div>
                  <div>${a.currentParticipants || 0}${a.maxParticipants > 0 ? ' / ' + a.maxParticipants : ''}</div>
                </div>
              </div>
              
              <div class="mb-3">
                <div class="small text-muted">活動說明</div>
                <div class="border rounded p-2 bg-light small">${a.description || '無說明'}</div>
              </div>
              
              ${a.requirements ? `
                <div class="mb-3">
                  <div class="small text-muted">報名須知</div>
                  <div class="border rounded p-2 bg-light small">${a.requirements}</div>
                </div>
              ` : ''}
              
              ${a.notes ? `
                <div class="mb-3">
                  <div class="small text-muted">備註</div>
                  <div class="alert alert-info py-2 small mb-0">${a.notes}</div>
                </div>
              ` : ''}
            </div>
          </div>
          
          <div class="col-lg-4">
            <div class="border rounded p-3">
              <h6 class="fw-semibold mb-2">報名名單 (${registrations.length})</h6>
              <div style="max-height:400px;overflow:auto;">
                ${registrations.length ? registrations.map(r => `
                  <div class="d-flex align-items-center border-bottom py-2 small">
                    <div class="participant-avatar small-avatar me-2">${r.participantName.charAt(0)}</div>
                    <div class="flex-grow-1">
                      <div class="fw-semibold">${r.participantName}</div>
                      <div class="text-muted">${r.participantPhone || ''}</div>
                    </div>
                    <span class="badge ${r.status === 'confirmed' ? 'bg-success' : 'bg-warning'}">${r.status === 'confirmed' ? '已確認' : '待確認'}</span>
                  </div>
                `).join('') : '<div class="text-center text-muted py-3">尚無報名</div>'}
              </div>
            </div>
          </div>
        </div>
      `;
      modal.show();
    } catch (error) {
      Util.showToast('error', '載入活動詳情失敗：' + error.message);
    }
  },
  
  async register(id) {
    // 簡化版報名表單
    const { value: formValues } = await Swal.fire({
      title: '活動報名',
      html: `
        <div class="text-start">
          <div class="mb-3">
            <label class="form-label">姓名 *</label>
            <input id="regName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">電話 *</label>
            <input id="regPhone" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input id="regEmail" type="email" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">緊急聯絡人</label>
            <input id="regEmergency" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">備註</label>
            <textarea id="regNotes" class="form-control" rows="2"></textarea>
          </div>
        </div>
      `,
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: '確認報名',
      cancelButtonText: '取消',
      preConfirm: () => {
        const name = document.getElementById('regName').value.trim();
        const phone = document.getElementById('regPhone').value.trim();
        if (!name || !phone) {
          Swal.showValidationMessage('請填寫必填欄位');
          return false;
        }
        return {
          name,
          phone,
          email: document.getElementById('regEmail').value.trim(),
          emergency: document.getElementById('regEmergency').value.trim(),
          notes: document.getElementById('regNotes').value.trim()
        };
      }
    });
    
    if (formValues) {
      try {
        const registration = {
          activityId: id,
          participantName: formValues.name,
          participantPhone: formValues.phone,
          participantEmail: formValues.email,
          emergencyContact: formValues.emergency,
          notes: formValues.notes,
          registrationDate: Util.today(),
          status: 'confirmed'
        };
        
        await API.call('addRegistration', { registration });
        this.renderGrid();
        Util.showToast('success', '報名成功');
      } catch (error) {
        Util.showToast('error', '報名失敗：' + error.message);
      }
    }
  },
  
  async manageRegistrations(id) {
    try {
      const activities = await API.call('getActivities');
      const activity = activities.find(x => x.id === id);
      const registrations = await API.call('getRegistrations', { activityId: id });
      
      if (!activity) return;
      
      const modal = new bootstrap.Modal(document.getElementById('registrationManageModal'));
      document.getElementById('registrationManageTitle').textContent = `${activity.name} - 報名管理`;
      
      const tbody = document.getElementById('registrationManageBody');
      if (!registrations.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">尚無報名</td></tr>';
      } else {
        tbody.innerHTML = registrations.map(r => `
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="participant-avatar small-avatar me-2">${r.participantName.charAt(0)}</div>
                <div>
                  <div class="fw-semibold">${r.participantName}</div>
                  <div class="small text-muted">${r.participantPhone}</div>
                </div>
              </div>
            </td>
            <td class="small">${r.participantEmail || '—'}</td>
            <td class="small">${r.emergencyContact || '—'}</td>
            <td class="small">${r.registrationDate}</td>
            <td><span class="badge ${r.status === 'confirmed' ? 'bg-success' : 'bg-warning'}">${r.status === 'confirmed' ? '已確認' : '待確認'}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-danger" onclick="Activities.deleteRegistration('${r.id}')" title="刪除">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');
      }
      
      modal.show();
    } catch (error) {
      Util.showToast('error', '載入報名資料失敗：' + error.message);
    }
  },
  
  async deleteRegistration(id) {
    const result = await Util.confirm({ title: '刪除報名', text: '確定刪除此筆報名？', confirmColor: '#dc3545' });
    if (!result.isConfirmed) return;
    
    try {
      await API.call('deleteRegistration', { id });
      // 重新載入報名管理視窗
      const modal = bootstrap.Modal.getInstance(document.getElementById('registrationManageModal'));
      if (modal) {
        // 從當前顯示的活動ID重新載入
        // 這裡需要追蹤當前管理的活動ID
        this.renderGrid();
      }
      Util.showToast('success', '已刪除報名');
    } catch (error) {
      Util.showToast('error', '刪除失敗：' + error.message);
    }
  },
  
  async delete(id) {
    const result = await Util.confirm({ title: '刪除活動', text: '確定刪除此活動？相關報名也會一併刪除。', confirmColor: '#dc3545' });
    if (!result.isConfirmed) return;
    
    try {
      await API.call('deleteActivity', { id });
      this.renderGrid();
      Util.showToast('success', '已刪除活動');
    } catch (error) {
      Util.showToast('error', '刪除失敗：' + error.message);
    }
  }
};

/* 活動 UI 控制 */
const ActivityUI = {
  modal: null,
  
  async open(id = null) {
    if (!this.modal) this.modal = new bootstrap.Modal(document.getElementById('activityModal'));
    
    document.getElementById('activityForm').reset();
    document.getElementById('activityId').value = '';
    
    if (id) {
      try {
        const activities = await API.call('getActivities');
        const a = activities.find(x => x.id === id);
        if (a) {
          document.getElementById('activityModalTitle').textContent = '編輯活動';
          document.getElementById('activityId').value = a.id;
          document.getElementById('activityName').value = a.name;
          document.getElementById('activityDate').value = a.date;
          document.getElementById('activityStartTime').value = a.startTime || '';
          document.getElementById('activityEndTime').value = a.endTime || '';
          document.getElementById('activityLocation').value = a.location || '';
          document.getElementById('activityFee').value = a.fee || '';
          document.getElementById('activityMaxParticipants').value = a.maxParticipants || '';
          document.getElementById('activityStatus').value = a.status;
          document.getElementById('activityDescription').value = a.description || '';
          document.getElementById('activityRequirements').value = a.requirements || '';
          document.getElementById('activityNotes').value = a.notes || '';
        }
      } catch (error) {
        Util.showToast('error', '載入活動資料失敗：' + error.message);
      }
    } else {
      document.getElementById('activityModalTitle').textContent = '新增活動';
      document.getElementById('activityDate').value = Util.today();
      document.getElementById('activityStatus').value = 'draft';
      document.getElementById('activityFee').value = '0';
    }
    
    this.modal.show();
  },
  
  async save() {
    const form = document.getElementById('activityForm');
    if (!form.checkValidity()) { form.reportValidity(); return; }
    
    const id = document.getElementById('activityId').value;
    
    const activity = {
      id: id || Util.uuid(),
      name: document.getElementById('activityName').value.trim(),
      date: document.getElementById('activityDate').value,
      startTime: document.getElementById('activityStartTime').value,
      endTime: document.getElementById('activityEndTime').value,
      location: document.getElementById('activityLocation').value.trim(),
      fee: Util.toNumber(document.getElementById('activityFee').value),
      maxParticipants: parseInt(document.getElementById('activityMaxParticipants').value) || 0,
      status: document.getElementById('activityStatus').value,
      description: document.getElementById('activityDescription').value.trim(),
      requirements: document.getElementById('activityRequirements').value.trim(),
      notes: document.getElementById('activityNotes').value.trim()
    };
    
    try {
      if (id) {
        await API.call('updateActivity', { activity });
        Util.showToast('success', '活動已更新');
      } else {
        await API.call('addActivity', { activity });
        Util.showToast('success', '活動已新增');
      }
      
      this.modal.hide();
      Activities.renderGrid();
    } catch (error) {
      Util.showToast('error', '儲存失敗：' + error.message);
    }
  }
};


/* -------------------- 公告管理模組 -------------------- */
const Announcements = {
  async render() {
    try {
      const announcements = await API.call('getAnnouncements');
      const container = document.getElementById('announcementsContainer');
      
      if (!announcements.length) {
        container.innerHTML = `<div class="text-center text-muted py-5">
          <i class="bi bi-megaphone display-1 d-block mb-3"></i>
          <h5>尚無公告</h5>
          <p>點擊右上角「新增公告」開始發布公告</p>
        </div>`;
        return;
      }
      
      container.innerHTML = announcements.map(a => `
        <div class="announcement-card card mb-3 ${a.urgent ? 'urgent' : ''}">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <div>
              <span class="badge ${a.urgent ? 'bg-danger' : 'bg-info'}">${a.urgent ? '緊急' : '一般'}</span>
              <span class="badge ${a.status === 'published' ? 'bg-success' : 'bg-secondary'} ms-1">${a.status === 'published' ? '已發布' : '草稿'}</span>
            </div>
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                <i class="bi bi-three-dots"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" onclick="AnnouncementUI.open('${a.id}')"><i class="bi bi-pencil me-2"></i>編輯</a></li>
                <li><a class="dropdown-item" href="#" onclick="Announcements.toggleStatus('${a.id}')"><i class="bi bi-eye me-2"></i>${a.status === 'published' ? '取消發布' : '發布'}</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="#" onclick="Announcements.delete('${a.id}')"><i class="bi bi-trash me-2"></i>刪除</a></li>
              </ul>
            </div>
          </div>
          <div class="card-body">
            <h6 class="card-title fw-semibold">${a.title}</h6>
            <p class="card-text">${a.content}</p>
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">發布日期: ${a.publishDate}</small>
              <small class="text-muted">作者: ${a.author}</small>
            </div>
          </div>
        </div>
      `).join('');
    } catch (error) {
      Util.showToast('error', '載入公告失敗：' + error.message);
    }
  },
  
  async toggleStatus(id) {
    try {
      await API.call('toggleAnnouncementStatus', { id });
      this.render();
      Util.showToast('success', '狀態已更新');
    } catch (error) {
      Util.showToast('error', '更新失敗：' + error.message);
    }
  },
  
  async delete(id) {
    const result = await Util.confirm({ title: '刪除公告', text: '確定刪除此公告？', confirmColor: '#dc3545' });
    if (!result.isConfirmed) return;
    
    try {
      await API.call('deleteAnnouncement', { id });
      this.render();
      Util.showToast('success', '已刪除公告');
    } catch (error) {
      Util.showToast('error', '刪除失敗：' + error.message);
    }
  }
};

const AnnouncementUI = {
  modal: null,
  
  async open(id = null) {
    if (!this.modal) this.modal = new bootstrap.Modal(document.getElementById('announcementModal'));
    
    document.getElementById('announcementForm').reset();
    document.getElementById('announcementId').value = '';
    
    if (id) {
      try {
        const announcements = await API.call('getAnnouncements');
        const a = announcements.find(x => x.id === id);
        if (a) {
          document.getElementById('announcementModalTitle').textContent = '編輯公告';
          document.getElementById('announcementId').value = a.id;
          document.getElementById('announcementTitle').value = a.title;
          document.getElementById('announcementContent').value = a.content;
          document.getElementById('announcementPublishDate').value = a.publishDate;
          document.getElementById('announcementAuthor').value = a.author;
          document.getElementById('announcementUrgent').checked = a.urgent;
          document.getElementById('announcementStatus').value = a.status;
        }
      } catch (error) {
        Util.showToast('error', '載入公告資料失敗：' + error.message);
      }
    } else {
      document.getElementById('announcementModalTitle').textContent = '新增公告';
      document.getElementById('announcementPublishDate').value = Util.today();
      document.getElementById('announcementAuthor').value = '系統管理員';
      document.getElementById('announcementStatus').value = 'draft';
    }
    
    this.modal.show();
  },
  
  async save() {
    const form = document.getElementById('announcementForm');
    if (!form.checkValidity()) { form.reportValidity(); return; }
    
    const id = document.getElementById('announcementId').value;
    
    const announcement = {
      id: id || Util.uuid(),
      title: document.getElementById('announcementTitle').value.trim(),
      content: document.getElementById('announcementContent').value.trim(),
      publishDate: document.getElementById('announcementPublishDate').value,
      author: document.getElementById('announcementAuthor').value.trim(),
      urgent: document.getElementById('announcementUrgent').checked,
      status: document.getElementById('announcementStatus').value
    };
    
    try {
      if (id) {
        await API.call('updateAnnouncement', { announcement });
        Util.showToast('success', '公告已更新');
      } else {
        await API.call('addAnnouncement', { announcement });
        Util.showToast('success', '公告已新增');
      }
      
      this.modal.hide();
      Announcements.render();
    } catch (error) {
      Util.showToast('error', '儲存失敗：' + error.message);
    }
  }
};

/* -------------------- 行政表單模組 -------------------- */
const Forms = {
  templates: {
    membershipApplication: { name: '入會申請書', icon: 'bi-person-plus' },
    feeReceipt: { name: '會費收據', icon: 'bi-receipt' },
    activityRegistration: { name: '活動報名表', icon: 'bi-calendar-check' },
    expenseVoucher: { name: '支出憑證', icon: 'bi-receipt-cutoff' },
    meetingMinutes: { name: '會議紀錄', icon: 'bi-journal-text' },
    volunteerApplication: { name: '志工申請表', icon: 'bi-heart' }
  },
  
  render() {
    const container = document.getElementById('formsContainer');
    container.innerHTML = Object.entries(this.templates).map(([key, template]) => `
      <div class="col-lg-4 col-md-6 mb-3">
        <div class="form-download-item">
          <div class="d-flex align-items-center mb-2">
            <i class="${template.icon} me-2 text-primary" style="font-size:24px;"></i>
            <h6 class="mb-0 fw-semibold">${template.name}</h6>
          </div>
          <p class="text-muted small mb-3">標準格式表單，可下載填寫使用</p>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" onclick="Forms.download('${key}', 'pdf')">
              <i class="bi bi-file-earmark-pdf"></i> PDF
            </button>
            <button class="btn btn-sm btn-outline-success" onclick="Forms.download('${key}', 'docx')">
              <i class="bi bi-file-earmark-word"></i> Word
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="Forms.preview('${key}')">
              <i class="bi bi-eye"></i> 預覽
            </button>
          </div>
        </div>
      </div>
    `).join('');
  },
  
  download(formType, format) {
    // 實際應該從後端產生表單檔案
    Util.showToast('info', `下載 ${this.templates[formType].name} (${format.toUpperCase()}) 功能開發中`);
  },
  
  preview(formType) {
    const template = this.templates[formType];
    Swal.fire({
      title: template.name + ' 預覽',
      html: this.generatePreview(formType),
      width: '800px',
      showConfirmButton: false,
      showCancelButton: true,
      cancelButtonText: '關閉'
    });
  },
  
  generatePreview(formType) {
    switch (formType) {
      case 'membershipApplication':
        return `
          <div class="text-start p-3">
            <h5 class="text-center mb-4">台灣帕金森病友權益促進會 入會申請書</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">姓名</label>
                <input class="form-control" placeholder="請填寫姓名">
              </div>
              <div class="col-md-6">
                <label class="form-label">身分證字號</label>
                <input class="form-control" placeholder="請填寫身分證字號">
              </div>
              <div class="col-md-6">
                <label class="form-label">出生日期</label>
                <input type="date" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">性別</label>
                <select class="form-control">
                  <option>男</option>
                  <option>女</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">聯絡地址</label>
                <input class="form-control" placeholder="請填寫完整地址">
              </div>
              <div class="col-md-6">
                <label class="form-label">聯絡電話</label>
                <input class="form-control" placeholder="請填寫聯絡電話">
              </div>
              <div class="col-md-6">
                <label class="form-label">電子信箱</label>
                <input type="email" class="form-control" placeholder="請填寫電子信箱">
              </div>
            </div>
            <div class="mt-4 text-center">
              <p class="small text-muted">申請人簽名：_________________ 日期：_________________</p>
            </div>
          </div>
        `;
      case 'feeReceipt':
        return `
          <div class="text-start p-3">
            <div class="d-flex justify-content-between align-items-start mb-4">
              <div>
                <h5>台灣帕金森病友權益促進會</h5>
                <p class="mb-0">會費收據</p>
              </div>
              <div class="receipt-seal-placeholder">
                會章
              </div>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <strong>收據編號：</strong>R20240001
              </div>
              <div class="col-md-6">
                <strong>收費日期：</strong>${Util.today()}
              </div>
              <div class="col-12">
                <strong>收費項目：</strong>年度會費
              </div>
              <div class="col-md-6">
                <strong>繳費人：</strong>_______________
              </div>
              <div class="col-md-6">
                <strong>金額：</strong>NT$ 1,000
              </div>
              <div class="col-12">
                <strong>大寫金額：</strong>${Util.financialChinese(1000)}
              </div>
            </div>
            <div class="mt-4 text-end">
              <p class="small">經手人：_____________</p>
            </div>
          </div>
        `;
      default:
        return '<p class="text-center text-muted">表單預覽功能開發中</p>';
    }
  }
};

/* -------------------- 統計分析模組 -------------------- */
const Analytics = {
  charts: {},
  
  async refresh() {
    try {
      const data = await API.call('getAnalyticsData');
      this.renderIncomeExpenseChart(data.monthlyData);
      this.renderCategoryChart(data.categoryData);
      this.renderMemberChart(data.memberData);
      this.renderActivityChart(data.activityData);
    } catch (error) {
      Util.showToast('error', '載入統計資料失敗：' + error.message);
    }
  },
  
  renderIncomeExpenseChart(data) {
    const ctx = document.getElementById('incomeExpenseChart');
    if (!ctx) return;
    
    if (this.charts.incomeExpense) {
      this.charts.incomeExpense.destroy();
    }
    
    this.charts.incomeExpense = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(d => d.month),
        datasets: [{
          label: '收入',
          data: data.map(d => d.income),
          borderColor: '#198754',
          backgroundColor: 'rgba(25, 135, 84, 0.1)',
          tension: 0.4
        }, {
          label: '支出',
          data: data.map(d => d.expense),
          borderColor: '#dc3545',
          backgroundColor: 'rgba(220, 53, 69, 0.1)',
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: { display: true, text: '月度收支趨勢' }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  },
  
  renderCategoryChart(data) {
    const ctx = document.getElementById('categoryChart');
    if (!ctx) return;
    
    if (this.charts.category) {
      this.charts.category.destroy();
    }
    
    this.charts.category = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: data.map(d => d.category),
        datasets: [{
          data: data.map(d => d.amount),
          backgroundColor: [
            '#0d6efd', '#198754', '#ffc107', '#dc3545',
            '#6f42c1', '#fd7e14', '#20c997', '#6c757d'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: { display: true, text: '支出類別分布' }
        }
      }
    });
  },
  
  renderMemberChart(data) {
    const ctx = document.getElementById('memberChart');
    if (!ctx) return;
    
    if (this.charts.member) {
      this.charts.member.destroy();
    }
    
    this.charts.member = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.map(d => d.month),
        datasets: [{
          label: '新增會員',
          data: data.map(d => d.newMembers),
          backgroundColor: '#0d6efd'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: { display: true, text: '會員成長趨勢' }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  },
  
  renderActivityChart(data) {
    const ctx = document.getElementById('activityChart');
    if (!ctx) return;
    
    if (this.charts.activity) {
      this.charts.activity.destroy();
    }
    
    this.charts.activity = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.map(d => d.name),
        datasets: [{
          label: '報名人數',
          data: data.map(d => d.participants),
          backgroundColor: '#198754'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: { display: true, text: '活動參與統計' }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }
};

/* -------------------- 報表中心模組 -------------------- */
const Reports = {
  dateInitialized: false,
  
  initDateOnce() {
    if (this.dateInitialized) return;
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    document.getElementById('reportStartDate').value = firstDay.toISOString().split('T')[0];
    document.getElementById('reportEndDate').value = lastDay.toISOString().split('T')[0];
    this.dateInitialized = true;
  },
  
  async generateReport(type) {
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;
    
    if (!startDate || !endDate) {
      return Util.showToast('error', '請選擇報表期間');
    }
    
    try {
      const data = await API.call('generateReport', { type, startDate, endDate });
      this.displayReport(type, data, startDate, endDate);
    } catch (error) {
      Util.showToast('error', '產生報表失敗：' + error.message);
    }
  },
  
  displayReport(type, data, startDate, endDate) {
    const container = document.getElementById('reportResult');
    const period = `${startDate} 至 ${endDate}`;
    
    switch (type) {
      case 'financial':
        container.innerHTML = this.renderFinancialReport(data, period);
        break;
      case 'member':
        container.innerHTML = this.renderMemberReport(data, period);
        break;
      case 'activity':
        container.innerHTML = this.renderActivityReport(data, period);
        break;
      default:
        container.innerHTML = '<p class="text-muted">未知的報表類型</p>';
    }
  },
  
  renderFinancialReport(data, period) {
    return `
      <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0">財務報表 (${period})</h6>
          <button class="btn btn-sm btn-outline-primary" onclick="Reports.printReport()">
            <i class="bi bi-printer"></i> 列印
          </button>
        </div>
        <div class="card-body">
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <div class="text-center p-3 border rounded">
                <h5 class="text-success mb-1">$${Util.fmtNum(data.totalIncome)}</h5>
                <small class="text-muted">總收入</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="text-center p-3 border rounded">
                <h5 class="text-danger mb-1">$${Util.fmtNum(data.totalExpense)}</h5>
                <small class="text-muted">總支出</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="text-center p-3 border rounded">
                <h5 class="${data.netIncome >= 0 ? 'text-success' : 'text-danger'} mb-1">$${Util.fmtNum(data.netIncome)}</h5>
                <small class="text-muted">淨收入</small>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-lg-6">
              <h6 class="fw-semibold mb-2">收入明細</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead class="table-light">
                    <tr><th>類別</th><th class="text-end">金額</th><th class="text-end">比例</th></tr>
                  </thead>
                  <tbody>
                    ${data.incomeByCategory.map(item => `
                      <tr>
                        <td>${item.category}</td>
                        <td class="text-end">$${Util.fmtNum(item.amount)}</td>
                        <td class="text-end">${((item.amount / data.totalIncome) * 100).toFixed(1)}%</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-lg-6">
              <h6 class="fw-semibold mb-2">支出明細</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead class="table-light">
                    <tr><th>類別</th><th class="text-end">金額</th><th class="text-end">比例</th></tr>
                  </thead>
                  <tbody>
                    ${data.expenseByCategory.map(item => `
                      <tr>
                        <td>${item.category}</td>
                        <td class="text-end">$${Util.fmtNum(item.amount)}</td>
                        <td class="text-end">${((item.amount / data.totalExpense) * 100).toFixed(1)}%</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  },
  
  renderMemberReport(data, period) {
    return `
      <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0">會員報表 (${period})</h6>
          <button class="btn btn-sm btn-outline-primary" onclick="Reports.printReport()">
            <i class="bi bi-printer"></i> 列印
          </button>
        </div>
        <div class="card-body">
          <div class="row g-3 mb-4">
            <div class="col-md-3">
              <div class="text-center p-3 border rounded">
                <h5 class="text-primary mb-1">${data.totalMembers}</h5>
                <small class="text-muted">總會員數</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center p-3 border rounded">
                <h5 class="text-success mb-1">${data.newMembers}</h5>
                <small class="text-muted">新增會員</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center p-3 border rounded">
                <h5 class="text-warning mb-1">${data.overdueMembers}</h5>
                <small class="text-muted">逾期會費</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center p-3 border rounded">
                <h5 class="text-info mb-1">$${Util.fmtNum(data.totalFeeCollected)}</h5>
                <small class="text-muted">會費收入</small>
              </div>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table">
              <thead class="table-light">
                <tr><th>會員類型</th><th class="text-end">人數</th><th class="text-end">比例</th></tr>
              </thead>
              <tbody>
                ${data.membersByType.map(item => `
                  <tr>
                    <td>${Members.typeText(item.type)}</td>
                    <td class="text-end">${item.count}</td>
                    <td class="text-end">${((item.count / data.totalMembers) * 100).toFixed(1)}%</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
  },
  
  renderActivityReport(data, period) {
    return `
      <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0">活動報表 (${period})</h6>
          <button class="btn btn-sm btn-outline-primary" onclick="Reports.printReport()">
            <i class="bi bi-printer"></i> 列印
          </button>
        </div>
        <div class="card-body">
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <div class="text-center p-3 border rounded">
                <h5 class="text-primary mb-1">${data.totalActivities}</h5>
                <small class="text-muted">總活動數</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="text-center p-3 border rounded">
                <h5 class="text-success mb-1">${data.totalParticipants}</h5>
                <small class="text-muted">總參與人次</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="text-center p-3 border rounded">
                <h5 class="text-info mb-1">$${Util.fmtNum(data.totalRevenue)}</h5>
                <small class="text-muted">活動收入</small>
              </div>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table">
              <thead class="table-light">
                <tr><th>活動名稱</th><th>日期</th><th class="text-end">參與人數</th><th class="text-end">收入</th></tr>
              </thead>
              <tbody>
                ${data.activities.map(item => `
                  <tr>
                    <td>${item.name}</td>
                    <td>${item.date}</td>
                    <td class="text-end">${item.participants}</td>
                    <td class="text-end">$${Util.fmtNum(item.revenue)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
  },
  
  printReport() {
    window.print();
  }
};

/* -------------------- 列印模組 -------------------- */
const Print = {
  async receipt(transactionId) {
    try {
      const transactions = await API.call('getTransactions');
      const t = transactions.find(x => x.id === transactionId);
      if (!t || t.type !== '收入') return;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(this.generateReceiptHTML(t));
      printWindow.document.close();
      printWindow.print();
    } catch (error) {
      Util.showToast('error', '列印收據失敗：' + error.message);
    }
  },
  
  async voucher(transactionId) {
    try {
      const transactions = await API.call('getTransactions');
      const t = transactions.find(x => x.id === transactionId);
      if (!t || t.type !== '支出') return;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(this.generateVoucherHTML(t));
      printWindow.document.close();
      printWindow.print();
    } catch (error) {
      Util.showToast('error', '列印憑證失敗：' + error.message);
    }
  },
  
  generateReceiptHTML(transaction) {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>收據 - ${transaction.receiptNumber}</title>
        <style>
          body { font-family: 'Microsoft JhengHei', sans-serif; margin: 20px; }
          .receipt-header { text-align: center; margin-bottom: 30px; }
          .receipt-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
          .receipt-number { font-size: 18px; color: #666; }
          .receipt-body { border: 2px solid #000; padding: 20px; }
          .receipt-row { display: flex; justify-content: space-between; margin-bottom: 15px; }
          .receipt-label { font-weight: bold; }
          .receipt-amount { font-size: 20px; font-weight: bold; color: #d63384; }
          .receipt-footer { text-align: right; margin-top: 30px; }
          .seal-area { width: 80px; height: 80px; border: 1px dashed #ccc; display: inline-block; text-align: center; line-height: 80px; }
        </style>
      </head>
      <body>
        <div class="receipt-header">
          <div class="receipt-title">台灣帕金森病友權益促進會</div>
          <div class="receipt-number">收據編號：${transaction.receiptNumber}</div>
        </div>
        <div class="receipt-body">
          <div class="receipt-row">
            <span class="receipt-label">收費日期：</span>
            <span>${transaction.date}</span>
          </div>
          <div class="receipt-row">
            <span class="receipt-label">繳費人：</span>
            <span>${transaction.counterparty || '_______________'}</span>
          </div>
          <div class="receipt-row">
            <span class="receipt-label">收費項目：</span>
            <span>${transaction.category}</span>
          </div>
          <div class="receipt-row">
            <span class="receipt-label">金額：</span>
            <span class="receipt-amount">NT$ ${Util.fmtNum(transaction.amount)}</span>
          </div>
          <div class="receipt-row">
            <span class="receipt-label">大寫金額：</span>
            <span>${Util.financialChinese(transaction.amount)}</span>
          </div>
          ${transaction.description ? `
            <div class="receipt-row">
              <span class="receipt-label">說明：</span>
              <span>${transaction.description}</span>
            </div>
          ` : ''}
        </div>
        <div class="receipt-footer">
          <p>經手人：_______________ <span class="seal-area">會章</span></p>
          <p>列印時間：${new Date().toLocaleString('zh-TW')}</p>
        </div>
      </body>
      </html>
    `;
  },
  
  generateVoucherHTML(transaction) {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>支出憑證 - ${transaction.voucherNumber}</title>
        <style>
          body { font-family: 'Microsoft JhengHei', sans-serif; margin: 20px; }
          .voucher-header { text-align: center; margin-bottom: 30px; }
          .voucher-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
          .voucher-number { font-size: 18px; color: #666; }
          .voucher-body { border: 2px solid #000; padding: 20px; }
          .voucher-row { display: flex; justify-content: space-between; margin-bottom: 15px; }
          .voucher-label { font-weight: bold; }
          .voucher-amount { font-size: 20px; font-weight: bold; color: #dc3545; }
          .voucher-footer { text-align: right; margin-top: 30px; }
          .seal-area { width: 80px; height: 80px; border: 1px dashed #ccc; display: inline-block; text-align: center; line-height: 80px; }
        </style>
      </head>
      <body>
        <div class="voucher-header">
          <div class="voucher-title">台灣帕金森病友權益促進會</div>
          <div class="voucher-number">支出憑證編號：${transaction.voucherNumber}</div>
        </div>
        <div class="voucher-body">
          <div class="voucher-row">
            <span class="voucher-label">支出日期：</span>
            <span>${transaction.date}</span>
          </div>
          <div class="voucher-row">
            <span class="voucher-label">支付對象：</span>
            <span>${transaction.counterparty || '_______________'}</span>
          </div>
          <div class="voucher-row">
            <span class="voucher-label">支出項目：</span>
            <span>${transaction.category}</span>
          </div>
          <div class="voucher-row">
            <span class="voucher-label">金額：</span>
            <span class="voucher-amount">NT$ ${Util.fmtNum(transaction.amount)}</span>
          </div>
          <div class="voucher-row">
            <span class="voucher-label">大寫金額：</span>
            <span>${Util.financialChinese(transaction.amount)}</span>
          </div>
          ${transaction.description ? `
            <div class="voucher-row">
              <span class="voucher-label">用途說明：</span>
              <span>${transaction.description}</span>
            </div>
          ` : ''}
        </div>
        <div class="voucher-footer">
          <p>經手人：_______________ 審核人：_______________ <span class="seal-area">會章</span></p>
          <p>列印時間：${new Date().toLocaleString('zh-TW')}</p>
        </div>
      </body>
      </html>
    `;
  },
  
  batchReceipts(transactionIds) {
    Util.showToast('info', '批次列印收據功能開發中');
  },
  
  batchVouchers(transactionIds) {
    Util.showToast('info', '批次列印憑證功能開發中');
  }
};

/* -------------------- 資料匯入匯出模組 -------------------- */
const DataPort = {
  async exportTransactions(ids = null) {
    try {
      const transactions = await API.call('getTransactions');
      const data = ids ? transactions.filter(t => ids.includes(t.id)) : transactions;
      
      const csv = this.transactionsToCSV(data);
      this.downloadCSV(csv, `交易記錄_${Util.today()}.csv`);
      Util.showToast('success', `已匯出 ${data.length} 筆交易記錄`);
    } catch (error) {
      Util.showToast('error', '匯出失敗：' + error.message);
    }
  },
  
  async exportMembers(ids = null) {
    try {
      const members = await API.call('getMembers');
      const data = ids ? members.filter(m => ids.includes(m.id)) : members;
      
      const csv = this.membersToCSV(data);
      this.downloadCSV(csv, `會員資料_${Util.today()}.csv`);
      Util.showToast('success', `已匯出 ${data.length} 筆會員資料`);
    } catch (error) {
      Util.showToast('error', '匯出失敗：' + error.message);
    }
  },
  
  transactionsToCSV(transactions) {
    const headers = ['日期', '類型', '類別', '金額', '對象', '帳戶', '說明', '編號'];
    const rows = transactions.map(t => [
      t.date,
      t.type,
      t.category,
      t.amount,
      t.counterparty || '',
      t.account || '',
      t.description || '',
      t.type === '收入' ? (t.receiptNumber || '') : (t.voucherNumber || '')
    ]);
    
    return [headers, ...rows].map(row => 
      row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
    ).join('\n');
  },
  
  membersToCSV(members) {
    const headers = ['姓名', '電話', 'Email', '出生日期', '性別', '身分證', '地址', '加入日期', '狀態', '類型', '年費', '最後繳費'];
    const rows = members.map(m => [
      m.name,
      m.phone,
      m.email || '',
      m.birthDate || '',
      m.gender || '',
      m.idNumber || '',
      m.address || '',
      m.joinDate,
      Members.statusText(m.status),
      Members.typeText(m.type),
      m.membershipFee || '',
      m.lastPaymentDate || ''
    ]);
    
    return [headers, ...rows].map(row => 
      row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
    ).join('\n');
  },
  
  downloadCSV(csvContent, filename) {
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  },
  
  async importData(type) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv,.xlsx';
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const data = this.parseCSV(text);
        
        if (type === 'transactions') {
          await this.importTransactions(data);
        } else if (type === 'members') {
          await this.importMembers(data);
        }
      } catch (error) {
        Util.showToast('error', '匯入失敗：' + error.message);
      }
    };
    input.click();
  },
  
  parseCSV(text) {
    const lines = text.split('\n').filter(line => line.trim());
    const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
    const rows = lines.slice(1).map(line => {
      const values = line.split(',').map(v => v.replace(/"/g, '').trim());
      const obj = {};
      headers.forEach((header, index) => {
        obj[header] = values[index] || '';
      });
      return obj;
    });
    return rows;
  },
  
  async importTransactions(data) {
    // 實際應該有更完整的資料驗證和轉換
    Util.showToast('info', '交易記錄匯入功能開發中');
  },
  
  async importMembers(data) {
    // 實際應該有更完整的資料驗證和轉換
    Util.showToast('info', '會員資料匯入功能開發中');
  }
};

/* -------------------- 系統設定模組 -------------------- */
const Settings = {
  async load() {
    try {
      const settings = await API.call('getSettings');
      this.populateForm(settings);
    } catch (error) {
      Util.showToast('error', '載入設定失敗：' + error.message);
    }
  },
  
  populateForm(settings) {
    document.getElementById('orgName').value = settings.organization?.name || '';
    document.getElementById('orgAddress').value = settings.organization?.address || '';
    document.getElementById('orgPhone').value = settings.organization?.phone || '';
    document.getElementById('orgEmail').value = settings.organization?.email || '';
    document.getElementById('orgWebsite').value = settings.organization?.website || '';
    
    // 收入類別
    const incomeList = document.getElementById('incomeCategoriesList');
    incomeList.innerHTML = (settings.categories?.收入 || []).map(cat => 
      `<div class="category-item">
        <span>${cat}</span>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="Settings.removeCategory('收入', '${cat}')">
          <i class="bi bi-trash"></i>
        </button>
      </div>`
    ).join('');
    
    // 支出類別
    const expenseList = document.getElementById('expenseCategoriesList');
    expenseList.innerHTML = (settings.categories?.支出 || []).map(cat => 
      `<div class="category-item">
        <span>${cat}</span>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="Settings.removeCategory('支出', '${cat}')">
          <i class="bi bi-trash"></i>
        </button>
      </div>`
    ).join('');
    
    // 帳戶設定
    document.getElementById('defaultMembershipFee').value = settings.membership?.defaultFee || '';
    document.getElementById('feeReminderDays').value = settings.membership?.reminderDays || '';
  },
  
  addCategory(type) {
    const inputId = type === '收入' ? 'newIncomeCategory' : 'newExpenseCategory';
    const input = document.getElementById(inputId);
    const category = input.value.trim();
    
    if (!category) return;
    
    // 檢查是否已存在
    const listId = type === '收入' ? 'incomeCategoriesList' : 'expenseCategoriesList';
    const list = document.getElementById(listId);
    const existing = [...list.querySelectorAll('.category-item span')].map(span => span.textContent);
    
    if (existing.includes(category)) {
      Util.showToast('error', '類別已存在');
      return;
    }
    
    // 新增到列表
    const item = document.createElement('div');
    item.className = 'category-item';
    item.innerHTML = `
      <span>${category}</span>
      <button type="button" class="btn btn-sm btn-outline-danger" onclick="Settings.removeCategory('${type}', '${category}')">
        <i class="bi bi-trash"></i>
      </button>
    `;
    list.appendChild(item);
    
    input.value = '';
  },
  
  removeCategory(type, category) {
    const listId = type === '收入' ? 'incomeCategoriesList' : 'expenseCategoriesList';
    const list = document.getElementById(listId);
    const items = list.querySelectorAll('.category-item');
    
    items.forEach(item => {
      if (item.querySelector('span').textContent === category) {
        item.remove();
      }
    });
  },
  
  async save() {
    try {
      const incomeCategories = [...document.querySelectorAll('#incomeCategoriesList .category-item span')]
        .map(span => span.textContent);
      const expenseCategories = [...document.querySelectorAll('#expenseCategoriesList .category-item span')]
        .map(span => span.textContent);
      
      const settings = {
        organization: {
          name: document.getElementById('orgName').value.trim(),
          address: document.getElementById('orgAddress').value.trim(),
          phone: document.getElementById('orgPhone').value.trim(),
          email: document.getElementById('orgEmail').value.trim(),
          website: document.getElementById('orgWebsite').value.trim()
        },
        categories: {
          收入: incomeCategories,
          支出: expenseCategories
        },
        membership: {
          defaultFee: Util.toNumber(document.getElementById('defaultMembershipFee').value),
          reminderDays: parseInt(document.getElementById('feeReminderDays').value) || 30
        }
      };
      
      await API.call('updateSettings', { settings });
      Util.showToast('success', '設定已儲存');
    } catch (error) {
      Util.showToast('error', '儲存設定失敗：' + error.message);
    }
  },
  
  async backup() {
    try {
      const data = await API.call('exportAllData');
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `系統備份_${Util.today()}.json`;
      link.click();
      URL.revokeObjectURL(url);
      Util.showToast('success', '備份檔案已下載');
    } catch (error) {
      Util.showToast('error', '備份失敗：' + error.message);
    }
  },
  
  async restore() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const result = await Util.confirm({
        title: '還原系統',
        text: '此操作將覆蓋所有現有資料，確定要繼續嗎？',
        confirmColor: '#dc3545'
      });
      
      if (!result.isConfirmed) return;
      
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        await API.call('importAllData', { data });
        Util.showToast('success', '系統已還原，請重新整理頁面');
        setTimeout(() => window.location.reload(), 2000);
      } catch (error) {
        Util.showToast('error', '還原失敗：' + error.message);
      }
    };
    input.click();
  }
};

/* -------------------- 主程式初始化 -------------------- */
document.addEventListener('DOMContentLoaded', () => {
  // 載入 Chart.js
  if (typeof Chart === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = () => Analytics.refresh();
    document.head.appendChild(script);
  }
  
  // 初始化報表日期
  Reports.initDateOnce();
  
  // 載入表單模板
  Forms.render();
  
  // 載入公告
  if (document.getElementById('announcementsContainer')) {
    Announcements.render();
  }
  
  // 載入活動
  if (document.getElementById('activitiesGrid')) {
    Activities.renderGrid();
  }
  
  // 載入設定
  if (document.getElementById('orgName')) {
    Settings.load();
  }
  
  console.log('系統模組全部載入完成');
});




/* -------------------- 系統初始化 -------------------- */
document.addEventListener('DOMContentLoaded', () => {
  // 初始化儀表板
  Dashboard.refresh();
  
  // 設定快捷鍵
  document.addEventListener('keydown', e => {
    if (e.ctrlKey || e.metaKey) {
      switch (e.key) {
        case 't': e.preventDefault(); TransactionUI.open(); break;
        case 'm': e.preventDefault(); MemberUI.open(); break;
        case 'a': e.preventDefault(); ActivityUI.open(); break;
        case 'f': e.preventDefault(); document.getElementById('globalSearchInput').focus(); break;
      }
    }
  });
  
  // 全域搜尋
  window.GlobalSearch = {
    exec() {
      const query = document.getElementById('globalSearchInput').value.trim();
      if (!query) return;
      
      // 簡化搜尋 - 實際應該呼叫後端搜尋API
      Util.showToast('info', `搜尋「${query}」功能開發中`);
    }
  };
  
  // 其他初始化...
  console.log('台灣帕金森病友權益促進會管理系統已載入');
});

// 匯出主要模組供外部使用
window.AppModules = {
  Dashboard, Transactions, TransactionUI, Members, MemberUI,
  Activities, ActivityUI, API, Util, AppLayout
};

// 全域函數註冊
window.Announcements = Announcements;
window.AnnouncementUI = AnnouncementUI;
window.Forms = Forms;
window.Analytics = Analytics;
window.Reports = Reports;
window.Print = Print;
window.DataPort = DataPort;
window.Settings = Settings;

    </script>
  </body>
</html>
