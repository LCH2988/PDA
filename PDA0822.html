<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會 - 雲端會計管理系統</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <!-- SweetAlert2 -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <style>
      :root {
          --primary-color: #2c5aa0;
          --secondary-color: #f8f9fa;
          --success-color: #198754;
          --danger-color: #dc3545;
          --warning-color: #ffc107;
      }

      body {
          background-color: var(--secondary-color);
          font-family: 'Microsoft JhengHei', sans-serif;
      }

      .navbar-brand {
          font-weight: bold;
          color: var(--primary-color) !important;
      }

      .card {
          border: none;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          transition: transform 0.2s;
          border-radius: 12px;
      }

      .card:hover {
          transform: translateY(-2px);
      }

      .stat-card {
          background: linear-gradient(135deg, var(--primary-color), #4a90e2);
          color: white;
          border-radius: 15px;
      }

      .stat-card h3 {
          font-size: 2.5rem;
          font-weight: bold;
      }

      .btn-primary {
          background-color: var(--primary-color);
          border-color: var(--primary-color);
          border-radius: 8px;
          font-weight: 500;
      }

      .btn-primary:hover {
          background-color: #1e3d6f;
          border-color: #1e3d6f;
      }

      .table th {
          background-color: var(--secondary-color);
          font-weight: 600;
          border-top: none;
      }

      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }

      .loading-spinner {
          color: white;
          font-size: 3rem;
      }

      .sync-status {
          position: fixed;
          top: 80px;
          right: 20px;
          z-index: 1000;
      }

      .cloud-status {
          position: fixed;
          top: 120px;
          right: 20px;
          z-index: 1000;
      }

      .member-avatar {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          background-color: var(--secondary-color);
          font-size: 18px;
          color: #6c757d;
      }

      .action-buttons {
          display: flex;
          gap: 5px;
          flex-wrap: wrap;
      }

      .action-buttons .btn {
          padding: 0.25rem 0.5rem;
      }

      .chart-container {
          position: relative;
          height: 400px;
      }

      .sidebar {
          min-height: 100vh;
          background: linear-gradient(180deg, var(--primary-color), #1e3d6f);
      }

      .sidebar .nav-link {
          color: rgba(255,255,255,0.8);
          padding: 12px 20px;
          border-radius: 8px;
          margin: 4px 0;
          transition: all 0.3s;
      }

      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
          color: white;
          background-color: rgba(255,255,255,0.1);
          transform: translateX(5px);
      }

      .main-content {
          padding: 20px;
      }

      .content-section {
          animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .voucher-preview {
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
          margin-top: 10px;
      }

      .voucher-preview img {
          max-width: 100px;
          max-height: 100px;
          object-fit: cover;
          border-radius: 5px;
          margin: 5px;
          cursor: pointer;
      }

      .search-summary {
          background-color: #e3f2fd;
          border-left: 4px solid var(--primary-color);
          padding: 10px 15px;
          margin-bottom: 20px;
      }

      .form-control, .form-select {
          border-radius: 8px;
          border: 1px solid #e0e0e0;
      }

      .form-control:focus, .form-select:focus {
          border-color: var(--primary-color);
          box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25);
      }

      .modal-content {
          border-radius: 12px;
          border: none;
      }

      .modal-header {
          background: linear-gradient(135deg, var(--primary-color), #4a90e2);
          color: white;
          border-radius: 12px 12px 0 0;
      }

      .pagination .page-link {
          border-radius: 8px;
          margin: 0 2px;
          border: none;
          color: var(--primary-color);
      }

      .pagination .page-item.active .page-link {
          background: var(--primary-color);
          border-color: var(--primary-color);
      }

      .spin {
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .electronic-seal {
          width: 60px;
          height: 60px;
          border: 2px solid #dc3545;
          border-radius: 50%;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          font-size: 12px;
          font-weight: bold;
          color: #dc3545;
          margin: 0 10px;
          text-align: center;
          line-height: 1.2;
      }

      .report-section {
          margin-bottom: 30px;
          padding: 20px;
          border: 1px solid #dee2e6;
          border-radius: 8px;
      }

      .report-header {
          text-align: center;
          margin-bottom: 30px;
          padding-bottom: 20px;
          border-bottom: 2px solid var(--primary-color);
      }

      .member-history-card {
          border-left: 4px solid var(--primary-color);
          margin-bottom: 10px;
      }

      .auth-container {
          max-width: 400px;
          margin: 100px auto;
          padding: 30px;
          background: white;
          border-radius: 15px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      }

      .sync-indicator {
          display: inline-flex;
          align-items: center;
          gap: 5px;
      }

      .conflict-resolution {
          background: #fff3cd;
          border: 1px solid #ffeaa7;
          padding: 15px;
          border-radius: 8px;
          margin: 10px 0;
      }

      @media (max-width: 768px) {
          .sidebar {
              min-height: auto;
              position: fixed;
              z-index: 1000;
              transform: translateX(-100%);
              transition: transform 0.3s ease;
              width: 250px;
          }
          
          .sidebar.show {
              transform: translateX(0);
          }
          
          .main-content {
              margin-left: 0;
          }
          
          .stat-card h3 {
              font-size: 1.8rem;
          }
          
          .action-buttons {
              flex-direction: column;
          }
          
          .table-responsive {
              font-size: 0.875rem;
          }
      }

      @media print {
          .sidebar, .no-print, .navbar {
              display: none !important;
          }
          
          .main-content {
              margin-left: 0 !important;
              padding: 0 !important;
          }
      }
  </style>
</head>
<body>
  <!-- 載入中覆蓋層 -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
      <div class="text-center">
          <div class="loading-spinner">
              <i class="bi bi-arrow-clockwise spin"></i>
          </div>
          <div class="text-white mt-3" id="loadingText">載入中...</div>
      </div>
  </div>

  <!-- 雲端同步狀態指示器 -->
  <div id="syncStatus" class="sync-status">
      <span class="badge bg-secondary" id="syncIndicator">
          <i class="bi bi-cloud-slash"></i> 未連接
      </span>
  </div>

  <!-- 雲端狀態指示器 -->
  <div id="cloudStatus" class="cloud-status">
      <span class="badge bg-info" id="cloudIndicator">
          <i class="bi bi-cloud"></i> 離線模式
      </span>
  </div>

  <!-- Google 登入認證區 -->
  <div id="authContainer" class="auth-container">
      <div class="text-center mb-4">
          <i class="bi bi-cloud-arrow-up display-4 text-primary mb-3"></i>
          <h4>雲端會計管理系統</h4>
          <p class="text-muted">請先登入 Google 帳號以同步資料</p>
      </div>
      
      <div class="d-grid gap-2">
          <button class="btn btn-primary btn-lg" onclick="signIn()">
              <i class="bi bi-google"></i> 使用 Google 帳號登入
          </button>
          <button class="btn btn-outline-secondary" onclick="useOfflineMode()">
              <i class="bi bi-laptop"></i> 離線模式使用
          </button>
      </div>
      
      <div class="mt-3 text-center">
          <small class="text-muted">
              登入後資料將自動同步至 Google 雲端硬碟
          </small>
      </div>
  </div>

  <!-- 主要應用程式介面 -->
  <div id="mainApp" style="display: none;">
      <!-- 導航列 -->
      <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm no-print">
          <div class="container-fluid">
              <a class="navbar-brand" href="#">
                  <i class="bi bi-heart-pulse me-2"></i>
                  台灣帕金森病友權益促進會
              </a>
              <button class="navbar-toggler" type="button" onclick="toggleSidebar()">
                  <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                  <ul class="navbar-nav ms-auto">
                      <li class="nav-item dropdown">
                          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                              <i class="bi bi-cloud"></i> 雲端同步
                          </a>
                          <ul class="dropdown-menu">
                              <li><a class="dropdown-item" href="#" onclick="manualSync()">
                                  <i class="bi bi-arrow-repeat"></i> 手動同步
                              </a></li>
                              <li><a class="dropdown-item" href="#" onclick="showSyncHistory()">
                                  <i class="bi bi-clock-history"></i> 同步記錄
                              </a></li>
                              <li><a class="dropdown-item" href="#" onclick="resolveConflicts()">
                                  <i class="bi bi-exclamation-triangle"></i> 解決衝突
                              </a></li>
                              <li><hr class="dropdown-divider"></li>
                              <li><a class="dropdown-item" href="#" onclick="showCloudSettings()">
                                  <i class="bi bi-gear"></i> 雲端設定
                              </a></li>
                          </ul>
                      </li>
                      <li class="nav-item dropdown">
                          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                              <i class="bi bi-gear"></i> 系統
                          </a>
                          <ul class="dropdown-menu">
                              <li><a class="dropdown-item" href="#" onclick="showSystemSettings()">
                                  <i class="bi bi-gear-fill"></i> 系統設定
                              </a></li>
                              <li><a class="dropdown-item" href="#" onclick="exportAllData()">
                                  <i class="bi bi-download"></i> 匯出資料
                              </a></li>
                              <li><a class="dropdown-item" href="#" onclick="importAllData()">
                                  <i class="bi bi-upload"></i> 匯入資料
                              </a></li>
                              <li><hr class="dropdown-divider"></li>
                              <li><a class="dropdown-item" href="#" onclick="signOut()">
                                  <i class="bi bi-box-arrow-right"></i> 登出
                              </a></li>
                          </ul>
                      </li>
                      <li class="nav-item">
                          <span class="navbar-text" id="userInfo">
                              <i class="bi bi-person-circle"></i> <span id="userName">使用者</span>
                          </span>
                      </li>
                  </ul>
              </div>
          </div>
      </nav>

      <div class="container-fluid">
          <div class="row">
              <!-- 側邊欄 -->
              <div class="col-md-2 sidebar text-white p-0" id="sidebar">
                  <div class="p-3">
                      <h6 class="text-center mb-4">雲端會計系統</h6>
                      <nav class="nav flex-column">
                          <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                              <i class="bi bi-speedometer2 me-2"></i>儀表板
                          </a>
                          <a class="nav-link" href="#" onclick="showSection('transactions')">
                              <i class="bi bi-receipt me-2"></i>交易記錄
                          </a>
                          <a class="nav-link" href="#" onclick="showSection('members')">
                              <i class="bi bi-people me-2"></i>會員管理
                          </a>
                          <a class="nav-link" href="#" onclick="showSection('analytics')">
                              <i class="bi bi-graph-up me-2"></i>統計分析
                          </a>
                          <a class="nav-link" href="#" onclick="showSection('reports')">
                              <i class="bi bi-file-earmark-text me-2"></i>報表
                          </a>
                          <a class="nav-link" href="#" onclick="showSection('cloud')">
                              <i class="bi bi-cloud-check me-2"></i>雲端管理
                          </a>
                      </nav>
                  </div>
              </div>

              <!-- 主要內容區 -->
              <div class="col-md-10 main-content" id="mainContent">
                  <!-- 儀表板 -->
                  <div id="dashboardSection" class="content-section">
                      <div class="d-flex justify-content-between align-items-center mb-4">
                          <h2><i class="bi bi-speedometer2"></i> 儀表板</h2>
                          <div>
                              <button class="btn btn-outline-info me-2" onclick="manualSync()">
                                  <i class="bi bi-cloud-arrow-up"></i> 同步雲端
                              </button>
                              <button class="btn btn-primary me-2" onclick="showTransactionModal()">
                                  <i class="bi bi-plus-circle"></i> 新增交易
                              </button>
                              <button class="btn btn-success" onclick="showMemberModal()">
                                  <i class="bi bi-person-plus"></i> 新增會員
                              </button>
                          </div>
                      </div>

                      <!-- 雲端狀態摘要 -->
                      <div class="alert alert-info" id="cloudStatusAlert">
                          <div class="d-flex align-items-center">
                              <i class="bi bi-info-circle me-2"></i>
                              <div>
                                  <strong>雲端狀態：</strong>
                                  <span id="cloudStatusText">正在檢查連線...</span>
                                  <br>
                                  <small>最後同步：<span id="lastSyncTime">從未同步</span></small>
                              </div>
                              <div class="ms-auto">
                                  <button class="btn btn-sm btn-outline-primary" onclick="checkCloudStatus()">
                                      <i class="bi bi-arrow-clockwise"></i> 檢查狀態
                                  </button>
                              </div>
                          </div>
                      </div>

                      <!-- 統計卡片 -->
                      <div class="row mb-4">
                          <div class="col-md-3 mb-3">
                              <div class="card stat-card">
                                  <div class="card-body text-center">
                                      <i class="bi bi-cash-coin display-4 mb-2"></i>
                                      <h3 id="totalIncome">$0</h3>
                                      <p class="mb-0">總收入</p>
                                  </div>
                              </div>
                          </div>
                          <div class="col-md-3 mb-3">
                              <div class="card stat-card">
                                  <div class="card-body text-center">
                                      <i class="bi bi-credit-card display-4 mb-2"></i>
                                      <h3 id="totalExpense">$0</h3>
                                      <p class="mb-0">總支出</p>
                                  </div>
                              </div>
                          </div>
                          <div class="col-md-3 mb-3">
                              <div class="card stat-card">
                                  <div class="card-body text-center">
                                      <i class="bi bi-people display-4 mb-2"></i>
                                      <h3 id="totalMembers">0</h3>
                                      <p class="mb-0">會員總數</p>
                                  </div>
                              </div>
                          </div>
                          <div class="col-md-3 mb-3">
                              <div class="card stat-card">
                                  <div class="card-body text-center">
                                      <i class="bi bi-cloud-check display-4 mb-2"></i>
                                      <h3 id="cloudSyncCount">0</h3>
                                      <p class="mb-0">雲端記錄</p>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <!-- 最近交易和會員 -->
                      <div class="row">
                          <div class="col-md-6">
                              <div class="card">
                                  <div class="card-header">
                                      <h5><i class="bi bi-clock-history"></i> 最近交易</h5>
                                  </div>
                                  <div class="card-body">
                                      <div id="recentTransactions">
                                          <div class="text-center text-muted">
                                              <i class="bi bi-receipt display-4"></i>
                                              <p>尚無交易記錄</p>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="card">
                                  <div class="card-header">
                                      <h5><i class="bi bi-person-plus"></i> 新加入會員</h5>
                                  </div>
                                  <div class="card-body">
                                      <div id="recentMembers">
                                          <div class="text-center text-muted">
                                              <i class="bi bi-people display-4"></i>
                                              <p>尚無會員資料</p>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- 雲端管理區 -->
                  <div id="cloudSection" class="content-section" style="display: none;">
                      <div class="d-flex justify-content-between align-items-center mb-4">
                          <h2><i class="bi bi-cloud-check"></i> 雲端管理</h2>
                          <div>
                              <button class="btn btn-primary" onclick="manualSync()">
                                  <i class="bi bi-arrow-repeat"></i> 立即同步
                              </button>
                          </div>
                      </div>

                      <!-- 雲端狀態面板 -->
                      <div class="row mb-4">
                          <div class="col-md-4">
                              <div class="card">
                                  <div class="card-body text-center">
                                      <i class="bi bi-cloud-check display-4 text-success mb-3"></i>
                                      <h5>同步狀態</h5>
                                      <p id="syncStatusDetail" class="text-muted">檢查中...</p>
                                      <button class="btn btn-outline-primary btn-sm" onclick="checkSyncStatus()">
                                          檢查狀態
                                      </button>
                                  </div>
                              </div>
                          </div>
                          <div class="col-md-4">
                              <div class="card">
                                  <div class="card-body text-center">
                                      <i class="bi bi-database display-4 text-info mb-3"></i>
                                      <h5>資料統計</h5>
                                      <p class="text-muted">
                                          本地：<span id="localRecordCount">0</span> 筆<br>
                                          雲端：<span id="cloudRecordCount">0</span> 筆
                                      </p>
                                      <button class="btn btn-outline-info btn-sm" onclick="compareData()">
                                          比較資料
                                      </button>
                                  </div>
                              </div>
                          </div>
                          <div class="col-md-4">
                              <div class="card">
                                  <div class="card-body text-center">
                                      <i class="bi bi-clock-history display-4 text-warning mb-3"></i>
                                      <h5>最後同步</h5>
                                      <p id="lastSyncDetail" class="text-muted">從未同步</p>
                                      <button class="btn btn-outline-warning btn-sm" onclick="showSyncHistory()">
                                          查看記錄
                                      </button>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <!-- 同步設定 -->
                      <div class="card mb-4">
                          <div class="card-header">
                              <h5><i class="bi bi-gear"></i> 同步設定</h5>
                          </div>
                          <div class="card-body">
                              <div class="row">
                                  <div class="col-md-6">
                                      <div class="mb-3">
                                          <div class="form-check">
                                              <input class="form-check-input" type="checkbox" id="autoSync" checked>
                                              <label class="form-check-label" for="autoSync">
                                                  啟用自動同步
                                              </label>
                                          </div>
                                      </div>
                                      <div class="mb-3">
                                          <label for="syncInterval" class="form-label">同步間隔（分鐘）</label>
                                          <select class="form-select" id="syncInterval">
                                              <option value="5">5 分鐘</option>
                                              <option value="10" selected>10 分鐘</option>
                                              <option value="30">30 分鐘</option>
                                              <option value="60">1 小時</option>
                                          </select>
                                      </div>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="mb-3">
                                          <div class="form-check">
                                              <input class="form-check-input" type="checkbox" id="syncOnChange" checked>
                                              <label class="form-check-label" for="syncOnChange">
                                                  資料變更時立即同步
                                              </label>
                                          </div>
                                      </div>
                                      <div class="mb-3">
                                          <div class="form-check">
                                              <input class="form-check-input" type="checkbox" id="conflictNotification" checked>
                                              <label class="form-check-label" for="conflictNotification">
                                                  衝突時顯示通知
                                              </label>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                              <button class="btn btn-primary" onclick="saveSyncSettings()">
                                  <i class="bi bi-save"></i> 儲存設定
                              </button>
                          </div>
                      </div>

                      <!-- 同步記錄 -->
                      <div class="card">
                          <div class="card-header">
                              <h5><i class="bi bi-list-ul"></i> 同步記錄</h5>
                          </div>
                          <div class="card-body">
                              <div id="syncHistoryList">
                                  <div class="text-center text-muted">
                                      <i class="bi bi-clock-history display-4"></i>
                                      <p>尚無同步記錄</p>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- 其他區段保持原樣... -->
                  <!-- 交易記錄區 -->
                  <div id="transactionsSection" class="content-section" style="display: none;">
                      <!-- 原有的交易記錄內容 -->
                  </div>

                  <!-- 會員管理區 -->
                  <div id="membersSection" class="content-section" style="display: none;">
                      <!-- 原有的會員管理內容 -->
                  </div>

                  <!-- 統計分析區 -->
                  <div id="analyticsSection" class="content-section" style="display: none;">
                      <!-- 原有的統計分析內容 -->
                  </div>

                  <!-- 報表區 -->
                  <div id="reportsSection" class="content-section" style="display: none;">
                      <!-- 原有的報表內容 -->
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- 衝突解決模態框 -->
  <div class="modal fade" id="conflictModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="bi bi-exclamation-triangle"></i> 資料衝突解決
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="conflictContent">
                  <!-- 衝突內容將動態載入 -->
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-warning" onclick="resolveConflictKeepLocal()">
                      <i class="bi bi-laptop"></i> 保留本地
                  </button>
                  <button type="button" class="btn btn-primary" onclick="resolveConflictKeepCloud()">
                      <i class="bi bi-cloud"></i> 保留雲端
                  </button>
                  <button type="button" class="btn btn-success" onclick="resolveConflictMerge()">
                      <i class="bi bi-arrow-left-right"></i> 合併資料
                  </button>
              </div>
          </div>
      </div>
  </div>

  <!-- 雲端設定模態框 -->
  <div class="modal fade" id="cloudSettingsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="bi bi-cloud-gear"></i> 雲端設定
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <div class="row">
                      <div class="col-md-6">
                          <h6><i class="bi bi-google"></i> Google Apps Script 設定</h6>
                          <div class="mb-3">
                              <label for="gasWebAppUrl" class="form-label">Web App URL</label>
                              <input type="url" class="form-control" id="gasWebAppUrl" placeholder="https://script.google.com/...">
                          </div>
                          <div class="mb-3">
                              <label for="spreadsheetId" class="form-label">試算表 ID</label>
                              <input type="text" class="form-control" id="spreadsheetId" placeholder="Google 試算表 ID">
                          </div>
                          <div class="mb-3">
                              <div class="form-check">
                                  <input class="form-check-input" type="checkbox" id="enableEncryption">
                                  <label class="form-check-label" for="enableEncryption">
                                      啟用資料加密
                                  </label>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <h6><i class="bi bi-shield-check"></i> 安全設定</h6>
                          <div class="mb-3">
                              <label for="backupRetention" class="form-label">備份保留天數</label>
                              <select class="form-select" id="backupRetention">
                                  <option value="7">7 天</option>
                                  <option value="30" selected>30 天</option>
                                  <option value="90">90 天</option>
                                  <option value="365">1 年</option>
                              </select>
                          </div>
                          <div class="mb-3">
                              <div class="form-check">
                                  <input class="form-check-input" type="checkbox" id="enableVersionControl" checked>
                                  <label class="form-check-label" for="enableVersionControl">
                                      啟用版本控制
                                  </label>
                              </div>
                          </div>
                          <div class="mb-3">
                              <button class="btn btn-outline-primary" onclick="testCloudConnection()">
                                  <i class="bi bi-wifi"></i> 測試連線
                              </button>
                          </div>
                      </div>
                  </div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="saveCloudSettings()">
                      <i class="bi bi-save"></i> 儲存設定
                  </button>
              </div>
          </div>
      </div>
  </div>

  <!-- Toast 容器 -->
  <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer">
      <div id="successToast" class="toast" role="alert">
          <div class="toast-header">
              <i class="bi bi-check-circle text-success me-2"></i>
              <strong class="me-auto">成功</strong>
              <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
          </div>
          <div class="toast-body" id="successToastBody">
              操作成功！
          </div>
      </div>
      
      <div id="errorToast" class="toast" role="alert">
          <div class="toast-header">
              <i class="bi bi-exclamation-triangle text-danger me-2"></i>
              <strong class="me-auto">錯誤</strong>
              <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
          </div>
          <div class="toast-body" id="errorToastBody">
              操作失敗！
          </div>
      </div>

      <div id="syncToast" class="toast" role="alert">
          <div class="toast-header">
              <i class="bi bi-cloud-arrow-up text-info me-2"></i>
              <strong class="me-auto">同步</strong>
              <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
          </div>
          <div class="toast-body" id="syncToastBody">
              正在同步資料...
          </div>
      </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Google APIs -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>

  <script>
      // 雲端同步相關全域變數
      let isAuthenticated = false;
      let isOnlineMode = false;
      let gasWebAppUrl = '';
      let currentUser = null;
      let syncTimer = null;
      let conflictData = [];
      let syncHistory = [];
      let cloudSettings = {
          gasWebAppUrl: '',
          spreadsheetId: '',
          enableEncryption: false,
          backupRetention: 30,
          enableVersionControl: true,
          autoSync: true,
          syncInterval: 10,
          syncOnChange: true,
          conflictNotification: true
      };

      // Google API 設定
      const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
      const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets';

      // 原有的全域變數保持不變
      let transactions = [];
      let members = [];
      let currentPage = 1;
      let itemsPerPage = 10;
      let currentMemberPage = 1;
      let memberItemsPerPage = 10;
      let charts = {};
      let settings = {
          organizationName: '台灣帕金森病友權益促進會',
          organizationAddress: '',
          organizationPhone: '',
          organizationEmail: '',
          defaultMembershipFee: 1000,
          receiptPrefix: 'R',
          treasurerSeal: '出納',
          accountantSeal: '會計',
          chairmanSeal: '理事長',
          enableAutoBackup: false,
          enableNotifications: true
      };

      // 收入和支出類別
      const categories = {
          收入: ['會費', '捐款', '活動收入', '政府補助', '利息收入', '其他收入'],
          支出: ['活動費用', '辦公費用', '交通費', '餐費', '場地費', '設備費', '印刷費', '郵電費', '保險費', '其他支出']
      };

      // 初始化系統
      document.addEventListener('DOMContentLoaded', function() {
          initializeCloudSystem();
      });

      // 雲端系統初始化
      async function initializeCloudSystem() {
          showLoading('正在初始化雲端系統...');
          
          try {
              // 載入雲端設定
              loadCloudSettings();
              
              // 檢查是否有儲存的認證
              const savedAuth = localStorage.getItem('cloudAuth');
              if (savedAuth) {
                  const authData = JSON.parse(savedAuth);
                  if (authData.expiry > Date.now()) {
                      isAuthenticated = true;
                      currentUser = authData.user;
                      await initializeApp();
                      return;
                  }
              }
              
              // 顯示登入畫面
              showAuthContainer();
              
          } catch (error) {
              console.error('雲端系統初始化失敗:', error);
              showToast('error', '雲端系統初始化失敗，將使用離線模式');
              useOfflineMode();
          } finally {
              hideLoading();
          }
      }

      // Google 登入
      async function signIn() {
          showLoading('正在連接 Google 服務...');
          
          try {
              await gapi.load('auth2', async () => {
                  const authInstance = await gapi.auth2.init({
                      client_id: 'YOUR_GOOGLE_CLIENT_ID', // 需要替換為實際的 Client ID
                      scope: SCOPES
                  });
                  
                  const user = await authInstance.signIn();
                  const profile = user.getBasicProfile();
                  
                  currentUser = {
                      id: profile.getId(),
                      name: profile.getName(),
                      email: profile.getEmail(),
                      imageUrl: profile.getImageUrl()
                  };
                  
                  // 儲存認證資訊
                  const authData = {
                      user: currentUser,
                      expiry: Date.now() + (24 * 60 * 60 * 1000) // 24小時後過期
                  };
                  localStorage.setItem('cloudAuth', JSON.stringify(authData));
                  
                  isAuthenticated = true;
                  isOnlineMode = true;
                  
                  await initializeApp();
                  showToast('success', `歡迎回來，${currentUser.name}！`);
              });
              
          } catch (error) {
              console.error('Google 登入失敗:', error);
              showToast('error', 'Google 登入失敗，請稍後再試');
          } finally {
              hideLoading();
          }
      }

      // 登出
      async function signOut() {
          try {
              if (gapi.auth2) {
                  const authInstance = gapi.auth2.getAuthInstance();
                  await authInstance.signOut();
              }
              
              localStorage.removeItem('cloudAuth');
              isAuthenticated = false;
              isOnlineMode = false;
              currentUser = null;
              
              // 清除同步計時器
              if (syncTimer) {
                  clearInterval(syncTimer);
                  syncTimer = null;
              }
              
              showAuthContainer();
              showToast('success', '已成功登出');
              
          } catch (error) {
              console.error('登出失敗:', error);
              showToast('error', '登出失敗');
          }
      }

      // 使用離線模式
      function useOfflineMode() {
          isOnlineMode = false;
          isAuthenticated = false;
          initializeApp();
          showToast('info', '正在使用離線模式');
      }

      // 初始化應用程式
      async function initializeApp() {
          hideAuthContainer();
          showMainApp();
          
          // 原有的初始化邏輯
          initializeSystem();
          loadData();
          updateDashboard();
          setupEventListeners();
          initializeCharts();
          setupKeyboardShortcuts();
          
          // 雲端相關初始化
          if (isOnlineMode) {
              updateUserInfo();
              await checkCloudConnection();
              startAutoSync();
              await loadFromCloud();
          }
          
          updateCloudStatus();
      }

      // 顯示/隱藏介面元素
      function showAuthContainer() {
          document.getElementById('authContainer').style.display = 'block';
          document.getElementById('mainApp').style.display = 'none';
      }

      function hideAuthContainer() {
          document.getElementById('authContainer').style.display = 'none';
      }

      function showMainApp() {
          document.getElementById('mainApp').style.display = 'block';
      }

      // 更新使用者資訊
      function updateUserInfo() {
          if (currentUser) {
              document.getElementById('userName').textContent = currentUser.name;
          }
      }

      // 更新雲端狀態
      function updateCloudStatus() {
          const syncIndicator = document.getElementById('syncIndicator');
          const cloudIndicator = document.getElementById('cloudIndicator');
          const cloudStatusText = document.getElementById('cloudStatusText');
          
          if (isOnlineMode && isAuthenticated) {
              syncIndicator.innerHTML = '<i class="bi bi-cloud-check"></i> 已連接';
              syncIndicator.className = 'badge bg-success';
              cloudIndicator.innerHTML = '<i class="bi bi-cloud-check"></i> 雲端模式';
              cloudIndicator.className = 'badge bg-success';
              if (cloudStatusText) {
                  cloudStatusText.textContent = '雲端連線正常，資料將自動同步';
              }
          } else {
              syncIndicator.innerHTML = '<i class="bi bi-cloud-slash"></i> 未連接';
              syncIndicator.className = 'badge bg-secondary';
              cloudIndicator.innerHTML = '<i class="bi bi-laptop"></i> 離線模式';
              cloudIndicator.className = 'badge bg-warning';
              if (cloudStatusText) {
                  cloudStatusText.textContent = '離線模式，資料僅儲存在本地';
              }
          }
      }

      // 檢查雲端連線
      async function checkCloudConnection() {
          if (!isOnlineMode || !cloudSettings.gasWebAppUrl) return false;
          
          try {
              const response = await fetch(cloudSettings.gasWebAppUrl + '?action=ping', {
                  method: 'GET',
                  mode: 'cors'
              });
              
              if (response.ok) {
                  updateCloudStatus();
                  return true;
              }
          } catch (error) {
              console.error('雲端連線檢查失敗:', error);
          }
          
          return false;
      }

      // 手動同步
      async function manualSync() {
          if (!isOnlineMode) {
              showToast('warning', '離線模式無法同步雲端');
              return;
          }
          
          showLoading('正在同步資料到雲端...');
          showSyncToast('正在同步資料...');
          
          try {
              await syncToCloud();
              await loadFromCloud();
              showToast('success', '資料同步完成');
          } catch (error) {
              console.error('手動同步失敗:', error);
              showToast('error', '同步失敗：' + error.message);
          } finally {
              hideLoading();
              hideSyncToast();
          }
      }

      // 同步到雲端
      async function syncToCloud() {
          if (!isOnlineMode || !cloudSettings.gasWebAppUrl) return;
          
          const syncData = {
              transactions: transactions,
              members: members,
              settings: settings,
              timestamp: new Date().toISOString(),
              user: currentUser?.email || 'unknown'
          };
          
          try {
              const response = await fetch(cloudSettings.gasWebAppUrl, {
                  method: 'POST',
                  mode: 'cors',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'sync',
                      data: syncData
                  })
              });
              
              if (!response.ok) {
                  throw new Error('雲端同步失敗');
              }
              
              const result = await response.json();
              
              if (result.conflicts && result.conflicts.length > 0) {
                  conflictData = result.conflicts;
                  showConflictModal();
                  return;
              }
              
              // 記錄同步歷史
              addSyncHistory('上傳', '成功', '資料已同步到雲端');
              updateLastSyncTime();
              
          } catch (error) {
              addSyncHistory('上傳', '失敗', error.message);
              throw error;
          }
      }

      // 從雲端載入
      async function loadFromCloud() {
          if (!isOnlineMode || !cloudSettings.gasWebAppUrl) return;
          
          try {
              const response = await fetch(cloudSettings.gasWebAppUrl + '?action=load', {
                  method: 'GET',
                  mode: 'cors'
              });
              
              if (!response.ok) {
                  throw new Error('從雲端載入失敗');
              }
              
              const result = await response.json();
              
              if (result.data) {
                  // 檢查是否有衝突
                  const hasConflicts = checkForConflicts(result.data);
                  
                  if (hasConflicts) {
                      showConflictModal();
                      return;
                  }
                  
                  // 更新本地資料
                  if (result.data.transactions) {
                      transactions = result.data.transactions;
                  }
                  if (result.data.members) {
                      members = result.data.members;
                  }
                  if (result.data.settings) {
                      settings = { ...settings, ...result.data.settings };
                  }
                  
                  saveData();
                  updateDashboard();
                  displayTransactions();
                  displayMembers();
                  
                  addSyncHistory('下載', '成功', '從雲端載入資料');
                  updateLastSyncTime();
              }
              
          } catch (error) {
              addSyncHistory('下載', '失敗', error.message);
              throw error;
          }
      }

      // 檢查衝突
      function checkForConflicts(cloudData) {
          const conflicts = [];
          
          // 檢查交易記錄衝突
          if (cloudData.transactions) {
              cloudData.transactions.forEach(cloudTransaction => {
                  const localTransaction = transactions.find(t => t.id === cloudTransaction.id);
                  if (localTransaction && localTransaction.updatedAt !== cloudTransaction.updatedAt) {
                      conflicts.push({
                          type: 'transaction',
                          id: cloudTransaction.id,
                          local: localTransaction,
                          cloud: cloudTransaction
                      });
                  }
              });
          }
          
          // 檢查會員資料衝突
          if (cloudData.members) {
              cloudData.members.forEach(cloudMember => {
                  const localMember = members.find(m => m.id === cloudMember.id);
                  if (localMember && localMember.updatedAt !== cloudMember.updatedAt) {
                      conflicts.push({
                          type: 'member',
                          id: cloudMember.id,
                          local: localMember,
                          cloud: cloudMember
                      });
                  }
              });
          }
          
          conflictData = conflicts;
          return conflicts.length > 0;
      }

      // 顯示衝突解決模態框
      function showConflictModal() {
          const modal = new bootstrap.Modal(document.getElementById('conflictModal'));
          const content = document.getElementById('conflictContent');
          
          let conflictHtml = '<div class="alert alert-warning">';
          conflictHtml += '<h6><i class="bi bi-exclamation-triangle"></i> 發現資料衝突</h6>';
          conflictHtml += '<p>本地資料與雲端資料不一致，請選擇解決方式：</p>';
          conflictHtml += '</div>';
          
          conflictHtml += '<div class="row">';
          
          conflictData.forEach((conflict, index) => {
              conflictHtml += `
                  <div class="col-12 mb-3">
                      <div class="card">
                          <div class="card-header">
                              <h6>${conflict.type === 'transaction' ? '交易記錄' : '會員資料'} 衝突 - ${conflict.id.substring(0, 8)}</h6>
                          </div>
                          <div class="card-body">
                              <div class="row">
                                  <div class="col-md-6">
                                      <h6 class="text-primary">本地版本</h6>
                                      <pre class="bg-light p-2 small">${JSON.stringify(conflict.local, null, 2)}</pre>
                                  </div>
                                  <div class="col-md-6">
                                      <h6 class="text-success">雲端版本</h6>
                                      <pre class="bg-light p-2 small">${JSON.stringify(conflict.cloud, null, 2)}</pre>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              `;
          });
          
          conflictHtml += '</div>';
          content.innerHTML = conflictHtml;
          modal.show();
      }

      // 衝突解決方法
      async function resolveConflictKeepLocal() {
          try {
              await syncToCloud(); // 強制上傳本地資料
              bootstrap.Modal.getInstance(document.getElementById('conflictModal')).hide();
              showToast('success', '已保留本地資料並同步到雲端');
          } catch (error) {
              showToast('error', '解決衝突失敗：' + error.message);
          }
      }

      async function resolveConflictKeepCloud() {
          try {
              await loadFromCloud(); // 強制下載雲端資料
              bootstrap.Modal.getInstance(document.getElementById('conflictModal')).hide();
              showToast('success', '已採用雲端資料');
          } catch (error) {
              showToast('error', '解決衝突失敗：' + error.message);
          }
      }

      async function resolveConflictMerge() {
          try {
              // 合併邏輯
              conflictData.forEach(conflict => {
                  if (conflict.type === 'transaction') {
                      const index = transactions.findIndex(t => t.id === conflict.id);
                      if (index !== -1) {
                          // 合併交易記錄（保留最新的更新時間）
                          const merged = {
                              ...conflict.local,
                              ...conflict.cloud,
                              updatedAt: new Date().toISOString()
                          };
                          transactions[index] = merged;
                      }
                  } else if (conflict.type === 'member') {
                      const index = members.findIndex(m => m.id === conflict.id);
                      if (index !== -1) {
                          // 合併會員資料
                          const merged = {
                              ...conflict.local,
                              ...conflict.cloud,
                              updatedAt: new Date().toISOString()
                          };
                          members[index] = merged;
                      }
                  }
              });
              
              saveData();
              await syncToCloud();
              
              bootstrap.Modal.getInstance(document.getElementById('conflictModal')).hide();
              showToast('success', '資料合併完成並已同步');
              
          } catch (error) {
              showToast('error', '合併資料失敗：' + error.message);
          }
      }

      // 自動同步
      function startAutoSync() {
          if (!cloudSettings.autoSync || !isOnlineMode) return;
          
          if (syncTimer) {
              clearInterval(syncTimer);
          }
          
          const interval = cloudSettings.syncInterval * 60 * 1000; // 轉換為毫秒
          syncTimer = setInterval(async () => {
              try {
                  await syncToCloud();
                  await loadFromCloud();
              } catch (error) {
                  console.error('自動同步失敗:', error);
              }
          }, interval);
      }

      // 同步歷史記錄
      function addSyncHistory(type, status, message) {
          const historyItem = {
              timestamp: new Date().toISOString(),
              type: type,
              status: status,
              message: message,
              user: currentUser?.email || 'unknown'
          };
          
          syncHistory.unshift(historyItem);
          
          // 保留最近100筆記錄
          if (syncHistory.length > 100) {
              syncHistory = syncHistory.slice(0, 100);
          }
          
          localStorage.setItem('syncHistory', JSON.stringify(syncHistory));
          updateSyncHistoryDisplay();
      }

      // 更新同步歷史顯示
      function updateSyncHistoryDisplay() {
          const container = document.getElementById('syncHistoryList');
          if (!container) return;
          
          if (syncHistory.length === 0) {
              container.innerHTML = `
                  <div class="text-center text-muted">
                      <i class="bi bi-clock-history display-4"></i>
                      <p>尚無同步記錄</p>
                  </div>
              `;
              return;
          }
          
          const historyHtml = syncHistory.slice(0, 10).map(item => `
              <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                  <div>
                      <span class="badge ${item.status === '成功' ? 'bg-success' : 'bg-danger'} me-2">
                          ${item.type} ${item.status}
                      </span>
                      <small class="text-muted">${item.message}</small>
                  </div>
                  <small class="text-muted">${new Date(item.timestamp).toLocaleString('zh-TW')}</small>
              </div>
          `).join('');
          
          container.innerHTML = historyHtml;
      }

      // 更新最後同步時間
      function updateLastSyncTime() {
          const now = new Date().toLocaleString('zh-TW');
          const elements = document.querySelectorAll('#lastSyncTime, #lastSyncDetail');
          elements.forEach(el => {
              if (el) el.textContent = now;
          });
      }

      // 雲端設定相關函數
      function loadCloudSettings() {
          const saved = localStorage.getItem('cloudSettings');
          if (saved) {
              cloudSettings = { ...cloudSettings, ...JSON.parse(saved) };
          }
          
          const syncHistorySaved = localStorage.getItem('syncHistory');
          if (syncHistorySaved) {
              syncHistory = JSON.parse(syncHistorySaved);
          }
      }

      function saveCloudSettings() {
          localStorage.setItem('cloudSettings', JSON.stringify(cloudSettings));
          showToast('success', '雲端設定已儲存');
      }

      function showCloudSettings() {
          const modal = new bootstrap.Modal(document.getElementById('cloudSettingsModal'));
          
          // 載入目前設定
          document.getElementById('gasWebAppUrl').value = cloudSettings.gasWebAppUrl || '';
          document.getElementById('spreadsheetId').value = cloudSettings.spreadsheetId || '';
          document.getElementById('enableEncryption').checked = cloudSettings.enableEncryption;
          document.getElementById('backupRetention').value = cloudSettings.backupRetention;
          document.getElementById('enableVersionControl').checked = cloudSettings.enableVersionControl;
          
          modal.show();
      }

      function saveCloudSettings() {
          cloudSettings.gasWebAppUrl = document.getElementById('gasWebAppUrl').value;
          cloudSettings.spreadsheetId = document.getElementById('spreadsheetId').value;
          cloudSettings.enableEncryption = document.getElementById('enableEncryption').checked;
          cloudSettings.backupRetention = parseInt(document.getElementById('backupRetention').value);
          cloudSettings.enableVersionControl = document.getElementById('enableVersionControl').checked;
          
          localStorage.setItem('cloudSettings', JSON.stringify(cloudSettings));
          
          const modal = bootstrap.Modal.getInstance(document.getElementById('cloudSettingsModal'));
          modal.hide();
          
          showToast('success', '雲端設定已儲存');
      }

      function saveSyncSettings() {
          cloudSettings.autoSync = document.getElementById('autoSync').checked;
          cloudSettings.syncInterval = parseInt(document.getElementById('syncInterval').value);
          cloudSettings.syncOnChange = document.getElementById('syncOnChange').checked;
          cloudSettings.conflictNotification = document.getElementById('conflictNotification').checked;
          
          localStorage.setItem('cloudSettings', JSON.stringify(cloudSettings));
          
          // 重新啟動自動同步
          if (isOnlineMode) {
              startAutoSync();
          }
          
          showToast('success', '同步設定已儲存');
      }

      async function testCloudConnection() {
          const url = document.getElementById('gasWebAppUrl').value;
          if (!url) {
              showToast('error', '請先輸入 Web App URL');
              return;
          }
          
          showLoading('測試連線中...');
          
          try {
              const response = await fetch(url + '?action=ping', {
                  method: 'GET',
                  mode: 'cors'
              });
              
              if (response.ok) {
                  showToast('success', '雲端連線測試成功');
              } else {
                  showToast('error', '雲端連線測試失敗');
              }
          } catch (error) {
              showToast('error', '連線測試失敗：' + error.message);
          } finally {
              hideLoading();
          }
      }

      // Toast 相關函數
      function showSyncToast(message) {
          document.getElementById('syncToastBody').textContent = message;
          const toast = new bootstrap.Toast(document.getElementById('syncToast'));
          toast.show();
      }

      function hideSyncToast() {
          const toast = bootstrap.Toast.getInstance(document.getElementById('syncToast'));
          if (toast) toast.hide();
      }

      // 載入和顯示函數
      function showLoading(text = '載入中...') {
          document.getElementById('loadingText').textContent = text;
          document.getElementById('loadingOverlay').style.display = 'flex';
      }

      function hideLoading() {
          document.getElementById('loadingOverlay').style.display = 'none';
      }

      // 資料變更時觸發同步
      function onDataChange() {
          if (cloudSettings.syncOnChange && isOnlineMode) {
              setTimeout(async () => {
                  try {
                      await syncToCloud();
                  } catch (error) {
                      console.error('自動同步失敗:', error);
                  }
              }, 1000); // 延遲1秒執行
          }
      }

      // 修改原有的儲存函數以支援雲端同步
      function saveData() {
          localStorage.setItem('transactions', JSON.stringify(transactions));
          localStorage.setItem('members', JSON.stringify(members));
          updateSyncStatus();
          onDataChange(); // 觸發雲端同步
      }

      // 修改原有的同步狀態更新函數
      function updateSyncStatus() {
          if (isOnlineMode) {
              const indicator = document.getElementById('syncIndicator');
              indicator.innerHTML = '<i class="bi bi-cloud-upload"></i> 同步中';
              indicator.className = 'badge bg-warning';
              
              setTimeout(() => {
                  indicator.innerHTML = '<i class="bi bi-cloud-check"></i> 已同步';
                  indicator.className = 'badge bg-success';
              }, 1000);
          }
      }

      // 其他雲端相關函數
      function showSyncHistory() {
          // 可以顯示詳細的同步歷史模態框
          Swal.fire({
              title: '同步記錄',
              html: generateSyncHistoryHtml(),
              width: '800px',
              showCloseButton: true,
              showConfirmButton: false
          });
      }

      function generateSyncHistoryHtml() {
          if (syncHistory.length === 0) {
              return '<p class="text-muted">尚無同步記錄</p>';
          }
          
          return `
              <div class="table-responsive">
                  <table class="table table-sm">
                      <thead>
                          <tr>
                              <th>時間</th>
                              <th>類型</th>
                              <th>狀態</th>
                              <th>訊息</th>
                              <th>使用者</th>
                          </tr>
                      </thead>
                      <tbody>
                          ${syncHistory.map(item => `
                              <tr>
                                  <td>${new Date(item.timestamp).toLocaleString('zh-TW')}</td>
                                  <td><span class="badge bg-info">${item.type}</span></td>
                                  <td><span class="badge ${item.status === '成功' ? 'bg-success' : 'bg-danger'}">${item.status}</span></td>
                                  <td>${item.message}</td>
                                  <td>${item.user}</td>
                              </tr>
                          `).join('')}
                      </tbody>
                  </table>
              </div>
          `;
      }

      function checkSyncStatus() {
          updateCloudStatus();
          if (isOnlineMode) {
              checkCloudConnection();
          }
      }

      function compareData() {
          const localCount = transactions.length + members.length;
          document.getElementById('localRecordCount').textContent = localCount;
          
          if (isOnlineMode) {
              // 這裡可以實作從雲端獲取記錄數量的邏輯
              document.getElementById('cloudRecordCount').textContent = '檢查中...';
          } else {
              document.getElementById('cloudRecordCount').textContent = '離線';
          }
      }

      function resolveConflicts() {
          if (conflictData.length > 0) {
              showConflictModal();
          } else {
              showToast('info', '目前沒有資料衝突');
          }
      }

      // 原有函數保持不變，但需要加入雲端同步觸發
      function initializeSystem() {
          const today = new Date().toISOString().split('T')[0];
          const dateInputs = document.querySelectorAll('input[type="date"]');
          dateInputs.forEach(input => {
              if (input.id === 'date' || input.id === 'memberJoinDate') {
                  input.value = today;
              }
          });

          const currentYear = new Date().getFullYear();
          const yearSelects = document.querySelectorAll('#filterYear, #analyticsYear');
          yearSelects.forEach(select => {
              for (let year = currentYear; year >= currentYear - 10; year--) {
                  const option = document.createElement('option');
                  option.value = year;
                  option.textContent = year + '年';
                  select.appendChild(option);
              }
          });

          loadSettings();
      }

      function loadData() {
          const savedTransactions = localStorage.getItem('transactions');
          const savedMembers = localStorage.getItem('members');
          
          if (savedTransactions) {
              transactions = JSON.parse(savedTransactions);
          }
          
          if (savedMembers) {
              members = JSON.parse(savedMembers);
          }

          updateCounterpartyList();
      }

      function loadSettings() {
          const savedSettings = localStorage.getItem('systemSettings');
          if (savedSettings) {
              settings = { ...settings, ...JSON.parse(savedSettings) };
          }
      }

      function saveSettings() {
          localStorage.setItem('systemSettings', JSON.stringify(settings));
      }

      // 修改顯示區段函數以支援雲端管理
      function showSection(sectionName) {
          document.querySelectorAll('.content-section').forEach(section => {
              section.style.display = 'none';
          });

          document.querySelectorAll('.sidebar .nav-link').forEach(link => {
              link.classList.remove('active');
          });

          document.getElementById(sectionName + 'Section').style.display = 'block';
          event.target.classList.add('active');

          const sidebar = document.getElementById('sidebar');
          if (window.innerWidth <= 768) {
              sidebar.classList.remove('show');
          }

          switch(sectionName) {
              case 'dashboard':
                  updateDashboard();
                  break;
              case 'transactions':
                  displayTransactions();
                  break;
              case 'members':
                  displayMembers();
                  break;
              case 'analytics':
                  updateAnalytics();
                  break;
              case 'cloud':
                  updateCloudSection();
                  break;
          }
      }

      function updateCloudSection() {
          updateSyncHistoryDisplay();
          compareData();
          
          const syncStatusDetail = document.getElementById('syncStatusDetail');
          if (syncStatusDetail) {
              if (isOnlineMode) {
                  syncStatusDetail.textContent = '雲端連線正常';
                  syncStatusDetail.className = 'text-success';
              } else {
                  syncStatusDetail.textContent = '離線模式';
                  syncStatusDetail.className = 'text-warning';
              }
          }
      }

      // 工具函數
      function generateId() {
          return Date.now().toString(36) + Math.random().toString(36).substr(2);
      }

      function showToast(type, message) {
          const toastId = type === 'success' ? 'successToast' : 'errorToast';
          const toastBodyId = type === 'success' ? 'successToastBody' : 'errorToastBody';
          
          document.getElementById(toastBodyId).textContent = message;
          
          const toast = new bootstrap.Toast(document.getElementById(toastId));
          toast.show();
      }

      // 網路狀態監聽
      window.addEventListener('online', function() {
          if (isAuthenticated) {
              isOnlineMode = true;
              updateCloudStatus();
              checkCloudConnection();
              startAutoSync();
              showToast('success', '網路連線已恢復，開始同步資料');
              manualSync();
          }
      });

      window.addEventListener('offline', function() {
          isOnlineMode = false;
          updateCloudStatus();
          if (syncTimer) {
              clearInterval(syncTimer);
              syncTimer = null;
          }
          showToast('warning', '網路連線中斷，切換至離線模式');
      });

      // 頁面卸載前同步
      window.addEventListener('beforeunload', function() {
          if (isOnlineMode && (transactions.length > 0 || members.length > 0)) {
              navigator.sendBeacon(cloudSettings.gasWebAppUrl, JSON.stringify({
                  action: 'quickSync',
                  data: { transactions, members, settings }
              }));
          }
      });

      // 其他原有函數保持不變...
      function toggleSidebar() {
          const sidebar = document.getElementById('sidebar');
          sidebar.classList.toggle('show');
      }

      function updateDashboard() {
          const totalIncome = transactions
              .filter(t => t.type === '收入')
              .reduce((sum, t) => sum + parseFloat(t.amount), 0);

          const totalExpense = transactions
              .filter(t => t.type === '支出')
              .reduce((sum, t) => sum + parseFloat(t.amount), 0);

          const totalMembers = members.length;
          const cloudSyncCount = isOnlineMode ? (transactions.length + members.length) : 0;

          document.getElementById('totalIncome').textContent = '$' + totalIncome.toLocaleString();
          document.getElementById('totalExpense').textContent = '$' + totalExpense.toLocaleString();
          document.getElementById('totalMembers').textContent = totalMembers.toLocaleString();
          document.getElementById('cloudSyncCount').textContent = cloudSyncCount.toLocaleString();

          updateRecentTransactions();
          updateRecentMembers();
      }

      function updateRecentTransactions() {
          const recentTransactions = transactions
              .sort((a, b) => new Date(b.date) - new Date(a.date))
              .slice(0, 5);

          const container = document.getElementById('recentTransactions');
          
          if (recentTransactions.length === 0) {
              container.innerHTML = `
                  <div class="text-center text-muted">
                      <i class="bi bi-receipt display-4"></i>
                      <p>尚無交易記錄</p>
                  </div>
              `;
              return;
          }

          container.innerHTML = recentTransactions.map(transaction => `
              <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                  <div>
                      <strong>${transaction.category}</strong>
                      <br>
                      <small class="text-muted">${transaction.date} | ${transaction.counterparty || '無'}</small>
                  </div>
                  <div class="text-end">
                      <span class="badge ${transaction.type === '收入' ? 'bg-success' : 'bg-danger'}">
                          ${transaction.type === '收入' ? '+' : '-'}$${parseFloat(transaction.amount).toLocaleString()}
                      </span>
                      ${isOnlineMode ? '<i class="bi bi-cloud-check text-success ms-1" title="已同步"></i>' : '<i class="bi bi-laptop text-warning ms-1" title="離線"></i>'}
                  </div>
              </div>
          `).join('');
      }

      function updateRecentMembers() {
          const recentMembers = members
              .sort((a, b) => new Date(b.joinDate) - new Date(a.joinDate))
              .slice(0, 5);

          const container = document.getElementById('recentMembers');
          
          if (recentMembers.length === 0) {
              container.innerHTML = `
                  <div class="text-center text-muted">
                      <i class="bi bi-people display-4"></i>
                      <p>尚無會員資料</p>
                  </div>
              `;
              return;
          }

          container.innerHTML = recentMembers.map(member => `
              <div class="d-flex align-items-center mb-2 p-2 border-bottom">
                  <div class="member-avatar me-3">
                      <i class="bi bi-person"></i>
                  </div>
                  <div class="flex-grow-1">
                      <strong>${member.name}</strong>
                      <br>
                      <small class="text-muted">${member.joinDate} 加入</small>
                  </div>
                  <div>
                      <span class="badge ${getStatusBadgeClass(member.status)}">
                          ${getStatusText(member.status)}
                      </span>
                      ${isOnlineMode ? '<i class="bi bi-cloud-check text-success ms-1" title="已同步"></i>' : '<i class="bi bi-laptop text-warning ms-1" title="離線"></i>'}
                  </div>
              </div>
          `).join('');
      }

      // 狀態輔助函數
      function getStatusBadgeClass(status) {
          switch (status) {
              case 'active': return 'bg-success';
              case 'inactive': return 'bg-danger';
              case 'pending': return 'bg-warning';
              default: return 'bg-secondary';
          }
      }

      function getStatusText(status) {
          switch (status) {
              case 'active': return '正常';
              case 'inactive': return '停權';
              case 'pending': return '待審核';
              default: return '未知';
          }
      }

      function setupEventListeners() {
          // 原有的事件監聽器設定保持不變
      }

      function initializeCharts() {
          // 原有的圖表初始化保持不變
      }

      function setupKeyboardShortcuts() {
          // 原有的快捷鍵設定保持不變
      }

      function updateCounterpartyList() {
          const datalist = document.getElementById('counterpartyList');
          if (!datalist) return;
          
          const counterparties = [...new Set(transactions
              .map(t => t.counterparty)
              .filter(c => c)
          )];
          
          datalist.innerHTML = counterparties
              .map(c => `<option value="${c}">`)
              .join('');
      }

      // 匯出資料時包含雲端狀態
      function exportAllData() {
          const exportData = {
              transactions: transactions,
              members: members,
              settings: settings,
              cloudSettings: cloudSettings,
              syncHistory: syncHistory,
              exportDate: new Date().toISOString(),
              isOnlineMode: isOnlineMode,
              version: '2.0'
          };
          
          const dataStr = JSON.stringify(exportData, null, 2);
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          
          const link = document.createElement('a');
          link.href = URL.createObjectURL(dataBlob);
          link.download = `${settings.organizationName}_雲端備份_${new Date().toISOString().split('T')[0]}.json`;
          link.click();
          
          showToast('success', '雲端資料備份已下載');
      }

      function importAllData() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          
          input.onchange = function(e) {
              const file = e.target.files[0];
              if (!file) return;
              
              const reader = new FileReader();
              reader.onload = function(e) {
                  try {
                      const importData = JSON.parse(e.target.result);
                      
                      if (importData.transactions && importData.members) {
                          Swal.fire({
                              title: '確認匯入資料',
                              text: '這將會覆蓋目前所有資料，確定要繼續嗎？',
                              icon: 'warning',
                              showCancelButton: true,
                              confirmButtonColor: '#dc3545',
                              cancelButtonColor: '#6c757d',
                              confirmButtonText: '確定匯入',
                              cancelButtonText: '取消'
                          }).then((result) => {
                              if (result.isConfirmed) {
                                  transactions = importData.transactions || [];
                                  members = importData.members || [];
                                  
                                  if (importData.settings) {
                                      settings = { ...settings, ...importData.settings };
                                      saveSettings();
                                  }
                                  
                                  if (importData.cloudSettings) {
                                      cloudSettings = { ...cloudSettings, ...importData.cloudSettings };
                                      localStorage.setItem('cloudSettings', JSON.stringify(cloudSettings));
                                  }
                                  
                                  if (importData.syncHistory) {
                                      syncHistory = importData.syncHistory;
                                      localStorage.setItem('syncHistory', JSON.stringify(syncHistory));
                                  }
                                  
                                  saveData();
                                  updateDashboard();
                                  updateCounterpartyList();
                                  
                                  // 如果是線上模式，同步到雲端
                                  if (isOnlineMode) {
                                      manualSync();
                                  }
                                  
                                  showToast('success', '資料匯入成功');
                              }
                          });
                      } else {
                          showToast('error', '備份檔案格式錯誤');
                      }
                  } catch (error) {
                      console.error('匯入錯誤:', error);
                      showToast('error', '檔案格式錯誤，匯入失敗');
                  }
              };
              reader.readAsText(file);
          };
          
          input.click();
      }
  </script>

  <!-- Google Apps Script 後端程式碼範例 -->
  <script type="text/plain" id="gas-backend-code">
  // 以下是 Google Apps Script 後端程式碼範例
  // 需要在 Google Apps Script 中建立並部署為 Web App

  function doGet(e) {
    const action = e.parameter.action;
    
    switch(action) {
      case 'ping':
        return ContentService.createTextOutput(JSON.stringify({status: 'ok'}))
          .setMimeType(ContentService.MimeType.JSON);
      case 'load':
        return loadData();
      default:
        return ContentService.createTextOutput(JSON.stringify({error: 'Invalid action'}))
          .setMimeType(ContentService.MimeType.JSON);
    }
  }

  function doPost(e) {
    try {
      const data = JSON.parse(e.postData.contents);
      const action = data.action;
      
      switch(action) {
        case 'sync':
          return syncData(data.data);
        case 'quickSync':
          return quickSync(data.data);
        default:
          return ContentService.createTextOutput(JSON.stringify({error: 'Invalid action'}))
            .setMimeType(ContentService.MimeType.JSON);
      }
    } catch (error) {
      return ContentService.createTextOutput(JSON.stringify({error: error.toString()}))
        .setMimeType(ContentService.MimeType.JSON);
    }
  }

  function syncData(data) {
    const spreadsheetId = 'YOUR_SPREADSHEET_ID'; // 替換為實際的試算表 ID
    const ss = SpreadsheetApp.openById(spreadsheetId);
    
    // 同步交易記錄
    const transactionSheet = ss.getSheetByName('Transactions') || ss.insertSheet('Transactions');
    syncTransactions(transactionSheet, data.transactions);
    
    // 同步會員資料
    const memberSheet = ss.getSheetByName('Members') || ss.insertSheet('Members');
    syncMembers(memberSheet, data.members);
    
    // 同步設定
    const settingsSheet = ss.getSheetByName('Settings') || ss.insertSheet('Settings');
    syncSettings(settingsSheet, data.settings);
    
    // 記錄同步歷史
    const historySheet = ss.getSheetByName('SyncHistory') || ss.insertSheet('SyncHistory');
    recordSyncHistory(historySheet, data);
    
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      timestamp: new Date().toISOString()
    })).setMimeType(ContentService.MimeType.JSON);
  }

  function loadData() {
    const spreadsheetId = 'YOUR_SPREADSHEET_ID';
    const ss = SpreadsheetApp.openById(spreadsheetId);
    
    const result = {
      transactions: loadTransactions(ss),
      members: loadMembers(ss),
      settings: loadSettings(ss)
    };
    
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      data: result
    })).setMimeType(ContentService.MimeType.JSON);
  }

  function syncTransactions(sheet, transactions) {
    // 清除現有資料（保留標題）
    if (sheet.getLastRow() > 1) {
      sheet.deleteRows(2, sheet.getLastRow() - 1);
    }
    
    // 設定標題（如果沒有的話）
    if (sheet.getLastRow() === 0) {
      sheet.getRange(1, 1, 1, 10).setValues([
        ['ID', 'Date', 'Type', 'Category', 'Amount', 'Counterparty', 'Account', 'Description', 'ReceiptNumber', 'UpdatedAt']
      ]);
    }
    
    // 寫入交易資料
    if (transactions && transactions.length > 0) {
      const data = transactions.map(t => [
        t.id, t.date, t.type, t.category, t.amount,
        t.counterparty || '', t.account || '', t.description || '',
        t.receiptNumber || '', t.updatedAt || ''
      ]);
      
      sheet.getRange(2, 1, data.length, 10).setValues(data);
    }
  }

  function syncMembers(sheet, members) {
    // 類似的邏輯處理會員資料
    if (sheet.getLastRow() > 1) {
      sheet.deleteRows(2, sheet.getLastRow() - 1);
    }
    
    if (sheet.getLastRow() === 0) {
      sheet.getRange(1, 1, 1, 15).setValues([
        ['ID', 'Name', 'Phone', 'Email', 'BirthDate', 'Gender', 'Address', 
         'JoinDate', 'Status', 'Type', 'MembershipFee', 'LastPaymentDate', 
         'Notes', 'Tags', 'UpdatedAt']
      ]);
    }
    
    if (members && members.length > 0) {
      const data = members.map(m => [
        m.id, m.name, m.phone, m.email || '', m.birthDate || '',
        m.gender || '', m.address || '', m.joinDate, m.status,
        m.type || '', m.membershipFee || 0, m.lastPaymentDate || '',
        m.notes || '', (m.tags || []).join(','), m.updatedAt || ''
      ]);
      
      sheet.getRange(2, 1, data.length, 15).setValues(data);
    }
  }

  function loadTransactions(ss) {
    const sheet = ss.getSheetByName('Transactions');
    if (!sheet || sheet.getLastRow() <= 1) return [];
    
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 10).getValues();
    return data.map(row => ({
      id: row[0],
      date: row[1],
      type: row[2],
      category: row[3],
      amount: row[4],
      counterparty: row[5],
      account: row[6],
      description: row[7],
      receiptNumber: row[8],
      updatedAt: row[9]
    }));
  }

  function loadMembers(ss) {
    const sheet = ss.getSheetByName('Members');
    if (!sheet || sheet.getLastRow() <= 1) return [];
    
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 15).getValues();
    return data.map(row => ({
      id: row[0],
      name: row[1],
      phone: row[2],
      email: row[3],
      birthDate: row[4],
      gender: row[5],
      address: row[6],
      joinDate: row[7],
      status: row[8],
      type: row[9],
      membershipFee: row[10],
      lastPaymentDate: row[11],
      notes: row[12],
      tags: row[13] ? row[13].split(',') : [],
      updatedAt: row[14]
    }));
  }

  function recordSyncHistory(sheet, data) {
    if (sheet.getLastRow() === 0) {
      sheet.getRange(1, 1, 1, 5).setValues([
        ['Timestamp', 'User', 'Action', 'RecordCount', 'Status']
      ]);
    }
    
    const recordCount = (data.transactions?.length || 0) + (data.members?.length || 0);
    sheet.appendRow([
      new Date().toISOString(),
      data.user || 'unknown',
      'sync',
      recordCount,
      'success'
    ]);
  }
  </script>
</body>
</html>
