<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>台灣帕金森病友權益促進會 - 會計暨營運整合管理系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="非營利組織整合：財務 / 會員 / 活動 / 公告 / 表單 / 雲端備份管理系統">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <style>
    :root {
      --primary:#2c5aa0;
      --primary-dark:#1e3d6f;
      --gradient-primary:linear-gradient(135deg,#2c5aa0,#4a90e2);
      --gradient-green:linear-gradient(135deg,#28a745,#20c997);
      --gradient-orange:linear-gradient(135deg,#ff9f40,#ffb347);
      --secondary-bg:#f8f9fa;
      --radius-lg:15px;
      --radius-md:10px;
      --radius-sm:6px;
    }
    body {
      background:var(--secondary-bg);
      font-family:"Microsoft JhengHei","Noto Sans TC",system-ui,sans-serif;
      font-size:14.5px;
    }
    .navbar-brand { font-weight:600; color:var(--primary)!important; }
    .sidebar {
      min-height:100vh;
      background:linear-gradient(180deg,#2c5aa0,#1e3d6f);
      color:#fff;
    }
    .sidebar .nav-link {
      color:rgba(255,255,255,.82);
      border-radius:8px;
      margin:3px 0;
      font-weight:500;
      transition:.25s;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background:rgba(255,255,255,0.12);
      color:#fff;
      transform:translateX(4px);
    }
    .content-section { animation:fadeIn .35s ease; }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(12px); }
      to { opacity:1; transform:translateY(0); }
    }
    .stat-card {
      background:var(--gradient-primary);
      color:#fff;
      border:none;
      border-radius:var(--radius-lg);
      box-shadow:0 4px 14px -4px rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
    }
    .stat-card.alt-green { background:var(--gradient-green); }
    .stat-card.alt-orange{ background:var(--gradient-orange); }
    .stat-card .icon-bg {
      position:absolute;
      right:-10px; top:-10px;
      font-size:72px;
      opacity:.16;
    }
    .card-hoverable { transition:.25s; border:none; border-radius:var(--radius-lg); }
    .card-hoverable:hover { transform:translateY(-4px); box-shadow:0 8px 24px -6px rgba(0,0,0,.15); }
    .table thead th { background:#f1f4f8; border-top:none; font-weight:600; }
    .badge-rounded { border-radius:20px; font-weight:500; letter-spacing:.5px; }
    .member-avatar, .participant-avatar {
      width:40px;height:40px;border-radius:50%;background:#fff;
      display:flex;align-items:center;justify-content:center;
      color:#666;font-weight:600;
      box-shadow:0 0 0 1px rgba(0,0,0,.05);
    }
    .small-avatar { width:32px;height:32px;font-size:12px; }
    .action-buttons .btn { padding:.25rem .5rem; }
    .voucher-preview img {
      max-width:100px;max-height:100px;object-fit:cover;border-radius:6px;margin:4px;cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    .loading-overlay {
      position:fixed; inset:0; z-index:2000;
      background:rgba(0,0,0,.45); display:flex;align-items:center;justify-content:center;
    }
    .pagination .page-link { border:none; border-radius:8px; color:var(--primary); }
    .pagination .page-item.active .page-link { background:var(--primary); }
    .chart-container { position:relative; height:380px; }
    .separator-title {
      font-size:15px;font-weight:600;margin:16px 0 10px;display:flex;align-items:center;gap:.5rem;
    }
    .separator-title:before, .separator-title:after {
      content:""; flex:1; height:1px; background:linear-gradient(90deg,#d0d3d9,#ffffff);
    }
    .form-download-item {
      border:1px solid #e2e6eb; padding:14px 16px; border-radius:var(--radius-md);
      background:#fff; position:relative; transition:.25s;
    }
    .form-download-item:hover { box-shadow:0 6px 18px -6px rgba(0,0,0,.15); transform:translateY(-3px); }
    .activity-card { border:none;border-radius:var(--radius-lg);overflow:hidden;box-shadow:0 3px 10px -2px rgba(0,0,0,.12);position:relative; }
    .activity-card .progress { height:6px; border-radius:3px; background:#e9ecef; overflow:hidden; }
    .activity-card .progress-bar { background:var(--gradient-green); }
    .announcement-card { border-left:5px solid #ffc107; border-radius:var(--radius-md); }
    .announcement-card.urgent { border-left-color:#dc3545; background:linear-gradient(135deg,#fff5f5,#ffffff); }
    .dual-col { columns:2 320px; column-gap:14px; }
    .row-invalid { background:#fff5f5!important; }
    .row-duplicate { background:#fff9e6!important; }
    .preview-status-badge { font-size:10px; }
    .mapping-select { width:100%; margin-bottom:6px; }
    @media print {
      .no-print, .sidebar, .navbar, .modal-backdrop { display:none!important; }
      body { background:#fff; }
      .main-content { margin:0!important; padding:0!important; }
      .card { box-shadow:none!important; }
    }
    @media (max-width: 992px){
      .sidebar { position:fixed; left:0; top:0; transform:translateX(-100%); transition:.35s; z-index:1100; width:250px; }
      .sidebar.show { transform:translateX(0); }
    }
    .spin { animation:spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .receipt-seal-placeholder { width:60px; height:60px; border:2px solid #c00; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:#c00; }
    
    /* 雲端同步狀態 */
    .sync-status {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1200;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .sync-status .badge {
      font-size: 11px;
      padding: 4px 8px;
    }
    .cloud-connected { background: #28a745 !important; }
    .cloud-syncing { background: #ffc107 !important; color: #000 !important; }
    .cloud-error { background: #dc3545 !important; }
  </style>
</head>
<body>
  <!-- 全螢幕載入遮罩 -->
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="text-center text-white">
      <div class="mb-3">
        <i class="bi bi-arrow-clockwise spin" style="font-size:48px;"></i>
      </div>
      <div>系統載入中，請稍候…</div>
    </div>
  </div>

  <!-- 雲端同步狀態 -->
  <div class="sync-status no-print">
    <span id="cloudStatus" class="badge cloud-connected">
      <i class="bi bi-cloud-check"></i> 本地儲存
    </span>
    <span id="syncStatus" class="badge bg-success" style="display:none;">
      <i class="bi bi-arrow-repeat spin"></i> 同步中
    </span>
  </div>

  <!-- 導覽列 -->
  <nav class="navbar navbar-expand-lg bg-white shadow-sm no-print">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <i class="bi bi-heart-pulse me-2"></i> 台灣帕金森病友權益促進會
      </a>
      <button class="navbar-toggler" type="button" onclick="AppLayout.toggleSidebar()">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item me-2">
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
              <input id="globalSearchInput" type="text" class="form-control" placeholder="全域搜尋 (交易 / 會員 / 活動 / 公告)" onkeydown="if(event.key==='Enter') GlobalSearch.exec()">
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle fw-semibold" href="#" data-bs-toggle="dropdown">
              <i class="bi bi-gear"></i> 系統
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" onclick="SettingsUI.open()"><i class="bi bi-sliders"></i> 系統設定</a></li>
              <li><a class="dropdown-item" href="#" onclick="AccountUI.openManager()"><i class="bi bi-bank"></i> 帳戶管理</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.exportAll()"><i class="bi bi-download"></i> 匯出資料</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.importAll()"><i class="bi bi-upload"></i> 匯入資料</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="About.show()"><i class="bi bi-info-circle"></i> 關於</a></li>
              <li><a class="dropdown-item" href="#" onclick="Settings.resetData()"><i class="bi bi-exclamation-triangle"></i> 系統重置</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- 側邊欄 -->
      <aside id="sidebar" class="sidebar col-lg-2 col-md-3 p-3">
        <h6 class="text-center mt-2 mb-4 fw-semibold">管理選單</h6>
        <nav class="nav flex-column">
          <a class="nav-link active" href="#" data-section="dashboard" onclick="AppLayout.showSection('dashboard',this)"><i class="bi bi-speedometer2 me-2"></i>儀表板</a>
          <a class="nav-link" href="#" data-section="transactions" onclick="AppLayout.showSection('transactions',this)"><i class="bi bi-receipt me-2"></i>交易記錄</a>
          <a class="nav-link" href="#" data-section="members" onclick="AppLayout.showSection('members',this)"><i class="bi bi-people me-2"></i>會員管理</a>
          <a class="nav-link" href="#" data-section="activities" onclick="AppLayout.showSection('activities',this)"><i class="bi bi-calendar-event me-2"></i>活動管理</a>
          <a class="nav-link" href="#" data-section="announcements" onclick="AppLayout.showSection('announcements',this)"><i class="bi bi-megaphone me-2"></i>公告管理</a>
          <a class="nav-link" href="#" data-section="forms" onclick="AppLayout.showSection('forms',this)"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單</a>
          <a class="nav-link" href="#" data-section="analytics" onclick="AppLayout.showSection('analytics',this)"><i class="bi bi-graph-up me-2"></i>統計分析</a>
          <a class="nav-link" href="#" data-section="reports" onclick="AppLayout.showSection('reports',this)"><i class="bi bi-file-earmark-text me-2"></i>報表中心</a>
        </nav>
      </aside>

      <!-- 主要內容 -->
      <main id="mainContent" class="col-lg-10 col-md-9 p-4">
        <!-- 儀表板 -->
        <section id="dashboardSection" class="content-section">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>儀表板</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
              <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
              <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
            </div>
          </div>

          <!-- 統計卡片列 -->
          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100">
                <div class="icon-bg"><i class="bi bi-cash-coin"></i></div>
                <small>總收入</small>
                <h3 id="dashTotalIncome" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">本月</span>
                  <span id="dashMonthIncome" class="small fw-semibold">$0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100 alt-orange">
                <div class="icon-bg"><i class="bi bi-credit-card-2-front"></i></div>
                <small>總支出</small>
                <h3 id="dashTotalExpense" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">本月</span>
                  <span id="dashMonthExpense" class="small fw-semibold">$0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100 alt-green">
                <div class="icon-bg"><i class="bi bi-bank"></i></div>
                <small>帳戶總餘額</small>
                <h3 id="dashTotalBalance" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">帳戶數</span>
                  <span id="dashAccountCount" class="small fw-semibold">0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100">
                <div class="icon-bg"><i class="bi bi-people"></i></div>
                <small>會員總數</small>
                <h3 id="dashMemberTotal" class="mb-1">0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">逾期會費</span>
                  <span id="dashMemberOverdue" class="badge bg-danger rounded-pill">0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 帳戶餘額 -->
          <div class="card card-hoverable mb-3">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h6 class="mb-0"><i class="bi bi-bank me-1"></i>帳戶餘額概覽</h6>
              <button class="btn btn-sm btn-outline-primary" onclick="AccountUI.openManager()"><i class="bi bi-gear"></i> 管理帳戶</button>
            </div>
            <div class="card-body">
              <div id="dashboardAccountBalances" class="row g-3">
                <!-- 動態填入 -->
              </div>
            </div>
          </div>

          <!-- 最新交易 / 最新會員 / 最新活動 -->
          <div class="row g-3">
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-arrows-expand me-1"></i>最近交易</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentTx">
                  <!-- 動態 -->
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-person-plus me-1"></i>新加入會員</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentMembers">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-calendar-event me-1"></i>近期活動</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentActivities">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 交易記錄 -->
        <section id="transactionsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-receipt me-2"></i>交易記錄</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
              <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportTransactions()"><i class="bi bi-download"></i> 匯出</button>
            </div>
          </div>

          <!-- 篩選器 -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <div class="col-md-2">
                  <label class="form-label small">年份</label>
                  <select id="txFilterYear" class="form-select form-select-sm" onchange="Transactions.renderTable()">
                    <option value="">全部</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label small">月份</label>
                  <select id="txFilterMonth" class="form-select form-select-sm" onchange="Transactions.renderTable()">
                    <option value="">全部</option>
                    <option value="1">1月</option><option value="2">2月</option><option value="3">3月</option>
                    <option value="4">4月</option><option value="5">5月</option><option value="6">6月</option>
                    <option value="7">7月</option><option value="8">8月</option><option value="9">9月</option>
                    <option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label small">類型</label>
                  <select id="txFilterType" class="form-select form-select-sm" onchange="Transactions.renderTable()">
                    <option value="">全部</option>
                    <option value="收入">收入</option>
                    <option value="支出">支出</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label small">關鍵字</label>
                  <input id="txFilterKeyword" type="text" class="form-control form-control-sm" placeholder="搜尋類別、對象、說明..." onkeyup="Transactions.renderTable()">
                </div>
                <div class="col-md-3">
                  <div class="d-flex gap-2">
                    <select id="txBatchAction" class="form-select form-select-sm">
                      <option value="">批次操作</option>
                      <option value="delete">刪除</option>
                      <option value="export">匯出</option>
                    </select>
                    <button class="btn btn-outline-primary btn-sm" onclick="Transactions.batchAction()">執行</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 交易表格 -->
          <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <span id="txRecordCount">0 筆記錄</span>
              <div class="d-flex gap-2 align-items-center">
                <label class="small mb-0">每頁</label>
                <select class="form-select form-select-sm" style="width:auto;" onchange="Transactions.state.per=parseInt(this.value);Transactions.renderTable()">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
                <label class="small mb-0">筆</label>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th width="40"><input type="checkbox" onchange="Transactions.toggleSelectAll(this)"></th>
                    <th>日期</th>
                    <th>類型</th>
                    <th>類別</th>
                    <th class="text-end">金額</th>
                    <th>對象</th>
                    <th>帳戶</th>
                    <th>說明</th>
                    <th>編號</th>
                    <th width="180">操作</th>
                  </tr>
                </thead>
                <tbody id="txTableBody">
                  <!-- 動態填入 -->
                </tbody>
              </table>
            </div>
            <div class="card-footer bg-white">
              <nav>
                <ul id="txPagination" class="pagination pagination-sm justify-content-center mb-0">
                  <!-- 動態填入 -->
                </ul>
              </nav>
            </div>
          </div>
        </section>

        <!-- 會員管理 -->
        <section id="membersSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-people me-2"></i>會員管理</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-primary btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
              <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportMembers()"><i class="bi bi-download"></i> 匯出</button>
            </div>
          </div>

          <!-- 會員統計 -->
          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 id="mStatTotal" class="text-primary">0</h5>
                  <small class="text-muted">總會員數</small>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 id="mStatActive" class="text-success">0</h5>
                  <small class="text-muted">正常會員</small>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 id="mStatOverdue" class="text-warning">0</h5>
                  <small class="text-muted">逾期會費</small>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 id="mStatNew" class="text-info">0</h5>
                  <small class="text-muted">本月新增</small>
                </div>
              </div>
            </div>
          </div>

          <!-- 篩選器 -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <div class="col-md-2">
                  <label class="form-label small">狀態</label>
                  <select id="memberFilterStatus" class="form-select form-select-sm" onchange="Members.renderTable()">
                    <option value="">全部</option>
                    <option value="active">正常</option>
                    <option value="inactive">停權</option>
                    <option value="pending">待審核</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label small">類型</label>
                  <select id="memberFilterType" class="form-select form-select-sm" onchange="Members.renderTable()">
                    <option value="">全部</option>
                    <option value="regular">一般會員</option>
                    <option value="honorary">榮譽會員</option>
                      <option value="life">終身會員</option>
                      <option value="family">家屬會員</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label small">關鍵字</label>
                    <input id="memberFilterKeyword" type="text" class="form-control form-control-sm" placeholder="搜尋姓名、電話、Email..." onkeyup="Members.renderTable()">
                  </div>
                  <div class="col-md-4">
                    <div class="d-flex gap-2">
                      <select id="memberBatchAction" class="form-select form-select-sm">
                        <option value="">批次操作</option>
                        <option value="delete">刪除</option>
                        <option value="export">匯出</option>
                        <option value="status-active">設為正常</option>
                        <option value="status-inactive">設為停權</option>
                      </select>
                      <button class="btn btn-outline-primary btn-sm" onclick="Members.batchAction()">執行</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 會員表格 -->
            <div class="card">
              <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <span id="memberRecordCount">0 筆記錄</span>
                <div class="d-flex gap-2 align-items-center">
                  <label class="small mb-0">每頁</label>
                  <select class="form-select form-select-sm" style="width:auto;" onchange="Members.state.per=parseInt(this.value);Members.renderTable()">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                  </select>
                  <label class="small mb-0">筆</label>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead>
                    <tr>
                      <th width="40"><input type="checkbox" onchange="Members.toggleSelectAll(this)"></th>
                      <th>會員</th>
                      <th>聯絡方式</th>
                      <th>基本資料</th>
                      <th>加入日期</th>
                      <th>狀態</th>
                      <th>會費狀況</th>
                      <th>標籤</th>
                      <th width="200">操作</th>
                    </tr>
                  </thead>
                  <tbody id="memberTableBody">
                    <!-- 動態填入 -->
                  </tbody>
                </table>
              </div>
              <div class="card-footer bg-white">
                <nav>
                  <ul id="memberPagination" class="pagination pagination-sm justify-content-center mb-0">
                    <!-- 動態填入 -->
                  </ul>
                </nav>
              </div>
            </div>
          </section>

          <!-- 活動管理 -->
          <section id="activitiesSection" class="content-section" style="display:none;">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
              <h4 class="mb-0"><i class="bi bi-calendar-event me-2"></i>活動管理</h4>
              <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
              </div>
            </div>

            <!-- 活動統計 -->
            <div class="row g-3 mb-3">
              <div class="col-6 col-md-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h5 id="actStatTotal" class="text-primary">0</h5>
                    <small class="text-muted">總活動數</small>
                  </div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h5 id="actStatRegistration" class="text-success">0</h5>
                    <small class="text-muted">報名中</small>
                  </div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h5 id="actStatOngoing" class="text-warning">0</h5>
                    <small class="text-muted">進行中</small>
                  </div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h5 id="actStatCompleted" class="text-info">0</h5>
                    <small class="text-muted">已結束</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- 活動網格 -->
            <div id="activitiesGrid" class="row g-3">
              <!-- 動態填入 -->
            </div>
          </section>

          <!-- 公告管理 -->
          <section id="announcementsSection" class="content-section" style="display:none;">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
              <h4 class="mb-0"><i class="bi bi-megaphone me-2"></i>公告管理</h4>
              <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm" onclick="AnnouncementUI.open()"><i class="bi bi-plus-circle"></i> 新增公告</button>
              </div>
            </div>

            <div id="announcementsContainer">
              <!-- 動態填入 -->
            </div>
          </section>

          <!-- 表單管理 -->
          <section id="formsSection" class="content-section" style="display:none;">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
              <h4 class="mb-0"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單</h4>
              <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm" onclick="FormUI.open()"><i class="bi bi-plus-circle"></i> 新增表單</button>
              </div>
            </div>

            <div id="formsContainer">
              <!-- 動態填入 -->
            </div>
          </section>

          <!-- 統計分析 -->
          <section id="analyticsSection" class="content-section" style="display:none;">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
              <h4 class="mb-0"><i class="bi bi-graph-up me-2"></i>統計分析</h4>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-lg-6">
                <div class="card">
                  <div class="card-header bg-white">
                    <h6 class="mb-0">收支趨勢</h6>
                  </div>
                  <div class="card-body">
                    <div class="chart-container">
                      <canvas id="incomeExpenseChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="card">
                  <div class="card-header bg-white">
                    <h6 class="mb-0">會員成長</h6>
                  </div>
                  <div class="card-body">
                    <div class="chart-container">
                      <canvas id="memberGrowthChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-lg-6">
                <div class="card">
                  <div class="card-header bg-white">
                    <h6 class="mb-0">支出類別分布</h6>
                  </div>
                  <div class="card-body">
                    <div class="chart-container">
                      <canvas id="categoryChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="card">
                  <div class="card-header bg-white">
                    <h6 class="mb-0">本月統計</h6>
                  </div>
                  <div class="card-body">
                    <div id="monthlyTrendContainer">
                      <!-- 動態填入 -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- 報表中心 -->
          <section id="reportsSection" class="content-section" style="display:none;">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
              <h4 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>報表中心</h4>
            </div>

            <div class="card mb-3">
              <div class="card-body">
                <div class="row g-3 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label">開始日期</label>
                    <input type="date" id="reportStartDate" class="form-control">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">結束日期</label>
                    <input type="date" id="reportEndDate" class="form-control">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">報表類型</label>
                    <select id="reportType" class="form-select">
                      <option value="">請選擇報表類型</option>
                      <option value="financial">財務報表</option>
                      <option value="member">會員報表</option>
                      <option value="activity">活動報表</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <div class="d-flex gap-2">
                      <button class="btn btn-primary" onclick="Reports.generate()">產生報表</button>
                      <button class="btn btn-outline-secondary" onclick="Reports.print()">列印</button>
                      <button class="btn btn-outline-info" onclick="Reports.export()">匯出</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="reportResult">
              <!-- 動態填入 -->
            </div>
          </section>
        </main>
      </div>
    </div>

    <!-- 模態框 -->
    <!-- 交易模態框 -->
    <div class="modal fade" id="transactionModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="txModalTitle" class="modal-title">新增交易</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="txForm">
              <input type="hidden" id="txId">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">日期 *</label>
                  <input type="date" id="txDate" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">類型 *</label>
                  <select id="txType" class="form-select" required onchange="TransactionUI.onTypeChange()">
                    <option value="收入">收入</option>
                    <option value="支出">支出</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">類別 *</label>
                  <select id="txCategory" class="form-select" required></select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">金額 *</label>
                  <input type="number" id="txAmount" class="form-control" step="0.01" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">對象</label>
                  <input type="text" id="txCounterparty" class="form-control" list="counterpartyDatalist">
                  <datalist id="counterpartyDatalist"></datalist>
                </div>
                <div class="col-md-6">
                  <label class="form-label">帳戶</label>
                  <select id="txAccount" class="form-select"></select>
                </div>
                <div class="col-12">
                  <label class="form-label">說明</label>
                  <textarea id="txDescription" class="form-control" rows="2"></textarea>
                </div>
                <div class="col-md-6">
                  <label id="txNumberLabel" class="form-label">收據編號</label>
                  <input type="text" id="txNumber" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">附件</label>
                  <input type="file" id="txVouchers" class="form-control" multiple accept="image/*,.pdf" onchange="TransactionUI.handleVoucherUpload(event)">
                </div>
                <div class="col-12">
                  <div id="txVoucherPreview" class="voucher-preview"></div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" onclick="TransactionUI.save()">儲存</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 會員模態框 -->
    <div class="modal fade" id="memberModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="memberModalTitle" class="modal-title">新增會員</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="memberForm">
              <input type="hidden" id="memberId">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">姓名 *</label>
                  <input type="text" id="memberName" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">電話 *</label>
                  <input type="tel" id="memberPhone" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Email</label>
                  <input type="email" id="memberEmail" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">出生日期</label>
                  <input type="date" id="memberBirthDate" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">性別</label>
                  <select id="memberGender" class="form-select">
                    <option value="">請選擇</option>
                    <option value="男">男</option>
                    <option value="女">女</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">身分證字號</label>
                  <input type="text" id="memberIdNumber" class="form-control">
                </div>
                <div class="col-12">
                  <label class="form-label">地址</label>
                  <textarea id="memberAddress" class="form-control" rows="2"></textarea>
                </div>
                <div class="col-md-6">
                  <label class="form-label">緊急聯絡人</label>
                  <input type="text" id="emergencyContact" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">緊急聯絡電話</label>
                  <input type="tel" id="emergencyPhone" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">加入日期</label>
                  <input type="date" id="memberJoinDate" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">狀態</label>
                  <select id="memberStatus" class="form-select">
                    <option value="active">正常</option>
                    <option value="inactive">停權</option>
                    <option value="pending">待審核</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">會員類型</label>
                  <select id="memberType" class="form-select">
                    <option value="regular">一般會員</option>
                    <option value="honorary">榮譽會員</option>
                    <option value="life">終身會員</option>
                    <option value="family">家屬會員</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">年費</label>
                  <input type="number" id="membershipFee" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">最後繳費日期</label>
                  <input type="date" id="lastPaymentDate" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">標籤 (逗號分隔)</label>
                  <input type="text" id="memberTags" class="form-control" placeholder="病友,志工,幹部">
                </div>
                <div class="col-12">
                  <label class="form-label">備註</label>
                  <textarea id="memberNotes" class="form-control" rows="3"></textarea>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" onclick="MemberUI.save()">儲存</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 會員詳情模態框 -->
    <div class="modal fade" id="memberDetailModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">會員詳情</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="memberDetailContent"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 活動模態框 -->
    <div class="modal fade" id="activityModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="activityModalTitle" class="modal-title">新增活動</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="activityForm">
              <input type="hidden" id="activityId">
              <div class="row g-3">
                <div class="col-md-8">
                  <label class="form-label">活動名稱 *</label>
                  <input type="text" id="activityName" class="form-control" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">狀態</label>
                  <select id="activityStatus" class="form-select">
                    <option value="planning">規劃中</option>
                    <option value="registration">報名中</option>
                    <option value="ongoing">進行中</option>
                    <option value="completed">已結束</option>
                    <option value="cancelled">已取消</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">日期 *</label>
                  <input type="date" id="activityDate" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">時間</label>
                  <input type="time" id="activityTime" class="form-control">
                </div>
                <div class="col-12">
                  <label class="form-label">地點</label>
                  <input type="text" id="activityLocation" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">費用</label>
                  <input type="number" id="activityFee" class="form-control" step="0.01">
                </div>
                <div class="col-md-6">
                  <label class="form-label">人數限制</label>
                  <input type="number" id="activityMaxParticipants" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">報名截止日期</label>
                  <input type="date" id="activityRegistrationDeadline" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">負責人</label>
                  <input type="text" id="activityOrganizer" class="form-control">
                </div>
                <div class="col-12">
                  <label class="form-label">聯絡電話</label>
                  <input type="tel" id="activityContactPhone" class="form-control">
                </div>
                <div class="col-12">
                  <label class="form-label">活動說明</label>
                  <textarea id="activityDescription" class="form-control" rows="4"></textarea>
                </div>
                <div class="col-12">
                  <label class="form-label">內部備註</label>
                  <textarea id="activityNotes" class="form-control" rows="2"></textarea>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" onclick="ActivityUI.save()">儲存</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 活動詳情模態框 -->
    <div class="modal fade" id="activityDetailModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">活動詳情</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="activityDetailContent"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 公告模態框 -->
    <div class="modal fade" id="announcementModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="announcementModalTitle" class="modal-title">新增公告</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="announcementForm">
              <input type="hidden" id="announcementId">
              <div class="row g-3">
                <div class="col-md-8">
                  <label class="form-label">標題 *</label>
                  <input type="text" id="announcementTitle" class="form-control" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">發布日期</label>
                  <input type="date" id="announcementPublishDate" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">作者</label>
                  <input type="text" id="announcementAuthor" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">狀態</label>
                  <select id="announcementStatus" class="form-select">
                    <option value="published">已發布</option>
                    <option value="draft">草稿</option>
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">內容 *</label>
                  <textarea id="announcementContent" class="form-control" rows="8" required></textarea>
                </div>
                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="announcementPinned">
                    <label class="form-check-label" for="announcementPinned">置頂公告</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="announcementUrgent">
                    <label class="form-check-label" for="announcementUrgent">緊急公告</label>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" onclick="AnnouncementUI.save()">儲存</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 表單模態框 -->
    <div class="modal fade" id="formModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="formModalTitle" class="modal-title">新增表單</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="formBuilderForm">
              <input type="hidden" id="formId">
              <div class="row g-3">
                <div class="col-md-8">
                  <label class="form-label">表單標題 *</label>
                  <input type="text" id="formTitle" class="form-control" required>
                </div>
                <div class="col-md-4">
                  <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" id="formActive" checked>
                    <label class="form-check-label" for="formActive">啟用表單</label>
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label">表單說明</label>
                  <textarea id="formDescription" class="form-control" rows="3"></textarea>
                </div>
                <div class="col-12">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">表單欄位</h6>
                    <button type="button" class="btn btn-sm btn-primary" onclick="FormUI.addField()">
                      <i class="bi bi-plus-circle"></i> 新增欄位
                    </button>
                  </div>
                  <div id="formFieldsContainer">
                    <!-- 動態填入 -->
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" onclick="FormUI.save()">儲存</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 帳戶管理模態框 -->
    <div class="modal fade" id="accountManagerModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">帳戶管理</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <button class="btn btn-primary btn-sm" onclick="AccountUI.openEditor()">
                <i class="bi bi-plus-circle"></i> 新增帳戶
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>帳戶名稱</th>
                    <th>說明</th>
                    <th class="text-end">初始餘額</th>
                    <th class="text-end">目前餘額</th>
                    <th>狀態</th>
                    <th width="120">操作</th>
                  </tr>
                </thead>
                <tbody id="accountTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 帳戶編輯模態框 -->
    <div class="modal fade" id="accountEditModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="accountEditTitle" class="modal-title">新增帳戶</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="accountForm">
              <input type="hidden" id="accountId">
              <div class="mb-3">
                <label class="form-label">帳戶名稱 *</label>
                <input type="text" id="accountName" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">說明</label>
                <input type="text" id="accountDesc" class="form-control">
              </div>
              <div class="mb-3">
                <label class="form-label">初始餘額</label>
                <input type="number" id="accountInitial" class="form-control" step="0.01" value="0">
              </div>
              <div class="mb-3">
                <label class="form-label">備註</label>
                <textarea id="accountNotes" class="form-control" rows="2"></textarea>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="accountActive" checked>
                <label class="form-check-label" for="accountActive">啟用帳戶</label>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" onclick="AccountUI.save()">儲存</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 系統設定模態框 -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">系統設定</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="settingsForm">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label">組織名稱</label>
                  <input type="text" id="settingOrgName" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">預設會費</label>
                  <input type="number" id="settingDefaultFee" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">收據編號前綴</label>
                  <input type="text" id="settingReceiptPrefix" class="form-control">
                </div>
                <div class="col-12">
                  <h6>收入類別 (每行一個)</h6>
                  <textarea id="settingIncomeCategories" class="form-control" rows="4"></textarea>
                </div>
                <div class="col-12">
                  <h6>支出類別 (每行一個)</h6>
                  <textarea id="settingExpenseCategories" class="form-control" rows="4"></textarea>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" onclick="SettingsUI.save()">儲存</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>

   <script>
  (function() {
    'use strict';

    // 工具函數
    const Util = {
      uuid: () => 'id_' + Math.random().toString(36).slice(2, 10) + '_' + Date.now(),
      today: () => new Date().toISOString().split('T')[0],
      fmtNum: n => (Number(n) || 0).toLocaleString(),
      toNumber: v => isNaN(parseFloat(v)) ? 0 : parseFloat(v),
      
      showToast(type, msg) {
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            toast: true,
            position: 'top-end',
            icon: type === 'success' ? 'success' : 'error',
            title: msg,
            showConfirmButton: false,
            timer: 3000
          });
        } else {
          alert(msg);
        }
      },
      
      confirm(opts) {
        if (typeof Swal !== 'undefined') {
          return Swal.fire({
            icon: opts.icon || 'warning',
            title: opts.title || '確定？',
            html: opts.html || opts.text || '',
            showCancelButton: true,
            confirmButtonText: opts.confirmText || '確定',
            cancelButtonText: opts.cancelText || '取消',
            confirmButtonColor: opts.confirmColor || '#0d6efd'
          });
        } else {
          return Promise.resolve({ isConfirmed: confirm(opts.text || opts.title) });
        }
      },

      formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('zh-TW');
      },

      getInitials(name) {
        if (!name) return '?';
        return name.charAt(0).toUpperCase();
      },

      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
    };

    // 雲端同步功能
    const CloudSync = {
      apiUrl: 'https://script.google.com/macros/s/AKfycbzjuucTbaQJHThy9beW8YR0orux1gH3LDS7UcNje4MOPbLfGn5AYs4xURZy556FF7lc-g/exec',
      
      async syncToCloud() {
        try {
          const response = await fetch(this.apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'backupData',
              data: Store.data
            })
          });
          const result = await response.json();
          return result.success;
        } catch (error) {
          console.error('雲端同步失敗:', error);
          return false;
        }
      },
      
      async syncFromCloud() {
        try {
          const response = await fetch(this.apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'getAllData'
            })
          });
          const result = await response.json();
          if (result.success) {
            Store.data = result.data;
            Store.save();
          }
          return result.success;
        } catch (error) {
          console.error('雲端同步失敗:', error);
          return false;
        }
      }
    };

    // 資料儲存
    const Store = {
      data: {
        transactions: [],
        members: [],
        accounts: [
          {
            id: 'acc1',
            name: '現金',
            description: '現金往來',
            initialBalance: 0,
            currentBalance: 0,
            active: true,
            createdAt: new Date().toISOString()
          }
        ],
        activities: [],
        announcements: [],
        forms: [],
        settings: {
          organizationName: '台灣帕金森病友權益促進會',
          defaultMembershipFee: 1000,
          receiptPrefix: 'R',
          voucherPrefix: 'V',
          incomeCategories: ['會費收入', '捐款收入', '活動收入', '利息收入', '其他收入'],
          expenseCategories: ['活動支出', '行政支出', '設備支出', '人事支出', '其他支出']
        }
      },
      
      save() {
        try {
          localStorage.setItem('clubManagementData', JSON.stringify(this.data));
          return Promise.resolve();
        } catch (error) {
          console.error('Save failed:', error);
          return Promise.reject(error);
        }
      },
      
      load() {
        try {
          const saved = localStorage.getItem('clubManagementData');
          if (saved) {
            this.data = { ...this.data, ...JSON.parse(saved) };
          }
          return Promise.resolve();
        } catch (error) {
          console.error('Load failed:', error);
          return Promise.resolve();
        }
      }
    };

    // 應用程式佈局
    const AppLayout = {
      showSection(name, link) {
        document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
        const section = document.getElementById(name + 'Section');
        if (section) section.style.display = 'block';
        
        document.querySelectorAll('.sidebar .nav-link').forEach(a => a.classList.remove('active'));
        if (link) link.classList.add('active');
        
        // 根據不同 section 執行對應的初始化
        switch(name) {
          case 'dashboard': 
            Dashboard.refresh(); 
            break;
          case 'transactions': 
            Transactions.renderTable(); 
            break;
          case 'members': 
            Members.renderTable(); 
            break;
          case 'activities':
            Activities.renderGrid();
            break;
          case 'announcements':
            Announcements.renderList();
            break;
          case 'forms':
            Forms.renderList();
            break;
          case 'analytics':
            Analytics.renderCharts();
            break;
          case 'reports':
            Reports.init();
            break;
        }
        
        if (window.innerWidth < 992) this.toggleSidebar(false);
      },
      
      toggleSidebar(force) {
        const sb = document.getElementById('sidebar');
        if (typeof force === 'boolean') {
          sb.classList.toggle('show', force);
        } else {
          sb.classList.toggle('show');
        }
      }
    };

    // 儀表板
    const Dashboard = {
      refresh() {
        const tx = Store.data.transactions;
        const members = Store.data.members;
        const accounts = Store.data.accounts;
        
        let totalIncome = 0, totalExpense = 0;
        let monthIncome = 0, monthExpense = 0;
        const currentMonth = new Date().getMonth() + 1;
        const currentYear = new Date().getFullYear();
        
        tx.forEach(t => {
          const amt = Util.toNumber(t.amount);
          const txDate = new Date(t.date);
          const isCurrentMonth = txDate.getMonth() + 1 === currentMonth && txDate.getFullYear() === currentYear;
          
          if (t.type === '收入') {
            totalIncome += amt;
            if (isCurrentMonth) monthIncome += amt;
          } else {
            totalExpense += amt;
            if (isCurrentMonth) monthExpense += amt;
          }
        });
        
        const totalBalance = accounts.reduce((s, a) => s + (a.currentBalance || 0), 0);
        
        // 更新顯示
        const elements = {
          dashTotalIncome: '$' + Util.fmtNum(totalIncome),
          dashTotalExpense: '$' + Util.fmtNum(totalExpense),
          dashTotalBalance: '$' + Util.fmtNum(totalBalance),
          dashMemberTotal: members.length,
          dashAccountCount: accounts.length,
          dashMonthIncome: '$' + Util.fmtNum(monthIncome),
          dashMonthExpense: '$' + Util.fmtNum(monthExpense)
        };
        
        Object.entries(elements).forEach(([id, value]) => {
          const el = document.getElementById(id);
          if (el) el.textContent = value;
        });
        
        this.renderAccounts();
        this.renderRecentTransactions();
        this.renderRecentMembers();
        this.renderRecentActivities();
      },
      
      renderAccounts() {
        const container = document.getElementById('dashboardAccountBalances');
        if (!container) return;
        
        const accounts = Store.data.accounts;
        if (!accounts.length) {
          container.innerHTML = '<div class="col-12 text-muted">尚無帳戶</div>';
          return;
        }
        
        container.innerHTML = accounts.map(a => `
          <div class="col-6 col-md-3">
            <div class="border rounded p-2 h-100 small bg-white">
              <div class="d-flex justify-content-between">
                <span class="fw-semibold">${a.name}</span>
                <span class="badge ${a.active ? 'bg-success' : 'bg-secondary'}">${a.active ? '啟用' : '停用'}</span>
              </div>
              <div class="mt-1">
                <span class="text-muted">餘額：</span>
                <span class="${(a.currentBalance || 0) >= 0 ? 'text-success' : 'text-danger'} fw-semibold">$${Util.fmtNum(a.currentBalance || 0)}</span>
              </div>
            </div>
          </div>
        `).join('');
      },

      renderRecentTransactions() {
        const container = document.getElementById('dashboardRecentTx');
        if (!container) return;
        
        const recent = Store.data.transactions
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .slice(0, 5);
        
        if (!recent.length) {
          container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易</div>';
          return;
        }
        
        container.innerHTML = recent.map(tx => `
          <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
            <div>
              <div class="fw-semibold small">${tx.category || '未分類'}</div>
              <div class="text-muted" style="font-size:12px;">${Util.formatDate(tx.date)}</div>
            </div>
            <div class="text-end">
              <div class="${tx.type === '收入' ? 'text-success' : 'text-danger'} fw-semibold">
                ${tx.type === '收入' ? '+' : '-'}$${Util.fmtNum(tx.amount)}
              </div>
            </div>
          </div>
        `).join('');
      },

      renderRecentMembers() {
        const container = document.getElementById('dashboardRecentMembers');
        if (!container) return;
        
        const recent = Store.data.members
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .slice(0, 5);
        
        if (!recent.length) {
          container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員</div>';
          return;
        }
        
        container.innerHTML = recent.map(m => `
          <div class="d-flex align-items-center py-2 border-bottom">
            <div class="member-avatar small-avatar me-2">${Util.getInitials(m.name)}</div>
            <div class="flex-grow-1">
              <div class="fw-semibold small">${m.name}</div>
              <div class="text-muted" style="font-size:12px;">${m.phone || ''}</div>
            </div>
            <span class="badge bg-${m.status === 'active' ? 'success' : 'secondary'} badge-rounded">
              ${m.status === 'active' ? '正常' : '停權'}
            </span>
          </div>
        `).join('');
      },

      renderRecentActivities() {
        const container = document.getElementById('dashboardRecentActivities');
        if (!container) return;
        
        const recent = Store.data.activities
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .slice(0, 5);
        
        if (!recent.length) {
          container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動</div>';
          return;
        }
        
        container.innerHTML = recent.map(act => `
          <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
            <div>
              <div class="fw-semibold small">${act.name}</div>
              <div class="text-muted" style="font-size:12px;">${Util.formatDate(act.date)}</div>
            </div>
            <span class="badge bg-${act.status === 'registration' ? 'success' : 'secondary'} badge-rounded">
              ${act.status === 'registration' ? '報名中' : '其他'}
            </span>
          </div>
        `).join('');
      }
    };

    // 交易管理
    const TransactionUI = {
      modal: null,
      editingId: null,
      
      open(id = null) {
        this.editingId = id;
        
        if (!this.modal) {
          const modalEl = document.getElementById('transactionModal');
          if (modalEl && typeof bootstrap !== 'undefined') {
            this.modal = new bootstrap.Modal(modalEl);
          } else {
            Util.showToast('error', '無法開啟交易視窗');
            return;
          }
        }
        
        // 重置表單
        const form = document.getElementById('txForm');
        if (form) form.reset();
        
        // 設定預設值
        document.getElementById('txDate').value = Util.today();
        document.getElementById('txModalTitle').textContent = id ? '編輯交易' : '新增交易';
        
        // 載入資料
        if (id) {
          const tx = Store.data.transactions.find(t => t.id === id);
          if (tx) {
            Object.keys(tx).forEach(key => {
              const el = document.getElementById('tx' + key.charAt(0).toUpperCase() + key.slice(1));
              if (el) el.value = tx[key];
            });
          }
        }
        
        this.updateCategories();
        this.updateAccounts();
        this.modal.show();
      },
      
      updateCategories() {
        const typeEl = document.getElementById('txType');
        const categoryEl = document.getElementById('txCategory');
        if (!typeEl || !categoryEl) return;
        
        const type = typeEl.value;
        const categories = type === '收入' 
          ? Store.data.settings.incomeCategories 
          : Store.data.settings.expenseCategories;
        
        categoryEl.innerHTML = categories.map(cat => 
          `<option value="${cat}">${cat}</option>`
        ).join('');
      },
      
      updateAccounts() {
        const accountEl = document.getElementById('txAccount');
        if (!accountEl) return;
        
        const accounts = Store.data.accounts.filter(a => a.active);
        accountEl.innerHTML = '<option value="">請選擇帳戶</option>' + 
          accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('');
      },
      
      onTypeChange() {
        this.updateCategories();
        const label = document.getElementById('txNumberLabel');
        if (label) {
          label.textContent = document.getElementById('txType').value === '收入' ? '收據編號' : '憑證編號';
        }
      },
      
      handleVoucherUpload(event) {
        const files = event.target.files;
        const preview = document.getElementById('txVoucherPreview');
        if (!preview) return;
        
        preview.innerHTML = '';
        Array.from(files).forEach(file => {
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = e => {
              const img = document.createElement('img');
              img.src = e.target.result;
              img.className = 'voucher-preview-img';
              preview.appendChild(img);
            };
            reader.readAsDataURL(file);
          }
        });
      },
      
      save() {
        const form = document.getElementById('txForm');
        if (!form || !form.checkValidity()) {
          if (form) form.reportValidity();
          return;
        }
        
        const transaction = {
          id: this.editingId || Util.uuid(),
          date: document.getElementById('txDate')?.value || Util.today(),
          type: document.getElementById('txType')?.value || '收入',
          category: document.getElementById('txCategory')?.value || '',
          amount: Util.toNumber(document.getElementById('txAmount')?.value || 0),
          counterparty: document.getElementById('txCounterparty')?.value || '',
          account: document.getElementById('txAccount')?.value || '',
          description: document.getElementById('txDescription')?.value || '',
          number: document.getElementById('txNumber')?.value || '',
          createdAt: this.editingId ? 
            Store.data.transactions.find(t => t.id === this.editingId)?.createdAt : 
            new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        if (this.editingId) {
          const index = Store.data.transactions.findIndex(t => t.id === this.editingId);
          if (index >= 0) {
            Store.data.transactions[index] = transaction;
          }
        } else {
          Store.data.transactions.push(transaction);
        }
        
        // 更新帳戶餘額
        this.updateAccountBalance(transaction);
        
        Store.save().then(() => {
          Dashboard.refresh();
          if (document.getElementById('transactionsSection').style.display !== 'none') {
            Transactions.renderTable();
          }
          this.modal.hide();
          Util.showToast('success', this.editingId ? '交易已更新' : '交易已新增');
        }).catch(error => {
          Util.showToast('error', '儲存失敗');
        });
      },
      
      updateAccountBalance(transaction) {
        if (!transaction.account) return;
        
        const account = Store.data.accounts.find(a => a.id === transaction.account);
        if (!account) return;
        
        const amount = Util.toNumber(transaction.amount);
        if (transaction.type === '收入') {
          account.currentBalance = (account.currentBalance || 0) + amount;
        } else {
          account.currentBalance = (account.currentBalance || 0) - amount;
        }
      }
    };

    // 交易列表
    const Transactions = {
      state: { page: 1, per: 25, selected: [] },
      
      renderTable() {
        const tbody = document.getElementById('txTableBody');
        if (!tbody) return;
        
        let filtered = [...Store.data.transactions];
        
        // 篩選
        const year = document.getElementById('txFilterYear')?.value;
        const month = document.getElementById('txFilterMonth')?.value;
        const type = document.getElementById('txFilterType')?.value;
        const keyword = document.getElementById('txFilterKeyword')?.value?.toLowerCase();
        
        if (year) {
          filtered = filtered.filter(tx => new Date(tx.date).getFullYear() == year);
        }
        if (month) {
          filtered = filtered.filter(tx => new Date(tx.date).getMonth() + 1 == month);
        }
        if (type) {
          filtered = filtered.filter(tx => tx.type === type);
        }
        if (keyword) {
          filtered = filtered.filter(tx => 
            (tx.category || '').toLowerCase().includes(keyword) ||
            (tx.counterparty || '').toLowerCase().includes(keyword) ||
            (tx.description || '').toLowerCase().includes(keyword)
          );
        }
        
        // 排序
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // 分頁
        const total = filtered.length;
        const start = (this.state.page - 1) * this.state.per;
        const pageData = filtered.slice(start, start + this.state.per);
        
        // 更新記錄數
        const countEl = document.getElementById('txRecordCount');
        if (countEl) countEl.textContent = `${total} 筆記錄`;
        
        // 渲染表格
        tbody.innerHTML = pageData.map(tx => `
          <tr>
            <td><input type="checkbox" value="${tx.id}" onchange="Transactions.toggleSelect(this)"></td>
            <td>${Util.formatDate(tx.date)}</td>
            <td><span class="badge bg-${tx.type === '收入' ? 'success' : 'danger'}">${tx.type}</span></td>
            <td>${tx.category || '-'}</td>
            <td class="text-end fw-semibold ${tx.type === '收入' ? 'text-success' : 'text-danger'}">
              ${tx.type === '收入' ? '+' : '-'}$${Util.fmtNum(tx.amount)}
            </td>
            <td>${tx.counterparty || '-'}</td>
            <td>${this.getAccountName(tx.account)}</td>
            <td class="small">${tx.description || '-'}</td>
            <td class="small">${tx.number || '-'}</td>
            <td class="action-buttons">
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="TransactionUI.open('${tx.id}')">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="Transactions.delete('${tx.id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
        
        // 渲染分頁
        this.renderPagination(total);
        this.updateYearFilter();
      },
      
      getAccountName(accountId) {
        if (!accountId) return '-';
        const account = Store.data.accounts.find(a => a.id === accountId);
        return account ? account.name : '-';
      },
      
      renderPagination(total) {
        const pagination = document.getElementById('txPagination');
        if (!pagination) return;
        
        const totalPages = Math.ceil(total / this.state.per);
        if (totalPages <= 1) {
          pagination.innerHTML = '';
          return;
        }
        
        let html = '';
        for (let i = 1; i <= totalPages; i++) {
          html += `
            <li class="page-item ${i === this.state.page ? 'active' : ''}">
              <a class="page-link" href="#" onclick="Transactions.goToPage(${i})">${i}</a>
            </li>
          `;
        }
        pagination.innerHTML = html;
      },
      
      goToPage(page) {
        this.state.page = page;
        this.renderTable();
      },
      
      updateYearFilter() {
        const yearSelect = document.getElementById('txFilterYear');
        if (!yearSelect) return;
        
        const years = [...new Set(Store.data.transactions.map(tx => new Date(tx.date).getFullYear()))];
        years.sort((a, b) => b - a);
        
        const currentValue = yearSelect.value;
        yearSelect.innerHTML = '<option value="">全部</option>' + 
          years.map(year => `<option value="${year}">${year}</option>`).join('');
        yearSelect.value = currentValue;
      },
      
      toggleSelect(checkbox) {
        const id = checkbox.value;
        if (checkbox.checked) {
          if (!this.state.selected.includes(id)) {
            this.state.selected.push(id);
          }
        } else {
          this.state.selected = this.state.selected.filter(s => s !== id);
        }
      },
      
      toggleSelectAll(checkbox) {
        const checkboxes = document.querySelectorAll('#txTableBody input[type="checkbox"]');
        checkboxes.forEach(cb => {
          cb.checked = checkbox.checked;
          this.toggleSelect(cb);
        });
      },
      
      batchAction() {
        const action = document.getElementById('txBatchAction')?.value;
        if (!action || !this.state.selected.length) {
          Util.showToast('error', '請選擇操作和項目');
          return;
        }
        
        switch(action) {
          case 'delete':
            this.batchDelete();
            break;
          case 'export':
            this.batchExport();
            break;
        }
      },
      
      batchDelete() {
        Util.confirm({
          title: '批次刪除',
          text: `確定要刪除選中的 ${this.state.selected.length} 筆交易嗎？`,
          icon: 'warning'
        }).then(result => {
          if (result.isConfirmed) {
            Store.data.transactions = Store.data.transactions.filter(tx => 
              !this.state.selected.includes(tx.id)
            );
            this.state.selected = [];
            Store.save().then(() => {
              this.renderTable();
              Dashboard.refresh();
              Util.showToast('success', '批次刪除完成');
            });
          }
        });
      },
      
      delete(id) {
        Util.confirm({
          title: '刪除交易',
          text: '確定要刪除這筆交易嗎？',
          icon: 'warning'
        }).then(result => {
          if (result.isConfirmed) {
            Store.data.transactions = Store.data.transactions.filter(tx => tx.id !== id);
            Store.save().then(() => {
              this.renderTable();
              Dashboard.refresh();
              Util.showToast('success', '交易已刪除');
            });
          }
        });
      }
    };

    // 會員管理
    const MemberUI = {
      modal: null,
      editingId: null,
      
      open(id = null) {
        this.editingId = id;
        
        if (!this.modal) {
          const modalEl = document.getElementById('memberModal');
          if (modalEl && typeof bootstrap !== 'undefined') {
            this.modal = new bootstrap.Modal(modalEl);
          } else {
            Util.showToast('error', '無法開啟會員視窗');
            return;
          }
        }
        
        const form = document.getElementById('memberForm');
        if (form) form.reset();
        
        document.getElementById('memberJoinDate').value = Util.today();
        document.getElementById('memberModalTitle').textContent = id ? '編輯會員' : '新增會員';
        
        if (id) {
          const member = Store.data.members.find(m => m.id === id);
          if (member) {
            Object.keys(member).forEach(key => {
              const el = document.getElementById('member' + key.charAt(0).toUpperCase() + key.slice(1));
              if (el) el.value = member[key];
            });
          }
        }
        
        this.modal.show();
      },
      
      save() {
        const form = document.getElementById('memberForm');
        if (!form || !form.checkValidity()) {
          if (form) form.reportValidity();
          return;
        }
        
        const member = {
          id: this.editingId || Util.uuid(),
          name: document.getElementById('memberName')?.value || '',
          phone: document.getElementById('memberPhone')?.value || '',
          email: document.getElementById('memberEmail')?.value || '',
          birthDate: document.getElementById('memberBirthDate')?.value || '',
          gender: document.getElementById('memberGender')?.value || '',
          idNumber: document.getElementById('memberIdNumber')?.value || '',
          address: document.getElementById('memberAddress')?.value || '',
          emergencyContact: document.getElementById('emergencyContact')?.value || '',
          emergencyPhone: document.getElementById('emergencyPhone')?.value || '',
          joinDate: document.getElementById('memberJoinDate')?.value || Util.today(),
          status: document.getElementById('memberStatus')?.value || 'active',
          type: document.getElementById('memberType')?.value || 'regular',
          membershipFee: Util.toNumber(document.getElementById('membershipFee')?.value || 0),
          lastPaymentDate: document.getElementById('lastPaymentDate')?.value || '',
          tags: document.getElementById('memberTags')?.value || '',
          notes: document.getElementById('memberNotes')?.value || '',
          createdAt: this.editingId ? 
            Store.data.members.find(m => m.id === this.editingId)?.createdAt : 
            new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        if (this.editingId) {
          const index = Store.data.members.findIndex(m => m.id === this.editingId);
          if (index >= 0) {
            Store.data.members[index] = member;
          }
        } else {
          Store.data.members.push(member);
        }
        
        Store.save().then(() => {
          Dashboard.refresh();
          if (document.getElementById('membersSection').style.display !== 'none') {
            Members.renderTable();
          }
          this.modal.hide();
          Util.showToast('success', this.editingId ? '會員已更新' : '會員已新增');
        }).catch(error => {
          Util.showToast('error', '儲存失敗');
        });
      }
    };

    // 會員列表
    const Members = {
      state: { page: 1, per: 25, selected: [] },
      
      renderTable() {
        const tbody = document.getElementById('memberTableBody');
        if (!tbody) return;
        
        let filtered = [...Store.data.members];
        
        // 篩選
        const status = document.getElementById('memberFilterStatus')?.value;
        const type = document.getElementById('memberFilterType')?.value;
        const keyword = document.getElementById('memberFilterKeyword')?.value?.toLowerCase();
        
        if (status) {
          filtered = filtered.filter(m => m.status === status);
        }
        if (type) {
          filtered = filtered.filter(m => m.type === type);
        }
        if (keyword) {
          filtered = filtered.filter(m => 
            (m.name || '').toLowerCase().includes(keyword) ||
            (m.phone || '').toLowerCase().includes(keyword) ||
            (m.email || '').toLowerCase().includes(keyword)
          );
        }
        
        // 排序
        filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        // 分頁
        const total = filtered.length;
        const start = (this.state.page - 1) * this.state.per;
        const pageData = filtered.slice(start, start + this.state.per);
        
        // 更新記錄數和統計
        const countEl = document.getElementById('memberRecordCount');
        if (countEl) countEl.textContent = `${total} 筆記錄`;
        this.updateStats();
        
        // 渲染表格
        tbody.innerHTML = pageData.map(m => `
          <tr>
            <td><input type="checkbox" value="${m.id}" onchange="Members.toggleSelect(this)"></td>
            <td>
              <div class="d-flex align-items-center">
                <div class="member-avatar me-2">${Util.getInitials(m.name)}</div>
                <div>
                  <div class="fw-semibold">${m.name}</div>
                  <div class="small text-muted">${this.getTypeText(m.type)}</div>
                </div>
              </div>
            </td>
            <td>
              <div>${m.phone || '-'}</div>
              <div class="small text-muted">${m.email || '-'}</div>
            </td>
            <td>
              <div class="small">
                <div>性別：${m.gender || '-'}</div>
                <div>生日：${m.birthDate ? Util.formatDate(m.birthDate) : '-'}</div>
              </div>
            </td>
            <td>${m.joinDate ? Util.formatDate(m.joinDate) : '-'}</td>
            <td>
              <span class="badge bg-${this.getStatusColor(m.status)} badge-rounded">
                ${this.getStatusText(m.status)}
              </span>
            </td>
            <td>
              <div class="small">
                <div>年費：$${Util.fmtNum(m.membershipFee || 0)}</div>
                <div class="text-muted">最後繳費：${m.lastPaymentDate ? Util.formatDate(m.lastPaymentDate) : '未繳費'}</div>
              </div>
            </td>
            <td>
              ${m.tags ? m.tags.split(',').map(tag => 
                `<span class="badge bg-light text-dark me-1">${tag.trim()}</span>`
              ).join('') : '-'}
            </td>
            <td class="action-buttons">
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-info" onclick="Members.showDetail('${m.id}')">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-primary" onclick="MemberUI.open('${m.id}')">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="Members.delete('${m.id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
        
        this.renderPagination(total);
      },
      
      updateStats() {
        const members = Store.data.members;
        const currentMonth = new Date().getMonth() + 1;
        const currentYear = new Date().getFullYear();
        
        const stats = {
          total: members.length,
          active: members.filter(m => m.status === 'active').length,
          overdue: members.filter(m => this.isOverdue(m)).length,
          newThisMonth: members.filter(m => {
            const joinDate = new Date(m.joinDate);
            return joinDate.getMonth() + 1 === currentMonth && joinDate.getFullYear() === currentYear;
          }).length
        };
        
        const elements = {
          mStatTotal: stats.total,
          mStatActive: stats.active,
          mStatOverdue: stats.overdue,
          mStatNew: stats.newThisMonth
        };
        
        Object.entries(elements).forEach(([id, value]) => {
          const el = document.getElementById(id);
          if (el) el.textContent = value;
        });
      },
      
      isOverdue(member) {
        if (!member.lastPaymentDate) return true;
        const lastPayment = new Date(member.lastPaymentDate);
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
        return lastPayment < oneYearAgo;
      },
      
      getTypeText(type) {
        const types = {
          regular: '一般會員',
          honorary: '榮譽會員',
          life: '終身會員',
          family: '家屬會員'
        };
        return types[type] || type;
      },
      
      getStatusText(status) {
        const statuses = {
          active: '正常',
          inactive: '停權',
          pending: '待審核'
        };
        return statuses[status] || status;
      },
      
      getStatusColor(status) {
        const colors = {
          active: 'success',
          inactive: 'danger',
          pending: 'warning'
        };
        return colors[status] || 'secondary';
      },
      
      renderPagination(total) {
        const pagination = document.getElementById('memberPagination');
        if (!pagination) return;
        
        const totalPages = Math.ceil(total / this.state.per);
        if (totalPages <= 1) {
          pagination.innerHTML = '';
          return;
        }
        
        let html = '';
        for (let i = 1; i <= totalPages; i++) {
          html += `
            <li class="page-item ${i === this.state.page ? 'active' : ''}">
              <a class="page-link" href="#" onclick="Members.goToPage(${i})">${i}</a>
            </li>
          `;
        }
        pagination.innerHTML = html;
      },
      
      goToPage(page) {
        this.state.page = page;
        this.renderTable();
      },
      
      toggleSelect(checkbox) {
        const id = checkbox.value;
        if (checkbox.checked) {
          if (!this.state.selected.includes(id)) {
            this.state.selected.push(id);
          }
        } else {
          this.state.selected = this.state.selected.filter(s => s !== id);
        }
      },
      
      toggleSelectAll(checkbox) {
        const checkboxes = document.querySelectorAll('#memberTableBody input[type="checkbox"]');
        checkboxes.forEach(cb => {
          cb.checked = checkbox.checked;
          this.toggleSelect(cb);
        });
      },
      
      batchAction() {
        const action = document.getElementById('memberBatchAction')?.value;
        if (!action || !this.state.selected.length) {
          Util.showToast('error', '請選擇操作和項目');
          return;
        }
        
        switch(action) {
          case 'delete':
            this.batchDelete();
            break;
          case 'status-active':
            this.batchUpdateStatus('active');
            break;
          case 'status-inactive':
            this.batchUpdateStatus('inactive');
            break;
        }
      },
      
      batchDelete() {
        Util.confirm({
          title: '批次刪除',
          text: `確定要刪除選中的 ${this.state.selected.length} 位會員嗎？`,
          icon: 'warning'
        }).then(result => {
          if (result.isConfirmed) {
            Store.data.members = Store.data.members.filter(m => 
              !this.state.selected.includes(m.id)
            );
            this.state.selected = [];
            Store.save().then(() => {
              this.renderTable();
              Dashboard.refresh();
              Util.showToast('success', '批次刪除完成');
            });
          }
        });
      },
      
      batchUpdateStatus(status) {
        Store.data.members.forEach(m => {
          if (this.state.selected.includes(m.id)) {
            m.status = status;
            m.updatedAt = new Date().toISOString();
          }
        });
        
        this.state.selected = [];
        Store.save().then(() => {
          this.renderTable();
          Util.showToast('success', '批次更新完成');
        });
      },
      
      delete(id) {
        Util.confirm({
          title: '刪除會員',
          text: '確定要刪除這位會員嗎？',
          icon: 'warning'
        }).then(result => {
          if (result.isConfirmed) {
            Store.data.members = Store.data.members.filter(m => m.id !== id);
            Store.save().then(() => {
              this.renderTable();
              Dashboard.refresh();
              Util.showToast('success', '會員已刪除');
            });
          }
        });
      },
      
      showDetail(id) {
        const member = Store.data.members.find(m => m.id === id);
        if (!member) return;
        
        const modalEl = document.getElementById('memberDetailModal');
        const contentEl = document.getElementById('memberDetailContent');
        
        if (!modalEl || !contentEl) return;
        
        contentEl.innerHTML = `
          <div class="row g-3">
            <div class="col-md-4">
              <div class="card">
                <div class="card-body text-center">
                  <div class="member-avatar mx-auto mb-3" style="width:80px;height:80px;font-size:32px;">
                    ${Util.getInitials(member.name)}
                  </div>
                  <h5>${member.name}</h5>
                  <p class="text-muted">${this.getTypeText(member.type)}</p>
                  <span class="badge bg-${this.getStatusColor(member.status)} badge-rounded">
                    ${this.getStatusText(member.status)}
                  </span>
                </div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">基本資料</h6>
                </div>
                <div class="card-body">
                  <div class="row g-2">
                    <div class="col-6"><strong>電話：</strong>${member.phone || '-'}</div>
                    <div class="col-6"><strong>Email：</strong>${member.email || '-'}</div>
                    <div class="col-6"><strong>性別：</strong>${member.gender || '-'}</div>
                    <div class="col-6"><strong>生日：</strong>${member.birthDate ? Util.formatDate(member.birthDate) : '-'}</div>
                    <div class="col-12"><strong>地址：</strong>${member.address || '-'}</div>
                    <div class="col-6"><strong>緊急聯絡人：</strong>${member.emergencyContact || '-'}</div>
                    <div class="col-6"><strong>緊急電話：</strong>${member.emergencyPhone || '-'}</div>
                  </div>
                </div>
              </div>
              
              <div class="card mt-3">
                <div class="card-header">
                  <h6 class="mb-0">會員資訊</h6>
                </div>
                <div class="card-body">
                  <div class="row g-2">
                    <div class="col-6"><strong>加入日期：</strong>${member.joinDate ? Util.formatDate(member.joinDate) : '-'}</div>
                    <div class="col-6"><strong>年費：</strong>$${Util.fmtNum(member.membershipFee || 0)}</div>
                    <div class="col-12"><strong>最後繳費：</strong>${member.lastPaymentDate ? Util.formatDate(member.lastPaymentDate) : '未繳費'}</div>
                    <div class="col-12"><strong>標籤：</strong>${member.tags || '-'}</div>
                    <div class="col-12"><strong>備註：</strong>${member.notes || '-'}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        if (typeof bootstrap !== 'undefined') {
          const modal = new bootstrap.Modal(modalEl);
          modal.show();
        }
      }
    };

    // 活動管理
    const ActivityUI = {
      modal: null,
      editingId: null,
      
      open(id = null) {
        this.editingId = id;
        
        if (!this.modal) {
          const modalEl = document.getElementById('activityModal');
          if (modalEl && typeof bootstrap !== 'undefined') {
            this.modal = new bootstrap.Modal(modalEl);
          } else {
            Util.showToast('error', '無法開啟活動視窗');
            return;
          }
        }
        
        const form = document.getElementById('activityForm');
        if (form) form.reset();
        
        document.getElementById('activityDate').value = Util.today();
        document.getElementById('activityModalTitle').textContent = id ? '編輯活動' : '新增活動';
        
        if (id) {
          const activity = Store.data.activities.find(a => a.id === id);
          if (activity) {
            Object.keys(activity).forEach(key => {
              const el = document.getElementById('activity' + key.charAt(0).toUpperCase() + key.slice(1));
              if (el) el.value = activity[key];
            });
          }
        }
        
        this.modal.show();
      },
      
      save() {
        const form = document.getElementById('activityForm');
        if (!form || !form.checkValidity()) {
          if (form) form.reportValidity();
          return;
        }
        
        const activity = {
          id: this.editingId || Util.uuid(),
          name: document.getElementById('activityName')?.value || '',
          date: document.getElementById('activityDate')?.value || '',
          time: document.getElementById('activityTime')?.value || '',
          location: document.getElementById('activityLocation')?.value || '',
          fee: Util.toNumber(document.getElementById('activityFee')?.value || 0),
          maxParticipants: parseInt(document.getElementById('activityMaxParticipants')?.value || 0),
          registrationDeadline: document.getElementById('activityRegistrationDeadline')?.value || '',
          organizer: document.getElementById('activityOrganizer')?.value || '',
          contactPhone: document.getElementById('activityContactPhone')?.value || '',
          description: document.getElementById('activityDescription')?.value || '',
          notes: document.getElementById('activityNotes')?.value || '',
          status: document.getElementById('activityStatus')?.value || 'planning',
          participants: this.editingId ? 
            Store.data.activities.find(a => a.id === this.editingId)?.participants || [] : 
            [],
          createdAt: this.editingId ? 
            Store.data.activities.find(a => a.id === this.editingId)?.createdAt : 
            new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        if (this.editingId) {
          const index = Store.data.activities.findIndex(a => a.id === this.editingId);
          if (index >= 0) {
            Store.data.activities[index] = activity;
          }
        } else {
          Store.data.activities.push(activity);
        }
        
        Store.save().then(() => {
          Dashboard.refresh();
          if (document.getElementById('activitiesSection').style.display !== 'none') {
            Activities.renderGrid();
          }
          this.modal.hide();
          Util.showToast('success', this.editingId ? '活動已更新' : '活動已新增');
        }).catch(error => {
          Util.showToast('error', '儲存失敗');
        });
      }
    };

    // 活動列表
    const Activities = {
      renderGrid() {
        const container = document.getElementById('activitiesGrid');
        if (!container) return;
        
        const activities = Store.data.activities.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // 更新統計
        this.updateStats();
        
        if (!activities.length) {
          container.innerHTML = `
            <div class="col-12">
              <div class="text-center text-muted py-5">
                <i class="bi bi-calendar-event display-1 d-block mb-3"></i>
                <h5>尚無活動</h5>
                <p>點擊「新增活動」開始建立第一個活動</p>
              </div>
            </div>
          `;
          return;
        }
        
        container.innerHTML = activities.map(act => `
          <div class="col-lg-4 col-md-6">
            <div class="activity-card card h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="card-title mb-0">${act.name}</h6>
                  <span class="badge bg-${this.getStatusColor(act.status)} badge-rounded">
                    ${this.getStatusText(act.status)}
                  </span>
                </div>
                
                <div class="small text-muted mb-3">
                  <div><i class="bi bi-calendar me-1"></i>${Util.formatDate(act.date)} ${act.time || ''}</div>
                  <div><i class="bi bi-geo-alt me-1"></i>${act.location || '地點未定'}</div>
                  <div><i class="bi bi-person me-1"></i>${act.organizer || '主辦人未定'}</div>
                </div>
                
                <p class="card-text small">${act.description || '無說明'}</p>
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <small class="text-muted">
                    參與人數：${(act.participants || []).length}${act.maxParticipants ? `/${act.maxParticipants}` : ''}
                  </small>
                  <small class="fw-semibold">
                    ${act.fee ? `$${Util.fmtNum(act.fee)}` : '免費'}
                  </small>
                </div>
                
                ${act.maxParticipants ? `
                  <div class="progress mb-3">
                    <div class="progress-bar" style="width: ${((act.participants || []).length / act.maxParticipants * 100)}%"></div>
                  </div>
                ` : ''}
                
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-info btn-sm flex-fill" onclick="Activities.showDetail('${act.id}')">
                    <i class="bi bi-eye"></i> 詳情
                  </button>
                  <button class="btn btn-outline-primary btn-sm" onclick="ActivityUI.open('${act.id}')">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm" onclick="Activities.delete('${act.id}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      },
      
      updateStats() {
        const activities = Store.data.activities;
        
        const stats = {
          total: activities.length,
          registration: activities.filter(a => a.status === 'registration').length,
          ongoing: activities.filter(a => a.status === 'ongoing').length,
          completed: activities.filter(a => a.status === 'completed').length
        };
        
        const elements = {
          actStatTotal: stats.total,
          actStatRegistration: stats.registration,
          actStatOngoing: stats.ongoing,
          actStatCompleted: stats.completed
        };
        
        Object.entries(elements).forEach(([id, value]) => {
          const el = document.getElementById(id);
          if (el) el.textContent = value;
        });
      },
      
      getStatusText(status) {
        const statuses = {
          planning: '規劃中',
          registration: '報名中',
          ongoing: '進行中',
          completed: '已結束',
          cancelled: '已取消'
        };
        return statuses[status] || status;
      },
      
      getStatusColor(status) {
        const colors = {
          planning: 'secondary',
          registration: 'success',
          ongoing: 'warning',
          completed: 'info',
          cancelled: 'danger'
        };
        return colors[status] || 'secondary';
      },
      
      delete(id) {
        Util.confirm({
          title: '刪除活動',
          text: '確定要刪除這個活動嗎？',
          icon: 'warning'
        }).then(result => {
          if (result.isConfirmed) {
            Store.data.activities = Store.data.activities.filter(a => a.id !== id);
            Store.save().then(() => {
              this.renderGrid();
              Dashboard.refresh();
              Util.showToast('success', '活動已刪除');
            });
          }
        });
      },
      
      showDetail(id) {
        const activity = Store.data.activities.find(a => a.id === id);
        if (!activity) return;
        
        const modalEl = document.getElementById('activityDetailModal');
        const contentEl = document.getElementById('activityDetailContent');
        
        if (!modalEl || !contentEl) return;
        
        contentEl.innerHTML = `
          <div class="row g-3">
            <div class="col-md-8">
              <div class="card">
                <div class="card-header d-flex justify-content-between">
                  <h5 class="mb-0">${activity.name}</h5>
                  <span class="badge bg-${this.getStatusColor(activity.status)} badge-rounded">
                    ${this.getStatusText(activity.status)}
                  </span>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-6">
                      <strong>日期時間：</strong><br>
                      ${Util.formatDate(activity.date)} ${activity.time || ''}
                    </div>
                    <div class="col-6">
                      <strong>地點：</strong><br>
                      ${activity.location || '地點未定'}
                    </div>
                    <div class="col-6">
                      <strong>費用：</strong><br>
                      ${activity.fee? `$${Util.fmtNum(activity.fee)}` : '免費'}
                    </div>
                    <div class="col-6">
                      <strong>人數限制：</strong><br>
                      ${activity.maxParticipants || '無限制'}
                    </div>
                    <div class="col-6">
                      <strong>報名截止：</strong><br>
                      ${activity.registrationDeadline ? Util.formatDate(activity.registrationDeadline) : '未設定'}
                    </div>
                    <div class="col-6">
                      <strong>負責人：</strong><br>
                      ${activity.organizer || '未指定'}
                    </div>
                    <div class="col-12">
                      <strong>聯絡電話：</strong><br>
                      ${activity.contactPhone || '未提供'}
                    </div>
                    <div class="col-12">
                      <strong>活動說明：</strong><br>
                      ${activity.description || '無說明'}
                    </div>
                    ${activity.notes ? `
                    <div class="col-12">
                      <strong>內部備註：</strong><br>
                      ${activity.notes}
                    </div>
                    ` : ''}
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">參與者 (${(activity.participants || []).length})</h6>
                </div>
                <div class="card-body">
                  ${(activity.participants || []).length ? 
                    (activity.participants || []).map(p => `
                      <div class="d-flex align-items-center mb-2">
                        <div class="member-avatar small-avatar me-2">${Util.getInitials(p.name)}</div>
                        <div class="flex-grow-1">
                          <div class="small fw-semibold">${p.name}</div>
                          <div class="text-muted" style="font-size:11px;">${p.phone || ''}</div>
                        </div>
                      </div>
                    `).join('') : 
                    '<div class="text-muted text-center py-3">尚無參與者</div>'
                  }
                </div>
              </div>
            </div>
          </div>
        `;
        
        if (typeof bootstrap !== 'undefined') {
          const modal = new bootstrap.Modal(modalEl);
          modal.show();
        }
      }
    };

    // 公告管理
    const AnnouncementUI = {
      modal: null,
      editingId: null,
      
      open(id = null) {
        this.editingId = id;
        
        if (!this.modal) {
          const modalEl = document.getElementById('announcementModal');
          if (modalEl && typeof bootstrap !== 'undefined') {
            this.modal = new bootstrap.Modal(modalEl);
          } else {
            Util.showToast('error', '無法開啟公告視窗');
            return;
          }
        }
        
        const form = document.getElementById('announcementForm');
        if (form) form.reset();
        
        document.getElementById('announcementPublishDate').value = Util.today();
        document.getElementById('announcementModalTitle').textContent = id ? '編輯公告' : '新增公告';
        
        if (id) {
          const announcement = Store.data.announcements.find(a => a.id === id);
          if (announcement) {
            Object.keys(announcement).forEach(key => {
              const el = document.getElementById('announcement' + key.charAt(0).toUpperCase() + key.slice(1));
              if (el) {
                if (el.type === 'checkbox') {
                  el.checked = announcement[key];
                } else {
                  el.value = announcement[key];
                }
              }
            });
          }
        }
        
        this.modal.show();
      },
      
      save() {
        const form = document.getElementById('announcementForm');
        if (!form || !form.checkValidity()) {
          if (form) form.reportValidity();
          return;
        }
        
        const announcement = {
          id: this.editingId || Util.uuid(),
          title: document.getElementById('announcementTitle')?.value || '',
          content: document.getElementById('announcementContent')?.value || '',
          author: document.getElementById('announcementAuthor')?.value || '',
          publishDate: document.getElementById('announcementPublishDate')?.value || Util.today(),
          status: document.getElementById('announcementStatus')?.value || 'published',
          pinned: document.getElementById('announcementPinned')?.checked || false,
          urgent: document.getElementById('announcementUrgent')?.checked || false,
          createdAt: this.editingId ? 
            Store.data.announcements.find(a => a.id === this.editingId)?.createdAt : 
            new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        if (this.editingId) {
          const index = Store.data.announcements.findIndex(a => a.id === this.editingId);
          if (index >= 0) {
            Store.data.announcements[index] = announcement;
          }
        } else {
          Store.data.announcements.push(announcement);
        }
        
        Store.save().then(() => {
          if (document.getElementById('announcementsSection').style.display !== 'none') {
            Announcements.renderList();
          }
          this.modal.hide();
          Util.showToast('success', this.editingId ? '公告已更新' : '公告已新增');
        }).catch(error => {
          Util.showToast('error', '儲存失敗');
        });
      }
    };

    // 公告列表
    const Announcements = {
      renderList() {
        const container = document.getElementById('announcementsContainer');
        if (!container) return;
        
        const announcements = Store.data.announcements
          .filter(a => a.status === 'published')
          .sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            return new Date(b.publishDate) - new Date(a.publishDate);
          });
        
        if (!announcements.length) {
          container.innerHTML = `
            <div class="text-center text-muted py-5">
              <i class="bi bi-megaphone display-1 d-block mb-3"></i>
              <h5>尚無公告</h5>
              <p>點擊「新增公告」開始建立第一個公告</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = announcements.map(ann => `
          <div class="card mb-3 ${ann.urgent ? 'border-danger' : ''}">
            <div class="card-header d-flex justify-content-between align-items-center ${ann.urgent ? 'bg-danger-subtle' : ''}">
              <div class="d-flex align-items-center gap-2">
                ${ann.pinned ? '<i class="bi bi-pin-angle-fill text-warning"></i>' : ''}
                ${ann.urgent ? '<i class="bi bi-exclamation-triangle-fill text-danger"></i>' : ''}
                <h6 class="mb-0">${ann.title}</h6>
              </div>
              <div class="d-flex align-items-center gap-2">
                <small class="text-muted">${ann.author || '系統'} • ${Util.formatDate(ann.publishDate)}</small>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="AnnouncementUI.open('${ann.id}')">
                      <i class="bi bi-pencil me-2"></i>編輯
                    </a></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="Announcements.delete('${ann.id}')">
                      <i class="bi bi-trash me-2"></i>刪除
                    </a></li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="announcement-content">${ann.content.replace(/\n/g, '<br>')}</div>
            </div>
          </div>
        `).join('');
      },
      
      delete(id) {
        Util.confirm({
          title: '刪除公告',
          text: '確定要刪除這個公告嗎？',
          icon: 'warning'
        }).then(result => {
          if (result.isConfirmed) {
            Store.data.announcements = Store.data.announcements.filter(a => a.id !== id);
            Store.save().then(() => {
              this.renderList();
              Util.showToast('success', '公告已刪除');
            });
          }
        });
      }
    };

    // 表單管理
    const FormUI = {
      modal: null,
      editingId: null,
      fieldCounter: 0,
      
      open(id = null) {
        this.editingId = id;
        this.fieldCounter = 0;
        
        if (!this.modal) {
          const modalEl = document.getElementById('formModal');
          if (modalEl && typeof bootstrap !== 'undefined') {
            this.modal = new bootstrap.Modal(modalEl);
          } else {
            Util.showToast('error', '無法開啟表單視窗');
            return;
          }
        }
        
        const form = document.getElementById('formBuilderForm');
        if (form) form.reset();
        
        document.getElementById('formModalTitle').textContent = id ? '編輯表單' : '新增表單';
        document.getElementById('formFieldsContainer').innerHTML = '';
        
        if (id) {
          const formData = Store.data.forms.find(f => f.id === id);
          if (formData) {
            document.getElementById('formTitle').value = formData.title || '';
            document.getElementById('formDescription').value = formData.description || '';
            document.getElementById('formActive').checked = formData.active !== false;
            
            (formData.fields || []).forEach(field => {
              this.addField(field);
            });
          }
        }
        
        this.modal.show();
      },
      
      addField(fieldData = null) {
        const container = document.getElementById('formFieldsContainer');
        if (!container) return;
        
        const fieldId = 'field_' + (++this.fieldCounter);
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'card mb-2';
        fieldDiv.innerHTML = `
          <div class="card-body">
            <div class="row g-2 align-items-center">
              <div class="col-md-3">
                <input type="text" class="form-control form-control-sm" placeholder="欄位標題" 
                       value="${fieldData?.label || ''}" data-field="label">
              </div>
              <div class="col-md-2">
                <select class="form-select form-select-sm" data-field="type">
                  <option value="text" ${fieldData?.type === 'text' ? 'selected' : ''}>文字</option>
                  <option value="email" ${fieldData?.type === 'email' ? 'selected' : ''}>Email</option>
                  <option value="tel" ${fieldData?.type === 'tel' ? 'selected' : ''}>電話</option>
                  <option value="number" ${fieldData?.type === 'number' ? 'selected' : ''}>數字</option>
                  <option value="date" ${fieldData?.type === 'date' ? 'selected' : ''}>日期</option>
                  <option value="textarea" ${fieldData?.type === 'textarea' ? 'selected' : ''}>多行文字</option>
                  <option value="select" ${fieldData?.type === 'select' ? 'selected' : ''}>下拉選單</option>
                  <option value="radio" ${fieldData?.type === 'radio' ? 'selected' : ''}>單選</option>
                  <option value="checkbox" ${fieldData?.type === 'checkbox' ? 'selected' : ''}>複選</option>
                </select>
              </div>
              <div class="col-md-3">
                <input type="text" class="form-control form-control-sm" placeholder="選項 (逗號分隔)" 
                       value="${fieldData?.options || ''}" data-field="options">
              </div>
              <div class="col-md-2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" ${fieldData?.required ? 'checked' : ''} data-field="required">
                  <label class="form-check-label small">必填</label>
                </div>
              </div>
              <div class="col-md-2">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.parentElement.parentElement.parentElement.remove()">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
        
        container.appendChild(fieldDiv);
      },
      
      save() {
        const form = document.getElementById('formBuilderForm');
        if (!form || !form.checkValidity()) {
          if (form) form.reportValidity();
          return;
        }
        
        // 收集表單欄位
        const fields = [];
        const fieldCards = document.querySelectorAll('#formFieldsContainer .card');
        fieldCards.forEach(card => {
          const field = {
            label: card.querySelector('[data-field="label"]')?.value || '',
            type: card.querySelector('[data-field="type"]')?.value || 'text',
            options: card.querySelector('[data-field="options"]')?.value || '',
            required: card.querySelector('[data-field="required"]')?.checked || false
          };
          if (field.label) fields.push(field);
        });
        
        const formData = {
          id: this.editingId || Util.uuid(),
          title: document.getElementById('formTitle')?.value || '',
          description: document.getElementById('formDescription')?.value || '',
          active: document.getElementById('formActive')?.checked !== false,
          fields: fields,
          submissions: this.editingId ? 
            Store.data.forms.find(f => f.id === this.editingId)?.submissions || [] : 
            [],
          createdAt: this.editingId ? 
            Store.data.forms.find(f => f.id === this.editingId)?.createdAt : 
            new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        if (this.editingId) {
          const index = Store.data.forms.findIndex(f => f.id === this.editingId);
          if (index >= 0) {
            Store.data.forms[index] = formData;
          }
        } else {
          Store.data.forms.push(formData);
        }
        
        Store.save().then(() => {
          if (document.getElementById('formsSection').style.display !== 'none') {
            Forms.renderList();
          }
          this.modal.hide();
          Util.showToast('success', this.editingId ? '表單已更新' : '表單已新增');
        }).catch(error => {
          Util.showToast('error', '儲存失敗');
        });
      }
    };

    // 表單列表
    const Forms = {
      renderList() {
        const container = document.getElementById('formsContainer');
        if (!container) return;
        
        const forms = Store.data.forms.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        
        if (!forms.length) {
          container.innerHTML = `
            <div class="text-center text-muted py-5">
              <i class="bi bi-file-earmark-arrow-down display-1 d-block mb-3"></i>
              <h5>尚無表單</h5>
              <p>點擊「新增表單」開始建立第一個表單</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = forms.map(form => `
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center gap-2">
                <h6 class="mb-0">${form.title}</h6>
                <span class="badge bg-${form.active ? 'success' : 'secondary'} badge-rounded">
                  ${form.active ? '啟用' : '停用'}
                </span>
              </div>
              <div class="d-flex align-items-center gap-2">
                <small class="text-muted">${(form.submissions || []).length} 筆回覆</small>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-info" onclick="Forms.showSubmissions('${form.id}')">
                    <i class="bi bi-eye"></i> 回覆
                  </button>
                  <button class="btn btn-outline-primary" onclick="FormUI.open('${form.id}')">
                    <i class="bi bi-pencil"></i> 編輯
                  </button>
                  <button class="btn btn-outline-danger" onclick="Forms.delete('${form.id}')">
                    <i class="bi bi-trash"></i> 刪除
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body">
              <p class="text-muted mb-2">${form.description || '無說明'}</p>
              <div class="small text-muted">
                <span>欄位數：${(form.fields || []).length}</span> •
                <span>建立時間：${Util.formatDate(form.createdAt)}</span>
              </div>
            </div>
          </div>
        `).join('');
      },
      
      delete(id) {
        Util.confirm({
          title: '刪除表單',
          text: '確定要刪除這個表單嗎？所有回覆資料也會一併刪除。',
          icon: 'warning'
        }).then(result => {
          if (result.isConfirmed) {
            Store.data.forms = Store.data.forms.filter(f => f.id !== id);
            Store.save().then(() => {
              this.renderList();
              Util.showToast('success', '表單已刪除');
            });
          }
        });
      },
      
      showSubmissions(formId) {
        const form = Store.data.forms.find(f => f.id === formId);
        if (!form) return;
        
        Util.showToast('info', '表單回覆功能開發中');
      }
    };

    // 帳戶管理
    const AccountUI = {
      modal: null,
      editModal: null,
      editingId: null,
      
      open() {
        if (!this.modal) {
          const modalEl = document.getElementById('accountManagerModal');
          if (modalEl && typeof bootstrap !== 'undefined') {
            this.modal = new bootstrap.Modal(modalEl);
          } else {
            Util.showToast('error', '無法開啟帳戶管理視窗');
            return;
          }
        }
        
        this.renderTable();
        this.modal.show();
      },
      
      renderTable() {
        const tbody = document.getElementById('accountTableBody');
        if (!tbody) return;
        
        const accounts = Store.data.accounts || [];
        
        tbody.innerHTML = accounts.map(acc => `
          <tr>
            <td>${acc.name}</td>
            <td>${acc.description || '-'}</td>
            <td class="text-end">$${Util.fmtNum(acc.initialBalance || 0)}</td>
            <td class="text-end ${(acc.currentBalance || 0) >= 0 ? 'text-success' : 'text-danger'}">
              $${Util.fmtNum(acc.currentBalance || 0)}
            </td>
            <td>
              <span class="badge bg-${acc.active ? 'success' : 'secondary'} badge-rounded">
                ${acc.active ? '啟用' : '停用'}
              </span>
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="AccountUI.openEditor('${acc.id}')">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="AccountUI.delete('${acc.id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      },
      
      openEditor(id = null) {
        this.editingId = id;
        
        if (!this.editModal) {
          const modalEl = document.getElementById('accountEditModal');
          if (modalEl && typeof bootstrap !== 'undefined') {
            this.editModal = new bootstrap.Modal(modalEl);
          } else {
            Util.showToast('error', '無法開啟帳戶編輯視窗');
            return;
          }
        }
        
        const form = document.getElementById('accountForm');
        if (form) form.reset();
        
        document.getElementById('accountEditTitle').textContent = id ? '編輯帳戶' : '新增帳戶';
        
        if (id) {
          const account = Store.data.accounts.find(a => a.id === id);
          if (account) {
            document.getElementById('accountName').value = account.name || '';
            document.getElementById('accountDesc').value = account.description || '';
            document.getElementById('accountInitial').value = account.initialBalance || 0;
            document.getElementById('accountNotes').value = account.notes || '';
            document.getElementById('accountActive').checked = account.active !== false;
          }
        }
        
        this.editModal.show();
      },
      
      save() {
        const form = document.getElementById('accountForm');
        if (!form || !form.checkValidity()) {
          if (form) form.reportValidity();
          return;
        }
        
        const initialBalance = Util.toNumber(document.getElementById('accountInitial')?.value || 0);
        
        const account = {
          id: this.editingId || Util.uuid(),
          name: document.getElementById('accountName')?.value || '',
          description: document.getElementById('accountDesc')?.value || '',
          initialBalance: initialBalance,
          currentBalance: this.editingId ? 
            Store.data.accounts.find(a => a.id === this.editingId)?.currentBalance || initialBalance : 
            initialBalance,
          notes: document.getElementById('accountNotes')?.value || '',
          active: document.getElementById('accountActive')?.checked !== false,
          createdAt: this.editingId ? 
            Store.data.accounts.find(a => a.id === this.editingId)?.createdAt : 
            new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        if (this.editingId) {
          const index = Store.data.accounts.findIndex(a => a.id === this.editingId);
          if (index >= 0) {
            Store.data.accounts[index] = account;
          }
        } else {
          Store.data.accounts.push(account);
        }
        
        Store.save().then(() => {
          this.renderTable();
          Dashboard.refresh();
          this.editModal.hide();
          Util.showToast('success', this.editingId ? '帳戶已更新' : '帳戶已新增');
        }).catch(error => {
          Util.showToast('error', '儲存失敗');
        });
      },
      
      delete(id) {
        // 檢查是否有交易使用此帳戶
        const hasTransactions = Store.data.transactions.some(tx => tx.account === id);
        
        if (hasTransactions) {
          Util.showToast('error', '此帳戶已有交易記錄，無法刪除');
          return;
        }
        
        Util.confirm({
          title: '刪除帳戶',
          text: '確定要刪除這個帳戶嗎？',
          icon: 'warning'
        }).then(result => {
          if (result.isConfirmed) {
            Store.data.accounts = Store.data.accounts.filter(a => a.id !== id);
            Store.save().then(() => {
              this.renderTable();
              Dashboard.refresh();
              Util.showToast('success', '帳戶已刪除');
            });
          }
        });
      }
    };

    // 系統設定
    const SettingsUI = {
      modal: null,
      
      open() {
        if (!this.modal) {
          const modalEl = document.getElementById('settingsModal');
          if (modalEl && typeof bootstrap !== 'undefined') {
            this.modal = new bootstrap.Modal(modalEl);
          } else {
            Util.showToast('error', '無法開啟設定視窗');
            return;
          }
        }
        
        this.loadSettings();
        this.modal.show();
      },
      
      loadSettings() {
        const settings = Store.data.settings;
        
        document.getElementById('settingOrgName').value = settings.organizationName || '';
        document.getElementById('settingDefaultFee').value = settings.defaultMembershipFee || '';
        document.getElementById('settingReceiptPrefix').value = settings.receiptPrefix || '';
        document.getElementById('settingIncomeCategories').value = (settings.incomeCategories || []).join('\n');
        document.getElementById('settingExpenseCategories').value = (settings.expenseCategories || []).join('\n');
      },
      
      save() {
        const settings = {
          ...Store.data.settings,
          organizationName: document.getElementById('settingOrgName')?.value || '',
          defaultMembershipFee: Util.toNumber(document.getElementById('settingDefaultFee')?.value || 0),
          receiptPrefix: document.getElementById('settingReceiptPrefix')?.value || 'R',
          incomeCategories: document.getElementById('settingIncomeCategories')?.value.split('\n').filter(c => c.trim()),
          expenseCategories: document.getElementById('settingExpenseCategories')?.value.split('\n').filter(c => c.trim())
        };
        
        Store.data.settings = settings;
        
        Store.save().then(() => {
          this.modal.hide();
          Util.showToast('success', '設定已儲存');
        }).catch(error => {
          Util.showToast('error', '儲存失敗');
        });
      }
    };

    // 統計分析
    const Analytics = {
      charts: {},
      
      renderCharts() {
        if (typeof Chart === 'undefined') {
          console.warn('Chart.js not loaded');
          return;
        }
        
        this.renderIncomeExpenseChart();
        this.renderMemberGrowthChart();
        this.renderCategoryChart();
        this.renderMonthlyTrend();
      },
      
      renderIncomeExpenseChart() {
        const ctx = document.getElementById('incomeExpenseChart');
        if (!ctx) return;
        
        if (this.charts.incomeExpense) {
          this.charts.incomeExpense.destroy();
        }
        
        // 準備數據 - 最近12個月
        const months = [];
        const incomeData = [];
        const expenseData = [];
        
        for (let i = 11; i >= 0; i--) {
          const date = new Date();
          date.setMonth(date.getMonth() - i);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          months.push(date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'short' }));
          
          const monthTransactions = Store.data.transactions.filter(tx => 
            tx.date.startsWith(monthKey)
          );
          
          const income = monthTransactions
            .filter(tx => tx.type === '收入')
            .reduce((sum, tx) => sum + Util.toNumber(tx.amount), 0);
          
          const expense = monthTransactions
            .filter(tx => tx.type === '支出')
            .reduce((sum, tx) => sum + Util.toNumber(tx.amount), 0);
          
          incomeData.push(income);
          expenseData.push(expense);
        }
        
        this.charts.incomeExpense = new Chart(ctx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: '收入',
              data: incomeData,
              borderColor: '#198754',
              backgroundColor: 'rgba(25, 135, 84, 0.1)',
              tension: 0.4
            }, {
              label: '支出',
              data: expenseData,
              borderColor: '#dc3545',
              backgroundColor: 'rgba(220, 53, 69, 0.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: '收支趨勢分析'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '$' + value.toLocaleString();
                  }
                }
              }
            }
          }
        });
      },
      
      renderMemberGrowthChart() {
        const ctx = document.getElementById('memberGrowthChart');
        if (!ctx) return;
        
        if (this.charts.memberGrowth) {
          this.charts.memberGrowth.destroy();
        }
        
        // 準備數據 - 會員成長
        const months = [];
        const growthData = [];
        let cumulativeMembers = 0;
        
        for (let i = 11; i >= 0; i--) {
          const date = new Date();
          date.setMonth(date.getMonth() - i);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          months.push(date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'short' }));
          
          const monthMembers = Store.data.members.filter(m => 
            m.joinDate && m.joinDate.startsWith(monthKey)
          ).length;
          
          cumulativeMembers += monthMembers;
          growthData.push(cumulativeMembers);
        }
        
        this.charts.memberGrowth = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: months,
            datasets: [{
              label: '累計會員數',
              data: growthData,
              backgroundColor: '#0d6efd',
              borderColor: '#0d6efd',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: '會員成長趨勢'
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      },
      
      renderCategoryChart() {
        const ctx = document.getElementById('categoryChart');
        if (!ctx) return;
        
        if (this.charts.category) {
          this.charts.category.destroy();
        }
        
        // 準備數據 - 支出類別分析
        const expenseCategories = {};
        Store.data.transactions
          .filter(tx => tx.type === '支出')
          .forEach(tx => {
            const category = tx.category || '其他';
            expenseCategories[category] = (expenseCategories[category] || 0) + Util.toNumber(tx.amount);
          });
        
        const labels = Object.keys(expenseCategories);
        const data = Object.values(expenseCategories);
        const colors = [
          '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff',
          '#ff9f40', '#ff6384', '#c9cbcf', '#4bc0c0', '#ff6384'
        ];
        
        this.charts.category = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: colors.slice(0, labels.length),
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: '支出類別分布'
              },
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      },
      
      renderMonthlyTrend() {
        const ctx = document.getElementById('monthlyTrendChart');
        if (!ctx) return;
        
        if (this.charts.monthlyTrend) {
          this.charts.monthlyTrend.destroy();
        }
        
        // 準備數據 - 月度淨收益
        const months = [];
        const netData = [];
        
        for (let i = 11; i >= 0; i--) {
          const date = new Date();
          date.setMonth(date.getMonth() - i);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          months.push(date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'short' }));
          
          const monthTransactions = Store.data.transactions.filter(tx => 
            tx.date.startsWith(monthKey)
          );
          
          const income = monthTransactions
            .filter(tx => tx.type === '收入')
            .reduce((sum, tx) => sum + Util.toNumber(tx.amount), 0);
          
          const expense = monthTransactions
            .filter(tx => tx.type === '支出')
            .reduce((sum, tx) => sum + Util.toNumber(tx.amount), 0);
          
          netData.push(income - expense);
        }
        
        this.charts.monthlyTrend = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: months,
            datasets: [{
              label: '淨收益',
              data: netData,
              backgroundColor: netData.map(value => value >= 0 ? '#198754' : '#dc3545'),
              borderColor: netData.map(value => value >= 0 ? '#198754' : '#dc3545'),
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: '月度淨收益趨勢'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '$' + value.toLocaleString();
                  }
                }
              }
            }
          }
        });
      }
    };

    // 報表功能
    const Reports = {
      init() {
        this.renderSummary();
        this.renderRecentTransactions();
      },
      
      renderSummary() {
        const container = document.getElementById('reportSummary');
        if (!container) return;
        
        const transactions = Store.data.transactions;
        const members = Store.data.members;
        const accounts = Store.data.accounts;
        
        const totalIncome = transactions
          .filter(tx => tx.type === '收入')
          .reduce((sum, tx) => sum + Util.toNumber(tx.amount), 0);
        
        const totalExpense = transactions
          .filter(tx => tx.type === '支出')
          .reduce((sum, tx) => sum + Util.toNumber(tx.amount), 0);
        
        const totalBalance = accounts.reduce((sum, acc) => sum + (acc.currentBalance || 0), 0);
        
        const activeMembers = members.filter(m => m.status === 'active').length;
        
        container.innerHTML = `
          <div class="row g-3">
            <div class="col-md-3">
              <div class="card bg-success text-white">
                <div class="card-body text-center">
                  <h4>$${Util.fmtNum(totalIncome)}</h4>
                  <p class="mb-0">總收入</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-danger text-white">
                <div class="card-body text-center">
                  <h4>$${Util.fmtNum(totalExpense)}</h4>
                  <p class="mb-0">總支出</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-info text-white">
                <div class="card-body text-center">
                  <h4>$${Util.fmtNum(totalBalance)}</h4>
                  <p class="mb-0">總餘額</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-primary text-white">
                <div class="card-body text-center">
                  <h4>${activeMembers}</h4>
                  <p class="mb-0">活躍會員</p>
                </div>
              </div>
            </div>
          </div>
        `;
      },
      
      renderRecentTransactions() {
        const container = document.getElementById('reportTransactions');
        if (!container) return;
        
        const recent = Store.data.transactions
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .slice(0, 10);
        
        if (!recent.length) {
          container.innerHTML = '<div class="text-center text-muted py-4">尚無交易記錄</div>';
          return;
        }
        
        container.innerHTML = `
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>日期</th>
                  <th>類型</th>
                  <th>類別</th>
                  <th class="text-end">金額</th>
                  <th>對象</th>
                  <th>說明</th>
                </tr>
              </thead>
              <tbody>
                ${recent.map(tx => `
                  <tr>
                    <td>${Util.formatDate(tx.date)}</td>
                    <td><span class="badge bg-${tx.type === '收入' ? 'success' : 'danger'}">${tx.type}</span></td>
                    <td>${tx.category || '-'}</td>
                    <td class="text-end ${tx.type === '收入' ? 'text-success' : 'text-danger'}">
                      ${tx.type === '收入' ? '+' : '-'}$${Util.fmtNum(tx.amount)}
                    </td>
                    <td>${tx.counterparty || '-'}</td>
                    <td class="small">${tx.description || '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      },
      
      exportData(type) {
        let data, filename;
        
        switch(type) {
          case 'transactions':
            data = Store.data.transactions;
            filename = '交易記錄.json';
            break;
          case 'members':
            data = Store.data.members;
            filename = '會員資料.json';
            break;
          case 'all':
            data = Store.data;
            filename = '完整資料.json';
            break;
          default:
            return;
        }
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        
        Util.showToast('success', '資料已匯出');
      },
      
      importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const importedData = JSON.parse(e.target.result);
              
              Util.confirm({
                title: '匯入資料',
                text: '確定要匯入資料嗎？這會覆蓋現有資料。',
                icon: 'warning'
              }).then(result => {
                if (result.isConfirmed) {
                  Store.data = { ...Store.data, ...importedData };
                  Store.save().then(() => {
                    Dashboard.refresh();
                    Util.showToast('success', '資料匯入成功');
                  });
                }
              });
            } catch (error) {
              Util.showToast('error', '檔案格式錯誤');
            }
          };
          reader.readAsText(file);
        };
        input.click();
      }
    };

    // 全域事件監聽
    document.addEventListener('DOMContentLoaded', function() {
      // 載入資料
      Store.load().then(() => {
        // 初始化應用
        AppLayout.showSection('dashboard');
        
        // 設定導航事件
        document.querySelectorAll('.nav-link[data-section]').forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.dataset.section;
            AppLayout.showSection(section, this);
          });
        });
        
        // 設定側邊欄切換
        const sidebarToggle = document.getElementById('sidebarToggle');
        if (sidebarToggle) {
          sidebarToggle.addEventListener('click', () => AppLayout.toggleSidebar());
        }
        
        // 設定篩選事件
        const filterElements = [
          'txFilterYear', 'txFilterMonth', 'txFilterType', 'txFilterKeyword',
          'memberFilterStatus', 'memberFilterType', 'memberFilterKeyword'
        ];
        
        filterElements.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            const handler = Util.debounce(() => {
              if (id.startsWith('tx')) {
                Transactions.state.page = 1;
                Transactions.renderTable();
              } else if (id.startsWith('member')) {
                Members.state.page = 1;
                Members.renderTable();
              }
            }, 300);
            
            el.addEventListener('input', handler);
            el.addEventListener('change', handler);
          }
        });
        
        // 設定交易類型變更事件
        const txTypeEl = document.getElementById('txType');
        if (txTypeEl) {
          txTypeEl.addEventListener('change', () => TransactionUI.onTypeChange());
        }
        
        // 設定憑證上傳事件
        const voucherEl = document.getElementById('txVoucher');
        if (voucherEl) {
          voucherEl.addEventListener('change', (e) => TransactionUI.handleVoucherUpload(e));
        }
        
        // 響應式處理
        const handleResize = () => {
          if (window.innerWidth >= 992) {
            document.getElementById('sidebar').classList.add('show');
          }
        };
        
        window.addEventListener('resize', handleResize);
        handleResize();
        
        console.log('社團管理系統已初始化');
      }).catch(error => {
        console.error('初始化失敗:', error);
        Util.showToast('error', '系統初始化失敗');
      });
    });

    // 暴露全域函數
    window.AppLayout = AppLayout;
    window.Dashboard = Dashboard;
    window.TransactionUI = TransactionUI;
    window.Transactions = Transactions;
    window.MemberUI = MemberUI;
    window.Members = Members;
    window.ActivityUI = ActivityUI;
    window.Activities = Activities;
    window.AnnouncementUI = AnnouncementUI;
    window.Announcements = Announcements;
    window.FormUI = FormUI;
    window.Forms = Forms;
    window.AccountUI = AccountUI;
    window.SettingsUI = SettingsUI;
    window.Analytics = Analytics;
    window.Reports = Reports;
    window.CloudSync = CloudSync;

  })();
</script>

  </body>
</html>



