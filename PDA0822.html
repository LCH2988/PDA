<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>台灣帕金森病友權益促進會 - 會計暨營運整合管理系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="非營利組織整合：財務 / 會員 / 活動 / 公告 / 表單 / 雲端備份管理系統">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <style>
    :root {
      --primary:#2c5aa0;
      --primary-dark:#1e3d6f;
      --gradient-primary:linear-gradient(135deg,#2c5aa0,#4a90e2);
      --gradient-green:linear-gradient(135deg,#28a745,#20c997);
      --gradient-orange:linear-gradient(135deg,#ff9f40,#ffb347);
      --secondary-bg:#f8f9fa;
      --radius-lg:15px;
      --radius-md:10px;
      --radius-sm:6px;
    }
    body {
      background:var(--secondary-bg);
      font-family:"Microsoft JhengHei","Noto Sans TC",system-ui,sans-serif;
      font-size:14.5px;
    }
    .navbar-brand { font-weight:600; color:var(--primary)!important; }
    .sidebar {
      min-height:100vh;
      background:linear-gradient(180deg,#2c5aa0,#1e3d6f);
      color:#fff;
    }
    .sidebar .nav-link {
      color:rgba(255,255,255,.82);
      border-radius:8px;
      margin:3px 0;
      font-weight:500;
      transition:.25s;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background:rgba(255,255,255,0.12);
      color:#fff;
      transform:translateX(4px);
    }
    .content-section { animation:fadeIn .35s ease; }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(12px); }
      to { opacity:1; transform:translateY(0); }
    }
    .stat-card {
      background:var(--gradient-primary);
      color:#fff;
      border:none;
      border-radius:var(--radius-lg);
      box-shadow:0 4px 14px -4px rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
    }
    .stat-card.alt-green { background:var(--gradient-green); }
    .stat-card.alt-orange{ background:var(--gradient-orange); }
    .stat-card .icon-bg {
      position:absolute;
      right:-10px; top:-10px;
      font-size:72px;
      opacity:.16;
    }
    .card-hoverable { transition:.25s; border:none; border-radius:var(--radius-lg); }
    .card-hoverable:hover { transform:translateY(-4px); box-shadow:0 8px 24px -6px rgba(0,0,0,.15); }
    .table thead th { background:#f1f4f8; border-top:none; font-weight:600; }
    .badge-rounded { border-radius:20px; font-weight:500; letter-spacing:.5px; }
    .member-avatar, .participant-avatar {
      width:40px;height:40px;border-radius:50%;background:#fff;
      display:flex;align-items:center;justify-content:center;
      color:#666;font-weight:600;
      box-shadow:0 0 0 1px rgba(0,0,0,.05);
    }
    .small-avatar { width:32px;height:32px;font-size:12px; }
    .action-buttons .btn { padding:.25rem .5rem; }
    .voucher-preview img {
      max-width:100px;max-height:100px;object-fit:cover;border-radius:6px;margin:4px;cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    .loading-overlay {
      position:fixed; inset:0; z-index:2000;
      background:rgba(0,0,0,.45); display:flex;align-items:center;justify-content:center;
    }
    .pagination .page-link { border:none; border-radius:8px; color:var(--primary); }
    .pagination .page-item.active .page-link { background:var(--primary); }
    .chart-container { position:relative; height:380px; }
    .separator-title {
      font-size:15px;font-weight:600;margin:16px 0 10px;display:flex;align-items:center;gap:.5rem;
    }
    .separator-title:before, .separator-title:after {
      content:""; flex:1; height:1px; background:linear-gradient(90deg,#d0d3d9,#ffffff);
    }
    .form-download-item {
      border:1px solid #e2e6eb; padding:14px 16px; border-radius:var(--radius-md);
      background:#fff; position:relative; transition:.25s;
    }
    .form-download-item:hover { box-shadow:0 6px 18px -6px rgba(0,0,0,.15); transform:translateY(-3px); }
    .activity-card { border:none;border-radius:var(--radius-lg);overflow:hidden;box-shadow:0 3px 10px -2px rgba(0,0,0,.12);position:relative; }
    .activity-card .progress { height:6px; border-radius:3px; background:#e9ecef; overflow:hidden; }
    .activity-card .progress-bar { background:var(--gradient-green); }
    .announcement-card { border-left:5px solid #ffc107; border-radius:var(--radius-md); }
    .announcement-card.urgent { border-left-color:#dc3545; background:linear-gradient(135deg,#fff5f5,#ffffff); }
    .dual-col { columns:2 320px; column-gap:14px; }
    .row-invalid { background:#fff5f5!important; }
    .row-duplicate { background:#fff9e6!important; }
    .preview-status-badge { font-size:10px; }
    .mapping-select { width:100%; margin-bottom:6px; }
    @media print {
      .no-print, .sidebar, .navbar, .modal-backdrop { display:none!important; }
      body { background:#fff; }
      .main-content { margin:0!important; padding:0!important; }
      .card { box-shadow:none!important; }
    }
    @media (max-width: 992px){
      .sidebar { position:fixed; left:0; top:0; transform:translateX(-100%); transition:.35s; z-index:1100; width:250px; }
      .sidebar.show { transform:translateX(0); }
    }
    .spin { animation:spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .receipt-seal-placeholder { width:60px; height:60px; border:2px solid #c00; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:#c00; }
    
    /* 雲端同步狀態 */
    .sync-status {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1200;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .sync-status .badge {
      font-size: 11px;
      padding: 4px 8px;
    }
    .cloud-connected { background: #28a745 !important; }
    .cloud-syncing { background: #ffc107 !important; color: #000 !important; }
    .cloud-error { background: #dc3545 !important; }
  </style>
</head>
<body>
  <!-- 全螢幕載入遮罩 -->
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="text-center text-white">
      <div class="mb-3">
        <i class="bi bi-arrow-clockwise spin" style="font-size:48px;"></i>
      </div>
      <div>系統載入中，請稍候…</div>
    </div>
  </div>

  <!-- 雲端同步狀態 -->
  <div class="sync-status no-print">
    <span id="cloudStatus" class="badge cloud-connected">
      <i class="bi bi-cloud-check"></i> 雲端已連線
    </span>
    <span id="syncStatus" class="badge bg-success" style="display:none;">
      <i class="bi bi-arrow-repeat spin"></i> 同步中
    </span>
  </div>

  <!-- 導覽列 -->
  <nav class="navbar navbar-expand-lg bg-white shadow-sm no-print">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <i class="bi bi-heart-pulse me-2"></i> 台灣帕金森病友權益促進會
      </a>
      <button class="navbar-toggler" type="button" onclick="AppLayout.toggleSidebar()">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item me-2">
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
              <input id="globalSearchInput" type="text" class="form-control" placeholder="全域搜尋 (交易 / 會員 / 活動 / 公告)" onkeydown="if(event.key==='Enter') GlobalSearch.exec()">
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle fw-semibold" href="#" data-bs-toggle="dropdown">
              <i class="bi bi-gear"></i> 系統
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" onclick="SettingsUI.open()"><i class="bi bi-sliders"></i> 系統設定</a></li>
              <li><a class="dropdown-item" href="#" onclick="AccountUI.openManager()"><i class="bi bi-bank"></i> 帳戶管理</a></li>
              <li><a class="dropdown-item" href="#" onclick="CloudSync.forceSync()"><i class="bi bi-cloud-arrow-up"></i> 立即同步</a></li>
              <li><a class="dropdown-item" href="#" onclick="BatchImport.open('transactions')"><i class="bi bi-cloud-upload"></i> 批次匯入</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.exportAll()"><i class="bi bi-download"></i> 匯出資料</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.importAll()"><i class="bi bi-upload"></i> 匯入資料</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="Shortcuts.show()"><i class="bi bi-keyboard"></i> 快捷鍵</a></li>
              <li><a class="dropdown-item" href="#" onclick="About.show()"><i class="bi bi-info-circle"></i> 關於</a></li>
              <li><a class="dropdown-item" href="#" onclick="ConfirmReset.show()"><i class="bi bi-exclamation-triangle"></i> 系統重置</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- 側邊欄 -->
      <aside id="sidebar" class="sidebar col-lg-2 col-md-3 p-3">
        <h6 class="text-center mt-2 mb-4 fw-semibold">管理選單</h6>
        <nav class="nav flex-column">
          <a class="nav-link active" href="#" data-section="dashboard" onclick="AppLayout.showSection('dashboard',this)"><i class="bi bi-speedometer2 me-2"></i>儀表板</a>
          <a class="nav-link" href="#" data-section="transactions" onclick="AppLayout.showSection('transactions',this)"><i class="bi bi-receipt me-2"></i>交易記錄</a>
          <a class="nav-link" href="#" data-section="members" onclick="AppLayout.showSection('members',this)"><i class="bi bi-people me-2"></i>會員管理</a>
          <a class="nav-link" href="#" data-section="activities" onclick="AppLayout.showSection('activities',this)"><i class="bi bi-calendar-event me-2"></i>活動管理</a>
          <a class="nav-link" href="#" data-section="announcements" onclick="AppLayout.showSection('announcements',this)"><i class="bi bi-megaphone me-2"></i>公告管理</a>
          <a class="nav-link" href="#" data-section="forms" onclick="AppLayout.showSection('forms',this)"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單</a>
          <a class="nav-link" href="#" data-section="analytics" onclick="AppLayout.showSection('analytics',this)"><i class="bi bi-graph-up me-2"></i>統計分析</a>
          <a class="nav-link" href="#" data-section="reports" onclick="AppLayout.showSection('reports',this)"><i class="bi bi-file-earmark-text me-2"></i>報表中心</a>
        </nav>
      </aside>

      <!-- 主要內容 -->
      <main id="mainContent" class="col-lg-10 col-md-9 p-4">
        <!-- 儀表板 -->
        <section id="dashboardSection" class="content-section">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>儀表板</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
              <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
              <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
            </div>
          </div>

          <!-- 統計卡片列 -->
          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100">
                <div class="icon-bg"><i class="bi bi-cash-coin"></i></div>
                <small>總收入</small>
                <h3 id="dashTotalIncome" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">本月</span>
                  <span id="dashMonthIncome" class="small fw-semibold">$0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100 alt-orange">
                <div class="icon-bg"><i class="bi bi-credit-card-2-front"></i></div>
                <small>總支出</small>
                <h3 id="dashTotalExpense" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">本月</span>
                  <span id="dashMonthExpense" class="small fw-semibold">$0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100 alt-green">
                <div class="icon-bg"><i class="bi bi-bank"></i></div>
                <small>帳戶總餘額</small>
                <h3 id="dashTotalBalance" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">帳戶數</span>
                  <span id="dashAccountCount" class="small fw-semibold">0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100">
                <div class="icon-bg"><i class="bi bi-people"></i></div>
                <small>會員總數</small>
                <h3 id="dashMemberTotal" class="mb-1">0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">逾期會費</span>
                  <span id="dashMemberOverdue" class="badge bg-danger rounded-pill">0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 帳戶餘額 -->
          <div class="card card-hoverable mb-3">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h6 class="mb-0"><i class="bi bi-bank me-1"></i>帳戶餘額概覽</h6>
              <button class="btn btn-sm btn-outline-primary" onclick="AccountUI.openManager()"><i class="bi bi-gear"></i> 管理帳戶</button>
            </div>
            <div class="card-body">
              <div id="dashboardAccountBalances" class="row g-3">
                <!-- 動態填入 -->
              </div>
            </div>
          </div>

          <!-- 最新交易 / 最新會員 / 最新活動 -->
          <div class="row g-3">
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-arrows-expand me-1"></i>最近交易</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentTx">
                  <!-- 動態 -->
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-person-plus me-1"></i>新加入會員</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentMembers">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-calendar-event me-1"></i>近期活動</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentActivities">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 其他 Section 保持原樣，這裡省略以節省空間 -->
        <!-- 交易記錄、會員管理、活動管理等 Section 內容與原版相同 -->
        
      </main>
    </div>
  </div>

  <!-- 依賴套件 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    /* ================================================================
     Google Apps Script 整合版 - 核心 JS
     ================================================================ */

    /* -------------------- 雲端 API 層 -------------------- */
    const CloudAPI = {
      // GAS Web App URL - 請替換為您的 GAS Web App URL
      BASE_URL: 'https://script.google.com/macros/s/AKfycbydnmCgE1AG1gfgSqHqBjr_mzAXAlFOIGtqTsK_xwmd-34TNf7rPBREp2g7XdftsnbnQQ/exec',
      
      async request(action, data = {}) {
        try {
          this.showSyncStatus(true);
          
          const response = await fetch(this.BASE_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action, data })
          });
          
          const result = await response.json();
          
          if (!result.success) {
            throw new Error(result.error || 'API request failed');
          }
          
          this.showSyncStatus(false);
          this.updateCloudStatus('connected');
          return result.data;
          
        } catch (error) {
          this.showSyncStatus(false);
          this.updateCloudStatus('error');
          console.error('CloudAPI Error:', error);
          throw error;
        }
      },
      
      showSyncStatus(show) {
        const el = document.getElementById('syncStatus');
        if (el) {
          el.style.display = show ? 'inline-block' : 'none';
        }
      },
      
      updateCloudStatus(status) {
        const el = document.getElementById('cloudStatus');
        if (!el) return;
        
        el.className = 'badge';
        switch(status) {
          case 'connected':
            el.classList.add('cloud-connected');
            el.innerHTML = '<i class="bi bi-cloud-check"></i> 雲端已連線';
            break;
          case 'syncing':
            el.classList.add('cloud-syncing');
            el.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> 同步中';
            break;
          case 'error':
            el.classList.add('cloud-error');
            el.innerHTML = '<i class="bi bi-cloud-slash"></i> 連線錯誤';
            break;
          default:
            el.classList.add('bg-secondary');
            el.innerHTML = '<i class="bi bi-cloud"></i> 未連線';
        }
      }
    };

    /* -------------------- 工具層 -------------------- */
    const Util = {
      uuid: () => 'id_' + Math.random().toString(36).slice(2,10) + '_' + Date.now(),
      today: () => new Date().toISOString().split('T')[0],
      fmtNum: n => (Number(n)||0).toLocaleString(),
      toNumber: v => isNaN(parseFloat(v))?0:parseFloat(v),
      pad: (n,l=2) => String(n).padStart(l,'0'),
      
      formatDateInput(d){
        if(!d) return '';
        if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
        let s = String(d).replace(/[年月\.\/]/g,'-').replace(/日/,'');
        const m = s.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
        if(m) return m[1]+'-'+Util.pad(m[2])+'-'+Util.pad(m[3]);
        const dt = new Date(d);
        if(isNaN(dt.getTime())) return '';
        return dt.toISOString().split('T')[0];
      },
      
      age(birth){
        if(!birth) return '';
        const d = new Date(birth); if(isNaN(d.getTime())) return '';
        const t = new Date();
        let a = t.getFullYear()-d.getFullYear();
        if(t.getMonth()<d.getMonth() || (t.getMonth()==d.getMonth() && t.getDate()<d.getDate())) a--;
        return a;
      },
      
      showToast(type,msg){
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: type === 'success' ? 'success' : 'error',
          title: msg,
          showConfirmButton: false,
          timer: 3000
        });
      },
      
      confirm(opts){
        return Swal.fire({
          icon:opts.icon||'warning',
          title:opts.title||'確定？',
          html:opts.html||opts.text||'',
          showCancelButton:true,
          confirmButtonText:opts.confirmText||'確定',
          cancelButtonText:opts.cancelText||'取消',
          confirmButtonColor:opts.confirmColor||'#0d6efd'
        });
      },
      
      chunk(arr,size){
        const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size)); return out;
      },
      
      downloadBlob(filename, data, type='text/plain'){
        const blob = new Blob([data],{type});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download=filename;
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href),1000);
      },
      
      financialChinese(num){
        num = Number(num);
        if(isNaN(num)) return '';
        if(num===0) return '零元整';
        const cNum=['零','壹','貳','參','肆','伍','陸','柒','捌','玖'];
        const cUnit=['','拾','佰','仟'];
        const cSec=['','萬','億','兆'];
        const cDec=['角','分'];
        let s=Math.floor(num).toString(), dec=Math.round((num - Math.floor(num))*100).toString().padStart(2,'0');
        let res='';
        if(Number(s)>0){
          let k=0;
          while(s.length>0){
            let seg = s.slice(-4); s=s.slice(0,-4);
            let segStr='', zeroFlag=false;
            for(let i=0;i<seg.length;i++){
              const d=seg[seg.length-1-i];
                if(d==='0'){
                  if(!zeroFlag && segStr) segStr='零'+segStr;
                  zeroFlag=true;
                }else{
                  zeroFlag=false;
                  segStr = cNum[+d]+cUnit[i]+segStr;
                }
            }
            segStr=segStr.replace(/零+/g,'零').replace(/零$/,'');
            if(segStr) res = segStr + cSec[k] + res;
            k++;
          }
          res += '元';
        }
        dec = dec.replace(/0+$/,'');
        if(dec){
          if(dec[0]!=='0') res += cNum[+dec[0]]+cDec[0];
          if(dec[1] && dec[1]!=='0') res += cNum[+dec[1]]+cDec[1];
        } else res+='整';
        return res;
      }
    };

    /* -------------------- 資料儲存層 (雲端版) -------------------- */
    const Store = {
      data: {
        transactions: [],
        members: [],
        accounts: [],
        activities: [],
        registrations: [],
        announcements: [],
        forms: [],
        settings: {
          organizationName: '台灣帕金森病友權益促進會',
          organizationAddress: '',
          organizationPhone: '',
          organizationEmail: '',
          defaultMembershipFee: 1000,
          receiptPrefix: 'R',
          voucherPrefix: 'V',
          treasurerSeal: '出納',
          accountantSeal: '會計',
          chairmanSeal: '理事長',
          enableAutoBackup: false,
          enableNotifications: true,
          categories: {
            '收入': ['會費','捐款','活動收入','政府補助','利息收入','其他收入'],
            '支出': ['活動費用','辦公費用','交通費','餐費','場地費','設備費','印刷費','郵電費','保險費','其他支出']
          }
        }
      },
      
      async load() {
        try {
          // 載入所有資料表
          const tables = ['transactions', 'members', 'accounts', 'activities', 'registrations', 'announcements', 'forms'];
          
          for (const table of tables) {
            try {
              const data = await CloudAPI.request('getData', { table });
              this.data[table] = data || [];
            } catch (error) {
              console.warn(`Failed to load ${table}:`, error);
              this.data[table] = [];
            }
          }
          
          // 載入設定
          try {
            const settings = await CloudAPI.request('getSettings');
            this.data.settings = { ...this.data.settings, ...settings };
          } catch (error) {
            console.warn('Failed to load settings:', error);
          }
          
          console.log('Data loaded from cloud:', this.data);
        } catch (error) {
          console.error('Failed to load data:', error);
          Util.showToast('error', '載入資料失敗，使用預設資料');
        }
      },
      
      async save(tableName = null) {
        try {
          if (tableName) {
            // 儲存單一資料表
            await CloudAPI.request('saveData', {
              table: tableName,
              records: this.data[tableName]
            });
          } else {
            // 儲存所有資料表
            const tables = ['transactions', 'members', 'accounts', 'activities', 'registrations', 'announcements', 'forms'];
            
            for (const table of tables) {
              await CloudAPI.request('saveData', {
                table: table,
                records: this.data[table]
              });
            }
            
            // 儲存設定
            await CloudAPI.request('saveSettings', {
              settings: this.data.settings
            });
          }
          
          console.log('Data saved to cloud');
        } catch (error) {
          console.error('Failed to save data:', error);
          Util.showToast('error', '儲存資料失敗');
          throw error;
        }
      }
    };

    /* -------------------- 雲端同步管理 -------------------- */
    const CloudSync = {
      autoSyncInterval: null,
      
      async initialize() {
        try {
          // 初始化系統
          await CloudAPI.request('initializeSystem');
          console.log('Cloud system initialized');
        } catch (error) {
          console.error('Failed to initialize cloud system:', error);
        }
      },
      
      async forceSync() {
        try {
          Util.showToast('success', '開始同步資料...');
          await Store.save();
          Util.showToast('success', '資料同步完成');
        } catch (error) {
          Util.showToast('error', '同步失敗: ' + error.message);
        }
      },
      
      startAutoSync(intervalMinutes = 5) {
        if (this.autoSyncInterval) {
          clearInterval(this.autoSyncInterval);
        }
        
        this.autoSyncInterval = setInterval(async () => {
          try {
            await Store.save();
            console.log('Auto sync completed');
          } catch (error) {
            console.error('Auto sync failed:', error);
          }
        }, intervalMinutes * 60 * 1000);
      },
      
      stopAutoSync() {
        if (this.autoSyncInterval) {
          clearInterval(this.autoSyncInterval);
          this.autoSyncInterval = null;
        }
      }
    };

    /* -------------------- 編號產生 -------------------- */
    const Numbering = {
      receipt() {
        const s = Store.data.settings;
        const today = Util.today();
        const count = Store.data.transactions.filter(t=>t.type==='收入' && t.date===today).length + 1;
        const d = new Date();
        return (s.receiptPrefix||'R')+d.getFullYear()+Util.pad(d.getMonth()+1)+Util.pad(d.getDate())+Util.pad(count,3);
      },
      voucher() {
        const s = Store.data.settings;
        const today = Util.today();
        const count = Store.data.transactions.filter(t=>t.type==='支出' && t.date===today).length + 1;
        const d = new Date();
        return (s.voucherPrefix||'V')+d.getFullYear()+Util.pad(d.getMonth()+1)+Util.pad(d.getDate())+Util.pad(count,3);
      }
    };

    /* -------------------- Layout 控制 -------------------- */
    const AppLayout = {
      showSection(name, link) {
        document.querySelectorAll('.content-section').forEach(s=>s.style.display='none');
        document.getElementById(name+'Section').style.display='block';
        document.querySelectorAll('.sidebar .nav-link').forEach(a=>a.classList.remove('active'));
        if(link) link.classList.add('active');
        
        switch(name) {
          case 'dashboard': Dashboard.refresh(); break;
          case 'transactions': Transactions.renderTable(); break;
          case 'members': Members.renderTable(); break;
          case 'activities': Activities.renderGrid(); break;
          case 'announcements': Announcements.render(); break;
          case 'forms': Forms.render(); break;
          case 'analytics': Analytics.refresh(); break;
          case 'reports': Reports.initDateOnce(); break;
        }
        
        if(window.innerWidth<992) this.toggleSidebar(false);
      },
      
      toggleSidebar(force) {
        const sb = document.getElementById('sidebar');
        if(typeof force === 'boolean') {
          sb.classList.toggle('show', force);
        } else {
          sb.classList.toggle('show');
        }
      }
    };

    /* -------------------- Dashboard -------------------- */
    const Dashboard = {
      refresh() {
        const tx = Store.data.transactions;
        const members = Store.data.members;
        const accounts = Store.data.accounts;
        const today = new Date();
        const monthStr = today.getFullYear()+'-'+Util.pad(today.getMonth()+1);

        let totalIncome=0, totalExpense=0, monthIncome=0, monthExpense=0;
        tx.forEach(t => {
          const amt = Util.toNumber(t.amount);
          if(t.type==='收入') { 
            totalIncome += amt; 
            if(t.date.startsWith(monthStr)) monthIncome += amt; 
          } else { 
            totalExpense += amt; 
            if(t.date.startsWith(monthStr)) monthExpense += amt; 
          }
        });

        // 帳戶餘額計算
        Accounts.recalcBalances();
        const totalBalance = accounts.reduce((s,a) => s + a.currentBalance, 0);

        // 會員統計
        const overdue = members.filter(m => Members.isOverdue(m)).length;

        document.getElementById('dashTotalIncome').textContent = '$'+Util.fmtNum(totalIncome);
        document.getElementById('dashTotalExpense').textContent = '$'+Util.fmtNum(totalExpense);
        document.getElementById('dashMonthIncome').textContent = '$'+Util.fmtNum(monthIncome);
        document.getElementById('dashMonthExpense').textContent = '$'+Util.fmtNum(monthExpense);
        document.getElementById('dashTotalBalance').textContent = '$'+Util.fmtNum(totalBalance);
        document.getElementById('dashAccountCount').textContent = accounts.length;
        document.getElementById('dashMemberTotal').textContent = members.length;
        document.getElementById('dashMemberOverdue').textContent = overdue;

        this.renderAccounts();
        this.recentTransactions();
        this.recentMembers();
        this.recentActivities();
      },
      
      renderAccounts() {
        const container = document.getElementById('dashboardAccountBalances');
        if(!container) return;
        const accounts = Store.data.accounts;
        if(!accounts.length) {
          container.innerHTML='<div class="col-12 text-muted">尚無帳戶</div>'; 
          return;
        }
        container.innerHTML = accounts.map(a => `
          <div class="col-6 col-md-3">
            <div class="border rounded p-2 h-100 small bg-white">
              <div class="d-flex justify-content-between">
                <span class="fw-semibold">${a.name}</span>
                <span class="badge ${a.active?'bg-success':'bg-secondary'}">${a.active?'啟用':'停用'}</span>
              </div>
              <div class="mt-1">
                <span class="text-muted">餘額：</span>
                <span class="${a.currentBalance>=0?'text-success':'text-danger'} fw-semibold">$${Util.fmtNum(a.currentBalance)}</span>
              </div>
            </div>
          </div>
        `).join('');
      },
      
      recentTransactions() {
        const box = document.getElementById('dashboardRecentTx');
        const tx = [...Store.data.transactions].sort((a,b) => b.date.localeCompare(a.date)).slice(0,6);
        if(!tx.length) {
          box.innerHTML='<div class="text-center text-muted py-4"><i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易</div>';
          return;
        }
        box.innerHTML = tx.map(t => `
          <div class="d-flex justify-content-between align-items-center border-bottom py-2 small">
            <div>
              <div class="fw-semibold">${t.category}</div>
              <div class="text-muted">${t.date} ${t.counterparty||''}</div>
            </div>
            <div class="text-end">
              <span class="badge ${t.type==='收入'?'bg-success':'bg-danger'}">${t.type==='收入'?'+':'-'}$${Util.fmtNum(t.amount)}</span>
            </div>
          </div>
        `).join('');
      },
      
      recentMembers() {
        const box = document.getElementById('dashboardRecentMembers');
        const arr = [...Store.data.members].sort((a,b) => b.joinDate.localeCompare(a.joinDate)).slice(0,6);
        if(!arr.length) {
          box.innerHTML='<div class="text-center text-muted py-4"><i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員</div>';
          return;
        }
        box.innerHTML = arr.map(m => `
          <div class="d-flex align-items-center border-bottom py-2 small">
            <div class="member-avatar me-2"><i class="bi bi-person"></i></div>
            <div class="flex-grow-1">
              <div class="fw-semibold">${m.name}</div>
              <div class="text-muted">${m.joinDate}</div>
            </div>
            <span class="badge ${Members.badgeClass(m.status)}">${Members.statusText(m.status)}</span>
          </div>
        `).join('');
      },
      
      recentActivities() {
        const box = document.getElementById('dashboardRecentActivities');
        const arr = [...Store.data.activities].sort((a,b) => b.createdAt.localeCompare(a.createdAt)).slice(0,6);
        if(!arr.length) {
          box.innerHTML='<div class="text-center text-muted py-4"><i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動</div>';
          return;
        }
        box.innerHTML = arr.map(a => `
          <div class="d-flex align-items-center border-bottom py-2 small">
            <div class="me-2 text-info"><i class="bi bi-calendar-event"></i></div>
            <div class="flex-grow-1">
              <div class="fw-semibold">${a.name}</div>
              <div class="text-muted">${a.date}</div>
            </div>
            <span class="badge ${Activities.statusBadge(a.status)}">${Activities.statusText(a.status)}</span>
          </div>
        `).join('');
      }
    };

    /* -------------------- 交易模組 -------------------- */
    const Transactions = {
      state: { page: 1, per: 10, filtered: [] },
      
      filter() {
        const year = document.getElementById('txFilterYear').value;
        const month = document.getElementById('txFilterMonth').value;
        const type = document.getElementById('txFilterType').value;
        const kw = document.getElementById('txFilterKeyword').value.trim().toLowerCase();
        
        this.state.filtered = Store.data.transactions.filter(t => {
          const d = t.date || '';
          if(year && !d.startsWith(year+'-')) return false;
          if(month && !(d.slice(5,7) === Util.pad(month))) return false;
          if(type && t.type !== type) return false;
          if(kw) {
            const text = (t.category+' '+(t.counterparty||'')+' '+(t.description||'')+' '+(t.receiptNumber||'')+' '+(t.voucherNumber||'')).toLowerCase();
            if(!text.includes(kw)) return false;
          }
          return true;
        }).sort((a,b) => b.date.localeCompare(a.date) || b.createdAt.localeCompare(a.createdAt));
      },
      
      renderTable() {
        this.filter();
        const total = this.state.filtered.length;
        const per = this.state.per;
        const pages = Math.max(1, Math.ceil(total/per));
        if(this.state.page > pages) this.state.page = pages;
        const start = (this.state.page-1) * per;
        const rows = this.state.filtered.slice(start, start+per);
        
        document.getElementById('txRecordCount').textContent = `${total} 筆記錄`;
        
        const tb = document.getElementById('txTableBody');
        if(!rows.length) {
          tb.innerHTML = `<tr><td colspan="10" class="text-center text-muted py-5">
            <i class="bi bi-inbox display-6 d-block mb-2"></i> 無符合資料
          </td></tr>`;
        } else {
          tb.innerHTML = rows.map(t => {
            const num = t.type==='收入' ? (t.receiptNumber||'-') : (t.voucherNumber||'-');
            return `<tr>
              <td><input type="checkbox" data-id="${t.id}" class="tx-check"></td>
              <td>${t.date}</td>
              <td><span class="badge ${t.type==='收入'?'bg-success':'bg-danger'}">${t.type}</span></td>
              <td>${t.category}</td>
              <td class="text-end fw-semibold ${t.type==='收入'?'text-success':'text-danger'}">${t.type==='收入'?'+':'-'}$${Util.fmtNum(t.amount)}</td>
              <td>${t.counterparty||'-'}</td>
              <td>${t.account||'-'}</td>
              <td class="small">${t.description||'-'}</td>
              <td class="small">${num} ${t.vouchers?.length?'<i class="bi bi-paperclip text-primary"></i>':''}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-sm btn-outline-primary" title="編輯" onclick="TransactionUI.open('${t.id}')"><i class="bi bi-pencil"></i></button>
                  ${
                    t.type==='收入'
                      ? `<button class="btn btn-sm btn-outline-info" title="收據" onclick="Print.receipt('${t.id}')"><i class="bi bi-printer"></i></button>`
                      : `<button class="btn btn-sm btn-outline-warning" title="憑證" onclick="Print.voucher('${t.id}')"><i class="bi bi-receipt-cutoff"></i></button>`
                  }
                  <button class="btn btn-sm btn-outline-danger" title="刪除" onclick="Transactions.delete('${t.id}')"><i class="bi bi-trash"></i></button>
                </div>
              </td>
            </tr>`;
          }).join('');
        }
        
        this.renderPagination(pages);
        Counterparty.refreshDatalist();
      },
      
      renderPagination(pages) {
        const ul = document.getElementById('txPagination');
        let html = '';
        const p = this.state.page;
        const add = (pg, txt, dis=false, act=false) => html += `<li class="page-item ${dis?'disabled':''} ${act?'active':''}">
          <a href="#" class="page-link" onclick="Transactions.goto(${pg});return false;">${txt}</a></li>`;
        add(p-1, '«', p===1);
        for(let i=Math.max(1,p-2); i<=Math.min(pages,p+2); i++) add(i, i, false, i===p);
        add(p+1, '»', p===pages);
        ul.innerHTML = html;
      },
      
      goto(p) { 
        this.state.page = p; 
        this.renderTable(); 
      },
      
      toggleSelectAll(master) {
        document.querySelectorAll('.tx-check').forEach(cb => cb.checked = master.checked);
      },
      
      getSelectedIds() {
        return [...document.querySelectorAll('.tx-check:checked')].map(cb => cb.getAttribute('data-id'));
      },
      
      async batchAction() {
        const act = document.getElementById('txBatchAction').value;
        const ids = this.getSelectedIds();
        if(!act) return Util.showToast('error', '請選擇批次操作');
        if(!ids.length) return Util.showToast('error', '尚未勾選');
        
        if(act === 'delete') {
          const result = await Util.confirm({title:'刪除確認', text:`確定刪除 ${ids.length} 筆交易?`, confirmColor:'#dc3545'});
          if(result.isConfirmed) {
            Store.data.transactions = Store.data.transactions.filter(t => !ids.includes(t.id));
            await Store.save('transactions');
            Dashboard.refresh(); 
            this.renderTable();
            Util.showToast('success', '已刪除');
          }
        } else if(act === 'export') {
          DataPort.exportTransactions(ids);
        } else if(act === 'print') {
          Print.batchReceipts(ids);
        } else if(act === 'voucher') {
          Print.batchVouchers(ids);
        } else {
          Util.showToast('error', '尚未實作');
        }
      },
      
      async delete(id) {
        const result = await Util.confirm({title:'刪除交易', text:'是否刪除此筆交易？', confirmColor:'#dc3545'});
        if(!result.isConfirmed) return;
        
        Store.data.transactions = Store.data.transactions.filter(t => t.id !== id);
        await Store.save('transactions');
        Dashboard.refresh(); 
        this.renderTable();
        Util.showToast('success', '已刪除交易');
      }
    };

    /* 交易 UI 控制 */
    const TransactionUI = {
      modal: null,
      
      open(id = null) {
        if(!this.modal) this.modal = new bootstrap.Modal(document.getElementById('transactionModal'));
        
        document.getElementById('txForm').reset();
        document.getElementById('txId').value = '';
        document.getElementById('txVoucherPreview').innerHTML = '';
        this.fillAccounts();
        this.fillCategories('收入'); // 預設
        document.getElementById('txDate').value = Util.today();
        document.getElementById('txType').value = '收入';
        document.getElementById('txNumberLabel').textContent = '收據編號';
        document.getElementById('txNumber').value = Numbering.receipt();

        if(id) {
          const t = Store.data.transactions.find(x => x.id === id);
          if(t) {
            document.getElementById('txModalTitle').textContent = '編輯交易';
            document.getElementById('txId').value = t.id;
            document.getElementById('txDate').value = t.date;
            document.getElementById('txType').value = t.type;
            this.fillCategories(t.type);
            document.getElementById('txCategory').value = t.category;
            document.getElementById('txAmount').value = t.amount;
            document.getElementById('txCounterparty').value = t.counterparty || '';
            document.getElementById('txAccount').value = t.account || '';
            document.getElementById('txDescription').value = t.description || '';
            
            if(t.type === '收入') {
              document.getElementById('txNumberLabel').textContent = '收據編號';
              document.getElementById('txNumber').value = t.receiptNumber || '';
            } else {
              document.getElementById('txNumberLabel').textContent = '憑證編號';
              document.getElementById('txNumber').value = t.voucherNumber || '';
            }
            
            if(t.vouchers?.length) {
              this.renderVoucherPreview(t.vouchers);
            }
          }
        } else {
          document.getElementById('txModalTitle').textContent = '新增交易';
        }
        
        this.modal.show();
      },
      
      onTypeChange() {
        const type = document.getElementById('txType').value;
        this.fillCategories(type);
        const lbl = document.getElementById('txNumberLabel');
        if(type === '支出') { 
          lbl.textContent = '憑證編號'; 
          document.getElementById('txNumber').value = Numbering.voucher(); 
        } else { 
          lbl.textContent = '收據編號'; 
          document.getElementById('txNumber').value = Numbering.receipt(); 
        }
      },
      
      fillCategories(type) {
        const sel = document.getElementById('txCategory');
        sel.innerHTML = '<option value="">選擇類別</option>';
        const cats = Store.data.settings.categories[type] || [];
        cats.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c; 
          opt.textContent = c;
          sel.appendChild(opt);
        });
      },
      
      fillAccounts() {
        const sel = document.getElementById('txAccount');
        sel.innerHTML = '';
        Store.data.accounts.filter(a => a.active).forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.name; 
          opt.textContent = a.name;
          sel.appendChild(opt);
        });
        if(!sel.value && sel.options.length) sel.selectedIndex = 0;
      },
      
      handleVoucherUpload(e) {
        const files = [...e.target.files];
        const container = document.getElementById('txVoucherPreview');
        container.innerHTML = '';
        
        files.forEach(f => {
          if(f.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = ev => {
              const img = document.createElement('img');
              img.src = ev.target.result;
              img.title = f.name;
              img.onclick = () => Swal.fire({imageUrl: ev.target.result, showConfirmButton: false});
              container.appendChild(img);
            };
            reader.readAsDataURL(f);
          } else if(f.type === 'application/pdf') {
            const div = document.createElement('div');
            div.className = 'border rounded small p-2 d-inline-flex flex-column align-items-center justify-content-center';
            div.style.width = '90px'; 
            div.style.height = '90px';
            div.innerHTML = '<i class="bi bi-file-earmark-pdf text-danger" style="font-size:32px;"></i><div class="small text-truncate" style="max-width:80px">'+f.name+'</div>';
            container.appendChild(div);
          }
        });
      },
      
      renderVoucherPreview(vouchers) {
        const container = document.getElementById('txVoucherPreview');
        container.innerHTML = '';
        
        vouchers.forEach(v => {
          if(v.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = v.data;
            img.title = v.name;
            img.onclick = () => Swal.fire({imageUrl: v.data, showConfirmButton: false});
            container.appendChild(img);
          } else if(v.type === 'application/pdf') {
            const div = document.createElement('div');
            div.className = 'border rounded small p-2 d-inline-flex flex-column align-items-center justify-content-center';
            div.style.width = '90px'; 
            div.style.height = '90px';
            div.innerHTML = '<i class="bi bi-file-earmark-pdf text-danger" style="font-size:32px;"></i><div class="small text-truncate" style="max-width:80px">'+v.name+'</div>';
            container.appendChild(div);
          }
        });
      },
      
      async save() {
        const form = document.getElementById('txForm');
        if(!form.checkValidity()) { 
          form.reportValidity(); 
          return; 
        }
        
        const id = document.getElementById('txId').value;
        const type = document.getElementById('txType').value;
        
        const t = {
          id: id || Util.uuid(),
          date: document.getElementById('txDate').value,
          type,
          category: document.getElementById('txCategory').value,
          amount: Util.toNumber(document.getElementById('txAmount').value),
          counterparty: document.getElementById('txCounterparty').value.trim(),
          account: document.getElementById('txAccount').value,
          description: document.getElementById('txDescription').value.trim(),
          vouchers: [],
          createdAt: id ? (Store.data.transactions.find(x => x.id === id)?.createdAt || new Date().toISOString()) : new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        const customNumber = document.getElementById('txNumber').value.trim();
        if(type === '收入') {
          t.receiptNumber = customNumber || Numbering.receipt();
        } else {
          t.voucherNumber = customNumber || Numbering.voucher();
        }
        
        // 附件處理
        const fInput = document.getElementById('txVouchers');
        if(fInput.files.length) {
          let remain = fInput.files.length;
          const all = [];
          const done = async () => {
            t.vouchers = all;
            await this._finalSave(t, id);
          };
          
          [...fInput.files].forEach(f => {
            const reader = new FileReader();
            reader.onload = ev => {
              all.push({name: f.name, type: f.type, data: ev.target.result});
              if(--remain === 0) done();
            };
            reader.readAsDataURL(f);
          });
        } else {
          // 如果是編輯保留舊附件
          if(id) {
            const old = Store.data.transactions.find(x => x.id === id);
            if(old?.vouchers?.length) t.vouchers = old.vouchers;
          }
          await this._finalSave(t, id);
        }
      },
      
      async _finalSave(t, isEdit) {
        try {
          if(isEdit) {
            const idx = Store.data.transactions.findIndex(x => x.id === t.id);
            if(idx > -1) Store.data.transactions[idx] = t;
          } else {
            Store.data.transactions.push(t);
          }
          
          await Store.save('transactions');
          Dashboard.refresh();
          Transactions.renderTable();
          this.modal.hide();
          Util.showToast('success', isEdit ? '交易已更新' : '交易已新增');
        } catch (error) {
          Util.showToast('error', '儲存失敗: ' + error.message);
        }
      }
    };

    /* 對象自動完成 */
    const Counterparty = {
      refreshDatalist() {
        const set = new Set();
        Store.data.transactions.forEach(t => { 
          if(t.counterparty) set.add(t.counterparty); 
        });
        const dl = document.getElementById('counterpartyDatalist');
        if(dl) dl.innerHTML = [...set].map(v => `<option value="${v}">`).join('');
      }
    };

    /* -------------------- 會員模組 -------------------- */
    const Members = {
      state: {page: 1, per: 10, filtered: []},
      
      statusText: s => s==='active'?'正常':s==='inactive'?'停權':s==='pending'?'待審核':'—',
      badgeClass: s => s==='active'?'bg-success':s==='inactive'?'bg-danger':s==='pending'?'bg-warning text-dark':'bg-secondary',
      typeText: t => ({regular:'一般會員',honorary:'榮譽會員',life:'終身會員',family:'家屬會員'})[t]||'其他',
      
      isOverdue(m) {
        if(!m.lastPaymentDate) return true;
        const last = new Date(m.lastPaymentDate);
        const cmp = new Date(); 
        cmp.setFullYear(cmp.getFullYear()-1);
        return last < cmp;
      },
      
      filter() {
        const st = document.getElementById('memberFilterStatus').value;
        const tp = document.getElementById('memberFilterType').value;
        const kw = (document.getElementById('memberFilterKeyword').value||'').toLowerCase();
        
        this.state.filtered = Store.data.members.filter(m => {
          if(st && m.status !== st) return false;
          if(tp && m.type !== tp) return false;
          if(kw) {
            const txt = (m.name+' '+m.phone+' '+(m.email||'')+' '+(m.tags||[]).join(' ')).toLowerCase();
            if(!txt.includes(kw)) return false;
          }
          return true;
        }).sort((a,b) => b.joinDate.localeCompare(a.joinDate));
      },
      
      renderTable() {
        this.filter();
        const members = this.state.filtered;
        
        // 統計
        document.getElementById('mStatTotal').textContent = Store.data.members.length;
        document.getElementById('mStatActive').textContent = Store.data.members.filter(m => m.status==='active').length;
        const overdue = Store.data.members.filter(m => this.isOverdue(m)).length;
        document.getElementById('mStatOverdue').textContent = overdue;
        const monthStr = new Date().toISOString().slice(0,7);
        document.getElementById('mStatNew').textContent = Store.data.members.filter(m => m.joinDate.startsWith(monthStr)).length;

        const per = this.state.per;
        const pages = Math.max(1, Math.ceil(members.length/per));
        if(this.state.page > pages) this.state.page = pages;
        const start = (this.state.page-1) * per;
        const rows = members.slice(start, start+per);
        
        document.getElementById('memberRecordCount').textContent = `${members.length} 筆記錄`;
        
        const tb = document.getElementById('memberTableBody');
        if(!rows.length) {
          tb.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-5">
            <i class="bi bi-people display-6 d-block mb-2"></i> 無符合會員
          </td></tr>`;
        } else {
          tb.innerHTML = rows.map(m => {
            const age = Util.age(m.birthDate);
            const overdue = this.isOverdue(m);
            return `<tr>
              <td><input type="checkbox" class="member-check" data-id="${m.id}"></td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="member-avatar me-2">${m.name.charAt(0)}</div>
                  <div>
                    <div class="fw-semibold">${m.name}</div>
                    <div class="text-muted small">${m.id.slice(0,8)}</div>
                  </div>
                </div>
              </td>
              <td class="small">
                <div><i class="bi bi-telephone me-1"></i>${m.phone}</div>
                ${m.email?`<div class="text-truncate"><i class="bi bi-envelope me-1"></i>${m.email}</div>`:''}
              </td>
              <td>${age?age+'歲':''}${m.gender?' / '+m.gender:''}</td>
              <td>${m.joinDate}</td>
              <td><span class="badge ${this.badgeClass(m.status)}">${this.statusText(m.status)}</span></td>
              <td>
                <span class="badge ${overdue?'bg-danger':'bg-success'}">${overdue?'逾期':'已繳'}</span>
                ${m.lastPaymentDate?`<div class="small text-muted">${m.lastPaymentDate}</div>`:''}
              </td>
              <td class="small">
                ${(m.tags||[]).map(t=>`<span class="badge bg-secondary me-1">${t}</span>`).join('')||'-'}
              </td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-sm btn-outline-info" title="詳情" onclick="Members.detail('${m.id}')"><i class="bi bi-eye"></i></button>
                  <button class="btn btn-sm btn-outline-primary" title="編輯" onclick="MemberUI.open('${m.id}')"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-sm btn-outline-success" title="繳費" onclick="Members.recordFee('${m.id}')"><i class="bi bi-credit-card"></i></button>
                  <button class="btn btn-sm btn-outline-danger" title="刪除" onclick="Members.delete('${m.id}')"><i class="bi bi-trash"></i></button>
                </div>
              </td>
            </tr>`;
          }).join('');
        }
        
        // 分頁
        const ul = document.getElementById('memberPagination');
        let html = '', p = this.state.page;
        const add = (pg, txt, dis=false, act=false) => html += `<li class="page-item ${dis?'disabled':''} ${act?'active':''}">
          <a href="#" class="page-link" onclick="Members.goto(${pg});return false;">${txt}</a></li>`;
        add(p-1, '«', p===1);
        for(let i=Math.max(1,p-2); i<=Math.min(pages,p+2); i++) add(i, i, false, i===p);
        add(p+1, '»', p===pages);
        ul.innerHTML = html;
      },
      
      goto(p) { 
        this.state.page = p; 
        this.renderTable(); 
      },
      
      toggleSelectAll(master) {
        document.querySelectorAll('.member-check').forEach(cb => cb.checked = master.checked);
      },
      
      getSelected() { 
        return [...document.querySelectorAll('.member-check:checked')].map(cb => cb.getAttribute('data-id')); 
      },
      
      async batchAction() {
        const act = document.getElementById('memberBatchAction').value;
        const ids = this.getSelected();
        if(!act) return Util.showToast('error', '未選動作');
        if(!ids.length) return Util.showToast('error', '未勾選');
        
        if(act === 'delete') {
          const result = await Util.confirm({title:'刪除會員', text:`確定刪除 ${ids.length} 位會員？`, confirmColor:'#dc3545'});
          if(!result.isConfirmed) return;
          
          Store.data.members = Store.data.members.filter(m => !ids.includes(m.id));
          Store.data.registrations = Store.data.registrations.filter(r => !ids.includes(r.memberId));
          await Store.save();
          this.renderTable(); 
          Dashboard.refresh();
          Util.showToast('success', '已刪除會員');
        } else if(act === 'export') {
          DataPort.exportMembers(ids);
        } else if(act.startsWith('status-')) {
          const newStatus = act.split('-')[1];
          Store.data.members.forEach(m => { 
            if(ids.includes(m.id)) m.status = newStatus; 
          });
          await Store.save('members'); 
          this.renderTable(); 
          Util.showToast('success', '狀態已更新');
        } else {
          Util.showToast('error', '尚未實作');
        }
      },
      
      detail(id) {
        const m = Store.data.members.find(x => x.id === id);
        if(!m) return;
        
        const modal = new bootstrap.Modal(document.getElementById('memberDetailModal'));
        const tx = Store.data.transactions.filter(t => t.counterparty && t.counterparty.includes(m.name));
        const totalFee = tx.filter(t => t.type==='收入' && t.category==='會費').reduce((s,t) => s+Util.toNumber(t.amount), 0);
        const age = Util.age(m.birthDate);
        const overdue = this.isOverdue(m);
        
        document.getElementById('memberDetailContent').innerHTML = `
          <div class="row g-3">
            <div class="col-lg-6">
              <div class="border rounded p-3 h-100">
                <h6 class="fw-semibold mb-2"><i class="bi bi-person-badge me-1"></i>基本資料</h6>
                <div class="row small">
                  <div class="col-4 text-muted">姓名</div><div class="col-8 fw-semibold">${m.name}</div>
                  <div class="col-4 text-muted">電話</div><div class="col-8">${m.phone}</div>
                  <div class="col-4 text-muted">Email</div><div class="col-8">${m.email||'—'}</div>
                  <div class="col-4 text-muted">出生</div><div class="col-8">${m.birthDate||'—'} ${age?`(${age}歲)`:''}</div>
                  <div class="col-4 text-muted">性別</div><div class="col-8">${m.gender||'—'}</div>
                  <div class="col-4 text-muted">身分證</div><div class="col-8">${m.idNumber||'—'}</div>
                  <div class="col-4 text-muted">地址</div><div class="col-8">${m.address||'—'}</div>
                  <div class="col-4 text-muted">緊急聯絡</div><div class="col-8">${m.emergencyContact||'—'} ${m.emergencyPhone? '('+m.emergencyPhone+')':''}</div>
                </div>
                <h6 class="fw-semibold mt-3 mb-2"><i class="bi bi-card-checklist me-1"></i>會員資訊</h6>
                <div class="row small">
                  <div class="col-4 text-muted">加入日期</div><div class="col-8">${m.joinDate}</div>
                  <div class="col-4 text-muted">狀態</div><div class="col-8"><span class="badge ${this.badgeClass(m.status)}">${this.statusText(m.status)}</span></div>
                  <div class="col-4 text-muted">類型</div><div class="col-8">${this.typeText(m.type)}</div>
                  <div class="col-4 text-muted">年費</div><div class="col-8">$${Util.fmtNum(m.membershipFee||0)}</div>
                  <div class="col-4 text-muted">最後繳費</div><div class="col-8">${m.lastPaymentDate||'—'} ${overdue?'<span class="badge bg-danger">逾期</span>':'<span class="badge bg-success">正常</span>'}</div>
                  <div class="col-4 text-muted">累計會費</div><div class="col-8 text-success fw-semibold">$${Util.fmtNum(totalFee)}</div>
                  <div class="col-4 text-muted">標籤</div><div class="col-8">${(m.tags||[]).map(t=>`<span class="badge bg-secondary me-1">${t}</span>`).join('')||'—'}</div>
                </div>
                ${m.notes?`<div class="mt-3"><div class="small text-muted">備註</div><div class="alert alert-info py-2 small mb-0">${m.notes}</div></div>`:''}
              </div>
            </div>
            <div class="col-lg-6">
              <div class="border rounded p-3 h-100">
                <h6 class="fw-semibold mb-2"><i class="bi bi-clock-history me-1"></i>相關交易 (${tx.length} 筆)</h6>
                <div class="table-responsive" style="max-height:350px;overflow:auto;">
                  <table class="table table-sm">
                    <thead>
                      <tr><th>日期</th><th>類型</th><th>類別</th><th class="text-end">金額</th><th>說明</th><th>編號</th></tr>
                    </thead>
                    <tbody>
                      ${tx.map(t=>`
                        <tr>
                          <td>${t.date}</td>
                          <td><span class="badge ${t.type==='收入'?'bg-success':'bg-danger'}">${t.type}</span></td>
                          <td>${t.category}</td>
                          <td class="text-end ${t.type==='收入'?'text-success':'text-danger'}">${t.type==='收入'?'+':'-'}$${Util.fmtNum(t.amount)}</td>
                          <td class="small">${t.description||''}</td>
                          <td class="small">${t.receiptNumber||t.voucherNumber||''}</td>
                        </tr>`).join('')}
                      ${tx.length===0?'<tr><td colspan="6" class="text-center text-muted py-3">無交易</td></tr>':''}
                    </tbody>
                  </table>
                </div>
                <div class="mt-3">
                  <h6 class="fw-semibold mb-2"><i class="bi bi-activity me-1"></i>活動報名</h6>
                  <div id="memberActivityRegistrations" class="small text-muted">載入中...</div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        modal.show();
        
        // 填寫活動報名紀錄
        setTimeout(() => {
          const regBox = document.getElementById('memberActivityRegistrations');
          const regs = Store.data.registrations.filter(r => r.memberId === m.id);
          if(!regs.length) { 
            regBox.innerHTML = '無報名紀錄'; 
            return; 
          }
          regBox.innerHTML = '<ul class="list-unstyled mb-0">' + regs.slice(0,20).map(r => {
            const act = Store.data.activities.find(a => a.id === r.activityId);
            return `<li class="mb-1"><i class="bi bi-check2-circle text-success me-1"></i>${act?act.name:'(活動已刪除)'} <span class="text-muted">[${r.registrationDate}]</span></li>`;
          }).join('') + (regs.length>20?'<li class="text-muted">...更多</li>':'') + '</ul>';
        }, 50);
      },
      
      async delete(id) {
        const result = await Util.confirm({title:'刪除會員', text:'此動作同時刪除相關報名資料，確定？', confirmColor:'#dc3545'});
        if(!result.isConfirmed) return;
        
        Store.data.members = Store.data.members.filter(m => m.id !== id);
        Store.data.registrations = Store.data.registrations.filter(r => r.memberId !== id);
        await Store.save();
        this.renderTable(); 
        Dashboard.refresh();
        Util.showToast('success', '已刪除會員');
      },
      
      async recordFee(id) {
        const member = id ? Store.data.members.find(m => m.id === id) : null;
        if(!member) {
          const sel = this.getSelected();
          if(sel.length !== 1) { 
            Util.showToast('error', '請勾選單一會員或在詳情內操作'); 
            return; 
          }
          return this.recordFee(sel[0]);
        }
        
        const result = await Swal.fire({
          title: '紀錄會費',
          html: `
            <div class="text-start">
              <div class="mb-2">會員：<strong>${member.name}</strong></div>
              <label class="form-label">日期</label>
              <input id="feeDate" type="date" class="form-control" value="${Util.today()}">
              <label class="form-label mt-2">金額</label>
              <input id="feeAmount" type="number" class="form-control" value="${member.membershipFee||Store.data.settings.defaultMembershipFee||1000}">
              <label class="form-label mt-2">備註</label>
              <textarea id="feeNote" rows="2" class="form-control"></textarea>
            </div>
          `,
          confirmButtonText: '儲存',
          showCancelButton: true
        });
        
        if(!result.isConfirmed) return;
        
        const date = document.getElementById('feeDate').value;
        const amount = Util.toNumber(document.getElementById('feeAmount').value);
        const note = document.getElementById('feeNote').value.trim();
        
        if(!date || !amount) { 
          Util.showToast('error', '請填寫日期與金額'); 
          return; 
        }
        
        // 新增收入交易
        const tx = {
          id: Util.uuid(),
          date,
          type: '收入',
          category: '會費',
          amount,
          counterparty: member.name,
          account: Store.data.accounts.find(a => a.active)?.name || '現金',
          description: `${member.name} 會費${note? ' - '+note:''}`,
          receiptNumber: Numbering.receipt(),
          vouchers: [],
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        Store.data.transactions.push(tx);
        
        // 更新會員
        member.lastPaymentDate = date;
        member.updatedAt = new Date().toISOString();
        
        await Store.save();
        Transactions.renderTable();
        this.renderTable();
        Dashboard.refresh();
        Util.showToast('success', '已紀錄會費');
      },
      
      printCard() {
        window.print(); // 簡易示意，可自行客製會員卡版型
      }
    };

    /* 會員新增編輯 UI */
    const MemberUI = {
      modal: null,
      
      open(id = null) {
        if(!this.modal) this.modal = new bootstrap.Modal(document.getElementById('memberModal'));
        
        document.getElementById('memberForm').reset();
        document.getElementById('memberId').value = '';
        document.getElementById('memberJoinDate').value = Util.today();
        document.getElementById('membershipFee').value = Store.data.settings.defaultMembershipFee || 1000;
        document.getElementById('memberStatus').value = 'active';
        document.getElementById('memberType').value = 'regular';
        document.getElementById('memberModalTitle').textContent = '新增會員';
        
        if(id) {
          const m = Store.data.members.find(x => x.id === id);
          if(m) {
            document.getElementById('memberModalTitle').textContent = '編輯會員';
            document.getElementById('memberId').value = m.id;
            document.getElementById('memberName').value = m.name;
            document.getElementById('memberPhone').value = m.phone;
            document.getElementById('memberEmail').value = m.email || '';
            document.getElementById('memberBirthDate').value = m.birthDate || '';
            document.getElementById('memberGender').value = m.gender || '';
            document.getElementById('memberIdNumber').value = m.idNumber || '';
            document.getElementById('memberAddress').value = m.address || '';
            document.getElementById('emergencyContact').value = m.emergencyContact || '';
            document.getElementById('emergencyPhone').value = m.emergencyPhone || '';
            document.getElementById('memberNotes').value = m.notes || '';
            document.getElementById('memberJoinDate').value = m.joinDate;
            document.getElementById('memberStatus').value = m.status;
            document.getElementById('memberType').value = m.type;
            document.getElementById('membershipFee').value = m.membershipFee || Store.data.settings.defaultMembershipFee || 1000;
            document.getElementById('lastPaymentDate').value = m.lastPaymentDate || '';
            document.getElementById('memberTags').value = (m.tags || []).join(',');
          }
        }
        
        this.modal.show();
      },
      
      async save() {
        const form = document.getElementById('memberForm');
        if(!form.checkValidity()) { 
          form.reportValidity(); 
          return; 
        }
        
        const id = document.getElementById('memberId').value;
        const m = {
          id: id || Util.uuid(),
          name: document.getElementById('memberName').value.trim(),
          phone: document.getElementById('memberPhone').value.trim(),
          email: document.getElementById('memberEmail').value.trim(),
          birthDate: document.getElementById('memberBirthDate').value,
          gender: document.getElementById('memberGender').value,
          idNumber: document.getElementById('memberIdNumber').value.trim(),
          address: document.getElementById('memberAddress').value.trim(),
          emergencyContact: document.getElementById('emergencyContact').value.trim(),
          emergencyPhone: document.getElementById('emergencyPhone').value.trim(),
          notes: document.getElementById('memberNotes').value.trim(),
          joinDate: document.getElementById('memberJoinDate').value,
          status: document.getElementById('memberStatus').value,
          type: document.getElementById('memberType').value,
          membershipFee: Util.toNumber(document.getElementById('membershipFee').value),
          lastPaymentDate: document.getElementById('lastPaymentDate').value,
          tags: document.getElementById('memberTags').value.split(',').map(t => t.trim()).filter(Boolean),
          createdAt: id ? (Store.data.members.find(x => x.id === id)?.createdAt || new Date().toISOString()) : new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        if(id) {
          const idx = Store.data.members.findIndex(x => x.id === m.id);
          if(idx > -1) Store.data.members[idx] = m;
        } else {
          Store.data.members.push(m);
        }
        
        await Store.save('members'); 
        Members.renderTable(); 
        Dashboard.refresh();
        this.modal.hide();
        Util.showToast('success', id ? '會員已更新' : '會員已新增');
      },
      
      editFromDetail() {
        const id = document.querySelector('#memberDetailContent .fw-semibold')?.textContent;
        if(!id) return;
      }
    };

    /* -------------------- 帳戶模組 -------------------- */
    const Accounts = {
      async ensureDefaults() {
        if(!Store.data.accounts.length) {
          Store.data.accounts.push(
            {
              id: Util.uuid(),
              name: '現金',
              description: '現金往來',
              initialBalance: 0,
              currentBalance: 0,
              active: true,
              notes: '',
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            },
            {
              id: Util.uuid(),
              name: '銀行',
              description: '銀行帳戶',
              initialBalance: 0,
              currentBalance: 0,
              active: true,
              notes: '',
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            }
          );
          await Store.save('accounts');
        }
      },
      
      recalcBalances() {
        Store.data.accounts.forEach(a => {
          let bal = Util.toNumber(a.initialBalance);
          Store.data.transactions.forEach(t => {
            if(t.account === a.name) {
              if(t.type === '收入') bal += Util.toNumber(t.amount);
              else bal -= Util.toNumber(t.amount);
            }
          });
          a.currentBalance = bal;
        });
      }
    };

    /* 帳戶 UI */
    const AccountUI = {
      manager: null, 
      editor: null,
      
      openManager() {
        if(!this.manager) this.manager = new bootstrap.Modal(document.getElementById('accountManagerModal'));
        this.renderTable();
        this.manager.show();
      },
      
      renderTable() {
        Accounts.recalcBalances();
        const tb = document.getElementById('accountTableBody');
        const arr = Store.data.accounts;
        
        if(!arr.length) {
          tb.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">尚無帳戶</td></tr>'; 
          return;
        }
        
        tb.innerHTML = arr.map(a => `
          <tr>
            <td class="fw-semibold">${a.name}</td>
            <td class="small">${a.description||'-'}</td>
            <td class="text-end small">$${Util.fmtNum(a.initialBalance)}</td>
            <td class="text-end fw-semibold ${a.currentBalance>=0?'text-success':'text-danger'}">$${Util.fmtNum(a.currentBalance)}</td>
            <td><span class="badge ${a.active?'bg-success':'bg-secondary'}">${a.active?'啟用':'停用'}</span></td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-outline-primary" title="編輯" onclick="AccountUI.openEditor('${a.id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-${Store.data.transactions.some(t=>t.account===a.name)?'secondary disabled':'danger'}" title="刪除" onclick="AccountUI.delete('${a.id}')"><i class="bi bi-trash"></i></button>
              </div>
            </td>
          </tr>
        `).join('');
      },
      
      openEditor(id = null) {
        if(!this.editor) this.editor = new bootstrap.Modal(document.getElementById('accountEditModal'));
        
        document.getElementById('accountForm').reset();
        document.getElementById('accountId').value = '';
        document.getElementById('accountEditTitle').textContent = '新增帳戶';
        document.getElementById('accountActive').checked = true;
        
        if(id) {
          const a = Store.data.accounts.find(x => x.id === id);
          if(a) {
            document.getElementById('accountEditTitle').textContent = '編輯帳戶';
            document.getElementById('accountId').value = a.id;
            document.getElementById('accountName').value = a.name;
            document.getElementById('accountDesc').value = a.description || '';
            document.getElementById('accountInitial').value = a.initialBalance || 0;
            document.getElementById('accountNotes').value = a.notes || '';
            document.getElementById('accountActive').checked = !!a.active;
          }
        }
        
        this.editor.show();
      },
      
      async save() {
        const id = document.getElementById('accountId').value;
        const name = document.getElementById('accountName').value.trim();
        
        if(!name) return Util.showToast('error', '請輸入帳戶名稱');
        
        // 不允許同名（編輯除外）
        if(Store.data.accounts.some(a => a.name === name && a.id !== id)) {
          return Util.showToast('error', '已有相同名稱帳戶');
        }
        
        const acc = {
          id: id || Util.uuid(),
          name,
          description: document.getElementById('accountDesc').value.trim(),
          initialBalance: Util.toNumber(document.getElementById('accountInitial').value),
          currentBalance: 0, // 會重新計算
          notes: document.getElementById('accountNotes').value.trim(),
          active: document.getElementById('accountActive').checked,
          createdAt: id ? (Store.data.accounts.find(x => x.id === id)?.createdAt || new Date().toISOString()) : new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        if(id) {
          const idx = Store.data.accounts.findIndex(x => x.id === acc.id);
          if(idx > -1) Store.data.accounts[idx] = acc;
        } else {
          Store.data.accounts.push(acc);
        }
        
        await Store.save('accounts');
        this.renderTable();
        Dashboard.refresh();
        this.editor.hide();
        Util.showToast('success', id ? '帳戶已更新' : '帳戶已新增');
      },
      
      async delete(id) {
        const acc = Store.data.accounts.find(a => a.id === id);
        if(!acc) return;
        
        // 檢查是否有交易使用此帳戶
        if(Store.data.transactions.some(t => t.account === acc.name)) {
          return Util.showToast('error', '此帳戶有交易記錄，無法刪除');
        }
        
        const result = await Util.confirm({title:'刪除帳戶', text:`確定刪除帳戶「${acc.name}」？`, confirmColor:'#dc3545'});
        if(!result.isConfirmed) return;
        
        Store.data.accounts = Store.data.accounts.filter(a => a.id !== id);
        await Store.save('accounts');
        this.renderTable();
        Dashboard.refresh();
        Util.showToast('success', '已刪除帳戶');
      }
    };

    /* -------------------- 活動模組 -------------------- */
    const Activities = {
      statusText: s => ({planning:'規劃中',registration:'報名中',ongoing:'進行中',completed:'已結束',cancelled:'已取消'})[s]||'未知',
      statusBadge: s => ({planning:'bg-secondary',registration:'bg-primary',ongoing:'bg-success',completed:'bg-info',cancelled:'bg-danger'})[s]||'bg-secondary',
      
      renderGrid() {
        const container = document.getElementById('activitiesGrid');
        const acts = [...Store.data.activities].sort((a,b) => b.createdAt.localeCompare(a.createdAt));
        
        // 統計
        document.getElementById('actStatTotal').textContent = acts.length;
        document.getElementById('actStatRegistration').textContent = acts.filter(a => a.status==='registration').length;
        document.getElementById('actStatOngoing').textContent = acts.filter(a => a.status==='ongoing').length;
        document.getElementById('actStatCompleted').textContent = acts.filter(a => a.status==='completed').length;
        
        if(!acts.length) {
          container.innerHTML = `<div class="col-12 text-center text-muted py-5">
            <i class="bi bi-calendar-event display-1 d-block mb-3"></i>
            <h5>尚無活動</h5>
            <p>點擊「新增活動」開始建立第一個活動</p>
          </div>`;
          return;
        }
        
        container.innerHTML = acts.map(a => {
          const regs = Store.data.registrations.filter(r => r.activityId === a.id);
          const progress = a.maxParticipants > 0 ? Math.round((regs.length / a.maxParticipants) * 100) : 0;
          
          return `
            <div class="col-lg-4 col-md-6 mb-3">
              <div class="activity-card card h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-0 fw-semibold">${a.name}</h6>
                    <span class="badge ${this.statusBadge(a.status)}">${this.statusText(a.status)}</span>
                  </div>
                  <div class="small text-muted mb-2">
                    <div><i class="bi bi-calendar me-1"></i>${a.date} ${a.time||''}</div>
                    <div><i class="bi bi-geo-alt me-1"></i>${a.location||'待定'}</div>
                    ${a.fee ? `<div><i class="bi bi-currency-dollar me-1"></i>費用 $${Util.fmtNum(a.fee)}</div>` : ''}
                  </div>
                  <p class="card-text small text-muted">${(a.description||'').slice(0,80)}${a.description?.length>80?'...':''}</p>
                  
                  <div class="mb-2">
                    <div class="d-flex justify-content-between small">
                      <span>報名人數</span>
                      <span>${regs.length}${a.maxParticipants>0?` / ${a.maxParticipants}`:''}</span>
                    </div>
                    ${a.maxParticipants>0 ? `
                      <div class="progress">
                        <div class="progress-bar ${progress>=100?'bg-warning':'bg-success'}" style="width:${Math.min(progress,100)}%"></div>
                      </div>
                    ` : ''}
                  </div>
                  
                  <div class="d-flex gap-1">
                    <button class="btn btn-sm btn-outline-info flex-fill" onclick="Activities.detail('${a.id}')">
                      <i class="bi bi-eye"></i> 詳情
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="ActivityUI.open('${a.id}')">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="Activities.manageRegistrations('${a.id}')">
                      <i class="bi bi-people"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="Activities.delete('${a.id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      },
      
      detail(id) {
        const a = Store.data.activities.find(x => x.id === id);
        if(!a) return;
        
        const modal = new bootstrap.Modal(document.getElementById('activityDetailModal'));
        const regs = Store.data.registrations.filter(r => r.activityId === a.id);
        const totalFee = regs.reduce((s,r) => s + Util.toNumber(r.fee), 0);
        
        document.getElementById('activityDetailContent').innerHTML = `
          <div class="row g-3">
            <div class="col-lg-6">
              <div class="border rounded p-3 h-100">
                <h6 class="fw-semibold mb-3"><i class="bi bi-info-circle me-1"></i>活動資訊</h6>
                <div class="row small">
                  <div class="col-4 text-muted">活動名稱</div><div class="col-8 fw-semibold">${a.name}</div>
                  <div class="col-4 text-muted">日期時間</div><div class="col-8">${a.date} ${a.time||''}</div>
                  <div class="col-4 text-muted">地點</div><div class="col-8">${a.location||'待定'}</div>
                  <div class="col-4 text-muted">狀態</div><div class="col-8"><span class="badge ${this.statusBadge(a.status)}">${this.statusText(a.status)}</span></div>
                  <div class="col-4 text-muted">費用</div><div class="col-8">${a.fee ? '$'+Util.fmtNum(a.fee) : '免費'}</div>
                  <div class="col-4 text-muted">人數限制</div><div class="col-8">${a.maxParticipants>0 ? a.maxParticipants+'人' : '無限制'}</div>
                  <div class="col-4 text-muted">報名截止</div><div class="col-8">${a.registrationDeadline||'—'}</div>
                  <div class="col-4 text-muted">負責人</div><div class="col-8">${a.organizer||'—'}</div>
                  <div class="col-4 text-muted">聯絡電話</div><div class="col-8">${a.contactPhone||'—'}</div>
                </div>
                ${a.description ? `
                  <div class="mt-3">
                    <div class="small text-muted mb-1">活動說明</div>
                    <div class="alert alert-light py-2 small mb-0">${a.description.replace(/\n/g,'<br>')}</div>
                  </div>
                ` : ''}
                ${a.notes ? `
                  <div class="mt-3">
                    <div class="small text-muted mb-1">內部備註</div>
                    <div class="alert alert-info py-2 small mb-0">${a.notes.replace(/\n/g,'<br>')}</div>
                  </div>
                ` : ''}
              </div>
            </div>
            <div class="col-lg-6">
              <div class="border rounded p-3 h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="fw-semibold mb-0"><i class="bi bi-people me-1"></i>報名名單 (${regs.length}人)</h6>
                  <button class="btn btn-sm btn-primary" onclick="Activities.manageRegistrations('${a.id}')">
                    <i class="bi bi-gear"></i> 管理
                  </button>
                </div>
                
                <div class="mb-3">
                  <div class="row text-center">
                    <div class="col-4">
                      <div class="fw-semibold text-primary">${regs.length}</div>
                      <div class="small text-muted">報名人數</div>
                    </div>
                    <div class="col-4">
                      <div class="fw-semibold text-success">$${Util.fmtNum(totalFee)}</div>
                      <div class="small text-muted">報名費總計</div>
                    </div>
                    <div class="col-4">
                      <div class="fw-semibold ${a.maxParticipants>0?(regs.length>=a.maxParticipants?'text-warning':'text-info'):'text-secondary'}">${a.maxParticipants>0?Math.max(0,a.maxParticipants-regs.length):'∞'}</div>
                      <div class="small text-muted">剩餘名額</div>
                    </div>
                  </div>
                </div>
                
                <div class="table-responsive" style="max-height:300px;overflow:auto;">
                  <table class="table table-sm">
                    <thead>
                      <tr><th>會員</th><th>報名日期</th><th class="text-end">費用</th><th>狀態</th></tr>
                    </thead>
                    <tbody>
                      ${regs.slice(0,50).map(r => {
                        const m = Store.data.members.find(x => x.id === r.memberId);
                        return `
                          <tr>
                            <td>
                              <div class="d-flex align-items-center">
                                <div class="participant-avatar small-avatar me-2">${m?m.name.charAt(0):'?'}</div>
                                <div>
                                  <div class="fw-semibold small">${m?m.name:'(已刪除)'}</div>
                                  <div class="text-muted" style="font-size:11px;">${m?m.phone:''}</div>
                                </div>
                              </div>
                            </td>
                            <td class="small">${r.registrationDate}</td>
                            <td class="text-end small">${r.fee?'$'+Util.fmtNum(r.fee):'免費'}</td>
                            <td><span class="badge ${r.status==='confirmed'?'bg-success':r.status==='cancelled'?'bg-danger':'bg-warning text-dark'} badge-rounded" style="font-size:10px;">${r.status==='confirmed'?'已確認':r.status==='cancelled'?'已取消':'待確認'}</span></td>
                          </tr>
                        `;
                      }).join('')}
                      ${regs.length===0?'<tr><td colspan="4" class="text-center text-muted py-3">尚無報名</td></tr>':''}
                      ${regs.length>50?'<tr><td colspan="4" class="text-center text-muted">...更多</td></tr>':''}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        `;
        
        modal.show();
      },
      
      manageRegistrations(activityId) {
        const a = Store.data.activities.find(x => x.id === activityId);
        if(!a) return;
        
        const modal = new bootstrap.Modal(document.getElementById('registrationManagerModal'));
        document.getElementById('regManagerTitle').textContent = `${a.name} - 報名管理`;
        document.getElementById('regActivityId').value = activityId;
        
        this.renderRegistrationTable(activityId);
        modal.show();
      },
      
      renderRegistrationTable(activityId) {
        const regs = Store.data.registrations.filter(r => r.activityId === activityId);
        const tb = document.getElementById('registrationTableBody');
        
        if(!regs.length) {
          tb.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">尚無報名</td></tr>';
          return;
        }
        
        tb.innerHTML = regs.map(r => {
          const m = Store.data.members.find(x => x.id === r.memberId);
          return `
            <tr>
              <td><input type="checkbox" class="reg-check" data-id="${r.id}"></td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="participant-avatar small-avatar me-2">${m?m.name.charAt(0):'?'}</div>
                  <div>
                    <div class="fw-semibold">${m?m.name:'(會員已刪除)'}</div>
                    <div class="text-muted small">${m?m.phone:''}</div>
                  </div>
                </div>
              </td>
              <td>${r.registrationDate}</td>
              <td class="text-end">${r.fee?'$'+Util.fmtNum(r.fee):'免費'}</td>
              <td>
                <select class="form-select form-select-sm" onchange="Activities.updateRegStatus('${r.id}', this.value)">
                  <option value="pending" ${r.status==='pending'?'selected':''}>待確認</option>
                  <option value="confirmed" ${r.status==='confirmed'?'selected':''}>已確認</option>
                  <option value="cancelled" ${r.status==='cancelled'?'selected':''}>已取消</option>
                </select>
              </td>
              <td>
                <button class="btn btn-sm btn-outline-danger" onclick="Activities.deleteRegistration('${r.id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          `;
        }).join('');
      },
      
      async updateRegStatus(regId, newStatus) {
        const reg = Store.data.registrations.find(r => r.id === regId);
        if(!reg) return;
        
        reg.status = newStatus;
        reg.updatedAt = new Date().toISOString();
        
        await Store.save('registrations');
        Util.showToast('success', '狀態已更新');
      },
      
      async deleteRegistration(regId) {
        const result = await Util.confirm({title:'取消報名', text:'確定刪除此筆報名？', confirmColor:'#dc3545'});
        if(!result.isConfirmed) return;
        
        Store.data.registrations = Store.data.registrations.filter(r => r.id !== regId);
        await Store.save('registrations');
        
        const activityId = document.getElementById('regActivityId').value;
        this.renderRegistrationTable(activityId);
        this.renderGrid(); // 重新整理活動卡片
        Util.showToast('success', '已刪除報名');
      },
      
      async addRegistration() {
        const activityId = document.getElementById('regActivityId').value;
        const activity = Store.data.activities.find(a => a.id === activityId);
        if(!activity) return;
        
        // 取得可報名的會員（排除已報名的）
        const registered = Store.data.registrations.filter(r => r.activityId === activityId).map(r => r.memberId);
        const available = Store.data.members.filter(m => !registered.includes(m.id) && m.status === 'active');
        
        if(!available.length) {
          return Util.showToast('error', '無可報名會員');
        }
        
        const result = await Swal.fire({
          title: '新增報名',
          html: `
            <div class="text-start">
              <label class="form-label">選擇會員</label>
              <select id="newRegMember" class="form-select">
                <option value="">請選擇會員</option>
                ${available.map(m => `<option value="${m.id}">${m.name} (${m.phone})</option>`).join('')}
              </select>
              <label class="form-label mt-2">報名費用</label>
              <input id="newRegFee" type="number" class="form-control" value="${activity.fee||0}">
              <label class="form-label mt-2">備註</label>
              <textarea id="newRegNote" rows="2" class="form-control"></textarea>
            </div>
          `,
          confirmButtonText: '新增',
          showCancelButton: true
        });
        
        if(!result.isConfirmed) return;
        
        const memberId = document.getElementById('newRegMember').value;
        const fee = Util.toNumber(document.getElementById('newRegFee').value);
        const note = document.getElementById('newRegNote').value.trim();
        
        if(!memberId) return Util.showToast('error', '請選擇會員');
        
        const reg = {
          id: Util.uuid(),
          activityId,
          memberId,
          registrationDate: Util.today(),
          fee,
          status: 'confirmed',
          notes: note,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        Store.data.registrations.push(reg);
        await Store.save('registrations');
        
        this.renderRegistrationTable(activityId);
        this.renderGrid();
        Util.showToast('success', '已新增報名');
      },
      
      async delete(id) {
        const result = await Util.confirm({title:'刪除活動', text:'此動作同時刪除相關報名資料，確定？', confirmColor:'#dc3545'});
        if(!result.isConfirmed) return;
        
        Store.data.activities = Store.data.activities.filter(a => a.id !== id);
        Store.data.registrations = Store.data.registrations.filter(r => r.activityId !== id);
        await Store.save();
        this.renderGrid();
        Dashboard.refresh();
        Util.showToast('success', '已刪除活動');
      }
    };

    /* 活動新增編輯 UI */
    const ActivityUI = {
      modal: null,
      
      open(id = null) {
        if(!this.modal) this.modal = new bootstrap.Modal(document.getElementById('activityModal'));
        
        document.getElementById('activityForm').reset();
        document.getElementById('activityId').value = '';
        document.getElementById('activityDate').value = Util.today();
        document.getElementById('activityStatus').value = 'planning';
        document.getElementById('activityModalTitle').textContent = '新增活動';
        
        if(id) {
          const a = Store.data.activities.find(x => x.id === id);
          if(a) {
            document.getElementById('activityModalTitle').textContent = '編輯活動';
            document.getElementById('activityId').value = a.id;
            document.getElementById('activityName').value = a.name;
            document.getElementById('activityDate').value = a.date;
            document.getElementById('activityTime').value = a.time || '';
            document.getElementById('activityLocation').value = a.location || '';
            document.getElementById('activityDescription').value = a.description || '';
            document.getElementById('activityStatus').value = a.status;
            document.getElementById('activityFee').value = a.fee || '';
            document.getElementById('activityMaxParticipants').value = a.maxParticipants || '';
            document.getElementById('activityRegistrationDeadline').value = a.registrationDeadline || '';
            document.getElementById('activityOrganizer').value = a.organizer || '';
            document.getElementById('activityContactPhone').value = a.contactPhone || '';
            document.getElementById('activityNotes').value = a.notes || '';
          }
        }
        
        this.modal.show();
      },
      
      async save() {
        const form = document.getElementById('activityForm');
        if(!form.checkValidity()) { 
          form.reportValidity(); 
          return; 
        }
        
        const id = document.getElementById('activityId').value;
        const a = {
          id: id || Util.uuid(),
          name: document.getElementById('activityName').value.trim(),
          date: document.getElementById('activityDate').value,
          time: document.getElementById('activityTime').value.trim(),
          location: document.getElementById('activityLocation').value.trim(),
          description: document.getElementById('activityDescription').value.trim(),
          status: document.getElementById('activityStatus').value,
          fee: Util.toNumber(document.getElementById('activityFee').value),
          maxParticipants: parseInt(document.getElementById('activityMaxParticipants').value) || 0,
          registrationDeadline: document.getElementById('activityRegistrationDeadline').value,
          organizer: document.getElementById('activityOrganizer').value.trim(),
          contactPhone: document.getElementById('activityContactPhone').value.trim(),
          notes: document.getElementById('activityNotes').value.trim(),
          createdAt: id ? (Store.data.activities.find(x => x.id === id)?.createdAt || new Date().toISOString()) : new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        if(id) {
          const idx = Store.data.activities.findIndex(x => x.id === a.id);
          if(idx > -1) Store.data.activities[idx] = a;
        } else {
          Store.data.activities.push(a);
        }
        
        await Store.save('activities');
        Activities.renderGrid();
        Dashboard.refresh();
        this.modal.hide();
        Util.showToast('success', id ? '活動已更新' : '活動已新增');
      }
    };

    /* -------------------- 公告模組 -------------------- */
    const Announcements = {
      render() {
        const container = document.getElementById('announcementsContainer');
        const arr = [...Store.data.announcements].sort((a,b) => {
          // 置頂優先，然後按日期排序
          if(a.pinned && !b.pinned) return -1;
          if(!a.pinned && b.pinned) return 1;
          return b.publishDate.localeCompare(a.publishDate);
        });
        
        if(!arr.length) {
          container.innerHTML = `<div class="text-center text-muted py-5">
            <i class="bi bi-megaphone display-1 d-block mb-3"></i>
            <h5>尚無公告</h5>
            <p>點擊「新增公告」發布第一則公告</p>
          </div>`;
          return;
        }
        
        container.innerHTML = arr.map(a => `
          <div class="announcement-card card mb-3 ${a.urgent?'urgent':''}">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="d-flex align-items-center gap-2">
                  ${a.pinned?'<i class="bi bi-pin-angle-fill text-warning" title="置頂"></i>':''}
                  ${a.urgent?'<i class="bi bi-exclamation-triangle-fill text-danger" title="緊急"></i>':''}
                  <h6 class="card-title mb-0 fw-semibold">${a.title}</h6>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-sm btn-outline-primary" onclick="AnnouncementUI.open('${a.id}')">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="Announcements.delete('${a.id}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
              <div class="small text-muted mb-2">
                <i class="bi bi-calendar me-1"></i>${a.publishDate}
                <i class="bi bi-person ms-3 me-1"></i>${a.author||'系統'}
                <span class="badge ${a.status==='published'?'bg-success':'bg-secondary'} ms-2">${a.status==='published'?'已發布':'草稿'}</span>
              </div>
              <div class="card-text">
                ${a.content.length > 200 ? a.content.slice(0,200) + '...' : a.content}
              </div>
              ${a.content.length > 200 ? `
                <button class="btn btn-sm btn-link p-0 mt-1" onclick="Announcements.showFull('${a.id}')">
                  展開全文 <i class="bi bi-chevron-down"></i>
                </button>
              ` : ''}
            </div>
          </div>
        `).join('');
      },
      
      showFull(id) {
        const a = Store.data.announcements.find(x => x.id === id);
        if(!a) return;
        
        Swal.fire({
          title: a.title,
          html: `
            <div class="text-start">
              <div class="small text-muted mb-3">
                <i class="bi bi-calendar me-1"></i>${a.publishDate}
                <i class="bi bi-person ms-3 me-1"></i>${a.author||'系統'}
              </div>
              <div style="white-space:pre-wrap;">${a.content}</div>
            </div>
          `,
          showConfirmButton: false,
          showCloseButton: true,
          width: '600px'
        });
      },
      
      async delete(id) {
        const result = await Util.confirm({title:'刪除公告', text:'確定刪除此則公告？', confirmColor:'#dc3545'});
        if(!result.isConfirmed) return;
        
        Store.data.announcements = Store.data.announcements.filter(a => a.id !== id);
        await Store.save('announcements');
        this.render();
        Util.showToast('success', '已刪除公告');
      }
    };

    /* 公告編輯 UI */
    const AnnouncementUI = {
      modal: null,
      
      open(id = null) {
        if(!this.modal) this.modal = new bootstrap.Modal(document.getElementById('announcementModal'));
        
        document.getElementById('announcementForm').reset();
        document.getElementById('announcementId').value = '';
        document.getElementById('announcementPublishDate').value = Util.today();
        document.getElementById('announcementStatus').value = 'published';
        document.getElementById('announcementModalTitle').textContent = '新增公告';
        
        if(id) {
          const a = Store.data.announcements.find(x => x.id === id);
          if(a) {
            document.getElementById('announcementModalTitle').textContent = '編輯公告';
            document.getElementById('announcementId').value = a.id;
            document.getElementById('announcementTitle').value = a.title;
            document.getElementById('announcementContent').value = a.content;
            document.getElementById('announcementPublishDate').value = a.publishDate;
            document.getElementById('announcementAuthor').value = a.author || '';
            document.getElementById('announcementStatus').value = a.status;
            document.getElementById('announcementPinned').checked = !!a.pinned;
            document.getElementById('announcementUrgent').checked = !!a.urgent;
          }
        }
        
        this.modal.show();
      },
      
      async save() {
        const form = document.getElementById('announcementForm');
        if(!form.checkValidity()) { 
          form.reportValidity(); 
          return; 
        }
        
        const id = document.getElementById('announcementId').value;
        const a = {
          id: id || Util.uuid(),
          title: document.getElementById('announcementTitle').value.trim(),
          content: document.getElementById('announcementContent').value.trim(),
          publishDate: document.getElementById('announcementPublishDate').value,
          author: document.getElementById('announcementAuthor').value.trim(),
          status: document.getElementById('announcementStatus').value,
          pinned: document.getElementById('announcementPinned').checked,
          urgent: document.getElementById('announcementUrgent').checked,
          createdAt: id ? (Store.data.announcements.find(x => x.id === id)?.createdAt || new Date().toISOString()) : new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        if(id) {
          const idx = Store.data.announcements.findIndex(x => x.id === a.id);
          if(idx > -1) Store.data.announcements[idx] = a;
        } else {
          Store.data.announcements.push(a);
        }
        
        await Store.save('announcements');
        Announcements.render();
        this.modal.hide();
        Util.showToast('success', id ? '公告已更新' : '公告已發布');
      }
    };

    /* -------------------- 表單模組 -------------------- */
    const Forms = {
      render() {
        const container = document.getElementById('formsContainer');
        const arr = [...Store.data.forms].sort((a,b) => b.createdAt.localeCompare(a.createdAt));
        
        if(!arr.length) {
          container.innerHTML = `<div class="text-center text-muted py-5">
            <i class="bi bi-file-earmark-text display-1 d-block mb-3"></i>
            <h5>尚無表單</h5>
            <p>點擊「新增表單」建立第一個表單</p>
          </div>`;
          return;
        }
        
        container.innerHTML = arr.map(f => {
          const responses = f.responses || [];
          return `
            <div class="form-card card mb-3">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <h6 class="card-title mb-1 fw-semibold">${f.title}</h6>
                    <div class="small text-muted">
                      <i class="bi bi-calendar me-1"></i>建立於 ${f.createdAt.slice(0,10)}
                      <span class="badge ${f.active?'bg-success':'bg-secondary'} ms-2">${f.active?'開放中':'已關閉'}</span>
                    </div>
                  </div>
                  <div class="d-flex gap-1">
                    <button class="btn btn-sm btn-outline-info" onclick="Forms.viewResponses('${f.id}')" title="查看回應">
                      <i class="bi bi-eye"></i> ${responses.length}
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="FormUI.open('${f.id}')" title="編輯">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="Forms.preview('${f.id}')" title="預覽">
                      <i class="bi bi-display"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="Forms.delete('${f.id}')" title="刪除">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
                <p class="card-text small text-muted mb-2">${(f.description||'').slice(0,100)}${f.description?.length>100?'...':''}</p>
                <div class="d-flex justify-content-between small">
                  <span class="text-muted">${f.fields?.length||0} 個欄位</span>
                  <span class="text-primary">${responses.length} 份回應</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
      },
      
      preview(id) {
        const f = Store.data.forms.find(x => x.id === id);
        if(!f) return;
        
        let html = `<div class="text-start">
          <h5>${f.title}</h5>
          ${f.description?`<p class="text-muted">${f.description}</p>`:''}
          <form id="previewForm">`;
        
        (f.fields||[]).forEach((field, idx) => {
          html += `<div class="mb-3">
            <label class="form-label">${field.label} ${field.required?'<span class="text-danger">*</span>':''}</label>`;
          
          switch(field.type) {
            case 'text':
              html += `<input type="text" class="form-control" ${field.required?'required':''}>`; 
              break;
            case 'textarea':
              html += `<textarea class="form-control" rows="3" ${field.required?'required':''}></textarea>`; 
              break;
            case 'email':
              html += `<input type="email" class="form-control" ${field.required?'required':''}>`; 
              break;
            case 'phone':
              html += `<input type="tel" class="form-control" ${field.required?'required':''}>`; 
              break;
            case 'number':
              html += `<input type="number" class="form-control" ${field.required?'required':''}>`; 
              break;
            case 'date':
              html += `<input type="date" class="form-control" ${field.required?'required':''}>`; 
              break;
            case 'select':
              html += `<select class="form-select" ${field.required?'required':''}>
                <option value="">請選擇</option>
                ${(field.options||[]).map(opt => `<option value="${opt}">${opt}</option>`).join('')}
              </select>`; 
              break;
            case 'radio':
              html += '<div>';
              (field.options||[]).forEach(opt => {
                html += `<div class="form-check">
                  <input class="form-check-input" type="radio" name="field_${idx}" value="${opt}" ${field.required?'required':''}>
                  <label class="form-check-label">${opt}</label>
                </div>`;
              });
              html += '</div>'; 
              break;
            case 'checkbox':
              html += '<div>';
              (field.options||[]).forEach(opt => {
                html += `<div class="form-check">
                  <input class="form-check-input" type="checkbox" value="${opt}">
                  <label class="form-check-label">${opt}</label>
                </div>`;
              });
              html += '</div>'; 
              break;
          }
          
          if(field.description) {
            html += `<div class="form-text">${field.description}</div>`;
          }
          html += '</div>';
        });
        
        html += '</form></div>';
        
        Swal.fire({
          title: '表單預覽',
          html,
          showConfirmButton: false,
          showCloseButton: true,
          width: '600px'
        });
      },
      
      viewResponses(id) {
        const f = Store.data.forms.find(x => x.id === id);
        if(!f) return;
        
        const modal = new bootstrap.Modal(document.getElementById('formResponsesModal'));
        document.getElementById('formResponsesTitle').textContent = `${f.title} - 回應列表`;
        
        const responses = f.responses || [];
        const container = document.getElementById('formResponsesContainer');
        
        if(!responses.length) {
          container.innerHTML = '<div class="text-center text-muted py-4">尚無回應</div>';
        } else {
          container.innerHTML = `
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>提交時間</th>
                    <th>提交者</th>
                    ${(f.fields||[]).slice(0,5).map(field => `<th>${field.label}</th>`).join('')}
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${responses.map(r => `
                    <tr>
                      <td class="small">${r.submittedAt.slice(0,16).replace('T',' ')}</td>
                      <td class="small">${r.submitterName||'匿名'}</td>
                      ${(f.fields||[]).slice(0,5).map(field => {
                        const value = r.data[field.id] || '';
                        return `<td class="small">${Array.isArray(value) ? value.join(', ') : value}</td>`;
                      }).join('')}
                      <td>
                        <button class="btn btn-sm btn-outline-info" onclick="Forms.viewResponseDetail('${f.id}','${r.id}')">
                          <i class="bi bi-eye"></i>
                        </button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
        
        modal.show();
      },
      
      viewResponseDetail(formId, responseId) {
        const f = Store.data.forms.find(x => x.id === formId);
        const r = f?.responses?.find(x => x.id === responseId);
        if(!f || !r) return;
        
        let html = `<div class="text-start">
          <div class="mb-3">
            <strong>提交時間：</strong>${r.submittedAt.slice(0,16).replace('T',' ')}<br>
            <strong>提交者：</strong>${r.submitterName||'匿名'}
          </div>
          <hr>`;
        
        (f.fields||[]).forEach(field => {
          const value = r.data[field.id] || '';
          html += `<div class="mb-3">
            <strong>${field.label}：</strong><br>
            <div class="ps-3">${Array.isArray(value) ? value.join(', ') : (value || '(未填寫)')}</div>
          </div>`;
        });
        
        html += '</div>';
        
        Swal.fire({
          title: '回應詳情',
          html,
          showConfirmButton: false,
          showCloseButton: true,
          width: '500px'
        });
      },
      
      async delete(id) {
        const result = await Util.confirm({title:'刪除表單', text:'此動作同時刪除所有回應，確定？', confirmColor:'#dc3545'});
        if(!result.isConfirmed) return;
        
        Store.data.forms = Store.data.forms.filter(f => f.id !== id);
        await Store.save('forms');
        this.render();
        Util.showToast('success', '已刪除表單');
      }
    };

    /* 表單編輯 UI */
    const FormUI = {
      modal: null,
      currentFields: [],
      
      open(id = null) {
        if(!this.modal) this.modal = new bootstrap.Modal(document.getElementById('formModal'));
        
        document.getElementById('formBuilderForm').reset();
        document.getElementById('formId').value = '';
        document.getElementById('formModalTitle').textContent = '新增表單';
        this.currentFields = [];
        
        if(id) {
          const f = Store.data.forms.find(x => x.id === id);
          if(f) {
            document.getElementById('formModalTitle').textContent = '編輯表單';
            document.getElementById('formId').value = f.id;
            document.getElementById('formTitle').value = f.title;
            document.getElementById('formDescription').value = f.description || '';
            document.getElementById('formActive').checked = !!f.active;
            this.currentFields = [...(f.fields || [])];
          }
        }
        
        this.renderFields();
        this.modal.show();
      },
      
      renderFields() {
        const container = document.getElementById('formFieldsContainer');
        if(!this.currentFields.length) {
          container.innerHTML = '<div class="text-center text-muted py-3">尚未新增欄位</div>';
          return;
        }
        
        container.innerHTML = this.currentFields.map((field, idx) => `
          <div class="field-item border rounded p-3 mb-2">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="fw-semibold">${field.label} ${field.required?'<span class="text-danger">*</span>':''}</div>
                <div class="small text-muted">${field.type} ${field.description?'- '+field.description:''}</div>
                ${field.options?.length ? `<div class="small text-info">選項：${field.options.join(', ')}</div>` : ''}
              </div>
              <div class="d-flex gap-1">
                <button class="btn btn-sm btn-outline-primary" onclick="FormUI.editField(${idx})">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="FormUI.removeField(${idx})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `).join('');
      },
      
      async addField() {
        const result = await this.showFieldEditor();
        if(result) {
          this.currentFields.push(result);
          this.renderFields();
        }
      },
      
      async editField(idx) {
        const field = this.currentFields[idx];
        const result = await this.showFieldEditor(field);
        if(result) {
          this.currentFields[idx] = result;
          this.renderFields();
        }
      },
      
      removeField(idx) {
        this.currentFields.splice(idx, 1);
        this.renderFields();
      },
      
      async showFieldEditor(field = null) {
        const isEdit = !!field;
        
        const result = await Swal.fire({
          title: isEdit ? '編輯欄位' : '新增欄位',
          html: `
            <div class="text-start">
              <label class="form-label">欄位標籤</label>
              <input id="fieldLabel" type="text" class="form-control" value="${field?.label||''}" required>
              
              <label class="form-label mt-2">欄位類型</label>
              <select id="fieldType" class="form-select" onchange="FormUI.onFieldTypeChange()">
                <option value="text" ${field?.type==='text'?'selected':''}>單行文字</option>
                <option value="textarea" ${field?.type==='textarea'?'selected':''}>多行文字</option>
                <option value="email" ${field?.type==='email'?'selected':''}>電子郵件</option>
                <option value="phone" ${field?.type==='phone'?'selected':''}>電話號碼</option>
                <option value="number" ${field?.type==='number'?'selected':''}>數字</option>
                <option value="date" ${field?.type==='date'?'selected':''}>日期</option>
                <option value="select" ${field?.type==='select'?'selected':''}>下拉選單</option>
                <option value="radio" ${field?.type==='radio'?'selected':''}>單選按鈕</option>
                <option value="checkbox" ${field?.type==='checkbox'?'selected':''}>多選方塊</option>
              </select>
              
              <div id="fieldOptionsContainer" style="display:none;">
                <label class="form-label mt-2">選項 (每行一個)</label>
                <textarea id="fieldOptions" class="form-control" rows="3" placeholder="選項1\n選項2\n選項3">${field?.options?.join('\n')||''}</textarea>
              </div>
              
              <label class="form-label mt-2">說明文字 (選填)</label>
              <input id="fieldDescription" type="text" class="form-control" value="${field?.description||''}">
              
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="fieldRequired" ${field?.required?'checked':''}>
                <label class="form-check-label" for="fieldRequired">必填欄位</label>
              </div>
            </div>
          `,
          confirmButtonText: isEdit ? '更新' : '新增',
          showCancelButton: true,
          didOpen: () => {
            this.onFieldTypeChange();
          }
        });
        
        if(!result.isConfirmed) return null;
        
        const label = document.getElementById('fieldLabel').value.trim();
        const type = document.getElementById('fieldType').value;
        const description = document.getElementById('fieldDescription').value.trim();
        const required = document.getElementById('fieldRequired').checked;
        
        if(!label) {
          Util.showToast('error', '請輸入欄位標籤');
          return null;
        }
        
        const newField = {
          id: field?.id || Util.uuid(),
          label,
          type,
          description,
          required
        };
        
        if(['select', 'radio', 'checkbox'].includes(type)) {
          const options = document.getElementById('fieldOptions').value.split('\n').map(s => s.trim()).filter(Boolean);
          if(!options.length) {
            Util.showToast('error', '請輸入選項');
            return null;
          }
          newField.options = options;
        }
        
        return newField;
      },
      
      onFieldTypeChange() {
        const type = document.getElementById('fieldType').value;
        const container = document.getElementById('fieldOptionsContainer');
        if(['select', 'radio', 'checkbox'].includes(type)) {
          container.style.display = 'block';
        } else {
          container.style.display = 'none';
        }
      },
      
      async save() {
        const title = document.getElementById('formTitle').value.trim();
        if(!title) return Util.showToast('error', '請輸入表單標題');
        if(!this.currentFields.length) return Util.showToast('error', '請至少新增一個欄位');
        
        const id = document.getElementById('formId').value;
        const f = {
          id: id || Util.uuid(),
          title,
          description: document.getElementById('formDescription').value.trim(),
          active: document.getElementById('formActive').checked,
          fields: [...this.currentFields],
          responses: id ? (Store.data.forms.find(x => x.id === id)?.responses || []) : [],
          createdAt: id ? (Store.data.forms.find(x => x.id === id)?.createdAt || new Date().toISOString()) : new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        if(id) {
          const idx = Store.data.forms.findIndex(x => x.id === f.id);
          if(idx > -1) Store.data.forms[idx] = f;
        } else {
          Store.data.forms.push(f);
        }
        
        await Store.save('forms');
        Forms.render();
        this.modal.hide();
        Util.showToast('success', id ? '表單已更新' : '表單已建立');
      }
    };

    /* -------------------- 分析模組 -------------------- */
    const Analytics = {
      refresh() {
        this.renderIncomeExpenseChart();
        this.renderMemberGrowthChart();
        this.renderCategoryChart();
        this.renderMonthlyTrend();
      },
      
      renderIncomeExpenseChart() {
        const ctx = document.getElementById('incomeExpenseChart');
        if(!ctx) return;
        
        const months = [];
        const income = [];
        const expense = [];
        
        // 取得最近12個月
        for(let i = 11; i >= 0; i--) {
          const d = new Date();
          d.setMonth(d.getMonth() - i);
          const monthStr = d.getFullYear() + '-' + Util.pad(d.getMonth() + 1);
          months.push(monthStr.slice(5)); // 只要月份
          
          const monthIncome = Store.data.transactions
            .filter(t => t.type === '收入' && t.date.startsWith(monthStr))
            .reduce((s, t) => s + Util.toNumber(t.amount), 0);
          const monthExpense = Store.data.transactions
            .filter(t => t.type === '支出' && t.date.startsWith(monthStr))
            .reduce((s, t) => s + Util.toNumber(t.amount), 0);
          
          income.push(monthIncome);
          expense.push(monthExpense);
        }
        
        if(window.incomeExpenseChart) window.incomeExpenseChart.destroy();
        
        window.incomeExpenseChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: '收入',
              data: income,
              borderColor: '#28a745',
              backgroundColor: 'rgba(40, 167, 69, 0.1)',
              fill: true
            }, {
              label: '支出',
              data: expense,
              borderColor: '#dc3545',
              backgroundColor: 'rgba(220, 53, 69, 0.1)',
              fill: true
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: '收支趨勢 (最近12個月)' }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      },
      
      renderMemberGrowthChart() {
        const ctx = document.getElementById('memberGrowthChart');
        if(!ctx) return;
        
        const months = [];
        const counts = [];
        
        for(let i = 11; i >= 0; i--) {
          const d = new Date();
          d.setMonth(d.getMonth() - i);
          const monthStr = d.getFullYear() + '-' + Util.pad(d.getMonth() + 1);
          months.push(monthStr.slice(5));
          
          const count = Store.data.members.filter(m => m.joinDate <= monthStr + '-31').length;
          counts.push(count);
        }
        
        if(window.memberGrowthChart) window.memberGrowthChart.destroy();
        
        window.memberGrowthChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: '累計會員數',
              data: counts,
              borderColor: '#007bff',
              backgroundColor: 'rgba(0, 123, 255, 0.1)',
              fill: true
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: '會員成長趨勢' }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      },
      
      renderCategoryChart() {
        const ctx = document.getElementById('categoryChart');
        if(!ctx) return;
        
        const categoryData = {};
        Store.data.transactions.forEach(t => {
          if(t.type === '支出') {
            categoryData[t.category] = (categoryData[t.category] || 0) + Util.toNumber(t.amount);
          }
        });
        
        const labels = Object.keys(categoryData);
        const data = Object.values(categoryData);
        const colors = [
          '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff',
          '#ff9f40', '#ff6384', '#c9cbcf', '#4bc0c0', '#ff6384'
        ];
        
        if(window.categoryChart) window.categoryChart.destroy();
        
        window.categoryChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data,
              backgroundColor: colors.slice(0, labels.length)
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: '支出類別分布' },
              legend: { position: 'bottom' }
            }
          }
        });
      },
      
      renderMonthlyTrend() {
        const container = document.getElementById('monthlyTrendContainer');
        if(!container) return;
        
        const thisMonth = new Date().toISOString().slice(0, 7);
        const lastMonth = new Date(new Date().setMonth(new Date().getMonth() - 1)).toISOString().slice(0, 7);
        
        const thisMonthIncome = Store.data.transactions
          .filter(t => t.type === '收入' && t.date.startsWith(thisMonth))
          .reduce((s, t) => s + Util.toNumber(t.amount), 0);
        const lastMonthIncome = Store.data.transactions
          .filter(t => t.type === '收入' && t.date.startsWith(lastMonth))
          .reduce((s, t) => s + Util.toNumber(t.amount), 0);
        
        const thisMonthExpense = Store.data.transactions
          .filter(t => t.type === '支出' && t.date.startsWith(thisMonth))
          .reduce((s, t) => s + Util.toNumber(t.amount), 0);
        const lastMonthExpense = Store.data.transactions
          .filter(t => t.type === '支出' && t.date.startsWith(lastMonth))
          .reduce((s, t) => s + Util.toNumber(t.amount), 0);
        
        const incomeChange = lastMonthIncome === 0 ? 0 : ((thisMonthIncome - lastMonthIncome) / lastMonthIncome * 100);
        const expenseChange = lastMonthExpense === 0 ? 0 : ((thisMonthExpense - lastMonthExpense) / lastMonthExpense * 100);
        
        container.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-body text-center">
                  <h6 class="card-title">本月收入</h6>
                  <h4 class="text-success">$${Util.fmtNum(thisMonthIncome)}</h4>
                  <div class="small ${incomeChange >= 0 ? 'text-success' : 'text-danger'}">
                    <i class="bi bi-arrow-${incomeChange >= 0 ? 'up' : 'down'}"></i>
                    ${Math.abs(incomeChange).toFixed(1)}% vs 上月
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-body text-center">
                  <h6 class="card-title">本月支出</h6>
                  <h4 class="text-danger">$${Util.fmtNum(thisMonthExpense)}</h4>
                  <div class="small ${expenseChange <= 0 ? 'text-success' : 'text-danger'}">
                    <i class="bi bi-arrow-${expenseChange <= 0 ? 'down' : 'up'}"></i>
                    ${Math.abs(expenseChange).toFixed(1)}% vs 上月
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
    };

    /* -------------------- 報表模組 -------------------- */
    const Reports = {
      dateInited: false,
      
      initDateOnce() {
        if(this.dateInited) return;
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('reportStartDate').value = firstDay.toISOString().slice(0,10);
        document.getElementById('reportEndDate').value = today.toISOString().slice(0,10);
        this.dateInited = true;
      },
      
      generate() {
        this.initDateOnce();
        
        const start = document.getElementById('reportStartDate').value;
        const end = document.getElementById('reportEndDate').value;
        const type = document.getElementById('reportType').value;
        
        if(!start || !end) return Util.showToast('error', '請選擇日期範圍');
        if(start > end) return Util.showToast('error', '開始日期不能晚於結束日期');
        
        switch(type) {
          case 'financial': this.generateFinancialReport(start, end); break;
          case 'member': this.generateMemberReport(start, end); break;
          case 'activity': this.generateActivityReport(start, end); break;
          default: Util.showToast('error', '請選擇報表類型');
        }
      },
      
      generateFinancialReport(start, end) {
        const txs = Store.data.transactions.filter(t => t.date >= start && t.date <= end);
        const income = txs.filter(t => t.type === '收入');
        const expense = txs.filter(t => t.type === '支出');
        
        const totalIncome = income.reduce((s, t) => s + Util.toNumber(t.amount), 0);
        const totalExpense = expense.reduce((s, t) => s + Util.toNumber(t.amount), 0);
        const netIncome = totalIncome - totalExpense;
        
        // 收入分類統計
        const incomeByCategory = {};
        income.forEach(t => {
          incomeByCategory[t.category] = (incomeByCategory[t.category] || 0) + Util.toNumber(t.amount);
        });
        
        // 支出分類統計
        const expenseByCategory = {};
        expense.forEach(t => {
          expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + Util.toNumber(t.amount);
        });
        
        const html = `
          <div class="report-content">
            <div class="report-header text-center mb-4">
              <h4>財務報表</h4>
              <p class="text-muted">${start} ~ ${end}</p>
            </div>
            
            <div class="row mb-4">
              <div class="col-md-4">
                <div class="card text-center">
                  <div class="card-body">
                    <h6 class="card-title text-success">總收入</h6>
                    <h4 class="text-success">$${Util.fmtNum(totalIncome)}</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card text-center">
                  <div class="card-body">
                    <h6 class="card-title text-danger">總支出</h6>
                    <h4 class="text-danger">$${Util.fmtNum(totalExpense)}</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card text-center">
                  <div class="card-body">
                    <h6 class="card-title ${netIncome >= 0 ? 'text-success' : 'text-danger'}">淨收入</h6>
                    <h4 class="${netIncome >= 0 ? 'text-success' : 'text-danger'}">$${Util.fmtNum(netIncome)}</h4>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <h6>收入明細</h6>
                <table class="table table-sm">
                  <thead><tr><th>類別</th><th class="text-end">金額</th><th class="text-end">佔比</th></tr></thead>
                  <tbody>
                    ${Object.entries(incomeByCategory).map(([cat, amt]) => `
                      <tr>
                        <td>${cat}</td>
                        <td class="text-end">$${Util.fmtNum(amt)}</td>
                        <td class="text-end">${totalIncome > 0 ? (amt/totalIncome*100).toFixed(1) : 0}%</td>
                      </tr>
                    `).join('')}
                    ${Object.keys(incomeByCategory).length === 0 ? '<tr><td colspan="3" class="text-center text-muted">無收入記錄</td></tr>' : ''}
                  </tbody>
                </table>
              </div>
              <div class="col-md-6">
                <h6>支出明細</h6>
                <table class="table table-sm">
                  <thead><tr><th>類別</th><th class="text-end">金額</th><th class="text-end">佔比</th></tr></thead>
                  <tbody>
                    ${Object.entries(expenseByCategory).map(([cat, amt]) => `
                      <tr>
                        <td>${cat}</td>
                        <td class="text-end">$${Util.fmtNum(amt)}</td>
                        <td class="text-end">${totalExpense > 0 ? (amt/totalExpense*100).toFixed(1) : 0}%</td>
                      </tr>
                    `).join('')}
                    ${Object.keys(expenseByCategory).length === 0 ? '<tr><td colspan="3" class="text-center text-muted">無支出記錄</td></tr>' : ''}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
        
        document.getElementById('reportResult').innerHTML = html;
      },
      
      generateMemberReport(start, end) {
        const newMembers = Store.data.members.filter(m => m.joinDate >= start && m.joinDate <= end);
        const activeMembers = Store.data.members.filter(m => m.status === 'active');
        const overdueMembers = Store.data.members.filter(m => Members.isOverdue(m));
        
        // 會員類型統計
        const typeStats = {};
        Store.data.members.forEach(m => {
          typeStats[m.type] = (typeStats[m.type] || 0) + 1;
        });
        
        // 年齡分布
        const ageGroups = {'18以下': 0, '19-30': 0, '31-50': 0, '51-65': 0, '65以上': 0, '未知': 0};
        Store.data.members.forEach(m => {
          const age = Util.age(m.birthDate);
          if(!age) ageGroups['未知']++;
          else if(age <= 18) ageGroups['18以下']++;
          else if(age <= 30) ageGroups['19-30']++;
          else if(age <= 50) ageGroups['31-50']++;
          else if(age <= 65) ageGroups['51-65']++;
          else ageGroups['65以上']++;
        });
        
        const html = `
          <div class="report-content">
            <div class="report-header text-center mb-4">
              <h4>會員報表</h4>
              <p class="text-muted">${start} ~ ${end}</p>
            </div>
            
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h6 class="card-title">總會員數</h6>
                    <h4 class="text-primary">${Store.data.members.length}</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h6 class="card-title">新增會員</h6>
                    <h4 class="text-success">${newMembers.length}</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h6 class="card-title">正常會員</h6>
                    <h4 class="text-info">${activeMembers.length}</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h6 class="card-title">逾期會員</h6>
                    <h4 class="text-warning">${overdueMembers.length}</h4>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <h6>會員類型分布</h6>
                <table class="table table-sm">
                  <thead><tr><th>類型</th><th class="text-end">人數</th><th class="text-end">佔比</th></tr></thead>
                  <tbody>
                    ${Object.entries(typeStats).map(([type, count]) => `
                      <tr>
                        <td>${Members.typeText(type)}</td>
                        <td class="text-end">${count}</td>
                        <td class="text-end">${Store.data.members.length > 0 ? (count/Store.data.members.length*100).toFixed(1) : 0}%</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
              <div class="col-md-6">
                <h6>年齡分布</h6>
                <table class="table table-sm">
                  <thead><tr><th>年齡層</th><th class="text-end">人數</th><th class="text-end">佔比</th></tr></thead>
                  <tbody>
                    ${Object.entries(ageGroups).map(([group, count]) => `
                      <tr>
                        <td>${group}</td>
                        <td class="text-end">${count}</td>
                        <td class="text-end">${Store.data.members.length > 0 ? (count/Store.data.members.length*100).toFixed(1) : 0}%</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
        
        document.getElementById('reportResult').innerHTML = html;
      },
      
      generateActivityReport(start, end) {
        const activities = Store.data.activities.filter(a => a.date >= start && a.date <= end);
        const registrations = Store.data.registrations.filter(r => {
          const activity = Store.data.activities.find(a => a.id === r.activityId);
          return activity && activity.date >= start && activity.date <= end;
        });
        
        const totalFee = registrations.reduce((s, r) => s + Util.toNumber(r.fee), 0);
        
        // 活動狀態統計
        const statusStats = {};
        activities.forEach(a => {
          statusStats[a.status] = (statusStats[a.status] || 0) + 1;
        });
        
        const html = `
          <div class="report-content">
            <div class="report-header text-center mb-4">
              <h4>活動報表</h4>
              <p class="text-muted">${start} ~ ${end}</p>
            </div>
            
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h6 class="card-title">活動總數</h6>
                    <h4 class="text-primary">${activities.length}</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h6 class="card-title">總報名人次</h6>
                    <h4 class="text-success">${registrations.length}</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h6 class="card-title">平均報名率</h6>
                    <h4 class="text-info">${activities.length > 0 ? (registrations.length / activities.length).toFixed(1) : 0}</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h6 class="card-title">報名費總計</h6>
                    <h4 class="text-warning">$${Util.fmtNum(totalFee)}</h4>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <h6>活動狀態分布</h6>
                <table class="table table-sm">
                  <thead><tr><th>狀態</th><th class="text-end">數量</th><th class="text-end">佔比</th></tr></thead>
                  <tbody>
                    ${Object.entries(statusStats).map(([status, count]) => `
                      <tr>
                        <td>${Activities.statusText(status)}</td>
                        <td class="text-end">${count}</td>
                        <td class="text-end">${activities.length > 0 ? (count/activities.length*100).toFixed(1) : 0}%</td>
                      </tr>
                    `).join('')}
                    ${Object.keys(statusStats).length === 0 ? '<tr><td colspan="3" class="text-center text-muted">無活動記錄</td></tr>' : ''}
                  </tbody>
                </table>
              </div>
              <div class="col-md-6">
                <h6>熱門活動 (報名人數)</h6>
                <table class="table table-sm">
                  <thead><tr><th>活動名稱</th><th class="text-end">報名人數</th></tr></thead>
                  <tbody>
                    ${activities.map(a => {
                      const regCount = Store.data.registrations.filter(r => r.activityId === a.id).length;
                      return {activity: a, count: regCount};
                    }).sort((a,b) => b.count - a.count).slice(0,10).map(item => `
                      <tr>
                        <td>${item.activity.name}</td>
                        <td class="text-end">${item.count}</td>
                      </tr>
                    `).join('')}
                    ${activities.length === 0 ? '<tr><td colspan="2" class="text-center text-muted">無活動記錄</td></tr>' : ''}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
        
        document.getElementById('reportResult').innerHTML = html;
      },
      
      print() {
        const content = document.getElementById('reportResult').innerHTML;
        if(!content.trim()) return Util.showToast('error', '請先產生報表');
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>報表列印</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
              @media print {
                .no-print { display: none !important; }
              }
              body { font-size: 12px; }
            </style>
          </head>
          <body class="p-3">
            ${content}
          </body>
          </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => printWindow.print(), 500);
      },
      
      export() {
        const content = document.getElementById('reportResult').innerHTML;
        if(!content.trim()) return Util.showToast('error', '請先產生報表');
        
        // 簡易匯出為 HTML
        const blob = new Blob([`
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>報表匯出</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
          </head>
          <body class="p-3">
            ${content}
          </body>
          </html>
        `], {type: 'text/html'});
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `報表_${new Date().toISOString().slice(0,10)}.html`;
        a.click();
        URL.revokeObjectURL(url);
      }
    };

    /* -------------------- 設定模組 -------------------- */
    const Settings = {
      load() {
        document.getElementById('organizationName').value = Store.data.settings.organizationName || '';
        document.getElementById('organizationAddress').value = Store.data.settings.organizationAddress || '';
        document.getElementById('organizationPhone').value = Store.data.settings.organizationPhone || '';
        document.getElementById('organizationEmail').value = Store.data.settings.organizationEmail || '';
        document.getElementById('defaultMembershipFee').value = Store.data.settings.defaultMembershipFee || 1000;
        document.getElementById('receiptPrefix').value = Store.data.settings.receiptPrefix || 'R';
        document.getElementById('voucherPrefix').value = Store.data.settings.voucherPrefix || 'V';
        document.getElementById('backupEnabled').checked = !!Store.data.settings.backupEnabled;
        document.getElementById('autoBackupDays').value = Store.data.settings.autoBackupDays || 7;
      },
      
      async save() {
        Store.data.settings = {
          ...Store.data.settings,
          organizationName: document.getElementById('organizationName').value.trim(),
          organizationAddress: document.getElementById('organizationAddress').value.trim(),
          organizationPhone: document.getElementById('organizationPhone').value.trim(),
          organizationEmail: document.getElementById('organizationEmail').value.trim(),
          defaultMembershipFee: Util.toNumber(document.getElementById('defaultMembershipFee').value),
          receiptPrefix: document.getElementById('receiptPrefix').value.trim() || 'R',
          voucherPrefix: document.getElementById('voucherPrefix').value.trim() || 'V',
          backupEnabled: document.getElementById('backupEnabled').checked,
          autoBackupDays: parseInt(document.getElementById('autoBackupDays').value) || 7,
          updatedAt: new Date().toISOString()
        };
        
        await Store.save('settings');
        Util.showToast('success', '設定已儲存');
      },
      
      async resetData() {
        const result = await Util.confirm({
          title: '重置所有資料',
          text: '此動作將清除所有資料且無法復原，確定要繼續嗎？',
          confirmColor: '#dc3545',
          confirmButtonText: '確定重置'
        });
        
        if(!result.isConfirmed) return;
        
        const secondConfirm = await Util.confirm({
          title: '最後確認',
          text: '請再次確認要重置所有資料？',
          confirmColor: '#dc3545',
          confirmButtonText: '我確定要重置'
        });
        
        if(!secondConfirm.isConfirmed) return;
        
        // 重置資料
        Store.data = {
          transactions: [],
          members: [],
          activities: [],
          registrations: [],
          announcements: [],
          forms: [],
          accounts: [],
          settings: {
            organizationName: '',
            organizationAddress: '',
            organizationPhone: '',
            organizationEmail: '',
            defaultMembershipFee: 1000,
            receiptPrefix: 'R',
            voucherPrefix: 'V',
            backupEnabled: true,
            autoBackupDays: 7,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          }
        };
        
        await Store.save();
        await Accounts.ensureDefaults();
        
        // 重新初始化頁面
        Dashboard.refresh();
        Transactions.renderTable();
        Members.renderTable();
        Activities.renderGrid();
        Announcements.render();
        Forms.render();
        this.load();
        
        Util.showToast('success', '資料已重置');
      }
    };

    /* -------------------- 資料匯入匯出 -------------------- */
    const DataPort = {
      async exportAll() {
        const data = {
          ...Store.data,
          exportTime: new Date().toISOString(),
          version: '1.0'
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `社團管理系統_完整備份_${Util.today()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        Util.showToast('success', '資料已匯出');
      },
      
      async importAll() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if(!file) return;
          
          try {
            const text = await file.text();
            const data = JSON.parse(text);
            
            // 簡易驗證
            if(!data.transactions || !data.members || !data.activities) {
              throw new Error('檔案格式不正確');
            }
            
            const result = await Util.confirm({
              title: '匯入資料',
              text: '此動作將覆蓋現有資料，確定要繼續嗎？',
              confirmColor: '#dc3545'
            });
            
            if(!result.isConfirmed) return;
            
            // 匯入資料
            Store.data = {
              transactions: data.transactions || [],
              members: data.members || [],
              activities: data.activities || [],
              registrations: data.registrations || [],
              announcements: data.announcements || [],
              forms: data.forms || [],
              accounts: data.accounts || [],
              settings: data.settings || Store.data.settings
            };
            
            await Store.save();
            
            // 重新整理頁面
            Dashboard.refresh();
            Transactions.renderTable();
            Members.renderTable();
            Activities.renderGrid();
            Announcements.render();
            Forms.render();
            Settings.load();
            
            Util.showToast('success', '資料已匯入');
          } catch(error) {
            Util.showToast('error', '匯入失敗: ' + error.message);
          }
        };
        input.click();
      },
      
      exportMembers(memberIds = null) {
        const members = memberIds ? 
          Store.data.members.filter(m => memberIds.includes(m.id)) : 
          Store.data.members;
        
        if(!members.length) return Util.showToast('error', '無會員資料');
        
        // 轉換為 CSV 格式
        const headers = ['姓名', '電話', 'Email', '出生日期', '性別', '身分證', '地址', '加入日期', '狀態', '類型', '年費', '最後繳費日', '標籤', '備註'];
        const rows = members.map(m => [
          m.name,
          m.phone,
          m.email || '',
          m.birthDate || '',
          m.gender || '',
          m.idNumber || '',
          m.address || '',
          m.joinDate,
          Members.statusText(m.status),
          Members.typeText(m.type),
          m.membershipFee || '',
          m.lastPaymentDate || '',
          (m.tags || []).join(';'),
          m.notes || ''
        ]);
        
        const csv = [headers, ...rows].map(row => 
          row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
        ).join('\n');
        
        const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `會員資料_${Util.today()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        Util.showToast('success', '會員資料已匯出');
      }
    };

    /* -------------------- 初始化 -------------------- */
    async function init() {
      try {
        // 載入資料
        await Store.load();
        
        // 確保預設帳戶
        await Accounts.ensureDefaults();
        
        // 初始化各模組
        Dashboard.refresh();
        Transactions.renderTable();
        Members.renderTable();
        Activities.renderGrid();
        Announcements.render();
        Forms.render();
        Settings.load();
        
        // 重新計算帳戶餘額
        Accounts.recalcBalances();
        
        // 初始化對象自動完成
        Counterparty.refreshDatalist();
        
        // 初始化分析圖表（如果頁面有載入 Chart.js）
        if(typeof Chart !== 'undefined') {
          Analytics.refresh();
        }
        
        console.log('社團管理系統初始化完成');
        
      } catch(error) {
        console.error('初始化失敗:', error);
        Util.showToast('error', '系統初始化失敗: ' + error.message);
      }
    }

    // 頁面載入完成後初始化
    if(document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // 全域函數（供 HTML 呼叫）
    window.App = {
      // 交易模組
      Transactions,
      TransactionUI,
      
      // 會員模組
      Members,
      MemberUI,
      
      // 活動模組
      Activities,
      ActivityUI,
      
      // 公告模組
      Announcements,
      AnnouncementUI,
      
      // 表單模組
      Forms,
      FormUI,
      
      // 帳戶模組
      Accounts,
      AccountUI,
      
      // 分析模組
      Analytics,
      
      // 報表模組
      Reports,
      
      // 設定模組
      Settings,
      
      // 資料匯入匯出
      DataPort,
      
      // 工具函數
      Util,
      Dashboard
    };

  })();

    </script>
</body>
</html>
