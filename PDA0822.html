
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <!-- 保持原有的 head 內容不變 -->
  <meta charset="UTF-8">
  <title>台灣帕金森病友權益促進會 - 會計暨營運整合管理系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="非營利組織整合：財務 / 會員 / 活動 / 公告 / 表單 / 雲端備份管理系統">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<style>
    :root {
      --primary:#2c5aa0;
      --primary-dark:#1e3d6f;
      --gradient-primary:linear-gradient(135deg,#2c5aa0,#4a90e2);
      --gradient-green:linear-gradient(135deg,#28a745,#20c997);
      --gradient-orange:linear-gradient(135deg,#ff9f40,#ffb347);
      --secondary-bg:#f8f9fa;
      --radius-lg:15px;
      --radius-md:10px;
      --radius-sm:6px;
    }
    body {
      background:var(--secondary-bg);
      font-family:"Microsoft JhengHei","Noto Sans TC",system-ui,sans-serif;
      font-size:14.5px;
    }
    .navbar-brand { font-weight:600; color:var(--primary)!important; }
    .sidebar {
      min-height:100vh;
      background:linear-gradient(180deg,#2c5aa0,#1e3d6f);
      color:#fff;
    }
    .sidebar .nav-link {
      color:rgba(255,255,255,.82);
      border-radius:8px;
      margin:3px 0;
      font-weight:500;
      transition:.25s;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background:rgba(255,255,255,0.12);
      color:#fff;
      transform:translateX(4px);
    }
    .content-section { animation:fadeIn .35s ease; }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(12px); }
      to { opacity:1; transform:translateY(0); }
    }
    .stat-card {
      background:var(--gradient-primary);
      color:#fff;
      border:none;
      border-radius:var(--radius-lg);
      box-shadow:0 4px 14px -4px rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
    }
    .stat-card.alt-green { background:var(--gradient-green); }
    .stat-card.alt-orange{ background:var(--gradient-orange); }
    .stat-card .icon-bg {
      position:absolute;
      right:-10px; top:-10px;
      font-size:72px;
      opacity:.16;
    }
    .card-hoverable { transition:.25s; border:none; border-radius:var(--radius-lg); }
    .card-hoverable:hover { transform:translateY(-4px); box-shadow:0 8px 24px -6px rgba(0,0,0,.15); }
    .table thead th { background:#f1f4f8; border-top:none; font-weight:600; }
    .badge-rounded { border-radius:20px; font-weight:500; letter-spacing:.5px; }
    .member-avatar, .participant-avatar {
      width:40px;height:40px;border-radius:50%;background:#fff;
      display:flex;align-items:center;justify-content:center;
      color:#666;font-weight:600;
      box-shadow:0 0 0 1px rgba(0,0,0,.05);
    }
    .small-avatar { width:32px;height:32px;font-size:12px; }
    .action-buttons .btn { padding:.25rem .5rem; }
    .voucher-preview img {
      max-width:100px;max-height:100px;object-fit:cover;border-radius:6px;margin:4px;cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    .loading-overlay {
      position:fixed; inset:0; z-index:2000;
      background:rgba(0,0,0,.45); display:flex;align-items:center;justify-content:center;
    }
    .pagination .page-link { border:none; border-radius:8px; color:var(--primary); }
    .pagination .page-item.active .page-link { background:var(--primary); }
    .chart-container { position:relative; height:380px; }
    .separator-title {
      font-size:15px;font-weight:600;margin:16px 0 10px;display:flex;align-items:center;gap:.5rem;
    }
    .separator-title:before, .separator-title:after {
      content:""; flex:1; height:1px; background:linear-gradient(90deg,#d0d3d9,#ffffff);
    }
    .form-download-item {
      border:1px solid #e2e6eb; padding:14px 16px; border-radius:var(--radius-md);
      background:#fff; position:relative; transition:.25s;
    }
    .form-download-item:hover { box-shadow:0 6px 18px -6px rgba(0,0,0,.15); transform:translateY(-3px); }
    .activity-card { border:none;border-radius:var(--radius-lg);overflow:hidden;box-shadow:0 3px 10px -2px rgba(0,0,0,.12);position:relative; }
    .activity-card .progress { height:6px; border-radius:3px; background:#e9ecef; overflow:hidden; }
    .activity-card .progress-bar { background:var(--gradient-green); }
    .announcement-card { border-left:5px solid #ffc107; border-radius:var(--radius-md); }
    .announcement-card.urgent { border-left-color:#dc3545; background:linear-gradient(135deg,#fff5f5,#ffffff); }
    .dual-col { columns:2 320px; column-gap:14px; }
    /* Batch import indicators */
    .row-invalid { background:#fff5f5!important; }
    .row-duplicate { background:#fff9e6!important; }
    .preview-status-badge { font-size:10px; }
    .mapping-select { width:100%; margin-bottom:6px; }
    /* Print friendly */
    @media print {
      .no-print, .sidebar, .navbar, .modal-backdrop { display:none!important; }
      body { background:#fff; }
      .main-content { margin:0!important; padding:0!important; }
      .card { box-shadow:none!important; }
    }
    /* Mobile */
    @media (max-width: 992px){
      .sidebar { position:fixed; left:0; top:0; transform:translateX(-100%); transition:.35s; z-index:1100; width:250px; }
      .sidebar.show { transform:translateX(0); }
    }
    /* Utility */
    .spin { animation:spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
    /* Seal / Receipt simplified container placeholder (styling improved in print module) */
    .receipt-seal-placeholder { width:60px; height:60px; border:2px solid #c00; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:#c00; }
  </style>
</head>
<body>
  <!-- 全螢幕載入遮罩 -->
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="text-center text-white">
      <div class="mb-3">
        <i class="bi bi-arrow-clockwise spin" style="font-size:48px;"></i>
      </div>
      <div>系統載入中，請稍候…</div>
    </div>
  </div>

  <!-- 同步指示
  <div class="position-fixed top-0 end-0 p-2 d-flex flex-column gap-1 no-print" style="z-index:1200;">
    <span id="syncIndicator" class="badge bg-success"><i class="bi bi-cloud-check"></i> 已同步</span>
    <span id="cloudIndicator" class="badge bg-info"><i class="bi bi-cloud"></i> 雲端未連線</span>
    <span id="offlineIndicator" class="badge bg-danger d-none"><i class="bi bi-wifi-off"></i> 離線</span>
  </div> -->

  <!-- 導覽列 -->
  <nav class="navbar navbar-expand-lg bg-white shadow-sm no-print">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <i class="bi bi-heart-pulse me-2"></i> 台灣帕金森病友權益促進會
      </a>
      <button class="navbar-toggler" type="button" onclick="AppLayout.toggleSidebar()">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item me-2">
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
              <input id="globalSearchInput" type="text" class="form-control" placeholder="全域搜尋 (交易 / 會員 / 活動 / 公告)" onkeydown="if(event.key==='Enter') GlobalSearch.exec()">
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle fw-semibold" href="#" data-bs-toggle="dropdown">
              <i class="bi bi-gear"></i> 系統
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" onclick="SettingsUI.open()"><i class="bi bi-sliders"></i> 系統設定</a></li>
              <li><a class="dropdown-item" href="#" onclick="AccountUI.openManager()"><i class="bi bi-bank"></i> 帳戶管理</a></li>
              <li><a class="dropdown-item" href="#" onclick="GoogleSync.open()"><i class="bi bi-cloud-arrow-up"></i> 雲端同步</a></li>
              <li><a class="dropdown-item" href="#" onclick="BatchImport.open('transactions')"><i class="bi bi-cloud-upload"></i> 批次匯入</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.exportAll()"><i class="bi bi-download"></i> 匯出資料</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.importAll()"><i class="bi bi-upload"></i> 匯入資料</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="Shortcuts.show()"><i class="bi bi-keyboard"></i> 快捷鍵</a></li>
              <li><a class="dropdown-item" href="#" onclick="About.show()"><i class="bi bi-info-circle"></i> 關於</a></li>
              <li><a class="dropdown-item" href="#" onclick="ConfirmReset.show()"><i class="bi bi-exclamation-triangle"></i> 系統重置</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- 側邊欄 -->
      <aside id="sidebar" class="sidebar col-lg-2 col-md-3 p-3">
        <h6 class="text-center mt-2 mb-4 fw-semibold">管理選單</h6>
        <nav class="nav flex-column">
          <a class="nav-link active" href="#" data-section="dashboard" onclick="AppLayout.showSection('dashboard',this)"><i class="bi bi-speedometer2 me-2"></i>儀表板</a>
          <a class="nav-link" href="#" data-section="transactions" onclick="AppLayout.showSection('transactions',this)"><i class="bi bi-receipt me-2"></i>交易記錄</a>
          <a class="nav-link" href="#" data-section="members" onclick="AppLayout.showSection('members',this)"><i class="bi bi-people me-2"></i>會員管理</a>
          <a class="nav-link" href="#" data-section="activities" onclick="AppLayout.showSection('activities',this)"><i class="bi bi-calendar-event me-2"></i>活動管理</a>
          <a class="nav-link" href="#" data-section="announcements" onclick="AppLayout.showSection('announcements',this)"><i class="bi bi-megaphone me-2"></i>公告管理</a>
          <a class="nav-link" href="#" data-section="forms" onclick="AppLayout.showSection('forms',this)"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單</a>
          <a class="nav-link" href="#" data-section="analytics" onclick="AppLayout.showSection('analytics',this)"><i class="bi bi-graph-up me-2"></i>統計分析</a>
          <a class="nav-link" href="#" data-section="reports" onclick="AppLayout.showSection('reports',this)"><i class="bi bi-file-earmark-text me-2"></i>報表中心</a>
        </nav>
      </aside>

      <!-- 主要內容 -->
      <main id="mainContent" class="col-lg-10 col-md-9 p-4">
        <!-- =========================================================
             PART 2/5  ─────────────  主內容各 Section
             ========================================================= -->

        <!-- 儀表板 -->
        <section id="dashboardSection" class="content-section">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>儀表板</h4>
            <div class="d-flex gap-2">
                <div class="d-flex gap-1 me-3">
                  <span id="syncIndicator" class="badge bg-success"><i class="bi bi-cloud-check"></i> 已同步</span>
                  <span id="cloudIndicator" class="badge bg-info"><i class="bi bi-cloud"></i> 雲端未連線</span>
                  <span id="offlineIndicator" class="badge bg-danger d-none"><i class="bi bi-wifi-off"></i> 離線</span>
                </div>
              <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
              <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
              <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
            </div>
          </div>

          <!-- 統計卡片列 -->
          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100">
                <div class="icon-bg"><i class="bi bi-cash-coin"></i></div>
                <small>總收入</small>
                <h3 id="dashTotalIncome" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">本月</span>
                  <span id="dashMonthIncome" class="small fw-semibold">$0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100 alt-orange">
                <div class="icon-bg"><i class="bi bi-credit-card-2-front"></i></div>
                <small>總支出</small>
                <h3 id="dashTotalExpense" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">本月</span>
                  <span id="dashMonthExpense" class="small fw-semibold">$0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100 alt-green">
                <div class="icon-bg"><i class="bi bi-bank"></i></div>
                <small>帳戶總餘額</small>
                <h3 id="dashTotalBalance" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">帳戶數</span>
                  <span id="dashAccountCount" class="small fw-semibold">0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100">
                <div class="icon-bg"><i class="bi bi-people"></i></div>
                <small>會員總數</small>
                <h3 id="dashMemberTotal" class="mb-1">0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">逾期會費</span>
                  <span id="dashMemberOverdue" class="badge bg-danger rounded-pill">0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 帳戶餘額 -->
          <div class="card card-hoverable mb-3">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h6 class="mb-0"><i class="bi bi-bank me-1"></i>帳戶餘額概覽</h6>
              <button class="btn btn-sm btn-outline-primary" onclick="AccountUI.openManager()"><i class="bi bi-gear"></i> 管理帳戶</button>
            </div>
            <div class="card-body">
              <div id="dashboardAccountBalances" class="row g-3">
                <!-- 動態填入 -->
              </div>
            </div>
          </div>

          <!-- 最新交易 / 最新會員 / 最新活動 -->
          <div class="row g-3">
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-arrows-expand me-1"></i>最近交易</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentTx">
                  <!-- 動態 -->
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-person-plus me-1"></i>新加入會員</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentMembers">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-calendar-event me-1"></i>近期活動</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentActivities">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 交易記錄 -->
        <section id="transactionsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-receipt me-2"></i>交易記錄</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="AdvancedSearch.open()"><i class="bi bi-search"></i> 進階搜尋</button>
              <button class="btn btn-outline-success btn-sm" onclick="BatchImport.open('transactions')"><i class="bi bi-cloud-upload"></i> 批次匯入</button>
              <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
            </div>
          </div>

          <div class="card card-hoverable mb-3">
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <div class="col-md-2">
                  <label class="form-label mb-1">年份</label>
                  <select id="txFilterYear" class="form-select form-select-sm" onchange="Transactions.renderTable()">
                    <option value="">全部</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label mb-1">月份</label>
                  <select id="txFilterMonth" class="form-select form-select-sm" onchange="Transactions.renderTable()">
                    <option value="">全部</option>
                    ${[...Array(12)].map((_,i)=>`<option value="${i+1}">${i+1}月</option>`).join('')}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label mb-1">類型</label>
                  <select id="txFilterType" class="form-select form-select-sm" onchange="Transactions.renderTable()">
                    <option value="">全部</option>
                    <option value="收入">收入</option>
                    <option value="支出">支出</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label mb-1">關鍵字</label>
                  <input id="txFilterKeyword" type="text" class="form-control form-control-sm" placeholder="類別 / 對象 / 說明 / 編號" oninput="Transactions.renderTable()">
                </div>
                <div class="col-md-2 d-grid">
                  <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportTransactions()"><i class="bi bi-download"></i> 匯出</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card card-hoverable">
            <div class="card-body">
              <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
                <div><span id="txRecordCount" class="fw-semibold">0 筆</span></div>
                <div class="d-flex gap-2">
                  <select id="txBatchAction" class="form-select form-select-sm">
                    <option value="">批次操作</option>
                    <option value="delete">刪除</option>
                    <option value="export">匯出</option>
                    <option value="print">列印收據</option>
                    <option value="voucher">列印憑證</option>
                  </select>
                  <button class="btn btn-outline-primary btn-sm" onclick="Transactions.batchAction()">
                    <i class="bi bi-check2-square"></i> 執行
                  </button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-2">
                  <thead>
                    <tr>
                      <th style="width:30px;"><input type="checkbox" id="txSelectAll" onclick="Transactions.toggleSelectAll(this)"></th>
                      <th>日期</th><th>類型</th><th>類別</th><th class="text-end">金額</th><th>對象</th><th>帳戶</th><th>說明</th><th>編號/附件</th><th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="txTableBody">
                    <tr><td colspan="10" class="text-center py-5 text-muted">
                      <i class="bi bi-inbox display-6 d-block mb-2"></i> 尚無資料
                    </td></tr>
                  </tbody>
                </table>
              </div>
              <nav class="d-flex justify-content-center">
                <ul id="txPagination" class="pagination pagination-sm mb-0"></ul>
              </nav>
            </div>
          </div>
        </section>

        <!-- 會員管理 -->
        <section id="membersSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-people me-2"></i>會員管理</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-success btn-sm" onclick="BatchImport.open('members')"><i class="bi bi-cloud-upload"></i> 批次匯入</button>
              <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
              <div class="card text-center card-hoverable p-2">
                <small class="text-muted">總會員</small>
                <h4 id="mStatTotal" class="mb-0">0</h4>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center card-hoverable p-2">
                <small class="text-muted">正常</small>
                <h4 id="mStatActive" class="text-success mb-0">0</h4>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center card-hoverable p-2">
                <small class="text-muted">逾期會費</small>
                <h4 id="mStatOverdue" class="text-danger mb-0">0</h4>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center card-hoverable p-2">
                <small class="text-muted">本月新增</small>
                <h4 id="mStatNew" class="mb-0">0</h4>
              </div>
            </div>
          </div>

          <div class="card card-hoverable mb-3">
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <div class="col-md-3">
                  <label class="form-label mb-1">狀態</label>
                  <select id="memberFilterStatus" class="form-select form-select-sm" onchange="Members.renderTable()">
                    <option value="">全部</option>
                    <option value="active">正常</option>
                    <option value="inactive">停權</option>
                    <option value="pending">待審核</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label mb-1">會員類型</label>
                  <select id="memberFilterType" class="form-select form-select-sm" onchange="Members.renderTable()">
                    <option value="">全部</option>
                    <option value="regular">一般會員</option>
                    <option value="honorary">榮譽會員</option>
                    <option value="life">終身會員</option>
                    <option value="family">家屬會員</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label mb-1">關鍵字</label>
                  <input id="memberFilterKeyword" type="text" class="form-control form-control-sm" placeholder="姓名 / 電話 / Email / 標籤" oninput="Members.renderTable()">
                </div>
                <div class="col-md-2 d-grid">
                  <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportMembers()"><i class="bi bi-download"></i> 匯出</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card card-hoverable">
            <div class="card-body">
              <div class="d-flex flex-wrap justify-content-between mb-2 gap-2">
                <span id="memberRecordCount" class="fw-semibold">0 筆記錄</span>
                <div class="d-flex gap-2">
                  <select id="memberBatchAction" class="form-select form-select-sm">
                    <option value="">批次操作</option>
                    <option value="delete">刪除</option>
                    <option value="export">匯出</option>
                    <option value="status-active">設為正常</option>
                    <option value="status-inactive">設為停權</option>
                  </select>
                  <button class="btn btn-outline-primary btn-sm" onclick="Members.batchAction()"><i class="bi bi-check2-square"></i> 執行</button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th style="width:30px;"><input type="checkbox" id="memberSelectAll" onclick="Members.toggleSelectAll(this)"></th>
                      <th>基本資料</th><th>聯絡</th><th>年齡/性別</th><th>加入</th><th>狀態</th><th>會費</th><th>標籤</th><th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="memberTableBody">
                    <tr><td colspan="9" class="text-center text-muted py-5">
                      <i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員資料
                    </td></tr>
                  </tbody>
                </table>
              </div>
              <nav class="d-flex justify-content-center">
                <ul id="memberPagination" class="pagination pagination-sm mb-0"></ul>
              </nav>
            </div>
          </div>
        </section>

        <!-- 活動管理 -->
        <section id="activitiesSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-calendar-event me-2"></i>活動管理</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportActivities()"><i class="bi bi-download"></i> 匯出</button>
              <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
              <div class="card p-2 text-center card-hoverable">
                <small class="text-muted">總活動數</small>
                <h5 id="actStatTotal" class="mb-0">0</h5>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card p-2 text-center card-hoverable">
                <small class="text-muted">報名中</small>
                <h5 id="actStatOpen" class="mb-0 text-success">0</h5>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card p-2 text-center card-hoverable">
                <small class="text-muted">即將開始(7日)</small>
                <h5 id="actStatUpcoming" class="mb-0">0</h5>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card p-2 text-center card-hoverable">
                <small class="text-muted">總報名</small>
                <h5 id="actStatRegistrations" class="mb-0">0</h5>
              </div>
            </div>
          </div>

          <div class="card card-hoverable mb-3">
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <div class="col-md-2">
                  <label class="form-label mb-1">狀態</label>
                  <select id="actFilterStatus" class="form-select form-select-sm" onchange="Activities.renderGrid()">
                    <option value="">全部</option>
                    <option value="draft">草稿</option>
                    <option value="published">已發布</option>
                    <option value="registration">報名中</option>
                    <option value="full">已額滿</option>
                    <option value="closed">已結束</option>
                    <option value="cancelled">已取消</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label mb-1">類型</label>
                  <select id="actFilterType" class="form-select form-select-sm" onchange="Activities.renderGrid()">
                    <option value="">全部</option>
                    <option value="講座">講座</option>
                    <option value="聚會">聚會</option>
                    <option value="旅遊">旅遊</option>
                    <option value="運動">運動</option>
                    <option value="志工">志工服務</option>
                    <option value="其他">其他</option>
                  </select>
                </div>
                <div class="col-md-5">
                  <label class="form-label mb-1">關鍵字</label>
                  <input id="actFilterKeyword" type="text" class="form-control form-control-sm" placeholder="名稱 / 地點 / 描述" oninput="Activities.renderGrid()">
                </div>
                <div class="col-md-3">
                  <label class="form-label mb-1">排序</label>
                  <select id="actFilterSort" class="form-select form-select-sm" onchange="Activities.renderGrid()">
                    <option value="date_desc">日期(新→舊)</option>
                    <option value="date_asc">日期(舊→新)</option>
                    <option value="name_asc">名稱</option>
                    <option value="regs_desc">報名多→少</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div id="activitiesGrid" class="row g-4">
            <div class="col-12 text-center py-5 text-muted">
              <i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動
            </div>
          </div>
          <nav class="d-flex justify-content-center mt-3">
            <ul id="actPagination" class="pagination pagination-sm mb-0"></ul>
          </nav>
        </section>

        <!-- 公告管理 -->
        <section id="announcementsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-megaphone me-2"></i>公告管理</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportAnnouncements()"><i class="bi bi-download"></i> 匯出</button>
              <button class="btn btn-warning btn-sm" onclick="AnnouncementUI.open()"><i class="bi bi-plus-circle"></i> 新增公告</button>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-6 col-md-4">
              <div class="card p-2 text-center card-hoverable">
                <small class="text-muted">公告總數</small>
                <h5 id="annStatTotal" class="mb-0">0</h5>
              </div>
            </div>
            <div class="col-6 col-md-4">
              <div class="card p-2 text-center card-hoverable">
                <small class="text-muted">有效公告</small>
                <h5 id="annStatActive" class="text-success mb-0">0</h5>
              </div>
            </div>
            <div class="col-6 col-md-4">
              <div class="card p-2 text-center card-hoverable">
                <small class="text-muted">緊急公告</small>
                <h5 id="annStatUrgent" class="text-danger mb-0">0</h5>
              </div>
            </div>
          </div>

          <div class="card card-hoverable mb-3">
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <div class="col-md-3">
                  <label class="form-label mb-1">狀態</label>
                  <select id="annFilterStatus" class="form-select form-select-sm" onchange="Announcements.render()">
                    <option value="">全部</option>
                    <option value="draft">草稿</option>
                    <option value="published">已發布</option>
                    <option value="expired">已過期</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label mb-1">類型</label>
                  <select id="annFilterType" class="form-select form-select-sm" onchange="Announcements.render()">
                    <option value="">全部</option>
                    <option value="normal">一般</option>
                    <option value="urgent">緊急</option>
                    <option value="event">活動相關</option>
                    <option value="system">系統公告</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label mb-1">關鍵字</label>
                  <input id="annFilterKeyword" type="text" class="form-control form-control-sm" placeholder="標題 / 內容關鍵字" oninput="Announcements.render()">
                </div>
              </div>
            </div>
          </div>

          <div id="announcementsGrid" class="row g-4">
            <div class="col-12 text-center py-5 text-muted">
              <i class="bi bi-megaphone display-6 d-block mb-2"></i> 尚無公告
            </div>
          </div>
          <nav class="d-flex justify-content-center mt-3">
            <ul id="annPagination" class="pagination pagination-sm mb-0"></ul>
          </nav>
        </section>

        <!-- 行政表單 -->
        <section id="formsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單下載</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-primary btn-sm" onclick="FormUI.openManager()"><i class="bi bi-gear"></i> 管理表單</button>
            </div>
          </div>

          <div class="card card-hoverable mb-3">
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <div class="col-md-8">
                  <label class="form-label mb-1">關鍵字</label>
                  <input id="formFilterKeyword" type="text" class="form-control form-control-sm" placeholder="搜尋表單名稱 / 關鍵字" oninput="Forms.render()">
                </div>
                <div class="col-md-4">
                  <label class="form-label mb-1">分類</label>
                  <select id="formFilterCategory" class="form-select form-select-sm" onchange="Forms.render()">
                    <option value="">全部</option>
                    <option value="會員">會員相關</option>
                    <option value="財務">財務相關</option>
                    <option value="活動">活動相關</option>
                    <option value="行政">行政相關</option>
                    <option value="其他">其他</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div id="formsList" class="row g-3">
            <div class="col-12 text-center py-5 text-muted">
              <i class="bi bi-file-earmark-arrow-down display-6 d-block mb-2"></i> 尚無表單
            </div>
          </div>
        </section>

        <!-- 統計分析 -->
        <section id="analyticsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-graph-up me-2"></i>統計分析</h4>
            <div>
              <select id="analyticsYear" class="form-select form-select-sm d-inline-block w-auto" onchange="Analytics.refresh()">
                <option value="">選擇年份</option>
              </select>
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
              <div class="card text-center p-2 card-hoverable">
                <small>年度收入</small>
                <h5 id="anaTotalIncome" class="text-success mb-0">$0</h5>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center p-2 card-hoverable">
                <small>年度支出</small>
                <h5 id="anaTotalExpense" class="text-danger mb-0">$0</h5>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center p-2 card-hoverable">
                <small>年度結餘</small>
                <h5 id="anaBalance" class="mb-0">$0</h5>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center p-2 card-hoverable">
                <small>平均月度</small>
                <h5 id="anaAvgMonthly" class="mb-0">$0</h5>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-6">
              <div class="card card-hoverable">
                <div class="card-header bg-white"><h6 class="mb-0">收支趨勢</h6></div>
                <div class="card-body">
                  <div class="chart-container"><canvas id="chartTrend"></canvas></div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card card-hoverable">
                <div class="card-header bg-white"><h6 class="mb-0">支出類別占比</h6></div>
                <div class="card-body">
                  <div class="chart-container"><canvas id="chartExpenseCategory"></canvas></div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card card-hoverable">
                <div class="card-header bg-white"><h6 class="mb-0">月度收支對比</h6></div>
                <div class="card-body">
                  <div class="chart-container"><canvas id="chartMonthlyCompare"></canvas></div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card card-hoverable">
                <div class="card-header bg-white"><h6 class="mb-0">會員成長趨勢</h6></div>
                <div class="card-body">
                  <div class="chart-container"><canvas id="chartMemberGrowth"></canvas></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 報表中心 -->
        <section id="reportsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>報表中心</h4>
            <div class="d-flex gap-2">
              <input id="reportStart" type="date" class="form-control form-control-sm">
              <input id="reportEnd" type="date" class="form-control form-control-sm">
              <button class="btn btn-primary btn-sm" onclick="Reports.quickDate('thisMonth')">本月</button>
              <button class="btn btn-outline-primary btn-sm" onclick="Reports.quickDate('thisYear')">今年</button>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <div class="card card-hoverable h-100">
                <div class="card-body text-center">
                  <i class="bi bi-cash-stack display-5 text-primary mb-2"></i>
                  <h6 class="fw-semibold">現金出納帳</h6>
                  <p class="small text-muted">現金帳戶收支逐筆紀錄</p>
                  <button class="btn btn-primary btn-sm" onclick="Reports.generate('cashbook')"><i class="bi bi-download"></i> 生成</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-hoverable h-100">
                <div class="card-body text-center">
                  <i class="bi bi-bar-chart-line display-5 text-success mb-2"></i>
                  <h6 class="fw-semibold">收支決算表</h6>
                  <p class="small text-muted">期間收入支出與結餘</p>
                  <button class="btn btn-success btn-sm" onclick="Reports.generate('incomeExpense')"><i class="bi bi-download"></i> 生成</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-hoverable h-100">
                <div class="card-body text-center">
                  <i class="bi bi-building display-5 text-warning mb-2"></i>
                  <h6 class="fw-semibold">資產負債表</h6>
                  <p class="small text-muted">截至日期財務結構</p>
                  <button class="btn btn-warning btn-sm" onclick="Reports.generate('balanceSheet')"><i class="bi bi-download"></i> 生成</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-hoverable h-100">
                <div class="card-body text-center">
                  <i class="bi bi-journal-text display-5 text-info mb-2"></i>
                  <h6 class="fw-semibold">年度分類帳</h6>
                  <p class="small text-muted">各類別借貸彙總</p>
                  <button class="btn btn-info btn-sm text-white" onclick="Reports.generate('ledger')"><i class="bi bi-download"></i> 生成</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-hoverable h-100">
                <div class="card-body text-center">
                  <i class="bi bi-list-ul display-5 text-secondary mb-2"></i>
                  <h6 class="fw-semibold">綜合流水帳</h6>
                  <p class="small text-muted">所有交易明細列表</p>
                  <button class="btn btn-secondary btn-sm" onclick="Reports.generate('journal')"><i class="bi bi-download"></i> 生成</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-hoverable h-100">
                <div class="card-body text-center">
                  <i class="bi bi-people-fill display-5 text-dark mb-2"></i>
                  <h6 class="fw-semibold">會員報表</h6>
                  <p class="small text-muted">會員結構統計</p>
                  <button class="btn btn-dark btn-sm" onclick="Reports.generate('member')"><i class="bi bi-download"></i> 生成</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- =========================================================
             PART 3/5  ─────────────  MODALS
             ========================================================= -->

        <!-- 交易 Modal -->
        <div class="modal fade" id="transactionModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h6 class="modal-title"><i class="bi bi-receipt me-2"></i><span id="txModalTitle">新增交易</span></h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="txForm">
                  <input type="hidden" id="txId">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">日期 *</label>
                      <input id="txDate" type="date" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">類型 *</label>
                      <select id="txType" class="form-select" required onchange="TransactionUI.onTypeChange()">
                        <option value="">請選擇</option>
                        <option value="收入">收入</option>
                        <option value="支出">支出</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">帳戶 *</label>
                      <select id="txAccount" class="form-select" required></select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">類別 *</label>
                      <select id="txCategory" class="form-select" required></select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">金額 *</label>
                      <input id="txAmount" type="number" min="0" step="1" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">對象</label>
                      <input id="txCounterparty" type="text" class="form-control" list="counterpartyDatalist">
                      <datalist id="counterpartyDatalist"></datalist>
                    </div>
                    <div class="col-12">
                      <label class="form-label">說明</label>
                      <textarea id="txDescription" rows="2" class="form-control" placeholder="可留空"></textarea>
                    </div>
                    <div class="col-md-6">
                      <label id="txNumberLabel" for="txNumber" class="form-label">收據編號</label>
                      <input id="txNumber" type="text" class="form-control" placeholder="自動帶入，可覆寫">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">附件(憑證) 上傳</label>
                      <input id="txVouchers" type="file" class="form-control" multiple accept="image/*,application/pdf" onchange="TransactionUI.handleVoucherUpload(event)">
                      <div class="form-text">支援多檔：圖片 / PDF</div>
                    </div>
                    <div class="col-12">
                      <div id="txVoucherPreview" class="voucher-preview"></div>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-primary btn-sm" onclick="TransactionUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 會員 Modal -->
        <div class="modal fade" id="memberModal" tabindex="-1">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-success text-white">
                <h6 class="modal-title"><i class="bi bi-person me-2"></i><span id="memberModalTitle">新增會員</span></h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="memberForm">
                  <input type="hidden" id="memberId">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <h6 class="fw-semibold">基本資料</h6>
                      <label class="form-label mt-2">姓名 *</label>
                      <input id="memberName" class="form-control" required>
                      <label class="form-label mt-2">電話 *</label>
                      <input id="memberPhone" class="form-control" required>
                      <label class="form-label mt-2">電子郵件</label>
                      <input id="memberEmail" type="email" class="form-control">
                      <div class="row mt-2 g-2">
                        <div class="col-6">
                          <label class="form-label">出生日期</label>
                          <input id="memberBirthDate" type="date" class="form-control">
                        </div>
                        <div class="col-6">
                          <label class="form-label">性別</label>
                          <select id="memberGender" class="form-select">
                            <option value="">未指定</option>
                            <option value="男">男</option>
                            <option value="女">女</option>
                            <option value="其他">其他</option>
                          </select>
                        </div>
                      </div>
                      <label class="form-label mt-2">身分證字號</label>
                      <input id="memberIdNumber" maxlength="10" class="form-control">
                    </div>
                    <div class="col-md-4">
                      <h6 class="fw-semibold">聯絡資訊</h6>
                      <label class="form-label mt-2">地址</label>
                      <textarea id="memberAddress" rows="3" class="form-control"></textarea>
                      <label class="form-label mt-2">緊急聯絡人</label>
                      <input id="emergencyContact" class="form-control">
                      <label class="form-label mt-2">緊急聯絡電話</label>
                      <input id="emergencyPhone" class="form-control">
                      <label class="form-label mt-2">備註</label>
                      <textarea id="memberNotes" rows="3" class="form-control"></textarea>
                    </div>
                    <div class="col-md-4">
                      <h6 class="fw-semibold">會員資訊</h6>
                      <label class="form-label mt-2">加入日期 *</label>
                      <input id="memberJoinDate" type="date" class="form-control" required>
                      <label class="form-label mt-2">狀態</label>
                      <select id="memberStatus" class="form-select">
                        <option value="active">正常</option>
                        <option value="inactive">停權</option>
                        <option value="pending">待審核</option>
                      </select>
                      <label class="form-label mt-2">會員類型</label>
                      <select id="memberType" class="form-select">
                        <option value="regular">一般會員</option>
                        <option value="honorary">榮譽會員</option>
                        <option value="life">終身會員</option>
                        <option value="family">家屬會員</option>
                      </select>
                      <label class="form-label mt-2">年費金額</label>
                      <input id="membershipFee" type="number" class="form-control" value="1000" min="0">
                      <label class="form-label mt-2">最後繳費日期</label>
                      <input id="lastPaymentDate" type="date" class="form-control">
                      <label class="form-label mt-2">標籤（逗號分隔）</label>
                      <input id="memberTags" class="form-control" placeholder="例：病友,志工">
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-success btn-sm" onclick="MemberUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 會員詳情 Modal -->
        <div class="modal fade" id="memberDetailModal" tabindex="-1">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-dark text-white">
                <h6 class="modal-title"><i class="bi bi-person-badge me-2"></i>會員詳情</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="memberDetailContent">
                <!-- 動態填入 -->
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-success btn-sm" onclick="Members.recordFee()"><i class="bi bi-credit-card"></i> 紀錄繳費</button>
                <button class="btn btn-outline-primary btn-sm" onclick="Members.printCard()"><i class="bi bi-printer"></i> 會員卡</button>
                <button class="btn btn-primary btn-sm" onclick="MemberUI.editFromDetail()"><i class="bi bi-pencil"></i> 編輯</button>
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 活動 Modal -->
        <div class="modal fade" id="activityModal" tabindex="-1">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-info text-white">
                <h6 class="modal-title"><i class="bi bi-calendar-event me-2"></i><span id="activityModalTitle">新增活動</span></h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="activityForm">
                  <input type="hidden" id="activityId">
                  <div class="row g-3">
                    <div class="col-lg-8">
                      <label class="form-label">活動名稱 *</label>
                      <input id="activityName" class="form-control" required>
                      <div class="row g-2 mt-2">
                        <div class="col-md-6">
                          <label class="form-label">活動類型 *</label>
                          <select id="activityType" class="form-select" required>
                            <option value="">選擇</option>
                            <option value="講座">講座</option>
                            <option value="聚會">聚會</option>
                            <option value="旅遊">旅遊</option>
                            <option value="運動">運動</option>
                            <option value="志工">志工服務</option>
                            <option value="其他">其他</option>
                          </select>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">狀態</label>
                          <select id="activityStatus" class="form-select">
                            <option value="draft">草稿</option>
                            <option value="published">已發布</option>
                            <option value="registration">報名中</option>
                            <option value="full">已額滿</option>
                            <option value="closed">已結束</option>
                            <option value="cancelled">已取消</option>
                          </select>
                        </div>
                      </div>
                      <div class="row g-2 mt-2">
                        <div class="col-md-6">
                          <label class="form-label">活動日期 *</label>
                          <input id="activityDate" type="date" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">活動時間</label>
                          <input id="activityTime" type="time" class="form-control">
                        </div>
                      </div>
                      <div class="row g-2 mt-2">
                        <div class="col-md-6">
                          <label class="form-label">報名開始</label>
                          <input id="regStartDate" type="date" class="form-control">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">報名截止</label>
                          <input id="regEndDate" type="date" class="form-control">
                        </div>
                      </div>
                      <label class="form-label mt-2">地點</label>
                      <input id="activityLocation" class="form-control" placeholder="可留空">
                      <label class="form-label mt-2">活動描述</label>
                      <textarea id="activityDescription" rows="4" class="form-control"></textarea>
                    </div>
                    <div class="col-lg-4">
                      <label class="form-label">活動圖片</label>
                      <input id="activityImage" type="file" accept="image/*" class="form-control" onchange="ActivityUI.previewImage(event)">
                      <div id="activityImagePreview" class="mt-2"></div>
                      <div class="row g-2 mt-1">
                        <div class="col-6">
                          <label class="form-label mt-2">人數上限</label>
                          <input id="activityMax" type="number" min="1" value="50" class="form-control">
                        </div>
                        <div class="col-6">
                          <label class="form-label mt-2">費用</label>
                          <input id="activityFee" type="number" min="0" value="0" class="form-control">
                        </div>
                      </div>
                      <label class="form-label mt-2">聯絡人</label>
                      <input id="activityContact" class="form-control">
                      <label class="form-label mt-2">聯絡電話</label>
                      <input id="activityContactPhone" class="form-control">
                      <label class="form-label mt-2">備註</label>
                      <textarea id="activityNotes" rows="3" class="form-control"></textarea>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 活動詳情 -->
        <div class="modal fade" id="activityDetailModal" tabindex="-1">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-info text-white">
                <h6 class="modal-title"><i class="bi bi-info-circle me-2"></i>活動詳情</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="activityDetailContent"></div>
              <div class="modal-footer">
                <button id="activityRegisterBtn" class="btn btn-success btn-sm" onclick="Registrations.openRegister()" style="display:none;"><i class="bi bi-person-plus"></i> 我要報名</button>
                <button class="btn btn-outline-primary btn-sm" onclick="ActivityUI.editFromDetail()"><i class="bi bi-pencil"></i> 編輯</button>
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 活動報名 -->
        <div class="modal fade" id="registrationModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-success text-white">
                <h6 class="modal-title"><i class="bi bi-person-plus me-2"></i>活動報名</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div id="registrationActivityInfo" class="alert alert-info small mb-3"></div>
                <form id="registrationForm">
                  <input type="hidden" id="registrationActivityId">
                  <div class="mb-2 fw-semibold">報名身份</div>
                  <div class="d-flex gap-3 mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="regType" id="regExisting" value="existing" checked onchange="Registrations.toggleMode()">
                      <label class="form-check-label" for="regExisting">現有會員</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="regType" id="regNew" value="new" onchange="Registrations.toggleMode()">
                      <label class="form-check-label" for="regNew">新報名者</label>
                    </div>
                  </div>
                  <div id="regExistingBox" class="mb-3">
                    <label class="form-label">選擇會員 *</label>
                    <select id="regMemberSelect" class="form-select"></select>
                  </div>
                  <div id="regNewBox" class="mb-3" style="display:none;">
                    <div class="row g-2">
                      <div class="col-md-6">
                        <label class="form-label">姓名 *</label>
                        <input id="regName" class="form-control">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">電話 *</label>
                        <input id="regPhone" class="form-control">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input id="regEmail" type="email" class="form-control">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">緊急聯絡人</label>
                        <input id="regEmergency" class="form-control">
                      </div>
                    </div>
                  </div>
                  <label class="form-label">備註 / 特殊需求</label>
                  <textarea id="regNotes" rows="2" class="form-control" placeholder="飲食限制 / 行動協助等"></textarea>
                  <div class="form-check mt-3">
                    <input id="regAgree" type="checkbox" class="form-check-input">
                    <label for="regAgree" class="form-check-label">我同意活動條款並確認資料正確</label>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-success btn-sm" onclick="Registrations.submit()"><i class="bi bi-check-circle me-1"></i>送出</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 公告 Modal -->
        <div class="modal fade" id="announcementModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-warning">
                <h6 class="modal-title"><i class="bi bi-megaphone me-2"></i><span id="announcementModalTitle">新增公告</span></h6>
                <button class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="announcementForm">
                  <input type="hidden" id="announcementId">
                  <label class="form-label">標題 *</label>
                  <input id="announcementTitle" class="form-control" required>
                  <div class="row g-2 mt-2">
                    <div class="col-md-4">
                      <label class="form-label">類型</label>
                      <select id="announcementType" class="form-select">
                        <option value="normal">一般</option>
                        <option value="urgent">緊急</option>
                        <option value="event">活動相關</option>
                        <option value="system">系統公告</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">狀態</label>
                      <select id="announcementStatus" class="form-select">
                        <option value="draft">草稿</option>
                        <option value="published">已發布</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">置頂</label>
                      <div class="form-check">
                        <input id="announcementPinned" type="checkbox" class="form-check-input">
                        <label class="form-check-label" for="announcementPinned">置頂公告</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label mt-2">發布日期</label>
                      <input id="announcementPublishDate" type="date" class="form-control">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label mt-2">過期日期</label>
                      <input id="announcementExpireDate" type="date" class="form-control">
                    </div>
                  </div>
                  <label class="form-label mt-2">內容 *</label>
                  <textarea id="announcementContent" rows="6" class="form-control" required></textarea>
                  <label class="form-label mt-2">相關連結</label>
                  <input id="announcementLink" type="url" class="form-control" placeholder="https://">
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-warning btn-sm" onclick="AnnouncementUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 帳戶管理 Modal -->
        <div class="modal fade" id="accountManagerModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h6 class="modal-title"><i class="bi bi-bank me-2"></i>帳戶管理</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="d-flex justify-content-end mb-2">
                  <button class="btn btn-sm btn-primary" onclick="AccountUI.openEditor()"><i class="bi bi-plus-circle"></i> 新增帳戶</button>
                </div>
                <div class="table-responsive">
                  <table class="table table-hover align-middle">
                    <thead>
                      <tr>
                        <th>名稱</th><th>說明</th><th class="text-end">初始</th><th class="text-end">目前</th><th>狀態</th><th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="accountTableBody">
                      <tr><td colspan="6" class="text-center text-muted py-4">尚無帳戶</td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="small text-muted">提示：有交易的帳戶不可刪除，可改停用。</div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 帳戶編輯 Modal -->
        <div class="modal fade" id="accountEditModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h6 class="modal-title"><i class="bi bi-wallet2 me-2"></i><span id="accountEditTitle">新增帳戶</span></h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="accountForm">
                  <input type="hidden" id="accountId">
                  <label class="form-label">帳戶名稱 *</label>
                  <input id="accountName" class="form-control" required>
                  <label class="form-label mt-2">說明</label>
                  <textarea id="accountDesc" rows="2" class="form-control"></textarea>
                  <label class="form-label mt-2">初始餘額</label>
                  <input id="accountInitial" type="number" step="0.01" value="0" class="form-control">
                  <label class="form-label mt-2">備註</label>
                  <textarea id="accountNotes" rows="2" class="form-control"></textarea>
                  <div class="form-check mt-2">
                    <input id="accountActive" type="checkbox" class="form-check-input" checked>
                    <label class="form-check-label" for="accountActive">啟用帳戶</label>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-primary btn-sm" onclick="AccountUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 行政表單管理 Modal -->
        <div class="modal fade" id="formManagerModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h6 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>表單管理</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="d-flex justify-content-end mb-2">
                  <button class="btn btn-sm btn-primary" onclick="FormUI.openEditor()"><i class="bi bi-plus-circle"></i> 新增表單</button>
                </div>
                <div class="table-responsive">
                  <table class="table table-hover align-middle">
                    <thead>
                      <tr>
                        <th>名稱</th><th>分類</th><th>連結</th><th>關鍵字</th><th>狀態</th><th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="formTableBody">
                      <tr><td colspan="6" class="text-center text-muted py-4">尚無表單</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 表單編輯 Modal -->
        <div class="modal fade" id="formEditModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h6 class="modal-title"><i class="bi bi-file-plus me-2"></i><span id="formEditTitle">新增表單</span></h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="formEditForm">
                  <input type="hidden" id="formId">
                  <label class="form-label">名稱 *</label>
                  <input id="formName" class="form-control" required>
                  <label class="form-label mt-2">分類 *</label>
                  <select id="formCategory" class="form-select" required>
                    <option value="">選擇</option>
                    <option value="會員">會員</option>
                    <option value="財務">財務</option>
                    <option value="活動">活動</option>
                    <option value="行政">行政</option>
                    <option value="其他">其他</option>
                  </select>
                  <label class="form-label mt-2">檔案連結 *</label>
                  <input id="formUrl" type="url" class="form-control" placeholder="https://" required>
                  <label class="form-label mt-2">關鍵字 (逗號)</label>
                  <input id="formKeywords" class="form-control">
                  <label class="form-label mt-2">說明</label>
                  <textarea id="formDescription" rows="3" class="form-control"></textarea>
                  <div class="form-check mt-2">
                    <input id="formActive" type="checkbox" class="form-check-input" checked>
                    <label class="form-check-label" for="formActive">啟用</label>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-primary btn-sm" onclick="FormUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 系統設定 Modal -->
        <div class="modal fade" id="settingsModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h6 class="modal-title"><i class="bi bi-sliders me-2"></i>系統設定</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="settingsForm" class="row gy-3">
                  <div class="col-md-6">
                    <h6 class="fw-semibold mb-2">組織資訊</h6>
                    <label class="form-label">組織名稱</label>
                    <input id="setOrgName" class="form-control">
                    <label class="form-label mt-2">地址</label>
                    <textarea id="setOrgAddress" rows="2" class="form-control"></textarea>
                    <label class="form-label mt-2">電話</label>
                    <input id="setOrgPhone" class="form-control">
                    <label class="form-label mt-2">Email</label>
                    <input id="setOrgEmail" type="email" class="form-control">
                    <label class="form-label mt-2">預設年費</label>
                    <input id="setDefaultFee" type="number" class="form-control" value="1000" min="0">
                  </div>
                  <div class="col-md-6">
                    <h6 class="fw-semibold mb-2">系統 / 編號 / 印章</h6>
                    <label class="form-label">收據前綴</label>
                    <input id="setReceiptPrefix" class="form-control" maxlength="5">
                    <label class="form-label mt-2">憑證前綴</label>
                    <input id="setVoucherPrefix" class="form-control" maxlength="5">
                    <label class="form-label mt-2">出納章文字</label>
                    <input id="setSealTreasurer" class="form-control">
                    <label class="form-label mt-2">會計章文字</label>
                    <input id="setSealAccountant" class="form-control">
                    <label class="form-label mt-2">理事長章文字</label>
                    <input id="setSealChairman" class="form-control">
                    <div class="form-check mt-3">
                      <input id="setAutoBackup" type="checkbox" class="form-check-input">
                      <label for="setAutoBackup" class="form-check-label">啟用自動備份</label>
                    </div>
                    <div class="form-check mt-2">
                      <input id="setNotifications" type="checkbox" class="form-check-input">
                      <label for="setNotifications" class="form-check-label">啟用通知提醒</label>
                    </div>
                  </div>

                  <div class="col-12">
                    <h6 class="fw-semibold mt-3 mb-2">交易類別管理</h6>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <div class="border p-2 rounded">
                          <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-semibold">收入類別</span>
                            <div class="input-group input-group-sm" style="width:180px;">
                              <input id="newIncomeCat" class="form-control" placeholder="新增">
                              <button class="btn btn-outline-primary" onclick="SettingsUI.addCategory('收入')">+</button>
                            </div>
                          </div>
                          <div id="incomeCategoryList" class="d-flex flex-wrap gap-1"></div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="border p-2 rounded">
                          <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-semibold">支出類別</span>
                            <div class="input-group input-group-sm" style="width:180px;">
                              <input id="newExpenseCat" class="form-control" placeholder="新增">
                              <button class="btn btn-outline-primary" onclick="SettingsUI.addCategory('支出')">+</button>
                            </div>
                          </div>
                          <div id="expenseCategoryList" class="d-flex flex-wrap gap-1"></div>
                        </div>
                      </div>
                    </div>
                    <div class="small text-muted mt-2">點擊標籤可刪除類別（刪除不影響既有交易，但建議先確認不再使用）。</div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-danger btn-sm me-auto" onclick="SettingsUI.resetCategoryConfirm()">重置預設類別</button>
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-primary btn-sm" onclick="SettingsUI.save()"><i class="bi bi-save me-1"></i>儲存設定</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 批次匯入 Modal -->
        <div class="modal fade" id="batchImportModal" tabindex="-1">
          <div class="modal-dialog modal-fullscreen-lg-down modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-secondary text-white">
                <h6 class="modal-title"><i class="bi bi-cloud-upload me-2"></i>批次匯入</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <ul class="nav nav-tabs" id="batchTabs">
                  <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#batchTxnTab">交易匯入</button>
                  </li>
                  <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#batchMemberTab">會員匯入</button>
                  </li>
                </ul>
                <div class="tab-content pt-3">
                  <!-- 交易匯入 -->
                  <div id="batchTxnTab" class="tab-pane fade show active">
                    <div class="row g-3">
                      <div class="col-lg-3">
                        <div class="border p-3 rounded h-100">
                          <h6 class="fw-semibold mb-2"><i class="bi bi-file-earmark-spreadsheet"></i> 上傳檔案</h6>
                          <input id="batchTxFile" type="file" accept=".xlsx,.xls,.csv" class="form-control form-control-sm mb-2" onchange="BatchImport.handleFile('transactions')">
                          <div class="d-grid gap-2 mb-2">
                            <button class="btn btn-outline-secondary btn-sm" onclick="BatchImport.downloadTemplate('transactions')"><i class="bi bi-download"></i> 範本</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="BatchImport.reparse('transactions')"><i class="bi bi-arrow-clockwise"></i> 重新解析</button>
                            <button class="btn btn-outline-danger btn-sm" onclick="BatchImport.clear('transactions')"><i class="bi bi-x-circle"></i> 清除</button>
                          </div>
                          <hr>
                          <h6 class="fw-semibold mb-2"><i class="bi bi-link"></i> 欄位對應</h6>
                          <div id="batchTxFieldMap" class="small"></div>
                          <hr>
                          <div class="form-check">
                            <input id="batchTxSkipError" type="checkbox" class="form-check-input" checked>
                            <label class="form-check-label" for="batchTxSkipError">略過錯誤列</label>
                          </div>
                          <div class="form-check">
                            <input id="batchTxSkipDup" type="checkbox" class="form-check-input" checked>
                            <label class="form-check-label" for="batchTxSkipDup">略過重複</label>
                          </div>
                        </div>
                      </div>
                      <div class="col-lg-9">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <span id="batchTxStats" class="badge bg-secondary">尚未載入資料</span>
                          <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-warning" onclick="BatchImport.filterPreview('transactions','errors')"><i class="bi bi-exclamation-triangle"></i> 錯誤</button>
                            <button class="btn btn-sm btn-outline-info" onclick="BatchImport.filterPreview('transactions','duplicates')"><i class="bi bi-files"></i> 重複</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="BatchImport.filterPreview('transactions','all')"><i class="bi bi-list-ul"></i> 全部</button>
                            <button class="btn btn-sm btn-success" onclick="BatchImport.commit('transactions')"><i class="bi bi-check-circle"></i> 匯入</button>
                          </div>
                        </div>
                        <div class="table-responsive" style="max-height:420px;overflow:auto;">
                          <table class="table table-sm table-hover align-middle mb-0">
                            <thead id="batchTxHead" class="table-light"></thead>
                            <tbody id="batchTxBody">
                              <tr><td class="text-muted">尚未載入檔案</td></tr>
                            </tbody>
                          </table>
                        </div>
                        <div class="small text-muted mt-1">預覽僅顯示前 200 筆，實際匯入包含全部已選資料。</div>
                      </div>
                    </div>
                  </div>
                  <!-- 會員匯入 -->
                  <div id="batchMemberTab" class="tab-pane fade">
                    <div class="row g-3">
                      <div class="col-lg-3">
                        <div class="border p-3 rounded h-100">
                          <h6 class="fw-semibold mb-2"><i class="bi bi-file-earmark-person"></i> 上傳檔案</h6>
                          <input id="batchMemberFile" type="file" accept=".xlsx,.xls,.csv" class="form-control form-control-sm mb-2" onchange="BatchImport.handleFile('members')">
                          <div class="d-grid gap-2 mb-2">
                            <button class="btn btn-outline-secondary btn-sm" onclick="BatchImport.downloadTemplate('members')"><i class="bi bi-download"></i> 範本</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="BatchImport.reparse('members')"><i class="bi bi-arrow-clockwise"></i> 重解析</button>
                            <button class="btn btn-outline-danger btn-sm" onclick="BatchImport.clear('members')"><i class="bi bi-x-circle"></i> 清除</button>
                          </div>
                          <hr>
                          <h6 class="fw-semibold mb-2"><i class="bi bi-link"></i> 欄位對應</h6>
                          <div id="batchMemberFieldMap" class="small"></div>
                          <hr>
                          <div class="form-check">
                            <input id="batchMemberSkipError" type="checkbox" class="form-check-input" checked>
                            <label class="form-check-label" for="batchMemberSkipError">略過錯誤列</label>
                          </div>
                          <div class="form-check">
                            <input id="batchMemberSkipDup" type="checkbox" class="form-check-input" checked>
                            <label class="form-check-label" for="batchMemberSkipDup">略過重複</label>
                          </div>
                          <div class="mt-2">
                            <label class="form-label small">預設年費（若匯入未填）</label>
                            <input id="batchMemberDefaultFee" type="number" value="1000" class="form-control form-control-sm">
                          </div>
                        </div>
                      </div>
                      <div class="col-lg-9">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <span id="batchMemberStats" class="badge bg-secondary">尚未載入資料</span>
                          <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-warning" onclick="BatchImport.filterPreview('members','errors')"><i class="bi bi-exclamation-triangle"></i> 錯誤</button>
                            <button class="btn btn-sm btn-outline-info" onclick="BatchImport.filterPreview('members','duplicates')"><i class="bi bi-files"></i> 重複</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="BatchImport.filterPreview('members','all')"><i class="bi bi-list-ul"></i> 全部</button>
                            <button class="btn btn-sm btn-success" onclick="BatchImport.commit('members')"><i class="bi bi-check-circle"></i> 匯入</button>
                          </div>
                        </div>
                        <div class="table-responsive" style="max-height:420px;overflow:auto;">
                          <table class="table table-sm table-hover align-middle mb-0">
                            <thead id="batchMemberHead" class="table-light"></thead>
                            <tbody id="batchMemberBody">
                              <tr><td class="text-muted">尚未載入檔案</td></tr>
                            </tbody>
                          </table>
                        </div>
                        <div class="small text-muted mt-1">預覽僅顯示前 200 筆，實際匯入包含全部已選資料。</div>
                      </div>
                    </div>
                  </div>
                </div>
                <hr>
                <div class="alert alert-info small mb-0">
                  提示：匯入後請至對應頁面確認結果。欄位未對應者會忽略。可透過「略過錯誤」與「略過重複」加速處理。
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 報表 Modal -->
        <div class="modal fade" id="reportModal" tabindex="-1">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-dark text-white">
                <h6 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i><span id="reportModalTitle">報表</span></h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="reportModalBody">
                <!-- 動態報表 -->
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-primary btn-sm" onclick="Reports.print()"><i class="bi bi-printer"></i> 列印</button>
                <button class="btn btn-primary btn-sm" onclick="Reports.exportHTML()"><i class="bi bi-download"></i> 匯出</button>
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Google Sync Modal -->
        <div class="modal fade" id="googleSyncModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header bg-info text-white">
                <h6 class="modal-title"><i class="bi bi-cloud-arrow-up me-2"></i>雲端同步設定</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="alert alert-info small">
                  此為示意設定，正式串接 Google Drive / API 時於 GoogleSync.connect / sync / restore 介面實作。
                </div>
                <div class="form-check mb-2">
                  <input id="gsEnable" type="checkbox" class="form-check-input" onchange="GoogleSync.togglePanel()">
                  <label class="form-check-label" for="gsEnable">啟用雲端同步</label>
                </div>
                <div id="gsPanel" style="display:none;">
                  <label class="form-label">同步頻率</label>
                  <select id="gsInterval" class="form-select form-select-sm mb-2">
                    <option value="manual">手動</option>
                    <option value="5">每 5 分鐘</option>
                    <option value="15">每 15 分鐘</option>
                    <option value="30">每 30 分鐘</option>
                    <option value="60">每小時</option>
                  </select>
                  <div class="d-flex gap-2 flex-wrap">
                    <button id="gsConnectBtn" class="btn btn-outline-primary btn-sm" onclick="GoogleSync.connect()"><i class="bi bi-link-45deg"></i> 連接</button>
                    <button id="gsSyncBtn" class="btn btn-outline-success btn-sm" disabled onclick="GoogleSync.sync()"><i class="bi bi-cloud-upload"></i> 立即同步</button>
                    <button id="gsRestoreBtn" class="btn btn-outline-warning btn-sm" disabled onclick="GoogleSync.restore()"><i class="bi bi-cloud-download"></i> 雲端還原</button>
                  </div>
                  <div class="small text-muted mt-2" id="gsStatus">尚未連線</div>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
                <button class="btn btn-info btn-sm text-white" onclick="GoogleSync.saveSettings()"><i class="bi bi-save"></i> 儲存設定</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 全域 Toast 容器 -->
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:2000;">
          <div id="toastSuccess" class="toast align-items-center border-0" role="alert">
            <div class="d-flex">
              <div class="toast-body"><i class="bi bi-check-circle text-success me-2"></i><span id="toastSuccessMsg">成功</span></div>
              <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
          <div id="toastError" class="toast align-items-center border-0" role="alert">
            <div class="d-flex">
              <div class="toast-body"><i class="bi bi-exclamation-triangle text-danger me-2"></i><span id="toastErrorMsg">錯誤</span></div>
              <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
        </div>

        <!-- =========================================================
             PART 4/5  ─────────────  核心 JavaScript
             ========================================================= -->
      </main>
    </div>
  </div>
  
  <!-- 依賴套件 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
// 替換原有的 JavaScript 部分

/* ================================================================
 核心 JS - 修改為後端 API 版本
 ================================================================ */

// 設定 GAS API 網址
const API_URL = 'https://script.google.com/macros/s/AKfycbzJEjCzmcbcs01Xbx2Q4ngESAsKBUbm8QuiTOpSkjKFnRsvik3SW3ATnBx5kIIvUVRLZA/exec'; // 請替換為您的 GAS Web App URL

/* -------------------- 工具層 -------------------- */
const Util = {
  uuid: ()=>'id_'+Math.random().toString(36).slice(2,10),
  today: ()=> new Date().toISOString().split('T')[0],
  fmtNum: n=> (Number(n)||0).toLocaleString(),
  toNumber: v=> isNaN(parseFloat(v))?0:parseFloat(v),
  pad:(n,l=2)=> String(n).padStart(l,'0'),
  formatDateInput(d){
    if(!d) return '';
    if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
    let s = String(d).replace(/[年月\.\/]/g,'-').replace(/日/,'');
    const m = s.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
    if(m) return m[1]+'-'+Util.pad(m[2])+'-'+Util.pad(m[3]);
    const dt = new Date(d);
    if(isNaN(dt.getTime())) return '';
    return dt.toISOString().split('T')[0];
  },
  age(birth){
    if(!birth) return '';
    const d = new Date(birth); if(isNaN(d.getTime())) return '';
    const t = new Date();
    let a = t.getFullYear()-d.getFullYear();
    if(t.getMonth()<d.getMonth() || (t.getMonth()==d.getMonth() && t.getDate()<d.getDate())) a--;
    return a;
  },
  showToast(type,msg){
    const id = type==='success'?'toastSuccess':'toastError';
    const el = document.getElementById(id);
    if(!el){ alert(msg); return; }
    (type==='success'?document.getElementById('toastSuccessMsg'):document.getElementById('toastErrorMsg')).textContent=msg;
    new bootstrap.Toast(el,{delay:3000}).show();
  },
  confirm(opts){
    return Swal.fire({
      icon:opts.icon||'warning',
      title:opts.title||'確定？',
      html:opts.html||opts.text||'',
      showCancelButton:true,
      confirmButtonText:opts.confirmText||'確定',
      cancelButtonText:opts.cancelText||'取消',
      confirmButtonColor:opts.confirmColor||'#0d6efd'
    });
  },
  chunk(arr,size){
    const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size)); return out;
  },
  downloadBlob(filename, data, type='text/plain'){
    const blob = new Blob([data],{type});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download=filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),1000);
  },
  financialChinese(num){
    num = Number(num);
    if(isNaN(num)) return '';
    if(num===0) return '零元整';
    const cNum=['零','壹','貳','參','肆','伍','陸','柒','捌','玖'];
    const cUnit=['','拾','佰','仟'];
    const cSec=['','萬','億','兆'];
    const cDec=['角','分'];
    let s=Math.floor(num).toString(), dec=Math.round((num - Math.floor(num))*100).toString().padStart(2,'0');
    let res='';
    if(Number(s)>0){
      let k=0;
      while(s.length>0){
        let seg = s.slice(-4); s=s.slice(0,-4);
        let segStr='', zeroFlag=false;
        for(let i=0;i<seg.length;i++){
          const d=seg[seg.length-1-i];
            if(d==='0'){
              if(!zeroFlag && segStr) segStr='零'+segStr;
              zeroFlag=true;
            }else{
              zeroFlag=false;
              segStr = cNum[+d]+cUnit[i]+segStr;
            }
        }
        segStr=segStr.replace(/零+/g,'零').replace(/零$/,'');
        if(segStr) res = segStr + cSec[k] + res;
        k++;
      }
      res += '元';
    }
    dec = dec.replace(/0+$/,'');
    if(dec){
      if(dec[0]!=='0') res += cNum[+dec[0]]+cDec[0];
      if(dec[1] && dec[1]!=='0') res += cNum[+dec[1]]+cDec[1];
    } else res+='整';
    return res;
  }
};

/* -------------------- API 通訊層 -------------------- */
const API = {
  async call(action, data = {}) {
    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ action, ...data })
      });
      
      const result = await response.json();
      
      if (result.error) {
        throw new Error(result.error);
      }
      
      return result;
    } catch (error) {
      console.error('API Error:', error);
      Util.showToast('error', '網路錯誤：' + error.message);
      throw error;
    }
  },

  // 交易相關 API
  async getTransactions() {
    return await this.call('getTransactions');
  },

  async saveTransaction(transaction) {
    return await this.call('saveTransaction', { transaction });
  },

  async deleteTransaction(id) {
    return await this.call('deleteTransaction', { id });
  },

  // 會員相關 API
  async getMembers() {
    return await this.call('getMembers');
  },

  async saveMember(member) {
    return await this.call('saveMember', { member });
  },

  async deleteMember(id) {
    return await this.call('deleteMember', { id });
  },

  // 帳戶相關 API
  async getAccounts() {
    return await this.call('getAccounts');
  },

  async saveAccount(account) {
    return await this.call('saveAccount', { account });
  },

  async deleteAccount(id) {
    return await this.call('deleteAccount', { id });
  },

  // 活動相關 API
  async getActivities() {
    return await this.call('getActivities');
  },

  async saveActivity(activity) {
    return await this.call('saveActivity', { activity });
  },

  async deleteActivity(id) {
    return await this.call('deleteActivity', { id });
  },

  // 報名相關 API
  async getRegistrations() {
    return await this.call('getRegistrations');
  },

  async saveRegistration(registration) {
    return await this.call('saveRegistration', { registration });
  },

  // 公告相關 API
  async getAnnouncements() {
    return await this.call('getAnnouncements');
  },

  async saveAnnouncement(announcement) {
    return await this.call('saveAnnouncement', { announcement });
  },

  async deleteAnnouncement(id) {
    return await this.call('deleteAnnouncement', { id });
  },

  // 表單相關 API
  async getForms() {
    return await this.call('getForms');
  },

  async saveForm(form) {
    return await this.call('saveForm', { form });
  },

  async deleteForm(id) {
    return await this.call('deleteForm', { id });
  },

  // 設定相關 API
  async getSettings() {
    return await this.call('getSettings');
  },

  async saveSettings(settings) {
    return await this.call('saveSettings', { settings });
  }
};

/* -------------------- 資料儲存層 (修改為 API 版本) -------------------- */
const Store = {
  data: {
    transactions: [],
    members: [],
    accounts: [],
    activities: [],
    registrations: [],
    announcements: [],
    forms: [],
    settings: {
      organizationName: '台灣帕金森病友權益促進會',
      organizationAddress: '',
      organizationPhone: '',
      organizationEmail: '',
      defaultMembershipFee: 1000,
      receiptPrefix: 'R',
      voucherPrefix: 'V',
      treasurerSeal: '出納',
      accountantSeal: '會計',
      chairmanSeal: '理事長',
      categories: {
        '收入': ['會費','捐款','活動收入','政府補助','利息收入','其他收入'],
        '支出': ['活動費用','辦公費用','交通費','餐費','場地費','設備費','印刷費','郵電費','保險費','其他支出']
      }
    }
  },

  async load() {
    try {
      document.getElementById('loadingOverlay').style.display = 'flex';
      
      // 並行載入所有資料
      const [
        transactions,
        members,
        accounts,
        activities,
        registrations,
        announcements,
        forms,
        settings
      ] = await Promise.all([
        API.getTransactions(),
        API.getMembers(),
        API.getAccounts(),
        API.getActivities(),
        API.getRegistrations(),
        API.getAnnouncements(),
        API.getForms(),
        API.getSettings()
      ]);

      this.data.transactions = transactions || [];
      this.data.members = members || [];
      this.data.accounts = accounts || [];
      this.data.activities = activities || [];
      this.data.registrations = registrations || [];
      this.data.announcements = announcements || [];
      this.data.forms = forms || [];
      
      // 處理設定資料
      if (settings) {
        this.data.settings = { ...this.data.settings, ...this.processSettings(settings) };
      }

      document.getElementById('loadingOverlay').style.display = 'none';
      SyncIndicator.bump();
      
    } catch (error) {
      document.getElementById('loadingOverlay').style.display = 'none';
      Util.showToast('error', '載入資料失敗');
      console.error('Load error:', error);
    }
  },

  processSettings(settings) {
    const processed = { ...settings };
    
    // 處理類別設定
    if (settings.incomeCategories) {
      processed.categories = {
        '收入': settings.incomeCategories,
        '支出': settings.expenseCategories || []
      };
    }
    
    return processed;
  },

  async save() {
    // 由於使用 API，個別儲存操作已在各模組中處理
    SyncIndicator.bump();
  }
};

/* -------------------- 編號產生 -------------------- */
const Numbering = {
  receipt(){
    const s = Store.data.settings;
    const today = Util.today();
    const count = Store.data.transactions.filter(t=>t.type==='收入' && t.date===today).length + 1;
    const d = new Date();
    return (s.receiptPrefix||'R')+d.getFullYear()+Util.pad(d.getMonth()+1)+Util.pad(d.getDate())+Util.pad(count,3);
  },
  voucher(){
    const s = Store.data.settings;
    const today = Util.today();
    const count = Store.data.transactions.filter(t=>t.type==='支出' && t.date===today).length + 1;
    const d = new Date();
    return (s.voucherPrefix||'V')+d.getFullYear()+Util.pad(d.getMonth()+1)+Util.pad(d.getDate())+Util.pad(count,3);
  }
};

/* -------------------- 同步顯示指示 -------------------- */
const SyncIndicator = {
  timer: null,
  bump(){
    const el = document.getElementById('syncIndicator');
    if(!el) return;
    el.className='badge bg-warning';
    el.innerHTML='<i class="bi bi-cloud-upload"></i> 同步中';
    clearTimeout(this.timer);
    this.timer = setTimeout(()=>{
      el.className='badge bg-success';
      el.innerHTML='<i class="bi bi-cloud-check"></i> 已同步';
    }, 600);
  },
  setOffline(off){
    document.getElementById('offlineIndicator')?.classList.toggle('d-none',!off);
  }
};

/* -------------------- Layout 控制 -------------------- */
const AppLayout = {
  showSection(name,link){
    document.querySelectorAll('.content-section').forEach(s=>s.style.display='none');
    document.getElementById(name+'Section').style.display='block';
    document.querySelectorAll('.sidebar .nav-link').forEach(a=>a.classList.remove('active'));
    if(link) link.classList.add('active');
    switch(name){
      case 'dashboard': Dashboard.refresh(); break;
      case 'transactions': Transactions.renderTable(); break;
      case 'members': Members.renderTable(); break;
      case 'activities': Activities.renderGrid(); break;
      case 'announcements': Announcements.render(); break;
      case 'forms': Forms.render(); break;
      case 'analytics': Analytics.refresh(); break;
      case 'reports': Reports.initDateOnce(); break;
    }
    if(window.innerWidth<992) this.toggleSidebar(false);
  },
  toggleSidebar(force){
    const sb = document.getElementById('sidebar');
    if(typeof force === 'boolean'){
      sb.classList.toggle('show',force);
    } else {
      sb.classList.toggle('show');
    }
  }
};

// 保持原有的其他模組，但修改儲存部分為 API 呼叫
// 例如在 TransactionUI.save() 中：

const TransactionUI = {
  modal: null,
  open(id=null){
    if(!this.modal) this.modal = new bootstrap.Modal(document.getElementById('transactionModal'));
    document.getElementById('txForm').reset();
    document.getElementById('txId').value='';
    document.getElementById('txVoucherPreview').innerHTML='';
    this.fillAccounts();
    this.fillCategories('收入'); // 預設
    document.getElementById('txDate').value = Util.today();
    document.getElementById('txType').value='收入';
    document.getElementById('txNumberLabel').textContent='收據編號';
    document.getElementById('txNumber').value = Numbering.receipt();

    if(id){
      const t = Store.data.transactions.find(x=>x.id===id);
      if(t){
        document.getElementById('txModalTitle').textContent='編輯交易';
        document.getElementById('txId').value=t.id;
        document.getElementById('txDate').value=t.date;
        document.getElementById('txType').value=t.type;
        this.fillCategories(t.type);
        document.getElementById('txCategory').value=t.category;
        document.getElementById('txAmount').value=t.amount;
        document.getElementById('txCounterparty').value=t.counterparty||'';
        document.getElementById('txAccount').value=t.account||'';
        document.getElementById('txDescription').value=t.description||'';
        if(t.type==='收入'){
          document.getElementById('txNumberLabel').textContent='收據編號';
          document.getElementById('txNumber').value = t.receiptNumber||'';
        } else {
          document.getElementById('txNumberLabel').textContent='憑證編號';
          document.getElementById('txNumber').value = t.voucherNumber||'';
        }
        if(t.vouchers?.length){
          this.renderVoucherPreview(t.vouchers);
        }
      }
    } else {
      document.getElementById('txModalTitle').textContent='新增交易';
    }
    this.modal.show();
  },
  onTypeChange(){
    const type = document.getElementById('txType').value;
    this.fillCategories(type);
    const lbl=document.getElementById('txNumberLabel');
    if(type==='支出'){ lbl.textContent='憑證編號'; document.getElementById('txNumber').value=Numbering.voucher(); }
    else { lbl.textContent='收據編號'; document.getElementById('txNumber').value=Numbering.receipt(); }
  },
  fillCategories(type){
    const sel=document.getElementById('txCategory');
    sel.innerHTML='<option value="">選擇類別</option>';
    const cats = Store.data.settings.categories[type]||[];
    cats.forEach(c=>{
      const opt=document.createElement('option');
      opt.value=c; opt.textContent=c;
      sel.appendChild(opt);
    });
  },
  fillAccounts(){
    const sel=document.getElementById('txAccount');
    sel.innerHTML='';
    Store.data.accounts.filter(a=>a.active).forEach(a=>{
      const opt=document.createElement('option');
      opt.value=a.name; opt.textContent=a.name;
      sel.appendChild(opt);
    });
    if(!sel.value && sel.options.length) sel.selectedIndex=0;
  },
  handleVoucherUpload(e){
    const files=[...e.target.files];
    const container=document.getElementById('txVoucherPreview');
    container.innerHTML='';
    files.forEach(f=>{
      if(f.type.startsWith('image/')){
        const reader=new FileReader();
        reader.onload=ev=>{
          const img=document.createElement('img');
          img.src=ev.target.result;
          img.title=f.name;
          img.onclick=()=>Swal.fire({imageUrl:ev.target.result,showConfirmButton:false});
          container.appendChild(img);
        };
        reader.readAsDataURL(f);
      } else if(f.type==='application/pdf'){
        const div=document.createElement('div');
        div.className='border rounded small p-2 d-inline-flex flex-column align-items-center justify-content-center';
        div.style.width='90px'; div.style.height='90px';
        div.innerHTML='<i class="bi bi-file-earmark-pdf text-danger" style="font-size:32px;"></i><div class="small text-truncate" style="max-width:80px">'+f.name+'</div>';
        container.appendChild(div);
      }
    });
  },
  renderVoucherPreview(vouchers){
    const container=document.getElementById('txVoucherPreview');
    container.innerHTML='';
    vouchers.forEach(v=>{
      if(v.type.startsWith('image/')){
        const img=document.createElement('img');
        img.src=v.data;
        img.title=v.name;
        img.onclick=()=>Swal.fire({imageUrl:v.data,showConfirmButton:false});
        container.appendChild(img);
      } else if(v.type==='application/pdf'){
        const div=document.createElement('div');
        div.className='border rounded small p-2 d-inline-flex flex-column align-items-center justify-content-center';
        div.style.width='90px'; div.style.height='90px';
        div.innerHTML='<i class="bi bi-file-earmark-pdf text-danger" style="font-size:32px;"></i><div class="small text-truncate" style="max-width:80px">'+v.name+'</div>';
        container.appendChild(div);
      }
    });
  },
  save(){
    const form=document.getElementById('txForm');
    if(!form.checkValidity()){ form.reportValidity(); return; }
    const id=document.getElementById('txId').value;
    const type=document.getElementById('txType').value;
    const t={
      id: id||Util.uuid(),
      date: document.getElementById('txDate').value,
      type,
      category: document.getElementById('txCategory').value,
      amount: Util.toNumber(document.getElementById('txAmount').value),
      counterparty: document.getElementById('txCounterparty').value.trim(),
      account: document.getElementById('txAccount').value,
      description: document.getElementById('txDescription').value.trim(),
      vouchers: [],
      createdAt: id? (Store.data.transactions.find(x=>x.id===id)?.createdAt || new Date().toISOString()) : new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    const customNumber=document.getElementById('txNumber').value.trim();
    if(type==='收入'){
      t.receiptNumber = customNumber || Numbering.receipt();
    } else {
      t.voucherNumber = customNumber || Numbering.voucher();
    }
    // 附件
    const fInput=document.getElementById('txVouchers');
    if(fInput.files.length){
      let remain=fInput.files.length;
      const all=[];
      const done=()=>{
        t.vouchers=all;
        this._finalSave(t,id);
      };
      [...fInput.files].forEach(f=>{
        const reader=new FileReader();
        reader.onload=ev=>{
          all.push({name:f.name,type:f.type,data:ev.target.result});
          if(--remain===0) done();
        };
        reader.readAsDataURL(f);
      });
    } else {
      // 如果是編輯保留舊附件
      if(id){
        const old=Store.data.transactions.find(x=>x.id===id);
        if(old?.vouchers?.length) t.vouchers = old.vouchers;
      }
      this._finalSave(t,id);
    }
  },
  _finalSave(t,isEdit){
    if(isEdit){
      const idx=Store.data.transactions.findIndex(x=>x.id===t.id);
      if(idx>-1) Store.data.transactions[idx]=t;
    } else {
      Store.data.transactions.push(t);
    }
    Store.save();
    Dashboard.refresh();
    Transactions.renderTable();
    this.modal.hide();
    Util.showToast('success',isEdit?'交易已更新':'交易已新增');
  }
  };

  /* 對象自動完成 */
  const Counterparty = {
  refreshDatalist(){
    const set=new Set();
    Store.data.transactions.forEach(t=> { if(t.counterparty) set.add(t.counterparty); });
    const dl=document.getElementById('counterpartyDatalist');
    if(dl) dl.innerHTML= [...set].map(v=>`<option value="${v}">`).join('');
  }
  };

  /* -------------------- 會員模組 -------------------- */
  const Members = {
  state:{page:1,per:10,filtered:[]},
  statusText:s=> s==='active'?'正常':s==='inactive'?'停權':s==='pending'?'待審核':'—',
  badgeClass:s=> s==='active'?'bg-success':s==='inactive'?'bg-danger':s==='pending'?'bg-warning text-dark':'bg-secondary',
  typeText:t=> ({regular:'一般會員',honorary:'榮譽會員',life:'終身會員',family:'家屬會員'})[t]||'其他',
  isOverdue(m){
    if(!m.lastPaymentDate) return true;
    const last=new Date(m.lastPaymentDate);
    const cmp=new Date(); cmp.setFullYear(cmp.getFullYear()-1);
    return last < cmp;
  },
  filter(){
    const st=document.getElementById('memberFilterStatus').value;
    const tp=document.getElementById('memberFilterType').value;
    const kw=(document.getElementById('memberFilterKeyword').value||'').toLowerCase();
    this.state.filtered = Store.data.members.filter(m=>{
      if(st && m.status!==st) return false;
      if(tp && m.type!==tp) return false;
      if(kw){
        const txt=(m.name+' '+m.phone+' '+(m.email||'')+' '+(m.tags||[]).join(' ')).toLowerCase();
        if(!txt.includes(kw)) return false;
      }
      return true;
    }).sort((a,b)=> b.joinDate.localeCompare(a.joinDate));
  },
  renderTable(){
    this.filter();
    const members=this.state.filtered;
    // stats
    document.getElementById('mStatTotal').textContent=Store.data.members.length;
    document.getElementById('mStatActive').textContent=Store.data.members.filter(m=>m.status==='active').length;
    const overdue = Store.data.members.filter(m=>this.isOverdue(m)).length;
    document.getElementById('mStatOverdue').textContent=overdue;
    const monthStr=new Date().toISOString().slice(0,7);
    document.getElementById('mStatNew').textContent = Store.data.members.filter(m=>m.joinDate.startsWith(monthStr)).length;

    const per=this.state.per;
    const pages=Math.max(1,Math.ceil(members.length/per));
    if(this.state.page>pages) this.state.page=pages;
    const start=(this.state.page-1)*per;
    const rows=members.slice(start,start+per);
    document.getElementById('memberRecordCount').textContent = `${members.length} 筆記錄`;
    const tb=document.getElementById('memberTableBody');
    if(!rows.length){
      tb.innerHTML=`<tr><td colspan="9" class="text-center text-muted py-5">
        <i class="bi bi-people display-6 d-block mb-2"></i> 無符合會員
      </td></tr>`;
    } else {
      tb.innerHTML = rows.map(m=>{
        const age = Util.age(m.birthDate);
        const overdue=this.isOverdue(m);
        return `<tr>
          <td><input type="checkbox" class="member-check" data-id="${m.id}"></td>
          <td>
            <div class="d-flex align-items-center">
              <div class="member-avatar me-2">${m.name.charAt(0)}</div>
              <div>
                <div class="fw-semibold">${m.name}</div>
                <div class="text-muted small">${m.id.slice(0,8)}</div>
              </div>
            </div>
          </td>
          <td class="small">
            <div><i class="bi bi-telephone me-1"></i>${m.phone}</div>
            ${m.email?`<div class="text-truncate"><i class="bi bi-envelope me-1"></i>${m.email}</div>`:''}
          </td>
          <td>${age?age+'歲':''}${m.gender?' / '+m.gender:''}</td>
          <td>${m.joinDate}</td>
          <td><span class="badge ${this.badgeClass(m.status)}">${this.statusText(m.status)}</span></td>
          <td>
            <span class="badge ${overdue?'bg-danger':'bg-success'}">${overdue?'逾期':'已繳'}</span>
            ${m.lastPaymentDate?`<div class="small text-muted">${m.lastPaymentDate}</div>`:''}
          </td>
          <td class="small">
            ${(m.tags||[]).map(t=>`<span class="badge bg-secondary me-1">${t}</span>`).join('')||'-'}
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-sm btn-outline-info" title="詳情" onclick="Members.detail('${m.id}')"><i class="bi bi-eye"></i></button>
              <button class="btn btn-sm btn-outline-primary" title="編輯" onclick="MemberUI.open('${m.id}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-outline-success" title="繳費" onclick="Members.recordFee('${m.id}')"><i class="bi bi-credit-card"></i></button>
              <button class="btn btn-sm btn-outline-danger" title="刪除" onclick="Members.delete('${m.id}')"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        </tr>`;
      }).join('');
    }
    // pagination
    const ul=document.getElementById('memberPagination');
    let html='',p=this.state.page;
    const add=(pg,txt,dis=false,act=false)=> html+=`<li class="page-item ${dis?'disabled':''} ${act?'active':''}">
      <a href="#" class="page-link" onclick="Members.goto(${pg});return false;">${txt}</a></li>`;
    add(p-1,'«',p===1);
    for(let i=Math.max(1,p-2);i<=Math.min(pages,p+2);i++) add(i,i,false,i===p);
    add(p+1,'»',p===pages);
    ul.innerHTML=html;
  },
  goto(p){ this.state.page=p; this.renderTable(); },
  toggleSelectAll(master){
    document.querySelectorAll('.member-check').forEach(cb=> cb.checked=master.checked);
  },
  getSelected(){ return [...document.querySelectorAll('.member-check:checked')].map(cb=>cb.getAttribute('data-id')); },
  batchAction(){
    const act=document.getElementById('memberBatchAction').value;
    const ids=this.getSelected();
    if(!act) return Util.showToast('error','未選動作');
    if(!ids.length) return Util.showToast('error','未勾選');
    if(act==='delete'){
      Util.confirm({title:'刪除會員',text:`確定刪除 ${ids.length} 位會員？`,confirmColor:'#dc3545'}).then(r=>{
        if(!r.isConfirmed) return;
        Store.data.members = Store.data.members.filter(m=>!ids.includes(m.id));
        // 同時刪除報名紀錄
        Store.data.registrations = Store.data.registrations.filter(r=>!ids.includes(r.memberId));
        Store.save();
        this.renderTable(); Dashboard.refresh();
        Util.showToast('success','已刪除會員');
      });
    } else if(act==='export'){
      DataPort.exportMembers(ids);
    } else if(act.startsWith('status-')){
      const newStatus = act.split('-')[1];
      Store.data.members.forEach(m=> { if(ids.includes(m.id)) m.status=newStatus; });
      Store.save(); this.renderTable(); Util.showToast('success','狀態已更新');
    } else {
      Util.showToast('error','尚未實作');
    }
  },
  detail(id){
    const m=Store.data.members.find(x=>x.id===id);
    if(!m) return;
    const modal = new bootstrap.Modal(document.getElementById('memberDetailModal'));
    const tx = Store.data.transactions.filter(t=> t.counterparty && t.counterparty.includes(m.name));
    const totalFee = tx.filter(t=>t.type==='收入' && t.category==='會費').reduce((s,t)=>s+Util.toNumber(t.amount),0);
    const age=Util.age(m.birthDate);
    const overdue=this.isOverdue(m);
    document.getElementById('memberDetailContent').innerHTML=`
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="border rounded p-3 h-100">
            <h6 class="fw-semibold mb-2"><i class="bi bi-person-badge me-1"></i>基本資料</h6>
            <div class="row small">
              <div class="col-4 text-muted">姓名</div><div class="col-8 fw-semibold">${m.name}</div>
              <div class="col-4 text-muted">電話</div><div class="col-8">${m.phone}</div>
              <div class="col-4 text-muted">Email</div><div class="col-8">${m.email||'—'}</div>
              <div class="col-4 text-muted">出生</div><div class="col-8">${m.birthDate||'—'} ${age?`(${age}歲)`:''}</div>
              <div class="col-4 text-muted">性別</div><div class="col-8">${m.gender||'—'}</div>
              <div class="col-4 text-muted">身分證</div><div class="col-8">${m.idNumber||'—'}</div>
              <div class="col-4 text-muted">地址</div><div class="col-8">${m.address||'—'}</div>
              <div class="col-4 text-muted">緊急聯絡</div><div class="col-8">${m.emergencyContact||'—'} ${m.emergencyPhone? '('+m.emergencyPhone+')':''}</div>
            </div>
            <h6 class="fw-semibold mt-3 mb-2"><i class="bi bi-card-checklist me-1"></i>會員資訊</h6>
            <div class="row small">
              <div class="col-4 text-muted">加入日期</div><div class="col-8">${m.joinDate}</div>
              <div class="col-4 text-muted">狀態</div><div class="col-8"><span class="badge ${this.badgeClass(m.status)}">${this.statusText(m.status)}</span></div>
              <div class="col-4 text-muted">類型</div><div class="col-8">${this.typeText(m.type)}</div>
              <div class="col-4 text-muted">年費</div><div class="col-8">$${Util.fmtNum(m.membershipFee||0)}</div>
              <div class="col-4 text-muted">最後繳費</div><div class="col-8">${m.lastPaymentDate||'—'} ${overdue?'<span class="badge bg-danger">逾期</span>':'<span class="badge bg-success">正常</span>'}</div>
              <div class="col-4 text-muted">累計會費</div><div class="col-8 text-success fw-semibold">$${Util.fmtNum(totalFee)}</div>
              <div class="col-4 text-muted">標籤</div><div class="col-8">${(m.tags||[]).map(t=>`<span class="badge bg-secondary me-1">${t}</span>`).join('')||'—'}</div>
            </div>
            ${m.notes?`<div class="mt-3"><div class="small text-muted">備註</div><div class="alert alert-info py-2 small mb-0">${m.notes}</div></div>`:''}
          </div>
        </div>
        <div class="col-lg-6">
          <div class="border rounded p-3 h-100">
            <h6 class="fw-semibold mb-2"><i class="bi bi-clock-history me-1"></i>相關交易 (${tx.length} 筆)</h6>
            <div class="table-responsive" style="max-height:350px;overflow:auto;">
              <table class="table table-sm">
                <thead>
                  <tr><th>日期</th><th>類型</th><th>類別</th><th class="text-end">金額</th><th>說明</th><th>編號</th></tr>
                </thead>
                <tbody>
                  ${tx.map(t=>`
                    <tr>
                      <td>${t.date}</td>
                      <td><span class="badge ${t.type==='收入'?'bg-success':'bg-danger'}">${t.type}</span></td>
                      <td>${t.category}</td>
                      <td class="text-end ${t.type==='收入'?'text-success':'text-danger'}">${t.type==='收入'?'+':'-'}$${Util.fmtNum(t.amount)}</td>
                      <td class="small">${t.description||''}</td>
                      <td class="small">${t.receiptNumber||t.voucherNumber||''}</td>
                    </tr>`).join('')}
                  ${tx.length===0?'<tr><td colspan="6" class="text-center text-muted py-3">無交易</td></tr>':''}
                </tbody>
              </table>
            </div>
            <div class="mt-3">
              <h6 class="fw-semibold mb-2"><i class="bi bi-activity me-1"></i>活動報名</h6>
              <div id="memberActivityRegistrations" class="small text-muted">載入中...</div>
            </div>
          </div>
        </div>
      </div>
    `;
    modal.show();
    // 填寫活動報名紀錄
    setTimeout(()=>{
      const regBox=document.getElementById('memberActivityRegistrations');
      const regs = Store.data.registrations.filter(r=>r.memberId===m.id);
      if(!regs.length){ regBox.innerHTML='無報名紀錄'; return; }
      regBox.innerHTML = '<ul class="list-unstyled mb-0">'+regs.slice(0,20).map(r=>{
        const act=Store.data.activities.find(a=>a.id===r.activityId);
        return `<li class="mb-1"><i class="bi bi-check2-circle text-success me-1"></i>${act?act.name:'(活動已刪除)'} <span class="text-muted">[${r.registrationDate}]</span></li>`;
      }).join('') + (regs.length>20?'<li class="text-muted">...更多</li>':'') + '</ul>';
    },50);
  },
  delete(id){
    Util.confirm({title:'刪除會員',text:'此動作同時刪除相關報名資料，確定？',confirmColor:'#dc3545'}).then(r=>{
      if(!r.isConfirmed) return;
      Store.data.members = Store.data.members.filter(m=>m.id!==id);
      Store.data.registrations = Store.data.registrations.filter(r=>r.memberId!==id);
      Store.save(); this.renderTable(); Dashboard.refresh();
      Util.showToast('success','已刪除會員');
    });
  },
  recordFee(id){
    const member = id? Store.data.members.find(m=>m.id===id):null;
    if(!member){
      const sel=this.getSelected();
      if(sel.length!==1){ Util.showToast('error','請勾選單一會員或在詳情內操作'); return; }
      return this.recordFee(sel[0]);
    }
    Swal.fire({
      title:'紀錄會費',
      html:`
        <div class="text-start">
          <div class="mb-2">會員：<strong>${member.name}</strong></div>
          <label class="form-label">日期</label>
          <input id="feeDate" type="date" class="form-control" value="${Util.today()}">
          <label class="form-label mt-2">金額</label>
          <input id="feeAmount" type="number" class="form-control" value="${member.membershipFee||Store.data.settings.defaultMembershipFee||1000}">
          <label class="form-label mt-2">備註</label>
          <textarea id="feeNote" rows="2" class="form-control"></textarea>
        </div>
      `,
      confirmButtonText:'儲存',
      showCancelButton:true
    }).then(r=>{
      if(!r.isConfirmed) return;
      const date=document.getElementById('feeDate').value;
      const amount=Util.toNumber(document.getElementById('feeAmount').value);
      const note=document.getElementById('feeNote').value.trim();
      if(!date||!amount){ Util.showToast('error','請填寫日期與金額'); return; }
      // 新增收入交易
      const tx={
        id:Util.uuid(),
        date,
        type:'收入',
        category:'會費',
        amount,
        counterparty:member.name,
        account:Store.data.accounts.find(a=>a.active)?.name||'現金',
        description:`${member.name} 會費${note? ' - '+note:''}`,
        receiptNumber:Numbering.receipt(),
        vouchers:[],
        createdAt:new Date().toISOString(),
        updatedAt:new Date().toISOString()
      };
      Store.data.transactions.push(tx);
      // 更新會員
      member.lastPaymentDate=date;
      member.updatedAt=new Date().toISOString();
      Store.save();
      Transactions.renderTable();
      this.renderTable();
      Dashboard.refresh();
      Util.showToast('success','已紀錄會費');
    });
  },
  printCard(){
    window.print(); // 簡易示意，可自行客製會員卡版型
  }
  };

  /* 會員新增編輯 UI */
  const MemberUI = {
  modal:null,
  open(id=null){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('memberModal'));
    document.getElementById('memberForm').reset();
    document.getElementById('memberId').value='';
    document.getElementById('memberJoinDate').value=Util.today();
    document.getElementById('membershipFee').value=Store.data.settings.defaultMembershipFee||1000;
    document.getElementById('memberStatus').value='active';
    document.getElementById('memberType').value='regular';
    document.getElementById('memberModalTitle').textContent='新增會員';
    if(id){
      const m=Store.data.members.find(x=>x.id===id);
      if(m){
        document.getElementById('memberModalTitle').textContent='編輯會員';
        document.getElementById('memberId').value=m.id;
        document.getElementById('memberName').value=m.name;
        document.getElementById('memberPhone').value=m.phone;
        document.getElementById('memberEmail').value=m.email||'';
        document.getElementById('memberBirthDate').value=m.birthDate||'';
        document.getElementById('memberGender').value=m.gender||'';
        document.getElementById('memberIdNumber').value=m.idNumber||'';
        document.getElementById('memberAddress').value=m.address||'';
        document.getElementById('emergencyContact').value=m.emergencyContact||'';
        document.getElementById('emergencyPhone').value=m.emergencyPhone||'';
        document.getElementById('memberNotes').value=m.notes||'';
        document.getElementById('memberJoinDate').value=m.joinDate;
        document.getElementById('memberStatus').value=m.status;
        document.getElementById('memberType').value=m.type;
        document.getElementById('membershipFee').value=m.membershipFee||Store.data.settings.defaultMembershipFee||1000;
        document.getElementById('lastPaymentDate').value=m.lastPaymentDate||'';
        document.getElementById('memberTags').value=(m.tags||[]).join(',');
      }
    }
    this.modal.show();
  },
  save(){
    const form=document.getElementById('memberForm');
    if(!form.checkValidity()){ form.reportValidity(); return; }
    const id=document.getElementById('memberId').value;
    const m={
      id: id||Util.uuid(),
      name: document.getElementById('memberName').value.trim(),
      phone: document.getElementById('memberPhone').value.trim(),
      email: document.getElementById('memberEmail').value.trim(),
      birthDate: document.getElementById('memberBirthDate').value,
      gender: document.getElementById('memberGender').value,
      idNumber: document.getElementById('memberIdNumber').value.trim(),
      address: document.getElementById('memberAddress').value.trim(),
      emergencyContact: document.getElementById('emergencyContact').value.trim(),
      emergencyPhone: document.getElementById('emergencyPhone').value.trim(),
      notes: document.getElementById('memberNotes').value.trim(),
      joinDate: document.getElementById('memberJoinDate').value,
      status: document.getElementById('memberStatus').value,
      type: document.getElementById('memberType').value,
      membershipFee: Util.toNumber(document.getElementById('membershipFee').value),
      lastPaymentDate: document.getElementById('lastPaymentDate').value,
      tags: document.getElementById('memberTags').value.split(',').map(t=>t.trim()).filter(Boolean),
      createdAt: id?(Store.data.members.find(x=>x.id===id)?.createdAt || new Date().toISOString()):new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    if(id){
      const idx=Store.data.members.findIndex(x=>x.id===m.id);
      if(idx>-1) Store.data.members[idx]=m;
    } else Store.data.members.push(m);
    Store.save(); Members.renderTable(); Dashboard.refresh();
    this.modal.hide();
    Util.showToast('success',id?'會員已更新':'會員已新增');
  },
  editFromDetail(){
    const id=document.querySelector('#memberDetailContent .fw-semibold')?.textContent;
    if(!id) return;
  }
  };

  /* -------------------- 活動 / 報名 -------------------- */
  const Activities = {
  state:{page:1,per:6,filtered:[]},
  statusText:s=>({draft:'草稿',published:'已發布',registration:'報名中',full:'已額滿',closed:'已結束',cancelled:'已取消'})[s]||s,
  statusBadge(s){
    return {
      draft:'bg-secondary',published:'bg-primary',registration:'bg-success',
      full:'bg-warning text-dark',closed:'bg-dark',cancelled:'bg-danger'
    }[s]||'bg-secondary';
  },
  filter(){
    const status=document.getElementById('actFilterStatus').value;
    const type=document.getElementById('actFilterType').value;
    const kw=(document.getElementById('actFilterKeyword').value||'').toLowerCase();
    const sort=document.getElementById('actFilterSort').value;
    this.state.filtered = Store.data.activities.filter(a=>{
      if(status && a.status!==status) return false;
      if(type && a.type!==type) return false;
      if(kw){
        const text=(a.name+' '+(a.description||'')+' '+(a.location||'')).toLowerCase();
        if(!text.includes(kw)) return false;
      }
      return true;
    });
    // 排序
    this.state.filtered.sort((a,b)=>{
      switch(sort){
        case 'date_asc': return a.date.localeCompare(b.date);
        case 'date_desc': return b.date.localeCompare(a.date);
        case 'name_asc': return a.name.localeCompare(b.name);
        case 'regs_desc':
          const ar = Registrations.count(a.id);
          const br = Registrations.count(b.id);
          return br-ar;
        default: return b.date.localeCompare(a.date);
      }
    });
  },
  renderGrid(){
    this.filter();
    // stats
    document.getElementById('actStatTotal').textContent=Store.data.activities.length;
    document.getElementById('actStatOpen').textContent=Store.data.activities.filter(a=>a.status==='registration').length;
    const upcoming = Store.data.activities.filter(a=>{
      const dt=new Date(a.date);
      const today=new Date();
      const diff=(dt - today)/(86400*1000);
      return diff>=0 && diff<=7 && ['registration','published'].includes(a.status);
    }).length;
    document.getElementById('actStatUpcoming').textContent=upcoming;
    document.getElementById('actStatRegistrations').textContent=Store.data.registrations.length;

    const per=this.state.per;
    const pages=Math.max(1,Math.ceil(this.state.filtered.length/per));
    if(this.state.page>pages) this.state.page=pages;
    const start=(this.state.page-1)*per;
    const rows=this.state.filtered.slice(start,start+per);
    const grid=document.getElementById('activitiesGrid');
    if(!rows.length){
      grid.innerHTML='<div class="col-12 text-center py-5 text-muted"><i class="bi bi-calendar-event display-6 d-block mb-2"></i> 無符合活動</div>';
    } else {
      grid.innerHTML = rows.map(a=>{
        const regCount=Registrations.count(a.id);
        const percent = a.maxParticipants? Math.min(100, (regCount/a.maxParticipants*100)) : 0;
        const canRegister = a.status==='registration' && regCount < a.maxParticipants;
        return `<div class="col-md-6 col-lg-4">
          <div class="activity-card h-100 bg-white">
            ${a.image?`<img src="${a.image}" class="w-100" style="height:160px;object-fit:cover;">`
              :`<div class="d-flex align-items-center justify-content-center bg-light" style="height:160px;">
                  <i class="bi bi-calendar-event text-muted" style="font-size:48px;"></i>
                </div>`}
            <div class="p-3 d-flex flex-column h-100">
              <div class="d-flex justify-content-between align-items-start">
                <h6 class="fw-semibold mb-1 text-truncate" style="max-width:70%;">${a.name}</h6>
                <span class="badge ${this.statusBadge(a.status)}">${this.statusText(a.status)}</span>
              </div>
              <div class="small text-muted mb-2">
                <i class="bi bi-clock me-1"></i>${a.date}${a.time? ' '+a.time : ''} <br>
                <i class="bi bi-geo-alt me-1"></i>${a.location||'—'}
              </div>
              <div class="mb-2 small text-truncate" title="${(a.description||'').replace(/"/g,'&quot;')}">
                ${(a.description||'').slice(0,60)}${(a.description||'').length>60?'...':''}
              </div>
              <div class="mb-2">
                <div class="progress">
                  <div class="progress-bar" style="width:${percent}%"></div>
                </div>
                <div class="d-flex justify-content-between small mt-1">
                  <span class="text-muted">報名 ${regCount}/${a.maxParticipants}</span>
                  ${a.fee>0? `<span class="text-danger fw-semibold">$${Util.fmtNum(a.fee)}</span>`:'<span class="text-success">免費</span>'}
                </div>
              </div>
              <div class="mt-auto d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm flex-grow-1" onclick="Activities.detail('${a.id}')"><i class="bi bi-eye"></i> 詳情</button>
                ${ canRegister? `<button class="btn btn-success btn-sm" onclick="Registrations.quick('${a.id}')"><i class="bi bi-person-plus"></i></button>`:''}
                <div class="btn-group">
                  <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown"></button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="ActivityUI.open('${a.id}')"><i class="bi bi-pencil me-1"></i> 編輯</a></li>
                    <li><a class="dropdown-item" href="#" onclick="DataPort.exportActivityRegistrations('${a.id}')"><i class="bi bi-download me-1"></i> 匯出報名</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="Activities.delete('${a.id}')"><i class="bi bi-trash me-1"></i> 刪除</a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>`;
      }).join('');
    }
    // pagination
    const ul=document.getElementById('actPagination');
    let html='',p=this.state.page;
    const add=(pg,txt,dis=false,act=false)=> html+=`<li class="page-item ${dis?'disabled':''} ${act?'active':''}">
      <a href="#" class="page-link" onclick="Activities.goto(${pg});return false;">${txt}</a></li>`;
    add(p-1,'«',p===1);
    for(let i=Math.max(1,p-2); i<=Math.min(pages,p+2); i++) add(i,i,false,i===p);
    add(p+1,'»',p===pages);
    ul.innerHTML=html;
  },
  goto(p){ this.state.page=p; this.renderGrid(); },
  detail(id){
    const a=Store.data.activities.find(x=>x.id===id); if(!a) return;
    const modal=new bootstrap.Modal(document.getElementById('activityDetailModal'));
    const regCount=Registrations.count(a.id);
    const percent=a.maxParticipants? Math.min(100,regCount/a.maxParticipants*100):0;
    const canRegister=a.status==='registration' && regCount<a.maxParticipants;
    document.getElementById('activityDetailContent').innerHTML=`
      <div class="row g-3">
        <div class="col-md-6">
          ${a.image?`<img src="${a.image}" class="w-100 rounded" style="max-height:240px;object-fit:cover;">`
          :`<div class="d-flex align-items-center justify-content-center bg-light rounded" style="height:240px;">
              <i class="bi bi-image text-muted" style="font-size:64px;"></i>
            </div>`}
          <div class="mt-3">
            <h5 class="fw-semibold">${a.name}</h5>
            <div class="small text-muted">狀態：<span class="badge ${this.statusBadge(a.status)}">${this.statusText(a.status)}</span></div>
            <div class="small text-muted mt-1">日期：${a.date} ${a.time||''}</div>
            <div class="small text-muted">地點：${a.location||'—'}</div>
            <div class="small text-muted">人數：${regCount}/${a.maxParticipants}</div>
            <div class="progress mt-2" style="height:6px;"><div class="progress-bar" style="width:${percent}%"></div></div>
            <div class="small mt-2">費用：${a.fee>0? '$'+Util.fmtNum(a.fee):'免費'} / 類型：${a.type}</div>
            ${a.registrationStartDate||a.registrationEndDate? `<div class="small text-muted">報名期間：${a.registrationStartDate||''} ~ ${a.registrationEndDate||''}</div>`:''}
            <div class="small text-muted">聯絡：${a.contactPerson||'—'} ${a.contactPhone? '('+a.contactPhone+')':''}</div>
          </div>
        </div>
        <div class="col-md-6">
          <h6 class="fw-semibold">活動說明</h6>
          <div class="small mb-3" style="white-space:pre-wrap;">${a.description||'—'}</div>
          <h6 class="fw-semibold">備註</h6>
          <div class="small mb-3" style="white-space:pre-wrap;">${a.notes||'—'}</div>
          <h6 class="fw-semibold">報名清單 (${regCount})</h6>
          <div class="small" style="max-height:260px;overflow:auto;border:1px solid #e5e7eb;border-radius:6px;">
            <table class="table table-sm mb-0">
              <thead><tr><th>姓名</th><th>電話</th><th>會員</th><th>日期</th></tr></thead>
              <tbody>
                ${
                  Store.data.registrations.filter(r=>r.activityId===a.id).map(r=>{
                    return `<tr>
                      <td>${r.participantName}</td>
                      <td>${r.participantPhone||'—'}</td>
                      <td>${r.memberId?'<span class="badge bg-success">是</span>':'—'}</td>
                      <td>${r.registrationDate}</td>
                    </tr>`;
                  }).join('') || `<tr><td colspan="4" class="text-center text-muted">尚無報名</td></tr>`
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
    document.getElementById('activityRegisterBtn').style.display = canRegister?'inline-block':'none';
    Registrations.currentActivityId = a.id;
    modal.show();
  },
  delete(id){
    Util.confirm({title:'刪除活動',text:'刪除後報名紀錄亦刪除，確定？',confirmColor:'#dc3545'}).then(r=>{
      if(!r.isConfirmed) return;
      Store.data.activities = Store.data.activities.filter(a=>a.id!==id);
      Store.data.registrations = Store.data.registrations.filter(r=>r.activityId!==id);
      Store.save(); Dashboard.refresh(); Activities.renderGrid();
      Util.showToast('success','活動已刪除');
    });
  }
  };

  /* 活動 UI */
  const ActivityUI = {
  modal:null,
  open(id=null){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('activityModal'));
    const f=document.getElementById('activityForm');
    f.reset();
    document.getElementById('activityId').value='';
    document.getElementById('activityDate').value=Util.today();
    document.getElementById('activityStatus').value='draft';
    document.getElementById('activityMax').value=50;
    document.getElementById('activityFee').value=0;
    document.getElementById('activityImagePreview').innerHTML='';
    document.getElementById('activityModalTitle').textContent='新增活動';
    if(id){
      const a=Store.data.activities.find(x=>x.id===id);
      if(a){
        document.getElementById('activityModalTitle').textContent='編輯活動';
        document.getElementById('activityId').value=a.id;
        document.getElementById('activityName').value=a.name;
        document.getElementById('activityType').value=a.type;
        document.getElementById('activityStatus').value=a.status;
        document.getElementById('activityDate').value=a.date;
        document.getElementById('activityTime').value=a.time||'';
        document.getElementById('regStartDate').value=a.registrationStartDate||'';
        document.getElementById('regEndDate').value=a.registrationEndDate||'';
        document.getElementById('activityLocation').value=a.location||'';
        document.getElementById('activityDescription').value=a.description||'';
        document.getElementById('activityMax').value=a.maxParticipants||50;
        document.getElementById('activityFee').value=a.fee||0;
        document.getElementById('activityContact').value=a.contactPerson||'';
        document.getElementById('activityContactPhone').value=a.contactPhone||'';
        document.getElementById('activityNotes').value=a.notes||'';
        if(a.image){
          document.getElementById('activityImagePreview').innerHTML=`<img src="${a.image}" class="img-fluid rounded" style="max-height:160px;object-fit:cover;">`;
        }
      }
    }
    this.modal.show();
  },
  previewImage(ev){
    const file=ev.target.files[0];
    if(!file) return document.getElementById('activityImagePreview').innerHTML='';
    if(!file.type.startsWith('image/')) return;
    const reader=new FileReader();
    reader.onload=e=>{
      document.getElementById('activityImagePreview').innerHTML=`<img src="${e.target.result}" class="img-fluid rounded" style="max-height:160px;object-fit:cover;">`;
    };
    reader.readAsDataURL(file);
  },
  save(){
    const f=document.getElementById('activityForm');
    if(!f.checkValidity()){ f.reportValidity(); return; }
    const id=document.getElementById('activityId').value;
    const a={
      id: id||Util.uuid(),
      name: document.getElementById('activityName').value.trim(),
      type: document.getElementById('activityType').value,
      status: document.getElementById('activityStatus').value,
      date: document.getElementById('activityDate').value,
      time: document.getElementById('activityTime').value,
      registrationStartDate: document.getElementById('regStartDate').value,
      registrationEndDate: document.getElementById('regEndDate').value,
      location: document.getElementById('activityLocation').value.trim(),
      description: document.getElementById('activityDescription').value.trim(),
      maxParticipants: Util.toNumber(document.getElementById('activityMax').value)||50,
      fee: Util.toNumber(document.getElementById('activityFee').value)||0,
      contactPerson: document.getElementById('activityContact').value.trim(),
      contactPhone: document.getElementById('activityContactPhone').value.trim(),
      notes: document.getElementById('activityNotes').value.trim(),
      createdAt: id?(Store.data.activities.find(x=>x.id===id)?.createdAt||new Date().toISOString()):new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    const imgFile=document.getElementById('activityImage').files[0];
    const finalize=()=>{
      if(id){
        const idx=Store.data.activities.findIndex(x=>x.id===a.id);
        if(idx>-1) Store.data.activities[idx]=a;
      } else Store.data.activities.push(a);
      Store.save(); Activities.renderGrid(); Dashboard.refresh();
      this.modal.hide();
      Util.showToast('success',id?'活動已更新':'活動已新增');
    };
    if(imgFile && imgFile.type.startsWith('image/')){
      const reader=new FileReader();
      reader.onload=e=>{ a.image=e.target.result; finalize(); };
      reader.readAsDataURL(imgFile);
    } else finalize();
  },
  editFromDetail(){
    if(!Registrations.currentActivityId) return;
    this.open(Registrations.currentActivityId);
  }
  };

  /* 報名 */
  const Registrations = {
  currentActivityId:null,
  count(actId){ return Store.data.registrations.filter(r=>r.activityId===actId).length; },
  quick(actId){ this.currentActivityId=actId; Activities.detail(actId); setTimeout(()=>this.openRegister(),300); },
  openRegister(){
    const a=Store.data.activities.find(x=>x.id===this.currentActivityId); if(!a) return;
    const modal=new bootstrap.Modal(document.getElementById('registrationModal'));
    document.getElementById('registrationForm').reset();
    document.getElementById('registrationActivityId').value=a.id;
    // 會員選擇
    const sel=document.getElementById('regMemberSelect');
    sel.innerHTML='<option value="">選擇會員</option>'+Store.data.members.filter(m=>m.status==='active').map(m=>`<option value="${m.id}">${m.name} (${m.phone})</option>`).join('');
    document.getElementById('registrationActivityInfo').innerHTML=`
      <div><strong>${a.name}</strong></div>
      <div class="small text-muted">${a.date} ${a.time||''} | ${a.location||'—'}</div>
      <div class="small text-muted">人數 ${this.count(a.id)}/${a.maxParticipants}</div>
    `;
    modal.show();
  },
  toggleMode(){
    const existing=document.getElementById('regExisting').checked;
    document.getElementById('regExistingBox').style.display=existing?'block':'none';
    document.getElementById('regNewBox').style.display=existing?'none':'block';
  },
  submit(){
    const actId=document.getElementById('registrationActivityId').value;
    const a=Store.data.activities.find(x=>x.id===actId); if(!a) return;
    const existing=document.getElementById('regExisting').checked;
    const agree=document.getElementById('regAgree').checked;
    if(!agree) return Util.showToast('error','請勾選同意條款');
    // 人數檢查
    if(this.count(actId)>=a.maxParticipants) return Util.showToast('error','已額滿');
    let reg={
      id:Util.uuid(),
      activityId:actId,
      activityName:a.name,
      memberId:null,
      participantName:'',
      participantPhone:'',
      participantEmail:'',
      emergencyContact:'',
      notes:document.getElementById('regNotes').value.trim(),
      registrationDate:Util.today(),
      status:'confirmed',
      createdAt:new Date().toISOString()
    };
    if(existing){
      const memberId=document.getElementById('regMemberSelect').value;
      const m=Store.data.members.find(x=>x.id===memberId);
      if(!m) return Util.showToast('error','請選擇會員');
      // 重複檢查
      if(Store.data.registrations.some(r=>r.activityId===actId && r.memberId===memberId))
        return Util.showToast('error','此會員已報名');
      reg.memberId=memberId;
      reg.participantName=m.name;
      reg.participantPhone=m.phone;
      reg.participantEmail=m.email||'';
      reg.emergencyContact=m.emergencyContact||'';
    } else {
      const name=document.getElementById('regName').value.trim();
      const phone=document.getElementById('regPhone').value.trim();
      if(!name||!phone) return Util.showToast('error','請填姓名與電話');
      if(Store.data.registrations.some(r=>r.activityId===actId && r.participantName===name && r.participantPhone===phone))
        return Util.showToast('error','此報名者已存在');
      reg.participantName=name;
      reg.participantPhone=phone;
      reg.participantEmail=document.getElementById('regEmail').value.trim();
      reg.emergencyContact=document.getElementById('regEmergency').value.trim();
    }
    Store.data.registrations.push(reg);
    // 若額滿更新狀態
    if(this.count(actId)>=a.maxParticipants && a.status==='registration'){
      a.status='full';
      a.updatedAt=new Date().toISOString();
    }
    Store.save();
    Activities.renderGrid(); Dashboard.refresh();
    bootstrap.Modal.getInstance(document.getElementById('registrationModal')).hide();
    Util.showToast('success','報名成功');
    // 若在詳情中，刷新詳情
    setTimeout(()=>Activities.detail(actId),200);
  }
  };

  /* -------------------- 公告 -------------------- */
  const Announcements = {
  state:{page:1,per:6,filtered:[]},
  typeText:t=>({normal:'一般',urgent:'緊急',event:'活動相關',system:'系統公告'})[t]||t,
  typeBadge(t){
    return {normal:'bg-primary',urgent:'bg-danger',event:'bg-info',system:'bg-warning text-dark'}[t]||'bg-secondary';
  },
  filter(){
    const st=document.getElementById('annFilterStatus').value;
    const tp=document.getElementById('annFilterType').value;
    const kw=(document.getElementById('annFilterKeyword').value||'').toLowerCase();
    const today=Util.today();
    this.state.filtered = Store.data.announcements.filter(a=>{
      // 計算 expired
      let status = a.status;
      if(a.status==='published' && a.expireDate && a.expireDate < today) status='expired';
      if(st && status!==st) return false;
      if(tp && a.type!==tp) return false;
      if(kw){
        const text=(a.title+' '+(a.content||'')).toLowerCase();
        if(!text.includes(kw)) return false;
      }
      return true;
    }).sort((a,b)=>{
      // 置頂優先、再按發布日期
      if(a.pinned && !b.pinned) return -1;
      if(!a.pinned && b.pinned) return 1;
      return (b.publishDate||'').localeCompare(a.publishDate||'');
    });
    // 統計
    const today2=Util.today();
    document.getElementById('annStatTotal').textContent=Store.data.announcements.length;
    document.getElementById('annStatActive').textContent=Store.data.announcements.filter(a=>{
      return a.status==='published' && (!a.expireDate || a.expireDate>=today2);
    }).length;
    document.getElementById('annStatUrgent').textContent=Store.data.announcements.filter(a=>a.type==='urgent' && a.status==='published').length;
  },
  render(){
    this.filter();
    const per=this.state.per;
    const pages=Math.max(1,Math.ceil(this.state.filtered.length/per));
    if(this.state.page>pages) this.state.page=pages;
    const start=(this.state.page-1)*per;
    const rows=this.state.filtered.slice(start,start+per);
    const grid=document.getElementById('announcementsGrid');
    if(!rows.length){
      grid.innerHTML='<div class="col-12 text-center py-5 text-muted"><i class="bi bi-megaphone display-6 d-block mb-2"></i> 無公告</div>';
    } else {
      grid.innerHTML = rows.map(a=>{
        const today=Util.today();
        const isExpired = a.expireDate && a.expireDate<today;
        return `<div class="col-md-6 col-lg-4">
          <div class="announcement-card ${a.type==='urgent'?'urgent':''} bg-white p-3 h-100 position-relative">
            <div class="d-flex align-items-start justify-content-between">
              <div class="flex-grow-1 pe-2">
                <h6 class="fw-semibold mb-1 text-truncate">${a.title}</h6>
                <div class="small mb-1">
                  <span class="badge ${this.typeBadge(a.type)}">${this.typeText(a.type)}</span>
                  ${a.pinned?'<span class="badge bg-warning text-dark">置頂</span>':''}
                  ${isExpired?'<span class="badge bg-secondary">已過期</span>':''}
                </div>
                <div class="text-muted small mb-2">${a.publishDate||''}${a.expireDate? ' ~ '+a.expireDate:''}</div>
                <div class="small" style="height:60px;overflow:hidden;">${a.content.replace(/</g,'&lt;')}</div>
              </div>
              <div class="dropdown ms-auto">
                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="#" onclick="AnnouncementUI.open('${a.id}')"><i class="bi bi-pencil me-1"></i> 編輯</a></li>
                  <li><a class="dropdown-item text-primary" href="#" onclick="Announcements.view('${a.id}')"><i class="bi bi-eye me-1"></i> 檢視</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-danger" href="#" onclick="Announcements.delete('${a.id}')"><i class="bi bi-trash me-1"></i> 刪除</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>`;
      }).join('');
    }
    // pagination
    const ul=document.getElementById('annPagination');
    let html='',p=this.state.page;
    const add=(pg,txt,dis=false,act=false)=> html+=`<li class="page-item ${dis?'disabled':''} ${act?'active':''}">
      <a href="#" class="page-link" onclick="Announcements.goto(${pg});return false;">${txt}</a></li>`;
    add(p-1,'«',p===1);
    for(let i=Math.max(1,p-2); i<=Math.min(pages,p+2); i++) add(i,i,false,i===p);
    add(p+1,'»',p===pages);
    ul.innerHTML=html;
  },
  goto(p){ this.state.page=p; this.render(); },
  view(id){
    const a=Store.data.announcements.find(x=>x.id===id);
    if(!a) return;
    Swal.fire({
      title:a.title,
      html:`
        <div class="text-start small">
          <div class="mb-2">
            <span class="badge ${this.typeBadge(a.type)}">${this.typeText(a.type)}</span>
            ${a.pinned?'<span class="badge bg-warning text-dark">置頂</span>':''}
          </div>
          <div class="text-muted mb-2">${a.publishDate||''}${a.expireDate? ' ~ '+a.expireDate:''}</div>
          <div style="white-space:pre-wrap;">${a.content.replace(/</g,'&lt;')}</div>
          ${a.link?`<div class="mt-2"><a href="${a.link}" target="_blank">相關連結 <i class="bi bi-box-arrow-up-right"></i></a></div>`:''}
        </div>`,
      showCloseButton:true,
      showConfirmButton:false
    });
  },
  delete(id){
    Util.confirm({title:'刪除公告',text:'確定刪除此公告？',confirmColor:'#dc3545'}).then(r=>{
      if(!r.isConfirmed) return;
      Store.data.announcements = Store.data.announcements.filter(a=>a.id!==id);
      Store.save(); this.render(); Dashboard.refresh();
      Util.showToast('success','公告已刪除');
    });
  }
  };

  /* 公告 UI */
  const AnnouncementUI = {
  modal:null,
  open(id=null){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('announcementModal'));
    const f=document.getElementById('announcementForm');
    f.reset();
    document.getElementById('announcementId').value='';
    document.getElementById('announcementPublishDate').value=Util.today();
    document.getElementById('announcementStatus').value='published';
    document.getElementById('announcementType').value='normal';
    document.getElementById('announcementPinned').checked=false;
    document.getElementById('announcementModalTitle').textContent='新增公告';
    if(id){
      const a=Store.data.announcements.find(x=>x.id===id);
      if(a){
        document.getElementById('announcementModalTitle').textContent='編輯公告';
        document.getElementById('announcementId').value=a.id;
        document.getElementById('announcementTitle').value=a.title;
        document.getElementById('announcementType').value=a.type;
        document.getElementById('announcementStatus').value=a.status;
        document.getElementById('announcementPublishDate').value=a.publishDate||'';
        document.getElementById('announcementExpireDate').value=a.expireDate||'';
        document.getElementById('announcementContent').value=a.content||'';
        document.getElementById('announcementLink').value=a.link||'';
        document.getElementById('announcementPinned').checked=!!a.pinned;
      }
    }
    this.modal.show();
  },
  save(){
    const f=document.getElementById('announcementForm');
    if(!f.checkValidity()){ f.reportValidity(); return; }
    const id=document.getElementById('announcementId').value;
    const a={
      id: id||Util.uuid(),
      title: document.getElementById('announcementTitle').value.trim(),
      type: document.getElementById('announcementType').value,
      status: document.getElementById('announcementStatus').value,
      publishDate: document.getElementById('announcementPublishDate').value,
      expireDate: document.getElementById('announcementExpireDate').value,
      content: document.getElementById('announcementContent').value.trim(),
      link: document.getElementById('announcementLink').value.trim(),
      pinned: document.getElementById('announcementPinned').checked,
      createdAt: id?(Store.data.announcements.find(x=>x.id===id)?.createdAt||new Date().toISOString()):new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    if(a.status==='draft' && !a.publishDate) a.publishDate=Util.today();
    if(id){
      const idx=Store.data.announcements.findIndex(x=>x.id===a.id);
      if(idx>-1) Store.data.announcements[idx]=a;
    } else Store.data.announcements.push(a);
    Store.save(); Announcements.render(); this.modal.hide();
    Util.showToast('success',id?'公告已更新':'公告已新增');
  }
  };

  /* -------------------- 行政表單 -------------------- */
  const Forms = {
  render(){
    const kw=(document.getElementById('formFilterKeyword').value||'').toLowerCase();
    const cat=document.getElementById('formFilterCategory').value;
    const list=document.getElementById('formsList');
    let arr = Store.data.forms.filter(f=>f.active);
    if(cat) arr=arr.filter(f=>f.category===cat);
    if(kw){
      arr=arr.filter(f=>{
        const text=(f.name+' '+(f.keywords||[]).join(' ')+' '+(f.description||'')).toLowerCase();
        return text.includes(kw);
      });
    }
    if(!arr.length){
      list.innerHTML='<div class="col-12 text-center py-5 text-muted"><i class="bi bi-file-earmark-arrow-down display-6 d-block mb-2"></i> 無表單</div>';
      return;
    }
    list.innerHTML = arr.map(f=>`
      <div class="col-md-6 col-lg-4">
        <div class="form-download-item h-100 d-flex flex-column">
          <div class="d-flex justify-content-between align-items-start">
            <h6 class="fw-semibold mb-1 text-truncate" title="${f.name}">${f.name}</h6>
            <span class="badge bg-secondary">${f.category}</span>
          </div>
          <div class="small text-muted mb-2" style="min-height:40px;">${f.description||'—'}</div>
            <div class="mb-2 small">
              ${(f.keywords||[]).map(k=>`<span class="badge bg-light text-dark me-1">${k}</span>`).join('')}
            </div>
          <div class="mt-auto d-flex gap-2">
            <a href="${f.url}" target="_blank" class="btn btn-primary btn-sm flex-grow-1"><i class="bi bi-download"></i> 下載</a>
            <button class="btn btn-outline-secondary btn-sm" onclick="Forms.preview('${f.id}')" title="預覽">
              <i class="bi bi-eye"></i>
            </button>
          </div>
        </div>
      </div>
    `).join('');
  },
  preview(id){
    const f=Store.data.forms.find(x=>x.id===id); if(!f) return;
    Swal.fire({
      title:f.name,
      html:`<div class="text-start small">
        <div>分類：<strong>${f.category}</strong></div>
        <div class="mt-1">關鍵字：${(f.keywords||[]).join(', ')||'—'}</div>
        <div class="mt-2" style="white-space:pre-wrap;">${f.description||'—'}</div>
        <div class="mt-2"><a href="${f.url}" target="_blank">${f.url}</a></div>
      </div>`,
      confirmButtonText:'關閉'
    });
  }
  };

  /* 表單管理 UI */
  const FormUI = {
  modal:null,
  manager:null,
  openManager(){
    if(!this.manager) this.manager=new bootstrap.Modal(document.getElementById('formManagerModal'));
    this.renderTable();
    this.manager.show();
  },
  renderTable(){
    const tb=document.getElementById('formTableBody');
    const arr=Store.data.forms;
    if(!arr.length){
      tb.innerHTML='<tr><td colspan="6" class="text-center text-muted py-4">尚無表單</td></tr>';
      return;
    }
    tb.innerHTML = arr.map(f=>`
      <tr>
        <td class="fw-semibold">${f.name}</td>
        <td><span class="badge bg-secondary">${f.category}</span></td>
        <td class="small text-truncate" style="max-width:140px;"><a href="${f.url}" target="_blank"><i class="bi bi-link-45deg"></i> 連結</a></td>
        <td class="small">${(f.keywords||[]).map(k=>`<span class="badge bg-light text-dark me-1">${k}</span>`).join('')}</td>
        <td><span class="badge ${f.active?'bg-success':'bg-secondary'}">${f.active?'啟用':'停用'}</span></td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-sm btn-outline-primary" onclick="FormUI.openEditor('${f.id}')"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="FormUI.delete('${f.id}')"><i class="bi bi-trash"></i></button>
          </div>
        </td>
      </tr>
    `).join('');
  },
  openEditor(id=null){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('formEditModal'));
    document.getElementById('formEditForm').reset();
    document.getElementById('formId').value='';
    document.getElementById('formEditTitle').textContent='新增表單';
    document.getElementById('formActive').checked=true;
    if(id){
      const f=Store.data.forms.find(x=>x.id===id);
      if(f){
        document.getElementById('formEditTitle').textContent='編輯表單';
        document.getElementById('formId').value=f.id;
        document.getElementById('formName').value=f.name;
        document.getElementById('formCategory').value=f.category;
        document.getElementById('formUrl').value=f.url;
        document.getElementById('formKeywords').value=(f.keywords||[]).join(',');
        document.getElementById('formDescription').value=f.description||'';
        document.getElementById('formActive').checked=!!f.active;
      }
    }
    this.modal.show();
  },
  save(){
    const id=document.getElementById('formId').value;
    const f={
      id:id||Util.uuid(),
      name:document.getElementById('formName').value.trim(),
      category:document.getElementById('formCategory').value,
      url:document.getElementById('formUrl').value.trim(),
      keywords:document.getElementById('formKeywords').value.split(',').map(x=>x.trim()).filter(Boolean),
      description:document.getElementById('formDescription').value.trim(),
      active:document.getElementById('formActive').checked,
      createdAt: id?(Store.data.forms.find(x=>x.id===id)?.createdAt||new Date().toISOString()):new Date().toISOString(),
      updatedAt:new Date().toISOString()
    };
    if(id){
      const idx=Store.data.forms.findIndex(x=>x.id===f.id);
      if(idx>-1) Store.data.forms[idx]=f;
    } else Store.data.forms.push(f);
    Store.save();
    this.renderTable(); Forms.render();
    this.modal.hide();
    Util.showToast('success', id?'表單已更新':'表單已新增');
  },
  delete(id){
    Util.confirm({title:'刪除表單',text:'確定要刪除這個表單？',confirmColor:'#dc3545'}).then(r=>{
      if(!r.isConfirmed) return;
      Store.data.forms = Store.data.forms.filter(f=>f.id!==id);
      Store.save(); this.renderTable(); Forms.render();
      Util.showToast('success','表單已刪除');
    });
  }
  };

  /* -------------------- 帳戶模組 -------------------- */
  const Accounts = {
  ensureDefaults(){
    if(!Store.data.accounts.length){
      Store.data.accounts.push(
        {id:Util.uuid(),name:'現金',description:'現金往來',initialBalance:0,currentBalance:0,active:true,notes:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},
        {id:Util.uuid(),name:'銀行',description:'銀行帳戶',initialBalance:0,currentBalance:0,active:true,notes:'',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}
      );
      Store.save();
    }
  },
  recalcBalances(){
    Store.data.accounts.forEach(a=>{
      let bal=Util.toNumber(a.initialBalance);
      Store.data.transactions.forEach(t=>{
        if(t.account===a.name){
          if(t.type==='收入') bal+=Util.toNumber(t.amount);
          else bal-=Util.toNumber(t.amount);
        }
      });
      a.currentBalance=bal;
    });
  }
  };

  /* 帳戶 UI */
  const AccountUI = {
  manager:null, editor:null,
  openManager(){
    if(!this.manager) this.manager=new bootstrap.Modal(document.getElementById('accountManagerModal'));
    this.renderTable();
    this.manager.show();
  },
  renderTable(){
    Accounts.recalcBalances();
    const tb=document.getElementById('accountTableBody');
    const arr=Store.data.accounts;
    if(!arr.length){
      tb.innerHTML='<tr><td colspan="6" class="text-center text-muted py-4">尚無帳戶</td></tr>'; return;
    }
    tb.innerHTML = arr.map(a=>`
      <tr>
        <td class="fw-semibold">${a.name}</td>
        <td class="small">${a.description||'-'}</td>
        <td class="text-end small">$${Util.fmtNum(a.initialBalance)}</td>
        <td class="text-end fw-semibold ${a.currentBalance>=0?'text-success':'text-danger'}">$${Util.fmtNum(a.currentBalance)}</td>
        <td><span class="badge ${a.active?'bg-success':'bg-secondary'}">${a.active?'啟用':'停用'}</span></td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-sm btn-outline-primary" title="編輯" onclick="AccountUI.openEditor('${a.id}')"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-outline-${Store.data.transactions.some(t=>t.account===a.name)?'secondary disabled':'danger'}" title="刪除" onclick="AccountUI.delete('${a.id}')"><i class="bi bi-trash"></i></button>
          </div>
        </td>
      </tr>
    `).join('');
  },
  openEditor(id=null){
    if(!this.editor) this.editor=new bootstrap.Modal(document.getElementById('accountEditModal'));
    document.getElementById('accountForm').reset();
    document.getElementById('accountId').value='';
    document.getElementById('accountEditTitle').textContent='新增帳戶';
    document.getElementById('accountActive').checked=true;
    if(id){
      const a=Store.data.accounts.find(x=>x.id===id);
      if(a){
        document.getElementById('accountEditTitle').textContent='編輯帳戶';
        document.getElementById('accountId').value=a.id;
        document.getElementById('accountName').value=a.name;
        document.getElementById('accountDesc').value=a.description||'';
        document.getElementById('accountInitial').value=a.initialBalance||0;
        document.getElementById('accountNotes').value=a.notes||'';
        document.getElementById('accountActive').checked=!!a.active;
      }
    }
    this.editor.show();
  },
  save(){
    const id=document.getElementById('accountId').value;
    const name=document.getElementById('accountName').value.trim();
    if(!name) return Util.showToast('error','請輸入帳戶名稱');
    // 不允許同名（編輯除外）
    if(Store.data.accounts.some(a=>a.name===name && a.id!==id)){
      return Util.showToast('error','已有相同名稱帳戶');
    }
    const acc={
      id: id||Util.uuid(),
      name,
      description: document.getElementById('accountDesc').value.trim(),
      initialBalance: Util.toNumber(document.getElementById('accountInitial').value),
      notes: document.getElementById('accountNotes').value.trim(),
      active: document.getElementById('accountActive').checked,
      currentBalance:0,
      createdAt: id?(Store.data.accounts.find(x=>x.id===id)?.createdAt||new Date().toISOString()):new Date().toISOString(),
      updatedAt:new Date().toISOString()
    };
    if(id){
      const idx=Store.data.accounts.findIndex(x=>x.id===acc.id);
      if(idx>-1) Store.data.accounts[idx]=acc;
    } else Store.data.accounts.push(acc);
    Accounts.recalcBalances();
    Store.save();
    this.renderTable();
    Dashboard.refresh();
    this.editor.hide();
    Util.showToast('success', id?'帳戶已更新':'帳戶已新增');
  },
  delete(id){
    const a=Store.data.accounts.find(x=>x.id===id);
    if(!a) return;
    if(Store.data.transactions.some(t=>t.account===a.name)){
      return Util.showToast('error','已有交易紀錄，無法刪除，可改停用');
    }
    Util.confirm({title:'刪除帳戶',text:`確定刪除「${a.name}」？`,confirmColor:'#dc3545'}).then(r=>{
      if(!r.isConfirmed) return;
      Store.data.accounts = Store.data.accounts.filter(x=>x.id!==id);
      Store.save(); this.renderTable(); Dashboard.refresh();
      Util.showToast('success','帳戶已刪除');
    });
  }
  };

  /* -------------------- 系統設定 -------------------- */
  const SettingsUI = {
  modal:null,
  open(){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('settingsModal'));
    const s=Store.data.settings;
    document.getElementById('setOrgName').value=s.organizationName||'';
    document.getElementById('setOrgAddress').value=s.organizationAddress||'';
    document.getElementById('setOrgPhone').value=s.organizationPhone||'';
    document.getElementById('setOrgEmail').value=s.organizationEmail||'';
    document.getElementById('setDefaultFee').value=s.defaultMembershipFee||1000;
    document.getElementById('setReceiptPrefix').value=s.receiptPrefix||'R';
    document.getElementById('setVoucherPrefix').value=s.voucherPrefix||'V';
    document.getElementById('setSealTreasurer').value=s.treasurerSeal||'出納';
    document.getElementById('setSealAccountant').value=s.accountantSeal||'會計';
    document.getElementById('setSealChairman').value=s.chairmanSeal||'理事長';
    document.getElementById('setAutoBackup').checked=!!s.enableAutoBackup;
    document.getElementById('setNotifications').checked=!!s.enableNotifications;
    this.renderCategories();
    this.modal.show();
  },
  renderCategories(){
    const incBox=document.getElementById('incomeCategoryList');
    const expBox=document.getElementById('expenseCategoryList');
    const cats=Store.data.settings.categories;
    incBox.innerHTML = (cats['收入']||[]).map(c=>`<span class="badge bg-primary pointer" onclick="SettingsUI.removeCategory('收入','${c}')">${c}</span>`).join(' ');
    expBox.innerHTML = (cats['支出']||[]).map(c=>`<span class="badge bg-danger pointer" onclick="SettingsUI.removeCategory('支出','${c}')">${c}</span>`).join(' ');
  },
  addCategory(type){
    const input = type==='收入'?document.getElementById('newIncomeCat'):document.getElementById('newExpenseCat');
    const val=input.value.trim();
    if(!val) return;
    if(!Store.data.settings.categories[type]) Store.data.settings.categories[type]=[];
    if(Store.data.settings.categories[type].includes(val)){
      Util.showToast('error','已存在');
      return;
    }
    Store.data.settings.categories[type].push(val);
    input.value='';
    this.renderCategories();
    Store.save();
    Util.showToast('success','已新增類別');
  },
  removeCategory(type,cat){
    Util.confirm({title:'刪除類別',text:`確定刪除「${cat}」？`}).then(r=>{
      if(!r.isConfirmed) return;
      Store.data.settings.categories[type] = (Store.data.settings.categories[type]||[]).filter(c=>c!==cat);
      Store.save(); this.renderCategories();
    });
  },
  resetCategoryConfirm(){
    Util.confirm({title:'重置類別',text:'確定還原為預設收入/支出類別？',confirmColor:'#dc3545'}).then(r=>{
      if(!r.isConfirmed) return;
      Store.data.settings.categories={
        '收入':['會費','捐款','活動收入','政府補助','利息收入','其他收入'],
        '支出':['活動費用','辦公費用','交通費','餐費','場地費','設備費','印刷費','郵電費','保險費','其他支出']
      };
      Store.save(); this.renderCategories();
      Util.showToast('success','已重置');
    });
  },
  save(){
    const s=Store.data.settings;
    s.organizationName=document.getElementById('setOrgName').value.trim();
    s.organizationAddress=document.getElementById('setOrgAddress').value.trim();
    s.organizationPhone=document.getElementById('setOrgPhone').value.trim();
    s.organizationEmail=document.getElementById('setOrgEmail').value.trim();
    s.defaultMembershipFee=Util.toNumber(document.getElementById('setDefaultFee').value)||1000;
    s.receiptPrefix=document.getElementById('setReceiptPrefix').value.trim()||'R';
    s.voucherPrefix=document.getElementById('setVoucherPrefix').value.trim()||'V';
    s.treasurerSeal=document.getElementById('setSealTreasurer').value.trim()||'出納';
    s.accountantSeal=document.getElementById('setSealAccountant').value.trim()||'會計';
    s.chairmanSeal=document.getElementById('setSealChairman').value.trim()||'理事長';
    s.enableAutoBackup=document.getElementById('setAutoBackup').checked;
    s.enableNotifications=document.getElementById('setNotifications').checked;
    Store.save();
    this.modal.hide();
    Util.showToast('success','設定已儲存');
  }
  };

  /* -------------------- 批次匯入 -------------------- */
  const BatchImport = {
  modal:null,
  context:{
    transactions:{raw:[],mapped:[],headers:[],fieldMap:{},preview:[],errors:0,duplicates:0},
    members:{raw:[],mapped:[],headers:[],fieldMap:{},preview:[],errors:0,duplicates:0}
  },
  open(type){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('batchImportModal'));
    this.modal.show();
    // 預設顯示 tab (Bootstrap 5 自動)
  },
  downloadTemplate(type){
    if(type==='transactions'){
      const headers=['日期','類型','類別','金額','對象','帳戶','說明','編號','附件','狀態'];
      Util.downloadBlob('transactions_template.csv',headers.join(',')+'\n','text/csv');
    } else {
      const headers=['姓名','電話','Email','加入日期','狀態','會員類型','年費','最後繳費日期','標籤'];
      Util.downloadBlob('members_template.csv',headers.join(',')+'\n','text/csv');
    }
    Util.showToast('success','已下載範本');
  },
  clear(type){
    this.context[type]={raw:[],mapped:[],headers:[],fieldMap:{},preview:[],errors:0,duplicates:0};
    this.updatePreview(type);
  },
  handleFile(type){
    const input=document.getElementById(type==='transactions'?'batchTxFile':'batchMemberFile');
    const file=input.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=e=>{
      let data;
      if(file.name.endsWith('.csv')){
        data = e.target.result.split(/\r?\n/).filter(r=>r.trim()).map(r=>r.split(','));
      } else {
        const wb = XLSX.read(e.target.result,{type:'binary'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        data = XLSX.utils.sheet_to_json(ws,{header:1,raw:false,defval:''});
      }
      const headers=data.shift().map(h=>h.trim());
      this.context[type].headers=headers;
      this.context[type].raw=data;
      this.autoMap(type);
      this.parse(type);
    };
    if(file.name.endsWith('.csv')) reader.readAsText(file,'utf-8');
    else reader.readAsBinaryString(file);
  },
  autoMap(type){
    const map={};
    const H=this.context[type].headers;
    const norm = s=>s.replace(/\s/g,'').toLowerCase();
    if(type==='transactions'){
      const dict={
        date:['日期','date'],
        type:['類型','type'],
        category:['類別','分類','category'],
        amount:['金額','金額(元)','amount'],
        counterparty:['對象','對方','counterparty'],
        account:['帳戶','account'],
        description:['說明','備註','描述','description'],
        receiptNumber:['收據編號','receipt','receiptno','receipt number'],
        voucherNumber:['憑證編號','voucher','voucherno','voucher number']
      };
      Object.entries(dict).forEach(([k,arr])=>{
        const idx=H.findIndex(h=>arr.includes(norm(h)));
        if(idx>-1) map[k]=idx;
      });
    } else {
      const dict={
        name:['姓名','name'],
        phone:['電話','手機','phone'],
        email:['email','電子郵件','mail'],
        joinDate:['加入日期','入會日期','joindate'],
        status:['狀態','status'],
        type:['會員類型','類型','type'],
        membershipFee:['年費','會費','fee'],
        lastPaymentDate:['最後繳費日期','繳費日期','lastpayment'],
        tags:['標籤','tags']
      };
      Object.entries(dict).forEach(([k,arr])=>{
        const idx=H.findIndex(h=>arr.includes(norm(h)));
        if(idx>-1) map[k]=idx;
      });
    }
    this.context[type].fieldMap=map;
    this.renderFieldMap(type);
  },
  renderFieldMap(type){
    const box=document.getElementById(type==='transactions'?'batchTxFieldMap':'batchMemberFieldMap');
    const H=this.context[type].headers;
    if(!H.length){ box.innerHTML='<div class="text-muted">尚未載入</div>'; return; }
    const required = type==='transactions'? ['date','type','category','amount'] : ['name','phone','joinDate','status','type'];
    const mapKeys= type==='transactions'
      ? {date:'日期',type:'類型',category:'類別',amount:'金額',counterparty:'對象',account:'帳戶',description:'說明',receiptNumber:'收據編號',voucherNumber:'憑證編號'}
      : {name:'姓名',phone:'電話',email:'Email',joinDate:'加入日',status:'狀態',type:'會員類型',membershipFee:'年費',lastPaymentDate:'最後繳費',tags:'標籤'};
    let html='';
    Object.entries(mapKeys).forEach(([field,label])=>{
      html+=`<div class="mb-1">
        <label class="small">${label}${required.includes(field)?'<span class="text-danger">*</span>':''}</label>
        <select class="form-select form-select-sm mapping-select" onchange="BatchImport.updateMap('${type}','${field}',this.value)">
          <option value="">(不匯入)</option>
          ${H.map((h,i)=>`<option value="${i}" ${this.context[type].fieldMap[field]==i?'selected':''}>${h||('欄位'+i)}</option>`).join('')}
        </select>
      </div>`;
    });
    box.innerHTML=html;
  },
  updateMap(type,field,val){
    if(val==='') delete this.context[type].fieldMap[field];
    else this.context[type].fieldMap[field]=Number(val);
    this.parse(type);
  },
  reparse(type){ this.parse(type); },
  parse(type){
    const ctx=this.context[type];
    ctx.mapped=[];
    ctx.errors=0; ctx.duplicates=0;
    const seen=new Set();
    ctx.raw.forEach(row=>{
      const obj={_raw:row,_valid:true,_duplicate:false,_error:[]};
      if(type==='transactions'){
        obj.date = Util.formatDateInput(row[ctx.fieldMap.date]||'');
        obj.type = (row[ctx.fieldMap.type]||'').trim();
        obj.category = (row[ctx.fieldMap.category]||'').trim();
        obj.amount = Util.toNumber(row[ctx.fieldMap.amount]);
        obj.counterparty = ctx.fieldMap.counterparty!=null? (row[ctx.fieldMap.counterparty]||'').trim():'';
        obj.account = ctx.fieldMap.account!=null? (row[ctx.fieldMap.account]||'').trim():'';
        obj.description = ctx.fieldMap.description!=null? (row[ctx.fieldMap.description]||'').trim():'';
        // 驗證
        if(!obj.date) obj._error.push('日期');
        if(!['收入','支出'].includes(obj.type)) obj._error.push('類型');
        if(!obj.category) obj._error.push('類別');
        if(!(obj.amount>0)) obj._error.push('金額');
        const key=[obj.date,obj.type,obj.category,obj.amount,obj.counterparty].join('|');
        if(seen.has(key)){ obj._duplicate=true; ctx.duplicates++; }
        else seen.add(key);
        if(obj._error.length){ obj._valid=false; ctx.errors++; }
      } else {
        obj.name = (row[ctx.fieldMap.name]||'').trim();
        obj.phone = (row[ctx.fieldMap.phone]||'').trim();
        obj.email = ctx.fieldMap.email!=null?(row[ctx.fieldMap.email]||'').trim():'';
        obj.joinDate = Util.formatDateInput(row[ctx.fieldMap.joinDate]||'');
        obj.status = (row[ctx.fieldMap.status]||'active').trim()||'active';
        obj.type = (row[ctx.fieldMap.type]||'regular').trim()||'regular';
        obj.membershipFee = Util.toNumber(row[ctx.fieldMap.membershipFee]||document.getElementById('batchMemberDefaultFee').value||Store.data.settings.defaultMembershipFee||1000);
        obj.lastPaymentDate = ctx.fieldMap.lastPaymentDate!=null? Util.formatDateInput(row[ctx.fieldMap.lastPaymentDate]||'') : '';
        const tagStr = ctx.fieldMap.tags!=null? (row[ctx.fieldMap.tags]||''):'';
        obj.tags = tagStr.split(/[;,，]/).map(t=>t.trim()).filter(Boolean);
        if(!obj.name) obj._error.push('姓名');
        if(!obj.phone) obj._error.push('電話');
        if(!obj.joinDate) obj._error.push('加入');
        const key=[obj.name,obj.phone,obj.joinDate].join('|');
        if(seen.has(key)){ obj._duplicate=true; ctx.duplicates++; }
        else seen.add(key);
        if(obj._error.length){ obj._valid=false; ctx.errors++; }
      }
      ctx.mapped.push(obj);
    });
    this.updatePreview(type);
  },
  filterPreview(type,mode){
    this._filterMode=mode;
    this.updatePreview(type);
  },
  updatePreview(type){
    const ctx=this.context[type];
    const headEl=document.getElementById(type==='transactions'?'batchTxHead':'batchMemberHead');
    const bodyEl=document.getElementById(type==='transactions'?'batchTxBody':'batchMemberBody');
    const statsEl=document.getElementById(type==='transactions'?'batchTxStats':'batchMemberStats');
    if(!ctx.mapped.length){
      headEl.innerHTML=''; bodyEl.innerHTML='<tr><td class="text-muted">尚未載入檔案</td></tr>';
      statsEl.textContent='尚未載入資料'; return;
    }
    let cols=[];
    if(type==='transactions'){
      cols=['日期','類型','類別','金額','對象','帳戶','說明','狀態'];
    } else {
      cols=['姓名','電話','Email','加入日','狀態','類型','年費','最後繳費','標籤','狀態'];
    }
    headEl.innerHTML='<tr>'+cols.map(c=>`<th class="small">${c}</th>`).join('')+'</tr>';
    let list=ctx.mapped;
    switch(this._filterMode){
      case 'errors': list=list.filter(r=>!r._valid); break;
      case 'duplicates': list=list.filter(r=>r._duplicate); break;
      default: // all
    }
    const preview=list.slice(0,200);
    bodyEl.innerHTML = preview.map(r=>{
      const cls = r._duplicate?'row-duplicate':(!r._valid?'row-invalid':'');
      if(type==='transactions'){
        return `<tr class="small ${cls}">
          <td>${r.date||''}</td><td>${r.type||''}</td><td>${r.category||''}</td>
          <td class="text-end">${r.amount}</td><td>${r.counterparty||''}</td><td>${r.account||''}</td>
          <td>${r.description||''}</td>
          <td>${r._duplicate?'<span class="badge bg-warning text-dark preview-status-badge">重複</span>':''}
              ${!r._valid?'<span class="badge bg-danger preview-status-badge">錯誤:'+r._error.join('/')+'</span>':''}</td>
        </tr>`;
      } else {
        return `<tr class="small ${cls}">
          <td>${r.name||''}</td><td>${r.phone||''}</td><td>${r.email||''}</td>
          <td>${r.joinDate||''}</td><td>${r.status||''}</td><td>${r.type||''}</td>
          <td class="text-end">${r.membershipFee}</td><td>${r.lastPaymentDate||''}</td>
          <td>${(r.tags||[]).join(', ')}</td>
          <td>${r._duplicate?'<span class="badge bg-warning text-dark preview-status-badge">重複</span>':''}
              ${!r._valid?'<span class="badge bg-danger preview-status-badge">錯誤:'+r._error.join('/')+'</span>':''}</td>
        </tr>`;
      }
    }).join('');
    statsEl.textContent = `總筆數 ${ctx.mapped.length}；錯誤 ${ctx.errors}；重複 ${ctx.duplicates}；預覽顯示 ${preview.length}`;
  },
  commit(type){
    const skipErr=document.getElementById(type==='transactions'?'batchTxSkipError':'batchMemberSkipError').checked;
    const skipDup=document.getElementById(type==='transactions'?'batchTxSkipDup':'batchMemberSkipDup').checked;
    const ctx=this.context[type];
    if(!ctx.mapped.length) return Util.showToast('error','無資料');
    let imported=0;
    if(type==='transactions'){
      ctx.mapped.forEach(r=>{
        if(r._duplicate && skipDup) return;
        if(!r._valid && skipErr) return;
        if(!r._valid) return; // 強制略過錯誤
        const tx={
          id:Util.uuid(),
          date:r.date,
          type:r.type,
          category:r.category,
          amount:r.amount,
          counterparty:r.counterparty||'',
          account:r.account||Store.data.accounts.find(a=>a.active)?.name||'現金',
          description:r.description||'',
          receiptNumber: r.type==='收入'? Numbering.receipt():undefined,
          voucherNumber: r.type==='支出'? Numbering.voucher():undefined,
          vouchers:[],
          createdAt:new Date().toISOString(),
          updatedAt:new Date().toISOString()
        };
        Store.data.transactions.push(tx);
        imported++;
      });
      Store.save(); Transactions.renderTable(); Dashboard.refresh();
    } else {
      ctx.mapped.forEach(r=>{
        if(r._duplicate && skipDup) return;
        if(!r._valid && skipErr) return;
        if(!r._valid) return;
        const m={
          id:Util.uuid(),
          name:r.name,
          phone:r.phone,
          email:r.email||'',
          birthDate:'',
          gender:'',
          idNumber:'',
          address:'',
          emergencyContact:'',
          emergencyPhone:'',
          notes:'',
          joinDate:r.joinDate,
          status:r.status||'active',
          type:r.type||'regular',
          membershipFee:r.membershipFee||Store.data.settings.defaultMembershipFee||1000,
          lastPaymentDate:r.lastPaymentDate||'',
          tags:r.tags||[],
          createdAt:new Date().toISOString(),
          updatedAt:new Date().toISOString()
        };
        Store.data.members.push(m);
        imported++;
      });
      Store.save(); Members.renderTable(); Dashboard.refresh();
    }
    Util.showToast('success',`匯入完成：${imported} 筆`);
    this.clear(type);
  }
  };

  /* -------------------- 統計分析 -------------------- */
  const Analytics = {
  charts:{},
  refresh(){
    // 填年份選單
    const yearSel=document.getElementById('analyticsYear');
    if(yearSel && yearSel.options.length===1){
      const years=[...new Set(Store.data.transactions.map(t=>t.date.slice(0,4)))].sort().reverse();
      years.forEach(y=>{
        const opt=document.createElement('option'); opt.value=y; opt.textContent=y; yearSel.appendChild(opt);
      });
    }
    const year=yearSel.value || (new Date().getFullYear().toString());
    if(!yearSel.value){ yearSel.value=year; }
    // 統計
    const txYear = Store.data.transactions.filter(t=>t.date.startsWith(year+'-'));
    const incomeByMonth=Array(12).fill(0), expenseByMonth=Array(12).fill(0);
    let totalIncome=0,totalExpense=0;
    txYear.forEach(t=>{
      const m=Number(t.date.slice(5,7))-1;
      if(t.type==='收入'){ incomeByMonth[m]+=t.amount; totalIncome+=t.amount; }
      else { expenseByMonth[m]+=t.amount; totalExpense+=t.amount; }
    });
    const balance=totalIncome-totalExpense;
    const avg=(totalIncome+totalExpense)? Math.round(balance/12):0;
    document.getElementById('anaTotalIncome').textContent='$'+Util.fmtNum(totalIncome);
    document.getElementById('anaTotalExpense').textContent='$'+Util.fmtNum(totalExpense);
    document.getElementById('anaBalance').textContent='$'+Util.fmtNum(balance);
    document.getElementById('anaAvgMonthly').textContent='$'+Util.fmtNum(avg);

    // 收支趨勢 (折線)
    this.renderChart('chartTrend',{
      type:'line',
      data:{
        labels:[...Array(12)].map((_,i)=> (i+1)+'月'),
        datasets:[
          {label:'收入',data:incomeByMonth,borderColor:'#28a745',backgroundColor:'rgba(40,167,69,0.2)',tension:.25},
          {label:'支出',data:expenseByMonth,borderColor:'#dc3545',backgroundColor:'rgba(220,53,69,0.2)',tension:.25}
        ]
      }
    });
    // 支出類別占比
    const expenseCat = {};
    txYear.filter(t=>t.type==='支出').forEach(t=>{
      expenseCat[t.category]= (expenseCat[t.category]||0)+t.amount;
    });
    this.renderChart('chartExpenseCategory',{
      type:'doughnut',
      data:{
        labels:Object.keys(expenseCat),
        datasets:[{
          data:Object.values(expenseCat),
          backgroundColor:Object.keys(expenseCat).map((_,i)=>`hsl(${i*37%360} 70% 60%)`)
        }]
      },
      options:{plugins:{legend:{position:'bottom'}}}
    });
    // 月度收支對比 (bar)
    this.renderChart('chartMonthlyCompare',{
      type:'bar',
      data:{
        labels:[...Array(12)].map((_,i)=> (i+1)+'月'),
        datasets:[
          {label:'收入',data:incomeByMonth,backgroundColor:'#198754'},
          {label:'支出',data:expenseByMonth,backgroundColor:'#dc3545'}
        ]
      },
      options:{responsive:true,scales:{x:{stacked:false},y:{beginAtZero:true}}}
    });
    // 會員成長
    const memberByMonth=Array(12).fill(0);
    Store.data.members.forEach(m=>{
      if(m.joinDate.startsWith(year+'-')){
        const mm=Number(m.joinDate.slice(5,7))-1;
        memberByMonth[mm]++;
      }
    });
    let cumulative=0;
    const cumulativeArr=memberByMonth.map(v=> cumulative+=v);
    this.renderChart('chartMemberGrowth',{
      type:'line',
      data:{
        labels:[...Array(12)].map((_,i)=> (i+1)+'月'),
        datasets:[
          {label:'新增會員',data:memberByMonth,borderColor:'#0d6efd',backgroundColor:'rgba(13,110,253,0.2)',tension:.25},
          {label:'累計新增',data:cumulativeArr,borderColor:'#6610f2',backgroundColor:'rgba(102,16,242,0.15)',tension:.25}
        ]
      }
    });
  },
  renderChart(id,cfg){
    if(!document.getElementById(id)) return;
    if(this.charts[id]){ this.charts[id].destroy(); }
    this.charts[id]= new Chart(document.getElementById(id),cfg);
  }
  };

  /* -------------------- 報表中心 -------------------- */
  const Reports = {
  current:{type:null,html:''},
  initDateOnce(){
    const start=document.getElementById('reportStart');
    const end=document.getElementById('reportEnd');
    if(!start.value){
      const now=new Date();
      start.value= now.toISOString().slice(0,7)+'-01';
      end.value= Util.today();
    }
  },
  quickDate(mode){
    const now=new Date();
    if(mode==='thisMonth'){
      const start = new Date(now.getFullYear(), now.getMonth(),1);
      document.getElementById('reportStart').value=start.toISOString().split('T')[0];
      document.getElementById('reportEnd').value=Util.today();
    } else if(mode==='thisYear'){
      document.getElementById('reportStart').value= now.getFullYear()+'-01-01';
      document.getElementById('reportEnd').value= Util.today();
    }
  },
  generate(type){
    this.current.type=type;
    const start=document.getElementById('reportStart').value;
    const end=document.getElementById('reportEnd').value;
    if(!start||!end) return Util.showToast('error','請選擇期間');
    const tx=Store.data.transactions.filter(t=> t.date>=start && t.date<=end).sort((a,b)=> a.date.localeCompare(b.date));
    let html='';
    if(type==='cashbook'){
      const rows=tx.filter(t=>t.account==='現金');
      let balance=0;
      html=`<h5 class="mb-3">現金出納帳 (${start} ~ ${end})</h5>
        <table class="table table-sm table-bordered">
          <thead><tr><th>日期</th><th>類型</th><th>類別</th><th class="text-end">收入</th><th class="text-end">支出</th><th class="text-end">結餘</th><th>說明</th></tr></thead>
          <tbody>
            ${rows.map(r=>{
              if(r.type==='收入') balance+=r.amount; else balance-=r.amount;
              return `<tr>
                <td>${r.date}</td>
                <td>${r.type}</td>
                <td>${r.category}</td>
                <td class="text-end">${r.type==='收入'?Util.fmtNum(r.amount):''}</td>
                <td class="text-end">${r.type==='支出'?Util.fmtNum(r.amount):''}</td>
                <td class="text-end">${Util.fmtNum(balance)}</td>
                <td class="small">${r.description||''}</td>
              </tr>`;
            }).join('')||'<tr><td colspan="7" class="text-center text-muted">無資料</td></tr>'}
          </tbody>
        </table>`;
    } else if(type==='incomeExpense'){
      let inc=0,exp=0;
      tx.forEach(r=> r.type==='收入'? inc+=r.amount: exp+=r.amount);
      html=`<h5 class="mb-3">收支決算表 (${start} ~ ${end})</h5>
        <table class="table table-sm table-bordered w-auto">
          <tbody>
            <tr><th>總收入</th><td class="text-end text-success">$${Util.fmtNum(inc)}</td></tr>
            <tr><th>總支出</th><td class="text-end text-danger">$${Util.fmtNum(exp)}</td></tr>
            <tr><th>結餘</th><td class="text-end fw-semibold">$${Util.fmtNum(inc-exp)}</td></tr>
            <tr><th>大寫</th><td>${Util.financialChinese(inc-exp)}</td></tr>
          </tbody>
        </table>`;
      // 分類明細
      const incCat={}, expCat={};
      tx.forEach(r=>{
        if(r.type==='收入') incCat[r.category]=(incCat[r.category]||0)+r.amount;
        else expCat[r.category]=(expCat[r.category]||0)+r.amount;
      });
      html+=`<div class="row mt-4">
        <div class="col-md-6">
          <h6>收入分類</h6>
          <table class="table table-sm table-bordered">
            <thead><tr><th>類別</th><th class="text-end">金額</th></tr></thead>
            <tbody>${Object.entries(incCat).map(([k,v])=>`<tr><td>${k}</td><td class="text-end">$${Util.fmtNum(v)}</td></tr>`).join('')||'<tr><td colspan="2" class="text-center text-muted">無</td></tr>'}</tbody>
          </table>
        </div>
        <div class="col-md-6">
          <h6>支出分類</h6>
          <table class="table table-sm table-bordered">
            <thead><tr><th>類別</th><th class="text-end">金額</th></tr></thead>
            <tbody>${Object.entries(expCat).map(([k,v])=>`<tr><td>${k}</td><td class="text-end">$${Util.fmtNum(v)}</td></tr>`).join('')||'<tr><td colspan="2" class="text-center text-muted">無</td></tr>'}</tbody>
          </table>
        </div>
      </div>`;
    } else if(type==='balanceSheet'){
      // 簡化版（假設：現金+銀行 = 資產；會員會費預收忽略）
      Accounts.recalcBalances();
      const assets = Store.data.accounts.reduce((s,a)=>s+a.currentBalance,0);
      html=`<h5 class="mb-3">資產負債表（截至 ${end}）</h5>
        <table class="table table-sm table-bordered w-auto">
          <thead><tr><th>科目</th><th class="text-end">金額</th></tr></thead>
          <tbody>
            <tr><td>流動資產（帳戶餘額）</td><td class="text-end">$${Util.fmtNum(assets)}</td></tr>
            <tr><td>負債合計</td><td class="text-end">$0</td></tr>
            <tr><td class="fw-semibold">淨資產 / 結存</td><td class="text-end fw-semibold">$${Util.fmtNum(assets)}</td></tr>
          </tbody>
        </table>`;
    } else if(type==='ledger'){
      // 年度分類帳 (使用期間內分類)
      const byCat={};
      tx.forEach(t=>{
        const key=t.type+'-'+t.category;
        if(!byCat[key]) byCat[key]={type:t.type,category:t.category,total:0};
        byCat[key].total+=t.amount;
      });
      html=`<h5 class="mb-3">分類帳彙總 (${start} ~ ${end})</h5>
        <table class="table table-sm table-bordered">
          <thead><tr><th>類型</th><th>類別</th><th class="text-end">金額</th></tr></thead>
          <tbody>
            ${Object.values(byCat).sort((a,b)=> a.type.localeCompare(b.type)||a.category.localeCompare(b.category))
              .map(r=>`<tr><td>${r.type}</td><td>${r.category}</td><td class="text-end $${r.type==='收入'?'text-success':'text-danger'}">$${Util.fmtNum(r.total)}</td></tr>`).join('')||'<tr><td colspan="3" class="text-center text-muted">無</td></tr>'}
          </tbody>
        </table>`;
    } else if(type==='journal'){
      html=`<h5 class="mb-3">綜合流水帳 (${start} ~ ${end})</h5>
        <table class="table table-sm table-bordered">
          <thead><tr><th>日期</th><th>類型</th><th>類別</th><th class="text-end">金額</th><th>對象</th><th>帳戶</th><th>說明</th><th>編號</th></tr></thead>
          <tbody>${tx.map(t=>`<tr>
            <td>${t.date}</td><td>${t.type}</td><td>${t.category}</td>
            <td class="text-end ${t.type==='收入'?'text-success':'text-danger'}">${t.type==='收入'?'+':'-'}$${Util.fmtNum(t.amount)}</td>
            <td>${t.counterparty||''}</td><td>${t.account||''}</td>
            <td class="small">${t.description||''}</td>
            <td class="small">${t.receiptNumber||t.voucherNumber||''}</td>
          </tr>`).join('')||'<tr><td colspan="8" class="text-center text-muted">無</td></tr>'}</tbody>
        </table>`;
    } else if(type==='member'){
      const total=Store.data.members.length;
      const active=Store.data.members.filter(m=>m.status==='active').length;
      const overdue=Store.data.members.filter(m=>Members.isOverdue(m)).length;
      const typeCount={};
      Store.data.members.forEach(m=> typeCount[m.type]=(typeCount[m.type]||0)+1);
      html=`<h5 class="mb-3">會員統計報表 (${start} ~ ${end})</h5>
        <table class="table table-sm table-bordered w-auto">
          <tbody>
            <tr><th>總會員</th><td>${total}</td></tr>
            <tr><th>正常</th><td>${active}</td></tr>
            <tr><th>逾期會費</th><td>${overdue}</td></tr>
          </tbody>
        </table>
        <h6 class="mt-3">會員類型分布</h6>
        <table class="table table-sm table-bordered w-auto">
          <thead><tr><th>類型</th><th class="text-end">人數</th></tr></thead>
          <tbody>${Object.entries(typeCount).map(([k,v])=>`<tr><td>${Members.typeText(k)}</td><td class="text-end">${v}</td></tr>`).join('')}</tbody>
        </table>`;
    } else {
      html='<div class="text-muted">尚未實作</div>';
    }
    this.current.html=html;
    document.getElementById('reportModalTitle').textContent='報表 - '+this.reportName(type);
    document.getElementById('reportModalBody').innerHTML=html;
    new bootstrap.Modal(document.getElementById('reportModal')).show();
  },
  reportName(type){
    return {
      cashbook:'現金出納帳',
      incomeExpense:'收支決算表',
      balanceSheet:'資產負債表',
      ledger:'年度分類帳',
      journal:'綜合流水帳',
      member:'會員報表'
    }[type]||type;
  },
  print(){
    const w=window.open('','_blank');
    w.document.write(`<html><head><title>${this.reportName(this.current.type)}</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
      </head><body class="p-3">
      ${this.current.html}
      </body></html>`);
    w.document.close();
    setTimeout(()=>w.print(),300);
  },
  exportHTML(){
    const content=`<meta charset="utf-8"><title>${this.reportName(this.current.type)}</title>${this.current.html}`;
    Util.downloadBlob(this.reportName(this.current.type)+'.html',content,'text/html');
  }
  };

  /* -------------------- 匯入/匯出 -------------------- */
  const DataPort = {
  exportAll(){
    const all={
      transactions:Store.data.transactions,
      members:Store.data.members,
      accounts:Store.data.accounts,
      activities:Store.data.activities,
      registrations:Store.data.registrations,
      announcements:Store.data.announcements,
      forms:Store.data.forms,
      settings:Store.data.settings
    };
    Util.downloadBlob('backup_'+Date.now()+'.json',JSON.stringify(all,null,2),'application/json');
    Util.showToast('success','已匯出全部資料');
  },
  importAll(){
    const input=document.createElement('input');
    input.type='file'; input.accept='.json,application/json';
    input.onchange=e=>{
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=ev=>{
        try{
          const obj=JSON.parse(ev.target.result);
          Object.keys(obj).forEach(k=>{
            if(k in Store.data) Store.data[k]=obj[k];
          });
          Store.save(); Dashboard.refresh(); Transactions.renderTable(); Members.renderTable(); Activities.renderGrid(); Announcements.render(); Forms.render();
          Util.showToast('success','資料已匯入');
        }catch(err){ Util.showToast('error','匯入失敗'); }
      };
      reader.readAsText(file,'utf-8');
    };
    input.click();
  },
  exportTransactions(ids=null){
    let rows=Store.data.transactions;
    if(ids && ids.length) rows=rows.filter(r=>ids.includes(r.id));
    Util.downloadBlob('transactions_'+Date.now()+'.json',JSON.stringify(rows,null,2),'application/json');
    Util.showToast('success','交易已匯出');
  },
  exportMembers(ids=null){
    let rows=Store.data.members;
    if(ids && ids.length) rows=rows.filter(r=>ids.includes(r.id));
    Util.downloadBlob('members_'+Date.now()+'.json',JSON.stringify(rows,null,2),'application/json');
    Util.showToast('success','會員已匯出');
  },
  exportActivities(){
    Util.downloadBlob('activities_'+Date.now()+'.json',JSON.stringify(Store.data.activities,null,2),'application/json');
    Util.showToast('success','活動已匯出');
  },
  exportAnnouncements(){
    Util.downloadBlob('announcements_'+Date.now()+'.json',JSON.stringify(Store.data.announcements,null,2),'application/json');
    Util.showToast('success','公告已匯出');
  },
  exportActivityRegistrations(actId){
    const regs=Store.data.registrations.filter(r=>r.activityId===actId);
    Util.downloadBlob('activity_'+actId+'_regs.json',JSON.stringify(regs,null,2),'application/json');
    Util.showToast('success','已匯出報名');
  }
  };

  /* -------------------- 列印功能 -------------------- */
  const Print = {
  receipt(id){
    const t=Store.data.transactions.find(x=>x.id===id && x.type==='收入');
    if(!t) return Util.showToast('error','找不到收據資料');
    this._openDoc(this._receiptHTML([t]));
  },
  voucher(id){
    const t=Store.data.transactions.find(x=>x.id===id && x.type==='支出');
    if(!t) return Util.showToast('error','找不到憑證資料');
    this._openDoc(this._voucherHTML([t]));
  },
  batchReceipts(ids){
    const rows=Store.data.transactions.filter(t=>t.type==='收入' && ids.includes(t.id));
    if(!rows.length) return Util.showToast('error','沒有收入交易');
    this._openDoc(this._receiptHTML(rows));
  },
  batchVouchers(ids){
    const rows=Store.data.transactions.filter(t=>t.type==='支出' && ids.includes(t.id));
    if(!rows.length) return Util.showToast('error','沒有支出交易');
    this._openDoc(this._voucherHTML(rows));
  },

  // 單一樣式 (原 A 版) 收據 HTML 產生 (已將單位章放大 1.5 倍)
  _receiptHTML(rows){
    const sealURL = 'https://lh3.googleusercontent.com/pw/AP1GczOMBwHMxnGPiewNhQlkpif8fIKCvEWPOBy-o6OdrM6nX8CLYd3HH4jLSY6bklXi6aajHMHkNcqIYFymb9fOmrd7DZj6ZhmDhnHSnCogMgquwL4OURCBfpbpqIpzm_E-oxHu68NlVF9vN3jkynNLCQi-xA=w913-h923-s-no-gm?authuser=0';
    const s = Store.data.settings || {};
    const orgName = s.organizationName || '組織名稱';
    const orgAddress = s.organizationAddress || '';
    const orgPhone = s.organizationPhone || '';
    const orgEmail = s.organizationEmail || '';
    const contactLine = [orgAddress, orgPhone?`電話：${orgPhone}`:'', orgEmail?`Email：${orgEmail}`:'']
      .filter(Boolean).join('　');

    // 可改為設定值
    const ORG_ACCOUNT_INFO = {
      accountName: '社團法人台灣帕金森病友權益促進會',
      license: '立案證書字號(1080027359)',
      bankLine1: '第一銀行三重埔分行',
      bankLine2: '(007) 21110150402',
      taxId: '85202581'
    };

    const accountInfoBox = `
      <div class="org-extra-box">
        <div class="item"><span class="lbl">戶名：</span>${ORG_ACCOUNT_INFO.accountName}</div>
        <div class="item"><span class="lbl">政府立案：</span>${ORG_ACCOUNT_INFO.license}</div>
        <div class="item"><span class="lbl">捐款帳號：</span>${ORG_ACCOUNT_INFO.bankLine1} <span class="break-bank">${ORG_ACCOUNT_INFO.bankLine2}</span></div>
        <div class="item"><span class="lbl">統一編號：</span>${ORG_ACCOUNT_INFO.taxId}</div>
      </div>
    `;

    const baseTable = (r) => `
      <table class="meta">
        <tr>
          <th style="width:100px;">收據編號</th><td style="width:180px;">${r.receiptNumber || ''}</td>
          <th style="width:80px;">日期</th><td>${r.date}</td>
        </tr>
        <tr>
          <th>收款類別</th><td>${r.category}</td>
          <th>金額</th><td class="highlight">$${Util.fmtNum(r.amount)}</td>
        </tr>
        <tr>
          <th>付款人</th><td>${r.counterparty || ''}</td>
          <th>帳戶</th><td>${r.account || ''}</td>
        </tr>
        <tr>
          <th>中文大寫</th><td colspan="3" class="uppercase">${Util.financialChinese(r.amount)}</td>
        </tr>
        <tr>
          <th>備註 / 說明</th><td colspan="3" class="notes">${(r.description||'').replace(/</g,'&lt;')}</td>
        </tr>
      </table>
    `;

    const signTable3 = `
      <table class="sign sign-3">
        <tr>
          <th>出納</th>
          <th>會計</th>
          <th>理事長</th>
        </tr>
        <tr class="seal-row">
          <td><div class="seal">${s.treasurerSeal || '出納'}</div></td>
          <td><div class="seal">${s.accountantSeal || '會計'}</div></td>
          <td><div class="seal">${s.chairmanSeal || '理事長'}</div></td>
        </tr>
      </table>
    `;

    const genReceipt = (r, copyType) => {
      return `
        <div class="receipt">
          <div class="title has-top-seal">
            <div class="title-main">${orgName} 收據 <span class="eng">/ RECEIPT</span></div>
            <div class="copy-type">（${copyType}）</div>
          </div>
          ${contactLine?`<div class="org-info">${contactLine}</div>`:''}
          ${accountInfoBox}
          <img src="${sealURL}" class="org-seal" alt="單位章">
          ${baseTable(r)}
          ${signTable3}
          <div class="foot-note">本收據僅供內部核銷</div>
        </div>
      `;
    };

    const blockPerRow = (r) => `
      <div class="row-block">
        <div class="row-caption">=== 收據資料：${r.receiptNumber || ''} / ${r.date} ===</div>
        <div class="pair-wrapper">
          ${genReceipt(r,'收執聯')}
          <div class="cut-line">剪裁線</div>
          ${genReceipt(r,'存根聯')}
        </div>
        <div class="page-divider"></div>
      </div>
    `;

    return `<html><head><meta charset="utf-8">
    <title>收據列印</title>
    <style>
      *{box-sizing:border-box;}
      body{font-family:"Noto Sans TC","Microsoft JhengHei",sans-serif;margin:14px;color:#222;}
      h1{font-size:20px;margin:0 0 12px;font-weight:700;}
      .intro{font-size:12px;color:#555;margin-bottom:14px;line-height:1.5;}
      .row-block{margin-bottom:40px; page-break-after:always;}
      .row-caption{font-size:13px;font-weight:600;color:#333;margin:10px 4px 10px;letter-spacing:0.5px;}
      .pair-wrapper{border:2px dashed #ccc;padding:12px;background:#fafafa;position:relative;}
      .receipt{border:1px solid #444;padding:12px 14px 10px;background:#fff;position:relative;margin-bottom:14px;}
      .cut-line{text-align:center;font-size:10.5px;letter-spacing:2px;color:#666;margin:4px 0 10px;position:relative;}
      .cut-line:before,.cut-line:after{content:"";position:absolute;top:50%;width:44%;height:1px;background:repeating-linear-gradient(90deg,#999 0 6px,transparent 6px 12px);}
      .cut-line:before{left:0;} .cut-line:after{right:0;}

      :root{
        --org-seal-base:85px;
        --seal-scale:1.5;
      }

      .title{display:flex;justify-content:space-between;align-items:flex-end;flex-wrap:wrap;gap:6px;padding-right:calc(var(--org-seal-base) * var(--seal-scale) + 25px);min-height:40px;}
      .title-main{font-size:18px;font-weight:700;letter-spacing:1px;}
      .eng{font-size:11px;font-weight:400;color:#666;}
      .copy-type{font-size:12px;font-weight:600;color:#444;}
      .org-info{font-size:10.5px;color:#555;margin-top:4px;line-height:1.4;}
      .org-extra-box{
        margin-top:6px;
        border:1px solid #d4d4d8;
        background:#f9f9fb;
        padding:6px 8px 4px;
        font-size:11.5px;
        line-height:1.45;
        border-radius:4px;
      }
      .org-extra-box .item + .item{margin-top:2px;}
      .org-extra-box .lbl{
        display:inline-block;
        min-width:64px;
        color:#222;
        font-weight:600;
        letter-spacing:1px;
      }
      .org-extra-box .break-bank{
        display:inline-block;
        margin-left:6px;
        white-space:nowrap;
      }

      /* 單位章放大 1.5 倍 (由 85px -> 127.5px) */
      .org-seal{
        position:absolute;
        top:10px;
        right:10px;
        width:calc(var(--org-seal-base) * var(--seal-scale));
        height:auto;
        object-fit:contain;
        filter:drop-shadow(0 2px 4px rgba(0,0,0,.25));
        opacity:0.92;
      }

      table{width:100%;border-collapse:collapse;font-size:12.5px;margin-top:6px;}
      table.meta th, table.meta td{border:1px solid #555;padding:3px 5px;vertical-align:top;}
      table.meta th{background:#f3f5f7;text-align:left;font-weight:600;white-space:nowrap;font-size:12px;}
      .highlight{font-weight:700;color:#b30000;}
      .uppercase{font-weight:600;letter-spacing:2px;}
      .notes{min-height:40px;white-space:pre-wrap;}

      table.sign{margin-top:8px;font-size:12px;}
      table.sign th, table.sign td{border:1px solid #555;padding:5px 4px;text-align:center;}
      table.sign th{background:#f7f7f7;font-weight:600;font-size:12px;}
      .sign-3 th, .sign-3 td{width:33.33%;}
      .seal-row td{height:82px;position:relative;}

      .seal{width:64px;height:64px;border:2px solid #c00;border-radius:50%;margin:0 auto;display:flex;justify-content:center;align-items:center;font-size:12px;font-weight:700;color:#c00;}

      .foot-note{margin-top:4px;font-size:10px;color:#555;text-align:right;font-style:italic;}

      .page-divider{height:0;border-top:4px double #aaa;margin-top:24px;}

      @media print{
        body{margin:10px;}
        .pair-wrapper{border:0;background:#fff;padding:0;}
        .receipt{page-break-inside:avoid;}
        .row-block{margin-bottom:18px;}
        .page-divider{display:none;}
        h1,.intro,.row-caption{page-break-after:avoid;}
      }
    </style>
    </head><body>
      <h1>收據列印</h1>
      <div class="intro">
      如有疑問，請再告知。
      </div>
      ${rows.map(r=>blockPerRow(r)).join('')}
      <script>
        const imgs=[...document.images];
        Promise.all(imgs.map(i=> i.complete ? Promise.resolve() : new Promise(res=>{i.onload=res;i.onerror=res;})))
          .then(()=>console.log('All seals loaded.'));
      <\/script>
    </body></html>`;
  },

  _voucherHTML(rows, opts = {}){
      const s = Store.data.settings || {};
      const {
        attachAreaFixedHeight = null,
        printOnLoad = true,
        gap = 18
      } = opts;

      function buildVoucherHTML(t){
        const voucherNo = t.voucherNumber || t.receiptNumber || '';
        const chineseUpper = Util.financialChinese(t.amount);
        const todayStr = new Date().toISOString().split('T')[0];
        const attachStyle = attachAreaFixedHeight ? `style="height:${attachAreaFixedHeight}px;flex:none;"` : '';
        return `
          <div class="voucher-sheet">
            <div class="title-line">${s.organizationName || '本會'}　支出憑證黏貼單</div>
            <div class="info-row">
              <div><span class="label">日期：</span>${t.date || ''}</div>
              <div><span class="label">憑證編號：</span>${voucherNo}</div>
            </div>
            <div class="body-flex">
              <table class="block-table">
                <tr><td class="block-label">預算項目</td><td>${t.category || ''}</td></tr>
                <tr><td class="block-label">憑證金額</td><td>NT$ ${(Number(t.amount)||0).toLocaleString()}</td></tr>
                <tr><td class="block-label">中文大寫</td><td class="uppercase-amt">${chineseUpper}</td></tr>
                <tr class="usage-row">
                  <td class="block-label">用途說明</td>
                  <td class="usage-box">${(t.description||'').replace(/</g,'&lt;')}</td>
                </tr>
              </table>
              <table class="sign-table">
                <tr>
                  <th>活動主辦</th><th>出納</th><th>會計</th><th>負責人 / 理事長</th>
                </tr>
                <tr>
                  <td><div class="sign-name">${s.activityHost || ''}</div></td>
                  <td><div class="sign-name">${s.treasurerSeal || '出納'}</div></td>
                  <td><div class="sign-name">${s.accountantSeal || '會計'}</div></td>
                  <td><div class="sign-name">${s.chairmanSeal || '理事長'}</div></td>
                </tr>
              </table>
              <div class="footer-note">
                <span>1. 附原始憑證核章 2. 金額塗改無效 3. 本單與憑證留存備查</span>
                <span class="print-date">列印日期：${todayStr}</span>
              </div>
              <div class="attach-area" ${attachStyle}>
                <span>憑證黏貼處</span>
                <div class="attach-hint">請貼發票 / 收據</div>
              </div>
            </div>
          </div>
        `;
      }

      const style = `
      <style>
        *{box-sizing:border-box;}
        body{
          font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,sans-serif;
          margin:16px;
          -webkit-print-color-adjust:exact;
          print-color-adjust:exact;
        }
        .voucher-sheet{
          border:1px solid #333;
          padding:12px 14px 16px;
          margin:0 0 ${gap}px 0;
          page-break-inside:avoid;
          break-inside:avoid;
          position:relative;
          display:flex;
          flex-direction:column;
          gap:10px;
        }
        .title-line{
          font-size:18px;
            font-weight:700;
          text-align:center;
          letter-spacing:1px;
        }
        .info-row{
          display:flex;
          justify-content:space-between;
          font-size:13px;
          padding:4px 2px 2px;
          border-bottom:1px dashed #aaa;
          gap:12px;
          flex-wrap:wrap;
        }
        .info-row .label{color:#444;font-weight:600;}
        .body-flex{display:flex;flex-direction:column;gap:14px;}
        table{border-collapse:collapse;width:100%;font-size:13px;line-height:1.4;}
        .block-table td{border:1px solid #555;padding:6px 8px;vertical-align:top;}
        .block-label{width:90px;background:#f5f5f5;font-weight:600;text-align:center;white-space:nowrap;}
        .usage-row .usage-box{min-height:72px;white-space:pre-wrap;word-break:break-word;}
        .uppercase-amt{letter-spacing:2px;font-weight:600;color:#222;}
        .sign-table{width:100%;border:1px solid #555;}
        .sign-table th,.sign-table td{border:1px solid #555;text-align:center;padding:6px 4px;font-size:12px;}
        .sign-table th{background:#f2f2f2;font-weight:600;}
        .sign-name{height:58px;display:flex;align-items:flex-end;justify-content:center;padding-bottom:4px;font-weight:600;font-size:13px;}
        .footer-note{font-size:11px;color:#333;line-height:1.5;display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px;border-top:1px dashed #aaa;padding-top:6px;}
        .print-date{font-weight:500;}
        .attach-area{
          margin-top:2px;
          border:2px dashed #999;
          border-radius:4px;
          flex:1;
          min-height:${attachAreaFixedHeight ? attachAreaFixedHeight+'px' : '200px'};
          display:flex;
          flex-direction:column;
          align-items:center;
          justify-content:center;
          gap:6px;
          font-size:14px;
          color:#666;
          background:repeating-linear-gradient(45deg, rgba(0,0,0,0.03) 0 10px, rgba(0,0,0,0) 10px 20px);
          position:relative;
        }
        .attach-area span{font-weight:600;font-size:15px;letter-spacing:2px;}
        .attach-hint{font-size:12px;color:#888;}
        @media print {
          body{margin:8mm;}
          .voucher-sheet{break-inside:avoid;page-break-inside:avoid;box-shadow:none;}
        }
      </style>`;

      const content = (rows || []).map(r => buildVoucherHTML(r)).join('');
      return `
        <html>
          <head><meta charset="utf-8" />
            <title>${s.organizationName || ''} 支出憑證</title>
            ${style}
          </head>
          <body>
            ${content}
            ${printOnLoad ? '<script>window.print();<\/script>' : ''}
          </body>
        </html>
      `;
    },

    _openDoc(html){
      const w = window.open('','_blank');
      if(!w){
        Util.showToast('error','瀏覽器阻擋彈出視窗');
        return;
      }
      w.document.write(html);
      w.document.close();
    },

    openVoucherWindow(rows, opts){
      const html = this._voucherHTML(rows, opts);
      this._openDoc(html);
    }
  };

  // ========== 舊接口：開新視窗顯示 ==========
  function _openDoc(html){
    const w = window.open('','_blank');
    w.document.write(html);
    w.document.close();
  }

  // ========== 便捷：直接輸出並開窗 ==========
  function openVoucherWindow(rows, opts){
    const html = _voucherHTML(rows, opts);
    _openDoc(html);
  }

  // ========== (選擇性) 範例用助攻函式：若環境沒有可簡易補上 ==========
  // 若你環境已有就刪除此區
  if (typeof convertToChineseUpper !== 'function') {
    window.convertToChineseUpper = function(num){
      if (typeof Util !== 'undefined' && typeof Util.financialChinese === 'function')
        return Util.financialChinese(num);
      // 簡易 fallback
      return String(num || 0);
    };
  }

  /* -------------------- 雲端同步 (示意) -------------------- */
  const GoogleSync = {
  modal:null,
  open(){
    if(!this.modal) this.modal=new bootstrap.Modal(document.getElementById('googleSyncModal'));
    const s=Store.data.settings;
    document.getElementById('gsEnable').checked=!!s.googleSyncEnabled;
    document.getElementById('gsInterval').value=s.googleSyncInterval||'manual';
    this.togglePanel();
    const gs=Store.data.googleSync;
    document.getElementById('gsStatus').textContent = gs.connected? `已連線，上次同步：${gs.lastSync||'無'}` : '尚未連線';
    document.getElementById('gsConnectBtn').disabled=gs.connected;
    document.getElementById('gsSyncBtn').disabled=!gs.connected;
    document.getElementById('gsRestoreBtn').disabled=!gs.connected;
    this.modal.show();
  },
  togglePanel(){
    document.getElementById('gsPanel').style.display=document.getElementById('gsEnable').checked?'block':'none';
  },
  connect(){
    Store.data.googleSync.connected=true;
    Store.data.googleSync.lastSync=new Date().toISOString();
    Store.save();
    Util.showToast('success','已模擬連線');
    this.open();
  },
  sync(){
    Store.data.googleSync.lastSync=new Date().toISOString();
    Store.save();
    Util.showToast('success','已模擬上傳同步');
    this.open();
  },
  restore(){
    Util.showToast('success','已模擬從雲端還原(無實際動作)');
  },
  saveSettings(){
    Store.data.settings.googleSyncEnabled=document.getElementById('gsEnable').checked;
    Store.data.settings.googleSyncInterval=document.getElementById('gsInterval').value;
    Store.save();
    Util.showToast('success','同步設定已儲存');
    this.modal.hide();
  }
  };

  /* -------------------- 全域搜尋 -------------------- */
  const GlobalSearch = {
  exec(){
    const kw=(document.getElementById('globalSearchInput').value||'').trim().toLowerCase();
    if(!kw) return Util.showToast('error','請輸入搜尋關鍵字');
    const tx=Store.data.transactions.filter(t=>
      (t.category+' '+(t.counterparty||'')+' '+(t.description||'')+' '+(t.receiptNumber||'')+' '+(t.voucherNumber||'')).toLowerCase().includes(kw)
    ).slice(0,10);
    const members=Store.data.members.filter(m=>
      (m.name+' '+m.phone+' '+(m.email||'')+' '+(m.tags||[]).join(' ')).toLowerCase().includes(kw)
    ).slice(0,10);
    const acts=Store.data.activities.filter(a=>
      (a.name+' '+(a.description||'')).toLowerCase().includes(kw)
    ).slice(0,10);
    const anns=Store.data.announcements.filter(a=>
      (a.title+' '+(a.content||'')).toLowerCase().includes(kw)
    ).slice(0,10);
    let html='<div class="text-start">';
    html+='<h6 class="mt-2">交易</h6>'+(tx.length?'<ul class="list-unstyled small mb-1">'+tx.map(t=>`<li><a href="#" onclick="AppLayout.showSection('+"'transactions'"+'); setTimeout(()=>Transactions.filter()); return false;">${t.date} ${t.category} ${t.amount}</a></li>`).join(''):'<div class="text-muted small">無</div>');
    html+='<h6 class="mt-2">會員</h6>'+(members.length?'<ul class="list-unstyled small mb-1">'+members.map(m=>`<li>${m.name} (${m.phone})</li>`).join(''):'<div class="text-muted small">無</div>');
    html+='<h6 class="mt-2">活動</h6>'+(acts.length?'<ul class="list-unstyled small mb-1">'+acts.map(a=>`<li>${a.name}</li>`).join(''):'<div class="text-muted small">無</div>');
    html+='<h6 class="mt-2">公告</h6>'+(anns.length?'<ul class="list-unstyled small mb-1">'+anns.map(a=>`<li>${a.title}</li>`).join(''):'<div class="text-muted small">無</div>');
    html+='</div>';
    Swal.fire({title:'搜尋結果',html,width:600});
  }
  };

  /* -------------------- 快捷鍵 / 關於 / 重置 -------------------- */
  const Shortcuts = {
  show(){
    Swal.fire({
      title:'快捷鍵',
      html:`<div class="text-start small">
        <ul>
          <li><kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>T</kbd>：新增交易</li>
          <li><kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>M</kbd>：新增會員</li>
          <li><kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>A</kbd>：新增活動</li>
          <li><kbd>/</kbd>：焦點到全域搜尋</li>
        </ul>
      </div>`,
      confirmButtonText:'關閉'
    });
  }
  };
  const About = {
  show(){
    Swal.fire({
      title:'關於系統',
      html:`<div class="text-start small">
        <p>非營利組織整合管理示例系統（離線 LocalStorage Demo）。</p>
        <p>功能：財務 / 會員 / 活動 / 公告 / 表單 / 匯入匯出 / 簡易報表 / 列印。</p>
        <p>版本：v1.0 (示例)</p>
      </div>`,
      confirmButtonText:'關閉'
    });
  }
  };
  const ConfirmReset = {
  show(){
    Util.confirm({title:'系統重置',text:'將清除所有本機資料(不可回復)，確定？',confirmColor:'#dc3545'}).then(r=>{
      if(!r.isConfirmed) return;
      Object.values(Store.keys).forEach(k=>localStorage.removeItem(k));
      location.reload();
    });
  }
  };
  // ... 其他方法保持不變 ...
  
/* -------------------- 啟動流程 -------------------- */
window.addEventListener('load', async ()=>{
  await Store.load();
  
  // 填交易年份下拉
  const years=[...new Set(Store.data.transactions.map(t=>t.date.slice(0,4)))].sort().reverse();
  const yearSel=document.getElementById('txFilterYear');
  if(yearSel){
    years.forEach(y=>{
      const opt=document.createElement('option'); opt.value=y; opt.textContent=y; yearSel.appendChild(opt);
    });
  }
  
  AppLayout.showSection('dashboard');
  Dashboard.refresh();
  Counterparty.refreshDatalist();
});

// 其他模組也需要類似的修改，將 Store.save() 改為對應的 API 呼叫
// 例如：Members.save() -> API.saveMember()
// Activities.save() -> API.saveActivity() 等等

  </script>
</body>
</html>
