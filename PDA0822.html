<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>台灣帕金森病友權益促進會 - 會計暨營運整合管理系統</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
  :root {
    --primary-color: #0d6efd;
    --success-color: #198754;
    --info-color: #0dcaf0;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --dark-color: #212529;
    --light-color: #f8f9fa;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--light-color);
  }

  .sidebar {
    background: linear-gradient(135deg, var(--primary-color), #0056b3);
    min-height: 100vh;
    transition: all 0.3s ease;
    position: fixed;
    top: 0;
    left: -250px;
    width: 250px;
    z-index: 1000;
  }

  .sidebar.show {
    left: 0;
  }

  .sidebar .nav-link {
    color: rgba(255,255,255,0.8);
    padding: 0.75rem 1rem;
    border-radius: 0.375rem;
    margin: 0.25rem 0.5rem;
    transition: all 0.2s ease;
  }

  .sidebar .nav-link:hover,
  .sidebar .nav-link.active {
    color: white;
    background-color: rgba(255,255,255,0.1);
    transform: translateX(5px);
  }

  .main-content {
    margin-left: 0;
    transition: all 0.3s ease;
    min-height: 100vh;
  }

  @media (min-width: 992px) {
    .sidebar {
      position: relative;
      left: 0;
    }
    .main-content {
      margin-left: 250px;
    }
  }

  .navbar {
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .card {
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  }

  .stat-card {
    background: linear-gradient(135deg, var(--primary-color), #0056b3);
    color: white;
  }

  .stat-card.success {
    background: linear-gradient(135deg, var(--success-color), #146c43);
  }

  .stat-card.info {
    background: linear-gradient(135deg, var(--info-color), #0aa2c0);
  }

  .stat-card.warning {
    background: linear-gradient(135deg, var(--warning-color), #cc9a00);
  }

  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  .loading-spinner {
    width: 3rem;
    height: 3rem;
    border: 0.3rem solid rgba(255,255,255,0.3);
    border-top: 0.3rem solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .sync-indicator {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 1000;
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 1rem;
  }

  .online-indicator {
    background-color: var(--success-color);
    color: white;
  }

  .offline-indicator {
    background-color: var(--danger-color);
    color: white;
  }

  .content-section {
    padding: 1.5rem;
  }

  .table th {
    background-color: var(--light-color);
    font-weight: 600;
    border-top: none;
  }

  .btn {
    border-radius: 0.375rem;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .btn:hover {
    transform: translateY(-1px);
  }

  .form-control:focus,
  .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  }

  .modal-content {
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }

  .toast {
    border: none;
  }

  .sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    display: none;
  }

  @media (max-width: 991.98px) {
    .sidebar.show + .sidebar-overlay {
      display: block;
    }
  }
</style>
</head>

<body>
<!-- 載入覆蓋層 -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="text-center text-white">
    <div class="loading-spinner mb-3"></div>
    <div>載入中...</div>
  </div>
</div>

<!-- 同步狀態指示器 -->
<div id="syncIndicator" class="sync-indicator online-indicator">
  <i class="bi bi-cloud-check"></i> 已同步
</div>
<div id="offlineIndicator" class="sync-indicator offline-indicator" style="display:none;">
  <i class="bi bi-cloud-slash"></i> 離線
</div>

<div class="d-flex">
  <!-- 側邊欄 -->
  <nav id="sidebar" class="sidebar">
    <div class="p-3">
      <h5 class="text-white mb-0">
        <i class="bi bi-heart-pulse me-2"></i>帕金森病友會
      </h5>
      <small class="text-white-50">管理系統 v2.0</small>
    </div>
    
    <ul class="nav flex-column">
      <li class="nav-item">
        <a class="nav-link active" href="#" onclick="AppLayout.showSection('dashboard', this)">
          <i class="bi bi-speedometer2 me-2"></i>儀表板
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="AppLayout.showSection('transactions', this)">
          <i class="bi bi-receipt me-2"></i>交易記錄
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="AppLayout.showSection('members', this)">
          <i class="bi bi-people me-2"></i>會員管理
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="AppLayout.showSection('activities', this)">
          <i class="bi bi-calendar-event me-2"></i>活動管理
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="AppLayout.showSection('announcements', this)">
          <i class="bi bi-megaphone me-2"></i>公告管理
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="AppLayout.showSection('forms', this)">
          <i class="bi bi-file-earmark-text me-2"></i>表單管理
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="AppLayout.showSection('analytics', this)">
          <i class="bi bi-graph-up me-2"></i>統計分析
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="AppLayout.showSection('reports', this)">
          <i class="bi bi-file-earmark-bar-graph me-2"></i>報表中心
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="SettingsUI.open()">
          <i class="bi bi-sliders me-2"></i>系統設定
        </a>
      </li>
    </ul>

    <div class="mt-auto p-3">
      <div class="dropup">
        <button class="btn btn-outline-light btn-sm dropdown-toggle w-100" data-bs-toggle="dropdown">
          <i class="bi bi-tools me-1"></i>工具
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" onclick="AccountUI.openManager()">
            <i class="bi bi-bank me-2"></i>帳戶管理</a></li>
          <li><a class="dropdown-item" href="#" onclick="BatchImport.open('transactions')">
            <i class="bi bi-cloud-upload me-2"></i>批次匯入</a></li>
          <li><a class="dropdown-item" href="#" onclick="DataPort.exportAll()">
            <i class="bi bi-download me-2"></i>匯出資料</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" onclick="SystemTest.run()">
            <i class="bi bi-clipboard-check me-2"></i>系統測試</a></li>
          <li><a class="dropdown-item" href="#" onclick="About.show()">
            <i class="bi bi-info-circle me-2"></i>關於系統</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- 側邊欄遮罩 (手機版) -->
  <div class="sidebar-overlay" onclick="AppLayout.toggleSidebar(false)"></div>

  <!-- 主要內容區 -->
  <div class="main-content flex-grow-1">
    <!-- 頂部導航 -->
    <nav class="navbar navbar-expand-lg navbar-light">
      <div class="container-fluid">
        <button class="btn btn-outline-primary d-lg-none" onclick="AppLayout.toggleSidebar()">
          <i class="bi bi-list"></i>
        </button>
        
        <div class="navbar-nav me-auto">
          <div class="nav-item">
            <div class="input-group">
              <input id="globalSearchInput" type="text" class="form-control" placeholder="全域搜尋... (按 / 快速開啟)" style="width:300px;">
              <button class="btn btn-outline-secondary" onclick="GlobalSearch.exec()">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="navbar-nav">
          <div class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bi bi-bell"></i>
              <span class="badge bg-danger rounded-pill">3</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><h6 class="dropdown-header">通知</h6></li>
              <li><a class="dropdown-item" href="#">
                <div class="d-flex">
                  <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                  <div>
                    <div class="fw-semibold">會費到期提醒</div>
                    <small class="text-muted">5位會員會費即將到期</small>
                  </div>
                </div>
              </a></li>
              <li><a class="dropdown-item" href="#">
                <div class="d-flex">
                  <i class="bi bi-calendar-event text-info me-2"></i>
                  <div>
                    <div class="fw-semibold">活動報名</div>
                    <small class="text-muted">健康講座報名已開始</small>
                  </div>
                </div>
              </a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <!-- 主要內容 -->
    <main class="container-fluid">
      <!-- 儀表板 -->
      <section id="dashboardSection" class="content-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3><i class="bi bi-speedometer2 me-2"></i>儀表板</h3>
          <button class="btn btn-outline-primary btn-sm" onclick="Dashboard.refresh()">
            <i class="bi bi-arrow-clockwise"></i> 重新整理
          </button>
        </div>

        <!-- 統計卡片 -->
        <div class="row g-3 mb-4">
          <div class="col-lg-3 col-md-6">
            <div class="card stat-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="card-title mb-1">總收入</h6>
                    <h4 class="mb-0" id="dashTotalIncome">$0</h4>
                  </div>
                  <i class="bi bi-arrow-up-circle display-6 opacity-75"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="card stat-card success">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="card-title mb-1">總支出</h6>
                    <h4 class="mb-0" id="dashTotalExpense">$0</h4>
                  </div>
                  <i class="bi bi-arrow-down-circle display-6 opacity-75"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="card stat-card info">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="card-title mb-1">本月收入</h6>
                    <h4 class="mb-0" id="dashMonthIncome">$0</h4>
                  </div>
                  <i class="bi bi-calendar-month display-6 opacity-75"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="card stat-card warning">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="card-title mb-1">本月支出</h6>
                    <h4 class="mb-0" id="dashMonthExpense">$0</h4>
                  </div>
                  <i class="bi bi-calendar-x display-6 opacity-75"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 次要統計 -->
        <div class="row g-3 mb-4">
          <div class="col-lg-3 col-md-6">
            <div class="card">
              <div class="card-body text-center">
                <i class="bi bi-wallet2 display-6 text-primary mb-2"></i>
                <h6>總餘額</h6>
                <h5 class="text-primary" id="dashTotalBalance">$0</h5>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="card">
              <div class="card-body text-center">
                <i class="bi bi-people display-6 text-success mb-2"></i>
                <h6>會員總數</h6>
                <h5 class="text-success" id="dashMemberTotal">0</h5>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="card">
              <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle display-6 text-warning mb-2"></i>
                <h6>會費逾期</h6>
                <h5 class="text-warning" id="dashMemberOverdue">0</h5>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="card">
              <div class="card-body text-center">
                <i class="bi bi-calendar-event display-6 text-info mb-2"></i>
                <h6>本月活動</h6>
                <h5 class="text-info" id="dashMonthActivities">0</h5>
              </div>
            </div>
          </div>
        </div>

        <!-- 最近資料 -->
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="card h-100">
              <div class="card-header bg-primary text-white py-2">
                <h6 class="mb-0"><i class="bi bi-receipt me-1"></i>最近交易</h6>
              </div>
              <div class="card-body p-2" id="dashboardRecentTx">
                <div class="text-center text-muted py-4">
                  <i class="bi bi-receipt display-6 d-block mb-2"></i> 載入中...
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card h-100">
              <div class="card-header bg-success text-white py-2">
                <h6 class="mb-0"><i class="bi bi-people me-1"></i>最新會員</h6>
              </div>
              <div class="card-body p-2" id="dashboardRecentMembers">
                <div class="text-center text-muted py-4">
                  <i class="bi bi-people display-6 d-block mb-2"></i> 載入中...
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card h-100">
              <div class="card-header bg-info text-white py-2">
                <h6 class="mb-0"><i class="bi bi-calendar-event me-1"></i>近期活動</h6>
              </div>
              <div class="card-body p-2" id="dashboardRecentActivities">
                <div class="text-center text-muted py-4">
                  <i class="bi bi-calendar-event display-6 d-block mb-2"></i> 載入中...
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 交易記錄 -->
      <section id="transactionsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-receipt me-2"></i>交易記錄</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" onclick="BatchImport.open('transactions')">
              <i class="bi bi-cloud-upload"></i> 批次匯入</button>
            <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()">
              <i class="bi bi-plus-circle"></i> 新增交易</button>
          </div>
        </div>
        <div id="transactionsList">載入中...</div>
      </section>

      <!-- 會員管理 -->
      <section id="membersSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-people me-2"></i>會員管理</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" onclick="BatchImport.open('members')">
              <i class="bi bi-cloud-upload"></i> 批次匯入</button>
            <button class="btn btn-primary btn-sm" onclick="MemberUI.open()">
              <i class="bi bi-person-plus"></i> 新增會員</button>
          </div>
        </div>
        <div id="membersList">載入中...</div>
      </section>

      <!-- 活動管理 -->
      <section id="activitiesSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-calendar-event me-2"></i>活動管理</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" onclick="BatchImport.open('activities')">
              <i class="bi bi-cloud-upload"></i> 批次匯入</button>
            <button class="btn btn-primary btn-sm" onclick="ActivityUI.open()">
              <i class="bi bi-calendar-plus"></i> 新增活動</button>
          </div>
        </div>
        <div id="activitiesList">載入中...</div>
      </section>

      <!-- 公告管理 -->
      <section id="announcementsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-megaphone me-2"></i>公告管理</h4>
          <button class="btn btn-primary btn-sm" onclick="AnnouncementUI.open()">
            <i class="bi bi-plus-circle"></i> 新增公告</button>
        </div>
        <div id="announcementsList">載入中...</div>
      </section>

      <!-- 表單管理 -->
      <section id="formsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>表單管理</h4>
          <button class="btn btn-primary btn-sm" onclick="FormUI.open()">
            <i class="bi bi-plus-circle"></i> 新增表單</button>
        </div>
        <div id="formsList">載入中...</div>
      </section>

      <!-- 統計分析 -->
      <section id="analyticsSection" class="content-section" style="display:none;">
        <h4 class="mb-4"><i class="bi bi-graph-up me-2"></i>統計分析</h4>
        <div id="analyticsContent">載入中...</div>
      </section>

      <!-- 報表中心 -->
      <section id="reportsSection" class="content-section" style="display:none;">
        <h4 class="mb-4"><i class="bi bi-file-earmark-bar-graph me-2"></i>報表中心</h4>
        <div id="reportsContent">載入中...</div>
      </section>
    </main>
  </div>
</div>

<!-- 交易 Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h6 class="modal-title"><i class="bi bi-receipt me-2"></i><span id="txModalTitle">新增交易</span></h6>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="txForm">
          <input type="hidden" id="txId">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">日期 *</label>
              <input id="txDate" type="date" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">類型 *</label>
              <select id="txType" class="form-select" required>
                <option value="">請選擇</option>
                <option value="收入">收入</option>
                <option value="支出">支出</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">帳戶 *</label>
              <select id="txAccount" class="form-select" required></select>
            </div>
            <div class="col-md-6">
              <label class="form-label">類別 *</label>
              <select id="txCategory" class="form-select" required></select>
            </div>
            <div class="col-md-6">
              <label class="form-label">金額 *</label>
              <input id="txAmount" type="number" min="0" step="1" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">對象</label>
              <input id="txCounterparty" type="text" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">編號</label>
              <input id="txNumber" type="text" class="form-control" placeholder="自動產生">
            </div>
            <div class="col-12">
              <label class="form-label">說明</label>
              <textarea id="txDescription" rows="2" class="form-control"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
        <button class="btn btn-primary btn-sm" onclick="TransactionUI.save()">
          <i class="bi bi-save me-1"></i>儲存</button>
      </div>
    </div>
  </div>
</div>

<!-- 會員 Modal -->
<div class="modal fade" id="memberModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h6 class="modal-title"><i class="bi bi-person me-2"></i><span id="memberModalTitle">新增會員</span></h6>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="memberForm">
          <input type="hidden" id="memberId">
          <div class="row g-3">
            <div class="col-md-4">
              <h6 class="fw-semibold">基本資料</h6>
              <label class="form-label mt-2">姓名 *</label>
              <input id="memberName" class="form-control" required>
              <label class="form-label mt-2">電話 *</label>
              <input id="memberPhone" class="form-control" required>
              <label class="form-label mt-2">電子郵件</label>
              <input id="memberEmail" type="email" class="form-control">
              <div class="row mt-2 g-2">
                <div class="col-6">
                  <label class="form-label">出生日期</label>
                  <input id="memberBirthDate" type="date" class="form-control">
                </div>
                <div class="col-6">
                  <label class="form-label">性別</label>
                  <select id="memberGender" class="form-select">
                    <option value="">未指定</option>
                    <option value="男">男</option>
                    <option value="女">女</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <h6 class="fw-semibold">聯絡資訊</h6>
              <label class="form-label mt-2">地址</label>
              <textarea id="memberAddress" rows="3" class="form-control"></textarea>
              <label class="form-label mt-2">緊急聯絡人</label>
              <input id="emergencyContact" class="form-control">
              <label class="form-label mt-2">緊急聯絡電話</label>
              <input id="emergencyPhone" class="form-control">
              <label class="form-label mt-2">備註</label>
              <textarea id="memberNotes" rows="2" class="form-control"></textarea>
            </div>
            <div class="col-md-4">
              <h6 class="fw-semibold">會員資訊</h6>
              <label class="form-label mt-2">加入日期 *</label>
              <input id="memberJoinDate" type="date" class="form-control" required>
              <label class="form-label mt-2">狀態</label>
              <select id="memberStatus" class="form-select">
                <option value="active">正常</option>
                <option value="inactive">停權</option>
                <option value="pending">待審核</option>
              </select>
              <label class="form-label mt-2">會員類型</label>
              <select id="memberType" class="form-select">
                <option value="regular">一般會員</option>
                <option value="honorary">榮譽會員</option>
                <option value="life">終身會員</option>
                <option value="family">家屬會員</option>
              </select>
              <label class="form-label mt-2">年費金額</label>
              <input id="membershipFee" type="number" class="form-control" value="1000" min="0">
              <label class="form-label mt-2">最後繳費日期</label>
              <input id="lastPaymentDate" type="date" class="form-control">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
        <button class="btn btn-success btn-sm" onclick="MemberUI.save()">
          <i class="bi bi-save me-1"></i>儲存</button>
      </div>
    </div>
  </div>
</div>

<!-- 活動 Modal -->
<div class="modal fade" id="activityModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h6 class="modal-title"><i class="bi bi-calendar-event me-2"></i><span id="activityModalTitle">新增活動</span></h6>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="activityForm">
          <input type="hidden" id="activityId">
          <div class="row g-3">
            <div class="col-lg-8">
              <label class="form-label">活動名稱 *</label>
              <input id="activityName" class="form-control" required>
              <div class="row g-2 mt-2">
                <div class="col-md-6">
                  <label class="form-label">活動類型 *</label>
                  <select id="activityType" class="form-select" required>
                    <option value="">選擇</option>
                    <option value="講座">講座</option>
                    <option value="聚會">聚會</option>
                    <option value="旅遊">旅遊</option>
                    <option value="運動">運動</option>
                    <option value="志工">志工服務</option>
                    <option value="其他">其他</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">狀態</label>
                  <select id="activityStatus" class="form-select">
                    <option value="draft">草稿</option>
                    <option value="published">已發布</option>
                    <option value="registration">報名中</option>
                    <option value="closed">已結束</option>
                  </select>
                </div>
              </div>
              <div class="row g-2 mt-2">
                <div class="col-md-6">
                  <label class="form-label">活動日期 *</label>
                  <input id="activityDate" type="date" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">活動時間</label>
                  <input id="activityTime" type="time" class="form-control">
                </div>
              </div>
              <label class="form-label mt-2">地點</label>
              <input id="activityLocation" class="form-control">
              <label class="form-label mt-2">活動描述</label>
              <textarea id="activityDescription" rows="4" class="form-control"></textarea>
            </div>
            <div class="col-lg-4">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">人數上限</label>
                  <input id="activityMax" type="number" min="1" value="50" class="form-control">
                </div>
                <div class="col-6">
                  <label class="form-label">費用</label>
                  <input id="activityFee" type="number" min="0" value="0" class="form-control">
                </div>
              </div>
              <label class="form-label mt-2">聯絡人</label>
              <input id="activityContact" class="form-control">
              <label class="form-label mt-2">聯絡電話</label>
              <input id="activityContactPhone" class="form-control">
              <label class="form-label mt-2">備註</label>
              <textarea id="activityNotes" rows="3" class="form-control"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
        <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.save()">
          <i class="bi bi-save me-1"></i>儲存</button>
      </div>
    </div>
  </div>
</div>

<!-- 設定 Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h6 class="modal-title"><i class="bi bi-sliders me-2"></i>系統設定</h6>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="settingsForm">
          <div class="row g-3">
            <div class="col-md-6">
              <h6 class="fw-semibold mb-2">組織資訊</h6>
              <label class="form-label">組織名稱</label>
              <input id="setOrgName" class="form-control">
              <label class="form-label mt-2">地址</label>
              <textarea id="setOrgAddress" rows="2" class="form-control"></textarea>
              <label class="form-label mt-2">電話</label>
              <input id="setOrgPhone" class="form-control">
              <label class="form-label mt-2">Email</label>
              <input id="setOrgEmail" type="email" class="form-control">
            </div>
            <div class="col-md-6">
              <h6 class="fw-semibold mb-2">系統設定</h6>
              <label class="form-label">預設年費</label>
              <input id="setDefaultFee" type="number" class="form-control" value="1000" min="0">
              <label class="form-label mt-2">收據前綴</label>
              <input id="setReceiptPrefix" class="form-control" maxlength="5" value="R">
              <label class="form-label mt-2">憑證前綴</label>
              <input id="setVoucherPrefix" class="form-control" maxlength="5" value="V">
              <label class="form-label mt-2">收入類別</label>
              <input id="setIncomeCategories" class="form-control" placeholder="會費,捐款,補助,其他">
              <label class="form-label mt-2">支出類別</label>
              <input id="setExpenseCategories" class="form-control" placeholder="辦公費用,活動費用,交通費,其他">
              <div class="form-check mt-3">
                <input id="setAutoBackup" type="checkbox" class="form-check-input">
                <label for="setAutoBackup" class="form-check-label">啟用自動備份</label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
        <button class="btn btn-primary btn-sm" onclick="SettingsUI.save()">
          <i class="bi bi-save me-1"></i>儲存設定</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast 容器 -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // ===== 系統配置 =====
  const CONFIG = {
    GAS_URL: 'https://script.google.com/macros/s/AKfycbxGiCe8DYQMKIVhCJOs8CkhYdUjNIEhJWLe6jnZd0M6dMJNFkYA9YWm0ihSRElphnis3g/exec',
    VERSION: '2.0.0',
    CACHE_DURATION: 5 * 60 * 1000, // 5分鐘
    RETRY_ATTEMPTS: 3,
    RETRY_DELAY: 1000
  };

  // ===== API 模組 =====
  const api = {
    async request(action, data = {}) {
      const response = await fetch(CONFIG.GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ action, ...data })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      if (!result.success) {
        throw new Error(result.error || '操作失敗');
      }
      
      return result;
    },

    async requestWithRetry(action, data = {}, attempts = CONFIG.RETRY_ATTEMPTS) {
      for (let i = 0; i < attempts; i++) {
        try {
          return await this.request(action, data);
        } catch (error) {
          if (i === attempts - 1) throw error;
          await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * (i + 1)));
        }
      }
    }
  };

  // ===== 資料管理模組 =====
  const dataManager = {
    cache: new Map(),
    
    async getData(type) {
      const cacheKey = `data_${type}`;
      const cached = this.cache.get(cacheKey);
      
      if (cached && Date.now() - cached.timestamp < CONFIG.CACHE_DURATION) {
        return cached.data;
      }
      
      try {
        const result = await api.requestWithRetry('getData', { type });
        this.cache.set(cacheKey, {
          data: result.data || [],
          timestamp: Date.now()
        });
        return result.data || [];
      } catch (error) {
        Util.showToast('error', `載入${type}失敗: ${error.message}`);
        return cached ? cached.data : [];
      }
    },

    async saveData(type, data) {
      try {
        const result = await api.requestWithRetry('saveData', { type, data: JSON.stringify(data) });
        this.clearCache(type);
        return result;
      } catch (error) {
        Util.showToast('error', `儲存失敗: ${error.message}`);
        throw error;
      }
    },

    async deleteData(type, id) {
      try {
        const result = await api.requestWithRetry('deleteData', { type, id });
        this.clearCache(type);
        return result;
      } catch (error) {
        Util.showToast('error', `刪除失敗: ${error.message}`);
        throw error;
      }
    },

    clearCache(type = null) {
      if (type) {
        this.cache.delete(`data_${type}`);
      } else {
        this.cache.clear();
      }
    }
  };

  // ===== 工具函數 =====
  const Util = {
    today() {
      return new Date().toISOString().split('T')[0];
    },

    fmtNum(num) {
      return new Intl.NumberFormat('zh-TW').format(num || 0);
    },

    fmtDate(dateStr) {
      if (!dateStr) return '';
      return new Date(dateStr).toLocaleDateString('zh-TW');
    },

    generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    },

    showToast(type, message) {
      const toastContainer = document.getElementById('toastContainer');
      const toastId = 'toast_' + Date.now();
      
      const bgClass = {
        success: 'bg-success',
        error: 'bg-danger',
        warning: 'bg-warning',
        info: 'bg-info'
      }[type] || 'bg-primary';

      const iconClass = {
        success: 'bi-check-circle',
        error: 'bi-exclamation-triangle',
        warning: 'bi-exclamation-triangle',
        info: 'bi-info-circle'
      }[type] || 'bi-info-circle';

      const toastHtml = `
        <div id="${toastId}" class="toast ${bgClass} text-white" role="alert">
          <div class="toast-body d-flex align-items-center">
            <i class="bi ${iconClass} me-2"></i>
            <div class="flex-grow-1">${message}</div>
            <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `;
      
      toastContainer.insertAdjacentHTML('beforeend', toastHtml);
      
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
      toast.show();
      
      toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
      });
    },

    async confirm(options) {
      return await Swal.fire({
        title: options.title || '確認操作',
        text: options.text || '您確定要執行此操作嗎？',
        icon: options.icon || 'question',
        showCancelButton: true,
        confirmButtonColor: options.confirmColor || '#3085d6',
        cancelButtonColor: '#6c757d',
        confirmButtonText: options.confirmText || '確定',
        cancelButtonText: '取消'
      });
    },

    showLoading(show = true) {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = show ? 'flex' : 'none';
    }
  };

  // ===== 應用程式佈局 =====
  const AppLayout = {
    currentSection: 'dashboard',

    init() {
      this.setupEventListeners();
      this.showSection('dashboard');
      NetworkMonitor.init();
      GlobalSearch.init();
    },

    setupEventListeners() {
      // 全域快捷鍵
      document.addEventListener('keydown', (e) => {
        if (e.key === '/' && !e.target.matches('input, textarea')) {
          e.preventDefault();
          document.getElementById('globalSearchInput').focus();
        }
        if (e.key === 'Escape') {
          this.toggleSidebar(false);
        }
      });

      // 響應式側邊欄
      window.addEventListener('resize', () => {
        if (window.innerWidth >= 992) {
          this.toggleSidebar(false);
        }
      });
    },

    toggleSidebar(show = null) {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      
      if (show === null) {
        show = !sidebar.classList.contains('show');
      }
      
      sidebar.classList.toggle('show', show);
      if (overlay) {
        overlay.style.display = show ? 'block' : 'none';
      }
    },

    async showSection(sectionName, linkElement = null) {
      // 更新導航狀態
      document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.classList.remove('active');
      });
      if (linkElement) {
        linkElement.classList.add('active');
      }

      // 隱藏所有區段
      document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
      });

      // 顯示目標區段
      const targetSection = document.getElementById(sectionName + 'Section');
      if (targetSection) {
        targetSection.style.display = 'block';
        this.currentSection = sectionName;
        
        // 載入區段資料
        await this.loadSectionData(sectionName);
      }

      // 手機版自動關閉側邊欄
      if (window.innerWidth < 992) {
        this.toggleSidebar(false);
      }
    },

    async loadSectionData(section) {
      const contentMap = {
        dashboard: () => Dashboard.refresh(),
        transactions: () => this.loadTransactionsList(),
        members: () => this.loadMembersList(),
        activities: () => this.loadActivitiesList(),
        announcements: () => this.loadAnnouncementsList(),
        forms: () => this.loadFormsList(),
        analytics: () => this.loadAnalytics(),
        reports: () => this.loadReports()
      };

      const loader = contentMap[section];
      if (loader) {
        try {
          await loader();
        } catch (error) {
          console.error(`載入 ${section} 失敗:`, error);
        }
      }
    },

    async loadTransactionsList() {
      const container = document.getElementById('transactionsList');
      if (!container) return;

      try {
        const transactions = await dataManager.getData('transactions');
        
        let html = `
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <input id="txSearchInput" type="text" class="form-control form-control-sm" placeholder="搜尋交易...">
            </div>
            <div class="col-md-2">
              <select id="txTypeFilter" class="form-select form-select-sm">
                <option value="">全部類型</option>
                <option value="收入">收入</option>
                <option value="支出">支出</option>
              </select>
            </div>
            <div class="col-md-2">
              <input id="txDateFrom" type="date" class="form-control form-control-sm">
            </div>
            <div class="col-md-2">
              <input id="txDateTo" type="date" class="form-control form-control-sm">
            </div>
            <div class="col-md-3">
              <button class="btn btn-outline-primary btn-sm" onclick="AppLayout.filterTransactions()">
                <i class="bi bi-funnel"></i> 篩選
              </button>
              <button class="btn btn-outline-success btn-sm ms-1" onclick="DataPort.exportTransactions()">
                <i class="bi bi-download"></i> 匯出
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>日期</th>
                  <th>類型</th>
                  <th>類別</th>
                  <th>金額</th>
                  <th>對象</th>
                  <th>帳戶</th>
                  <th>說明</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                ${transactions.map(t => `
                  <tr>
                    <td>${Util.fmtDate(t['日期'])}</td>
                    <td>
                      <span class="badge ${t['類型'] === '收入' ? 'bg-success' : 'bg-danger'}">
                        ${t['類型'] || ''}
                      </span>
                    </td>
                    <td>${t['類別'] || ''}</td>
                    <td class="text-end fw-semibold">$${Util.fmtNum(t['金額'] || 0)}</td>
                    <td>${t['對象'] || ''}</td>
                    <td>${t['帳戶'] || ''}</td>
                    <td>${(t['說明'] || '').substring(0, 30)}${(t['說明'] || '').length > 30 ? '...' : ''}</td>
                    <td>
                      <button class="btn btn-outline-primary btn-sm" onclick="TransactionUI.open('${t.ID}')">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-outline-danger btn-sm ms-1" onclick="AppLayout.deleteTransaction('${t.ID}')">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        container.innerHTML = html;
        
      } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">載入交易記錄失敗</div>';
      }
    },

    async loadMembersList() {
      const container = document.getElementById('membersList');
      if (!container) return;

      try {
        const members = await dataManager.getData('members');
        
        let html = `
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <input id="memberSearchInput" type="text" class="form-control form-control-sm" placeholder="搜尋會員...">
            </div>
            <div class="col-md-2">
              <select id="memberStatusFilter" class="form-select form-select-sm">
                <option value="">全部狀態</option>
                <option value="active">正常</option>
                <option value="inactive">停權</option>
                <option value="pending">待審核</option>
              </select>
            </div>
            <div class="col-md-2">
              <select id="memberTypeFilter" class="form-select form-select-sm">
                <option value="">全部類型</option>
                <option value="regular">一般會員</option>
                <option value="honorary">榮譽會員</option>
                <option value="life">終身會員</option>
                <option value="family">家屬會員</option>
              </select>
            </div>
            <div class="col-md-4">
              <button class="btn btn-outline-primary btn-sm" onclick="AppLayout.filterMembers()">
                <i class="bi bi-funnel"></i> 篩選
              </button>
              <button class="btn btn-outline-success btn-sm ms-1" onclick="DataPort.exportMembers()">
                <i class="bi bi-download"></i> 匯出
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>姓名</th>
                  <th>電話</th>
                  <th>Email</th>
                  <th>加入日期</th>
                  <th>狀態</th>
                  <th>會員類型</th>
                  <th>年費</th>
                  <th>最後繳費</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                ${members.map(m => {
                  const statusClass = {
                    'active': 'bg-success',
                    'inactive': 'bg-danger',
                    'pending': 'bg-warning'
                  }[m['狀態']] || 'bg-secondary';
                  
                  const statusText = {
                    'active': '正常',
                    'inactive': '停權',
                    'pending': '待審核'
                  }[m['狀態']] || m['狀態'];

                  return `
                    <tr>
                      <td class="fw-semibold">${m['姓名'] || ''}</td>
                      <td>${m['電話'] || ''}</td>
                      <td>${m['Email'] || ''}</td>
                      <td>${Util.fmtDate(m['加入日期'])}</td>
                      <td><span class="badge ${statusClass}">${statusText}</span></td>
                      <td>${m['會員類型'] || ''}</td>
                      <td>$${Util.fmtNum(m['年費'] || 0)}</td>
                      <td>${Util.fmtDate(m['最後繳費日期'])}</td>
                      <td>
                        <button class="btn btn-outline-primary btn-sm" onclick="MemberUI.open('${m.ID}')">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm ms-1" onclick="AppLayout.deleteMember('${m.ID}')">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        container.innerHTML = html;
        
      } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">載入會員資料失敗</div>';
      }
    },

    async loadActivitiesList() {
      const container = document.getElementById('activitiesList');
      if (!container) return;

      try {
        const activities = await dataManager.getData('activities');
        
        let html = `
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <input id="activitySearchInput" type="text" class="form-control form-control-sm" placeholder="搜尋活動...">
            </div>
            <div class="col-md-2">
              <select id="activityTypeFilter" class="form-select form-select-sm">
                <option value="">全部類型</option>
                <option value="講座">講座</option>
                <option value="聚會">聚會</option>
                <option value="旅遊">旅遊</option>
                <option value="運動">運動</option>
                <option value="志工">志工服務</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="col-md-2">
              <select id="activityStatusFilter" class="form-select form-select-sm">
                <option value="">全部狀態</option>
                <option value="draft">草稿</option>
                <option value="published">已發布</option>
                <option value="registration">報名中</option>
                <option value="closed">已結束</option>
              </select>
            </div>
            <div class="col-md-4">
              <button class="btn btn-outline-primary btn-sm" onclick="AppLayout.filterActivities()">
                <i class="bi bi-funnel"></i> 篩選
              </button>
              <button class="btn btn-outline-success btn-sm ms-1" onclick="DataPort.exportActivities()">
                <i class="bi bi-download"></i> 匯出
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>活動名稱</th>
                  <th>類型</th>
                  <th>日期</th>
                  <th>地點</th>
                  <th>費用</th>
                  <th>人數上限</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                ${activities.map(a => {
                  const statusClass = {
                    'draft': 'bg-secondary',
                    'published': 'bg-primary',
                    'registration': 'bg-success',
                    'closed': 'bg-danger'
                  }[a['狀態']] || 'bg-secondary';
                  
                  const statusText = {
                    'draft': '草稿',
                    'published': '已發布',
                    'registration': '報名中',
                    'closed': '已結束'
                  }[a['狀態']] || a['狀態'];

                  return `
                    <tr>
                      <td class="fw-semibold">${a['名稱'] || ''}</td>
                      <td>${a['類型'] || ''}</td>
                      <td>${Util.fmtDate(a['日期'])}</td>
                      <td>${a['地點'] || ''}</td>
                      <td>$${Util.fmtNum(a['費用'] || 0)}</td>
                      <td>${a['人數上限'] || '不限'}</td>
                      <td><span class="badge ${statusClass}">${statusText}</span></td>
                      <td>
                        <button class="btn btn-outline-primary btn-sm" onclick="ActivityUI.open('${a.ID}')">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm ms-1" onclick="AppLayout.deleteActivity('${a.ID}')">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        container.innerHTML = html;
        
      } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">載入活動資料失敗</div>';
      }
    },

    async deleteTransaction(id) {
      const result = await Util.confirm({
        title: '確定刪除？',
        text: '此操作無法復原',
        icon: 'warning',
        confirmText: '刪除',
        confirmColor: '#dc3545'
      });

      if (result.isConfirmed) {
        try {
          await dataManager.deleteData('transaction', id);
          Util.showToast('success', '交易已刪除');
          this.loadTransactionsList();
          Dashboard.refresh();
        } catch (error) {
          // 錯誤已在 dataManager 中處理
        }
      }
    },

    async deleteMember(id) {
      const result = await Util.confirm({
        title: '確定刪除會員？',
        text: '此操作無法復原，相關資料將一併刪除',
        icon: 'warning',
        confirmText: '刪除',
        confirmColor: '#dc3545'
      });

      if (result.isConfirmed) {
        try {
          await dataManager.deleteData('member', id);
          Util.showToast('success', '會員已刪除');
          this.loadMembersList();
          Dashboard.refresh();
        } catch (error) {
          // 錯誤已在 dataManager 中處理
        }
      }
    },

    async deleteActivity(id) {
      const result = await Util.confirm({
        title: '確定刪除活動？',
        text: '此操作無法復原',
        icon: 'warning',
        confirmText: '刪除',
        confirmColor: '#dc3545'
      });

      if (result.isConfirmed) {
        try {
          await dataManager.deleteData('activity', id);
          Util.showToast('success', '活動已刪除');
          this.loadActivitiesList();
          Dashboard.refresh();
        } catch (error) {
          // 錯誤已在 dataManager 中處理
        }
      }
    }
  };

  // ===== 儀表板 =====
  const Dashboard = {
    async refresh() {
      try {
        const [transactions, members, activities] = await Promise.all([
          dataManager.getData('transactions'),
          dataManager.getData('members'),
          dataManager.getData('activities')
        ]);

        this.updateStats(transactions, members, activities);
        this.updateRecentData(transactions, members, activities);
        
      } catch (error) {
        console.error('儀表板更新失敗:', error);
      }
    },

    updateStats(transactions, members, activities) {
      const currentMonth = new Date().toISOString().slice(0, 7);
      
      const totalIncome = transactions
        .filter(t => t['類型'] === '收入')
        .reduce((sum, t) => sum + (parseFloat(t['金額']) || 0), 0);
        
      const totalExpense = transactions
        .filter(t => t['類型'] === '支出')
        .reduce((sum, t) => sum + (parseFloat(t['金額']) || 0), 0);
        
      const monthIncome = transactions
        .filter(t => t['類型'] === '收入' && t['日期']?.startsWith(currentMonth))
        .reduce((sum, t) => sum + (parseFloat(t['金額']) || 0), 0);
        
      const monthExpense = transactions
        .filter(t => t['類型'] === '支出' && t['日期']?.startsWith(currentMonth))
        .reduce((sum, t) => sum + (parseFloat(t['金額']) || 0), 0);

      const activeMembers = members.filter(m => m['狀態'] === 'active').length;
      const overdueMembers = members.filter(m => {
        if (!m['最後繳費日期']) return true;
        const lastPayment = new Date(m['最後繳費日期']);
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
        return lastPayment < oneYearAgo;
      }).length;

      const monthActivities = activities.filter(a => 
        a['日期']?.startsWith(currentMonth)
      ).length;

      // 更新統計數字
      document.getElementById('dashTotalIncome').textContent = '$' + Util.fmtNum(totalIncome);
      document.getElementById('dashTotalExpense').textContent = '$' + Util.fmtNum(totalExpense);
      document.getElementById('dashMonthIncome').textContent = '$' + Util.fmtNum(monthIncome);
      document.getElementById('dashMonthExpense').textContent = '$' + Util.fmtNum(monthExpense);
      document.getElementById('dashTotalBalance').textContent = '$' + Util.fmtNum(totalIncome - totalExpense);
      document.getElementById('dashMemberTotal').textContent = activeMembers;
      document.getElementById('dashMemberOverdue').textContent = overdueMembers;
      document.getElementById('dashMonthActivities').textContent = monthActivities;
    },

    updateRecentData(transactions, members, activities) {
      // 最近交易
      const recentTx = transactions
        .sort((a, b) => new Date(b['日期']) - new Date(a['日期']))
        .slice(0, 5);
        
      const txHtml = recentTx.length ? recentTx.map(t => `
        <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
          <div>
            <div class="fw-semibold">${t['類別']} - ${t['對象'] || ''}</div>
            <small class="text-muted">${Util.fmtDate(t['日期'])}</small>
          </div>
          <div class="text-end">
            <div class="fw-semibold ${t['類型'] === '收入' ? 'text-success' : 'text-danger'}">
              ${t['類型'] === '收入' ? '+' : '-'}$${Util.fmtNum(t['金額'] || 0)}
            </div>
          </div>
        </div>
      `).join('') : '<div class="text-center text-muted py-3">暫無資料</div>';
      
      document.getElementById('dashboardRecentTx').innerHTML = txHtml;

      // 最新會員
      const recentMembers = members
        .sort((a, b) => new Date(b['加入日期']) - new Date(a['加入日期']))
        .slice(0, 5);
        
      const membersHtml = recentMembers.length ? recentMembers.map(m => `
        <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
          <div>
            <div class="fw-semibold">${m['姓名'] || ''}</div>
            <small class="text-muted">${m['電話'] || ''}</small>
          </div>
          <div class="text-end">
            <small class="text-muted">${Util.fmtDate(m['加入日期'])}</small>
          </div>
        </div>
      `).join('') : '<div class="text-center text-muted py-3">暫無資料</div>';
      
      document.getElementById('dashboardRecentMembers').innerHTML = membersHtml;

      // 近期活動
      const upcomingActivities = activities
        .filter(a => new Date(a['日期']) >= new Date())
        .sort((a, b) => new Date(a['日期']) - new Date(b['日期']))
        .slice(0, 5);
        
      const activitiesHtml = upcomingActivities.length ? upcomingActivities.map(a => `
        <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
          <div>
            <div class="fw-semibold">${a['名稱'] || ''}</div>
            <small class="text-muted">${a['地點'] || ''}</small>
          </div>
          <div class="text-end">
            <small class="text-muted">${Util.fmtDate(a['日期'])}</small>
          </div>
        </div>
      `).join('') : '<div class="text-center text-muted py-3">暫無資料</div>';
      
      document.getElementById('dashboardRecentActivities').innerHTML = activitiesHtml;
    }
  };

  // ===== 交易 UI =====
  const TransactionUI = {
    modal: null,

    async open(id = null) {
      if (!this.modal) {
        this.modal = new bootstrap.Modal(document.getElementById('transactionModal'));
      }

      // 重置表單
      document.getElementById('txForm').reset();
      document.getElementById('txId').value = id || '';
      document.getElementById('txDate').value = Util.today();
      document.getElementById('txModalTitle').textContent = id ? '編輯交易' : '新增交易';

      // 載入帳戶選項
      await this.loadAccounts();
      
      // 載入類別選項
      this.loadCategories();

      // 如果是編輯，載入現有資料
      if (id) {
        await this.loadTransaction(id);
      }

      this.modal.show();
    },

    async loadAccounts() {
      try {
        const accounts = await dataManager.getData('accounts');
        const select = document.getElementById('txAccount');
        select.innerHTML = '<option value="">選擇帳戶</option>';
        
        accounts.filter(acc => acc['啟用狀態']).forEach(acc => {
          select.innerHTML += `<option value="${acc['名稱']}">${acc['名稱']} (${acc['類型']})</option>`;
        });
      } catch (error) {
        console.error('載入帳戶失敗:', error);
      }
    },

    loadCategories() {
      const typeSelect = document.getElementById('txType');
      const categorySelect = document.getElementById('txCategory');
      
      typeSelect.addEventListener('change', () => {
        const type = typeSelect.value;
        categorySelect.innerHTML = '<option value="">選擇類別</option>';
        
        if (type === '收入') {
          ['會費', '捐款', '補助', '利息收入', '其他收入'].forEach(cat => {
            categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
          });
        } else if (type === '支出') {
          ['辦公費用', '活動費用', '交通費', '餐費', '文具用品', '其他支出'].forEach(cat => {
            categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
          });
        }
      });
    },

    async loadTransaction(id) {
      try {
        const transactions = await dataManager.getData('transactions');
        const transaction = transactions.find(t => t.ID === id);
        
        if (transaction) {
          document.getElementById('txDate').value = transaction['日期'] || '';
          document.getElementById('txType').value = transaction['類型'] || '';
          document.getElementById('txType').dispatchEvent(new Event('change'));
          document.getElementById('txCategory').value = transaction['類別'] || '';
          document.getElementById('txAmount').value = transaction['金額'] || '';
          document.getElementById('txCounterparty').value = transaction['對象'] || '';
          document.getElementById('txAccount').value = transaction['帳戶'] || '';
          document.getElementById('txNumber').value = transaction['編號'] || '';
          document.getElementById('txDescription').value = transaction['說明'] || '';
        }
      } catch (error) {
        Util.showToast('error', '載入交易資料失敗');
      }
    },

    async save() {
      const form = document.getElementById('txForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      try {
        const formData = {
          ID: document.getElementById('txId').value || undefined,
          日期: document.getElementById('txDate').value,
          類型: document.getElementById('txType').value,
          類別: document.getElementById('txCategory').value,
          金額: parseFloat(document.getElementById('txAmount').value) || 0,
          對象: document.getElementById('txCounterparty').value.trim(),
          帳戶: document.getElementById('txAccount').value,
          編號: document.getElementById('txNumber').value.trim(),
          說明: document.getElementById('txDescription').value.trim()
        };

        // 自動產生編號
        if (!formData.編號) {
          const prefix = formData.類型 === '收入' ? 'R' : 'V';
          const date = new Date().toISOString().slice(2, 10).replace(/-/g, '');
          const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
          formData.編號 = `${prefix}${date}${random}`;
        }

        await dataManager.saveData('transaction', formData);
        
        Util.showToast('success', '交易已儲存');
        this.modal.hide();
        
        // 刷新相關資料
        AppLayout.loadTransactionsList();
        Dashboard.refresh();
        
      } catch (error) {
        // 錯誤已在 dataManager 中處理
      }
    }
  };

  // ===== 會員 UI =====
  const MemberUI = {
    modal: null,

    async open(id = null) {
      if (!this.modal) {
        this.modal = new bootstrap.Modal(document.getElementById('memberModal'));
      }

      // 重置表單
      document.getElementById('memberForm').reset();
      document.getElementById('memberId').value = id || '';
      document.getElementById('memberJoinDate').value = Util.today();
      document.getElementById('memberModalTitle').textContent = id ? '編輯會員' : '新增會員';

      // 如果是編輯，載入現有資料
      if (id) {
        await this.loadMember(id);
      }

      this.modal.show();
    },

    async loadMember(id) {
      try {
        const members = await dataManager.getData('members');
        const member = members.find(m => m.ID === id);
        
        if (member) {
          Object.keys(member).forEach(key => {
            const element = document.getElementById(this.getFieldId(key));
            if (element) {
              if (element.type === 'checkbox') {
                element.checked = member[key];
              } else {
                element.value = member[key] || '';
              }
            }
          });
        }
      } catch (error) {
        Util.showToast('error', '載入會員資料失敗');
      }
    },

    getFieldId(key) {
      const fieldMap = {
        '姓名': 'memberName',
        '電話': 'memberPhone',
        'Email': 'memberEmail',
        '出生日期': 'memberBirthDate',
        '性別': 'memberGender',
        '地址': 'memberAddress',
        '緊急聯絡人': 'emergencyContact',
        '緊急聯絡電話': 'emergencyPhone',
        '備註': 'memberNotes',
        '加入日期': 'memberJoinDate',
        '狀態': 'memberStatus',
        '會員類型': 'memberType',
        '年費': 'membershipFee',
        '最後繳費日期': 'lastPaymentDate'
      };
      return fieldMap[key] || key;
    },

    async save() {
      const form = document.getElementById('memberForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      try {
        const formData = {
          ID: document.getElementById('memberId').value || undefined,
          姓名: document.getElementById('memberName').value.trim(),
          電話: document.getElementById('memberPhone').value.trim(),
          Email: document.getElementById('memberEmail').value.trim(),
          出生日期: document.getElementById('memberBirthDate').value,
          性別: document.getElementById('memberGender').value,
          地址: document.getElementById('memberAddress').value.trim(),
          緊急聯絡人: document.getElementById('emergencyContact').value.trim(),
          緊急聯絡電話: document.getElementById('emergencyPhone').value.trim(),
          備註: document.getElementById('memberNotes').value.trim(),
          加入日期: document.getElementById('memberJoinDate').value,
          狀態: document.getElementById('memberStatus').value,
          會員類型: document.getElementById('memberType').value,
          年費: parseFloat(document.getElementById('membershipFee').value) || 0,
          最後繳費日期: document.getElementById('lastPaymentDate').value
        };

        await dataManager.saveData('member', formData);
        
        Util.showToast('success', '會員資料已儲存');
        this.modal.hide();
        
        // 刷新相關資料
        AppLayout.loadMembersList();
        Dashboard.refresh();
        
      } catch (error) {
        // 錯誤已在 dataManager 中處理
      }
    }
  };

  // ===== 活動 UI =====
  const ActivityUI = {
    modal: null,

    async open(id = null) {
      if (!this.modal) {
        this.modal = new bootstrap.Modal(document.getElementById('activityModal'));
      }

      // 重置表單
      document.getElementById('activityForm').reset();
      document.getElementById('activityId').value = id || '';
      document.getElementById('activityDate').value = Util.today();
      document.getElementById('activityModalTitle').textContent = id ? '編輯活動' : '新增活動';

      // 如果是編輯，載入現有資料
      if (id) {
        await this.loadActivity(id);
      }

      this.modal.show();
    },

    async loadActivity(id) {
      try {
        const activities = await dataManager.getData('activities');
        const activity = activities.find(a => a.ID === id);
        
        if (activity) {
          document.getElementById('activityName').value = activity['名稱'] || '';
          document.getElementById('activityType').value = activity['類型'] || '';
          document.getElementById('activityStatus').value = activity['狀態'] || '';
          document.getElementById('activityDate').value = activity['日期'] || '';
          document.getElementById('activityTime').value = activity['時間'] || '';
          document.getElementById('activityLocation').value = activity['地點'] || '';
          document.getElementById('activityDescription').value = activity['描述'] || '';
          document.getElementById('activityMax').value = activity['人數上限'] || '';
          document.getElementById('activityFee').value = activity['費用'] || '';
          document.getElementById('activityContact').value = activity['聯絡人'] || '';
          document.getElementById('activityContactPhone').value = activity['聯絡電話'] || '';
          document.getElementById('activityNotes').value = activity['備註'] || '';
        }
      } catch (error) {
        Util.showToast('error', '載入活動資料失敗');
      }
    },

    async save() {
      const form = document.getElementById('activityForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      try {
        const formData = {
          ID: document.getElementById('activityId').value || undefined,
          名稱: document.getElementById('activityName').value.trim(),
          類型: document.getElementById('activityType').value,
          狀態: document.getElementById('activityStatus').value,
          日期: document.getElementById('activityDate').value,
          時間: document.getElementById('activityTime').value,
          地點: document.getElementById('activityLocation').value.trim(),
          描述: document.getElementById('activityDescription').value.trim(),
          人數上限: parseInt(document.getElementById('activityMax').value) || null,
          費用: parseFloat(document.getElementById('activityFee').value) || 0,
          聯絡人: document.getElementById('activityContact').value.trim(),
          聯絡電話: document.getElementById('activityContactPhone').value.trim(),
          備註: document.getElementById('activityNotes').value.trim()
        };

        await dataManager.saveData('activity', formData);
        
        Util.showToast('success', '活動已儲存');
        this.modal.hide();
        
        // 刷新相關資料
        AppLayout.loadActivitiesList();
        Dashboard.refresh();
        
      } catch (error) {
        // 錯誤已在 dataManager 中處理
      }
    }
  };

  // ===== 設定 UI =====
  const SettingsUI = {
    modal: null,

    async open() {
      if (!this.modal) {
        this.modal = new bootstrap.Modal(document.getElementById('settingsModal'));
      }

      // 載入現有設定
      await this.loadSettings();
      this.modal.show();
    },

    async loadSettings() {
      try {
        const settings = await dataManager.getData('settings');
        const config = settings.length > 0 ? settings[0] : {};
        
        document.getElementById('setOrgName').value = config['組織名稱'] || '台灣帕金森病友權益促進會';
        document.getElementById('setOrgAddress').value = config['組織地址'] || '';
        document.getElementById('setOrgPhone').value = config['組織電話'] || '';
        document.getElementById('setOrgEmail').value = config['組織Email'] || '';
        document.getElementById('setDefaultFee').value = config['預設年費'] || 1000;
        document.getElementById('setReceiptPrefix').value = config['收據前綴'] || 'R';
        document.getElementById('setVoucherPrefix').value = config['憑證前綴'] || 'V';
        document.getElementById('setIncomeCategories').value = config['收入類別'] || '會費,捐款,補助,其他';
        document.getElementById('setExpenseCategories').value = config['支出類別'] || '辦公費用,活動費用,交通費,其他';
        document.getElementById('setAutoBackup').checked = config['自動備份'] || false;
        
      } catch (error) {
        console.error('載入設定失敗:', error);
      }
    },

    async save() {
      try {
        const formData = {
          ID: 'system_settings',
          組織名稱: document.getElementById('setOrgName').value.trim(),
          組織地址: document.getElementById('setOrgAddress').value.trim(),
          組織電話: document.getElementById('setOrgPhone').value.trim(),
          組織Email: document.getElementById('setOrgEmail').value.trim(),
          預設年費: parseFloat(document.getElementById('setDefaultFee').value) || 1000,
          收據前綴: document.getElementById('setReceiptPrefix').value.trim(),
          憑證前綴: document.getElementById('setVoucherPrefix').value.trim(),
          收入類別: document.getElementById('setIncomeCategories').value.trim(),
          支出類別: document.getElementById('setExpenseCategories').value.trim(),
          自動備份: document.getElementById('setAutoBackup').checked
        };

        await dataManager.saveData('settings', formData);
        
        Util.showToast('success', '設定已儲存');
        this.modal.hide();
        
      } catch (error) {
        // 錯誤已在 dataManager 中處理
      }
    }
  };

  // ===== 網路監控 =====
  const NetworkMonitor = {
    init() {
      this.updateStatus();
      
      window.addEventListener('online', () => this.updateStatus());
      window.addEventListener('offline', () => this.updateStatus());
      
      // 定期檢查連線狀態
      setInterval(() => this.updateStatus(), 30000);
    },

    updateStatus() {
      const onlineIndicator = document.getElementById('syncIndicator');
      const offlineIndicator = document.getElementById('offlineIndicator');
      
      if (navigator.onLine) {
        onlineIndicator.style.display = 'block';
        offlineIndicator.style.display = 'none';
      } else {
        onlineIndicator.style.display = 'none';
        offlineIndicator.style.display = 'block';
      }
    }
  };

  // ===== 全域搜尋 =====
  const GlobalSearch = {
    init() {
      const input = document.getElementById('globalSearchInput');
      
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          this.exec();
        }
      });
    },

    async exec() {
      const query = document.getElementById('globalSearchInput').value.trim();
      if (!query) return;

      Util.showLoading(true);
      
      try {
        const results = await this.search(query);
        this.showResults(results, query);
      } catch (error) {
        Util.showToast('error', '搜尋失敗: ' + error.message);
      } finally {
        Util.showLoading(false);
      }
    },

    async search(query) {
      const [transactions, members, activities] = await Promise.all([
        dataManager.getData('transactions'),
        dataManager.getData('members'),
        dataManager.getData('activities')
      ]);

      const results = {
        transactions: transactions.filter(t => 
          JSON.stringify(t).toLowerCase().includes(query.toLowerCase())
        ),
        members: members.filter(m => 
          JSON.stringify(m).toLowerCase().includes(query.toLowerCase())
        ),
        activities: activities.filter(a => 
          JSON.stringify(a).toLowerCase().includes(query.toLowerCase())
        )
      };

      return results;
    },

    showResults(results, query) {
      const totalResults = results.transactions.length + results.members.length + results.activities.length;
      
      Swal.fire({
        title: `搜尋結果: "${query}"`,
        html: `
          <div class="text-start">
            <p class="mb-3">找到 ${totalResults} 筆結果</p>
            ${results.transactions.length > 0 ? `
              <h6>交易記錄 (${results.transactions.length})</h6>
              <ul class="list-unstyled mb-3">
                ${results.transactions.slice(0, 5).map(t => `
                  <li class="mb-1">
                    <small class="text-muted">${Util.fmtDate(t['日期'])}</small>
                    ${t['類別']} - $${Util.fmtNum(t['金額'])}
                  </li>
                `).join('')}
              </ul>
            ` : ''}
            ${results.members.length > 0 ? `
              <h6>會員 (${results.members.length})</h6>
              <ul class="list-unstyled mb-3">
                ${results.members.slice(0, 5).map(m => `
                  <li class="mb-1">${m['姓名']} - ${m['電話']}</li>
                `).join('')}
              </ul>
            ` : ''}
            ${results.activities.length > 0 ? `
              <h6>活動 (${results.activities.length})</h6>
              <ul class="list-unstyled mb-3">
                ${results.activities.slice(0, 5).map(a => `
                  <li class="mb-1">
                    <small class="text-muted">${Util.fmtDate(a['日期'])}</small>
                    ${a['名稱']}
                  </li>
                `).join('')}
              </ul>
            ` : ''}
          </div>
        `,
        width: 600,
        confirmButtonText: '關閉'
      });
    }
  };

  // ===== 批次匯入 =====
  const BatchImport = {
    open(type) {
      const typeNames = {
        transactions: '交易記錄',
        members: '會員資料',
        activities: '活動資料'
      };

      Swal.fire({
        title: `批次匯入${typeNames[type]}`,
        html: `
          <div class="text-start">
            <p>請選擇 CSV 檔案進行匯入：</p>
            <input type="file" id="importFile" accept=".csv" class="form-control mb-3">
            <div class="alert alert-info">
              <small>
                <strong>注意事項：</strong><br>
                • 檔案格式必須為 CSV<br>
                • 第一行應為欄位標題<br>
                • 請確保資料格式正確
              </small>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '匯入',
        cancelButtonText: '取消',
        preConfirm: () => {
          const file = document.getElementById('importFile').files[0];
          if (!file) {
            Swal.showValidationMessage('請選擇檔案');
            return false;
          }
          return file;
        }
      }).then((result) => {
        if (result.isConfirmed) {
          this.processFile(result.value, type);
        }
      });
    },

    async processFile(file, type) {
      try {
        const text = await file.text();
        const data = this.parseCSV(text);
        
        if (data.length === 0) {
          throw new Error('檔案內容為空');
        }

        const result = await Util.confirm({
          title: '確認匯入',
          text: `即將匯入 ${data.length} 筆資料，是否繼續？`,
          confirmText: '匯入'
        });

        if (result.isConfirmed) {
          await this.importData(data, type);
          Util.showToast('success', `成功匯入 ${data.length} 筆資料`);
          AppLayout.loadSectionData(AppLayout.currentSection);
          Dashboard.refresh();
        }
      } catch (error) {
        Util.showToast('error', '匯入失敗: ' + error.message);
      }
    },

    parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) return [];

      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        const row = {};
        
        headers.forEach((header, index) => {
          row[header] = values[index] || '';
        });
        
        row.ID = Util.generateId();
        data.push(row);
      }

      return data;
    },

    async importData(data, type) {
      for (const item of data) {
        await dataManager.saveData(type.slice(0, -1), item);
      }
    }
  };

  // ===== 資料匯出 =====
  const DataPort = {
    async exportAll() {
      try {
        const [transactions, members, activities] = await Promise.all([
          dataManager.getData('transactions'),
          dataManager.getData('members'),
          dataManager.getData('activities')
        ]);

        this.downloadJSON({
          transactions,
          members,
          activities,
          exported_at: new Date().toISOString()
        }, 'parkinson_data_backup.json');

        Util.showToast('success', '資料匯出完成');
      } catch (error) {
        Util.showToast('error', '匯出失敗: ' + error.message);
      }
    },

    async exportTransactions() {
      try {
        const data = await dataManager.getData('transactions');
        this.downloadCSV(data, 'transactions.csv');
      } catch (error) {
        Util.showToast('error', '匯出失敗: ' + error.message);
      }
    },

    async exportMembers() {
      try {
        const data = await dataManager.getData('members');
        this.downloadCSV(data, 'members.csv');
      } catch (error) {
        Util.showToast('error', '匯出失敗: ' + error.message);
      }
    },

    async exportActivities() {
      try {
        const data = await dataManager.getData('activities');
        this.downloadCSV(data, 'activities.csv');
      } catch (error) {
        Util.showToast('error', '匯出失敗: ' + error.message);
      }
    },

    downloadCSV(data, filename) {
      if (data.length === 0) {
        Util.showToast('warning', '沒有資料可匯出');
        return;
      }

      const headers = Object.keys(data[0]);
      const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
      ].join('\n');

      this.downloadFile(csvContent, filename, 'text/csv;charset=utf-8;');
    },

    downloadJSON(data, filename) {
      const content = JSON.stringify(data, null, 2);
      this.downloadFile(content, filename, 'application/json;charset=utf-8;');
    },

    downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
  };

  // ===== 帳戶管理 =====
  const AccountUI = {
    async openManager() {
      try {
        const accounts = await dataManager.getData('accounts');
        
        Swal.fire({
          title: '帳戶管理',
          html: `
            <div class="text-start">
              <button class="btn btn-primary btn-sm mb-3" onclick="AccountUI.addAccount()">
                <i class="bi bi-plus"></i> 新增帳戶
              </button>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>名稱</th>
                      <th>類型</th>
                      <th>餘額</th>
                      <th>狀態</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${accounts.map(acc => `
                      <tr>
                        <td>${acc['名稱'] || ''}</td>
                        <td>${acc['類型'] || ''}</td>
                        <td>$${Util.fmtNum(acc['餘額'] || 0)}</td>
                        <td>
                          <span class="badge ${acc['啟用狀態'] ? 'bg-success' : 'bg-secondary'}">
                            ${acc['啟用狀態'] ? '啟用' : '停用'}
                          </span>
                        </td>
                        <td>
                          <button class="btn btn-outline-primary btn-sm" onclick="AccountUI.editAccount('${acc.ID}')">
                            <i class="bi bi-pencil"></i>
                          </button>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `,
          width: 800,
          showConfirmButton: false,
          showCloseButton: true
        });
      } catch (error) {
        Util.showToast('error', '載入帳戶失敗');
      }
    },

    addAccount() {
      Swal.fire({
        title: '新增帳戶',
        html: `
          <form id="accountForm">
            <div class="mb-3">
              <label class="form-label">帳戶名稱</label>
              <input id="accName" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">帳戶類型</label>
              <select id="accType" class="form-select" required>
                <option value="">選擇類型</option>
                <option value="現金">現金</option>
                <option value="銀行">銀行帳戶</option>
                <option value="信用卡">信用卡</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">初始餘額</label>
              <input id="accBalance" type="number" class="form-control" value="0">
            </div>
            <div class="mb-3">
              <div class="form-check">
                <input id="accEnabled" type="checkbox" class="form-check-input" checked>
                <label for="accEnabled" class="form-check-label">啟用帳戶</label>
              </div>
            </div>
          </form>
        `,
        showCancelButton: true,
        confirmButtonText: '儲存',
        cancelButtonText: '取消',
        preConfirm: () => {
          const form = document.getElementById('accountForm');
          if (!form.checkValidity()) {
            form.reportValidity();
            return false;
          }
          return true;
        }
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const formData = {
              ID: Util.generateId(),
              名稱: document.getElementById('accName').value.trim(),
              類型: document.getElementById('accType').value,
              餘額: parseFloat(document.getElementById('accBalance').value) || 0,
              啟用狀態: document.getElementById('accEnabled').checked
            };

            await dataManager.saveData('account', formData);
            Util.showToast('success', '帳戶已新增');
            this.openManager();
          } catch (error) {
            // 錯誤已在 dataManager 中處理
          }
        }
      });
    }
  };

  // ===== 系統測試 =====
  const SystemTest = {
    async run() {
      const tests = [
        { name: '資料庫連線', test: () => api.request('test') },
        { name: '交易資料讀取', test: () => dataManager.getData('transactions') },
        { name: '會員資料讀取', test: () => dataManager.getData('members') },
        { name: '活動資料讀取', test: () => dataManager.getData('activities') }
      ];

      let results = [];
      
      for (const test of tests) {
        try {
          await test.test();
          results.push({ name: test.name, status: 'success', message: '正常' });
        } catch (error) {
          results.push({ name: test.name, status: 'error', message: error.message });
        }
      }

      const html = `
        <div class="text-start">
          <h6>系統測試結果</h6>
          <div class="list-group">
            ${results.map(r => `
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <span>${r.name}</span>
                <span class="badge ${r.status === 'success' ? 'bg-success' : 'bg-danger'}">
                  ${r.status === 'success' ? '通過' : '失敗'}
                </span>
              </div>
              ${r.status === 'error' ? `<small class="text-danger">${r.message}</small>` : ''}
            `).join('')}
          </div>
        </div>
      `;

      Swal.fire({
        title: '系統測試',
        html,
        confirmButtonText: '關閉'
      });
    }
  };

  // ===== 關於系統 =====
  const About = {
    show() {
      Swal.fire({
        title: '關於系統',
        html: `
          <div class="text-start">
            <h6><i class="bi bi-heart-pulse me-2"></i>台灣帕金森病友權益促進會</h6>
            <p><strong>會計暨營運整合管理系統</strong></p>
            <hr>
            <p><strong>版本：</strong> ${CONFIG.VERSION}</p>
            <p><strong>開發：</strong> 系統開發團隊</p>
            <p><strong>技術：</strong> HTML5, CSS3, JavaScript, Bootstrap 5, Google Apps Script</p>
            <hr>
            <p class="mb-0">
              <small class="text-muted">
                本系統專為台灣帕金森病友權益促進會設計，提供完整的會員管理、財務管理、活動管理等功能。
              </small>
            </p>
          </div>
        `,
        confirmButtonText: '關閉'
      });
    }
  };

  // ===== 初始化 =====
  document.addEventListener('DOMContentLoaded', () => {
    // 檢查瀏覽器支援
    if (!window.fetch || !window.Promise) {
      alert('您的瀏覽器版本過舊，請更新至最新版本以獲得最佳體驗。');
      return;
    }

    // 初始化應用程式
    AppLayout.init();
    
    // 載入初始資料
    Dashboard.refresh();
    
    // 隱藏載入畫面
    setTimeout(() => {
      Util.showLoading(false);
    }, 1000);

    console.log('台灣帕金森病友權益促進會管理系統 v' + CONFIG.VERSION + ' 已啟動');
  });

  // ===== 全域錯誤處理 =====
  window.addEventListener('error', (event) => {
    console.error('系統錯誤:', event.error);
    Util.showToast('error', '系統發生錯誤，請重新整理頁面');
  });

  window.addEventListener('unhandledrejection', (event) => {
    console.error('未處理的 Promise 錯誤:', event.reason);
    event.preventDefault();
  });

  // ===== 服務工作者註冊 (PWA支援) =====
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => {
          console.log('ServiceWorker 註冊成功');
        })
        .catch(error => {
          console.log('ServiceWorker 註冊失敗');
        });
    });
  }
</script>
</body>
</html>
