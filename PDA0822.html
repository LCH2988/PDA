<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>台灣帕金森病友權益促進會 - 會計暨營運整合管理系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="非營利組織整合：財務 / 會員 / 活動 / 公告 / 表單 / 雲端備份管理系統">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <style>
    :root {
      --primary:#2c5aa0;
      --primary-dark:#1e3d6f;
      --gradient-primary:linear-gradient(135deg,#2c5aa0,#4a90e2);
      --gradient-green:linear-gradient(135deg,#28a745,#20c997);
      --gradient-orange:linear-gradient(135deg,#ff9f40,#ffb347);
      --secondary-bg:#f8f9fa;
      --radius-lg:15px;
      --radius-md:10px;
      --radius-sm:6px;
    }
    body {
      background:var(--secondary-bg);
      font-family:"Microsoft JhengHei","Noto Sans TC",system-ui,sans-serif;
      font-size:14.5px;
    }
    .navbar-brand { font-weight:600; color:var(--primary)!important; }
    .sidebar {
      min-height:100vh;
      background:linear-gradient(180deg,#2c5aa0,#1e3d6f);
      color:#fff;
    }
    .sidebar .nav-link {
      color:rgba(255,255,255,.82);
      border-radius:8px;
      margin:3px 0;
      font-weight:500;
      transition:.25s;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background:rgba(255,255,255,0.12);
      color:#fff;
      transform:translateX(4px);
    }
    .content-section { animation:fadeIn .35s ease; }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(12px); }
      to { opacity:1; transform:translateY(0); }
    }
    .stat-card {
      background:var(--gradient-primary);
      color:#fff;
      border:none;
      border-radius:var(--radius-lg);
      box-shadow:0 4px 14px -4px rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
    }
    .stat-card.alt-green { background:var(--gradient-green); }
    .stat-card.alt-orange{ background:var(--gradient-orange); }
    .stat-card .icon-bg {
      position:absolute;
      right:-10px; top:-10px;
      font-size:72px;
      opacity:.16;
    }
    .card-hoverable { transition:.25s; border:none; border-radius:var(--radius-lg); }
    .card-hoverable:hover { transform:translateY(-4px); box-shadow:0 8px 24px -6px rgba(0,0,0,.15); }
    .table thead th { background:#f1f4f8; border-top:none; font-weight:600; }
    .badge-rounded { border-radius:20px; font-weight:500; letter-spacing:.5px; }
    .member-avatar, .participant-avatar {
      width:40px;height:40px;border-radius:50%;background:#fff;
      display:flex;align-items:center;justify-content:center;
      color:#666;font-weight:600;
      box-shadow:0 0 0 1px rgba(0,0,0,.05);
    }
    .small-avatar { width:32px;height:32px;font-size:12px; }
    .action-buttons .btn { padding:.25rem .5rem; }
    .loading-overlay {
      position:fixed; inset:0; z-index:2000;
      background:rgba(0,0,0,.45); display:flex;align-items:center;justify-content:center;
    }
    .pagination .page-link { border:none; border-radius:8px; color:var(--primary); }
    .pagination .page-item.active .page-link { background:var(--primary); }
    .chart-container { position:relative; height:380px; }
    .separator-title {
      font-size:15px;font-weight:600;margin:16px 0 10px;display:flex;align-items:center;gap:.5rem;
    }
    .separator-title:before, .separator-title:after {
      content:""; flex:1; height:1px; background:linear-gradient(90deg,#d0d3d9,#ffffff);
    }
    .activity-card { border:none;border-radius:var(--radius-lg);overflow:hidden;box-shadow:0 3px 10px -2px rgba(0,0,0,.12);position:relative; }
    .activity-card .progress { height:6px; border-radius:3px; background:#e9ecef; overflow:hidden; }
    .activity-card .progress-bar { background:var(--gradient-green); }
    .announcement-card { border-left:5px solid #ffc107; border-radius:var(--radius-md); }
    .announcement-card.urgent { border-left-color:#dc3545; background:linear-gradient(135deg,#fff5f5,#ffffff); }
    @media print {
      .no-print, .sidebar, .navbar, .modal-backdrop { display:none!important; }
      body { background:#fff; }
      .main-content { margin:0!important; padding:0!important; }
      .card { box-shadow:none!important; }
    }
    @media (max-width: 992px){
      .sidebar { position:fixed; left:0; top:0; transform:translateX(-100%); transition:.35s; z-index:1100; width:250px; }
      .sidebar.show { transform:translateX(0); }
    }
    .spin { animation:spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="text-center text-white">
      <div class="mb-3">
        <i class="bi bi-arrow-clockwise spin" style="font-size:48px;"></i>
      </div>
      <div>系統載入中，請稍候…</div>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg bg-white shadow-sm no-print">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <i class="bi bi-heart-pulse me-2"></i> 台灣帕金森病友權益促進會
      </a>
      <button class="navbar-toggler" type="button" onclick="AppLayout.toggleSidebar()">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item me-2">
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
              <input id="globalSearchInput" type="text" class="form-control" placeholder="全域搜尋 (交易 / 會員 / 活動 / 公告)" onkeydown="if(event.key==='Enter') GlobalSearch.exec()">
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle fw-semibold" href="#" data-bs-toggle="dropdown">
              <i class="bi bi-gear"></i> 系統
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" onclick="SettingsUI.open()"><i class="bi bi-sliders"></i> 系統設定</a></li>
              <li><a class="dropdown-item" href="#" onclick="AccountUI.openManager()"><i class="bi bi-bank"></i> 帳戶管理</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.exportAll()"><i class="bi bi-download"></i> 匯出資料</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.importAll()"><i class="bi bi-upload"></i> 匯入資料</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="About.show()"><i class="bi bi-info-circle"></i> 關於</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <aside id="sidebar" class="sidebar col-lg-2 col-md-3 p-3">
        <h6 class="text-center mt-2 mb-4 fw-semibold">管理選單</h6>
          <nav class="nav flex-column">
            <a class="nav-link active" href="#" data-section="dashboard" onclick="AppLayout.showSection('dashboard',this)"><i class="bi bi-speedometer2 me-2"></i>儀表板</a>
            <a class="nav-link" href="#" data-section="transactions" onclick="AppLayout.showSection('transactions',this)"><i class="bi bi-receipt me-2"></i>交易記錄</a>
            <a class="nav-link" href="#" data-section="members" onclick="AppLayout.showSection('members',this)"><i class="bi bi-people me-2"></i>會員管理</a>
            <a class="nav-link" href="#" data-section="activities" onclick="AppLayout.showSection('activities',this)"><i class="bi bi-calendar-event me-2"></i>活動管理</a>
            <a class="nav-link" href="#" data-section="announcements" onclick="AppLayout.showSection('announcements',this)"><i class="bi bi-megaphone me-2"></i>公告管理</a>
            <a class="nav-link" href="#" data-section="forms" onclick="AppLayout.showSection('forms',this)"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單</a>
            <a class="nav-link" href="#" data-section="analytics" onclick="AppLayout.showSection('analytics',this)"><i class="bi bi-graph-up me-2"></i>統計分析</a>
            <a class="nav-link" href="#" data-section="reports" onclick="AppLayout.showSection('reports',this)"><i class="bi bi-file-earmark-text me-2"></i>報表中心</a>
          </nav>
      </aside>

      <main id="mainContent" class="col-lg-10 col-md-9 p-4">
        <!-- 儀表板 -->
        <section id="dashboardSection" class="content-section">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>儀表板</h4>
            <div class="d-flex gap-2">
              <div class="d-flex gap-1 me-3">
                <span id="syncIndicator" class="badge bg-success"><i class="bi bi-cloud-check"></i> 已同步</span>
                <span id="offlineIndicator" class="badge bg-danger d-none"><i class="bi bi-wifi-off"></i> 離線</span>
              </div>
              <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
              <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
              <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100">
                <div class="icon-bg"><i class="bi bi-cash-coin"></i></div>
                <small>總收入</small>
                <h3 id="dashTotalIncome" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">本月</span>
                  <span id="dashMonthIncome" class="small fw-semibold">$0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100 alt-orange">
                <div class="icon-bg"><i class="bi bi-credit-card-2-front"></i></div>
                <small>總支出</small>
                <h3 id="dashTotalExpense" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">本月</span>
                  <span id="dashMonthExpense" class="small fw-semibold">$0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100 alt-green">
                <div class="icon-bg"><i class="bi bi-bank"></i></div>
                <small>帳戶總餘額</small>
                <h3 id="dashTotalBalance" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">帳戶數</span>
                  <span id="dashAccountCount" class="small fw-semibold">0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100">
                <div class="icon-bg"><i class="bi bi-people"></i></div>
                <small>會員總數</small>
                <h3 id="dashMemberTotal" class="mb-1">0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">逾期會費</span>
                  <span id="dashMemberOverdue" class="badge bg-danger rounded-pill">0</span>
                </div>
              </div>
            </div>
          </div>

          <div class="card card-hoverable mb-3">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h6 class="mb-0"><i class="bi bi-bank me-1"></i>帳戶餘額概覽</h6>
              <button class="btn btn-sm btn-outline-primary" onclick="AccountUI.openManager()"><i class="bi bi-gear"></i> 管理帳戶</button>
            </div>
            <div class="card-body">
              <div id="dashboardAccountBalances" class="row g-3"></div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-arrows-expand me-1"></i>最近交易</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentTx">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-person-plus me-1"></i>新加入會員</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentMembers">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-calendar-event me-1"></i>近期活動</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentActivities">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 交易記錄 -->
        <section id="transactionsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-receipt me-2"></i>交易記錄</h4>
            <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
          </div>
          
          <div class="card card-hoverable mb-3">
            <div class="card-header bg-white">
              <div class="row g-2 align-items-center">
                <div class="col-md-2">
                  <select id="txFilterType" class="form-select form-select-sm" onchange="Transactions.applyFilters()">
                    <option value="">全部類型</option>
                    <option value="收入">收入</option>
                    <option value="支出">支出</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <select id="txFilterYear" class="form-select form-select-sm" onchange="Transactions.applyFilters()">
                    <option value="">全部年份</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <select id="txFilterAccount" class="form-select form-select-sm" onchange="Transactions.applyFilters()">
                    <option value="">全部帳戶</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <input id="txSearchInput" type="text" class="form-control form-control-sm" placeholder="搜尋交易..." onkeyup="Transactions.applyFilters()">
                </div>
                <div class="col-md-3 text-end">
                  <button class="btn btn-outline-secondary btn-sm" onclick="Transactions.exportToExcel()"><i class="bi bi-download"></i> 匯出</button>
                </div>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead>
                    <tr>
                      <th>日期</th>
                      <th>類型</th>
                      <th>類別</th>
                      <th>金額</th>
                      <th>對象</th>
                      <th>帳戶</th>
                      <th>說明</th>
                      <th>憑證</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="transactionsTableBody">
                    <tr>
                      <td colspan="9" class="text-center text-muted py-4">載入中...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- 會員管理 -->
        <section id="membersSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-people me-2"></i>會員管理</h4>
            <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
          </div>
          
          <div class="card card-hoverable mb-3">
            <div class="card-header bg-white">
              <div class="row g-2 align-items-center">
                <div class="col-md-2">
                  <select id="memberFilterStatus" class="form-select form-select-sm" onchange="Members.applyFilters()">
                    <option value="">全部狀態</option>
                    <option value="active">正常</option>
                    <option value="inactive">停權</option>
                    <option value="pending">待審核</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <select id="memberFilterType" class="form-select form-select-sm" onchange="Members.applyFilters()">
                    <option value="">全部類型</option>
                    <option value="regular">一般會員</option>
                    <option value="senior">資深會員</option>
                    <option value="honorary">榮譽會員</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <input id="memberSearchInput" type="text" class="form-control form-control-sm" placeholder="搜尋會員姓名、電話..." onkeyup="Members.applyFilters()">
                </div>
                <div class="col-md-4 text-end">
                  <button class="btn btn-outline-secondary btn-sm" onclick="Members.exportToExcel()"><i class="bi bi-download"></i> 匯出</button>
                </div>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead>
                    <tr>
                      <th>會員</th>
                      <th>聯絡方式</th>
                      <th>狀態</th>
                      <th>類型</th>
                      <th>加入日期</th>
                      <th>會費</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="membersTableBody">
                    <tr>
                      <td colspan="7" class="text-center text-muted py-4">載入中...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- 活動管理 -->
        <section id="activitiesSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-calendar-event me-2"></i>活動管理</h4>
            <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
          </div>
          
          <div class="row g-3" id="activitiesGrid">
            <div class="col-12 text-center text-muted py-4">載入中...</div>
          </div>
        </section>

        <!-- 公告管理 -->
        <section id="announcementsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-megaphone me-2"></i>公告管理</h4>
            <button class="btn btn-warning btn-sm" onclick="AnnouncementUI.open()"><i class="bi bi-plus-circle"></i> 新增公告</button>
          </div>
          
          <div id="announcementsList" class="row g-3">
            <div class="col-12 text-center text-muted py-4">載入中...</div>
          </div>
        </section>

        <!-- 行政表單 -->
        <section id="formsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單</h4>
            <button class="btn btn-secondary btn-sm" onclick="FormUI.open()"><i class="bi bi-plus-circle"></i> 新增表單</button>
          </div>
          
          <div id="formsList" class="row g-3">
            <div class="col-12 text-center text-muted py-4">載入中...</div>
          </div>
        </section>

        <!-- 統計分析 -->
        <section id="analyticsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-graph-up me-2"></i>統計分析</h4>
          </div>
          
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <div class="card card-hoverable">
                <div class="card-header bg-white">
                  <h6 class="mb-0">收支趨勢圖</h6>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="incomeExpenseChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card card-hoverable">
                <div class="card-header bg-white">
                  <h6 class="mb-0">支出類別分布</h6>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="expenseCategoryChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 報表中心 -->
        <section id="reportsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>報表中心</h4>
          </div>
          
          <div class="row g-3">
            <div class="col-md-4">
              <div class="card card-hoverable">
                <div class="card-body text-center">
                  <i class="bi bi-receipt display-4 text-primary mb-3"></i>
                  <h6>收支明細表</h6>
                  <p class="small text-muted">產生指定期間的收支明細報表</p>
                  <button class="btn btn-outline-primary btn-sm" onclick="Reports.generateIncomeExpense()">產生報表</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-hoverable">
                <div class="card-body text-center">
                  <i class="bi bi-people display-4 text-success mb-3"></i>
                  <h6>會員名冊</h6>
                  <p class="small text-muted">產生會員清單與統計資料</p>
                  <button class="btn btn-outline-success btn-sm" onclick="Reports.generateMemberList()">產生報表</button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-hoverable">
                <div class="card-body text-center">
                  <i class="bi bi-calendar-event display-4 text-info mb-3"></i>
                  <h6>活動報表</h6>
                  <p class="small text-muted">產生活動參與統計報表</p>
                  <button class="btn btn-outline-info btn-sm" onclick="Reports.generateActivityReport()">產生報表</button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- 交易 Modal -->
  <div class="modal fade" id="transactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title"><i class="bi bi-receipt me-2"></i><span id="transactionModalTitle">新增交易</span></h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="transactionForm">
            <input type="hidden" id="transactionId">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">日期 *</label>
                <input type="date" id="transactionDate" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">類型 *</label>
                <select id="transactionType" class="form-select" required onchange="TransactionUI.updateCategories()">
                  <option value="">請選擇</option>
                  <option value="收入">收入</option>
                  <option value="支出">支出</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">類別 *</label>
                <select id="transactionCategory" class="form-select" required>
                  <option value="">請選擇類型後顯示</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">金額 *</label>
                <input type="number" id="transactionAmount" class="form-control" min="0" step="0.01" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">對象</label>
                <input type="text" id="transactionCounterparty" class="form-control" list="counterpartyList">
                <datalist id="counterpartyList"></datalist>
              </div>
              <div class="col-md-6">
                <label class="form-label">帳戶</label>
                <select id="transactionAccount" class="form-select">
                  <option value="">請選擇帳戶</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">說明</label>
                <textarea id="transactionDescription" class="form-control" rows="2"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">收據編號</label>
                <input type="text" id="transactionReceiptNumber" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">憑證編號</label>
                <input type="text" id="transactionVoucherNumber" class="form-control">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary" onclick="TransactionUI.save()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 會員 Modal -->
  <div class="modal fade" id="memberModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title"><i class="bi bi-person me-2"></i><span id="memberModalTitle">新增會員</span></h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="memberForm">
            <input type="hidden" id="memberId">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">姓名 *</label>
                <input type="text" id="memberName" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">電話 *</label>
                <input type="tel" id="memberPhone" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Email</label>
                <input type="email" id="memberEmail" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">出生日期</label>
                <input type="date" id="memberBirthDate" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">性別</label>
                <select id="memberGender" class="form-select">
                  <option value="">請選擇</option>
                  <option value="男">男</option>
                  <option value="女">女</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">身分證字號</label>
                <input type="text" id="memberIdNumber" class="form-control">
              </div>
              <div class="col-12">
                <label class="form-label">地址</label>
                <input type="text" id="memberAddress" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">緊急聯絡人</label>
                <input type="text" id="memberEmergencyContact" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">緊急聯絡電話</label>
                <input type="tel" id="memberEmergencyPhone" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">加入日期 *</label>
                <input type="date" id="memberJoinDate" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">狀態 *</label>
                <select id="memberStatus" class="form-select" required>
                  <option value="active">正常</option>
                  <option value="inactive">停權</option>
                  <option value="pending">待審核</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">會員類型 *</label>
                <select id="memberType" class="form-select" required>
                  <option value="regular">一般會員</option>
                  <option value="senior">資深會員</option>
                  <option value="honorary">榮譽會員</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">年費</label>
                <input type="number" id="memberMembershipFee" class="form-control" min="0">
              </div>
              <div class="col-md-6">
                <label class="form-label">最後繳費日期</label>
                <input type="date" id="memberLastPaymentDate" class="form-control">
              </div>
              <div class="col-12">
                <label class="form-label">備註</label>
                <textarea id="memberNotes" class="form-control" rows="2"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-success" onclick="MemberUI.save()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 活動 Modal -->
  <div class="modal fade" id="activityModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title"><i class="bi bi-calendar-event me-2"></i><span id="activityModalTitle">新增活動</span></h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="activityForm">
            <input type="hidden" id="activityId">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">活動名稱 *</label>
                <input type="text" id="activityName" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">活動類型 *</label>
                <select id="activityType" class="form-select" required>
                  <option value="">請選擇</option>
                  <option value="講座">講座</option>
                  <option value="聚會">聚會</option>
                  <option value="旅遊">旅遊</option>
                  <option value="運動">運動</option>
                  <option value="其他">其他</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">活動日期 *</label>
                <input type="date" id="activityDate" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">活動時間</label>
                <input type="time" id="activityTime" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">狀態 *</label>
                <select id="activityStatus" class="form-select" required>
                  <option value="planning">籌備中</option>
                  <option value="registration">報名中</option>
                  <option value="ongoing">進行中</option>
                  <option value="completed">已完成</option>
                  <option value="cancelled">已取消</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">報名開始日期</label>
                <input type="date" id="activityRegistrationStartDate" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">報名結束日期</label>
                <input type="date" id="activityRegistrationEndDate" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">活動地點</label>
                <input type="text" id="activityLocation" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">人數上限</label>
                <input type="number" id="activityMaxParticipants" class="form-control" min="1" value="50">
              </div>
              <div class="col-md-6">
                <label class="form-label">活動費用</label>
                <input type="number" id="activityFee" class="form-control" min="0" step="0.01">
              </div>
              <div class="col-md-6">
                <label class="form-label">聯絡人</label>
                <input type="text" id="activityContactPerson" class="form-control">
              </div>
              <div class="col-12">
                <label class="form-label">活動描述</label>
                <textarea id="activityDescription" class="form-control" rows="3"></textarea>
              </div>
              <div class="col-12">
                <label class="form-label">備註</label>
                <textarea id="activityNotes" class="form-control" rows="2"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-info text-white" onclick="ActivityUI.save()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 公告 Modal -->
  <div class="modal fade" id="announcementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title"><i class="bi bi-megaphone me-2"></i><span id="announcementModalTitle">新增公告</span></h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="announcementForm">
            <input type="hidden" id="announcementId">
            <div class="row g-3">
              <div class="col-md-8">
                <label class="form-label">標題 *</label>
                <input type="text" id="announcementTitle" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">類型 *</label>
                <select id="announcementType" class="form-select" required>
                  <option value="">請選擇</option>
                  <option value="一般">一般</option>
                  <option value="重要">重要</option>
                  <option value="緊急">緊急</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">狀態 *</label>
                <select id="announcementStatus" class="form-select" required>
                  <option value="draft">草稿</option>
                  <option value="published">已發布</option>
                  <option value="archived">已封存</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">發布日期</label>
                <input type="date" id="announcementPublishDate" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">過期日期</label>
                <input type="date" id="announcementExpireDate" class="form-control">
              </div>
              <div class="col-12">
                <label class="form-label">內容 *</label>
                <textarea id="announcementContent" class="form-control" rows="5" required></textarea>
              </div>
              <div class="col-12">
                <label class="form-label">相關連結</label>
                <input type="url" id="announcementLink" class="form-control" placeholder="https://">
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input type="checkbox" id="announcementPinned" class="form-check-input">
                  <label class="form-check-label" for="announcementPinned">置頂公告</label>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-warning" onclick="AnnouncementUI.save()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 表單 Modal -->
  <div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title"><i class="bi bi-file-earmark-arrow-down me-2"></i><span id="formModalTitle">新增表單</span></h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formForm">
            <input type="hidden" id="formId">
            <div class="mb-3">
              <label class="form-label">表單名稱 *</label>
              <input type="text" id="formName" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">分類 *</label>
              <select id="formCategory" class="form-select" required>
                <option value="">請選擇</option>
                <option value="申請表">申請表</option>
                <option value="報名表">報名表</option>
                <option value="調查表">調查表</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">表單連結 *</label>
              <input type="url" id="formUrl" class="form-control" required placeholder="https://">
            </div>
            <div class="mb-3">
              <label class="form-label">關鍵字</label>
              <input type="text" id="formKeywords" class="form-control" placeholder="用逗號分隔多個關鍵字">
              <div class="form-text">例如：申請,會員,入會</div>
            </div>
            <div class="mb-3">
              <label class="form-label">說明</label>
              <textarea id="formDescription" class="form-control" rows="3"></textarea>
            </div>
            <div class="form-check">
              <input type="checkbox" id="formActive" class="form-check-input" checked>
              <label class="form-check-label" for="formActive">啟用狀態</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-secondary" onclick="FormUI.save()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 帳戶管理 Modal -->
  <div class="modal fade" id="accountManagerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title"><i class="bi bi-bank me-2"></i>帳戶管理</h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6>帳戶列表</h6>
            <button class="btn btn-primary btn-sm" onclick="AccountUI.openEditor()"><i class="bi bi-plus-circle"></i> 新增帳戶</button>
          </div>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>名稱</th>
                  <th>說明</th>
                  <th>初始餘額</th>
                  <th>目前餘額</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="accountsTableBody">
                <tr>
                  <td colspan="6" class="text-center text-muted py-4">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 帳戶編輯 Modal -->
  <div class="modal fade" id="accountModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title"><i class="bi bi-bank me-2"></i><span id="accountModalTitle">新增帳戶</span></h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="accountForm">
            <input type="hidden" id="accountId">
            <div class="mb-3">
              <label class="form-label">帳戶名稱 *</label>
              <input type="text" id="accountName" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">說明</label>
              <input type="text" id="accountDescription" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">初始餘額</label>
              <input type="number" id="accountInitialBalance" class="form-control" step="0.01" value="0">
            </div>
            <div class="mb-3">
              <label class="form-label">備註</label>
              <textarea id="accountNotes" class="form-control" rows="2"></textarea>
            </div>
            <div class="form-check">
              <input type="checkbox" id="accountActive" class="form-check-input" checked>
              <label class="form-check-label" for="accountActive">啟用狀態</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary" onclick="AccountUI.saveAccount()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 系統設定 Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title"><i class="bi bi-sliders me-2"></i>系統設定</h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="settingsForm">
            <div class="row g-3">
              <div class="col-12">
                <h6 class="separator-title">組織資訊</h6>
              </div>
              <div class="col-md-6">
                <label class="form-label">組織名稱</label>
                <input type="text" id="settingsOrganizationName" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">組織電話</label>
                <input type="tel" id="settingsOrganizationPhone" class="form-control">
              </div>
              <div class="col-12">
                <label class="form-label">組織地址</label>
                <input type="text" id="settingsOrganizationAddress" class="form-control">
              </div>
              <div class="col-12">
                <label class="form-label">組織 Email</label>
                <input type="email" id="settingsOrganizationEmail" class="form-control">
              </div>
              <div class="col-12">
                <h6 class="separator-title">財務設定</h6>
              </div>
              <div class="col-md-4">
                <label class="form-label">預設年費</label>
                <input type="number" id="settingsDefaultMembershipFee" class="form-control" min="0">
              </div>
              <div class="col-md-4">
                <label class="form-label">收據編號前綴</label>
                <input type="text" id="settingsReceiptPrefix" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">憑證編號前綴</label>
                <input type="text" id="settingsVoucherPrefix" class="form-control">
              </div>
              <div class="col-12">
                <h6 class="separator-title">收支類別設定</h6>
              </div>
              <div class="col-md-6">
                <label class="form-label">收入類別</label>
                <textarea id="settingsIncomeCategories" class="form-control" rows="4" placeholder="每行一個類別"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">支出類別</label>
                <textarea id="settingsExpenseCategories" class="form-control" rows="4" placeholder="每行一個類別"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary" onclick="SettingsUI.save()">儲存設定</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast 通知 -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:2000;">
    <div id="toastSuccess" class="toast align-items-center border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body"><i class="bi bi-check-circle text-success me-2"></i><span id="toastSuccessMsg">成功</span></div>
        <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastError" class="toast align-items-center border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body"><i class="bi bi-exclamation-triangle text-danger me-2"></i><span id="toastErrorMsg">錯誤</span></div>
        <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- 依賴套件 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
  // ================== 配置設定 ==================
  const CONFIG = {
    // 請替換為您的 Google Apps Script Web App URL
    API_URL: 'https://script.google.com/macros/s/AKfycbz8T9ZZMtqXEcK1o11R6NIZSuEIWHNI8O8V6_nfnP7gMxdAMa86uu6_ZF3lRkJZZBtVAA/exec',
    // 或者使用測試 URL（開發階段）
    // API_URL: 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/dev'
  };

  // ================== API 通信層 ==================
  // const API = {
  //   async call(action, data = {}) {
  //     try {
  //       this.showLoading(true);
        
  //       const response = await fetch(CONFIG.API_URL, {
  //         method: 'POST',
  //         headers: {
  //           'Content-Type': 'application/json',
  //         },
  //         body: JSON.stringify({
  //           action: action,
  //           ...data
  //         })
  //       });

  //       if (!response.ok) {
  //         throw new Error(`HTTP error! status: ${response.status}`);
  //       }

  //         const result = await response.json();
          
  //         if (result.success) {
  //           return result.data;
  //         } else {
  //           throw new Error(result.error || '操作失敗');
  //         }
  //       } catch (error) {
  //         console.error('API call failed:', error);
  //         Util.showToast('error', error.message || '網路連線錯誤');
  //         throw error;
  //       } finally {
  //         this.showLoading(false);
  //       }
  //     },

  //     showLoading(show) {
  //       const overlay = document.getElementById('loadingOverlay');
  //       if (overlay) {
  //         overlay.style.display = show ? 'flex' : 'none';
  //       }
  //     }
  //   };

    // 修改 API 物件
  const API = {
  async call(action, data = {}) {
    try {
      this.showLoading(true);
      
      // 使用 no-cors 模式
      const response = await fetch(CONFIG.API_URL, {
        method: 'POST',
        mode: 'no-cors', // 添加這行
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: action,
          ...data
        })
      });

      // 由於 no-cors 模式，我們無法讀取回應內容
      // 需要改用其他方法
      return await this.callWithJSONP(action, data);
      
    } catch (error) {
      console.error('API call failed:', error);
      Util.showToast('error', error.message || '網路連線錯誤');
      throw error;
    } finally {
      this.showLoading(false);
    }
  },

  // JSONP 方式呼叫 API
  async callWithJSONP(action, data = {}) {
    return new Promise((resolve, reject) => {
      const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
      
      // 創建 script 標籤
      const script = document.createElement('script');
      const params = new URLSearchParams({
        action: action,
        data: JSON.stringify(data),
        callback: callbackName
      });
      
      script.src = CONFIG.API_URL + '?' + params.toString();
      
      // 設定回調函數
      window[callbackName] = function(response) {
        resolve(response);
        document.head.removeChild(script);
        delete window[callbackName];
      };
      
      // 錯誤處理
      script.onerror = function() {
        reject(new Error('JSONP request failed'));
        document.head.removeChild(script);
        delete window[callbackName];
      };
      
      document.head.appendChild(script);
    });
  },

  showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
      overlay.style.display = show ? 'flex' : 'none';
    }
  }
  };

    // ================== 工具層 ==================
    const Util = {
      uuid: () => 'id_' + Math.random().toString(36).slice(2, 10),
      today: () => new Date().toISOString().split('T')[0],
      fmtNum: n => (Number(n) || 0).toLocaleString(),
      toNumber: v => isNaN(parseFloat(v)) ? 0 : parseFloat(v),
      pad: (n, l = 2) => String(n).padStart(l, '0'),
      
      formatDateInput(d) {
        if (!d) return '';
        if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
        let s = String(d).replace(/[年月\.\/]/g, '-').replace(/日/, '');
        const m = s.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
        if (m) return m[1] + '-' + Util.pad(m[2]) + '-' + Util.pad(m[3]);
        const dt = new Date(d);
        if (isNaN(dt.getTime())) return '';
        return dt.toISOString().split('T')[0];
      },

      age(birth) {
        if (!birth) return '';
        const d = new Date(birth);
        if (isNaN(d.getTime())) return '';
        const t = new Date();
        let a = t.getFullYear() - d.getFullYear();
        if (t.getMonth() < d.getMonth() || (t.getMonth() == d.getMonth() && t.getDate() < d.getDate())) a--;
        return a;
      },

      showToast(type, msg) {
        const id = type === 'success' ? 'toastSuccess' : 'toastError';
        const el = document.getElementById(id);
        if (!el) { alert(msg); return; }
        (type === 'success' ? document.getElementById('toastSuccessMsg') : document.getElementById('toastErrorMsg')).textContent = msg;
        new bootstrap.Toast(el, { delay: 3000 }).show();
      },

      confirm(opts) {
        return Swal.fire({
          icon: opts.icon || 'warning',
          title: opts.title || '確定？',
          html: opts.html || opts.text || '',
          showCancelButton: true,
          confirmButtonText: opts.confirmText || '確定',
          cancelButtonText: opts.cancelText || '取消',
          confirmButtonColor: opts.confirmColor || '#0d6efd'
        });
      },

      downloadBlob(filename, data, type = 'text/plain') {
        const blob = new Blob([data], { type });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
      }
    };

    // ================== Layout 管理 ==================
    const AppLayout = {
      showSection(name, link) {
        document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
        document.getElementById(name + 'Section').style.display = 'block';
        document.querySelectorAll('.sidebar .nav-link').forEach(a => a.classList.remove('active'));
        if (link) link.classList.add('active');
        
        switch (name) {
          case 'dashboard': Dashboard.refresh(); break;
          case 'transactions': Transactions.load(); break;
          case 'members': Members.load(); break;
          case 'activities': Activities.load(); break;
          case 'announcements': Announcements.load(); break;
          case 'forms': Forms.load(); break;
          case 'analytics': Analytics.refresh(); break;
          case 'reports': Reports.init(); break;
        }
        
        if (window.innerWidth < 992) this.toggleSidebar(false);
      },

      toggleSidebar(force) {
        const sb = document.getElementById('sidebar');
        if (typeof force === 'boolean') {
          sb.classList.toggle('show', force);
        } else {
          sb.classList.toggle('show');
        }
      }
    };

    // ================== 儀表板 ==================
    const Dashboard = {
      async refresh() {
        try {
          const data = await API.call('getDashboardData');
          this.updateStats(data.stats);
          this.renderAccounts(data.accounts);
          this.renderRecentTransactions(data.recentTransactions);
          this.renderRecentMembers(data.recentMembers);
          this.renderRecentActivities(data.recentActivities);
        } catch (error) {
          console.error('Dashboard refresh failed:', error);
        }
      },

      updateStats(stats) {
        document.getElementById('dashTotalIncome').textContent = '$' + Util.fmtNum(stats.totalIncome);
        document.getElementById('dashTotalExpense').textContent = '$' + Util.fmtNum(stats.totalExpense);
        document.getElementById('dashMonthIncome').textContent = '$' + Util.fmtNum(stats.monthIncome);
        document.getElementById('dashMonthExpense').textContent = '$' + Util.fmtNum(stats.monthExpense);
        document.getElementById('dashTotalBalance').textContent = '$' + Util.fmtNum(stats.totalBalance);
        document.getElementById('dashAccountCount').textContent = stats.accountCount;
        document.getElementById('dashMemberTotal').textContent = stats.memberTotal;
        document.getElementById('dashMemberOverdue').textContent = stats.memberOverdue;
      },

      renderAccounts(accounts) {
        const container = document.getElementById('dashboardAccountBalances');
        if (!container) return;
        
        if (!accounts.length) {
          container.innerHTML = '<div class="col-12 text-muted">尚無帳戶</div>';
          return;
        }
        
        container.innerHTML = accounts.map(a => `
          <div class="col-6 col-md-3">
            <div class="border rounded p-2 h-100 small bg-white">
              <div class="d-flex justify-content-between">
                <span class="fw-semibold">${a.name}</span>
                <span class="badge ${a.active ? 'bg-success' : 'bg-secondary'}">${a.active ? '啟用' : '停用'}</span>
              </div>
              <div class="mt-1">
                <span class="text-muted">餘額：</span>
                <span class="${a.currentBalance >= 0 ? 'text-success' : 'text-danger'} fw-semibold">$${Util.fmtNum(a.currentBalance)}</span>
              </div>
            </div>
          </div>`).join('');
      },

      renderRecentTransactions(transactions) {
        const box = document.getElementById('dashboardRecentTx');
        if (!transactions.length) {
          box.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易</div>';
          return;
        }
        
        box.innerHTML = transactions.map(t => `
          <div class="d-flex justify-content-between align-items-center border-bottom py-2 small">
            <div>
              <div class="fw-semibold">${t.category}</div>
              <div class="text-muted">${t.date} ${t.counterparty || ''}</div>
            </div>
            <div class="text-end">
              <span class="badge ${t.type === '收入' ? 'bg-success' : 'bg-danger'}">${t.type === '收入' ? '+' : '-'}$${Util.fmtNum(t.amount)}</span>
            </div>
          </div>`).join('');
      },

      renderRecentMembers(members) {
        const box = document.getElementById('dashboardRecentMembers');
        if (!members.length) {
          box.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員</div>';
          return;
        }
        
        box.innerHTML = members.map(m => `
          <div class="d-flex align-items-center border-bottom py-2 small">
            <div class="member-avatar me-2"><i class="bi bi-person"></i></div>
            <div class="flex-grow-1">
              <div class="fw-semibold">${m.name}</div>
              <div class="text-muted">${m.joinDate}</div>
            </div>
            <span class="badge ${Members.badgeClass(m.status)}">${Members.statusText(m.status)}</span>
          </div>`).join('');
      },

      renderRecentActivities(activities) {
        const box = document.getElementById('dashboardRecentActivities');
        if (!activities.length) {
          box.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動</div>';
          return;
        }
        
        box.innerHTML = activities.map(a => `
          <div class="d-flex align-items-center border-bottom py-2 small">
            <div class="me-2 text-info"><i class="bi bi-calendar-event"></i></div>
            <div class="flex-grow-1">
              <div class="fw-semibold">${a.name}</div>
              <div class="text-muted">${a.date}</div>
            </div>
            <span class="badge ${Activities.statusBadge(a.status)}">${Activities.statusText(a.status)}</span>
          </div>`).join('');
      }
    };

    // ================== 交易管理 ==================
    const Transactions = {
      data: [],
      filteredData: [],

      async load() {
        try {
          this.data = await API.call('getTransactions');
          this.applyFilters();
          this.populateFilters();
        } catch (error) {
          console.error('Load transactions failed:', error);
        }
      },

      applyFilters() {
        const type = document.getElementById('txFilterType')?.value || '';
        const year = document.getElementById('txFilterYear')?.value || '';
        const account = document.getElementById('txFilterAccount')?.value || '';
        const search = document.getElementById('txSearchInput')?.value.toLowerCase() || '';

        this.filteredData = this.data.filter(t => {
          if (type && t.type !== type) return false;
          if (year && !t.date.startsWith(year)) return false;
          if (account && t.account !== account) return false;
          if (search && !this.matchesSearch(t, search)) return false;
          return true;
        });

        this.renderTable();
      },

      matchesSearch(transaction, search) {
        const searchFields = [
          transaction.category,
          transaction.counterparty,
          transaction.description,
          transaction.receiptNumber,
          transaction.voucherNumber
        ];
        return searchFields.some(field => 
          field && field.toLowerCase().includes(search)
        );
      },

      populateFilters() {
        // 填充年份篩選器
        const years = [...new Set(this.data.map(t => t.date.slice(0, 4)))].sort().reverse();
        const yearSelect = document.getElementById('txFilterYear');
        if (yearSelect) {
          yearSelect.innerHTML = '<option value="">全部年份</option>' +
            years.map(y => `<option value="${y}">${y}</option>`).join('');
        }

        // 填充帳戶篩選器
        this.populateAccountFilter();
      },

      async populateAccountFilter() {
        try {
          const accounts = await API.call('getAccounts');
          const accountSelect = document.getElementById('txFilterAccount');
          if (accountSelect) {
            accountSelect.innerHTML = '<option value="">全部帳戶</option>' +
              accounts.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
          }
        } catch (error) {
          console.error('Load accounts for filter failed:', error);
        }
      },

      renderTable() {
        const tbody = document.getElementById('transactionsTableBody');
        if (!tbody) return;

        if (!this.filteredData.length) {
          tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">無符合條件的交易記錄</td></tr>';
          return;
        }

        tbody.innerHTML = this.filteredData.map(t => `
          <tr>
            <td>${t.date}</td>
            <td><span class="badge ${t.type === '收入' ? 'bg-success' : 'bg-danger'}">${t.type}</span></td>
            <td>${t.category}</td>
            <td class="text-end fw-semibold">${Util.fmtNum(t.amount)}</td>
            <td>${t.counterparty || '-'}</td>
            <td>${t.account || '-'}</td>
            <td>${t.description || '-'}</td>
            <td>${t.receiptNumber || t.voucherNumber || '-'}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-outline-primary" onclick="TransactionUI.edit('${t.id}')">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="Transactions.delete('${t.id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>`).join('');
      },

      async delete(id) {
        const result = await Util.confirm({
          title: '確定刪除？',
          text: '此操作無法復原',
          confirmText: '刪除',
          confirmColor: '#dc3545'
        });

        if (result.isConfirmed) {
          try {
            await API.call('deleteTransaction', { id });
            Util.showToast('success', '交易已刪除');
            this.load();
            Dashboard.refresh();
          } catch (error) {
            console.error('Delete transaction failed:', error);
          }
        }
      },

      exportToExcel() {
        if (!this.filteredData.length) {
          Util.showToast('error', '無資料可匯出');
          return;
        }

        const ws = XLSX.utils.json_to_sheet(this.filteredData.map(t => ({
          '日期': t.date,
          '類型': t.type,
          '類別': t.category,
          '金額': t.amount,
          '對象': t.counterparty,
          '帳戶': t.account,
          '說明': t.description,
          '收據編號': t.receiptNumber,
          '憑證編號': t.voucherNumber
        })));

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '交易記錄');
        XLSX.writeFile(wb, `交易記錄_${Util.today()}.xlsx`);
      }
    };

    // ================== 交易 UI ==================
    const TransactionUI = {
      currentId: null,

      async open(id = null) {
        this.currentId = id;
        const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
        
        if (id) {
          document.getElementById('transactionModalTitle').textContent = '編輯交易';
          await this.loadTransaction(id);
        } else {
          document.getElementById('transactionModalTitle').textContent = '新增交易';
          this.resetForm();
        }

        await this.loadCategories();
        await this.loadAccounts();
        modal.show();
      },

      async loadTransaction(id) {
        try {
          const transaction = await API.call('getTransaction', { id });
          this.populateForm(transaction);
        } catch (error) {
          console.error('Load transaction failed:', error);
        }
      },

      populateForm(data) {
        document.getElementById('transactionId').value = data.id || '';
        document.getElementById('transactionDate').value = data.date || Util.today();
        document.getElementById('transactionType').value = data.type || '';
        document.getElementById('transactionCategory').value = data.category || '';
        document.getElementById('transactionAmount').value = data.amount || '';
        document.getElementById('transactionCounterparty').value = data.counterparty || '';
        document.getElementById('transactionAccount').value = data.account || '';
        document.getElementById('transactionDescription').value = data.description || '';
        document.getElementById('transactionReceiptNumber').value = data.receiptNumber || '';
        document.getElementById('transactionVoucherNumber').value = data.voucherNumber || '';
        
        this.updateCategories();
      },

      resetForm() {
        document.getElementById('transactionForm').reset();
        document.getElementById('transactionId').value = '';
        document.getElementById('transactionDate').value = Util.today();
      },

      async loadCategories() {
        try {
          const settings = await API.call('getSettings');
          this.categories = settings.categories || { '收入': [], '支出': [] };
        } catch (error) {
          console.error('Load categories failed:', error);
          this.categories = { '收入': [], '支出': [] };
        }
      },

      updateCategories() {
        const type = document.getElementById('transactionType').value;
        const categorySelect = document.getElementById('transactionCategory');
        
        if (!type) {
          categorySelect.innerHTML = '<option value="">請選擇類型後顯示</option>';
          return;
        }

        const categories = this.categories[type] || [];
        categorySelect.innerHTML = '<option value="">請選擇類別</option>' +
          categories.map(c => `<option value="${c}">${c}</option>`).join('');
      },

      async loadAccounts() {
        try {
          const accounts = await API.call('getAccounts');
          const accountSelect = document.getElementById('transactionAccount');
          accountSelect.innerHTML = '<option value="">請選擇帳戶</option>' +
            accounts.filter(a => a.active).map(a => `<option value="${a.name}">${a.name}</option>`).join('');
        } catch (error) {
          console.error('Load accounts failed:', error);
        }
      },

      async save() {
        const form = document.getElementById('transactionForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const data = {
          id: document.getElementById('transactionId').value || null,
          date: document.getElementById('transactionDate').value,
          type: document.getElementById('transactionType').value,
          category: document.getElementById('transactionCategory').value,
          amount: parseFloat(document.getElementById('transactionAmount').value),
          counterparty: document.getElementById('transactionCounterparty').value,
          account: document.getElementById('transactionAccount').value,
          description: document.getElementById('transactionDescription').value,
          receiptNumber: document.getElementById('transactionReceiptNumber').value,
          voucherNumber: document.getElementById('transactionVoucherNumber').value
        };

        try {
          if (data.id) {
            await API.call('updateTransaction', data);
            Util.showToast('success', '交易已更新');
          } else {
            await API.call('addTransaction', data);
            Util.showToast('success', '交易已新增');
          }

          bootstrap.Modal.getInstance(document.getElementById('transactionModal')).hide();
          Transactions.load();
          Dashboard.refresh();
        } catch (error) {
          console.error('Save transaction failed:', error);
        }
      }
    };

    // ================== 會員管理 ==================
    const Members = {
      data: [],
      filteredData: [],

      async load() {
        try {
          this.data = await API.call('getMembers');
          this.applyFilters();
        } catch (error) {
          console.error('Load members failed:', error);
        }
      },

      applyFilters() {
        const status = document.getElementById('memberFilterStatus')?.value || '';
        const type = document.getElementById('memberFilterType')?.value || '';
        const search = document.getElementById('memberSearchInput')?.value.toLowerCase() || '';

        this.filteredData = this.data.filter(m => {
          if (status && m.status !== status) return false;
          if (type && m.type !== type) return false;
          if (search && !this.matchesSearch(m, search)) return false;
          return true;
        });

        this.renderTable();
      },

      matchesSearch(member, search) {
        const searchFields = [
          member.name,
          member.phone,
          member.email,
          member.idNumber
        ];
        return searchFields.some(field => 
          field && field.toLowerCase().includes(search)
        );
      },

      renderTable() {
        const tbody = document.getElementById('membersTableBody');
        if (!tbody) return;

        if (!this.filteredData.length) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">無符合條件的會員</td></tr>';
          return;
        }

        tbody.innerHTML = this.filteredData.map(m => `
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="member-avatar me-2"><i class="bi bi-person"></i></div>
                <div>
                  <div class="fw-semibold">${m.name}</div>
                  <div class="small text-muted">${m.idNumber || ''}</div>
                </div>
              </div>
            </td>
            <td>
              <div>${m.phone}</div>
              <div class="small text-muted">${m.email || ''}</div>
            </td>
            <td><span class="badge ${this.badgeClass(m.status)}">${this.statusText(m.status)}</span></td>
            <td><span class="badge bg-secondary">${this.typeText(m.type)}</span></td>
            <td>${m.joinDate}</td>
            <td>
              <div>$${Util.fmtNum(m.membershipFee || 0)}</div>
              <div class="small text-muted">${m.lastPaymentDate || '未繳費'}</div>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-outline-primary" onclick="MemberUI.edit('${m.id}')">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="Members.delete('${m.id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>`).join('');
      },

      badgeClass(status) {
        const classes = {
          'active': 'bg-success',
          'inactive': 'bg-secondary',
          'pending': 'bg-warning'
        };
        return classes[status] || 'bg-secondary';
      },

      statusText(status) {
        const texts = {
          'active': '正常',
          'inactive': '停權',
          'pending': '待審核'
        };
        return texts[status] || status;
      },

      typeText(type) {
        const texts = {
          'regular': '一般會員',
          'senior': '資深會員',
          'honorary': '榮譽會員'
        };
        return texts[type] || type;
      },

      async delete(id) {
        const result = await Util.confirm({
          title: '確定刪除？',
          text: '此操作無法復原',
          confirmText: '刪除',
          confirmColor: '#dc3545'
        });

        if (result.isConfirmed) {
          try {
            await API.call('deleteMember', { id });
            Util.showToast('success', '會員已刪除');
            this.load();
            Dashboard.refresh();
          } catch (error) {
            console.error('Delete member failed:', error);
          }
        }
      },

      exportToExcel() {
        if (!this.filteredData.length) {
          Util.showToast('error', '無資料可匯出');
          return;
        }

        const ws = XLSX.utils.json_to_sheet(this.filteredData.map(m => ({
          '姓名': m.name,
          '電話': m.phone,
          'Email': m.email,
          '出生日期': m.birthDate,
          '性別': m.gender,
          '身分證字號': m.idNumber,
          '地址': m.address,
          '加入日期': m.joinDate,
          '狀態': this.statusText(m.status),
          '會員類型': this.typeText(m.type),
          '年費': m.membershipFee,
          '最後繳費日期': m.lastPaymentDate
        })));

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '會員名冊');
        XLSX.writeFile(wb, `會員名冊_${Util.today()}.xlsx`);
      }
    };

    // ================== 會員 UI ==================
    const MemberUI = {
      currentId: null,

      async open(id = null) {
        this.currentId = id;
        const modal = new bootstrap.Modal(document.getElementById('memberModal'));
        
        if (id) {
          document.getElementById('memberModalTitle').textContent = '編輯會員';
          await this.loadMember(id);
        } else {
          document.getElementById('memberModalTitle').textContent = '新增會員';
          this.resetForm();
        }

        modal.show();
      },

      async loadMember(id) {
        try {
          const member = await API.call('getMember', { id });
          this.populateForm(member);
        } catch (error) {
          console.error('Load member failed:', error);
        }
      },

      populateForm(data) {
        document.getElementById('memberId').value = data.id || '';
        document.getElementById('memberName').value = data.name || '';
        document.getElementById('memberPhone').value = data.phone || '';
        document.getElementById('memberEmail').value = data.email || '';
        document.getElementById('memberBirthDate').value = data.birthDate || '';
        document.getElementById('memberGender').value = data.gender || '';
        document.getElementById('memberIdNumber').value = data.idNumber || '';
        document.getElementById('memberAddress').value = data.address || '';
        document.getElementById('memberEmergencyContact').value = data.emergencyContact || '';
        document.getElementById('memberEmergencyPhone').value = data.emergencyPhone || '';
        document.getElementById('memberJoinDate').value = data.joinDate || Util.today();
        document.getElementById('memberStatus').value = data.status || 'active';
        document.getElementById('memberType').value = data.type || 'regular';
        document.getElementById('memberMembershipFee').value = data.membershipFee || '';
        document.getElementById('memberLastPaymentDate').value = data.lastPaymentDate || '';
        document.getElementById('memberNotes').value = data.notes || '';
      },

      resetForm() {
        document.getElementById('memberForm').reset();
        document.getElementById('memberId').value = '';
        document.getElementById('memberJoinDate').value = Util.today();
        document.getElementById('memberStatus').value = 'active';
        document.getElementById('memberType').value = 'regular';
      },

      async save() {
        const form = document.getElementById('memberForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const data = {
          id: document.getElementById('memberId').value || null,
          name: document.getElementById('memberName').value,
          phone: document.getElementById('memberPhone').value,
          email: document.getElementById('memberEmail').value,
          birthDate: document.getElementById('memberBirthDate').value,
          gender: document.getElementById('memberGender').value,
          idNumber: document.getElementById('memberIdNumber').value,
          address: document.getElementById('memberAddress').value,
          emergencyContact: document.getElementById('memberEmergencyContact').value,
          emergencyPhone: document.getElementById('memberEmergencyPhone').value,
          joinDate: document.getElementById('memberJoinDate').value,
          status: document.getElementById('memberStatus').value,
          type: document.getElementById('memberType').value,
          membershipFee: parseFloat(document.getElementById('memberMembershipFee').value) || 0,
          lastPaymentDate: document.getElementById('memberLastPaymentDate').value,
          notes: document.getElementById('memberNotes').value
        };

        try {
          if (data.id) {
            await API.call('updateMember', data);
            Util.showToast('success', '會員資料已更新');
          } else {
            await API.call('addMember', data);
            Util.showToast('success', '會員已新增');
          }

          bootstrap.Modal.getInstance(document.getElementById('memberModal')).hide();
          Members.load();
          Dashboard.refresh();
        } catch (error) {
          console.error('Save member failed:', error);
        }
      }
    };

    // ================== 活動管理 ==================
    const Activities = {
      data: [],

      async load() {
        try {
          this.data = await API.call('getActivities');
          this.renderGrid();
        } catch (error) {
          console.error('Load activities failed:', error);
        }
      },

      renderGrid() {
        const container = document.getElementById('activitiesGrid');
        if (!container) return;

        if (!this.data.length) {
          container.innerHTML = '<div class="col-12 text-center text-muted py-4">尚無活動</div>';
          return;
        }

        container.innerHTML = this.data.map(a => `
          <div class="col-md-6 col-lg-4">
            <div class="activity-card card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="card-title mb-0">${a.name}</h6>
                  <span class="badge ${this.statusBadge(a.status)}">${this.statusText(a.status)}</span>
                </div>
                <div class="small text-muted mb-2">
                  <i class="bi bi-calendar me-1"></i>${a.date}
                  ${a.time ? `<i class="bi bi-clock ms-2 me-1"></i>${a.time}` : ''}
                </div>
                ${a.location ? `<div class="small text-muted mb-2"><i class="bi bi-geo-alt me-1"></i>${a.location}</div>` : ''}
                <div class="small mb-2">
                  <span class="text-muted">參與人數：</span>
                  <span class="fw-semibold">${a.currentParticipants || 0}/${a.maxParticipants || '∞'}</span>
                </div>
                ${a.fee ? `<div class="small mb-2"><span class="text-muted">費用：</span><span class="fw-semibold">$${Util.fmtNum(a.fee)}</span></div>` : ''}
                <div class="progress mb-3">
                  <div class="progress-bar" style="width: ${this.getProgressPercent(a)}%"></div>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-sm btn-outline-primary flex-fill" onclick="ActivityUI.edit('${a.id}')">
                    <i class="bi bi-pencil"></i> 編輯
                  </button>
                  <button class="btn btn-sm btn-outline-info" onclick="Activities.viewParticipants('${a.id}')">
                    <i class="bi bi-people"></i> 參與者
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="Activities.delete('${a.id}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>`).join('');
      },

      statusBadge(status) {
        const badges = {
          'planning': 'bg-secondary',
          'registration': 'bg-primary',
          'ongoing': 'bg-warning',
          'completed': 'bg-success',
          'cancelled': 'bg-danger'
        };
        return badges[status] || 'bg-secondary';
      },

      statusText(status) {
        const texts = {
          'planning': '籌備中',
          'registration': '報名中',
          'ongoing': '進行中',
          'completed': '已完成',
          'cancelled': '已取消'
        };
        return texts[status] || status;
      },

      getProgressPercent(activity) {
        if (!activity.maxParticipants) return 0;
        return Math.min(100, (activity.currentParticipants || 0) / activity.maxParticipants * 100);
      },

      async viewParticipants(id) {
        try {
          const participants = await API.call('getActivityParticipants', { id });
          // 這裡可以顯示參與者列表的 modal
          console.log('Participants:', participants);
          Util.showToast('info', `共有 ${participants.length} 位參與者`);
        } catch (error) {
          console.error('Load participants failed:', error);
        }
      },

      async delete(id) {
        const result = await Util.confirm({
          title: '確定刪除？',
          text: '此操作無法復原',
          confirmText: '刪除',
          confirmColor: '#dc3545'
        });

        if (result.isConfirmed) {
          try {
            await API.call('deleteActivity', { id });
            Util.showToast('success', '活動已刪除');
            this.load();
            Dashboard.refresh();
          } catch (error) {
            console.error('Delete activity failed:', error);
          }
        }
      }
    };

    // ================== 活動 UI ==================
    const ActivityUI = {
      currentId: null,

      async open(id = null) {
        this.currentId = id;
        const modal = new bootstrap.Modal(document.getElementById('activityModal'));
        
        if (id) {
          document.getElementById('activityModalTitle').textContent = '編輯活動';
          await this.loadActivity(id);
        } else {
          document.getElementById('activityModalTitle').textContent = '新增活動';
          this.resetForm();
        }

        modal.show();
      },

      async loadActivity(id) {
        try {
          const activity = await API.call('getActivity', { id });
          this.populateForm(activity);
        } catch (error) {
          console.error('Load activity failed:', error);
        }
      },

      populateForm(data) {
        document.getElementById('activityId').value = data.id || '';
        document.getElementById('activityName').value = data.name || '';
        document.getElementById('activityType').value = data.type || '';
        document.getElementById('activityDate').value = data.date || '';
        document.getElementById('activityTime').value = data.time || '';
        document.getElementById('activityStatus').value = data.status || 'planning';
        document.getElementById('activityRegistrationStartDate').value = data.registrationStartDate || '';
        document.getElementById('activityRegistrationEndDate').value = data.registrationEndDate || '';
        document.getElementById('activityLocation').value = data.location || '';
        document.getElementById('activityMaxParticipants').value = data.maxParticipants || '';
        document.getElementById('activityFee').value = data.fee || '';
        document.getElementById('activityContactPerson').value = data.contactPerson || '';
        document.getElementById('activityDescription').value = data.description || '';
        document.getElementById('activityNotes').value = data.notes || '';
      },

      resetForm() {
        document.getElementById('activityForm').reset();
        document.getElementById('activityId').value = '';
        document.getElementById('activityStatus').value = 'planning';
        document.getElementById('activityMaxParticipants').value = '50';
      },

      async save() {
        const form = document.getElementById('activityForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const data = {
          id: document.getElementById('activityId').value || null,
          name: document.getElementById('activityName').value,
          type: document.getElementById('activityType').value,
          date: document.getElementById('activityDate').value,
          time: document.getElementById('activityTime').value,
          status: document.getElementById('activityStatus').value,
          registrationStartDate: document.getElementById('activityRegistrationStartDate').value,
          registrationEndDate: document.getElementById('activityRegistrationEndDate').value,
          location: document.getElementById('activityLocation').value,
          maxParticipants: parseInt(document.getElementById('activityMaxParticipants').value) || null,
          fee: parseFloat(document.getElementById('activityFee').value) || 0,
          contactPerson: document.getElementById('activityContactPerson').value,
          description: document.getElementById('activityDescription').value,
          notes: document.getElementById('activityNotes').value
        };

        try {
          if (data.id) {
            await API.call('updateActivity', data);
            Util.showToast('success', '活動已更新');
          } else {
            await API.call('addActivity', data);
            Util.showToast('success', '活動已新增');
          }

          bootstrap.Modal.getInstance(document.getElementById('activityModal')).hide();
          Activities.load();
          Dashboard.refresh();
        } catch (error) {
          console.error('Save activity failed:', error);
        }
      }
    };

    // ================== 公告管理 ==================
    const Announcements = {
      data: [],

      async load() {
        try {
          this.data = await API.call('getAnnouncements');
          this.render();
        } catch (error) {
          console.error('Load announcements failed:', error);
        }
      },

      render() {
        const container = document.getElementById('announcementsList');
        if (!container) return;

        if (!this.data.length) {
          container.innerHTML = '<div class="col-12 text-center text-muted py-4">尚無公告</div>';
          return;
        }

        container.innerHTML = this.data.map(a => `
          <div class="col-md-6 col-lg-4">
            <div class="announcement-card card ${a.type === '緊急' ? 'urgent' : ''}">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="card-title mb-0">${a.title}</h6>
                  <div class="d-flex gap-1">
                    <span class="badge ${this.typeBadge(a.type)}">${a.type}</span>
                    ${a.pinned ? '<span class="badge bg-warning"><i class="bi bi-pin"></i></span>' : ''}
                  </div>
                </div>
                <div class="small text-muted mb-2">
                  發布日期：${a.publishDate || '未設定'}
                  ${a.expireDate ? `<br>到期日期：${a.expireDate}` : ''}
                </div>
                <p class="card-text small">${this.truncateContent(a.content)}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="badge ${this.statusBadge(a.status)}">${this.statusText(a.status)}</span>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="AnnouncementUI.edit('${a.id}')">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="Announcements.delete('${a.id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>`).join('');
      },

      typeBadge(type) {
        const badges = {
          '一般': 'bg-secondary',
          '重要': 'bg-warning',
          '緊急': 'bg-danger'
        };
        return badges[type] || 'bg-secondary';
      },

      statusBadge(status) {
        const badges = {
          'draft': 'bg-secondary',
          'published': 'bg-success',
          'archived': 'bg-dark'
        };
        return badges[status] || 'bg-secondary';
      },

      statusText(status) {
        const texts = {
          'draft': '草稿',
          'published': '已發布',
          'archived': '已封存'
        };
        return texts[status] || status;
      },

      truncateContent(content) {
        if (!content) return '';
        return content.length > 100 ? content.substring(0, 100) + '...' : content;
      },

      async delete(id) {
        const result = await Util.confirm({
          title: '確定刪除？',
          text: '此操作無法復原',
          confirmText: '刪除',
          confirmColor: '#dc3545'
        });

        if (result.isConfirmed) {
          try {
            await API.call('deleteAnnouncement', { id });
            Util.showToast('success', '公告已刪除');
            this.load();
          } catch (error) {
            console.error('Delete announcement failed:', error);
          }
        }
      }
    };

    // ================== 公告 UI ==================
    const AnnouncementUI = {
      currentId: null,

      async open(id = null) {
        this.currentId = id;
        const modal = new bootstrap.Modal(document.getElementById('announcementModal'));
        
        if (id) {
          document.getElementById('announcementModalTitle').textContent = '編輯公告';
          await this.loadAnnouncement(id);
        } else {
          document.getElementById('announcementModalTitle').textContent = '新增公告';
          this.resetForm();
        }

        modal.show();
      },

      async loadAnnouncement(id) {
        try {
          const announcement = await API.call('getAnnouncement', { id });
          this.populateForm(announcement);
        } catch (error) {
          console.error('Load announcement failed:', error);
        }
      },

      populateForm(data) {
        document.getElementById('announcementId').value = data.id || '';
        document.getElementById('announcementTitle').value = data.title || '';
        document.getElementById('announcementType').value = data.type || '';
        document.getElementById('announcementStatus').value = data.status || 'draft';
        document.getElementById('announcementPublishDate').value = data.publishDate || '';
        document.getElementById('announcementExpireDate').value = data.expireDate || '';
        document.getElementById('announcementContent').value = data.content || '';
        document.getElementById('announcementLink').value = data.link || '';
        document.getElementById('announcementPinned').checked = data.pinned || false;
      },

      resetForm() {
        document.getElementById('announcementForm').reset();
        document.getElementById('announcementId').value = '';
        document.getElementById('announcementStatus').value = 'draft';
      },

      async save() {
        const form = document.getElementById('announcementForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const data = {
          id: document.getElementById('announcementId').value || null,
          title: document.getElementById('announcementTitle').value,
          type: document.getElementById('announcementType').value,
          status: document.getElementById('announcementStatus').value,
          publishDate: document.getElementById('announcementPublishDate').value,
          expireDate: document.getElementById('announcementExpireDate').value,
          content: document.getElementById('announcementContent').value,
          link: document.getElementById('announcementLink').value,
          pinned: document.getElementById('announcementPinned').checked
        };

        try {
          if (data.id) {
            await API.call('updateAnnouncement', data);
            Util.showToast('success', '公告已更新');
          } else {
            await API.call('addAnnouncement', data);
            Util.showToast('success', '公告已新增');
          }

          bootstrap.Modal.getInstance(document.getElementById('announcementModal')).hide();
          Announcements.load();
        } catch (error) {
          console.error('Save announcement failed:', error);
        }
      }
    };

    // ================== 表單管理 ==================
    const Forms = {
      data: [],

      async load() {
        try {
          this.data = await API.call('getForms');
          this.render();
        } catch (error) {
          console.error('Load forms failed:', error);
        }
      },

      render() {
        const container = document.getElementById('formsList');
        if (!container) return;

        if (!this.data.length) {
          container.innerHTML = '<div class="col-12 text-center text-muted py-4">尚無表單</div>';
          return;
        }

        container.innerHTML = this.data.map(f => `
          <div class="col-md-6 col-lg-4">
            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="card-title mb-0">${f.name}</h6>
                  <span class="badge ${f.active ? 'bg-success' : 'bg-secondary'}">${f.active ? '啟用' : '停用'}</span>
                </div>
                <div class="small text-muted mb-2">分類：${f.category}</div>
                ${f.description ? `<p class="card-text small">${f.description}</p>` : ''}
                ${f.keywords ? `<div class="small text-muted mb-2">關鍵字：${f.keywords}</div>` : ''}
                <div class="d-flex gap-1">
                  <a href="${f.url}" target="_blank" class="btn btn-sm btn-primary flex-fill">
                    <i class="bi bi-box-arrow-up-right"></i> 開啟
                  </a>
                  <button class="btn btn-sm btn-outline-primary" onclick="FormUI.edit('${f.id}')">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="Forms.delete('${f.id}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>`).join('');
      },

      async delete(id) {
        const result = await Util.confirm({
          title: '確定刪除？',
          text: '此操作無法復原',
          confirmText: '刪除',
          confirmColor: '#dc3545'
        });

        if (result.isConfirmed) {
          try {
            await API.call('deleteForm', { id });
            Util.showToast('success', '表單已刪除');
            this.load();
          } catch (error) {
            console.error('Delete form failed:', error);
          }
        }
      }
    };

    // ================== 表單 UI ==================
    const FormUI = {
      currentId: null,

      async open(id = null) {
        this.currentId = id;
        const modal = new bootstrap.Modal(document.getElementById('formModal'));
        
        if (id) {
          document.getElementById('formModalTitle').textContent = '編輯表單';
          await this.loadForm(id);
        } else {
          document.getElementById('formModalTitle').textContent = '新增表單';
          this.resetForm();
        }

        modal.show();
      },

      async loadForm(id) {
        try {
          const form = await API.call('getForm', { id });
          this.populateForm(form);
        } catch (error) {
          console.error('Load form failed:', error);
        }
      },

      populateForm(data) {
        document.getElementById('formId').value = data.id || '';
        document.getElementById('formName').value = data.name || '';
        document.getElementById('formCategory').value = data.category || '';
        document.getElementById('formUrl').value = data.url || '';
        document.getElementById('formKeywords').value = data.keywords || '';
        document.getElementById('formDescription').value = data.description || '';
        document.getElementById('formActive').checked = data.active !== false;
      },

      resetForm() {
        document.getElementById('formForm').reset();
        document.getElementById('formId').value = '';
        document.getElementById('formActive').checked = true;
      },

      async save() {
        const form = document.getElementById('formForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const data = {
          id: document.getElementById('formId').value || null,
          name: document.getElementById('formName').value,
          category: document.getElementById('formCategory').value,
          url: document.getElementById('formUrl').value,
          keywords: document.getElementById('formKeywords').value,
          description: document.getElementById('formDescription').value,
          active: document.getElementById('formActive').checked
        };

        try {
          if (data.id) {
            await API.call('updateForm', data);
            Util.showToast('success', '表單已更新');
          } else {
            await API.call('addForm', data);
            Util.showToast('success', '表單已新增');
          }

          bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();
          Forms.load();
        } catch (error) {
          console.error('Save form failed:', error);
        }
      }
    };

    // ================== 分析統計 ==================
    const Analytics = {
      charts: {},

      async refresh() {
        try {
          const data = await API.call('getAnalyticsData');
          this.renderIncomeExpenseChart(data.monthlyIncomeExpense);
          this.renderCategoryChart(data.categoryStats);
          this.renderMemberChart(data.memberStats);
          this.renderActivityChart(data.activityStats);
        } catch (error) {
          console.error('Analytics refresh failed:', error);
        }
      },

      renderIncomeExpenseChart(data) {
        const ctx = document.getElementById('incomeExpenseChart');
        if (!ctx) return;

        if (this.charts.incomeExpense) {
          this.charts.incomeExpense.destroy();
        }

        this.charts.incomeExpense = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.labels,
            datasets: [{
              label: '收入',
              data: data.income,
              borderColor: '#28a745',
              backgroundColor: 'rgba(40, 167, 69, 0.1)',
              fill: true
            }, {
              label: '支出',
              data: data.expense,
              borderColor: '#dc3545',
              backgroundColor: 'rgba(220, 53, 69, 0.1)',
              fill: true
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '$' + value.toLocaleString();
                  }
                }
              }
            }
          }
        });
      },

      renderCategoryChart(data) {
        const ctx = document.getElementById('categoryChart');
        if (!ctx) return;

        if (this.charts.category) {
          this.charts.category.destroy();
        }

        this.charts.category = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: data.labels,
            datasets: [{
              data: data.values,
              backgroundColor: [
                '#007bff', '#28a745', '#ffc107', '#dc3545',
                '#6f42c1', '#fd7e14', '#20c997', '#e83e8c'
              ]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      },

      renderMemberChart(data) {
        const ctx = document.getElementById('memberChart');
        if (!ctx) return;

        if (this.charts.member) {
          this.charts.member.destroy();
        }

        this.charts.member = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: [{
              label: '新增會員',
              data: data.values,
              backgroundColor: '#007bff'
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      },

      renderActivityChart(data) {
        const ctx = document.getElementById('activityChart');
        if (!ctx) return;

        if (this.charts.activity) {
          this.charts.activity.destroy();
        }

        this.charts.activity = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: data.labels,
            datasets: [{
              data: data.values,
              backgroundColor: [
                '#28a745', '#007bff', '#ffc107', '#dc3545', '#6c757d'
              ]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
    };

    // ================== 報表管理 ==================
    const Reports = {
      init() {
        // 初始化報表頁面
      },

      async generateMemberList() {
        try {
          const members = await API.call('getMembers');
          const csvContent = this.membersToCsv(members);
          Util.downloadBlob('會員清單.csv', csvContent, 'text/csv;charset=utf-8;');
          Util.showToast('success', '會員清單已產生');
        } catch (error) {
          console.error('Generate member list failed:', error);
        }
      },

      membersToCsv(members) {
        const headers = ['姓名', '電話', 'Email', '狀態', '會員類型', '加入日期', '年費', '最後繳費日期'];
        const rows = members.map(m => [
          m.name,
          m.phone,
          m.email || '',
          Members.statusText(m.status),
          Members.typeText(m.type),
          m.joinDate,
          m.membershipFee || 0,
          m.lastPaymentDate || ''
        ]);
        
        return [headers, ...rows].map(row => 
          row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
        ).join('\n');
      },

      async generateActivityReport() {
        try {
          const activities = await API.call('getActivities');
          const csvContent = this.activitiesToCsv(activities);
          Util.downloadBlob('活動報表.csv', csvContent, 'text/csv;charset=utf-8;');
          Util.showToast('success', '活動報表已產生');
        } catch (error) {
          console.error('Generate activity report failed:', error);
        }
      },

      activitiesToCsv(activities) {
        const headers = ['活動名稱', '類型', '日期', '狀態', '參與人數', '人數上限', '費用'];
        const rows = activities.map(a => [
          a.name,
          a.type,
          a.date,
          Activities.statusText(a.status),
          a.currentParticipants || 0,
          a.maxParticipants || '',
          a.fee || 0
        ]);
        
        return [headers, ...rows].map(row => 
          row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
        ).join('\n');
      }
    };

    // ================== 帳戶管理 ==================
    const AccountUI = {
      data: [],

      async open() {
        const modal = new bootstrap.Modal(document.getElementById('accountManagerModal'));
        await this.loadAccounts();
        modal.show();
      },

      async loadAccounts() {
        try {
          this.data = await API.call('getAccounts');
          this.renderTable();
        } catch (error) {
          console.error('Load accounts failed:', error);
        }
      },

      renderTable() {
        const tbody = document.getElementById('accountsTableBody');
        if (!tbody) return;

        if (!this.data.length) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">尚無帳戶</td></tr>';
          return;
        }

        tbody.innerHTML = this.data.map(a => `
          <tr>
            <td>${a.name}</td>
            <td>${a.description || '-'}</td>
            <td class="text-end">$${Util.fmtNum(a.initialBalance)}</td>
            <td class="text-end ${a.currentBalance >= 0 ? 'text-success' : 'text-danger'}">$${Util.fmtNum(a.currentBalance)}</td>
            <td><span class="badge ${a.active ? 'bg-success' : 'bg-secondary'}">${a.active ? '啟用' : '停用'}</span></td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="AccountUI.openEditor('${a.id}')">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="AccountUI.deleteAccount('${a.id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>`).join('');
      },

      async openEditor(id = null) {
        const modal = new bootstrap.Modal(document.getElementById('accountModal'));
        
        if (id) {
          document.getElementById('accountModalTitle').textContent = '編輯帳戶';
          const account = this.data.find(a => a.id === id);
          if (account) this.populateAccountForm(account);
        } else {
          document.getElementById('accountModalTitle').textContent = '新增帳戶';
          this.resetAccountForm();
        }

        modal.show();
      },

      populateAccountForm(data) {
        document.getElementById('accountId').value = data.id || '';
        document.getElementById('accountName').value = data.name || '';
        document.getElementById('accountDescription').value = data.description || '';
        document.getElementById('accountInitialBalance').value = data.initialBalance || 0;
        document.getElementById('accountNotes').value = data.notes || '';
        document.getElementById('accountActive').checked = data.active !== false;
      },

      resetAccountForm() {
        document.getElementById('accountForm').reset();
        document.getElementById('accountId').value = '';
        document.getElementById('accountInitialBalance').value = '0';
        document.getElementById('accountActive').checked = true;
      },

      async saveAccount() {
        const form = document.getElementById('accountForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const data = {
          id: document.getElementById('accountId').value || null,
          name: document.getElementById('accountName').value,
          description: document.getElementById('accountDescription').value,
          initialBalance: parseFloat(document.getElementById('accountInitialBalance').value) || 0,
          notes: document.getElementById('accountNotes').value,
          active: document.getElementById('accountActive').checked
        };

        try {
          if (data.id) {
            await API.call('updateAccount', data);
            Util.showToast('success', '帳戶已更新');
          } else {
            await API.call('addAccount', data);
            Util.showToast('success', '帳戶已新增');
          }

          bootstrap.Modal.getInstance(document.getElementById('accountModal')).hide();
          this.loadAccounts();
          Dashboard.refresh();
        } catch (error) {
          console.error('Save account failed:', error);
        }
      },

      async deleteAccount(id) {
        const result = await Util.confirm({
          title: '確定刪除？',
          text: '刪除帳戶將影響相關交易記錄',
          confirmText: '刪除',
          confirmColor: '#dc3545'
        });

        if (result.isConfirmed) {
          try {
            await API.call('deleteAccount', { id });
            Util.showToast('success', '帳戶已刪除');
            this.loadAccounts();
            Dashboard.refresh();
          } catch (error) {
            console.error('Delete account failed:', error);
          }
        }
      }
    };

    // ================== 系統設定 ==================
    const SettingsUI = {
      async open() {
        const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
        await this.loadSettings();
        modal.show();
      },

      async loadSettings() {
        try {
          const settings = await API.call('getSettings');
          this.populateForm(settings);
        } catch (error) {
          console.error('Load settings failed:', error);
        }
      },

      populateForm(data) {
        document.getElementById('settingsOrganizationName').value = data.organizationName || '';
        document.getElementById('settingsOrganizationPhone').value = data.organizationPhone || '';
        document.getElementById('settingsOrganizationAddress').value = data.organizationAddress || '';
        document.getElementById('settingsOrganizationEmail').value = data.organizationEmail || '';
        document.getElementById('settingsDefaultMembershipFee').value = data.defaultMembershipFee || '';
        document.getElementById('settingsReceiptPrefix').value = data.receiptPrefix || '';
        document.getElementById('settingsVoucherPrefix').value = data.voucherPrefix || '';
        
        const incomeCategories = data.categories?.收入 || [];
        const expenseCategories = data.categories?.支出 || [];
        document.getElementById('settingsIncomeCategories').value = incomeCategories.join('\n');
        document.getElementById('settingsExpenseCategories').value = expenseCategories.join('\n');
      },

      async save() {
        const data = {
          organizationName: document.getElementById('settingsOrganizationName').value,
          organizationPhone: document.getElementById('settingsOrganizationPhone').value,
          organizationAddress: document.getElementById('settingsOrganizationAddress').value,
          organizationEmail: document.getElementById('settingsOrganizationEmail').value,
          defaultMembershipFee: parseFloat(document.getElementById('settingsDefaultMembershipFee').value) || 0,
          receiptPrefix: document.getElementById('settingsReceiptPrefix').value,
          voucherPrefix: document.getElementById('settingsVoucherPrefix').value,
          categories: {
            收入: document.getElementById('settingsIncomeCategories').value.split('\n').filter(c => c.trim()),
            支出: document.getElementById('settingsExpenseCategories').value.split('\n').filter(c => c.trim())
          }
        };

        try {
          await API.call('updateSettings', data);
          Util.showToast('success', '設定已儲存');
          bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
        } catch (error) {
          console.error('Save settings failed:', error);
        }
      }
    };

    // ================== 事件監聽器 ==================
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化應用
      AppLayout.showSection('dashboard');

      // 搜尋和篩選事件
      document.getElementById('txSearchInput')?.addEventListener('input', () => Transactions.applyFilters());
      document.getElementById('txFilterType')?.addEventListener('change', () => Transactions.applyFilters());
      document.getElementById('txFilterYear')?.addEventListener('change', () => Transactions.applyFilters());
      document.getElementById('txFilterAccount')?.addEventListener('change', () => Transactions.applyFilters());

      document.getElementById('memberSearchInput')?.addEventListener('input', () => Members.applyFilters());
      document.getElementById('memberFilterStatus')?.addEventListener('change', () => Members.applyFilters());
      document.getElementById('memberFilterType')?.addEventListener('change', () => Members.applyFilters());

      // 響應式側邊欄
      window.addEventListener('resize', function() {
        if (window.innerWidth >= 992) {
          document.getElementById('sidebar').classList.remove('show');
        }
      });

      // 點擊外部關閉側邊欄
      document.addEventListener('click', function(e) {
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.querySelector('[onclick*="toggleSidebar"]');
        
        if (window.innerWidth < 992 && 
            sidebar.classList.contains('show') && 
            !sidebar.contains(e.target) && 
            !toggleBtn.contains(e.target)) {
          AppLayout.toggleSidebar(false);
        }
      });

      // 載入初始資料
      setTimeout(() => {
        Dashboard.refresh();
      }, 100);
    });

    // ================== 全域函數 ==================
    window.AppLayout = AppLayout;
    window.TransactionUI = TransactionUI;
    window.MemberUI = MemberUI;
    window.ActivityUI = ActivityUI;
    window.AnnouncementUI = AnnouncementUI;
    window.FormUI = FormUI;
    window.AccountUI = AccountUI;
    window.SettingsUI = SettingsUI;
    window.Transactions = Transactions;
    window.Members = Members;
    window.Activities = Activities;
    window.Announcements = Announcements;
    window.Forms = Forms;
    window.Reports = Reports;
    </script>
  </body>
</html>
