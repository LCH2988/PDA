<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>台灣帕金森病友權益促進會 - 會計暨營運整合管理系統</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="description" content="非營利組織整合：財務 / 會員 / 活動 / 公告 / 表單 / 雲端備份管理系統">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
<style>
  :root {
    --primary:#2c5aa0;
    --primary-dark:#1e3d6f;
    --gradient-primary:linear-gradient(135deg,#2c5aa0,#4a90e2);
    --gradient-green:linear-gradient(135deg,#28a745,#20c997);
    --gradient-orange:linear-gradient(135deg,#ff9f40,#ffb347);
    --secondary-bg:#f8f9fa;
    --radius-lg:15px;
    --radius-md:10px;
    --radius-sm:6px;
  }
  body {
    background:var(--secondary-bg);
    font-family:"Microsoft JhengHei","Noto Sans TC",system-ui,sans-serif;
    font-size:14.5px;
  }
  .navbar-brand { font-weight:600; color:var(--primary)!important; }
  .sidebar {
    min-height:100vh;
    background:linear-gradient(180deg,#2c5aa0,#1e3d6f);
    color:#fff;
  }
  .sidebar .nav-link {
    color:rgba(255,255,255,.82);
    border-radius:8px;
    margin:3px 0;
    font-weight:500;
    transition:.25s;
  }
  .sidebar .nav-link:hover,
  .sidebar .nav-link.active {
    background:rgba(255,255,255,0.12);
    color:#fff;
    transform:translateX(4px);
  }
  .content-section { animation:fadeIn .35s ease; }
  @keyframes fadeIn {
    from { opacity:0; transform:translateY(12px); }
    to { opacity:1; transform:translateY(0); }
  }
  .stat-card {
    background:var(--gradient-primary);
    color:#fff;
    border:none;
    border-radius:var(--radius-lg);
    box-shadow:0 4px 14px -4px rgba(0,0,0,.18);
    position:relative;
    overflow:hidden;
  }
  .stat-card.alt-green { background:var(--gradient-green); }
  .stat-card.alt-orange{ background:var(--gradient-orange); }
  .stat-card .icon-bg {
    position:absolute;
    right:-10px; top:-10px;
    font-size:72px;
    opacity:.16;
  }
  .card-hoverable { transition:.25s; border:none; border-radius:var(--radius-lg); }
  .card-hoverable:hover { transform:translateY(-4px); box-shadow:0 8px 24px -6px rgba(0,0,0,.15); }
  .table thead th { background:#f1f4f8; border-top:none; font-weight:600; }
  .badge-rounded { border-radius:20px; font-weight:500; letter-spacing:.5px; }
  .member-avatar, .participant-avatar {
    width:40px;height:40px;border-radius:50%;background:#fff;
    display:flex;align-items:center;justify-content:center;
    color:#666;font-weight:600;
    box-shadow:0 0 0 1px rgba(0,0,0,.05);
  }
  .small-avatar { width:32px;height:32px;font-size:12px; }
  .action-buttons .btn { padding:.25rem .5rem; }
  .voucher-preview img {
    max-width:100px;max-height:100px;object-fit:cover;border-radius:6px;margin:4px;cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,.15);
  }
  .loading-overlay {
    position:fixed; inset:0; z-index:2000;
    background:rgba(0,0,0,.45); display:flex;align-items:center;justify-content:center;
  }
  .pagination .page-link { border:none; border-radius:8px; color:var(--primary); }
  .pagination .page-item.active .page-link { background:var(--primary); }
  .chart-container { position:relative; height:380px; }
  .separator-title {
    font-size:15px;font-weight:600;margin:16px 0 10px;display:flex;align-items:center;gap:.5rem;
  }
  .separator-title:before, .separator-title:after {
    content:""; flex:1; height:1px; background:linear-gradient(90deg,#d0d3d9,#ffffff);
  }
  .form-download-item {
    border:1px solid #e2e6eb; padding:14px 16px; border-radius:var(--radius-md);
    background:#fff; position:relative; transition:.25s;
  }
  .form-download-item:hover { box-shadow:0 6px 18px -6px rgba(0,0,0,.15); transform:translateY(-3px); }
  .activity-card { border:none;border-radius:var(--radius-lg);overflow:hidden;box-shadow:0 3px 10px -2px rgba(0,0,0,.12);position:relative; }
  .activity-card .progress { height:6px; border-radius:3px; background:#e9ecef; overflow:hidden; }
  .activity-card .progress-bar { background:var(--gradient-green); }
  .announcement-card { border-left:5px solid #ffc107; border-radius:var(--radius-md); }
  .announcement-card.urgent { border-left-color:#dc3545; background:linear-gradient(135deg,#fff5f5,#ffffff); }
  .dual-col { columns:2 320px; column-gap:14px; }
  .row-invalid { background:#fff5f5!important; }
  .row-duplicate { background:#fff9e6!important; }
  .preview-status-badge { font-size:10px; }
  .mapping-select { width:100%; margin-bottom:6px; }
  @media print {
    .no-print, .sidebar, .navbar, .modal-backdrop { display:none!important; }
    body { background:#fff; }
    .main-content { margin:0!important; padding:0!important; }
    .card { box-shadow:none!important; }
  }
  @media (max-width: 992px){
    .sidebar { position:fixed; left:0; top:0; transform:translateX(-100%); transition:.35s; z-index:1100; width:250px; }
    .sidebar.show { transform:translateX(0); }
  }
  .spin { animation:spin 1s linear infinite; }
  @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
  .receipt-seal-placeholder { width:60px; height:60px; border:2px solid #c00; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:#c00; }
</style>
</head>
<body>
<!-- 全螢幕載入遮罩 -->
<div id="loadingOverlay" class="loading-overlay" style="display:none;">
  <div class="text-center text-white">
    <div class="mb-3">
      <i class="bi bi-arrow-clockwise spin" style="font-size:48px;"></i>
    </div>
    <div>系統載入中，請稍候…</div>
  </div>
</div>

<!-- 同步指示 -->
<div class="position-fixed top-0 end-0 p-2 d-flex flex-column gap-1 no-print" style="z-index:1200;">
  <span id="syncIndicator" class="badge bg-success"><i class="bi bi-cloud-check"></i> 已同步</span>
  <span id="cloudIndicator" class="badge bg-info"><i class="bi bi-cloud"></i> 雲端連線</span>
  <span id="offlineIndicator" class="badge bg-danger d-none"><i class="bi bi-wifi-off"></i> 離線</span>
</div>

<!-- 導覽列 -->
<nav class="navbar navbar-expand-lg bg-white shadow-sm no-print">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <i class="bi bi-heart-pulse me-2"></i> 台灣帕金森病友權益促進會
    </a>
    <button class="navbar-toggler" type="button" onclick="AppLayout.toggleSidebar()">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto align-items-lg-center">
        <li class="nav-item me-2">
          <div class="input-group input-group-sm">
            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
            <input id="globalSearchInput" type="text" class="form-control" placeholder="全域搜尋 (交易 / 會員 / 活動 / 公告)" onkeydown="if(event.key==='Enter') GlobalSearch.exec()">
          </div>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle fw-semibold" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-gear"></i> 系統
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" onclick="SettingsUI.open()"><i class="bi bi-sliders"></i> 系統設定</a></li>
            <li><a class="dropdown-item" href="#" onclick="AccountUI.openManager()"><i class="bi bi-bank"></i> 帳戶管理</a></li>
            <li><a class="dropdown-item" href="#" onclick="GoogleSync.open()"><i class="bi bi-cloud-arrow-up"></i> 雲端同步</a></li>
            <li><a class="dropdown-item" href="#" onclick="BatchImport.open('transactions')"><i class="bi bi-cloud-upload"></i> 批次匯入</a></li>
            <li><a class="dropdown-item" href="#" onclick="DataPort.exportAll()"><i class="bi bi-download"></i> 匯出資料</a></li>
            <li><a class="dropdown-item" href="#" onclick="DataPort.importAll()"><i class="bi bi-upload"></i> 匯入資料</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="Shortcuts.show()"><i class="bi bi-keyboard"></i> 快捷鍵</a></li>
            <li><a class="dropdown-item" href="#" onclick="About.show()"><i class="bi bi-info-circle"></i> 關於</a></li>
            <li><a class="dropdown-item" href="#" onclick="ConfirmReset.show()"><i class="bi bi-exclamation-triangle"></i> 系統重置</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <!-- 側邊欄 -->
    <aside id="sidebar" class="sidebar col-lg-2 col-md-3 p-3">
      <h6 class="text-center mt-2 mb-4 fw-semibold">管理選單</h6>
      <nav class="nav flex-column">
        <a class="nav-link active" href="#" data-section="dashboard" onclick="AppLayout.showSection('dashboard',this)"><i class="bi bi-speedometer2 me-2"></i>儀表板</a>
        <a class="nav-link" href="#" data-section="transactions" onclick="AppLayout.showSection('transactions',this)"><i class="bi bi-receipt me-2"></i>交易記錄</a>
        <a class="nav-link" href="#" data-section="members" onclick="AppLayout.showSection('members',this)"><i class="bi bi-people me-2"></i>會員管理</a>
        <a class="nav-link" href="#" data-section="activities" onclick="AppLayout.showSection('activities',this)"><i class="bi bi-calendar-event me-2"></i>活動管理</a>
        <a class="nav-link" href="#" data-section="announcements" onclick="AppLayout.showSection('announcements',this)"><i class="bi bi-megaphone me-2"></i>公告管理</a>
        <a class="nav-link" href="#" data-section="forms" onclick="AppLayout.showSection('forms',this)"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單</a>
        <a class="nav-link" href="#" data-section="analytics" onclick="AppLayout.showSection('analytics',this)"><i class="bi bi-graph-up me-2"></i>統計分析</a>
        <a class="nav-link" href="#" data-section="reports" onclick="AppLayout.showSection('reports',this)"><i class="bi bi-file-earmark-text me-2"></i>報表中心</a>
      </nav>
    </aside>

    <!-- 主要內容 -->
    <main id="mainContent" class="col-lg-10 col-md-9 p-4">
      <!-- 儀表板 -->
      <section id="dashboardSection" class="content-section">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>儀表板</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
            <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
            <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
          </div>
        </div>

        <!-- 統計卡片列 -->
        <div class="row g-3 mb-3">
          <div class="col-6 col-md-3">
            <div class="stat-card p-3 h-100">
              <div class="icon-bg"><i class="bi bi-cash-coin"></i></div>
              <small>總收入</small>
              <h3 id="dashTotalIncome" class="mb-1">$0</h3>
              <div class="d-flex justify-content-between">
                <span class="small opacity-75">本月</span>
                <span id="dashMonthIncome" class="small fw-semibold">$0</span>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stat-card p-3 h-100 alt-orange">
              <div class="icon-bg"><i class="bi bi-credit-card-2-front"></i></div>
              <small>總支出</small>
              <h3 id="dashTotalExpense" class="mb-1">$0</h3>
              <div class="d-flex justify-content-between">
                <span class="small opacity-75">本月</span>
                <span id="dashMonthExpense" class="small fw-semibold">$0</span>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stat-card p-3 h-100 alt-green">
              <div class="icon-bg"><i class="bi bi-bank"></i></div>
              <small>帳戶總餘額</small>
              <h3 id="dashTotalBalance" class="mb-1">$0</h3>
              <div class="d-flex justify-content-between">
                <span class="small opacity-75">帳戶數</span>
                <span id="dashAccountCount" class="small fw-semibold">0</span>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stat-card p-3 h-100">
              <div class="icon-bg"><i class="bi bi-people"></i></div>
              <small>會員總數</small>
              <h3 id="dashMemberTotal" class="mb-1">0</h3>
              <div class="d-flex justify-content-between">
                <span class="small opacity-75">逾期會費</span>
                <span id="dashMemberOverdue" class="badge bg-danger rounded-pill">0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 最新交易 / 最新會員 -->
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="card card-hoverable h-100">
              <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-arrows-expand me-1"></i>最近交易</h6>
              </div>
              <div class="card-body p-2" id="dashboardRecentTx">
                <div class="text-center text-muted py-4">
                  <i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card card-hoverable h-100">
              <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-person-plus me-1"></i>新加入會員</h6>
              </div>
              <div class="card-body p-2" id="dashboardRecentMembers">
                <div class="text-center text-muted py-4">
                  <i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 交易記錄 -->
      <section id="transactionsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-receipt me-2"></i>交易記錄</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="AdvancedSearch.open()"><i class="bi bi-search"></i> 進階搜尋</button>
            <button class="btn btn-outline-success btn-sm" onclick="BatchImport.open('transactions')"><i class="bi bi-cloud-upload"></i> 批次匯入</button>
            <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
          </div>
        </div>

        <div class="card card-hoverable mb-3">
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-md-2">
                <label class="form-label mb-1">類型</label>
                <select id="txFilterType" class="form-select form-select-sm" onchange="Transactions.renderTable()">
                  <option value="">全部</option>
                  <option value="收入">收入</option>
                  <option value="支出">支出</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label mb-1">類別</label>
                <select id="txFilterCategory" class="form-select form-select-sm" onchange="Transactions.renderTable()">
                  <option value="">全部</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label mb-1">帳戶</label>
                <select id="txFilterAccount" class="form-select form-select-sm" onchange="Transactions.renderTable()">
                  <option value="">全部</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label mb-1">關鍵字</label>
                <input id="txFilterKeyword" type="text" class="form-control form-control-sm" placeholder="對象 / 說明 / 編號" oninput="Transactions.renderTable()">
              </div>
              <div class="col-md-2 d-grid">
                <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportTransactions()"><i class="bi bi-download"></i> 匯出</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-hoverable">
          <div class="card-body">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
              <div><span id="txRecordCount" class="fw-semibold">0 筆</span></div>
              <div class="d-flex gap-2">
                <select id="txBatchAction" class="form-select form-select-sm">
                  <option value="">批次操作</option>
                  <option value="delete">刪除</option>
                  <option value="export">匯出</option>
                  <option value="print">列印收據</option>
                  <option value="voucher">列印憑證</option>
                </select>
                <button class="btn btn-outline-primary btn-sm" onclick="Transactions.batchAction()">
                  <i class="bi bi-check2-square"></i> 執行
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-2">
                <thead>
                  <tr>
                    <th style="width:30px;"><input type="checkbox" id="txSelectAll" onclick="Transactions.toggleSelectAll(this)"></th>
                    <th>日期</th><th>類型</th><th>類別</th><th class="text-end">金額</th><th>對象</th><th>帳戶</th><th>說明</th><th>編號/附件</th><th>操作</th>
                  </tr>
                </thead>
                <tbody id="txTableBody">
                  <tr><td colspan="10" class="text-center py-5 text-muted">
                    <i class="bi bi-inbox display-6 d-block mb-2"></i> 尚無資料
                  </td></tr>
                </tbody>
              </table>
            </div>
            <nav class="d-flex justify-content-center">
              <ul id="txPagination" class="pagination pagination-sm mb-0"></ul>
            </nav>
          </div>
        </div>
      </section>

      <!-- 會員管理 -->
      <section id="membersSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-people me-2"></i>會員管理</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-success btn-sm" onclick="BatchImport.open('members')"><i class="bi bi-cloud-upload"></i> 批次匯入</button>
            <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-6 col-md-3">
            <div class="card text-center card-hoverable p-2">
              <small class="text-muted">總會員</small>
              <h4 id="mStatTotal" class="mb-0">0</h4>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card text-center card-hoverable p-2">
              <small class="text-muted">正常</small>
              <h4 id="mStatActive" class="text-success mb-0">0</h4>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card text-center card-hoverable p-2">
              <small class="text-muted">逾期會費</small>
              <h4 id="mStatOverdue" class="text-danger mb-0">0</h4>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card text-center card-hoverable p-2">
              <small class="text-muted">本月新增</small>
              <h4 id="mStatNew" class="mb-0">0</h4>
            </div>
          </div>
        </div>

        <div class="card card-hoverable mb-3">
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-md-3">
                <label class="form-label mb-1">狀態</label>
                <select id="memberFilterStatus" class="form-select form-select-sm" onchange="Members.renderTable()">
                  <option value="">全部</option>
                  <option value="啟用">正常</option>
                  <option value="停用">停權</option>
                  <option value="待審核">待審核</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label mb-1">會員類型</label>
                <select id="memberFilterType" class="form-select form-select-sm" onchange="Members.renderTable()">
                  <option value="">全部</option>
                  <option value="一般會員">一般會員</option>
                  <option value="榮譽會員">榮譽會員</option>
                  <option value="終身會員">終身會員</option>
                  <option value="家屬會員">家屬會員</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label mb-1">關鍵字</label>
                <input id="memberFilterKeyword" type="text" class="form-control form-control-sm" placeholder="姓名 / 電話 / Email / 標籤" oninput="Members.renderTable()">
              </div>
              <div class="col-md-2 d-grid">
                <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportMembers()"><i class="bi bi-download"></i> 匯出</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-hoverable">
          <div class="card-body">
            <div class="d-flex flex-wrap justify-content-between mb-2 gap-2">
              <span id="memberRecordCount" class="fw-semibold">0 筆記錄</span>
              <div class="d-flex gap-2">
                <select id="memberBatchAction" class="form-select form-select-sm">
                  <option value="">批次操作</option>
                  <option value="delete">刪除</option>
                  <option value="export">匯出</option>
                  <option value="status-啟用">設為正常</option>
                  <option value="status-停用">設為停權</option>
                </select>
                <button class="btn btn-outline-primary btn-sm" onclick="Members.batchAction()"><i class="bi bi-check2-square"></i> 執行</button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th style="width:30px;">
<input type="checkbox" id="memberSelectAll" onclick="Members.toggleSelectAll(this)"></th>
                    <th>基本資料</th><th>聯絡</th><th>年齡/性別</th><th>加入</th><th>狀態</th><th>會費</th><th>標籤</th><th>操作</th>
                  </tr>
                </thead>
                <tbody id="memberTableBody">
                  <tr><td colspan="9" class="text-center text-muted py-5">
                    <i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員資料
                  </td></tr>
                </tbody>
              </table>
            </div>
            <nav class="d-flex justify-content-center">
              <ul id="memberPagination" class="pagination pagination-sm mb-0"></ul>
            </nav>
          </div>
        </div>
      </section>

      <!-- 活動管理 -->
      <section id="activitiesSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-calendar-event me-2"></i>活動管理</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportActivities()"><i class="bi bi-download"></i> 匯出</button>
            <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-6 col-md-3">
            <div class="card p-2 text-center card-hoverable">
              <small class="text-muted">總活動數</small>
              <h5 id="actStatTotal" class="mb-0">0</h5>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card p-2 text-center card-hoverable">
              <small class="text-muted">報名中</small>
              <h5 id="actStatOpen" class="mb-0 text-success">0</h5>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card p-2 text-center card-hoverable">
              <small class="text-muted">即將開始(7日)</small>
              <h5 id="actStatUpcoming" class="mb-0">0</h5>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card p-2 text-center card-hoverable">
              <small class="text-muted">總報名</small>
              <h5 id="actStatRegistrations" class="mb-0">0</h5>
            </div>
          </div>
        </div>

        <div class="card card-hoverable mb-3">
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-md-2">
                <label class="form-label mb-1">狀態</label>
                <select id="actFilterStatus" class="form-select form-select-sm" onchange="Activities.renderGrid()">
                  <option value="">全部</option>
                  <option value="籌備中">籌備中</option>
                  <option value="已發布">已發布</option>
                  <option value="報名中">報名中</option>
                  <option value="已額滿">已額滿</option>
                  <option value="已結束">已結束</option>
                  <option value="已取消">已取消</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label mb-1">類型</label>
                <select id="actFilterType" class="form-select form-select-sm" onchange="Activities.renderGrid()">
                  <option value="">全部</option>
                  <option value="講座">講座</option>
                  <option value="聚會">聚會</option>
                  <option value="旅遊">旅遊</option>
                  <option value="運動">運動</option>
                  <option value="志工服務">志工服務</option>
                  <option value="其他">其他</option>
                </select>
              </div>
              <div class="col-md-5">
                <label class="form-label mb-1">關鍵字</label>
                <input id="actFilterKeyword" type="text" class="form-control form-control-sm" placeholder="名稱 / 地點 / 描述" oninput="Activities.renderGrid()">
              </div>
              <div class="col-md-3">
                <label class="form-label mb-1">排序</label>
                <select id="actFilterSort" class="form-select form-select-sm" onchange="Activities.renderGrid()">
                  <option value="date_desc">日期(新→舊)</option>
                  <option value="date_asc">日期(舊→新)</option>
                  <option value="name_asc">名稱</option>
                  <option value="regs_desc">報名多→少</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div id="activitiesGrid" class="row g-4">
          <div class="col-12 text-center py-5 text-muted">
            <i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動
          </div>
        </div>
        <nav class="d-flex justify-content-center mt-3">
          <ul id="actPagination" class="pagination pagination-sm mb-0"></ul>
        </nav>
      </section>

      <!-- 公告管理 -->
      <section id="announcementsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-megaphone me-2"></i>公告管理</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportAnnouncements()"><i class="bi bi-download"></i> 匯出</button>
            <button class="btn btn-warning btn-sm" onclick="AnnouncementUI.open()"><i class="bi bi-plus-circle"></i> 新增公告</button>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-6 col-md-4">
            <div class="card p-2 text-center card-hoverable">
              <small class="text-muted">公告總數</small>
              <h5 id="annStatTotal" class="mb-0">0</h5>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="card p-2 text-center card-hoverable">
              <small class="text-muted">有效公告</small>
              <h5 id="annStatActive" class="text-success mb-0">0</h5>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="card p-2 text-center card-hoverable">
              <small class="text-muted">緊急公告</small>
              <h5 id="annStatUrgent" class="text-danger mb-0">0</h5>
            </div>
          </div>
        </div>

        <div class="card card-hoverable mb-3">
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-md-3">
                <label class="form-label mb-1">狀態</label>
                <select id="annFilterStatus" class="form-select form-select-sm" onchange="Announcements.render()">
                  <option value="">全部</option>
                  <option value="草稿">草稿</option>
                  <option value="發布">已發布</option>
                  <option value="過期">已過期</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label mb-1">類型</label>
                <select id="annFilterType" class="form-select form-select-sm" onchange="Announcements.render()">
                  <option value="">全部</option>
                  <option value="一般">一般</option>
                  <option value="緊急">緊急</option>
                  <option value="活動相關">活動相關</option>
                  <option value="系統公告">系統公告</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label mb-1">關鍵字</label>
                <input id="annFilterKeyword" type="text" class="form-control form-control-sm" placeholder="標題 / 內容關鍵字" oninput="Announcements.render()">
              </div>
            </div>
          </div>
        </div>

        <div id="announcementsGrid" class="row g-4">
          <div class="col-12 text-center py-5 text-muted">
            <i class="bi bi-megaphone display-6 d-block mb-2"></i> 尚無公告
          </div>
        </div>
        <nav class="d-flex justify-content-center mt-3">
          <ul id="annPagination" class="pagination pagination-sm mb-0"></ul>
        </nav>
      </section>

      <!-- 行政表單 -->
      <section id="formsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單下載</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-primary btn-sm" onclick="FormUI.openManager()"><i class="bi bi-gear"></i> 管理表單</button>
          </div>
        </div>

        <div class="card card-hoverable mb-3">
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-md-8">
                <label class="form-label mb-1">關鍵字</label>
                <input id="formFilterKeyword" type="text" class="form-control form-control-sm" placeholder="搜尋表單名稱 / 關鍵字" oninput="Forms.render()">
              </div>
              <div class="col-md-4">
                <label class="form-label mb-1">分類</label>
                <select id="formFilterCategory" class="form-select form-select-sm" onchange="Forms.render()">
                  <option value="">全部</option>
                  <option value="會員">會員相關</option>
                  <option value="財務">財務相關</option>
                  <option value="活動">活動相關</option>
                  <option value="行政">行政相關</option>
                  <option value="其他">其他</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div id="formsList" class="row g-3">
          <div class="col-12 text-center py-5 text-muted">
            <i class="bi bi-file-earmark-arrow-down display-6 d-block mb-2"></i> 尚無表單
          </div>
        </div>
      </section>

      <!-- 統計分析 -->
      <section id="analyticsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-graph-up me-2"></i>統計分析</h4>
          <div>
            <select id="analyticsYear" class="form-select form-select-sm d-inline-block w-auto" onchange="Analytics.refresh()">
              <option value="">選擇年份</option>
            </select>
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-6 col-md-3">
            <div class="card text-center p-2 card-hoverable">
              <small>年度收入</small>
              <h5 id="anaTotalIncome" class="text-success mb-0">$0</h5>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card text-center p-2 card-hoverable">
              <small>年度支出</small>
              <h5 id="anaTotalExpense" class="text-danger mb-0">$0</h5>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card text-center p-2 card-hoverable">
              <small>年度結餘</small>
              <h5 id="anaBalance" class="mb-0">$0</h5>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card text-center p-2 card-hoverable">
              <small>平均月度</small>
              <h5 id="anaAvgMonthly" class="mb-0">$0</h5>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-lg-6">
            <div class="card card-hoverable">
              <div class="card-header bg-white"><h6 class="mb-0">收支趨勢</h6></div>
              <div class="card-body">
                <div class="chart-container"><canvas id="chartTrend"></canvas></div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card card-hoverable">
              <div class="card-header bg-white"><h6 class="mb-0">支出類別占比</h6></div>
              <div class="card-body">
                <div class="chart-container"><canvas id="chartExpenseCategory"></canvas></div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card card-hoverable">
              <div class="card-header bg-white"><h6 class="mb-0">月度收支對比</h6></div>
              <div class="card-body">
                <div class="chart-container"><canvas id="chartMonthlyCompare"></canvas></div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card card-hoverable">
              <div class="card-header bg-white"><h6 class="mb-0">會員成長趨勢</h6></div>
              <div class="card-body">
                <div class="chart-container"><canvas id="chartMemberGrowth"></canvas></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 報表中心 -->
      <section id="reportsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>報表中心</h4>
          <div class="d-flex gap-2">
            <input id="reportStart" type="date" class="form-control form-control-sm">
            <input id="reportEnd" type="date" class="form-control form-control-sm">
            <button class="btn btn-primary btn-sm" onclick="Reports.quickDate('thisMonth')">本月</button>
            <button class="btn btn-outline-primary btn-sm" onclick="Reports.quickDate('thisYear')">今年</button>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <div class="card card-hoverable h-100">
              <div class="card-body text-center">
                <i class="bi bi-cash-stack display-5 text-primary mb-2"></i>
                <h6 class="fw-semibold">交易記錄</h6>
                <p class="small text-muted">完整交易明細報表</p>
                <button class="btn btn-primary btn-sm" onclick="Reports.generate('transactions')"><i class="bi bi-download"></i> 生成</button>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card card-hoverable h-100">
              <div class="card-body text-center">
                <i class="bi bi-people-fill display-5 text-success mb-2"></i>
                <h6 class="fw-semibold">會員報表</h6>
                <p class="small text-muted">會員資料統計報表</p>
                <button class="btn btn-success btn-sm" onclick="Reports.generate('members')"><i class="bi bi-download"></i> 生成</button>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card card-hoverable h-100">
              <div class="card-body text-center">
                <i class="bi bi-calendar-event display-5 text-info mb-2"></i>
                <h6 class="fw-semibold">活動報表</h6>
                <p class="small text-muted">活動與報名統計</p>
                <button class="btn btn-info btn-sm text-white" onclick="Reports.generate('activities')"><i class="bi bi-download"></i> 生成</button>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card card-hoverable h-100">
              <div class="card-body text-center">
                <i class="bi bi-bar-chart-line display-5 text-warning mb-2"></i>
                <h6 class="fw-semibold">財務報表</h6>
                <p class="small text-muted">收支與帳戶餘額</p>
                <button class="btn btn-warning btn-sm" onclick="Reports.generate('financial')"><i class="bi bi-download"></i> 生成</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- 所有 Modal 對話框 -->
<!-- 交易 Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h6 class="modal-title"><i class="bi bi-receipt me-2"></i><span id="txModalTitle">新增交易</span></h6>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="txForm">
          <input type="hidden" id="txId">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">日期 *</label>
              <input id="txDate" type="date" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">類型 *</label>
              <select id="txType" class="form-select" required onchange="TransactionUI.onTypeChange()">
                <option value="">請選擇</option>
                <option value="收入">收入</option>
                <option value="支出">支出</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">帳戶 *</label>
              <select id="txAccount" class="form-select" required></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">類別 *</label>
              <select id="txCategory" class="form-select" required></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">金額 *</label>
              <input id="txAmount" type="number" min="0" step="1" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">對象</label>
              <input id="txCounterparty" type="text" class="form-control" list="counterpartyDatalist">
              <datalist id="counterpartyDatalist"></datalist>
            </div>
            <div class="col-12">
              <label class="form-label">說明</label>
              <textarea id="txDescription" rows="2" class="form-control" placeholder="可留空"></textarea>
            </div>
            <div class="col-md-6">
              <label id="txNumberLabel" for="txNumber" class="form-label">收據編號</label>
              <input id="txNumber" type="text" class="form-control" placeholder="自動帶入，可覆寫">
            </div>
            <div class="col-md-6">
              <label class="form-label">附件(憑證) 上傳</label>
              <input id="txVouchers" type="file" class="form-control" multiple accept="image/*,application/pdf" onchange="TransactionUI.handleVoucherUpload(event)">
              <div class="form-text">支援多檔：圖片 / PDF</div>
            </div>
            <div class="col-12">
              <div id="txVoucherPreview" class="voucher-preview"></div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
        <button class="btn btn-primary btn-sm" onclick="TransactionUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
      </div>
    </div>
  </div>
</div>

<!-- 會員 Modal -->
<div class="modal fade" id="memberModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h6 class="modal-title"><i class="bi bi-person me-2"></i><span id="memberModalTitle">新增會員</span></h6>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="memberForm">
          <input type="hidden" id="memberId">
          <div class="row g-3">
            <div class="col-md-4">
              <h6 class="fw-semibold">基本資料</h6>
              <label class="form-label mt-2">姓名 *</label>
              <input id="memberName" class="form-control" required>
              <label class="form-label mt-2">電話 *</label>
              <input id="memberPhone" class="form-control" required>
              <label class="form-label mt-2">電子郵件</label>
              <input id="memberEmail" type="email" class="form-control">
              <div class="row mt-2 g-2">
                <div class="col-6">
                  <label class="form-label">出生日期</label>
                  <input id="memberBirthDate" type="date" class="form-control">
                </div>
                <div class="col-6">
                  <label class="form-label">性別</label>
                  <select id="memberGender" class="form-select">
                    <option value="">未指定</option>
                    <option value="男">男</option>
                    <option value="女">女</option>
                    <option value="其他">其他</option>
                  </select>
                </div>
              </div>
              <label class="form-label mt-2">身分證字號</label>
              <input id="memberIdNumber" maxlength="10" class="form-control">
            </div>
            <div class="col-md-4">
              <h6 class="fw-semibold">聯絡資訊</h6>
              <label class="form-label mt-2">地址</label>
              <textarea id="memberAddress" rows="3" class="form-control"></textarea>
              <label class="form-label mt-2">緊急聯絡人</label>
              <input id="emergencyContact" class="form-control">
              <label class="form-label mt-2">緊急聯絡電話</label>
              <input id="emergencyPhone" class="form-control">
              <label class="form-label mt-2">備註</label>
              <textarea id="memberNotes" rows="3" class="form-control"></textarea>
            </div>
            <div class="col-md-4">
              <h6 class="fw-semibold">會員資訊</h6>
              <label class="form-label mt-2">加入日期 *</label>
              <input id="memberJoinDate" type="date" class="form-control" required>
              <label class="form-label mt-2">狀態</label>
              <select id="memberStatus" class="form-select">
                <option value="啟用">正常</option>
                <option value="停用">停權</option>
                <option value="待審核">待審核</option>
              </select>
              <label class="form-label mt-2">會員類型</label>
              <select id="memberType" class="form-select">
                <option value="一般會員">一般會員</option>
                <option value="榮譽會員">榮譽會員</option>
                <option value="終身會員">終身會員</option>
                <option value="家屬會員">家屬會員</option>
              </select>
              <label class="form-label mt-2">年費金額</label>
              <input id="membershipFee" type="number" class="form-control" value="1000" min="0">
              <label class="form-label mt-2">最後繳費日期</label>
              <input id="lastPaymentDate" type="date" class="form-control">
              <label class="form-label mt-2">標籤（逗號分隔）</label>
              <input id="memberTags" class="form-control" placeholder="例：病友,志工">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
        <button class="btn btn-success btn-sm" onclick="MemberUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
      </div>
    </div>
  </div>
</div>

<!-- 活動 Modal -->
<div class="modal fade" id="activityModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h6 class="modal-title"><i class="bi bi-calendar-event me-2"></i><span id="activityModalTitle">新增活動</span></h6>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="activityForm">
          <input type="hidden" id="activityId">
          <div class="row g-3">
            <div class="col-lg-8">
              <label class="form-label">活動名稱 *</label>
              <input id="activityName" class="form-control" required>
              <div class="row g-2 mt-2">
                <div class="col-md-6">
                  <label class="form-label">活動類型 *</label>
                  <select id="activityType" class="form-select" required>
                    <option value="">選擇</option>
                    <option value="講座">講座</option>
                    <option value="聚會">聚會</option>
<option value="旅遊">旅遊</option>
                    <option value="運動">運動</option>
                    <option value="志工服務">志工服務</option>
                    <option value="其他">其他</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">狀態</label>
                  <select id="activityStatus" class="form-select">
                    <option value="籌備中">籌備中</option>
                    <option value="已發布">已發布</option>
                    <option value="報名中">報名中</option>
                    <option value="已額滿">已額滿</option>
                    <option value="已結束">已結束</option>
                    <option value="已取消">已取消</option>
                  </select>
                </div>
              </div>
              <div class="row g-2 mt-2">
                <div class="col-md-6">
                  <label class="form-label">活動日期 *</label>
                  <input id="activityDate" type="date" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">活動時間</label>
                  <input id="activityTime" type="time" class="form-control">
                </div>
              </div>
              <label class="form-label mt-2">地點</label>
              <input id="activityLocation" class="form-control" placeholder="可留空">
              <label class="form-label mt-2">活動描述</label>
              <textarea id="activityDescription" rows="4" class="form-control"></textarea>
            </div>
            <div class="col-lg-4">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">人數上限</label>
                  <input id="activityMax" type="number" min="1" value="50" class="form-control">
                </div>
                <div class="col-6">
                  <label class="form-label">費用</label>
                  <input id="activityFee" type="number" min="0" value="0" class="form-control">
                </div>
              </div>
              <label class="form-label mt-2">聯絡人</label>
              <input id="activityContact" class="form-control">
              <label class="form-label mt-2">聯絡電話</label>
              <input id="activityContactPhone" class="form-control">
              <label class="form-label mt-2">備註</label>
              <textarea id="activityNotes" rows="3" class="form-control"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
        <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
      </div>
    </div>
  </div>
</div>

<!-- 公告 Modal -->
<div class="modal fade" id="announcementModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h6 class="modal-title"><i class="bi bi-megaphone me-2"></i><span id="announcementModalTitle">新增公告</span></h6>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="announcementForm">
          <input type="hidden" id="announcementId">
          <label class="form-label">標題 *</label>
          <input id="announcementTitle" class="form-control" required>
          <div class="row g-2 mt-2">
            <div class="col-md-4">
              <label class="form-label">類型</label>
              <select id="announcementType" class="form-select">
                <option value="一般">一般</option>
                <option value="緊急">緊急</option>
                <option value="活動相關">活動相關</option>
                <option value="系統公告">系統公告</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">狀態</label>
              <select id="announcementStatus" class="form-select">
                <option value="草稿">草稿</option>
                <option value="發布">已發布</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">置頂</label>
              <div class="form-check">
                <input id="announcementPinned" type="checkbox" class="form-check-input">
                <label class="form-check-label" for="announcementPinned">置頂公告</label>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label mt-2">發布日期</label>
              <input id="announcementPublishDate" type="date" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label mt-2">過期日期</label>
              <input id="announcementExpireDate" type="date" class="form-control">
            </div>
          </div>
          <label class="form-label mt-2">內容 *</label>
          <textarea id="announcementContent" rows="6" class="form-control" required></textarea>
          <label class="form-label mt-2">相關連結</label>
          <input id="announcementLink" type="url" class="form-control" placeholder="https://">
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
        <button class="btn btn-warning btn-sm" onclick="AnnouncementUI.save()"><i class="bi bi-save me-1"></i>儲存</button>
      </div>
    </div>
  </div>
</div>

<!-- 系統設定 Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h6 class="modal-title"><i class="bi bi-sliders me-2"></i>系統設定</h6>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="settingsForm" class="row gy-3">
          <div class="col-md-6">
            <h6 class="fw-semibold mb-2">組織資訊</h6>
            <label class="form-label">組織名稱</label>
            <input id="setOrgName" class="form-control">
            <label class="form-label mt-2">地址</label>
            <textarea id="setOrgAddress" rows="2" class="form-control"></textarea>
            <label class="form-label mt-2">電話</label>
            <input id="setOrgPhone" class="form-control">
            <label class="form-label mt-2">Email</label>
            <input id="setOrgEmail" type="email" class="form-control">
            <label class="form-label mt-2">預設年費</label>
            <input id="setDefaultFee" type="number" class="form-control" value="1000" min="0">
          </div>
          <div class="col-md-6">
            <h6 class="fw-semibold mb-2">系統 / 編號</h6>
            <label class="form-label">收據前綴</label>
            <input id="setReceiptPrefix" class="form-control" maxlength="5">
            <label class="form-label mt-2">憑證前綴</label>
            <input id="setVoucherPrefix" class="form-control" maxlength="5">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
        <button class="btn btn-primary btn-sm" onclick="SettingsUI.save()"><i class="bi bi-save me-1"></i>儲存設定</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast 容器 -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:2000;">
  <div id="toastSuccess" class="toast align-items-center border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body"><i class="bi bi-check-circle text-success me-2"></i><span id="toastSuccessMsg">成功</span></div>
      <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  <div id="toastError" class="toast align-items-center border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body"><i class="bi bi-exclamation-triangle text-danger me-2"></i><span id="toastErrorMsg">錯誤</span></div>
      <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- 依賴套件 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/* ================================================================
 核心 JavaScript - 配合 GAS 後端 API
 ================================================================ */

// GAS 後端 URL - 請替換為您的實際部署 URL
const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyGxusCLEt-RVo2kd1MYQBtomR_4JYoB6q1c1M6YoCLV8UVk-UtQdwEybwPrnOftGVQwQ/exec';

/* -------------------- API 通訊層 -------------------- */
const API = {
async call(action, params = {}) {
  try {
    const response = await fetch(GAS_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        action: action,
        params: params
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error || '未知錯誤');
    }
    
    return result.data;
  } catch (error) {
    console.error('API Error:', error);
    throw error;
  }
},

// 測試連線
async testConnection() {
  return await this.call('testConnection');
},

// 初始化資料庫
async initializeSheets() {
  return await this.call('initializeSheets');
},

// 儀表板統計
async getDashboardStats() {
  return await this.call('getDashboardStats');
},

// 交易相關
async getTransactions(params = {}) {
  return await this.call('getTransactions', params);
},

async saveTransaction(data) {
  return await this.call('saveTransaction', data);
},

async deleteTransaction(id) {
  return await this.call('deleteTransaction', { ID: id });
},

// 會員相關
async getMembers(params = {}) {
  return await this.call('getMembers', params);
},

async saveMember(data) {
  return await this.call('saveMember', data);
},

async deleteMember(id) {
  return await this.call('deleteMember', { ID: id });
},

// 帳戶相關
async getAccounts() {
  return await this.call('getAccounts');
},

async saveAccount(data) {
  return await this.call('saveAccount', data);
},

async deleteAccount(id) {
  return await this.call('deleteAccount', { ID: id });
},

// 活動相關
async getActivities(params = {}) {
  return await this.call('getActivities', params);
},

async saveActivity(data) {
  return await this.call('saveActivity', data);
},

async deleteActivity(id) {
  return await this.call('deleteActivity', { ID: id });
},

// 公告相關
async getAnnouncements(params = {}) {
  return await this.call('getAnnouncements', params);
},

async saveAnnouncement(data) {
  return await this.call('saveAnnouncement', data);
},

async deleteAnnouncement(id) {
  return await this.call('deleteAnnouncement', { ID: id });
},

// 表單相關
async getForms() {
  return await this.call('getForms');
},

async saveForm(data) {
  return await this.call('saveForm', data);
},

async deleteForm(id) {
  return await this.call('deleteForm', { ID: id });
},

// 設定相關
async getSettings() {
  return await this.call('getSettings');
},

async saveSettings(data) {
  return await this.call('saveSettings', data);
},

// 分析相關
async getAnalyticsData(params = {}) {
  return await this.call('getAnalyticsData', params);
},

// 報表相關
async generateReport(params = {}) {
  return await this.call('generateReport', params);
}
};

/* -------------------- 工具函數 -------------------- */
const Util = {
uuid: () => 'id_' + Math.random().toString(36).slice(2, 10),
today: () => new Date().toISOString().split('T')[0],
fmtNum: n => (Number(n) || 0).toLocaleString(),
toNumber: v => isNaN(parseFloat(v)) ? 0 : parseFloat(v),

showToast(type, msg) {
  const id = type === 'success' ? 'toastSuccess' : 'toastError';
  const el = document.getElementById(id);
  if (!el) { alert(msg); return; }
  (type === 'success' ? document.getElementById('toastSuccessMsg') : document.getElementById('toastErrorMsg')).textContent = msg;
  new bootstrap.Toast(el, { delay: 3000 }).show();
},

async confirm(opts) {
  return await Swal.fire({
    icon: opts.icon || 'warning',
    title: opts.title || '確定？',
    html: opts.html || opts.text || '',
    showCancelButton: true,
    confirmButtonText: opts.confirmText || '確定',
    cancelButtonText: opts.cancelText || '取消',
    confirmButtonColor: opts.confirmColor || '#0d6efd'
  });
},

showLoading(show = true) {
  document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}
};

/* -------------------- Layout 控制 -------------------- */
const AppLayout = {
async showSection(name, link) {
  document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
  document.getElementById(name + 'Section').style.display = 'block';
  document.querySelectorAll('.sidebar .nav-link').forEach(a => a.classList.remove('active'));
  if (link) link.classList.add('active');
  
  try {
    switch (name) {
      case 'dashboard': await Dashboard.refresh(); break;
      case 'transactions': await Transactions.renderTable(); break;
      case 'members': await Members.renderTable(); break;
      case 'activities': await Activities.renderGrid(); break;
      case 'announcements': await Announcements.render(); break;
      case 'forms': await Forms.render(); break;
      case 'analytics': await Analytics.refresh(); break;
      case 'reports': Reports.initDateOnce(); break;
    }
  } catch (error) {
    console.error('Section load error:', error);
    Util.showToast('error', '載入失敗：' + error.message);
  }
  
  if (window.innerWidth < 992) this.toggleSidebar(false);
},

toggleSidebar(force) {
  const sb = document.getElementById('sidebar');
  if (typeof force === 'boolean') {
    sb.classList.toggle('show', force);
  } else {
    sb.classList.toggle('show');
  }
}
};

/* -------------------- Dashboard -------------------- */
const Dashboard = {
async refresh() {
  try {
    Util.showLoading(true);
    const stats = await API.getDashboardStats();
    
    document.getElementById('dashTotalIncome').textContent = '$' + Util.fmtNum(stats.totalIncome);
    document.getElementById('dashTotalExpense').textContent = '$' + Util.fmtNum(stats.totalExpense);
    document.getElementById('dashMonthIncome').textContent = '$' + Util.fmtNum(stats.monthIncome);
    document.getElementById('dashMonthExpense').textContent = '$' + Util.fmtNum(stats.monthExpense);
    document.getElementById('dashTotalBalance').textContent = '$' + Util.fmtNum(stats.totalBalance);
    document.getElementById('dashAccountCount').textContent = stats.accountCount;
    document.getElementById('dashMemberTotal').textContent = stats.memberTotal;
    document.getElementById('dashMemberOverdue').textContent = stats.overdueMembers;

    this.renderRecentTransactions(stats.recentTransactions);
    this.renderRecentMembers(stats.recentMembers);
    
  } catch (error) {
    console.error('Dashboard refresh error:', error);
    Util.showToast('error', '儀表板載入失敗');
  } finally {
    Util.showLoading(false);
  }
},

renderRecentTransactions(transactions) {
  const box = document.getElementById('dashboardRecentTx');
  if (!transactions || !transactions.length) {
    box.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易</div>';
    return;
  }
  
  box.innerHTML = transactions.map(t => `
    <div class="d-flex justify-content-between align-items-center border-bottom py-2 small">
      <div>
        <div class="fw-semibold">${t['類別'] || ''}</div>
        <div class="text-muted">${t['日期'] || ''} ${t['對象'] || ''}</div>
      </div>
      <div class="text-end">
        <span class="badge ${t['類型'] === '收入' ? 'bg-success' : 'bg-danger'}">${t['類型'] === '收入' ? '+' : '-'}$${Util.fmtNum(t['金額'])}</span>
      </div>
    </div>
  `).join('');
},

renderRecentMembers(members) {
  const box = document.getElementById('dashboardRecentMembers');
  if (!members || !members.length) {
    box.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員</div>';
    return;
  }
  
  box.innerHTML = members.map(m => `
    <div class="d-flex align-items-center border-bottom py-2 small">
      <div class="member-avatar me-2"><i class="bi bi-person"></i></div>
      <div class="flex-grow-1">
        <div class="fw-semibold">${m['姓名'] || ''}</div>
        <div class="text-muted">${m['加入日期'] || ''}</div>
      </div>
      <span class="badge ${m['狀態'] === '啟用' ? 'bg-success' : 'bg-secondary'}">${m['狀態'] || ''}</span>
    </div>
  `).join('');
}
};

/* -------------------- 交易模組 -------------------- */
const Transactions = {
state: { page: 1, per: 10, data: [] },

async renderTable() {
  try {
    Util.showLoading(true);
    
    const filters = {
      type: document.getElementById('txFilterType').value,
      category: document.getElementById('txFilterCategory').value,
      account: document.getElementById('txFilterAccount').value,
      search: document.getElementById('txFilterKeyword').value,
      page: this.state.page,
      limit: this.state.per
    };
    
    const result = await API.getTransactions(filters);
    this.state.data = result.data || [];
    
    document.getElementById('txRecordCount').textContent = `${result.total || 0} 筆記錄`;
    this.renderTableBody(this.state.data);
    this.renderPagination(result.totalPages || 1);
    
  } catch (error) {
    console.error('Transactions render error:', error);
    Util.showToast('error', '交易載入失敗');
  } finally {
    Util.showLoading(false);
  }
},

renderTableBody(data) {
  const tb = document.getElementById('txTableBody');
  if (!data || !data.length) {
    tb.innerHTML = `<tr><td colspan="10" class="text-center py-5 text-muted">
      <i class="bi bi-inbox display-6 d-block mb-2"></i> 無符合資料
    </td></tr>`;
    return;
  }
  
  tb.innerHTML = data.map(t => {
    const num = t['類型'] === '收入' ? (t['收據編號'] || '-') : (t['憑證編號'] || '-');
    return `<tr>
      <td><input type="checkbox" data-id="${t.ID}" class="tx-check"></td>
      <td>${t['日期'] || ''}</td>
      <td><span class="badge ${t['類型'] === '收入' ? 'bg-success' : 'bg-danger'}">${t['類型'] || ''}</span></td>
      <td>${t['類別'] || ''}</td>
      <td class="text-end fw-semibold ${t['類型'] === '收入' ? 'text-success' : 'text-danger'}">${t['類型'] === '收入' ? '+' : '-'}$${Util.fmtNum(t['金額'])}</td>
      <td>${t['對象'] || '-'}</td>
      <td>${t['帳戶'] || '-'}</td>
      <td class="small">${t['說明'] || '-'}</td>
      <td class="small">${num}</td>
      <td>
        <div class="action-buttons">
          <button class="btn btn-sm btn-outline-primary" title="編輯" onclick="TransactionUI.open('${t.ID}')"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-outline-danger" title="刪除" onclick="Transactions.delete('${t.ID}')"><i class="bi bi-trash"></i></button>
        </div>
      </td>
    </tr>`;
  }).join('');
},

renderPagination(pages) {
  const ul = document.getElementById('txPagination');
  let html = '';
  const p = this.state.page;
  const add = (pg, txt, dis = false, act = false) => html += `<li class="page-item ${dis ? 'disabled' : ''} ${act ? 'active' : ''}">
    <a href="#" class="page-link" onclick="Transactions.goto(${pg});return false;">${txt}</a></li>`;
  add(p - 1, '«', p === 1);
  for (let i = Math.max(1, p - 2); i <= Math.min(pages, p + 2); i++) add(i, i, false, i === p);
  add(p + 1, '»', p === pages);
  ul.innerHTML = html;
},

goto(p) { 
  this.state.page = p; 
  this.renderTable(); 
},

toggleSelectAll(master) {
  document.querySelectorAll('.tx-check').forEach(cb => cb.checked = master.checked);
},

getSelectedIds() {
  return [...document.querySelectorAll('.tx-check:checked')].map(cb => cb.getAttribute('data-id'));
},

async batchAction() {
  const act = document.getElementById('txBatchAction').value;
  const ids = this.getSelectedIds();
  if (!act) return Util.showToast('error', '請選擇批次操作');
  if (!ids.length) return Util.showToast('error', '尚未勾選');
  
  if (act === 'delete') {
    const result = await Util.confirm({ title: '刪除確認', text: `確定刪除 ${ids.length} 筆交易?`, confirmColor: '#dc3545' });
    if (result.isConfirmed) {
      try {
        for (const id of ids) {
          await API.deleteTransaction(id);
        }
        await this.renderTable();
        await Dashboard.refresh();
        Util.showToast('success', '已刪除');
      } catch (error) {
        Util.showToast('error', '刪除失敗：' + error.message);
      }
    }
  } else {
    Util.showToast('error', '尚未實作');
  }
},

async delete(id) {
  const result = await Util.confirm({ title: '刪除交易', text: '是否刪除此筆交易？', confirmColor: '#dc3545' });
  if (!result.isConfirmed) return;
  
  try {
    await API.deleteTransaction(id);
    await this.renderTable();
    await Dashboard.refresh();
    Util.showToast('success', '已刪除交易');
  } catch (error) {
    Util.showToast('error', '刪除失敗：' + error.message);
  }
}
};

/* -------------------- 交易 UI 控制 -------------------- */
const TransactionUI = {
modal: null,
currentData: null,

async open(id = null) {
  if (!this.modal) this.modal = new bootstrap.Modal(document.getElementById('transactionModal'));
  
  document.getElementById('txForm').reset();
  document.getElementById('txId').value = '';
  document.getElementById('txVoucherPreview').innerHTML = '';
  
  await this.fillAccounts();
  await this.fillCategories('收入');
  document.getElementById('txDate').value = Util.today();
  document.getElementById('txType').value = '收入';
  document.getElementById('txNumberLabel').textContent = '收據編號';

  if (id) {
    try {
      const transactions = await API.getTransactions();
      const t = transactions.data.find(x => x.ID === id);
      if (t) {
        document.getElementById('txModalTitle').textContent = '編輯交易';
        document.getElementById('txId').value = t.ID;
        document.getElementById('txDate').value = t['日期'] || '';
        document.getElementById('txType').value = t['類型'] || '';
        await this.fillCategories(t['類型']);
        document.getElementById('txCategory').value = t['類別'] || '';
        document.getElementById('txAmount').value = t['金額'] || '';
        document.getElementById('txCounterparty').value = t['對象'] || '';
        document.getElementById('txAccount').value = t['帳戶'] || '';
        document.getElementById('txDescription').value = t['說明'] || '';
        
        if (t['類型'] === '收入') {
          document.getElementById('txNumberLabel').textContent = '收據編號';
          document.getElementById('txNumber').value = t['收據編號'] || '';
        } else {
          document.getElementById('txNumberLabel').textContent = '憑證編號';
          document.getElementById('txNumber').value = t['憑證編號'] || '';
        }
        this.currentData = t;
      }
    } catch (error) {
      Util.showToast('error', '載入交易失敗');
      return;
    }
  } else {
    document.getElementById('txModalTitle').textContent = '新增交易';
    this.currentData = null;
  }
  
  this.modal.show();
},

async onTypeChange() {
  const type = document.getElementById('txType').value;
  await this.fillCategories(type);
  document.getElementById('txNumberLabel').textContent = type === '收入' ? '收據編號' : '憑證編號';
},

async fillAccounts() {
  try {
    const accounts = await API.getAccounts();
    const sel = document.getElementById('txAccount');
    sel.innerHTML = '<option value="">請選擇帳戶</option>' + 
      accounts.map(a => `<option value="${a['帳戶名稱']}">${a['帳戶名稱']}</option>`).join('');
  } catch (error) {
    console.error('Fill accounts error:', error);
  }
},

async fillCategories(type) {
  const categories = type === '收入' 
    ? ['會費', '捐款', '活動費', '利息', '其他收入']
    : ['辦公費', '活動支出', '交通費', '餐費', '設備費', '其他支出'];
  
  const sel = document.getElementById('txCategory');
  sel.innerHTML = '<option value="">請選擇類別</option>' + 
    categories.map(c => `<option value="${c}">${c}</option>`).join('');
},

handleVoucherUpload(event) {
  const files = event.target.files;
  const preview = document.getElementById('txVoucherPreview');
  preview.innerHTML = '';
  
  for (let file of files) {
    if (file.type.startsWith('image/')) {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.onclick = () => window.open(img.src);
      preview.appendChild(img);
    } else if (file.type === 'application/pdf') {
      const div = document.createElement('div');
      div.innerHTML = `<i class="bi bi-file-pdf text-danger me-1"></i>${file.name}`;
      div.className = 'badge bg-light text-dark me-1';
      preview.appendChild(div);
    }
  }
},

async save() {
  const form = document.getElementById('txForm');
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }

  const data = {
    ID: document.getElementById('txId').value || Util.uuid(),
    日期: document.getElementById('txDate').value,
    類型: document.getElementById('txType').value,
    類別: document.getElementById('txCategory').value,
    金額: Util.toNumber(document.getElementById('txAmount').value),
    對象: document.getElementById('txCounterparty').value,
    帳戶: document.getElementById('txAccount').value,
    說明: document.getElementById('txDescription').value
  };

  const type = data['類型'];
  const numberField = type === '收入' ? '收據編號' : '憑證編號';
  data[numberField] = document.getElementById('txNumber').value || this.generateNumber(type);

  try {
    await API.saveTransaction(data);
    this.modal.hide();
    await Transactions.renderTable();
    await Dashboard.refresh();
    Util.showToast('success', '交易已儲存');
  } catch (error) {
    Util.showToast('error', '儲存失敗：' + error.message);
  }
},

generateNumber(type) {
  const prefix = type === '收入' ? 'R' : 'V';
  const date = new Date().toISOString().slice(2, 10).replace(/-/g, '');
  const rand = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
  return `${prefix}${date}${rand}`;
}
};

/* -------------------- 會員模組 -------------------- */
const Members = {
state: { page: 1, per: 10, data: [] },

async renderTable() {
  try {
    Util.showLoading(true);
    
    const filters = {
      status: document.getElementById('memberFilterStatus').value,
      type: document.getElementById('memberFilterType').value,
      search: document.getElementById('memberFilterKeyword').value,
      page: this.state.page,
      limit: this.state.per
    };
    
    const result = await API.getMembers(filters);
    this.state.data = result.data || [];
    
    document.getElementById('memberRecordCount').textContent = `${result.total || 0} 筆記錄`;
    this.renderTableBody(this.state.data);
    this.renderPagination(result.totalPages || 1);
    this.updateStats();
    
  } catch (error) {
    console.error('Members render error:', error);
    Util.showToast('error', '會員載入失敗');
  } finally {
    Util.showLoading(false);
  }
},

renderTableBody(data) {
  const tb = document.getElementById('memberTableBody');
  if (!data || !data.length) {
    tb.innerHTML = `<tr><td colspan="9" class="text-center py-5 text-muted">
      <i class="bi bi-people display-6 d-block mb-2"></i> 無符合資料
    </td></tr>`;
    return;
  }
  
  tb.innerHTML = data.map(m => {
    const age = this.calculateAge(m['出生日期']);
    const tags = (m['標籤'] || '').split(',').filter(t => t.trim()).map(t => 
      `<span class="badge bg-secondary badge-rounded me-1">${t.trim()}</span>`).join('');
    
    return `<tr>
      <td><input type="checkbox" data-id="${m.ID}" class="member-check"></td>
      <td>
        <div class="d-flex align-items-center">
          <div class="member-avatar me-2"><i class="bi bi-person"></i></div>
          <div>
            <div class="fw-semibold">${m['姓名'] || ''}</div>
            <small class="text-muted">${m['會員類型'] || ''}</small>
          </div>
        </div>
      </td>
      <td>
        <div class="small">
          <div><i class="bi bi-telephone me-1"></i>${m['電話'] || '-'}</div>
          <div><i class="bi bi-envelope me-1"></i>${m['電子郵件'] || '-'}</div>
        </div>
      </td>
      <td>${age ? age + '歲' : '-'} / ${m['性別'] || '-'}</td>
      <td>${m['加入日期'] || '-'}</td>
      <td><span class="badge ${m['狀態'] === '啟用' ? 'bg-success' : 'bg-secondary'}">${m['狀態'] || ''}</span></td>
      <td class="small">
        <div>年費: $${Util.fmtNum(m['年費'] || 0)}</div>
        <div class="text-muted">最後: ${m['最後繳費日期'] || '-'}</div>
      </td>
      <td class="small">${tags}</td>
      <td>
        <div class="action-buttons">
          <button class="btn btn-sm btn-outline-primary" title="編輯" onclick="MemberUI.open('${m.ID}')"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-outline-danger" title="刪除" onclick="Members.delete('${m.ID}')"><i class="bi bi-trash"></i></button>
        </div>
      </td>
    </tr>`;
  }).join('');
},

calculateAge(birthDate) {
  if (!birthDate) return null;
  const today = new Date();
  const birth = new Date(birthDate);
  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) age--;
  return age;
},

renderPagination(pages) {
  const ul = document.getElementById('memberPagination');
  let html = '';
  const p = this.state.page;
  const add = (pg, txt, dis = false, act = false) => html += `<li class="page-item ${dis ? 'disabled' : ''} ${act ? 'active' : ''}">
    <a href="#" class="page-link" onclick="Members.goto(${pg});return false;">${txt}</a></li>`;
  add(p - 1, '«', p === 1);
  for (let i = Math.max(1, p - 2); i <= Math.min(pages, p + 2); i++) add(i, i, false, i === p);
  add(p + 1, '»', p === pages);
  ul.innerHTML = html;
},

goto(p) { 
  this.state.page = p; 
  this.renderTable(); 
},

async updateStats() {
  try {
    const allMembers = await API.getMembers();
    const members = allMembers.data || [];
    
    const total = members.length;
    const active = members.filter(m => m['狀態'] === '啟用').length;
    const overdue = members.filter(m => this.isOverdue(m)).length;
    const thisMonth = members.filter(m => this.isThisMonth(m['加入日期'])).length;
    
    document.getElementById('mStatTotal').textContent = total;
    document.getElementById('mStatActive').textContent = active;
    document.getElementById('mStatOverdue').textContent = overdue;
    document.getElementById('mStatNew').textContent = thisMonth;
  } catch (error) {
    console.error('Member stats error:', error);
  }
},

isOverdue(member) {
  if (!member['最後繳費日期']) return true;
  const lastPay = new Date(member['最後繳費日期']);
  const oneYearAgo = new Date();
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
  return lastPay < oneYearAgo;
},

isThisMonth(dateStr) {
  if (!dateStr) return false;
  const date = new Date(dateStr);
  const now = new Date();
  return date.getFullYear() === now.getFullYear() && date.getMonth() === now.getMonth();
},

toggleSelectAll(master) {
  document.querySelectorAll('.member-check').forEach(cb => cb.checked = master.checked);
},

getSelectedIds() {
  return [...document.querySelectorAll('.member-check:checked')].map(cb => cb.getAttribute('data-id'));
},

async batchAction() {
  const act = document.getElementById('memberBatchAction').value;
  const ids = this.getSelectedIds();
  if (!act) return Util.showToast('error', '請選擇批次操作');
  if (!ids.length) return Util.showToast('error', '尚未勾選');
  
  if (act === 'delete') {
    const result = await Util.confirm({ title: '刪除確認', text: `確定刪除 ${ids.length} 位會員?`, confirmColor: '#dc3545' });
    if (result.isConfirmed) {
      try {
        for (const id of ids) {
          await API.deleteMember(id);
        }
        await this.renderTable();
        await Dashboard.refresh();
        Util.showToast('success', '已刪除');
      } catch (error) {
        Util.showToast('error', '刪除失敗：' + error.message);
      }
    }
  } else {
    Util.showToast('error', '尚未實作');
  }
},

async delete(id) {
  const result = await Util.confirm({ title: '刪除會員', text: '是否刪除此位會員？', confirmColor: '#dc3545' });
  if (!result.isConfirmed) return;
  
  try {
    await API.deleteMember(id);
    await this.renderTable();
    await Dashboard.refresh();
    Util.showToast('success', '已刪除會員');
  } catch (error) {
    Util.showToast('error', '刪除失敗：' + error.message);
  }
}
};

/* -------------------- 會員 UI 控制 -------------------- */
const MemberUI = {
modal: null,
currentData: null,

async open(id = null) {
  if (!this.modal) this.modal = new bootstrap.Modal(document.getElementById('memberModal'));
  
  document.getElementById('memberForm').reset();
  document.getElementById('memberId').value = '';
  document.getElementById('memberJoinDate').value = Util.today();
  document.getElementById('memberStatus').value = '啟用';
  document.getElementById('memberType').value = '一般會員';
  document.getElementById('membershipFee').value = '1000';

  if (id) {
    try {
      const members = await API.getMembers();
      const m = members.data.find(x => x.ID === id);
      if (m) {
        document.getElementById('memberModalTitle').textContent = '編輯會員';
        document.getElementById('memberId').value = m.ID;
        document.getElementById('memberName').value = m['姓名'] || '';
        document.getElementById('memberPhone').value = m['電話'] || '';
        document.getElementById('memberEmail').value = m['電子郵件'] || '';
        document.getElementById('memberBirthDate').value = m['出生日期'] || '';
        document.getElementById('memberGender').value = m['性別'] || '';
        document.getElementById('memberIdNumber').value = m['身分證字號'] || '';
        document.getElementById('memberAddress').value = m['地址'] || '';
        document.getElementById('emergencyContact').value = m['緊急聯絡人'] || '';
        document.getElementById('emergencyPhone').value = m['緊急聯絡電話'] || '';
        document.getElementById('memberNotes').value = m['備註'] || '';
        document.getElementById('memberJoinDate').value = m['加入日期'] || '';
        document.getElementById('memberStatus').value = m['狀態'] || '';
        document.getElementById('memberType').value = m['會員類型'] || '';
        document.getElementById('membershipFee').value = m['年費'] || '';
        document.getElementById('lastPaymentDate').value = m['最後繳費日期'] || '';
        document.getElementById('memberTags').value = m['標籤'] || '';
        this.currentData = m;
      }
    } catch (error) {
      Util.showToast('error', '載入會員失敗');
      return;
    }
  } else {
    document.getElementById('memberModalTitle').textContent = '新增會員';
    this.currentData = null;
  }
  
  this.modal.show();
},

async save() {
  const form = document.getElementById('memberForm');
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }

  const data = {
    ID: document.getElementById('memberId').value || Util.uuid(),
    姓名: document.getElementById('memberName').value,
    電話: document.getElementById('memberPhone').value,
    電子郵件: document.getElementById('memberEmail').value,
    出生日期: document.getElementById('memberBirthDate').value,
    性別: document.getElementById('memberGender').value,
    身分證字號: document.getElementById('memberIdNumber').value,
    地址: document.getElementById('memberAddress').value,
    緊急聯絡人: document.getElementById('emergencyContact').value,
    緊急聯絡電話: document.getElementById('emergencyPhone').value,
    備註: document.getElementById('memberNotes').value,
    加入日期: document.getElementById('memberJoinDate').value,
    狀態: document.getElementById('memberStatus').value,
    會員類型: document.getElementById('memberType').value,
    年費: Util.toNumber(document.getElementById('membershipFee').value),
    最後繳費日期: document.getElementById('lastPaymentDate').value,
    標籤: document.getElementById('memberTags').value
  };

  try {
    await API.saveMember(data);
    this.modal.hide();
    await Members.renderTable();
    await Dashboard.refresh();
    Util.showToast('success', '會員已儲存');
  } catch (error) {
    Util.showToast('error', '儲存失敗：' + error.message);
  }
}
};

/* -------------------- 活動模組 -------------------- */
const Activities = {
state: { page: 1, per: 6, data: [] },

async renderGrid() {
  try {
    Util.showLoading(true);
    
    const filters = {
      status: document.getElementById('actFilterStatus').value,
      type: document.getElementById('actFilterType').value,
      search: document.getElementById('actFilterKeyword').value,
      sort: document.getElementById('actFilterSort').value,
      page: this.state.page,
      limit: this.state.per
    };
    
    const result = await API.getActivities(filters);
    this.state.data = result.data || [];
    
    this.renderGridBody(this.state.data);
    this.renderPagination(result.totalPages || 1);
    this.updateStats();
    
  } catch (error) {
    console.error('Activities render error:', error);
    Util.showToast('error', '活動載入失敗');
  } finally {
    Util.showLoading(false);
  }
},

renderGridBody(data) {
  const grid = document.getElementById('activitiesGrid');
  if (!data || !data.length) {
    grid.innerHTML = `<div class="col-12 text-center py-5 text-muted">
      <i class="bi bi-calendar-event display-6 d-block mb-2"></i> 無符合活動
    </div>`;
    return;
  }
  
  grid.innerHTML = data.map(a => {
    const statusColor = {
      '籌備中': 'secondary', '已發布': 'primary', '報名中': 'success',
      '已額滿': 'warning', '已結束': 'dark', '已取消': 'danger'
    }[a['狀態']] || 'secondary';
    
    const progress = a['人數上限'] ? Math.round((a['報名人數'] || 0) / a['人數上限'] * 100) : 0;
    
    return `<div class="col-md-6 col-lg-4">
      <div class="activity-card card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="card-title mb-0">${a['活動名稱'] || ''}</h6>
            <span class="badge bg-${statusColor}">${a['狀態'] || ''}</span>
          </div>
          <div class="small text-muted mb-2">
            <div><i class="bi bi-calendar me-1"></i>${a['活動日期'] || ''} ${a['活動時間'] || ''}</div>
            <div><i class="bi bi-geo-alt me-1"></i>${a['地點'] || '未定'}</div>
            <div><i class="bi bi-tag me-1"></i>${a['活動類型'] || ''}</div>
          </div>
          <p class="card-text small">${(a['活動描述'] || '').substring(0, 80)}${(a['活動描述'] || '').length > 80 ? '...' : ''}</p>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <small class="text-muted">報名: ${a['報名人數'] || 0}/${a['人數上限'] || '∞'}</small>
            <small class="fw-semibold ${a['費用'] > 0 ? 'text-warning' : 'text-success'}">${a['費用'] > 0 ? '$' + Util.fmtNum(a['費用']) : '免費'}</small>
          </div>
          <div class="progress mb-3">
            <div class="progress-bar" style="width:${progress}%"></div>
          </div>
          <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-primary flex-fill" onclick="ActivityUI.open('${a.ID}')">編輯</button>
            <button class="btn btn-sm btn-outline-info" onclick="Activities.viewRegistrations('${a.ID}')">報名</button>
            <button class="btn btn-sm btn-outline-danger" onclick="Activities.delete('${a.ID}')"><i class="bi bi-trash"></i></button>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
},

renderPagination(pages) {
  const ul = document.getElementById('actPagination');
  let html = '';
  const p = this.state.page;
  const add = (pg, txt, dis = false, act = false) => html += `<li class="page-item ${dis ? 'disabled' : ''} ${act ? 'active' : ''}">
    <a href="#" class="page-link" onclick="Activities.goto(${pg});return false;">${txt}</a></li>`;
  add(p - 1, '«', p === 1);
  for (let i = Math.max(1, p - 2); i <= Math.min(pages, p + 2); i++) add(i, i, false, i === p);
  add(p + 1, '»', p === pages);
  ul.innerHTML = html;
},

goto(p) { 
  this.state.page = p; 
  this.renderGrid(); 
},

async updateStats() {
  try {
    const allActivities = await API.getActivities();
    const activities = allActivities.data || [];
    
    const total = activities.length;
    const open = activities.filter(a => a['狀態'] === '報名中').length;
    const upcoming = activities.filter(a => this.isUpcoming(a['活動日期'])).length;
    const totalRegs = activities.reduce((sum, a) => sum + (a['報名人數'] || 0), 0);
    
    document.getElementById('actStatTotal').textContent = total;
    document.getElementById('actStatOpen').textContent = open;
    document.getElementById('actStatUpcoming').textContent = upcoming;
    document.getElementById('actStatRegistrations').textContent = totalRegs;
  } catch (error) {
    console.error('Activity stats error:', error);
  }
},

isUpcoming(dateStr) {
  if (!dateStr) return false;
  const actDate = new Date(dateStr);
  const now = new Date();
  const sevenDays = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
  return actDate >= now && actDate <= sevenDays;
},

async viewRegistrations(id) {
  Util.showToast('error', '報名功能尚未實作');
},

async delete(id) {
  const result = await Util.confirm({ title: '刪除活動', text: '是否刪除此活動？', confirmColor: '#dc3545' });
  if (!result.isConfirmed) return;
  
  try {
    await API.deleteActivity(id);
    await this.renderGrid();
    Util.showToast('success', '已刪除活動');
  } catch (error) {
    Util.showToast('error', '刪除失敗：' + error.message);
  }
}
};

/* -------------------- 活動 UI 控制 -------------------- */
const ActivityUI = {
modal: null,
currentData: null,

async open(id = null) {
  if (!this.modal) this.modal = new bootstrap.Modal(document.getElementById('activityModal'));
  
  document.getElementById('activityForm').reset();
  document.getElementById('activityId').value = '';
  document.getElementById('activityDate').value = Util.today();
  document.getElementById('activityStatus').value = '籌備中';
  document.getElementById('activityMax').value = '50';
  document.getElementById('activityFee').value = '0';

  if (id) {
    try {
      const activities = await API.getActivities();
      const a = activities.data.find(x => x.ID === id);
      if (a) {
        document.getElementById('activityModalTitle').textContent = '編輯活動';
        document.getElementById('activityId').value = a.ID;
        document.getElementById('activityName').value = a['活動名稱'] || '';
        document.getElementById('activityType').value = a['活動類型'] || '';
        document.getElementById('activityStatus').value = a['狀態'] || '';
        document.getElementById('activityDate').value = a['活動日期'] || '';
        document.getElementById('activityTime').value = a['活動時間'] || '';
        document.getElementById('activityLocation').value = a['地點'] || '';
        document.getElementById('activityDescription').value = a['活動描述'] || '';
        document.getElementById('activityMax').value = a['人數上限'] || '';
        document.getElementById('activityFee').value = a['費用'] || '';
        document.getElementById('activityContact').value = a['聯絡人'] || '';
        document.getElementById('activityContactPhone').value = a['聯絡電話'] || '';
        document.getElementById('activityNotes').value = a['備註'] || '';
        this.currentData = a;
      }
    } catch (error) {
      Util.showToast('error', '載入活動失敗');
      return;
    }
  } else {
    document.getElementById('activityModalTitle').textContent = '新增活動';
    this.currentData = null;
  }
  
  this.modal.show();
},

async save() {
  const form = document.getElementById('activityForm');
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }

  const data = {
    ID: document.getElementById('activityId').value || Util.uuid(),
    活動名稱: document.getElementById('activityName').value,
    活動類型: document.getElementById('activityType').value,
    狀態: document.getElementById('activityStatus').value,
    活動日期: document.getElementById('activityDate').value,
    活動時間: document.getElementById('activityTime').value,
    地點: document.getElementById('activityLocation').value,
    活動描述: document.getElementById('activityDescription').value,
    人數上限: Util.toNumber(document.getElementById('activityMax').value),
    費用: Util.toNumber(document.getElementById('activityFee').value),
    聯絡人: document.getElementById('activityContact').value,
    聯絡電話: document.getElementById('activityContactPhone').value,
    備註: document.getElementById('activityNotes').value,
    報名人數: this.currentData ? (this.currentData['報名人數'] || 0) : 0
  };

  try {
    await API.saveActivity(data);
    this.modal.hide();
    await Activities.renderGrid();
    Util.showToast('success', '活動已儲存');
  } catch (error) {
    Util.showToast('error', '儲存失敗：' + error.message);
  }
}
};

/* -------------------- 公告模組 -------------------- */
const Announcements = {
state: { page: 1, per: 6, data: [] },

async render() {
  try {
    Util.showLoading(true);
    
    const filters = {
      status: document.getElementById('annFilterStatus').value,
      type: document.getElementById('annFilterType').value,
      search: document.getElementById('annFilterKeyword').value,
      page: this.state.page,
      limit: this.state.per
    };
    
    const result = await API.getAnnouncements(filters);
    this.state.data = result.data || [];
    
    this.renderGrid(this.state.data);
    this.renderPagination(result.totalPages || 1);
    this.updateStats();
    
  } catch (error) {
    console.error('Announcements render error:', error);
    Util.showToast('error', '公告載入失敗');
  } finally {
    Util.showLoading(false);
  }
},

renderGrid(data) {
  const grid = document.getElementById('announcementsGrid');
  if (!data || !data.length) {
    grid.innerHTML = `<div class="col-12 text-center py-5 text-muted">
      <i class="bi bi-megaphone display-6 d-block mb-2"></i> 無符合公告
    </div>`;
    return;
  }
  
  grid.innerHTML = data.map(a => {
    const typeColor = {
      '一般': 'primary', '緊急': 'danger', '活動相關': 'success', '系統公告': 'info'
    }[a['類型']] || 'primary';
    
    const isUrgent = a['類型'] === '緊急';
    const isPinned = a['置頂'] === true || a['置頂'] === 'true';
    
    return `<div class="col-md-6 col-lg-4">
      <div class="card announcement-card h-100 ${isUrgent ? 'urgent' : ''}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="card-title mb-0">${a['標題'] || ''}</h6>
            <div>
              ${isPinned ? '<i class="bi bi-pin-angle text-warning me-1" title="置頂"></i>' : ''}
              <span class="badge bg-${typeColor}">${a['類型'] || ''}</span>
            </div>
          </div>
          <div class="small text-muted mb-2">
            <div><i class="bi bi-calendar me-1"></i>${a['發布日期'] || ''}</div>
            ${a['過期日期'] ? `<div><i class="bi bi-calendar-x me-1"></i>到期: ${a['過期日期']}</div>` : ''}
          </div>
          <p class="card-text small">${(a['內容'] || '').substring(0, 100)}${(a['內容'] || '').length > 100 ? '...' : ''}</p>
          ${a['相關連結'] ? `<div class="mb-2"><a href="${a['相關連結']}" target="_blank" class="small text-decoration-none"><i class="bi bi-link-45deg me-1"></i>相關連結</a></div>` : ''}
          <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-primary flex-fill" onclick="AnnouncementUI.open('${a.ID}')">編輯</button>
            <button class="btn btn-sm btn-outline-danger" onclick="Announcements.delete('${a.ID}')"><i class="bi bi-trash"></i></button>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
},

renderPagination(pages) {
  const ul = document.getElementById('annPagination');
  let html = '';
  const p = this.state.page;
  const add = (pg, txt, dis = false, act = false) => html += `<li class="page-item ${dis ? 'disabled' : ''} ${act ? 'active' : ''}">
    <a href="#" class="page-link" onclick="Announcements.goto(${pg});return false;">${txt}</a></li>`;
  add(p - 1, '«', p === 1);
  for (let i = Math.max(1, p - 2); i <= Math.min(pages, p + 2); i++) add(i, i, false, i === p);
  add(p + 1, '»', p === pages);
  ul.innerHTML = html;
},

goto(p) { 
  this.state.page = p; 
  this.render(); 
},

async updateStats() {
  try {
    const allAnnouncements = await API.getAnnouncements();
    const announcements = allAnnouncements.data || [];
    
    const total = announcements.length;
    const active = announcements.filter(a => a['狀態'] === '發布').length;
    const urgent = announcements.filter(a => a['類型'] === '緊急').length;
    
    document.getElementById('annStatTotal').textContent = total;
    document.getElementById('annStatActive').textContent = active;
    document.getElementById('annStatUrgent').textContent = urgent;
  } catch (error) {
    console.error('Announcement stats error:', error);
  }
},

async delete(id) {
  const result = await Util.confirm({ title: '刪除公告', text: '是否刪除此公告？', confirmColor: '#dc3545' });
  if (!result.isConfirmed) return;
  
  try {
    await API.deleteAnnouncement(id);
    await this.render();
    Util.showToast('success', '已刪除公告');
  } catch (error) {
    Util.showToast('error', '刪除失敗：' + error.message);
  }
}
};

/* -------------------- 公告 UI 控制 -------------------- */
const AnnouncementUI = {
modal: null,
currentData: null,

async open(id = null) {
  if (!this.modal) this.modal = new bootstrap.Modal(document.getElementById('announcementModal'));
  
  document.getElementById('announcementForm').reset();
  document.getElementById('announcementId').value = '';
  document.getElementById('announcementPublishDate').value = Util.today();
  document.getElementById('announcementType').value = '一般';
  document.getElementById('announcementStatus').value = '草稿';

  if (id) {
    try {
      const announcements = await API.getAnnouncements();
      const a = announcements.data.find(x => x.ID === id);
      if (a) {
        document.getElementById('announcementModalTitle').textContent = '編輯公告';
        document.getElementById('announcementId').value = a.ID;
        document.getElementById('announcementTitle').value = a['標題'] || '';
        document.getElementById('announcementType').value = a['類型'] || '';
        document.getElementById('announcementStatus').value = a['狀態'] || '';
        document.getElementById('announcementPinned').checked = a['置頂'] === true || a['置頂'] === 'true';
        document.getElementById('announcementPublishDate').value = a['發布日期'] || '';
        document.getElementById('announcementExpireDate').value = a['過期日期'] || '';
        document.getElementById('announcementContent').value = a['內容'] || '';
        document.getElementById('announcementLink').value = a['相關連結'] || '';
        this.currentData = a;
      }
    } catch (error) {
      Util.showToast('error', '載入公告失敗');
      return;
    }
  } else {
    document.getElementById('announcementModalTitle').textContent = '新增公告';
    this.currentData = null;
  }
  
  this.modal.show();
},

async save() {
  const form = document.getElementById('announcementForm');
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }

  const data = {
    ID: document.getElementById('announcementId').value || Util.uuid(),
    標題: document.getElementById('announcementTitle').value,
    類型: document.getElementById('announcementType').value,
    狀態: document.getElementById('announcementStatus').value,
    置頂: document.getElementById('announcementPinned').checked,
    發布日期: document.getElementById('announcementPublishDate').value,
    過期日期: document.getElementById('announcementExpireDate').value,
    內容: document.getElementById('announcementContent').value,
    相關連結: document.getElementById('announcementLink').value
  };

  try {
    await API.saveAnnouncement(data);
    this.modal.hide();
    await Announcements.render();
    Util.showToast('success', '公告已儲存');
  } catch (error) {
    Util.showToast('error', '儲存失敗：' + error.message);
  }
}
};

/* -------------------- 表單模組 -------------------- */
const Forms = {
async render() {
  try {
    Util.showLoading(true);
    
    const filters = {
      category: document.getElementById('formFilterCategory').value,
      search: document.getElementById('formFilterKeyword').value
    };
    
    const forms = await API.getForms();
    let data = forms || [];
    
    if (filters.category) {
      data = data.filter(f => f['分類'] === filters.category);
    }
    
    if (filters.search) {
      const search = filters.search.toLowerCase();
      data = data.filter(f => 
        (f['表單名稱'] || '').toLowerCase().includes(search) ||
        (f['描述'] || '').toLowerCase().includes(search)
      );
    }
    
    this.renderList(data);
    
  } catch (error) {
    console.error('Forms render error:', error);
    Util.showToast('error', '表單載入失敗');
  } finally {
    Util.showLoading(false);
  }
},

renderList(data) {
  const list = document.getElementById('formsList');
  if (!data || !data.length) {
    list.innerHTML = `<div class="col-12 text-center py-5 text-muted">
      <i class="bi bi-file-earmark-arrow-down display-6 d-block mb-2"></i> 無符合表單
    </div>`;
    return;
  }
  
  list.innerHTML = data.map(f => {
    const categoryColor = {
      '會員': 'primary', '財務': 'success', '活動': 'info', '行政': 'warning', '其他': 'secondary'
    }[f['分類']] || 'secondary';
    
    return `<div class="col-md-6 col-lg-4">
      <div class="card form-card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="card-title mb-0">${f['表單名稱'] || ''}</h6>
            <span class="badge bg-${categoryColor}">${f['分類'] || ''}</span>
          </div>
          <p class="card-text small text-muted">${f['描述'] || ''}</p>
          <div class="d-flex gap-1">
            <button class="btn btn-sm btn-primary flex-fill" onclick="Forms.download('${f.ID}')">
              <i class="bi bi-download me-1"></i>下載
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="Forms.delete('${f.ID}')">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
},

async download(id) {
  Util.showToast('error', '下載功能尚未實作');
},

async delete(id) {
  const result = await Util.confirm({ title: '刪除表單', text: '是否刪除此表單？', confirmColor: '#dc3545' });
  if (!result.isConfirmed) return;
  
  try {
    await API.deleteForm(id);
    await this.render();
    Util.showToast('success', '已刪除表單');
  } catch (error) {
    Util.showToast('error', '刪除失敗：' + error.message);
  }
}
};

/* -------------------- 統計分析模組 -------------------- */
const Analytics = {
charts: {},

async refresh() {
  try {
    Util.showLoading(true);
    
    const year = document.getElementById('analyticsYear').value || new Date().getFullYear();
    const data = await API.getAnalyticsData({ year });
    
    this.updateSummary(data.summary);
    this.renderCharts(data);
    
  } catch (error) {
    console.error('Analytics refresh error:', error);
    Util.showToast('error', '統計載入失敗');
  } finally {
    Util.showLoading(false);
  }
},

updateSummary(summary) {
  document.getElementById('anaTotalIncome').textContent = '$' + Util.fmtNum(summary.totalIncome || 0);
  document.getElementById('anaTotalExpense').textContent = '$' + Util.fmtNum(summary.totalExpense || 0);
  document.getElementById('anaBalance').textContent = '$' + Util.fmtNum((summary.totalIncome || 0) - (summary.totalExpense || 0));
  document.getElementById('anaAvgMonthly').textContent = '$' + Util.fmtNum(summary.avgMonthly || 0);
},

renderCharts(data) {
  this.renderTrendChart(data.monthly);
  this.renderExpenseCategoryChart(data.expenseCategories);
  this.renderMonthlyCompareChart(data.monthly);
  this.renderMemberGrowthChart(data.memberGrowth);
},

renderTrendChart(monthlyData) {
  const ctx = document.getElementById('chartTrend');
  if (this.charts.trend) this.charts.trend.destroy();
  
  this.charts.trend = new Chart(ctx, {
    type: 'line',
    data: {
      labels: monthlyData.map(m => m.month),
      datasets: [{
        label: '收入',
        data: monthlyData.map(m => m.income),
        borderColor: '#28a745',
        backgroundColor: 'rgba(40, 167, 69, 0.1)',
        tension: 0.4
      }, {
        label: '支出',
        data: monthlyData.map(m => m.expense),
        borderColor: '#dc3545',
        backgroundColor: 'rgba(220, 53, 69, 0.1)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: value => '$' + Util.fmtNum(value)
          }
        }
      }
    }
  });
},

renderExpenseCategoryChart(categoryData) {
  const ctx = document.getElementById('chartExpenseCategory');
  if (this.charts.expenseCategory) this.charts.expenseCategory.destroy();
  
  this.charts.expenseCategory = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: categoryData.map(c => c.category),
      datasets: [{
        data: categoryData.map(c => c.amount),
        backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
},

renderMonthlyCompareChart(monthlyData) {
  const ctx = document.getElementById('chartMonthlyCompare');
  if (this.charts.monthlyCompare) this.charts.monthlyCompare.destroy();
  
  this.charts.monthlyCompare = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: monthlyData.map(m => m.month),
      datasets: [{
        label: '收入',
        data: monthlyData.map(m => m.income),
        backgroundColor: 'rgba(40, 167, 69, 0.8)'
      }, {
        label: '支出',
        data: monthlyData.map(m => m.expense),
        backgroundColor: 'rgba(220, 53, 69, 0.8)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: value => '$' + Util.fmtNum(value)
          }
        }
      }
    }
  });
},

renderMemberGrowthChart(growthData) {
  const ctx = document.getElementById('chartMemberGrowth');
  if (this.charts.memberGrowth) this.charts.memberGrowth.destroy();
  
  this.charts.memberGrowth = new Chart(ctx, {
    type: 'line',
    data: {
      labels: growthData.map(g => g.month),
      datasets: [{
        label: '會員總數',
        data: growthData.map(g => g.total),
        borderColor: '#007bff',
        backgroundColor: 'rgba(0, 123, 255, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}
};

/* -------------------- 報表模組 -------------------- */
const Reports = {
dateInitialized: false,

initDateOnce() {
  if (this.dateInitialized) return;
  
  const today = new Date();
  const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
  
  document.getElementById('reportStart').value = firstDay.toISOString().split('T')[0];
  document.getElementById('reportEnd').value = today.toISOString().split('T')[0];
  
  this.dateInitialized = true;
},

quickDate(period) {
  const today = new Date();
  let start, end = today;
  
  if (period === 'thisMonth') {
    start = new Date(today.getFullYear(), today.getMonth(), 1);
  } else if (period === 'thisYear') {
    start = new Date(today.getFullYear(), 0, 1);
  }
  
  document.getElementById('reportStart').value = start.toISOString().split('T')[0];
  document.getElementById('reportEnd').value = end.toISOString().split('T')[0];
},

async generate(type) {
  const startDate = document.getElementById('reportStart').value;
  const endDate = document.getElementById('reportEnd').value;
  
  if (!startDate || !endDate) {
    return Util.showToast('error', '請選擇日期範圍');
  }
  
  try {
    Util.showLoading(true);
    
    const params = {
      type: type,
      startDate: startDate,
      endDate: endDate
    };
    
    const reportData = await API.generateReport(params);
    this.downloadReport(reportData, type);
    
    Util.showToast('success', '報表已生成');
    
  } catch (error) {
    console.error('Report generation error:', error);
    Util.showToast('error', '報表生成失敗：' + error.message);
  } finally {
    Util.showLoading(false);
  }
},

downloadReport(data, type) {
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, '報表');
  
  const filename = `${type}_report_${new Date().toISOString().split('T')[0]}.xlsx`;
  XLSX.writeFile(wb, filename);
}
};

/* -------------------- 資料匯出 -------------------- */
const DataPort = {
async exportTransactions() {
  try {
    const result = await API.getTransactions();
    const data = result.data || [];
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, '交易記錄');
    
    XLSX.writeFile(wb, `交易記錄_${Util.today()}.xlsx`);
    Util.showToast('success', '已匯出交易記錄');
  } catch (error) {
    Util.showToast('error', '匯出失敗：' + error.message);
  }
},

async exportMembers() {
  try {
    const result = await API.getMembers();
    const data = result.data || [];
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, '會員資料');
    
    XLSX.writeFile(wb, `會員資料_${Util.today()}.xlsx`);
    Util.showToast('success', '已匯出會員資料');
  } catch (error) {
    Util.showToast('error', '匯出失敗：' + error.message);
  }
},

async exportActivities() {
  try {
    const result = await API.getActivities();
    const data = result.data || [];
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, '活動資料');
    
    XLSX.writeFile(wb, `活動資料_${Util.today()}.xlsx`);
    Util.showToast('success', '已匯出活動資料');
  } catch (error) {
    Util.showToast('error', '匯出失敗：' + error.message);
  }
},

async exportAnnouncements() {
  try {
    const result = await API.getAnnouncements();
    const data = result.data || [];
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, '公告資料');
    
    XLSX.writeFile(wb, `公告資料_${Util.today()}.xlsx`);
    Util.showToast('success', '已匯出公告資料');
  } catch (error) {
    Util.showToast('error', '匯出失敗：' + error.message);
  }
}
};

/* -------------------- 設定 UI 控制 -------------------- */
const SettingsUI = {
modal: null,

async open() {
  if (!this.modal) this.modal = new bootstrap.Modal(document.getElementById('settingsModal'));
  
  try {
    const settings = await API.getSettings();
    
    document.getElementById('setOrgName').value = settings.orgName || '';
    document.getElementById('setOrgAddress').value = settings.orgAddress || '';
    document.getElementById('setOrgPhone').value = settings.orgPhone || '';
    document.getElementById('setOrgEmail').value = settings.orgEmail || '';
    document.getElementById('setDefaultFee').value = settings.defaultFee || 1000;
    document.getElementById('setReceiptPrefix').value = settings.receiptPrefix || 'R';
    document.getElementById('setVoucherPrefix').value = settings.voucherPrefix || 'V';
    
  } catch (error) {
    console.error('Settings load error:', error);
  }
  
  this.modal.show();
},

async save() {
  const data = {
    orgName: document.getElementById('setOrgName').value,
    orgAddress: document.getElementById('setOrgAddress').value,
    orgPhone: document.getElementById('setOrgPhone').value,
    orgEmail: document.getElementById('setOrgEmail').value,
    defaultFee: Util.toNumber(document.getElementById('setDefaultFee').value),
    receiptPrefix: document.getElementById('setReceiptPrefix').value,
    voucherPrefix: document.getElementById('setVoucherPrefix').value
  };

  try {
    await API.saveSettings(data);
    this.modal.hide();
    Util.showToast('success', '設定已儲存');
  } catch (error) {
    Util.showToast('error', '儲存失敗：' + error.message);
  }
}
};

/* -------------------- 表單管理 UI -------------------- */
const FormUI = {
async openManager() {
  Util.showToast('error', '表單管理功能尚未實作');
}
};

/* -------------------- 初始化 -------------------- */
document.addEventListener('DOMContentLoaded', async function() {
// 初始化年份選單
const yearSelect = document.getElementById('analyticsYear');
const currentYear = new Date().getFullYear();
for (let year = currentYear; year >= currentYear - 5; year--) {
  yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
}
yearSelect.value = currentYear;

// 測試 API 連線
try {
  await API.testConnection();
  console.log('API 連線成功');
} catch (error) {
  console.error('API 連線失敗:', error);
  Util.showToast('error', 'API 連線失敗，請檢查設定');
}

// 載入儀表板
await AppLayout.showSection('dashboard');
});

// 全域函數
window.AppLayout = AppLayout;
window.Dashboard = Dashboard;
window.Transactions = Transactions;
window.TransactionUI = TransactionUI;
window.Members = Members;
window.MemberUI = MemberUI;
window.Activities = Activities;
window.ActivityUI = ActivityUI;
window.Announcements = Announcements;
window.AnnouncementUI = AnnouncementUI;
window.Forms = Forms;
window.FormUI = FormUI;
window.Analytics = Analytics;
window.Reports = Reports;
window.DataPort = DataPort;
window.SettingsUI = SettingsUI;

</script>
</body>
</html>
