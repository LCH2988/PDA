<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>台灣帕金森病友權益促進會 - 會計暨營運整合管理系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="非營利組織整合：財務 / 會員 / 活動 / 公告 / 表單 / 雲端備份管理系統">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <style>
    :root {
      --primary:#2c5aa0;
      --primary-dark:#1e3d6f;
      --gradient-primary:linear-gradient(135deg,#2c5aa0,#4a90e2);
      --gradient-green:linear-gradient(135deg,#28a745,#20c997);
      --gradient-orange:linear-gradient(135deg,#ff9f40,#ffb347);
      --secondary-bg:#f8f9fa;
      --radius-lg:15px;
      --radius-md:10px;
      --radius-sm:6px;
    }
    body {
      background:var(--secondary-bg);
      font-family:"Microsoft JhengHei","Noto Sans TC",system-ui,sans-serif;
      font-size:14.5px;
    }
    .navbar-brand { font-weight:600; color:var(--primary)!important; }
    .sidebar {
      min-height:100vh;
      background:linear-gradient(180deg,#2c5aa0,#1e3d6f);
      color:#fff;
    }
    .sidebar .nav-link {
      color:rgba(255,255,255,.82);
      border-radius:8px;
      margin:3px 0;
      font-weight:500;
      transition:.25s;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background:rgba(255,255,255,0.12);
      color:#fff;
      transform:translateX(4px);
    }
    .content-section { animation:fadeIn .35s ease; }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(12px); }
      to { opacity:1; transform:translateY(0); }
    }
    .stat-card {
      background:var(--gradient-primary);
      color:#fff;
      border:none;
      border-radius:var(--radius-lg);
      box-shadow:0 4px 14px -4px rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
    }
    .stat-card.alt-green { background:var(--gradient-green); }
    .stat-card.alt-orange{ background:var(--gradient-orange); }
    .stat-card .icon-bg {
      position:absolute;
      right:-10px; top:-10px;
      font-size:72px;
      opacity:.16;
    }
    .card-hoverable { transition:.25s; border:none; border-radius:var(--radius-lg); }
    .card-hoverable:hover { transform:translateY(-4px); box-shadow:0 8px 24px -6px rgba(0,0,0,.15); }
    .table thead th { background:#f1f4f8; border-top:none; font-weight:600; }
    .badge-rounded { border-radius:20px; font-weight:500; letter-spacing:.5px; }
    .member-avatar, .participant-avatar {
      width:40px;height:40px;border-radius:50%;background:#fff;
      display:flex;align-items:center;justify-content:center;
      color:#666;font-weight:600;
      box-shadow:0 0 0 1px rgba(0,0,0,.05);
    }
    .small-avatar { width:32px;height:32px;font-size:12px; }
    .action-buttons .btn { padding:.25rem .5rem; }
    .loading-overlay {
      position:fixed; inset:0; z-index:2000;
      background:rgba(0,0,0,.45); display:flex;align-items:center;justify-content:center;
    }
    .pagination .page-link { border:none; border-radius:8px; color:var(--primary); }
    .pagination .page-item.active .page-link { background:var(--primary); }
    .chart-container { position:relative; height:380px; }
    .separator-title {
      font-size:15px;font-weight:600;margin:16px 0 10px;display:flex;align-items:center;gap:.5rem;
    }
    .separator-title:before, .separator-title:after {
      content:""; flex:1; height:1px; background:linear-gradient(90deg,#d0d3d9,#ffffff);
    }
    .activity-card { border:none;border-radius:var(--radius-lg);overflow:hidden;box-shadow:0 3px 10px -2px rgba(0,0,0,.12);position:relative; }
    .activity-card .progress { height:6px; border-radius:3px; background:#e9ecef; overflow:hidden; }
    .activity-card .progress-bar { background:var(--gradient-green); }
    .announcement-card { border-left:5px solid #ffc107; border-radius:var(--radius-md); }
    .announcement-card.urgent { border-left-color:#dc3545; background:linear-gradient(135deg,#fff5f5,#ffffff); }
    @media print {
      .no-print, .sidebar, .navbar, .modal-backdrop { display:none!important; }
      body { background:#fff; }
      .main-content { margin:0!important; padding:0!important; }
      .card { box-shadow:none!important; }
    }
    @media (max-width: 992px){
      .sidebar { position:fixed; left:0; top:0; transform:translateX(-100%); transition:.35s; z-index:1100; width:250px; }
      .sidebar.show { transform:translateX(0); }
    }
    .spin { animation:spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="text-center text-white">
      <div class="mb-3">
        <i class="bi bi-arrow-clockwise spin" style="font-size:48px;"></i>
      </div>
      <div>系統載入中，請稍候…</div>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg bg-white shadow-sm no-print">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <i class="bi bi-heart-pulse me-2"></i> 台灣帕金森病友權益促進會
      </a>
      <button class="navbar-toggler" type="button" onclick="AppLayout.toggleSidebar()">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item me-2">
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
              <input id="globalSearchInput" type="text" class="form-control" placeholder="全域搜尋 (交易 / 會員 / 活動 / 公告)" onkeydown="if(event.key==='Enter') GlobalSearch.exec()">
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle fw-semibold" href="#" data-bs-toggle="dropdown">
              <i class="bi bi-gear"></i> 系統
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" onclick="SettingsUI.open()"><i class="bi bi-sliders"></i> 系統設定</a></li>
              <li><a class="dropdown-item" href="#" onclick="AccountUI.open()"><i class="bi bi-bank"></i> 帳戶管理</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.exportAll()"><i class="bi bi-download"></i> 匯出資料</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.importAll()"><i class="bi bi-upload"></i> 匯入資料</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="About.show()"><i class="bi bi-info-circle"></i> 關於</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <aside id="sidebar" class="sidebar col-lg-2 col-md-3 p-3">
        <h6 class="text-center mt-2 mb-4 fw-semibold">管理選單</h6>
          <nav class="nav flex-column">
            <a class="nav-link active" href="#" data-section="dashboard" onclick="AppLayout.showSection('dashboard',this)"><i class="bi bi-speedometer2 me-2"></i>儀表板</a>
            <a class="nav-link" href="#" data-section="transactions" onclick="AppLayout.showSection('transactions',this)"><i class="bi bi-receipt me-2"></i>交易記錄</a>
            <a class="nav-link" href="#" data-section="members" onclick="AppLayout.showSection('members',this)"><i class="bi bi-people me-2"></i>會員管理</a>
            <a class="nav-link" href="#" data-section="activities" onclick="AppLayout.showSection('activities',this)"><i class="bi bi-calendar-event me-2"></i>活動管理</a>
            <a class="nav-link" href="#" data-section="announcements" onclick="AppLayout.showSection('announcements',this)"><i class="bi bi-megaphone me-2"></i>公告管理</a>
            <a class="nav-link" href="#" data-section="forms" onclick="AppLayout.showSection('forms',this)"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單</a>
            <a class="nav-link" href="#" data-section="analytics" onclick="AppLayout.showSection('analytics',this)"><i class="bi bi-graph-up me-2"></i>統計分析</a>
            <a class="nav-link" href="#" data-section="reports" onclick="AppLayout.showSection('reports',this)"><i class="bi bi-file-earmark-text me-2"></i>報表中心</a>
          </nav>
      </aside>

      <main id="mainContent" class="col-lg-10 col-md-9 p-4">
        <!-- 儀表板 -->
        <section id="dashboardSection" class="content-section">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>儀表板</h4>
            <div class="d-flex gap-2">
              <div class="d-flex gap-1 me-3">
                <span id="syncIndicator" class="badge bg-success"><i class="bi bi-cloud-check"></i> 已同步</span>
                <span id="offlineIndicator" class="badge bg-danger d-none"><i class="bi bi-wifi-off"></i> 離線</span>
              </div>
              <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
              <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
              <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100">
                <div class="icon-bg"><i class="bi bi-cash-coin"></i></div>
                <small>總收入</small>
                <h3 id="totalIncome" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">本月</span>
                  <span id="monthIncome" class="small fw-semibold">$0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100 alt-orange">
                <div class="icon-bg"><i class="bi bi-credit-card-2-front"></i></div>
                <small>總支出</small>
                <h3 id="totalExpense" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">本月</span>
                  <span id="monthExpense" class="small fw-semibold">$0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100 alt-green">
                <div class="icon-bg"><i class="bi bi-bank"></i></div>
                <small>帳戶總餘額</small>
                <h3 id="totalBalance" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">帳戶數</span>
                  <span id="accountCount" class="small fw-semibold">0</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card p-3 h-100">
                <div class="icon-bg"><i class="bi bi-people"></i></div>
                <small>會員總數</small>
                <h3 id="memberTotal" class="mb-1">0</h3>
                <div class="d-flex justify-content-between">
                  <span class="small opacity-75">逾期會費</span>
                  <span id="memberOverdue" class="badge bg-danger rounded-pill">0</span>
                </div>
              </div>
            </div>
          </div>

          <div class="card card-hoverable mb-3">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h6 class="mb-0"><i class="bi bi-bank me-1"></i>帳戶餘額概覽</h6>
              <button class="btn btn-sm btn-outline-primary" onclick="AccountUI.open()"><i class="bi bi-gear"></i> 管理帳戶</button>
            </div>
            <div class="card-body">
              <div id="dashboardAccountBalances" class="row g-3"></div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-arrows-expand me-1"></i>最近交易</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentTx">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-person-plus me-1"></i>新加入會員</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentMembers">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-hoverable h-100">
                <div class="card-header bg-white">
                  <h6 class="mb-0"><i class="bi bi-calendar-event me-1"></i>近期活動</h6>
                </div>
                <div class="card-body p-2" id="dashboardRecentActivities">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 交易記錄 -->
        <section id="transactionsSection" class="content-section" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0"><i class="bi bi-receipt me-2"></i>交易記錄</h4>
            <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
          </div>
          
          <div class="card card-hoverable mb-3">
            <div class="card-header bg-white">
              <div class="row g-2 align-items-center">
                <div class="col-md-2">
                  <select id="txFilterType" class="form-select form-select-sm" onchange="Transactions.applyFilters()">
                    <option value="">全部類型</option>
                    <option value="收入">收入</option>
                    <option value="支出">支出</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <select id="txFilterYear" class="form-select form-select-sm" onchange="Transactions.applyFilters()">
                    <option value="">全部年份</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <select id="txFilterAccount" class="form-select form-select-sm" onchange="Transactions.applyFilters()">
                    <option value="">全部帳戶</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <input id="txSearchInput" type="text" class="form-control form-control-sm" placeholder="搜尋交易..." onkeyup="Transactions.applyFilters()">
                </div>
                <div class="col-md-3 text-end">
                  <button class="btn btn-outline-secondary btn-sm" onclick="Transactions.exportToExcel()"><i class="bi bi-download"></i> 匯出</button>
                </div>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead>
                    <tr>
                      <th>日期</th>
                      <th>類型</th>
                      <th>類別</th>
                      <th>金額</th>
                      <th>對象</th>
                      <th>帳戶</th>
                      <th>說明</th>
                      <th>憑證</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="transactionsTableBody">
                    <tr>
                      <td colspan="9" class="text-center text-muted py-4">載入中...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- 其他 sections 保持不變... -->
        <section id="membersSection" class="content-section" style="display:none;">
          <div class="text-center py-5">
            <h4>會員管理功能開發中...</h4>
          </div>
        </section>

        <section id="activitiesSection" class="content-section" style="display:none;">
          <div class="text-center py-5">
            <h4>活動管理功能開發中...</h4>
          </div>
        </section>

        <section id="announcementsSection" class="content-section" style="display:none;">
          <div class="text-center py-5">
            <h4>公告管理功能開發中...</h4>
          </div>
        </section>

        <section id="formsSection" class="content-section" style="display:none;">
          <div class="text-center py-5">
            <h4>行政表單功能開發中...</h4>
          </div>
        </section>

        <section id="analyticsSection" class="content-section" style="display:none;">
          <div class="text-center py-5">
            <h4>統計分析功能開發中...</h4>
          </div>
        </section>

        <section id="reportsSection" class="content-section" style="display:none;">
          <div class="text-center py-5">
            <h4>報表中心功能開發中...</h4>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- 交易 Modal -->
  <div class="modal fade" id="transactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title"><i class="bi bi-receipt me-2"></i><span id="transactionModalTitle">新增交易</span></h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="transactionForm">
            <input type="hidden" id="transactionId">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">日期 *</label>
                <input type="date" id="transactionDate" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">類型 *</label>
                <select id="transactionType" class="form-select" required onchange="TransactionUI.updateCategories()">
                  <option value="">請選擇</option>
                  <option value="收入">收入</option>
                  <option value="支出">支出</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">類別 *</label>
                <select id="transactionCategory" class="form-select" required>
                  <option value="">請選擇類型後顯示</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">金額 *</label>
                <input type="number" id="transactionAmount" class="form-control" min="0" step="0.01" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">對象</label>
                <input type="text" id="transactionCounterparty" class="form-control" list="counterpartyList">
                <datalist id="counterpartyList"></datalist>
              </div>
              <div class="col-md-6">
                <label class="form-label">帳戶</label>
                <select id="transactionAccount" class="form-select">
                  <option value="">請選擇帳戶</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">說明</label>
                <textarea id="transactionDescription" class="form-control" rows="2"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">收據編號</label>
                <input type="text" id="transactionReceiptNumber" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">憑證編號</label>
                <input type="text" id="transactionVoucherNumber" class="form-control">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary" onclick="TransactionUI.save()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast 通知 -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:2000;">
    <div id="toastSuccess" class="toast align-items-center border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body"><i class="bi bi-check-circle text-success me-2"></i><span id="toastSuccessMsg">成功</span></div>
        <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastError" class="toast align-items-center border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body"><i class="bi bi-exclamation-triangle text-danger me-2"></i><span id="toastErrorMsg">錯誤</span></div>
        <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- 依賴套件 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
  // ================== 配置設定 ==================
  const CONFIG = {
    // 請替換為您的 Google Apps Script Web App URL
    API_URL: 'https://script.google.com/macros/s/AKfycbw_NtGdCkUYu5NPvrfk4ED3c5FsGz_AIiYLv_1uIUl0frt1k61JHW27JKzmvkp8j6h0QA/exec',
  };

  // ================== API 通信層 ==================
  const API = {
    async call(action, data = {}) {
      try {
        this.showLoading(true);
        
        const response = await fetch(CONFIG.API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: action,
            ...data
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
          return result;
        } else {
          throw new Error(result.error || '操作失敗');
        }
      } catch (error) {
        console.error('API call failed:', error);
        Util.showToast('error', error.message || '網路連線錯誤');
        throw error;
      } finally {
        this.showLoading(false);
      }
    },

    showLoading(show) {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.style.display = show ? 'flex' : 'none';
      }
      }
    };

    // ================== 工具層 ==================
    const Util = {
      uuid: () => 'id_' + Math.random().toString(36).slice(2, 10),
      today: () => new Date().toISOString().split('T')[0],
      fmtNum: n => (Number(n) || 0).toLocaleString(),
      toNumber: v => isNaN(parseFloat(v)) ? 0 : parseFloat(v),
      pad: (n, l = 2) => String(n).padStart(l, '0'),
      
      formatDateInput(d) {
        if (!d) return '';
        if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
        let s = String(d).replace(/[年月\.\/]/g, '-').replace(/日/, '');
        const m = s.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
        if (m) return m[1] + '-' + Util.pad(m[2]) + '-' + Util.pad(m[3]);
        const dt = new Date(d);
        if (isNaN(dt.getTime())) return '';
        return dt.toISOString().split('T')[0];
      },

      showToast(type, msg) {
        const id = type === 'success' ? 'toastSuccess' : 'toastError';
        const el = document.getElementById(id);
        if (!el) { alert(msg); return; }
        (type === 'success' ? document.getElementById('toastSuccessMsg') : document.getElementById('toastErrorMsg')).textContent = msg;
        new bootstrap.Toast(el, { delay: 3000 }).show();
      },

      confirm(opts) {
        return Swal.fire({
          icon: opts.icon || 'warning',
          title: opts.title || '確定？',
          html: opts.html || opts.text || '',
          showCancelButton: true,
          confirmButtonText: opts.confirmText || '確定',
          cancelButtonText: opts.cancelText || '取消',
          confirmButtonColor: opts.confirmColor || '#0d6efd'
        });
      }
    };

    // ================== Layout 管理 ==================
    const AppLayout = {
      showSection(name, link) {
        document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
        document.getElementById(name + 'Section').style.display = 'block';
        document.querySelectorAll('.sidebar .nav-link').forEach(a => a.classList.remove('active'));
        if (link) link.classList.add('active');
        
        switch (name) {
          case 'dashboard': Dashboard.refresh(); break;
          case 'transactions': Transactions.load(); break;
        }
        
        if (window.innerWidth < 992) this.toggleSidebar(false);
      },

      toggleSidebar(force) {
        const sb = document.getElementById('sidebar');
        if (typeof force === 'boolean') {
          sb.classList.toggle('show', force);
        } else {
          sb.classList.toggle('show');
        }
      }
    };

    // ================== 儀表板 ==================
    const Dashboard = {
      async refresh() {
        try {
          console.log('Dashboard refreshing...');
          const result = await API.call('getDashboardData');
          
          if (result.success && result.data) {
            console.log('Dashboard data received:', result.data);
            
            if (result.data.stats) {
              this.updateStats(result.data.stats);
            }
            
            if (result.data.accounts) {
              this.renderAccounts(result.data.accounts);
            }
            if (result.data.recentTransactions) {
              this.renderRecentTransactions(result.data.recentTransactions);
            }
            if (result.data.recentMembers) {
              this.renderRecentMembers(result.data.recentMembers);
            }
            if (result.data.recentActivities) {
              this.renderRecentActivities(result.data.recentActivities);
            }
          } else {
            console.error('Dashboard data fetch failed:', result.error || 'Unknown error');
            this.showError('無法載入儀表板資料');
          }
        } catch (error) {
          console.error('Dashboard refresh failed:', error);
          this.showError('儀表板載入失敗: ' + error.message);
        }
      },

      updateStats(stats) {
        const safeStats = {
          totalIncome: 0,
          totalExpense: 0,
          monthIncome: 0,
          monthExpense: 0,
          totalBalance: 0,
          accountCount: 0,
          memberTotal: 0,
          memberOverdue: 0,
          ...stats
        };

        const elements = {
          totalIncome: document.getElementById('totalIncome'),
          totalExpense: document.getElementById('totalExpense'),
          monthIncome: document.getElementById('monthIncome'),
          monthExpense: document.getElementById('monthExpense'),
          totalBalance: document.getElementById('totalBalance'),
          accountCount: document.getElementById('accountCount'),
          memberTotal: document.getElementById('memberTotal'),
          memberOverdue: document.getElementById('memberOverdue')
        };

        Object.entries(elements).forEach(([key, element]) => {
          if (element) {
            const value = safeStats[key];
            if (key.includes('Income') || key.includes('Expense') || key.includes('Balance')) {
              element.textContent = `$${(value || 0).toLocaleString()}`;
            } else {
              element.textContent = (value || 0).toLocaleString();
            }
          } else {
            console.warn(`Element not found: ${key}`);
          }
        });
      },

      renderAccounts(accounts) {
        const container = document.getElementById('dashboardAccountBalances');
        if (!container) return;
        
        if (!accounts.length) {
          container.innerHTML = '<div class="col-12 text-muted">尚無帳戶</div>';
          return;
        }
        
        container.innerHTML = accounts.map(a => `
          <div class="col-6 col-md-3">
            <div class="border rounded p-2 h-100 small bg-white">
              <div class="d-flex justify-content-between">
                <span class="fw-semibold">${a.name || a['帳戶名稱'] || '未命名'}</span>
                <span class="badge ${(a.active || a['狀態'] === '啟用') ? 'bg-success' : 'bg-secondary'}">${(a.active || a['狀態'] === '啟用') ? '啟用' : '停用'}</span>
              </div>
              <div class="mt-1">
                <span class="text-muted">餘額：</span>
                <span class="${(a.currentBalance || a['目前餘額'] || 0) >= 0 ? 'text-success' : 'text-danger'} fw-semibold">$${Util.fmtNum(a.currentBalance || a['目前餘額'] || 0)}</span>
              </div>
            </div>
          </div>`).join('');
      },

      renderRecentTransactions(transactions) {
        const box = document.getElementById('dashboardRecentTx');
        if (!transactions.length) {
          box.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易</div>';
          return;
        }
        
        box.innerHTML = transactions.map(t => `
          <div class="d-flex justify-content-between align-items-center border-bottom py-2 small">
            <div>
              <div class="fw-semibold">${t.category || t['類別'] || '未分類'}</div>
              <div class="text-muted">${t.date || t['日期']} ${t.counterparty || t['科目'] || ''}</div>
            </div>
            <div class="text-end">
              <span class="badge ${(t.type || t['類型']) === '收入' ? 'bg-success' : 'bg-danger'}">${(t.type || t['類型']) === '收入' ? '+' : '-'}$${Util.fmtNum(t.amount || t['金額'] || 0)}</span>
            </div>
          </div>`).join('');
      },

      renderRecentMembers(members) {
        const box = document.getElementById('dashboardRecentMembers');
        if (!members.length) {
          box.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員</div>';
          return;
        }
        
        box.innerHTML = members.map(m => `
          <div class="d-flex align-items-center border-bottom py-2 small">
            <div class="member-avatar me-2"><i class="bi bi-person"></i></div>
            <div class="flex-grow-1">
              <div class="fw-semibold">${m.name || m['姓名'] || '未命名'}</div>
              <div class="text-muted">${m.joinDate || m['入會日期'] || ''}</div>
            </div>
            <span class="badge bg-success">正常</span>
          </div>`).join('');
      },

      renderRecentActivities(activities) {
        const box = document.getElementById('dashboardRecentActivities');
        if (!activities.length) {
          box.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-calendar-event display-6 d-block mb-2"></i> 尚無活動</div>';
          return;
        }
        
        box.innerHTML = activities.map(a => `
          <div class="d-flex align-items-center border-bottom py-2 small">
            <div class="me-2 text-info"><i class="bi bi-calendar-event"></i></div>
            <div class="flex-grow-1">
              <div class="fw-semibold">${a.name || a['活動名稱'] || '未命名'}</div>
              <div class="text-muted">${a.date || a['開始日期'] || ''}</div>
            </div>
            <span class="badge bg-primary">進行中</span>
          </div>`).join('');
      },

      showError(message) {
        const elements = ['totalIncome', 'totalExpense', 'monthIncome', 'monthExpense', 
                         'totalBalance', 'accountCount', 'memberTotal', 'memberOverdue'];
        
        elements.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = '--';
          }
        });

        Util.showToast('error', message);
      }
    };

    // ================== 交易管理 ==================
    const Transactions = {
      data: [],
      filteredData: [],

      async load() {
        try {
          const result = await API.call('getTransactions');
          this.data = result.data || [];
          this.applyFilters();
          this.populateFilters();
        } catch (error) {
          console.error('Load transactions failed:', error);
          this.data = [];
          this.renderTable();
        }
      },

      applyFilters() {
        const type = document.getElementById('txFilterType')?.value || '';
        const year = document.getElementById('txFilterYear')?.value || '';
        const account = document.getElementById('txFilterAccount')?.value || '';
        const search = document.getElementById('txSearchInput')?.value.toLowerCase() || '';

        this.filteredData = this.data.filter(t => {
          const txType = t.type || t['類型'];
          const txDate = t.date || t['日期'];
          const txAccount = t.account || t['帳戶'];
          
          if (type && txType !== type) return false;
          if (year && !txDate.startsWith(year)) return false;
          if (account && txAccount !== account) return false;
          if (search && !this.matchesSearch(t, search)) return false;
          return true;
        });

        this.renderTable();
      },

      matchesSearch(transaction, search) {
        const searchFields = [
          transaction.category || transaction['類別'],
          transaction.counterparty || transaction['科目'],
          transaction.description || transaction['摘要'],
          transaction.receiptNumber || transaction['收據編號'],
          transaction.voucherNumber || transaction['憑證編號']
        ];
        return searchFields.some(field => 
          field && field.toLowerCase().includes(search)
        );
      },

      populateFilters() {
        const years = [...new Set(this.data.map(t => (t.date || t['日期'] || '').slice(0, 4)))].filter(y => y).sort().reverse();
        const yearSelect = document.getElementById('txFilterYear');
        if (yearSelect) {
          yearSelect.innerHTML = '<option value="">全部年份</option>' +
            years.map(y => `<option value="${y}">${y}</option>`).join('');
        }
      },

      renderTable() {
        const tbody = document.getElementById('transactionsTableBody');
        if (!tbody) return;

        if (!this.filteredData.length) {
          tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">無符合條件的交易記錄</td></tr>';
          return;
        }

        tbody.innerHTML = this.filteredData.map(t => `
          <tr>
            <td>${t.date || t['日期'] || ''}</td>
            <td><span class="badge ${(t.type || t['類型']) === '收入' ? 'bg-success' : 'bg-danger'}">${t.type || t['類型'] || ''}</span></td>
            <td>${t.category || t['類別'] || ''}</td>
            <td class="text-end fw-semibold">${Util.fmtNum(t.amount || t['金額'] || 0)}</td>
            <td>${t.counterparty || t['科目'] || '-'}</td>
            <td>${t.account || t['帳戶'] || '-'}</td>
            <td>${t.description || t['摘要'] || '-'}</td>
            <td>${t.receiptNumber || t['收據編號'] || t.voucherNumber || t['憑證編號'] || '-'}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-outline-primary" onclick="TransactionUI.edit('${t.id || t.ID}')">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="Transactions.delete('${t.id || t.ID}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>`).join('');
      },

      async delete(id) {
        const result = await Util.confirm({
          title: '確定刪除？',
          text: '此操作無法復原',
          confirmText: '刪除',
          confirmColor: '#dc3545'
        });

        if (result.isConfirmed) {
          try {
            await API.call('deleteTransaction', { id });
            Util.showToast('success', '交易已刪除');
            this.load();
            Dashboard.refresh();
          } catch (error) {
            console.error('Delete transaction failed:', error);
          }
        }
      }
    };

    // ================== 交易 UI ==================
    const TransactionUI = {
      currentId: null,
      categories: { '收入': ['會費', '捐款', '補助', '其他收入'], '支出': ['活動費用', '行政費用', '設備費用', '其他支出'] },

      async open(id = null) {
        this.currentId = id;
        const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
        
        if (id) {
          document.getElementById('transactionModalTitle').textContent = '編輯交易';
          await this.loadTransaction(id);
        } else {
          document.getElementById('transactionModalTitle').textContent = '新增交易';
          this.resetForm();
        }

        this.updateCategories();
        modal.show();
      },

      async loadTransaction(id) {
        try {
          const transaction = Transactions.data.find(t => (t.id || t.ID) === id);
          if (transaction) {
            this.populateForm(transaction);
          }
        } catch (error) {
          console.error('Load transaction failed:', error);
        }
      },

      populateForm(data) {
        document.getElementById('transactionId').value = data.id || data.ID || '';
        document.getElementById('transactionDate').value = data.date || data['日期'] || Util.today();
        document.getElementById('transactionType').value = data.type || data['類型'] || '';
        document.getElementById('transactionCategory').value = data.category || data['類別'] || '';
        document.getElementById('transactionAmount').value = data.amount || data['金額'] || '';
        document.getElementById('transactionCounterparty').value = data.counterparty || data['科目'] || '';
        document.getElementById('transactionAccount').value = data.account || data['帳戶'] || '';
        document.getElementById('transactionDescription').value = data.description || data['摘要'] || '';
        document.getElementById('transactionReceiptNumber').value = data.receiptNumber || data['收據編號'] || '';
        document.getElementById('transactionVoucherNumber').value = data.voucherNumber || data['憑證編號'] || '';
        
        this.updateCategories();
      },

      resetForm() {
        document.getElementById('transactionForm').reset();
        document.getElementById('transactionId').value = '';
        document.getElementById('transactionDate').value = Util.today();
      },

      updateCategories() {
        const type = document.getElementById('transactionType').value;
        const categorySelect = document.getElementById('transactionCategory');
        
        if (!type) {
          categorySelect.innerHTML = '<option value="">請選擇類型後顯示</option>';
          return;
        }

        const categories = this.categories[type] || [];
        categorySelect.innerHTML = '<option value="">請選擇類別</option>' +
          categories.map(c => `<option value="${c}">${c}</option>`).join('');
      },

      async save() {
        const form = document.getElementById('transactionForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const data = {
          id: document.getElementById('transactionId').value || null,
          date: document.getElementById('transactionDate').value,
          type: document.getElementById('transactionType').value,
          category: document.getElementById('transactionCategory').value,
          amount: parseFloat(document.getElementById('transactionAmount').value),
          counterparty: document.getElementById('transactionCounterparty').value,
          account: document.getElementById('transactionAccount').value,
          description: document.getElementById('transactionDescription').value,
          receiptNumber: document.getElementById('transactionReceiptNumber').value,
          voucherNumber: document.getElementById('transactionVoucherNumber').value
        };

        try {
          if (data.id) {
            await API.call('updateTransaction', data);
            Util.showToast('success', '交易已更新');
          } else {
            await API.call('addTransaction', data);
            Util.showToast('success', '交易已新增');
          }

          bootstrap.Modal.getInstance(document.getElementById('transactionModal')).hide();
          Transactions.load();
          Dashboard.refresh();
        } catch (error) {
          console.error('Save transaction failed:', error);
        }
      }
    };

    // ================== 其他 UI 物件 ==================
    const MemberUI = { open: () => Util.showToast('info', '會員管理功能開發中') };
    const ActivityUI = { open: () => Util.showToast('info', '活動管理功能開發中') };
    const AccountUI = { open: () => Util.showToast('info', '帳戶管理功能開發中') };
    const SettingsUI = { open: () => Util.showToast('info', '系統設定功能開發中') };
    const GlobalSearch = { exec: () => Util.showToast('info', '全域搜尋功能開發中') };
    const DataPort = { 
      exportAll: () => Util.showToast('info', '匯出功能開發中'),
      importAll: () => Util.showToast('info', '匯入功能開發中')
    };
    const About = { show: () => Util.showToast('info', '關於功能開發中') };

    // ================== 事件監聽器 ==================
    document.addEventListener('DOMContentLoaded', function() {
      AppLayout.showSection('dashboard');

      window.addEventListener('resize', function() {
        if (window.innerWidth >= 992) {
          document.getElementById('sidebar').classList.remove('show');
        }
      });

      document.addEventListener('click', function(e) {
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.querySelector('[onclick*="toggleSidebar"]');
        
        if (window.innerWidth < 992 && 
            sidebar.classList.contains('show') && 
            !sidebar.contains(e.target) && 
            !toggleBtn.contains(e.target)) {
          AppLayout.toggleSidebar(false);
        }
      });

      setTimeout(() => {
        Dashboard.refresh();
      }, 100);
    });

    // ================== 全域函數 ==================
    window.AppLayout = AppLayout;
    window.TransactionUI = TransactionUI;
    window.MemberUI = MemberUI;
    window.ActivityUI = ActivityUI;
    window.AccountUI = AccountUI;
    window.SettingsUI = SettingsUI;
    window.Transactions = Transactions;
    window.GlobalSearch = GlobalSearch;
    window.DataPort = DataPort;
    window.About = About;
    </script>
  </body>
  </html>
