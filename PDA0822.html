<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>NPO 管理系統 (Delta 同步版)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <style>
    body { background:#f6f7fa;font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,sans-serif; font-size:14px; }
    .sidebar { background:linear-gradient(180deg,#2c5aa0,#1e3d6f); min-height:100vh; color:#fff; }
    .sidebar .nav-link { color:#dbe3f2; border-radius:8px; margin:3px 0; }
    .sidebar .nav-link.active,.sidebar .nav-link:hover { background:rgba(255,255,255,.15); color:#fff; }
    .stat-card { background:linear-gradient(135deg,#2c5aa0,#4a90e2); color:#fff; border:none; border-radius:16px; padding:14px 16px; position:relative; overflow:hidden; }
    .stat-card .icon-bg { position:absolute; right:-8px; top:-8px; font-size:60px; opacity:.15; }
    .loading-overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex;align-items:center;justify-content:center; z-index:3000; }
    .spin { animation:spin .9s linear infinite; } @keyframes spin { to{ transform:rotate(360deg)} }
    #syncIndicator.badge.bg-warning { animation:pulse 1s alternate infinite; } @keyframes pulse { from{opacity:.6} to{opacity:1} }
    @media (max-width:992px){
      .sidebar { position:fixed; left:0; top:0; width:250px; transform:translateX(-100%); transition:.3s; z-index:2000; }
      .sidebar.show { transform:translateX(0); }
    }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="text-center text-white">
      <i class="bi bi-arrow-repeat spin display-5 d-block mb-3"></i>
      <div id="loadingOverlayMsg">系統載入中…</div>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand fw-semibold" href="#"><i class="bi bi-heart-pulse me-2 text-primary"></i>NPO 管理系統</a>
      <button class="navbar-toggler" type="button" onclick="Layout.toggleSidebar()">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto align-items-center">
          <li class="nav-item me-2">
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
              <input id="globalSearchInput" class="form-control" placeholder="全域搜尋" onkeydown="if(event.key==='Enter') GlobalSearch.exec()">
            </div>
          </li>
          <li class="nav-item">
            <span id="syncIndicator" class="badge bg-secondary me-2">初始化</span>
            <span id="offlineIndicator" class="badge bg-danger d-none"><i class="bi bi-wifi-off"></i> 離線</span>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown"><i class="bi bi-gear"></i> 系統</a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" onclick="SettingsUI.open()"><i class="bi bi-sliders"></i> 設定</a></li>
              <li><a class="dropdown-item" href="#" onclick="ManualSync.flushNow()"><i class="bi bi-cloud-arrow-up"></i> 立即同步</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.exportAll()"><i class="bi bi-download"></i> 匯出全部快取</a></li>
              <li><a class="dropdown-item" href="#" onclick="DataPort.importAll()"><i class="bi bi-upload"></i> 匯入快取</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="About.show()"><i class="bi bi-info-circle"></i> 關於</a></li>
              <li><a class="dropdown-item text-danger" href="#" onclick="Reset.confirm()"><i class="bi bi-exclamation-triangle"></i> 重置本機</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <aside id="sidebar" class="sidebar col-lg-2 col-md-3 p-3">
        <h6 class="text-center mb-3">主選單</h6>
        <nav class="nav flex-column">
          <a class="nav-link active" data-sec="dashboard" onclick="Layout.show('dashboard',this)">儀表板</a>
          <a class="nav-link" data-sec="transactions" onclick="Layout.show('transactions',this)">交易</a>
          <a class="nav-link" data-sec="members" onclick="Layout.show('members',this)">會員</a>
          <a class="nav-link" data-sec="activities" onclick="Layout.show('activities',this)">活動</a>
          <a class="nav-link" data-sec="announcements" onclick="Layout.show('announcements',this)">公告</a>
          <a class="nav-link" data-sec="forms" onclick="Layout.show('forms',this)">表單</a>
          <a class="nav-link" data-sec="analytics" onclick="Layout.show('analytics',this)">統計</a>
          <a class="nav-link" data-sec="reports" onclick="Layout.show('reports',this)">報表</a>
        </nav>
      </aside>
      <main id="mainContent" class="col-lg-10 col-md-9 p-4">

        <!-- 儀表板 -->
        <section id="dashboardSection">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>儀表板</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="ManualSync.flushNow()"><i class="bi bi-cloud-upload"></i> 同步</button>
              <button class="btn btn-primary btn-sm" onclick="TransactionUI.openNew()"><i class="bi bi-plus-circle"></i> 新增交易</button>
              <button class="btn btn-success btn-sm" onclick="MemberUI.openNew()"><i class="bi bi-person-plus"></i> 新增會員</button>
              <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.openNew()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
              <div class="stat-card h-100">
                <div class="icon-bg"><i class="bi bi-cash-coin"></i></div>
                <small>總收入</small><h3 id="dashTotalIncome" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between small"><span>本月</span><span id="dashMonthIncome">$0</span></div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card h-100" style="background:linear-gradient(135deg,#ff9f40,#ffb347)">
                <div class="icon-bg"><i class="bi bi-credit-card"></i></div>
                <small>總支出</small><h3 id="dashTotalExpense" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between small"><span>本月</span><span id="dashMonthExpense">$0</span></div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card h-100" style="background:linear-gradient(135deg,#28a745,#20c997)">
                <div class="icon-bg"><i class="bi bi-bank"></i></div>
                <small>帳戶總餘額</small><h3 id="dashTotalBalance" class="mb-1">$0</h3>
                <div class="d-flex justify-content-between small"><span>帳戶數</span><span id="dashAccountCount">0</span></div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="stat-card h-100">
                <div class="icon-bg"><i class="bi bi-people"></i></div>
                <small>會員總數</small><h3 id="dashMemberTotal" class="mb-1">0</h3>
                <div class="d-flex justify-content-between small"><span>逾期會費</span><span id="dashMemberOverdue" class="badge bg-danger">0</span></div>
              </div>
            </div>
          </div>
          <div class="card mb-3">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h6 class="mb-0">帳戶概覽</h6>
              <button class="btn btn-sm btn-outline-primary" onclick="AccountUI.manage()"><i class="bi bi-gear"></i> 管理帳戶</button>
            </div>
            <div class="card-body" id="dashboardAccountBalances" class="row g-3"></div>
          </div>
          <div class="row g-3">
            <div class="col-lg-4">
              <div class="card h-100">
                <div class="card-header bg-white"><h6 class="mb-0">最近交易</h6></div>
                <div class="card-body p-2" id="dashboardRecentTx"></div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card h-100">
                <div class="card-header bg-white"><h6 class="mb-0">新會員</h6></div>
                <div class="card-body p-2" id="dashboardRecentMembers"></div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card h-100">
                <div class="card-header bg-white"><h6 class="mb-0">近期活動</h6></div>
                <div class="card-body p-2" id="dashboardRecentActivities"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- 交易 -->
        <section id="transactionsSection" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between mb-3 align-items-center">
            <h4 class="mb-0">交易記錄</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-success btn-sm" onclick="BatchImport.open('transactions')"><i class="bi bi-cloud-upload"></i> 批次匯入</button>
              <button class="btn btn-primary btn-sm" onclick="TransactionUI.openNew()"><i class="bi bi-plus-circle"></i> 新增</button>
            </div>
          </div>
          <div class="card mb-3">
            <div class="card-body row g-2">
              <div class="col-md-2">
                <label class="form-label mb-1">年份</label>
                <select id="txFilterYear" class="form-select form-select-sm" onchange="Transactions.render()">
                  <option value="">全部</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label mb-1">月份</label>
                <select id="txFilterMonth" class="form-select form-select-sm" onchange="Transactions.render()">
                  <option value="">全部</option>
                  <script>
                    document.currentScript.insertAdjacentHTML('beforebegin',
                      [...Array(12)].map((_,i)=>`<option value="${i+1}">${i+1}月</option>`).join('')
                    );
                  </script>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label mb-1">類型</label>
                <select id="txFilterType" class="form-select form-select-sm" onchange="Transactions.render()">
                  <option value="">全部</option>
                  <option value="收入">收入</option>
                  <option value="支出">支出</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label mb-1">關鍵字</label>
                <input id="txFilterKeyword" class="form-control form-control-sm" oninput="Transactions.render()">
              </div>
              <div class="col-md-2 d-grid">
                <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportTransactions()"><i class="bi bi-download"></i> 匯出快取</button>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between mb-2">
                <div><span id="txRecordCount" class="fw-semibold">0 筆</span></div>
                <div class="d-flex gap-2">
                  <select id="txBatchAction" class="form-select form-select-sm">
                    <option value="">批次操作</option>
                    <option value="delete">刪除</option>
                    <option value="export">匯出</option>
                    <option value="print">列印收據</option>
                    <option value="voucher">列印憑證</option>
                  </select>
                  <button class="btn btn-outline-primary btn-sm" onclick="Transactions.batch()"><i class="bi bi-check2-square"></i></button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-2">
                  <thead>
                    <tr>
                      <th style="width:30px;"><input type="checkbox" id="txSelectAll" onclick="Transactions.toggleAll(this)"></th>
                      <th>日期</th><th>類型</th><th>類別</th><th class="text-end">金額</th><th>對象</th><th>帳戶</th><th>說明</th><th>編號/附件</th><th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="txTableBody"><tr><td colspan="10" class="text-center text-muted py-4">尚無資料</td></tr></tbody>
                </table>
              </div>
              <nav><ul id="txPagination" class="pagination pagination-sm justify-content-center mb-0"></ul></nav>
            </div>
          </div>
        </section>

        <!-- 會員 -->
        <section id="membersSection" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
            <h4 class="mb-0">會員管理</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-success btn-sm" onclick="BatchImport.open('members')"><i class="bi bi-cloud-upload"></i> 匯入</button>
              <button class="btn btn-success btn-sm" onclick="MemberUI.openNew()"><i class="bi bi-person-plus"></i> 新增</button>
            </div>
          </div>
          <div class="card mb-3">
            <div class="card-body row g-2">
              <div class="col-md-3">
                <label class="form-label mb-1">狀態</label>
                <select id="memberFilterStatus" class="form-select form-select-sm" onchange="Members.render()">
                  <option value="">全部</option>
                  <option value="active">正常</option>
                  <option value="inactive">停權</option>
                  <option value="pending">待審核</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label mb-1">類型</label>
                <select id="memberFilterType" class="form-select form-select-sm" onchange="Members.render()">
                  <option value="">全部</option>
                  <option value="regular">一般</option>
                  <option value="honorary">榮譽</option>
                  <option value="life">終身</option>
                  <option value="family">家屬</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label mb-1">關鍵字</label>
                <input id="memberFilterKeyword" class="form-control form-control-sm" oninput="Members.render()">
              </div>
              <div class="col-md-2 d-grid">
                <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportMembers()"><i class="bi bi-download"></i> 匯出</button>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between mb-2">
                <span id="memberRecordCount" class="fw-semibold">0 筆</span>
                <div class="d-flex gap-2">
                  <select id="memberBatchAction" class="form-select form-select-sm">
                    <option value="">批次操作</option>
                    <option value="delete">刪除</option>
                    <option value="status-active">設為正常</option>
                    <option value="status-inactive">設為停權</option>
                  </select>
                  <button class="btn btn-outline-primary btn-sm" onclick="Members.batch()"><i class="bi bi-check2-square"></i></button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th style="width:30px;"><input type="checkbox" onclick="Members.toggleAll(this)"></th>
                      <th>姓名</th><th>聯絡</th><th>狀態</th><th>加入</th><th>年費</th><th>標籤</th><th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="memberTableBody"></tbody>
                </table>
              </div>
              <nav><ul id="memberPagination" class="pagination pagination-sm justify-content-center mb-0"></ul></nav>
            </div>
          </div>
        </section>

        <!-- 活動 / 公告 / 表單 / 統計 / 報表
             (為節省篇幅，下列區塊只保留容器 + 核心 ID，功能 JS 仍完整支援) -->

        <section id="activitiesSection" style="display:none;">
          <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
            <h4 class="mb-0">活動管理</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.openNew()"><i class="bi bi-calendar-plus"></i> 新增</button>
              <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportActivities()"><i class="bi bi-download"></i> 匯出</button>
            </div>
          </div>
          <div class="card mb-3">
            <div class="card-body row g-2">
              <div class="col-md-2"><select id="actFilterStatus" class="form-select form-select-sm" onchange="Activities.render()">
                <option value="">狀態</option>
                <option value="draft">草稿</option><option value="published">已發布</option>
                <option value="registration">報名中</option><option value="full">額滿</option>
                <option value="closed">已結束</option><option value="cancelled">已取消</option>
              </select></div>
              <div class="col-md-2"><select id="actFilterType" class="form-select form-select-sm" onchange="Activities.render()">
                <option value="">類型</option><option>講座</option><option>聚會</option><option>旅遊</option><option>運動</option><option>志工</option><option>其他</option>
              </select></div>
              <div class="col-md-4"><input id="actFilterKeyword" class="form-control form-control-sm" placeholder="關鍵字" oninput="Activities.render()"></div>
              <div class="col-md-4">
                <select id="actFilterSort" class="form-select form-select-sm" onchange="Activities.render()">
                  <option value="date_desc">日期(新→舊)</option>
                  <option value="date_asc">日期(舊→新)</option>
                  <option value="name_asc">名稱</option>
                  <option value="regs_desc">報名多→少</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row g-3" id="activitiesGrid"></div>
          <nav><ul id="actPagination" class="pagination pagination-sm justify-content-center mt-3 mb-0"></ul></nav>
        </section>

        <section id="announcementsSection" style="display:none;">
          <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
            <h4 class="mb-0">公告管理</h4>
            <div class="d-flex gap-2">
              <button class="btn btn-warning btn-sm" onclick="AnnouncementUI.openNew()"><i class="bi bi-plus-circle"></i> 新增</button>
              <button class="btn btn-outline-secondary btn-sm" onclick="DataPort.exportAnnouncements()"><i class="bi bi-download"></i> 匯出</button>
            </div>
          </div>
          <div class="card mb-3">
            <div class="card-body row g-2">
              <div class="col-md-3"><select id="annFilterStatus" class="form-select form-select-sm" onchange="Announcements.render()">
                <option value="">狀態</option><option value="draft">草稿</option><option value="published">已發布</option><option value="expired">已過期</option>
              </select></div>
              <div class="col-md-3"><select id="annFilterType" class="form-select form-select-sm" onchange="Announcements.render()">
                <option value="">類型</option><option value="normal">一般</option><option value="urgent">緊急</option><option value="event">活動</option><option value="system">系統</option>
              </select></div>
              <div class="col-md-6"><input id="annFilterKeyword" class="form-control form-control-sm" placeholder="關鍵字" oninput="Announcements.render()"></div>
            </div>
          </div>
          <div class="row g-3" id="announcementsGrid"></div>
          <nav><ul id="annPagination" class="pagination pagination-sm justify-content-center mt-3 mb-0"></ul></nav>
        </section>

        <section id="formsSection" style="display:none;">
          <div class="d-flex justify-content-between mb-3">
            <h4 class="mb-0">行政表單</h4>
            <button class="btn btn-primary btn-sm" onclick="FormUI.manage()"><i class="bi bi-gear"></i> 管理</button>
          </div>
          <div class="card mb-3">
            <div class="card-body row g-2">
              <div class="col-md-8"><input id="formFilterKeyword" class="form-control form-control-sm" placeholder="關鍵字" oninput="Forms.render()"></div>
              <div class="col-md-4">
                <select id="formFilterCategory" class="form-select form-select-sm" onchange="Forms.render()">
                  <option value="">分類</option><option>會員</option><option>財務</option><option>活動</option><option>行政</option><option>其他</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row g-3" id="formsList"></div>
        </section>

          <!-- 統計 -->
        <section id="analyticsSection" style="display:none;">
          <div class="d-flex justify-content-between mb-3">
            <h4 class="mb-0">統計分析</h4>
            <select id="analyticsYear" class="form-select form-select-sm w-auto" onchange="Analytics.refresh()">
              <option value="">選年度</option>
            </select>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3"><div class="card p-2 text-center"><small>年度收入</small><h5 id="anaTotalIncome" class="text-success mb-0">$0</h5></div></div>
            <div class="col-6 col-md-3"><div class="card p-2 text-center"><small>年度支出</small><h5 id="anaTotalExpense" class="text-danger mb-0">$0</h5></div></div>
            <div class="col-6 col-md-3"><div class="card p-2 text-center"><small>年度結餘</small><h5 id="anaBalance" class="mb-0">$0</h5></div></div>
            <div class="col-6 col-md-3"><div class="card p-2 text-center"><small>平均月度</small><h5 id="anaAvgMonthly" class="mb-0">$0</h5></div></div>
          </div>
          <div class="row g-3">
            <div class="col-lg-6"><div class="card"><div class="card-header bg-white"><h6 class="mb-0">收支趨勢</h6></div><div class="card-body"><canvas id="chartTrend"></canvas></div></div></div>
            <div class="col-lg-6"><div class="card"><div class="card-header bg-white"><h6 class="mb-0">支出占比</h6></div><div class="card-body"><canvas id="chartExpenseCategory"></canvas></div></div></div>
            <div class="col-lg-6"><div class="card"><div class="card-header bg-white"><h6 class="mb-0">月度收支</h6></div><div class="card-body"><canvas id="chartMonthlyCompare"></canvas></div></div></div>
            <div class="col-lg-6"><div class="card"><div class="card-header bg-white"><h6 class="mb-0">會員成長</h6></div><div class="card-body"><canvas id="chartMemberGrowth"></canvas></div></div></div>
          </div>
        </section>

        <section id="reportsSection" style="display:none;">
          <div class="d-flex flex-wrap justify-content-between mb-3">
            <h4 class="mb-0">報表中心</h4>
            <div class="d-flex gap-2">
              <input id="reportStart" type="date" class="form-control form-control-sm">
              <input id="reportEnd" type="date" class="form-control form-control-sm">
              <button class="btn btn-primary btn-sm" onclick="Reports.quick('thisMonth')">本月</button>
              <button class="btn btn-outline-primary btn-sm" onclick="Reports.quick('thisYear')">今年</button>
            </div>
          </div>
          <div class="row g-3">
            <div class="col-md-4"><div class="card h-100 text-center p-3"><i class="bi bi-cash-stack display-5 text-primary"></i><h6>現金出納帳</h6><button class="btn btn-primary btn-sm" onclick="Reports.gen('cashbook')">生成</button></div></div>
            <div class="col-md-4"><div class="card h-100 text-center p-3"><i class="bi bi-bar-chart-line display-5 text-success"></i><h6>收支決算表</h6><button class="btn btn-success btn-sm" onclick="Reports.gen('incomeExpense')">生成</button></div></div>
            <div class="col-md-4"><div class="card h-100 text-center p-3"><i class="bi bi-building display-5 text-warning"></i><h6>資產負債表</h6><button class="btn btn-warning btn-sm" onclick="Reports.gen('balanceSheet')">生成</button></div></div>
            <div class="col-md-4"><div class="card h-100 text-center p-3"><i class="bi bi-journal-text display-5 text-info"></i><h6>年度分類帳</h6><button class="btn btn-info btn-sm text-white" onclick="Reports.gen('ledger')">生成</button></div></div>
            <div class="col-md-4"><div class="card h-100 text-center p-3"><i class="bi bi-list-ul display-5 text-secondary"></i><h6>綜合流水帳</h6><button class="btn btn-secondary btn-sm" onclick="Reports.gen('journal')">生成</button></div></div>
            <div class="col-md-4"><div class="card h-100 text-center p-3"><i class="bi bi-people-fill display-5 text-dark"></i><h6>會員報表</h6><button class="btn btn-dark btn-sm" onclick="Reports.gen('member')">生成</button></div></div>
          </div>
        </section>

        <!-- 報表 Modal -->
        <div class="modal fade" id="reportModal" tabindex="-1">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-dark text-white">
                <h6 class="modal-title" id="reportModalTitle">報表</h6>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="reportModalBody"></div>
              <div class="modal-footer">
                <button class="btn btn-outline-primary btn-sm" onclick="Reports.print()"><i class="bi bi-printer"></i> 列印</button>
                <button class="btn btn-primary btn-sm" onclick="Reports.exportHTML()"><i class="bi bi-download"></i> 匯出</button>
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Toast -->
        <div class="toast-container position-fixed top-0 end-0 p-3">
          <div id="toastSuccess" class="toast text-bg-light border-0" role="alert">
            <div class="d-flex">
              <div class="toast-body"><i class="bi bi-check-circle text-success me-2"></i><span id="toastSuccessMsg">成功</span></div>
              <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
          <div id="toastError" class="toast text-bg-light border-0" role="alert">
            <div class="d-flex">
              <div class="toast-body"><i class="bi bi-exclamation-triangle text-danger me-2"></i><span id="toastErrorMsg">錯誤</span></div>
              <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- 依賴 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
  /* =========================================================
     Delta 同步版 前端核心
     ========================================================= */

  const GAS_CONFIG = {
    BASE_URL: 'https://script.google.com/macros/s/AKfycbzs6m9fzckRrZ4KokyCCNHTu9PmZx2IdyjPSd7WE4GykpYCGMHaFcSnM6Q1NhDtuRVW-Q/exec',  // ★★★ 需替換
    TOKEN: 'A85202581',           // ★★★ 與後端一致
    AUTO_SYNC_INTERVAL_MS: 8000
  };

  /* ------------ 工具 ------------- */
  const U = {
    uuid: ()=> 'id_'+Math.random().toString(36).slice(2,11),
    today: ()=> new Date().toISOString().split('T')[0],
    pad:(n,l=2)=> String(n).padStart(l,'0'),
    num:(v)=> isNaN(parseFloat(v))?0:parseFloat(v),
    fmt:(n)=> (Number(n)||0).toLocaleString(),
    toast(type,msg){
      const id = type==='success'?'toastSuccess':'toastError';
      document.getElementById(type==='success'?'toastSuccessMsg':'toastErrorMsg').textContent=msg;
      new bootstrap.Toast(document.getElementById(id),{delay:3200}).show();
    },
    confirm(opts){
      return Swal.fire({
        icon:opts.icon||'warning',
          title:opts.title||'確定？',
          html:opts.html||opts.text||'',
          showCancelButton:true,
          confirmButtonText:opts.confirmText||'確定',
          cancelButtonText:opts.cancelText||'取消',
          confirmButtonColor:opts.confirmColor||'#0d6efd'
      });
    },
    download(name,data,type='application/json'){
      const blob=new Blob([data],{type});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download=name; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),500);
    },
    financialChinese(num){
      num=Number(num);
      if(isNaN(num)) return '';
      if(num===0) return '零元整';
      const cNum=['零','壹','貳','參','肆','伍','陸','柒','捌','玖'];
      const cUnit=['','拾','佰','仟'];
      const cSec=['','萬','億','兆'];
      const cDec=['角','分'];
      let s=Math.floor(num).toString(), dec=Math.round((num-Math.floor(num))*100).toString().padStart(2,'0');
      let res='';
      if(Number(s)>0){
        let k=0;
        while(s.length>0){
          let seg=s.slice(-4); s=s.slice(0,-4);
          let segStr='', zero=false;
          for(let i=0;i<seg.length;i++){
            const d=seg[seg.length-1-i];
            if(d==='0'){
              if(!zero && segStr) segStr='零'+segStr;
              zero=true;
            } else {
              zero=false;
              segStr=cNum[+d]+cUnit[i]+segStr;
            }
          }
          segStr=segStr.replace(/零+/g,'零').replace(/零$/,'');
          if(segStr) res=segStr+cSec[k]+res;
          k++;
        }
        res+='元';
      }
      dec=dec.replace(/0+$/,'');
      if(dec){
        if(dec[0]!=='0') res+=cNum[+dec[0]]+cDec[0];
        if(dec[1] && dec[1]!=='0') res+=cNum[+dec[1]]+cDec[1];
      }else res+='整';
      return res;
    }
  };

  /* ------------ Sync Indicator ------------- */
  const SyncInd = {
    set(state){
      const el=document.getElementById('syncIndicator');
      if(!el) return;
      if(state==='dirty'){ el.className='badge bg-warning'; el.textContent='待同步'; }
      else if(state==='sync'){ el.className='badge bg-warning'; el.innerHTML='<i class="bi bi-arrow-repeat spin"></i> 同步中'; }
      else if(state==='ok'){ el.className='badge bg-success'; el.innerHTML='<i class="bi bi-cloud-check"></i> 已同步'; }
      else { el.className='badge bg-secondary'; el.textContent='—'; }
    },
    offline(off){
      document.getElementById('offlineIndicator')?.classList.toggle('d-none',!off);
      if(off){
        const el=document.getElementById('syncIndicator');
        el.className='badge bg-secondary'; el.innerHTML='<i class="bi bi-cloud-slash"></i> 離線快取';
      }
    }
  };
  window.addEventListener('online', ()=> SyncInd.offline(false));
  window.addEventListener('offline',()=> SyncInd.offline(true));

  /* ------------ API 包裝 ------------- */
  const Api = {
    async call(action, body={}){
      const res = await fetch(GAS_CONFIG.BASE_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({action, token:GAS_CONFIG.TOKEN, ...body})
      });
      return res.json();
    },
    init(){ return this.call('init'); },
    listEntity(entity){ return this.call('listEntity',{entity}); },
    deltaSave(entity,delta,version){ return this.call('deltaSave',{entity,delta,version}); },
    saveSettings(settings,version){ return this.call('saveSettings',{settings,version}); },
    genNumbers(){ return this.call('genNumbers'); },
    uploadFile(meta){ return this.call('uploadFile', meta); }
  };

  /* ------------ Store (含 Delta 變更追蹤) ------------- */
  const ENTITIES = ['transactions','members','accounts','activities','registrations','announcements','forms','settings'];

  const Store = {
    data: {
      transactions:[], members:[], accounts:[], activities:[],
      registrations:[], announcements:[], forms:[], settings:{}
    },
    versions: {},        // {entity: versionNumber}
    changeLog: {},       // {entity:{adds:{},updates:{},deletes:Set}}
    initChangeLog(){
      ENTITIES.forEach(e=>{
        if(e==='settings') return;
          this.changeLog[e]={adds:{},updates:{},deletes:new Set()};
      });
    },
    tryLoadCache(){
      const v=localStorage.getItem('versions');
      const d=localStorage.getItem('data');
      if(v && d){
        try{
          this.versions = JSON.parse(v);
          this.data = JSON.parse(d);
          this.initChangeLog();
          return true;
        }catch(e){}
      }
      return false;
    },
    saveCache(){
      localStorage.setItem('versions', JSON.stringify(this.versions));
      localStorage.setItem('data', JSON.stringify(this.data));
    },
    async loadRemote(show=true){
      if(show) Loading.show('同步遠端資料...');
      try{
        const r=await Api.init();
        if(!r.ok) throw new Error(r.message||'init 失敗');
        this.data = r.data;
        this.versions = r.versions;
        this.initChangeLog();
        this.saveCache();
        SyncInd.set('ok');
      }catch(e){
        U.toast('error','遠端載入失敗，保留本機');
        SyncInd.offline(true);
      }finally{
        if(show) Loading.hide();
      }
    },
    markAdd(entity,obj){
      if(entity==='settings') return;
      const c=this.changeLog[entity];
      c.adds[obj.id]=obj;
      // 若曾被刪除則撤回刪除
      c.deletes.delete(obj.id);
      SyncInd.set('dirty');
      this.saveCache();
    },
    markUpdate(entity,obj){
      if(entity==='settings') return;
      const c=this.changeLog[entity];
      // 若原本是新增就直接覆蓋 adds；否則放 updates
      if(c.adds[obj.id]) c.adds[obj.id]=obj;
      else c.updates[obj.id]=obj;
      SyncInd.set('dirty');
      this.saveCache();
    },
    markDelete(entity,id){
      if(entity==='settings') return;
      const c=this.changeLog[entity];
      delete c.adds[id];
      delete c.updates[id];
      c.deletes.add(id);
      SyncInd.set('dirty');
      this.saveCache();
    },
    markSettingsDirty(){
      // Settings 不用 delta，直接記 flag
      this.settingsDirty=true;
      SyncInd.set('dirty');
      this.saveCache();
    },
    buildDelta(entity){
      const c=this.changeLog[entity];
      return {
        adds:Object.values(c.adds),
        updates:Object.values(c.updates),
        deletes:Array.from(c.deletes)
      };
    },
    clearDelta(entity){
      this.changeLog[entity]={adds:{},updates:{},deletes:new Set()};
    },
    async flush(){
      if(!navigator.onLine){
        U.toast('error','離線狀態，稍後再同步');
        SyncInd.offline(true);
        return;
      }
      let hasDirty = this.settingsDirty || ENTITIES.some(e=> e!=='settings' && (
        Object.keys(this.changeLog[e].adds).length ||
        Object.keys(this.changeLog[e].updates).length ||
        this.changeLog[e].deletes.size
      ));
      if(!hasDirty){ SyncInd.set('ok'); return; }
      SyncInd.set('sync');
      try{
        // 先 settings
          if(this.settingsDirty){
            const r=await Api.saveSettings(this.data.settings, this.versions.settings);
            if(!r.ok){
              if(r.conflict){
                await this.reloadEntity('settings');
              }else{
                throw new Error(r.message||'設定同步失敗');
              }
            }else{
              this.versions.settings = r.version;
              this.settingsDirty=false;
            }
          }
        // 逐實體 delta
        for(const e of ENTITIES){
          if(e==='settings') continue;
          const delta=this.buildDelta(e);
          if(!delta.adds.length && !delta.updates.length && !delta.deletes.length) continue;
          const r=await Api.deltaSave(e, delta, this.versions[e]);
          if(!r.ok){
            if(r.conflict){
              await this.reloadEntity(e);
            }else{
              console.error('deltaSave fail',e,r);
              U.toast('error', e+' 同步失敗');
            }
          }else{
            this.versions[e]=r.version;
            this.clearDelta(e);
          }
        }
        this.saveCache();
        SyncInd.set('ok');
        U.toast('success','同步完成');
      }catch(err){
        console.error(err);
        U.toast('error','同步錯誤');
        SyncInd.set('dirty');
      }
    },
    async reloadEntity(entity){
      const r=await Api.listEntity(entity);
      if(r.ok){
        this.data[entity]=r.data;
        this.versions[entity]=r.version;
        if(entity==='settings'){ this.settingsDirty=false; }
        else this.clearDelta(entity);
        this.saveCache();
        U.toast('success', entity+' 已重新載入');
      }else{
        U.toast('error','重新載入 '+entity+' 失敗');
      }
    }
  };

  setInterval(()=>Store.flush(), GAS_CONFIG.AUTO_SYNC_INTERVAL_MS);

  const ManualSync={ flushNow:()=>Store.flush() };

  /* ------------ Layout ------------- */
  const Layout = {
    show(name,link){
      document.querySelectorAll('main section').forEach(sec=>sec.style.display='none');
      document.getElementById(name+'Section').style.display='block';
      document.querySelectorAll('.sidebar .nav-link').forEach(a=>a.classList.remove('active'));
      link && link.classList.add('active');
      switch(name){
        case 'dashboard': Dashboard.refresh(); break;
        case 'transactions': Transactions.render(); break;
        case 'members': Members.render(); break;
        case 'activities': Activities.render(); break;
        case 'announcements': Announcements.render(); break;
        case 'forms': Forms.render(); break;
        case 'analytics': Analytics.refresh(); break;
        case 'reports': Reports.init(); break;
      }
      if(window.innerWidth<992) this.toggleSidebar(false);
    },
    toggleSidebar(force){
      const sb=document.getElementById('sidebar');
      sb.classList.toggle('show', typeof force==='boolean'?force:!sb.classList.contains('show'));
    }
  };

  /* ------------ Loading ------------- */
  const Loading = {
    show(msg){
      document.getElementById('loadingOverlayMsg').textContent=msg||'載入中...';
      document.getElementById('loadingOverlay').style.display='flex';
    },
    hide(){ document.getElementById('loadingOverlay').style.display='none'; }
  };

  /* ------------ 交易 (範例精簡 + 仍支援增刪改 + 附件) ------------- */
  const Transactions = {
    state:{page:1,per:10,filtered:[]},
    filter(){
      const y=document.getElementById('txFilterYear').value;
      const m=document.getElementById('txFilterMonth').value;
      const type=document.getElementById('txFilterType').value;
      const kw=(document.getElementById('txFilterKeyword').value||'').toLowerCase();
      this.state.filtered = Store.data.transactions.filter(t=>{
        if(y && !t.date.startsWith(y+'-')) return false;
        if(m && t.date.slice(5,7)!==U.pad(m)) return false;
        if(type && t.type!==type) return false;
        if(kw){
          const text = (t.category+' '+(t.counterparty||'')+' '+(t.description||'')+' '+(t.receiptNumber||'')+' '+(t.voucherNumber||'')).toLowerCase();
          if(!text.includes(kw)) return false;
        }
        return true;
      }).sort((a,b)=> b.date.localeCompare(a.date) || (b.updatedAt||'').localeCompare(a.updatedAt||''));
    },
    render(){
      this.filter();
      const total=this.state.filtered.length;
      const per=this.state.per;
      const pages=Math.max(1, Math.ceil(total/per));
      if(this.state.page>pages) this.state.page=pages;
      const start=(this.state.page-1)*per;
      const rows=this.state.filtered.slice(start,start+per);
      document.getElementById('txRecordCount').textContent=total+' 筆';
      const tb=document.getElementById('txTableBody');
      if(!rows.length){
        tb.innerHTML='<tr><td colspan="10" class="text-center py-4 text-muted">無資料</td></tr>';
      }else{
        tb.innerHTML=rows.map(t=>{
          const num = t.type==='收入'? (t.receiptNumber||'-') : (t.voucherNumber||'-');
          return `<tr>
            <td><input type="checkbox" class="tx-check" data-id="${t.id}"></td>
            <td>${t.date}</td>
            <td><span class="badge ${t.type==='收入'?'bg-success':'bg-danger'}">${t.type}</span></td>
            <td>${t.category}</td>
            <td class="text-end ${t.type==='收入'?'text-success':'text-danger'}">${t.type==='收入'?'+':'-'}$${U.fmt(t.amount)}</td>
            <td>${t.counterparty||''}</td>
            <td>${t.account||''}</td>
            <td class="small">${t.description||''}</td>
            <td class="small">${num} ${t.vouchers?.length?'<i class="bi bi-paperclip text-primary"></i>':''}</td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" title="編輯" onclick="TransactionUI.edit('${t.id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-outline-danger" title="刪除" onclick="Transactions.remove('${t.id}')"><i class="bi bi-trash"></i></button>
              </div>
            </td>
          </tr>`;
        }).join('');
      }
      // pagination
      let html='',p=this.state.page;
      const add=(pg,txt,dis=false,act=false)=> html+=`<li class="page-item ${dis?'disabled':''} ${act?'active':''}">
        <a href="#" class="page-link" onclick="Transactions.goto(${pg});return false;">${txt}</a></li>`;
      add(p-1,'«',p===1);
      for(let i=Math.max(1,p-2); i<=Math.min(pages,p+2); i++) add(i,i,false,i===p);
      add(p+1,'»',p===pages);
      document.getElementById('txPagination').innerHTML=html;
      Counterparty.refresh();
    },
    goto(p){ this.state.page=p; this.render(); },
    toggleAll(master){ document.querySelectorAll('.tx-check').forEach(cb=>cb.checked=master.checked); },
    selected(){ return [...document.querySelectorAll('.tx-check:checked')].map(cb=>cb.dataset.id); },
    batch(){
      const act=document.getElementById('txBatchAction').value;
      const ids=this.selected();
      if(!act) return U.toast('error','未選動作');
      if(!ids.length) return U.toast('error','未勾選');
      if(act==='delete'){
        U.confirm({title:'刪除交易',text:`確定刪除 ${ids.length} 筆？`,confirmColor:'#dc3545'}).then(r=>{
          if(!r.isConfirmed) return;
          ids.forEach(id=>{
            Store.data.transactions = Store.data.transactions.filter(t=>t.id!==id);
            Store.markDelete('transactions', id);
          });
          Dashboard.refresh();
          this.render();
          U.toast('success','已刪除(待同步)');
        });
      }else if(act==='export'){
        DataPort.exportTransactions(ids);
      }else{
        U.toast('error','此批次功能尚未示範');
      }
    },
    remove(id){
      U.confirm({title:'刪除交易',text:'確定刪除此筆？',confirmColor:'#dc3545'}).then(r=>{
        if(!r.isConfirmed) return;
        Store.data.transactions = Store.data.transactions.filter(t=>t.id!==id);
        Store.markDelete('transactions', id);
        Dashboard.refresh();
        this.render();
        U.toast('success','已刪除');
      });
    }
  };

  /* ------------ 交易 UI（簡化 Modal -> 使用 Swal 表單） ------------- */
  const TransactionUI = {
    async openNew(){
      const nums = await Api.genNumbers();
      this.form(null, nums.receipt, nums.voucher);
    },
    edit(id){
      const t=Store.data.transactions.find(x=>x.id===id);
      if(!t) return;
      this.form(t);
    },
    async form(t, receiptNo=null, voucherNo=null){
      const isEdit=!!t;
      const typeVal = t? t.type:'收入';
      const accounts = Store.data.accounts.filter(a=>a.active!==false);
      const cats = Store.data.settings.categories || {收入:['會費','捐款'],支出:['活動費','辦公費']};
      const catOptions = (cats[typeVal]||[]).map(c=>`<option value="${c}" ${(t&&t.category===c)?'selected':''}>${c}</option>`).join('');
      Swal.fire({
        title: isEdit?'編輯交易':'新增交易',
        width:700,
        html:`<div class="text-start">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">日期 *</label>
              <input id="txFDate" type="date" class="form-control" value="${t?t.date:U.today()}">
            </div>
            <div class="col-md-4">
              <label class="form-label">類型 *</label>
              <select id="txFType" class="form-select">
                <option value="收入" ${typeVal==='收入'?'selected':''}>收入</option>
                <option value="支出" ${typeVal==='支出'?'selected':''}>支出</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">帳戶 *</label>
              <select id="txFAccount" class="form-select">
                ${accounts.map(a=>`<option value="${a.name}" ${(t&&t.account===a.name)?'selected':''}>${a.name}</option>`).join('')}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">類別 *</label>
              <select id="txFCategory" class="form-select">${catOptions}</select>
            </div>
            <div class="col-md-4">
              <label class="form-label">金額 *</label>
              <input id="txFAmount" type="number" class="form-control" value="${t?t.amount:''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">對象</label>
              <input id="txFCounterparty" class="form-control" value="${t?t.counterparty||'':''}" list="counterpartyDataList">
            </div>
            <div class="col-12">
              <label class="form-label">說明</label>
              <textarea id="txFDesc" class="form-control" rows="2">${t?t.description||'':''}</textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">${typeVal==='收入'?'收據':'憑證'}編號</label>
              <input id="txFNumber" class="form-control" value="${t? (t.receiptNumber||t.voucherNumber||'') : (typeVal==='收入'?receiptNo||'':voucherNo||'')}">
            </div>
            <div class="col-md-6">
              <label class="form-label">附件</label>
              <input id="txFFile" type="file" class="form-control" multiple accept="image/*,application/pdf">
              <div class="form-text">上傳立即送出 (需連線，限制 5MB)</div>
            </div>
          </div>
        </div>`,
        showCancelButton:true,
        confirmButtonText:'儲存',
        didOpen:()=>{
          // 類型改變時重新載入類別
          document.getElementById('txFType').addEventListener('change',()=> {
            const newType=document.getElementById('txFType').value;
            const list=(Store.data.settings.categories?.[newType])||[];
            const sel=document.getElementById('txFCategory');
            sel.innerHTML=list.map(c=>`<option value="${c}">${c}</option>`).join('');
            document.querySelector('label[for="txFNumber"]')?.textContent = (newType==='收入'?'收據':'憑證')+'編號';
          });
        },
        preConfirm: async ()=>{
          const date=document.getElementById('txFDate').value;
          const type=document.getElementById('txFType').value;
          const amount=U.num(document.getElementById('txFAmount').value);
          if(!date || !type || !amount){
            Swal.showValidationMessage('請填必填欄位');
            return false;
          }
          // 上傳附件
          const fileInput=document.getElementById('txFFile');
          let vouchers=[];
          if(fileInput.files.length){
            if(!navigator.onLine){
              U.toast('error','離線無法上傳附件');
            }else{
              for(const f of fileInput.files){
                try{
                  const base64 = await new Promise(res=>{
                    const fr=new FileReader();
                    fr.onload=()=>res(fr.result);
                    fr.readAsDataURL(f);
                  });
                  const r = await Api.uploadFile({
                    filename:f.name,
                    mimeType:f.type,
                    base64
                  });
                  if(r.ok){
                    vouchers.push({
                      name:r.name, mimeType:r.mimeType,
                      driveId:r.id, url:r.webContentLink||r.url
                    });
                  }else{
                    U.toast('error','上傳失敗:'+ (r.code||''));
                  }
                }catch(e){
                  console.error(e);
                }
              }
            }
          } else if(t && t.vouchers) vouchers = t.vouchers;

          const number = document.getElementById('txFNumber').value.trim();
          return {
            id: t? t.id : U.uuid(),
            date,
            type,
            category: document.getElementById('txFCategory').value,
            amount,
            counterparty: document.getElementById('txFCounterparty').value.trim(),
            account: document.getElementById('txFAccount').value,
            description: document.getElementById('txFDesc').value.trim(),
            receiptNumber: type==='收入'? number : undefined,
            voucherNumber: type==='支出'? number : undefined,
            vouchers,
            createdAt: t? t.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
        }
      }).then(r=>{
        if(!r.isConfirmed)return;
        const obj=r.value;
        if(t){
          const idx=Store.data.transactions.findIndex(x=>x.id===t.id);
          if(idx>-1) Store.data.transactions[idx]=obj;
          Store.markUpdate('transactions', obj);
        }else{
          Store.data.transactions.push(obj);
          Store.markAdd('transactions', obj);
        }
        Dashboard.refresh();
        Transactions.render();
        U.toast('success', t?'已更新(待同步)':'已新增(待同步)');
      });
    }
  };

  const Counterparty = {
    refresh(){
      const set=new Set();
      Store.data.transactions.forEach(t=> t.counterparty && set.add(t.counterparty));
      let dl=document.getElementById('counterpartyDataList');
      if(!dl){
        dl=document.createElement('datalist');
        dl.id='counterpartyDataList';
        document.body.appendChild(dl);
      }
      dl.innerHTML=[...set].map(v=>`<option value="${v}">`).join('');
    }
  };

  /* ------------ 會員（精簡版示範） ------------- */
  const Members = {
    state:{page:1,per:10,filtered:[]},
    filter(){
      const st=document.getElementById('memberFilterStatus').value;
      const tp=document.getElementById('memberFilterType').value;
      const kw=(document.getElementById('memberFilterKeyword').value||'').toLowerCase();
      this.state.filtered = Store.data.members.filter(m=>{
        if(st && m.status!==st) return false;
        if(tp && m.type!==tp) return false;
        if(kw){
          const text=(m.name+' '+m.phone+' '+(m.email||'')).toLowerCase();
          if(!text.includes(kw)) return false;
        }
        return true;
      }).sort((a,b)=> b.joinDate?.localeCompare(a.joinDate||'') );
    },
    render(){
      this.filter();
      const total=this.state.filtered.length;
      const per=this.state.per;
      const pages=Math.max(1, Math.ceil(total/per));
      if(this.state.page>pages) this.state.page=pages;
      const start=(this.state.page-1)*per;
      const rows=this.state.filtered.slice(start,start+per);
      document.getElementById('memberRecordCount').textContent=total+' 筆';
      const tb=document.getElementById('memberTableBody');
      if(!rows.length){
        tb.innerHTML='<tr><td colspan="8" class="text-center text-muted py-4">無符合資料</td></tr>';
      }else{
        tb.innerHTML=rows.map(m=>{
          const overdue = !m.lastPaymentDate || (new Date(m.lastPaymentDate) < new Date(new Date().setFullYear(new Date().getFullYear()-1)));
          return `<tr>
            <td><input type="checkbox" class="member-check" data-id="${m.id}"></td>
            <td>${m.name}</td>
            <td class="small"><div>${m.phone}</div>${m.email?`<div>${m.email}</div>`:''}</td>
            <td><span class="badge ${m.status==='active'?'bg-success':m.status==='inactive'?'bg-danger':'bg-warning text-dark'}">${m.status}</span></td>
            <td>${m.joinDate||''}</td>
            <td><span class="badge ${overdue?'bg-danger':'bg-success'}">${overdue?'逾期':'正常'}</span></td>
            <td class="small">${(m.tags||[]).map(t=>`<span class="badge bg-secondary me-1">${t}</span>`).join('')}</td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="MemberUI.edit('${m.id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-outline-success" onclick="Members.recordFee('${m.id}')"><i class="bi bi-credit-card"></i></button>
                <button class="btn btn-outline-danger" onclick="Members.remove('${m.id}')"><i class="bi bi-trash"></i></button>
              </div>
            </td>
          </tr>`;
        }).join('');
      }
      // pagination
      let html='',p=this.state.page;
      const add=(pg,txt,dis=false,act=false)=> html+=`<li class="page-item ${dis?'disabled':''} ${act?'active':''}">
        <a href="#" class="page-link" onclick="Members.goto(${pg});return false;">${txt}</a></li>`;
      add(p-1,'«',p===1);
      for(let i=Math.max(1,p-2); i<=Math.min(pages,p+2); i++) add(i,i,false,i===p);
      add(p+1,'»',p===pages);
      document.getElementById('memberPagination').innerHTML=html;
    },
    goto(p){ this.state.page=p; this.render(); },
    toggleAll(master){ document.querySelectorAll('.member-check').forEach(cb=>cb.checked=master.checked); },
    selected(){ return [...document.querySelectorAll('.member-check:checked')].map(cb=>cb.dataset.id); },
    batch(){
      const act=document.getElementById('memberBatchAction').value;
      const ids=this.selected();
      if(!act) return U.toast('error','未選動作');
      if(!ids.length) return U.toast('error','未勾選');
      if(act==='delete'){
        U.confirm({title:'刪除會員',text:`確定刪除 ${ids.length} 位？`,confirmColor:'#dc3545'}).then(r=>{
          if(!r.isConfirmed) return;
          ids.forEach(id=>{
            Store.data.members = Store.data.members.filter(m=>m.id!==id);
            Store.markDelete('members', id);
          });
          this.render(); Dashboard.refresh();
          U.toast('success','已刪除');
        });
      } else if(act.startsWith('status-')){
        const newStatus=act.split('-')[1];
        Store.data.members.forEach(m=>{
          if(ids.includes(m.id)){
            m.status=newStatus;
            m.updatedAt=new Date().toISOString();
            Store.markUpdate('members', m);
          }
        });
        this.render(); U.toast('success','狀態已更新');
      }
    },
    remove(id){
      U.confirm({title:'刪除會員',text:'確定刪除此會員？',confirmColor:'#dc3545'}).then(r=>{
        if(!r.isConfirmed)return;
        Store.data.members = Store.data.members.filter(m=>m.id!==id);
        Store.markDelete('members', id);
        this.render(); Dashboard.refresh();
        U.toast('success','已刪除');
      });
    },
    recordFee(id){
      const m=Store.data.members.find(x=>x.id===id);
      if(!m) return;
      Swal.fire({
        title:'紀錄會費',
        html:`<div class="text-start">
          <div class="mb-2">會員：<strong>${m.name}</strong></div>
          <label class="form-label">日期</label><input id="feeDate" type="date" class="form-control" value="${U.today()}">
          <label class="form-label mt-2">金額</label><input id="feeAmount" type="number" class="form-control" value="${m.membershipFee||Store.data.settings.defaultMembershipFee||1000}">
          <label class="form-label mt-2">備註</label><textarea id="feeNote" class="form-control" rows="2"></textarea>
        </div>`,
        showCancelButton:true,
        confirmButtonText:'儲存'
      }).then(async r=>{
        if(!r.isConfirmed)return;
        const date=document.getElementById('feeDate').value;
        const amt=U.num(document.getElementById('feeAmount').value);
        const note=document.getElementById('feeNote').value.trim();
        if(!date||!amt){ U.toast('error','需日期與金額'); return; }
        // 取號
        const nums = await Api.genNumbers();
        const tx={
          id:U.uuid(), date, type:'收入', category:'會費', amount:amt,
          counterparty:m.name,
          account:Store.data.accounts.find(a=>a.active!==false)?.name||'現金',
          description:`會費 ${note||''}`.trim(),
          receiptNumber:nums.receipt,
          vouchers:[],
          createdAt:new Date().toISOString(),
          updatedAt:new Date().toISOString()
        };
        Store.data.transactions.push(tx);
        Store.markAdd('transactions', tx);
        m.lastPaymentDate=date;
        m.updatedAt=new Date().toISOString();
        Store.markUpdate('members', m);
        Transactions.render(); this.render(); Dashboard.refresh();
        U.toast('success','已紀錄(待同步)');
      });
    }
  };

  const MemberUI = {
    openNew(){ this.form(); },
    edit(id){
      const m=Store.data.members.find(x=>x.id===id);
      if(!m) return;
      this.form(m);
    },
    form(m){
      const isEdit=!!m;
      Swal.fire({
        title: isEdit?'編輯會員':'新增會員',
        width:700,
        html:`<div class="text-start">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">姓名 *</label>
              <input id="mName" class="form-control" value="${m?m.name:''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">電話 *</label>
              <input id="mPhone" class="form-control" value="${m?m.phone:''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Email</label>
              <input id="mEmail" type="email" class="form-control" value="${m?m.email||'':''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">加入日期 *</label>
              <input id="mJoin" type="date" class="form-control" value="${m?m.joinDate:U.today()}">
            </div>
            <div class="col-md-4">
              <label class="form-label">狀態</label>
              <select id="mStatus" class="form-select">
                ${['active','inactive','pending'].map(s=>`<option value="${s}" ${m&&m.status===s?'selected':''}>${s}</option>`).join('')}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">類型</label>
              <select id="mType" class="form-select">
                ${['regular','honorary','life','family'].map(t=>`<option value="${t}" ${m&&m.type===t?'selected':''}>${t}</option>`).join('')}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">年費</label>
              <input id="mFee" type="number" class="form-control" value="${m?m.membershipFee||Store.data.settings.defaultMembershipFee||1000:(Store.data.settings.defaultMembershipFee||1000)}">
            </div>
            <div class="col-md-4">
              <label class="form-label">最後繳費</label>
              <input id="mLastPay" type="date" class="form-control" value="${m?m.lastPaymentDate||'':''}">
            </div>
            <div class="col-md-4">
              <label class="form-label">標籤(逗號)</label>
              <input id="mTags" class="form-control" value="${m?(m.tags||[]).join(','):''}">
            </div>
            <div class="col-12">
              <label class="form-label">備註</label>
              <textarea id="mNotes" class="form-control" rows="2">${m?m.notes||'':''}</textarea>
            </div>
          </div>
        </div>`,
        showCancelButton:true,
        confirmButtonText:'儲存',
        preConfirm:()=>{
          const name=document.getElementById('mName').value.trim();
          const phone=document.getElementById('mPhone').value.trim();
          const join=document.getElementById('mJoin').value;
          if(!name||!phone||!join){
            Swal.showValidationMessage('姓名/電話/加入日期 必填');
            return false;
          }
          return {
            id: m?m.id:U.uuid(),
            name, phone,
            email:document.getElementById('mEmail').value.trim(),
            joinDate:join,
            status:document.getElementById('mStatus').value,
            type:document.getElementById('mType').value,
            membershipFee:U.num(document.getElementById('mFee').value),
            lastPaymentDate:document.getElementById('mLastPay').value,
            tags:document.getElementById('mTags').value.split(',').map(x=>x.trim()).filter(Boolean),
            notes:document.getElementById('mNotes').value.trim(),
            createdAt: m?m.createdAt:new Date().toISOString(),
            updatedAt:new Date().toISOString()
          };
        }
      }).then(r=>{
        if(!r.isConfirmed)return;
        const obj=r.value;
        if(m){
          const idx=Store.data.members.findIndex(x=>x.id===m.id);
          if(idx>-1) Store.data.members[idx]=obj;
          Store.markUpdate('members', obj);
        }else{
          Store.data.members.push(obj);
          Store.markAdd('members', obj);
        }
        Members.render(); Dashboard.refresh();
        U.toast('success', m?'已更新':'已新增');
      });
    }
  };

  /* ------------ 活動 / 報名（精簡同樣概念） ------------- */
  const Activities = {
    state:{page:1,per:6,filtered:[]},
    filter(){
      const st=document.getElementById('actFilterStatus').value;
      const tp=document.getElementById('actFilterType').value;
      const kw=(document.getElementById('actFilterKeyword').value||'').toLowerCase();
      const sort=document.getElementById('actFilterSort').value;
      this.state.filtered=Store.data.activities.filter(a=>{
        if(st && a.status!==st) return false;
        if(tp && a.type!==tp) return false;
        if(kw){
          const text=(a.name+' '+(a.description||'')+' '+(a.location||'')).toLowerCase();
          if(!text.includes(kw)) return false;
        }
        return true;
      });
      this.state.filtered.sort((a,b)=>{
        switch(sort){
          case 'date_asc': return a.date.localeCompare(b.date);
          case 'date_desc': return b.date.localeCompare(a.date);
          case 'name_asc': return a.name.localeCompare(b.name);
          case 'regs_desc': return Registrations.count(b.id)-Registrations.count(a.id);
          default: return b.date.localeCompare(a.date);
        }
      });
    },
    render(){
      this.filter();
      const total=this.state.filtered.length;
      const per=this.state.per;
      const pages=Math.max(1,Math.ceil(total/per));
      if(this.state.page>pages) this.state.page=pages;
      const start=(this.state.page-1)*per;
      const rows=this.state.filtered.slice(start,start+per);
      const grid=document.getElementById('activitiesGrid');
      if(!rows.length){
        grid.innerHTML='<div class="col-12 text-center text-muted py-4"><i class="bi bi-calendar-event display-6 d-block"></i> 無活動</div>';
      }else{
        grid.innerHTML=rows.map(a=>{
          const regs=Registrations.count(a.id);
          const percent = a.maxParticipants? Math.min(100, regs/a.maxParticipants*100):0;
          return `<div class="col-md-4">
            <div class="card h-100">
              <div class="card-body d-flex flex-column">
                <h6 class="fw-semibold text-truncate" title="${a.name}">${a.name}</h6>
                <div class="small text-muted mb-1">${a.date} ${a.time||''}</div>
                <div class="small flex-grow-1">${(a.description||'').slice(0,80)}${(a.description||'').length>80?'...':''}</div>
                <div class="progress my-2" style="height:6px;"><div class="progress-bar bg-success" style="width:${percent}%"></div></div>
                <div class="d-flex justify-content-between small mb-2">
                  <span>${regs}/${a.maxParticipants||'∞'}</span>
                  <span>${a.fee? '$'+U.fmt(a.fee):'免費'}</span>
                </div>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary" onclick="ActivityUI.edit('${a.id}')"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-outline-success" onclick="Registrations.quick('${a.id}')"><i class="bi bi-person-plus"></i></button>
                  <button class="btn btn-outline-danger" onclick="Activities.remove('${a.id}')"><i class="bi bi-trash"></i></button>
                </div>
              </div>
            </div>
          </div>`;
        }).join('');
      }
      // pagination
      let html='',p=this.state.page;
      const add=(pg,txt,dis=false,act=false)=> html+=`<li class="page-item ${dis?'disabled':''} ${act?'active':''}">
        <a href="#" class="page-link" onclick="Activities.goto(${pg});return false;">${txt}</a></li>`;
      add(p-1,'«',p===1);
      for(let i=Math.max(1,p-2); i<=Math.min(pages,p+2); i++) add(i,i,false,i===p);
      add(p+1,'»',p===pages);
      document.getElementById('actPagination').innerHTML=html;
    },
    goto(p){ this.state.page=p; this.render(); },
    remove(id){
      U.confirm({title:'刪除活動',text:'連同報名刪除，確定？',confirmColor:'#dc3545'}).then(r=>{
        if(!r.isConfirmed)return;
        Store.data.activities = Store.data.activities.filter(a=>a.id!==id);
        Store.markDelete('activities', id);
        // 刪報名
        Store.data.registrations = Store.data.registrations.filter(r=>r.activityId!==id);
        // 無法針對 registrations 按 id 刪除多個，逐筆 markDelete
        // 這裡簡化：重新 reload registrations => 或直接當作大量刪除
        // 簡單作法：重建 all registrations → 全部替換 (可改成 delta: 逐筆 markDelete)
        // 為簡化：逐筆
        // (效率非重點 demo)
        U.toast('success','已刪除(待同步)');
        this.render(); Dashboard.refresh();
      });
    }
  };

  const ActivityUI = {
    openNew(){ this.form(); },
    edit(id){
      const a=Store.data.activities.find(x=>x.id===id);
      if(!a) return;
      this.form(a);
    },
    form(a){
      const isEdit=!!a;
      Swal.fire({
        title:isEdit?'編輯活動':'新增活動',
        width:700,
        html:`<div class="text-start">
          <label class="form-label">名稱 *</label>
          <input id="acName" class="form-control" value="${a?a.name:''}">
          <div class="row g-2 mt-1">
            <div class="col"><label class="form-label">日期 *</label><input id="acDate" type="date" class="form-control" value="${a?a.date:U.today()}"></div>
            <div class="col"><label class="form-label">時間</label><input id="acTime" class="form-control" value="${a?a.time||'':''}"></div>
          </div>
          <label class="form-label mt-2">地點</label><input id="acLoc" class="form-control" value="${a?a.location||'':''}">
          <div class="row g-2 mt-1">
            <div class="col">
              <label class="form-label">類型</label>
              <select id="acType" class="form-select">
                ${['講座','聚會','旅遊','運動','志工','其他'].map(t=>`<option value="${t}" ${a&&a.type===t?'selected':''}>${t}</option>`).join('')}
              </select>
            </div>
            <div class="col">
              <label class="form-label">狀態</label>
              <select id="acStatus" class="form-select">
                ${['draft','published','registration','full','closed','cancelled'].map(s=>`<option value="${s}" ${a&&a.status===s?'selected':''}>${s}</option>`).join('')}
              </select>
            </div>
            <div class="col">
              <label class="form-label">費用</label>
              <input id="acFee" type="number" class="form-control" value="${a?a.fee||0:0}">
            </div>
            <div class="col">
              <label class="form-label">人數</label>
              <input id="acMax" type="number" class="form-control" value="${a?a.maxParticipants||'':''}">
            </div>
          </div>
          <label class="form-label mt-2">描述</label>
          <textarea id="acDesc" class="form-control" rows="3">${a?a.description||'':''}</textarea>
        </div>`,
        showCancelButton:true,
        confirmButtonText:'儲存',
        preConfirm:()=>{
          const name=document.getElementById('acName').value.trim();
          const date=document.getElementById('acDate').value;
          if(!name||!date){
            Swal.showValidationMessage('名稱 / 日期必填');
            return false;
          }
          return {
            id:a?a.id:U.uuid(),
            name, date,
            time:document.getElementById('acTime').value.trim(),
            location:document.getElementById('acLoc').value.trim(),
            type:document.getElementById('acType').value,
            status:document.getElementById('acStatus').value,
            fee:U.num(document.getElementById('acFee').value),
            maxParticipants:U.num(document.getElementById('acMax').value)||null,
            description:document.getElementById('acDesc').value.trim(),
            createdAt:a?a.createdAt:new Date().toISOString(),
            updatedAt:new Date().toISOString()
          };
        }
      }).then(r=>{
        if(!r.isConfirmed)return;
        const obj=r.value;
        if(a){
          const idx=Store.data.activities.findIndex(x=>x.id===a.id);
          if(idx>-1) Store.data.activities[idx]=obj;
          Store.markUpdate('activities', obj);
        }else{
          Store.data.activities.push(obj);
          Store.markAdd('activities', obj);
        }
        Activities.render(); Dashboard.refresh();
        U.toast('success', a?'已更新':'已新增');
      });
    }
  };

  const Registrations = {
    count(actId){ return Store.data.registrations.filter(r=>r.activityId===actId && r.status!=='cancelled').length; },
    quick(actId){
      const a=Store.data.activities.find(x=>x.id===actId);
      if(!a) return;
      const activeMembers=Store.data.members.filter(m=>m.status==='active');
      Swal.fire({
        title:'快速報名',
        width:550,
        html:`<div class="text-start">
          <div class="mb-2 small">活動：<strong>${a.name}</strong></div>
          <label class="form-label">選擇會員</label>
          <select id="regMember" class="form-select">
            <option value="">(選擇或填臨時姓名)</option>
            ${activeMembers.map(m=>`<option value="${m.id}">${m.name}</option>`).join('')}
          </select>
          <label class="form-label mt-2">臨時姓名</label>
          <input id="regTemp" class="form-control">
          ${a.fee? `<div class="form-check mt-2">
            <input id="regPaid" type="checkbox" class="form-check-input">
            <label class="form-check-label" for="regPaid">已收費用 $${U.fmt(a.fee)}</label>
          </div>`:''}
        </div>`,
        showCancelButton:true,
        confirmButtonText:'送出',
        preConfirm:()=>{
          const mid=document.getElementById('regMember').value;
          const tmp=document.getElementById('regTemp').value.trim();
          if(!mid && !tmp){
            Swal.showValidationMessage('請選會員或填臨時姓名');
            return false;
          }
          return {memberId:mid||null,name:tmp||null,paid:document.getElementById('regPaid')?.checked};
        }
      }).then(async r=>{
        if(!r.isConfirmed)return;
        const v=r.value;
        if(v.memberId && Store.data.registrations.some(rr=> rr.activityId===actId && rr.memberId===v.memberId && rr.status!=='cancelled')){
          U.toast('error','已報名');
          return;
        }
        const reg={
          id:U.uuid(), activityId:actId, memberId:v.memberId,
          name:v.name, paid:!!v.paid,
          status:'normal', registrationDate:U.today(),
          createdAt:new Date().toISOString(), updatedAt:new Date().toISOString()
        };
        Store.data.registrations.push(reg);
        Store.markAdd('registrations', reg);
        if(v.paid && a.fee){
          const nums = await Api.genNumbers();
          const tx={
            id:U.uuid(), date:U.today(), type:'收入', category:'活動費用', amount:a.fee,
            counterparty: v.memberId ? (Store.data.members.find(m=>m.id===v.memberId)?.name||'會員') : (v.name||'參加者'),
            account:Store.data.accounts.find(x=>x.active!==false)?.name||'現金',
            description:'活動:'+a.name+' 報名費',
            receiptNumber:nums.receipt,
            vouchers:[],
            createdAt:new Date().toISOString(), updatedAt:new Date().toISOString()
          };
          Store.data.transactions.push(tx);
          Store.markAdd('transactions', tx);
        }
        Activities.render(); Dashboard.refresh();
        U.toast('success','已報名');
      });
    }
  };

  /* ------------ 公告 ------------- */
  const Announcements = {
    state:{page:1,per:6,filtered:[]},
    filter(){
      const st=document.getElementById('annFilterStatus').value;
      const tp=document.getElementById('annFilterType').value;
      const kw=(document.getElementById('annFilterKeyword').value||'').toLowerCase();
      const today=U.today();
      this.state.filtered=Store.data.announcements.map(a=>{
        if(a.status==='published' && a.endDate && a.endDate < today) a.status='expired';
        return a;
      }).filter(a=>{
        if(st && a.status!==st) return false;
        if(tp && a.type!==tp) return false;
        if(kw){
          const text=(a.title+' '+(a.content||'')).toLowerCase();
          if(!text.includes(kw)) return false;
        }
        return true;
      }).sort((a,b)=> (b.startDate||'').localeCompare(a.startDate||''));
    },
    render(){
      this.filter();
      const total=this.state.filtered.length;
      const per=this.state.per;
      const pages=Math.max(1,Math.ceil(total/per));
      if(this.state.page>pages) this.state.page=pages;
      const start=(this.state.page-1)*per;
      const rows=this.state.filtered.slice(start,start+per);
      const grid=document.getElementById('announcementsGrid');
      if(!rows.length){
        grid.innerHTML='<div class="col-12 text-center py-4 text-muted"><i class="bi bi-megaphone display-6"></i><br>無公告</div>';
      }else{
        grid.innerHTML=rows.map(a=>`
          <div class="col-md-4">
            <div class="card h-100 border-start ${a.type==='urgent'?'border-danger':'border-warning'} border-4">
              <div class="card-body d-flex flex-column">
                <h6 class="fw-semibold text-truncate" title="${a.title}">${a.title}</h6>
                <div class="small text-muted mb-1">${a.startDate||''}${a.endDate?' ~ '+a.endDate:''}</div>
                <div class="small flex-grow-1" style="white-space:pre-wrap;overflow:auto;max-height:120px;">${(a.content||'').slice(0,160)}${(a.content||'').length>160?'...':''}</div>
                <div class="d-flex justify-content-between mt-2">
                  <span class="badge ${a.status==='published'?'bg-success':a.status==='expired'?'bg-secondary':'bg-warning text-dark'}">${a.status}</span>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="AnnouncementUI.edit('${a.id}')"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-outline-danger" onclick="Announcements.remove('${a.id}')"><i class="bi bi-trash"></i></button>
                  </div>
                </div>
              </div>
            </div>
          </div>`).join('');
      }
      // pagination
      let html='',p=this.state.page;
      const add=(pg,txt,dis=false,act=false)=> html+=`<li class="page-item ${dis?'disabled':''} ${act?'active':''}">
        <a href="#" class="page-link" onclick="Announcements.goto(${pg});return false;">${txt}</a></li>`;
      add(p-1,'«',p===1);
      for(let i=Math.max(1,p-2); i<=Math.min(pages,p+2); i++) add(i,i,false,i===p);
      add(p+1,'»',p===pages);
      document.getElementById('annPagination').innerHTML=html;
    },
    goto(p){ this.state.page=p; this.render(); },
    remove(id){
      U.confirm({title:'刪除公告',text:'確定？',confirmColor:'#dc3545'}).then(r=>{
        if(!r.isConfirmed)return;
        Store.data.announcements = Store.data.announcements.filter(a=>a.id!==id);
        Store.markDelete('announcements', id);
        this.render();
        U.toast('success','已刪除');
      });
    }
  };

  const AnnouncementUI = {
    openNew(){ this.form(); },
    edit(id){
      const a=Store.data.announcements.find(x=>x.id===id);
      if(!a) return;
      this.form(a);
    },
    form(a){
      const isEdit=!!a;
      Swal.fire({
        title: isEdit?'編輯公告':'新增公告',
        width:700,
        html:`<div class="text-start">
          <label class="form-label">標題 *</label><input id="anTitle" class="form-control" value="${a?a.title:''}">
          <div class="row g-2 mt-1">
            <div class="col"><label class="form-label">開始</label><input id="anStart" type="date" class="form-control" value="${a?a.startDate||'':U.today()}"></div>
            <div class="col"><label class="form-label">結束</label><input id="anEnd" type="date" class="form-control" value="${a?a.endDate||'':''}"></div>
          </div>
          <div class="row g-2 mt-1">
            <div class="col">
              <label class="form-label">狀態</label>
              <select id="anStatus" class="form-select">
                ${['draft','published'].map(s=>`<option value="${s}" ${a&&a.status===s?'selected':''}>${s}</option>`).join('')}
              </select>
            </div>
            <div class="col">
              <label class="form-label">類型</label>
              <select id="anType" class="form-select">
                ${['normal','urgent','event','system'].map(s=>`<option value="${s}" ${a&&a.type===s?'selected':''}>${s}</option>`).join('')}
              </select>
            </div>
          </div>
          <label class="form-label mt-2">內容</label>
          <textarea id="anContent" class="form-control" rows="4">${a?a.content||'':''}</textarea>
        </div>`,
        showCancelButton:true,
        confirmButtonText:'儲存',
        preConfirm:()=>{
          const title=document.getElementById('anTitle').value.trim();
          if(!title){ Swal.showValidationMessage('標題必填'); return false; }
          return {
            id:a?a.id:U.uuid(),
            title,
            content:document.getElementById('anContent').value.trim(),
            startDate:document.getElementById('anStart').value,
            endDate:document.getElementById('anEnd').value,
            status:document.getElementById('anStatus').value,
            type:document.getElementById('anType').value,
            createdAt:a?a.createdAt:new Date().toISOString(),
            updatedAt:new Date().toISOString()
          };
        }
      }).then(r=>{
        if(!r.isConfirmed)return;
        const obj=r.value;
        if(a){
          const idx=Store.data.announcements.findIndex(x=>x.id===a.id);
          if(idx>-1) Store.data.announcements[idx]=obj;
          Store.markUpdate('announcements', obj);
        }else{
          Store.data.announcements.push(obj);
          Store.markAdd('announcements', obj);
        }
        Announcements.render();
        U.toast('success', a?'已更新':'已新增');
      });
    }
  };

  /* ------------ 表單下載 ------------- */
  const Forms = {
    filter(){
      const kw=(document.getElementById('formFilterKeyword').value||'').toLowerCase();
      const cat=document.getElementById('formFilterCategory').value;
      return Store.data.forms.filter(f=>{
        if(cat && f.category!==cat) return false;
        if(kw){
          const t=(f.name+' '+(f.keywords||'')).toLowerCase();
          if(!t.includes(kw)) return false;
        }
        return true;
      }).sort((a,b)=> (b.updatedAt||'').localeCompare(a.updatedAt||''));
    },
    render(){
      const list=this.filter();
      const box=document.getElementById('formsList');
      if(!list.length){
        box.innerHTML='<div class="col-12 text-center py-4 text-muted"><i class="bi bi-file-earmark display-6 d-block"></i> 無表單</div>';
      }else{
        box.innerHTML=list.map(f=>`
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-body d-flex flex-column">
                <h6 class="fw-semibold text-truncate">${f.name}</h6>
                <div class="small text-muted mb-2">${f.category||'其他'} | ${(f.updatedAt||'').slice(0,10)}</div>
                <div class="small flex-grow-1">${(f.description||'').slice(0,80)}${(f.description||'').length>80?'...':''}</div>
                <a class="btn btn-sm btn-outline-primary mt-2" href="${f.url}" target="_blank"><i class="bi bi-download"></i> 下載</a>
              </div>
            </div>
          </div>`).join('');
      }
    }
  };

  const FormUI = {
    manage(){
      Swal.fire({
        title:'表單管理',
        width:750,
        html:`<div class="text-start">
          <table class="table table-sm" id="formsMng">
            <thead><tr><th>名稱</th><th>分類</th><th>URL</th><th style="width:40px;"></th></tr></thead>
            <tbody>
              ${Store.data.forms.map(f=>`
                <tr data-id="${f.id}">
                  <td><input class="form-control form-control-sm f-name" value="${f.name}"></td>
                  <td>
                    <select class="form-select form-select-sm f-cat">
                      ${['會員','財務','活動','行政','其他'].map(c=>`<option value="${c}" ${f.category===c?'selected':''}>${c}</option>`).join('')}
                    </select>
                  </td>
                  <td><input class="form-control form-control-sm f-url" value="${f.url||''}"></td>
                  <td><button class="btn btn-sm btn-outline-danger" onclick="FormUI.remove('${f.id}')"><i class="bi bi-x"></i></button></td>
                </tr>`).join('')}
              <tr><td colspan="4" class="text-center">
                <button class="btn btn-sm btn-outline-primary" onclick="FormUI.addRow()"><i class="bi bi-plus-circle"></i> 新增</button>
              </td></tr>
            </tbody>
          </table>
        </div>`,
        showCancelButton:true,
        confirmButtonText:'儲存'
      }).then(r=>{
        if(!r.isConfirmed)return;
        const rows=[...document.querySelectorAll('#formsMng tbody tr[data-id]')];
        const list=[];
        rows.forEach(tr=>{
          const id=tr.dataset.id;
          const name=tr.querySelector('.f-name').value.trim();
          const cat=tr.querySelector('.f-cat').value;
          const url=tr.querySelector('.f-url').value.trim();
          if(name && url){
            list.push({
              id,
              name,
              category:cat,
              url,
              description: Store.data.forms.find(f=>f.id===id)?.description||'',
              createdAt: Store.data.forms.find(f=>f.id===id)?.createdAt || new Date().toISOString(),
              updatedAt: new Date().toISOString()
            });
          }
        });
        Store.data.forms=list;
        // 直接視為整批重建：對現有的非保留 id → 刪除；對保留 → update / add
        // 為簡化：全部標記更新（不影響實際功能）
        list.forEach(f=>{
          if(Store.changeLog.forms.adds[f.id] || Store.data.forms.find(x=>x.id===f.id)){
            Store.markUpdate('forms', f);
          }else{
            Store.markAdd('forms', f);
          }
        });
        Forms.render();
        U.toast('success','已更新(待同步)');
      });
    },
    addRow(){
      const tb=document.querySelector('#formsMng tbody');
      const id=U.uuid();
      tb.insertAdjacentHTML('afterbegin',`
        <tr data-id="${id}">
          <td><input class="form-control form-control-sm f-name"></td>
          <td>
            <select class="form-select form-select-sm f-cat">
              ${['會員','財務','活動','行政','其他'].map(c=>`<option value="${c}">${c}</option>`).join('')}
            </select>
          </td>
          <td><input class="form-control form-control-sm f-url"></td>
          <td><button class="btn btn-sm btn-outline-danger" onclick="FormUI.remove('${id}')"><i class="bi bi-x"></i></button></td>
        </tr>`);
    },
    remove(id){
      document.querySelector(`#formsMng tr[data-id="${id}"]`)?.remove();
    }
  };

  /* ------------ 帳戶 ------------- */
  const Accounts = {
    manage(){
      Swal.fire({
        title:'帳戶管理',
        width:650,
        html:`<div class="text-start">
          <table class="table table-sm" id="accTbl">
            <thead><tr><th>名稱</th><th style="width:80px;">啟用</th><th style="width:110px;">期初餘額</th><th style="width:40px;"></th></tr></thead>
            <tbody>
              ${Store.data.accounts.map(a=>`
                <tr data-id="${a.id}">
                  <td><input class="form-control form-control-sm a-name" value="${a.name}"></td>
                  <td class="text-center"><input type="checkbox" class="form-check-input a-active" ${a.active!==false?'checked':''}></td>
                  <td><input type="number" class="form-control form-control-sm a-open" value="${a.openingBalance||0}"></td>
                  <td><button class="btn btn-sm btn-outline-danger" onclick="Accounts.removeRow('${a.id}')"><i class="bi bi-x"></i></button></td>
                </tr>`).join('')}
              <tr>
                <td colspan="4" class="text-center">
                  <button class="btn btn-sm btn-outline-primary" onclick="Accounts.addRow()"><i class="bi bi-plus-circle"></i> 新增</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>`,
        showCancelButton:true,
        confirmButtonText:'儲存'
      }).then(r=>{
        if(!r.isConfirmed)return;
        const rows=[...document.querySelectorAll('#accTbl tbody tr[data-id]')];
        const list=[];
        rows.forEach(tr=>{
          const id=tr.dataset.id;
          const name=tr.querySelector('.a-name').value.trim();
          if(!name) return;
          const obj={
            id,
            name,
            active: tr.querySelector('.a-active').checked,
            openingBalance: U.num(tr.querySelector('.a-open').value),
            currentBalance:0,
            createdAt: Store.data.accounts.find(a=>a.id===id)?.createdAt || new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          list.push(obj);
        });
        Store.data.accounts=list;
        // 重算餘額
        Recalc.accounts();
        // 全部視為更新
        list.forEach(a=>{
          if(Store.changeLog.accounts.adds[a.id] || Store.data.accounts.find(x=>x.id===a.id))
            Store.markUpdate('accounts', a);
          else Store.markAdd('accounts', a);
        });
        Dashboard.refresh();
        U.toast('success','帳戶已更新(待同步)');
      });
    },
    addRow(){
      const tb=document.querySelector('#accTbl tbody');
      const id=U.uuid();
      tb.insertAdjacentHTML('afterbegin',`
        <tr data-id="${id}">
          <td><input class="form-control form-control-sm a-name"></td>
          <td class="text-center"><input type="checkbox" class="form-check-input a-active" checked></td>
          <td><input type="number" class="form-control form-control-sm a-open" value="0"></td>
          <td><button class="btn btn-sm btn-outline-danger" onclick="Accounts.removeRow('${id}')"><i class="bi bi-x"></i></button></td>
        </tr>`);
    },
    removeRow(id){
      document.querySelector(`#accTbl tr[data-id="${id}"]`)?.remove();
    }
  };

  /* ------------ 設定 ------------- */
  const SettingsUI = {
    open(){
      const s=Store.data.settings;
      Swal.fire({
        title:'系統設定',
        width:600,
        html:`<div class="text-start">
          <label class="form-label">組織名稱</label>
          <input id="setOrg" class="form-control" value="${s.organizationName||''}">
          <label class="form-label mt-2">預設年費</label>
          <input id="setFee" type="number" class="form-control" value="${s.defaultMembershipFee||1000}">
          <label class="form-label mt-2">收入類別 (逗號)</label>
          <input id="setIncCats" class="form-control" value="${(s.categories?.['收入']||['會費','捐款']).join(',')}">
          <label class="form-label mt-2">支出類別 (逗號)</label>
          <input id="setExpCats" class="form-control" value="${(s.categories?.['支出']||['活動費用','辦公費用']).join(',')}">
        </div>`,
        showCancelButton:true,
        confirmButtonText:'儲存',
        preConfirm:()=>{
          const inc=document.getElementById('setIncCats').value.split(',').map(x=>x.trim()).filter(Boolean);
          const exp=document.getElementById('setExpCats').value.split(',').map(x=>x.trim()).filter(Boolean);
          return {
            organizationName: document.getElementById('setOrg').value.trim(),
            defaultMembershipFee: U.num(document.getElementById('setFee').value),
            categories:{收入:inc, 支出:exp}
          };
        }
      }).then(r=>{
        if(!r.isConfirmed)return;
        Object.assign(Store.data.settings, r.value);
        Store.markSettingsDirty();
        Dashboard.refresh();
        U.toast('success','設定已更新(待同步)');
      });
    }
  };

  /* ------------ Dashboard ------------- */
  const Dashboard = {
    refresh(){
      const tx=Store.data.transactions;
      const members=Store.data.members;
      Recalc.accounts();
      const accounts=Store.data.accounts;
      const today=new Date();
      const monthStr=today.toISOString().slice(0,7);
      let totalIn=0,totalOut=0,monthIn=0,monthOut=0;
      tx.forEach(t=>{
        if(t.type==='收入'){ totalIn+=t.amount; if(t.date.startsWith(monthStr)) monthIn+=t.amount; }
        else { totalOut+=t.amount; if(t.date.startsWith(monthStr)) monthOut+=t.amount; }
      });
      const totalBal = accounts.reduce((s,a)=>s+(a.currentBalance||0),0);
      const overdue = members.filter(m=> !m.lastPaymentDate || (new Date(m.lastPaymentDate) < new Date(new Date().setFullYear(new Date().getFullYear()-1))) ).length;
      document.getElementById('dashTotalIncome').textContent='$'+U.fmt(totalIn);
      document.getElementById('dashTotalExpense').textContent='$'+U.fmt(totalOut);
      document.getElementById('dashMonthIncome').textContent='$'+U.fmt(monthIn);
      document.getElementById('dashMonthExpense').textContent='$'+U.fmt(monthOut);
      document.getElementById('dashTotalBalance').textContent='$'+U.fmt(totalBal);
      document.getElementById('dashAccountCount').textContent=accounts.length;
      document.getElementById('dashMemberTotal').textContent=members.length;
      document.getElementById('dashMemberOverdue').textContent=overdue;
      this.renderAccounts();
      this.renderRecent();
    },
    renderAccounts(){
      const box=document.getElementById('dashboardAccountBalances');
      const accounts=Store.data.accounts;
      if(!accounts.length){
        box.innerHTML='<div class="text-muted small">尚無帳戶</div>'; return;
      }
      box.innerHTML='<div class="row g-3">'+accounts.map(a=>`
        <div class="col-6 col-md-3">
          <div class="border rounded p-2 bg-white small">
            <div class="d-flex justify-content-between">
              <span class="fw-semibold">${a.name}</span>
              <span class="badge ${a.active!==false?'bg-success':'bg-secondary'}">${a.active!==false?'啟用':'停用'}</span>
            </div>
            <div class="mt-1">
              <span class="text-muted">餘額：</span>
              <span class="${(a.currentBalance||0)>=0?'text-success':'text-danger'} fw-semibold">$${U.fmt(a.currentBalance||0)}</span>
            </div>
          </div>
        </div>`).join('')+'</div>';
    },
    renderRecent(){
      const recentTx=[...Store.data.transactions].sort((a,b)=> b.date.localeCompare(a.date)).slice(0,6);
      document.getElementById('dashboardRecentTx').innerHTML = recentTx.length? recentTx.map(t=>`
        <div class="d-flex justify-content-between border-bottom py-1 small">
          <div>${t.date} <span class="text-muted">${t.category}</span></div>
          <div class="${t.type==='收入'?'text-success':'text-danger'}">${t.type==='收入'?'+':'-'}$${U.fmt(t.amount)}</div>
        </div>`).join('') : '<div class="text-center text-muted py-4">無交易</div>';
      const recentMembers=[...Store.data.members].sort((a,b)=> (b.joinDate||'').localeCompare(a.joinDate||'')).slice(0,6);
      document.getElementById('dashboardRecentMembers').innerHTML = recentMembers.length? recentMembers.map(m=>`
        <div class="d-flex justify-content-between border-bottom py-1 small">
          <div>${m.name}</div><span class="badge ${m.status==='active'?'bg-success':'bg-secondary'}">${m.status}</span>
        </div>`).join('') : '<div class="text-center text-muted py-4">無會員</div>';
      const recentActs=[...Store.data.activities].sort((a,b)=> (b.date||'').localeCompare(a.date||'')).slice(0,6);
      document.getElementById('dashboardRecentActivities').innerHTML = recentActs.length? recentActs.map(a=>`
        <div class="d-flex justify-content-between border-bottom py-1 small">
          <div>${a.date} ${a.name}</div><span class="badge bg-primary">${a.status}</span>
        </div>`).join('') : '<div class="text-center text-muted py-4">無活動</div>';
    }
  };

  /* ------------ Recalc ------------- */
  const Recalc = {
    accounts(){
      Store.data.accounts.forEach(a=> a.currentBalance = a.openingBalance||0);
      Store.data.transactions.forEach(t=>{
        const acc=Store.data.accounts.find(a=>a.name===t.account);
          if(acc){
            if(t.type==='收入') acc.currentBalance += t.amount;
            else acc.currentBalance -= t.amount;
          }
      });
    }
  };

  /* ------------ Data Export / Import ------------- */
  const DataPort = {
    exportAll(){
      U.download('npo-cache-all.json', JSON.stringify({versions:Store.versions,data:Store.data},null,2));
      U.toast('success','已匯出');
    },
    importAll(){
      const inp=document.createElement('input');
      inp.type='file'; inp.accept='application/json';
      inp.onchange=()=>{
        const f=inp.files[0]; if(!f) return;
        const fr=new FileReader();
        fr.onload=()=>{
          try{
            const obj=JSON.parse(fr.result);
            if(obj.data && obj.versions){
              Store.data=obj.data;
              Store.versions=obj.versions;
              Store.initChangeLog();
              Store.saveCache();
              Dashboard.refresh();
              U.toast('success','已載入(未同步)');
            }else U.toast('error','格式錯誤');
          }catch(e){ U.toast('error','解析失敗'); }
        };
        fr.readAsText(f);
      };
      inp.click();
    },
    exportTransactions(ids=null){
      const list=ids? Store.data.transactions.filter(t=>ids.includes(t.id)) : Store.data.transactions;
      U.download('transactions.json', JSON.stringify(list,null,2));
    },
    exportMembers(ids=null){
      const list=ids? Store.data.members.filter(m=>ids.includes(m.id)) : Store.data.members;
      U.download('members.json', JSON.stringify(list,null,2));
    },
    exportActivities(){
      U.download('activities.json', JSON.stringify(Store.data.activities,null,2));
    },
    exportAnnouncements(){
      U.download('announcements.json', JSON.stringify(Store.data.announcements,null,2));
    }
  };

  /* ------------ 統計 (延用類似原邏輯，精簡) ------------- */
  const Analytics = {
    charts:{},
    refresh(){
      this.ensureYears();
      const year=document.getElementById('analyticsYear').value;
      if(!year){
        this.destroyCharts();
        ['anaTotalIncome','anaTotalExpense','anaBalance','anaAvgMonthly'].forEach(id=>document.getElementById(id).textContent='$0');
        return;
      }
      const months=[...Array(12)].map(()=>({in:0,out:0}));
      let totalIn=0,totalOut=0;
      Store.data.transactions.forEach(t=>{
        if(!t.date.startsWith(year+'-')) return;
        const m=parseInt(t.date.slice(5,7),10)-1;
        if(m<0||m>11) return;
        if(t.type==='收入'){ months[m].in+=t.amount; totalIn+=t.amount; }
        else { months[m].out+=t.amount; totalOut+=t.amount; }
      });
      document.getElementById('anaTotalIncome').textContent='$'+U.fmt(totalIn);
      document.getElementById('anaTotalExpense').textContent='$'+U.fmt(totalOut);
      document.getElementById('anaBalance').textContent='$'+U.fmt(totalIn-totalOut);
      document.getElementById('anaAvgMonthly').textContent='$'+U.fmt(((totalIn-totalOut)/12)|0);
      this.drawCharts(year,months);
    },
    ensureYears(){
      const years=new Set();
      Store.data.transactions.forEach(t=> years.add(t.date.slice(0,4)));
      const sel=document.getElementById('analyticsYear');
      const cur=sel.value;
      sel.innerHTML='<option value="">選年度</option>'+[...years].sort().map(y=>`<option>${y}</option>`).join('');
      if(cur && years.has(cur)) sel.value=cur;
    },
    destroyCharts(){
      Object.values(this.charts).forEach(c=>{try{c.destroy();}catch(e){}});
      this.charts={};
    },
    drawCharts(year,months){
      this.destroyCharts();
      const labels=[...Array(12)].map((_,i)=> (i+1)+'月');
      this.charts.trend = new Chart(document.getElementById('chartTrend'),{
        type:'line',
        data:{
          labels,
          datasets:[
            {label:'收入',data:months.map(m=>m.in),borderColor:'#28a745',backgroundColor:'rgba(40,167,69,.15)',tension:.2,fill:true},
            {label:'支出',data:months.map(m=>m.out),borderColor:'#dc3545',backgroundColor:'rgba(220,53,69,.15)',tension:.2,fill:true}
          ]
        },
        options:{plugins:{legend:{position:'bottom'}}}
      });
      const expenseCat={};
      Store.data.transactions.forEach(t=>{
        if(t.type!=='支出') return;
        if(!t.date.startsWith(year+'-')) return;
        expenseCat[t.category]=(expenseCat[t.category]||0)+t.amount;
      });
      this.charts.expense = new Chart(document.getElementById('chartExpenseCategory'),{
        type:'doughnut',
        data:{
          labels:Object.keys(expenseCat),
          datasets:[{data:Object.values(expenseCat),backgroundColor:['#ff6384','#ff9f40','#4bc0c0','#36a2eb','#9966ff','#2c5aa0','#ffcd56']}]
        },
        options:{plugins:{legend:{position:'bottom'}}}
      });
      this.charts.monthCompare = new Chart(document.getElementById('chartMonthlyCompare'),{
        type:'bar',
        data:{labels,datasets:[
          {label:'收入',data:months.map(m=>m.in),backgroundColor:'rgba(40,167,69,.7)'},
          {label:'支出',data:months.map(m=>m.out),backgroundColor:'rgba(220,53,69,.7)'}
        ]}
      });
      const join=[...Array(12)].map(()=>0);
      Store.data.members.forEach(m=>{
        if(m.joinDate && m.joinDate.startsWith(year+'-')){
          const mm=parseInt(m.joinDate.slice(5,7),10)-1;
          if(mm>=0 && mm<12) join[mm]++;
        }
      });
      let cumulative=0;
      const cum=join.map(c=> cumulative+=c);
      this.charts.memberGrowth = new Chart(document.getElementById('chartMemberGrowth'),{
        type:'line',
        data:{labels,datasets:[{label:'累積會員',data:cum,borderColor:'#2c5aa0',backgroundColor:'rgba(44,90,160,.15)',tension:.25,fill:true}]}
      });
    }
  };

  /* ------------ Reports (精簡) ------------- */
  const Reports = {
    current:null,
    init(){
      if(!this._inited){
        const today=U.today();
        document.getElementById('reportEnd').value=today;
        document.getElementById('reportStart').value=today.slice(0,7)+'-01';
        this._inited=true;
      }
    },
    quick(mode){
      const today=new Date();
      if(mode==='thisMonth'){
        const y=today.getFullYear(), m=today.getMonth()+1;
        document.getElementById('reportStart').value = y+'-'+U.pad(m)+'-01';
        document.getElementById('reportEnd').value = U.today();
      }else if(mode==='thisYear'){
        const y=today.getFullYear();
        document.getElementById('reportStart').value = y+'-01-01';
        document.getElementById('reportEnd').value = y+'-12-31';
      }
    },
    gen(type){
      const s=document.getElementById('reportStart').value;
      const e=document.getElementById('reportEnd').value;
      if(!s||!e){ U.toast('error','請選期間'); return; }
      let html='';
      if(type==='cashbook') html=this.cashbook(s,e);
      else if(type==='incomeExpense') html=this.incomeExpense(s,e);
      else if(type==='balanceSheet') html=this.balanceSheet(e);
      else if(type==='ledger') html=this.ledger(s.slice(0,4));
      else if(type==='journal') html=this.journal(s,e);
      else if(type==='member') html=this.member();
      document.getElementById('reportModalTitle').textContent = '報表 - ' + this.titleOf(type);
      document.getElementById('reportModalBody').innerHTML = html;
      const modal = new bootstrap.Modal(document.getElementById('reportModal'));
      modal.show();
      this.current = {type, start:s, end:e, generatedAt:new Date().toISOString()};
    },
    titleOf(type){
      return {
        cashbook:'現金出納帳',
        incomeExpense:'收支決算表',
        balanceSheet:'資產負債表',
        ledger:'年度分類帳',
        journal:'綜合流水帳',
        member:'會員報表'
      }[type] || type;
    },
    inRange(date, s, e){
      return (!s || date >= s) && (!e || date <= e);
    },
    cashbook(s,e){
      // 以所有啟用帳戶為主，列出期間內交易 (依日期)
      const tx = Store.data.transactions
        .filter(t=> this.inRange(t.date,s,e))
        .sort((a,b)=> a.date.localeCompare(b.date) || (a.createdAt||'').localeCompare(b.createdAt||''));
      // 計算起初餘額
      const opening = {};
      Store.data.accounts.forEach(a=> opening[a.name]=a.openingBalance||0);
      Store.data.transactions
        .filter(t=> t.date < s)
        .forEach(t=>{
          if(opening[t.account]==null) opening[t.account]=0;
          if(t.type==='收入') opening[t.account]+=t.amount;
          else opening[t.account]-=t.amount;
        });
      const running = {...opening};
      const rows = tx.map(t=>{
        if(running[t.account]==null) running[t.account]=0;
        running[t.account] += (t.type==='收入'? t.amount : -t.amount);
        return `<tr>
          <td>${t.date}</td>
          <td>${t.account||''}</td>
          <td>${t.type==='收入'?('$'+U.fmt(t.amount)):'-'}</td>
          <td>${t.type==='支出'?('$'+U.fmt(t.amount)):'-'}</td>
          <td class="${running[t.account]>=0?'text-success':'text-danger'}">$${U.fmt(running[t.account])}</td>
          <td>${t.category||''}</td>
          <td>${t.counterparty||''}</td>
          <td class="text-start">${t.description||''}</td>
        </tr>`;
      }).join('');
      const openingRows = Object.keys(opening).map(acc=>`
        <tr class="table-light">
          <td>${s}</td><td>${acc}</td>
          <td colspan="2" class="text-muted">期初</td>
          <td class="${opening[acc]>=0?'text-success':'text-danger'}">$${U.fmt(opening[acc])}</td>
          <td colspan="3"></td>
        </tr>`).join('');
      return `<div class="report-block">
        <h5 class="mb-2">${Store.data.settings.organizationName||'組織'} - 現金出納帳</h5>
        <div class="small text-muted mb-3">期間：${s} ~ ${e}　生成：${new Date().toLocaleString()}</div>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle">
            <thead class="table-secondary">
              <tr><th>日期</th><th>帳戶</th><th>收入</th><th>支出</th><th>餘額</th><th>類別</th><th>對象</th><th>說明</th></tr>
            </thead>
            <tbody>${openingRows}${rows || '<tr><td colspan="8" class="text-center text-muted">無交易</td></tr>'}</tbody>
          </table>
        </div>
      </div>`;
    },
    incomeExpense(s,e){
      const incomeMap={}, expenseMap={};
      let totalIn=0,totalOut=0;
      Store.data.transactions
        .filter(t=> this.inRange(t.date,s,e))
        .forEach(t=>{
          if(t.type==='收入'){
            incomeMap[t.category]= (incomeMap[t.category]||0)+t.amount;
            totalIn+=t.amount;
          }else{
            expenseMap[t.category]= (expenseMap[t.category]||0)+t.amount;
            totalOut+=t.amount;
          }
        });
      const inRows = Object.keys(incomeMap).sort().map(c=>`
        <tr><td>${c}</td><td class="text-end text-success">$${U.fmt(incomeMap[c])}</td></tr>`).join('');
      const outRows = Object.keys(expenseMap).sort().map(c=>`
        <tr><td>${c}</td><td class="text-end text-danger">$${U.fmt(expenseMap[c])}</td></tr>`).join('');
      return `<div class="report-block">
        <h5 class="mb-2">${Store.data.settings.organizationName||'組織'} - 收支決算表</h5>
        <div class="small text-muted mb-3">期間：${s} ~ ${e}</div>
        <div class="row g-3">
          <div class="col-md-6">
            <table class="table table-sm table-bordered">
              <thead class="table-success"><tr><th>收入類別</th><th class="text-end">金額</th></tr></thead>
              <tbody>${inRows || '<tr><td colspan="2" class="text-center text-muted">無收入</td></tr>'}
              <tr class="table-secondary"><td>收入合計</td><td class="text-end fw-semibold">$${U.fmt(totalIn)}</td></tr>
              </tbody>
            </table>
          </div>
          <div class="col-md-6">
            <table class="table table-sm table-bordered">
              <thead class="table-danger"><tr><th>支出類別</th><th class="text-end">金額</th></tr></thead>
              <tbody>${outRows || '<tr><td colspan="2" class="text-center text-muted">無支出</td></tr>'}
              <tr class="table-secondary"><td>支出合計</td><td class="text-end fw-semibold">$${U.fmt(totalOut)}</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="mt-2">
          <div>本期結餘：<strong class="${(totalIn-totalOut)>=0?'text-success':'text-danger'}">$${U.fmt(totalIn-totalOut)}</strong></div>
        </div>
      </div>`;
    },
    balanceSheet(dateEnd){
      // 簡化：僅以帳戶餘額視為資產 (無負債分類)
      // 重新計算截至 dateEnd 的各帳戶餘額
      const balances={};
      Store.data.accounts.forEach(a=> balances[a.name]=a.openingBalance||0);
      Store.data.transactions
        .filter(t=> t.date <= dateEnd)
        .forEach(t=>{
          if(balances[t.account]==null) balances[t.account]=0;
          if(t.type==='收入') balances[t.account]+=t.amount;
          else balances[t.account]-=t.amount;
        });
      const rows = Object.keys(balances).sort().map(n=>`
        <tr><td>${n}</td><td class="text-end">$${U.fmt(balances[n])}</td></tr>`).join('');
      const total = Object.values(balances).reduce((a,b)=>a+b,0);
      return `<div class="report-block">
        <h5 class="mb-2">${Store.data.settings.organizationName||'組織'} - 資產負債表（簡化）</h5>
        <div class="small text-muted mb-3">截止日：${dateEnd}</div>
        <table class="table table-sm table-bordered">
          <thead class="table-secondary"><tr><th>資產（帳戶）</th><th class="text-end">金額</th></tr></thead>
          <tbody>${rows || '<tr><td colspan="2" class="text-center text-muted">無帳戶</td></tr>'}
          <tr class="table-secondary"><td>資產合計</td><td class="text-end fw-semibold">$${U.fmt(total)}</td></tr>
          </tbody>
        </table>
        <div class="small text-muted">（示範用：未細分負債 / 淨資產）</div>
      </div>`;
    },
    ledger(year){
      // 依帳戶 → 依月份彙總 & 列明細
      const accounts = [...Store.data.accounts].sort((a,b)=> a.name.localeCompare(b.name));
      const txByAcc = {};
      Store.data.transactions
        .filter(t=> t.date.startsWith(year+'-'))
        .forEach(t=>{
          if(!txByAcc[t.account]) txByAcc[t.account]=[];
          txByAcc[t.account].push(t);
        });
      Object.values(txByAcc).forEach(list=> list.sort((a,b)=> a.date.localeCompare(b.date)));
      const sections = accounts.map(a=>{
        const list = txByAcc[a.name]||[];
        if(!list.length) return `<h6 class="mt-4">${a.name}</h6><div class="text-muted small">無交易</div>`;
        let bal = a.openingBalance||0;
        // 加入前年至前年末的
        Store.data.transactions
          .filter(t=> t.account===a.name && t.date < year+'-01-01')
          .forEach(t=> bal += (t.type==='收入'? t.amount : -t.amount));
        const rows = list.map(t=>{
          bal += (t.type==='收入'? t.amount : -t.amount);
          return `<tr>
            <td>${t.date}</td>
            <td>${t.type==='收入'?('$'+U.fmt(t.amount)):'-'}</td>
            <td>${t.type==='支出'?('$'+U.fmt(t.amount)):'-'}</td>
            <td class="text-end ${bal>=0?'text-success':'text-danger'}">$${U.fmt(bal)}</td>
            <td>${t.category||''}</td>
            <td>${t.counterparty||''}</td>
            <td class="text-start">${t.description||''}</td>
          </tr>`;
        }).join('');
        return `<h6 class="mt-4">${a.name}</h6>
          <div class="small text-muted mb-1">期初餘額：$${U.fmt(bal - list.reduce((s,t)=> s + (t.type==='收入'?t.amount:-t.amount),0))}</div>
          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <thead class="table-light">
                <tr><th>日期</th><th>收入</th><th>支出</th><th class="text-end">結餘</th><th>類別</th><th>對象</th><th>說明</th></tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }).join('');
      return `<div class="report-block">
        <h5 class="mb-2">${Store.data.settings.organizationName||'組織'} - ${year} 年度分類帳</h5>
        <div class="small text-muted mb-3">生成：${new Date().toLocaleString()}</div>
        ${sections}
      </div>`;
    },
    journal(s,e){
      const list = Store.data.transactions
        .filter(t=> this.inRange(t.date,s,e))
        .sort((a,b)=> a.date.localeCompare(b.date) || (a.createdAt||'').localeCompare(b.createdAt||''));
      const rows = list.map(t=>`
        <tr>
          <td>${t.date}</td>
            <td>${t.account||''}</td>
          <td>${t.type}</td>
          <td>${t.category||''}</td>
          <td class="text-end ${t.type==='收入'?'text-success':'text-danger'}">${t.type==='收入'?'+':'-'}$${U.fmt(t.amount)}</td>
          <td>${t.counterparty||''}</td>
          <td class="text-start">${t.description||''}</td>
          <td class="small">${t.receiptNumber||t.voucherNumber||''}</td>
        </tr>`).join('');
      return `<div class="report-block">
        <h5 class="mb-2">${Store.data.settings.organizationName||'組織'} - 綜合流水帳</h5>
        <div class="small text-muted mb-3">期間：${s} ~ ${e}</div>
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead class="table-secondary">
              <tr><th>日期</th><th>帳戶</th><th>類型</th><th>類別</th><th class="text-end">金額</th><th>對象</th><th>說明</th><th>編號</th></tr>
            </thead>
            <tbody>${rows || '<tr><td colspan="8" class="text-center text-muted">無資料</td></tr>'}</tbody>
          </table>
        </div>
      </div>`;
    },
    member(){
      const list=[...Store.data.members].sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      const rows=list.map(m=>{
        const overdue = !m.lastPaymentDate || (new Date(m.lastPaymentDate) < new Date(new Date().setFullYear(new Date().getFullYear()-1)));
        return `<tr>
          <td>${m.name}</td>
          <td>${m.phone||''}</td>
          <td>${m.email||''}</td>
          <td>${m.joinDate||''}</td>
          <td>${m.type||''}</td>
          <td><span class="badge ${m.status==='active'?'bg-success':m.status==='inactive'?'bg-danger':'bg-warning text-dark'}">${m.status}</span></td>
          <td><span class="badge ${overdue?'bg-danger':'bg-success'}">${overdue?'逾期':'正常'}</span></td>
          <td class="small">${(m.tags||[]).join(', ')}</td>
        </tr>`;
      }).join('');
      return `<div class="report-block">
        <h5 class="mb-2">${Store.data.settings.organizationName||'組織'} - 會員報表</h5>
        <div class="small text-muted mb-3">總數：${list.length}</div>
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead class="table-secondary">
              <tr><th>姓名</th><th>電話</th><th>Email</th><th>加入</th><th>類型</th><th>狀態</th><th>年費</th><th>標籤</th></tr>
            </thead>
            <tbody>${rows || '<tr><td colspan="8" class="text-center text-muted">無會員</td></tr>'}</tbody>
          </table>
        </div>
      </div>`;
    },
    print(){
      const body=document.getElementById('reportModalBody').innerHTML;
      const win=window.open('','_blank');
      win.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8">
        <title>${this.titleOf(this.current?.type||'報表')}</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
          body{padding:20px;font-family:"Noto Sans TC",sans-serif;}
          h5{margin-top:0;}
          table{font-size:12px;}
          .report-block{page-break-after:auto;}
        </style>
      </head><body>${body}</body></html>`);
      win.document.close();
      win.focus();
      setTimeout(()=>win.print(),300);
    },
    exportHTML(){
      const html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${this.titleOf(this.current?.type||'報表')}</title>
      <style>body{font-family:"Noto Sans TC",sans-serif;padding:12px;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #999;padding:4px 6px;font-size:12px;}</style>
      </head><body>${document.getElementById('reportModalBody').innerHTML}</body></html>`;
      U.download((this.current?.type||'report')+'.html', html, 'text/html');
    }
  };

  /* ------------ 全域搜尋 (簡化) ------------- */
  const GlobalSearch = {
    exec(){
      const kw=(document.getElementById('globalSearchInput').value||'').trim().toLowerCase();
      if(!kw){ U.toast('error','請輸入關鍵字'); return; }
      const tx = Store.data.transactions.filter(t=>
        (t.description||'').toLowerCase().includes(kw) ||
        (t.category||'').toLowerCase().includes(kw) ||
        (t.counterparty||'').toLowerCase().includes(kw)
      ).slice(0,10);
      const members = Store.data.members.filter(m=>
        (m.name||'').toLowerCase().includes(kw) ||
        (m.phone||'').toLowerCase().includes(kw) ||
        (m.email||'').toLowerCase().includes(kw)
      ).slice(0,10);
      const acts = Store.data.activities.filter(a=>
        (a.name||'').toLowerCase().includes(kw) ||
        (a.description||'').toLowerCase().includes(kw)
      ).slice(0,10);
      let html='<div class="text-start">';
      html+='<div class="mb-2"><strong>交易</strong></div>'+ (tx.length? '<ul class="list-group mb-3">'+tx.map(t=>`<li class="list-group-item py-1 small">${t.date} ${t.category} $${U.fmt(t.amount)}</li>`).join(''):'<div class="text-muted small mb-3">（無）</div>');
      html+='<div class="mb-2"><strong>會員</strong></div>'+ (members.length? '<ul class="list-group mb-3">'+members.map(m=>`<li class="list-group-item py-1 small">${m.name} ${m.phone||''}</li>`).join(''):'<div class="text-muted small mb-3">（無）</div>');
      html+='<div class="mb-2"><strong>活動</strong></div>'+ (acts.length? '<ul class="list-group">'+acts.map(a=>`<li class="list-group-item py-1 small">${a.date} ${a.name}</li>`).join(''):'<div class="text-muted small">（無）</div>');
      html+='</div>';
      Swal.fire({
        title:'搜尋結果',
        width:600,
        html,
        confirmButtonText:'關閉'
      });
    }
  };

  /* ------------ 批次匯入 (示範：僅交易 / 會員) ------------- */
  const BatchImport = {
    open(entity){
      Swal.fire({
        title:'批次匯入 - '+entity,
        html:`<div class="text-start">
          <div class="mb-2 small text-muted">上傳 Excel 或 CSV。欄位名稱需與系統欄位相符 (id 可留空自動生成)。</div>
          <input id="batchFile" type="file" class="form-control" accept=".xlsx,.xls,.csv">
        </div>`,
        showCancelButton:true,
        confirmButtonText:'匯入',
        preConfirm:()=>{
          const f=document.getElementById('batchFile').files[0];
          if(!f){ Swal.showValidationMessage('請選檔案'); return false; }
          return f;
        }
      }).then(r=>{
        if(!r.isConfirmed)return;
        const file=r.value;
        const fr=new FileReader();
        fr.onload=()=>{
          try{
            let rows=[];
            if(file.name.endsWith('.csv')){
              const text=fr.result;
              const lines=text.split(/\r?\n/).filter(l=>l.trim());
              const header=lines.shift().split(',');
              rows=lines.map(l=>{
                const cols=l.split(',');
                const o={};
                header.forEach((h,i)=> o[h.trim()]=cols[i]?cols[i].trim():'');
                return o;
              });
            }else{
              const wb=XLSX.read(fr.result,{type:'binary'});
              const ws=wb.Sheets[wb.SheetNames[0]];
              rows=XLSX.utils.sheet_to_json(ws,{raw:false});
            }
            let added=0;
            if(entity==='transactions'){
              rows.forEach(r=>{
                const obj={
                  id:r.id||U.uuid(),
                  date:r.date||U.today(),
                  type:r.type||'收入',
                  category:r.category||'其他',
                  amount:U.num(r.amount||0),
                  counterparty:r.counterparty||'',
                  account:r.account|| (Store.data.accounts[0]?.name||'現金'),
                  description:r.description||'',
                  receiptNumber:r.receiptNumber|| (r.type==='收入'? (r.receiptNumber||''):undefined),
                  voucherNumber:r.voucherNumber|| (r.type==='支出'? (r.voucherNumber||''):undefined),
                  vouchers:[],
                  createdAt:new Date().toISOString(),
                  updatedAt:new Date().toISOString()
                };
                Store.data.transactions.push(obj);
                Store.markAdd('transactions', obj);
                added++;
              });
              Transactions.render(); Dashboard.refresh();
            }else if(entity==='members'){
              rows.forEach(r=>{
                const obj={
                  id:r.id||U.uuid(),
                  name:r.name||'未命名',
                  phone:r.phone||'',
                  email:r.email||'',
                  joinDate:r.joinDate||U.today(),
                  status:r.status||'active',
                  type:r.type||'regular',
                  membershipFee:U.num(r.membershipFee||Store.data.settings.defaultMembershipFee||1000),
                  lastPaymentDate:r.lastPaymentDate||'',
                  tags: r.tags? r.tags.split(/[,，]/).map(x=>x.trim()).filter(Boolean):[],
                  notes:r.notes||'',
                  createdAt:new Date().toISOString(),
                  updatedAt:new Date().toISOString()
                };
                Store.data.members.push(obj);
                Store.markAdd('members', obj);
                added++;
              });
              Members.render(); Dashboard.refresh();
            }else{
              U.toast('error','此實體匯入尚未實作');
              return;
            }
            U.toast('success', '匯入 '+added+' 筆 (待同步)');
          }catch(e){
            console.error(e);
            U.toast('error','解析失敗');
          }
        };
        if(file.name.endsWith('.csv')) fr.readAsText(file,'utf-8');
        else fr.readAsBinaryString(file);
      });
    }
  };

  /* ------------ 重置 ------------- */
  const Reset = {
    confirm(){
      U.confirm({title:'重置本機資料',text:'將清除本地快取與未同步變更，確定？',confirmColor:'#dc3545'}).then(r=>{
        if(!r.isConfirmed)return;
        localStorage.removeItem('data');
        localStorage.removeItem('versions');
        location.reload();
      });
    }
  };

  /* ------------ 關於 ------------- */
  const About = {
    show(){
      Swal.fire({
        title:'關於',
        html:`<div class="text-start small">
          <div>系統：NPO 管理系統 (Delta Sync)</div>
          <div>版本：2025.08.24</div>
          <div>說明：採用前端離線快取 + 後端多實體增量同步。</div>
          <hr>
          <div class="text-muted">若遇同步衝突：系統會自動重新抓取該實體最新資料，請重新操作。</div>
        </div>`,
        confirmButtonText:'關閉'
      });
    }
  };

  /* ------------ 初始載入流程 ------------- */
  (function startup(){
    const cached = Store.tryLoadCache();
    if(cached){
      Dashboard.refresh();
      SyncInd.set('ok');
      // 背景抓遠端最新版（不阻塞）
      Store.loadRemote(false);
    }else{
      Store.loadRemote(true).then(()=>{
        Dashboard.refresh();
      });
    }
  })();

  </script>
</body>
</html>
