<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>台灣帕金森病友權益促進會 - 會計暨營運整合管理系統</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="description" content="非營利組織整合：財務 / 會員 / 活動 / 公告 / 表單 / 雲端備份管理系統">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
<style>
  :root {
    --primary:#2c5aa0;
    --primary-dark:#1e3d6f;
    --gradient-primary:linear-gradient(135deg,#2c5aa0,#4a90e2);
    --gradient-green:linear-gradient(135deg,#28a745,#20c997);
    --gradient-orange:linear-gradient(135deg,#ff9f40,#ffb347);
    --secondary-bg:#f8f9fa;
    --radius-lg:15px;
    --radius-md:10px;
    --radius-sm:6px;
  }
  body {
    background:var(--secondary-bg);
    font-family:"Microsoft JhengHei","Noto Sans TC",system-ui,sans-serif;
    font-size:14.5px;
  }
  .navbar-brand { font-weight:600; color:var(--primary)!important; }
  .sidebar {
    min-height:100vh;
    background:linear-gradient(180deg,#2c5aa0,#1e3d6f);
    color:#fff;
  }
  .sidebar .nav-link {
    color:rgba(255,255,255,.82);
    border-radius:8px;
    margin:3px 0;
    font-weight:500;
    transition:.25s;
  }
  .sidebar .nav-link:hover,
  .sidebar .nav-link.active {
    background:rgba(255,255,255,0.12);
    color:#fff;
    transform:translateX(4px);
  }
  .content-section { animation:fadeIn .35s ease; }
  @keyframes fadeIn {
    from { opacity:0; transform:translateY(12px); }
    to { opacity:1; transform:translateY(0); }
  }
  .stat-card {
    background:var(--gradient-primary);
    color:#fff;
    border:none;
    border-radius:var(--radius-lg);
    box-shadow:0 4px 14px -4px rgba(0,0,0,.18);
    position:relative;
    overflow:hidden;
  }
  .stat-card.alt-green { background:var(--gradient-green); }
  .stat-card.alt-orange{ background:var(--gradient-orange); }
  .stat-card .icon-bg {
    position:absolute;
    right:-10px; top:-10px;
    font-size:72px;
    opacity:.16;
  }
  .card-hoverable { transition:.25s; border:none; border-radius:var(--radius-lg); }
  .card-hoverable:hover { transform:translateY(-4px); box-shadow:0 8px 24px -6px rgba(0,0,0,.15); }
  .table thead th { background:#f1f4f8; border-top:none; font-weight:600; }
  .badge-rounded { border-radius:20px; font-weight:500; letter-spacing:.5px; }
  .member-avatar, .participant-avatar {
    width:40px;height:40px;border-radius:50%;background:#fff;
    display:flex;align-items:center;justify-content:center;
    color:#666;font-weight:600;
    box-shadow:0 0 0 1px rgba(0,0,0,.05);
  }
  .small-avatar { width:32px;height:32px;font-size:12px; }
  .action-buttons .btn { padding:.25rem .5rem; }
  .loading-overlay {
    position:fixed; inset:0; z-index:2000;
    background:rgba(0,0,0,.45); display:flex;align-items:center;justify-content:center;
  }
  .pagination .page-link { border:none; border-radius:8px; color:var(--primary); }
  .pagination .page-item.active .page-link { background:var(--primary); }
  .chart-container { position:relative; height:380px; }
  .loading-spinner { 
    display:inline-block; width:20px; height:20px; 
    border:3px solid rgba(255,255,255,.3); 
    border-radius:50%; border-top-color:#fff; 
    animation:spin 1s ease-in-out infinite; 
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<!-- 載入遮罩 -->
<div id="loadingOverlay" class="loading-overlay" style="display:none;">
  <div class="text-center text-white">
    <div class="mb-3">
      <i class="bi bi-arrow-clockwise spin" style="font-size:48px;"></i>
    </div>
    <div>系統載入中，請稍候…</div>
  </div>
</div>

<!-- 導覽列 -->
<nav class="navbar navbar-expand-lg bg-white shadow-sm no-print">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <i class="bi bi-heart-pulse me-2"></i> 台灣帕金森病友權益促進會
    </a>
    <button class="navbar-toggler" type="button" onclick="AppLayout.toggleSidebar()">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto align-items-lg-center">
        <li class="nav-item me-2">
          <div class="input-group input-group-sm">
            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
            <input id="globalSearchInput" type="text" class="form-control" placeholder="全域搜尋" onkeydown="if(event.key==='Enter') GlobalSearch.exec()">
          </div>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle fw-semibold" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-gear"></i> 系統
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" onclick="SettingsUI.open()"><i class="bi bi-sliders"></i> 系統設定</a></li>
            <li><a class="dropdown-item" href="#" onclick="API.initializeSheets()"><i class="bi bi-database"></i> 初始化資料庫</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="About.show()"><i class="bi bi-info-circle"></i> 關於</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</div>

<div class="container-fluid">
  <div class="row">
    <!-- 側邊欄 -->
    <aside id="sidebar" class="sidebar col-lg-2 col-md-3 p-3">
      <h6 class="text-center mt-2 mb-4 fw-semibold">管理選單</h6>
      <nav class="nav flex-column">
        <a class="nav-link active" href="#" data-section="dashboard" onclick="AppLayout.showSection('dashboard',this)"><i class="bi bi-speedometer2 me-2"></i>儀表板</a>
        <a class="nav-link" href="#" data-section="transactions" onclick="AppLayout.showSection('transactions',this)"><i class="bi bi-receipt me-2"></i>交易記錄</a>
        <a class="nav-link" href="#" data-section="members" onclick="AppLayout.showSection('members',this)"><i class="bi bi-people me-2"></i>會員管理</a>
        <a class="nav-link" href="#" data-section="activities" onclick="AppLayout.showSection('activities',this)"><i class="bi bi-calendar-event me-2"></i>活動管理</a>
        <a class="nav-link" href="#" data-section="announcements" onclick="AppLayout.showSection('announcements',this)"><i class="bi bi-megaphone me-2"></i>公告管理</a>
        <a class="nav-link" href="#" data-section="forms" onclick="AppLayout.showSection('forms',this)"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單</a>
        <a class="nav-link" href="#" data-section="analytics" onclick="AppLayout.showSection('analytics',this)"><i class="bi bi-graph-up me-2"></i>統計分析</a>
        <a class="nav-link" href="#" data-section="reports" onclick="AppLayout.showSection('reports',this)"><i class="bi bi-file-earmark-text me-2"></i>報表中心</a>
      </nav>
    </aside>

    <!-- 主要內容 -->
    <main id="mainContent" class="col-lg-10 col-md-9 p-4">
      <!-- 儀表板 -->
      <section id="dashboardSection" class="content-section">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>儀表板</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
            <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
            <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
          </div>
        </div>

        <!-- 統計卡片 -->
        <div class="row g-3 mb-3">
          <div class="col-6 col-md-3">
            <div class="stat-card p-3 h-100">
              <div class="icon-bg"><i class="bi bi-cash-coin"></i></div>
              <small>總收入</small>
              <h3 id="dashTotalIncome" class="mb-1">$0</h3>
              <div class="d-flex justify-content-between">
                <span class="small opacity-75">本月</span>
                <span id="dashMonthIncome" class="small fw-semibold">$0</span>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stat-card p-3 h-100 alt-orange">
              <div class="icon-bg"><i class="bi bi-credit-card-2-front"></i></div>
              <small>總支出</small>
              <h3 id="dashTotalExpense" class="mb-1">$0</h3>
              <div class="d-flex justify-content-between">
                <span class="small opacity-75">本月</span>
                <span id="dashMonthExpense" class="small fw-semibold">$0</span>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stat-card p-3 h-100 alt-green">
              <div class="icon-bg"><i class="bi bi-bank"></i></div>
              <small>帳戶總餘額</small>
              <h3 id="dashTotalBalance" class="mb-1">$0</h3>
              <div class="d-flex justify-content-between">
                <span class="small opacity-75">帳戶數</span>
                <span id="dashAccountCount" class="small fw-semibold">0</span>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stat-card p-3 h-100">
              <div class="icon-bg"><i class="bi bi-people"></i></div>
              <small>會員總數</small>
              <h3 id="dashMemberTotal" class="mb-1">0</h3>
              <div class="d-flex justify-content-between">
                <span class="small opacity-75">逾期會費</span>
                <span id="dashMemberOverdue" class="badge bg-danger rounded-pill">0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 帳戶餘額 -->
        <div class="card card-hoverable mb-3">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-bank me-1"></i>帳戶餘額概覽</h6>
            <button class="btn btn-sm btn-outline-primary" onclick="AccountUI.openManager()"><i class="bi bi-gear"></i> 管理帳戶</button>
          </div>
          <div class="card-body">
            <div id="dashboardAccountBalances" class="row g-3">
              <!-- 動態填入 -->
            </div>
          </div>
        </div>

        <!-- 最新資料展示 -->
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="card card-hoverable h-100">
              <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-arrows-expand me-1"></i>最近交易</h6>
              </div>
              <div class="card-body p-2" id="dashboardRecentTx">
                <div class="text-center text-muted py-4">
                  <div class="loading-spinner"></div>
                  <div class="mt-2">載入中...</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card card-hoverable h-100">
              <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-person-plus me-1"></i>新加入會員</h6>
              </div>
              <div class="card-body p-2" id="dashboardRecentMembers">
                <div class="text-center text-muted py-4">
                  <div class="loading-spinner"></div>
                  <div class="mt-2">載入中...</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card card-hoverable h-100">
              <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-calendar-event me-1"></i>近期活動</h6>
              </div>
              <div class="card-body p-2" id="dashboardRecentActivities">
                <div class="text-center text-muted py-4">
                  <div class="loading-spinner"></div>
                  <div class="mt-2">載入中...</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 其他 sections 保持原有結構，但移除具體內容以節省空間 -->
      <section id="transactionsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-receipt me-2"></i>交易記錄</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-primary btn-sm" onclick="TransactionUI.open()"><i class="bi bi-plus-circle"></i> 新增交易</button>
          </div>
        </div>
        <div id="transactionsContent">
          <div class="text-center py-5">
            <div class="loading-spinner"></div>
            <div class="mt-2">載入中...</div>
          </div>
        </div>
      </section>

      <!-- 其他 sections 類似結構... -->
      <section id="membersSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-people me-2"></i>會員管理</h4>
          <button class="btn btn-success btn-sm" onclick="MemberUI.open()"><i class="bi bi-person-plus"></i> 新增會員</button>
        </div>
        <div id="membersContent">
          <div class="text-center py-5">
            <div class="loading-spinner"></div>
            <div class="mt-2">載入中...</div>
          </div>
        </div>
      </section>

      <section id="activitiesSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-calendar-event me-2"></i>活動管理</h4>
          <button class="btn btn-info btn-sm text-white" onclick="ActivityUI.open()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
        </div>
        <div id="activitiesContent">
          <div class="text-center py-5">
            <div class="loading-spinner"></div>
            <div class="mt-2">載入中...</div>
          </div>
        </div>
      </section>

      <section id="announcementsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-megaphone me-2"></i>公告管理</h4>
          <button class="btn btn-warning btn-sm" onclick="AnnouncementUI.open()"><i class="bi bi-plus-circle"></i> 新增公告</button>
        </div>
        <div id="announcementsContent">
          <div class="text-center py-5">
            <div class="loading-spinner"></div>
            <div class="mt-2">載入中...</div>
          </div>
        </div>
      </section>

      <section id="formsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-file-earmark-arrow-down me-2"></i>行政表單</h4>
          <button class="btn btn-primary btn-sm" onclick="FormUI.openManager()"><i class="bi bi-gear"></i> 管理表單</button>
        </div>
        <div id="formsContent">
          <div class="text-center py-5">
            <div class="loading-spinner"></div>
            <div class="mt-2">載入中...</div>
          </div>
        </div>
      </section>

      <section id="analyticsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-graph-up me-2"></i>統計分析</h4>
        </div>
        <div id="analyticsContent">
          <div class="text-center py-5">
            <div class="loading-spinner"></div>
            <div class="mt-2">載入中...</div>
          </div>
        </div>
      </section>

      <section id="reportsSection" class="content-section" style="display:none;">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>報表中心</h4>
        </div>
        <div id="reportsContent">
          <div class="text-center py-5">
            <div class="loading-spinner"></div>
            <div class="mt-2">載入中...</div>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- Toast 容器 -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:2000;">
  <div id="toastSuccess" class="toast align-items-center border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body"><i class="bi bi-check-circle text-success me-2"></i><span id="toastSuccessMsg">成功</span></div>
      <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  <div id="toastError" class="toast align-items-center border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body"><i class="bi bi-exclamation-triangle text-danger me-2"></i><span id="toastErrorMsg">錯誤</span></div>
      <button class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- 依賴套件 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  // ============================================================================
  // API 配置與核心功能
  // ============================================================================
  
  const CONFIG = {
    GAS_URL: 'https://script.google.com/macros/s/AKfycbxJOxH9KFPf6Zye9NyNP1uo0qiI780wpz6hqkQa2piFXG9Hek3XBzqRtmJCMejh60bIqA/exec', // 請替換為實際的GAS URL
    TIMEOUT: 30000 // 30秒超時
  };

  // API 呼叫核心函數
  const API = {
    async call(action, data = {}) {
      try {
        UI.showLoading(true);
        
        const payload = { action, data };
        const response = await fetch(CONFIG.GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || '未知錯誤');
        }
        
        return result;
      } catch (error) {
        console.error('API Error:', error);
        UI.showToast('error', `API 錯誤: ${error.message}`);
        throw error;
      } finally {
        UI.showLoading(false);
      }
    },

    // 初始化資料庫
    async initializeSheets() {
      try {
        const result = await this.call('initializeSheets');
        UI.showToast('success', result.message || '資料庫初始化完成');
        return result;
      } catch (error) {
        UI.showToast('error', '資料庫初始化失敗');
        throw error;
      }
    },

    // 交易相關
    async getTransactions(params = {}) {
      return await this.call('getTransactions', params);
    },

    async saveTransaction(data) {
      return await this.call('saveTransaction', data);
    },

    async deleteTransaction(id) {
      return await this.call('deleteTransaction', { id });
    },

    // 會員相關
    async getMembers(params = {}) {
      return await this.call('getMembers', params);
    },

    async saveMember(data) {
      return await this.call('saveMember', data);
    },

    async deleteMember(id) {
      return await this.call('deleteMember', { id });
    },

    // 帳戶相關
    async getAccounts() {
      return await this.call('getAccounts');
    },

    async saveAccount(data) {
      return await this.call('saveAccount', data);
    },

    async deleteAccount(id) {
      return await this.call('deleteAccount', { id });
    },

    // 活動相關
    async getActivities(params = {}) {
      return await this.call('getActivities', params);
    },

    async saveActivity(data) {
      return await this.call('saveActivity', data);
    },

    async deleteActivity(id) {
      return await this.call('deleteActivity', { id });
    },

    // 報名相關
    async getRegistrations(params = {}) {
      return await this.call('getRegistrations', params);
    },

    async saveRegistration(data) {
      return await this.call('saveRegistration', data);
    },

    // 公告相關
    async getAnnouncements(params = {}) {
      return await this.call('getAnnouncements', params);
    },

    async saveAnnouncement(data) {
      return await this.call('saveAnnouncement', data);
    },

    async deleteAnnouncement(id) {
      return await this.call('deleteAnnouncement', { id });
    },

    // 表單相關
    async getForms() {
      return await this.call('getForms');
    },

    async saveForm(data) {
      return await this.call('saveForm', data);
    },

    async deleteForm(id) {
      return await this.call('deleteForm', { id });
    },

    // 設定相關
    async getSettings() {
      return await this.call('getSettings');
    },

    async saveSettings(data) {
      return await this.call('saveSettings', data);
    },

    // 統計相關
    async getDashboardStats() {
      return await this.call('getDashboardStats');
    },

    async getAnalyticsData(params) {
      return await this.call('getAnalyticsData', params);
    },

    // 報表相關
    async generateReport(params) {
      return await this.call('generateReport', params);
    }
  };

  // ============================================================================
  // UI 工具函數
  // ============================================================================
  
  const UI = {
    showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    },

    showToast(type, message) {
      const toastId = type === 'success' ? 'toastSuccess' : 'toastError';
      const msgId = type === 'success' ? 'toastSuccessMsg' : 'toastErrorMsg';
      
      document.getElementById(msgId).textContent = message;
      const toast = new bootstrap.Toast(document.getElementById(toastId));
      toast.show();
    },

    formatNumber(num) {
      return (Number(num) || 0).toLocaleString();
    },

    formatDate(date) {
      if (!date) return '';
      return new Date(date).toLocaleDateString('zh-TW');
    },

    async confirm(options) {
      return await Swal.fire({
        icon: options.icon || 'warning',
        title: options.title || '確定？',
        text: options.text || '',
        showCancelButton: true,
        confirmButtonText: options.confirmText || '確定',
        cancelButtonText: options.cancelText || '取消',
        confirmButtonColor: options.confirmColor || '#0d6efd'
      });
    }
  };

  // ============================================================================
  // 應用程式佈局控制
  // ============================================================================
  
  const AppLayout = {
    currentSection: 'dashboard',

    showSection(name, link) {
      // 隱藏所有 sections
      document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
      
      // 顯示目標 section
      document.getElementById(name + 'Section').style.display = 'block';
      
      // 更新導航狀態
      document.querySelectorAll('.sidebar .nav-link').forEach(a => a.classList.remove('active'));
      if (link) link.classList.add('active');
      
      this.currentSection = name;
      
      // 載入對應數據
      this.loadSectionData(name);
      
      // 行動裝置自動收起側邊欄
      if (window.innerWidth < 992) {
        this.toggleSidebar(false);
      }
    },

    async loadSectionData(section) {
      try {
        switch (section) {
          case 'dashboard':
            await Dashboard.refresh();
            break;
          case 'transactions':
            await Transactions.load();
            break;
          case 'members':
            await Members.load();
            break;
          case 'activities':
            await Activities.load();
            break;
          case 'announcements':
            await Announcements.load();
            break;
          case 'forms':
            await Forms.load();
            break;
          case 'analytics':
            await Analytics.load();
            break;
          case 'reports':
            await Reports.load();
            break;
        }
      } catch (error) {
        console.error(`載入 ${section} 數據失敗:`, error);
      }
    },

    toggleSidebar(force) {
      const sidebar = document.getElementById('sidebar');
      if (typeof force === 'boolean') {
        sidebar.classList.toggle('show', force);
      } else {
        sidebar.classList.toggle('show');
      }
    }
  };

  // ============================================================================
  // 儀表板模組
  // ============================================================================

    const Dashboard = {
    async refresh() {
      try {
        const result = await API.getDashboardStats();
        const stats = result.data;
        
        // 更新統計卡片
        document.getElementById('dashTotalIncome').textContent = '$' + UI.formatNumber(stats.totalIncome);
        document.getElementById('dashTotalExpense').textContent = '$' + UI.formatNumber(stats.totalExpense);
        document.getElementById('dashMonthIncome').textContent = '$' + UI.formatNumber(stats.monthIncome);
        document.getElementById('dashMonthExpense').textContent = '$' + UI.formatNumber(stats.monthExpense);
        document.getElementById('dashTotalBalance').textContent = '$' + UI.formatNumber(stats.totalBalance);
        document.getElementById('dashAccountCount').textContent = stats.accountCount;
        document.getElementById('dashMemberTotal').textContent = stats.memberTotal;
        document.getElementById('dashMemberOverdue').textContent = stats.overdueMembers;
        
        // 更新帳戶餘額
        this.renderAccountBalances(stats.accounts);
        
        // 更新最近資料
        this.renderRecentTransactions(stats.recentTransactions);
        this.renderRecentMembers(stats.recentMembers);
        
      } catch (error) {
        console.error('載入儀表板失敗:', error);
      }
    },

    renderAccountBalances(accounts) {
      const container = document.getElementById('dashboardAccountBalances');
      if (!accounts || !accounts.length) {
        container.innerHTML = '<div class="col-12 text-muted">尚無帳戶</div>';
        return;
      }
      
      container.innerHTML = accounts.map(account => `
        <div class="col-6 col-md-3">
          <div class="border rounded p-2 h-100 small bg-white">
            <div class="d-flex justify-content-between">
              <span class="fw-semibold">${account.name}</span>
              <span class="badge ${account.active ? 'bg-success' : 'bg-secondary'}">${account.active ? '啟用' : '停用'}</span>
            </div>
            <div class="mt-1">
              <span class="text-muted">餘額：</span>
              <span class="${account.balance >= 0 ? 'text-success' : 'text-danger'} fw-semibold">$${UI.formatNumber(account.balance)}</span>
            </div>
          </div>
        </div>
      `).join('');
    },

    renderRecentTransactions(transactions) {
      const container = document.getElementById('dashboardRecentTx');
      if (!transactions || !transactions.length) {
        container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-receipt display-6 d-block mb-2"></i> 尚無交易</div>';
        return;
      }
      
      container.innerHTML = transactions.map(tx => `
        <div class="d-flex justify-content-between align-items-center border-bottom py-2 small">
          <div>
            <div class="fw-semibold">${tx['類別'] || ''}</div>
            <div class="text-muted">${tx['日期'] || ''} ${tx['對象'] || ''}</div>
          </div>
          <div class="text-end">
            <span class="badge ${tx['類型'] === '收入' ? 'bg-success' : 'bg-danger'}">${tx['類型'] === '收入' ? '+' : '-'}$${UI.formatNumber(tx['金額'])}</span>
          </div>
        </div>
      `).join('');
    },

    renderRecentMembers(members) {
      const container = document.getElementById('dashboardRecentMembers');
      if (!members || !members.length) {
        container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-people display-6 d-block mb-2"></i> 尚無會員</div>';
        return;
      }
      
      container.innerHTML = members.map(member => `
        <div class="d-flex align-items-center border-bottom py-2 small">
          <div class="member-avatar me-2"><i class="bi bi-person"></i></div>
          <div class="flex-grow-1">
            <div class="fw-semibold">${member['姓名'] || ''}</div>
            <div class="text-muted">${member['加入日期'] || ''}</div>
          </div>
          <span class="badge ${this.getStatusBadgeClass(member['狀態'])}">${this.getStatusText(member['狀態'])}</span>
        </div>
      `).join('');
    },

    getStatusBadgeClass(status) {
      const classes = {
        'active': 'bg-success',
        'inactive': 'bg-danger',
        'pending': 'bg-warning text-dark'
      };
      return classes[status] || 'bg-secondary';
    },

    getStatusText(status) {
      const texts = {
        'active': '正常',
        'inactive': '停權',
        'pending': '待審核'
      };
      return texts[status] || '未知';
    }
  };

  // ============================================================================
  // 交易模組
  // ============================================================================
  
  const Transactions = {
    data: [],
    currentPage: 1,
    pageSize: 10,

    async load() {
      try {
        const result = await API.getTransactions();
        this.data = result.data;
        this.render();
      } catch (error) {
        document.getElementById('transactionsContent').innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>載入交易記錄失敗: ${error.message}
          </div>
        `;
      }
    },

    render() {
      const container = document.getElementById('transactionsContent');
      if (!this.data.length) {
        container.innerHTML = `
          <div class="text-center py-5 text-muted">
            <i class="bi bi-inbox display-6 d-block mb-2"></i>
            <div>尚無交易記錄</div>
          </div>
        `;
        return;
      }

      // 簡化的表格顯示
      container.innerHTML = `
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>日期</th><th>類型</th><th>類別</th><th>金額</th><th>對象</th><th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${this.data.slice(0, 20).map(tx => `
                    <tr>
                      <td>${tx['日期'] || ''}</td>
                      <td><span class="badge ${tx['類型'] === '收入' ? 'bg-success' : 'bg-danger'}">${tx['類型'] || ''}</span></td>
                      <td>${tx['類別'] || ''}</td>
                      <td class="text-end fw-semibold">${tx['類型'] === '收入' ? '+' : '-'}$${UI.formatNumber(tx['金額'])}</td>
                      <td>${tx['對象'] || '-'}</td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="TransactionUI.edit('${tx.ID}')">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="Transactions.delete('${tx.ID}')">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ${this.data.length > 20 ? '<div class="text-muted text-center mt-2">僅顯示前 20 筆記錄</div>' : ''}
          </div>
        </div>
      `;
    },

    async delete(id) {
      const result = await UI.confirm({
        title: '刪除交易',
        text: '確定要刪除此筆交易嗎？',
        confirmColor: '#dc3545'
      });

      if (result.isConfirmed) {
        try {
          await API.deleteTransaction(id);
          UI.showToast('success', '交易已刪除');
          await this.load();
          await Dashboard.refresh();
        } catch (error) {
          UI.showToast('error', '刪除失敗');
        }
      }
    }
  };

  // ============================================================================
  // 會員模組
  // ============================================================================
  
  const Members = {
    data: [],

    async load() {
      try {
        const result = await API.getMembers();
        this.data = result.data;
        this.render();
      } catch (error) {
        document.getElementById('membersContent').innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>載入會員資料失敗: ${error.message}
          </div>
        `;
      }
    },

    render() {
      const container = document.getElementById('membersContent');
      if (!this.data.length) {
        container.innerHTML = `
          <div class="text-center py-5 text-muted">
            <i class="bi bi-people display-6 d-block mb-2"></i>
            <div>尚無會員資料</div>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>姓名</th><th>電話</th><th>Email</th><th>加入日期</th><th>狀態</th><th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${this.data.slice(0, 20).map(member => `
                    <tr>
                      <td>
                        <div class="d-flex align-items-center">
                          <div class="member-avatar me-2">${(member['姓名'] || '').charAt(0)}</div>
                          <div>${member['姓名'] || ''}</div>
                        </div>
                      </td>
                      <td>${member['電話'] || ''}</td>
                      <td>${member['Email'] || '-'}</td>
                      <td>${member['加入日期'] || ''}</td>
                      <td><span class="badge ${Dashboard.getStatusBadgeClass(member['狀態'])}">${Dashboard.getStatusText(member['狀態'])}</span></td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="MemberUI.edit('${member.ID}')">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="Members.delete('${member.ID}')">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ${this.data.length > 20 ? '<div class="text-muted text-center mt-2">僅顯示前 20 筆記錄</div>' : ''}
          </div>
        </div>
      `;
    },

    async delete(id) {
      const result = await UI.confirm({
        title: '刪除會員',
        text: '確定要刪除此會員嗎？',
        confirmColor: '#dc3545'
      });

      if (result.isConfirmed) {
        try {
          await API.deleteMember(id);
          UI.showToast('success', '會員已刪除');
          await this.load();
          await Dashboard.refresh();
        } catch (error) {
          UI.showToast('error', '刪除失敗');
        }
      }
    }
  };

  // ============================================================================
  // 其他模組的簡化版本
  // ============================================================================
  
  const Activities = {
    async load() {
      try {
        const result = await API.getActivities();
        this.render(result.data);
      } catch (error) {
        document.getElementById('activitiesContent').innerHTML = `
          <div class="alert alert-danger">載入活動資料失敗: ${error.message}</div>
        `;
      }
    },

    render(data) {
      const container = document.getElementById('activitiesContent');
      if (!data.length) {
        container.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-calendar-event display-6 d-block mb-2"></i>尚無活動</div>';
        return;
      }
      
      container.innerHTML = `
        <div class="row g-3">
          ${data.slice(0, 12).map(activity => `
            <div class="col-md-6 col-lg-4">
              <div class="card h-100">
                <div class="card-body">
                  <h6 class="card-title">${activity['名稱'] || ''}</h6>
                  <p class="card-text small text-muted">
                    <i class="bi bi-calendar me-1"></i>${activity['日期'] || ''}<br>
                    <i class="bi bi-geo-alt me-1"></i>${activity['地點'] || ''}
                  </p>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-primary">${activity['狀態'] || ''}</span>
                    <div>
                      <button class="btn btn-sm btn-outline-primary" onclick="ActivityUI.edit('${activity.ID}')">編輯</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
  };

  const Announcements = {
    async load() {
      try {
        const result = await API.getAnnouncements();
        this.render(result.data);
      } catch (error) {
        document.getElementById('announcementsContent').innerHTML = `
          <div class="alert alert-danger">載入公告失敗: ${error.message}</div>
        `;
      }
    },

    render(data) {
      const container = document.getElementById('announcementsContent');
      if (!data.length) {
        container.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-megaphone display-6 d-block mb-2"></i>尚無公告</div>';
        return;
      }
      
      container.innerHTML = `
        <div class="row g-3">
          ${data.slice(0, 12).map(ann => `
            <div class="col-md-6 col-lg-4">
              <div class="card h-100">
                <div class="card-body">
                  <h6 class="card-title">${ann['標題'] || ''}</h6>
                  <p class="card-text small">${(ann['內容'] || '').substring(0, 100)}...</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-warning">${ann['類型'] || ''}</span>
                    <small class="text-muted">${ann['發布日期'] || ''}</small>
                  </div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
  };

  const Forms = {
    async load() {
      try {
        const result = await API.getForms();
        this.render(result.data);
      } catch (error) {
        document.getElementById('formsContent').innerHTML = `
          <div class="alert alert-danger">載入表單失敗: ${error.message}</div>
        `;
      }
    },

    render(data) {
      const container = document.getElementById('formsContent');
      if (!data.length) {
        container.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-file-earmark-arrow-down display-6 d-block mb-2"></i>尚無表單</div>';
        return;
      }
      
      container.innerHTML = `
        <div class="row g-3">
          ${data.map(form => `
            <div class="col-md-6 col-lg-4">
              <div class="card h-100">
                <div class="card-body">
                  <h6 class="card-title">${form['名稱'] || ''}</h6>
                  <p class="card-text small">${form['說明'] || ''}</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-secondary">${form['分類'] || ''}</span>
                    <a href="${form['連結'] || '#'}" target="_blank" class="btn btn-sm btn-primary">下載</a>
                  </div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
  };

  const Analytics = {
    async load() {
      document.getElementById('analyticsContent').innerHTML = '<div class="text-center py-5"><i class="bi bi-graph-up display-6 text-muted"></i><br>統計分析功能開發中</div>';
    }
  };

  const Reports = {
    async load() {
      document.getElementById('reportsContent').innerHTML = '<div class="text-center py-5"><i class="bi bi-file-earmark-text display-6 text-muted"></i><br>報表功能開發中</div>';
    }
  };

  // ============================================================================
  // UI 控制器 (簡化版本)
  // ============================================================================
  
  const TransactionUI = {
    open() {
      Swal.fire({
        title: '新增交易',
        html: `
          <div class="text-start">
            <div class="mb-2">
              <label class="form-label">日期</label>
              <input id="txDate" type="date" class="form-control" value="${new Date().toISOString().split('T')[0]}">
            </div>
            <div class="mb-2">
              <label class="form-label">類型</label>
              <select id="txType" class="form-select">
                <option value="收入">收入</option>
                <option value="支出">支出</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">類別</label>
              <input id="txCategory" class="form-control" placeholder="例：會費、辦公費用">
            </div>
            <div class="mb-2">
              <label class="form-label">金額</label>
              <input id="txAmount" type="number" class="form-control" min="0">
            </div>
            <div class="mb-2">
              <label class="form-label">對象</label>
              <input id="txCounterparty" class="form-control" placeholder="可留空">
            </div>
            <div class="mb-2">
              <label class="form-label">說明</label>
              <textarea id="txDescription" class="form-control" rows="2"></textarea>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '儲存',
        cancelButtonText: '取消',
        preConfirm: () => {
          const data = {
            '日期': document.getElementById('txDate').value,
            '類型': document.getElementById('txType').value,
            '類別': document.getElementById('txCategory').value,
            '金額': parseFloat(document.getElementById('txAmount').value) || 0,
            '對象': document.getElementById('txCounterparty').value,
            '帳戶': '現金', // 預設
            '說明': document.getElementById('txDescription').value
          };
          
          if (!data['類別'] || !data['金額']) {
            Swal.showValidationMessage('請填寫必要欄位');
            return false;
          }
          
          return data;
        }
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await API.saveTransaction(result.value);
            UI.showToast('success', '交易已儲存');
            if (AppLayout.currentSection === 'transactions') {
              await Transactions.load();
            }
            await Dashboard.refresh();
          } catch (error) {
            UI.showToast('error', '儲存失敗');
          }
        }
      });
    },

    edit(id) {
      UI.showToast('info', '編輯功能開發中');
    }
  };

  const MemberUI = {
    open() {
      Swal.fire({
        title: '新增會員',
        html: `
          <div class="text-start">
            <div class="mb-2">
              <label class="form-label">姓名 *</label>
              <input id="memberName" class="form-control">
            </div>
            <div class="mb-2">
              <label class="form-label">電話 *</label>
              <input id="memberPhone" class="form-control">
            </div>
            <div class="mb-2">
              <label class="form-label">Email</label>
              <input id="memberEmail" type="email" class="form-control">
            </div>
            <div class="mb-2">
              <label class="form-label">加入日期</label>
              <input id="memberJoinDate" type="date" class="form-control" value="${new Date().toISOString().split('T')[0]}">
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '儲存',
        cancelButtonText: '取消',
        preConfirm: () => {
          const data = {
            '姓名': document.getElementById('memberName').value,
            '電話': document.getElementById('memberPhone').value,
            'Email': document.getElementById('memberEmail').value,
            '加入日期': document.getElementById('memberJoinDate').value,
            '狀態': 'active',
            '會員類型': 'regular',
            '年費': 1000
          };
          
          if (!data['姓名'] || !data['電話']) {
            Swal.showValidationMessage('請填寫姓名和電話');
            return false;
          }
          
          return data;
        }
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await API.saveMember(result.value);
            UI.showToast('success', '會員已新增');
            if (AppLayout.currentSection === 'members') {
              await Members.load();
            }
            await Dashboard.refresh();
          } catch (error) {
            UI.showToast('error', '新增失敗');
          }
        }
      });
    },

    edit(id) {
      UI.showToast('info', '編輯功能開發中');
    }
  };

  const ActivityUI = {
    open() {
      UI.showToast('info', '活動新增功能開發中');
    },

    edit(id) {
      UI.showToast('info', '活動編輯功能開發中');
    }
  };

  const AnnouncementUI = {
    open() {
      UI.showToast('info', '公告新增功能開發中');
    }
  };

  const FormUI = {
    openManager() {
      UI.showToast('info', '表單管理功能開發中');
    }
  };

  const AccountUI = {
    openManager() {
      UI.showToast('info', '帳戶管理功能開發中');
    }
  };

  const SettingsUI = {
    open() {
      UI.showToast('info', '系統設定功能開發中');
    }
  };

  const GlobalSearch = {
    exec() {
      const keyword = document.getElementById('globalSearchInput').value.trim();
      if (!keyword) {
        UI.showToast('error', '請輸入搜尋關鍵字');
        return;
      }
      UI.showToast('info', '搜尋功能開發中');
    }
  };

  const About = {
    show() {
      Swal.fire({
        title: '關於系統',
        html: `
          <div class="text-start">
            <p>台灣帕金森病友權益促進會 - 會計暨營運整合管理系統</p>
            <p>採用 Google Apps Script 後端 + Google Sheets 資料庫</p>
            <p>版本：v2.0 (API模式)</p>
            <hr>
            <p class="small text-muted">
              功能包含：財務管理、會員管理、活動管理、公告管理、表單管理、統計分析、報表生成等。
            </p>
          </div>
        `,
        confirmButtonText: '關閉'
      });
    }
  };

  // ============================================================================
  // 應用程式初始化
  // ============================================================================
  
  document.addEventListener('DOMContentLoaded', async function() {
    try {
      // 檢查 GAS URL 是否已設定
      if (CONFIG.GAS_URL.includes('你的GAS部署ID')) {
        UI.showToast('error', '請先設定 GAS_URL');
        return;
      }

      // 載入儀表板
      await Dashboard.refresh();
      
      // 設定快捷鍵
      document.addEventListener('keydown', (e) => {
        if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
          e.preventDefault();
          document.getElementById('globalSearchInput').focus();
        }
      });

      console.log('系統初始化完成');
      
    } catch (error) {
      console.error('系統初始化失敗:', error);
      UI.showToast('error', '系統初始化失敗，請檢查網路連線和 GAS 設定');
    }
  });

  // 暴露主要物件到全域（方便除錯）
  window.APP = {
    API, UI, Dashboard, Transactions, Members, Activities, 
    Announcements, Forms, Analytics, Reports, AppLayout
  };
</script>
</body>
</html>
