<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活動報名系統</title>
    
    <!-- 載入必要的 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    
    <!-- 自訂樣式 -->
    <style>
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            padding: 20px 0;
        }

        .navbar-brand img {
            height: 30px;
            margin-right: 10px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-profile img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .footer {
            background-color: #f8f9fa;
            padding: 1rem 0;
            margin-top: auto;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .nav-link {
            position: relative;
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: currentColor;
        }

        .btn-floating {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
  <!-- 在 body 開始處加入 -->
<div id="initialLoading" class="position-fixed w-100 h-100 bg-white d-flex justify-content-center align-items-center" style="z-index: 9999;">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">載入中...</span>
        </div>
        <h5>正在載入應用程式...</h5>
        <p class="text-muted small">請稍候片刻</p>
    </div>
</div>



    <!-- 載入中動畫 -->
    <div id="loading">
        <div class="spinner"></div>
    </div>

    <!-- 導航欄 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="your-logo.png" alt="Logo">
                活動報名系統
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-view="home">首頁</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-view="events">活動列表</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-view="myEvents">我的活動</a>
                    </li>
                    <li class="nav-item admin-only" style="display: none;">
                        <a class="nav-link" href="#" data-view="admin">管理員</a>
                    </li>
                </ul>
                
                <div class="user-profile">
                    <img src="default-avatar.png" alt="使用者頭像" id="userAvatar">
                    <span id="userName">載入中...</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要內容區 -->
    <div class="main-content">
        <div class="container">
            <div id="content">
                <!-- 動態內容將在這裡載入 -->
            </div>
        </div>
    </div>

    <!-- 浮動按鈕 -->
    <button class="btn btn-primary btn-floating d-none" id="scrollTopBtn">
        <i class="bi bi-arrow-up"></i>
    </button>

    <!-- 頁尾 -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0">© 2025 活動報名系統. All rights reserved.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">
                        <a href="#" class="text-decoration-none me-3">使用條款</a>
                        <a href="#" class="text-decoration-none me-3">隱私政策</a>
                        <a href="#" class="text-decoration-none">聯絡我們</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- 載入必要的 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- 載入自訂 JavaScript -->
    <!-- <script src="app.js"></script> -->
    
    <script>
      /**
 * 活動報名系統前端主程式
 * 整合所有功能，包含：
 * - LIFF 整合
 * - 使用者管理
 * - 活動管理
 * - 報名功能
 * - 管理員功能
 * - 統計分析
 */

// ================ 常數定義 ================
const LIFF_ID = '2001679903-r5VXNe5g';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyRnmCcOsNgRrri4kgYJQDjoyj2TCbaX9RUYW8DLUg-Rbps5SUpwnzLf14A5C_WAYs9fQ/exec';


// ================ 全域狀態 ================
const globalState = {
    isAdmin: false,
    userProfile: null,
    currentView: 'home',
    isEditing: false
};

// ================ 初始化相關 ================
document.addEventListener('DOMContentLoaded', initializeApp);

async function initializeApp() {
    try {
        showLoading();
        await initializeLiff();
        setupEventListeners();
        // 隱藏初始載入畫面
        document.getElementById('initialLoading').style.display = 'none';
        hideLoading();
    } catch (error) {
        console.error('初始化失敗:', error);
        handleError(error);
        hideLoading();
    }
}



async function initializeLiff() {
    try {
        await liff.init({ liffId: LIFF_ID });
        
        // 檢查是否登入
        if (!liff.isLoggedIn()) {
            // 如果在 LINE APP 內
            if (liff.isInClient()) {
                liff.login();
            } else {
                // 如果在外部瀏覽器
                const result = await Swal.fire({
                    title: '需要登入',
                    text: '請選擇登入方式',
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: '使用 LINE 登入',
                    cancelButtonText: '取消'
                });

                if (result.isConfirmed) {
                    liff.login();
                }
            }
            return;
        }

        const profile = await liff.getProfile();
        globalState.userProfile = profile;

        // 準備登入資訊
        const loginInfo = {
            userId: profile.userId,
            displayName: profile.displayName,
            pictureUrl: profile.pictureUrl || '',
            statusMessage: profile.statusMessage || '',
            os: liff.getOS(),
            language: liff.getLanguage(),
            version: liff.getVersion(),
            lineVersion: liff.getLineVersion(),
            isInClient: liff.isInClient(),
            userAgent: navigator.userAgent,
            screenWidth: window.screen.width,
            screenHeight: window.screen.height,
            loginTime: new Date().toISOString()
        };

        // 記錄登入
        await recordLoginInfo(loginInfo);
        
        // 檢查管理員權限
        await checkAdminStatus(profile.userId);

        // 更新UI
        updateUIWithUserInfo(profile);
        await loadUserProfile(profile);
        showHome();

    } catch (error) {
        console.error('LIFF初始化錯誤:', error);
        Swal.fire({
            title: 'LIFF 初始化失敗',
            text: '請確認您是否使用最新版本的 LINE 應用程式，或是使用支援的瀏覽器',
            icon: 'error',
            confirmButtonText: '確定'
        });
    }
}


// ================ 工具函數 ================
const loading = {
    show: () => document.getElementById('loading').style.display = 'flex',
    hide: () => document.getElementById('loading').style.display = 'none'
};

function handleError(error, title = '錯誤') {
    console.error(error);
    
    // 針對特定錯誤提供更友善的提示
    let errorMessage = error.message || '發生未知錯誤';
    let errorTitle = title;

    if (error.message.includes('LIFF')) {
        errorTitle = 'LINE 登入問題';
        errorMessage = '請確認您已登入 LINE，或是使用支援的瀏覽器';
    }

    Swal.fire({
        icon: 'error',
        title: errorTitle,
        text: errorMessage,
        confirmButtonText: '確定'
    });
}


function showNotification(message, type = 'info') {
    Swal.fire({
        icon: type,
        title: type === 'error' ? '錯誤' : type === 'warning' ? '警告' : '提示',
        text: message,
        timer: type === 'error' ? 0 : 3000,
        timerProgressBar: true,
        showConfirmButton: type === 'error'
    });
}

function formatDateTime(dateTimeStr) {
    const dt = new Date(dateTimeStr);
    return `${dt.getFullYear()}/${(dt.getMonth()+1).toString().padStart(2, '0')}/${dt.getDate().toString().padStart(2, '0')} ${dt.getHours().toString().padStart(2, '0')}:${dt.getMinutes().toString().padStart(2, '0')}`;
}

// ================ API 請求處理 ================
async function apiRequest(action, method = 'GET', data = null) {
    try {
        const options = {
            method,
            headers: {
                'Content-Type': 'application/json'
            }
        };

        if (data) {
            options.body = JSON.stringify({
                action,
                ...data
            });
        }

        const url = method === 'GET' 
            ? `${GAS_URL}?action=${action}${data ? '&' + new URLSearchParams(data).toString() : ''}`
            : GAS_URL;

        const response = await fetch(url, options);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || '請求失敗');
        }

        return result;
    } catch (error) {
        console.error('API 請求錯誤:', error);
        throw error;
    }
}

// ================ 使用者相關功能 ================
async function recordLoginInfo(loginInfo) {
    try {
        const response = await apiRequest('recordLogin', 'POST', loginInfo);
        if (!response.success) {
            throw new Error(response.error || '登入記錄失敗');
        }
        document.getElementById('loginCount').textContent = response.loginCount;
        return response;
    } catch (error) {
        console.error('登入記錄錯誤:', error);
        showNotification('登入記錄發生問題，但您可以繼續使用系統', 'warning');
    }
}

async function checkAdminStatus(userId) {
    try {
        const result = await apiRequest('checkAdmin', 'GET', { userId });
        globalState.isAdmin = result.isAdmin;
        document.querySelector('.admin-only').style.display = globalState.isAdmin ? 'block' : 'none';
        return result;
    } catch (error) {
        console.error('檢查管理員權限失敗:', error);
        return { isAdmin: false };
    }
}

function updateUIWithUserInfo(profile) {
    document.getElementById('userPicture').src = profile.pictureUrl || 'default-avatar.png';
    document.getElementById('userName').textContent = profile.displayName;
    document.getElementById('userId').textContent = profile.userId;
}

// ================ 個人資料相關功能 ================
async function loadUserProfile(profile) {
    try {
        const result = await apiRequest('getUserProfile', 'GET', { userId: profile.userId });
        if (result.success) {
            globalState.userProfile = { ...globalState.userProfile, ...result.profile };
            displayProfile();
            populateProfileForm();
        }
    } catch (error) {
        handleError(error, '載入個人資料失敗');
    }
}

function displayProfile() {
    const profile = globalState.userProfile;
    const displayDiv = document.getElementById('profileDisplay');
    displayDiv.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>真實姓名：</strong>${profile.realName || '未設定'}</p>
                <p><strong>用餐習慣：</strong>${profile.diet || '葷'}</p>
                <p><strong>手機號碼：</strong>${profile.phone || '未設定'}</p>
            </div>
            <div class="col-md-6">
                <p><strong>生日：</strong>${profile.birthday || '未設定'}</p>
                <p><strong>身分證字號：</strong>${profile.idNumber || '未設定'}</p>
                <p><strong>電子信箱：</strong>${profile.email || '未設定'}</p>
            </div>
        </div>
    `;
}

function populateProfileForm() {
    const profile = globalState.userProfile;
    const form = document.getElementById('profileForm');
    form.realName.value = profile.realName || '';
    form.diet.value = profile.diet || '葷';
    form.phone.value = profile.phone || '';
    form.birthday.value = profile.birthday || '';
    form.idNumber.value = profile.idNumber || '';
    form.email.value = profile.email || '';
}





// ================ 活動相關功能 ================
async function showEvents() {
    try {
        loading.show();
        const result = await apiRequest('getEvents');
        
        if (result.success) {
            displayEvents(result.data);
            updateNavActive('活動列表');
        }
    } catch (error) {
        handleError(error, '載入活動列表失敗');
    } finally {
        loading.hide();
    }
}

function displayEvents(events) {
    const content = document.getElementById('content');
    if (!events || events.length === 0) {
        content.innerHTML = `
            <div class="alert alert-info">
                目前沒有進行中的活動
            </div>
        `;
        return;
    }

    content.innerHTML = `
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            ${events.map(event => createEventCard(event)).join('')}
        </div>
    `;
}

function createEventCard(event) {
    const isFullyBooked = event.currentParticipants >= event.maxParticipants;
    const hasRegistered = event.registeredUsers?.includes(globalState.userProfile.userId);
    
    return `
        <div class="col">
            <div class="card h-100 event-card">
                ${event.imageUrl ? `
                    <img src="${event.imageUrl}" class="card-img-top" alt="${event.title}">
                ` : ''}
                <div class="card-body">
                    <h5 class="card-title">${event.title}</h5>
                    <p class="card-text">${event.description}</p>
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> ${formatDateTime(event.startTime)}
                        </small>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="bi bi-geo-alt"></i> ${event.location || '地點未定'}
                        </small>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">報名狀況</small>
                            <small class="text-muted">
                                ${event.currentParticipants}/${event.maxParticipants}
                            </small>
                        </div>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar ${isFullyBooked ? 'bg-danger' : 'bg-success'}" 
                                 role="progressbar" 
                                 style="width: ${(event.currentParticipants/event.maxParticipants)*100}%">
                            </div>
                        </div>
                    </div>
                    <div class="d-grid">
                        ${hasRegistered ? `
                            <button class="btn btn-outline-danger" 
                                    onclick="cancelRegistration('${event.id}')">
                                取消報名
                            </button>
                        ` : `
                            <button class="btn btn-primary" 
                                    onclick="showRegistrationForm('${event.id}')"
                                    ${isFullyBooked ? 'disabled' : ''}>
                                ${isFullyBooked ? '已額滿' : '立即報名'}
                            </button>
                        `}
                    </div>
                </div>
            </div>
        </div>
    `;
}

async function showRegistrationForm(eventId) {
    try {
        loading.show();
        const result = await apiRequest('getEventDetail', 'GET', { eventId });
        
        if (result.success) {
            const event = result.data;
            const { value: formData } = await Swal.fire({
                title: '活動報名',
                html: `
                    <form id="registrationForm" class="text-start">
                        <div class="mb-3">
                            <label class="form-label required-field">姓名</label>
                            <input type="text" class="form-control" id="regName" 
                                   value="${globalState.userProfile.realName || ''}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label required-field">電話</label>
                            <input type="tel" class="form-control" id="regPhone" 
                                   value="${globalState.userProfile.phone || ''}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label required-field">電子信箱</label>
                            <input type="email" class="form-control" id="regEmail" 
                                   value="${globalState.userProfile.email || ''}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">飲食習慣</label>
                            <select class="form-select" id="regDiet">
                                <option value="葷" ${globalState.userProfile.diet === '葷' ? 'selected' : ''}>葷食</option>
                                <option value="素" ${globalState.userProfile.diet === '素' ? 'selected' : ''}>素食</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">備註</label>
                            <textarea class="form-control" id="regNotes" rows="3"></textarea>
                        </div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: '確認報名',
                cancelButtonText: '取消',
                preConfirm: () => {
                    const form = document.getElementById('registrationForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return false;
                    }
                    return {
                        eventId: eventId,
                        name: document.getElementById('regName').value,
                        phone: document.getElementById('regPhone').value,
                        email: document.getElementById('regEmail').value,
                        diet: document.getElementById('regDiet').value,
                        notes: document.getElementById('regNotes').value
                    };
                }
            });

            if (formData) {
                await submitRegistration(formData);
            }
        }
    } catch (error) {
        handleError(error, '報名失敗');
    } finally {
        loading.hide();
    }
}

async function submitRegistration(formData) {
    try {
        loading.show();
        const result = await apiRequest('register', 'POST', {
            ...formData,
            userId: globalState.userProfile.userId
        });
        
        if (result.success) {
            showNotification('報名成功！', 'success');
            showEvents(); // 重新載入活動列表
        }
    } catch (error) {
        handleError(error, '報名失敗');
    } finally {
        loading.hide();
    }
}

async function cancelRegistration(eventId) {
    try {
        const result = await Swal.fire({
            title: '確定要取消報名嗎？',
            text: '取消後如要參加需要重新報名',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '確定取消',
            cancelButtonText: '保持報名'
        });

        if (result.isConfirmed) {
            loading.show();
            const response = await apiRequest('cancelRegistration', 'POST', {
                eventId,
                userId: globalState.userProfile.userId
            });
            
            if (response.success) {
                showNotification('已取消報名', 'success');
                showEvents(); // 重新載入活動列表
            }
        }
    } catch (error) {
        handleError(error, '取消報名失敗');
    } finally {
        loading.hide();
    }
}

// ================ 我的活動相關功能 ================
async function showMyEvents() {
    try {
        loading.show();
        const result = await apiRequest('getMyEvents', 'GET', { 
            userId: globalState.userProfile.userId 
        });
        
        if (result.success) {
            displayMyEvents(result.data);
            updateNavActive('我的活動');
        }
    } catch (error) {
        handleError(error, '載入我的活動失敗');
    } finally {
        loading.hide();
    }
}

function displayMyEvents(events) {
    const content = document.getElementById('content');
    if (!events || events.length === 0) {
        content.innerHTML = `
            <div class="alert alert-info">
                您目前尚未報名任何活動
            </div>
        `;
        return;
    }

    content.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h2 class="mb-0">我的活動</h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>活動名稱</th>
                                <th>活動時間</th>
                                <th>活動地點</th>
                                <th>報名狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${events.map(event => createMyEventRow(event)).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}





// ================ 管理員功能 ================
async function showAdminPanel() {
    if (!globalState.isAdmin) {
        showNotification('您沒有管理員權限', 'error');
        return;
    }

    try {
        loading.show();
        const result = await apiRequest('getAdminData');
        
        if (result.success) {
            displayAdminPanel(result.data);
            updateNavActive('管理員');
        }
    } catch (error) {
        handleError(error, '載入管理面板失敗');
    } finally {
        loading.hide();
    }
}

function displayAdminPanel(data) {
    const content = document.getElementById('content');
    content.innerHTML = `
        <div class="row">
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">活動管理</h3>
                        <button class="btn btn-primary" onclick="showCreateEventForm()">
                            <i class="bi bi-plus-circle"></i> 新增活動
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>活動名稱</th>
                                        <th>時間</th>
                                        <th>地點</th>
                                        <th>報名狀況</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.events.map(event => createAdminEventRow(event)).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">系統統計</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">使用者分析</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="userChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    `;

    // 初始化統計圖表
    initializeCharts(data.stats);
}

function createAdminEventRow(event) {
    return `
        <tr>
            <td>
                <div class="fw-bold">${event.title}</div>
                <small class="text-muted">${event.description}</small>
            </td>
            <td>
                ${formatDateTime(event.startTime)}<br>
                <small class="text-muted">至</small><br>
                ${formatDateTime(event.endTime)}
            </td>
            <td>${event.location || '未指定'}</td>
            <td>
                <div class="progress mb-2" style="height: 5px;">
                    <div class="progress-bar ${event.currentParticipants >= event.maxParticipants ? 'bg-danger' : 'bg-success'}" 
                         role="progressbar" 
                         style="width: ${(event.currentParticipants/event.maxParticipants)*100}%">
                    </div>
                </div>
                <small>${event.currentParticipants}/${event.maxParticipants}</small>
            </td>
            <td>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" 
                            onclick="showEventDetails('${event.id}')">
                        <i class="bi bi-info-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" 
                            onclick="editEvent('${event.id}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="deleteEvent('${event.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `;
}

async function showCreateEventForm() {
    const { value: formData } = await Swal.fire({
        title: '新增活動',
        html: `
            <form id="eventForm" class="text-start">
                <div class="mb-3">
                    <label class="form-label required-field">活動名稱</label>
                    <input type="text" class="form-control" id="eventTitle" required>
                </div>
                <div class="mb-3">
                    <label class="form-label required-field">活動描述</label>
                    <textarea class="form-control" id="eventDescription" rows="3" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label required-field">開始時間</label>
                    <input type="datetime-local" class="form-control" id="eventStartTime" required>
                </div>
                <div class="mb-3">
                    <label class="form-label required-field">結束時間</label>
                    <input type="datetime-local" class="form-control" id="eventEndTime" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">活動地點</label>
                    <input type="text" class="form-control" id="eventLocation">
                </div>
                <div class="mb-3">
                    <label class="form-label required-field">人數上限</label>
                    <input type="number" class="form-control" id="eventMaxParticipants" required min="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">活動圖片網址</label>
                    <input type="url" class="form-control" id="eventImageUrl">
                </div>
            </form>
        `,
        showCancelButton: true,
        confirmButtonText: '建立活動',
        cancelButtonText: '取消',
        preConfirm: () => {
            const form = document.getElementById('eventForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return false;
            }
            return {
                title: document.getElementById('eventTitle').value,
                description: document.getElementById('eventDescription').value,
                startTime: document.getElementById('eventStartTime').value,
                endTime: document.getElementById('eventEndTime').value,
                location: document.getElementById('eventLocation').value,
                maxParticipants: document.getElementById('eventMaxParticipants').value,
                imageUrl: document.getElementById('eventImageUrl').value
            };
        }
    });

    if (formData) {
        try {
            loading.show();
            const result = await apiRequest('createEvent', 'POST', formData);
            
            if (result.success) {
                showNotification('活動建立成功！', 'success');
                showAdminPanel();
            }
        } catch (error) {
            handleError(error, '建立活動失敗');
        } finally {
            loading.hide();
        }
    }
}

// ================ 統計圖表功能 ================
function initializeCharts(stats) {
    // 活動統計圖表
    const statsCtx = document.getElementById('statsChart').getContext('2d');
    new Chart(statsCtx, {
        type: 'bar',
        data: {
            labels: stats.events.map(e => e.title),
            datasets: [{
                label: '報名人數',
                data: stats.events.map(e => e.participants),
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // 使用者分析圖表
    const userCtx = document.getElementById('userChart').getContext('2d');
    new Chart(userCtx, {
        type: 'pie',
        data: {
            labels: ['新使用者', '活躍使用者', '非活躍使用者'],
            datasets: [{
                data: [
                    stats.users.new,
                    stats.users.active,
                    stats.users.inactive
                ],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.5)',
                    'rgba(54, 162, 235, 0.5)',
                    'rgba(255, 99, 132, 0.5)'
                ],
                borderColor: [
                    'rgba(75, 192, 192, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true
        }
    });
}





// ================ API 請求處理 ================
async function apiRequest(endpoint, method = 'GET', data = null) {
    const options = {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${await liff.getAccessToken()}`
        }
    };

    if (data && (method === 'POST' || method === 'PUT')) {
        options.body = JSON.stringify(data);
    }

    const queryString = data && method === 'GET' ? 
        '?' + new URLSearchParams(data).toString() : '';

    try {
        const response = await fetch(`${GAS_URL}/${endpoint}${queryString}`, options);
        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.message || '請求失敗');
        }

        return result;
    } catch (error) {
        console.error('API請求錯誤:', error);
        throw error;
    }
}

// ================ UI 相關功能 ================
function setupEventListeners() {
    // 導航選單點擊事件
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const view = e.target.getAttribute('data-view');
            handleNavigation(view);
        });
    });

    // 視窗大小改變事件
    window.addEventListener('resize', () => {
        adjustUIForScreenSize();
    });

    // 初始調整UI
    adjustUIForScreenSize();
}

function handleNavigation(view) {
    switch (view) {
        case 'home':
            showHome();
            break;
        case 'events':
            showEvents();
            break;
        case 'myEvents':
            showMyEvents();
            break;
        case 'admin':
            if (globalState.isAdmin) {
                showAdminPanel();
            } else {
                showNotification('沒有權限訪問此頁面', 'error');
            }
            break;
        case 'profile':
            showProfile();
            break;
        default:
            showHome();
    }
}

function updateNavActive(viewName) {
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.textContent.trim() === viewName) {
            link.classList.add('active');
        }
    });
}

function adjustUIForScreenSize() {
    const isMobile = window.innerWidth < 768;
    document.body.classList.toggle('mobile-view', isMobile);
    // 其他響應式UI調整...
}

// ================ 通知與錯誤處理 ================
function showNotification(message, type = 'info') {
    const icon = {
        'success': 'check-circle-fill',
        'error': 'exclamation-triangle-fill',
        'warning': 'exclamation-circle-fill',
        'info': 'info-circle-fill'
    }[type];

    Swal.fire({
        icon: type,
        title: message,
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        customClass: {
            popup: 'colored-toast'
        }
    });
}

function handleError(error, defaultMessage = '發生錯誤') {
    console.error(error);
    showNotification(error.message || defaultMessage, 'error');
}

// ================ 日期時間處理 ================
function formatDateTime(dateString) {
    if (!dateString) return '未指定';
    
    const date = new Date(dateString);
    return new Intl.DateTimeFormat('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    }).format(date);
}

// ================ 表單驗證 ================
function validateForm(formData, requiredFields) {
    const errors = [];
    
    requiredFields.forEach(field => {
        if (!formData[field]) {
            errors.push(`${field} 為必填欄位`);
        }
    });

    if (errors.length > 0) {
        throw new Error(errors.join('\n'));
    }

    return true;
}

// ================ 樣式相關 ================
const styles = `
    .colored-toast.swal2-icon-success {
        background-color: #a5dc86 !important;
    }
    
    .colored-toast.swal2-icon-error {
        background-color: #f27474 !important;
    }
    
    .colored-toast.swal2-icon-warning {
        background-color: #f8bb86 !important;
    }
    
    .colored-toast.swal2-icon-info {
        background-color: #3fc3ee !important;
    }
    
    .colored-toast .swal2-title {
        color: white;
    }
    
    .colored-toast .swal2-close {
        color: white;
    }
    
    .colored-toast .swal2-html-container {
        color: white;
    }

    .required-field::after {
        content: '*';
        color: red;
        margin-left: 4px;
    }

    .event-card {
        transition: transform 0.2s;
    }

    .event-card:hover {
        transform: translateY(-5px);
    }

    #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .mobile-view .card {
        margin-bottom: 1rem;
    }

    .mobile-view .table-responsive {
        margin-bottom: 1rem;
    }
`;

// 添加樣式到頁面
const styleSheet = document.createElement('style');
styleSheet.textContent = styles;
document.head.appendChild(styleSheet);

// ================ 初始化應用 ================
initializeApp();


    </script>


    <script>
        // 捲動到頂部按鈕功能
        window.onscroll = function() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                document.getElementById('scrollTopBtn').classList.remove('d-none');
            } else {
                document.getElementById('scrollTopBtn').classList.add('d-none');
            }
        };

        document.getElementById('scrollTopBtn').onclick = function() {
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        // // 確保在 LINE 環境中運行
        // if (!window.location.href.includes('liff.line.me')) {
        //     document.body.innerHTML = `
        //         <div class="container mt-5">
        //             <div class="alert alert-danger" role="alert">
        //                 <h4 class="alert-heading">錯誤！</h4>
        //                 <p>此應用程式必須在 LINE 應用程式中運行。</p>
        //                 <hr>
        //                 <p class="mb-0">請使用 LINE 掃描 QR Code 或點擊連結開啟。</p>
        //             </div>
        //         </div>
        //     `;
        // }
    </script>
</body>
</html>
