<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="LINE活動報名系統">
    <title>活動報名系統</title>
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css" rel="stylesheet">
    
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        :root {
            --primary-color: #00B900;
            --secondary-color: #666666;
            --accent-color: #FF6B6B;
        }
        
        /* Loading 遮罩 */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        /* 卡片動畫效果 */
        .event-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        /* 必填欄位標記 */
        .required-field::after {
            content: '*';
            color: var(--accent-color);
            margin-left: 4px;
        }
        
        /* 表單樣式 */
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0,185,0,0.25);
        }
        
        /* 導航列樣式 */
        .navbar {
            background-color: var(--primary-color) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* 使用者資訊卡片 */
        #userInfo {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
        }
        
        #userPicture {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* 響應式調整 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            #userPicture {
                width: 60px;
                height: 60px;
            }
        }
        
        /* 活動狀態標籤 */
        .event-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .event-status.active {
            background-color: #28a745;
            color: white;
        }
        
        .event-status.full {
            background-color: var(--accent-color);
            color: white;
        }
        
        /* 按鈕樣式 */
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #009900;
            border-color: #009900;
        }
    </style>
</head>

<body>
    <!-- Loading 遮罩 -->
    <div id="loading" class="loading">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">載入中...</span>
        </div>
    </div>

    <!-- 導航欄 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">活動報名系統</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showHome()">首頁</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showEventList()">活動列表</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showMyEvents()">我的活動</a>
                    </li>
                    <li class="nav-item admin-only" style="display: none;">
                        <a class="nav-link" href="#" onclick="showAdmin()">管理員專區</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主要內容區 -->
    <div class="container mt-4">
        <!-- 使用者資訊卡片 -->
        <div id="userInfo" class="card mb-4 shadow-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <img id="userPicture" alt="使用者頭像">
                    </div>
                    <div class="col">
                        <h5 class="card-title mb-1" id="userName"></h5>
                        <p class="card-text text-muted small mb-0">登入次數：<span id="loginCount"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 個人資料卡片 -->
        <div class="card mb-4 shadow-sm" id="profileCard">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h5 class="mb-0">個人基本資料</h5>
                <button class="btn btn-primary btn-sm" onclick="toggleProfileEdit()">編輯資料</button>
            </div>
            <div class="card-body">
                <!-- 個人資料表單 -->
                <form id="profileForm" class="needs-validation" novalidate style="display: none;">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="realName" class="form-label required-field">真實姓名</label>
                            <input type="text" class="form-control" id="realName" required>
                            <div class="invalid-feedback">請輸入真實姓名</div>
                        </div>
                        <div class="col-md-6">
                            <label for="diet" class="form-label">用餐習慣</label>
                            <select class="form-select" id="diet">
                                <option value="葷">葷</option>
                                <option value="素">素</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="phone" class="form-label">手機號碼</label>
                            <input type="tel" class="form-control" id="phone" pattern="^09\d{8}$">
                            <div class="invalid-feedback">請輸入有效的台灣手機號碼</div>
                        </div>
                        <div class="col-md-6">
                            <label for="birthday" class="form-label">生日</label>
                            <input type="date" class="form-control" id="birthday">
                        </div>
                        <div class="col-md-6">
                            <label for="idNumber" class="form-label">身分證字號</label>
                            <input type="text" class="form-control" id="idNumber" pattern="^[A-Z][12]\d{8}$">
                            <div class="invalid-feedback">請輸入有效的身分證字號</div>
                        </div>
                        <div class="col-md-6">
                            <label for="email" class="form-label">電子信箱</label>
                            <input type="email" class="form-control" id="email">
                            <div class="invalid-feedback">請輸入有效的電子信箱地址</div>
                        </div>
                    </div>
                    <div class="text-end mt-3">
                        <button type="button" class="btn btn-secondary me-2" onclick="cancelProfileEdit()">取消</button>
                        <button type="submit" class="btn btn-primary">儲存資料</button>
                    </div>
                </form>

                <!-- 個人資料顯示區 -->
                <div id="profileDisplay"></div>
            </div>
        </div>

        <!-- 動態內容區 -->
        <div id="content"></div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script>
      // 常數定義
const LIFF_ID = '2001679903-r5VXNe5g';
const API_URL = 'https://script.google.com/macros/s/AKfycbyyXWyhSMsIghLqtsdaBBnEZp5KZzkRjv0N2yG-3t9fv8LE-IXBzyPPNFo1AYqpaqDqEg/exec';

// 全域變數
let isAdmin = false;
let currentProfile = null;
let isProfileEditing = false;
let csrfToken = null;

// 初始化
document.addEventListener('DOMContentLoaded', initializeLiff);

// LIFF 初始化
async function initializeLiff() {
    try {
        showLoading();
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            const profile = await liff.getProfile();
            csrfToken = generateCsrfToken();
            
            // 取得 LINE 相關資訊
            const lineInfo = {
                userId: profile.userId,
                displayName: profile.displayName,
                pictureUrl: profile.pictureUrl,
                statusMessage: profile.statusMessage,
                os: liff.getOS(),
                language: liff.getLanguage(),
                version: liff.getVersion(),
                lineVersion: liff.getLineVersion(),
                isInClient: liff.isInClient(),
                csrfToken: csrfToken
            };

            // 記錄登入資訊
            await recordLoginInfo(lineInfo);
            
            await Promise.all([
                updateUserInfo(profile),
                loadUserProfile(profile),
                checkAdminStatus(profile)
            ]);
            
            showHome();
        }
    } catch (err) {
        handleError(err, 'LIFF 初始化失敗');
    } finally {
        hideLoading();
    }
}


// API 服務類
class ApiService {
    constructor(baseUrl) {
        this.baseUrl = baseUrl;
        this.csrfToken = null;
        this.userId = null;
    }

    // 設置用戶 ID 和 CSRF Token
    setUserContext(userId, csrfToken) {
        this.userId = userId;
        this.csrfToken = csrfToken;
    }

    // 通用 API 請求方法
    async fetchApi(endpoint, method = 'GET', data = null) {
        try {
            const url = new URL(endpoint, this.baseUrl);
            
            // 對於 GET 請求，將參數加到 URL 中
            if (method === 'GET' && data) {
                Object.keys(data).forEach(key => 
                    url.searchParams.append(key, data[key])
                );
            }

            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            // 只在非 GET 請求時添加 body
            if (method !== 'GET' && data) {
                options.body = JSON.stringify({
                    ...data,
                    userId: this.userId,
                    csrfToken: this.csrfToken
                });
            }

            const response = await fetch(url, options);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || '操作失敗');
            }

            return result;

        } catch (error) {
            console.error('API 請求失敗:', error);
            throw new Error(`API 請求失敗: ${error.message}`);
        }
    }

    // 記錄登入
    async recordLogin(loginData) {
        return this.fetchApi('/api', 'POST', {
            action: 'recordLogin',
            ...loginData
        });
    }

    // 檢查管理員狀態
    async checkAdmin() {
        return this.fetchApi('/api', 'GET', {
            action: 'checkAdmin',
            userId: this.userId,
            csrfToken: this.csrfToken
        });
    }

    // 獲取用戶資料
    async getUserProfile() {
        return this.fetchApi('/api', 'GET', {
            action: 'getUserProfile',
            userId: this.userId,
            csrfToken: this.csrfToken
        });
    }

    // 更新用戶資料
    async updateProfile(profileData) {
        return this.fetchApi('/api', 'POST', {
            action: 'updateProfile',
            ...profileData
        });
    }

    // 獲取活動列表
    async getEvents() {
        return this.fetchApi('/api', 'GET', {
            action: 'getEvents',
            userId: this.userId,
            csrfToken: this.csrfToken
        });
    }

    // 報名活動
    async registerEvent(eventData) {
        return this.fetchApi('/api', 'POST', {
            action: 'registerEvent',
            ...eventData
        });
    }

    // 獲取我的報名記錄
    async getMyRegistrations() {
        return this.fetchApi('/api', 'GET', {
            action: 'getMyRegistrations',
            userId: this.userId,
            csrfToken: this.csrfToken
        });
    }
}

// 使用範例
const apiService = new ApiService(API_URL);

// 初始化時設置用戶上下文
function initializeApi(userId, csrfToken) {
    apiService.setUserContext(userId, csrfToken);
}

// 導出 API 服務實例
export default apiService;


// API 請求處理
async function apiRequest(action, method = 'GET', data = null) {
    try {
        const options = {
            method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            }
        };

        if (data) {
            options.body = JSON.stringify({ 
                action, 
                ...data,
                csrfToken 
            });
        }

        const url = method === 'GET' 
            ? `${API_URL}?action=${action}${data ? '&' + new URLSearchParams(data).toString() : ''}`
            : API_URL;

        const response = await fetch(url, options);
        
        if (!response.ok) {
            throw new Error('網路請求失敗');
        }

        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || '請求失敗');
        }
        
        return result;
    } catch (error) {
        throw new Error(`API 請求失敗: ${error.message}`);
    }
}

// 記錄登入資訊
async function recordLoginInfo(lineInfo) {
    try {
        const response = await apiRequest('recordLogin', 'POST', lineInfo);
        return response;
    } catch (error) {
        console.error('登入記錄失敗:', error);
        // 不中斷使用者體驗，僅記錄錯誤
    }
}

// 更新使用者資訊
async function updateUserInfo(profile) {
    document.getElementById('userPicture').src = profile.pictureUrl;
    document.getElementById('userName').textContent = profile.displayName;
}

// 載入使用者資料
async function loadUserProfile(profile) {
    try {
        const result = await apiRequest('getUserProfile', 'GET', { 
            userId: profile.userId 
        });
        
        if (result.success) {
            currentProfile = result.profile;
            displayProfile();
            populateProfileForm();
        }
    } catch (err) {
        handleError(err, '載入個人資料失敗');
    }
}

// 顯示個人資料
function displayProfile() {
    const displayDiv = document.getElementById('profileDisplay');
    displayDiv.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>真實姓名：</strong>${currentProfile.realName || '未設定'}</p>
                <p><strong>用餐習慣：</strong>${currentProfile.dietary || '葷'}</p>
                <p><strong>手機號碼：</strong>${currentProfile.phone || '未設定'}</p>
            </div>
            <div class="col-md-6">
                <p><strong>生日：</strong>${currentProfile.birthday || '未設定'}</p>
                <p><strong>身分證字號：</strong>${maskIdNumber(currentProfile.idNumber) || '未設定'}</p>
                <p><strong>電子信箱：</strong>${currentProfile.email || '未設定'}</p>
            </div>
        </div>
    `;
}

// 遮罩身分證字號
function maskIdNumber(idNumber) {
    return idNumber ? idNumber.substring(0, 3) + '****' + idNumber.substring(7) : '';
}

// 填充個人資料表單
function populateProfileForm() {
    const form = document.getElementById('profileForm');
    form.realName.value = currentProfile.realName || '';
    form.diet.value = currentProfile.dietary || '葷';
    form.phone.value = currentProfile.phone || '';
    form.birthday.value = currentProfile.birthday || '';
    form.idNumber.value = currentProfile.idNumber || '';
    form.email.value = currentProfile.email || '';
}

// 切換個人資料編輯模式
function toggleProfileEdit() {
    isProfileEditing = true;
    document.getElementById('profileForm').style.display = 'block';
    document.getElementById('profileDisplay').style.display = 'none';
}

// 取消編輯
function cancelProfileEdit() {
    isProfileEditing = false;
    document.getElementById('profileForm').style.display = 'none';
    document.getElementById('profileDisplay').style.display = 'block';
    document.getElementById('profileForm').classList.remove('was-validated');
    populateProfileForm();
}

// 表單提交處理
document.getElementById('profileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!this.checkValidity()) {
        e.stopPropagation();
        this.classList.add('was-validated');
        return;
    }

    try {
        showLoading();
        const profile = await liff.getProfile();
        const formData = {
            userId: profile.userId,
            realName: this.realName.value,
            dietary: this.diet.value,
            phone: this.phone.value,
            birthday: this.birthday.value,
            idNumber: this.idNumber.value,
            email: this.email.value
        };

        const result = await apiRequest('updateProfile', 'POST', formData);
        
        if (result.success) {
            await Swal.fire({
                icon: 'success',
                title: '成功',
                text: '資料儲存成功！',
                confirmButtonText: '確定'
            });
            currentProfile = formData;
            displayProfile();
            cancelProfileEdit();
        }
    } catch (err) {
        handleError(err, '儲存資料失敗');
    } finally {
        hideLoading();
    }
});

// 錯誤處理
function handleError(error, title) {
    console.error(error);
    Swal.fire({
        icon: 'error',
        title: title,
        text: error.message || '發生未知錯誤',
        confirmButtonText: '確定'
    });
}

// Loading 控制
function showLoading() {
    document.getElementById('loading').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

// CSRF Token 生成
function generateCsrfToken() {
    return Array.from(crypto.getRandomValues(new Uint8Array(16)))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
}

// 格式化日期時間
function formatDateTime(dateTimeStr) {
    const dt = new Date(dateTimeStr);
    return `${dt.getFullYear()}/${(dt.getMonth()+1).toString().padStart(2, '0')}/${dt.getDate().toString().padStart(2, '0')} ${dt.getHours().toString().padStart(2, '0')}:${dt.getMinutes().toString().padStart(2, '0')}`;
}
    </script>
</body>
</html>
