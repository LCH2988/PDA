<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>活動報名系統</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- 載入 Day.js 用於日期處理 -->
  <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
</head>

<body>
  <div id="app" class="min-h-screen bg-gray-100">
    <div v-if="isLoading" class="flex justify-center items-center h-screen">
      <div class="animate-spin rounded-full h-32 w-32 border-b-2 border-gray-900"></div>
    </div>

    <div v-else class="container mx-auto px-4 py-8">
      <!-- 頂部導航欄 -->
      <nav class="bg-white shadow-lg rounded-lg mb-6">
        <div class="container mx-auto px-6 py-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <img v-if="lineProfile.pictureUrl" :src="lineProfile.pictureUrl"
                                class="w-10 h-10 rounded-full">
              <div>
                <div class="text-xl font-semibold">{{lineProfile.displayName}}</div>
                <div class="text-sm text-gray-500">上次登入: {{formatDate(lastLoginTime)}}</div>
              </div>
            </div>
            <div class="text-sm text-gray-500">
              登入次數: {{loginCount}}
            </div>
          </div>
        </div>
      </nav>

      <!-- 首次登入表單 -->
      <div v-if="isFirstLogin" class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-6">請填寫基本資料</h2>
        <form @submit.prevent="submitUserInfo" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">
              姓名 * <span class="text-red-500" v-if="!userInfo.name">必填</span>
          </label>
              <input v-model="userInfo.name" type="text" required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
              :class="{'border-red-500': !userInfo.name && formSubmitted}">
            </div>

            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">用餐習慣</label>
              <select v-model="userInfo.mealPreference"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="葷食">葷食</option>
                                <option value="素食">素食</option>
                            </select>
            </div>

            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">手機號碼</label>
              <input v-model="userInfo.phone" type="tel" pattern="[0-9]{10}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">生日</label>
              <input v-model="userInfo.birthday" type="date"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">身分證字號</label>
              <input v-model="userInfo.idNumber" type="text"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">Email</label>
              <input v-model="userInfo.email" type="email"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
          </div>

          <div class="flex justify-between items-center">
            <p class="text-sm text-gray-500">* 為必填欄位</p>
            <button type="submit"
          :disabled="isLoading"
          class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
          <span v-if="isLoading">處理中...</span>
          <span v-else>提交資料</span>
      </button>
          </div>
        </form>
      </div>

      <!-- 主系統頁面 -->
      <div v-else>
        <!-- 導航選單 -->
        <div class="bg-white rounded-lg shadow-lg mb-6">
          <nav class="flex">
            <button v-for="tab in tabs" :key="tab.id"
                            @click="currentTab = tab.id"
                            :class="[
                                'px-4 py-3 text-sm font-medium flex-1',
                                currentTab === tab.id
                                    ? 'text-blue-600 border-b-2 border-blue-600'
                                    : 'text-gray-500 hover:text-gray-700 hover:border-gray-300'
                            ]">
                            {{ tab.name }}
                        </button>
          </nav>
        </div>

        <!-- 活動清單 -->
        <div v-if="currentTab === 'activities'" class="space-y-6">
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4">活動清單</h3>
            <div v-if="activities.length === 0" class="text-center text-gray-500 py-8">
              目前沒有活動
            </div>
            <div v-else class="space-y-4">
              <div v-for="activity in activities" :key="activity.id" class="border rounded-lg p-4 hover:bg-gray-50">
                <div class="flex justify-between items-start">
                  <div>
                    <h4 class="text-lg font-medium">{{activity.name}}</h4>
                    <p class="text-sm text-gray-500">{{formatDate(activity.date)}}</p>
                    <p class="text-sm text-gray-600 mt-2">{{activity.description}}</p>
                  </div>
                  <button @click="registerActivity(activity.id)"
                                        :disabled="activity.isFull"
                                        :class="[
                                            'px-4 py-2 rounded-md text-sm font-medium',
                                            activity.isFull
                                                ? 'bg-gray-300 text-gray-500'
                                                : 'bg-blue-600 text-white hover:bg-blue-700'
                                        ]">
                                        {{ activity.isFull ? '已額滿' : '報名' }}
                                    </button>
                </div>
                <div class="mt-4 text-sm text-gray-500">
                  <span>地點：{{activity.location}}</span>
                  <span class="mx-2">|</span>
                  <span>名額：{{activity.currentParticipants}}/{{activity.maxParticipants}}</span>
                  <span class="mx-2">|</span>
                  <span>報名截止：{{formatDate(activity.deadline)}}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 我的活動 -->
        <div v-if="currentTab === 'myActivities'" class="space-y-6">
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4">我的活動</h3>
            <div v-if="myActivities.length === 0" class="text-center text-gray-500 py-8">
              您尚未報名任何活動
            </div>
            <div v-else class="space-y-4">
              <div v-for="activity in myActivities" :key="activity.id" class="border rounded-lg p-4">
                <div class="flex justify-between items-start">
                  <div>
                    <h4 class="text-lg font-medium">{{activity.name}}</h4>
                    <p class="text-sm text-gray-500">{{formatDate(activity.date)}}</p>
                    <p class="text-sm text-gray-600 mt-2">{{activity.description}}</p>
                  </div>
                  <button @click="cancelRegistration(activity.id)"
                                        class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                                        取消報名
                                    </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 個人資料 -->
        <div v-if="currentTab === 'profile'" class="space-y-6">
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4">個人資料</h3>
            <form @submit.prevent="updateProfile" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 複製首次登入表單的輸入欄位，但預填現有資料 -->
                <div class="space-y-2">
                  <label class="block text-sm font-medium text-gray-700">姓名 *</label>
                  <input v-model="profile.name" type="text" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <!-- 其他欄位類似... -->
              </div>
              <div class="flex justify-end">
                <button type="submit"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    更新資料
                                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- 管理員專區 -->
        <div v-if="currentTab === 'admin' && isAdmin" class="space-y-6">
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4">管理員專區</h3>
            <!-- 新增活動表單 -->
            <form @submit.prevent="createActivity" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2">
                  <label class="block text-sm font-medium text-gray-700">活動名稱 *</label>
                  <input v-model="newActivity.name" type="text" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="space-y-2">
                  <label class="block text-sm font-medium text-gray-700">活動日期 *</label>
                  <input v-model="newActivity.date" type="datetime-local" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <!-- 其他活動相關欄位... -->
              </div>
              <div class="flex justify-end">
                <button type="submit"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    建立活動
                                </button>
              </div>
            </form>

            <!-- 活動管理列表 -->
            <div class="mt-8">
              <h4 class="text-lg font-medium mb-4">活動管理</h4>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        活動名稱
                      </th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        日期
                      </th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        報名人數
                      </th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        操作
                      </th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    <tr v-for="activity in activities" :key="activity.id">
                      <td class="px-6 py-4 whitespace-nowrap">
                        {{activity.name}}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        {{formatDate(activity.date)}}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        {{activity.currentParticipants}}/{{activity.maxParticipants}}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <button @click="editActivity(activity.id)"
                                                    class="text-blue-600 hover:text-blue-900 mr-4">
                                                    編輯
                                                </button>
                        <button @click="deleteActivity(activity.id)"
                                                    class="text-red-600 hover:text-red-900">
                                                    刪除
                                                </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 通知訊息 -->
    <div v-if="notification.show" class="fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg" :class="{
                'bg-green-500': notification.type === 'success',
                'bg-red-500': notification.type === 'error'
            }">
      <p class="text-white">{{ notification.message }}</p>
    </div>
  </div>

  <script>
    const { createApp, ref, onMounted, computed } = Vue

        // GAS 後端 API 網址
        const API_URL = 'https://script.google.com/macros/s/AKfycbzskhMQAvhvqj2cikJI-M1E1YwoHyajqSf2ot8kd4O4ySp_KFvp_0T573QGVYqkbfyXvg/exec'
        const LIFF_ID = '2001679903-r5VXNe5g'

        createApp({
            setup() {
                // 狀態管理
                const isLoading = ref(true)
                const isFirstLogin = ref(false)
                const lineProfile = ref({})
                const lastLoginTime = ref('')
                const loginCount = ref(0)
                const currentTab = ref('activities')
                const isAdmin = ref(false)
                const activities = ref([])
                const myActivities = ref([])
                const notification = ref({
                    show: false,
                    message: '',
                    type: 'success'
                })

                // 表單數據
                const userInfo = ref({
                    name: '',
                    mealPreference: '葷食',
                    phone: '',
                    birthday: '',
                    idNumber: '',
                    email: ''
                })

                const profile = ref({...userInfo.value})

                const newActivity = ref({
                    name: '',
                    date: '',
                    location: '',
                    description: '',
                    maxParticipants: 0,
                    deadline: ''
                })

                // 頁籤設定
                const tabs = computed(() => {
                    const basicTabs = [
                        { id: 'activities', name: '活動清單' },
                        { id: 'myActivities', name: '我的活動' },
                        { id: 'profile', name: '個人資料' }
                    ]
                    if (isAdmin.value) {
                        basicTabs.push({ id: 'admin', name: '管理員專區' })
                    }
                    return basicTabs
                })

                // LIFF 初始化
                const initializeLiff = async () => {
                    try {
                        await liff.init({ liffId: LIFF_ID })
                        if (!liff.isLoggedIn()) {
                            liff.login()
                        } else {
                            const profile = await liff.getProfile()
                            lineProfile.value = profile
                            await checkUserRegistration()
                        }
                    } catch (err) {
                        showNotification('LIFF 初始化失敗', 'error')
                        console.error('LIFF 初始化失敗', err)
                    }
                }

                // 檢查使用者註冊狀態
                const checkUserRegistration = async () => {
                    try {
                        const response = await fetch(`${API_URL}?action=checkUser&lineId=${lineProfile.value.userId}`)
                        const data = await response.json()
                        
                        isFirstLogin.value = !data.registered
                        if (data.registered) {
                            lastLoginTime.value = data.lastLogin
                            loginCount.value = data.loginCount
                            isAdmin.value = data.isAdmin
                            profile.value = data.profile
                            await fetchActivities()
                            if (!isFirstLogin.value) {
                                await fetchMyActivities()
                            }
                        }
                        
                        isLoading.value = false
                    } catch (err) {
                        showNotification('檢查使用者註冊失敗', 'error')
                        console.error('檢查使用者註冊失敗', err)
                    }
                }

                // 提交使用者資料
              // 提交使用者資料
const submitUserInfo = async () => {
  try {
    isLoading.value = true; // 新增載入狀態
    
    // 驗證必填欄位
    if (!userInfo.value.name) {
      showNotification('請填寫姓名', 'error');
      return;
    }

    const userData = {
      ...userInfo.value,
      lineId: lineProfile.value.userId,
      lineName: lineProfile.value.displayName
    };

    console.log('Submitting user data:', userData); // 新增除錯訊息

    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        action: 'registerUser',
        data: userData
      })
    });

    console.log('Response received:', response); // 新增除錯訊息

    const result = await response.json();
    console.log('Result:', result); // 新增除錯訊息

    if (result.data && result.data.success) {
      isFirstLogin.value = false;
      showNotification('註冊成功！', 'success');
      await checkUserRegistration();
    } else {
      throw new Error(result.data.error || '註冊失敗');
    }
  } catch (err) {
    console.error('註冊失敗:', err);
    showNotification(`註冊失敗: ${err.message}`, 'error');
  } finally {
    isLoading.value = false;
  }
};

                // 取得活動清單
                const fetchActivities = async () => {
                    try {
                        const response = await fetch(`${API_URL}?action=getActivities`)
                        const data = await response.json()
                        activities.value = data.activities
                    } catch (err) {
                        showNotification('取得活動清單失敗', 'error')
                        console.error('取得活動清單失敗', err)
                    }
                }

                // 取得我的活動
                const fetchMyActivities = async () => {
                    try {
                        const response = await fetch(`${API_URL}?action=getMyActivities&lineId=${lineProfile.value.userId}`)
                        const data = await response.json()
                        myActivities.value = data.activities
                    } catch (err) {
                        showNotification('取得我的活動失敗', 'error')
                        console.error('取得我的活動失敗', err)
                    }
                }

                // 報名活動
                const registerActivity = async (activityId) => {
                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'registerActivity',
                                data: {
                                    activityId,
                                    lineId: lineProfile.value.userId
                                }
                            })
                        })

                        const result = await response.json()
                        if (result.success) {
                            showNotification('報名成功！', 'success')
                            await fetchActivities()
                            await fetchMyActivities()
                        }
                    } catch (err) {
                        showNotification('報名失敗', 'error')
                        console.error('報名失敗', err)
                    }
                }

                // 取消報名
                const cancelRegistration = async (activityId) => {
                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'cancelRegistration',
                                data: {
                                    activityId,
                                    lineId: lineProfile.value.userId
                                }
                            })
                        })

                        const result = await response.json()
                        if (result.success) {
                            showNotification('取消報名成功！', 'success')
                            await fetchActivities()
                            await fetchMyActivities()
                        }
                    } catch (err) {
                        showNotification('取消報名失敗', 'error')
                        console.error('取消報名失敗', err)
                    }
                }

                // 更新個人資料
                const updateProfile = async () => {
                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'updateProfile',
                                data: {
                                    ...profile.value,
                                    lineId: lineProfile.value.userId
                                }
                            })
                        })

                        const result = await response.json()
                        if (result.success) {
                            showNotification('資料更新成功！', 'success')
                        }
                    } catch (err) {
                        showNotification('資料更新失敗', 'error')
                        console.error('資料更新失敗', err)
                    }
                }

                // 建立活動（管理員）
                const createActivity = async () => {
                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'createActivity',
                                data: newActivity.value
                            })
                        })

                        const result = await response.json()
                        if (result.success) {
                            showNotification('活動建立成功！', 'success')
                            newActivity.value = {
                                name: '',
                                date: '',
                                location: '',
                                description: '',
                                maxParticipants: 0,
                                deadline: ''
                            }
                            await fetchActivities()
                        }
                    } catch (err) {
                        showNotification('活動建立失敗', 'error')
                        console.error('活動建立失敗', err)
                    }
                }

                // 編輯活動（管理員）
                const editActivity = async (activityId) => {
                    // 實作編輯活動邏輯
                }

                // 刪除活動（管理員）
                const deleteActivity = async (activityId) => {
                    if (!confirm('確定要刪除此活動嗎？')) return

                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'deleteActivity',
                                data: { activityId }
                            })
                        })

                        const result = await response.json()
                        if (result.success) {
                            showNotification('活動刪除成功！', 'success')
                            await fetchActivities()
                        }
                    } catch (err) {
                        showNotification('活動刪除失敗', 'error')
                        console.error('活動刪除失敗', err)
                    }
                }

                // 顯示通知
                const showNotification = (message, type = 'success') => {
                    notification.value = {
                        show: true,
                        message,
                        type
                    }
                    setTimeout(() => {
                        notification.value.show = false
                    }, 3000)
                }

                // 格式化日期
                const formatDate = (date) => {
                    if (!date) return ''
                    return dayjs(date).format('YYYY/MM/DD HH:mm')
                }

                onMounted(() => {
                    initializeLiff()
                })

                return {
                    isLoading,
                    isFirstLogin,
                    lineProfile,
                    lastLoginTime,
                    loginCount,
                    currentTab,
                    isAdmin,
                    activities,
                    myActivities,
                    notification,
                    userInfo,
                    profile,
                    newActivity,
                    tabs,
                    submitUserInfo,
                    registerActivity,
                    cancelRegistration,
                    updateProfile,
                    createActivity,
                    editActivity,
                    deleteActivity,
                    formatDate
                }
            }
        }).mount('#app')
  </script>
</body>

</html>
