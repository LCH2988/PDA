<!-- index.html -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="LINE活動報名系統">
    <title>活動報名系統</title>
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css" rel="stylesheet">
    
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        :root {
            --primary-color: #00B900;
            --secondary-color: #666666;
            --accent-color: #FF6B6B;
            --background-color: #F8F9FA;
            --text-color: #333333;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading.active {
            display: flex;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #009900;
            border-color: #009900;
        }

        .profile-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
        }

        .error-message {
            color: var(--accent-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 185, 0, 0.25);
        }
    </style>
</head>
<body>
    <!-- Loading 遮罩 -->
    <div id="loading" class="loading">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">載入中...</span>
        </div>
    </div>

    <!-- 主要內容 -->
    <div class="container py-4">
        <!-- 使用者資料卡片 -->
        <div class="card mb-4">
            <div class="card-body text-center">
                <img id="profile-image" src="placeholder.png" alt="個人頭像" class="profile-image mb-3">
                <h5 id="user-name" class="card-title mb-0">載入中...</h5>
                <p id="login-count" class="text-muted small">登入次數: --</p>
            </div>
        </div>

        <!-- 個人資料表單 -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">個人資料</h5>
                <form id="profile-form" novalidate>
                    <div class="mb-3">
                        <label for="realName" class="form-label">真實姓名</label>
                        <input type="text" class="form-control" id="realName" name="realName" required>
                        <div class="error-message"></div>
                    </div>

                    <div class="mb-3">
                        <label for="phone" class="form-label">手機號碼</label>
                        <input type="tel" class="form-control" id="phone" name="phone" pattern="^09\d{8}$" required>
                        <div class="error-message"></div>
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label">電子信箱</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                        <div class="error-message"></div>
                    </div>

                    <div class="mb-3">
                        <label for="birthday" class="form-label">生日</label>
                        <input type="date" class="form-control" id="birthday" name="birthday">
                        <div class="error-message"></div>
                    </div>

                    <div class="mb-3">
                        <label for="idNumber" class="form-label">身分證字號</label>
                        <input type="text" class="form-control" id="idNumber" name="idNumber" pattern="^[A-Z][12]\d{8}$">
                        <div class="error-message"></div>
                    </div>

                    <div class="mb-3">
                        <label for="dietary" class="form-label">飲食習慣</label>
                        <select class="form-select" id="dietary" name="dietary">
                            <option value="">請選擇</option>
                            <option value="normal">一般</option>
                            <option value="vegetarian">素食</option>
                            <option value="halal">清真</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">更新資料</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script>
      // app.js

// 常數定義
const CONFIG = {
    LIFF_ID: '2001679903-r5VXNe5g',
    API_URL: 'https://script.google.com/macros/s/AKfycbwlm5t2R8BSUpq71rosRoTszaRjJNUT_Uw-fCksjvHK2wRfvOan008cZcE5mhJpTCCDKw/exec'
};

// 全域狀態
const state = {
    userId: null,
    csrfToken: null,
    profile: null
};

// API 服務
const apiService = {
    async request(action, data = {}) {
        const payload = {
            ...data,
            action,
            csrfToken: state.csrfToken
        };

        const response = await fetch(CONFIG.API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error('網路請求失敗');
        }

        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || '請求失敗');
        }

        return result;
    },

    async recordLogin(data) {
        return this.request('recordLogin', data);
    },

    async getUserProfile() {
        return this.request('getUserProfile', { userId: state.userId });
    },

    async updateProfile(profileData) {
        return this.request('updateProfile', {
            ...profileData,
            userId: state.userId
        });
    }
};

// UI 控制器
const uiController = {
    elements: {
        loading: document.getElementById('loading'),
        profileImage: document.getElementById('profile-image'),
        userName: document.getElementById('user-name'),
        loginCount: document.getElementById('login-count'),
        profileForm: document.getElementById('profile-form')
    },

    showLoading() {
        this.elements.loading.classList.add('active');
    },

    hideLoading() {
        this.elements.loading.classList.remove('active');
    },

    updateProfile(profile) {
        this.elements.profileImage.src = profile.pictureUrl;
        this.elements.userName.textContent = profile.displayName;
        this.elements.loginCount.textContent = `登入次數: ${profile.loginCount || 0}`;

        // 更新表單資料
        const form = this.elements.profileForm;
        Object.entries(profile).forEach(([key, value]) => {
            const input = form.elements[key];
            if (input) {
                input.value = value || '';
            }
        });
    },

    setupFormValidation() {
        const form = this.elements.profileForm;
        const inputs = form.querySelectorAll('input[required]');

        inputs.forEach(input => {
            input.addEventListener('input', () => {
                this.validateField(input);
            });
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (this.validateForm()) {
                await this.handleFormSubmit();
            }
        });
    },

    validateField(input) {
        const errorDiv = input.nextElementSibling;
        let isValid = true;
        let errorMessage = '';

        if (input.required && !input.value) {
            isValid = false;
            errorMessage = '此欄位為必填';
        } else if (input.pattern && !new RegExp(input.pattern).test(input.value)) {
            isValid = false;
            errorMessage = '格式不正確';
        }

        input.classList.toggle('is-invalid', !isValid);
        errorDiv.textContent = errorMessage;

        return isValid;
    },

    validateForm() {
        const form = this.elements.profileForm;
        const inputs = form.querySelectorAll('input[required]');
        let isValid = true;

        inputs.forEach(input => {
            if (!this.validateField(input)) {
                isValid = false;
            }
        });

        return isValid;
    },

    async handleFormSubmit() {
        try {
            this.showLoading();
            const form = this.elements.profileForm;
            const formData = new FormData(form);
            const profileData = Object.fromEntries(formData.entries());

            await apiService.updateProfile(profileData);
            
            await Swal.fire({
                icon: 'success',
                title: '更新成功',
                text: '您的個人資料已更新'
            });
        } catch (error) {
            console.error('更新失敗:', error);
            await Swal.fire({
                icon: 'error',
                title: '更新失敗',
                text: error.message || '請稍後再試'
            });
        } finally {
            this.hideLoading();
        }
    }
};

// 應用程式初始化
async function initializeApp() {
    try {
        uiController.showLoading();

        // 初始化 LIFF
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        // 檢查是否在 LINE 環境中
        if (!liff.isLoggedIn()) {
            await liff.login();
            return;
        }

        // 獲取用戶資料
        const profile = await liff.getProfile();
        state.userId = profile.userId;

        // 記錄登入
        const loginResult = await apiService.recordLogin({
            userId: profile.userId,
            displayName: profile.displayName,
            pictureUrl: profile.pictureUrl,
            statusMessage: profile.statusMessage,
            os: liff.getOS(),
            language: liff.getLanguage(),
            version: liff.getVersion(),
            lineVersion: liff.getLineVersion(),
            isInClient: liff.isInClient(),
            userAgent: navigator.userAgent,
            screenWidth: window.screen.width,
            screenHeight: window.screen.height
        });

        // 儲存 CSRF Token
        state.csrfToken = loginResult.csrfToken;

        // 載入用戶資料
        const userProfile = await apiService.getUserProfile();
        state.profile = userProfile.profile;

        // 更新 UI
        uiController.updateProfile(state.profile);
        uiController.setupFormValidation();

    } catch (error) {
        console.error('初始化失敗:', error);
        await Swal.fire({
            icon: 'error',
            title: '初始化失敗',
            text: error.message || '請重新整理頁面'
        });
    } finally {
        uiController.hideLoading();
    }
}

// 啟動應用程式
window.addEventListener('load', initializeApp);

    </script>
</body>
</html>
