<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活動報名系統</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --line-green: #00B900;
            --line-green-dark: #009900;
        }

        body {
            background-color: #f8f9fa;
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 1.25rem;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .profile-card {
            background: linear-gradient(145deg, var(--line-green), var(--line-green-dark));
            color: white;
        }

        .profile-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            margin: 20px auto;
            object-fit: cover;
        }

        .form-label {
            font-weight: bold;
        }

        .form-control, .form-select {
            font-size: 1.25rem;
            padding: 0.75rem;
            height: 3.5rem;
        }

        .btn-primary {
            background-color: var(--line-green);
            border-color: var(--line-green);
            font-size: 1.25rem;
            padding: 0.75rem;
        }

        .btn-primary:hover {
            background-color: var(--line-green-dark);
            border-color: var(--line-green-dark);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .form-error {
            color: #dc3545;
            font-size: 1rem;
            margin-top: 0.25rem;
            display: none;
        }

        .form-error.visible {
            display: block;
        }

        .event-card {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .event-card:hover {
            transform: translateY(-5px);
        }

        .event-image {
            height: 200px;
            object-fit: cover;
            border-radius: 15px 15px 0 0;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .step {
            padding: 0.5rem 1rem;
            margin: 0 0.5rem;
            border-radius: 20px;
            background: #e9ecef;
            color: #6c757d;
        }

        .step.active {
            background: var(--line-green);
            color: white;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay active">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">載入中...</span>
        </div>
    </div>

    <div class="container py-4">
        <div class="step-indicator mb-4">
            <div id="stepProfile" class="step active">個人資料</div>
            <div id="stepEvent" class="step">活動報名</div>
            <div id="stepConfirm" class="step">確認報名</div>
        </div>

        <!-- 個人資料區塊 -->
        <div id="profileSection">
            <div class="card profile-card mb-4">
                <div class="card-body text-center">
                    <img id="userAvatar" src="https://via.placeholder.com/150" alt="個人頭像" class="profile-image">
                    <h4 id="userName" class="mb-2">載入中...</h4>
                    <p id="userStats" class="mb-0 opacity-75">登入次數: --</p>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">個人資料</h5>
                    <form id="profileForm" novalidate>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">真實姓名 *</label>
                                <input type="text" class="form-control" name="realName" required>
                                <div class="form-error">請輸入真實姓名</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">手機號碼 *</label>
                                <input type="tel" class="form-control" name="phone" 
                                       pattern="^09\d{8}$" required>
                                <div class="form-error">請輸入有效的手機號碼</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">電子信箱 *</label>
                                <input type="email" class="form-control" name="email" required>
                                <div class="form-error">請輸入有效的電子信箱</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">生日</label>
                                <input type="date" class="form-control" name="birthday">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">身分證字號</label>
                                <input type="text" class="form-control" name="idNumber" 
                                       pattern="^[A-Z][12]\d{8}$">
                                <div class="form-error">請輸入有效的身分證字號</div>
                            </div>

                            <div class="col-12">
                                <label class="form-label">飲食習慣</label>
                                <select class="form-select" name="dietary">
                                    <option value="">請選擇</option>
                                    <option value="normal">一般</option>
                                    <option value="vegetarian">素食</option>
                                    <option value="halal">清真</option>
                                </select>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary w-100">
                                下一步：選擇活動
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 活動選擇區塊 -->
        <div id="eventSection" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">可報名活動</h5>
                    <div class="row g-4" id="eventList">
                        <!-- 活動卡片將由 JavaScript 動態生成 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 報名確認區塊 -->
        <div id="confirmSection" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">報名確認</h5>
                    <div id="confirmationDetails">
                        <!-- 確認資訊將由 JavaScript 動態生成 -->
                    </div>
                    <div class="mt-4">
                        <button id="submitRegistration" class="btn btn-primary w-100">
                            確認報名
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>

    <script>
    // 配置
    const CONFIG = {
        LIFF_ID: '2001679903-r5VXNe5g',
        API_URL: 'https://script.google.com/macros/s/AKfycbzp0BlDYUckxbf8uma_itcggcSIC2w9My3gVcqPX5YPpMLwfQ4VIBLtujClO3xgPFqdoA/exec',
        DEBUG: true
    };

    // 應用狀態
    const AppState = {
        userId: null,
        csrfToken: null,
        profile: null,
        currentStep: 'profile',
        selectedEvent: null
    };

    // UI 管理
    const UI = {
        elements: {
            loading: document.getElementById('loadingOverlay'),
            avatar: document.getElementById('userAvatar'),
            userName: document.getElementById('userName'),
            userStats: document.getElementById('userStats'),
            profileForm: document.getElementById('profileForm'),
            profileSection: document.getElementById('profileSection'),
            eventSection: document.getElementById('eventSection'),
            confirmSection: document.getElementById('confirmSection'),
            eventList: document.getElementById('eventList'),
            confirmationDetails: document.getElementById('confirmationDetails'),
            submitRegistration: document.getElementById('submitRegistration'),
            steps: {
                profile: document.getElementById('stepProfile'),
                event: document.getElementById('stepEvent'),
                confirm: document.getElementById('stepConfirm')
            }
        },

        setLoading(show) {
            this.elements.loading.classList.toggle('active', show);
        },

        updateProfile(profile) {
            this.elements.avatar.src = profile.pictureUrl || 'https://via.placeholder.com/150';
            this.elements.userName.textContent = profile.displayName || '未知用戶';
            this.elements.userStats.textContent = `登入次數: ${profile.loginCount || 0}`;

            const form = this.elements.profileForm;
            Object.entries(profile).forEach(([key, value]) => {
                const input = form.elements[key];
                if (input && value) {
                    input.value = value;
                }
            });
        },

        showStep(step) {
            AppState.currentStep = step;
            this.elements.profileSection.style.display = step === 'profile' ? 'block' : 'none';
            this.elements.eventSection.style.display = step === 'event' ? 'block' : 'none';
            this.elements.confirmSection.style.display = step === 'confirm' ? 'block' : 'none';

            // 更新步驟指示器
            Object.keys(this.elements.steps).forEach(key => {
                this.elements.steps[key].classList.toggle('active', key === step);
            });
        },

        renderEvents(events) {
            this.elements.eventList.innerHTML = events.map(event => `
                <div class="col-md-6 col-lg-4">
                    <div class="card event-card" onclick="selectEvent('${event.id}')">
                        <img src="${event.image}" class="event-image" alt="${event.title}">
                        <div class="card-body">
                            <h5 class="card-title">${event.title}</h5>
                            <p class="card-text">${event.description}</p>
                            <p class="card-text">
                                <small class="text-muted">
                                    日期：${event.date}<br>
                                    地點：${event.location}
                                </small>
                            </p>
                        </div>
                    </div>
                </div>
            `).join('');
        },

        updateConfirmation(profile, event) {
            this.elements.confirmationDetails.innerHTML = `
                <div class="row">
                    <div class="col-12">
                        <h6>活動資訊</h6>
                        <p>${event.title}<br>
                        日期：${event.date}<br>
                        地點：${event.location}</p>
                        
                        <h6>報名者資訊</h6>
                        <p>姓名：${profile.realName}<br>
                        電話：${profile.phone}<br>
                        信箱：${profile.email}<br>
                        飲食：${profile.dietary || '一般'}</p>
                    </div>
                </div>
            `;
        },

        async showAlert(options) {
            return Swal.fire({
                confirmButtonColor: '#00B900',
                ...options
            });
        }
    };

    // API 服務
    const ApiService = {
        async request(action, data = {}) {
            try {
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action,
                        csrfToken: AppState.csrfToken,
                        ...data
                    })
                });

                if (!response.ok) {
                    throw new Error('網路請求失敗');
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || '請求失敗');
                }

                return result;
            } catch (error) {
                console.error(`API ${action} 失敗:`, error);
                throw error;
            }
        },

        recordLogin: (data) => ApiService.request('recordLogin', data),
        getUserProfile: () => ApiService.request('getUserProfile', { userId: AppState.userId }),
        updateProfile: (data) => ApiService.request('updateProfile', { ...data, userId: AppState.userId }),
        getEvents: () => ApiService.request('getEvents'),
        registerEvent: (eventId, profileData) => ApiService.request('registerEvent', { 
            eventId, 
            profileData,
            userId: AppState.userId 
        })
    };

    // 表單驗證
    const FormValidator = {
        patterns: {
            phone: /^09\d{8}$/,
            email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
            idNumber: /^[A-Z][12]\d{8}$/
        },

        validateField(input) {
            const errorDiv = input.nextElementSibling;
            let isValid = true;
            let errorMessage = '';

            if (input.required && !input.value) {
                isValid = false;
                errorMessage = '此欄位為必填';
            } else if (input.pattern && !new RegExp(input.pattern).test(input.value)) {
                isValid = false;
                errorMessage = '格式不正確';
            }

            input.classList.toggle('is-invalid', !isValid);
            if (errorDiv?.classList.contains('form-error')) {
                errorDiv.classList.toggle('visible', !isValid);
                errorDiv.textContent = errorMessage;
            }

            return isValid;
        },

        validateForm(form) {
            const requiredInputs = form.querySelectorAll('input[required], input[pattern]');
            return Array.from(requiredInputs).every(input => this.validateField(input));
        },

        setupValidation(form) {
            const inputs = form.querySelectorAll('input[required], input[pattern]');
            inputs.forEach(input => {
                input.addEventListener('input', () => this.validateField(input));
                input.addEventListener('blur', () => this.validateField(input));
            });
        }
    };

    // 初始化應用
    async function initializeApp() {
        try {
            UI.setLoading(true);

            await liff.init({ liffId: CONFIG.LIFF_ID });
            
            if (!liff.isLoggedIn()) {
                await liff.login();
                return;
            }

            const profile = await liff.getProfile();
            AppState.userId = profile.userId;

            const loginResult = await ApiService.recordLogin({
                userId: profile.userId,
                displayName: profile.displayName,
                pictureUrl: profile.pictureUrl,
                statusMessage: profile.statusMessage,
                os: liff.getOS(),
                language: liff.getLanguage(),
                version: liff.getVersion(),
                lineVersion: liff.getLineVersion(),
                isInClient: liff.isInClient()
            });

            AppState.csrfToken = loginResult.csrfToken;

            const userProfile = await ApiService.getUserProfile();
            AppState.profile = userProfile.profile;

            UI.updateProfile(AppState.profile);
            FormValidator.setupValidation(UI.elements.profileForm);

            // 預先載入活動資料
            const events = await ApiService.getEvents();
            UI.renderEvents(events.data);

        } catch (error) {
            console.error('初始化失敗:', error);
            await UI.showAlert({
                icon: 'error',
                title: '初始化失敗',
                text: CONFIG.DEBUG ? error.message : '請重新整理頁面後再試'
            });
        } finally {
            UI.setLoading(false);
        }
    }

    // 處理個人資料表單提交
    async function handleProfileSubmit(event) {
        event.preventDefault();

        if (!FormValidator.validateForm(event.target)) {
            return;
        }

        try {
            UI.setLoading(true);

            const formData = new FormData(event.target);
            const profileData = Object.fromEntries(formData.entries());

            await ApiService.updateProfile(profileData);
            AppState.profile = { ...AppState.profile, ...profileData };
            
            UI.showStep('event');

        } catch (error) {
            console.error('更新失敗:', error);
            await UI.showAlert({
                icon: 'error',
                title: '更新失敗',
                text: CONFIG.DEBUG ? error.message : '請稍後再試'
            });
        } finally {
            UI.setLoading(false);
        }
    }

    // 選擇活動
    async function selectEvent(eventId) {
        try {
            const events = await ApiService.getEvents();
            const event = events.data.find(e => e.id === eventId);
            
            if (!event) {
                throw new Error('找不到活動資訊');
            }

            AppState.selectedEvent = event;
            UI.updateConfirmation(AppState.profile, event);
            UI.showStep('confirm');

        } catch (error) {
            await UI.showAlert({
                icon: 'error',
                title: '選擇活動失敗',
                text: error.message
            });
        }
    }

    // 確認報名
    async function handleRegistration() {
        try {
            UI.setLoading(true);

            await ApiService.registerEvent(
                AppState.selectedEvent.id,
                AppState.profile
            );

            await UI.showAlert({
                icon: 'success',
                title: '報名成功',
                text: '您已成功報名活動'
            });

            // 可以選擇關閉 LIFF 或返回步驟一
            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                UI.showStep('profile');
            }

        } catch (error) {
            await UI.showAlert({
                icon: 'error',
                title: '報名失敗',
                text: CONFIG.DEBUG ? error.message : '請稍後再試'
            });
        } finally {
            UI.setLoading(false);
        }
    }

    // 事件監聽
    UI.elements.profileForm.addEventListener('submit', handleProfileSubmit);
    UI.elements.submitRegistration.addEventListener('click', handleRegistration);
    window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
