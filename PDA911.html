<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活動報名系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
</head>
<body>
    <div id="loading" class="d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div id="main-content" class="container" style="display: none;">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">活動報名系統</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="profile-link">個人資料</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="events-link">活動列表</a>
                        </li>
                        <li class="nav-item d-none" id="admin-menu">
                            <a class="nav-link" href="#" id="admin-link">管理員專區</a>
                        </li>
                    </ul>
                    <div class="ms-auto">
                        <span id="user-name"></span>
                        <img id="user-picture" class="rounded-circle ms-2" style="width: 30px; height: 30px;" />
                    </div>
                </div>
            </div>
        </nav>

        <div id="content">
            <!-- 動態內容區域 -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // LIFF ID 設定
const LIFF_ID = '2001679903-r5VXNe5g';

// GAS Web App URL
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzZr85meAxFWWg9Dy2c0t3A3G0MBn0MRU7afOLbG-sfH29cMXrq-6eUM8YHXyDJaIAH/exec';


// 初始化 LIFF
async function initializeLiff() {
    try {
        await liff.init({ liffId: LIFF_ID });
        
        // 檢查是否已登入
        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }

        // 獲取使用者資料
        const profile = await liff.getProfile();
        await saveUserData(profile);
        
        // 檢查基本資料是否完整
        const userData = await checkUserProfile(profile.userId);
        
        if (!userData.isProfileComplete) {
            // 導向個人資料填寫頁面
            showProfileForm();
        } else {
            // 導向活動列表
            showEventList();
        }

        // 顯示主要內容
        document.getElementById('loading').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        
        // 設置使用者資訊
        document.getElementById('user-name').textContent = profile.displayName;
        document.getElementById('user-picture').src = profile.pictureUrl;

        // 檢查是否為管理員
        const isAdmin = await checkAdminStatus(profile.userId);
        if (isAdmin) {
            document.getElementById('admin-menu').classList.remove('d-none');
        }

    } catch (err) {
        console.error('LIFF 初始化失敗', err);
    }
}

// 儲存使用者資料
async function saveUserData(profile) {
    const data = {
        userId: profile.userId,
        displayName: profile.displayName,
        pictureUrl: profile.pictureUrl,
        timestamp: new Date().toISOString()
    };

    try {
        const response = await fetch(`${GAS_URL}?action=saveUser`, {
            method: 'POST',
            body: JSON.stringify(data)
        });
        return await response.json();
    } catch (err) {
        console.error('儲存使用者資料失敗', err);
    }
}

// 檢查使用者檔案完整性
async function checkUserProfile(userId) {
    try {
        const response = await fetch(`${GAS_URL}?action=checkProfile&userId=${userId}`);
        return await response.json();
    } catch (err) {
        console.error('檢查使用者檔案失敗', err);
        return { isProfileComplete: false };
    }
}

// 頁面載入時初始化 LIFF
window.onload = initializeLiff;
    </script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/profile.js"></script>
    <script src="assets/js/event.js"></script>
</body>
</html>
