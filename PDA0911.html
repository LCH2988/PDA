<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>帕金森病友會｜會員與財務整合系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --font-base: 19px;
      --font-large: 21px;
      --font-xlarge: 24px;
      --radius: 16px;
      --primary: #1b5e20;
      --primary-accent: #2e7d32;
      --danger: #c62828;
      --warning: #f57c00;
      --info: #1565c0;
      --bg: #fafafa;
      --card: #ffffff;
      --border: #dddddd;
      --text: #222;
      --muted: #666;
      --focus: #90caf9;
      --success-bg: #e8f5e9;
      --error-bg: #ffebee;
    }
    [data-theme="large"] { --font-base: 21px; --font-large: 24px; --font-xlarge: 28px; }
    [data-theme="contrast"] {
      --primary:#004d40; --primary-accent:#00695c; --bg:#ffffff; --card:#ffffff; --text:#000; --border:#000;
    }
    html, body {
      font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,sans-serif;
      font-size:var(--font-base);
      margin:0; padding:0; background:var(--bg); color:var(--text);
      -webkit-font-smoothing:antialiased;
    }
    h1,h2,h3,h4 { margin:0 0 16px; line-height:1.3; font-weight:700; }
    h1{ font-size:var(--font-xlarge); }
    h2{ font-size:var(--font-large); }
    h3{ font-size:1.25rem; }
    h4{ font-size:1.1rem; }
    p { line-height:1.55; margin:0 0 14px; }
    a { color:var(--info); text-decoration:none; }
    a:focus, button:focus, select:focus, input:focus, textarea:focus {
      outline:3px solid var(--focus); outline-offset:2px;
    }
    .hidden { display:none !important; }
    .wrap { max-width:960px; margin:0 auto; padding:70px 16px 100px; }
    header.app-bar {
      position:fixed; top:0; left:0; right:0;
      background:linear-gradient(90deg,var(--primary) 0%, var(--primary-accent) 100%);
      color:#fff; padding:14px 18px;
      display:flex; align-items:center; justify-content:space-between; z-index:100;
    }
    header .brand { font-size:1.05rem; font-weight:600; letter-spacing:1px; }
    header .brand small { display:block; font-size:0.7rem; opacity:.85; font-weight:400; }
    nav.bottom-nav {
      position:fixed; bottom:0; left:0; right:0;
      background:#fff; border-top:1px solid var(--border);
      display:flex; padding:6px 0 4px; z-index:95;
    }
    .nav-item {
      flex:1; text-align:center; font-size:0.75rem;
      color:var(--muted); cursor:pointer; user-select:none; padding:4px 0;
    }
    .nav-item span { font-size:26px; display:block; line-height:1.2; }
    .nav-item.active { color:var(--primary); font-weight:700; }
    .card {
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      padding:20px 22px 22px; margin:0 0 22px; box-shadow:0 4px 14px rgba(0,0,0,0.06);
    }
    .card.highlight { border:2px solid var(--primary-accent); }
    button {
      cursor:pointer; font-family:inherit; font-size:1em; line-height:1.2;
      padding:14px 18px; border-radius:12px; border:1px solid var(--primary-accent);
      background:var(--primary-accent); color:#fff; font-weight:600; letter-spacing:.5px;
      transition:.18s; min-height:54px;
    }
    button.secondary { background:#fff; color:var(--primary-accent); }
    button.outline { background:#fff; color:var(--primary); border:2px solid var(--primary); }
    button.small { padding:10px 14px; font-size:0.85rem; min-height:44px; }
    button.danger { background:var(--danger); border-color:var(--danger); }
    button:active { filter:brightness(.92); transform:translateY(1px); }
    .badge {
      display:inline-block; padding:4px 10px; border-radius:999px;
      font-size:0.72rem; font-weight:600; letter-spacing:.5px;
      background:#eee; color:#555; margin-right:6px;
    }
    .badge.primary { background:#e8f5e9; color:var(--primary); }
    .badge.danger { background:#ffebee; color:var(--danger); }
    .badge.warning { background:#fff3e0; color:var(--warning); }
    .badge.info { background:#e3f2fd; color:var(--info); }
    .admin-badge { background:#263238 !important; color:#fff !important; }
    .loading-center { text-align:center; padding:40px 10px; color:#555; font-size:0.95rem; }
    .list-item {
      border:1px solid var(--border); background:#fff; border-radius:14px;
      padding:14px 16px 12px; margin:0 0 14px; position:relative;
    }
    .list-item .title { font-weight:700; margin:0 0 6px; line-height:1.4; }
    .list-item .meta { font-size:0.78rem; color:var(--muted); line-height:1.4; }
    .empty {
      text-align:center; padding:32px 16px; border:2px dashed #ccc;
      border-radius:18px; color:#777; font-size:0.95rem;
    }
    .alert {
      border-radius:14px; padding:14px 16px; margin:0 0 18px;
      font-weight:600; line-height:1.5;
    }
    .alert.success { background:var(--success-bg); color:var(--primary); border:1px solid #a5d6a7; }
    .alert.error { background:var(--error-bg); color:var(--danger); border:1px solid #ef9a9a; }
    .alert.info { background:#e3f2fd; color:#1565c0; border:1px solid #90caf9; }
    .progress-bar {
      height:12px; background:#eee; border-radius:10px; overflow:hidden;
      margin:8px 0 4px;
    }
    .progress-bar span {
      display:block; height:100%; background:linear-gradient(90deg,#4caf50,#2e7d32);
      width:0%; transition:width .4s;
    }
    .stat-cards {
      display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); margin:0 0 12px;
    }
    .stat { background:#fff; border:1px solid var(--border); border-radius:16px; text-align:center; padding:16px 10px 14px; }
    .stat h4 { margin:0 0 6px; font-size:0.8rem; letter-spacing:1px; color:var(--muted); font-weight:600; }
    .stat .num { font-size:1.4rem; font-weight:700; color:var(--primary); line-height:1.2; }
    .table-scroll {
      overflow-x:auto; -webkit-overflow-scrolling:touch; border:1px solid var(--border);
      border-radius:12px; background:#fff; margin:12px 0;
    }
    table { border-collapse:collapse; width:100%; font-size:0.85rem; min-width:720px; }
    th,td { padding:10px 12px; border-bottom:1px solid #eee; text-align:left; vertical-align:top; }
    th { background:#f5f5f5; font-weight:600; white-space:nowrap; }
    tr:last-child td { border-bottom:none; }
    .text-right { text-align:right; }
    .tag-list { display:flex; gap:6px; flex-wrap:wrap; }
    .floating-buttons {
      position:fixed; bottom:90px; right:16px; display:flex; flex-direction:column; gap:10px; z-index:120;
    }
    .floating-buttons button {
      min-height:46px; padding:12px 14px; font-size:0.8rem; border-radius:50px;
      box-shadow:0 4px 12px rgba(0,0,0,0.18); font-weight:600;
    }
  </style>
</head>
<body>
  <header class="app-bar" role="banner">
    <div class="brand" aria-label="系統標題">
      帕金森病友會
      <small>會員・活動・財務整合</small>
    </div>
    <div class="toolbar-right">
      <button class="small outline" id="btnFontToggle" aria-label="切換字體大小">A+</button>
      <button class="small outline" id="btnContrastToggle" aria-label="高對比模式">高對比</button>
      <button class="small outline" id="btnReload" aria-label="重新載入">↻</button>
    </div>
  </header>

  <div class="wrap" id="app-root" aria-live="polite">
    <!-- 首頁 -->
    <div id="screen-home">
      <div class="card highlight" id="profileCard" aria-label="個人資訊卡片">
        <h2 style="display:flex;align-items:center;gap:10px;">
          <span>👤 個人概覽</span>
          <span id="badgeStatus" class="badge">載入中</span>
          <span id="badgeAdmin" class="badge admin-badge hidden">ADMIN</span>
        </h2>
        <div id="profileLoading" class="loading-center">載入中...</div>
        <div id="profileContent" class="hidden">
          <p style="margin:0 0 6px;">
            <strong id="realNameDisplay">—</strong>
            <span id="memberTypeDisplay" class="badge primary">—</span>
          </p>
          <p id="lineNameDisplay" style="margin:0 0 4px;color:var(--muted);font-size:0.85rem;"></p>
          <div class="stat-cards">
            <div class="stat"><h4>發言次數</h4><div class="num" id="statMessages">0</div></div>
            <div class="stat"><h4>活動參與</h4><div class="num" id="statActivities">0</div></div>
            <div class="stat"><h4>捐款次數</h4><div class="num" id="statDonationCount">0</div></div>
            <div class="stat"><h4>捐款總額</h4><div class="num" id="statDonationTotal">0</div></div>
          </div>
          <div style="font-size:0.75rem;color:var(--muted);">
            加入：<span id="joinedAt">—</span>｜最後互動：<span id="lastActive">—</span>
          </div>
        </div>
        <div id="registerPrompt" class="alert info hidden">
          尚未完成註冊，請前往「註冊」頁填寫資料。
        </div>
      </div>

      <div class="card">
        <h3>🚀 快速功能</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;">
          <button class="outline" data-nav="activities">📅 活動列表</button>
          <button class="outline" data-nav="donations">💰 捐款紀錄</button>
          <button class="outline" data-nav="myactivities">📝 我的活動</button>
          <button class="outline" data-nav="profile">👤 個人資料</button>
          <button class="outline" data-nav="finance">💰 財務管理</button>
          <button class="outline" data-nav="register">🧾 註冊 / 修改</button>
        </div>
      </div>

      <div class="card">
        <h3>🔔 最新活動（前 3 筆）</h3>
        <div id="homeActivities"></div>
        <div class="mt">
          <button class="secondary small" data-nav="activities">查看更多活動 →</button>
        </div>
      </div>
    </div>

    <!-- 註冊 -->
    <div id="screen-register" class="hidden">
      <div class="card">
        <h2>🧾 實名制註冊</h2>
        <form id="formRegister" novalidate>
          <div id="registerAlert"></div>
          <div class="field">
            <label for="regRealName">姓名 *</label>
            <input id="regRealName" name="realName" required maxlength="10" placeholder="請輸入姓名（2-10字）" />
          </div>
          <div class="field">
            <label for="regType">成員類別 *</label>
            <select id="regType" name="memberType" required>
              <option value="">請選擇...</option>
              <option value="member">一般成員</option>
              <option value="volunteer">志工</option>
              <option value="vip">會員 (VIP)</option>
            </select>
          </div>
          <div class="field">
            <label for="regPhone">電話 (目前不儲存)</label>
            <input id="regPhone" name="phone" placeholder="09xxxxxxxx 或 區碼-號碼" />
            <small>※ 若需保存聯絡方式，後端需新增 updateUserContact API</small>
          </div>
          <div class="field">
            <label for="regEmail">電子郵件 (目前不儲存)</label>
            <input id="regEmail" name="email" type="email" placeholder="name@example.com" />
          </div>
          <button type="submit">送出註冊</button>
        </form>
      </div>
    </div>

    <!-- 活動列表 -->
    <div id="screen-activities" class="hidden">
      <div class="card">
        <h2>📅 活動列表</h2>
        <div id="activitiesLoading" class="loading-center">載入中...</div>
        <div id="activitiesList" class="hidden"></div>
        <div class="card" style="background:#f5f5f5;margin-top:20px;">
          <h4>➕ 報名格式提示</h4>
          <p style="font-size:0.8rem;line-height:1.4;">
            快速報名：編號+1<br/>一般報名：編號+姓名<br/>團體報名：編號+姓名1+姓名2...
          </p>
          <form id="formManualRegister">
            <div class="field">
              <label>輸入報名字串</label>
              <input id="manualRegInput" placeholder="例如：001+王小明 或 001+王小明+李小華" />
            </div>
            <button type="submit" class="secondary">送出字串報名</button>
          </form>
          <div id="manualRegResult" style="margin-top:10px;font-size:0.8rem;"></div>
        </div>
      </div>
    </div>

    <!-- 我的活動 -->
    <div id="screen-myactivities" class="hidden">
      <div class="card">
        <h2>📝 我的活動</h2>
        <div id="myActivitiesLoading" class="loading-center">載入中...</div>
        <div id="myActivitiesList" class="hidden"></div>
      </div>
    </div>

    <!-- 捐款 -->
    <div id="screen-donations" class="hidden">
      <div class="card">
        <h2>💰 捐款紀錄</h2>
        <div id="donationsLoading" class="loading-center">載入中...</div>
        <div id="donationsList" class="hidden"></div>
      </div>
    </div>

    <!-- 個人資料 -->
    <div id="screen-profile" class="hidden">
      <div class="card">
        <h2>👤 個人資料</h2>
        <div id="profileDetailLoading" class="loading-center">載入中...</div>
        <div id="profileDetail" class="hidden"></div>
      </div>
    </div>

    <!-- 財務主選單 -->
    <div id="screen-finance" class="hidden">
      <div class="card">
        <h2>💰 財務管理</h2>
        <div id="financeAccessNote" class="alert info hidden">僅供已註冊 VIP 或管理員使用。</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;">
          <button class="outline" data-finance="balance">🏦 帳戶餘額</button>
          <button class="outline" data-finance="budget">📊 預算狀態</button>
          <button class="outline" data-finance="expenseApply">📝 支出申請</button>
          <button class="outline" data-finance="expenseList">💸 支出列表</button>
          <button class="outline" data-finance="incomeList">💰 收入列表</button>
          <button class="outline" data-finance="report">📈 財務報告</button>
        </div>
        <div id="financeContent" class="mt" style="margin-top:18px;"></div>
      </div>
    </div>

    <!-- 管理員 -->
    <div id="screen-admin" class="hidden">
      <div class="card">
        <h2>🔧 管理員工具</h2>
        <div class="alert info">示範支出審核前端；實務建議後端再驗證身份。</div>
        <form id="formApproveExpense">
          <div class="field">
            <label>支出編號 *</label>
            <input id="approveExpenseId" required placeholder="例如：EXP1680000000000" />
          </div>
          <div class="field">
            <label>決策 *</label>
            <select id="approveDecision">
              <option value="approve">同意</option>
              <option value="reject">拒絕</option>
            </select>
          </div>
          <div class="field">
            <label>備註 (選填)</label>
            <textarea id="approveNote" rows="2" placeholder="審核意見"></textarea>
          </div>
          <button type="submit">送出審核</button>
        </form>
        <div id="approveResult" style="font-size:0.8rem;margin-top:12px;"></div>
      </div>
    </div>
  </div>

  <div class="floating-buttons">
    <button id="btnHome" class="outline small" data-nav="home">🏠 回首頁</button>
  </div>

  <nav class="bottom-nav" role="navigation" aria-label="底部導覽">
    <div class="nav-item active" data-nav="home"><span>🏠</span>首頁</div>
    <div class="nav-item" data-nav="activities"><span>📅</span>活動</div>
    <div class="nav-item" data-nav="finance"><span>💰</span>財務</div>
    <div class="nav-item" data-nav="donations"><span>🎁</span>捐款</div>
    <div class="nav-item" data-nav="profile"><span>👤</span>資料</div>
  </nav>

  <script>
    // 從模板注入設定
    // const GAS_CONFIG = <?!= JSON.stringify(config) ?>;
    const LIFF_ID = "1656516134-VaGgmaPm";
    const ADMIN_IDS = 'U09b4c2535730fbb5643274ba1526ec9c' || [];
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzaKjU6yMdyCqKsNdKzACc5xgesoNNBcs49PBpD79L20N930j_faBUKnQ4gOU6VrXMSng/exec';
    // // 動態取得自身 WebApp URL（去除參數）
    // const WEBAPP_URL = (()=>{
    //   const u = new URL(window.location.href);
    //   u.search = ''; u.hash = '';
    //   return u.toString();
    // })();

    const state = {
      profile: null,
      user: null,
      stats: null,
      activities: [],
      myActivities: [],
      donations: [],
      activitiesLoaded: false,
      isAdmin: false,
      vipOrAdmin: false,
      fontLarge: false,
      highContrast: false
    };

    function $(id){ return document.getElementById(id); }
    function el(s){ return document.querySelector(s); }
    function els(s){ return Array.from(document.querySelectorAll(s)); }
    function fmtDate(d){ if(!d)return''; const dt=new Date(d); return isNaN(dt)?d:dt.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit'}); }
    function fmtDateTime(d){ if(!d)return''; const dt=new Date(d); return isNaN(dt)?d:dt.toLocaleString('zh-TW'); }
    function fmtMoney(n){ const v=Number(n); return isNaN(v)?'0':v.toLocaleString('zh-TW'); }
    function escapeHTML(str=''){ return str.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function showAlert(id,type,msg){ const c=$(id); if(!c)return; c.innerHTML='<div class="alert '+type+'">'+escapeHTML(msg)+'</div>'; }
    function getTypeName(t){ return ({member:'一般成員',volunteer:'志工',vip:'會員'})[t]||t||'—'; }

    async function apiGet(action, params={}){
      const url=new URL(WEBAPP_URL);
      url.searchParams.set('action', action);
      Object.entries(params).forEach(([k,v])=> url.searchParams.set(k,v));
      const r=await fetch(url.toString(),{method:'GET'});
      return r.json();
    }
    async function apiPost(payload){
      // 不設 Content-Type 避免未來跨域 Preflight
      const r=await fetch(WEBAPP_URL,{ method:'POST', body: JSON.stringify(payload)});
      return r.json();
    }

    const Api = {
      createUserIfNotExist:(userId,displayName)=> apiPost({action:'createUserIfNotExist',userId,displayName}),
      register:(userId,realName,memberType)=> apiPost({action:'register',userId,realName,memberType}),
      quickRegister:(userId,input)=> apiPost({action:'quickRegister',userId,input}),
      normalRegister:(userId,input)=> apiPost({action:'normalRegister',userId,input}),
      getUserInfo:(userId)=> apiGet('getUserInfo',{userId}),
      getActivities:()=> apiGet('getActivities'),
      getUserActivities:(userId)=> apiGet('getUserActivities',{userId}),
      getUserDonations:(userId)=> apiGet('getUserDonations',{userId}),
      getAccountBalance:()=> apiPost({action:'getAccountBalance'}),
      getBudgetStatus:()=> apiPost({action:'getBudgetStatus'}),
      addExpense:(data)=> apiPost({action:'addExpense', ...data}),
      getExpenseList:(userId,status='all')=> apiPost({action:'getExpenseList',userId,status}),
      getIncomeList:(from,to)=> apiPost({action:'getIncomeList',dateFrom:from,dateTo:to}),
      getFinanceReport:(year,month)=> apiPost({action:'getFinanceReport',year,month}),
      approveExpense:(expenseId,approverName,approved,note)=> apiPost({action:'approveExpense',expenseId,approverName,approved,note})
    };

    function switchScreen(name){
      ['home','register','activities','myactivities','donations','profile','finance','admin']
        .forEach(s=>{ const e=$('screen-'+s); if(e) e.classList.add('hidden'); });
      const target=$('screen-'+name); if(target) target.classList.remove('hidden');
      els('.nav-item').forEach(i=> i.classList.remove('active'));
      const nav=el('.nav-item[data-nav="'+name+'"]'); if(nav) nav.classList.add('active');

      if(name==='activities' && !state.activitiesLoaded) loadActivities();
      else if(name==='myactivities') loadMyActivities();
      else if(name==='donations') loadDonations();
      else if(name==='profile') renderProfileDetail();
      else if(name==='finance') prepareFinanceAccess();
      else if(name==='admin' && !state.isAdmin){
        $('screen-admin').innerHTML='<div class="card"><h2>🔒 無權限</h2><p>此功能僅限管理員。</p></div>';
      }
    }

    async function init(){
      // LIFF 可選
      if(typeof liff!=='undefined' && LIFF_ID && LIFF_ID!=='YOUR_LIFF_ID'){
        try{
          await liff.init({ liffId: LIFF_ID });
          if(!liff.isLoggedIn()){ liff.login(); return; }
          state.profile = await liff.getProfile();
        }catch(e){
          console.warn('LIFF失敗，使用模擬', e);
          state.profile={ userId:'SIM_USER_ID', displayName:'測試用戶' };
        }
      }else{
          state.profile={ userId:'LOCAL_DEV_USER', displayName:'本地測試者' };
      }

      try{
        await Api.createUserIfNotExist(state.profile.userId, state.profile.displayName);
        await refreshUserInfo();
        await loadActivities(true);
        await loadDashboardActivitiesPreview();
        renderProfileCard();
      }catch(e){
        console.error(e);
        showAlert('profileCard','error','無法載入使用者資料');
      }

      bindEvents();
    }

    async function refreshUserInfo(){
      const res=await Api.getUserInfo(state.profile.userId);
      if(res && !res.error){
        state.user=res;
        state.isAdmin = ADMIN_IDS.includes(res.lineId);
        state.vipOrAdmin = state.isAdmin || res.memberType==='vip';
      }
      if(state.user){
        const acts=await Api.getUserActivities(state.user.lineId);
        const dons=await Api.getUserDonations(state.user.lineId);
        const sum=(dons||[]).reduce((s,d)=> s + (Number(d.amount)||0),0);
        state.stats = { activities:(acts||[]).length, donations:(dons||[]).length, donationSum:sum };
      }
    }

    function bindEvents(){
      els('.nav-item').forEach(i=> i.addEventListener('click',()=> switchScreen(i.getAttribute('data-nav'))));
      els('[data-nav]').forEach(btn=> btn.addEventListener('click',()=> switchScreen(btn.getAttribute('data-nav'))));

      $('btnFontToggle').addEventListener('click',()=>{
        state.fontLarge=!state.fontLarge;
        document.documentElement.dataset.theme = state.fontLarge ? 'large' : '';
      });
      $('btnContrastToggle').addEventListener('click',()=>{
        state.highContrast=!state.highContrast;
        const base = state.fontLarge ? 'large' : '';
        document.documentElement.dataset.theme = state.highContrast ? (base+' contrast').trim() : base;
      });
      $('btnReload').addEventListener('click',()=> location.reload());

      $('formRegister').addEventListener('submit', async e=>{
        e.preventDefault();
        const realName=$('regRealName').value.trim();
        const memberType=$('regType').value;
        if(!realName || !memberType){
          showAlert('registerAlert','error','請完整填寫必填欄位');
          return;
        }
        try{
          const res=await Api.register(state.profile.userId, realName, memberType);
          if(res.success){
            showAlert('registerAlert','success','註冊成功，更新中...');
            await refreshUserInfo(); renderProfileCard();
            setTimeout(()=> switchScreen('home'), 1200);
          }else{
            showAlert('registerAlert','error', res.message||'註冊失敗');
          }
        }catch(err){
          showAlert('registerAlert','error','網路錯誤');
        }
      });

      $('formManualRegister').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.user || state.user.status!=='已註冊'){
          $('manualRegResult').textContent='請先註冊';
          return;
        }
        const input=$('manualRegInput').value.trim();
        if(!input) return;
        $('manualRegResult').textContent='處理中...';
        try{
          let res;
          if(/^\d+\+1$/.test(input)) res=await Api.quickRegister(state.user.lineId, input);
          else if(/^\d+\+.+/.test(input)) res=await Api.normalRegister(state.user.lineId, input);
          else { $('manualRegResult').textContent='格式錯誤'; return; }
          if(res.success){
            $('manualRegResult').textContent='報名成功！';
            await loadMyActivities(true);
          }else{
            $('manualRegResult').textContent=res.message||'報名失敗';
          }
        }catch(err){
          $('manualRegResult').textContent='網路錯誤';
        }
      });

      $('screen-finance').addEventListener('click', async e=>{
        const btn=e.target.closest('[data-finance]');
        if(!btn) return;
        if(!state.vipOrAdmin){
          $('financeContent').innerHTML='<div class="alert error">需要 VIP 或管理員權限</div>';
          return;
        }
        switch(btn.getAttribute('data-finance')){
          case 'balance': await uiFinanceBalance(); break;
          case 'budget': await uiFinanceBudget(); break;
          case 'expenseApply': uiFinanceExpenseForm(); break;
          case 'expenseList': await uiFinanceExpenseList(); break;
          case 'incomeList': await uiFinanceIncomeList(); break;
          case 'report': await uiFinanceReport(); break;
        }
      });

      $('formApproveExpense').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin){
          $('approveResult').textContent='無權限';
          return;
        }
          const expenseId=$('approveExpenseId').value.trim();
        const decision=$('approveDecision').value;
        const note=$('approveNote').value.trim();
        if(!expenseId){ $('approveResult').textContent='請輸入支出編號'; return; }
        $('approveResult').textContent='送出中...';
        try{
          const res=await Api.approveExpense(expenseId,
            state.user.realName||state.user.lineName||'管理員',
            decision==='approve', note);
          $('approveResult').textContent = res.success ? '審核完成' : (res.message||'審核失敗');
        }catch(err){
          $('approveResult').textContent='網路錯誤';
        }
      });
    }

    function renderProfileCard(){
      if(!state.user) return;
      $('profileLoading').classList.add('hidden');
      $('profileContent').classList.remove('hidden');
      $('lineNameDisplay').textContent='LINE：'+(state.user.lineName||'—');
      $('realNameDisplay').textContent=state.user.realName||'（未註冊）';
      $('memberTypeDisplay').textContent=state.user.memberType ? getTypeName(state.user.memberType) : '未分類';
      $('badgeStatus').textContent=state.user.status||'—';
      $('badgeStatus').className='badge '+(state.user.status==='已註冊'?'primary':'warning');
      if(state.isAdmin) $('badgeAdmin').classList.remove('hidden'); else $('badgeAdmin').classList.add('hidden');
      if(state.stats){
        $('statMessages').textContent=state.user.messageCount||0;
        $('statActivities').textContent=state.stats.activities||0;
        $('statDonationCount').textContent=state.stats.donations||0;
        $('statDonationTotal').textContent=fmtMoney(state.stats.donationSum||0);
      }
      $('joinedAt').textContent=state.user.firstTime?fmtDateTime(state.user.firstTime):'—';
      $('lastActive').textContent=state.user.lastTime?fmtDateTime(state.user.lastTime):'—';
      if(state.user.status!=='已註冊') $('registerPrompt').classList.remove('hidden');
      else $('registerPrompt').classList.add('hidden');
    }

    function renderProfileDetail(){
      if(!state.user) return;
      $('profileDetailLoading').classList.add('hidden');
      $('profileDetail').classList.remove('hidden');
      const u=state.user;
      $('profileDetail').innerHTML=`
        <div class="list-item">
          <div class="title">基本資料</div>
          <div class="meta">
            LINE 名稱：${escapeHTML(u.lineName||'—')}<br/>
            狀態：${escapeHTML(u.status||'—')}<br/>
            類別：${escapeHTML(getTypeName(u.memberType)||'—')}<br/>
            真實姓名：${escapeHTML(u.realName||'—')}<br/>
            加入：${u.firstTime?fmtDateTime(u.firstTime):'—'}<br/>
            最後互動：${u.lastTime?fmtDateTime(u.lastTime):'—'}
          </div>
        </div>
        <div class="list-item">
          <div class="title">聯絡資訊（尚未支援更新）</div>
          <div class="meta">
            電話：${escapeHTML(u.phone||'—')}<br/>
            Email：${escapeHTML(u.email||'—')}<br/>
            地址：${escapeHTML(u.address||'—')}<br/>
            生日：${escapeHTML(u.birthday||'—')}
          </div>
        </div>
      `;
    }

    async function loadActivities(skip){
      if(!skip){
        $('activitiesLoading').classList.remove('hidden');
        $('activitiesList').classList.add('hidden');
      }
      try{
        const list=await Api.getActivities();
        state.activities=Array.isArray(list)?list:[];
        state.activitiesLoaded=true;
        renderActivitiesList();
      }catch(e){
        $('activitiesLoading').textContent='載入失敗';
      }
    }
    function renderActivitiesList(){
      const c=$('activitiesList');
      $('activitiesLoading').classList.add('hidden');
      c.classList.remove('hidden');
      if(!state.activities.length){
        c.innerHTML='<div class="empty">目前沒有開放報名的活動</div>';
        return;
      }
      c.innerHTML=state.activities.map(a=>{
        const pct=a.maxParticipants ? Math.min(100,Math.round(a.currentParticipants/a.maxParticipants*100)) : 0;
        return `
          <div class="list-item">
            <div class="title">${escapeHTML(a.name)}
              <span class="badge info">${escapeHTML(a.id)}</span>
            </div>
            <div class="meta">
              日期：${escapeHTML(a.date)}｜地點：${escapeHTML(a.location)}<br/>
              截止：${escapeHTML(a.deadline)}<br/>
              人數：${a.currentParticipants}/${a.maxParticipants||'—'}
            </div>
            <div class="progress-bar"><span style="width:${pct}%;"></span></div>
            <div style="display:flex;gap:10px;margin-top:10px;">
              <button class="small secondary" onclick="quickRegister('${a.id}')">快速+1</button>
              <button class="small secondary" onclick="prefillManual('${a.id}')">填入編號</button>
            </div>
          </div>
        `;
      }).join('');
    }
    async function loadDashboardActivitiesPreview(){
      const box=$('homeActivities');
      try{
        const acts=await Api.getActivities();
        if(!acts.length){
          box.innerHTML='<div class="empty">目前無活動</div>'; return;
        }
        box.innerHTML=acts.slice(0,3).map(a=>`
          <div class="list-item">
            <div class="title">${escapeHTML(a.name)}</div>
            <div class="meta">
              ${escapeHTML(a.date)}｜${escapeHTML(a.location)}<br/>
              人數：${a.currentParticipants}/${a.maxParticipants||'—'}
            </div>
          </div>`).join('');
      }catch(e){
        box.innerHTML='<div class="empty">無法取得活動資料</div>';
      }
    }
    function prefillManual(id){ $('manualRegInput').value=id+'+'; $('manualRegInput').focus(); }
    async function quickRegister(id){
      if(!state.user || state.user.status!=='已註冊'){ alert('請先完成註冊'); return; }
      try{
        const res=await Api.quickRegister(state.user.lineId, id+'+1');
        if(res.success){
          alert('報名成功');
          await loadActivities(true);
          await loadMyActivities(true);
        }else{
          alert(res.message||'報名失敗');
        }
      }catch(e){ alert('網路錯誤'); }
    }
    async function loadMyActivities(){
      $('myActivitiesLoading').classList.remove('hidden');
      $('myActivitiesList').classList.add('hidden');
      try{
        const list=await Api.getUserActivities(state.user.lineId);
        state.myActivities=Array.isArray(list)?list:[];
        $('myActivitiesLoading').classList.add('hidden');
        const c=$('myActivitiesList');
        c.classList.remove('hidden');
        if(!state.myActivities.length){
          c.innerHTML='<div class="empty">尚無參與活動</div>'; return;
        }
        c.innerHTML=state.myActivities.map(a=>`
          <div class="list-item">
            <div class="title">${escapeHTML(a.activityName)}</div>
            <div class="meta">
              日期：${escapeHTML(a.date)}｜地點：${escapeHTML(a.location)}<br/>
              簽到狀態：${escapeHTML(a.status||'—')}
            </div>
          </div>`).join('');
      }catch(e){
        $('myActivitiesLoading').textContent='載入失敗';
      }
    }

    async function loadDonations(){
      $('donationsLoading').classList.remove('hidden');
      $('donationsList').classList.add('hidden');
      try{
        const list=await Api.getUserDonations(state.user.lineId);
        state.donations=Array.isArray(list)?list:[];
        $('donationsLoading').classList.add('hidden');
        const c=$('donationsList');
        c.classList.remove('hidden');
        if(!list.length){
          c.innerHTML='<div class="empty">尚無捐款紀錄</div>'; return;
        }
        let total=0;
        c.innerHTML=list.map(d=>{
          total+=Number(d.amount)||0;
          return `
            <div class="list-item">
              <div class="title">捐款：$${fmtMoney(d.amount)}</div>
              <div class="meta">
                日期：${escapeHTML(d.date)}｜方式：${escapeHTML(d.method||'—')}<br/>
                用途：${escapeHTML(d.purpose||'—')}｜收據：${escapeHTML(d.receiptStatus||'—')}
              </div>
            </div>`;
        }).join('') + `<div class="alert success">累計捐款：$${fmtMoney(total)}</div>`;
      }catch(e){
        $('donationsLoading').textContent='載入失敗';
      }
    }

    function prepareFinanceAccess(){
      if(!state.vipOrAdmin) $('financeAccessNote').classList.remove('hidden');
      else $('financeAccessNote').classList.add('hidden');
      $('financeContent').innerHTML='<div style="font-size:0.85rem;color:var(--muted);">請選擇上方功能...</div>';
    }

    async function uiFinanceBalance(){
      const box=$('financeContent');
      box.innerHTML='載入中...';
      try{
        const res=await Api.getAccountBalance();
        if(!res.success){ box.innerHTML='<div class="alert error">無法取得帳戶資料</div>'; return; }
        if(!res.accounts.length){ box.innerHTML='<div class="empty">尚無帳戶資料</div>'; return; }
        let total=0;
        const rows=res.accounts.map(a=>{
          total+=a.balance;
          return `<tr>
            <td>${escapeHTML(a.id)}</td>
            <td>${escapeHTML(a.name)}</td>
            <td>${escapeHTML(a.bank||'')}</td>
            <td>${escapeHTML(a.type||'')}</td>
            <td class="text-right">$${fmtMoney(a.balance)}</td>
          </tr>`;
        }).join('');
        box.innerHTML=`
          <h3>🏦 帳戶餘額</h3>
          <div class="table-scroll">
            <table>
              <thead><tr><th>帳戶ID</th><th>名稱</th><th>銀行</th><th>類型</th><th class="text-right">餘額</th></tr></thead>
              <tbody>${rows}</tbody>
              <tfoot><tr><th colspan="4" style="text-align:right;">總計</th><th class="text-right">$${fmtMoney(total)}</th></tr></tfoot>
            </table>
          </div>`;
      }catch(e){ box.innerHTML='<div class="alert error">載入失敗</div>'; }
    }

    async function uiFinanceBudget(){
      const box=$('financeContent');
      box.innerHTML='載入中...';
      try{
        const res=await Api.getBudgetStatus();
        if(!res.success){ box.innerHTML='<div class="alert error">無法取得預算資料</div>'; return; }
        if(!res.budgets.length){ box.innerHTML='<div class="empty">尚無預算資料</div>'; return; }
        const rows=res.budgets.map(b=>{
          const pct=parseInt(b.usagePercentage)||0;
          let barColor='#4caf50'; if(pct>=90) barColor='#c62828'; else if(pct>=80) barColor='#f57c00';
          return `<tr>
            <td>${escapeHTML(b.categoryName)}</td>
            <td class="text-right">$${fmtMoney(b.budgetAmount)}</td>
            <td class="text-right">$${fmtMoney(b.usedAmount)}</td>
            <td class="text-right">$${fmtMoney(b.remainingAmount)}</td>
            <td>
              <div class="progress-bar" style="height:10px;">
                <span style="width:${Math.min(100,pct)}%;background:${barColor};"></span>
              </div>
              <div style="font-size:0.65rem;text-align:right;">${escapeHTML(b.usagePercentage)}</div>
            </td>
          </tr>`;
        }).join('');
        box.innerHTML=`
          <h3>📊 預算狀態</h3>
          <div class="table-scroll">
            <table>
              <thead><tr><th>類別</th><th class="text-right">預算</th><th class="text-right">已用</th><th class="text-right">剩餘</th><th>使用率</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }catch(e){ box.innerHTML='<div class="alert error">載入失敗</div>'; }
    }

    function uiFinanceExpenseForm(){
      const box=$('financeContent');
      box.innerHTML=`
        <h3>📝 支出申請</h3>
        <form id="formExpense">
          <div id="expenseAlert"></div>
          <div class="field">
            <label>金額 *</label>
            <input type="number" id="expAmount" required placeholder="輸入金額" />
          </div>
          <div class="field">
            <label>類別 *</label>
            <select id="expCategory" required>
              <option value="">選擇</option>
              ${Object.entries({
                activity:'活動支出',office:'辦公費用',marketing:'宣傳費用',equipment:'設備費用',
                welfare:'福利支出',medical:'醫療支援',volunteer:'志工費用',other:'其他支出'
              }).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
            </select>
          </div>
          <div class="field">
            <label>說明 *</label>
            <input id="expDesc" required maxlength="50" placeholder="用途說明" />
          </div>
          <div class="field">
            <label>收款人 / 廠商 (選填)</label>
            <input id="expRecipient" maxlength="30" />
          </div>
          <button type="submit">提交申請</button>
        </form>`;
      $('formExpense').addEventListener('submit', async e=>{
        e.preventDefault();
        const amount=Number($('expAmount').value);
        const category=$('expCategory').value;
        const description=$('expDesc').value.trim();
        const recipient=$('expRecipient').value.trim();
        if(!amount || amount<=0 || !category || !description){
          showAlert('expenseAlert','error','請填寫必填欄位'); return;
        }
        try{
          const res=await Api.addExpense({
            category, description, amount, recipient,
            applicant: state.user.realName||state.user.lineName||'用戶',
            applicantLineId: state.user.lineId,
            paymentMethod:'bank_transfer',
            status:'待審核'
          });
          if(res.success){
            showAlert('expenseAlert','success','申請已提交，編號：'+res.expenseId);
            $('formExpense').reset();
          }else{
            showAlert('expenseAlert','error', res.message||'申請失敗');
          }
        }catch(err){
          showAlert('expenseAlert','error','網路錯誤');
        }
      });
    }

    async function uiFinanceExpenseList(){
      const box=$('financeContent');
      box.innerHTML='載入中...';
      try{
        const res=await Api.getExpenseList(state.user.lineId,'all');
        if(!res.success){ box.innerHTML='<div class="alert error">無法取得支出資料</div>'; return; }
        if(!res.expenses.length){ box.innerHTML='<div class="empty">尚無支出紀錄</div>'; return; }
        const rows=res.expenses.map(e=>`
          <tr>
            <td>${escapeHTML(e.id)}</td>
            <td>${fmtDate(e.date)}</td>
            <td>${escapeHTML(e.categoryName)}</td>
            <td>${escapeHTML(e.description)}</td>
            <td class="text-right">$${fmtMoney(e.amount)}</td>
            <td>${escapeHTML(e.status)}</td>
          </tr>`).join('');
        box.innerHTML=`
          <h3>💸 支出列表</h3>
          <div class="table-scroll">
            <table>
              <thead><tr><th>編號</th><th>日期</th><th>類別</th><th>說明</th><th class="text-right">金額</th><th>狀態</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }catch(e){ box.innerHTML='<div class="alert error">載入失敗</div>'; }
    }

    async function uiFinanceIncomeList(){
      const box=$('financeContent');
      box.innerHTML='載入中...';
      try{
        const now=new Date();
        const from=new Date(now.getFullYear(), now.getMonth(),1).toISOString();
        const to=new Date(now.getFullYear(), now.getMonth()+1,0).toISOString();
        const res=await Api.getIncomeList(from,to);
        if(!res.success){ box.innerHTML='<div class="alert error">無法取得收入資料</div>'; return; }
        if(!res.incomes.length){ box.innerHTML='<div class="empty">本月尚無收入紀錄</div>'; return; }
        let total=0;
        const rows=res.incomes.map(i=>{
          total+=Number(i.amount)||0;
          return `<tr>
            <td>${escapeHTML(i.id)}</td>
            <td>${fmtDate(i.date)}</td>
            <td>${escapeHTML(i.categoryName)}</td>
            <td>${escapeHTML(i.description)}</td>
            <td class="text-right">$${fmtMoney(i.amount)}</td>
            <td>${escapeHTML(i.source||'')}</td>
          </tr>`;
        }).join('');
        box.innerHTML=`
          <h3>💰 本月收入</h3>
          <div class="alert success" style="margin-bottom:12px;">本月總收入：$${fmtMoney(total)}</div>
          <div class="table-scroll">
            <table>
              <thead><tr><th>編號</th><th>日期</th><th>類別</th><th>描述</th><th class="text-right">金額</th><th>來源</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }catch(e){ box.innerHTML='<div class="alert error">載入失敗</div>'; }
    }

    async function uiFinanceReport(){
      const box=$('financeContent');
      box.innerHTML='載入報告...';
      try{
        const now=new Date();
        const res=await Api.getFinanceReport(now.getFullYear(), now.getMonth()+1);
        if(!res.success){ box.innerHTML='<div class="alert error">無法取得報告</div>'; return; }
        const r=res.report;
        const inc=(r.topIncomes||[]).map(i=>`<div class="badge info" style="font-size:0.65rem;">${escapeHTML(i.category)}：$${fmtMoney(i.amount)}</div>`).join('')||'<div class="inline-note">無資料</div>';
        const exp=(r.topExpenses||[]).map(i=>`<div class="badge warning" style="font-size:0.65rem;">${escapeHTML(i.category)}：$${fmtMoney(i.amount)}</div>`).join('')||'<div class="inline-note">無資料</div>';
        box.innerHTML=`
          <h3>📈 ${escapeHTML(r.month)} 財務報告</h3>
          <div class="stat-cards">
            <div class="stat"><h4>收入</h4><div class="num">$${fmtMoney(r.totalIncome)}</div></div>
            <div class="stat"><h4>支出</h4><div class="num">$${fmtMoney(r.totalExpense)}</div></div>
            <div class="stat"><h4>結餘</h4><div class="num" style="color:${r.balance>=0?'#2e7d32':'#c62828'}">$${fmtMoney(r.balance)}</div></div>
            <div class="stat"><h4>帳戶餘額</h4><div class="num">$${fmtMoney(r.cumulativeBalance)}</div></div>
          </div>
          <div style="font-size:0.9rem;margin-top:16px;font-weight:700;">主要收入</div>
          <div class="tag-list">${inc}</div>
          <div style="font-size:0.9rem;margin-top:16px;font-weight:700;">主要支出</div>
          <div class="tag-list">${exp}</div>
          <div style="height:1px;background:linear-gradient(90deg,#ddd,#eee,#ddd);margin:18px 0;"></div>
          <div style="font-size:0.65rem;color:var(--muted);">※ 報告包含當月所有收入與已核准/已付款支出。</div>`;
      }catch(e){ box.innerHTML='<div class="alert error">載入失敗</div>'; }
    }

    window.quickRegister=quickRegister;
    window.prefillManual=prefillManual;
    document.addEventListener('DOMContentLoaded', init);
  </script>

  <!-- 正式若需 LIFF 功能再載入 -->
  <!-- <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script> -->
</body>
</html>
