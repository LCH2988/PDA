<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      
      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          color: #333;
      }
      
      .container {
          max-width: 800px;
          margin: 0 auto;
          padding: 20px;
      }
      
      .header {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-radius: 20px;
          padding: 30px;
          margin-bottom: 20px;
          text-align: center;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }
      
      .header h1 {
          color: #4a5568;
          font-size: 28px;
          margin-bottom: 10px;
      }
      
      .header .subtitle {
          color: #718096;
          font-size: 16px;
      }
      
      .user-info {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 20px;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      }
      
      .tabs {
          display: flex;
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-radius: 15px;
          padding: 5px;
          margin-bottom: 20px;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
          overflow-x: auto;
      }
      
      .tab {
          flex: 1;
          padding: 12px 16px;
          text-align: center;
          border-radius: 10px;
          cursor: pointer;
          transition: all 0.3s ease;
          white-space: nowrap;
          min-width: 80px;
          font-size: 14px;
      }
      
      .tab.active {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }
      
      .tab-content {
          display: none;
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-radius: 15px;
          padding: 25px;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      }
      
      .tab-content.active {
          display: block;
      }
      
      .form-group {
          margin-bottom: 20px;
      }
      
      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #4a5568;
      }
      
      .form-group input,
      .form-group select,
      .form-group textarea {
          width: 100%;
          padding: 12px 16px;
          border: 2px solid #e2e8f0;
          border-radius: 10px;
          font-size: 16px;
          transition: border-color 0.3s ease;
      }
      
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      .btn {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          padding: 14px 28px;
          border-radius: 10px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }
      
      .btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }
      
      .btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
          transform: none;
      }
      
      .btn-secondary {
          background: #718096;
          box-shadow: 0 4px 12px rgba(113, 128, 150, 0.3);
      }
      
      .btn-danger {
          background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
          box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
      }
      
      .card {
          background: white;
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 15px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          border-left: 4px solid #667eea;
      }
      
      .status {
          display: inline-block;
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
          text-transform: uppercase;
      }
      
      .status.registered {
          background: #c6f6d5;
          color: #22543d;
      }
      
      .status.unregistered {
          background: #fed7d7;
          color: #742a2a;
      }
      
      .status.approved {
          background: #c6f6d5;
          color: #22543d;
      }
      
      .status.pending {
          background: #feebc8;
          color: #7b341e;
      }
      
      .status.rejected {
          background: #fed7d7;
          color: #742a2a;
      }
      
      .loading {
          text-align: center;
          padding: 40px;
          color: #718096;
      }
      
      .error {
          background: #fed7d7;
          color: #742a2a;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
          border-left: 4px solid #f56565;
      }
      
      .success {
          background: #c6f6d5;
          color: #22543d;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
          border-left: 4px solid #48bb78;
      }
      
      .grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 20px;
      }
      
      .stat-card {
          background: white;
          border-radius: 12px;
          padding: 20px;
          text-align: center;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      .stat-card .number {
          font-size: 32px;
          font-weight: bold;
          color: #667eea;
          margin-bottom: 5px;
      }
      
      .stat-card .label {
          color: #718096;
          font-size: 14px;
      }
      
      .activity-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 15px;
          background: white;
          border-radius: 10px;
          margin-bottom: 10px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      
      .activity-info h4 {
          color: #4a5568;
          margin-bottom: 5px;
      }
      
      .activity-info p {
          color: #718096;
          font-size: 14px;
      }
      
      .participants {
          background: #edf2f7;
          padding: 8px 12px;
          border-radius: 20px;
          font-size: 12px;
          color: #4a5568;
      }
      
      @media (max-width: 600px) {
          .container {
              padding: 10px;
          }
          
          .header {
              padding: 20px;
          }
          
          .header h1 {
              font-size: 24px;
          }
          
          .tabs {
              flex-wrap: nowrap;
              overflow-x: auto;
          }
          
          .tab {
              font-size: 12px;
              padding: 10px 12px;
          }
          
          .activity-item {
              flex-direction: column;
              align-items: flex-start;
              gap: 10px;
          }
      }
      
      .quick-actions {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
          gap: 10px;
          margin-bottom: 20px;
      }
      
      .quick-btn {
          background: rgba(255, 255, 255, 0.9);
          border: 2px solid #e2e8f0;
          padding: 15px 10px;
          border-radius: 12px;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s ease;
          font-size: 14px;
          color: #4a5568;
      }
      
      .quick-btn:hover {
          border-color: #667eea;
          background: white;
          transform: translateY(-2px);
      }
      
      .quick-btn .icon {
          font-size: 24px;
          margin-bottom: 8px;
          display: block;
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>ğŸ¥ å¸•é‡‘æ£®ç—…å‹æœƒ</h1>
          <p class="subtitle">æœƒå“¡ç®¡ç†ç³»çµ±</p>
      </div>

      <div id="user-info" class="user-info" style="display: none;">
          <h3>ğŸ‘¤ å€‹äººè³‡è¨Š</h3>
          <div id="user-details"></div>
      </div>

      <div class="quick-actions">
          <div class="quick-btn" onclick="showTab('profile')">
              <span class="icon">ğŸ‘¤</span>
              å€‹äººæª”æ¡ˆ
          </div>
          <div class="quick-btn" onclick="showTab('activities')">
              <span class="icon">ğŸ¯</span>
              æ´»å‹•å ±å
          </div>
          <div class="quick-btn" onclick="showTab('donations')">
              <span class="icon">ğŸ’°</span>
              ææ¬¾è¨˜éŒ„
          </div>
          <div class="quick-btn" onclick="showTab('finance')">
              <span class="icon">ğŸ“Š</span>
              è²¡å‹™ç®¡ç†
          </div>
      </div>

      <div class="tabs">
          <div class="tab active" onclick="showTab('profile')">å€‹äººæª”æ¡ˆ</div>
          <div class="tab" onclick="showTab('activities')">æ´»å‹•ç®¡ç†</div>
          <div class="tab" onclick="showTab('donations')">ææ¬¾è¨˜éŒ„</div>
          <div class="tab" onclick="showTab('finance')">è²¡å‹™ç®¡ç†</div>
          <div class="tab" onclick="showTab('feedback')">æ´»å‹•å›é¥‹</div>
          <div class="tab admin-only" onclick="showTab('admin')" style="display: none;">ç®¡ç†åŠŸèƒ½</div>
      </div>

      <!-- å€‹äººæª”æ¡ˆé é¢ -->
      <div id="profile-tab" class="tab-content active">
          <h3>ğŸ“ æœƒå“¡è¨»å†Š / å€‹äººè³‡æ–™</h3>
          
          <div id="registration-form">
              <div class="form-group">
                  <label for="realName">çœŸå¯¦å§“å *</label>
                  <input type="text" id="realName" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å" required>
              </div>
              
              <div class="form-group">
                  <label for="memberType">æœƒå“¡é¡åˆ¥ *</label>
                  <select id="memberType" required>
                      <option value="">è«‹é¸æ“‡æœƒå“¡é¡åˆ¥</option>
                      <option value="member">ä¸€èˆ¬æœƒå“¡</option>
                      <option value="volunteer">å¿—å·¥</option>
                      <option value="vip">VIPæœƒå“¡</option>
                  </select>
              </div>
              
              <button class="btn" onclick="registerUser()">è¨»å†Šæœƒå“¡</button>
          </div>

          <div id="contact-form" style="display: none;">
              <h4>ğŸ“ è¯çµ¡è³‡è¨Šæ›´æ–°</h4>
              <div class="form-group">
                  <label for="phone">é›»è©±</label>
                  <input type="tel" id="phone" placeholder="ä¾‹ï¼š0912345678">
              </div>
              
              <div class="form-group">
                  <label for="email">é›»å­éƒµä»¶</label>
                  <input type="email" id="email" placeholder="ä¾‹ï¼šuser@example.com">
              </div>
              
              <div class="form-group">
                  <label for="address">åœ°å€</label>
                  <input type="text" id="address" placeholder="è«‹è¼¸å…¥åœ°å€">
              </div>
              
              <div class="form-group">
                  <label for="birthday">ç”Ÿæ—¥</label>
                  <input type="date" id="birthday">
              </div>
              
              <button class="btn" onclick="updateContact()">æ›´æ–°è¯çµ¡è³‡è¨Š</button>
          </div>
      </div>

      <!-- æ´»å‹•ç®¡ç†é é¢ -->
      <div id="activities-tab" class="tab-content">
          <h3>ğŸ¯ æ´»å‹•å ±åç®¡ç†</h3>
          
          <div class="grid">
              <div class="stat-card">
                  <div class="number" id="total-activities">0</div>
                  <div class="label">å¯å ±åæ´»å‹•</div>
              </div>
              <div class="stat-card">
                  <div class="number" id="my-registrations">0</div>
                  <div class="label">æˆ‘çš„å ±å</div>
              </div>
          </div>

          <h4>ğŸ“… å¯å ±åæ´»å‹•</h4>
          <div id="activities-list" class="loading">è¼‰å…¥ä¸­...</div>

          <h4>ğŸ“‹ æˆ‘çš„æ´»å‹•å ±å</h4>
          <div id="my-activities-list" class="loading">è¼‰å…¥ä¸­...</div>
      </div>

      <!-- ææ¬¾è¨˜éŒ„é é¢ -->
      <div id="donations-tab" class="tab-content">
          <h3>ğŸ’° ææ¬¾è¨˜éŒ„</h3>
          
          <div class="grid">
              <div class="stat-card">
                  <div class="number" id="total-donations">0</div>
                  <div class="label">ææ¬¾ç­†æ•¸</div>
              </div>
              <div class="stat-card">
                  <div class="number" id="total-amount">NT$ 0</div>
                  <div class="label">ææ¬¾ç¸½é¡</div>
              </div>
          </div>

          <div id="donations-list" class="loading">è¼‰å…¥ä¸­...</div>
      </div>

      <!-- è²¡å‹™ç®¡ç†é é¢ -->
      <div id="finance-tab" class="tab-content">
          <h3>ğŸ“Š è²¡å‹™ç®¡ç†</h3>
          
          <h4>ğŸ’³ å¸³æˆ¶é¤˜é¡</h4>
          <div id="accounts-list" class="loading">è¼‰å…¥ä¸­...</div>

          <h4>ğŸ“ˆ é ç®—ä½¿ç”¨ç‹€æ³</h4>
          <div id="budget-status" class="loading">è¼‰å…¥ä¸­...</div>

          <h4>ğŸ’¸ æ”¯å‡ºç”³è«‹</h4>
          <div class="form-group">
              <label for="expense-category">æ”¯å‡ºé¡åˆ¥</label>
              <select id="expense-category">
                  <option value="activity">æ´»å‹•æ”¯å‡º</option>
                  <option value="office">è¾¦å…¬è²»ç”¨</option>
                  <option value="marketing">å®£å‚³è²»ç”¨</option>
                  <option value="equipment">è¨­å‚™è²»ç”¨</option>
                  <option value="welfare">ç¦åˆ©æ”¯å‡º</option>
                  <option value="medical">é†«ç™‚æ”¯æ´</option>
                  <option value="volunteer">å¿—å·¥è²»ç”¨</option>
                  <option value="other">å…¶ä»–æ”¯å‡º</option>
              </select>
          </div>
          
          <div class="form-group">
              <label for="expense-amount">é‡‘é¡</label>
              <input type="number" id="expense-amount" placeholder="è«‹è¼¸å…¥é‡‘é¡" min="0">
          </div>
          
          <div class="form-group">
              <label for="expense-description">èªªæ˜</label>
              <textarea id="expense-description" placeholder="è«‹è©³ç´°èªªæ˜æ”¯å‡ºç”¨é€”" rows="3"></textarea>
          </div>
          
          <button class="btn" onclick="submitExpense()">æäº¤æ”¯å‡ºç”³è«‹</button>

          <h4>ğŸ“‹ æˆ‘çš„æ”¯å‡ºç”³è«‹</h4>
          <div id="my-expenses" class="loading">è¼‰å…¥ä¸­...</div>
      </div>

      <!-- æ´»å‹•å›é¥‹é é¢ -->
      <div id="feedback-tab" class="tab-content">
          <h3>ğŸ“ æ´»å‹•å›é¥‹</h3>
          
          <div class="form-group">
              <label for="feedback-activity">é¸æ“‡æ´»å‹•</label>
              <select id="feedback-activity">
                  <option value="">è«‹é¸æ“‡å·²åƒèˆ‡çš„æ´»å‹•</option>
              </select>
          </div>
          
          <div class="form-group">
              <label for="feedback-rating">è©•åˆ† (1-5åˆ†)</label>
              <select id="feedback-rating">
                  <option value="">è«‹é¸æ“‡è©•åˆ†</option>
                  <option value="1">1åˆ† - å¾ˆä¸æ»¿æ„</option>
                  <option value="2">2åˆ† - ä¸æ»¿æ„</option>
                  <option value="3">3åˆ† - æ™®é€š</option>
                  <option value="4">4åˆ† - æ»¿æ„</option>
                  <option value="5">5åˆ† - éå¸¸æ»¿æ„</option>
              </select>
          </div>
          
          <div class="form-group">
              <label for="feedback-comment">æ„è¦‹èˆ‡å»ºè­°</label>
              <textarea id="feedback-comment" placeholder="è«‹åˆ†äº«æ‚¨çš„åƒèˆ‡å¿ƒå¾—èˆ‡å»ºè­°" rows="4"></textarea>
          </div>
          
          <button class="btn" onclick="submitFeedback()">æäº¤å›é¥‹</button>

          <h4>ğŸ“Š æˆ‘çš„å›é¥‹è¨˜éŒ„</h4>
          <div id="my-feedback" class="loading">è¼‰å…¥ä¸­...</div>
      </div>

      <!-- ç®¡ç†åŠŸèƒ½é é¢ -->
      <div id="admin-tab" class="tab-content">
          <h3>ğŸ”§ ç®¡ç†åŠŸèƒ½</h3>
          
          <div class="grid">
              <div class="stat-card">
                  <div class="number" id="total-members">0</div>
                  <div class="label">ç¸½æœƒå“¡æ•¸</div>
              </div>
              <div class="stat-card">
                  <div class="number" id="registered-members">0</div>
                  <div class="label">å·²è¨»å†Šæœƒå“¡</div>
              </div>
          </div>

          <h4>ğŸ‘¥ æœƒå“¡ç®¡ç†</h4>
          <div class="form-group">
              <input type="text" id="member-search" placeholder="æœå°‹æœƒå“¡ï¼ˆå§“åæˆ–LINE IDï¼‰">
          </div>
          <div class="form-group">
              <select id="member-type-filter">
                  <option value="">æ‰€æœ‰æœƒå“¡é¡åˆ¥</option>
                  <option value="member">ä¸€èˆ¬æœƒå“¡</option>
                  <option value="volunteer">å¿—å·¥</option>
                  <option value="vip">VIPæœƒå“¡</option>
              </select>
          </div>
          <button class="btn btn-secondary" onclick="searchMembers()">æœå°‹æœƒå“¡</button>
          
          <div id="members-list" class="loading">è¼‰å…¥ä¸­...</div>

          <h4>ğŸ’¸ æ”¯å‡ºå¯©æ ¸</h4>
          <div id="pending-expenses" class="loading">è¼‰å…¥ä¸­...</div>

          <h4>ğŸ“Š è²¡å‹™å ±è¡¨</h4>
          <div class="form-group">
              <label for="report-year">å¹´ä»½</label>
              <input type="number" id="report-year" value="2024" min="2020" max="2030">
          </div>
          <div class="form-group">
              <label for="report-month">æœˆä»½</label>
              <select id="report-month">
                  <option value="1">1æœˆ</option>
                  <option value="2">2æœˆ</option>
                  <option value="3">3æœˆ</option>
                  <option value="4">4æœˆ</option>
                  <option value="5">5æœˆ</option>
                  <option value="6">6æœˆ</option>
                  <option value="7">7æœˆ</option>
                  <option value="8">8æœˆ</option>
                  <option value="9">9æœˆ</option>
                  <option value="10">10æœˆ</option>
                  <option value="11">11æœˆ</option>
                  <option value="12">12æœˆ</option>
              </select>
          </div>
          <button class="btn" onclick="generateReport()">ç”¢ç”Ÿå ±è¡¨</button>
          
          <div id="finance-report"></div>
      </div>
  </div>

  <script>
      // ç³»çµ±é…ç½®
      const CONFIG = {
          LIFF_ID: '1656516134-VaGgmaPm', // è«‹æ›¿æ›ç‚ºå¯¦éš›çš„ LIFF ID
          API_BASE_URL: 'YOUR_GAS_API_URL', // è«‹æ›¿æ›ç‚ºå¯¦éš›çš„ GAS API URL
          API_KEY: 'AAbb8520258185202581', // è«‹æ›¿æ›ç‚ºå¯¦éš›çš„ API Key
          STRICT_SIGN: false // æ˜¯å¦ä½¿ç”¨åš´æ ¼ç°½ç« é©—è­‰
      };

      // å…¨åŸŸè®Šæ•¸
      let currentUser = null;
      let isAdmin = false;

      // LIFF åˆå§‹åŒ–
      async function initializeLiff() {
          try {
              await liff.init({ liffId: CONFIG.LIFF_ID });
              
              if (!liff.isLoggedIn()) {
                  liff.login();
                  return;
              }

              const profile = await liff.getProfile();
              await createUserIfNotExist(profile.userId, profile.displayName);
              await loadUserInfo();
              
              showMessage('LIFF åˆå§‹åŒ–æˆåŠŸ', 'success');
          } catch (error) {
              console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
              showMessage('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
          }
      }

      // API å‘¼å«å‡½å¼
      async function callAPI(action, data = {}) {
          try {
              const payload = {
                  action,
                  ...data,
                  apiKey: CONFIG.API_KEY,
                  ts: Date.now(),
                  nonce: Math.random().toString(36).substring(2)
              };

              if (CONFIG.STRICT_SIGN) {
                  const baseString = `${action}|${payload.ts}|${payload.nonce}|${CONFIG.API_KEY}`;
                  const signature = CryptoJS.HmacSHA256(baseString, CONFIG.API_KEY).toString();
                  payload.sign = signature;
              }

              const response = await fetch(CONFIG.API_BASE_URL, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
              });

              return await response.json();
          } catch (error) {
              console.error('API å‘¼å«å¤±æ•—:', error);
              throw error;
          }
      }

      // ä½¿ç”¨è€…ç®¡ç†
      async function createUserIfNotExist(lineId, lineName) {
          return await callAPI('createUserIfNotExist', { lineId, lineName });
      }

      async function loadUserInfo() {
          try {
              const profile = await liff.getProfile();
              const result = await callAPI('getUserInfo', { lineId: profile.userId });
              
              if (result.error) {
                  showMessage('ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š', 'error');
                  return;
              }

              currentUser = result;
              isAdmin = result.isAdmin || false;
              
              updateUserInfoDisplay();
              updateUIBasedOnUserStatus();
              
          } catch (error) {
              console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—:', error);
              showMessage('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—', 'error');
          }
      }

      function updateUserInfoDisplay() {
          if (!currentUser) return;

          const userInfoDiv = document.getElementById('user-info');
          const userDetailsDiv = document.getElementById('user-details');
          
          userDetailsDiv.innerHTML = `
              <p><strong>å§“å:</strong> ${currentUser.realName || 'æœªè¨­å®š'}</p>
              <p><strong>LINE åç¨±:</strong> ${currentUser.lineName || 'æœªçŸ¥'}</p>
              <p><strong>ç‹€æ…‹:</strong> <span class="status ${currentUser.status === 'å·²è¨»å†Š' ? 'registered' : 'unregistered'}">${currentUser.status}</span></p>
              <p><strong>æœƒå“¡é¡åˆ¥:</strong> ${currentUser.memberType || 'æœªè¨­å®š'}</p>
              <p><strong>äº’å‹•æ¬¡æ•¸:</strong> ${currentUser.messageCount || 0} æ¬¡</p>
              ${isAdmin ? '<p><strong>æ¬Šé™:</strong> <span class="status approved">ç®¡ç†å“¡</span></p>' : ''}
          `;
          
          userInfoDiv.style.display = 'block';
      }

      function updateUIBasedOnUserStatus() {
          const registrationForm = document.getElementById('registration-form');
          const contactForm = document.getElementById('contact-form');
          const adminTab = document.querySelector('.admin-only');

          if (currentUser.status === 'å·²è¨»å†Š') {
              registrationForm.style.display = 'none';
              contactForm.style.display = 'block';
              
              // å¡«å…¥ç¾æœ‰è¯çµ¡è³‡è¨Š
              document.getElementById('phone').value = currentUser.phone || '';
              document.getElementById('email').value = currentUser.email || '';
              document.getElementById('address').value = currentUser.address || '';
              document.getElementById('birthday').value = currentUser.birthday || '';
          } else {
              registrationForm.style.display = 'block';
              contactForm.style.display = 'none';
          }

          if (isAdmin) {
              adminTab.style.display = 'block';
          }
      }

      // æœƒå“¡è¨»å†Š
      async function registerUser() {
          const realName = document.getElementById('realName').value.trim();
          const memberType = document.getElementById('memberType').value;

          if (!realName || !memberType) {
              showMessage('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
              return;
          }

          try {
              const profile = await liff.getProfile();
              const result = await callAPI('register', {
                  lineId: profile.userId,
                  realName,
                  memberType
              });

              if (result.success) {
                  showMessage('è¨»å†ŠæˆåŠŸï¼', 'success');
                  await loadUserInfo();
              } else {
                  showMessage(`è¨»å†Šå¤±æ•—ï¼š${result.message}`, 'error');
              }
          } catch (error) {
              console.error('è¨»å†Šå¤±æ•—:', error);
              showMessage('è¨»å†Šéç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
          }
      }

      // æ›´æ–°è¯çµ¡è³‡è¨Š
      async function updateContact() {
          const phone = document.getElementById('phone').value.trim();
          const email = document.getElementById('email').value.trim();
          const address = document.getElementById('address').value.trim();
          const birthday = document.getElementById('birthday').value;

          try {
              const profile = await liff.getProfile();
              const result = await callAPI('updateUserContact', {
                  operatorLineId: profile.userId,
                  targetLineId: profile.userId,
                  phone,
                  email,
                  address,
                  birthday
              });

              if (result.success) {
                  showMessage('è¯çµ¡è³‡è¨Šæ›´æ–°æˆåŠŸï¼', 'success');
                  await loadUserInfo();
              } else {
                  showMessage(`æ›´æ–°å¤±æ•—ï¼š${result.message}`, 'error');
              }
          } catch (error) {
              console.error('æ›´æ–°è¯çµ¡è³‡è¨Šå¤±æ•—:', error);
              showMessage('æ›´æ–°éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
          }
      }

      // æ´»å‹•ç®¡ç†
      async function loadActivities() {
          try {
              const result = await callAPI('getActivities');
              const activitiesList = document.getElementById('activities-list');
              
              if (!result || result.length === 0) {
                  activitiesList.innerHTML = '<p>ç›®å‰æ²’æœ‰é–‹æ”¾çš„æ´»å‹•</p>';
                  return;
              }

              document.getElementById('total-activities').textContent = result.length;

              let html = '';
              result.forEach(activity => {
                  const dateStr = activity.date ? new Date(activity.date).toLocaleDateString('zh-TW') : 'å¾…å®š';
                  const participantsText = `${activity.currentParticipants}/${activity.maxParticipants || 'ä¸é™'}`;
                  
                  html += `
                      <div class="activity-item">
                          <div class="activity-info">
                              <h4>${activity.name}</h4>
                              <p>ğŸ“… ${dateStr} | ğŸ“ ${activity.location || 'å¾…å®š'}</p>
                              <p>${activity.description || ''}</p>
                          </div>
                          <div class="participants">${participantsText}</div>
                      </div>
                  `;
              });

              activitiesList.innerHTML = html;
          } catch (error) {
              console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', error);
              document.getElementById('activities-list').innerHTML = '<p class="error">è¼‰å…¥æ´»å‹•å¤±æ•—</p>';
          }
      }

      async function loadMyActivities() {
          try {
              const profile = await liff.getProfile();
              const result = await callAPI('getUserActivities', { lineId: profile.userId });
              const myActivitiesList = document.getElementById('my-activities-list');
              
              if (!result || result.length === 0) {
                  myActivitiesList.innerHTML = '<p>æ‚¨ç›®å‰æ²’æœ‰å ±åä»»ä½•æ´»å‹•</p>';
                  document.getElementById('my-registrations').textContent = '0';
                  return;
              }

              document.getElementById('my-registrations').textContent = result.length;

              let html = '';
              result.forEach(registration => {
                  const dateStr = registration.date ? new Date(registration.date).toLocaleDateString('zh-TW') : 'å¾…å®š';
                  
                  html += `
                      <div class="card">
                          <h4>${registration.activityName}</h4>
                          <p>ğŸ“… ${dateStr}</p>
                          <p>ğŸ“ ${registration.location || 'å¾…å®š'}</p>
                          <p>ğŸ‘¤ åƒèˆ‡è€…ï¼š${registration.participantName}</p>
                          <span class="status registered">${registration.status}</span>
                      </div>
                  `;
              });

              myActivitiesList.innerHTML = html;

              // åŒæ™‚è¼‰å…¥åˆ°å›é¥‹é é¢çš„æ´»å‹•é¸å–®
              loadActivitiesForFeedback(result);
              
          } catch (error) {
              console.error('è¼‰å…¥æˆ‘çš„æ´»å‹•å¤±æ•—:', error);
              document.getElementById('my-activities-list').innerHTML = '<p class="error">è¼‰å…¥å¤±æ•—</p>';
          }
      }

      function loadActivitiesForFeedback(activities) {
          const select = document.getElementById('feedback-activity');
          select.innerHTML = '<option value="">è«‹é¸æ“‡å·²åƒèˆ‡çš„æ´»å‹•</option>';
          
          activities.forEach(activity => {
              const option = document.createElement('option');
              option.value = activity.activityId;
              option.textContent = activity.activityName;
              select.appendChild(option);
          });
      }

      // ææ¬¾è¨˜éŒ„
      async function loadDonations() {
          try {
              const profile = await liff.getProfile();
              const result = await callAPI('getUserDonations', { lineId: profile.userId });
              const donationsList = document.getElementById('donations-list');
              
              if (!result || result.length === 0) {
                  donationsList.innerHTML = '<p>æ‚¨ç›®å‰æ²’æœ‰ææ¬¾è¨˜éŒ„</p>';
                  document.getElementById('total-donations').textContent = '0';
                  document.getElementById('total-amount').textContent = 'NT$ 0';
                  return;
              }

              const totalAmount = result.reduce((sum, donation) => sum + (Number(donation.amount) || 0), 0);
              
              document.getElementById('total-donations').textContent = result.length;
              document.getElementById('total-amount').textContent = `NT$ ${totalAmount.toLocaleString()}`;

              let html = '';
              result.forEach(donation => {
                  const dateStr = donation.date ? new Date(donation.date).toLocaleDateString('zh-TW') : '';
                  
                  html += `
                      <div class="card">
                          <h4>NT$ ${Number(donation.amount).toLocaleString()}</h4>
                          <p>ğŸ“… ${dateStr}</p>
                          <p>ğŸ¯ ${donation.purpose || 'ä¸€èˆ¬ææ¬¾'}</p>
                          <p>ğŸ’³ ${donation.method || 'æœªçŸ¥'}</p>
                          <span class="status ${donation.receiptStatus === 'å·²é–‹ç«‹' ? 'approved' : 'pending'}">${donation.receiptStatus || 'è™•ç†ä¸­'}</span>
                      </div>
                  `;
              });

              donationsList.innerHTML = html;
              
          } catch (error) {
              console.error('è¼‰å…¥ææ¬¾è¨˜éŒ„å¤±æ•—:', error);
              document.getElementById('donations-list').innerHTML = '<p class="error">è¼‰å…¥å¤±æ•—</p>';
          }
      }

      // è²¡å‹™ç®¡ç†
      async function loadFinanceData() {
          await Promise.all([
              loadAccountBalance(),
              loadBudgetStatus(),
              loadMyExpenses()
          ]);
      }

      async function loadAccountBalance() {
          try {
              const result = await callAPI('getAccountBalance');
              const accountsList = document.getElementById('accounts-list');
              
              if (!result.success || !result.accounts.length) {
                  accountsList.innerHTML = '<p>ç›®å‰æ²’æœ‰å¸³æˆ¶è³‡æ–™</p>';
                  return;
              }

              let html = '';
              result.accounts.forEach(account => {
                  html += `
                      <div class="card">
                          <h4>ğŸ¦ ${account.name}</h4>
                          <p>éŠ€è¡Œï¼š${account.bank}</p>
                          <p>é¡å‹ï¼š${account.type}</p>
                          <p><strong>é¤˜é¡ï¼šNT$ ${Number(account.balance).toLocaleString()}</strong></p>
                      </div>
                  `;
              });

              accountsList.innerHTML = html;
              
          } catch (error) {
              console.error('è¼‰å…¥å¸³æˆ¶é¤˜é¡å¤±æ•—:', error);
              document.getElementById('accounts-list').innerHTML = '<p class="error">è¼‰å…¥å¤±æ•—</p>';
          }
      }

      async function loadBudgetStatus() {
          try {
              const result = await callAPI('getBudgetStatus');
              const budgetStatus = document.getElementById('budget-status');
              
              if (!result.success || !result.budgets.length) {
                  budgetStatus.innerHTML = '<p>ç›®å‰æ²’æœ‰é ç®—è³‡æ–™</p>';
                  return;
              }

              let html = '';
              result.budgets.forEach(budget => {
                  const percentage = budget.usagePercentage;
                  const statusClass = percentage.includes('100') ? 'danger' : percentage.includes('8') || percentage.includes('9') ? 'pending' : 'approved';
                  
                  html += `
                      <div class="card">
                          <h4>ğŸ“‚ ${budget.categoryName}</h4>
                          <p>é ç®—ï¼šNT$ ${Number(budget.budgetAmount).toLocaleString()}</p>
                          <p>å·²ç”¨ï¼šNT$ ${Number(budget.usedAmount).toLocaleString()}</p>
                          <p>å‰©é¤˜ï¼šNT$ ${Number(budget.remainingAmount).toLocaleString()}</p>
                          <span class="status ${statusClass}">ä½¿ç”¨ç‡ ${percentage}</span>
                      </div>
                  `;
              });

              budgetStatus.innerHTML = html;
              
          } catch (error) {
              console.error('è¼‰å…¥é ç®—ç‹€æ³å¤±æ•—:', error);
              document.getElementById('budget-status').innerHTML = '<p class="error">è¼‰å…¥å¤±æ•—</p>';
          }
      }

      async function submitExpense() {
          const category = document.getElementById('expense-category').value;
          const amount = document.getElementById('expense-amount').value;
          const description = document.getElementById('expense-description').value.trim();

          if (!category || !amount || !description) {
              showMessage('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
              return;
          }

          if (Number(amount) <= 0) {
              showMessage('é‡‘é¡å¿…é ˆå¤§æ–¼ 0', 'error');
              return;
          }

          try {
              const profile = await liff.getProfile();
              const result = await callAPI('addExpense', {
                  category,
                  amount: Number(amount),
                  description,
                  applicant: currentUser.realName || currentUser.lineName,
                  applicantLineId: profile.userId
              });

              if (result.success) {
                  showMessage('æ”¯å‡ºç”³è«‹æäº¤æˆåŠŸï¼', 'success');
                  
                  // æ¸…ç©ºè¡¨å–®
                  document.getElementById('expense-amount').value = '';
                  document.getElementById('expense-description').value = '';
                  
                  // é‡æ–°è¼‰å…¥æ”¯å‡ºåˆ—è¡¨
                  await loadMyExpenses();
              } else {
                  showMessage(`ç”³è«‹å¤±æ•—ï¼š${result.message}`, 'error');
              }
          } catch (error) {
              console.error('æäº¤æ”¯å‡ºç”³è«‹å¤±æ•—:', error);
              showMessage('æäº¤éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
          }
      }

      async function loadMyExpenses() {
          try {
              const profile = await liff.getProfile();
              const result = await callAPI('getExpenseList', { 
                  lineId: profile.userId,
                  status: 'all'
              });
              
              const myExpenses = document.getElementById('my-expenses');
              
              if (!result.success || !result.expenses.length) {
                  myExpenses.innerHTML = '<p>æ‚¨ç›®å‰æ²’æœ‰æ”¯å‡ºç”³è«‹è¨˜éŒ„</p>';
                  return;
              }

              let html = '';
              result.expenses.forEach(expense => {
                  const dateStr = expense.date ? new Date(expense.date).toLocaleDateString('zh-TW') : '';
                  let statusClass = 'pending';
                  if (expense.status === 'å·²æ ¸å‡†' || expense.status === 'å·²ä»˜æ¬¾') statusClass = 'approved';
                  else if (expense.status === 'å·²æ‹’çµ•') statusClass = 'rejected';
                  
                  html += `
                      <div class="card">
                          <h4>${expense.categoryName}</h4>
                          <p>ğŸ“… ${dateStr}</p>
                          <p>ğŸ’° NT$ ${Number(expense.amount).toLocaleString()}</p>
                          <p>ğŸ“‹ ${expense.description}</p>
                          <span class="status ${statusClass}">${expense.status}</span>
                          ${expense.note ? `<p><small>å‚™è¨»ï¼š${expense.note}</small></p>` : ''}
                      </div>
                  `;
              });

              myExpenses.innerHTML = html;
              
          } catch (error) {
              console.error('è¼‰å…¥æ”¯å‡ºç”³è«‹å¤±æ•—:', error);
              document.getElementById('my-expenses').innerHTML = '<p class="error">è¼‰å…¥å¤±æ•—</p>';
          }
      }

      // æ´»å‹•å›é¥‹
      async function submitFeedback() {
          const activityId = document.getElementById('feedback-activity').value;
          const rating = document.getElementById('feedback-rating').value;
          const comment = document.getElementById('feedback-comment').value.trim();

          if (!activityId || !rating) {
              showMessage('è«‹é¸æ“‡æ´»å‹•ä¸¦çµ¦äºˆè©•åˆ†', 'error');
              return;
          }

          try {
              const profile = await liff.getProfile();
              const result = await callAPI('submitActivityFeedback', {
                  lineId: profile.userId,
                  activityId,
                  rating: Number(rating),
                  comment
              });

              if (result.success) {
                  showMessage('å›é¥‹æäº¤æˆåŠŸï¼', 'success');
                  
                  // æ¸…ç©ºè¡¨å–®
                  document.getElementById('feedback-rating').value = '';
                  document.getElementById('feedback-comment').value = '';
                  
                  // é‡æ–°è¼‰å…¥å›é¥‹è¨˜éŒ„
                  await loadMyFeedback();
              } else {
                  showMessage(`æäº¤å¤±æ•—ï¼š${result.message}`, 'error');
              }
          } catch (error) {
              console.error('æäº¤å›é¥‹å¤±æ•—:', error);
              showMessage('æäº¤éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
          }
      }

      async function loadMyFeedback() {
          try {
              const profile = await liff.getProfile();
              const activities = await callAPI('getUserActivities', { lineId: profile.userId });
              const myFeedback = document.getElementById('my-feedback');
              
              if (!activities || activities.length === 0) {
                  myFeedback.innerHTML = '<p>æ‚¨ç›®å‰æ²’æœ‰åƒèˆ‡çš„æ´»å‹•</p>';
                  return;
              }

              let html = '';
              for (const activity of activities) {
                  try {
                      const feedbackResult = await callAPI('getActivityFeedback', {
                          activityId: activity.activityId,
                          operatorLineId: profile.userId,
                          summaryOnly: false,
                          limit: 1
                      });
                      
                      if (feedbackResult.success && feedbackResult.feedbacks.length > 0) {
                          const feedback = feedbackResult.feedbacks[0];
                          const dateStr = feedback.createdAt ? new Date(feedback.createdAt).toLocaleDateString('zh-TW') : '';
                          
                          html += `
                              <div class="card">
                                  <h4>${activity.activityName}</h4>
                                  <p>ğŸ“… å›é¥‹æ™‚é–“ï¼š${dateStr}</p>
                                  <p>â­ è©•åˆ†ï¼š${feedback.rating}/5</p>
                                  <p>ğŸ’¬ æ„è¦‹ï¼š${feedback.comment || 'ç„¡'}</p>
                              </div>
                          `;
                      }
                  } catch (error) {
                      console.error('è¼‰å…¥å–®ä¸€æ´»å‹•å›é¥‹å¤±æ•—:', error);
                  }
              }

              myFeedback.innerHTML = html || '<p>æ‚¨ç›®å‰æ²’æœ‰æäº¤ä»»ä½•æ´»å‹•å›é¥‹</p>';
              
          } catch (error) {
              console.error('è¼‰å…¥æˆ‘çš„å›é¥‹å¤±æ•—:', error);
              document.getElementById('my-feedback').innerHTML = '<p class="error">è¼‰å…¥å¤±æ•—</p>';
          }
      }

      // ç®¡ç†åŠŸèƒ½
      async function loadAdminData() {
          if (!isAdmin) return;
          
          await Promise.all([
              loadMemberStats(),
              loadAllMembers(),
              loadPendingExpenses()
          ]);
      }

      async function loadMemberStats() {
          try {
              const result = await callAPI('getAllUsers', {
                  operatorLineId: (await liff.getProfile()).userId,
                  page: 1,
                  pageSize: 1000
              });

              if (result.success) {
                  const totalMembers = result.total;
                  const registeredMembers = result.users.filter(u => u.status === 'å·²è¨»å†Š').length;
                  
                  document.getElementById('total-members').textContent = totalMembers;
                  document.getElementById('registered-members').textContent = registeredMembers;
              }
          } catch (error) {
              console.error('è¼‰å…¥æœƒå“¡çµ±è¨ˆå¤±æ•—:', error);
          }
      }

      async function searchMembers() {
          const searchTerm = document.getElementById('member-search').value.trim();
          const typeFilter = document.getElementById('member-type-filter').value;
          
          await loadAllMembers(searchTerm, typeFilter);
      }

      async function loadAllMembers(searchTerm = '', typeFilter = '') {
          try {
              const profile = await liff.getProfile();
              const result = await callAPI('getAllUsers', {
                  operatorLineId: profile.userId,
                  page: 1,
                  pageSize: 100
              });

              const membersList = document.getElementById('members-list');
              
              if (!result.success || !result.users.length) {
                  membersList.innerHTML = '<p>æ²’æœ‰æ‰¾åˆ°æœƒå“¡è³‡æ–™</p>';
                  return;
              }

              let filteredUsers = result.users;
              
              // æœå°‹éæ¿¾
              if (searchTerm) {
                  filteredUsers = filteredUsers.filter(user => 
                      (user.realName && user.realName.includes(searchTerm)) ||
                      (user.lineName && user.lineName.includes(searchTerm)) ||
                      user.lineId.includes(searchTerm)
                  );
              }
              
              // é¡åˆ¥éæ¿¾
              if (typeFilter) {
                  filteredUsers = filteredUsers.filter(user => user.memberType === typeFilter);
              }

              let html = '';
              filteredUsers.forEach(user => {
                  const statusClass = user.status === 'å·²è¨»å†Š' ? 'registered' : 'unregistered';
                  
                  html += `
                      <div class="card">
                          <h4>${user.realName || user.lineName || 'æœªçŸ¥'}</h4>
                          <p>LINE ID: ${user.lineId}</p>
                          <p>æœƒå“¡é¡åˆ¥: ${user.memberType || 'æœªè¨­å®š'}</p>
                          <p>äº’å‹•æ¬¡æ•¸: ${user.messageCount || 0}</p>
                          <p>è¨»å†Šæ™‚é–“: ${user.registeredAt ? new Date(user.registeredAt).toLocaleDateString('zh-TW') : 'æœªçŸ¥'}</p>
                          <span class="status ${statusClass}">${user.status}</span>
                          <div style="margin-top: 10px;">
                              <button class="btn btn-secondary" onclick="updateMemberType('${user.lineId}')">ä¿®æ”¹é¡åˆ¥</button>
                          </div>
                      </div>
                  `;
              });

              membersList.innerHTML = html || '<p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æœƒå“¡</p>';
              
          } catch (error) {
              console.error('è¼‰å…¥æœƒå“¡åˆ—è¡¨å¤±æ•—:', error);
              document.getElementById('members-list').innerHTML = '<p class="error">è¼‰å…¥å¤±æ•—</p>';
          }
      }

      async function updateMemberType(targetLineId) {
          const newType = prompt('è«‹è¼¸å…¥æ–°çš„æœƒå“¡é¡åˆ¥ (member/volunteer/vip):');
          if (!newType) return;
          
          if (!['member', 'volunteer', 'vip'].includes(newType)) {
              showMessage('ç„¡æ•ˆçš„æœƒå“¡é¡åˆ¥', 'error');
              return;
          }

          try {
              const profile = await liff.getProfile();
              const result = await callAPI('updateMemberType', {
                  operatorLineId: profile.userId,
                  targetLineId,
                  newMemberType: newType,
                  note: 'ç®¡ç†å“¡é€é LIFF ä¿®æ”¹'
              });

              if (result.success) {
                  showMessage('æœƒå“¡é¡åˆ¥æ›´æ–°æˆåŠŸï¼', 'success');
                  await loadAllMembers();
              } else {
                  showMessage(`æ›´æ–°å¤±æ•—ï¼š${result.message}`, 'error');
              }
          } catch (error) {
              console.error('æ›´æ–°æœƒå“¡é¡åˆ¥å¤±æ•—:', error);
              showMessage('æ›´æ–°éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
          }
      }

      async function loadPendingExpenses() {
          try {
              const profile = await liff.getProfile();
              const result = await callAPI('getExpenseList', {
                  lineId: null, // è¼‰å…¥æ‰€æœ‰æ”¯å‡º
                  status: 'å¾…å¯©æ ¸'
              });

              const pendingExpenses = document.getElementById('pending-expenses');
              
              if (!result.success || !result.expenses.length) {
                  pendingExpenses.innerHTML = '<p>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„æ”¯å‡ºç”³è«‹</p>';
                  return;
              }

              let html = '';
              result.expenses.forEach(expense => {
                  const dateStr = expense.date ? new Date(expense.date).toLocaleDateString('zh-TW') : '';
                  
                  html += `
                      <div class="card">
                          <h4>${expense.categoryName}</h4>
                          <p>ç”³è«‹äººï¼š${expense.applicant}</p>
                          <p>ğŸ“… ${dateStr}</p>
                          <p>ğŸ’° NT$ ${Number(expense.amount).toLocaleString()}</p>
                          <p>ğŸ“‹ ${expense.description}</p>
                          <span class="status pending">${expense.status}</span>
                          <div style="margin-top: 15px;">
                              <button class="btn" onclick="approveExpense('${expense.id}', true)">æ ¸å‡†</button>
                              <button class="btn btn-danger" onclick="approveExpense('${expense.id}', false)">æ‹’çµ•</button>
                          </div>
                      </div>
                  `;
              });

              pendingExpenses.innerHTML = html;
              
          } catch (error) {
              console.error('è¼‰å…¥å¾…å¯©æ ¸æ”¯å‡ºå¤±æ•—:', error);
              document.getElementById('pending-expenses').innerHTML = '<p class="error">è¼‰å…¥å¤±æ•—</p>';
          }
      }

      async function approveExpense(expenseId, approved) {
          const note = approved ? '' : prompt('è«‹è¼¸å…¥æ‹’çµ•åŸå› :') || '';
          
          try {
              const profile = await liff.getProfile();
              const result = await callAPI('approveExpense', {
                  expenseId,
                  approverName: currentUser.realName || currentUser.lineName,
                  approved,
                  note,
                  operatorLineId: profile.userId
              });

              if (result.success) {
                  showMessage(`æ”¯å‡º${approved ? 'æ ¸å‡†' : 'æ‹’çµ•'}æˆåŠŸï¼`, 'success');
                  await loadPendingExpenses();
              } else {
                  showMessage(`æ“ä½œå¤±æ•—ï¼š${result.message}`, 'error');
              }
          } catch (error) {
              console.error('å¯©æ ¸æ”¯å‡ºå¤±æ•—:', error);
              showMessage('å¯©æ ¸éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
          }
      }

      async function generateReport() {
          const year = document.getElementById('report-year').value;
          const month = document.getElementById('report-month').value;

          if (!year || !month) {
              showMessage('è«‹é¸æ“‡å¹´ä»½å’Œæœˆä»½', 'error');
              return;
          }

          try {
              const result = await callAPI('getFinanceReport', { year, month });
              const reportDiv = document.getElementById('finance-report');
              
              if (!result.success) {
                  reportDiv.innerHTML = `<p class="error">ç”¢ç”Ÿå ±è¡¨å¤±æ•—ï¼š${result.message}</p>`;
                  return;
              }

              const report = result.report;
              
              reportDiv.innerHTML = `
                  <div class="card">
                      <h4>ğŸ“Š è²¡å‹™å ±è¡¨ - ${report.month}</h4>
                      <div class="grid">
                          <div class="stat-card">
                              <div class="number">NT$ ${Number(report.totalIncome).toLocaleString()}</div>
                              <div class="label">ç¸½æ”¶å…¥</div>
                          </div>
                          <div class="stat-card">
                              <div class="number">NT$ ${Number(report.totalExpense).toLocaleString()}</div>
                              <div class="label">ç¸½æ”¯å‡º</div>
                          </div>
                          <div class="stat-card">
                              <div class="number">NT$ ${Number(report.balance).toLocaleString()}</div>
                              <div class="label">æœ¬æœˆçµé¤˜</div>
                          </div>
                          <div class="stat-card">
                              <div class="number">NT$ ${Number(report.cumulativeBalance).toLocaleString()}</div>
                              <div class="label">ç´¯è¨ˆçµé¤˜</div>
                          </div>
                      </div>
                      
                      ${report.topExpenses.length > 0 ? `
                          <h5>ä¸»è¦æ”¯å‡ºé …ç›®</h5>
                          ${report.topExpenses.map(item => `
                              <p>â€¢ ${item.category}: NT$ ${Number(item.amount).toLocaleString()}</p>
                          `).join('')}
                      ` : ''}
                      
                      ${report.topIncomes.length > 0 ? `
                          <h5>ä¸»è¦æ”¶å…¥ä¾†æº</h5>
                          ${report.topIncomes.map(item => `
                              <p>â€¢ ${item.category}: NT$ ${Number(item.amount).toLocaleString()}</p>
                          `).join('')}
                      ` : ''}
                  </div>
              `;
              
          } catch (error) {
              console.error('ç”¢ç”Ÿå ±è¡¨å¤±æ•—:', error);
              document.getElementById('finance-report').innerHTML = '<p class="error">ç”¢ç”Ÿå ±è¡¨å¤±æ•—</p>';
          }
      }

      // UI æ§åˆ¶å‡½å¼
      function showTab(tabName) {
          // éš±è—æ‰€æœ‰åˆ†é å…§å®¹
          document.querySelectorAll('.tab-content').forEach(content => {
              content.classList.remove('active');
          });
          
          // ç§»é™¤æ‰€æœ‰åˆ†é çš„ active ç‹€æ…‹
          document.querySelectorAll('.tab').forEach(tab => {
              tab.classList.remove('active');
          });
          
          // é¡¯ç¤ºé¸ä¸­çš„åˆ†é å…§å®¹
          const targetContent = document.getElementById(`${tabName}-tab`);
          if (targetContent) {
              targetContent.classList.add('active');
          }
          
          // è¨­å®šå°æ‡‰åˆ†é ç‚º active
          const targetTab = document.querySelector(`.tab[onclick="showTab('${tabName}')"]`);
          if (targetTab) {
              targetTab.classList.add('active');
          }
          
          // è¼‰å…¥å°æ‡‰çš„è³‡æ–™
          loadTabData(tabName);
      }

      async function loadTabData(tabName) {
          switch (tabName) {
              case 'activities':
                  await loadActivities();
                  await loadMyActivities();
                  break;
              case 'donations':
                  await loadDonations();
                  break;
              case 'finance':
                  await loadFinanceData();
                  break;
              case 'feedback':
                  await loadMyFeedback();
                  break;
              case 'admin':
                  if (isAdmin) {
                      await loadAdminData();
                  }
                  break;
          }
      }

      function showMessage(message, type = 'info') {
          // ç§»é™¤ç¾æœ‰çš„è¨Šæ¯
          const existingMessage = document.querySelector('.message');
          if (existingMessage) {
              existingMessage.remove();
          }
          
          // å»ºç«‹æ–°è¨Šæ¯
          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${type}`;
          messageDiv.textContent = message;
          messageDiv.style.cssText = `
              position: fixed;
              top: 20px;
              left: 50%;
              transform: translateX(-50%);
              z-index: 1000;
              padding: 15px 20px;
              border-radius: 10px;
              font-weight: 600;
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
              max-width: 90%;
              text-align: center;
          `;
          
          document.body.appendChild(messageDiv);
          
          // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
          setTimeout(() => {
              if (messageDiv.parentNode) {
                  messageDiv.remove();
              }
          }, 3000);
      }

      // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', async () => {
          try {
              await initializeLiff();
              
              // è¨­å®šç•¶å‰æœˆä»½ç‚ºé è¨­å€¼
              const currentDate = new Date();
              document.getElementById('report-month').value = currentDate.getMonth() + 1;
              
              // è¼‰å…¥é è¨­åˆ†é è³‡æ–™
              await loadTabData('profile');
              
          } catch (error) {
              console.error('é é¢åˆå§‹åŒ–å¤±æ•—:', error);
              showMessage('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
          }
      });

      // é˜²æ­¢è¡¨å–®æäº¤æ™‚é é¢é‡æ–°è¼‰å…¥
      document.addEventListener('submit', (e) => {
          e.preventDefault();
      });

      // ç›£è½ LIFF é—œé–‰äº‹ä»¶
      window.addEventListener('beforeunload', () => {
          if (liff.isLoggedIn()) {
              // å¯ä»¥åœ¨é€™è£¡åŸ·è¡Œæ¸…ç†å·¥ä½œ
              console.log('LIFF æ‡‰ç”¨ç¨‹å¼å³å°‡é—œé–‰');
          }
      });
  </script>
</body>
</html>
