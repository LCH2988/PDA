<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸•é‡‘æ£®ç—…å‹æœƒ - æœƒå“¡ç®¡ç†ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      
      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          color: #333;
      }
      
      .container {
          max-width: 400px;
          margin: 0 auto;
          padding: 20px;
      }
      
      .header {
          background: white;
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 20px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
          text-align: center;
      }
      
      .header h1 {
          color: #667eea;
          margin-bottom: 10px;
          font-size: 1.5em;
      }
      
      .card {
          background: white;
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 15px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      }
      
      .profile-section {
          display: none;
      }
      
      .profile-info {
          display: flex;
          align-items: center;
          margin-bottom: 15px;
      }
      
      .profile-pic {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          margin-right: 15px;
      }
      
      .profile-details h3 {
          color: #667eea;
          margin-bottom: 5px;
      }
      
      .status-badge {
          display: inline-block;
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 0.8em;
          font-weight: bold;
      }
      
      .status-registered {
          background: #e8f5e8;
          color: #2e7d32;
      }
      
      .status-unregistered {
          background: #fff3e0;
          color: #f57c00;
      }
      
      .menu-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          margin-top: 20px;
      }
      
      .menu-item {
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
          border: none;
          border-radius: 12px;
          padding: 20px;
          text-align: center;
          cursor: pointer;
          transition: transform 0.2s;
          text-decoration: none;
          display: flex;
          flex-direction: column;
          align-items: center;
      }
      
      .menu-item:hover {
          transform: translateY(-2px);
      }
      
      .menu-item.disabled {
          background: #ccc;
          cursor: not-allowed;
      }
      
      .menu-icon {
          font-size: 2em;
          margin-bottom: 10px;
      }
      
      .form-group {
          margin-bottom: 15px;
      }
      
      .form-group label {
          display: block;
          margin-bottom: 5px;
          font-weight: bold;
          color: #555;
      }
      
      .form-group input,
      .form-group select {
          width: 100%;
          padding: 12px;
          border: 2px solid #ddd;
          border-radius: 8px;
          font-size: 16px;
      }
      
      .btn {
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 16px;
          width: 100%;
          transition: opacity 0.2s;
      }
      
      .btn:hover {
          opacity: 0.9;
      }
      
      .btn:disabled {
          background: #ccc;
          cursor: not-allowed;
      }
      
      .activities-list {
          max-height: 400px;
          overflow-y: auto;
      }
      
      .activity-item {
          border: 1px solid #eee;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 10px;
          background: #f9f9f9;
      }
      
      .activity-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
      }
      
      .activity-id {
          background: #667eea;
          color: white;
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 0.8em;
      }
      
      .activity-status {
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 0.8em;
      }
      
      .status-open {
          background: #e8f5e8;
          color: #2e7d32;
      }
      
      .loading {
          text-align: center;
          padding: 20px;
          color: #666;
      }
      
      .hidden {
          display: none;
      }
      
      .back-btn {
          background: #f5f5f5;
          color: #333;
          border: 1px solid #ddd;
          padding: 8px 16px;
          border-radius: 6px;
          cursor: pointer;
          margin-bottom: 15px;
      }

      .alert {
          padding: 12px;
          border-radius: 8px;
          margin-bottom: 15px;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .alert-error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .stats-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
          margin-top: 15px;
      }

      .stat-item {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          text-align: center;
      }

      .stat-number {
          font-size: 1.5em;
          font-weight: bold;
          color: #667eea;
      }

      .stat-label {
          font-size: 0.9em;
          color: #666;
          margin-top: 5px;
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>ğŸŒŸ å°ç£å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ</h1>
          <p>æœƒå“¡ç®¡ç†ç³»çµ±</p>
      </div>
      
      <!-- ä¸»ç•«é¢ -->
      <div id="main-screen">
          <div class="card profile-section" id="profile-card">
              <div class="profile-info">
                  <img id="profile-pic" class="profile-pic" src="" alt="å¤§é ­ç…§">
                  <div class="profile-details">
                      <h3 id="display-name">è¼‰å…¥ä¸­...</h3>
                      <span id="status-badge" class="status-badge">è¼‰å…¥ä¸­...</span>
                  </div>
              </div>
              <div id="user-stats" class="stats-grid"></div>
          </div>
          
          <div class="card">
              <h3>ğŸ  åŠŸèƒ½é¸å–®</h3>
              <div class="menu-grid">
                  <button class="menu-item" onclick="showRegistration()">
                      <div class="menu-icon">ğŸ“</div>
                      <div>å¯¦åç™»è¨˜</div>
                  </button>
                  <button class="menu-item" onclick="showActivities()">
                      <div class="menu-icon">ğŸ“…</div>
                      <div>æ´»å‹•è³‡è¨Š</div>
                  </button>
                  <button class="menu-item" onclick="showProfile()">
                      <div class="menu-icon">ğŸ‘¤</div>
                      <div>å€‹äººè³‡æ–™</div>
                  </button>
                  <button class="menu-item" id="volunteer-menu" onclick="showVolunteer()" style="display:none;">
                      <div class="menu-icon">ğŸ™‹â€â™€ï¸</div>
                      <div>å¿—å·¥å¹³å°</div>
                  </button>
                  <button class="menu-item" id="member-menu" onclick="showMemberArea()" style="display:none;">
                      <div class="menu-icon">ğŸ‘‘</div>
                      <div>æœƒå“¡å°ˆå€</div>
                  </button>
                  <button class="menu-item" onclick="showHelp()">
                      <div class="menu-icon">â“</div>
                      <div>ä½¿ç”¨èªªæ˜</div>
                  </button>
              </div>
          </div>
      </div>
      
      <!-- å¯¦åç™»è¨˜ç•«é¢ -->
      <div id="registration-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">â† è¿”å›ä¸»ç•«é¢</button>
          <div class="card">
              <h3>ğŸ“ å¯¦ååˆ¶ç™»è¨˜</h3>
              <div id="registration-alert"></div>
              <form id="registration-form">
                  <div class="form-group">
                      <label for="real-name">çœŸå¯¦å§“å</label>
                      <input type="text" id="real-name" required placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å">
                  </div>
                  <div class="form-group">
                      <label for="member-type">æˆå“¡é¡åˆ¥</label>
                      <select id="member-type" required>
                          <option value="">è«‹é¸æ“‡æˆå“¡é¡åˆ¥</option>
                          <option value="member">ä¸€èˆ¬æˆå“¡</option>
                          <option value="volunteer">å¿—å·¥</option>
                          <option value="vip">æœƒå“¡</option>
                      </select>
                  </div>
                  <button type="submit" class="btn" id="register-btn">å®Œæˆç™»è¨˜</button>
              </form>
          </div>
      </div>
      
      <!-- æ´»å‹•è³‡è¨Šç•«é¢ -->
      <div id="activities-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">â† è¿”å›ä¸»ç•«é¢</button>
          <div class="card">
              <h3>ğŸ“… æ´»å‹•è³‡è¨Š</h3>
              <div id="activities-loading" class="loading">è¼‰å…¥æ´»å‹•è³‡è¨Šä¸­...</div>
              <div id="activities-list" class="activities-list hidden"></div>
          </div>
          
          <div class="card">
              <h3>ğŸ¯ å¿«é€Ÿå ±å</h3>
              <div id="quick-register-alert"></div>
              <div class="form-group">
                  <label for="quick-register">è¼¸å…¥æ´»å‹•ç·¨è™Ÿ + 1 é€²è¡Œå¿«é€Ÿå ±å</label>
                  <input type="text" id="quick-register" placeholder="ä¾‹å¦‚ï¼š001+1">
              </div>
              <button onclick="quickRegister()" class="btn">å¿«é€Ÿå ±å</button>
          </div>
          
          <div class="card">
              <h3>ğŸ“‹ ä¸€èˆ¬/åœ˜é«”å ±å</h3>
              <div id="normal-register-alert"></div>
              <div class="form-group">
                  <label for="normal-register">æ´»å‹•ç·¨è™Ÿ + å§“åï¼ˆå¤šäººç”¨+åˆ†éš”ï¼‰</label>
                  <input type="text" id="normal-register" placeholder="ä¾‹å¦‚ï¼š001+ç‹å°æ˜ æˆ– 001+ç‹å°æ˜+æå°è¯">
              </div>
              <button onclick="normalRegister()" class="btn">æäº¤å ±å</button>
          </div>
      </div>
      
      <!-- å€‹äººè³‡æ–™ç•«é¢ -->
      <div id="profile-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">â† è¿”å›ä¸»ç•«é¢</button>
          <div class="card">
              <h3>ğŸ‘¤ å€‹äººè³‡æ–™</h3>
              <div id="profile-details"></div>
          </div>
      </div>
      
      <!-- å¿—å·¥å¹³å°ç•«é¢ -->
      <div id="volunteer-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">â† è¿”å›ä¸»ç•«é¢</button>
          <div class="card">
              <h3>ğŸ™‹â€â™€ï¸ å¿—å·¥å¹³å°</h3>
              <div class="menu-grid">
                  <button class="menu-item" onclick="showVolunteerTasks()">
                      <div class="menu-icon">ğŸ“‹</div>
                      <div>å¿—å·¥ä»»å‹™</div>
                  </button>
                  <button class="menu-item" onclick="showVolunteerSchedule()">
                      <div class="menu-icon">ğŸ“…</div>
                      <div>æ’ç­è¡¨</div>
                  </button>
                  <button class="menu-item" onclick="showVolunteerHours()">
                      <div class="menu-icon">â°</div>
                      <div>æœå‹™æ™‚æ•¸</div>
                  </button>
                  <button class="menu-item" onclick="showVolunteerTraining()">
                      <div class="menu-icon">ğŸ“</div>
                      <div>åŸ¹è¨“èª²ç¨‹</div>
                  </button>
              </div>
          </div>
      </div>
      
      <!-- æœƒå“¡å°ˆå€ç•«é¢ -->
      <div id="member-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">â† è¿”å›ä¸»ç•«é¢</button>
          <div class="card">
              <h3>ğŸ‘‘ æœƒå“¡å°ˆå€</h3>
              <div class="menu-grid">
                  <button class="menu-item" onclick="showDonationRecord()">
                      <div class="menu-icon">ğŸ’°</div>
                      <div>ææ¬¾è¨˜éŒ„</div>
                  </button>
                  <button class="menu-item" onclick="showMyActivities()">
                      <div class="menu-icon">ğŸ“</div>
                      <div>æˆ‘çš„æ´»å‹•</div>
                  </button>
                  <button class="menu-item" onclick="showPersonalStats()">
                      <div class="menu-icon">ğŸ“Š</div>
                      <div>å€‹äººçµ±è¨ˆ</div>
                  </button>
                  <button class="menu-item" onclick="updatePersonalInfo()">
                      <div class="menu-icon">âš™ï¸</div>
                      <div>è³‡æ–™ç¶­è­·</div>
                  </button>
              </div>
          </div>
      </div>

      <!-- ææ¬¾è¨˜éŒ„ç•«é¢ -->
      <div id="donation-screen" class="hidden">
          <button class="back-btn" onclick="showMemberArea()">â† è¿”å›æœƒå“¡å°ˆå€</button>
          <div class="card">
              <h3>ğŸ’° ææ¬¾è¨˜éŒ„</h3>
              <div id="donation-loading" class="loading">è¼‰å…¥ææ¬¾è¨˜éŒ„ä¸­...</div>
              <div id="donation-list" class="hidden"></div>
          </div>
      </div>

      <!-- æˆ‘çš„æ´»å‹•ç•«é¢ -->
      <div id="my-activities-screen" class="hidden">
          <button class="back-btn" onclick="showMemberArea()">â† è¿”å›æœƒå“¡å°ˆå€</button>
          <div class="card">
              <h3>ğŸ“ æˆ‘çš„æ´»å‹•</h3>
              <div id="my-activities-loading" class="loading">è¼‰å…¥æ´»å‹•è¨˜éŒ„ä¸­...</div>
              <div id="my-activities-list" class="hidden"></div>
          </div>
      </div>
  </div>

  <script>
      const LIFF_ID = '1656516134-VaGgmaPm';
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbw2pyyym3GdBK-1-SeekMxrqjVQnBBYqDBjMQ6msE2JNs6KXpoY-kICGL58XnnQK9OazQ/exec'; // è«‹æ›¿æ›ç‚ºå¯¦éš›çš„ GAS Web App URL
      let userProfile = null;
      let userData = null;

      // åˆå§‹åŒ–LIFF
      async function initializeLiff() {
          try {
              await liff.init({ liffId: LIFF_ID });
              
              if (liff.isLoggedIn()) {
                  userProfile = await liff.getProfile();
                  await loadUserData();
                  updateUI();
              } else {
                  liff.login();
              }
          } catch (error) {
              console.error('LIFFåˆå§‹åŒ–å¤±æ•—:', error);
              showAlert('registration-alert', 'error', 'ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
          }
      }

      // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
      async function loadUserData() {
          try {
              const response = await fetch(`${GAS_URL}?action=getUserInfo&userId=${userProfile.userId}`);
              const result = await response.json();
              if (result.error) {
                  throw new Error(result.error);
              }
              userData = result;
          } catch (error) {
              console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:', error);
              userData = null;
          }
      }

      // æ›´æ–°UI
      function updateUI() {
          if (userProfile) {
              document.getElementById('profile-pic').src = userProfile.pictureUrl;
              document.getElementById('display-name').textContent = userProfile.displayName;
              
              const statusBadge = document.getElementById('status-badge');
              const userStatsDiv = document.getElementById('user-stats');
              
              if (userData && userData.status === 'å·²è¨»å†Š') {
                  statusBadge.textContent = getTypeName(userData.memberType);
                  statusBadge.className = 'status-badge status-registered';
                  
                  // é¡¯ç¤ºä½¿ç”¨è€…çµ±è¨ˆ
                  userStatsDiv.innerHTML = `
                      <div class="stat-item">
                          <div class="stat-number">${userData.messageCount}</div>
                          <div class="stat-label">ç™¼è¨€æ¬¡æ•¸</div>
                      </div>
                      <div class="stat-item">
                          <div class="stat-number">${Math.floor((new Date() - new Date(userData.firstTime)) / (1000 * 60 * 60 * 24))}</div>
                          <div class="stat-label">åŠ å…¥å¤©æ•¸</div>
                      </div>
                  `;
                  
                  // é¡¯ç¤ºå°æ‡‰çš„åŠŸèƒ½é¸å–®
                  if (userData.memberType === 'volunteer') {
                      document.getElementById('volunteer-menu').style.display = 'block';
                  } else if (userData.memberType === 'vip') {
                      document.getElementById('member-menu').style.display = 'block';
                  }
              } else {
                  statusBadge.textContent = 'æœªå®Œæˆç™»è¨˜';
                  statusBadge.className = 'status-badge status-unregistered';
                  userStatsDiv.innerHTML = '<p style="text-align: center; color: #666;">è«‹å…ˆå®Œæˆå¯¦ååˆ¶ç™»è¨˜</p>';
              }
              
              document.querySelector('.profile-section').style.display = 'block';
          }
      }

      // é¡¯ç¤ºè­¦å‘Šè¨Šæ¯
      function showAlert(containerId, type, message) {
          const container = document.getElementById(containerId);
          container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
          setTimeout(() => {
              container.innerHTML = '';
          }, 5000);
      }

      // ç•«é¢åˆ‡æ›å‡½æ•¸
      function showMain() {
          hideAllScreens();
          document.getElementById('main-screen').classList.remove('hidden');
      }

      function showRegistration() {
          hideAllScreens();
          document.getElementById('registration-screen').classList.remove('hidden');
      }

      function showActivities() {
          hideAllScreens();
          document.getElementById('activities-screen').classList.remove('hidden');
          loadActivities();
      }

      function showProfile() {
          hideAllScreens();
          document.getElementById('profile-screen').classList.remove('hidden');
          loadProfileDetails();
      }

      function showVolunteer() {
          hideAllScreens();
          document.getElementById('volunteer-screen').classList.remove('hidden');
      }

      function showMemberArea() {
          hideAllScreens();
          document.getElementById('member-screen').classList.remove('hidden');
      }

      function showDonationRecord() {
          hideAllScreens();
          document.getElementById('donation-screen').classList.remove('hidden');
          loadDonationRecord();
      }

      function showMyActivities() {
          hideAllScreens();
          document.getElementById('my-activities-screen').classList.remove('hidden');
          loadMyActivities();
      }

      function hideAllScreens() {
          const screens = [
              'main-screen', 'registration-screen', 'activities-screen', 
              'profile-screen', 'volunteer-screen', 'member-screen',
              'donation-screen', 'my-activities-screen'
          ];
          screens.forEach(screen => {
              document.getElementById(screen).classList.add('hidden');
          });
      }

      // å¯¦åç™»è¨˜è™•ç†
      document.getElementById('registration-form').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const realName = document.getElementById('real-name').value.trim();
          const memberType = document.getElementById('member-type').value;
          const registerBtn = document.getElementById('register-btn');
          
          if (!realName || !memberType) {
              showAlert('registration-alert', 'error', 'è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
              return;
          }

          // é©—è­‰å§“åæ ¼å¼
          if (!/^[\u4e00-\u9fa5a-zA-Z\s]{2,10}$/.test(realName)) {
              showAlert('registration-alert', 'error', 'å§“åæ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥2-10å€‹ä¸­æ–‡æˆ–è‹±æ–‡å­—å…ƒ');
              return;
          }
          
          registerBtn.disabled = true;
          registerBtn.textContent = 'ç™»è¨˜ä¸­...';
          
          try {
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'register',
                      userId: userProfile.userId,
                      realName: realName,
                      memberType: memberType
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showAlert('registration-alert', 'success', 'è¨»å†ŠæˆåŠŸï¼');
                  await loadUserData();
                  updateUI();
                  setTimeout(() => showMain(), 2000);
              } else {
                  showAlert('registration-alert', 'error', 'è¨»å†Šå¤±æ•—ï¼š' + result.message);
              }
          } catch (error) {
              console.error('è¨»å†Šå¤±æ•—:', error);
              showAlert('registration-alert', 'error', 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          } finally {
              registerBtn.disabled = false;
              registerBtn.textContent = 'å®Œæˆç™»è¨˜';
          }
      });

      // è¼‰å…¥æ´»å‹•è³‡è¨Š
      async function loadActivities() {
          try {
              const response = await fetch(`${GAS_URL}?action=getActivities`);
              const result = await response.json();
              
              if (result.error) {
                  throw new Error(result.error);
              }
              
              const activities = result;
              
              document.getElementById('activities-loading').classList.add('hidden');
              const activitiesList = document.getElementById('activities-list');
              activitiesList.classList.remove('hidden');
              
              if (activities.length === 0) {
                  activitiesList.innerHTML = '<p style="text-align: center; color: #666;">ç›®å‰æ²’æœ‰é–‹æ”¾å ±åçš„æ´»å‹•</p>';
                  return;
              }
              
              let html = '';
              activities.forEach(activity => {
                  html += `
                      <div class="activity-item">
                          <div class="activity-header">
                              <span class="activity-id">${activity.id}</span>
                              <span class="activity-status status-open">${activity.status}</span>
                          </div>
                          <h4>${activity.name}</h4>
                          <p>ğŸ“ åœ°é»ï¼š${activity.location}</p>
                          <p>ğŸ“… æ—¥æœŸï¼š${formatDate(activity.date)}</p>
                          <p>â° å ±åæˆªæ­¢ï¼š${formatDate(activity.deadline)}</p>
                          ${activity.maxParticipants ? `<p>ğŸ‘¥ äººæ•¸é™åˆ¶ï¼š${activity.currentParticipants || 0}/${activity.maxParticipants}</p>` : ''}
                      </div>
                  `;
              });
              
              activitiesList.innerHTML = html;
          } catch (error) {
              console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', error);
              document.getElementById('activities-loading').textContent = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†';
          }
      }

      // å¿«é€Ÿå ±å
      async function quickRegister() {
          const input = document.getElementById('quick-register').value.trim();
          
          if (!input.match(/^\d+\+1$/)) {
              showAlert('quick-register-alert', 'error', 'æ ¼å¼éŒ¯èª¤ï¼è«‹è¼¸å…¥ï¼šæ´»å‹•ç·¨è™Ÿ+1');
              return;
          }
          
          if (!userData || userData.status !== 'å·²è¨»å†Š') {
              showAlert('quick-register-alert', 'error', 'è«‹å…ˆå®Œæˆå¯¦ååˆ¶ç™»è¨˜ï¼');
              return;
          }
          
          try {
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'quickRegister',
                      userId: userProfile.userId,
                      input: input
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showAlert('quick-register-alert', 'success', `å ±åæˆåŠŸï¼æ´»å‹•ï¼š${result.activity ? result.activity.name : 'æœªçŸ¥æ´»å‹•'}`);
                  document.getElementById('quick-register').value = '';
                  loadActivities(); // é‡æ–°è¼‰å…¥æ´»å‹•åˆ—è¡¨
              } else {
                  showAlert('quick-register-alert', 'error', 'å ±åå¤±æ•—ï¼š' + result.message);
              }
          } catch (error) {
              console.error('å ±åå¤±æ•—:', error);
              showAlert('quick-register-alert', 'error', 'å ±åå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
      }

      // ä¸€èˆ¬/åœ˜é«”å ±å
      async function normalRegister() {
          const input = document.getElementById('normal-register').value.trim();
          
          if (!input.match(/^\d+\+.+/)) {
              showAlert('normal-register-alert', 'error', 'æ ¼å¼éŒ¯èª¤ï¼è«‹è¼¸å…¥ï¼šæ´»å‹•ç·¨è™Ÿ+å§“å');
              return;
          }
          
          try {
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'normalRegister',
                      userId: userProfile.userId,
                      input: input
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  const names = result.names ? result.names.join('ã€') : 'å ±åè€…';
                  showAlert('normal-register-alert', 'success', `å ±åæˆåŠŸï¼åƒåŠ è€…ï¼š${names}`);
                  document.getElementById('normal-register').value = '';
                  loadActivities(); // é‡æ–°è¼‰å…¥æ´»å‹•åˆ—è¡¨
              } else {
                  showAlert('normal-register-alert', 'error', 'å ±åå¤±æ•—ï¼š' + result.message);
              }
          } catch (error) {
              console.error('å ±åå¤±æ•—:', error);
              showAlert('normal-register-alert', 'error', 'å ±åå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
      }

      // è¼‰å…¥å€‹äººè³‡æ–™è©³æƒ…
      function loadProfileDetails() {
          if (!userData) {
              document.getElementById('profile-details').innerHTML = '<p style="color: #666;">ç„¡æ³•è¼‰å…¥å€‹äººè³‡æ–™</p>';
              return;
          }
          
          let html = `
              <div style="margin-bottom: 15px;">
                  <strong>LINEåç¨±ï¼š</strong>${userProfile.displayName}
              </div>
          `;
          
          if (userData.status === 'å·²è¨»å†Š') {
              html += `
                  <div style="margin-bottom: 15px;">
                      <strong>çœŸå¯¦å§“åï¼š</strong>${userData.realName}
                  </div>
                  <div style="margin-bottom: 15px;">
                      <strong>æˆå“¡é¡åˆ¥ï¼š</strong>${getTypeName(userData.memberType)}
                  </div>
              `;
          } else {
              html += `
                  <div style="margin-bottom: 15px; color: #f57c00;">
                      <strong>è¨»å†Šç‹€æ…‹ï¼š</strong>æœªå®Œæˆå¯¦ååˆ¶ç™»è¨˜
                  </div>
              `;
          }
          
          html += `
              <div style="margin-bottom: 15px;">
                  <strong>ç™¼è¨€æ¬¡æ•¸ï¼š</strong>${userData.messageCount}
              </div>
              <div style="margin-bottom: 15px;">
                  <strong>åŠ å…¥æ™‚é–“ï¼š</strong>${formatDateTime(userData.firstTime)}
              </div>
              <div style="margin-bottom: 15px;">
                  <strong>æœ€å¾Œæ´»å‹•ï¼š</strong>${formatDateTime(userData.lastTime)}
              </div>
          `;
          
          document.getElementById('profile-details').innerHTML = html;
      }

      // è¼‰å…¥ææ¬¾è¨˜éŒ„
      async function loadDonationRecord() {
          try {
              const response = await fetch(`${GAS_URL}?action=getUserDonations&userId=${userProfile.userId}`);
              const result = await response.json();
              
              if (result.error) {
                  throw new Error(result.error);
              }
              
              const donations = result;
              
              document.getElementById('donation-loading').classList.add('hidden');
              const donationList = document.getElementById('donation-list');
              donationList.classList.remove('hidden');
              
              if (donations.length === 0) {
                  donationList.innerHTML = '<p style="text-align: center; color: #666;">ç›®å‰æ²’æœ‰ææ¬¾è¨˜éŒ„</p>';
                  return;
              }

              let html = '';
              let totalAmount = 0;

              donations.forEach(donation => {
                  html += `
                      <div class="activity-item">
                          <div class="activity-header">
                              <span class="activity-id">$${donation.amount}</span>
                              <span class="activity-status status-open">${donation.receiptStatus}</span>
                          </div>
                          <p>ğŸ“… æ—¥æœŸï¼š${formatDate(donation.date)}</p>
                          <p>ğŸ’³ æ–¹å¼ï¼š${donation.method}</p>
                          <p>ğŸ¯ ç”¨é€”ï¼š${donation.purpose}</p>
                          ${donation.receiptId ? `<p>ğŸ“„ æ”¶æ“šï¼š${donation.receiptId}</p>` : ''}
                      </div>
                  `;
                  totalAmount += parseInt(donation.amount);
              });

              html = `<div class="stat-item" style="margin-bottom: 15px;">
                  <div class="stat-number">$${totalAmount.toLocaleString()}</div>
                  <div class="stat-label">ç´¯è¨ˆææ¬¾é‡‘é¡</div>
              </div>` + html;
              
              donationList.innerHTML = html;
          } catch (error) {
              console.error('è¼‰å…¥ææ¬¾è¨˜éŒ„å¤±æ•—:', error);
              document.getElementById('donation-loading').textContent = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†';
          }
      }

      // è¼‰å…¥æˆ‘çš„æ´»å‹•
      async function loadMyActivities() {
          try {
              const response = await fetch(`${GAS_URL}?action=getUserActivities&userId=${userProfile.userId}`);
              const result = await response.json();
              
              if (result.error) {
                  throw new Error(result.error);
              }
              
              const activities = result;
              
              document.getElementById('my-activities-loading').classList.add('hidden');
              const activitiesList = document.getElementById('my-activities-list');
              activitiesList.classList.remove('hidden');
              
              if (activities.length === 0) {
                  activitiesList.innerHTML = '<p style="text-align: center; color: #666;">ç›®å‰æ²’æœ‰åƒåŠ éçš„æ´»å‹•</p>';
                  return;
              }

              let html = '';
              activities.forEach(activity => {
                  html += `
                      <div class="activity-item">
                          <div class="activity-header">
                              <span class="activity-id">${activity.activityId}</span>
                              <span class="activity-status ${activity.status === 'å·²ç°½åˆ°' ? 'status-open' : ''}">${activity.status}</span>
                          </div>
                          <h4>${activity.activityName}</h4>
                          <p>ğŸ“ åœ°é»ï¼š${activity.location}</p>
                          <p>ğŸ“… æ—¥æœŸï¼š${formatDate(activity.date)}</p>
                      </div>
                  `;
              });
              
              activitiesList.innerHTML = html;
          } catch (error) {
              console.error('è¼‰å…¥æˆ‘çš„æ´»å‹•å¤±æ•—:', error);
              document.getElementById('my-activities-loading').textContent = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†';
          }
      }

      // è¼”åŠ©å‡½æ•¸
      function getTypeName(type) {
          const typeNames = {
              'member': 'ä¸€èˆ¬æˆå“¡',
              'volunteer': 'å¿—å·¥',
              'vip': 'æœƒå“¡'
          };
          return typeNames[type] || 'æœªè¨­å®š';
      }

      function formatDate(dateString) {
          if (!dateString) return 'æœªè¨­å®š';
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW');
      }

      function formatDateTime(dateString) {
          if (!dateString) return 'æœªè¨­å®š';
          const date = new Date(dateString);
          return date.toLocaleString('zh-TW');
      }

      function showHelp() {
          const helpText = `ğŸ“– ä½¿ç”¨èªªæ˜

ğŸ“ å¯¦åç™»è¨˜ï¼š
â€¢ é¦–æ¬¡ä½¿ç”¨éœ€å®Œæˆå¯¦ååˆ¶ç™»è¨˜
â€¢ é¸æ“‡é©åˆçš„æˆå“¡é¡åˆ¥

ğŸ“… æ´»å‹•å ±åï¼š
â€¢ å¿«é€Ÿå ±åï¼šæ´»å‹•ç·¨è™Ÿ+1
â€¢ ä¸€èˆ¬å ±åï¼šæ´»å‹•ç·¨è™Ÿ+å§“å
â€¢ åœ˜é«”å ±åï¼šæ´»å‹•ç·¨è™Ÿ+å§“å1+å§“å2

ğŸ™‹â€â™€ï¸ å¿—å·¥åŠŸèƒ½ï¼š
â€¢ å¿—å·¥å°ˆç”¨çš„ä»»å‹™ç®¡ç†å¹³å°

ğŸ‘‘ æœƒå“¡å°ˆå€ï¼š
â€¢ ææ¬¾è¨˜éŒ„æŸ¥è©¢
â€¢ å€‹äººæ´»å‹•æ¸…å–®
â€¢ è³‡æ–™ç¶­è­·åŠŸèƒ½

ğŸ“ å¦‚æœ‰å•é¡Œè«‹è¯çµ¡ï¼š02-12345678`;
          
          alert(helpText);
      }

      // å¿—å·¥å¹³å°åŠŸèƒ½ï¼ˆç¤ºä¾‹ï¼‰
      function showVolunteerTasks() {
          alert('å¿—å·¥ä»»å‹™åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼');
      }

      function showVolunteerSchedule() {
          alert('æ’ç­è¡¨åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼');
      }

      function showVolunteerHours() {
          alert('æœå‹™æ™‚æ•¸åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼');
      }

      function showVolunteerTraining() {
          alert('åŸ¹è¨“èª²ç¨‹åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼');
      }

      // æœƒå“¡å°ˆå€åŠŸèƒ½
      function showPersonalStats() {
          if (!userData || userData.status !== 'å·²è¨»å†Š') {
              alert('è«‹å…ˆå®Œæˆå¯¦ååˆ¶ç™»è¨˜ï¼');
              return;
          }

          const joinDays = Math.floor((new Date() - new Date(userData.firstTime)) / (1000 * 60 * 60 * 24));
          const statsText = `ğŸ“Š å€‹äººçµ±è¨ˆ

ğŸ‘¤ æœƒå“¡ï¼š${userData.realName}
ğŸ·ï¸ é¡åˆ¥ï¼š${getTypeName(userData.memberType)}
ğŸ“… åŠ å…¥å¤©æ•¸ï¼š${joinDays} å¤©
ğŸ’¬ ç™¼è¨€æ¬¡æ•¸ï¼š${userData.messageCount} æ¬¡
â° æœ€å¾Œæ´»å‹•ï¼š${formatDateTime(userData.lastTime)}`;
          
          alert(statsText);
      }

      function updatePersonalInfo() {
          alert('è³‡æ–™ç¶­è­·åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œå¦‚éœ€æ›´æ–°å€‹äººè³‡æ–™è«‹è¯çµ¡å®¢æœï¼š02-12345678');
      }

      // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
      window.addEventListener('load', initializeLiff);

      // é é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚é‡æ–°è¼‰å…¥è³‡æ–™
      document.addEventListener('visibilitychange', function() {
          if (!document.hidden && userProfile) {
              loadUserData().then(() => updateUI());
          }
      });
  </script>
</body>
</html>
