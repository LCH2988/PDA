
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¸•é‡‘æ£®ç—…å‹æœƒæ•´åˆç³»çµ±</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --c-bg:#f5f7fa;
      --c-card:#ffffff;
      --c-border:#d8e0e8;
      --c-primary:#2563eb;
      --c-primary-hover:#1d4ed8;
      --c-text:#1f2937;
      --c-muted:#6b7280;
      --c-danger:#dc2626;
      --c-warn:#f59e0b;
      --c-ok:#059669;
      --radius:10px;
      --transition: .2s ease;
    }
    [data-theme=contrast]{
      --c-bg:#111;
      --c-card:#1e1e1e;
      --c-border:#444;
      --c-text:#fff;
      --c-muted:#bbb;
    }
    body {
      margin:0; font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:var(--c-bg); color:var(--c-text); display:flex; min-height:100vh;
      -webkit-font-smoothing: antialiased;
    }
    aside {
      width:260px; background:linear-gradient(180deg,#2563eb,#1d4ed8); color:#fff;
      display:flex; flex-direction:column; padding:16px 14px; box-sizing:border-box;
    }
    .brand { font-size:18px; font-weight:600; line-height:1.3; margin-bottom:14px; display:flex; gap:8px; align-items:center; }
    .brand span.logo {
      background:#fff1; width:38px; height:38px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:12px; font-weight:700; font-size:15px; letter-spacing:1px;
    }
    nav { flex:1; overflow:auto; }
    nav button {
      width:100%; background:transparent; border:none; text-align:left;
      color:#fff; padding:10px 12px; border-radius:8px; cursor:pointer;
      font-size:14px; display:flex; align-items:center; gap:8px; transition:var(--transition);
    }
    nav button:hover { background:#ffffff22; }
    nav button.active { background:#ffffff33; font-weight:600; }
    .footer-aside { font-size:11px; opacity:.8; margin-top:18px; line-height:1.6; }
    main { flex:1; display:flex; flex-direction:column; }
    header {
      background:var(--c-card); border-bottom:1px solid var(--c-border); padding:10px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      position:sticky; top:0; z-index:20;
    }
    header .actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button, .btn {
      background:var(--c-primary); border:none; color:#fff; padding:8px 14px;
      border-radius:6px; font:inherit; cursor:pointer; font-size:13px; display:inline-flex; align-items:center; gap:6px;
      transition:var(--transition);
    }
    button:hover { background:var(--c-primary-hover); }
    button.outline {
      background:transparent; color:var(--c-primary); border:1px solid var(--c-primary);
    }
    button.outline:hover { background:var(--c-primary); color:#fff; }
    button.ghost {
      background:transparent; color:var(--c-primary); border:none;
    }
    button.ghost:hover { background:#00000010; }
    .danger { background:var(--c-danger); }
    .danger:hover { background:#b91c1c; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; }
    .content-wrapper { padding:20px clamp(12px,2vw,40px); flex:1; overflow:auto; }
    h1,h2,h3 { font-weight:600; line-height:1.25; margin:0 0 14px; }
    h2 { font-size:18px; }
    h3 { font-size:15px; margin-top:28px; }
    p { line-height:1.6; margin:0 0 10px; }
    .grid { display:grid; gap:14px; }
    .grid.cols-2 { grid-template-columns:repeat(auto-fit,minmax(270px,1fr)); }
    .grid.cols-3 { grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); }
    .card {
      background:var(--c-card); border:1px solid var(--c-border); border-radius:var(--radius);
      padding:16px 18px; position:relative; box-shadow:0 2px 4px rgba(0,0,0,.04);
      transition:var(--transition);
    }
    .card:hover { box-shadow:0 4px 10px rgba(0,0,0,.08); }
    .card h3 { margin-top:0; }
    label.field { display:flex; flex-direction:column; gap:4px; font-size:12px; font-weight:500; }
    input[type=text],input[type=number],input[type=date],textarea,select {
      border:1px solid var(--c-border); background:#fff; color:inherit; padding:8px 10px; border-radius:6px;
      font:inherit; font-size:13px; box-sizing:border-box; width:100%; transition:var(--transition);
    }
    textarea { resize:vertical; min-height:90px; }
    input:focus,textarea:focus,select:focus { outline:2px solid #2563eb55; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th,td { padding:7px 10px; border:1px solid var(--c-border); vertical-align:top; }
    th { background:#f1f5f9; text-align:left; }
    [data-theme=contrast] th { background:#222; }
    .muted { color:var(--c-muted); font-size:12px; }
    .highlight { background:#fff6d5; }
    .badge {
      display:inline-block; background:#e5efff; color:#1d4ed8; padding:3px 8px; border-radius:16px;
      font-size:11px; margin-right:4px; font-weight:500;
    }
    [data-theme=contrast] .badge { background:#333; color:#8ab4ff; }
    .flex { display:flex; }
    .wrap { flex-wrap:wrap; }
    .gap { gap:10px; }
    .right { margin-left:auto; }
    .panel-title { font-size:14px; font-weight:600; margin:0 0 8px; display:flex; align-items:center; gap:6px; }
    .status-bar { font-size:12px; padding:4px 10px; border-radius:20px; background:#e2e8f0; display:inline-flex; gap:4px; align-items:center; }
    [data-theme=contrast] .status-bar { background:#333; color:#fff; }
    .top-activities { display:flex; flex-direction:column; gap:8px; }
    .activity-item {
      padding:10px 12px; border:1px solid var(--c-border); border-radius:8px; background:linear-gradient(135deg,#ffffff 0%,#f5f9ff 85%);
      display:flex; flex-direction:column; gap:4px; font-size:13px; position:relative;
    }
    [data-theme=contrast] .activity-item { background:#222; }
    .activity-item .title { font-weight:600; font-size:14px; }
    .activity-item small { color:var(--c-muted); }
    .chip { display:inline-block; padding:2px 8px; background:#2563eb10; color:var(--c-primary); border-radius:12px; font-size:11px; }
    .split { display:flex; gap:16px; flex-wrap:wrap; }
    .split > * { flex:1 1 300px; }
    .inline-form { display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end; }
    .sticky-info { position:sticky; top:86px; }
    .toggle-group { display:flex; gap:6px; }
    .small { font-size:12px; }
    .danger-text { color:var(--c-danger); }
    .ok-text { color:var(--c-ok); }
    .warn-text { color:var(--c-warn); }
    .divider { height:1px; background:var(--c-border); margin:24px 0; }
    .notice {
      background:#eef7ff; padding:10px 14px; border-radius:8px; border-left:4px solid var(--c-primary);
      font-size:13px; line-height:1.5;
    }
    [data-theme=contrast] .notice { background:#222; border-color:#555; }
    .floating-save {
      position:fixed; bottom:22px; right:26px; z-index:50;
      background:var(--c-primary); color:#fff; padding:10px 18px; border-radius:28px;
      box-shadow:0 4px 14px rgba(0,0,0,.2); cursor:pointer; font-size:14px; font-weight:500;
    }
    .font-size-large { font-size:1.08em; }
    .font-size-xlarge { font-size:1.18em; }
    @media (max-width:960px){
      aside { width:210px; }
    }
    @media (max-width:760px){
      aside { display:none; }
      body { flex-direction:column; }
      header { border-radius:0; }
    }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <aside id="sidebar">
    <div class="brand"><span class="logo">PD</span><div>å¸•é‡‘æ£®ç—…å‹æœƒ<br/><small>æ•´åˆç³»çµ±</small></div></div>
    <nav id="navMenu"></nav>
    <div class="footer-aside">
      <div>Â© 2025</div>
      <div style="margin-top:4px;">
        <button class="ghost small" id="btnToggleTheme">é«˜å°æ¯”/ä¸€èˆ¬</button><br/>
        <button class="ghost small" id="btnFontNormal">å­— M</button>
        <button class="ghost small" id="btnFontLarge">å­— L</button>
        <button class="ghost small" id="btnFontXLarge">å­— XL</button>
      </div>
    </div>
  </aside>
  <main>
    <header>
      <div class="status-bar" id="statusBar">è¼‰å…¥ä¸­...</div>
      <div class="actions">
        <input type="text" placeholder="API_KEY(æ¸¬è©¦)" id="apiKeyInput" style="width:160px;">
        <button id="btnInit">åˆå§‹åŒ–</button>
        <button class="outline" id="btnReloadProfile">é‡æ–°è¼‰å…¥ä½¿ç”¨è€…</button>
        <button class="outline" id="btnLogout">LIFF ç™»å‡º</button>
      </div>
    </header>
    <div class="content-wrapper" id="contentArea">
      <!-- å‹•æ…‹æ³¨å…¥ -->
    </div>
  </main>

  <div class="floating-save" id="saveLocalBtn" title="å„²å­˜è¨­å®š">å„²å­˜è¨­å®š</div>

  <script>
    /***********************
     * åŸºæœ¬å¸¸æ•¸ï¼ˆè«‹ä¾éƒ¨ç½²ç’°å¢ƒèª¿æ•´ï¼‰
     ***********************/
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwp1S1cyYlaBIZvZv7GFu4dHFClrCY1vXIAyZldCqV9YgjP90oNC2tkNfGUtGKOYkuk/execvc'; // éƒ¨ç½²å¾Œæ›¿æ›
    const LIFF_ID = '1656516134-VaGgmaPm';
    const ADMIN_IDS = ['AAbb8520258185202581']; // å¯åœ¨å¾Œç«¯è¨­å®šï¼Œæ­¤è™•åƒ…åšå‰ç«¯ UI å¿«é€Ÿåˆ¤æ–·

    /***********************
     * å…¨åŸŸç‹€æ…‹
     ***********************/
    const state = {
      apiBase: WEBAPP_URL,
      apiKey: '',
      userId: '',
      displayName: '',
      userInfo: null,
      isAdmin: false,
      activitiesCache: [],
      fontSizeMode: 'normal',
      theme: 'normal'
    };

    /***********************
     * DOM å¿«å–
     ***********************/
    const $ = sel => document.querySelector(sel);
    const navMenu = $('#navMenu');
    const contentArea = $('#contentArea');

    /***********************
     * å·¥å…·
     ***********************/
    function setStatus(msg){ $('#statusBar').textContent = msg; }
    function randomNonce(len=16){
      const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
      return s;
    }
    let _cachedKey=null;
    async function getCryptoKey(secret){
      if(_cachedKey && _cachedKey.__raw===secret) return _cachedKey;
      const enc=new TextEncoder();
      const key=await crypto.subtle.importKey('raw',enc.encode(secret),{name:'HMAC',hash:'SHA-256'},false,['sign']);
      key.__raw=secret; _cachedKey=key; return key;
    }
    async function hmacSha256Hex(secret,data){
      const key=await getCryptoKey(secret);
      const enc=new TextEncoder();
      const sig=await crypto.subtle.sign('HMAC',key,enc.encode(data));
      return Array.from(new Uint8Array(sig)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    async function callApi(action, payload={}){
      if(!state.apiKey) throw new Error('å°šæœªå¡«å…¥ API_KEY');
      const ts=Date.now();
      const nonce=randomNonce();
      const base=action+'|'+ts+'|'+nonce+'|'+state.apiKey;
      const sign=await hmacSha256Hex(state.apiKey, base);
      const body={ action, ts, nonce, sign, ...payload };
      const res=await fetch(state.apiBase,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    }
    function saveLocal(){
      localStorage.setItem('pd_apiKey', state.apiKey);
      localStorage.setItem('pd_fontSize', state.fontSizeMode);
      localStorage.setItem('pd_theme', state.theme);
      setStatus('è¨­å®šå·²å„²å­˜');
    }
    function loadLocal(){
      const k=localStorage.getItem('pd_apiKey');
      if(k){ state.apiKey=k; $('#apiKeyInput').value=k; }
      const f=localStorage.getItem('pd_fontSize');
      if(f){ applyFontSize(f); }
      const th=localStorage.getItem('pd_theme');
      if(th){ applyTheme(th); }
    }

    /***********************
     * å°è¦½ / é é¢çµ„ä»¶
     ***********************/
    const pages = [
      { id:'dashboard', label:'ç¸½è¦½', icon:'ğŸ“Š' },
      { id:'member', label:'æœƒå“¡è³‡æ–™', icon:'ğŸ‘¤' },
      { id:'activities', label:'æ´»å‹•åˆ—è¡¨', icon:'ğŸ—“ï¸' },
      { id:'myActivities', label:'æˆ‘çš„æ´»å‹•', icon:'âœ…' },
      { id:'donations', label:'ææ¬¾ç´€éŒ„', icon:'ğŸ’' },
      { id:'feedback', label:'æ´»å‹•å›é¥‹', icon:'ğŸ“' },
      { id:'finance', label:'è²¡å‹™è³‡è¨Š', icon:'ğŸ’°' },
      { id:'expense', label:'æ”¯å‡ºç®¡ç†', icon:'ğŸ§¾' },
      { id:'admin', label:'ç®¡ç†å·¥å…·', icon:'ğŸ›¡ï¸', admin:true }
    ];

    function renderNav(){
      navMenu.innerHTML='';
      pages.forEach(p=>{
        if(p.admin && !state.isAdmin) return;
        const btn=document.createElement('button');
        btn.textContent=p.icon+' '+p.label;
        btn.dataset.page=p.id;
        btn.addEventListener('click',()=>activatePage(p.id));
        navMenu.appendChild(btn);
      });
      // é è¨­
      const first=navMenu.querySelector('button');
      if(first) first.classList.add('active');
      activatePage(first?first.dataset.page:'dashboard');
    }
    function activatePage(id){
      navMenu.querySelectorAll('button').forEach(b=> b.classList.toggle('active', b.dataset.page===id));
      routeTo(id);
    }

    /***********************
     * UI å»ºæ§‹åŠ©æ‰‹
     ***********************/
    function wrapCard(title, inner, extraClass=''){
      return `<div class="card ${extraClass}">
        ${title?`<h3>${title}</h3>`:''}
        ${inner||''}
      </div>`;
    }
    function formatActivitiesList(list){
      if(!list.length) return '<p class="muted">ç›®å‰æ²’æœ‰æ´»å‹•</p>';
      return `<div class="grid cols-3">${
        list.map(a=>`
          <div class="activity-item">
            <div class="title">${a.id}. ${a.name||''}</div>
            <div><span class="chip">${a.date||''}</span> <span class="chip">${a.location||''}</span></div>
            <small>å ±åï¼š${a.currentParticipants}/${a.maxParticipants||'-'}</small>
            <div style="display:flex;gap:6px;margin-top:6px;">
              <button class="outline btnQuick" data-id="${a.id}">+1</button>
              <button class="outline btnNormal" data-id="${a.id}">å ±å</button>
            </div>
          </div>
        `).join('')
      }</div>`;
    }

    /***********************
     * PAGE: Dashboard
     ***********************/
    function pageDashboard(){
      const latest = state.activitiesCache.slice(0,3);
      contentArea.innerHTML=`
        <h2>ç³»çµ±ç¸½è¦½</h2>
        <div class="grid cols-3">
          ${wrapCard('å¿«é€Ÿè³‡è¨Š',`
            <div><strong>ä½¿ç”¨è€…ï¼š</strong>${state.displayName||'-'}</div>
            <div><strong>lineIdï¼š</strong>${state.userId||'-'}</div>
            <div><strong>ç‹€æ…‹ï¼š</strong>${state.userInfo?.status||'-'}</div>
            <div><strong>æœƒå“¡é¡åˆ¥ï¼š</strong>${state.userInfo?.memberType||'-'}</div>
            <div style="margin-top:8px;">${state.isAdmin?'<span class="badge">ADMIN</span>':''}</div>
            <div class="notice" style="margin-top:10px;">é¦–æ¬¡ä½¿ç”¨å¯å‰å¾€ã€Œæœƒå“¡è³‡æ–™ã€é€²è¡Œè¨»å†Šï¼Œæˆ–æ–¼ LINE Bot è¼¸å…¥ï¼šè¨»å†Š ç‹å°æ˜ vip</div>
          `)}
          ${wrapCard('æœ€æ–°æ´»å‹•(å‰ä¸‰ç­†)', latest.length
            ? latest.map(a=>`
              <div style="margin-bottom:8px;">
                <div><strong>${a.id}. ${a.name}</strong></div>
                <small>${a.date} @ ${a.location} | ${a.currentParticipants}/${a.maxParticipants||'-'}</small>
              </div>`).join('')
            : '<p class="muted">å°šç„¡æ´»å‹•</p>'
          )}
          ${wrapCard('å¿«é€Ÿæ“ä½œ',`
            <div class="toolbar">
              <button id="dashReloadActs" class="outline">é‡æ–°è¼‰å…¥æ´»å‹•</button>
              <button id="dashMyActs" class="outline">æˆ‘çš„æ´»å‹•</button>
              <button id="dashFinance" class="outline">è²¡å‹™</button>
            </div>
            <div style="margin-top:14px;">
              <label class="field">å¿«é€Ÿå ±åè¼¸å…¥ <input type="text" id="dashRegInput" placeholder="ä¾‹å¦‚ï¼š5+1 æˆ– 5+å§“å+å§“å"></label>
              <button style="margin-top:6px;" id="dashRegBtn">é€å‡ºå ±å</button>
              <pre id="dashRegLog" style="font-size:11px;margin-top:8px;max-height:120px;overflow:auto;"></pre>
            </div>
          `)}
        </div>
      `;
      $('#dashReloadActs').addEventListener('click', async ()=>{
        await loadActivitiesToCache(true);
        activatePage('dashboard');
      });
      $('#dashMyActs').addEventListener('click',()=>activatePage('myActivities'));
      $('#dashFinance').addEventListener('click',()=>activatePage('finance'));
      $('#dashRegBtn').addEventListener('click', async ()=>{
        const v=$('#dashRegInput').value.trim();
        if(!v) return;
          const act = /^\d+\+1$/.test(v)?'quickRegister':'normalRegister';
        try{
          const r=await callApi(act,{ userId:state.userId, input:v });
          $('#dashRegLog').textContent=JSON.stringify(r,null,2);
          if(r.success) await loadMyActivitiesCache();
        }catch(e){
          $('#dashRegLog').textContent='éŒ¯èª¤:'+e.message;
        }
      });
    }

    /***********************
     * PAGE: Member
     ***********************/
    function pageMember(){
      const u=state.userInfo||{};
      contentArea.innerHTML=`
        <h2>æœƒå“¡è³‡æ–™</h2>
        <div class="split">
          <div>
            ${wrapCard('åŸºæœ¬è³‡æ–™',`
              <div><strong>LINEåç¨±ï¼š</strong>${u.lineName||'-'}</div>
              <div><strong>çœŸå¯¦å§“åï¼š</strong>${u.realName||'-'}</div>
              <div><strong>ç‹€æ…‹ï¼š</strong>${u.status||'-'}</div>
              <div><strong>æœƒå“¡é¡åˆ¥ï¼š</strong>${u.memberType||'-'}</div>
              <div><strong>é›»è©±ï¼š</strong>${u.phone||'-'}</div>
              <div><strong>Emailï¼š</strong>${u.email||'-'}</div>
              <div><strong>åœ°å€ï¼š</strong>${u.address||'-'}</div>
              <div><strong>ç”Ÿæ—¥ï¼š</strong>${u.birthday||'-'}</div>
            `)}
            ${wrapCard('è¨»å†Š / ä¿®æ”¹',`
              <div class="inline-form">
                <label class="field">çœŸå¯¦å§“å<input type="text" id="regRealName" value="${u.realName||''}"></label>
                <label class="field">æœƒå“¡é¡åˆ¥
                  <select id="regMemberType">
                    <option value="member" ${u.memberType==='member'?'selected':''}>member</option>
                    <option value="volunteer" ${u.memberType==='volunteer'?'selected':''}>volunteer</option>
                    <option value="vip" ${u.memberType==='vip'?'selected':''}>vip</option>
                  </select>
                </label>
                <button id="btnRegisterUser">é€å‡ºè¨»å†Š</button>
              </div>
              <div class="notice" style="margin-top:8px;">è‹¥å°šæœªè¨»å†Šï¼Œè«‹å¡«å§“åå¾Œç›´æ¥é€å‡ºã€‚</div>
            `)}
          </div>
          <div class="sticky-info">
            ${wrapCard('æ›´æ–°è¯çµ¡è³‡æ–™',`
              <div class="grid cols-2" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr));">
                <label class="field">é›»è©±<input type="text" id="updPhone" value="${u.phone||''}"></label>
                <label class="field">Email<input type="text" id="updEmail" value="${u.email||''}"></label>
                <label class="field">åœ°å€<input type="text" id="updAddress" value="${u.address||''}"></label>
                <label class="field">ç”Ÿæ—¥<input type="date" id="updBirthday" value="${u.birthday||''}"></label>
              </div>
              <button style="margin-top:8px;" id="btnUpdateContact">æ›´æ–°è¯çµ¡è³‡æ–™</button>
            `)}
          </div>
        </div>
      `;
      $('#btnRegisterUser').addEventListener('click', registerUserHandler);
      $('#btnUpdateContact').addEventListener('click', updateContactHandler);
    }

    async function registerUserHandler(){
      try{
        const realName=$('#regRealName').value.trim();
        const memberType=$('#regMemberType').value;
        const r=await callApi('register',{ userId:state.userId, realName, memberType });
        alert(r.success?'è¨»å†Š/æ›´æ–°æˆåŠŸ':'å¤±æ•—ï¼š'+r.message);
        await refreshUserInfo();
        activatePage('member');
      }catch(e){ alert('å¤±æ•—ï¼š'+e.message); }
    }
    async function updateContactHandler(){
      try{
        const r=await callApi('updateUserContact',{
          operatorLineId:state.userId,
          targetLineId:state.userId,
          phone:$('#updPhone').value.trim(),
          email:$('#updEmail').value.trim(),
          address:$('#updAddress').value.trim(),
          birthday:$('#updBirthday').value
        });
        alert(r.success?'æ›´æ–°æˆåŠŸ':'å¤±æ•—ï¼š'+r.message);
        await refreshUserInfo();
        activatePage('member');
      }catch(e){ alert('å¤±æ•—ï¼š'+e.message); }
    }

    /***********************
     * PAGE: Activities
     ***********************/
    function pageActivities(){
      contentArea.innerHTML=`
        <h2>æ´»å‹•åˆ—è¡¨</h2>
        <div class="toolbar" style="margin-bottom:12px;">
          <button class="outline" id="btnReloadActivities">é‡æ–°è¼‰å…¥</button>
          <label class="field" style="max-width:260px;">å¿«é€Ÿå ±åå­—ä¸²
            <input type="text" id="actInput" placeholder="5+1 / 5+å¼µä¸‰+æå››">
          </label>
          <button id="btnActRegister">é€å‡º</button>
        </div>
        <div id="activitiesContainer">${formatActivitiesList(state.activitiesCache)}</div>
        <pre id="actLog" style="margin-top:14px;font-size:11px;max-height:180px;overflow:auto;"></pre>
      `;
      $('#btnReloadActivities').addEventListener('click', async ()=>{
        await loadActivitiesToCache(true);
        pageActivities();
      });
      $('#btnActRegister').addEventListener('click', async ()=>{
        const val=$('#actInput').value.trim();
        if(!val) return;
        const action=/^\d+\+1$/.test(val)?'quickRegister':'normalRegister';
        try{
          const r=await callApi(action,{ userId:state.userId, input:val });
          $('#actLog').textContent=JSON.stringify(r,null,2);
          if(r.success) await loadMyActivitiesCache();
        }catch(e){
          $('#actLog').textContent='éŒ¯èª¤ï¼š'+e.message;
        }
      });
      document.querySelectorAll('.btnQuick').forEach(b=>{
        b.addEventListener('click', async ()=>{
          try{
            const r=await callApi('quickRegister',{ userId:state.userId, input: b.dataset.id + '+1' });
            alert(r.success?'æˆåŠŸ':'å¤±æ•—ï¼š'+r.message);
          }catch(e){ alert('éŒ¯èª¤ï¼š'+e.message); }
        });
      });
      document.querySelectorAll('.btnNormal').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const nm=prompt('è¼¸å…¥å§“å(å¯+å¤šä½, ä»¥+åˆ†éš”)','');
          if(!nm) return;
          try{
            const r=await callApi('normalRegister',{ userId:state.userId, input: b.dataset.id + '+' + nm });
            alert(r.success?'æˆåŠŸ':'å¤±æ•—ï¼š'+r.message);
          }catch(e){ alert('éŒ¯èª¤ï¼š'+e.message); }
        });
      });
    }

    /***********************
     * PAGE: My Activities
     ***********************/
    async function pageMyActivities(){
      const list = await callApi('getUserActivities',{ userId:state.userId });
      contentArea.innerHTML=`
        <h2>æˆ‘çš„æ´»å‹•</h2>
        <div class="card">
          <div style="overflow:auto;">
            <table>
              <thead><tr><th>æ´»å‹•ID</th><th>åç¨±</th><th>æ—¥æœŸ</th><th>åœ°é»</th><th>ç‹€æ…‹</th></tr></thead>
              <tbody>
                ${
                  !Array.isArray(list)||!list.length
                  ? '<tr><td colspan="5" class="muted">å°šç„¡å ±å</td></tr>'
                  : list.map(i=>`<tr><td>${i.activityId}</td><td>${i.activityName||''}</td><td>${i.date||''}</td><td>${i.location||''}</td><td>${i.status}</td></tr>`).join('')
                }
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    /***********************
     * PAGE: Donations
     ***********************/
    async function pageDonations(){
      const dons=await callApi('getUserDonations',{ userId:state.userId });
      const sum=Array.isArray(dons)?dons.reduce((s,d)=>s+(Number(d.amount)||0),0):0;
      contentArea.innerHTML=`
        <h2>ææ¬¾ç´€éŒ„</h2>
        <div class="card">
          <div>ç¸½ç­†æ•¸ï¼š${dons.length||0}ã€€ç¸½é¡ï¼š${sum}</div>
          <div style="overflow:auto;margin-top:10px;">
            <table>
              <thead><tr><th>ID</th><th>é‡‘é¡</th><th>æ—¥æœŸ</th><th>æ–¹å¼</th><th>ç”¨é€”</th><th>æ”¶æ“š</th></tr></thead>
              <tbody>
                ${
                  !dons.length
                    ? '<tr><td colspan="6" class="muted">å°šç„¡ç´€éŒ„</td></tr>'
                    : dons.slice(-100).map(d=>`<tr><td>${d.id}</td><td>${d.amount}</td><td>${d.date||''}</td><td>${d.method||''}</td><td>${d.purpose||''}</td><td>${d.receiptStatus||''}</td></tr>`).join('')
                }
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    /***********************
     * PAGE: Feedback
     ***********************/
    function pageFeedback(){
      contentArea.innerHTML=`
        <h2>æ´»å‹•å›é¥‹</h2>
        <div class="card">
          <div class="inline-form">
            <label class="field">æ´»å‹•ç·¨è™Ÿ<input type="text" id="fbActivityId"></label>
            <label class="field">è©•åˆ†(1-5)<input type="number" id="fbRating" min="1" max="5"></label>
            <label class="field" style="flex:1;">æ„è¦‹<input type="text" id="fbComment" placeholder="æœ€å¤š300å­—"></label>
            <button id="btnSubmitFeedback">é€å‡º/æ›´æ–°</button>
          </div>
        </div>
        <div class="card">
          <div class="inline-form">
            <label class="field">æŸ¥è©¢æ´»å‹•ID(å¯ç©º)<input type="text" id="fbQueryId" placeholder="ä¾‹å¦‚ 5"></label>
            <label class="field">summaryOnly
              <select id="fbSummaryOnly"><option value="true">true</option><option value="false" selected>false</option></select>
            </label>
            <label class="field">limit<input type="number" id="fbLimit" value="50"></label>
            <button id="btnGetFeedback">å–å¾—å›é¥‹</button>
          </div>
          <pre id="feedbackResult" style="margin-top:10px;max-height:220px;overflow:auto;font-size:11px;"></pre>
        </div>
      `;
      $('#btnSubmitFeedback').addEventListener('click', submitFeedbackHandler);
      $('#btnGetFeedback').addEventListener('click', fetchFeedbackHandler);
    }
    async function submitFeedbackHandler(){
      try{
        const activityId=$('#fbActivityId').value.trim();
        const rating=$('#fbRating').value;
        const comment=$('#fbComment').value.trim();
        if(!activityId) return alert('ç¼ºæ´»å‹•ID');
        const r=await callApi('submitActivityFeedback',{ lineId:state.userId, activityId, rating, comment });
        alert(r.success?'æˆåŠŸ':'å¤±æ•—ï¼š'+r.message);
      }catch(e){ alert('å¤±æ•—ï¼š'+e.message); }
    }
    async function fetchFeedbackHandler(){
      try{
        const activityId=$('#fbQueryId').value.trim();
        const summaryOnly=$('#fbSummaryOnly').value==='true';
        const limit=Number($('#fbLimit').value||50);
        const r=await callApi('getActivityFeedback',{ operatorLineId:state.userId, activityId:activityId||undefined, summaryOnly, limit });
        $('#feedbackResult').textContent=JSON.stringify(r,null,2);
      }catch(e){
        $('#feedbackResult').textContent='éŒ¯èª¤ï¼š'+e.message;
      }
    }

    /***********************
     * PAGE: Finance
     ***********************/
    function pageFinance(){
      contentArea.innerHTML=`
        <h2>è²¡å‹™è³‡è¨Š</h2>
        <div class="grid cols-2">
          ${wrapCard('å¸³æˆ¶é¤˜é¡',`
            <button class="outline" id="btnLoadAccounts">è¼‰å…¥å¸³æˆ¶</button>
            <pre id="accountsBox" style="margin-top:8px;max-height:180px;overflow:auto;font-size:11px;"></pre>
          `)}
          ${wrapCard('é ç®—ä½¿ç”¨',`
            <button class="outline" id="btnLoadBudgets">è¼‰å…¥é ç®—</button>
            <pre id="budgetsBox" style="margin-top:8px;max-height:180px;overflow:auto;font-size:11px;"></pre>
          `)}
        </div>
        <div class="card">
          <h3>æœˆåº¦è²¡å ±</h3>
          <div class="inline-form">
            <label class="field">å¹´ä»½<input type="number" id="reportYear" value="2025"></label>
            <label class="field">æœˆä»½<input type="number" id="reportMonth" value="9" min="1" max="12"></label>
            <button id="btnGetReport">å–å¾—è²¡å ±</button>
          </div>
          <pre id="financeReportBox" style="margin-top:8px;max-height:240px;overflow:auto;font-size:11px;"></pre>
        </div>
      `;
      $('#btnLoadAccounts').addEventListener('click', async ()=>{
        try{ const r=await callApi('getAccountBalance',{}); $('#accountsBox').textContent=JSON.stringify(r,null,2); }
        catch(e){ $('#accountsBox').textContent='éŒ¯èª¤ï¼š'+e.message; }
      });
      $('#btnLoadBudgets').addEventListener('click', async ()=>{
        try{ const r=await callApi('getBudgetStatus',{}); $('#budgetsBox').textContent=JSON.stringify(r,null,2); }
        catch(e){ $('#budgetsBox').textContent='éŒ¯èª¤ï¼š'+e.message; }
      });
      $('#btnGetReport').addEventListener('click', async ()=>{
        try{
          const year=$('#reportYear').value;
          const month=$('#reportMonth').value;
          const r=await callApi('getFinanceReport',{ year, month });
          $('#financeReportBox').textContent=JSON.stringify(r,null,2);
        }catch(e){ $('#financeReportBox').textContent='éŒ¯èª¤ï¼š'+e.message; }
      });
    }

    /***********************
     * PAGE: Expense
     ***********************/
    function pageExpense(){
      contentArea.innerHTML=`
        <h2>æ”¯å‡ºç®¡ç†</h2>
        <div class="card">
          <h3>æ–°å¢æ”¯å‡º</h3>
          <div class="grid cols-3" style="grid-template-columns:repeat(auto-fit,minmax(190px,1fr));">
            <label class="field">é¡åˆ¥<input type="text" id="expCategory" value="activity"></label>
            <label class="field">é‡‘é¡<input type="number" id="expAmount" value="500"></label>
            <label class="field">æè¿°<input type="text" id="expDesc" value="æ¸¬è©¦æ”¯å‡º"></label>
            <label class="field">ä»˜æ¬¾æ–¹å¼<input type="text" id="expPayMethod" placeholder="è½‰å¸³/ç¾é‡‘"></label>
            <label class="field">æ”¶æ¬¾å°è±¡<input type="text" id="expRecipient" placeholder="å•†å®¶/å€‹äºº"></label>
          </div>
          <button style="margin-top:10px;" id="btnAddExpense">æ–°å¢æ”¯å‡º</button>
        </div>
        <div class="card">
          <h3>æˆ‘çš„æ”¯å‡ºåˆ—è¡¨</h3>
          <div class="inline-form">
            <label class="field" style="max-width:160px;">ç‹€æ…‹(all/å¾…å¯©æ ¸/å·²æ ¸å‡†/å·²æ‹’çµ•/å·²ä»˜æ¬¾)<input type="text" id="expStatusFilter" value="all"></label>
            <button id="btnLoadMyExpenses">è¼‰å…¥</button>
          </div>
          <div style="overflow:auto;margin-top:8px;">
            <table>
              <thead><tr><th>ID</th><th>é¡åˆ¥</th><th>é‡‘é¡</th><th>æè¿°</th><th>ç‹€æ…‹</th></tr></thead>
              <tbody id="expenseTbody"><tr><td colspan="5" class="muted">å°šæœªè¼‰å…¥</td></tr></tbody>
            </table>
          </div>
        </div>
      `;
      $('#btnAddExpense').addEventListener('click', addExpenseHandler);
      $('#btnLoadMyExpenses').addEventListener('click', loadMyExpensesHandler);
    }
    async function addExpenseHandler(){
      try{
        const r=await callApi('addExpense',{
          category:$('#expCategory').value.trim(),
          description:$('#expDesc').value.trim(),
          amount:$('#expAmount').value,
          applicant:state.userInfo?.realName || state.displayName || 'æœ¬äºº',
          applicantLineId:state.userId,
          paymentMethod:$('#expPayMethod').value.trim(),
          recipient:$('#expRecipient').value.trim()
        });
        alert(r.success?'æ–°å¢æˆåŠŸï¼š'+r.expenseId:'å¤±æ•—ï¼š'+r.message);
      }catch(e){ alert('å¤±æ•—ï¼š'+e.message); }
    }
    async function loadMyExpensesHandler(){
      const tb=$('#expenseTbody');
      tb.innerHTML='<tr><td colspan="5">è¼‰å…¥ä¸­...</td></tr>';
      try{
        const status=$('#expStatusFilter').value.trim();
        const r=await callApi('getExpenseList',{ userId:state.userId, status });
        if(!r.expenses||!r.expenses.length){
          tb.innerHTML='<tr><td colspan="5" class="muted">ç„¡è³‡æ–™</td></tr>'; return;
        }
        tb.innerHTML=r.expenses.slice(-100).map(e=>`
          <tr><td>${e.id}</td><td>${e.categoryName||e.category}</td><td>${e.amount}</td><td>${e.description||''}</td><td>${e.status}</td></tr>
        `).join('');
      }catch(e){
        tb.innerHTML='<tr><td colspan="5" class="danger-text">éŒ¯èª¤ï¼š'+e.message+'</td></tr>';
      }
    }

    /***********************
     * PAGE: Admin
     ***********************/
    function pageAdmin(){
      if(!state.isAdmin){
        contentArea.innerHTML='<h2>ç®¡ç†å·¥å…·</h2><p class="danger-text">æ‚¨ä¸æ˜¯ç®¡ç†å“¡ã€‚</p>';
        return;
      }
      contentArea.innerHTML=`
        <h2>ç®¡ç†å·¥å…·</h2>
        <div class="grid cols-2">
          ${wrapCard('æœƒå“¡é¡åˆ¥èª¿æ•´',`
            <div class="inline-form">
              <label class="field">ç›®æ¨™ lineId<input type="text" id="admTargetLineId"></label>
              <label class="field">æ–°é¡åˆ¥<input type="text" id="admNewMemberType" placeholder="vip"></label>
              <label class="field">å‚™è¨»<input type="text" id="admNote"></label>
              <button id="btnUpdateMemberType">æ›´æ–°é¡åˆ¥</button>
            </div>
          `)}
          ${wrapCard('æ”¯å‡ºå¯©æ ¸',`
            <div class="inline-form">
              <label class="field">æ”¯å‡ºç·¨è™Ÿ<input type="text" id="approveExpenseId" placeholder="EXP..."></label>
              <label class="field">æ±ºå®š
                <select id="approveDecision"><option value="agree">åŒæ„</option><option value="reject">æ‹’çµ•</option></select>
              </label>
              <label class="field">å‚™è¨»<input type="text" id="approveNote"></label>
              <button id="btnApproveExpense">é€å‡ºå¯©æ ¸</button>
            </div>
          `)}
        </div>
        <div class="card">
          <h3>å…¨éƒ¨æœƒå“¡æœå°‹</h3>
          <div class="inline-form">
            <label class="field">é ç¢¼<input type="number" id="allUsersPage" value="1"></label>
            <label class="field">æ¯é <input type="number" id="allUsersSize" value="20"></label>
            <label class="field">é—œéµå­—<input type="text" id="allUsersKeyword"></label>
            <label class="field">æœƒå“¡é¡åˆ¥<input type="text" id="allUsersMemberType" placeholder="member"></label>
            <label class="field">ç‹€æ…‹<input type="text" id="allUsersStatus" placeholder="å·²è¨»å†Š"></label>
            <button id="btnGetAllUsers">æœå°‹</button>
          </div>
          <pre id="allUsersResult" style="margin-top:8px;max-height:240px;overflow:auto;font-size:11px;"></pre>
        </div>
        <div class="card">
          <h3>å›é¥‹çµ±è¨ˆ</h3>
          <div class="inline-form">
            <label class="field">æ´»å‹•ç·¨è™Ÿ(å¯ç©º)<input type="text" id="admFeedbackActivityId"></label>
            <label class="field">summaryOnly
              <select id="admFbSummaryOnly"><option value="true" selected>true</option><option value="false">false</option></select>
            </label>
            <label class="field">limit<input type="number" id="admFbLimit" value="50"></label>
            <button id="btnAdminGetFeedback">å–å¾—</button>
          </div>
          <pre id="adminFeedbackBox" style="margin-top:8px;max-height:220px;overflow:auto;font-size:11px;"></pre>
        </div>
      `;
      $('#btnUpdateMemberType').addEventListener('click', async ()=>{
        try{
          const r=await callApi('updateMemberType',{
            operatorLineId:state.userId,
            targetLineId:$('#admTargetLineId').value.trim(),
            newMemberType:$('#admNewMemberType').value.trim(),
            note:$('#admNote').value.trim()
          });
          alert(r.success?'æˆåŠŸ':'å¤±æ•—ï¼š'+r.message);
        }catch(e){ alert('éŒ¯èª¤ï¼š'+e.message); }
      });
      $('#btnApproveExpense').addEventListener('click', async ()=>{
        try{
          const approved=$('#approveDecision').value==='agree';
          const r=await callApi('approveExpense',{
            expenseId:$('#approveExpenseId').value.trim(),
            approverName:state.userInfo?.realName || 'ç®¡ç†å“¡',
            approved,
            note:$('#approveNote').value.trim(),
            operatorLineId:state.userId
          });
          alert(r.success?(approved?'å·²æ ¸å‡†':'å·²æ‹’çµ•'):'å¤±æ•—ï¼š'+r.message);
        }catch(e){ alert('éŒ¯èª¤ï¼š'+e.message); }
      });
      $('#btnGetAllUsers').addEventListener('click', async ()=>{
        try{
          const r=await callApi('getAllUsers',{
            operatorLineId:state.userId,
            page:Number($('#allUsersPage').value||1),
            pageSize:Number($('#allUsersSize').value||20),
            keyword:$('#allUsersKeyword').value.trim(),
            memberType:$('#allUsersMemberType').value.trim(),
            status:$('#allUsersStatus').value.trim()
          });
          $('#allUsersResult').textContent=JSON.stringify(r,null,2);
        }catch(e){ $('#allUsersResult').textContent='éŒ¯èª¤ï¼š'+e.message; }
      });
      $('#btnAdminGetFeedback').addEventListener('click', async ()=>{
        try{
          const r=await callApi('getActivityFeedback',{
            operatorLineId:state.userId,
            activityId:$('#admFeedbackActivityId').value.trim()||undefined,
            summaryOnly:$('#admFbSummaryOnly').value==='true',
            limit:Number($('#admFbLimit').value||50)
          });
          $('#adminFeedbackBox').textContent=JSON.stringify(r,null,2);
        }catch(e){
          $('#adminFeedbackBox').textContent='éŒ¯èª¤ï¼š'+e.message;
        }
      });
    }

    /***********************
     * Router
     ***********************/
    function routeTo(id){
      switch(id){
        case 'dashboard': pageDashboard(); break;
        case 'member': pageMember(); break;
        case 'activities': pageActivities(); break;
        case 'myActivities': pageMyActivities(); break;
        case 'donations': pageDonations(); break;
        case 'feedback': pageFeedback(); break;
        case 'finance': pageFinance(); break;
        case 'expense': pageExpense(); break;
        case 'admin': pageAdmin(); break;
        default: contentArea.innerHTML='<p>æœªçŸ¥é é¢</p>';
      }
    }

    /***********************
     * è³‡æ–™è¼‰å…¥
     ***********************/
    async function refreshUserInfo(){
      try{
        const r=await callApi('getUserInfo',{ userId:state.userId });
        if(r.error){ setStatus('æœªè¨»å†Š'); state.userInfo=null; return; }
        state.userInfo=r;
        state.isAdmin = ADMIN_IDS.includes(state.userId);
      }catch(e){
        setStatus('å–å¾—ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—:'+e.message);
      }
    }
    async function loadActivitiesToCache(force=false){
      if(state.activitiesCache.length && !force) return;
      try{
        const r=await callApi('getActivities',{});
        state.activitiesCache=Array.isArray(r)?r:[];
      }catch(e){
        console.error(e);
      }
    }
    async function loadMyActivitiesCache(){
      // ç›®å‰åƒ…éœ€è¦å³æ™‚æŸ¥è©¢æ™‚å‘¼å«ï¼Œä¸é•·æœŸç·©å­˜
      return;
    }

    /***********************
     * é¡¯ç¤º / å­—ç´š / ä¸»é¡Œ
     ***********************/
    function applyFontSize(mode){
      document.body.classList.remove('font-size-large','font-size-xlarge');
      if(mode==='large') document.body.classList.add('font-size-large');
      else if(mode==='xlarge') document.body.classList.add('font-size-xlarge');
      state.fontSizeMode=mode;
    }
    function applyTheme(th){
      if(th==='contrast'){
        document.body.setAttribute('data-theme','contrast');
      }else{
        document.body.removeAttribute('data-theme');
      }
      state.theme=th;
    }

    $('#btnFontNormal').addEventListener('click',()=>applyFontSize('normal'));
    $('#btnFontLarge').addEventListener('click',()=>applyFontSize('large'));
    $('#btnFontXLarge').addEventListener('click',()=>applyFontSize('xlarge'));
    $('#btnToggleTheme').addEventListener('click',()=>{
      applyTheme(state.theme==='contrast'?'normal':'contrast');
    });
    $('#saveLocalBtn').addEventListener('click', saveLocal);

    /***********************
     * åˆå§‹åŒ–æµç¨‹
     ***********************/
    async function init(){
      loadLocal();
      state.apiKey = $('#apiKeyInput').value.trim();
      await initLIFFIfPossible();
      if(!state.userId){
        setStatus('è«‹å…ˆç™»å…¥æˆ–æ‰‹å‹•è¨­å®š userIdï¼ˆéœ€ä¿®æ”¹å‰ç«¯ç¨‹å¼ï¼‰');
        return;
      }
      try{
        // create or update
        await callApi('createUserIfNotExist',{ userId:state.userId, displayName:state.displayName });
      }catch(e){
        console.warn('createUserIfNotExist å¤±æ•—', e);
      }
      await refreshUserInfo();
      await loadActivitiesToCache(true);
      renderNav();
      setStatus('å°±ç·’ userId='+state.userId);
    }

    async function initLIFFIfPossible(){
      if(!LIFF_ID){
        console.warn('æœªè¨­å®š LIFF_IDï¼Œè·³é LIFF');
        return;
      }
      try{
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()){
          liff.login();
          return;
        }
        const profile=await liff.getProfile();
        state.userId=profile.userId;
        state.displayName=profile.displayName;
      }catch(e){
        console.warn('LIFF å¤±æ•—',e);
      }
    }

    $('#btnInit').addEventListener('click', async ()=>{
      state.apiKey=$('#apiKeyInput').value.trim();
      await init();
      activatePage('dashboard');
    });
    $('#btnReloadProfile').addEventListener('click', async ()=>{
      await refreshUserInfo();
      activatePage('member');
    });
    $('#btnLogout').addEventListener('click', ()=>{
      if(window.liff && liff.isLoggedIn()){
        liff.logout();
        location.reload();
      }
    });

    // è‡ªå‹•åˆå§‹åŒ–ï¼ˆè‹¥å·²å„²å­˜ API_KEYï¼‰
    if(localStorage.getItem('pd_apiKey')){
      state.apiKey=localStorage.getItem('pd_apiKey');
      $('#apiKeyInput').value=state.apiKey;
      init();
    } else {
      setStatus('è«‹è¼¸å…¥ API_KEY å¾Œé»ã€Œåˆå§‹åŒ–ã€');
    }
  </script>
</body>
</html>

å®Œæˆï¼è«‹å°‡ä¸Šè¿°ç¨‹å¼è²¼å…¥ç’°å¢ƒä¸¦å¥—ç”¨å¯¦éš›åƒæ•¸å³å¯æ­£å¼å•Ÿç”¨ã€‚
