<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°ç£å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAD///8A">
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          color: #333;
      }

      .container {
          max-width: 400px;
          margin: 0 auto;
          background: white;
          min-height: 100vh;
          position: relative;
          overflow-x: hidden;
      }

      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          text-align: center;
          position: relative;
      }

      .header h1 {
          font-size: 18px;
          margin-bottom: 5px;
          font-weight: 600;
      }

      .header p {
          font-size: 14px;
          opacity: 0.9;
      }

      .profile-section {
          display: none;
          background: white;
          margin: -15px 20px 0;
          border-radius: 15px;
          padding: 20px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
          position: relative;
          z-index: 10;
      }

      .profile-info {
          display: flex;
          align-items: center;
          margin-bottom: 15px;
      }

      .profile-pic {
          width: 50px;
          height: 50px;
          border-radius: 50%;
          margin-right: 15px;
          border: 3px solid #667eea;
      }

      .profile-details h3 {
          font-size: 16px;
          margin-bottom: 5px;
          color: #333;
      }

      .status-badge {
          display: inline-block;
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
      }

      .status-registered {
          background: #e8f5e8;
          color: #2e7d32;
      }

      .status-unregistered {
          background: #fff3e0;
          color: #f57c00;
      }

      .user-stats {
          display: flex;
          justify-content: space-around;
          margin-top: 15px;
          padding-top: 15px;
          border-top: 1px solid #eee;
      }

      .stat-item {
          text-align: center;
      }

      .stat-number {
          font-size: 20px;
          font-weight: bold;
          color: #667eea;
      }

      .stat-label {
          font-size: 12px;
          color: #666;
          margin-top: 5px;
      }

      .main-menu {
          padding: 20px;
      }

      .menu-section {
          margin-bottom: 25px;
      }

      .menu-section h3 {
          font-size: 16px;
          margin-bottom: 15px;
          color: #333;
          display: flex;
          align-items: center;
      }

      .menu-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
      }

      .menu-item {
          background: white;
          border: 2px solid #f0f0f0;
          border-radius: 12px;
          padding: 20px 15px;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s ease;
          font-size: 14px;
          color: #333;
          text-decoration: none;
          display: flex;
          flex-direction: column;
          align-items: center;
          min-height: 80px;
          justify-content: center;
      }

      .menu-item:hover {
          border-color: #667eea;
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      }

      .menu-icon {
          font-size: 24px;
          margin-bottom: 8px;
      }

      .card {
          background: white;
          margin: 20px;
          border-radius: 15px;
          padding: 20px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      .card h3 {
          margin-bottom: 20px;
          color: #333;
          font-size: 18px;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }

      .form-group input,
      .form-group select {
          width: 100%;
          padding: 12px;
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          font-size: 16px;
          transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus {
          outline: none;
          border-color: #667eea;
      }

      .btn {
          width: 100%;
          padding: 15px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
          transform: none;
      }

      .btn-secondary {
          background: #f5f5f5;
          color: #333;
          margin-top: 10px;
      }

      .btn-secondary:hover {
          background: #e0e0e0;
      }

      .alert {
          padding: 12px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 14px;
      }

      .alert-success {
          background: #e8f5e8;
          color: #2e7d32;
          border: 1px solid #c8e6c9;
      }

      .alert-error {
          background: #ffebee;
          color: #c62828;
          border: 1px solid #ffcdd2;
      }

      .back-btn {
          background: none;
          border: none;
          color: #667eea;
          font-size: 16px;
          padding: 10px 20px;
          cursor: pointer;
          margin-bottom: 10px;
      }

      .hidden {
          display: none !important;
      }

      .loading {
          text-align: center;
          padding: 40px;
          color: #666;
      }

      .activity-item {
          background: #f9f9f9;
          border-radius: 12px;
          padding: 15px;
          margin-bottom: 15px;
          border-left: 4px solid #667eea;
      }

      .activity-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
      }

      .activity-id {
          background: #667eea;
          color: white;
          padding: 4px 8px;
          border-radius: 6px;
          font-size: 12px;
          font-weight: bold;
      }

      .activity-status {
          padding: 4px 8px;
          border-radius: 6px;
          font-size: 12px;
          font-weight: bold;
      }

      .status-open {
          background: #e8f5e8;
          color: #2e7d32;
      }

      .activity-item h4 {
          margin-bottom: 10px;
          color: #333;
      }

      .activity-item p {
          margin-bottom: 5px;
          font-size: 14px;
          color: #666;
      }

      .register-section {
          margin-top: 20px;
      }

      .register-input {
          display: flex;
          gap: 10px;
          margin-bottom: 15px;
      }

      .register-input input {
          flex: 1;
          padding: 12px;
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          font-size: 14px;
      }

      .register-input button {
          padding: 12px 20px;
          background: #667eea;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 600;
      }

      .help-text {
          font-size: 12px;
          color: #666;
          margin-top: 5px;
          line-height: 1.4;
      }

      .bottom-nav {
          position: fixed;
          bottom: 0;
          left: 50%;
          transform: translateX(-50%);
          width: 100%;
          max-width: 400px;
          background: white;
          border-top: 1px solid #e0e0e0;
          display: flex;
          justify-content: space-around;
          padding: 10px 0;
          z-index: 100;
      }

      .nav-item {
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 5px;
          cursor: pointer;
          color: #666;
          font-size: 12px;
          transition: color 0.3s ease;
      }

      .nav-item.active {
          color: #667eea;
      }

      .nav-item:hover {
          color: #667eea;
      }

      .nav-icon {
          font-size: 20px;
          margin-bottom: 4px;
      }

      .content-wrapper {
          padding-bottom: 80px;
      }

      @media (max-width: 375px) {
          .menu-grid {
              grid-template-columns: 1fr;
          }
          
          .menu-item {
              min-height: 60px;
          }
      }

      .volunteer-menu, .member-menu {
          display: none;
      }
  </style>
</head>
<body>
  <div class="container">
      <!-- ä¸»ç•«é¢ -->
      <div id="main-screen">
          <div class="header">
              <h1>å°ç£å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ</h1>
              <p>Parkinson's Disease Association Taiwan</p>
          </div>

          <div class="profile-section">
              <div class="profile-info">
                  <img id="profile-pic" class="profile-pic" src="" alt="Profile">
                  <div class="profile-details">
                      <h3 id="display-name">è¼‰å…¥ä¸­...</h3>
                      <span id="status-badge" class="status-badge">è¼‰å…¥ä¸­...</span>
                  </div>
              </div>
              <div id="user-stats" class="user-stats"></div>
          </div>

          <div class="content-wrapper">
              <div class="main-menu">
                  <!-- åŸºæœ¬åŠŸèƒ½ -->
                  <div class="menu-section">
                      <h3>ğŸ  åŸºæœ¬åŠŸèƒ½</h3>
                      <div class="menu-grid">
                          <button class="menu-item" onclick="showRegistration()">
                              <div class="menu-icon">ğŸ“</div>
                              <div>å¯¦åç™»è¨˜</div>
                          </button>
                          <button class="menu-item" onclick="showActivities()">
                              <div class="menu-icon">ğŸ“…</div>
                              <div>æ´»å‹•å ±å</div>
                          </button>
                          <button class="menu-item" onclick="showProfile()">
                              <div class="menu-icon">ğŸ‘¤</div>
                              <div>å€‹äººè³‡æ–™</div>
                          </button>
                          <button class="menu-item" onclick="showHelp()">
                              <div class="menu-icon">â“</div>
                              <div>ä½¿ç”¨èªªæ˜</div>
                          </button>
                      </div>
                  </div>

                  <!-- å¿—å·¥åŠŸèƒ½ -->
                  <div id="volunteer-menu" class="menu-section volunteer-menu">
                      <h3>ğŸ™‹â€â™€ï¸ å¿—å·¥å¹³å°</h3>
                      <div class="menu-grid">
                          <button class="menu-item" onclick="showVolunteerTasks()">
                              <div class="menu-icon">ğŸ“‹</div>
                              <div>å¿—å·¥ä»»å‹™</div>
                          </button>
                          <button class="menu-item" onclick="showVolunteerSchedule()">
                              <div class="menu-icon">ğŸ“†</div>
                              <div>æ’ç­è¡¨</div>
                          </button>
                          <button class="menu-item" onclick="showVolunteerHours()">
                              <div class="menu-icon">â°</div>
                              <div>æœå‹™æ™‚æ•¸</div>
                          </button>
                          <button class="menu-item" onclick="showVolunteerTraining()">
                              <div class="menu-icon">ğŸ“</div>
                              <div>åŸ¹è¨“èª²ç¨‹</div>
                          </button>
                      </div>
                  </div>

                  <!-- æœƒå“¡å°ˆå€ -->
                  <div id="member-menu" class="menu-section member-menu">
                      <h3>ğŸ‘‘ æœƒå“¡å°ˆå€</h3>
                      <div class="menu-grid">
                          <button class="menu-item" onclick="showDonationRecord()">
                              <div class="menu-icon">ğŸ’°</div>
                              <div>ææ¬¾è¨˜éŒ„</div>
                          </button>
                          <button class="menu-item" onclick="showMyActivities()">
                              <div class="menu-icon">ğŸ“</div>
                              <div>æˆ‘çš„æ´»å‹•</div>
                          </button>
                          <button class="menu-item" onclick="showPersonalStats()">
                              <div class="menu-icon">ğŸ“Š</div>
                              <div>å€‹äººçµ±è¨ˆ</div>
                          </button>
                          <button class="menu-item" onclick="updatePersonalInfo()">
                              <div class="menu-icon">âš™ï¸</div>
                              <div>è³‡æ–™ç¶­è­·</div>
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- å¯¦åç™»è¨˜ç•«é¢ -->
      <div id="registration-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">â† è¿”å›ä¸»é¸å–®</button>
          <div class="card">
              <h3>ğŸ“ å¯¦ååˆ¶ç™»è¨˜</h3>
              <div id="registration-alert"></div>
              <form id="registration-form">
                  <div class="form-group">
                      <label for="real-name">çœŸå¯¦å§“å *</label>
                      <input type="text" id="real-name" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å" required>
                      <div class="help-text">è«‹è¼¸å…¥2-10å€‹ä¸­æ–‡æˆ–è‹±æ–‡å­—å…ƒ</div>
                  </div>
                  <div class="form-group">
                      <label for="member-type">æˆå“¡é¡åˆ¥ *</label>
                      <select id="member-type" required>
                          <option value="">è«‹é¸æ“‡æˆå“¡é¡åˆ¥</option>
                          <option value="member">ä¸€èˆ¬æˆå“¡</option>
                          <option value="volunteer">å¿—å·¥</option>
                          <option value="vip">æœƒå“¡</option>
                      </select>
                  </div>
                  <button type="submit" id="register-btn" class="btn">å®Œæˆç™»è¨˜</button>
              </form>
          </div>
      </div>

      <!-- æ´»å‹•å ±åç•«é¢ -->
      <div id="activities-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">â† è¿”å›ä¸»é¸å–®</button>
          <div class="card">
              <h3>ğŸ“… æ´»å‹•å ±å</h3>
              
              <!-- å¿«é€Ÿå ±å -->
              <div class="register-section">
                  <h4>âš¡ å¿«é€Ÿå ±åï¼ˆæœ¬äººï¼‰</h4>
                  <div id="quick-register-alert"></div>
                  <div class="register-input">
                      <input type="text" id="quick-register" placeholder="æ´»å‹•ç·¨è™Ÿ+1 (ä¾‹: 123+1)">
                      <button onclick="quickRegister()">å ±å</button>
                  </div>
                  <div class="help-text">æ ¼å¼ï¼šæ´»å‹•ç·¨è™Ÿ+1ï¼Œåƒ…é™æœ¬äººå ±å</div>
              </div>

              <!-- ä¸€èˆ¬/åœ˜é«”å ±å -->
              <div class="register-section">
                  <h4>ğŸ‘¥ ä¸€èˆ¬/åœ˜é«”å ±å</h4>
                  <div id="normal-register-alert"></div>
                  <div class="register-input">
                      <input type="text" id="normal-register" placeholder="æ´»å‹•ç·¨è™Ÿ+å§“å (ä¾‹: 123+ç‹å°æ˜+æå°è¯)">
                      <button onclick="normalRegister()">å ±å</button>
                  </div>
                  <div class="help-text">æ ¼å¼ï¼šæ´»å‹•ç·¨è™Ÿ+å§“å1+å§“å2...ï¼Œå¯å ±åå¤šäºº</div>
              </div>

              <!-- æ´»å‹•åˆ—è¡¨ -->
              <h4>ğŸ“‹ é–‹æ”¾å ±åæ´»å‹•</h4>
              <div id="activities-loading" class="loading">è¼‰å…¥æ´»å‹•è³‡è¨Šä¸­...</div>
              <div id="activities-list" class="hidden"></div>
          </div>
      </div>

      <!-- å€‹äººè³‡æ–™ç•«é¢ -->
      <div id="profile-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">â† è¿”å›ä¸»é¸å–®</button>
          <div class="card">
              <h3>ğŸ‘¤ å€‹äººè³‡æ–™</h3>
              <div id="profile-details"></div>
          </div>
      </div>

      <!-- å¿—å·¥å¹³å°ç•«é¢ -->
      <div id="volunteer-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">â† è¿”å›ä¸»é¸å–®</button>
          <div class="card">
              <h3>ğŸ™‹â€â™€ï¸ å¿—å·¥å¹³å°</h3>
              <div class="menu-grid">
                  <button class="menu-item" onclick="showVolunteerTasks()">
                      <div class="menu-icon">ğŸ“‹</div>
                      <div>å¿—å·¥ä»»å‹™</div>
                  </button>
                  <button class="menu-item" onclick="showVolunteerSchedule()">
                      <div class="menu-icon">ğŸ“†</div>
                      <div>æ’ç­è¡¨</div>
                  </button>
                  <button class="menu-item" onclick="showVolunteerHours()">
                      <div class="menu-icon">â°</div>
                      <div>æœå‹™æ™‚æ•¸</div>
                  </button>
                  <button class="menu-item" onclick="showVolunteerTraining()">
                      <div class="menu-icon">ğŸ“</div>
                      <div>åŸ¹è¨“èª²ç¨‹</div>
                  </button>
              </div>
          </div>
      </div>

      <!-- æœƒå“¡å°ˆå€ç•«é¢ -->
      <div id="member-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">â† è¿”å›ä¸»é¸å–®</button>
          <div class="card">
              <h3>ğŸ‘‘ æœƒå“¡å°ˆå€</h3>
              <div class="menu-grid">
                  <button class="menu-item" onclick="showDonationRecord()">
                      <div class="menu-icon">ğŸ’°</div>
                      <div>ææ¬¾è¨˜éŒ„</div>
                  </button>
                  <button class="menu-item" onclick="showMyActivities()">
                      <div class="menu-icon">ğŸ“</div>
                      <div>æˆ‘çš„æ´»å‹•</div>
                  </button>
                  <button class="menu-item" onclick="showPersonalStats()">
                      <div class="menu-icon">ğŸ“Š</div>
                      <div>å€‹äººçµ±è¨ˆ</div>
                  </button>
                  <button class="menu-item" onclick="updatePersonalInfo()">
                      <div class="menu-icon">âš™ï¸</div>
                      <div>è³‡æ–™ç¶­è­·</div>
                  </button>
              </div>
          </div>
      </div>

      <!-- ææ¬¾è¨˜éŒ„ç•«é¢ -->
      <div id="donation-screen" class="hidden">
          <button class="back-btn" onclick="showMemberArea()">â† è¿”å›æœƒå“¡å°ˆå€</button>
          <div class="card">
              <h3>ğŸ’° ææ¬¾è¨˜éŒ„</h3>
              <div id="donation-loading" class="loading">è¼‰å…¥ææ¬¾è¨˜éŒ„ä¸­...</div>
              <div id="donation-list" class="hidden"></div>
          </div>
      </div>

      <!-- æˆ‘çš„æ´»å‹•ç•«é¢ -->
      <div id="my-activities-screen" class="hidden">
          <button class="back-btn" onclick="showMemberArea()">â† è¿”å›æœƒå“¡å°ˆå€</button>
          <div class="card">
              <h3>ğŸ“ æˆ‘çš„æ´»å‹•</h3>
              <div id="my-activities-loading" class="loading">è¼‰å…¥æ´»å‹•è¨˜éŒ„ä¸­...</div>
              <div id="my-activities-list" class="hidden"></div>
          </div>
      </div>

      <!-- åº•éƒ¨å°èˆª -->
      <div class="bottom-nav">
          <div class="nav-item active" onclick="showMain()">
              <div class="nav-icon">ğŸ </div>
              <div>ä¸»é </div>
          </div>
          <div class="nav-item" onclick="showActivities()">
              <div class="nav-icon">ğŸ“…</div>
              <div>æ´»å‹•</div>
          </div>
          <div class="nav-item" onclick="showProfile()">
              <div class="nav-icon">ğŸ‘¤</div>
              <div>å€‹äºº</div>
          </div>
          <div class="nav-item" onclick="showHelp()">
              <div class="nav-icon">â“</div>
              <div>èªªæ˜</div>
          </div>
      </div>
  </div>

  <script>
      // è¨­å®šåƒæ•¸ - è«‹æ›¿æ›ç‚ºå¯¦éš›å€¼
      const LIFF_ID = '1656516134-VaGgmaPm';
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbypkqokP2yH1yJM3SEK_qKN9uXn7kDeSdn0TTLd8iatSwbTp3d93l6NJmy0KA1FROyUVg/exec';
      
      let userProfile = null;
      let userData = null;

      // ä¿®æ­£çš„ fetch å‡½æ•¸ï¼Œè™•ç† CORS å’ŒéŒ¯èª¤
      async function fetchWithErrorHandling(url, options = {}) {
          try {
              const defaultOptions = {
                  mode: 'cors',
                  cache: 'no-cache',
                  headers: {
                      'Content-Type': 'application/json',
                  },
              };

              const finalOptions = { ...defaultOptions, ...options };
              
              console.log('Fetching:', url, finalOptions);
              const response = await fetch(url, finalOptions);
              
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              const text = await response.text();
              console.log('Response text:', text);
              
              if (!text) {
                  throw new Error('Empty response');
              }
              
              try {
                  return JSON.parse(text);
              } catch (parseError) {
                  console.error('JSON parse error:', parseError);
                  console.error('Response text:', text);
                  throw new Error('Invalid JSON response');
              }
              
          } catch (error) {
              console.error('Fetch error:', error);
              throw error;
          }
      }

      // åˆå§‹åŒ–LIFF
      async function initializeLiff() {
          try {
              console.log('é–‹å§‹åˆå§‹åŒ– LIFF...');
              await liff.init({ liffId: LIFF_ID });
              console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');
              
              if (liff.isLoggedIn()) {
                  console.log('ä½¿ç”¨è€…å·²ç™»å…¥');
                  userProfile = await liff.getProfile();
                  console.log('å–å¾—ä½¿ç”¨è€…è³‡æ–™:', userProfile);
                  
                  await loadUserData();
                  updateUI();
              } else {
                  console.log('ä½¿ç”¨è€…æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                  liff.login();
              }
          } catch (error) {
              console.error('LIFFåˆå§‹åŒ–å¤±æ•—:', error);
              showAlert('registration-alert', 'error', `ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š${error.message}`);
          }
      }

      // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
      async function loadUserData() {
          try {
              if (!userProfile || !userProfile.userId) {
                  throw new Error('No user profile available');
              }

              const url = `${GAS_URL}?action=getUserInfo&userId=${encodeURIComponent(userProfile.userId)}`;
              const result = await fetchWithErrorHandling(url, { method: 'GET' });
              
              if (result.error) {
                  console.warn('User not found in database:', result.error);
                  userData = null;
              } else {
                  userData = result;
              }
          } catch (error) {
              console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:', error);
              userData = null;
          }
      }

      // æ›´æ–°UI
      function updateUI() {
          if (userProfile) {
              document.getElementById('profile-pic').src = userProfile.pictureUrl;
              document.getElementById('display-name').textContent = userProfile.displayName;
              
              const statusBadge = document.getElementById('status-badge');
              const userStatsDiv = document.getElementById('user-stats');
              
              if (userData && userData.status === 'å·²è¨»å†Š') {
                  statusBadge.textContent = getTypeName(userData.memberType);
                  statusBadge.className = 'status-badge status-registered';
                  
                  // é¡¯ç¤ºä½¿ç”¨è€…çµ±è¨ˆ
                  const joinDays = Math.floor((new Date() - new Date(userData.firstTime)) / (1000 * 60 * 60 * 24));
                  userStatsDiv.innerHTML = `
                      <div class="stat-item">
                          <div class="stat-number">${userData.messageCount || 0}</div>
                          <div class="stat-label">ç™¼è¨€æ¬¡æ•¸</div>
                      </div>
                      <div class="stat-item">
                          <div class="stat-number">${joinDays}</div>
                          <div class="stat-label">åŠ å…¥å¤©æ•¸</div>
                      </div>
                  `;
                  
                  // é¡¯ç¤ºå°æ‡‰çš„åŠŸèƒ½é¸å–®
                  if (userData.memberType === 'volunteer') {
                      document.getElementById('volunteer-menu').style.display = 'block';
                  } else if (userData.memberType === 'vip') {
                      document.getElementById('member-menu').style.display = 'block';
                  }
              } else {
                  statusBadge.textContent = 'æœªå®Œæˆç™»è¨˜';
                  statusBadge.className = 'status-badge status-unregistered';
                  userStatsDiv.innerHTML = '<p style="text-align: center; color: #666;">è«‹å…ˆå®Œæˆå¯¦ååˆ¶ç™»è¨˜</p>';
              }
              
              document.querySelector('.profile-section').style.display = 'block';
          }
      }

      // é¡¯ç¤ºè­¦å‘Šè¨Šæ¯
      function showAlert(containerId, type, message) {
          const container = document.getElementById(containerId);
          container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
          setTimeout(() => {
              container.innerHTML = '';
          }, 5000);
      }

      // ç•«é¢åˆ‡æ›å‡½æ•¸
      function showMain() {
          hideAllScreens();
          document.getElementById('main-screen').classList.remove('hidden');
          updateNavigation('main');
      }

      function showRegistration() {
          hideAllScreens();
          document.getElementById('registration-screen').classList.remove('hidden');
          updateNavigation('registration');
      }

      function showActivities() {
          hideAllScreens();
          document.getElementById('activities-screen').classList.remove('hidden');
          updateNavigation('activities');
          loadActivities();
      }

      function showProfile() {
          hideAllScreens();
          document.getElementById('profile-screen').classList.remove('hidden');
          updateNavigation('profile');
          loadProfileDetails();
      }

      function showMemberArea() {
          hideAllScreens();
          document.getElementById('member-screen').classList.remove('hidden');
          updateNavigation('member');
      }

      function showVolunteerArea() {
          hideAllScreens();
          document.getElementById('volunteer-screen').classList.remove('hidden');
          updateNavigation('volunteer');
      }

      function showDonationRecord() {
          hideAllScreens();
          document.getElementById('donation-screen').classList.remove('hidden');
          loadDonationRecord();
      }

      function showMyActivities() {
          hideAllScreens();
          document.getElementById('my-activities-screen').classList.remove('hidden');
          loadMyActivities();
      }

      function showHelp() {
          liff.openWindow({
              url: 'https://lch2988.github.io/PDA/help.html',
              external: true
          });
      }

      function hideAllScreens() {
          const screens = ['main-screen', 'registration-screen', 'activities-screen', 'profile-screen', 'member-screen', 'volunteer-screen', 'donation-screen', 'my-activities-screen'];
          screens.forEach(screen => {
              document.getElementById(screen).classList.add('hidden');
          });
      }

      function updateNavigation(active) {
          const navItems = document.querySelectorAll('.nav-item');
          navItems.forEach(item => item.classList.remove('active'));
          
          switch(active) {
              case 'main':
                  navItems[0].classList.add('active');
                  break;
              case 'activities':
                  navItems[1].classList.add('active');
                  break;
              case 'profile':
                  navItems[2].classList.add('active');
                  break;
              case 'help':
                  navItems[3].classList.add('active');
                  break;
          }
      }

      // å¯¦ååˆ¶ç™»è¨˜è™•ç†
      document.getElementById('registration-form').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const realName = document.getElementById('real-name').value.trim();
          const memberType = document.getElementById('member-type').value;
          const registerBtn = document.getElementById('register-btn');
          
          if (!realName || !memberType) {
              showAlert('registration-alert', 'error', 'è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
              return;
          }

          // é©—è­‰å§“åæ ¼å¼
          if (!/^[\u4e00-\u9fa5a-zA-Z\s]{2,10}$/.test(realName)) {
              showAlert('registration-alert', 'error', 'å§“åæ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥2-10å€‹ä¸­æ–‡æˆ–è‹±æ–‡å­—å…ƒ');
              return;
          }
          
          if (!userProfile || !userProfile.userId) {
              showAlert('registration-alert', 'error', 'ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Šï¼Œè«‹é‡æ–°æ•´ç†é é¢');
              return;
          }
          
          registerBtn.disabled = true;
          registerBtn.textContent = 'ç™»è¨˜ä¸­...';
          
          try {
              const requestData = {
                  action: 'register',
                  userId: userProfile.userId,
                  realName: realName,
                  memberType: memberType
              };

              const result = await fetchWithErrorHandling(GAS_URL, {
                  method: 'POST',
                  body: JSON.stringify(requestData)
              });
              
              if (result.success) {
                  showAlert('registration-alert', 'success', result.message || 'è¨»å†ŠæˆåŠŸï¼');
                  await loadUserData();
                  updateUI();
                  setTimeout(() => showMain(), 2000);
              } else {
                  showAlert('registration-alert', 'error', result.message || 'è¨»å†Šå¤±æ•—');
              }
          } catch (error) {
              console.error('è¨»å†Šå¤±æ•—:', error);
              showAlert('registration-alert', 'error', 'è¨»å†Šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦');
          } finally {
              registerBtn.disabled = false;
              registerBtn.textContent = 'å®Œæˆç™»è¨˜';
          }
      });

      // è¼‰å…¥æ´»å‹•è³‡è¨Š
      async function loadActivities() {
          try {
              const url = `${GAS_URL}?action=getActivities`;
              const result = await fetchWithErrorHandling(url, { method: 'GET' });
              
              if (result.error) {
                  throw new Error(result.error);
              }
              
              const activities = Array.isArray(result) ? result : [];
              
              document.getElementById('activities-loading').classList.add('hidden');
              const activitiesList = document.getElementById('activities-list');
              activitiesList.classList.remove('hidden');
              
              if (activities.length === 0) {
                  activitiesList.innerHTML = '<p style="text-align: center; color: #666;">ç›®å‰æ²’æœ‰é–‹æ”¾å ±åçš„æ´»å‹•</p>';
                  return;
              }
              
              let html = '';
              activities.forEach(activity => {
                  html += `
                      <div class="activity-item">
                          <div class="activity-header">
                              <span class="activity-id">${activity.id}</span>
                              <span class="activity-status status-open">${activity.status}</span>
                          </div>
                          <h4>${activity.name}</h4>
                          <p>ğŸ“ åœ°é»ï¼š${activity.location}</p>
                          <p>ğŸ“… æ—¥æœŸï¼š${formatDate(activity.date)}</p>
                          <p>â° å ±åæˆªæ­¢ï¼š${formatDate(activity.deadline)}</p>
                          ${activity.maxParticipants ? `<p>ğŸ‘¥ äººæ•¸é™åˆ¶ï¼š${activity.currentParticipants || 0}/${activity.maxParticipants}</p>` : ''}
                      </div>
                  `;
              });
              
              activitiesList.innerHTML = html;
          } catch (error) {
              console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', error);
              document.getElementById('activities-loading').textContent = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†';
          }
      }

      // å¿«é€Ÿå ±å
      async function quickRegister() {
          const input = document.getElementById('quick-register').value.trim();
          
          if (!input.match(/^\d+\+1$/)) {
              showAlert('quick-register-alert', 'error', 'æ ¼å¼éŒ¯èª¤ï¼è«‹è¼¸å…¥ï¼šæ´»å‹•ç·¨è™Ÿ+1');
              return;
          }
          
          if (!userData || userData.status !== 'å·²è¨»å†Š') {
              showAlert('quick-register-alert', 'error', 'è«‹å…ˆå®Œæˆå¯¦ååˆ¶ç™»è¨˜ï¼');
              return;
          }
          
          try {
              const requestData = {
                  action: 'quickRegister',
                  userId: userProfile.userId,
                  input: input
              };

              const result = await fetchWithErrorHandling(GAS_URL, {
                  method: 'POST',
                  body: JSON.stringify(requestData)
              });
              
              if (result.success) {
                  showAlert('quick-register-alert', 'success', result.message || 'å ±åæˆåŠŸï¼');
                  document.getElementById('quick-register').value = '';
                  loadActivities();
              } else {
                  showAlert('quick-register-alert', 'error', result.message || 'å ±åå¤±æ•—');
              }
          } catch (error) {
              console.error('å ±åå¤±æ•—:', error);
              showAlert('quick-register-alert', 'error', 'å ±åå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
      }

      // ä¸€èˆ¬/åœ˜é«”å ±å
      async function normalRegister() {
          const input = document.getElementById('normal-register').value.trim();
          
          if (!input.match(/^\d+\+.+/)) {
              showAlert('normal-register-alert', 'error', 'æ ¼å¼éŒ¯èª¤ï¼è«‹è¼¸å…¥ï¼šæ´»å‹•ç·¨è™Ÿ+å§“å');
              return;
          }
          
          try {
              const requestData = {
                  action: 'normalRegister',
                  userId: userProfile.userId,
                  input: input
              };

              const result = await fetchWithErrorHandling(GAS_URL, {
                  method: 'POST',
                  body: JSON.stringify(requestData)
              });
              
              if (result.success) {
                  const names = result.names ? result.names.join('ã€') : 'å ±åè€…';
                  showAlert('normal-register-alert', 'success', `å ±åæˆåŠŸï¼åƒåŠ è€…ï¼š${names}`);
                  document.getElementById('normal-register').value = '';
                  loadActivities();
              } else {
                  showAlert('normal-register-alert', 'error', result.message || 'å ±åå¤±æ•—');
              }
          } catch (error) {
              console.error('å ±åå¤±æ•—:', error);
              showAlert('normal-register-alert', 'error', 'å ±åå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
      }

      // è¼‰å…¥å€‹äººè³‡æ–™è©³æƒ…
      function loadProfileDetails() {
          const profileDetails = document.getElementById('profile-details');
          
          if (!userProfile) {
              profileDetails.innerHTML = '<p>ç„¡æ³•è¼‰å…¥å€‹äººè³‡æ–™</p>';
              return;
          }
          
          let html = `
              <div style="text-align: center; margin-bottom: 20px;">
                  <img src="${userProfile.pictureUrl}" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #667eea;">
                  <h3 style="margin: 10px 0;">${userProfile.displayName}</h3>
              </div>
              
              <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                  <h4>ğŸ“± LINE è³‡è¨Š</h4>
                  <p><strong>ä½¿ç”¨è€…IDï¼š</strong>${userProfile.userId}</p>
                  <p><strong>é¡¯ç¤ºåç¨±ï¼š</strong>${userProfile.displayName}</p>
                  <p><strong>ç‹€æ…‹è¨Šæ¯ï¼š</strong>${userProfile.statusMessage || 'ç„¡'}</p>
              </div>
          `;
          
          if (userData) {
              html += `
                  <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                      <h4>ğŸ‘¤ æœƒå“¡è³‡è¨Š</h4>
                      <p><strong>çœŸå¯¦å§“åï¼š</strong>${userData.realName || 'æœªè¨­å®š'}</p>
                      <p><strong>æˆå“¡é¡åˆ¥ï¼š</strong>${getTypeName(userData.memberType)}</p>
                      <p><strong>è¨»å†Šç‹€æ…‹ï¼š</strong>${userData.status}</p>
                      <p><strong>è¨»å†Šæ™‚é–“ï¼š</strong>${userData.registrationTime ? formatDate(userData.registrationTime) : 'æœªè¨»å†Š'}</p>
                  </div>
                  
                  <div style="background: #f9f9f9; padding: 15px; border-radius: 10px;">
                      <h4>ğŸ“Š ä½¿ç”¨çµ±è¨ˆ</h4>
                      <p><strong>ç™¼è¨€æ¬¡æ•¸ï¼š</strong>${userData.messageCount || 0}</p>
                      <p><strong>é¦–æ¬¡ä½¿ç”¨ï¼š</strong>${formatDate(userData.firstTime)}</p>
                      <p><strong>æœ€å¾Œä½¿ç”¨ï¼š</strong>${formatDate(userData.lastTime)}</p>
                  </div>
              `;
          }
          
          profileDetails.innerHTML = html;
      }

      // è¼‰å…¥ææ¬¾è¨˜éŒ„
      async function loadDonationRecord() {
          try {
              if (!userData || userData.status !== 'å·²è¨»å†Š') {
                  document.getElementById('donation-loading').textContent = 'è«‹å…ˆå®Œæˆå¯¦ååˆ¶ç™»è¨˜';
                  return;
              }

              const url = `${GAS_URL}?action=getUserDonations&userId=${encodeURIComponent(userProfile.userId)}`;
              const result = await fetchWithErrorHandling(url, { method: 'GET' });
              
              document.getElementById('donation-loading').classList.add('hidden');
              const donationList = document.getElementById('donation-list');
              donationList.classList.remove('hidden');
              
              if (result.error || !result.length) {
                  donationList.innerHTML = '<p style="text-align: center; color: #666;">æš«ç„¡ææ¬¾è¨˜éŒ„</p>';
                  return;
              }
              
              let html = '';
              let totalAmount = 0;
              
              result.forEach(donation => {
                  totalAmount += donation.amount;
                  html += `
                      <div class="activity-item">
                          <div class="activity-header">
                              <span class="activity-id">${donation.id}</span>
                              <span class="activity-status status-open">NT$ ${donation.amount.toLocaleString()}</span>
                          </div>
                          <h4>${donation.purpose}</h4>
                          <p>ğŸ“… æ—¥æœŸï¼š${formatDate(donation.date)}</p>
                          <p>ğŸ’³ æ–¹å¼ï¼š${donation.method}</p>
                          ${donation.note ? `<p>ğŸ“ å‚™è¨»ï¼š${donation.note}</p>` : ''}
                      </div>
                  `;
              });
              
              html = `
                  <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                      <h3 style="color: #2e7d32; margin: 0;">ç´¯è¨ˆææ¬¾é‡‘é¡</h3>
                      <div style="font-size: 24px; font-weight: bold; color: #2e7d32; margin-top: 5px;">
                          NT$ ${totalAmount.toLocaleString()}
                      </div>
                  </div>
                  ${html}
              `;
              
              donationList.innerHTML = html;
          } catch (error) {
              console.error('è¼‰å…¥ææ¬¾è¨˜éŒ„å¤±æ•—:', error);
              document.getElementById('donation-loading').textContent = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†';
          }
      }

      // è¼‰å…¥æˆ‘çš„æ´»å‹•
      async function loadMyActivities() {
          try {
              if (!userData || userData.status !== 'å·²è¨»å†Š') {
                  document.getElementById('my-activities-loading').textContent = 'è«‹å…ˆå®Œæˆå¯¦ååˆ¶ç™»è¨˜';
                  return;
              }

              const url = `${GAS_URL}?action=getUserActivities&userId=${encodeURIComponent(userProfile.userId)}`;
              const result = await fetchWithErrorHandling(url, { method: 'GET' });
              
              document.getElementById('my-activities-loading').classList.add('hidden');
              const activitiesList = document.getElementById('my-activities-list');
              activitiesList.classList.remove('hidden');
              
              if (result.error || !result.length) {
                  activitiesList.innerHTML = '<p style="text-align: center; color: #666;">æš«ç„¡æ´»å‹•è¨˜éŒ„</p>';
                  return;
              }
              
              let html = '';
              result.forEach(activity => {
                  html += `
                      <div class="activity-item">
                          <div class="activity-header">
                              <span class="activity-id">${activity.activityId}</span>
                              <span class="activity-status ${getStatusClass(activity.status)}">${activity.status}</span>
                          </div>
                          <h4>${activity.activityName}</h4>
                          <p>ğŸ“… æ´»å‹•æ—¥æœŸï¼š${formatDate(activity.activityDate)}</p>
                          <p>ğŸ“ å ±åæ™‚é–“ï¼š${formatDate(activity.registrationTime)}</p>
                          <p>ğŸ‘¤ åƒåŠ è€…ï¼š${activity.participantName}</p>
                          ${activity.note ? `<p>ğŸ“ å‚™è¨»ï¼š${activity.note}</p>` : ''}
                      </div>
                  `;
              });
              
              activitiesList.innerHTML = html;
          } catch (error) {
              console.error('è¼‰å…¥æ´»å‹•è¨˜éŒ„å¤±æ•—:', error);
              document.getElementById('my-activities-loading').textContent = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†';
          }
      }

      // å¿—å·¥åŠŸèƒ½ï¼ˆä½”ä½ç¬¦ï¼‰
      function showVolunteerTasks() {
          alert('å¿—å·¥ä»»å‹™åŠŸèƒ½é–‹ç™¼ä¸­...');
      }

      function showVolunteerSchedule() {
          alert('æ’ç­è¡¨åŠŸèƒ½é–‹ç™¼ä¸­...');
      }

      function showVolunteerHours() {
          alert('æœå‹™æ™‚æ•¸åŠŸèƒ½é–‹ç™¼ä¸­...');
      }

      function showVolunteerTraining() {
          alert('åŸ¹è¨“èª²ç¨‹åŠŸèƒ½é–‹ç™¼ä¸­...');
      }

      function showPersonalStats() {
          alert('å€‹äººçµ±è¨ˆåŠŸèƒ½é–‹ç™¼ä¸­...');
      }

      function updatePersonalInfo() {
          alert('è³‡æ–™ç¶­è­·åŠŸèƒ½é–‹ç™¼ä¸­...');
      }

      // å·¥å…·å‡½æ•¸
      function formatDate(dateString) {
          if (!dateString) return 'æœªè¨­å®š';
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
          });
      }

      function getTypeName(type) {
          const types = {
              'member': 'ä¸€èˆ¬æˆå“¡',
              'volunteer': 'å¿—å·¥',
              'vip': 'æœƒå“¡'
          };
          return types[type] || type;
      }

      function getStatusClass(status) {
          switch(status) {
              case 'å·²å ±å': return 'status-open';
              case 'å·²åƒåŠ ': return 'status-registered';
              case 'å·²å–æ¶ˆ': return 'status-cancelled';
              default: return 'status-open';
          }
      }

      // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
      window.addEventListener('load', function() {
          console.log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
          initializeLiff();
      });

      // è™•ç†è¿”å›æŒ‰éˆ•
      window.addEventListener('beforeunload', function() {
          if (liff.isInClient()) {
              liff.closeWindow();
          }
      });
  </script>
</body>
</html>
