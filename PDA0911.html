<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAD///8A">
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          color: #333;
      }

      .container {
          max-width: 400px;
          margin: 0 auto;
          background: white;
          min-height: 100vh;
          position: relative;
          overflow-x: hidden;
      }

      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          text-align: center;
          position: relative;
      }

      .header h1 {
          font-size: 18px;
          margin-bottom: 5px;
          font-weight: 600;
      }

      .header p {
          font-size: 14px;
          opacity: 0.9;
      }

      .profile-section {
          display: none;
          background: white;
          margin: -15px 20px 0;
          border-radius: 15px;
          padding: 20px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
          position: relative;
          z-index: 10;
      }

      .profile-info {
          display: flex;
          align-items: center;
          margin-bottom: 15px;
      }

      .profile-pic {
          width: 50px;
          height: 50px;
          border-radius: 50%;
          margin-right: 15px;
          border: 3px solid #667eea;
      }

      .profile-details h3 {
          font-size: 16px;
          margin-bottom: 5px;
          color: #333;
      }

      .status-badge {
          display: inline-block;
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
      }

      .status-registered {
          background: #e8f5e8;
          color: #2e7d32;
      }

      .status-unregistered {
          background: #fff3e0;
          color: #f57c00;
      }

      .user-stats {
          display: flex;
          justify-content: space-around;
          margin-top: 15px;
          padding-top: 15px;
          border-top: 1px solid #eee;
      }

      .stat-item {
          text-align: center;
      }

      .stat-number {
          font-size: 20px;
          font-weight: bold;
          color: #667eea;
      }

      .stat-label {
          font-size: 12px;
          color: #666;
          margin-top: 5px;
      }

      .main-menu {
          padding: 20px;
      }

      .menu-section {
          margin-bottom: 25px;
      }

      .menu-section h3 {
          font-size: 16px;
          margin-bottom: 15px;
          color: #333;
          display: flex;
          align-items: center;
      }

      .menu-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
      }

      .menu-item {
          background: white;
          border: 2px solid #f0f0f0;
          border-radius: 12px;
          padding: 20px 15px;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s ease;
          font-size: 14px;
          color: #333;
          text-decoration: none;
          display: flex;
          flex-direction: column;
          align-items: center;
          min-height: 80px;
          justify-content: center;
      }

      .menu-item:hover {
          border-color: #667eea;
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      }

      .menu-icon {
          font-size: 24px;
          margin-bottom: 8px;
      }

      .card {
          background: white;
          margin: 20px;
          border-radius: 15px;
          padding: 20px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      .card h3 {
          margin-bottom: 20px;
          color: #333;
          font-size: 18px;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }

      .form-group input,
      .form-group select {
          width: 100%;
          padding: 12px;
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          font-size: 16px;
          transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus {
          outline: none;
          border-color: #667eea;
      }

      .btn {
          width: 100%;
          padding: 15px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
          transform: none;
      }

      .btn-secondary {
          background: #f5f5f5;
          color: #333;
          margin-top: 10px;
      }

      .btn-secondary:hover {
          background: #e0e0e0;
      }

      .alert {
          padding: 12px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 14px;
      }

      .alert-success {
          background: #e8f5e8;
          color: #2e7d32;
          border: 1px solid #c8e6c9;
      }

      .alert-error {
          background: #ffebee;
          color: #c62828;
          border: 1px solid #ffcdd2;
      }

      .back-btn {
          background: none;
          border: none;
          color: #667eea;
          font-size: 16px;
          padding: 10px 20px;
          cursor: pointer;
          margin-bottom: 10px;
      }

      .hidden {
          display: none !important;
      }

      .loading {
          text-align: center;
          padding: 40px;
          color: #666;
      }

      .activity-item {
          background: #f9f9f9;
          border-radius: 12px;
          padding: 15px;
          margin-bottom: 15px;
          border-left: 4px solid #667eea;
      }

      .activity-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
      }

      .activity-id {
          background: #667eea;
          color: white;
          padding: 4px 8px;
          border-radius: 6px;
          font-size: 12px;
          font-weight: bold;
      }

      .activity-status {
          padding: 4px 8px;
          border-radius: 6px;
          font-size: 12px;
          font-weight: bold;
      }

      .status-open {
          background: #e8f5e8;
          color: #2e7d32;
      }

      .activity-item h4 {
          margin-bottom: 10px;
          color: #333;
      }

      .activity-item p {
          margin-bottom: 5px;
          font-size: 14px;
          color: #666;
      }

      .register-section {
          margin-top: 20px;
      }

      .register-input {
          display: flex;
          gap: 10px;
          margin-bottom: 15px;
      }

      .register-input input {
          flex: 1;
          padding: 12px;
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          font-size: 14px;
      }

      .register-input button {
          padding: 12px 20px;
          background: #667eea;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 600;
      }

      .help-text {
          font-size: 12px;
          color: #666;
          margin-top: 5px;
          line-height: 1.4;
      }

      .bottom-nav {
          position: fixed;
          bottom: 0;
          left: 50%;
          transform: translateX(-50%);
          width: 100%;
          max-width: 400px;
          background: white;
          border-top: 1px solid #e0e0e0;
          display: flex;
          justify-content: space-around;
          padding: 10px 0;
          z-index: 100;
      }

      .nav-item {
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 5px;
          cursor: pointer;
          color: #666;
          font-size: 12px;
          transition: color 0.3s ease;
      }

      .nav-item.active {
          color: #667eea;
      }

      .nav-item:hover {
          color: #667eea;
      }

      .nav-icon {
          font-size: 20px;
          margin-bottom: 4px;
      }

      .content-wrapper {
          padding-bottom: 80px;
      }

      @media (max-width: 375px) {
          .menu-grid {
              grid-template-columns: 1fr;
          }
          
          .menu-item {
              min-height: 60px;
          }
      }

      .volunteer-menu, .member-menu {
          display: none;
      }
  </style>
</head>
<body>
  <div class="container">
      <!-- 主畫面 -->
      <div id="main-screen">
          <div class="header">
              <h1>台灣帕金森病友權益促進會</h1>
              <p>Parkinson's Disease Association Taiwan</p>
          </div>

          <div class="profile-section">
              <div class="profile-info">
                  <img id="profile-pic" class="profile-pic" src="" alt="Profile">
                  <div class="profile-details">
                      <h3 id="display-name">載入中...</h3>
                      <span id="status-badge" class="status-badge">載入中...</span>
                  </div>
              </div>
              <div id="user-stats" class="user-stats"></div>
          </div>

          <div class="content-wrapper">
              <div class="main-menu">
                  <!-- 基本功能 -->
                  <div class="menu-section">
                      <h3>🏠 基本功能</h3>
                      <div class="menu-grid">
                          <button class="menu-item" onclick="showRegistration()">
                              <div class="menu-icon">📝</div>
                              <div>實名登記</div>
                          </button>
                          <button class="menu-item" onclick="showActivities()">
                              <div class="menu-icon">📅</div>
                              <div>活動報名</div>
                          </button>
                          <button class="menu-item" onclick="showProfile()">
                              <div class="menu-icon">👤</div>
                              <div>個人資料</div>
                          </button>
                          <button class="menu-item" onclick="showHelp()">
                              <div class="menu-icon">❓</div>
                              <div>使用說明</div>
                          </button>
                      </div>
                  </div>

                  <!-- 志工功能 -->
                  <div id="volunteer-menu" class="menu-section volunteer-menu">
                      <h3>🙋‍♀️ 志工平台</h3>
                      <div class="menu-grid">
                          <button class="menu-item" onclick="showVolunteerTasks()">
                              <div class="menu-icon">📋</div>
                              <div>志工任務</div>
                          </button>
                          <button class="menu-item" onclick="showVolunteerSchedule()">
                              <div class="menu-icon">📆</div>
                              <div>排班表</div>
                          </button>
                          <button class="menu-item" onclick="showVolunteerHours()">
                              <div class="menu-icon">⏰</div>
                              <div>服務時數</div>
                          </button>
                          <button class="menu-item" onclick="showVolunteerTraining()">
                              <div class="menu-icon">🎓</div>
                              <div>培訓課程</div>
                          </button>
                      </div>
                  </div>

                  <!-- 會員專區 -->
                  <div id="member-menu" class="menu-section member-menu">
                      <h3>👑 會員專區</h3>
                      <div class="menu-grid">
                          <button class="menu-item" onclick="showDonationRecord()">
                              <div class="menu-icon">💰</div>
                              <div>捐款記錄</div>
                          </button>
                          <button class="menu-item" onclick="showMyActivities()">
                              <div class="menu-icon">📝</div>
                              <div>我的活動</div>
                          </button>
                          <button class="menu-item" onclick="showPersonalStats()">
                              <div class="menu-icon">📊</div>
                              <div>個人統計</div>
                          </button>
                          <button class="menu-item" onclick="updatePersonalInfo()">
                              <div class="menu-icon">⚙️</div>
                              <div>資料維護</div>
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- 實名登記畫面 -->
      <div id="registration-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">← 返回主選單</button>
          <div class="card">
              <h3>📝 實名制登記</h3>
              <div id="registration-alert"></div>
              <form id="registration-form">
                  <div class="form-group">
                      <label for="real-name">真實姓名 *</label>
                      <input type="text" id="real-name" placeholder="請輸入您的真實姓名" required>
                      <div class="help-text">請輸入2-10個中文或英文字元</div>
                  </div>
                  <div class="form-group">
                      <label for="member-type">成員類別 *</label>
                      <select id="member-type" required>
                          <option value="">請選擇成員類別</option>
                          <option value="member">一般成員</option>
                          <option value="volunteer">志工</option>
                          <option value="vip">會員</option>
                      </select>
                  </div>
                  <button type="submit" id="register-btn" class="btn">完成登記</button>
              </form>
          </div>
      </div>

      <!-- 活動報名畫面 -->
      <div id="activities-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">← 返回主選單</button>
          <div class="card">
              <h3>📅 活動報名</h3>
              
              <!-- 快速報名 -->
              <div class="register-section">
                  <h4>⚡ 快速報名（本人）</h4>
                  <div id="quick-register-alert"></div>
                  <div class="register-input">
                      <input type="text" id="quick-register" placeholder="活動編號+1 (例: 123+1)">
                      <button onclick="quickRegister()">報名</button>
                  </div>
                  <div class="help-text">格式：活動編號+1，僅限本人報名</div>
              </div>

              <!-- 一般/團體報名 -->
              <div class="register-section">
                  <h4>👥 一般/團體報名</h4>
                  <div id="normal-register-alert"></div>
                  <div class="register-input">
                      <input type="text" id="normal-register" placeholder="活動編號+姓名 (例: 123+王小明+李小華)">
                      <button onclick="normalRegister()">報名</button>
                  </div>
                  <div class="help-text">格式：活動編號+姓名1+姓名2...，可報名多人</div>
              </div>

              <!-- 活動列表 -->
              <h4>📋 開放報名活動</h4>
              <div id="activities-loading" class="loading">載入活動資訊中...</div>
              <div id="activities-list" class="hidden"></div>
          </div>
      </div>

      <!-- 個人資料畫面 -->
      <div id="profile-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">← 返回主選單</button>
          <div class="card">
              <h3>👤 個人資料</h3>
              <div id="profile-details"></div>
          </div>
      </div>

      <!-- 志工平台畫面 -->
      <div id="volunteer-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">← 返回主選單</button>
          <div class="card">
              <h3>🙋‍♀️ 志工平台</h3>
              <div class="menu-grid">
                  <button class="menu-item" onclick="showVolunteerTasks()">
                      <div class="menu-icon">📋</div>
                      <div>志工任務</div>
                  </button>
                  <button class="menu-item" onclick="showVolunteerSchedule()">
                      <div class="menu-icon">📆</div>
                      <div>排班表</div>
                  </button>
                  <button class="menu-item" onclick="showVolunteerHours()">
                      <div class="menu-icon">⏰</div>
                      <div>服務時數</div>
                  </button>
                  <button class="menu-item" onclick="showVolunteerTraining()">
                      <div class="menu-icon">🎓</div>
                      <div>培訓課程</div>
                  </button>
              </div>
          </div>
      </div>

      <!-- 會員專區畫面 -->
      <div id="member-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">← 返回主選單</button>
          <div class="card">
              <h3>👑 會員專區</h3>
              <div class="menu-grid">
                  <button class="menu-item" onclick="showDonationRecord()">
                      <div class="menu-icon">💰</div>
                      <div>捐款記錄</div>
                  </button>
                  <button class="menu-item" onclick="showMyActivities()">
                      <div class="menu-icon">📝</div>
                      <div>我的活動</div>
                  </button>
                  <button class="menu-item" onclick="showPersonalStats()">
                      <div class="menu-icon">📊</div>
                      <div>個人統計</div>
                  </button>
                  <button class="menu-item" onclick="updatePersonalInfo()">
                      <div class="menu-icon">⚙️</div>
                      <div>資料維護</div>
                  </button>
              </div>
          </div>
      </div>

      <!-- 捐款記錄畫面 -->
      <div id="donation-screen" class="hidden">
          <button class="back-btn" onclick="showMemberArea()">← 返回會員專區</button>
          <div class="card">
              <h3>💰 捐款記錄</h3>
              <div id="donation-loading" class="loading">載入捐款記錄中...</div>
              <div id="donation-list" class="hidden"></div>
          </div>
      </div>

      <!-- 我的活動畫面 -->
      <div id="my-activities-screen" class="hidden">
          <button class="back-btn" onclick="showMemberArea()">← 返回會員專區</button>
          <div class="card">
              <h3>📝 我的活動</h3>
              <div id="my-activities-loading" class="loading">載入活動記錄中...</div>
              <div id="my-activities-list" class="hidden"></div>
          </div>
      </div>

      <!-- 底部導航 -->
      <div class="bottom-nav">
          <div class="nav-item active" onclick="showMain()">
              <div class="nav-icon">🏠</div>
              <div>主頁</div>
          </div>
          <div class="nav-item" onclick="showActivities()">
              <div class="nav-icon">📅</div>
              <div>活動</div>
          </div>
          <div class="nav-item" onclick="showProfile()">
              <div class="nav-icon">👤</div>
              <div>個人</div>
          </div>
          <div class="nav-item" onclick="showHelp()">
              <div class="nav-icon">❓</div>
              <div>說明</div>
          </div>
      </div>
  </div>

  <script>
      // 設定參數 - 請替換為實際值
      const LIFF_ID = '1656516134-VaGgmaPm';
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbypkqokP2yH1yJM3SEK_qKN9uXn7kDeSdn0TTLd8iatSwbTp3d93l6NJmy0KA1FROyUVg/exec';
      
      let userProfile = null;
      let userData = null;

      // 修正的 fetch 函數，處理 CORS 和錯誤
      async function fetchWithErrorHandling(url, options = {}) {
          try {
              const defaultOptions = {
                  mode: 'cors',
                  cache: 'no-cache',
                  headers: {
                      'Content-Type': 'application/json',
                  },
              };

              const finalOptions = { ...defaultOptions, ...options };
              
              console.log('Fetching:', url, finalOptions);
              const response = await fetch(url, finalOptions);
              
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              const text = await response.text();
              console.log('Response text:', text);
              
              if (!text) {
                  throw new Error('Empty response');
              }
              
              try {
                  return JSON.parse(text);
              } catch (parseError) {
                  console.error('JSON parse error:', parseError);
                  console.error('Response text:', text);
                  throw new Error('Invalid JSON response');
              }
              
          } catch (error) {
              console.error('Fetch error:', error);
              throw error;
          }
      }

      // 初始化LIFF
      async function initializeLiff() {
          try {
              console.log('開始初始化 LIFF...');
              await liff.init({ liffId: LIFF_ID });
              console.log('LIFF 初始化成功');
              
              if (liff.isLoggedIn()) {
                  console.log('使用者已登入');
                  userProfile = await liff.getProfile();
                  console.log('取得使用者資料:', userProfile);
                  
                  await loadUserData();
                  updateUI();
              } else {
                  console.log('使用者未登入，導向登入頁面');
                  liff.login();
              }
          } catch (error) {
              console.error('LIFF初始化失敗:', error);
              showAlert('registration-alert', 'error', `系統初始化失敗：${error.message}`);
          }
      }

      // 載入使用者資料
      async function loadUserData() {
          try {
              if (!userProfile || !userProfile.userId) {
                  throw new Error('No user profile available');
              }

              const url = `${GAS_URL}?action=getUserInfo&userId=${encodeURIComponent(userProfile.userId)}`;
              const result = await fetchWithErrorHandling(url, { method: 'GET' });
              
              if (result.error) {
                  console.warn('User not found in database:', result.error);
                  userData = null;
              } else {
                  userData = result;
              }
          } catch (error) {
              console.error('載入使用者資料失敗:', error);
              userData = null;
          }
      }

      // 更新UI
      function updateUI() {
          if (userProfile) {
              document.getElementById('profile-pic').src = userProfile.pictureUrl;
              document.getElementById('display-name').textContent = userProfile.displayName;
              
              const statusBadge = document.getElementById('status-badge');
              const userStatsDiv = document.getElementById('user-stats');
              
              if (userData && userData.status === '已註冊') {
                  statusBadge.textContent = getTypeName(userData.memberType);
                  statusBadge.className = 'status-badge status-registered';
                  
                  // 顯示使用者統計
                  const joinDays = Math.floor((new Date() - new Date(userData.firstTime)) / (1000 * 60 * 60 * 24));
                  userStatsDiv.innerHTML = `
                      <div class="stat-item">
                          <div class="stat-number">${userData.messageCount || 0}</div>
                          <div class="stat-label">發言次數</div>
                      </div>
                      <div class="stat-item">
                          <div class="stat-number">${joinDays}</div>
                          <div class="stat-label">加入天數</div>
                      </div>
                  `;
                  
                  // 顯示對應的功能選單
                  if (userData.memberType === 'volunteer') {
                      document.getElementById('volunteer-menu').style.display = 'block';
                  } else if (userData.memberType === 'vip') {
                      document.getElementById('member-menu').style.display = 'block';
                  }
              } else {
                  statusBadge.textContent = '未完成登記';
                  statusBadge.className = 'status-badge status-unregistered';
                  userStatsDiv.innerHTML = '<p style="text-align: center; color: #666;">請先完成實名制登記</p>';
              }
              
              document.querySelector('.profile-section').style.display = 'block';
          }
      }

      // 顯示警告訊息
      function showAlert(containerId, type, message) {
          const container = document.getElementById(containerId);
          container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
          setTimeout(() => {
              container.innerHTML = '';
          }, 5000);
      }

      // 畫面切換函數
      function showMain() {
          hideAllScreens();
          document.getElementById('main-screen').classList.remove('hidden');
          updateNavigation('main');
      }

      function showRegistration() {
          hideAllScreens();
          document.getElementById('registration-screen').classList.remove('hidden');
          updateNavigation('registration');
      }

      function showActivities() {
          hideAllScreens();
          document.getElementById('activities-screen').classList.remove('hidden');
          updateNavigation('activities');
          loadActivities();
      }

      function showProfile() {
          hideAllScreens();
          document.getElementById('profile-screen').classList.remove('hidden');
          updateNavigation('profile');
          loadProfileDetails();
      }

      function showMemberArea() {
          hideAllScreens();
          document.getElementById('member-screen').classList.remove('hidden');
          updateNavigation('member');
      }

      function showVolunteerArea() {
          hideAllScreens();
          document.getElementById('volunteer-screen').classList.remove('hidden');
          updateNavigation('volunteer');
      }

      function showDonationRecord() {
          hideAllScreens();
          document.getElementById('donation-screen').classList.remove('hidden');
          loadDonationRecord();
      }

      function showMyActivities() {
          hideAllScreens();
          document.getElementById('my-activities-screen').classList.remove('hidden');
          loadMyActivities();
      }

      function showHelp() {
          liff.openWindow({
              url: 'https://lch2988.github.io/PDA/help.html',
              external: true
          });
      }

      function hideAllScreens() {
          const screens = ['main-screen', 'registration-screen', 'activities-screen', 'profile-screen', 'member-screen', 'volunteer-screen', 'donation-screen', 'my-activities-screen'];
          screens.forEach(screen => {
              document.getElementById(screen).classList.add('hidden');
          });
      }

      function updateNavigation(active) {
          const navItems = document.querySelectorAll('.nav-item');
          navItems.forEach(item => item.classList.remove('active'));
          
          switch(active) {
              case 'main':
                  navItems[0].classList.add('active');
                  break;
              case 'activities':
                  navItems[1].classList.add('active');
                  break;
              case 'profile':
                  navItems[2].classList.add('active');
                  break;
              case 'help':
                  navItems[3].classList.add('active');
                  break;
          }
      }

      // 實名制登記處理
      document.getElementById('registration-form').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const realName = document.getElementById('real-name').value.trim();
          const memberType = document.getElementById('member-type').value;
          const registerBtn = document.getElementById('register-btn');
          
          if (!realName || !memberType) {
              showAlert('registration-alert', 'error', '請填寫完整資訊');
              return;
          }

          // 驗證姓名格式
          if (!/^[\u4e00-\u9fa5a-zA-Z\s]{2,10}$/.test(realName)) {
              showAlert('registration-alert', 'error', '姓名格式錯誤，請輸入2-10個中文或英文字元');
              return;
          }
          
          if (!userProfile || !userProfile.userId) {
              showAlert('registration-alert', 'error', '無法取得使用者資訊，請重新整理頁面');
              return;
          }
          
          registerBtn.disabled = true;
          registerBtn.textContent = '登記中...';
          
          try {
              const requestData = {
                  action: 'register',
                  userId: userProfile.userId,
                  realName: realName,
                  memberType: memberType
              };

              const result = await fetchWithErrorHandling(GAS_URL, {
                  method: 'POST',
                  body: JSON.stringify(requestData)
              });
              
              if (result.success) {
                  showAlert('registration-alert', 'success', result.message || '註冊成功！');
                  await loadUserData();
                  updateUI();
                  setTimeout(() => showMain(), 2000);
              } else {
                  showAlert('registration-alert', 'error', result.message || '註冊失敗');
              }
          } catch (error) {
              console.error('註冊失敗:', error);
              showAlert('registration-alert', 'error', '註冊失敗，請檢查網路連線或稍後再試');
          } finally {
              registerBtn.disabled = false;
              registerBtn.textContent = '完成登記';
          }
      });

      // 載入活動資訊
      async function loadActivities() {
          try {
              const url = `${GAS_URL}?action=getActivities`;
              const result = await fetchWithErrorHandling(url, { method: 'GET' });
              
              if (result.error) {
                  throw new Error(result.error);
              }
              
              const activities = Array.isArray(result) ? result : [];
              
              document.getElementById('activities-loading').classList.add('hidden');
              const activitiesList = document.getElementById('activities-list');
              activitiesList.classList.remove('hidden');
              
              if (activities.length === 0) {
                  activitiesList.innerHTML = '<p style="text-align: center; color: #666;">目前沒有開放報名的活動</p>';
                  return;
              }
              
              let html = '';
              activities.forEach(activity => {
                  html += `
                      <div class="activity-item">
                          <div class="activity-header">
                              <span class="activity-id">${activity.id}</span>
                              <span class="activity-status status-open">${activity.status}</span>
                          </div>
                          <h4>${activity.name}</h4>
                          <p>📍 地點：${activity.location}</p>
                          <p>📅 日期：${formatDate(activity.date)}</p>
                          <p>⏰ 報名截止：${formatDate(activity.deadline)}</p>
                          ${activity.maxParticipants ? `<p>👥 人數限制：${activity.currentParticipants || 0}/${activity.maxParticipants}</p>` : ''}
                      </div>
                  `;
              });
              
              activitiesList.innerHTML = html;
          } catch (error) {
              console.error('載入活動失敗:', error);
              document.getElementById('activities-loading').textContent = '載入失敗，請重新整理';
          }
      }

      // 快速報名
      async function quickRegister() {
          const input = document.getElementById('quick-register').value.trim();
          
          if (!input.match(/^\d+\+1$/)) {
              showAlert('quick-register-alert', 'error', '格式錯誤！請輸入：活動編號+1');
              return;
          }
          
          if (!userData || userData.status !== '已註冊') {
              showAlert('quick-register-alert', 'error', '請先完成實名制登記！');
              return;
          }
          
          try {
              const requestData = {
                  action: 'quickRegister',
                  userId: userProfile.userId,
                  input: input
              };

              const result = await fetchWithErrorHandling(GAS_URL, {
                  method: 'POST',
                  body: JSON.stringify(requestData)
              });
              
              if (result.success) {
                  showAlert('quick-register-alert', 'success', result.message || '報名成功！');
                  document.getElementById('quick-register').value = '';
                  loadActivities();
              } else {
                  showAlert('quick-register-alert', 'error', result.message || '報名失敗');
              }
          } catch (error) {
              console.error('報名失敗:', error);
              showAlert('quick-register-alert', 'error', '報名失敗，請稍後再試');
          }
      }

      // 一般/團體報名
      async function normalRegister() {
          const input = document.getElementById('normal-register').value.trim();
          
          if (!input.match(/^\d+\+.+/)) {
              showAlert('normal-register-alert', 'error', '格式錯誤！請輸入：活動編號+姓名');
              return;
          }
          
          try {
              const requestData = {
                  action: 'normalRegister',
                  userId: userProfile.userId,
                  input: input
              };

              const result = await fetchWithErrorHandling(GAS_URL, {
                  method: 'POST',
                  body: JSON.stringify(requestData)
              });
              
              if (result.success) {
                  const names = result.names ? result.names.join('、') : '報名者';
                  showAlert('normal-register-alert', 'success', `報名成功！參加者：${names}`);
                  document.getElementById('normal-register').value = '';
                  loadActivities();
              } else {
                  showAlert('normal-register-alert', 'error', result.message || '報名失敗');
              }
          } catch (error) {
              console.error('報名失敗:', error);
              showAlert('normal-register-alert', 'error', '報名失敗，請稍後再試');
          }
      }

      // 載入個人資料詳情
      function loadProfileDetails() {
          const profileDetails = document.getElementById('profile-details');
          
          if (!userProfile) {
              profileDetails.innerHTML = '<p>無法載入個人資料</p>';
              return;
          }
          
          let html = `
              <div style="text-align: center; margin-bottom: 20px;">
                  <img src="${userProfile.pictureUrl}" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #667eea;">
                  <h3 style="margin: 10px 0;">${userProfile.displayName}</h3>
              </div>
              
              <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                  <h4>📱 LINE 資訊</h4>
                  <p><strong>使用者ID：</strong>${userProfile.userId}</p>
                  <p><strong>顯示名稱：</strong>${userProfile.displayName}</p>
                  <p><strong>狀態訊息：</strong>${userProfile.statusMessage || '無'}</p>
              </div>
          `;
          
          if (userData) {
              html += `
                  <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                      <h4>👤 會員資訊</h4>
                      <p><strong>真實姓名：</strong>${userData.realName || '未設定'}</p>
                      <p><strong>成員類別：</strong>${getTypeName(userData.memberType)}</p>
                      <p><strong>註冊狀態：</strong>${userData.status}</p>
                      <p><strong>註冊時間：</strong>${userData.registrationTime ? formatDate(userData.registrationTime) : '未註冊'}</p>
                  </div>
                  
                  <div style="background: #f9f9f9; padding: 15px; border-radius: 10px;">
                      <h4>📊 使用統計</h4>
                      <p><strong>發言次數：</strong>${userData.messageCount || 0}</p>
                      <p><strong>首次使用：</strong>${formatDate(userData.firstTime)}</p>
                      <p><strong>最後使用：</strong>${formatDate(userData.lastTime)}</p>
                  </div>
              `;
          }
          
          profileDetails.innerHTML = html;
      }

      // 載入捐款記錄
      async function loadDonationRecord() {
          try {
              if (!userData || userData.status !== '已註冊') {
                  document.getElementById('donation-loading').textContent = '請先完成實名制登記';
                  return;
              }

              const url = `${GAS_URL}?action=getUserDonations&userId=${encodeURIComponent(userProfile.userId)}`;
              const result = await fetchWithErrorHandling(url, { method: 'GET' });
              
              document.getElementById('donation-loading').classList.add('hidden');
              const donationList = document.getElementById('donation-list');
              donationList.classList.remove('hidden');
              
              if (result.error || !result.length) {
                  donationList.innerHTML = '<p style="text-align: center; color: #666;">暫無捐款記錄</p>';
                  return;
              }
              
              let html = '';
              let totalAmount = 0;
              
              result.forEach(donation => {
                  totalAmount += donation.amount;
                  html += `
                      <div class="activity-item">
                          <div class="activity-header">
                              <span class="activity-id">${donation.id}</span>
                              <span class="activity-status status-open">NT$ ${donation.amount.toLocaleString()}</span>
                          </div>
                          <h4>${donation.purpose}</h4>
                          <p>📅 日期：${formatDate(donation.date)}</p>
                          <p>💳 方式：${donation.method}</p>
                          ${donation.note ? `<p>📝 備註：${donation.note}</p>` : ''}
                      </div>
                  `;
              });
              
              html = `
                  <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                      <h3 style="color: #2e7d32; margin: 0;">累計捐款金額</h3>
                      <div style="font-size: 24px; font-weight: bold; color: #2e7d32; margin-top: 5px;">
                          NT$ ${totalAmount.toLocaleString()}
                      </div>
                  </div>
                  ${html}
              `;
              
              donationList.innerHTML = html;
          } catch (error) {
              console.error('載入捐款記錄失敗:', error);
              document.getElementById('donation-loading').textContent = '載入失敗，請重新整理';
          }
      }

      // 載入我的活動
      async function loadMyActivities() {
          try {
              if (!userData || userData.status !== '已註冊') {
                  document.getElementById('my-activities-loading').textContent = '請先完成實名制登記';
                  return;
              }

              const url = `${GAS_URL}?action=getUserActivities&userId=${encodeURIComponent(userProfile.userId)}`;
              const result = await fetchWithErrorHandling(url, { method: 'GET' });
              
              document.getElementById('my-activities-loading').classList.add('hidden');
              const activitiesList = document.getElementById('my-activities-list');
              activitiesList.classList.remove('hidden');
              
              if (result.error || !result.length) {
                  activitiesList.innerHTML = '<p style="text-align: center; color: #666;">暫無活動記錄</p>';
                  return;
              }
              
              let html = '';
              result.forEach(activity => {
                  html += `
                      <div class="activity-item">
                          <div class="activity-header">
                              <span class="activity-id">${activity.activityId}</span>
                              <span class="activity-status ${getStatusClass(activity.status)}">${activity.status}</span>
                          </div>
                          <h4>${activity.activityName}</h4>
                          <p>📅 活動日期：${formatDate(activity.activityDate)}</p>
                          <p>📝 報名時間：${formatDate(activity.registrationTime)}</p>
                          <p>👤 參加者：${activity.participantName}</p>
                          ${activity.note ? `<p>📝 備註：${activity.note}</p>` : ''}
                      </div>
                  `;
              });
              
              activitiesList.innerHTML = html;
          } catch (error) {
              console.error('載入活動記錄失敗:', error);
              document.getElementById('my-activities-loading').textContent = '載入失敗，請重新整理';
          }
      }

      // 志工功能（佔位符）
      function showVolunteerTasks() {
          alert('志工任務功能開發中...');
      }

      function showVolunteerSchedule() {
          alert('排班表功能開發中...');
      }

      function showVolunteerHours() {
          alert('服務時數功能開發中...');
      }

      function showVolunteerTraining() {
          alert('培訓課程功能開發中...');
      }

      function showPersonalStats() {
          alert('個人統計功能開發中...');
      }

      function updatePersonalInfo() {
          alert('資料維護功能開發中...');
      }

      // 工具函數
      function formatDate(dateString) {
          if (!dateString) return '未設定';
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
          });
      }

      function getTypeName(type) {
          const types = {
              'member': '一般成員',
              'volunteer': '志工',
              'vip': '會員'
          };
          return types[type] || type;
      }

      function getStatusClass(status) {
          switch(status) {
              case '已報名': return 'status-open';
              case '已參加': return 'status-registered';
              case '已取消': return 'status-cancelled';
              default: return 'status-open';
          }
      }

      // 頁面載入時初始化
      window.addEventListener('load', function() {
          console.log('頁面載入完成，開始初始化...');
          initializeLiff();
      });

      // 處理返回按鈕
      window.addEventListener('beforeunload', function() {
          if (liff.isInClient()) {
              liff.closeWindow();
          }
      });
  </script>
</body>
</html>
