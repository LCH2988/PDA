### File: index.html

<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>台灣帕金森病友權益促進會</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
/*（樣式與原本一致，略微精簡，可視需要調整）*/
body { margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;}
.container{max-width:420px;margin:0 auto;background:#fff;min-height:100vh;position:relative;}
.header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:20px;text-align:center;}
.header h1{margin:0;font-size:18px;font-weight:600;}
.profile-section{display:none;margin:-15px 20px 0;background:#fff;padding:18px;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.12);}
.profile-info{display:flex;align-items:center;}
.profile-pic{width:54px;height:54px;border-radius:50%;border:3px solid #667eea;margin-right:14px;object-fit:cover;}
.status-badge{display:inline-block;font-size:12px;padding:4px 10px;border-radius:20px;font-weight:600;margin-top:4px;}
.status-registered{background:#e8f5e8;color:#2e7d32;}
.status-unregistered{background:#fff3e0;color:#f57c00;}
.user-stats{display:flex;justify-content:space-around;margin-top:12px;padding-top:12px;border-top:1px solid #eee;}
.stat-number{font-size:18px;font-weight:700;color:#667eea;}
.main-menu{padding:20px;}
.menu-section{margin-bottom:22px;}
.menu-section h3{font-size:15px;margin:0 0 12px;font-weight:600;}
.menu-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;}
.menu-item{background:#fff;border:2px solid #f0f0f0;border-radius:12px;padding:16px 10px;cursor:pointer;text-align:center;font-size:14px;transition:.25s;display:flex;flex-direction:column;justify-content:center;min-height:80px;}
.menu-item:hover{border-color:#667eea;box-shadow:0 4px 12px rgba(102,126,234,0.25);transform:translateY(-2px);}
.menu-icon{font-size:24px;margin-bottom:6px;}
.hidden{display:none!important;}
.card{background:#fff;margin:20px;border-radius:15px;padding:20px;box-shadow:0 2px 12px rgba(0,0,0,.08);}
.card h3{margin:0 0 18px;font-size:18px;}
.form-group{margin-bottom:16px;}
.form-group label{display:block;font-weight:600;margin-bottom:6px;}
.form-group input,.form-group select{width:100%;padding:11px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;}
.btn{width:100%;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:.25s;}
.btn:hover{transform:translateY(-2px);box-shadow:0 4px 14px rgba(102,126,234,.35);}
.btn:disabled{opacity:.55;cursor:not-allowed;transform:none;}
.alert{padding:10px 12px;border-radius:8px;font-size:14px;margin-bottom:14px;line-height:1.5;}
.alert-success{background:#e8f5e8;color:#2e7d32;border:1px solid #c8e6c9;}
.alert-error{background:#ffebee;color:#c62828;border:1px solid #ffcdd2;}
.back-btn{background:none;border:none;color:#667eea;font-size:15px;cursor:pointer;margin:18px 0 0 20px;}
.activity-item{background:#f9f9f9;padding:14px;border-radius:12px;margin-bottom:14px;border-left:4px solid #667eea;}
.activity-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.activity-id{background:#667eea;color:#fff;padding:3px 8px;border-radius:6px;font-size:12px;font-weight:600;}
.activity-status{font-size:12px;padding:4px 8px;border-radius:6px;font-weight:600;}
.status-open{background:#e8f5e8;color:#2e7d32;}
.loading{text-align:center;color:#666;padding:30px;}
.register-input{display:flex;gap:10px;margin-bottom:10px;}
.register-input input{flex:1;padding:11px;border:2px solid #e0e0e0;border-radius:8px;}
.register-input button{background:#667eea;color:#fff;border:none;padding:11px 18px;border-radius:8px;font-weight:600;cursor:pointer;}
.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:420px;background:#fff;border-top:1px solid #e0e0e0;display:flex;justify-content:space-around;padding:8px 0;}
.nav-item{display:flex;flex-direction:column;align-items:center;font-size:12px;color:#666;cursor:pointer;}
.nav-item.active{color:#667eea;font-weight:600;}
</style>
</head>
<body>
<div class="container">

  <div id="main-screen">
    <div class="header">
      <h1>台灣帕金森病友權益促進會</h1>
      <p style="font-size:12px;opacity:.85">Parkinson's Disease Association Taiwan</p>
    </div>

    <div class="profile-section" id="profile-section">
      <div class="profile-info">
        <img id="profile-pic" class="profile-pic" alt="Profile" />
        <div>
          <div id="display-name" style="font-weight:600;">載入中...</div>
          <div id="status-badge" class="status-badge">...</div>
        </div>
      </div>
      <div id="user-stats" class="user-stats"></div>
    </div>

    <div class="main-menu">
      <div class="menu-section">
        <h3>🏠 基本功能</h3>
        <div class="menu-grid">
          <div class="menu-item" onclick="showScreen('registration')"><div class="menu-icon">📝</div>實名登記</div>
          <div class="menu-item" onclick="showScreen('activities')"><div class="menu-icon">📅</div>活動報名</div>
          <div class="menu-item" onclick="showScreen('profile')"><div class="menu-icon">👤</div>個人資料</div>
          <div class="menu-item" onclick="openHelp()"><div class="menu-icon">❓</div>使用說明</div>
        </div>
      </div>

      <div class="menu-section hidden" id="volunteer-menu">
        <h3>🙋‍♀️ 志工平台</h3>
        <div class="menu-grid">
          <div class="menu-item" onclick="placeholder('志工任務')"><div class="menu-icon">📋</div>志工任務</div>
          <div class="menu-item" onclick="placeholder('排班表')"><div class="menu-icon">📆</div>排班表</div>
          <div class="menu-item" onclick="placeholder('時數登記')"><div class="menu-icon">⏰</div>服務時數</div>
          <div class="menu-item" onclick="placeholder('培訓課程')"><div class="menu-icon">🎓</div>培訓課程</div>
        </div>
      </div>

      <div class="menu-section hidden" id="vip-menu">
        <h3>👑 會員專區</h3>
        <div class="menu-grid">
          <div class="menu-item" onclick="showScreen('donations')"><div class="menu-icon">💰</div>捐款記錄</div>
          <div class="menu-item" onclick="showScreen('myActivities')"><div class="menu-icon">📝</div>我的活動</div>
          <div class="menu-item" onclick="placeholder('統計')"><div class="menu-icon">📊</div>個人統計</div>
          <div class="menu-item" onclick="placeholder('資料維護')"><div class="menu-icon">⚙️</div>資料維護</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 實名登記 -->
  <div id="registration-screen" class="hidden">
    <button class="back-btn" onclick="showScreen('main')">← 返回</button>
    <div class="card">
      <h3>📝 實名制登記</h3>
      <div id="registration-alert"></div>
      <form id="registration-form">
        <div class="form-group">
          <label>真實姓名 *</label>
            <input id="real-name" type="text" placeholder="2-10個中文或英文" required />
        </div>
        <div class="form-group">
          <label>成員類別 *</label>
          <select id="member-type" required>
            <option value="">請選擇</option>
            <option value="member">一般成員</option>
            <option value="volunteer">志工</option>
            <option value="vip">會員</option>
          </select>
        </div>
        <button class="btn" id="register-btn" type="submit">完成登記</button>
      </form>
    </div>
  </div>

  <!-- 活動報名 -->
  <div id="activities-screen" class="hidden">
    <button class="back-btn" onclick="showScreen('main')">← 返回</button>
    <div class="card">
      <h3>📅 活動報名</h3>
      <div>
        <h4 style="margin:0 0 8px;">⚡ 快速報名</h4>
        <div id="quick-register-alert"></div>
        <div class="register-input">
          <input id="quick-register-input" placeholder="例如：001+1" />
          <button onclick="quickRegister()">送出</button>
        </div>
      </div>
      <div style="margin-top:18px;">
        <h4 style="margin:0 0 8px;">👥 一般 / 團體報名</h4>
        <div id="normal-register-alert"></div>
        <div class="register-input">
          <input id="normal-register-input" placeholder="例如：001+王小明+李小華" />
          <button onclick="normalRegister()">送出</button>
        </div>
      </div>
      <hr style="margin:20px 0;">
      <h4 style="margin:0 0 10px;">📋 開放報名活動</h4>
      <div id="activities-loading" class="loading">載入中...</div>
      <div id="activities-list" class="hidden"></div>
    </div>
  </div>

  <!-- 個人資料 -->
  <div id="profile-screen" class="hidden">
    <button class="back-btn" onclick="showScreen('main')">← 返回</button>
    <div class="card">
      <h3>👤 個人資料</h3>
      <div id="profile-details">載入中...</div>
    </div>
  </div>

  <!-- 捐款記錄 -->
  <div id="donations-screen" class="hidden">
    <button class="back-btn" onclick="showScreen('main')">← 返回</button>
    <div class="card">
      <h3>💰 捐款記錄</h3>
      <div id="donation-loading" class="loading">載入中...</div>
      <div id="donation-list" class="hidden"></div>
    </div>
  </div>

  <!-- 我的活動 -->
  <div id="myActivities-screen" class="hidden">
    <button class="back-btn" onclick="showScreen('main')">← 返回</button>
    <div class="card">
      <h3>📝 我的活動</h3>
      <div id="myActivities-loading" class="loading">載入中...</div>
      <div id="myActivities-list" class="hidden"></div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" data-target="main" onclick="showScreen('main')">🏠<div>主頁</div></div>
    <div class="nav-item" data-target="activities" onclick="showScreen('activities')">📅<div>活動</div></div>
    <div class="nav-item" data-target="profile" onclick="showScreen('profile')">👤<div>個人</div></div>
    <div class="nav-item" data-target="help" onclick="openHelp()">❓<div>說明</div></div>
  </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwfmva0DsoItaQPsJ3LS0Pd15s8OI_ujQJsn6GvF5sXd7mqy8TZZ0tFQCvoPdXFolKp3g/exec'; // 例如：https://script.google.com/macros/s/XXXX/exec
const LIFF_ID = '1656516134-VaGgmaPm';

let liffProfile = null;
let userData = null;

async function initLiff() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    liffProfile = await liff.getProfile();
    await ensureUser();      // 確保後端有使用者紀錄
    await loadUserInfo();
    await loadActivities();
    updateProfileUI();
  } catch (e) {
    console.error('LIFF初始化失敗', e);
  }
}

async function ensureUser() {
  try {
    const body = { action:'createUserIfNotExist', userId:liffProfile.userId, displayName:liffProfile.displayName };
    await postJson(body);
  } catch(e) {
    console.warn('確保使用者存在失敗', e);
  }
}

function showAlert(containerId, type, msg) {
  const el = document.getElementById(containerId);
  if (!el) return;
  el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(()=>{ el.innerHTML=''; }, 5000);
}

async function loadUserInfo() {
  try {
    const res = await fetch(`${GAS_URL}?action=getUserInfo&userId=${encodeURIComponent(liffProfile.userId)}`);
    const json = await res.json();
    if (json && !json.error) {
      userData = json;
    } else {
      userData = null;
    }
    renderProfileDetails();
  } catch(e) {
    console.error('載入使用者資料失敗', e);
  }
}

async function loadActivities() {
  const loading = document.getElementById('activities-loading');
  const list = document.getElementById('activities-list');
  loading.classList.remove('hidden');
  list.classList.add('hidden');
  try {
    const res = await fetch(`${GAS_URL}?action=getActivities`);
    const data = await res.json();
    loading.classList.add('hidden');
    list.classList.remove('hidden');
    if (!Array.isArray(data) || !data.length) {
      list.innerHTML = '<p style="text-align:center;color:#666;">目前沒有開放報名活動</p>';
      return;
    }
    list.innerHTML = data.map(a => `
      <div class="activity-item">
        <div class="activity-header">
          <span class="activity-id">${a.id}</span>
          <span class="activity-status status-open">${a.status}</span>
        </div>
        <div style="font-weight:600;margin-bottom:4px;">${a.name}</div>
        <div>📍 ${a.location}</div>
        <div>📅 ${formatDate(a.date)}</div>
        <div>⏳ 截止：${formatDate(a.deadline)}</div>
        ${a.maxParticipants ? `<div>👥 ${a.currentParticipants}/${a.maxParticipants}</div>`:''}
      </div>`).join('');
  } catch(e) {
    console.error('載入活動失敗', e);
    loading.textContent = '載入失敗';
  }
}

function updateProfileUI() {
  if (!liffProfile) return;
  document.getElementById('profile-pic').src = liffProfile.pictureUrl || '';
  document.getElementById('display-name').textContent = liffProfile.displayName || '使用者';
  const badge = document.getElementById('status-badge');
  const stats = document.getElementById('user-stats');
  if (userData && userData.status === '已註冊') {
    badge.textContent = getTypeName(userData.memberType);
    badge.className = 'status-badge status-registered';
    const joinDays = Math.floor((Date.now() - new Date(userData.firstTime)) / 86400000);
    stats.innerHTML = `
      <div style="text-align:center;"><div class="stat-number">${userData.messageCount||0}</div><div style="font-size:12px;color:#555">發言</div></div>
      <div style="text-align:center;"><div class="stat-number">${joinDays}</div><div style="font-size:12px;color:#555">天</div></div>
    `;
    if (userData.memberType === 'volunteer') document.getElementById('volunteer-menu').classList.remove('hidden');
    if (userData.memberType === 'vip') document.getElementById('vip-menu').classList.remove('hidden');
  } else {
    badge.textContent = '未完成登記';
    badge.className = 'status-badge status-unregistered';
    stats.innerHTML = '<div style="text-align:center;color:#777;font-size:13px;">請先完成實名登記</div>';
  }
  document.getElementById('profile-section').style.display = 'block';
}

function renderProfileDetails() {
  const el = document.getElementById('profile-details');
  if (!liffProfile) {
    el.innerHTML = '<p>無法取得資料</p>';
    return;
  }
  let html = `
    <div style="text-align:center;">
      <img src="${liffProfile.pictureUrl||''}" style="width:80px;height:80px;border-radius:50%;border:3px solid #667eea;object-fit:cover;">
      <h3 style="margin:10px 0;">${liffProfile.displayName}</h3>
    </div>
    <div style="background:#f9f9f9;padding:12px;border-radius:10px;margin-bottom:10px;">
      <strong>LINE User ID：</strong><div style="word-break:break-all;font-size:12px;">${liffProfile.userId}</div>
    </div>
  `;
  if (userData) {
    html += `
      <div style="background:#f9f9f9;padding:12px;border-radius:10px;margin-bottom:10px;">
        <h4 style="margin:0 0 8px;">👤 會員資訊</h4>
        姓名：${userData.realName || '未設定'}<br>
        類別：${getTypeName(userData.memberType)}<br>
        註冊狀態：${userData.status}<br>
        首次記錄：${formatDate(userData.firstTime)}<br>
        最後使用：${formatDate(userData.lastTime)}
      </div>
    `;
  } else {
    html += `<div style="padding:12px;border:1px dashed #ccc;border-radius:10px;">尚未註冊，請至「實名登記」完成。</div>`;
  }
  el.innerHTML = html;
}

// 實名制登記提交
document.getElementById('registration-form').addEventListener('submit', async e => {
  e.preventDefault();
  const real = document.getElementById('real-name').value.trim();
  const type = document.getElementById('member-type').value;
  if (!/^[\u4e00-\u9fa5a-zA-Z\s]{2,10}$/.test(real)) {
    showAlert('registration-alert','error','姓名格式錯誤');
    return;
  }
  if (!['member','volunteer','vip'].includes(type)) {
    showAlert('registration-alert','error','成員類別錯誤');
    return;
  }
  try {
    const res = await postJson({ action:'register', userId:liffProfile.userId, realName:real, memberType:type });
    if (res.success) {
      showAlert('registration-alert','success','註冊成功！');
      await loadUserInfo();
      updateProfileUI();
      setTimeout(()=>showScreen('main'),1200);
    } else {
      showAlert('registration-alert','error',res.message||'註冊失敗');
    }
  } catch(e2) {
    showAlert('registration-alert','error','連線失敗');
  }
});

// 快速報名
async function quickRegister() {
  const v = document.getElementById('quick-register-input').value.trim();
  if (!/^\d+\+1$/.test(v)) {
    showAlert('quick-register-alert','error','格式錯誤：例 001+1');
    return;
  }
  try {
    const res = await postJson({ action:'quickRegister', userId:liffProfile.userId, input:v });
    if (res.success) {
      showAlert('quick-register-alert','success','報名成功');
      document.getElementById('quick-register-input').value = '';
      loadActivities();
    } else {
      showAlert('quick-register-alert','error',res.message||'報名失敗');
    }
  } catch(e) {
    showAlert('quick-register-alert','error','網路錯誤');
  }
}

// 一般 / 團體報名
async function normalRegister() {
  const v = document.getElementById('normal-register-input').value.trim();
  if (!/^\d+\+.+/.test(v)) {
    showAlert('normal-register-alert','error','格式錯誤：例 001+王小明');
    return;
  }
  try {
    const res = await postJson({ action:'normalRegister', userId:liffProfile.userId, input:v });
    if (res.success) {
      showAlert('normal-register-alert','success','報名成功');
      document.getElementById('normal-register-input').value = '';
      loadActivities();
    } else {
      showAlert('normal-register-alert','error',res.message||'報名失敗');
    }
  } catch(e) {
    showAlert('normal-register-alert','error','網路錯誤');
  }
}

// 捐款 / 我的活動
async function loadDonations() {
  const loading = document.getElementById('donation-loading');
  const list = document.getElementById('donation-list');
  loading.classList.remove('hidden');
  list.classList.add('hidden');
  try {
    const res = await fetch(`${GAS_URL}?action=getUserDonations&userId=${encodeURIComponent(liffProfile.userId)}`);
    const data = await res.json();
    loading.classList.add('hidden');
    list.classList.remove('hidden');
    if (!Array.isArray(data) || !data.length) {
      list.innerHTML = '<p style="text-align:center;color:#666;">暫無捐款記錄</p>';
      return;
    }
    let total = 0;
    let html = '';
    data.forEach(d=>{
      total += d.amount||0;
      html += `<div class="activity-item">
        <div class="activity-header">
          <span class="activity-id">${d.id}</span>
          <span class="activity-status status-open">NT$ ${d.amount}</span>
        </div>
        <div style="font-weight:600;margin-bottom:4px;">${d.purpose||'未分類'}</div>
        <div>📅 日期：${formatDate(d.date)}</div>
        <div>💳 方式：${d.method||'-'}</div>
        <div>收據：${d.receiptStatus||'-'}</div>
      </div>`;
    });
    list.innerHTML = `<div style="background:#e8f5e8;padding:12px;border-radius:10px;margin-bottom:14px;text-align:center;">
      <div style="color:#2e7d32;font-weight:600;">累計捐款</div>
      <div style="font-size:22px;font-weight:700;color:#2e7d32;">NT$ ${total.toLocaleString()}</div>
    </div>${html}`;
  } catch(e) {
    loading.textContent='載入失敗';
  }
}

async function loadMyActivities() {
  const loading = document.getElementById('myActivities-loading');
  const list = document.getElementById('myActivities-list');
  loading.classList.remove('hidden');
  list.classList.add('hidden');
  try {
    const res = await fetch(`${GAS_URL}?action=getUserActivities&userId=${encodeURIComponent(liffProfile.userId)}`);
    const data = await res.json();
    loading.classList.add('hidden');
    list.classList.remove('hidden');
    if (!Array.isArray(data) || !data.length) {
      list.innerHTML = '<p style="text-align:center;color:#666;">尚無參加活動</p>';
      return;
    }
    list.innerHTML = data.map(a=> `
      <div class="activity-item">
        <div class="activity-header">
          <span class="activity-id">${a.activityId}</span>
          <span class="activity-status status-open">${a.status}</span>
        </div>
        <div style="font-weight:600;margin-bottom:4px;">${a.activityName}</div>
        <div>📅 日期：${formatDate(a.date)}</div>
        <div>📍 地點：${a.location}</div>
      </div>`).join('');
  } catch(e) {
    loading.textContent='載入失敗';
  }
}

// 工具
function formatDate(d) {
  if (!d) return '-';
  const dt = new Date(d);
  if (isNaN(dt.getTime())) return d;
  return dt.toLocaleString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
}
function getTypeName(t) {
  return ({member:'一般成員',volunteer:'志工',vip:'會員'})[t] || '未設定';
}

async function postJson(obj) {
  const res = await fetch(GAS_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' }, // 避免 preflight
    body: JSON.stringify(obj)
  });
  const txt = await res.text();
  try { return JSON.parse(txt); } catch { return { success:false, message:'Invalid JSON' }; }
}

// 畫面切換
function showScreen(name) {
  const screens = ['main','registration','activities','profile','donations','myActivities'];
  screens.forEach(s=>{
    const el = document.getElementById(`${s}-screen`); if (el) el.classList.add('hidden');
  });
  const target = document.getElementById(`${name}-screen`);
  if (target) target.classList.remove('hidden');

  // nav active
  document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
  const nav = document.querySelector(`.nav-item[data-target="${name}"]`);
  if (nav) nav.classList.add('active');

  if (name==='donations') loadDonations();
  if (name==='myActivities') loadMyActivities();
  if (name==='activities') loadActivities();
  if (name==='profile') renderProfileDetails();
  if (name==='main') updateProfileUI();
}

function openHelp() {
  liff.openWindow({ url:'https://lch2988.github.io/PDA/help.html', external:true });
}

function placeholder(label) {
  alert(label + ' 功能開發中');
}

window.addEventListener('load', initLiff);
</script>
</body>
</html>
