<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¸•é‡‘æ£®ç—…å‹æœƒï½œæœƒå“¡èˆ‡è²¡å‹™æ•´åˆç³»çµ±</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --font-base: 19px;
      --font-large: 21px;
      --font-xlarge: 24px;
      --radius: 16px;
      --primary: #1b5e20;
      --primary-accent: #2e7d32;
      --danger: #c62828;
      --warning: #f57c00;
      --info: #1565c0;
      --bg: #fafafa;
      --card: #ffffff;
      --border: #dddddd;
      --text: #222;
      --muted: #666;
      --focus: #90caf9;
      --success-bg: #e8f5e9;
      --error-bg: #ffebee;
    }
    [data-theme="large"] { --font-base: 21px; --font-large: 24px; --font-xlarge: 28px; }
    [data-theme="contrast"] {
      --primary:#004d40; --primary-accent:#00695c; --bg:#ffffff; --card:#ffffff; --text:#000; --border:#000;
    }
    html, body {
      font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,sans-serif;
      font-size:var(--font-base);
      margin:0; padding:0; background:var(--bg); color:var(--text);
      -webkit-font-smoothing:antialiased;
    }
    h1,h2,h3,h4 { margin:0 0 16px; line-height:1.3; font-weight:700; }
    h1{ font-size:var(--font-xlarge); }
    h2{ font-size:var(--font-large); }
    h3{ font-size:1.25rem; }
    h4{ font-size:1.1rem; }
    p { line-height:1.55; margin:0 0 14px; }
    a { color:var(--info); text-decoration:none; }
    a:focus, button:focus, select:focus, input:focus, textarea:focus {
      outline:3px solid var(--focus); outline-offset:2px;
    }
    .hidden { display:none !important; }
    .wrap { max-width:960px; margin:0 auto; padding:70px 16px 100px; }
    header.app-bar {
      position:fixed; top:0; left:0; right:0;
      background:linear-gradient(90deg,var(--primary) 0%, var(--primary-accent) 100%);
      color:#fff; padding:14px 18px;
      display:flex; align-items:center; justify-content:space-between; z-index:100;
    }
    header .brand { font-size:1.05rem; font-weight:600; letter-spacing:1px; }
    header .brand small { display:block; font-size:0.7rem; opacity:.85; font-weight:400; }
    nav.bottom-nav {
      position:fixed; bottom:0; left:0; right:0;
      background:#fff; border-top:1px solid var(--border);
      display:flex; padding:6px 0 4px; z-index:95;
    }
    .nav-item {
      flex:1; text-align:center; font-size:0.75rem;
      color:var(--muted); cursor:pointer; user-select:none; padding:4px 0;
    }
    .nav-item span { font-size:26px; display:block; line-height:1.2; }
    .nav-item.active { color:var(--primary); font-weight:700; }
    .card {
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      padding:20px 22px 22px; margin:0 0 22px; box-shadow:0 4px 14px rgba(0,0,0,0.06);
    }
    .card.highlight { border:2px solid var(--primary-accent); }
    button {
      cursor:pointer; font-family:inherit; font-size:1em; line-height:1.2;
      padding:14px 18px; border-radius:12px; border:1px solid var(--primary-accent);
      background:var(--primary-accent); color:#fff; font-weight:600; letter-spacing:.5px;
      transition:.18s; min-height:54px;
    }
    button.secondary { background:#fff; color:var(--primary-accent); }
    button.outline { background:#fff; color:var(--primary); border:2px solid var(--primary); }
    button.small { padding:10px 14px; font-size:0.85rem; min-height:44px; }
    button.danger { background:var(--danger); border-color:var(--danger); }
    button:active { filter:brightness(.92); transform:translateY(1px); }
    .badge {
      display:inline-block; padding:4px 10px; border-radius:999px;
      font-size:0.72rem; font-weight:600; letter-spacing:.5px;
      background:#eee; color:#555; margin-right:6px;
    }
    .badge.primary { background:#e8f5e9; color:var(--primary); }
    .badge.danger { background:#ffebee; color:var(--danger); }
    .badge.warning { background:#fff3e0; color:var(--warning); }
    .badge.info { background:#e3f2fd; color:var(--info); }
    .admin-badge { background:#263238 !important; color:#fff !important; }
    .loading-center { text-align:center; padding:40px 10px; color:#555; font-size:0.95rem; }
    .list-item {
      border:1px solid var(--border); background:#fff; border-radius:14px;
      padding:14px 16px 12px; margin:0 0 14px; position:relative;
    }
    .list-item .title { font-weight:700; margin:0 0 6px; line-height:1.4; }
    .list-item .meta { font-size:0.78rem; color:var(--muted); line-height:1.4; }
    .empty {
      text-align:center; padding:32px 16px; border:2px dashed #ccc;
      border-radius:18px; color:#777; font-size:0.95rem;
    }
    .alert {
      border-radius:14px; padding:14px 16px; margin:0 0 18px;
      font-weight:600; line-height:1.5;
    }
    .alert.success { background:var(--success-bg); color:var(--primary); border:1px solid #a5d6a7; }
    .alert.error { background:var(--error-bg); color:var(--danger); border:1px solid #ef9a9a; }
    .alert.info { background:#e3f2fd; color:#1565c0; border:1px solid #90caf9; }
    .progress-bar {
      height:12px; background:#eee; border-radius:10px; overflow:hidden;
      margin:8px 0 4px;
    }
    .progress-bar span {
      display:block; height:100%; background:linear-gradient(90deg,#4caf50,#2e7d32);
      width:0%; transition:width .4s;
    }
    .stat-cards {
      display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); margin:0 0 12px;
    }
    .stat { background:#fff; border:1px solid var(--border); border-radius:16px; text-align:center; padding:16px 10px 14px; }
    .stat h4 { margin:0 0 6px; font-size:0.8rem; letter-spacing:1px; color:var(--muted); font-weight:600; }
    .stat .num { font-size:1.4rem; font-weight:700; color:var(--primary); line-height:1.2; }
    .table-scroll {
      overflow-x:auto; -webkit-overflow-scrolling:touch; border:1px solid var(--border);
      border-radius:12px; background:#fff; margin:12px 0;
    }
    table { border-collapse:collapse; width:100%; font-size:0.85rem; min-width:720px; }
    th,td { padding:10px 12px; border-bottom:1px solid #eee; text-align:left; vertical-align:top; }
    th { background:#f5f5f5; font-weight:600; white-space:nowrap; }
    tr:last-child td { border-bottom:none; }
    .text-right { text-align:right; }
    .tag-list { display:flex; gap:6px; flex-wrap:wrap; }
    .floating-buttons {
      position:fixed; bottom:90px; right:16px; display:flex; flex-direction:column; gap:10px; z-index:120;
    }
    .floating-buttons button {
      min-height:46px; padding:12px 14px; font-size:0.8rem; border-radius:50px;
      box-shadow:0 4px 12px rgba(0,0,0,0.18); font-weight:600;
    }
  </style>
</head>
<body>
  <header class="app-bar" role="banner">
    <div class="brand" aria-label="ç³»çµ±æ¨™é¡Œ">
      å¸•é‡‘æ£®ç—…å‹æœƒ
      <small>æœƒå“¡ãƒ»æ´»å‹•ãƒ»è²¡å‹™æ•´åˆ</small>
    </div>
    <div class="toolbar-right">
      <button class="small outline" id="btnFontToggle" aria-label="åˆ‡æ›å­—é«”å¤§å°">A+</button>
      <button class="small outline" id="btnContrastToggle" aria-label="é«˜å°æ¯”æ¨¡å¼">é«˜å°æ¯”</button>
      <button class="small outline" id="btnReload" aria-label="é‡æ–°è¼‰å…¥">â†»</button>
    </div>
  </header>

  <div class="wrap" id="app-root" aria-live="polite">
    <!-- é¦–é  -->
    <div id="screen-home">
      <div class="card highlight" id="profileCard" aria-label="å€‹äººè³‡è¨Šå¡ç‰‡">
        <h2 style="display:flex;align-items:center;gap:10px;">
          <span>ğŸ‘¤ å€‹äººæ¦‚è¦½</span>
          <span id="badgeStatus" class="badge">è¼‰å…¥ä¸­</span>
          <span id="badgeAdmin" class="badge admin-badge hidden">ADMIN</span>
        </h2>
        <div id="profileLoading" class="loading-center">è¼‰å…¥ä¸­...</div>
        <div id="profileContent" class="hidden">
          <p style="margin:0 0 6px;">
            <strong id="realNameDisplay">â€”</strong>
            <span id="memberTypeDisplay" class="badge primary">â€”</span>
          </p>
          <p id="lineNameDisplay" style="margin:0 0 4px;color:var(--muted);font-size:0.85rem;"></p>
          <div class="stat-cards">
            <div class="stat"><h4>ç™¼è¨€æ¬¡æ•¸</h4><div class="num" id="statMessages">0</div></div>
            <div class="stat"><h4>æ´»å‹•åƒèˆ‡</h4><div class="num" id="statActivities">0</div></div>
            <div class="stat"><h4>ææ¬¾æ¬¡æ•¸</h4><div class="num" id="statDonationCount">0</div></div>
            <div class="stat"><h4>ææ¬¾ç¸½é¡</h4><div class="num" id="statDonationTotal">0</div></div>
          </div>
          <div style="font-size:0.75rem;color:var(--muted);">
            åŠ å…¥ï¼š<span id="joinedAt">â€”</span>ï½œæœ€å¾Œäº’å‹•ï¼š<span id="lastActive">â€”</span>
          </div>
        </div>
        <div id="registerPrompt" class="alert info hidden">
          å°šæœªå®Œæˆè¨»å†Šï¼Œè«‹å‰å¾€ã€Œè¨»å†Šã€é å¡«å¯«è³‡æ–™ã€‚
        </div>
      </div>

      <div class="card">
        <h3>ğŸš€ å¿«é€ŸåŠŸèƒ½</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;">
          <button class="outline" data-nav="activities">ğŸ“… æ´»å‹•åˆ—è¡¨</button>
          <button class="outline" data-nav="donations">ğŸ’° ææ¬¾ç´€éŒ„</button>
          <button class="outline" data-nav="myactivities">ğŸ“ æˆ‘çš„æ´»å‹•</button>
          <button class="outline" data-nav="profile">ğŸ‘¤ å€‹äººè³‡æ–™</button>
          <button class="outline" data-nav="finance">ğŸ’° è²¡å‹™ç®¡ç†</button>
          <button class="outline" data-nav="register">ğŸ§¾ è¨»å†Š / ä¿®æ”¹</button>
        </div>
      </div>

      <div class="card">
        <h3>ğŸ”” æœ€æ–°æ´»å‹•ï¼ˆå‰ 3 ç­†ï¼‰</h3>
        <div id="homeActivities"></div>
        <div class="mt">
          <button class="secondary small" data-nav="activities">æŸ¥çœ‹æ›´å¤šæ´»å‹• â†’</button>
        </div>
      </div>
    </div>

    <!-- è¨»å†Š -->
    <div id="screen-register" class="hidden">
      <div class="card">
        <h2>ğŸ§¾ å¯¦ååˆ¶è¨»å†Š</h2>
        <form id="formRegister" novalidate>
          <div id="registerAlert"></div>
          <div class="field">
            <label for="regRealName">å§“å *</label>
            <input id="regRealName" name="realName" required maxlength="10" placeholder="è«‹è¼¸å…¥å§“åï¼ˆ2-10å­—ï¼‰" />
          </div>
          <div class="field">
            <label for="regType">æˆå“¡é¡åˆ¥ *</label>
            <select id="regType" name="memberType" required>
              <option value="">è«‹é¸æ“‡...</option>
              <option value="member">ä¸€èˆ¬æˆå“¡</option>
              <option value="volunteer">å¿—å·¥</option>
              <option value="vip">æœƒå“¡ (VIP)</option>
            </select>
          </div>
          <div class="field">
            <label for="regPhone">é›»è©± (ç›®å‰ä¸å„²å­˜)</label>
            <input id="regPhone" name="phone" placeholder="09xxxxxxxx æˆ– å€ç¢¼-è™Ÿç¢¼" />
            <small>â€» è‹¥éœ€ä¿å­˜è¯çµ¡æ–¹å¼ï¼Œå¾Œç«¯éœ€æ–°å¢ updateUserContact API</small>
          </div>
          <div class="field">
            <label for="regEmail">é›»å­éƒµä»¶ (ç›®å‰ä¸å„²å­˜)</label>
            <input id="regEmail" name="email" type="email" placeholder="name@example.com" />
          </div>
          <button type="submit">é€å‡ºè¨»å†Š</button>
        </form>
      </div>
    </div>

    <!-- æ´»å‹•åˆ—è¡¨ -->
    <div id="screen-activities" class="hidden">
      <div class="card">
        <h2>ğŸ“… æ´»å‹•åˆ—è¡¨</h2>
        <div id="activitiesLoading" class="loading-center">è¼‰å…¥ä¸­...</div>
        <div id="activitiesList" class="hidden"></div>
        <div class="card" style="background:#f5f5f5;margin-top:20px;">
          <h4>â• å ±åæ ¼å¼æç¤º</h4>
          <p style="font-size:0.8rem;line-height:1.4;">
            å¿«é€Ÿå ±åï¼šç·¨è™Ÿ+1<br/>ä¸€èˆ¬å ±åï¼šç·¨è™Ÿ+å§“å<br/>åœ˜é«”å ±åï¼šç·¨è™Ÿ+å§“å1+å§“å2...
          </p>
          <form id="formManualRegister">
            <div class="field">
              <label>è¼¸å…¥å ±åå­—ä¸²</label>
              <input id="manualRegInput" placeholder="ä¾‹å¦‚ï¼š001+ç‹å°æ˜ æˆ– 001+ç‹å°æ˜+æå°è¯" />
            </div>
            <button type="submit" class="secondary">é€å‡ºå­—ä¸²å ±å</button>
          </form>
          <div id="manualRegResult" style="margin-top:10px;font-size:0.8rem;"></div>
        </div>
      </div>
    </div>

    <!-- æˆ‘çš„æ´»å‹• -->
    <div id="screen-myactivities" class="hidden">
      <div class="card">
        <h2>ğŸ“ æˆ‘çš„æ´»å‹•</h2>
        <div id="myActivitiesLoading" class="loading-center">è¼‰å…¥ä¸­...</div>
        <div id="myActivitiesList" class="hidden"></div>
      </div>
    </div>

    <!-- ææ¬¾ -->
    <div id="screen-donations" class="hidden">
      <div class="card">
        <h2>ğŸ’° ææ¬¾ç´€éŒ„</h2>
        <div id="donationsLoading" class="loading-center">è¼‰å…¥ä¸­...</div>
        <div id="donationsList" class="hidden"></div>
      </div>
    </div>

    <!-- å€‹äººè³‡æ–™ -->
    <div id="screen-profile" class="hidden">
      <div class="card">
        <h2>ğŸ‘¤ å€‹äººè³‡æ–™</h2>
        <div id="profileDetailLoading" class="loading-center">è¼‰å…¥ä¸­...</div>
        <div id="profileDetail" class="hidden"></div>
      </div>
    </div>

    <!-- è²¡å‹™ä¸»é¸å–® -->
    <div id="screen-finance" class="hidden">
      <div class="card">
        <h2>ğŸ’° è²¡å‹™ç®¡ç†</h2>
        <div id="financeAccessNote" class="alert info hidden">åƒ…ä¾›å·²è¨»å†Š VIP æˆ–ç®¡ç†å“¡ä½¿ç”¨ã€‚</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;">
          <button class="outline" data-finance="balance">ğŸ¦ å¸³æˆ¶é¤˜é¡</button>
          <button class="outline" data-finance="budget">ğŸ“Š é ç®—ç‹€æ…‹</button>
          <button class="outline" data-finance="expenseApply">ğŸ“ æ”¯å‡ºç”³è«‹</button>
          <button class="outline" data-finance="expenseList">ğŸ’¸ æ”¯å‡ºåˆ—è¡¨</button>
          <button class="outline" data-finance="incomeList">ğŸ’° æ”¶å…¥åˆ—è¡¨</button>
          <button class="outline" data-finance="report">ğŸ“ˆ è²¡å‹™å ±å‘Š</button>
        </div>
        <div id="financeContent" class="mt" style="margin-top:18px;"></div>
      </div>
    </div>

    <!-- ç®¡ç†å“¡ -->
    <div id="screen-admin" class="hidden">
      <div class="card">
        <h2>ğŸ”§ ç®¡ç†å“¡å·¥å…·</h2>
        <div class="alert info">ç¤ºç¯„æ”¯å‡ºå¯©æ ¸å‰ç«¯ï¼›å¯¦å‹™å»ºè­°å¾Œç«¯å†é©—è­‰èº«ä»½ã€‚</div>
        <form id="formApproveExpense">
          <div class="field">
            <label>æ”¯å‡ºç·¨è™Ÿ *</label>
            <input id="approveExpenseId" required placeholder="ä¾‹å¦‚ï¼šEXP1680000000000" />
          </div>
          <div class="field">
            <label>æ±ºç­– *</label>
            <select id="approveDecision">
              <option value="approve">åŒæ„</option>
              <option value="reject">æ‹’çµ•</option>
            </select>
          </div>
          <div class="field">
            <label>å‚™è¨» (é¸å¡«)</label>
            <textarea id="approveNote" rows="2" placeholder="å¯©æ ¸æ„è¦‹"></textarea>
          </div>
          <button type="submit">é€å‡ºå¯©æ ¸</button>
        </form>
        <div id="approveResult" style="font-size:0.8rem;margin-top:12px;"></div>
      </div>
    </div>
  </div>

  <div class="floating-buttons">
    <button id="btnHome" class="outline small" data-nav="home">ğŸ  å›é¦–é </button>
  </div>

  <nav class="bottom-nav" role="navigation" aria-label="åº•éƒ¨å°è¦½">
    <div class="nav-item active" data-nav="home"><span>ğŸ </span>é¦–é </div>
    <div class="nav-item" data-nav="activities"><span>ğŸ“…</span>æ´»å‹•</div>
    <div class="nav-item" data-nav="finance"><span>ğŸ’°</span>è²¡å‹™</div>
    <div class="nav-item" data-nav="donations"><span>ğŸ</span>ææ¬¾</div>
    <div class="nav-item" data-nav="profile"><span>ğŸ‘¤</span>è³‡æ–™</div>
  </nav>

  <script>
    // å¾æ¨¡æ¿æ³¨å…¥è¨­å®š
    // const GAS_CONFIG = <?!= JSON.stringify(config) ?>;
    const LIFF_ID = "1656516134-VaGgmaPm";
    const ADMIN_IDS = 'U09b4c2535730fbb5643274ba1526ec9c' || [];
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzaKjU6yMdyCqKsNdKzACc5xgesoNNBcs49PBpD79L20N930j_faBUKnQ4gOU6VrXMSng/exec';
    // // å‹•æ…‹å–å¾—è‡ªèº« WebApp URLï¼ˆå»é™¤åƒæ•¸ï¼‰
    // const WEBAPP_URL = (()=>{
    //   const u = new URL(window.location.href);
    //   u.search = ''; u.hash = '';
    //   return u.toString();
    // })();

    const state = {
      profile: null,
      user: null,
      stats: null,
      activities: [],
      myActivities: [],
      donations: [],
      activitiesLoaded: false,
      isAdmin: false,
      vipOrAdmin: false,
      fontLarge: false,
      highContrast: false
    };

    function $(id){ return document.getElementById(id); }
    function el(s){ return document.querySelector(s); }
    function els(s){ return Array.from(document.querySelectorAll(s)); }
    function fmtDate(d){ if(!d)return''; const dt=new Date(d); return isNaN(dt)?d:dt.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit'}); }
    function fmtDateTime(d){ if(!d)return''; const dt=new Date(d); return isNaN(dt)?d:dt.toLocaleString('zh-TW'); }
    function fmtMoney(n){ const v=Number(n); return isNaN(v)?'0':v.toLocaleString('zh-TW'); }
    function escapeHTML(str=''){ return str.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function showAlert(id,type,msg){ const c=$(id); if(!c)return; c.innerHTML='<div class="alert '+type+'">'+escapeHTML(msg)+'</div>'; }
    function getTypeName(t){ return ({member:'ä¸€èˆ¬æˆå“¡',volunteer:'å¿—å·¥',vip:'æœƒå“¡'})[t]||t||'â€”'; }

    async function apiGet(action, params={}){
      const url=new URL(WEBAPP_URL);
      url.searchParams.set('action', action);
      Object.entries(params).forEach(([k,v])=> url.searchParams.set(k,v));
      const r=await fetch(url.toString(),{method:'GET'});
      return r.json();
    }
    async function apiPost(payload){
      // ä¸è¨­ Content-Type é¿å…æœªä¾†è·¨åŸŸ Preflight
      const r=await fetch(WEBAPP_URL,{ method:'POST', body: JSON.stringify(payload)});
      return r.json();
    }

    const Api = {
      createUserIfNotExist:(userId,displayName)=> apiPost({action:'createUserIfNotExist',userId,displayName}),
      register:(userId,realName,memberType)=> apiPost({action:'register',userId,realName,memberType}),
      quickRegister:(userId,input)=> apiPost({action:'quickRegister',userId,input}),
      normalRegister:(userId,input)=> apiPost({action:'normalRegister',userId,input}),
      getUserInfo:(userId)=> apiGet('getUserInfo',{userId}),
      getActivities:()=> apiGet('getActivities'),
      getUserActivities:(userId)=> apiGet('getUserActivities',{userId}),
      getUserDonations:(userId)=> apiGet('getUserDonations',{userId}),
      getAccountBalance:()=> apiPost({action:'getAccountBalance'}),
      getBudgetStatus:()=> apiPost({action:'getBudgetStatus'}),
      addExpense:(data)=> apiPost({action:'addExpense', ...data}),
      getExpenseList:(userId,status='all')=> apiPost({action:'getExpenseList',userId,status}),
      getIncomeList:(from,to)=> apiPost({action:'getIncomeList',dateFrom:from,dateTo:to}),
      getFinanceReport:(year,month)=> apiPost({action:'getFinanceReport',year,month}),
      approveExpense:(expenseId,approverName,approved,note)=> apiPost({action:'approveExpense',expenseId,approverName,approved,note})
    };

    function switchScreen(name){
      ['home','register','activities','myactivities','donations','profile','finance','admin']
        .forEach(s=>{ const e=$('screen-'+s); if(e) e.classList.add('hidden'); });
      const target=$('screen-'+name); if(target) target.classList.remove('hidden');
      els('.nav-item').forEach(i=> i.classList.remove('active'));
      const nav=el('.nav-item[data-nav="'+name+'"]'); if(nav) nav.classList.add('active');

      if(name==='activities' && !state.activitiesLoaded) loadActivities();
      else if(name==='myactivities') loadMyActivities();
      else if(name==='donations') loadDonations();
      else if(name==='profile') renderProfileDetail();
      else if(name==='finance') prepareFinanceAccess();
      else if(name==='admin' && !state.isAdmin){
        $('screen-admin').innerHTML='<div class="card"><h2>ğŸ”’ ç„¡æ¬Šé™</h2><p>æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ã€‚</p></div>';
      }
    }

    async function init(){
      // LIFF å¯é¸
      if(typeof liff!=='undefined' && LIFF_ID && LIFF_ID!=='YOUR_LIFF_ID'){
        try{
          await liff.init({ liffId: LIFF_ID });
          if(!liff.isLoggedIn()){ liff.login(); return; }
          state.profile = await liff.getProfile();
        }catch(e){
          console.warn('LIFFå¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬', e);
          state.profile={ userId:'SIM_USER_ID', displayName:'æ¸¬è©¦ç”¨æˆ¶' };
        }
      }else{
          state.profile={ userId:'LOCAL_DEV_USER', displayName:'æœ¬åœ°æ¸¬è©¦è€…' };
      }

      try{
        await Api.createUserIfNotExist(state.profile.userId, state.profile.displayName);
        await refreshUserInfo();
        await loadActivities(true);
        await loadDashboardActivitiesPreview();
        renderProfileCard();
      }catch(e){
        console.error(e);
        showAlert('profileCard','error','ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™');
      }

      bindEvents();
    }

    async function refreshUserInfo(){
      const res=await Api.getUserInfo(state.profile.userId);
      if(res && !res.error){
        state.user=res;
        state.isAdmin = ADMIN_IDS.includes(res.lineId);
        state.vipOrAdmin = state.isAdmin || res.memberType==='vip';
      }
      if(state.user){
        const acts=await Api.getUserActivities(state.user.lineId);
        const dons=await Api.getUserDonations(state.user.lineId);
        const sum=(dons||[]).reduce((s,d)=> s + (Number(d.amount)||0),0);
        state.stats = { activities:(acts||[]).length, donations:(dons||[]).length, donationSum:sum };
      }
    }

    function bindEvents(){
      els('.nav-item').forEach(i=> i.addEventListener('click',()=> switchScreen(i.getAttribute('data-nav'))));
      els('[data-nav]').forEach(btn=> btn.addEventListener('click',()=> switchScreen(btn.getAttribute('data-nav'))));

      $('btnFontToggle').addEventListener('click',()=>{
        state.fontLarge=!state.fontLarge;
        document.documentElement.dataset.theme = state.fontLarge ? 'large' : '';
      });
      $('btnContrastToggle').addEventListener('click',()=>{
        state.highContrast=!state.highContrast;
        const base = state.fontLarge ? 'large' : '';
        document.documentElement.dataset.theme = state.highContrast ? (base+' contrast').trim() : base;
      });
      $('btnReload').addEventListener('click',()=> location.reload());

      $('formRegister').addEventListener('submit', async e=>{
        e.preventDefault();
        const realName=$('regRealName').value.trim();
        const memberType=$('regType').value;
        if(!realName || !memberType){
          showAlert('registerAlert','error','è«‹å®Œæ•´å¡«å¯«å¿…å¡«æ¬„ä½');
          return;
        }
        try{
          const res=await Api.register(state.profile.userId, realName, memberType);
          if(res.success){
            showAlert('registerAlert','success','è¨»å†ŠæˆåŠŸï¼Œæ›´æ–°ä¸­...');
            await refreshUserInfo(); renderProfileCard();
            setTimeout(()=> switchScreen('home'), 1200);
          }else{
            showAlert('registerAlert','error', res.message||'è¨»å†Šå¤±æ•—');
          }
        }catch(err){
          showAlert('registerAlert','error','ç¶²è·¯éŒ¯èª¤');
        }
      });

      $('formManualRegister').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.user || state.user.status!=='å·²è¨»å†Š'){
          $('manualRegResult').textContent='è«‹å…ˆè¨»å†Š';
          return;
        }
        const input=$('manualRegInput').value.trim();
        if(!input) return;
        $('manualRegResult').textContent='è™•ç†ä¸­...';
        try{
          let res;
          if(/^\d+\+1$/.test(input)) res=await Api.quickRegister(state.user.lineId, input);
          else if(/^\d+\+.+/.test(input)) res=await Api.normalRegister(state.user.lineId, input);
          else { $('manualRegResult').textContent='æ ¼å¼éŒ¯èª¤'; return; }
          if(res.success){
            $('manualRegResult').textContent='å ±åæˆåŠŸï¼';
            await loadMyActivities(true);
          }else{
            $('manualRegResult').textContent=res.message||'å ±åå¤±æ•—';
          }
        }catch(err){
          $('manualRegResult').textContent='ç¶²è·¯éŒ¯èª¤';
        }
      });

      $('screen-finance').addEventListener('click', async e=>{
        const btn=e.target.closest('[data-finance]');
        if(!btn) return;
        if(!state.vipOrAdmin){
          $('financeContent').innerHTML='<div class="alert error">éœ€è¦ VIP æˆ–ç®¡ç†å“¡æ¬Šé™</div>';
          return;
        }
        switch(btn.getAttribute('data-finance')){
          case 'balance': await uiFinanceBalance(); break;
          case 'budget': await uiFinanceBudget(); break;
          case 'expenseApply': uiFinanceExpenseForm(); break;
          case 'expenseList': await uiFinanceExpenseList(); break;
          case 'incomeList': await uiFinanceIncomeList(); break;
          case 'report': await uiFinanceReport(); break;
        }
      });

      $('formApproveExpense').addEventListener('submit', async e=>{
        e.preventDefault();
        if(!state.isAdmin){
          $('approveResult').textContent='ç„¡æ¬Šé™';
          return;
        }
          const expenseId=$('approveExpenseId').value.trim();
        const decision=$('approveDecision').value;
        const note=$('approveNote').value.trim();
        if(!expenseId){ $('approveResult').textContent='è«‹è¼¸å…¥æ”¯å‡ºç·¨è™Ÿ'; return; }
        $('approveResult').textContent='é€å‡ºä¸­...';
        try{
          const res=await Api.approveExpense(expenseId,
            state.user.realName||state.user.lineName||'ç®¡ç†å“¡',
            decision==='approve', note);
          $('approveResult').textContent = res.success ? 'å¯©æ ¸å®Œæˆ' : (res.message||'å¯©æ ¸å¤±æ•—');
        }catch(err){
          $('approveResult').textContent='ç¶²è·¯éŒ¯èª¤';
        }
      });
    }

    function renderProfileCard(){
      if(!state.user) return;
      $('profileLoading').classList.add('hidden');
      $('profileContent').classList.remove('hidden');
      $('lineNameDisplay').textContent='LINEï¼š'+(state.user.lineName||'â€”');
      $('realNameDisplay').textContent=state.user.realName||'ï¼ˆæœªè¨»å†Šï¼‰';
      $('memberTypeDisplay').textContent=state.user.memberType ? getTypeName(state.user.memberType) : 'æœªåˆ†é¡';
      $('badgeStatus').textContent=state.user.status||'â€”';
      $('badgeStatus').className='badge '+(state.user.status==='å·²è¨»å†Š'?'primary':'warning');
      if(state.isAdmin) $('badgeAdmin').classList.remove('hidden'); else $('badgeAdmin').classList.add('hidden');
      if(state.stats){
        $('statMessages').textContent=state.user.messageCount||0;
        $('statActivities').textContent=state.stats.activities||0;
        $('statDonationCount').textContent=state.stats.donations||0;
        $('statDonationTotal').textContent=fmtMoney(state.stats.donationSum||0);
      }
      $('joinedAt').textContent=state.user.firstTime?fmtDateTime(state.user.firstTime):'â€”';
      $('lastActive').textContent=state.user.lastTime?fmtDateTime(state.user.lastTime):'â€”';
      if(state.user.status!=='å·²è¨»å†Š') $('registerPrompt').classList.remove('hidden');
      else $('registerPrompt').classList.add('hidden');
    }

    function renderProfileDetail(){
      if(!state.user) return;
      $('profileDetailLoading').classList.add('hidden');
      $('profileDetail').classList.remove('hidden');
      const u=state.user;
      $('profileDetail').innerHTML=`
        <div class="list-item">
          <div class="title">åŸºæœ¬è³‡æ–™</div>
          <div class="meta">
            LINE åç¨±ï¼š${escapeHTML(u.lineName||'â€”')}<br/>
            ç‹€æ…‹ï¼š${escapeHTML(u.status||'â€”')}<br/>
            é¡åˆ¥ï¼š${escapeHTML(getTypeName(u.memberType)||'â€”')}<br/>
            çœŸå¯¦å§“åï¼š${escapeHTML(u.realName||'â€”')}<br/>
            åŠ å…¥ï¼š${u.firstTime?fmtDateTime(u.firstTime):'â€”'}<br/>
            æœ€å¾Œäº’å‹•ï¼š${u.lastTime?fmtDateTime(u.lastTime):'â€”'}
          </div>
        </div>
        <div class="list-item">
          <div class="title">è¯çµ¡è³‡è¨Šï¼ˆå°šæœªæ”¯æ´æ›´æ–°ï¼‰</div>
          <div class="meta">
            é›»è©±ï¼š${escapeHTML(u.phone||'â€”')}<br/>
            Emailï¼š${escapeHTML(u.email||'â€”')}<br/>
            åœ°å€ï¼š${escapeHTML(u.address||'â€”')}<br/>
            ç”Ÿæ—¥ï¼š${escapeHTML(u.birthday||'â€”')}
          </div>
        </div>
      `;
    }

    async function loadActivities(skip){
      if(!skip){
        $('activitiesLoading').classList.remove('hidden');
        $('activitiesList').classList.add('hidden');
      }
      try{
        const list=await Api.getActivities();
        state.activities=Array.isArray(list)?list:[];
        state.activitiesLoaded=true;
        renderActivitiesList();
      }catch(e){
        $('activitiesLoading').textContent='è¼‰å…¥å¤±æ•—';
      }
    }
    function renderActivitiesList(){
      const c=$('activitiesList');
      $('activitiesLoading').classList.add('hidden');
      c.classList.remove('hidden');
      if(!state.activities.length){
        c.innerHTML='<div class="empty">ç›®å‰æ²’æœ‰é–‹æ”¾å ±åçš„æ´»å‹•</div>';
        return;
      }
      c.innerHTML=state.activities.map(a=>{
        const pct=a.maxParticipants ? Math.min(100,Math.round(a.currentParticipants/a.maxParticipants*100)) : 0;
        return `
          <div class="list-item">
            <div class="title">${escapeHTML(a.name)}
              <span class="badge info">${escapeHTML(a.id)}</span>
            </div>
            <div class="meta">
              æ—¥æœŸï¼š${escapeHTML(a.date)}ï½œåœ°é»ï¼š${escapeHTML(a.location)}<br/>
              æˆªæ­¢ï¼š${escapeHTML(a.deadline)}<br/>
              äººæ•¸ï¼š${a.currentParticipants}/${a.maxParticipants||'â€”'}
            </div>
            <div class="progress-bar"><span style="width:${pct}%;"></span></div>
            <div style="display:flex;gap:10px;margin-top:10px;">
              <button class="small secondary" onclick="quickRegister('${a.id}')">å¿«é€Ÿ+1</button>
              <button class="small secondary" onclick="prefillManual('${a.id}')">å¡«å…¥ç·¨è™Ÿ</button>
            </div>
          </div>
        `;
      }).join('');
    }
    async function loadDashboardActivitiesPreview(){
      const box=$('homeActivities');
      try{
        const acts=await Api.getActivities();
        if(!acts.length){
          box.innerHTML='<div class="empty">ç›®å‰ç„¡æ´»å‹•</div>'; return;
        }
        box.innerHTML=acts.slice(0,3).map(a=>`
          <div class="list-item">
            <div class="title">${escapeHTML(a.name)}</div>
            <div class="meta">
              ${escapeHTML(a.date)}ï½œ${escapeHTML(a.location)}<br/>
              äººæ•¸ï¼š${a.currentParticipants}/${a.maxParticipants||'â€”'}
            </div>
          </div>`).join('');
      }catch(e){
        box.innerHTML='<div class="empty">ç„¡æ³•å–å¾—æ´»å‹•è³‡æ–™</div>';
      }
    }
    function prefillManual(id){ $('manualRegInput').value=id+'+'; $('manualRegInput').focus(); }
    async function quickRegister(id){
      if(!state.user || state.user.status!=='å·²è¨»å†Š'){ alert('è«‹å…ˆå®Œæˆè¨»å†Š'); return; }
      try{
        const res=await Api.quickRegister(state.user.lineId, id+'+1');
        if(res.success){
          alert('å ±åæˆåŠŸ');
          await loadActivities(true);
          await loadMyActivities(true);
        }else{
          alert(res.message||'å ±åå¤±æ•—');
        }
      }catch(e){ alert('ç¶²è·¯éŒ¯èª¤'); }
    }
    async function loadMyActivities(){
      $('myActivitiesLoading').classList.remove('hidden');
      $('myActivitiesList').classList.add('hidden');
      try{
        const list=await Api.getUserActivities(state.user.lineId);
        state.myActivities=Array.isArray(list)?list:[];
        $('myActivitiesLoading').classList.add('hidden');
        const c=$('myActivitiesList');
        c.classList.remove('hidden');
        if(!state.myActivities.length){
          c.innerHTML='<div class="empty">å°šç„¡åƒèˆ‡æ´»å‹•</div>'; return;
        }
        c.innerHTML=state.myActivities.map(a=>`
          <div class="list-item">
            <div class="title">${escapeHTML(a.activityName)}</div>
            <div class="meta">
              æ—¥æœŸï¼š${escapeHTML(a.date)}ï½œåœ°é»ï¼š${escapeHTML(a.location)}<br/>
              ç°½åˆ°ç‹€æ…‹ï¼š${escapeHTML(a.status||'â€”')}
            </div>
          </div>`).join('');
      }catch(e){
        $('myActivitiesLoading').textContent='è¼‰å…¥å¤±æ•—';
      }
    }

    async function loadDonations(){
      $('donationsLoading').classList.remove('hidden');
      $('donationsList').classList.add('hidden');
      try{
        const list=await Api.getUserDonations(state.user.lineId);
        state.donations=Array.isArray(list)?list:[];
        $('donationsLoading').classList.add('hidden');
        const c=$('donationsList');
        c.classList.remove('hidden');
        if(!list.length){
          c.innerHTML='<div class="empty">å°šç„¡ææ¬¾ç´€éŒ„</div>'; return;
        }
        let total=0;
        c.innerHTML=list.map(d=>{
          total+=Number(d.amount)||0;
          return `
            <div class="list-item">
              <div class="title">ææ¬¾ï¼š$${fmtMoney(d.amount)}</div>
              <div class="meta">
                æ—¥æœŸï¼š${escapeHTML(d.date)}ï½œæ–¹å¼ï¼š${escapeHTML(d.method||'â€”')}<br/>
                ç”¨é€”ï¼š${escapeHTML(d.purpose||'â€”')}ï½œæ”¶æ“šï¼š${escapeHTML(d.receiptStatus||'â€”')}
              </div>
            </div>`;
        }).join('') + `<div class="alert success">ç´¯è¨ˆææ¬¾ï¼š$${fmtMoney(total)}</div>`;
      }catch(e){
        $('donationsLoading').textContent='è¼‰å…¥å¤±æ•—';
      }
    }

    function prepareFinanceAccess(){
      if(!state.vipOrAdmin) $('financeAccessNote').classList.remove('hidden');
      else $('financeAccessNote').classList.add('hidden');
      $('financeContent').innerHTML='<div style="font-size:0.85rem;color:var(--muted);">è«‹é¸æ“‡ä¸Šæ–¹åŠŸèƒ½...</div>';
    }

    async function uiFinanceBalance(){
      const box=$('financeContent');
      box.innerHTML='è¼‰å…¥ä¸­...';
      try{
        const res=await Api.getAccountBalance();
        if(!res.success){ box.innerHTML='<div class="alert error">ç„¡æ³•å–å¾—å¸³æˆ¶è³‡æ–™</div>'; return; }
        if(!res.accounts.length){ box.innerHTML='<div class="empty">å°šç„¡å¸³æˆ¶è³‡æ–™</div>'; return; }
        let total=0;
        const rows=res.accounts.map(a=>{
          total+=a.balance;
          return `<tr>
            <td>${escapeHTML(a.id)}</td>
            <td>${escapeHTML(a.name)}</td>
            <td>${escapeHTML(a.bank||'')}</td>
            <td>${escapeHTML(a.type||'')}</td>
            <td class="text-right">$${fmtMoney(a.balance)}</td>
          </tr>`;
        }).join('');
        box.innerHTML=`
          <h3>ğŸ¦ å¸³æˆ¶é¤˜é¡</h3>
          <div class="table-scroll">
            <table>
              <thead><tr><th>å¸³æˆ¶ID</th><th>åç¨±</th><th>éŠ€è¡Œ</th><th>é¡å‹</th><th class="text-right">é¤˜é¡</th></tr></thead>
              <tbody>${rows}</tbody>
              <tfoot><tr><th colspan="4" style="text-align:right;">ç¸½è¨ˆ</th><th class="text-right">$${fmtMoney(total)}</th></tr></tfoot>
            </table>
          </div>`;
      }catch(e){ box.innerHTML='<div class="alert error">è¼‰å…¥å¤±æ•—</div>'; }
    }

    async function uiFinanceBudget(){
      const box=$('financeContent');
      box.innerHTML='è¼‰å…¥ä¸­...';
      try{
        const res=await Api.getBudgetStatus();
        if(!res.success){ box.innerHTML='<div class="alert error">ç„¡æ³•å–å¾—é ç®—è³‡æ–™</div>'; return; }
        if(!res.budgets.length){ box.innerHTML='<div class="empty">å°šç„¡é ç®—è³‡æ–™</div>'; return; }
        const rows=res.budgets.map(b=>{
          const pct=parseInt(b.usagePercentage)||0;
          let barColor='#4caf50'; if(pct>=90) barColor='#c62828'; else if(pct>=80) barColor='#f57c00';
          return `<tr>
            <td>${escapeHTML(b.categoryName)}</td>
            <td class="text-right">$${fmtMoney(b.budgetAmount)}</td>
            <td class="text-right">$${fmtMoney(b.usedAmount)}</td>
            <td class="text-right">$${fmtMoney(b.remainingAmount)}</td>
            <td>
              <div class="progress-bar" style="height:10px;">
                <span style="width:${Math.min(100,pct)}%;background:${barColor};"></span>
              </div>
              <div style="font-size:0.65rem;text-align:right;">${escapeHTML(b.usagePercentage)}</div>
            </td>
          </tr>`;
        }).join('');
        box.innerHTML=`
          <h3>ğŸ“Š é ç®—ç‹€æ…‹</h3>
          <div class="table-scroll">
            <table>
              <thead><tr><th>é¡åˆ¥</th><th class="text-right">é ç®—</th><th class="text-right">å·²ç”¨</th><th class="text-right">å‰©é¤˜</th><th>ä½¿ç”¨ç‡</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }catch(e){ box.innerHTML='<div class="alert error">è¼‰å…¥å¤±æ•—</div>'; }
    }

    function uiFinanceExpenseForm(){
      const box=$('financeContent');
      box.innerHTML=`
        <h3>ğŸ“ æ”¯å‡ºç”³è«‹</h3>
        <form id="formExpense">
          <div id="expenseAlert"></div>
          <div class="field">
            <label>é‡‘é¡ *</label>
            <input type="number" id="expAmount" required placeholder="è¼¸å…¥é‡‘é¡" />
          </div>
          <div class="field">
            <label>é¡åˆ¥ *</label>
            <select id="expCategory" required>
              <option value="">é¸æ“‡</option>
              ${Object.entries({
                activity:'æ´»å‹•æ”¯å‡º',office:'è¾¦å…¬è²»ç”¨',marketing:'å®£å‚³è²»ç”¨',equipment:'è¨­å‚™è²»ç”¨',
                welfare:'ç¦åˆ©æ”¯å‡º',medical:'é†«ç™‚æ”¯æ´',volunteer:'å¿—å·¥è²»ç”¨',other:'å…¶ä»–æ”¯å‡º'
              }).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}
            </select>
          </div>
          <div class="field">
            <label>èªªæ˜ *</label>
            <input id="expDesc" required maxlength="50" placeholder="ç”¨é€”èªªæ˜" />
          </div>
          <div class="field">
            <label>æ”¶æ¬¾äºº / å» å•† (é¸å¡«)</label>
            <input id="expRecipient" maxlength="30" />
          </div>
          <button type="submit">æäº¤ç”³è«‹</button>
        </form>`;
      $('formExpense').addEventListener('submit', async e=>{
        e.preventDefault();
        const amount=Number($('expAmount').value);
        const category=$('expCategory').value;
        const description=$('expDesc').value.trim();
        const recipient=$('expRecipient').value.trim();
        if(!amount || amount<=0 || !category || !description){
          showAlert('expenseAlert','error','è«‹å¡«å¯«å¿…å¡«æ¬„ä½'); return;
        }
        try{
          const res=await Api.addExpense({
            category, description, amount, recipient,
            applicant: state.user.realName||state.user.lineName||'ç”¨æˆ¶',
            applicantLineId: state.user.lineId,
            paymentMethod:'bank_transfer',
            status:'å¾…å¯©æ ¸'
          });
          if(res.success){
            showAlert('expenseAlert','success','ç”³è«‹å·²æäº¤ï¼Œç·¨è™Ÿï¼š'+res.expenseId);
            $('formExpense').reset();
          }else{
            showAlert('expenseAlert','error', res.message||'ç”³è«‹å¤±æ•—');
          }
        }catch(err){
          showAlert('expenseAlert','error','ç¶²è·¯éŒ¯èª¤');
        }
      });
    }

    async function uiFinanceExpenseList(){
      const box=$('financeContent');
      box.innerHTML='è¼‰å…¥ä¸­...';
      try{
        const res=await Api.getExpenseList(state.user.lineId,'all');
        if(!res.success){ box.innerHTML='<div class="alert error">ç„¡æ³•å–å¾—æ”¯å‡ºè³‡æ–™</div>'; return; }
        if(!res.expenses.length){ box.innerHTML='<div class="empty">å°šç„¡æ”¯å‡ºç´€éŒ„</div>'; return; }
        const rows=res.expenses.map(e=>`
          <tr>
            <td>${escapeHTML(e.id)}</td>
            <td>${fmtDate(e.date)}</td>
            <td>${escapeHTML(e.categoryName)}</td>
            <td>${escapeHTML(e.description)}</td>
            <td class="text-right">$${fmtMoney(e.amount)}</td>
            <td>${escapeHTML(e.status)}</td>
          </tr>`).join('');
        box.innerHTML=`
          <h3>ğŸ’¸ æ”¯å‡ºåˆ—è¡¨</h3>
          <div class="table-scroll">
            <table>
              <thead><tr><th>ç·¨è™Ÿ</th><th>æ—¥æœŸ</th><th>é¡åˆ¥</th><th>èªªæ˜</th><th class="text-right">é‡‘é¡</th><th>ç‹€æ…‹</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }catch(e){ box.innerHTML='<div class="alert error">è¼‰å…¥å¤±æ•—</div>'; }
    }

    async function uiFinanceIncomeList(){
      const box=$('financeContent');
      box.innerHTML='è¼‰å…¥ä¸­...';
      try{
        const now=new Date();
        const from=new Date(now.getFullYear(), now.getMonth(),1).toISOString();
        const to=new Date(now.getFullYear(), now.getMonth()+1,0).toISOString();
        const res=await Api.getIncomeList(from,to);
        if(!res.success){ box.innerHTML='<div class="alert error">ç„¡æ³•å–å¾—æ”¶å…¥è³‡æ–™</div>'; return; }
        if(!res.incomes.length){ box.innerHTML='<div class="empty">æœ¬æœˆå°šç„¡æ”¶å…¥ç´€éŒ„</div>'; return; }
        let total=0;
        const rows=res.incomes.map(i=>{
          total+=Number(i.amount)||0;
          return `<tr>
            <td>${escapeHTML(i.id)}</td>
            <td>${fmtDate(i.date)}</td>
            <td>${escapeHTML(i.categoryName)}</td>
            <td>${escapeHTML(i.description)}</td>
            <td class="text-right">$${fmtMoney(i.amount)}</td>
            <td>${escapeHTML(i.source||'')}</td>
          </tr>`;
        }).join('');
        box.innerHTML=`
          <h3>ğŸ’° æœ¬æœˆæ”¶å…¥</h3>
          <div class="alert success" style="margin-bottom:12px;">æœ¬æœˆç¸½æ”¶å…¥ï¼š$${fmtMoney(total)}</div>
          <div class="table-scroll">
            <table>
              <thead><tr><th>ç·¨è™Ÿ</th><th>æ—¥æœŸ</th><th>é¡åˆ¥</th><th>æè¿°</th><th class="text-right">é‡‘é¡</th><th>ä¾†æº</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }catch(e){ box.innerHTML='<div class="alert error">è¼‰å…¥å¤±æ•—</div>'; }
    }

    async function uiFinanceReport(){
      const box=$('financeContent');
      box.innerHTML='è¼‰å…¥å ±å‘Š...';
      try{
        const now=new Date();
        const res=await Api.getFinanceReport(now.getFullYear(), now.getMonth()+1);
        if(!res.success){ box.innerHTML='<div class="alert error">ç„¡æ³•å–å¾—å ±å‘Š</div>'; return; }
        const r=res.report;
        const inc=(r.topIncomes||[]).map(i=>`<div class="badge info" style="font-size:0.65rem;">${escapeHTML(i.category)}ï¼š$${fmtMoney(i.amount)}</div>`).join('')||'<div class="inline-note">ç„¡è³‡æ–™</div>';
        const exp=(r.topExpenses||[]).map(i=>`<div class="badge warning" style="font-size:0.65rem;">${escapeHTML(i.category)}ï¼š$${fmtMoney(i.amount)}</div>`).join('')||'<div class="inline-note">ç„¡è³‡æ–™</div>';
        box.innerHTML=`
          <h3>ğŸ“ˆ ${escapeHTML(r.month)} è²¡å‹™å ±å‘Š</h3>
          <div class="stat-cards">
            <div class="stat"><h4>æ”¶å…¥</h4><div class="num">$${fmtMoney(r.totalIncome)}</div></div>
            <div class="stat"><h4>æ”¯å‡º</h4><div class="num">$${fmtMoney(r.totalExpense)}</div></div>
            <div class="stat"><h4>çµé¤˜</h4><div class="num" style="color:${r.balance>=0?'#2e7d32':'#c62828'}">$${fmtMoney(r.balance)}</div></div>
            <div class="stat"><h4>å¸³æˆ¶é¤˜é¡</h4><div class="num">$${fmtMoney(r.cumulativeBalance)}</div></div>
          </div>
          <div style="font-size:0.9rem;margin-top:16px;font-weight:700;">ä¸»è¦æ”¶å…¥</div>
          <div class="tag-list">${inc}</div>
          <div style="font-size:0.9rem;margin-top:16px;font-weight:700;">ä¸»è¦æ”¯å‡º</div>
          <div class="tag-list">${exp}</div>
          <div style="height:1px;background:linear-gradient(90deg,#ddd,#eee,#ddd);margin:18px 0;"></div>
          <div style="font-size:0.65rem;color:var(--muted);">â€» å ±å‘ŠåŒ…å«ç•¶æœˆæ‰€æœ‰æ”¶å…¥èˆ‡å·²æ ¸å‡†/å·²ä»˜æ¬¾æ”¯å‡ºã€‚</div>`;
      }catch(e){ box.innerHTML='<div class="alert error">è¼‰å…¥å¤±æ•—</div>'; }
    }

    window.quickRegister=quickRegister;
    window.prefillManual=prefillManual;
    document.addEventListener('DOMContentLoaded', init);
  </script>

  <!-- æ­£å¼è‹¥éœ€ LIFF åŠŸèƒ½å†è¼‰å…¥ -->
  <!-- <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script> -->
</body>
</html>
