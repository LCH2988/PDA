
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>帕金森病友會整合系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --c-bg:#f5f7fa;
      --c-card:#ffffff;
      --c-border:#d8e0e8;
      --c-primary:#2563eb;
      --c-primary-hover:#1d4ed8;
      --c-text:#1f2937;
      --c-muted:#6b7280;
      --c-danger:#dc2626;
      --c-warn:#f59e0b;
      --c-ok:#059669;
      --radius:10px;
      --transition: .2s ease;
    }
    [data-theme=contrast]{
      --c-bg:#111;
      --c-card:#1e1e1e;
      --c-border:#444;
      --c-text:#fff;
      --c-muted:#bbb;
    }
    body {
      margin:0; font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:var(--c-bg); color:var(--c-text); display:flex; min-height:100vh;
      -webkit-font-smoothing: antialiased;
    }
    aside {
      width:260px; background:linear-gradient(180deg,#2563eb,#1d4ed8); color:#fff;
      display:flex; flex-direction:column; padding:16px 14px; box-sizing:border-box;
    }
    .brand { font-size:18px; font-weight:600; line-height:1.3; margin-bottom:14px; display:flex; gap:8px; align-items:center; }
    .brand span.logo {
      background:#fff1; width:38px; height:38px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:12px; font-weight:700; font-size:15px; letter-spacing:1px;
    }
    nav { flex:1; overflow:auto; }
    nav button {
      width:100%; background:transparent; border:none; text-align:left;
      color:#fff; padding:10px 12px; border-radius:8px; cursor:pointer;
      font-size:14px; display:flex; align-items:center; gap:8px; transition:var(--transition);
    }
    nav button:hover { background:#ffffff22; }
    nav button.active { background:#ffffff33; font-weight:600; }
    .footer-aside { font-size:11px; opacity:.8; margin-top:18px; line-height:1.6; }
    main { flex:1; display:flex; flex-direction:column; }
    header {
      background:var(--c-card); border-bottom:1px solid var(--c-border); padding:10px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      position:sticky; top:0; z-index:20;
    }
    header .actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button, .btn {
      background:var(--c-primary); border:none; color:#fff; padding:8px 14px;
      border-radius:6px; font:inherit; cursor:pointer; font-size:13px; display:inline-flex; align-items:center; gap:6px;
      transition:var(--transition);
    }
    button:hover { background:var(--c-primary-hover); }
    button.outline {
      background:transparent; color:var(--c-primary); border:1px solid var(--c-primary);
    }
    button.outline:hover { background:var(--c-primary); color:#fff; }
    button.ghost {
      background:transparent; color:var(--c-primary); border:none;
    }
    button.ghost:hover { background:#00000010; }
    .danger { background:var(--c-danger); }
    .danger:hover { background:#b91c1c; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; }
    .content-wrapper { padding:20px clamp(12px,2vw,40px); flex:1; overflow:auto; }
    h1,h2,h3 { font-weight:600; line-height:1.25; margin:0 0 14px; }
    h2 { font-size:18px; }
    h3 { font-size:15px; margin-top:28px; }
    p { line-height:1.6; margin:0 0 10px; }
    .grid { display:grid; gap:14px; }
    .grid.cols-2 { grid-template-columns:repeat(auto-fit,minmax(270px,1fr)); }
    .grid.cols-3 { grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); }
    .card {
      background:var(--c-card); border:1px solid var(--c-border); border-radius:var(--radius);
      padding:16px 18px; position:relative; box-shadow:0 2px 4px rgba(0,0,0,.04);
      transition:var(--transition);
    }
    .card:hover { box-shadow:0 4px 10px rgba(0,0,0,.08); }
    .card h3 { margin-top:0; }
    label.field { display:flex; flex-direction:column; gap:4px; font-size:12px; font-weight:500; }
    input[type=text],input[type=number],input[type=date],textarea,select {
      border:1px solid var(--c-border); background:#fff; color:inherit; padding:8px 10px; border-radius:6px;
      font:inherit; font-size:13px; box-sizing:border-box; width:100%; transition:var(--transition);
    }
    textarea { resize:vertical; min-height:90px; }
    input:focus,textarea:focus,select:focus { outline:2px solid #2563eb55; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th,td { padding:7px 10px; border:1px solid var(--c-border); vertical-align:top; }
    th { background:#f1f5f9; text-align:left; }
    [data-theme=contrast] th { background:#222; }
    .muted { color:var(--c-muted); font-size:12px; }
    .highlight { background:#fff6d5; }
    .badge {
      display:inline-block; background:#e5efff; color:#1d4ed8; padding:3px 8px; border-radius:16px;
      font-size:11px; margin-right:4px; font-weight:500;
    }
    [data-theme=contrast] .badge { background:#333; color:#8ab4ff; }
    .flex { display:flex; }
    .wrap { flex-wrap:wrap; }
    .gap { gap:10px; }
    .right { margin-left:auto; }
    .panel-title { font-size:14px; font-weight:600; margin:0 0 8px; display:flex; align-items:center; gap:6px; }
    .status-bar { font-size:12px; padding:4px 10px; border-radius:20px; background:#e2e8f0; display:inline-flex; gap:4px; align-items:center; }
    [data-theme=contrast] .status-bar { background:#333; color:#fff; }
    .top-activities { display:flex; flex-direction:column; gap:8px; }
    .activity-item {
      padding:10px 12px; border:1px solid var(--c-border); border-radius:8px; background:linear-gradient(135deg,#ffffff 0%,#f5f9ff 85%);
      display:flex; flex-direction:column; gap:4px; font-size:13px; position:relative;
    }
    [data-theme=contrast] .activity-item { background:#222; }
    .activity-item .title { font-weight:600; font-size:14px; }
    .activity-item small { color:var(--c-muted); }
    .chip { display:inline-block; padding:2px 8px; background:#2563eb10; color:var(--c-primary); border-radius:12px; font-size:11px; }
    .split { display:flex; gap:16px; flex-wrap:wrap; }
    .split > * { flex:1 1 300px; }
    .inline-form { display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end; }
    .sticky-info { position:sticky; top:86px; }
    .toggle-group { display:flex; gap:6px; }
    .small { font-size:12px; }
    .danger-text { color:var(--c-danger); }
    .ok-text { color:var(--c-ok); }
    .warn-text { color:var(--c-warn); }
    .divider { height:1px; background:var(--c-border); margin:24px 0; }
    .notice {
      background:#eef7ff; padding:10px 14px; border-radius:8px; border-left:4px solid var(--c-primary);
      font-size:13px; line-height:1.5;
    }
    [data-theme=contrast] .notice { background:#222; border-color:#555; }
    .floating-save {
      position:fixed; bottom:22px; right:26px; z-index:50;
      background:var(--c-primary); color:#fff; padding:10px 18px; border-radius:28px;
      box-shadow:0 4px 14px rgba(0,0,0,.2); cursor:pointer; font-size:14px; font-weight:500;
    }
    .font-size-large { font-size:1.08em; }
    .font-size-xlarge { font-size:1.18em; }
    @media (max-width:960px){
      aside { width:210px; }
    }
    @media (max-width:760px){
      aside { display:none; }
      body { flex-direction:column; }
      header { border-radius:0; }
    }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <aside id="sidebar">
    <div class="brand"><span class="logo">PD</span><div>帕金森病友會<br/><small>整合系統</small></div></div>
    <nav id="navMenu"></nav>
    <div class="footer-aside">
      <div>© 2025</div>
      <div style="margin-top:4px;">
        <button class="ghost small" id="btnToggleTheme">高對比/一般</button><br/>
        <button class="ghost small" id="btnFontNormal">字 M</button>
        <button class="ghost small" id="btnFontLarge">字 L</button>
        <button class="ghost small" id="btnFontXLarge">字 XL</button>
      </div>
    </div>
  </aside>
  <main>
    <header>
      <div class="status-bar" id="statusBar">載入中...</div>
      <div class="actions">
        <input type="text" placeholder="API_KEY(測試)" id="apiKeyInput" style="width:160px;">
        <button id="btnInit">初始化</button>
        <button class="outline" id="btnReloadProfile">重新載入使用者</button>
        <button class="outline" id="btnLogout">LIFF 登出</button>
      </div>
    </header>
    <div class="content-wrapper" id="contentArea">
      <!-- 動態注入 -->
    </div>
  </main>

  <div class="floating-save" id="saveLocalBtn" title="儲存設定">儲存設定</div>

  <script>
    /***********************
     * 基本常數（請依部署環境調整）
     ***********************/
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwp1S1cyYlaBIZvZv7GFu4dHFClrCY1vXIAyZldCqV9YgjP90oNC2tkNfGUtGKOYkuk/execvc'; // 部署後替換
    const LIFF_ID = '1656516134-VaGgmaPm';
    const ADMIN_IDS = ['AAbb8520258185202581']; // 可在後端設定，此處僅做前端 UI 快速判斷

    /***********************
     * 全域狀態
     ***********************/
    const state = {
      apiBase: WEBAPP_URL,
      apiKey: '',
      userId: '',
      displayName: '',
      userInfo: null,
      isAdmin: false,
      activitiesCache: [],
      fontSizeMode: 'normal',
      theme: 'normal'
    };

    /***********************
     * DOM 快取
     ***********************/
    const $ = sel => document.querySelector(sel);
    const navMenu = $('#navMenu');
    const contentArea = $('#contentArea');

    /***********************
     * 工具
     ***********************/
    function setStatus(msg){ $('#statusBar').textContent = msg; }
    function randomNonce(len=16){
      const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
      return s;
    }
    let _cachedKey=null;
    async function getCryptoKey(secret){
      if(_cachedKey && _cachedKey.__raw===secret) return _cachedKey;
      const enc=new TextEncoder();
      const key=await crypto.subtle.importKey('raw',enc.encode(secret),{name:'HMAC',hash:'SHA-256'},false,['sign']);
      key.__raw=secret; _cachedKey=key; return key;
    }
    async function hmacSha256Hex(secret,data){
      const key=await getCryptoKey(secret);
      const enc=new TextEncoder();
      const sig=await crypto.subtle.sign('HMAC',key,enc.encode(data));
      return Array.from(new Uint8Array(sig)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    async function callApi(action, payload={}){
      if(!state.apiKey) throw new Error('尚未填入 API_KEY');
      const ts=Date.now();
      const nonce=randomNonce();
      const base=action+'|'+ts+'|'+nonce+'|'+state.apiKey;
      const sign=await hmacSha256Hex(state.apiKey, base);
      const body={ action, ts, nonce, sign, ...payload };
      const res=await fetch(state.apiBase,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    }
    function saveLocal(){
      localStorage.setItem('pd_apiKey', state.apiKey);
      localStorage.setItem('pd_fontSize', state.fontSizeMode);
      localStorage.setItem('pd_theme', state.theme);
      setStatus('設定已儲存');
    }
    function loadLocal(){
      const k=localStorage.getItem('pd_apiKey');
      if(k){ state.apiKey=k; $('#apiKeyInput').value=k; }
      const f=localStorage.getItem('pd_fontSize');
      if(f){ applyFontSize(f); }
      const th=localStorage.getItem('pd_theme');
      if(th){ applyTheme(th); }
    }

    /***********************
     * 導覽 / 頁面組件
     ***********************/
    const pages = [
      { id:'dashboard', label:'總覽', icon:'📊' },
      { id:'member', label:'會員資料', icon:'👤' },
      { id:'activities', label:'活動列表', icon:'🗓️' },
      { id:'myActivities', label:'我的活動', icon:'✅' },
      { id:'donations', label:'捐款紀錄', icon:'💝' },
      { id:'feedback', label:'活動回饋', icon:'📝' },
      { id:'finance', label:'財務資訊', icon:'💰' },
      { id:'expense', label:'支出管理', icon:'🧾' },
      { id:'admin', label:'管理工具', icon:'🛡️', admin:true }
    ];

    function renderNav(){
      navMenu.innerHTML='';
      pages.forEach(p=>{
        if(p.admin && !state.isAdmin) return;
        const btn=document.createElement('button');
        btn.textContent=p.icon+' '+p.label;
        btn.dataset.page=p.id;
        btn.addEventListener('click',()=>activatePage(p.id));
        navMenu.appendChild(btn);
      });
      // 預設
      const first=navMenu.querySelector('button');
      if(first) first.classList.add('active');
      activatePage(first?first.dataset.page:'dashboard');
    }
    function activatePage(id){
      navMenu.querySelectorAll('button').forEach(b=> b.classList.toggle('active', b.dataset.page===id));
      routeTo(id);
    }

    /***********************
     * UI 建構助手
     ***********************/
    function wrapCard(title, inner, extraClass=''){
      return `<div class="card ${extraClass}">
        ${title?`<h3>${title}</h3>`:''}
        ${inner||''}
      </div>`;
    }
    function formatActivitiesList(list){
      if(!list.length) return '<p class="muted">目前沒有活動</p>';
      return `<div class="grid cols-3">${
        list.map(a=>`
          <div class="activity-item">
            <div class="title">${a.id}. ${a.name||''}</div>
            <div><span class="chip">${a.date||''}</span> <span class="chip">${a.location||''}</span></div>
            <small>報名：${a.currentParticipants}/${a.maxParticipants||'-'}</small>
            <div style="display:flex;gap:6px;margin-top:6px;">
              <button class="outline btnQuick" data-id="${a.id}">+1</button>
              <button class="outline btnNormal" data-id="${a.id}">報名</button>
            </div>
          </div>
        `).join('')
      }</div>`;
    }

    /***********************
     * PAGE: Dashboard
     ***********************/
    function pageDashboard(){
      const latest = state.activitiesCache.slice(0,3);
      contentArea.innerHTML=`
        <h2>系統總覽</h2>
        <div class="grid cols-3">
          ${wrapCard('快速資訊',`
            <div><strong>使用者：</strong>${state.displayName||'-'}</div>
            <div><strong>lineId：</strong>${state.userId||'-'}</div>
            <div><strong>狀態：</strong>${state.userInfo?.status||'-'}</div>
            <div><strong>會員類別：</strong>${state.userInfo?.memberType||'-'}</div>
            <div style="margin-top:8px;">${state.isAdmin?'<span class="badge">ADMIN</span>':''}</div>
            <div class="notice" style="margin-top:10px;">首次使用可前往「會員資料」進行註冊，或於 LINE Bot 輸入：註冊 王小明 vip</div>
          `)}
          ${wrapCard('最新活動(前三筆)', latest.length
            ? latest.map(a=>`
              <div style="margin-bottom:8px;">
                <div><strong>${a.id}. ${a.name}</strong></div>
                <small>${a.date} @ ${a.location} | ${a.currentParticipants}/${a.maxParticipants||'-'}</small>
              </div>`).join('')
            : '<p class="muted">尚無活動</p>'
          )}
          ${wrapCard('快速操作',`
            <div class="toolbar">
              <button id="dashReloadActs" class="outline">重新載入活動</button>
              <button id="dashMyActs" class="outline">我的活動</button>
              <button id="dashFinance" class="outline">財務</button>
            </div>
            <div style="margin-top:14px;">
              <label class="field">快速報名輸入 <input type="text" id="dashRegInput" placeholder="例如：5+1 或 5+姓名+姓名"></label>
              <button style="margin-top:6px;" id="dashRegBtn">送出報名</button>
              <pre id="dashRegLog" style="font-size:11px;margin-top:8px;max-height:120px;overflow:auto;"></pre>
            </div>
          `)}
        </div>
      `;
      $('#dashReloadActs').addEventListener('click', async ()=>{
        await loadActivitiesToCache(true);
        activatePage('dashboard');
      });
      $('#dashMyActs').addEventListener('click',()=>activatePage('myActivities'));
      $('#dashFinance').addEventListener('click',()=>activatePage('finance'));
      $('#dashRegBtn').addEventListener('click', async ()=>{
        const v=$('#dashRegInput').value.trim();
        if(!v) return;
          const act = /^\d+\+1$/.test(v)?'quickRegister':'normalRegister';
        try{
          const r=await callApi(act,{ userId:state.userId, input:v });
          $('#dashRegLog').textContent=JSON.stringify(r,null,2);
          if(r.success) await loadMyActivitiesCache();
        }catch(e){
          $('#dashRegLog').textContent='錯誤:'+e.message;
        }
      });
    }

    /***********************
     * PAGE: Member
     ***********************/
    function pageMember(){
      const u=state.userInfo||{};
      contentArea.innerHTML=`
        <h2>會員資料</h2>
        <div class="split">
          <div>
            ${wrapCard('基本資料',`
              <div><strong>LINE名稱：</strong>${u.lineName||'-'}</div>
              <div><strong>真實姓名：</strong>${u.realName||'-'}</div>
              <div><strong>狀態：</strong>${u.status||'-'}</div>
              <div><strong>會員類別：</strong>${u.memberType||'-'}</div>
              <div><strong>電話：</strong>${u.phone||'-'}</div>
              <div><strong>Email：</strong>${u.email||'-'}</div>
              <div><strong>地址：</strong>${u.address||'-'}</div>
              <div><strong>生日：</strong>${u.birthday||'-'}</div>
            `)}
            ${wrapCard('註冊 / 修改',`
              <div class="inline-form">
                <label class="field">真實姓名<input type="text" id="regRealName" value="${u.realName||''}"></label>
                <label class="field">會員類別
                  <select id="regMemberType">
                    <option value="member" ${u.memberType==='member'?'selected':''}>member</option>
                    <option value="volunteer" ${u.memberType==='volunteer'?'selected':''}>volunteer</option>
                    <option value="vip" ${u.memberType==='vip'?'selected':''}>vip</option>
                  </select>
                </label>
                <button id="btnRegisterUser">送出註冊</button>
              </div>
              <div class="notice" style="margin-top:8px;">若尚未註冊，請填姓名後直接送出。</div>
            `)}
          </div>
          <div class="sticky-info">
            ${wrapCard('更新聯絡資料',`
              <div class="grid cols-2" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr));">
                <label class="field">電話<input type="text" id="updPhone" value="${u.phone||''}"></label>
                <label class="field">Email<input type="text" id="updEmail" value="${u.email||''}"></label>
                <label class="field">地址<input type="text" id="updAddress" value="${u.address||''}"></label>
                <label class="field">生日<input type="date" id="updBirthday" value="${u.birthday||''}"></label>
              </div>
              <button style="margin-top:8px;" id="btnUpdateContact">更新聯絡資料</button>
            `)}
          </div>
        </div>
      `;
      $('#btnRegisterUser').addEventListener('click', registerUserHandler);
      $('#btnUpdateContact').addEventListener('click', updateContactHandler);
    }

    async function registerUserHandler(){
      try{
        const realName=$('#regRealName').value.trim();
        const memberType=$('#regMemberType').value;
        const r=await callApi('register',{ userId:state.userId, realName, memberType });
        alert(r.success?'註冊/更新成功':'失敗：'+r.message);
        await refreshUserInfo();
        activatePage('member');
      }catch(e){ alert('失敗：'+e.message); }
    }
    async function updateContactHandler(){
      try{
        const r=await callApi('updateUserContact',{
          operatorLineId:state.userId,
          targetLineId:state.userId,
          phone:$('#updPhone').value.trim(),
          email:$('#updEmail').value.trim(),
          address:$('#updAddress').value.trim(),
          birthday:$('#updBirthday').value
        });
        alert(r.success?'更新成功':'失敗：'+r.message);
        await refreshUserInfo();
        activatePage('member');
      }catch(e){ alert('失敗：'+e.message); }
    }

    /***********************
     * PAGE: Activities
     ***********************/
    function pageActivities(){
      contentArea.innerHTML=`
        <h2>活動列表</h2>
        <div class="toolbar" style="margin-bottom:12px;">
          <button class="outline" id="btnReloadActivities">重新載入</button>
          <label class="field" style="max-width:260px;">快速報名字串
            <input type="text" id="actInput" placeholder="5+1 / 5+張三+李四">
          </label>
          <button id="btnActRegister">送出</button>
        </div>
        <div id="activitiesContainer">${formatActivitiesList(state.activitiesCache)}</div>
        <pre id="actLog" style="margin-top:14px;font-size:11px;max-height:180px;overflow:auto;"></pre>
      `;
      $('#btnReloadActivities').addEventListener('click', async ()=>{
        await loadActivitiesToCache(true);
        pageActivities();
      });
      $('#btnActRegister').addEventListener('click', async ()=>{
        const val=$('#actInput').value.trim();
        if(!val) return;
        const action=/^\d+\+1$/.test(val)?'quickRegister':'normalRegister';
        try{
          const r=await callApi(action,{ userId:state.userId, input:val });
          $('#actLog').textContent=JSON.stringify(r,null,2);
          if(r.success) await loadMyActivitiesCache();
        }catch(e){
          $('#actLog').textContent='錯誤：'+e.message;
        }
      });
      document.querySelectorAll('.btnQuick').forEach(b=>{
        b.addEventListener('click', async ()=>{
          try{
            const r=await callApi('quickRegister',{ userId:state.userId, input: b.dataset.id + '+1' });
            alert(r.success?'成功':'失敗：'+r.message);
          }catch(e){ alert('錯誤：'+e.message); }
        });
      });
      document.querySelectorAll('.btnNormal').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const nm=prompt('輸入姓名(可+多位, 以+分隔)','');
          if(!nm) return;
          try{
            const r=await callApi('normalRegister',{ userId:state.userId, input: b.dataset.id + '+' + nm });
            alert(r.success?'成功':'失敗：'+r.message);
          }catch(e){ alert('錯誤：'+e.message); }
        });
      });
    }

    /***********************
     * PAGE: My Activities
     ***********************/
    async function pageMyActivities(){
      const list = await callApi('getUserActivities',{ userId:state.userId });
      contentArea.innerHTML=`
        <h2>我的活動</h2>
        <div class="card">
          <div style="overflow:auto;">
            <table>
              <thead><tr><th>活動ID</th><th>名稱</th><th>日期</th><th>地點</th><th>狀態</th></tr></thead>
              <tbody>
                ${
                  !Array.isArray(list)||!list.length
                  ? '<tr><td colspan="5" class="muted">尚無報名</td></tr>'
                  : list.map(i=>`<tr><td>${i.activityId}</td><td>${i.activityName||''}</td><td>${i.date||''}</td><td>${i.location||''}</td><td>${i.status}</td></tr>`).join('')
                }
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    /***********************
     * PAGE: Donations
     ***********************/
    async function pageDonations(){
      const dons=await callApi('getUserDonations',{ userId:state.userId });
      const sum=Array.isArray(dons)?dons.reduce((s,d)=>s+(Number(d.amount)||0),0):0;
      contentArea.innerHTML=`
        <h2>捐款紀錄</h2>
        <div class="card">
          <div>總筆數：${dons.length||0}　總額：${sum}</div>
          <div style="overflow:auto;margin-top:10px;">
            <table>
              <thead><tr><th>ID</th><th>金額</th><th>日期</th><th>方式</th><th>用途</th><th>收據</th></tr></thead>
              <tbody>
                ${
                  !dons.length
                    ? '<tr><td colspan="6" class="muted">尚無紀錄</td></tr>'
                    : dons.slice(-100).map(d=>`<tr><td>${d.id}</td><td>${d.amount}</td><td>${d.date||''}</td><td>${d.method||''}</td><td>${d.purpose||''}</td><td>${d.receiptStatus||''}</td></tr>`).join('')
                }
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    /***********************
     * PAGE: Feedback
     ***********************/
    function pageFeedback(){
      contentArea.innerHTML=`
        <h2>活動回饋</h2>
        <div class="card">
          <div class="inline-form">
            <label class="field">活動編號<input type="text" id="fbActivityId"></label>
            <label class="field">評分(1-5)<input type="number" id="fbRating" min="1" max="5"></label>
            <label class="field" style="flex:1;">意見<input type="text" id="fbComment" placeholder="最多300字"></label>
            <button id="btnSubmitFeedback">送出/更新</button>
          </div>
        </div>
        <div class="card">
          <div class="inline-form">
            <label class="field">查詢活動ID(可空)<input type="text" id="fbQueryId" placeholder="例如 5"></label>
            <label class="field">summaryOnly
              <select id="fbSummaryOnly"><option value="true">true</option><option value="false" selected>false</option></select>
            </label>
            <label class="field">limit<input type="number" id="fbLimit" value="50"></label>
            <button id="btnGetFeedback">取得回饋</button>
          </div>
          <pre id="feedbackResult" style="margin-top:10px;max-height:220px;overflow:auto;font-size:11px;"></pre>
        </div>
      `;
      $('#btnSubmitFeedback').addEventListener('click', submitFeedbackHandler);
      $('#btnGetFeedback').addEventListener('click', fetchFeedbackHandler);
    }
    async function submitFeedbackHandler(){
      try{
        const activityId=$('#fbActivityId').value.trim();
        const rating=$('#fbRating').value;
        const comment=$('#fbComment').value.trim();
        if(!activityId) return alert('缺活動ID');
        const r=await callApi('submitActivityFeedback',{ lineId:state.userId, activityId, rating, comment });
        alert(r.success?'成功':'失敗：'+r.message);
      }catch(e){ alert('失敗：'+e.message); }
    }
    async function fetchFeedbackHandler(){
      try{
        const activityId=$('#fbQueryId').value.trim();
        const summaryOnly=$('#fbSummaryOnly').value==='true';
        const limit=Number($('#fbLimit').value||50);
        const r=await callApi('getActivityFeedback',{ operatorLineId:state.userId, activityId:activityId||undefined, summaryOnly, limit });
        $('#feedbackResult').textContent=JSON.stringify(r,null,2);
      }catch(e){
        $('#feedbackResult').textContent='錯誤：'+e.message;
      }
    }

    /***********************
     * PAGE: Finance
     ***********************/
    function pageFinance(){
      contentArea.innerHTML=`
        <h2>財務資訊</h2>
        <div class="grid cols-2">
          ${wrapCard('帳戶餘額',`
            <button class="outline" id="btnLoadAccounts">載入帳戶</button>
            <pre id="accountsBox" style="margin-top:8px;max-height:180px;overflow:auto;font-size:11px;"></pre>
          `)}
          ${wrapCard('預算使用',`
            <button class="outline" id="btnLoadBudgets">載入預算</button>
            <pre id="budgetsBox" style="margin-top:8px;max-height:180px;overflow:auto;font-size:11px;"></pre>
          `)}
        </div>
        <div class="card">
          <h3>月度財報</h3>
          <div class="inline-form">
            <label class="field">年份<input type="number" id="reportYear" value="2025"></label>
            <label class="field">月份<input type="number" id="reportMonth" value="9" min="1" max="12"></label>
            <button id="btnGetReport">取得財報</button>
          </div>
          <pre id="financeReportBox" style="margin-top:8px;max-height:240px;overflow:auto;font-size:11px;"></pre>
        </div>
      `;
      $('#btnLoadAccounts').addEventListener('click', async ()=>{
        try{ const r=await callApi('getAccountBalance',{}); $('#accountsBox').textContent=JSON.stringify(r,null,2); }
        catch(e){ $('#accountsBox').textContent='錯誤：'+e.message; }
      });
      $('#btnLoadBudgets').addEventListener('click', async ()=>{
        try{ const r=await callApi('getBudgetStatus',{}); $('#budgetsBox').textContent=JSON.stringify(r,null,2); }
        catch(e){ $('#budgetsBox').textContent='錯誤：'+e.message; }
      });
      $('#btnGetReport').addEventListener('click', async ()=>{
        try{
          const year=$('#reportYear').value;
          const month=$('#reportMonth').value;
          const r=await callApi('getFinanceReport',{ year, month });
          $('#financeReportBox').textContent=JSON.stringify(r,null,2);
        }catch(e){ $('#financeReportBox').textContent='錯誤：'+e.message; }
      });
    }

    /***********************
     * PAGE: Expense
     ***********************/
    function pageExpense(){
      contentArea.innerHTML=`
        <h2>支出管理</h2>
        <div class="card">
          <h3>新增支出</h3>
          <div class="grid cols-3" style="grid-template-columns:repeat(auto-fit,minmax(190px,1fr));">
            <label class="field">類別<input type="text" id="expCategory" value="activity"></label>
            <label class="field">金額<input type="number" id="expAmount" value="500"></label>
            <label class="field">描述<input type="text" id="expDesc" value="測試支出"></label>
            <label class="field">付款方式<input type="text" id="expPayMethod" placeholder="轉帳/現金"></label>
            <label class="field">收款對象<input type="text" id="expRecipient" placeholder="商家/個人"></label>
          </div>
          <button style="margin-top:10px;" id="btnAddExpense">新增支出</button>
        </div>
        <div class="card">
          <h3>我的支出列表</h3>
          <div class="inline-form">
            <label class="field" style="max-width:160px;">狀態(all/待審核/已核准/已拒絕/已付款)<input type="text" id="expStatusFilter" value="all"></label>
            <button id="btnLoadMyExpenses">載入</button>
          </div>
          <div style="overflow:auto;margin-top:8px;">
            <table>
              <thead><tr><th>ID</th><th>類別</th><th>金額</th><th>描述</th><th>狀態</th></tr></thead>
              <tbody id="expenseTbody"><tr><td colspan="5" class="muted">尚未載入</td></tr></tbody>
            </table>
          </div>
        </div>
      `;
      $('#btnAddExpense').addEventListener('click', addExpenseHandler);
      $('#btnLoadMyExpenses').addEventListener('click', loadMyExpensesHandler);
    }
    async function addExpenseHandler(){
      try{
        const r=await callApi('addExpense',{
          category:$('#expCategory').value.trim(),
          description:$('#expDesc').value.trim(),
          amount:$('#expAmount').value,
          applicant:state.userInfo?.realName || state.displayName || '本人',
          applicantLineId:state.userId,
          paymentMethod:$('#expPayMethod').value.trim(),
          recipient:$('#expRecipient').value.trim()
        });
        alert(r.success?'新增成功：'+r.expenseId:'失敗：'+r.message);
      }catch(e){ alert('失敗：'+e.message); }
    }
    async function loadMyExpensesHandler(){
      const tb=$('#expenseTbody');
      tb.innerHTML='<tr><td colspan="5">載入中...</td></tr>';
      try{
        const status=$('#expStatusFilter').value.trim();
        const r=await callApi('getExpenseList',{ userId:state.userId, status });
        if(!r.expenses||!r.expenses.length){
          tb.innerHTML='<tr><td colspan="5" class="muted">無資料</td></tr>'; return;
        }
        tb.innerHTML=r.expenses.slice(-100).map(e=>`
          <tr><td>${e.id}</td><td>${e.categoryName||e.category}</td><td>${e.amount}</td><td>${e.description||''}</td><td>${e.status}</td></tr>
        `).join('');
      }catch(e){
        tb.innerHTML='<tr><td colspan="5" class="danger-text">錯誤：'+e.message+'</td></tr>';
      }
    }

    /***********************
     * PAGE: Admin
     ***********************/
    function pageAdmin(){
      if(!state.isAdmin){
        contentArea.innerHTML='<h2>管理工具</h2><p class="danger-text">您不是管理員。</p>';
        return;
      }
      contentArea.innerHTML=`
        <h2>管理工具</h2>
        <div class="grid cols-2">
          ${wrapCard('會員類別調整',`
            <div class="inline-form">
              <label class="field">目標 lineId<input type="text" id="admTargetLineId"></label>
              <label class="field">新類別<input type="text" id="admNewMemberType" placeholder="vip"></label>
              <label class="field">備註<input type="text" id="admNote"></label>
              <button id="btnUpdateMemberType">更新類別</button>
            </div>
          `)}
          ${wrapCard('支出審核',`
            <div class="inline-form">
              <label class="field">支出編號<input type="text" id="approveExpenseId" placeholder="EXP..."></label>
              <label class="field">決定
                <select id="approveDecision"><option value="agree">同意</option><option value="reject">拒絕</option></select>
              </label>
              <label class="field">備註<input type="text" id="approveNote"></label>
              <button id="btnApproveExpense">送出審核</button>
            </div>
          `)}
        </div>
        <div class="card">
          <h3>全部會員搜尋</h3>
          <div class="inline-form">
            <label class="field">頁碼<input type="number" id="allUsersPage" value="1"></label>
            <label class="field">每頁<input type="number" id="allUsersSize" value="20"></label>
            <label class="field">關鍵字<input type="text" id="allUsersKeyword"></label>
            <label class="field">會員類別<input type="text" id="allUsersMemberType" placeholder="member"></label>
            <label class="field">狀態<input type="text" id="allUsersStatus" placeholder="已註冊"></label>
            <button id="btnGetAllUsers">搜尋</button>
          </div>
          <pre id="allUsersResult" style="margin-top:8px;max-height:240px;overflow:auto;font-size:11px;"></pre>
        </div>
        <div class="card">
          <h3>回饋統計</h3>
          <div class="inline-form">
            <label class="field">活動編號(可空)<input type="text" id="admFeedbackActivityId"></label>
            <label class="field">summaryOnly
              <select id="admFbSummaryOnly"><option value="true" selected>true</option><option value="false">false</option></select>
            </label>
            <label class="field">limit<input type="number" id="admFbLimit" value="50"></label>
            <button id="btnAdminGetFeedback">取得</button>
          </div>
          <pre id="adminFeedbackBox" style="margin-top:8px;max-height:220px;overflow:auto;font-size:11px;"></pre>
        </div>
      `;
      $('#btnUpdateMemberType').addEventListener('click', async ()=>{
        try{
          const r=await callApi('updateMemberType',{
            operatorLineId:state.userId,
            targetLineId:$('#admTargetLineId').value.trim(),
            newMemberType:$('#admNewMemberType').value.trim(),
            note:$('#admNote').value.trim()
          });
          alert(r.success?'成功':'失敗：'+r.message);
        }catch(e){ alert('錯誤：'+e.message); }
      });
      $('#btnApproveExpense').addEventListener('click', async ()=>{
        try{
          const approved=$('#approveDecision').value==='agree';
          const r=await callApi('approveExpense',{
            expenseId:$('#approveExpenseId').value.trim(),
            approverName:state.userInfo?.realName || '管理員',
            approved,
            note:$('#approveNote').value.trim(),
            operatorLineId:state.userId
          });
          alert(r.success?(approved?'已核准':'已拒絕'):'失敗：'+r.message);
        }catch(e){ alert('錯誤：'+e.message); }
      });
      $('#btnGetAllUsers').addEventListener('click', async ()=>{
        try{
          const r=await callApi('getAllUsers',{
            operatorLineId:state.userId,
            page:Number($('#allUsersPage').value||1),
            pageSize:Number($('#allUsersSize').value||20),
            keyword:$('#allUsersKeyword').value.trim(),
            memberType:$('#allUsersMemberType').value.trim(),
            status:$('#allUsersStatus').value.trim()
          });
          $('#allUsersResult').textContent=JSON.stringify(r,null,2);
        }catch(e){ $('#allUsersResult').textContent='錯誤：'+e.message; }
      });
      $('#btnAdminGetFeedback').addEventListener('click', async ()=>{
        try{
          const r=await callApi('getActivityFeedback',{
            operatorLineId:state.userId,
            activityId:$('#admFeedbackActivityId').value.trim()||undefined,
            summaryOnly:$('#admFbSummaryOnly').value==='true',
            limit:Number($('#admFbLimit').value||50)
          });
          $('#adminFeedbackBox').textContent=JSON.stringify(r,null,2);
        }catch(e){
          $('#adminFeedbackBox').textContent='錯誤：'+e.message;
        }
      });
    }

    /***********************
     * Router
     ***********************/
    function routeTo(id){
      switch(id){
        case 'dashboard': pageDashboard(); break;
        case 'member': pageMember(); break;
        case 'activities': pageActivities(); break;
        case 'myActivities': pageMyActivities(); break;
        case 'donations': pageDonations(); break;
        case 'feedback': pageFeedback(); break;
        case 'finance': pageFinance(); break;
        case 'expense': pageExpense(); break;
        case 'admin': pageAdmin(); break;
        default: contentArea.innerHTML='<p>未知頁面</p>';
      }
    }

    /***********************
     * 資料載入
     ***********************/
    async function refreshUserInfo(){
      try{
        const r=await callApi('getUserInfo',{ userId:state.userId });
        if(r.error){ setStatus('未註冊'); state.userInfo=null; return; }
        state.userInfo=r;
        state.isAdmin = ADMIN_IDS.includes(state.userId);
      }catch(e){
        setStatus('取得使用者資訊失敗:'+e.message);
      }
    }
    async function loadActivitiesToCache(force=false){
      if(state.activitiesCache.length && !force) return;
      try{
        const r=await callApi('getActivities',{});
        state.activitiesCache=Array.isArray(r)?r:[];
      }catch(e){
        console.error(e);
      }
    }
    async function loadMyActivitiesCache(){
      // 目前僅需要即時查詢時呼叫，不長期緩存
      return;
    }

    /***********************
     * 顯示 / 字級 / 主題
     ***********************/
    function applyFontSize(mode){
      document.body.classList.remove('font-size-large','font-size-xlarge');
      if(mode==='large') document.body.classList.add('font-size-large');
      else if(mode==='xlarge') document.body.classList.add('font-size-xlarge');
      state.fontSizeMode=mode;
    }
    function applyTheme(th){
      if(th==='contrast'){
        document.body.setAttribute('data-theme','contrast');
      }else{
        document.body.removeAttribute('data-theme');
      }
      state.theme=th;
    }

    $('#btnFontNormal').addEventListener('click',()=>applyFontSize('normal'));
    $('#btnFontLarge').addEventListener('click',()=>applyFontSize('large'));
    $('#btnFontXLarge').addEventListener('click',()=>applyFontSize('xlarge'));
    $('#btnToggleTheme').addEventListener('click',()=>{
      applyTheme(state.theme==='contrast'?'normal':'contrast');
    });
    $('#saveLocalBtn').addEventListener('click', saveLocal);

    /***********************
     * 初始化流程
     ***********************/
    async function init(){
      loadLocal();
      state.apiKey = $('#apiKeyInput').value.trim();
      await initLIFFIfPossible();
      if(!state.userId){
        setStatus('請先登入或手動設定 userId（需修改前端程式）');
        return;
      }
      try{
        // create or update
        await callApi('createUserIfNotExist',{ userId:state.userId, displayName:state.displayName });
      }catch(e){
        console.warn('createUserIfNotExist 失敗', e);
      }
      await refreshUserInfo();
      await loadActivitiesToCache(true);
      renderNav();
      setStatus('就緒 userId='+state.userId);
    }

    async function initLIFFIfPossible(){
      if(!LIFF_ID){
        console.warn('未設定 LIFF_ID，跳過 LIFF');
        return;
      }
      try{
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()){
          liff.login();
          return;
        }
        const profile=await liff.getProfile();
        state.userId=profile.userId;
        state.displayName=profile.displayName;
      }catch(e){
        console.warn('LIFF 失敗',e);
      }
    }

    $('#btnInit').addEventListener('click', async ()=>{
      state.apiKey=$('#apiKeyInput').value.trim();
      await init();
      activatePage('dashboard');
    });
    $('#btnReloadProfile').addEventListener('click', async ()=>{
      await refreshUserInfo();
      activatePage('member');
    });
    $('#btnLogout').addEventListener('click', ()=>{
      if(window.liff && liff.isLoggedIn()){
        liff.logout();
        location.reload();
      }
    });

    // 自動初始化（若已儲存 API_KEY）
    if(localStorage.getItem('pd_apiKey')){
      state.apiKey=localStorage.getItem('pd_apiKey');
      $('#apiKeyInput').value=state.apiKey;
      init();
    } else {
      setStatus('請輸入 API_KEY 後點「初始化」');
    }
  </script>
</body>
</html>

完成！請將上述程式貼入環境並套用實際參數即可正式啟用。
