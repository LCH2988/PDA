### File: index.html

<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>å°ç£å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
/*ï¼ˆæ¨£å¼èˆ‡åŸæœ¬ä¸€è‡´ï¼Œç•¥å¾®ç²¾ç°¡ï¼Œå¯è¦–éœ€è¦èª¿æ•´ï¼‰*/
body { margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;}
.container{max-width:420px;margin:0 auto;background:#fff;min-height:100vh;position:relative;}
.header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:20px;text-align:center;}
.header h1{margin:0;font-size:18px;font-weight:600;}
.profile-section{display:none;margin:-15px 20px 0;background:#fff;padding:18px;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.12);}
.profile-info{display:flex;align-items:center;}
.profile-pic{width:54px;height:54px;border-radius:50%;border:3px solid #667eea;margin-right:14px;object-fit:cover;}
.status-badge{display:inline-block;font-size:12px;padding:4px 10px;border-radius:20px;font-weight:600;margin-top:4px;}
.status-registered{background:#e8f5e8;color:#2e7d32;}
.status-unregistered{background:#fff3e0;color:#f57c00;}
.user-stats{display:flex;justify-content:space-around;margin-top:12px;padding-top:12px;border-top:1px solid #eee;}
.stat-number{font-size:18px;font-weight:700;color:#667eea;}
.main-menu{padding:20px;}
.menu-section{margin-bottom:22px;}
.menu-section h3{font-size:15px;margin:0 0 12px;font-weight:600;}
.menu-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;}
.menu-item{background:#fff;border:2px solid #f0f0f0;border-radius:12px;padding:16px 10px;cursor:pointer;text-align:center;font-size:14px;transition:.25s;display:flex;flex-direction:column;justify-content:center;min-height:80px;}
.menu-item:hover{border-color:#667eea;box-shadow:0 4px 12px rgba(102,126,234,0.25);transform:translateY(-2px);}
.menu-icon{font-size:24px;margin-bottom:6px;}
.hidden{display:none!important;}
.card{background:#fff;margin:20px;border-radius:15px;padding:20px;box-shadow:0 2px 12px rgba(0,0,0,.08);}
.card h3{margin:0 0 18px;font-size:18px;}
.form-group{margin-bottom:16px;}
.form-group label{display:block;font-weight:600;margin-bottom:6px;}
.form-group input,.form-group select{width:100%;padding:11px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;}
.btn{width:100%;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:.25s;}
.btn:hover{transform:translateY(-2px);box-shadow:0 4px 14px rgba(102,126,234,.35);}
.btn:disabled{opacity:.55;cursor:not-allowed;transform:none;}
.alert{padding:10px 12px;border-radius:8px;font-size:14px;margin-bottom:14px;line-height:1.5;}
.alert-success{background:#e8f5e8;color:#2e7d32;border:1px solid #c8e6c9;}
.alert-error{background:#ffebee;color:#c62828;border:1px solid #ffcdd2;}
.back-btn{background:none;border:none;color:#667eea;font-size:15px;cursor:pointer;margin:18px 0 0 20px;}
.activity-item{background:#f9f9f9;padding:14px;border-radius:12px;margin-bottom:14px;border-left:4px solid #667eea;}
.activity-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.activity-id{background:#667eea;color:#fff;padding:3px 8px;border-radius:6px;font-size:12px;font-weight:600;}
.activity-status{font-size:12px;padding:4px 8px;border-radius:6px;font-weight:600;}
.status-open{background:#e8f5e8;color:#2e7d32;}
.loading{text-align:center;color:#666;padding:30px;}
.register-input{display:flex;gap:10px;margin-bottom:10px;}
.register-input input{flex:1;padding:11px;border:2px solid #e0e0e0;border-radius:8px;}
.register-input button{background:#667eea;color:#fff;border:none;padding:11px 18px;border-radius:8px;font-weight:600;cursor:pointer;}
.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:420px;background:#fff;border-top:1px solid #e0e0e0;display:flex;justify-content:space-around;padding:8px 0;}
.nav-item{display:flex;flex-direction:column;align-items:center;font-size:12px;color:#666;cursor:pointer;}
.nav-item.active{color:#667eea;font-weight:600;}
</style>
</head>
<body>
<div class="container">

  <div id="main-screen">
    <div class="header">
      <h1>å°ç£å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ</h1>
      <p style="font-size:12px;opacity:.85">Parkinson's Disease Association Taiwan</p>
    </div>

    <div class="profile-section" id="profile-section">
      <div class="profile-info">
        <img id="profile-pic" class="profile-pic" alt="Profile" />
        <div>
          <div id="display-name" style="font-weight:600;">è¼‰å…¥ä¸­...</div>
          <div id="status-badge" class="status-badge">...</div>
        </div>
      </div>
      <div id="user-stats" class="user-stats"></div>
    </div>

    <div class="main-menu">
      <div class="menu-section">
        <h3>ğŸ  åŸºæœ¬åŠŸèƒ½</h3>
        <div class="menu-grid">
          <div class="menu-item" onclick="showScreen('registration')"><div class="menu-icon">ğŸ“</div>å¯¦åç™»è¨˜</div>
          <div class="menu-item" onclick="showScreen('activities')"><div class="menu-icon">ğŸ“…</div>æ´»å‹•å ±å</div>
          <div class="menu-item" onclick="showScreen('profile')"><div class="menu-icon">ğŸ‘¤</div>å€‹äººè³‡æ–™</div>
          <div class="menu-item" onclick="openHelp()"><div class="menu-icon">â“</div>ä½¿ç”¨èªªæ˜</div>
        </div>
      </div>

      <div class="menu-section hidden" id="volunteer-menu">
        <h3>ğŸ™‹â€â™€ï¸ å¿—å·¥å¹³å°</h3>
        <div class="menu-grid">
          <div class="menu-item" onclick="placeholder('å¿—å·¥ä»»å‹™')"><div class="menu-icon">ğŸ“‹</div>å¿—å·¥ä»»å‹™</div>
          <div class="menu-item" onclick="placeholder('æ’ç­è¡¨')"><div class="menu-icon">ğŸ“†</div>æ’ç­è¡¨</div>
          <div class="menu-item" onclick="placeholder('æ™‚æ•¸ç™»è¨˜')"><div class="menu-icon">â°</div>æœå‹™æ™‚æ•¸</div>
          <div class="menu-item" onclick="placeholder('åŸ¹è¨“èª²ç¨‹')"><div class="menu-icon">ğŸ“</div>åŸ¹è¨“èª²ç¨‹</div>
        </div>
      </div>

      <div class="menu-section hidden" id="vip-menu">
        <h3>ğŸ‘‘ æœƒå“¡å°ˆå€</h3>
        <div class="menu-grid">
          <div class="menu-item" onclick="showScreen('donations')"><div class="menu-icon">ğŸ’°</div>ææ¬¾è¨˜éŒ„</div>
          <div class="menu-item" onclick="showScreen('myActivities')"><div class="menu-icon">ğŸ“</div>æˆ‘çš„æ´»å‹•</div>
          <div class="menu-item" onclick="placeholder('çµ±è¨ˆ')"><div class="menu-icon">ğŸ“Š</div>å€‹äººçµ±è¨ˆ</div>
          <div class="menu-item" onclick="placeholder('è³‡æ–™ç¶­è­·')"><div class="menu-icon">âš™ï¸</div>è³‡æ–™ç¶­è­·</div>
        </div>
      </div>
    </div>
  </div>

  <!-- å¯¦åç™»è¨˜ -->
  <div id="registration-screen" class="hidden">
    <button class="back-btn" onclick="showScreen('main')">â† è¿”å›</button>
    <div class="card">
      <h3>ğŸ“ å¯¦ååˆ¶ç™»è¨˜</h3>
      <div id="registration-alert"></div>
      <form id="registration-form">
        <div class="form-group">
          <label>çœŸå¯¦å§“å *</label>
            <input id="real-name" type="text" placeholder="2-10å€‹ä¸­æ–‡æˆ–è‹±æ–‡" required />
        </div>
        <div class="form-group">
          <label>æˆå“¡é¡åˆ¥ *</label>
          <select id="member-type" required>
            <option value="">è«‹é¸æ“‡</option>
            <option value="member">ä¸€èˆ¬æˆå“¡</option>
            <option value="volunteer">å¿—å·¥</option>
            <option value="vip">æœƒå“¡</option>
          </select>
        </div>
        <button class="btn" id="register-btn" type="submit">å®Œæˆç™»è¨˜</button>
      </form>
    </div>
  </div>

  <!-- æ´»å‹•å ±å -->
  <div id="activities-screen" class="hidden">
    <button class="back-btn" onclick="showScreen('main')">â† è¿”å›</button>
    <div class="card">
      <h3>ğŸ“… æ´»å‹•å ±å</h3>
      <div>
        <h4 style="margin:0 0 8px;">âš¡ å¿«é€Ÿå ±å</h4>
        <div id="quick-register-alert"></div>
        <div class="register-input">
          <input id="quick-register-input" placeholder="ä¾‹å¦‚ï¼š001+1" />
          <button onclick="quickRegister()">é€å‡º</button>
        </div>
      </div>
      <div style="margin-top:18px;">
        <h4 style="margin:0 0 8px;">ğŸ‘¥ ä¸€èˆ¬ / åœ˜é«”å ±å</h4>
        <div id="normal-register-alert"></div>
        <div class="register-input">
          <input id="normal-register-input" placeholder="ä¾‹å¦‚ï¼š001+ç‹å°æ˜+æå°è¯" />
          <button onclick="normalRegister()">é€å‡º</button>
        </div>
      </div>
      <hr style="margin:20px 0;">
      <h4 style="margin:0 0 10px;">ğŸ“‹ é–‹æ”¾å ±åæ´»å‹•</h4>
      <div id="activities-loading" class="loading">è¼‰å…¥ä¸­...</div>
      <div id="activities-list" class="hidden"></div>
    </div>
  </div>

  <!-- å€‹äººè³‡æ–™ -->
  <div id="profile-screen" class="hidden">
    <button class="back-btn" onclick="showScreen('main')">â† è¿”å›</button>
    <div class="card">
      <h3>ğŸ‘¤ å€‹äººè³‡æ–™</h3>
      <div id="profile-details">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <!-- ææ¬¾è¨˜éŒ„ -->
  <div id="donations-screen" class="hidden">
    <button class="back-btn" onclick="showScreen('main')">â† è¿”å›</button>
    <div class="card">
      <h3>ğŸ’° ææ¬¾è¨˜éŒ„</h3>
      <div id="donation-loading" class="loading">è¼‰å…¥ä¸­...</div>
      <div id="donation-list" class="hidden"></div>
    </div>
  </div>

  <!-- æˆ‘çš„æ´»å‹• -->
  <div id="myActivities-screen" class="hidden">
    <button class="back-btn" onclick="showScreen('main')">â† è¿”å›</button>
    <div class="card">
      <h3>ğŸ“ æˆ‘çš„æ´»å‹•</h3>
      <div id="myActivities-loading" class="loading">è¼‰å…¥ä¸­...</div>
      <div id="myActivities-list" class="hidden"></div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" data-target="main" onclick="showScreen('main')">ğŸ <div>ä¸»é </div></div>
    <div class="nav-item" data-target="activities" onclick="showScreen('activities')">ğŸ“…<div>æ´»å‹•</div></div>
    <div class="nav-item" data-target="profile" onclick="showScreen('profile')">ğŸ‘¤<div>å€‹äºº</div></div>
    <div class="nav-item" data-target="help" onclick="openHelp()">â“<div>èªªæ˜</div></div>
  </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwfmva0DsoItaQPsJ3LS0Pd15s8OI_ujQJsn6GvF5sXd7mqy8TZZ0tFQCvoPdXFolKp3g/exec'; // ä¾‹å¦‚ï¼šhttps://script.google.com/macros/s/XXXX/exec
const LIFF_ID = '1656516134-VaGgmaPm';

let liffProfile = null;
let userData = null;

async function initLiff() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    liffProfile = await liff.getProfile();
    await ensureUser();      // ç¢ºä¿å¾Œç«¯æœ‰ä½¿ç”¨è€…ç´€éŒ„
    await loadUserInfo();
    await loadActivities();
    updateProfileUI();
  } catch (e) {
    console.error('LIFFåˆå§‹åŒ–å¤±æ•—', e);
  }
}

async function ensureUser() {
  try {
    const body = { action:'createUserIfNotExist', userId:liffProfile.userId, displayName:liffProfile.displayName };
    await postJson(body);
  } catch(e) {
    console.warn('ç¢ºä¿ä½¿ç”¨è€…å­˜åœ¨å¤±æ•—', e);
  }
}

function showAlert(containerId, type, msg) {
  const el = document.getElementById(containerId);
  if (!el) return;
  el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(()=>{ el.innerHTML=''; }, 5000);
}

async function loadUserInfo() {
  try {
    const res = await fetch(`${GAS_URL}?action=getUserInfo&userId=${encodeURIComponent(liffProfile.userId)}`);
    const json = await res.json();
    if (json && !json.error) {
      userData = json;
    } else {
      userData = null;
    }
    renderProfileDetails();
  } catch(e) {
    console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—', e);
  }
}

async function loadActivities() {
  const loading = document.getElementById('activities-loading');
  const list = document.getElementById('activities-list');
  loading.classList.remove('hidden');
  list.classList.add('hidden');
  try {
    const res = await fetch(`${GAS_URL}?action=getActivities`);
    const data = await res.json();
    loading.classList.add('hidden');
    list.classList.remove('hidden');
    if (!Array.isArray(data) || !data.length) {
      list.innerHTML = '<p style="text-align:center;color:#666;">ç›®å‰æ²’æœ‰é–‹æ”¾å ±åæ´»å‹•</p>';
      return;
    }
    list.innerHTML = data.map(a => `
      <div class="activity-item">
        <div class="activity-header">
          <span class="activity-id">${a.id}</span>
          <span class="activity-status status-open">${a.status}</span>
        </div>
        <div style="font-weight:600;margin-bottom:4px;">${a.name}</div>
        <div>ğŸ“ ${a.location}</div>
        <div>ğŸ“… ${formatDate(a.date)}</div>
        <div>â³ æˆªæ­¢ï¼š${formatDate(a.deadline)}</div>
        ${a.maxParticipants ? `<div>ğŸ‘¥ ${a.currentParticipants}/${a.maxParticipants}</div>`:''}
      </div>`).join('');
  } catch(e) {
    console.error('è¼‰å…¥æ´»å‹•å¤±æ•—', e);
    loading.textContent = 'è¼‰å…¥å¤±æ•—';
  }
}

function updateProfileUI() {
  if (!liffProfile) return;
  document.getElementById('profile-pic').src = liffProfile.pictureUrl || '';
  document.getElementById('display-name').textContent = liffProfile.displayName || 'ä½¿ç”¨è€…';
  const badge = document.getElementById('status-badge');
  const stats = document.getElementById('user-stats');
  if (userData && userData.status === 'å·²è¨»å†Š') {
    badge.textContent = getTypeName(userData.memberType);
    badge.className = 'status-badge status-registered';
    const joinDays = Math.floor((Date.now() - new Date(userData.firstTime)) / 86400000);
    stats.innerHTML = `
      <div style="text-align:center;"><div class="stat-number">${userData.messageCount||0}</div><div style="font-size:12px;color:#555">ç™¼è¨€</div></div>
      <div style="text-align:center;"><div class="stat-number">${joinDays}</div><div style="font-size:12px;color:#555">å¤©</div></div>
    `;
    if (userData.memberType === 'volunteer') document.getElementById('volunteer-menu').classList.remove('hidden');
    if (userData.memberType === 'vip') document.getElementById('vip-menu').classList.remove('hidden');
  } else {
    badge.textContent = 'æœªå®Œæˆç™»è¨˜';
    badge.className = 'status-badge status-unregistered';
    stats.innerHTML = '<div style="text-align:center;color:#777;font-size:13px;">è«‹å…ˆå®Œæˆå¯¦åç™»è¨˜</div>';
  }
  document.getElementById('profile-section').style.display = 'block';
}

function renderProfileDetails() {
  const el = document.getElementById('profile-details');
  if (!liffProfile) {
    el.innerHTML = '<p>ç„¡æ³•å–å¾—è³‡æ–™</p>';
    return;
  }
  let html = `
    <div style="text-align:center;">
      <img src="${liffProfile.pictureUrl||''}" style="width:80px;height:80px;border-radius:50%;border:3px solid #667eea;object-fit:cover;">
      <h3 style="margin:10px 0;">${liffProfile.displayName}</h3>
    </div>
    <div style="background:#f9f9f9;padding:12px;border-radius:10px;margin-bottom:10px;">
      <strong>LINE User IDï¼š</strong><div style="word-break:break-all;font-size:12px;">${liffProfile.userId}</div>
    </div>
  `;
  if (userData) {
    html += `
      <div style="background:#f9f9f9;padding:12px;border-radius:10px;margin-bottom:10px;">
        <h4 style="margin:0 0 8px;">ğŸ‘¤ æœƒå“¡è³‡è¨Š</h4>
        å§“åï¼š${userData.realName || 'æœªè¨­å®š'}<br>
        é¡åˆ¥ï¼š${getTypeName(userData.memberType)}<br>
        è¨»å†Šç‹€æ…‹ï¼š${userData.status}<br>
        é¦–æ¬¡è¨˜éŒ„ï¼š${formatDate(userData.firstTime)}<br>
        æœ€å¾Œä½¿ç”¨ï¼š${formatDate(userData.lastTime)}
      </div>
    `;
  } else {
    html += `<div style="padding:12px;border:1px dashed #ccc;border-radius:10px;">å°šæœªè¨»å†Šï¼Œè«‹è‡³ã€Œå¯¦åç™»è¨˜ã€å®Œæˆã€‚</div>`;
  }
  el.innerHTML = html;
}

// å¯¦ååˆ¶ç™»è¨˜æäº¤
document.getElementById('registration-form').addEventListener('submit', async e => {
  e.preventDefault();
  const real = document.getElementById('real-name').value.trim();
  const type = document.getElementById('member-type').value;
  if (!/^[\u4e00-\u9fa5a-zA-Z\s]{2,10}$/.test(real)) {
    showAlert('registration-alert','error','å§“åæ ¼å¼éŒ¯èª¤');
    return;
  }
  if (!['member','volunteer','vip'].includes(type)) {
    showAlert('registration-alert','error','æˆå“¡é¡åˆ¥éŒ¯èª¤');
    return;
  }
  try {
    const res = await postJson({ action:'register', userId:liffProfile.userId, realName:real, memberType:type });
    if (res.success) {
      showAlert('registration-alert','success','è¨»å†ŠæˆåŠŸï¼');
      await loadUserInfo();
      updateProfileUI();
      setTimeout(()=>showScreen('main'),1200);
    } else {
      showAlert('registration-alert','error',res.message||'è¨»å†Šå¤±æ•—');
    }
  } catch(e2) {
    showAlert('registration-alert','error','é€£ç·šå¤±æ•—');
  }
});

// å¿«é€Ÿå ±å
async function quickRegister() {
  const v = document.getElementById('quick-register-input').value.trim();
  if (!/^\d+\+1$/.test(v)) {
    showAlert('quick-register-alert','error','æ ¼å¼éŒ¯èª¤ï¼šä¾‹ 001+1');
    return;
  }
  try {
    const res = await postJson({ action:'quickRegister', userId:liffProfile.userId, input:v });
    if (res.success) {
      showAlert('quick-register-alert','success','å ±åæˆåŠŸ');
      document.getElementById('quick-register-input').value = '';
      loadActivities();
    } else {
      showAlert('quick-register-alert','error',res.message||'å ±åå¤±æ•—');
    }
  } catch(e) {
    showAlert('quick-register-alert','error','ç¶²è·¯éŒ¯èª¤');
  }
}

// ä¸€èˆ¬ / åœ˜é«”å ±å
async function normalRegister() {
  const v = document.getElementById('normal-register-input').value.trim();
  if (!/^\d+\+.+/.test(v)) {
    showAlert('normal-register-alert','error','æ ¼å¼éŒ¯èª¤ï¼šä¾‹ 001+ç‹å°æ˜');
    return;
  }
  try {
    const res = await postJson({ action:'normalRegister', userId:liffProfile.userId, input:v });
    if (res.success) {
      showAlert('normal-register-alert','success','å ±åæˆåŠŸ');
      document.getElementById('normal-register-input').value = '';
      loadActivities();
    } else {
      showAlert('normal-register-alert','error',res.message||'å ±åå¤±æ•—');
    }
  } catch(e) {
    showAlert('normal-register-alert','error','ç¶²è·¯éŒ¯èª¤');
  }
}

// ææ¬¾ / æˆ‘çš„æ´»å‹•
async function loadDonations() {
  const loading = document.getElementById('donation-loading');
  const list = document.getElementById('donation-list');
  loading.classList.remove('hidden');
  list.classList.add('hidden');
  try {
    const res = await fetch(`${GAS_URL}?action=getUserDonations&userId=${encodeURIComponent(liffProfile.userId)}`);
    const data = await res.json();
    loading.classList.add('hidden');
    list.classList.remove('hidden');
    if (!Array.isArray(data) || !data.length) {
      list.innerHTML = '<p style="text-align:center;color:#666;">æš«ç„¡ææ¬¾è¨˜éŒ„</p>';
      return;
    }
    let total = 0;
    let html = '';
    data.forEach(d=>{
      total += d.amount||0;
      html += `<div class="activity-item">
        <div class="activity-header">
          <span class="activity-id">${d.id}</span>
          <span class="activity-status status-open">NT$ ${d.amount}</span>
        </div>
        <div style="font-weight:600;margin-bottom:4px;">${d.purpose||'æœªåˆ†é¡'}</div>
        <div>ğŸ“… æ—¥æœŸï¼š${formatDate(d.date)}</div>
        <div>ğŸ’³ æ–¹å¼ï¼š${d.method||'-'}</div>
        <div>æ”¶æ“šï¼š${d.receiptStatus||'-'}</div>
      </div>`;
    });
    list.innerHTML = `<div style="background:#e8f5e8;padding:12px;border-radius:10px;margin-bottom:14px;text-align:center;">
      <div style="color:#2e7d32;font-weight:600;">ç´¯è¨ˆææ¬¾</div>
      <div style="font-size:22px;font-weight:700;color:#2e7d32;">NT$ ${total.toLocaleString()}</div>
    </div>${html}`;
  } catch(e) {
    loading.textContent='è¼‰å…¥å¤±æ•—';
  }
}

async function loadMyActivities() {
  const loading = document.getElementById('myActivities-loading');
  const list = document.getElementById('myActivities-list');
  loading.classList.remove('hidden');
  list.classList.add('hidden');
  try {
    const res = await fetch(`${GAS_URL}?action=getUserActivities&userId=${encodeURIComponent(liffProfile.userId)}`);
    const data = await res.json();
    loading.classList.add('hidden');
    list.classList.remove('hidden');
    if (!Array.isArray(data) || !data.length) {
      list.innerHTML = '<p style="text-align:center;color:#666;">å°šç„¡åƒåŠ æ´»å‹•</p>';
      return;
    }
    list.innerHTML = data.map(a=> `
      <div class="activity-item">
        <div class="activity-header">
          <span class="activity-id">${a.activityId}</span>
          <span class="activity-status status-open">${a.status}</span>
        </div>
        <div style="font-weight:600;margin-bottom:4px;">${a.activityName}</div>
        <div>ğŸ“… æ—¥æœŸï¼š${formatDate(a.date)}</div>
        <div>ğŸ“ åœ°é»ï¼š${a.location}</div>
      </div>`).join('');
  } catch(e) {
    loading.textContent='è¼‰å…¥å¤±æ•—';
  }
}

// å·¥å…·
function formatDate(d) {
  if (!d) return '-';
  const dt = new Date(d);
  if (isNaN(dt.getTime())) return d;
  return dt.toLocaleString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
}
function getTypeName(t) {
  return ({member:'ä¸€èˆ¬æˆå“¡',volunteer:'å¿—å·¥',vip:'æœƒå“¡'})[t] || 'æœªè¨­å®š';
}

async function postJson(obj) {
  const res = await fetch(GAS_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' }, // é¿å… preflight
    body: JSON.stringify(obj)
  });
  const txt = await res.text();
  try { return JSON.parse(txt); } catch { return { success:false, message:'Invalid JSON' }; }
}

// ç•«é¢åˆ‡æ›
function showScreen(name) {
  const screens = ['main','registration','activities','profile','donations','myActivities'];
  screens.forEach(s=>{
    const el = document.getElementById(`${s}-screen`); if (el) el.classList.add('hidden');
  });
  const target = document.getElementById(`${name}-screen`);
  if (target) target.classList.remove('hidden');

  // nav active
  document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
  const nav = document.querySelector(`.nav-item[data-target="${name}"]`);
  if (nav) nav.classList.add('active');

  if (name==='donations') loadDonations();
  if (name==='myActivities') loadMyActivities();
  if (name==='activities') loadActivities();
  if (name==='profile') renderProfileDetails();
  if (name==='main') updateProfileUI();
}

function openHelp() {
  liff.openWindow({ url:'https://lch2988.github.io/PDA/help.html', external:true });
}

function placeholder(label) {
  alert(label + ' åŠŸèƒ½é–‹ç™¼ä¸­');
}

window.addEventListener('load', initLiff);
</script>
</body>
</html>
