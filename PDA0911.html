<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>帕金森病友會｜整合系統 前端</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg:#f7f9fb; --card:#ffffff; --primary:#2563eb; --primary-hover:#1d4ed8;
      --border:#dbe1e8; --danger:#dc2626; --warn:#f59e0b; --ok:#059669;
      --text:#1f2937; --muted:#6b7280; --radius:8px;
      --mono:ui-monospace, SFMono-Regular, Menlo, Consolas,"Liberation Mono", monospace;
    }
    body { margin:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:var(--bg); color:var(--text); }
    header { background:var(--primary); color:#fff; padding:10px 16px; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    header h1 { font-size:18px; margin:4px 0; }
    #statusBar { font-size:12px; opacity:.9; }
    a { color:var(--primary); text-decoration:none; }
    a:hover { text-decoration:underline; }
    .container { max-width:1200px; margin:0 auto; padding:12px 16px 40px; }
    .flex { display:flex; } .gap { gap:12px; } .wrap { flex-wrap:wrap; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:0 1px 2px rgba(0,0,0,0.05); margin-bottom:16px; }
    .card h2, .card h3 { margin-top:0; font-size:16px; border-left:4px solid var(--primary); padding-left:8px; }
    .row { display:flex; flex-wrap:wrap; gap:12px; }
    .col { flex:1 1 300px; }
    label { display:flex; flex-direction:column; font-size:13px; gap:4px; }
    input[type=text], input[type=number], input[type=date], textarea, select {
      border:1px solid var(--border); background:#fff; font:inherit; padding:6px 8px; border-radius:4px; width:100%; box-sizing:border-box;
    }
    textarea { min-height:80px; resize:vertical; }
    button { background:var(--primary); color:#fff; border:none; padding:8px 14px; border-radius:4px; font:inherit; cursor:pointer; display:inline-flex; align-items:center; gap:6px; }
    button:hover { background:var(--primary-hover); }
    button.outline { background:transparent; color:var(--primary); border:1px solid var(--primary); }
    button.outline:hover { background:var(--primary); color:#fff; }
    .danger { background:var(--danger); } .danger:hover { background:#b91c1c; }
    .muted { color:var(--muted); font-size:12px; }
    .badge { display:inline-block; background:#e5efff; color:#1d4ed8; padding:2px 6px; border-radius:12px; font-size:11px; margin-right:4px; }
    pre, code { font-family:var(--mono); font-size:12px; background:#f0f3f7; padding:8px; border-radius:4px; overflow:auto; line-height:1.45; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:6px 8px; border:1px solid var(--border); vertical-align:top; }
    th { background:#f1f5f9; text-align:left; }
    .tabs { display:flex; gap:4px; flex-wrap:wrap; margin-bottom:12px; }
    .tabs button { background:#e2e8f0; color:#1f2937; border:1px solid #cbd5e1; padding:6px 12px; border-radius:20px; font-size:13px; }
    .tabs button.active { background:var(--primary); color:#fff; border-color:var(--primary); }
    .hidden { display:none !important; }
    .scroll-x { overflow-x:auto; }
    .footer { text-align:center; font-size:12px; padding:40px 0 10px; color:var(--muted); }
    .admin-only { border:1px dashed var(--warn); }
    .grid-2 { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px; }
    .warn { color:var(--warn); } .ok { color:var(--ok); }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <h1>帕金森病友會 整合系統 前端</h1>
  <div id="statusBar">等待設定...</div>
</header>

<div class="container">
  <!-- 設定 / 登入 -->
  <div class="card" id="initCard">
    <h2>連線設定 / 使用者登入</h2>
    <div class="row">
      <div class="col">
        <label>
          API 網址（固定）
          <input type="text" id="apiBase" readonly />
          <label style="font-size:11px; display:flex;align-items:center;gap:4px;margin-top:4px;">
            <input type="checkbox" id="chkEditable" style="width:auto;"> 允許修改（測試用）
          </label>
        </label>
      </div>
      <div class="col">
        <label>
          API_KEY（不儲存；用於簽章）
          <input type="text" id="apiKeyInput" placeholder="輸入後方可呼叫保護 API" />
        </label>
      </div>
      <div class="col">
        <label>
          手動 userId（若未 LIFF 登入）
          <input type="text" id="manualUserId" placeholder="Uxxxxxxxx" />
        </label>
      </div>
      <div class="col">
        <label>
          顯示名稱（手動/覆蓋）
          <input type="text" id="manualDisplayName" placeholder="顯示名稱" />
        </label>
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <div class="col">
        <button id="btnInit">初始化 / 健康檢查</button>
        <button class="outline" id="btnFetchProfile">重新取得 LIFF Profile</button>
        <button class="outline" id="btnLogoutLiff">LIFF 登出</button>
      </div>
      <div class="col">
        <div class="muted">
          注意：前端輸入 API_KEY 僅供測試，正式上線建議後端簽章代理或短效 Token。
        </div>
      </div>
    </div>
    <pre id="initLog" style="margin-top:12px; max-height:150px;"></pre>
  </div>

  <!-- Tabs -->
  <div class="tabs" id="mainTabs"></div>

  <!-- 會員 -->
  <div class="card tab-panel" data-tab="member">
    <h2>會員 / 個人資料</h2>
    <div id="userInfoBox"></div>
    <hr />
    <h3>註冊帳號</h3>
    <div class="row">
      <div class="col">
        <label>真實姓名
          <input type="text" id="regRealName" />
        </label>
      </div>
      <div class="col">
        <label>會員類別
          <select id="regMemberType">
            <option value="member">member</option>
            <option value="volunteer">volunteer</option>
            <option value="vip">vip</option>
          </select>
        </label>
      </div>
      <div class="col">
        <button id="btnRegisterUser">送出註冊</button>
      </div>
    </div>
    <hr />
    <h3>更新聯絡資料</h3>
    <div class="grid-2">
      <label>電話 <input type="text" id="updPhone"></label>
      <label>Email <input type="text" id="updEmail"></label>
      <label>地址 <input type="text" id="updAddress"></label>
      <label>生日 <input type="date" id="updBirthday"></label>
    </div>
    <div style="margin-top:8px;">
      <button id="btnUpdateContact">更新聯絡資料</button>
    </div>
  </div>

  <!-- 活動 -->
  <div class="card tab-panel" data-tab="activities">
    <h2>活動列表 / 報名</h2>
    <button id="btnLoadActivities">載入活動</button>
    <div class="scroll-x" style="margin-top:8px;">
      <table id="activitiesTable">
        <thead>
          <tr><th>ID</th><th>名稱</th><th>日期</th><th>地點</th><th>截止</th><th>報名</th><th>操作</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <hr />
    <h3>快速/一般報名指令文字</h3>
    <p class="muted">快速：活動編號+1；一般：活動編號+姓名(+姓名)。</p>
    <div class="row">
      <div class="col">
        <label>報名輸入字串
          <input type="text" id="regInput" placeholder="例如：5+1 或 5+王小明+張三" />
        </label>
      </div>
      <div class="col">
        <button id="btnSubmitRegister">送出報名</button>
      </div>
    </div>
    <pre id="activityLog"></pre>
  </div>

  <!-- 我的活動 -->
  <div class="card tab-panel" data-tab="myActivities">
    <h2>我的活動</h2>
    <button id="btnLoadMyActivities">載入我的活動</button>
    <div class="scroll-x" style="margin-top:8px;">
      <table id="myActivitiesTable">
        <thead><tr><th>活動ID</th><th>名稱</th><th>日期</th><th>地點</th><th>狀態</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- 捐款 -->
  <div class="card tab-panel" data-tab="donations">
    <h2>我的捐款紀錄</h2>
    <button id="btnLoadDonations">載入捐款</button>
    <div class="scroll-x" style="margin-top:8px;">
      <table id="donationsTable">
        <thead><tr><th>ID</th><th>金額</th><th>日期</th><th>方式</th><th>用途</th><th>收據</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- 活動回饋 -->
  <div class="card tab-panel" data-tab="feedback">
    <h2>活動回饋</h2>
    <div class="row">
      <div class="col"><label>活動編號 <input type="text" id="fbActivityId" /></label></div>
      <div class="col"><label>評分(1~5) <input type="number" id="fbRating" min="1" max="5" /></label></div>
      <div class="col"><label>意見 <input type="text" id="fbComment" placeholder="最多 300 字" /></label></div>
      <div class="col"><button id="btnSubmitFeedback">送出/更新回饋</button></div>
    </div>
    <hr />
    <h3>查看回饋</h3>
    <div class="row">
      <div class="col"><label>活動編號(可空) <input type="text" id="fbListActivityId" placeholder="例如：5" /></label></div>
      <div class="col"><label>summaryOnly
        <select id="fbSummaryOnly"><option value="true">true</option><option value="false" selected>false</option></select>
      </label></div>
      <div class="col"><label>limit <input type="number" id="fbLimit" value="50" /></label></div>
      <div class="col"><button id="btnGetFeedback">取得回饋</button></div>
    </div>
    <pre id="feedbackResult"></pre>
  </div>

  <!-- 財務 -->
  <div class="card tab-panel" data-tab="finance">
    <h2>財務總覽</h2>
    <div class="row">
      <div class="col">
        <button id="btnLoadAccounts">帳戶餘額</button>
        <pre id="accountsBox"></pre>
      </div>
      <div class="col">
        <button id="btnLoadBudgets">預算使用</button>
        <pre id="budgetsBox"></pre>
      </div>
    </div>
    <hr />
    <h3>月度財報</h3>
    <div class="row">
      <div class="col"><label>年份 <input type="number" id="reportYear" value="2024" /></label></div>
      <div class="col"><label>月份 <input type="number" id="reportMonth" value="9" min="1" max="12" /></label></div>
      <div class="col"><button id="btnGetFinanceReport">取得財報</button></div>
    </div>
    <pre id="financeReportBox"></pre>
  </div>

  <!-- 支出 -->
  <div class="card tab-panel" data-tab="expense">
    <h2>支出管理（個人）</h2>
    <h3>新增支出</h3>
    <div class="grid-2">
      <label>類別<input type="text" id="expCategory" value="activity" /></label>
      <label>金額<input type="number" id="expAmount" value="500" /></label>
      <label>描述<input type="text" id="expDesc" value="測試支出" /></label>
      <label>付款方式<input type="text" id="expPayMethod" placeholder="轉帳/現金" /></label>
      <label>收款對象<input type="text" id="expRecipient" placeholder="商家/個人" /></label>
    </div>
    <div style="margin-top:8px;"><button id="btnAddExpense">新增支出</button></div>
    <hr />
    <h3>我的支出列表</h3>
    <div class="row">
      <div class="col"><label>狀態(all/待審核/已核准/已拒絕/已付款)<input type="text" id="expStatusFilter" value="all" /></label></div>
      <div class="col"><button id="btnLoadMyExpenses">載入</button></div>
    </div>
    <div class="scroll-x" style="margin-top:8px;">
      <table id="expenseTable">
        <thead><tr><th>ID</th><th>類別</th><th>金額</th><th>描述</th><th>狀態</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- 管理員 -->
  <div class="card tab-panel admin-only" data-tab="admin">
    <h2>管理員工具</h2>
    <h3>會員類別調整</h3>
    <div class="row">
      <div class="col"><label>目標 lineId <input type="text" id="admTargetLineId" /></label></div>
      <div class="col"><label>新會員類別 <input type="text" id="admNewMemberType" placeholder="vip" /></label></div>
      <div class="col"><label>備註 <input type="text" id="admNote" placeholder="調整原因" /></label></div>
      <div class="col"><button id="btnUpdateMemberType">更新類別</button></div>
    </div>
    <hr />
    <h3>全部會員 (分頁搜尋)</h3>
    <div class="grid-2">
      <label>頁碼 <input type="number" id="allUsersPage" value="1" /></label>
      <label>每頁 <input type="number" id="allUsersSize" value="20" /></label>
      <label>關鍵字 <input type="text" id="allUsersKeyword" /></label>
      <label>會員類別 <input type="text" id="allUsersMemberType" placeholder="member" /></label>
      <label>狀態 <input type="text" id="allUsersStatus" placeholder="已註冊" /></label>
    </div>
    <div style="margin-top:8px;"><button id="btnGetAllUsers">搜尋會員</button></div>
    <pre id="allUsersResult" style="max-height:200px;"></pre>
    <hr />
    <h3>支出審核</h3>
    <div class="row">
      <div class="col"><label>支出編號 <input type="text" id="approveExpenseId" placeholder="EXP..." /></label></div>
      <div class="col"><label>決定
        <select id="approveDecision"><option value="agree">同意</option><option value="reject">拒絕</option></select>
      </label></div>
      <div class="col"><label>備註 <input type="text" id="approveNote" /></label></div>
      <div class="col"><button id="btnApproveExpense">送出審核</button></div>
    </div>
    <hr />
    <h3>回饋統計（可留空活動 ID 取全部）</h3>
    <div class="row">
      <div class="col"><label>活動編號 <input type="text" id="admFeedbackActivityId" placeholder="可空" /></label></div>
      <div class="col"><label>summaryOnly
        <select id="admFbSummaryOnly"><option value="true" selected>true</option><option value="false">false</option></select>
      </label></div>
      <div class="col"><label>limit <input type="number" id="admFbLimit" value="50" /></label></div>
      <div class="col"><button id="btnAdminGetFeedback">取得回饋統計</button></div>
    </div>
    <pre id="adminFeedbackBox"></pre>
  </div>

  <div class="footer">
    前端示範版（單檔） | 請勿於正式環境暴露 API_KEY | © 2024
  </div>
</div>

<script>
  /******************** 固定常數（你提供） ********************/
  const LIFF_ID   = '1656516134-VaGgmaPm';
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwSgVu53XkX2fLpSvIB2rNrQH1ssnI2v47rBWEr33__p91QX0x-qg14i3yDJy6cPDmv/exec';
  const ADMIN_IDS = ['U09b4c2535730fbb5643274ba1526ec9c','ADMIN_LINE_ID_2'];

  /******************** 全域狀態 ********************/
  const state = {
    apiBase: WEBAPP_URL,
    apiKey: '',
    userId: '',
    displayName: '',
    userInfo: null,
    isAdmin: false
  };

  /******************** DOM 快取 ********************/
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const statusBar = $("#statusBar");
  const initLog   = $("#initLog");

  /******************** 工具 ********************/
  function logInit(msg){
    initLog.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    initLog.scrollTop = initLog.scrollHeight;
  }
  function setStatus(msg){ statusBar.textContent = msg; }
  function prettify(o){ return JSON.stringify(o,null,2); }
  function randomNonce(len=16){
    const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
    return s;
  }

  /******************** HMAC 簽章 (Web Crypto) ********************/
  let _cachedKey=null;
  async function getCryptoKey(secret){
    if(_cachedKey && _cachedKey.__raw===secret) return _cachedKey;
    const enc=new TextEncoder();
    const key=await crypto.subtle.importKey('raw',enc.encode(secret),{name:'HMAC',hash:'SHA-256'},false,['sign']);
    key.__raw=secret; _cachedKey=key; return key;
  }
  async function hmacSha256Hex(secret,data){
    const key=await getCryptoKey(secret);
    const enc=new TextEncoder();
    const sig=await crypto.subtle.sign('HMAC',key,enc.encode(data));
    return Array.from(new Uint8Array(sig)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  /******************** API 呼叫（自動簽章） ********************/
  async function callApi(action, payload={}){
    if(!state.apiBase) throw new Error('未設定 API 網址');
    const ts=Date.now();
    const nonce=randomNonce();
    if(!state.apiKey) throw new Error('未輸入 API_KEY');
    const base=action+'|'+ts+'|'+nonce+'|'+state.apiKey;
    const sign=await hmacSha256Hex(state.apiKey, base);
    const body={ action, ts, nonce, sign, ...payload };
    const res=await fetch(state.apiBase,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  }

  /******************** Tabs ********************/
  const tabsConfig = [
    { id:'member', label:'會員資料' },
    { id:'activities', label:'活動列表' },
    { id:'myActivities', label:'我的活動' },
    { id:'donations', label:'捐款' },
    { id:'feedback', label:'活動回饋' },
    { id:'finance', label:'財務' },
    { id:'expense', label:'支出' },
    { id:'admin', label:'管理', admin:true }
  ];
  function renderTabs(){
    const bar=$("#mainTabs");
    bar.innerHTML='';
    tabsConfig.forEach(t=>{
      if(t.admin && !state.isAdmin) return;
      const btn=document.createElement('button');
      btn.textContent=t.label;
      btn.dataset.tab=t.id;
      btn.addEventListener('click',()=>activateTab(t.id));
      bar.appendChild(btn);
    });
    const first=bar.querySelector('button');
    if(first) first.classList.add('active');
    activateTab(first?first.dataset.tab:'member');
  }
  function activateTab(id){
    $$('.tabs button').forEach(b=> b.classList.toggle('active', b.dataset.tab===id));
    $$('.tab-panel').forEach(p=> p.classList.toggle('hidden', p.dataset.tab!==id));
  }

  /******************** 使用者資訊 ********************/
  async function loadUserInfo(){
    if(!state.userId) return;
    try{
      const r=await callApi('getUserInfo',{ userId:state.userId });
      if(r.error){
        $("#userInfoBox").innerHTML='<p class="warn">尚未建立或錯誤：'+r.error+'</p>';
        return;
      }
      state.userInfo=r;
      state.isAdmin = ADMIN_IDS.includes(state.userId);
      renderTabs();
      $("#userInfoBox").innerHTML=`
        <div>
          <div><strong>lineId：</strong>${r.lineId}</div>
          <div><strong>LINE名稱：</strong>${r.lineName||''}</div>
          <div><strong>真實姓名：</strong>${r.realName||''}</div>
          <div><strong>狀態：</strong>${r.status||''}</div>
          <div><strong>會員類別：</strong>${r.memberType||''}</div>
          <div><strong>電話：</strong>${r.phone||''}</div>
          <div><strong>Email：</strong>${r.email||''}</div>
          <div><strong>地址：</strong>${r.address||''}</div>
          <div><strong>生日：</strong>${r.birthday||''}</div>
          ${state.isAdmin ? '<div class="badge">ADMIN</div>' : ''}
        </div>`;
    }catch(err){
      $("#userInfoBox").innerHTML='<p class="warn">取得使用者資訊失敗：'+err.message+'</p>';
    }
  }

  /******************** 初始化流程 ********************/
  async function doInit(){
    state.apiKey = $("#apiKeyInput").value.trim();
    if(!state.apiBase){
      logInit('API Base 缺失');
      return;
    }
    await initLIFFSafe();
    if(!state.userId){
      state.userId = $("#manualUserId").value.trim();
      state.displayName = $("#manualDisplayName").value.trim();
    }
    if(!state.userId){
      logInit('尚未有 userId，請手動填寫或使用 LIFF。');
      return;
    }
    try{
      const r=await callApi('createUserIfNotExist',{ userId:state.userId, displayName:state.displayName });
      logInit('createUserIfNotExist='+JSON.stringify(r));
    }catch(e){
      logInit('createUserIfNotExist 失敗:'+e.message);
    }
    try{
      const health=await fetch(state.apiBase+'?action=healthCheck').then(r=>r.json());
      logInit('healthCheck='+JSON.stringify(health));
    }catch(err){
      logInit('healthCheck 失敗:'+err.message);
    }
    await loadUserInfo();
    setStatus('初始化完成 userId='+state.userId);
  }

  /******************** LIFF ********************/
  async function initLIFFSafe(){
    if(!LIFF_ID){
      logInit('未設定 LIFF_ID，可使用手動模式。');
      return;
    }
    try{
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()){
        liff.login();
        return;
      }
      const profile=await liff.getProfile();
      state.userId=profile.userId;
      state.displayName=profile.displayName;
      $("#manualUserId").value=state.userId;
      $("#manualDisplayName").value=state.displayName;
      logInit('LIFF 取得 userId='+state.userId);
    }catch(err){
      logInit('LIFF 初始化失敗：'+err.message);
    }
  }

  $("#btnFetchProfile").addEventListener('click', async ()=>{
    await initLIFFSafe();
    await loadUserInfo();
  });
  $("#btnLogoutLiff").addEventListener('click', ()=>{
    if(window.liff && liff.isLoggedIn()){
      liff.logout();
      location.reload();
    }
  });
  $("#chkEditable").addEventListener('change', e=>{
    $("#apiBase").readOnly = !e.target.checked;
  });

  $("#btnInit").addEventListener('click', doInit);

  /******************** 註冊 ********************/
  $("#btnRegisterUser").addEventListener('click', async ()=>{
    try{
      const realName=$("#regRealName").value.trim();
      const memberType=$("#regMemberType").value;
      const r=await callApi('register',{ userId:state.userId, realName, memberType });
      alert(r.success?'註冊成功':'失敗：'+r.message);
      await loadUserInfo();
    }catch(err){ alert('註冊失敗：'+err.message); }
  });

  /******************** 更新聯絡 ********************/
  $("#btnUpdateContact").addEventListener('click', async ()=>{
    try{
      const r=await callApi('updateUserContact',{
        operatorLineId:state.userId,
        targetLineId:state.userId,
        phone:$("#updPhone").value.trim(),
        email:$("#updEmail").value.trim(),
          address:$("#updAddress").value.trim(),
        birthday:$("#updBirthday").value
      });
      alert(r.success?'更新成功':'失敗：'+r.message);
      if(r.success) await loadUserInfo();
    }catch(e){ alert('更新失敗：'+e.message); }
  });

  /******************** 活動 ********************/
  $("#btnLoadActivities").addEventListener('click', loadActivities);
  async function loadActivities(){
    const tbody=$("#activitiesTable tbody");
    tbody.innerHTML='<tr><td colspan="7">載入中...</td></tr>';
    try{
      const r=await callApi('getActivities',{});
      const list=Array.isArray(r)?r:[];
      if(!list.length){ tbody.innerHTML='<tr><td colspan="7">尚無活動</td></tr>'; return; }
      tbody.innerHTML=list.map(a=>`
        <tr>
          <td>${a.id}</td><td>${a.name||''}</td><td>${a.date||''}</td><td>${a.location||''}</td>
          <td>${a.deadline||''}</td><td>${a.currentParticipants||0}/${a.maxParticipants||'-'}</td>
          <td>
            <button data-act="${a.id}" class="btnQuick">快速+1</button>
            <button data-act="${a.id}" class="btnNormal">一般報名</button>
          </td>
        </tr>`).join('');
      tbody.querySelectorAll('.btnQuick').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const rr=await callApi('quickRegister',{ userId:state.userId, input: b.dataset.act + '+1' });
          alert(rr.success?'快速報名成功':'失敗：'+rr.message);
        });
      });
      tbody.querySelectorAll('.btnNormal').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const nm=prompt('輸入姓名(可 + 多人)','');
          if(!nm) return;
          const rr=await callApi('normalRegister',{ userId:state.userId, input: b.dataset.act + '+' + nm });
          alert(rr.success?'報名成功':'失敗：'+rr.message);
        });
      });
    }catch(err){
      tbody.innerHTML='<tr><td colspan="7" class="warn">失敗：'+err.message+'</td></tr>';
    }
  }

  $("#btnSubmitRegister").addEventListener('click', async ()=>{
    const input=$("#regInput").value.trim();
    if(!input){ alert('請輸入'); return; }
    let action=/^\d+\+1$/.test(input)?'quickRegister':'normalRegister';
    try{
      const r=await callApi(action,{ userId:state.userId, input });
      $("#activityLog").textContent=prettify(r);
      alert(r.success?'成功':'失敗：'+r.message);
    }catch(e){
      alert('呼叫失敗：'+e.message);
    }
  });

  /******************** 我的活動 ********************/
  $("#btnLoadMyActivities").addEventListener('click', async ()=>{
    const tbody=$("#myActivitiesTable tbody");
    tbody.innerHTML='<tr><td colspan="5">載入中...</td></tr>';
    try{
      const r=await callApi('getUserActivities',{ userId:state.userId });
      if(!Array.isArray(r)||!r.length){ tbody.innerHTML='<tr><td colspan="5">尚無報名</td></tr>'; return; }
      tbody.innerHTML=r.map(i=>`
        <tr><td>${i.activityId}</td><td>${i.activityName||''}</td><td>${i.date||''}</td><td>${i.location||''}</td><td>${i.status||''}</td></tr>
      `).join('');
    }catch(e){
      tbody.innerHTML='<tr><td colspan="5" class="warn">失敗：'+e.message+'</td></tr>';
    }
  });

  /******************** 捐款 ********************/
  $("#btnLoadDonations").addEventListener('click', async ()=>{
    const tbody=$("#donationsTable tbody");
    tbody.innerHTML='<tr><td colspan="6">載入中...</td></tr>';
    try{
      const r=await callApi('getUserDonations',{ userId:state.userId });
      if(!Array.isArray(r)||!r.length){ tbody.innerHTML='<tr><td colspan="6">尚無紀錄</td></tr>'; return; }
      tbody.innerHTML=r.slice(-50).map(d=>`
        <tr><td>${d.id}</td><td>${d.amount}</td><td>${d.date||''}</td><td>${d.method||''}</td><td>${d.purpose||''}</td><td>${d.receiptStatus||''}</td></tr>
      `).join('');
    }catch(err){
      tbody.innerHTML='<tr><td colspan="6" class="warn">失敗：'+err.message+'</td></tr>';
    }
  });

  /******************** 活動回饋 ********************/
  $("#btnSubmitFeedback").addEventListener('click', async ()=>{
    const activityId=$("#fbActivityId").value.trim();
    const rating=$("#fbRating").value;
    const comment=$("#fbComment").value.trim();
    if(!activityId){ alert('需活動編號'); return; }
    try{
      const r=await callApi('submitActivityFeedback',{ lineId:state.userId, activityId, rating, comment });
      alert(r.success?'回饋已送出/更新':'失敗：'+r.message);
    }catch(e){
      alert('提交失敗：'+e.message);
    }
  });
  $("#btnGetFeedback").addEventListener('click', async ()=>{
    const activityId=$("#fbListActivityId").value.trim();
    const summaryOnly=$("#fbSummaryOnly").value==='true';
    const limit=Number($("#fbLimit").value||50);
    try{
      const r=await callApi('getActivityFeedback',{ operatorLineId:state.userId, activityId:activityId||undefined, summaryOnly, limit });
      $("#feedbackResult").textContent=prettify(r);
    }catch(e){
      $("#feedbackResult").textContent='失敗：'+e.message;
    }
  });

  /******************** 財務 ********************/
  $("#btnLoadAccounts").addEventListener('click', async ()=>{
    try{ const r=await callApi('getAccountBalance',{}); $("#accountsBox").textContent=prettify(r); }
    catch(e){ $("#accountsBox").textContent='失敗：'+e.message; }
  });
  $("#btnLoadBudgets").addEventListener('click', async ()=>{
    try{ const r=await callApi('getBudgetStatus',{}); $("#budgetsBox").textContent=prettify(r); }
    catch(e){ $("#budgetsBox").textContent='失敗：'+e.message; }
  });
  $("#btnGetFinanceReport").addEventListener('click', async ()=>{
    try{
      const year=$("#reportYear").value; const month=$("#reportMonth").value;
      const r=await callApi('getFinanceReport',{ year, month });
      $("#financeReportBox").textContent=prettify(r);
    }catch(e){ $("#financeReportBox").textContent='失敗：'+e.message; }
  });

  /******************** 支出 ********************/
  $("#btnAddExpense").addEventListener('click', async ()=>{
    try{
      const r=await callApi('addExpense',{
        category:$("#expCategory").value.trim(),
        description:$("#expDesc").value.trim(),
        amount:$("#expAmount").value,
        applicant:state.userInfo?.realName || state.displayName || '本人',
        applicantLineId:state.userId,
        paymentMethod:$("#expPayMethod").value.trim(),
        recipient:$("#expRecipient").value.trim()
      });
      alert(r.success?'新增成功：'+r.expenseId:'失敗：'+r.message);
    }catch(e){ alert('新增失敗：'+e.message); }
  });

  $("#btnLoadMyExpenses").addEventListener('click', async ()=>{
    const tbody=$("#expenseTable tbody");
    tbody.innerHTML='<tr><td colspan="5">載入中...</td></tr>';
    try{
      const status=$("#expStatusFilter").value.trim();
      const r=await callApi('getExpenseList',{ userId:state.userId, status });
      if(!r.expenses||!r.expenses.length){ tbody.innerHTML='<tr><td colspan="5">無資料</td></tr>'; return; }
      tbody.innerHTML=r.expenses.slice(-100).map(e=>`
        <tr><td>${e.id}</td><td>${e.categoryName||e.category}</td><td>${e.amount}</td><td>${e.description||''}</td><td>${e.status}</td></tr>
      `).join('');
    }catch(err){
      tbody.innerHTML='<tr><td colspan="5" class="warn">失敗：'+err.message+'</td></tr>';
    }
  });

  /******************** 管理員 ********************/
  $("#btnUpdateMemberType").addEventListener('click', async ()=>{
    if(!state.isAdmin) return alert('非管理員');
    try{
      const r=await callApi('updateMemberType',{
        operatorLineId:state.userId,
        targetLineId:$("#admTargetLineId").value.trim(),
        newMemberType:$("#admNewMemberType").value.trim(),
        note:$("#admNote").value.trim()
      });
      alert(r.success?'更新成功':'失敗：'+r.message);
    }catch(e){ alert('更新失敗：'+e.message); }
  });

  $("#btnGetAllUsers").addEventListener('click', async ()=>{
    if(!state.isAdmin) return alert('非管理員');
    try{
      const r=await callApi('getAllUsers',{
        operatorLineId:state.userId,
        page:Number($("#allUsersPage").value||1),
        pageSize:Number($("#allUsersSize").value||20),
        keyword:$("#allUsersKeyword").value.trim(),
        memberType:$("#allUsersMemberType").value.trim(),
        status:$("#allUsersStatus").value.trim()
      });
      $("#allUsersResult").textContent=prettify(r);
    }catch(e){ $("#allUsersResult").textContent='失敗：'+e.message; }
  });

  $("#btnApproveExpense").addEventListener('click', async ()=>{
    if(!state.isAdmin) return alert('非管理員');
    try{
      const approved=$("#approveDecision").value==='agree';
      const r=await callApi('approveExpense',{
        expenseId:$("#approveExpenseId").value.trim(),
        approverName:state.userInfo?.realName || '管理員',
        approved,
        note:$("#approveNote").value.trim(),
        operatorLineId:state.userId
      });
      alert(r.success?(approved?'已核准':'已拒絕'):'失敗：'+r.message);
    }catch(e){ alert('審核失敗：'+e.message); }
  });

  $("#btnAdminGetFeedback").addEventListener('click', async ()=>{
    if(!state.isAdmin) return alert('非管理員');
    try{
      const r=await callApi('getActivityFeedback',{
        operatorLineId:state.userId,
        activityId:$("#admFeedbackActivityId").value.trim()||undefined,
        summaryOnly:$("#admFbSummaryOnly").value==='true',
        limit:Number($("#admFbLimit").value||50)
      });
      $("#adminFeedbackBox").textContent=prettify(r);
    }catch(e){
      $("#adminFeedbackBox").textContent='失敗：'+e.message;
    }
  });

  /******************** 頁面啟動 ********************/
  (function start(){
    $("#apiBase").value = WEBAPP_URL;
    renderTabs();
    setStatus('請輸入 API_KEY 後按「初始化」。');
    logInit('已載入固定常數 LIFF_ID / WEBAPP_URL / ADMIN_IDS。');
  })();
</script>
</body>
</html>
