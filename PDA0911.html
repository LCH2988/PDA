<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友會 - 會員管理系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      
      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          color: #333;
      }
      
      .container {
          max-width: 400px;
          margin: 0 auto;
          padding: 20px;
      }
      
      .header {
          background: white;
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 20px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
          text-align: center;
      }
      
      .header h1 {
          color: #667eea;
          margin-bottom: 10px;
          font-size: 1.5em;
      }
      
      .card {
          background: white;
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 15px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      }
      
      .profile-section {
          display: none;
      }
      
      .profile-info {
          display: flex;
          align-items: center;
          margin-bottom: 15px;
      }
      
      .profile-pic {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          margin-right: 15px;
      }
      
      .profile-details h3 {
          color: #667eea;
          margin-bottom: 5px;
      }
      
      .status-badge {
          display: inline-block;
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 0.8em;
          font-weight: bold;
      }
      
      .status-registered {
          background: #e8f5e8;
          color: #2e7d32;
      }
      
      .status-unregistered {
          background: #fff3e0;
          color: #f57c00;
      }
      
      .menu-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          margin-top: 20px;
      }
      
      .menu-item {
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
          border: none;
          border-radius: 12px;
          padding: 20px;
          text-align: center;
          cursor: pointer;
          transition: transform 0.2s;
          text-decoration: none;
          display: flex;
          flex-direction: column;
          align-items: center;
      }
      
      .menu-item:hover {
          transform: translateY(-2px);
      }
      
      .menu-item.disabled {
          background: #ccc;
          cursor: not-allowed;
      }
      
      .menu-icon {
          font-size: 2em;
          margin-bottom: 10px;
      }
      
      .form-group {
          margin-bottom: 15px;
      }
      
      .form-group label {
          display: block;
          margin-bottom: 5px;
          font-weight: bold;
          color: #555;
      }
      
      .form-group input,
      .form-group select {
          width: 100%;
          padding: 12px;
          border: 2px solid #ddd;
          border-radius: 8px;
          font-size: 16px;
      }
      
      .btn {
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 16px;
          width: 100%;
          transition: opacity 0.2s;
      }
      
      .btn:hover {
          opacity: 0.9;
      }
      
      .btn:disabled {
          background: #ccc;
          cursor: not-allowed;
      }
      
      .activities-list {
          max-height: 400px;
          overflow-y: auto;
      }
      
      .activity-item {
          border: 1px solid #eee;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 10px;
          background: #f9f9f9;
      }
      
      .activity-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
      }
      
      .activity-id {
          background: #667eea;
          color: white;
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 0.8em;
      }
      
      .activity-status {
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 0.8em;
      }
      
      .status-open {
          background: #e8f5e8;
          color: #2e7d32;
      }
      
      .loading {
          text-align: center;
          padding: 20px;
          color: #666;
      }
      
      .hidden {
          display: none;
      }
      
      .back-btn {
          background: #f5f5f5;
          color: #333;
          border: 1px solid #ddd;
          padding: 8px 16px;
          border-radius: 6px;
          cursor: pointer;
          margin-bottom: 15px;
      }

      .alert {
          padding: 12px;
          border-radius: 8px;
          margin-bottom: 15px;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .alert-error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .stats-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
          margin-top: 15px;
      }

      .stat-item {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          text-align: center;
      }

      .stat-number {
          font-size: 1.5em;
          font-weight: bold;
          color: #667eea;
      }

      .stat-label {
          font-size: 0.9em;
          color: #666;
          margin-top: 5px;
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>🌟 台灣帕金森病友權益促進會</h1>
          <p>會員管理系統</p>
      </div>
      
      <!-- 主畫面 -->
      <div id="main-screen">
          <div class="card profile-section" id="profile-card">
              <div class="profile-info">
                  <img id="profile-pic" class="profile-pic" src="" alt="大頭照">
                  <div class="profile-details">
                      <h3 id="display-name">載入中...</h3>
                      <span id="status-badge" class="status-badge">載入中...</span>
                  </div>
              </div>
              <div id="user-stats" class="stats-grid"></div>
          </div>
          
          <div class="card">
              <h3>🏠 功能選單</h3>
              <div class="menu-grid">
                  <button class="menu-item" onclick="showRegistration()">
                      <div class="menu-icon">📝</div>
                      <div>實名登記</div>
                  </button>
                  <button class="menu-item" onclick="showActivities()">
                      <div class="menu-icon">📅</div>
                      <div>活動資訊</div>
                  </button>
                  <button class="menu-item" onclick="showProfile()">
                      <div class="menu-icon">👤</div>
                      <div>個人資料</div>
                  </button>
                  <button class="menu-item" id="volunteer-menu" onclick="showVolunteer()" style="display:none;">
                      <div class="menu-icon">🙋‍♀️</div>
                      <div>志工平台</div>
                  </button>
                  <button class="menu-item" id="member-menu" onclick="showMemberArea()" style="display:none;">
                      <div class="menu-icon">👑</div>
                      <div>會員專區</div>
                  </button>
                  <button class="menu-item" onclick="showHelp()">
                      <div class="menu-icon">❓</div>
                      <div>使用說明</div>
                  </button>
              </div>
          </div>
      </div>
      
      <!-- 實名登記畫面 -->
      <div id="registration-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">← 返回主畫面</button>
          <div class="card">
              <h3>📝 實名制登記</h3>
              <div id="registration-alert"></div>
              <form id="registration-form">
                  <div class="form-group">
                      <label for="real-name">真實姓名</label>
                      <input type="text" id="real-name" required placeholder="請輸入您的真實姓名">
                  </div>
                  <div class="form-group">
                      <label for="member-type">成員類別</label>
                      <select id="member-type" required>
                          <option value="">請選擇成員類別</option>
                          <option value="member">一般成員</option>
                          <option value="volunteer">志工</option>
                          <option value="vip">會員</option>
                      </select>
                  </div>
                  <button type="submit" class="btn" id="register-btn">完成登記</button>
              </form>
          </div>
      </div>
      
      <!-- 活動資訊畫面 -->
      <div id="activities-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">← 返回主畫面</button>
          <div class="card">
              <h3>📅 活動資訊</h3>
              <div id="activities-loading" class="loading">載入活動資訊中...</div>
              <div id="activities-list" class="activities-list hidden"></div>
          </div>
          
          <div class="card">
              <h3>🎯 快速報名</h3>
              <div id="quick-register-alert"></div>
              <div class="form-group">
                  <label for="quick-register">輸入活動編號 + 1 進行快速報名</label>
                  <input type="text" id="quick-register" placeholder="例如：001+1">
              </div>
              <button onclick="quickRegister()" class="btn">快速報名</button>
          </div>
          
          <div class="card">
              <h3>📋 一般/團體報名</h3>
              <div id="normal-register-alert"></div>
              <div class="form-group">
                  <label for="normal-register">活動編號 + 姓名（多人用+分隔）</label>
                  <input type="text" id="normal-register" placeholder="例如：001+王小明 或 001+王小明+李小華">
              </div>
              <button onclick="normalRegister()" class="btn">提交報名</button>
          </div>
      </div>
      
      <!-- 個人資料畫面 -->
      <div id="profile-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">← 返回主畫面</button>
          <div class="card">
              <h3>👤 個人資料</h3>
              <div id="profile-details"></div>
          </div>
      </div>
      
      <!-- 志工平台畫面 -->
      <div id="volunteer-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">← 返回主畫面</button>
          <div class="card">
              <h3>🙋‍♀️ 志工平台</h3>
              <div class="menu-grid">
                  <button class="menu-item" onclick="showVolunteerTasks()">
                      <div class="menu-icon">📋</div>
                      <div>志工任務</div>
                  </button>
                  <button class="menu-item" onclick="showVolunteerSchedule()">
                      <div class="menu-icon">📅</div>
                      <div>排班表</div>
                  </button>
                  <button class="menu-item" onclick="showVolunteerHours()">
                      <div class="menu-icon">⏰</div>
                      <div>服務時數</div>
                  </button>
                  <button class="menu-item" onclick="showVolunteerTraining()">
                      <div class="menu-icon">🎓</div>
                      <div>培訓課程</div>
                  </button>
              </div>
          </div>
      </div>
      
      <!-- 會員專區畫面 -->
      <div id="member-screen" class="hidden">
          <button class="back-btn" onclick="showMain()">← 返回主畫面</button>
          <div class="card">
              <h3>👑 會員專區</h3>
              <div class="menu-grid">
                  <button class="menu-item" onclick="showDonationRecord()">
                      <div class="menu-icon">💰</div>
                      <div>捐款記錄</div>
                  </button>
                  <button class="menu-item" onclick="showMyActivities()">
                      <div class="menu-icon">📝</div>
                      <div>我的活動</div>
                  </button>
                  <button class="menu-item" onclick="showPersonalStats()">
                      <div class="menu-icon">📊</div>
                      <div>個人統計</div>
                  </button>
                  <button class="menu-item" onclick="updatePersonalInfo()">
                      <div class="menu-icon">⚙️</div>
                      <div>資料維護</div>
                  </button>
              </div>
          </div>
      </div>

      <!-- 捐款記錄畫面 -->
      <div id="donation-screen" class="hidden">
          <button class="back-btn" onclick="showMemberArea()">← 返回會員專區</button>
          <div class="card">
              <h3>💰 捐款記錄</h3>
              <div id="donation-loading" class="loading">載入捐款記錄中...</div>
              <div id="donation-list" class="hidden"></div>
          </div>
      </div>

      <!-- 我的活動畫面 -->
      <div id="my-activities-screen" class="hidden">
          <button class="back-btn" onclick="showMemberArea()">← 返回會員專區</button>
          <div class="card">
              <h3>📝 我的活動</h3>
              <div id="my-activities-loading" class="loading">載入活動記錄中...</div>
              <div id="my-activities-list" class="hidden"></div>
          </div>
      </div>
  </div>

  <script>
      const LIFF_ID = '1656516134-VaGgmaPm';
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbw2pyyym3GdBK-1-SeekMxrqjVQnBBYqDBjMQ6msE2JNs6KXpoY-kICGL58XnnQK9OazQ/exec'; // 請替換為實際的 GAS Web App URL
      let userProfile = null;
      let userData = null;

      // 初始化LIFF
      async function initializeLiff() {
          try {
              await liff.init({ liffId: LIFF_ID });
              
              if (liff.isLoggedIn()) {
                  userProfile = await liff.getProfile();
                  await loadUserData();
                  updateUI();
              } else {
                  liff.login();
              }
          } catch (error) {
              console.error('LIFF初始化失敗:', error);
              showAlert('registration-alert', 'error', '系統初始化失敗，請重新整理頁面');
          }
      }

      // 載入使用者資料
      async function loadUserData() {
          try {
              const response = await fetch(`${GAS_URL}?action=getUserInfo&userId=${userProfile.userId}`);
              const result = await response.json();
              if (result.error) {
                  throw new Error(result.error);
              }
              userData = result;
          } catch (error) {
              console.error('載入使用者資料失敗:', error);
              userData = null;
          }
      }

      // 更新UI
      function updateUI() {
          if (userProfile) {
              document.getElementById('profile-pic').src = userProfile.pictureUrl;
              document.getElementById('display-name').textContent = userProfile.displayName;
              
              const statusBadge = document.getElementById('status-badge');
              const userStatsDiv = document.getElementById('user-stats');
              
              if (userData && userData.status === '已註冊') {
                  statusBadge.textContent = getTypeName(userData.memberType);
                  statusBadge.className = 'status-badge status-registered';
                  
                  // 顯示使用者統計
                  userStatsDiv.innerHTML = `
                      <div class="stat-item">
                          <div class="stat-number">${userData.messageCount}</div>
                          <div class="stat-label">發言次數</div>
                      </div>
                      <div class="stat-item">
                          <div class="stat-number">${Math.floor((new Date() - new Date(userData.firstTime)) / (1000 * 60 * 60 * 24))}</div>
                          <div class="stat-label">加入天數</div>
                      </div>
                  `;
                  
                  // 顯示對應的功能選單
                  if (userData.memberType === 'volunteer') {
                      document.getElementById('volunteer-menu').style.display = 'block';
                  } else if (userData.memberType === 'vip') {
                      document.getElementById('member-menu').style.display = 'block';
                  }
              } else {
                  statusBadge.textContent = '未完成登記';
                  statusBadge.className = 'status-badge status-unregistered';
                  userStatsDiv.innerHTML = '<p style="text-align: center; color: #666;">請先完成實名制登記</p>';
              }
              
              document.querySelector('.profile-section').style.display = 'block';
          }
      }

      // 顯示警告訊息
      function showAlert(containerId, type, message) {
          const container = document.getElementById(containerId);
          container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
          setTimeout(() => {
              container.innerHTML = '';
          }, 5000);
      }

      // 畫面切換函數
      function showMain() {
          hideAllScreens();
          document.getElementById('main-screen').classList.remove('hidden');
      }

      function showRegistration() {
          hideAllScreens();
          document.getElementById('registration-screen').classList.remove('hidden');
      }

      function showActivities() {
          hideAllScreens();
          document.getElementById('activities-screen').classList.remove('hidden');
          loadActivities();
      }

      function showProfile() {
          hideAllScreens();
          document.getElementById('profile-screen').classList.remove('hidden');
          loadProfileDetails();
      }

      function showVolunteer() {
          hideAllScreens();
          document.getElementById('volunteer-screen').classList.remove('hidden');
      }

      function showMemberArea() {
          hideAllScreens();
          document.getElementById('member-screen').classList.remove('hidden');
      }

      function showDonationRecord() {
          hideAllScreens();
          document.getElementById('donation-screen').classList.remove('hidden');
          loadDonationRecord();
      }

      function showMyActivities() {
          hideAllScreens();
          document.getElementById('my-activities-screen').classList.remove('hidden');
          loadMyActivities();
      }

      function hideAllScreens() {
          const screens = [
              'main-screen', 'registration-screen', 'activities-screen', 
              'profile-screen', 'volunteer-screen', 'member-screen',
              'donation-screen', 'my-activities-screen'
          ];
          screens.forEach(screen => {
              document.getElementById(screen).classList.add('hidden');
          });
      }

      // 實名登記處理
      document.getElementById('registration-form').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const realName = document.getElementById('real-name').value.trim();
          const memberType = document.getElementById('member-type').value;
          const registerBtn = document.getElementById('register-btn');
          
          if (!realName || !memberType) {
              showAlert('registration-alert', 'error', '請填寫完整資訊');
              return;
          }

          // 驗證姓名格式
          if (!/^[\u4e00-\u9fa5a-zA-Z\s]{2,10}$/.test(realName)) {
              showAlert('registration-alert', 'error', '姓名格式錯誤，請輸入2-10個中文或英文字元');
              return;
          }
          
          registerBtn.disabled = true;
          registerBtn.textContent = '登記中...';
          
          try {
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'register',
                      userId: userProfile.userId,
                      realName: realName,
                      memberType: memberType
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showAlert('registration-alert', 'success', '註冊成功！');
                  await loadUserData();
                  updateUI();
                  setTimeout(() => showMain(), 2000);
              } else {
                  showAlert('registration-alert', 'error', '註冊失敗：' + result.message);
              }
          } catch (error) {
              console.error('註冊失敗:', error);
              showAlert('registration-alert', 'error', '註冊失敗，請稍後再試');
          } finally {
              registerBtn.disabled = false;
              registerBtn.textContent = '完成登記';
          }
      });

      // 載入活動資訊
      async function loadActivities() {
          try {
              const response = await fetch(`${GAS_URL}?action=getActivities`);
              const result = await response.json();
              
              if (result.error) {
                  throw new Error(result.error);
              }
              
              const activities = result;
              
              document.getElementById('activities-loading').classList.add('hidden');
              const activitiesList = document.getElementById('activities-list');
              activitiesList.classList.remove('hidden');
              
              if (activities.length === 0) {
                  activitiesList.innerHTML = '<p style="text-align: center; color: #666;">目前沒有開放報名的活動</p>';
                  return;
              }
              
              let html = '';
              activities.forEach(activity => {
                  html += `
                      <div class="activity-item">
                          <div class="activity-header">
                              <span class="activity-id">${activity.id}</span>
                              <span class="activity-status status-open">${activity.status}</span>
                          </div>
                          <h4>${activity.name}</h4>
                          <p>📍 地點：${activity.location}</p>
                          <p>📅 日期：${formatDate(activity.date)}</p>
                          <p>⏰ 報名截止：${formatDate(activity.deadline)}</p>
                          ${activity.maxParticipants ? `<p>👥 人數限制：${activity.currentParticipants || 0}/${activity.maxParticipants}</p>` : ''}
                      </div>
                  `;
              });
              
              activitiesList.innerHTML = html;
          } catch (error) {
              console.error('載入活動失敗:', error);
              document.getElementById('activities-loading').textContent = '載入失敗，請重新整理';
          }
      }

      // 快速報名
      async function quickRegister() {
          const input = document.getElementById('quick-register').value.trim();
          
          if (!input.match(/^\d+\+1$/)) {
              showAlert('quick-register-alert', 'error', '格式錯誤！請輸入：活動編號+1');
              return;
          }
          
          if (!userData || userData.status !== '已註冊') {
              showAlert('quick-register-alert', 'error', '請先完成實名制登記！');
              return;
          }
          
          try {
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'quickRegister',
                      userId: userProfile.userId,
                      input: input
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showAlert('quick-register-alert', 'success', `報名成功！活動：${result.activity ? result.activity.name : '未知活動'}`);
                  document.getElementById('quick-register').value = '';
                  loadActivities(); // 重新載入活動列表
              } else {
                  showAlert('quick-register-alert', 'error', '報名失敗：' + result.message);
              }
          } catch (error) {
              console.error('報名失敗:', error);
              showAlert('quick-register-alert', 'error', '報名失敗，請稍後再試');
          }
      }

      // 一般/團體報名
      async function normalRegister() {
          const input = document.getElementById('normal-register').value.trim();
          
          if (!input.match(/^\d+\+.+/)) {
              showAlert('normal-register-alert', 'error', '格式錯誤！請輸入：活動編號+姓名');
              return;
          }
          
          try {
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'normalRegister',
                      userId: userProfile.userId,
                      input: input
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  const names = result.names ? result.names.join('、') : '報名者';
                  showAlert('normal-register-alert', 'success', `報名成功！參加者：${names}`);
                  document.getElementById('normal-register').value = '';
                  loadActivities(); // 重新載入活動列表
              } else {
                  showAlert('normal-register-alert', 'error', '報名失敗：' + result.message);
              }
          } catch (error) {
              console.error('報名失敗:', error);
              showAlert('normal-register-alert', 'error', '報名失敗，請稍後再試');
          }
      }

      // 載入個人資料詳情
      function loadProfileDetails() {
          if (!userData) {
              document.getElementById('profile-details').innerHTML = '<p style="color: #666;">無法載入個人資料</p>';
              return;
          }
          
          let html = `
              <div style="margin-bottom: 15px;">
                  <strong>LINE名稱：</strong>${userProfile.displayName}
              </div>
          `;
          
          if (userData.status === '已註冊') {
              html += `
                  <div style="margin-bottom: 15px;">
                      <strong>真實姓名：</strong>${userData.realName}
                  </div>
                  <div style="margin-bottom: 15px;">
                      <strong>成員類別：</strong>${getTypeName(userData.memberType)}
                  </div>
              `;
          } else {
              html += `
                  <div style="margin-bottom: 15px; color: #f57c00;">
                      <strong>註冊狀態：</strong>未完成實名制登記
                  </div>
              `;
          }
          
          html += `
              <div style="margin-bottom: 15px;">
                  <strong>發言次數：</strong>${userData.messageCount}
              </div>
              <div style="margin-bottom: 15px;">
                  <strong>加入時間：</strong>${formatDateTime(userData.firstTime)}
              </div>
              <div style="margin-bottom: 15px;">
                  <strong>最後活動：</strong>${formatDateTime(userData.lastTime)}
              </div>
          `;
          
          document.getElementById('profile-details').innerHTML = html;
      }

      // 載入捐款記錄
      async function loadDonationRecord() {
          try {
              const response = await fetch(`${GAS_URL}?action=getUserDonations&userId=${userProfile.userId}`);
              const result = await response.json();
              
              if (result.error) {
                  throw new Error(result.error);
              }
              
              const donations = result;
              
              document.getElementById('donation-loading').classList.add('hidden');
              const donationList = document.getElementById('donation-list');
              donationList.classList.remove('hidden');
              
              if (donations.length === 0) {
                  donationList.innerHTML = '<p style="text-align: center; color: #666;">目前沒有捐款記錄</p>';
                  return;
              }

              let html = '';
              let totalAmount = 0;

              donations.forEach(donation => {
                  html += `
                      <div class="activity-item">
                          <div class="activity-header">
                              <span class="activity-id">$${donation.amount}</span>
                              <span class="activity-status status-open">${donation.receiptStatus}</span>
                          </div>
                          <p>📅 日期：${formatDate(donation.date)}</p>
                          <p>💳 方式：${donation.method}</p>
                          <p>🎯 用途：${donation.purpose}</p>
                          ${donation.receiptId ? `<p>📄 收據：${donation.receiptId}</p>` : ''}
                      </div>
                  `;
                  totalAmount += parseInt(donation.amount);
              });

              html = `<div class="stat-item" style="margin-bottom: 15px;">
                  <div class="stat-number">$${totalAmount.toLocaleString()}</div>
                  <div class="stat-label">累計捐款金額</div>
              </div>` + html;
              
              donationList.innerHTML = html;
          } catch (error) {
              console.error('載入捐款記錄失敗:', error);
              document.getElementById('donation-loading').textContent = '載入失敗，請重新整理';
          }
      }

      // 載入我的活動
      async function loadMyActivities() {
          try {
              const response = await fetch(`${GAS_URL}?action=getUserActivities&userId=${userProfile.userId}`);
              const result = await response.json();
              
              if (result.error) {
                  throw new Error(result.error);
              }
              
              const activities = result;
              
              document.getElementById('my-activities-loading').classList.add('hidden');
              const activitiesList = document.getElementById('my-activities-list');
              activitiesList.classList.remove('hidden');
              
              if (activities.length === 0) {
                  activitiesList.innerHTML = '<p style="text-align: center; color: #666;">目前沒有參加過的活動</p>';
                  return;
              }

              let html = '';
              activities.forEach(activity => {
                  html += `
                      <div class="activity-item">
                          <div class="activity-header">
                              <span class="activity-id">${activity.activityId}</span>
                              <span class="activity-status ${activity.status === '已簽到' ? 'status-open' : ''}">${activity.status}</span>
                          </div>
                          <h4>${activity.activityName}</h4>
                          <p>📍 地點：${activity.location}</p>
                          <p>📅 日期：${formatDate(activity.date)}</p>
                      </div>
                  `;
              });
              
              activitiesList.innerHTML = html;
          } catch (error) {
              console.error('載入我的活動失敗:', error);
              document.getElementById('my-activities-loading').textContent = '載入失敗，請重新整理';
          }
      }

      // 輔助函數
      function getTypeName(type) {
          const typeNames = {
              'member': '一般成員',
              'volunteer': '志工',
              'vip': '會員'
          };
          return typeNames[type] || '未設定';
      }

      function formatDate(dateString) {
          if (!dateString) return '未設定';
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW');
      }

      function formatDateTime(dateString) {
          if (!dateString) return '未設定';
          const date = new Date(dateString);
          return date.toLocaleString('zh-TW');
      }

      function showHelp() {
          const helpText = `📖 使用說明

📝 實名登記：
• 首次使用需完成實名制登記
• 選擇適合的成員類別

📅 活動報名：
• 快速報名：活動編號+1
• 一般報名：活動編號+姓名
• 團體報名：活動編號+姓名1+姓名2

🙋‍♀️ 志工功能：
• 志工專用的任務管理平台

👑 會員專區：
• 捐款記錄查詢
• 個人活動清單
• 資料維護功能

📞 如有問題請聯絡：02-12345678`;
          
          alert(helpText);
      }

      // 志工平台功能（示例）
      function showVolunteerTasks() {
          alert('志工任務功能開發中，敬請期待！');
      }

      function showVolunteerSchedule() {
          alert('排班表功能開發中，敬請期待！');
      }

      function showVolunteerHours() {
          alert('服務時數功能開發中，敬請期待！');
      }

      function showVolunteerTraining() {
          alert('培訓課程功能開發中，敬請期待！');
      }

      // 會員專區功能
      function showPersonalStats() {
          if (!userData || userData.status !== '已註冊') {
              alert('請先完成實名制登記！');
              return;
          }

          const joinDays = Math.floor((new Date() - new Date(userData.firstTime)) / (1000 * 60 * 60 * 24));
          const statsText = `📊 個人統計

👤 會員：${userData.realName}
🏷️ 類別：${getTypeName(userData.memberType)}
📅 加入天數：${joinDays} 天
💬 發言次數：${userData.messageCount} 次
⏰ 最後活動：${formatDateTime(userData.lastTime)}`;
          
          alert(statsText);
      }

      function updatePersonalInfo() {
          alert('資料維護功能開發中，如需更新個人資料請聯絡客服：02-12345678');
      }

      // 頁面載入時初始化
      window.addEventListener('load', initializeLiff);

      // 頁面可見性變化時重新載入資料
      document.addEventListener('visibilitychange', function() {
          if (!document.hidden && userProfile) {
              loadUserData().then(() => updateUI());
          }
      });
  </script>
</body>
</html>
