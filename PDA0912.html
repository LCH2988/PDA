<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>帕金森病友會｜會員・活動・財務整合</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <style>
    :root {
      --c-bg:#f7f7f9;
      --c-bg-alt:#ffffff;
      --c-primary:#0a6bd9;
      --c-primary-hover:#0c5fbf;
      --c-accent:#ff7a00;
      --c-border:#d9d9e0;
      --c-text:#1d1f23;
      --c-text-alt:#555;
      --c-danger:#d7263d;
      --c-ok:#118a39;
      --radius-s:4px;
      --radius-m:8px;
      --radius-l:14px;
      --shadow-sm:0 1px 2px rgba(0,0,0,.06);
      --shadow:0 4px 12px rgba(0,0,0,.08);
      --transition: .18s cubic-bezier(.4,.0,.2,1);
      --sidebar-w:240px;
      --font-size:16px;
      --line-height:1.5;
    }
    [data-font="lg"] {
      --font-size:18px;
    }
    [data-font="xl"] {
      --font-size:20px;
    }
    [data-contrast="high"] {
      --c-bg:#111;
      --c-bg-alt:#1c1c1e;
      --c-primary:#4da3ff;
      --c-primary-hover:#81c3ff;
      --c-accent:#ffc14d;
      --c-border:#444;
      --c-text:#f5f7fa;
      --c-text-alt:#c9d1d9;
      --c-danger:#ff4d4f;
      --c-ok:#34c759;
    }
    html,body {
      margin:0;
      padding:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif;
      font-size:var(--font-size);
      line-height:var(--line-height);
      background:var(--c-bg);
      color:var(--c-text);
      -webkit-font-smoothing: antialiased;
    }
    body {
      display:flex;
      min-height:100vh;
      overflow:hidden;
    }
    a { color:var(--c-primary); text-decoration:none; }
    a:hover { text-decoration:underline; }
    button {
      font:inherit;
      cursor:pointer;
    }
    h1,h2,h3 {
      margin:0 0 .5em;
      font-weight:600;
      line-height:1.2;
    }
    p { margin:0 0 .75em; }
    /* Sidebar */
    .sidebar {
      width:var(--sidebar-w);
      background:linear-gradient(180deg,var(--c-bg-alt),var(--c-bg) 90%);
      border-right:1px solid var(--c-border);
      display:flex;
      flex-direction:column;
      padding:14px 14px 18px;
      box-sizing:border-box;
      gap:10px;
    }
    .brand {
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:600;
      font-size:18px;
      padding:6px 10px 12px;
      letter-spacing:.5px;
    }
    .brand-badge {
      background:var(--c-primary);
      color:#fff;
      padding:2px 8px 3px;
      border-radius: var(--radius-s);
      font-size:12px;
      font-weight:500;
    }
    nav {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .nav-section-title {
      font-size:12px;
      letter-spacing:.5px;
      color:var(--c-text-alt);
      padding:10px 10px 4px;
      text-transform:uppercase;
    }
    .nav-item {
      border:1px solid transparent;
      background:transparent;
      color:var(--c-text);
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius: var(--radius-m);
      position:relative;
      font-weight:500;
      transition:var(--transition);
    }
    .nav-item:hover {
      background:var(--c-primary);
      color:#fff;
    }
    .nav-item.active {
      background:var(--c-primary);
      color:#fff;
      box-shadow:var(--shadow-sm);
    }
    .nav-item .badge {
      margin-left:auto;
      background:var(--c-accent);
      color:#fff;
      font-size:11px;
      padding:2px 6px 3px;
      border-radius: 10px;
      font-weight:600;
      letter-spacing:.5px;
    }
    .util-bar {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      padding:8px 2px;
      border-top:1px solid var(--c-border);
      margin-top:6px;
    }
    .chip {
      padding:5px 10px;
      background:var(--c-bg-alt);
      border:1px solid var(--c-border);
      border-radius: 999px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
      transition:var(--transition);
    }
    .chip:hover {
      background:var(--c-primary);
      color:#fff;
    }
    .chip.toggle-active {
      background:var(--c-primary);
      border-color:var(--c-primary);
      color:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,.12);
    }
    /* Main layout */
    .main {
      flex:1;
      display:flex;
      flex-direction:column;
      min-width:0;
      position:relative;
      overflow:hidden;
    }
    .topbar {
      height:58px;
      display:flex;
      align-items:center;
      padding:0 20px;
      gap:16px;
      background:var(--c-bg-alt);
      border-bottom:1px solid var(--c-border);
    }
    .topbar .title {
      font-size:17px;
      font-weight:600;
    }
    .grow { flex:1; }
    .user-pill {
      display:flex;
      align-items:center;
      gap:10px;
      background:var(--c-primary);
      color:#fff;
      padding:6px 14px;
      border-radius: 30px;
      font-size:14px;
      box-shadow:var(--shadow-sm);
    }
    .user-pill small {
      opacity:.8;
      font-weight:400;
      font-size:12px;
    }
    .status-dot {
      width:10px;
      height:10px;
      background:var(--c-ok);
      border-radius:50%;
      box-shadow:0 0 0 2px rgba(255,255,255,.6);
    }
    .content-wrapper {
      flex:1;
      overflow:auto;
      padding:24px clamp(16px,2.5vw,40px) 60px;
      position:relative;
    }
    .sections {
      display:none;
    }
    .sections.active {
      display:block;
      animation:fadeIn .35s;
    }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(8px); }
      to { opacity:1; transform:translateY(0); }
    }
    /* Cards */
    .cards-grid {
      display:grid;
      gap:18px;
    }
    @media (min-width:880px) {
      .cards-grid.cols-3 {
        grid-template-columns: repeat(3, 1fr);
      }
      .cards-grid.cols-2 {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    .card {
      background:var(--c-bg-alt);
      border:1px solid var(--c-border);
      border-radius: var(--radius-l);
      padding:18px 18px 20px;
      position:relative;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow:var(--shadow-sm);
      transition:var(--transition);
    }
    .card:hover {
      border-color:var(--c-primary);
      box-shadow:0 6px 18px -4px rgba(0,0,0,.12);
      transform:translateY(-2px);
    }
    .card.compact {
      padding:14px 16px 16px;
      gap:6px;
    }
    .card-header {
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .card-title {
      font-size:16px;
      font-weight:600;
      margin:0;
      flex:1;
    }
    .card-meta {
      font-size:12px;
      color:var(--c-text-alt);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .divider {
      height:1px;
      background:var(--c-border);
      margin:4px 0 8px;
    }
    .tag {
      font-size:11px;
      padding:2px 8px 3px;
      background:var(--c-primary);
      color:#fff;
      border-radius: 999px;
      letter-spacing:.5px;
      font-weight:500;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .tag.outline {
      background:transparent;
      color:var(--c-primary);
      border:1px solid var(--c-primary);
    }
    .tag.neutral {
      background:var(--c-text-alt);
    }
    .tag.danger {
      background:var(--c-danger);
    }
    .tag.accent {
      background:var(--c-accent);
    }
    .actions-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .btn {
      --btn-bg:var(--c-primary);
      --btn-color:#fff;
      --btn-border:var(--c-primary);
      font:inherit;
      border:1px solid var(--btn-border);
      background:var(--btn-bg);
      color:var(--btn-color);
      padding:8px 16px 9px;
      border-radius: var(--radius-m);
      font-weight:500;
      display:inline-flex;
      align-items:center;
      gap:6px;
      letter-spacing:.3px;
      position:relative;
      transition:var(--transition);
    }
    .btn:hover {
      filter:brightness(1.05);
      transform:translateY(-1px);
      box-shadow:0 4px 12px -3px rgba(0,0,0,.25);
    }
    .btn.outline {
      --btn-bg:transparent;
      --btn-color:var(--c-primary);
      --btn-border:var(--c-primary);
    }
    .btn.outline:hover {
      background:var(--c-primary);
      color:#fff;
    }
    .btn.ghost {
      --btn-bg:transparent;
      --btn-color:var(--c-text);
      --btn-border:var(--c-border);
    }
    .btn.ghost:hover {
      background:var(--c-primary);
      color:#fff;
      border-color:var(--c-primary);
    }
    .btn.danger {
      --btn-bg:var(--c-danger);
      --btn-border:var(--c-danger);
    }
    .btn.accent {
      --btn-bg:var(--c-accent);
      --btn-border:var(--c-accent);
    }
    .btn.small {
      padding:5px 12px 6px;
      font-size:13px;
    }
    .btn.full {
      width:100%;
      justify-content:center;
    }
    /* Lists / table style cards */
    .list {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .list-item {
      border:1px solid var(--c-border);
      border-radius: var(--radius-m);
      padding:12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:6px;
      background:var(--c-bg-alt);
      transition:var(--transition);
    }
    .list-item:hover {
      border-color:var(--c-primary);
      box-shadow:0 4px 14px -4px rgba(0,0,0,.16);
    }
    .list-item-head {
      display:flex;
      align-items:center;
      gap:12px;
      font-weight:600;
    }
    .list-item-body {
      font-size:13px;
      color:var(--c-text-alt);
      display:flex;
      flex-wrap:wrap;
      gap:12px;
    }
    /* Forms */
    .form-grid {
      display:grid;
      gap:18px;
    }
    @media (min-width:720px) {
      .form-grid.cols-2 {
        grid-template-columns: repeat(2,1fr);
      }
    }
    .field {
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label {
      font-size:13px;
      color:var(--c-text-alt);
      font-weight:500;
      letter-spacing:.5px;
    }
    .field input[type=text],
    .field input[type=date],
    .field input[type=number],
    .field input[type=password],
    .field select,
    .field textarea {
      border:1px solid var(--c-border);
      background:var(--c-bg-alt);
      color:var(--c-text);
      font:inherit;
      padding:10px 12px;
      border-radius: var(--radius-m);
      outline:none;
      transition:var(--transition);
      resize:vertical;
    }
    .field textarea { min-height:100px; }
    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color:var(--c-primary);
      box-shadow:0 0 0 2px rgba(10,107,217,.15);
    }
    .inline-note {
      font-size:12px;
      opacity:.65;
    }
    /* Status & empty */
    .empty {
      padding:30px 24px 34px;
      text-align:center;
      color:var(--c-text-alt);
      border:2px dashed var(--c-border);
      border-radius: var(--radius-l);
      background:linear-gradient(145deg,var(--c-bg-alt),var(--c-bg) 90%);
    }
    .metric-cards {
      display:grid;
      gap:18px;
    }
    @media (min-width:960px) {
      .metric-cards {
        grid-template-columns: repeat(4,1fr);
      }
    }
    .metric {
      background:var(--c-bg-alt);
      border:1px solid var(--c-border);
      border-radius: var(--radius-l);
      padding:16px 18px 18px;
      display:flex;
      flex-direction:column;
      gap:8px;
      position:relative;
      overflow:hidden;
    }
    .metric:before {
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(ellipse at top right,rgba(10,107,217,.18),transparent 60%);
      pointer-events:none;
    }
    .metric-label {
      font-size:12px;
      letter-spacing:.5px;
      text-transform:uppercase;
      color:var(--c-text-alt);
      font-weight:600;
    }
    .metric-value {
      font-size: clamp(26px,3.2vw,34px);
      font-weight:600;
      letter-spacing:1px;
    }
    .metric-sub {
      font-size:12px;
      color:var(--c-text-alt);
      font-weight:500;
    }
    /* Accessibility */
    .visually-hidden {
      position:absolute !important;
      width:1px !important;
      height:1px !important;
      padding:0 !important;
      margin:-1px !important;
      overflow:hidden !important;
      clip:rect(0 0 0 0) !important;
      white-space:nowrap !important;
      border:0 !important;
    }
    /* Toast / notification */
    .toast-container {
      position:fixed;
      right:18px;
      bottom:18px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:999;
      max-width:400px;
    }
    .toast {
      background:var(--c-bg-alt);
      border:1px solid var(--c-border);
      padding:14px 16px 16px;
      border-radius: var(--radius-m);
      box-shadow:0 8px 30px -8px rgba(0,0,0,.3);
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:14px;
      animation:slideIn .4s cubic-bezier(.4,0,.2,1);
      position:relative;
    }
    .toast.success { border-color:var(--c-ok); }
    .toast.error { border-color:var(--c-danger); }
    @keyframes slideIn {
      from { opacity:0; transform:translateY(10px) scale(.96); }
      to { opacity:1; transform:translateY(0) scale(1); }
    }
    .toast-close {
      position:absolute;
      top:6px;
      right:8px;
      background:transparent;
      border:none;
      font-size:16px;
      cursor:pointer;
      color:var(--c-text-alt);
    }
    .toast-close:hover { color:var(--c-text); }
    /* Modal (for首次設定) */
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(17,20,24,.42);
      backdrop-filter:blur(4px);
      display:none;
      align-items:flex-start;
      justify-content:center;
      overflow:auto;
      padding:60px 20px;
      z-index:400;
    }
    .modal-backdrop.active { display:flex; }
    .modal {
      max-width:520px;
      width:100%;
      background:var(--c-bg-alt);
      border:1px solid var(--c-border);
      border-radius: 20px;
      padding:30px 30px 40px;
      box-shadow:0 20px 50px -12px rgba(0,0,0,.35);
      display:flex;
      flex-direction:column;
      gap:24px;
      animation:pop .4s;
    }
    @keyframes pop {
      from { opacity:0; transform:translateY(20px) scale(.96); }
      to { opacity:1; transform:translateY(0) scale(1); }
    }
    .modal-header { display:flex; flex-direction:column; gap:4px; }
    .modal-header h2 { margin:0; font-size:22px; }
    .modal-footer {
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:10px;
    }
    .muted {
      font-size:12px;
      color:var(--c-text-alt);
      line-height:1.4;
    }
    /* Loader overlay */
    .global-loading {
      position:absolute;
      inset:0;
      pointer-events:none;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      transition:.3s;
    }
    .global-loading.active {
      pointer-events:auto;
      background:rgba(255,255,255,.45);
      backdrop-filter:blur(4px);
      opacity:1;
    }
    [data-contrast="high"] .global-loading.active {
      background:rgba(0,0,0,.55);
    }
    .spinner {
      width:54px;
      height:54px;
      border-radius:50%;
      border:5px solid var(--c-border);
      border-top-color: var(--c-primary);
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform:rotate(360deg); }
    }
    /* Responsive */
    .mobile-toggle {
      display:none;
    }
    @media (max-width:980px) {
      body {
        flex-direction:column;
        overflow:auto;
      }
      .sidebar {
        position:fixed;
        top:0;
        left:0;
        bottom:0;
        transform:translateX(-100%);
        z-index:500;
        transition:var(--transition);
        box-shadow:0 10px 40px -10px rgba(0,0,0,.4);
        background:linear-gradient(180deg,var(--c-bg-alt),var(--c-bg) 90%);
      }
      .sidebar.open {
        transform:translateX(0);
      }
      .main {
        min-height:100vh;
      }
      .mobile-toggle {
        display:inline-flex;
        padding:8px 12px;
        background:var(--c-primary);
        color:#fff;
        border-radius: var(--radius-m);
        border:none;
      }
    }
    /* Utilities */
    .fade {
      animation:fade .4s;
    }
    @keyframes fade {
      from { opacity:0; }
      to { opacity:1; }
    }
    .link-btn {
      background:transparent;
      border:none;
      color:var(--c-primary);
      font:inherit;
      cursor:pointer;
      padding:0;
    }
    .link-btn:hover { text-decoration:underline; }
    .hr {
      height:1px;
      background:var(--c-border);
      margin:18px 0;
    }
  </style>
</head>
<body data-font="md" data-contrast="normal">
  <!-- 側邊導覽 -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <span>帕金森病友會</span>
      <span class="brand-badge">整合平台</span>
    </div>
    <div class="nav-section">
      <div class="nav-section-title">主選單</div>
      <button class="nav-item active" data-route="home">
        <span>首頁</span>
      </button>
      <button class="nav-item" data-route="activities">
        <span>活動列表</span>
      </button>
      <button class="nav-item" data-route="myActivities">
        <span>我的活動</span>
      </button>
      <button class="nav-item" data-route="donations">
        <span>捐款紀錄</span>
      </button>
      <button class="nav-item" data-route="finance">
        <span>財務管理</span>
      </button>
      <button class="nav-item" data-route="profile">
        <span>個人資料</span>
      </button>
    </div>
    <div class="nav-section">
      <div class="nav-section-title">快速功能</div>
      <button class="nav-item" id="btnQuickRefresh">
        <span>重新同步資料</span>
      </button>
    </div>
    <div class="util-bar">
      <div class="chip" id="btnFontUp">A+</div>
      <div class="chip" id="btnContrast">高對比</div>
      <div class="chip" id="btnLogout">登出</div>
    </div>
  </aside>

  <!-- 主區 -->
  <main class="main">
    <div class="topbar">
      <button class="mobile-toggle" id="mobileMenu">選單</button>
      <div class="title" id="pageTitle">首頁</div>
      <div class="grow"></div>
      <div class="user-pill" id="userPill">
        <div class="status-dot" id="userStatusDot"></div>
        <div>
          <div id="pillDisplayName">未登入</div>
          <small id="pillUserId">--</small>
        </div>
      </div>
    </div>
    <div class="content-wrapper" id="contentWrapper">
      <!-- 首頁 -->
      <section class="sections active" id="page-home">
        <h1>會員・活動・財務 整合總覽</h1>
          <p id="welcomeLine" style="margin-top:-4px;">歡迎使用本平台。</p>
        <div class="cards-grid cols-3" style="margin-top:20px;" id="homeMetrics">
          <div class="metric">
            <div class="metric-label">即將參加</div>
            <div class="metric-value" id="m_upcomingCount">--</div>
            <div class="metric-sub">未來 30 天活動</div>
          </div>
          <div class="metric">
            <div class="metric-label">累計活動</div>
            <div class="metric-value" id="m_totalActivities">--</div>
            <div class="metric-sub">已報名</div>
          </div>
          <div class="metric">
            <div class="metric-label">累計捐款</div>
            <div class="metric-value" id="m_totalDonation">--</div>
            <div class="metric-sub">所有時間</div>
          </div>
          <div class="metric">
            <div class="metric-label">本年度捐款</div>
            <div class="metric-value" id="m_yearDonation">--</div>
            <div class="metric-sub" id="yearLabel"></div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">最新活動 (前 3 筆)</h3>
            <button class="btn ghost small" data-route="activities">查看更多</button>
          </div>
          <div id="homeLatestActivities" class="list"></div>
        </div>
      </section>
      <!-- 活動列表 -->
      <section class="sections" id="page-activities">
        <h2>活動列表</h2>
        <p class="inline-note">顯示可報名與進行中的活動。若有名額限制請儘早報名。</p>
        <div class="actions-row">
          <button class="btn small outline" id="btnReloadActivities">重新整理</button>
        </div>
        <div class="hr"></div>
        <div id="activitiesList" class="list"></div>
      </section>
      <!-- 我的活動 -->
      <section class="sections" id="page-myActivities">
        <h2>我的活動</h2>
        <p class="inline-note">顯示您已報名或已參加的活動。</p>
        <div class="actions-row">
          <button class="btn small outline" id="btnReloadMyActivities">重新整理</button>
        </div>
        <div class="hr"></div>
          <div id="myActivitiesList" class="list"></div>
      </section>
      <!-- 捐款紀錄 -->
      <section class="sections" id="page-donations">
        <h2>捐款紀錄</h2>
        <p class="inline-note">以下為您個人之捐款歷史。若需收據補印請聯繫管理單位。</p>
        <div class="actions-row">
          <button class="btn small outline" id="btnReloadDonations">重新整理</button>
        </div>
        <div class="hr"></div>
        <div id="donationsList" class="list"></div>
      </section>
      <!-- 財務管理 -->
      <section class="sections" id="page-finance">
        <h2>財務管理</h2>
        <p class="inline-note">顯示財務摘要與關鍵指標。僅供內部參考。</p>
        <div class="actions-row">
          <button class="btn small outline" id="btnReloadFinance">更新摘要</button>
        </div>
        <div class="hr"></div>
        <div id="financeSummary" class="cards-grid cols-2"></div>
        <div class="hr"></div>
        <div class="card compact">
          <div class="card-header">
            <h3 class="card-title">本期摘要</h3>
          </div>
          <div id="financeExtra"></div>
        </div>
      </section>
      <!-- 個人資料 -->
      <section class="sections" id="page-profile">
        <h2>個人資料</h2>
        <p class="inline-note">請確認資訊是否正確，更新後點「儲存」。</p>
        <form id="formProfile">
          <div class="form-grid cols-2">
            <div class="field">
              <label>使用者 ID</label>
              <input type="text" id="pfUserId" readonly>
            </div>
            <div class="field">
              <label>姓名 / 暱稱</label>
              <input type="text" id="pfDisplayName" autocomplete="name">
            </div>
            <div class="field">
              <label>Email</label>
              <input type="text" id="pfEmail" autocomplete="email">
            </div>
            <div class="field">
              <label>聯絡電話</label>
              <input type="text" id="pfPhone" autocomplete="tel">
            </div>
            <div class="field">
              <label>生日</label>
              <input type="date" id="pfBirthday">
            </div>
            <div class="field">
              <label>地址</label>
              <input type="text" id="pfAddress" autocomplete="street-address">
            </div>
            <div class="field" style="grid-column:1 / -1;">
              <label>備註 / 健康資訊（僅內部）</label>
              <textarea id="pfNotes" placeholder="（可留空）"></textarea>
            </div>
          </div>
          <div class="actions-row" style="margin-top:14px;">
            <button class="btn" type="submit">儲存資料</button>
            <button class="btn ghost" type="button" id="btnReloadProfile">重新載入</button>
          </div>
        </form>
      </section>
    </div>
    <div class="global-loading" id="globalLoading">
      <div class="spinner"></div>
    </div>
  </main>

  <!-- 初次設定 / 登入 -->
  <div class="modal-backdrop active" id="initModal">
    <div class="modal">
      <div class="modal-header">
        <h2>初始化設定</h2>
        <p class="muted" style="margin:0;">請輸入後端 API 位置與 API_KEY。此資訊僅儲存在您的瀏覽器。</p>
      </div>
      <div class="form-grid">
        <div class="field">
          <label>API Base URL (GAS Web App /exec)</label>
          <input type="text" id="inApiBase" placeholder="https://script.google.com/macros/s/XXXX/exec">
        </div>
        <div class="field">
          <label>API_KEY</label>
          <input type="text" id="inApiKey" placeholder="請輸入後端設定的 API_KEY">
        </div>
        <div class="field">
          <label>使用者 ID (若未透過 LINE)</label>
          <input type="text" id="inUserId" placeholder="例如 user_123" autocomplete="off">
        </div>
        <div class="field">
          <label>顯示名稱</label>
          <input type="text" id="inDisplayName" placeholder="您的名稱">
        </div>
      </div>
      <div class="modal-footer">
        <div class="muted">
          安全提示：API_KEY 請勿分享。<br>
          （方案 B 已啟用 CORS 標頭，請確保後端設定正確）
        </div>
        <div class="actions-row">
          <button class="btn" id="btnDoInit">開始使用</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>

  <script>
    /**************
     * 全域狀態
     **************/
    const state = {
      apiBase: '',
      apiKey: '',
      userId: '',
      displayName: '',
      userProfile: null,
      activitiesCache: [],
      myActivitiesCache: [],
      donationsCache: [],
      financeCache: null,
      latestActivities: [],
      inited: false,
      loadingCount: 0,
    };

    /**************
     * 工具函式
     **************/
    function $(sel){ return document.querySelector(sel); }
    function $all(sel){ return Array.from(document.querySelectorAll(sel)); }

    function saveLocal() {
      localStorage.setItem('pda_settings', JSON.stringify({
        apiBase: state.apiBase,
          apiKey: state.apiKey,
          userId: state.userId,
          displayName: state.displayName
      }));
    }
    function loadLocal() {
      try {
        const raw = localStorage.getItem('pda_settings');
        if (!raw) return;
        const obj = JSON.parse(raw);
        state.apiBase = obj.apiBase || '';
        state.apiKey = obj.apiKey || '';
        state.userId = obj.userId || '';
        state.displayName = obj.displayName || '';
        if(state.apiBase) $('#inApiBase').value = state.apiBase;
        if(state.apiKey) $('#inApiKey').value = state.apiKey;
        if(state.userId) $('#inUserId').value = state.userId;
        if(state.displayName) $('#inDisplayName').value = state.displayName;
      } catch(e){}
    }

    function toast(msg, type='info', timeout=4500) {
      const el = document.createElement('div');
      el.className = 'toast '+(type==='error'?'error': type==='success'?'success':'');
      el.innerHTML = `
        <button class="toast-close" aria-label="關閉通知">&times;</button>
        <div>${escapeHtml(msg)}</div>
      `;
      $('#toastContainer').appendChild(el);
      const closer = el.querySelector('.toast-close');
      const remove = ()=> {
        el.style.opacity='0';
        el.style.transform='translateY(6px)';
        setTimeout(()=> el.remove(), 260);
      };
      closer.addEventListener('click', remove);
      if(timeout>0) setTimeout(remove, timeout);
    }

    function escapeHtml(str='') {
      return str.replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
    }

    function setLoading(on) {
      if(on) state.loadingCount++;
      else state.loadingCount = Math.max(0, state.loadingCount-1);
      $('#globalLoading').classList.toggle('active', state.loadingCount>0);
    }

    function ensureApiReady() {
      if(!state.apiBase) throw new Error('未設定 API Base');
      if(!state.apiKey) throw new Error('未設定 API_KEY');
    }

    /**************
     * CORS 避免預檢的 callApi
     * 使用 application/x-www-form-urlencoded (不手動設 Content-Type -> 瀏覽器自動)
     **************/
    async function callApi(action, payload = {}) {
      ensureApiReady();
      const params = new URLSearchParams();
      params.append('action', action);
      params.append('apiKey', state.apiKey);
      if(state.userId) params.append('userId', state.userId);
      Object.entries(payload).forEach(([k,v])=>{
        if(v === undefined || v === null) return;
        if(typeof v === 'object') params.append(k, JSON.stringify(v));
        else params.append(k, v);
      });
      let res;
      try {
        setLoading(true);
        res = await fetch(state.apiBase, { method:'POST', body: params });
      } catch(err) {
        throw new Error('無法連線後端：'+ err.message);
      } finally {
        setLoading(false);
      }
      if(!res.ok) {
        let txt = await res.text();
        throw new Error('HTTP '+res.status+'：'+txt.slice(0,120));
      }
      let text = await res.text();
      try {
        return JSON.parse(text);
      } catch(err) {
        throw new Error('回應 JSON 解析失敗：'+text.slice(0,160));
      }
    }

    /**************
     * 導航與頁面
     **************/
    function routeTo(name) {
      $all('.nav-item').forEach(btn=>{
        const r = btn.getAttribute('data-route');
        if(r) btn.classList.toggle('active', r===name);
      });
      $all('.sections').forEach(sec=>{
        sec.classList.remove('active');
      });
      const pageEl = $('#page-'+name.replace(/[A-Z]/g,m=>'-'+m.toLowerCase()));
      if(pageEl) {
        pageEl.classList.add('active');
        $('#pageTitle').textContent = pageTitleMap[name] || '頁面';
        // 特定頁面載入
        switch(name) {
          case 'home': loadHomeCombined(); break;
          case 'activities': renderActivities(); if(!state.activitiesCache.length) loadActivities(); break;
          case 'myActivities': renderMyActivities(); if(!state.myActivitiesCache.length) loadMyActivities(); break;
          case 'donations': renderDonations(); if(!state.donationsCache.length) loadDonations(); break;
          case 'finance': if(!state.financeCache) loadFinance(); else renderFinance(); break;
          case 'profile': if(!state.userProfile) loadUserProfile(); break;
        }
        if(window.innerWidth<980) sidebarToggle(false);
      } else {
        toast('頁面不存在：'+name,'error');
      }
    }

    const pageTitleMap = {
      home:'首頁',
      activities:'活動列表',
      myActivities:'我的活動',
      donations:'捐款紀錄',
      finance:'財務管理',
      profile:'個人資料'
    };

    /**************
     * 無障礙 / 顯示
     **************/
    function fontUp() {
      const body = document.body;
      const cur = body.getAttribute('data-font') || 'md';
      const order = ['md','lg','xl'];
      let idx = order.indexOf(cur);
      idx = (idx + 1) % order.length;
      body.setAttribute('data-font', order[idx]);
      toast('字級已切換：'+order[idx]);
    }
    function contrastToggle() {
      const body = document.body;
      const isHigh = body.getAttribute('data-contrast')==='high';
      body.setAttribute('data-contrast', isHigh?'normal':'high');
      $('#btnContrast').classList.toggle('toggle-active', !isHigh);
      toast('對比度：'+ (isHigh?'一般':'高對比'));
    }

    function sidebarToggle(force) {
      const sb = $('#sidebar');
      const open = typeof force==='boolean'? force : !sb.classList.contains('open');
      sb.classList.toggle('open', open);
    }

    /**************
     * 資料載入 / Home
     **************/
    async function loadHomeCombined() {
      // 最新活動
      loadLatestActivities();
      // 指標
      loadMyActivities({silent:true}).catch(()=>{});
      loadDonations({silent:true}).catch(()=>{});
      // 當 userProfile 有後再更新問候
      if(!state.userProfile) loadUserProfile({silent:true});
      refreshHomeMetricsLater();
    }
    let homeMetricTimer = null;
    function refreshHomeMetricsLater() {
      clearTimeout(homeMetricTimer);
      homeMetricTimer = setTimeout(refreshHomeMetrics, 600);
    }
    function refreshHomeMetrics() {
      // upcoming count & total activities
      const now = Date.now();
      let upcoming = 0;
      state.myActivitiesCache.forEach(a=>{
        const t = new Date(a.date || a.startDate || a.start_date || a.start_time).getTime();
          if(!isNaN(t) && t > now && t - now < 1000*60*60*24*30) upcoming++;
      });
      $('#m_upcomingCount').textContent = upcoming;
      $('#m_totalActivities').textContent = state.myActivitiesCache.length || 0;

      // donations
      let totalDonation=0, yearDonation=0;
      const year = new Date().getFullYear();
      state.donationsCache.forEach(d=>{
        const amt = Number(d.amount || d.donationAmount || 0);
        totalDonation += amt;
        const dt = new Date(d.date || d.donationDate || d.createdAt);
        if(dt.getFullYear()===year) yearDonation += amt;
      });
      $('#m_totalDonation').textContent = totalDonation.toLocaleString();
      $('#m_yearDonation').textContent = yearDonation.toLocaleString();
      $('#yearLabel').textContent = year;
      if(state.displayName) {
        $('#welcomeLine').textContent = '您好，'+ state.displayName +'！';
      }
    }

    async function loadLatestActivities() {
      try {
        const r = await callApi('getLatestActivities',{ limit:3 });
        if(!r || !r.success) throw new Error(r && r.message || '取得最新活動失敗');
        state.latestActivities = r.data || [];
        renderHomeLatest();
      } catch(e) {
        $('#homeLatestActivities').innerHTML = renderEmpty('無法取得最新活動：'+e.message);
      }
    }

    function renderHomeLatest() {
      const box = $('#homeLatestActivities');
      if(!state.latestActivities.length) {
        box.innerHTML = renderEmpty('目前沒有可顯示的活動');
        return;
      }
      box.innerHTML = state.latestActivities.map(a=>renderActivityItem(a,true)).join('');
      box.querySelectorAll('[data-act-register]').forEach(btn=>{
        btn.addEventListener('click', ()=> registerActivity(btn.getAttribute('data-id')));
      });
    }

    /**************
     * 活動
     **************/
    async function loadActivities(opts={}) {
      try {
        if(!opts.silent) setLoading(true);
        const r = await callApi('getActivities',{});
        if(!r || !r.success) throw new Error(r && r.message || '取得活動失敗');
        state.activitiesCache = r.data || [];
        renderActivities();
      } catch(e) {
        $('#activitiesList').innerHTML = renderEmpty('載入活動失敗：'+e.message);
      } finally {
        if(!opts.silent) setLoading(false);
      }
    }

    function renderActivities() {
      const wrap = $('#activitiesList');
      if(!state.activitiesCache.length) {
        wrap.innerHTML = renderEmpty('尚無活動資料');
        return;
      }
      wrap.innerHTML = state.activitiesCache.map(a=>renderActivityItem(a)).join('');
      wrap.querySelectorAll('[data-act-register]').forEach(btn=>{
        btn.addEventListener('click', ()=> registerActivity(btn.getAttribute('data-id')));
      });
    }

    function renderActivityItem(a,compact=false) {
      const id = a.id || a.activityId || a.activity_id || '';
      const title = escapeHtml(a.title || a.name || '未命名活動');
      const date = escapeHtml(a.date || a.dateStr || a.startDate || a.start_time || '');
      const place = escapeHtml(a.location || a.place || '');
      const quota = a.capacity || a.quota || '';
      const enrolled = a.enrolled || a.participants || 0;
      const remain = quota ? (quota - enrolled) : null;
      const remainTag = quota? `<span class="tag ${remain<=0?'danger': remain<3?'accent':'outline'}">剩 ${remain<=0?0:remain}</span>`:'';
      return `
        <div class="list-item" data-activity="${id}">
          <div class="list-item-head">
            <div>${title}</div>
            ${remainTag}
          </div>
          <div class="list-item-body">
            <span><strong>日期：</strong>${date||'--'}</span>
            ${ place ? `<span><strong>地點：</strong>${place}</span>`:'' }
            ${ quota ? `<span><strong>名額：</strong>${enrolled}/${quota}</span>`:'' }
          </div>
          <div class="actions-row">
            <button class="btn small" data-act-register data-id="${id}">報名</button>
          </div>
        </div>
      `;
    }

    async function registerActivity(activityId) {
      if(!activityId) return toast('無效的活動 ID','error');
      try {
        setLoading(true);
        const r = await callApi('registerActivity',{ activityId });
        if(!r || !r.success) throw new Error(r && r.message || '報名失敗');
        toast('報名成功','success');
        loadMyActivities({silent:true}).then(refreshHomeMetricsLater);
      } catch(e) {
        toast('報名失敗：'+e.message,'error');
      } finally {
        setLoading(false);
      }
    }

    /**************
     * 我的活動
     **************/
    async function loadMyActivities(opts={}) {
      try {
        if(!opts.silent) setLoading(true);
        const r = await callApi('getMyActivities',{});
        if(!r || !r.success) throw new Error(r && r.message || '取得我的活動失敗');
        state.myActivitiesCache = r.data || [];
        renderMyActivities();
        refreshHomeMetricsLater();
      } catch(e) {
        if(!opts.silent) $('#myActivitiesList').innerHTML = renderEmpty('載入失敗：'+e.message);
      } finally {
        if(!opts.silent) setLoading(false);
      }
    }

    function renderMyActivities() {
      const wrap = $('#myActivitiesList');
      if(!state.myActivitiesCache.length) {
        wrap.innerHTML = renderEmpty('尚未報名任何活動');
        return;
      }
      wrap.innerHTML = state.myActivitiesCache.map(a=>{
        const title = escapeHtml(a.title || a.name || '未命名活動');
        const date = escapeHtml(a.date || a.startDate || a.start_time || '');
        const status = a.status || '已報名';
        return `
          <div class="list-item">
            <div class="list-item-head">
              <div>${title}</div>
              <span class="tag outline">${escapeHtml(status)}</span>
            </div>
            <div class="list-item-body">
              <span><strong>日期：</strong>${date||'--'}</span>
              ${ a.location ? `<span><strong>地點：</strong>${escapeHtml(a.location)}</span>`:'' }
            </div>
          </div>
        `;
      }).join('');
    }

    /**************
     * 捐款紀錄
     **************/
    async function loadDonations(opts={}) {
      try {
        if(!opts.silent) setLoading(true);
        const r = await callApi('getDonations',{});
        if(!r || !r.success) throw new Error(r && r.message || '取得捐款失敗');
        state.donationsCache = r.data || [];
        renderDonations();
        refreshHomeMetricsLater();
      } catch(e) {
        if(!opts.silent) $('#donationsList').innerHTML = renderEmpty('載入失敗：'+e.message);
      } finally {
        if(!opts.silent) setLoading(false);
      }
    }

    function renderDonations() {
      const wrap = $('#donationsList');
      if(!state.donationsCache.length) {
        wrap.innerHTML = renderEmpty('尚無捐款資料');
        return;
      }
      wrap.innerHTML = state.donationsCache.map(d=>{
        const date = escapeHtml(d.date || d.donationDate || d.createdAt || '');
        const amount = Number(d.amount || d.donationAmount || 0);
        const note = escapeHtml(d.note || '');
        return `
          <div class="list-item">
            <div class="list-item-head">
              <div>${date}</div>
              <span class="tag accent">$ ${amount.toLocaleString()}</span>
            </div>
            <div class="list-item-body">
              <span><strong>用途：</strong>${escapeHtml(d.purpose || d.category || '一般')}</span>
              ${ note ? `<span><strong>備註：</strong>${note}</span>`:'' }
            </div>
          </div>
        `;
      }).join('');
    }

    /**************
     * 財務摘要
     **************/
    async function loadFinance() {
      try {
        setLoading(true);
        const r = await callApi('getFinanceSummary',{});
        if(!r || !r.success) throw new Error(r && r.message || '取得財務摘要失敗');
        state.financeCache = r.data || {};
        renderFinance();
      } catch(e) {
        $('#financeSummary').innerHTML = renderEmpty('載入財務失敗：'+e.message);
      } finally {
        setLoading(false);
      }
    }

    function renderFinance() {
      const box = $('#financeSummary');
      const d = state.financeCache || {};
      const metrics = [
        { label:'累計收入', value: d.totalIncome },
        { label:'累計支出', value: d.totalExpense },
        { label:'結餘', value: d.balance },
        { label:'本月收入', value: d.monthIncome },
        { label:'本月支出', value: d.monthExpense },
        { label:'本月結餘', value: d.monthBalance },
        { label:'年度收入', value: d.yearIncome },
        { label:'年度支出', value: d.yearExpense }
      ];
      box.innerHTML = metrics.map(m=>{
        const val = (m.value === undefined || m.value === null) ? '--' : Number(m.value).toLocaleString();
        return `
          <div class="card compact">
            <div class="card-title" style="font-size:14px;margin:0;">${escapeHtml(m.label)}</div>
            <div style="font-size:22px;font-weight:600;">${val}</div>
          </div>
        `;
      }).join('');
      $('#financeExtra').innerHTML = `
        <div style="font-size:14px;">
          <strong>更新時間：</strong>${escapeHtml(d.updatedAt || d.updateTime || new Date().toLocaleString())}
        </div>
        <div class="inline-note" style="margin-top:6px;">
          若資料有誤，請聯繫管理員重新同步。
        </div>
      `;
    }

    /**************
     * 個人資料
     **************/
    async function loadUserProfile(opts={}) {
      try {
        if(!opts.silent) setLoading(true);
        const r = await callApi('getUserInfo',{ userId: state.userId });
        if(!r || !r.success) throw new Error(r && r.message || '取得使用者資料失敗');
        state.userProfile = r.data || {};
        applyUserProfileToForm();
        updateUserPill();
      } catch(e) {
        if(!opts.silent) toast(e.message,'error');
      } finally {
        if(!opts.silent) setLoading(false);
      }
    }

    function applyUserProfileToForm() {
      const p = state.userProfile || {};
      $('#pfUserId').value = state.userId || '';
      $('#pfDisplayName').value = p.displayName || state.displayName || '';
      $('#pfEmail').value = p.email || '';
      $('#pfPhone').value = p.phone || '';
      $('#pfBirthday').value = p.birthday || '';
      $('#pfAddress').value = p.address || '';
      $('#pfNotes').value = p.notes || '';
    }

    async function updateProfile(e) {
      e.preventDefault();
      const payload = {
        userId: state.userId,
        displayName: $('#pfDisplayName').value.trim(),
        email: $('#pfEmail').value.trim(),
        phone: $('#pfPhone').value.trim(),
        birthday: $('#pfBirthday').value.trim(),
        address: $('#pfAddress').value.trim(),
        notes: $('#pfNotes').value.trim()
      };
      try {
        setLoading(true);
        const r = await callApi('updateUserProfile', payload);
        if(!r || !r.success) throw new Error(r && r.message || '更新失敗');
        toast('已更新個人資料','success');
        state.displayName = payload.displayName;
        state.userProfile = Object.assign({}, state.userProfile, payload);
        updateUserPill();
        saveLocal();
      } catch(e) {
        toast(e.message,'error');
      } finally {
        setLoading(false);
      }
    }

    function updateUserPill() {
      $('#pillDisplayName').textContent = state.displayName || state.userProfile?.displayName || '未登入';
      $('#pillUserId').textContent = state.userId || '--';
      $('#userStatusDot').style.background = state.userId ? 'var(--c-ok)' : 'var(--c-danger)';
    }

    /**************
     * 初始化 / 登入
     **************/
    async function doInit() {
      state.apiBase = $('#inApiBase').value.trim();
      state.apiKey = $('#inApiKey').value.trim();
      state.userId = $('#inUserId').value.trim() || state.userId;
      state.displayName = $('#inDisplayName').value.trim() || state.displayName;
      if(!state.apiBase.endsWith('/exec')) {
        toast('API URL 需以 /exec 結尾','error');
        return;
      }
      if(!state.apiBase || !state.apiKey || !state.userId) {
        toast('請填寫 API URL、API_KEY 與 使用者 ID','error');
        return;
      }
      try {
        setLoading(true);
        // 建立使用者（如果不存在）
        const r = await callApi('createUserIfNotExist', {
          userId: state.userId,
          displayName: state.displayName || '使用者'
        });
        if(!r || !r.success) {
          throw new Error(r && r.message || '使用者初始化失敗');
        }
        toast('初始化完成','success');
        state.inited = true;
        saveLocal();
        updateUserPill();
        $('#initModal').classList.remove('active');
        // 載入首頁資料
        loadHomeCombined();
      } catch(e) {
        toast(e.message,'error');
      } finally {
        setLoading(false);
      }
    }

    function logout() {
      if(!confirm('確定要登出？本機儲存的 API_KEY 與設定將被清除。')) return;
      localStorage.removeItem('pda_settings');
      state.apiBase = '';
      state.apiKey = '';
      state.userId = '';
      state.displayName = '';
      state.userProfile = null;
      updateUserPill();
      $('#initModal').classList.add('active');
      toast('已登出','success');
    }

    /**************
     * UI 組件
     **************/
    function renderEmpty(msg) {
      return `<div class="empty">${escapeHtml(msg)}</div>`;
    }

    /**************
     * 事件綁定
     **************/
    function bindEvents() {
      // 導航
      $all('.nav-item[data-route]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const route = btn.getAttribute('data-route');
          routeTo(route);
        });
      });
      $('#btnReloadActivities').addEventListener('click', ()=> loadActivities());
      $('#btnReloadMyActivities').addEventListener('click', ()=> loadMyActivities());
      $('#btnReloadDonations').addEventListener('click', ()=> loadDonations());
      $('#btnReloadFinance').addEventListener('click', ()=> loadFinance());
      $('#btnReloadProfile').addEventListener('click', ()=> loadUserProfile());
      $('#btnQuickRefresh').addEventListener('click', ()=> {
        loadMyActivities({silent:true});
        loadDonations({silent:true});
        loadFinance();
        toast('已觸發重新同步','success');
      });
      $('#formProfile').addEventListener('submit', updateProfile);
      $('#btnDoInit').addEventListener('click', doInit);
      $('#btnLogout').addEventListener('click', logout);
      $('#btnFontUp').addEventListener('click', fontUp);
      $('#btnContrast').addEventListener('click', contrastToggle);
      $('#mobileMenu').addEventListener('click', ()=> sidebarToggle());
      document.addEventListener('keydown', e=>{
        if(e.key==='Escape') sidebarToggle(false);
      });
      // 初始對比狀態顯示
      $('#btnContrast').classList.toggle('toggle-active', document.body.getAttribute('data-contrast')==='high');
    }

    /**************
     * 初始流程
     **************/
    function boot() {
      loadLocal();
      bindEvents();
      updateUserPill();
      // 若已有設定 -> 自動初始化 (不再顯示 modal)
      if(state.apiBase && state.apiKey && state.userId) {
        $('#initModal').classList.remove('active');
        state.inited = true;
        loadHomeCombined();
      }
    }

    // 啟動
    boot();
  </script>
</body>
</html>
