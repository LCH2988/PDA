<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>帕金森病友會管理系統 - 管理員</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes,maximum-scale=3.0">
<link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AOAgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AOAgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AOAgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
  /* ========== 基礎設定 ========== */
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: rgba(220, 53, 69, 0.3); }
  :root {
    --admin-primary: #dc3545; --admin-primary-dark: #c82333; --admin-secondary: #6f42c1;
    --admin-success: #28a745; --admin-warning: #ffc107; --admin-info: #17a2b8; --admin-danger: #dc3545;
    --light-bg: #f8f9fa; --white: #ffffff; --text-primary: #212529; --text-secondary: #6c757d;
    --border-color: #dee2e6; --shadow: 0 2px 10px rgba(0,0,0,0.1); --shadow-hover: 0 4px 20px rgba(0,0,0,0.15);
  }
  body {
    font-family: 'Microsoft JhengHei','PingFang TC','Helvetica Neue',Arial,sans-serif;
    font-size: 16px; line-height: 1.6; color: var(--text-primary);
    background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%); min-height: 100vh;
  }
  .admin-container { max-width: 100%; min-height: 100vh; background: var(--white); position: relative; padding-top: env(safe-area-inset-top); }
  .admin-header { background: linear-gradient(135deg, var(--admin-primary) 0%, var(--admin-primary-dark) 100%); color: white; padding: 20px 15px 15px; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); }
  .admin-header h1 { font-size: 22px; font-weight: 700; margin: 0 0 8px; text-align: center; }
  .admin-header .subtitle { font-size: 14px; text-align: center; opacity: .9; margin: 0; }
  .admin-user-info { background: rgba(255,255,255,0.15); border-radius: 15px; padding: 12px 15px; margin-top: 15px; display: flex; align-items: center; gap: 12px; }
  .admin-avatar { width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; color: white; border: 2px solid rgba(255,255,255,0.3); }

  /* 底部導航 */
  .admin-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--white); border-top: 1px solid var(--border-color);
    padding: 8px 0 calc(8px + env(safe-area-inset-bottom)); z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
  .admin-nav-items { display: flex; justify-content: space-around; align-items: center; max-width: 100%; margin: 0 auto; }
  .admin-nav-item { display: flex; flex-direction: column; align-items: center; padding: 6px 4px; color: var(--text-secondary);
    transition: all .3s ease; border-radius: 10px; min-width: 55px; cursor: pointer; border: none; background: none; font-size: 12px; }
  .admin-nav-item.active { color: var(--admin-primary); background: rgba(220, 53, 69, 0.1); }
  .admin-nav-item i { font-size: 20px; margin-bottom: 2px; }
  .admin-nav-item span { font-size: 10px; font-weight: 500; text-align: center; line-height: 1.1; }

  /* 內容區 */
  .admin-content { padding: 15px 15px 90px; min-height: calc(100vh - 160px); }
  .admin-section { display: none; }
  .admin-section.active { display: block; }

  /* 卡片 */
  .admin-card { background: var(--white); border-radius: 12px; padding: 16px; margin-bottom: 15px; box-shadow: var(--shadow); border: none; }
  .admin-card-title { font-size: 18px; font-weight: 700; color: var(--text-primary); margin: 0 0 12px; display: flex; align-items: center; gap: 8px; }
  .admin-card-text { font-size: 14px; color: var(--text-secondary); margin: 0 0 12px; line-height: 1.4; }

  /* 統計卡 */
  .admin-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
  .admin-stat-card { background: linear-gradient(135deg, var(--admin-primary), var(--admin-primary-dark)); color: white; padding: 16px; border-radius: 12px; text-align: center; box-shadow: var(--shadow); }
  .admin-stat-card.secondary { background: linear-gradient(135deg, var(--admin-secondary), #5a2d91); }
  .admin-stat-card.success { background: linear-gradient(135deg, var(--admin-success), #1e7e34); }
  .admin-stat-card.warning { background: linear-gradient(135deg, var(--admin-warning), #e0a800); }
  .admin-stat-card.info { background: linear-gradient(135deg, var(--admin-info), #117a8b); }
  .admin-stat-number { font-size: 24px; font-weight: 700; margin: 0 0 4px; }
  .admin-stat-label { font-size: 12px; opacity: .9; margin: 0; }

  /* 按鈕 */
  .admin-btn { font-size: 14px; font-weight: 600; padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; transition: all .3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 6px; min-height: 40px; }
  .admin-btn-primary { background: linear-gradient(135deg, var(--admin-primary), var(--admin-primary-dark)); color: white; }
  .admin-btn-success { background: linear-gradient(135deg, var(--admin-success), #1e7e34); color: white; }
  .admin-btn-warning { background: linear-gradient(135deg, var(--admin-warning), #e0a800); color: white; }
  .admin-btn-info { background: linear-gradient(135deg, var(--admin-info), #117a8b); color: white; }
  .admin-btn-secondary { background: #6c757d; color: white; }
  .admin-btn-outline { background: transparent; color: var(--admin-primary); border: 1px solid var(--admin-primary); }
  .admin-btn-sm { font-size: 12px; padding: 6px 12px; min-height: 32px; }
  .admin-btn-block { width: 100%; margin-bottom: 10px; }

  /* 表單 */
  .admin-form-group { margin-bottom: 15px; }
  .admin-form-label { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; display: block; }
  .admin-form-control, .admin-form-select { font-size: 14px; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--white); color: var(--text-primary); width: 100%; transition: border-color .3s ease; min-height: 40px; }
  .admin-form-control:focus, .admin-form-select:focus { outline: none; border-color: var(--admin-primary); box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.1); }
  textarea.admin-form-control { min-height: 80px; resize: vertical; }

  /* 表格 */
  .admin-table-container { background: var(--white); border-radius: 8px; overflow: hidden; box-shadow: var(--shadow); margin-bottom: 15px; }
  .admin-table { width: 100%; font-size: 13px; margin: 0; }
  .admin-table th { background: #f8f9fa; font-weight: 600; padding: 12px 8px; border-bottom: 1px solid var(--border-color); color: var(--text-primary); font-size: 12px; }
  .admin-table td { padding: 10px 8px; border-bottom: 1px solid #f1f3f4; vertical-align: middle; }
  .admin-table tbody tr:hover { background-color: rgba(220, 53, 69, 0.05); }

  /* 列表項目 */
  .admin-item { background: var(--white); border-radius: 10px; padding: 15px; margin-bottom: 12px; box-shadow: var(--shadow); border-left: 3px solid var(--admin-primary); }
  .admin-item-title { font-size: 16px; font-weight: 700; color: var(--text-primary); margin: 0 0 8px; }
  .admin-item-meta { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 8px; font-size: 12px; color: var(--text-secondary); }
  .admin-item-meta span { display: flex; align-items: center; gap: 4px; }
  .admin-item-description { font-size: 14px; color: var(--text-secondary); margin-bottom: 10px; line-height: 1.4; }
  .admin-item-actions { display: flex; gap: 8px; flex-wrap: wrap; }

  /* 狀態 */
  .admin-status-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; }
  .admin-status-active { background: #d4edda; color: #155724; }
  .admin-status-pending { background: #fff3cd; color: #856404; }
  .admin-status-rejected { background: #f8d7da; color: #721c24; }
  .admin-status-completed { background: #e2e3ff; color: #383d41; }

  /* 空狀態, 載入, 通知 */
  .admin-notification { position: fixed; top: 15px; left: 15px; right: 15px; background: var(--white); padding: 12px 16px; border-radius: 8px; box-shadow: var(--shadow-hover); z-index: 2000; transform: translateY(-80px); opacity: 0; transition: all .4s ease; font-size: 14px; }
  .admin-notification.show { transform: translateY(0); opacity: 1; }
  .admin-notification.success { border-left: 3px solid var(--admin-success); background: #d4edda; color: #155724; }
  .admin-notification.error { border-left: 3px solid var(--admin-danger); background: #f8d7da; color: #721c24; }
  .admin-notification.warning { border-left: 3px solid var(--admin-warning); background: #fff3cd; color: #856404; }
  .admin-notification.info { border-left: 3px solid var(--admin-info); background: #d1ecf1; color: #0c5460; }
  .admin-loading { text-align: center; padding: 30px 15px; color: var(--text-secondary); }
  .admin-spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid var(--admin-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .admin-empty-state { text-align: center; padding: 30px 15px; color: var(--text-secondary); }
  .admin-empty-state i { font-size: 36px; margin-bottom: 10px; opacity: .5; }
  .admin-empty-state h5 { font-size: 16px; margin-bottom: 8px; }
  .admin-empty-state p { font-size: 14px; margin: 0; }

  /* 響應式 */
  @media (max-width: 576px) {
    .admin-stats-grid { grid-template-columns: 1fr; }
    .admin-quick-actions { grid-template-columns: 1fr; }
    .admin-item-meta { flex-direction: column; gap: 6px; }
    .admin-table { font-size: 11px; }
    .admin-table th, .admin-table td { padding: 8px 4px; }
  }
</style>
</head>
<body>
<div class="admin-container">
  <div class="admin-header">
    <h1><i class="bi bi-shield-check"></i> 管理員控制台</h1>
    <p class="subtitle">帕金森病友會管理系統</p>
    <div id="adminUserInfo" class="admin-user-info" style="display:none;">
      <div class="admin-avatar" id="adminUserAvatar">A</div>
      <div style="flex:1;">
        <div style="font-weight:600;font-size:14px;" id="adminUserName">管理員</div>
        <div style="font-size:12px;opacity:.8;" id="adminUserRole">系統管理員</div>
      </div>
      <button class="admin-btn admin-btn-sm" onclick="refreshAdminData()" style="background:rgba(255,255,255,0.2);color:white;">
        <i class="bi bi-arrow-clockwise"></i>
      </button>
    </div>
  </div>

  <div id="adminNotificationContainer"></div>

  <div class="admin-content">
    <!-- 儀表板 -->
    <div class="admin-section active" id="adminDashboard">
      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-speedometer2"></i> 系統概覽</div>
        <div class="admin-card-text">管理員專用的系統監控和快速操作中心</div>
      </div>

      <div class="admin-stats-grid" id="adminDashboardStats">
        <div class="admin-stat-card">
          <div class="admin-stat-number" id="totalMembers">0</div>
          <div class="admin-stat-label">總會員數</div>
        </div>
        <div class="admin-stat-card secondary">
          <div class="admin-stat-number" id="activeActivities">0</div>
          <div class="admin-stat-label">進行中活動</div>
        </div>
        <div class="admin-stat-card success">
          <div class="admin-stat-number" id="totalDonations">$0</div>
          <div class="admin-stat-label">總捐款額</div>
        </div>
        <div class="admin-stat-card warning">
          <div class="admin-stat-number" id="pendingApprovals">0</div>
          <div class="admin-stat-label">待審核項目</div>
        </div>
      </div>

      <div class="admin-quick-actions" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px;">
        <button class="admin-btn admin-btn-outline" onclick="switchAdminTab('members')">
          <i class="bi bi-people"></i> 會員管理
        </button>
        <button class="admin-btn admin-btn-outline" onclick="switchAdminTab('activities')">
          <i class="bi bi-calendar-plus"></i> 新增活動
        </button>
        <button class="admin-btn admin-btn-outline" onclick="showSystemNotificationModal()">
          <i class="bi bi-megaphone"></i> 發送通知
        </button>
        <button class="admin-btn admin-btn-outline" onclick="exportAllData('all')">
          <i class="bi bi-download"></i> 匯出資料
        </button>
      </div>

      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-exclamation-triangle"></i> 需要注意的項目</div>
        <div id="adminAlerts">
          <div class="admin-loading">
            <div class="admin-spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 會員管理 -->
    <div class="admin-section" id="adminMembers">
      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-people"></i> 會員管理</div>
        <div class="admin-card-text">管理所有會員資料、審核申請和權限設定</div>
      </div>

      <div class="admin-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
          <h6 style="margin:0;">會員列表</h6>
          <button class="admin-btn admin-btn-info admin-btn-sm" onclick="exportMembers()">
            <i class="bi bi-download"></i> 匯出
          </button>
        </div>
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>姓名</th>
                <th>類別</th>
                <th>狀態</th>
                <th>加入日期</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="adminMembersList">
              <tr>
                <td colspan="5">
                  <div class="admin-loading">
                    <div class="admin-spinner"></div>
                    <p>載入中...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-person-plus"></i> 待審核會員</div>
        <div id="pendingMembers">
          <div class="admin-loading">
            <div class="admin-spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 活動管理 -->
    <div class="admin-section" id="adminActivities">
      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-calendar-event"></i> 活動管理</div>
        <div class="admin-card-text">建立、編輯和管理所有活動，監控報名狀況</div>
      </div>

      <div class="admin-card">
        <button class="admin-btn admin-btn-primary admin-btn-block" onclick="showCreateActivityModal()">
          <i class="bi bi-plus-circle"></i> 建立新活動
        </button>
      </div>

      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-list-ul"></i> 活動列表</div>
        <div id="adminActivitiesList">
          <div class="admin-loading">
            <div class="admin-spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 志工管理 -->
    <div class="admin-section" id="adminVolunteers">
      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-heart"></i> 志工管理</div>
        <div class="admin-card-text">管理志工需求、審核申請和記錄服務時數</div>
      </div>

      <div class="admin-card">
        <button class="admin-btn admin-btn-success admin-btn-block" onclick="showCreateVolunteerNeedModal()">
          <i class="bi bi-plus-circle"></i> 發布志工需求
        </button>
      </div>

      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-clipboard-check"></i> 志工申請審核</div>
        <div id="volunteerApplications">
          <div class="admin-loading">
            <div class="admin-spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>

      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-award"></i> 服務時數管理</div>
        <div id="volunteerHoursManagement">
          <div class="admin-loading">
            <div class="admin-spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 財務管理 -->
    <div class="admin-section" id="adminFinance">
      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-cash-stack"></i> 財務管理</div>
        <div class="admin-card-text">管理捐款記錄、審核支出申請和財務報表</div>
      </div>

      <div class="admin-stats-grid">
        <div class="admin-stat-card success">
          <div class="admin-stat-number" id="monthlyDonations">$0</div>
          <div class="admin-stat-label">本月捐款</div>
        </div>
        <div class="admin-stat-card warning">
          <div class="admin-stat-number" id="monthlyExpenses">$0</div>
          <div class="admin-stat-label">本月支出</div>
        </div>
        <div class="admin-stat-card info">
          <div class="admin-stat-number" id="pendingExpenseApprovals">0</div>
          <div class="admin-stat-label">待審核支出</div>
        </div>
        <div class="admin-stat-card">
          <div class="admin-stat-number" id="accountBalance">$0</div>
          <div class="admin-stat-label">帳戶餘額</div>
        </div>
      </div>

      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-receipt"></i> 支出申請審核</div>
        <div id="expenseApprovals">
          <div class="admin-loading">
            <div class="admin-spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>

      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-graph-up"></i> 財務報表</div>
        <div class="admin-quick-actions" style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="admin-btn admin-btn-info" onclick="generateMonthlyReport()">
            <i class="bi bi-file-earmark-text"></i> 月報表
          </button>
          <button class="admin-btn admin-btn-info" onclick="generateYearlyReport()">
            <i class="bi bi-file-earmark-bar-graph"></i> 年報表
          </button>
        </div>
      </div>
    </div>

    <!-- 系統設定 -->
    <div class="admin-section" id="adminSettings">
      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-gear"></i> 系統設定</div>
        <div class="admin-card-text">管理系統參數、權限設定和資料備份</div>
      </div>

      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-shield-lock"></i> 管理員權限</div>
        <form id="adminPermissionsForm" onsubmit="return false;">
          <div class="admin-form-group">
            <label class="admin-form-label">新增管理員</label>
            <div style="display:flex;gap:8px;">
              <input type="text" class="admin-form-control" placeholder="輸入管理員姓名" id="newAdminName" style="flex:1;">
              <input type="text" class="admin-form-control" placeholder="輸入會員 LINE ID" id="newAdminLineId" style="flex:1;">
              <select class="admin-form-select" id="newAdminRole" style="width:150px;">
                <option value="admin">Admin</option>
                <option value="finance">Finance</option>
                <option value="editor">Editor</option>
              </select>
              <button type="button" class="admin-btn admin-btn-primary" onclick="addAdmin()">
                <i class="bi bi-plus"></i>
              </button>
            </div>
          </div>
        </form>
        <div id="adminsList">
          <div class="admin-loading">
            <div class="admin-spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>

      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-sliders"></i> 系統參數</div>
        <div class="admin-form-group">
          <label class="admin-form-label">歡迎訊息</label>
          <textarea id="prefWelcomeMessage" class="admin-form-control" placeholder="新加入會員將看到的歡迎訊息"></textarea>
        </div>
        <div class="admin-form-group">
          <label class="admin-form-label">公告</label>
          <textarea id="prefAnnouncement" class="admin-form-control" placeholder="全體公告內容"></textarea>
        </div>
        <div class="admin-form-group" style="display:flex;gap:12px;align-items:center;">
          <label class="admin-form-label" style="margin:0;">自動核准會員</label>
          <input type="checkbox" id="prefAutoApproveMember" />
        </div>
        <div class="admin-form-group">
          <label class="admin-form-label">時區</label>
          <select id="prefTimezone" class="admin-form-select">
            <option value="Asia/Taipei">Asia/Taipei</option>
            <option value="Asia/Tokyo">Asia/Tokyo</option>
            <option value="Asia/Shanghai">Asia/Shanghai</option>
            <option value="UTC">UTC</option>
          </select>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="admin-btn admin-btn-primary" onclick="saveSystemPreferences(this)">
            <i class="bi bi-save"></i> 儲存設定
          </button>
          <button class="admin-btn admin-btn-secondary" onclick="loadSystemPreferences()">
            <i class="bi bi-arrow-counterclockwise"></i> 重新載入
          </button>
        </div>
      </div>

      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-database"></i> 資料管理</div>
        <div class="admin-quick-actions" style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="admin-btn admin-btn-info" onclick="createSystemBackup(this)">
            <i class="bi bi-cloud-upload"></i> 備份資料
          </button>
          <button class="admin-btn admin-btn-warning" onclick="listSystemBackups()">
            <i class="bi bi-card-list"></i> 載入備份清單
          </button>
        </div>
        <div id="backupList" style="margin-top:12px;">
          <div class="admin-empty-state">
            <i class="bi bi-cloud"></i>
            <h5>尚未載入備份清單</h5>
            <p>點擊「載入備份清單」以查看</p>
          </div>
        </div>
      </div>

      <div class="admin-card">
        <div class="admin-card-title"><i class="bi bi-graph-up-arrow"></i> 系統統計</div>
        <div id="systemStats">
          <div class="admin-table-container">
            <table class="admin-table">
              <tbody>
                <tr>
                  <th style="width:160px;">總用戶數</th>
                  <td id="sysTotalUsers">-</td>
                </tr>
                <tr>
                  <th>活躍用戶</th>
                  <td id="sysActiveUsers">-</td>
                </tr>
                <tr>
                  <th>儲存使用量</th>
                  <td id="sysStorageUsage">-</td>
                </tr>
                <tr>
                  <th>系統版本</th>
                  <td id="sysVersion">-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- 底部導航 -->
  <div class="admin-nav">
    <div class="admin-nav-items">
      <button class="admin-nav-item active" onclick="switchAdminTab('dashboard')">
        <i class="bi bi-speedometer2"></i>
        <span>儀表板</span>
      </button>
      <button class="admin-nav-item" onclick="switchAdminTab('members')">
        <i class="bi bi-people"></i>
        <span>會員</span>
      </button>
      <button class="admin-nav-item" onclick="switchAdminTab('activities')">
        <i class="bi bi-calendar-event"></i>
        <span>活動</span>
      </button>
      <button class="admin-nav-item" onclick="switchAdminTab('volunteers')">
        <i class="bi bi-heart"></i>
        <span>志工</span>
      </button>
      <button class="admin-nav-item" onclick="switchAdminTab('finance')">
        <i class="bi bi-cash-stack"></i>
        <span>財務</span>
      </button>
      <button class="admin-nav-item" onclick="switchAdminTab('settings')">
        <i class="bi bi-gear"></i>
        <span>設定</span>
      </button>
    </div>
  </div>

  <!-- Modal 容器 -->
  <div id="adminModalContainer"></div>
</div>

<script>
  // ========== 管理員設定 ==========
  const ADMIN_CONFIG = {
    LIFF_ID: '1656516134-X9oq92g9',
    API_BASE_URL: 'https://script.google.com/macros/s/AKfycbyjImHt10a57adOVdG5k7C29VkYO0NcxVpxD4xjTOqc-xCUMdqFKpMyQUSisvgMQ_gu/exec',
    API_KEY: 'AAbb8520258185202581'
  };

  // ========== 全域狀態 ==========
  let adminUserProfile = null;
  let currentAdminUser = null;
  let currentAdminTab = 'dashboard';

  // ========== 工具 ==========
  const toDateObj = v => { const d = new Date(v); return isNaN(d) ? null : d; };
  const formatDate = d => { const dt = toDateObj(d); return dt ? dt.toLocaleDateString('zh-TW') : '-'; };
  const formatDateTime = d => { const dt = toDateObj(d); return dt ? dt.toLocaleString('zh-TW') : '-'; };
  const formatCurrency = n => new Intl.NumberFormat('zh-TW',{ style:'currency', currency:'TWD', minimumFractionDigits:0 }).format(Number(n)||0);

  // 注入 Modal
  function injectModal(html, id) {
    const container = document.getElementById('adminModalContainer');
    // 移除同 ID 既有 modal
    const prev = document.getElementById(id);
    if (prev && prev.parentElement) prev.parentElement.remove();
    const wrap = document.createElement('div');
    wrap.innerHTML = html;
    container.appendChild(wrap.firstElementChild);
  }

  // ========== 通知 ==========
  function showAdminNotification(msg, type = 'success', ms = 3000) {
    const wrap = document.getElementById('adminNotificationContainer');
    const el = document.createElement('div');
    el.className = `admin-notification ${type}`;
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:start;">
        <span style="font-size:14px;font-weight:500;flex:1;">${msg}</span>
        <button style="background:none;border:none;font-size:18px;line-height:1;margin-left:10px;" onclick="this.closest('.admin-notification').remove()">&times;</button>
      </div>`;
    wrap.appendChild(el);
    requestAnimationFrame(() => el.classList.add('show'));
    setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 350); }, ms);
  }

  function setAdminButtonLoading(btn, loading = true) {
    if (!btn) return;
    if (loading) {
      if (!btn.dataset.originalText) btn.dataset.originalText = btn.innerHTML;
      btn.innerHTML = '<i class="bi bi-arrow-repeat" style="animation: spin 1s linear infinite;"></i> 處理中...';
      btn.disabled = true;
    } else {
      btn.disabled = false;
      if (btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText;
    }
  }

  // ========== API 呼叫 ==========
  async function callAdminAPI(action, data = {}, retries = 2) {
    const payload = { action, apiKey: ADMIN_CONFIG.API_KEY, timestamp: Date.now(), isAdmin: true, ...data };
    let lastErr;
    for (let i = 0; i <= retries; i++) {
      try {
        const res = await fetch(ADMIN_CONFIG.API_BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } 
        catch(e){ throw new Error('回應非 JSON: ' + text.slice(0, 200)); }
        if (json.success === false) throw new Error(json.message || 'API 錯誤');
        return json;
      } catch (err) {
        lastErr = err;
        await new Promise(r => setTimeout(r, 400 * (i + 1)));
      }
    }
    throw lastErr;
  }

  // ========== Tab 切換 ==========
  function switchAdminTab(tabName) {
    document.querySelectorAll('.admin-section').forEach(section => section.classList.remove('active'));
    const sectionId = 'admin' + tabName.charAt(0).toUpperCase() + tabName.slice(1); // e.g. dashboard -> adminDashboard
    const el = document.getElementById(sectionId);
    if (el) el.classList.add('active');

    document.querySelectorAll('.admin-nav-item').forEach(item => item.classList.remove('active'));
    const navBtn = document.querySelector(`.admin-nav-item[onclick="switchAdminTab('${tabName}')"]`);
    if (navBtn) navBtn.classList.add('active');

    currentAdminTab = tabName;

    // 載入資料
    switch(tabName) {
      case 'dashboard': loadAdminDashboard(); break;
      case 'members': loadMembersManagement(); break;
      case 'activities': loadActivitiesManagement(); break;
      case 'volunteers': loadVolunteersManagement(); break;
      case 'finance': loadFinanceManagement(); break;
      case 'settings': initSystemTab(); break;
    }
  }

  // ========== LIFF 初始化與權限 ==========
  async function initializeAdminLiff() {
    try {
      await liff.init({ liffId: ADMIN_CONFIG.LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      adminUserProfile = await liff.getProfile();
      // 顯示資訊
      document.getElementById('adminUserInfo').style.display = 'flex';
      document.getElementById('adminUserName').textContent = adminUserProfile.displayName || '管理員';
      document.getElementById('adminUserAvatar').textContent = (adminUserProfile.displayName || '?').charAt(0);

      // 權限檢查
      await checkAdminPermission();

      // 初次載入
      await loadAdminDashboard();
      showAdminNotification('管理員系統初始化完成', 'success');
    } catch (err) {
      console.error(err);
      showAdminNotification('系統初始化失敗：' + err.message, 'error');
    }
  }

  async function checkAdminPermission() {
    try {
      const r = await callAdminAPI('checkAdminPermission', { lineId: adminUserProfile.userId });
      if (!r.success || !r.data?.isAdmin) throw new Error('您沒有管理員權限');
      currentAdminUser = r.data;
      document.getElementById('adminUserRole').textContent = currentAdminUser.role || '系統管理員';
    } catch (err) {
      alert('權限驗證失敗：' + err.message);
      window.location.href = '/';
    }
  }

  function refreshAdminData() {
    switch (currentAdminTab) {
      case 'dashboard': loadAdminDashboard(); break;
      case 'members': loadMembersManagement(); break;
      case 'activities': loadActivitiesManagement(); break;
      case 'volunteers': loadVolunteersManagement(); break;
      case 'finance': loadFinanceManagement(); break;
      case 'settings': initSystemTab(); break;
    }
    showAdminNotification('已重新整理', 'info');
  }

  // ========== 儀表板 ==========
  async function loadAdminDashboard() {
    try {
      const r = await callAdminAPI('getAdminDashboard', { lineId: adminUserProfile?.userId });
      const data = r.data || {};
      document.getElementById('totalMembers').textContent = data.totalMembers || 0;
      document.getElementById('activeActivities').textContent = data.activeActivities || 0;
      document.getElementById('totalDonations').textContent = formatCurrency(data.totalDonations || 0).replace('NT$', '$');
      document.getElementById('pendingApprovals').textContent = data.pendingApprovals || 0;
      renderAdminAlerts(data.alerts || []);
    } catch (err) {
      showAdminNotification('載入儀表板失敗：' + err.message, 'error');
    }
  }

  function renderAdminAlerts(alerts) {
    const container = document.getElementById('adminAlerts');
    if (!alerts.length) {
      container.innerHTML = `
        <div class="admin-empty-state">
          <i class="bi bi-check-circle"></i>
          <h5>系統運作正常</h5>
          <p>目前沒有需要注意的項目</p>
        </div>`;
      return;
    }
    container.innerHTML = alerts.map(alert => `
      <div class="admin-item" style="border-left-color:${alert.type === 'warning' ? '#ffc107' : '#dc3545'};">
        <div class="admin-item-title">${alert.title || '提醒'}</div>
        <div class="admin-item-description">${alert.message || ''}</div>
        <div class="admin-item-meta">
          <span><i class="bi bi-clock"></i> ${formatDateTime(alert.timestamp)}</span>
        </div>
      </div>
    `).join('');
  }

  // ========== 會員管理 ==========
  async function loadMembersManagement() {
    try {
      const r = await callAdminAPI('getAllMembers', { lineId: adminUserProfile.userId });
      renderMembersList(Array.isArray(r.data) ? r.data : []);
      const pending = await callAdminAPI('getPendingMembers', { lineId: adminUserProfile.userId });
      renderPendingMembers(Array.isArray(pending.data) ? pending.data : []);
    } catch (err) {
      showAdminNotification('載入會員資料失敗：' + err.message, 'error');
    }
  }

  function renderMembersList(members) {
    const tbody = document.getElementById('adminMembersList');
    if (!members.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5">
            <div class="admin-empty-state">
              <i class="bi bi-people"></i>
              <h5>暫無會員資料</h5>
            </div>
          </td>
        </tr>`;
      return;
    }
    tbody.innerHTML = members.map(member => `
      <tr>
        <td>${member.realName || member.lineName || '-'}</td>
        <td><span class="admin-badge">${member.memberType || '一般'}</span></td>
        <td><span class="admin-status-badge ${member.status === 'disabled' ? 'admin-status-rejected' : 'admin-status-active'}">${member.status === 'disabled' ? '停用' : '正常'}</span></td>
        <td>${formatDate(member.joinDate)}</td>
        <td style="display:flex;gap:6px;flex-wrap:wrap;">
          <button class="admin-btn admin-btn-info admin-btn-sm" onclick="viewMember('${member.id}')">
            <i class="bi bi-eye"></i> 檢視
          </button>
          <button class="admin-btn admin-btn-primary admin-btn-sm" onclick="editMember('${member.id}')">
            <i class="bi bi-pencil-square"></i> 編輯
          </button>
          ${member.status === 'disabled' ? `
            <button class="admin-btn admin-btn-success admin-btn-sm" onclick="toggleMemberStatus('${member.id}', false, this)">
              <i class="bi bi-toggle-on"></i> 啟用
            </button>
          ` : `
            <button class="admin-btn admin-btn-warning admin-btn-sm" onclick="toggleMemberStatus('${member.id}', true, this)">
              <i class="bi bi-toggle-off"></i> 停用
            </button>
          `}
          <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteMember('${member.id}', this)">
            <i class="bi bi-trash"></i> 刪除
          </button>
        </td>
      </tr>
    `).join('');
  }

  function renderPendingMembers(list) {
    const container = document.getElementById('pendingMembers');
    if (!list.length) {
      container.innerHTML = `
        <div class="admin-empty-state">
          <i class="bi bi-inbox"></i>
          <h5>沒有待審核會員</h5>
          <p>新申請將顯示於此</p>
        </div>`;
      return;
    }
    container.innerHTML = list.map(m => `
      <div class="admin-item">
        <div class="admin-item-title">${m.realName || m.lineName || '未提供姓名'}</div>
        <div class="admin-item-meta">
          <span><i class="bi bi-person-badge"></i> 類別：${m.memberType || '一般'}</span>
          <span><i class="bi bi-calendar"></i> 申請日期：${formatDateTime(m.createdAt || m.applyAt)}</span>
        </div>
        <div class="admin-item-description">${m.note ? ('備註：' + m.note) : ''}</div>
        <div class="admin-item-actions">
          <button class="admin-btn admin-btn-success admin-btn-sm" onclick="approveMember('${m.id}')">
            <i class="bi bi-check2-circle"></i> 核准
          </button>
          <button class="admin-btn admin-btn-warning admin-btn-sm" onclick="rejectMember('${m.id}')">
            <i class="bi bi-x-circle"></i> 退回
          </button>
        </div>
      </div>
    `).join('');
  }

  async function approveMember(memberId) {
    try {
      await callAdminAPI('approveMember', { lineId: adminUserProfile.userId, memberId });
      showAdminNotification('會員已核准', 'success');
      loadMembersManagement();
      loadAdminDashboard();
    } catch (err) {
      showAdminNotification('核准失敗：' + err.message, 'error');
    }
  }

  async function rejectMember(memberId) {
    try {
      await callAdminAPI('rejectMember', { lineId: adminUserProfile.userId, memberId });
      showAdminNotification('已退回該會員申請', 'warning');
      loadMembersManagement();
      loadAdminDashboard();
    } catch (err) {
      showAdminNotification('退回失敗：' + err.message, 'error');
    }
  }

  // 會員操作（檢視、編輯、停用、刪除）
  function viewMember(memberId) { showMemberDetailModal(memberId, false); }
  function editMember(memberId) { showMemberDetailModal(memberId, true); }

  async function toggleMemberStatus(memberId, toDisable = true, btnEl) {
    try {
      setAdminButtonLoading(btnEl, true);
      await callAdminAPI('updateMemberStatus', { lineId: adminUserProfile.userId, memberId, status: toDisable ? 'disabled' : 'active' });
      showAdminNotification(`會員已${toDisable ? '停用' : '啟用'}`, toDisable ? 'warning' : 'success');
      loadMembersManagement();
      loadAdminDashboard();
    } catch (err) {
      showAdminNotification('狀態更新失敗：' + err.message, 'error');
    } finally {
      setAdminButtonLoading(btnEl, false);
    }
  }

  async function deleteMember(memberId, btnEl) {
    if (!confirm('確定要刪除此會員？此操作無法復原。')) return;
    try {
      setAdminButtonLoading(btnEl, true);
      await callAdminAPI('deleteMember', { lineId: adminUserProfile.userId, memberId });
      showAdminNotification('會員已刪除', 'success');
      loadMembersManagement();
      loadAdminDashboard();
    } catch (err) {
      showAdminNotification('刪除失敗：' + err.message, 'error');
    } finally {
      setAdminButtonLoading(btnEl, false);
    }
  }

  async function showMemberDetailModal(memberId, editable) {
    try {
      const r = await callAdminAPI('getMemberDetail', { lineId: adminUserProfile.userId, memberId });
      const m = r.data || {};
      const modalHtml = `
        <div class="modal fade" id="memberDetailModal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border:0;border-radius:12px;">
              <div class="modal-header" style="border:0;">
                <h5 class="modal-title"><i class="bi bi-person"></i> 會員${editable ? '編輯' : '資料'}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="admin-form-group">
                  <label class="admin-form-label">姓名</label>
                  <input id="m-name" class="admin-form-control" value="${m.realName || ''}" ${editable ? '' : 'disabled'}>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">類別</label>
                  <select id="m-type" class="admin-form-select" ${editable ? '' : 'disabled'}>
                    <option value="一般" ${m.memberType === '一般' ? 'selected' : ''}>一般</option>
                    <option value="病友" ${m.memberType === '病友' ? 'selected' : ''}>病友</option>
                    <option value="家屬" ${m.memberType === '家屬' ? 'selected' : ''}>家屬</option>
                    <option value="志工" ${m.memberType === '志工' ? 'selected' : ''}>志工</option>
                    <option value="其他" ${m.memberType === '其他' ? 'selected' : ''}>其他</option>
                  </select>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">狀態</label>
                  <select id="m-status" class="admin-form-select" ${editable ? '' : 'disabled'}>
                    <option value="active" ${m.status === 'active' ? 'selected' : ''}>正常</option>
                    <option value="disabled" ${m.status === 'disabled' ? 'selected' : ''}>停用</option>
                  </select>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">聯絡電話</label>
                  <input id="m-phone" class="admin-form-control" value="${m.phone || ''}" ${editable ? '' : 'disabled'}>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">備註</label>
                  <textarea id="m-note" class="admin-form-control" ${editable ? '' : 'disabled'}>${m.note || ''}</textarea>
                </div>
              </div>
              <div class="modal-footer" style="border:0;">
                <button type="button" class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">關閉</button>
                ${editable ? `
                  <button type="button" class="admin-btn admin-btn-primary" id="btnSaveMember"><i class="bi bi-save"></i> 儲存</button>
                ` : ''}
              </div>
            </div>
          </div>
        </div>
      `;
      injectModal(modalHtml, 'memberDetailModal');
      const modal = new bootstrap.Modal(document.getElementById('memberDetailModal'));
      modal.show();

      if (editable) {
        document.getElementById('btnSaveMember').addEventListener('click', async (e) => {
          const btn = e.currentTarget;
          try {
            setAdminButtonLoading(btn, true);
            const payload = {
              memberId,
              realName: document.getElementById('m-name').value.trim(),
              memberType: document.getElementById('m-type').value,
              status: document.getElementById('m-status').value,
              phone: document.getElementById('m-phone').value.trim(),
              note: document.getElementById('m-note').value.trim()
            };
            await callAdminAPI('updateMember', { lineId: adminUserProfile.userId, ...payload });
            showAdminNotification('會員資料已更新', 'success');
            modal.hide();
            loadMembersManagement();
          } catch (err) {
            showAdminNotification('更新失敗：' + err.message, 'error');
          } finally {
            setAdminButtonLoading(btn, false);
          }
        });
      }
    } catch (err) {
      showAdminNotification('載入會員資料失敗：' + err.message, 'error');
    }
  }

  function exportMembers() { exportAllData('members'); }

  // ========== 活動管理 ==========
  async function loadActivitiesManagement() {
    try {
      const r = await callAdminAPI('getActivities', { lineId: adminUserProfile.userId });
      renderActivitiesList(Array.isArray(r.data) ? r.data : []);
    } catch (err) {
      showAdminNotification('載入活動失敗：' + err.message, 'error');
    }
  }

  function renderActivitiesList(list) {
    const container = document.getElementById('adminActivitiesList');
    if (!list.length) {
      container.innerHTML = `
        <div class="admin-empty-state">
          <i class="bi bi-calendar-x"></i>
          <h5>目前沒有活動</h5>
          <p>點擊「建立新活動」來新增</p>
        </div>`;
      return;
    }
    container.innerHTML = list.map(a => `
      <div class="admin-item">
        <div class="admin-item-title">${a.title || '未命名活動'}</div>
        <div class="admin-item-meta">
          <span><i class="bi bi-clock"></i> ${formatDateTime(a.start)} ~ ${formatDateTime(a.end)}</span>
          <span><i class="bi bi-geo-alt"></i> ${a.location || '-'}</span>
          <span><i class="bi bi-people"></i> 報名：${a.registeredCount || 0}/${a.capacity || '-'}</span>
          <span>${a.status === 'closed' ? '<span class="admin-status-badge admin-status-rejected">已下架</span>' : '<span class="admin-status-badge admin-status-active">上架中</span>'}</span>
        </div>
        <div class="admin-item-description">${a.description || ''}</div>
        <div class="admin-item-actions">
          <button class="admin-btn admin-btn-info admin-btn-sm" onclick="viewActivityRegistrations('${a.id}')">
            <i class="bi bi-list-check"></i> 報名名單
          </button>
          <button class="admin-btn admin-btn-primary admin-btn-sm" onclick="showEditActivityModal('${a.id}')">
            <i class="bi bi-pencil-square"></i> 編輯
          </button>
          ${a.status === 'closed' ? `
            <button class="admin-btn admin-btn-success admin-btn-sm" onclick="toggleActivityStatus('${a.id}', 'open', this)">
              <i class="bi bi-upload"></i> 上架
            </button>
          ` : `
            <button class="admin-btn admin-btn-warning admin-btn-sm" onclick="toggleActivityStatus('${a.id}', 'closed', this)">
              <i class="bi bi-download"></i> 下架
            </button>
          `}
          <button class="admin-btn admin-btn-secondary admin-btn-sm" onclick="duplicateActivity('${a.id}', this)">
            <i class="bi bi-files"></i> 複製
          </button>
          <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteActivity('${a.id}', this)">
            <i class="bi bi-trash"></i> 刪除
          </button>
        </div>
      </div>
    `).join('');
  }

  function showCreateActivityModal() { showEditActivityModal(null); }

  async function showEditActivityModal(activityId) {
    try {
      let a = { title: '', start: '', end: '', location: '', capacity: '', description: '', status: 'open' };
      if (activityId) {
        const r = await callAdminAPI('getActivityDetail', { lineId: adminUserProfile.userId, activityId });
        a = r.data || a;
      }
      const modalHtml = `
        <div class="modal fade" id="activityModal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border:0;border-radius:12px;">
              <div class="modal-header" style="border:0;">
                <h5 class="modal-title"><i class="bi bi-calendar-event"></i> ${activityId ? '編輯活動' : '建立新活動'}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="admin-form-group">
                  <label class="admin-form-label">活動名稱</label>
                  <input id="a-title" class="admin-form-control" value="${a.title || ''}">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">開始時間</label>
                  <input id="a-start" type="datetime-local" class="admin-form-control" value="${a.start ? formatToLocalInput(a.start) : ''}">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">結束時間</label>
                  <input id="a-end" type="datetime-local" class="admin-form-control" value="${a.end ? formatToLocalInput(a.end) : ''}">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">地點</label>
                  <input id="a-location" class="admin-form-control" value="${a.location || ''}">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">人數上限</label>
                  <input id="a-capacity" type="number" min="0" class="admin-form-control" value="${a.capacity || ''}">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">狀態</label>
                  <select id="a-status" class="admin-form-select">
                    <option value="open" ${a.status !== 'closed' ? 'selected' : ''}>上架</option>
                    <option value="closed" ${a.status === 'closed' ? 'selected' : ''}>下架</option>
                  </select>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">活動說明</label>
                  <textarea id="a-description" class="admin-form-control">${a.description || ''}</textarea>
                </div>
              </div>
              <div class="modal-footer" style="border:0;">
                <button type="button" class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">關閉</button>
                <button type="button" class="admin-btn admin-btn-primary" id="btnSaveActivity">
                  <i class="bi bi-save"></i> 儲存
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      injectModal(modalHtml, 'activityModal');
      const modal = new bootstrap.Modal(document.getElementById('activityModal'));
      modal.show();

      document.getElementById('btnSaveActivity').addEventListener('click', async (e) => {
        const btn = e.currentTarget;
        try {
          const payload = {
            title: document.getElementById('a-title').value.trim(),
            start: document.getElementById('a-start').value,
            end: document.getElementById('a-end').value,
            location: document.getElementById('a-location').value.trim(),
            capacity: Number(document.getElementById('a-capacity').value || 0),
            status: document.getElementById('a-status').value,
            description: document.getElementById('a-description').value.trim(),
          };
          if (!payload.title) return showAdminNotification('請輸入活動名稱', 'warning');
          if (!payload.start || !payload.end) return showAdminNotification('請輸入開始/結束時間', 'warning');
          if (new Date(payload.end) < new Date(payload.start)) return showAdminNotification('結束時間不可早於開始時間', 'warning');

          setAdminButtonLoading(btn, true);
          const action = activityId ? 'updateActivity' : 'createActivity';
          const req = { lineId: adminUserProfile.userId, ...payload };
          if (activityId) req.activityId = activityId;
          await callAdminAPI(action, req);
          showAdminNotification(activityId ? '活動已更新' : '活動已建立', 'success');
          modal.hide();
          loadActivitiesManagement();
          loadAdminDashboard();
        } catch (err) {
          showAdminNotification('儲存失敗：' + err.message, 'error');
        } finally {
          setAdminButtonLoading(btn, false);
        }
      });
    } catch (err) {
      showAdminNotification('載入活動資料失敗：' + err.message, 'error');
    }
  }

  async function toggleActivityStatus(activityId, status, btnEl) {
    try {
      setAdminButtonLoading(btnEl, true);
      await callAdminAPI('updateActivityStatus', { lineId: adminUserProfile.userId, activityId, status });
      showAdminNotification(status === 'closed' ? '活動已下架' : '活動已上架', status === 'closed' ? 'warning' : 'success');
      loadActivitiesManagement();
      loadAdminDashboard();
    } catch (err) {
      showAdminNotification('更新活動狀態失敗：' + err.message, 'error');
    } finally {
      setAdminButtonLoading(btnEl, false);
    }
  }

  async function duplicateActivity(activityId, btnEl) {
    try {
      setAdminButtonLoading(btnEl, true);
      await callAdminAPI('duplicateActivity', { lineId: adminUserProfile.userId, activityId });
      showAdminNotification('活動已複製', 'success');
      loadActivitiesManagement();
    } catch (err) {
      showAdminNotification('複製失敗：' + err.message, 'error');
    } finally {
      setAdminButtonLoading(btnEl, false);
    }
  }

  async function deleteActivity(activityId, btnEl) {
    if (!confirm('確定要刪除此活動？此操作無法復原。')) return;
    try {
      setAdminButtonLoading(btnEl, true);
      await callAdminAPI('deleteActivity', { lineId: adminUserProfile.userId, activityId });
      showAdminNotification('活動已刪除', 'success');
      loadActivitiesManagement();
      loadAdminDashboard();
    } catch (err) {
      showAdminNotification('刪除失敗：' + err.message, 'error');
    } finally {
      setAdminButtonLoading(btnEl, false);
    }
  }

  async function viewActivityRegistrations(activityId) {
    try {
      const r = await callAdminAPI('getActivityRegistrations', { lineId: adminUserProfile.userId, activityId });
      const list = Array.isArray(r.data) ? r.data : [];
      const modalHtml = `
        <div class="modal fade" id="activityRegModal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
            <div class="modal-content" style="border:0;border-radius:12px;">
              <div class="modal-header" style="border:0;">
                <h5 class="modal-title"><i class="bi bi-list-check"></i> 報名名單</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                ${list.length ? `
                  <div class="admin-table-container">
                    <table class="admin-table">
                      <thead><tr><th>姓名</th><th>連絡電話</th><th>報名時間</th><th>狀態</th></tr></thead>
                      <tbody>
                        ${list.map(i => `
                          <tr>
                            <td>${i.name || '-'}</td>
                            <td>${i.phone || '-'}</td>
                            <td>${formatDateTime(i.createdAt)}</td>
                            <td><span class="admin-status-badge ${i.status === 'cancelled' ? 'admin-status-rejected' : 'admin-status-active'}">${i.status === 'cancelled' ? '取消' : '有效'}</span></td>
                          </tr>`).join('')}
                      </tbody>
                    </table>
                  </div>
                ` : `
                  <div class="admin-empty-state">
                    <i class="bi bi-people"></i>
                    <h5>尚無報名</h5>
                  </div>
                `}
              </div>
              <div class="modal-footer" style="border:0;">
                <button type="button" class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">關閉</button>
                <button type="button" class="admin-btn admin-btn-info" onclick="exportActivityRegistrations('${activityId}')">
                  <i class="bi bi-download"></i> 匯出名單
                </button>
              </div>
            </div>
          </div>
        </div>`;
      injectModal(modalHtml, 'activityRegModal');
      new bootstrap.Modal(document.getElementById('activityRegModal')).show();
    } catch (err) {
      showAdminNotification('載入名單失敗：' + err.message, 'error');
    }
  }

  function exportActivityRegistrations(activityId) {
    exportAllData('activityRegistrations', { activityId });
  }

  function formatToLocalInput(d) {
    const dt = toDateObj(d);
    if (!dt) return '';
    const tzoffset = dt.getTimezoneOffset() * 60000;
    const localISO = new Date(dt - tzoffset).toISOString().slice(0, 16);
    return localISO;
  }

  // ========== 志工管理 ==========
  async function loadVolunteersManagement() {
    try {
      const [needs, apps, hours] = await Promise.all([
        callAdminAPI('getVolunteerNeeds', { lineId: adminUserProfile.userId }),
        callAdminAPI('getVolunteerApplications', { lineId: adminUserProfile.userId }),
        callAdminAPI('getVolunteerHours', { lineId: adminUserProfile.userId })
      ]);
      renderVolunteerNeeds(Array.isArray(needs.data) ? needs.data : []);
      renderVolunteerApplications(Array.isArray(apps.data) ? apps.data : []);
      renderVolunteerHours(Array.isArray(hours.data) ? hours.data : []);
    } catch (err) {
      showAdminNotification('載入志工資料失敗：' + err.message, 'error');
    }
  }

  function renderVolunteerNeeds(list) {
    // 如需在 UI 顯示志工需求列表，可在此渲染到對應容器
    // 目前保留空實作
  }

  function showCreateVolunteerNeedModal() {
    const modalHtml = `
      <div class="modal fade" id="volNeedModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content" style="border:0;border-radius:12px;">
            <div class="modal-header" style="border:0;">
              <h5 class="modal-title"><i class="bi bi-heart"></i> 發布志工需求</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="admin-form-group">
                <label class="admin-form-label">標題</label>
                <input id="vn-title" class="admin-form-control">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">日期</label>
                <input id="vn-date" type="date" class="admin-form-control">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">地點</label>
                <input id="vn-location" class="admin-form-control">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">人數需求</label>
                <input id="vn-quota" type="number" min="1" class="admin-form-control">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">說明</label>
                <textarea id="vn-desc" class="admin-form-control"></textarea>
              </div>
            </div>
            <div class="modal-footer" style="border:0;">
              <button class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">關閉</button>
              <button class="admin-btn admin-btn-success" id="btnSaveVolNeed"><i class="bi bi-save"></i> 發布</button>
            </div>
          </div>
        </div>
      </div>`;
    injectModal(modalHtml, 'volNeedModal');
    const modal = new bootstrap.Modal(document.getElementById('volNeedModal'));
    modal.show();

    document.getElementById('btnSaveVolNeed').addEventListener('click', async (e) => {
      const btn = e.currentTarget;
      try {
        const payload = {
          title: document.getElementById('vn-title').value.trim(),
          date: document.getElementById('vn-date').value,
          location: document.getElementById('vn-location').value.trim(),
          quota: Number(document.getElementById('vn-quota').value || 0),
          description: document.getElementById('vn-desc').value.trim(),
        };
        if (!payload.title || !payload.date) return showAdminNotification('請填寫標題與日期', 'warning');
        setAdminButtonLoading(btn, true);
        await callAdminAPI('createVolunteerNeed', { lineId: adminUserProfile.userId, ...payload });
        showAdminNotification('志工需求已發布', 'success');
        modal.hide();
        loadVolunteersManagement();
      } catch (err) {
        showAdminNotification('發布失敗：' + err.message, 'error');
      } finally {
        setAdminButtonLoading(btn, false);
      }
    });
  }

  function renderVolunteerApplications(list) {
    const container = document.getElementById('volunteerApplications');
    if (!list.length) {
      container.innerHTML = `
        <div class="admin-empty-state">
          <i class="bi bi-inbox"></i>
          <h5>沒有待審核志工申請</h5>
        </div>`;
      return;
    }
    container.innerHTML = list.map(app => `
      <div class="admin-item">
        <div class="admin-item-title">${app.applicantName || '-'}</div>
        <div class="admin-item-meta">
          <span><i class="bi bi-heart"></i> 需求：${app.needTitle || '-'}</span>
          <span><i class="bi bi-calendar"></i> ${formatDate(app.applyDate)}</span>
        </div>
        <div class="admin-item-actions">
          <button class="admin-btn admin-btn-success admin-btn-sm" onclick="approveVolunteer('${app.id}')">
            <i class="bi bi-check2"></i> 核准
          </button>
          <button class="admin-btn admin-btn-warning admin-btn-sm" onclick="rejectVolunteer('${app.id}')">
            <i class="bi bi-x"></i> 退回
          </button>
        </div>
      </div>
    `).join('');
  }

  async function approveVolunteer(applicationId) {
    try {
      await callAdminAPI('approveVolunteerApplication', { lineId: adminUserProfile.userId, applicationId });
      showAdminNotification('志工申請已核准', 'success');
      loadVolunteersManagement();
    } catch (err) {
      showAdminNotification('核准失敗：' + err.message, 'error');
    }
  }

  async function rejectVolunteer(applicationId) {
    try {
      await callAdminAPI('rejectVolunteerApplication', { lineId: adminUserProfile.userId, applicationId });
      showAdminNotification('志工申請已退回', 'warning');
      loadVolunteersManagement();
    } catch (err) {
      showAdminNotification('退回失敗：' + err.message, 'error');
    }
  }

  function renderVolunteerHours(list) {
    const container = document.getElementById('volunteerHoursManagement');
    if (!list.length) {
      container.innerHTML = `
        <div class="admin-empty-state">
          <i class="bi bi-hourglass-split"></i>
          <h5>尚無服務時數</h5>
          <p>志工完成服務後可在此登錄</p>
          <div style="margin-top:10px;">
            <button class="admin-btn admin-btn-primary admin-btn-sm" onclick="showLogVolunteerHoursModal()">
              <i class="bi bi-plus-circle"></i> 新增時數
            </button>
          </div>
        </div>`;
      return;
    }
    container.innerHTML = `
      <div style="display:flex;justify-content:flex-end;margin-bottom:8px;">
        <button class="admin-btn admin-btn-primary admin-btn-sm" onclick="showLogVolunteerHoursModal()">
          <i class="bi bi-plus-circle"></i> 新增時數
        </button>
      </div>
      <div class="admin-table-container">
        <table class="admin-table">
          <thead>
            <tr><th>志工</th><th>日期</th><th>時數</th><th>服務內容</th><th>操作</th></tr>
          </thead>
          <tbody>
            ${list.map(h => `
              <tr>
                <td>${h.volunteerName || '-'}</td>
                <td>${formatDate(h.date)}</td>
                <td>${h.hours || 0}</td>
                <td>${h.description || ''}</td>
                <td>
                  <button class="admin-btn admin-btn-info admin-btn-sm" onclick="editVolunteerHour('${h.id}')">
                    <i class="bi bi-pencil"></i> 編輯
                  </button>
                  <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteVolunteerHour('${h.id}', this)">
                    <i class="bi bi-trash"></i> 刪除
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>`;
  }

  function showLogVolunteerHoursModal() {
    const modalHtml = `
      <div class="modal fade" id="volHourModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content" style="border:0;border-radius:12px;">
            <div class="modal-header" style="border:0;">
              <h5 class="modal-title"><i class="bi bi-clock-history"></i> 新增服務時數</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="admin-form-group">
                <label class="admin-form-label">志工 LINE ID</label>
                <input id="vh-line" class="admin-form-control" placeholder="志工 LINE ID">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">日期</label>
                <input id="vh-date" type="date" class="admin-form-control">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">時數</label>
                <input id="vh-hours" type="number" min="0" step="0.5" class="admin-form-control">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">服務內容</label>
                <textarea id="vh-desc" class="admin-form-control"></textarea>
              </div>
            </div>
            <div class="modal-footer" style="border:0;">
              <button class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">取消</button>
              <button class="admin-btn admin-btn-primary" id="btnSaveVolHour"><i class="bi bi-save"></i> 儲存</button>
            </div>
          </div>
        </div>
      </div>`;
    injectModal(modalHtml, 'volHourModal');
    const modal = new bootstrap.Modal(document.getElementById('volHourModal'));
    modal.show();

    document.getElementById('btnSaveVolHour').addEventListener('click', async (e) => {
      const btn = e.currentTarget;
      try {
        const payload = {
          volunteerLineId: document.getElementById('vh-line').value.trim(),
          date: document.getElementById('vh-date').value,
          hours: Number(document.getElementById('vh-hours').value || 0),
          description: document.getElementById('vh-desc').value.trim(),
        };
        if (!payload.volunteerLineId || !payload.date) return showAdminNotification('請填寫志工 LINE ID 與日期', 'warning');
        setAdminButtonLoading(btn, true);
        await callAdminAPI('logVolunteerHour', { lineId: adminUserProfile.userId, ...payload });
        showAdminNotification('時數已新增', 'success');
        modal.hide();
        loadVolunteersManagement();
      } catch (err) {
        showAdminNotification('新增失敗：' + err.message, 'error');
      } finally {
        setAdminButtonLoading(btn, false);
      }
    });
  }

  async function editVolunteerHour(id) {
    try {
      const r = await callAdminAPI('getVolunteerHourDetail', { lineId: adminUserProfile.userId, id });
      const h = r.data || {};
      const modalHtml = `
        <div class="modal fade" id="volHourEditModal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border:0;border-radius:12px;">
              <div class="modal-header" style="border:0;">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> 編輯服務時數</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="admin-form-group">
                  <label class="admin-form-label">志工</label>
                  <input id="vh2-name" class="admin-form-control" value="${h.volunteerName || ''}" disabled>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">日期</label>
                  <input id="vh2-date" type="date" class="admin-form-control" value="${h.date ? new Date(h.date).toISOString().slice(0,10) : ''}">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">時數</label>
                  <input id="vh2-hours" type="number" min="0" step="0.5" class="admin-form-control" value="${h.hours || 0}">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">服務內容</label>
                  <textarea id="vh2-desc" class="admin-form-control">${h.description || ''}</textarea>
                </div>
              </div>
              <div class="modal-footer" style="border:0;">
                <button class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">取消</button>
                <button class="admin-btn admin-btn-primary" id="btnUpdateVolHour"><i class="bi bi-save"></i> 儲存</button>
              </div>
            </div>
          </div>
        </div>`;
      injectModal(modalHtml, 'volHourEditModal');
      const modal = new bootstrap.Modal(document.getElementById('volHourEditModal'));
      modal.show();

      document.getElementById('btnUpdateVolHour').addEventListener('click', async (e) => {
        const btn = e.currentTarget;
        try {
          setAdminButtonLoading(btn, true);
          const payload = {
            id,
            date: document.getElementById('vh2-date').value,
            hours: Number(document.getElementById('vh2-hours').value || 0),
            description: document.getElementById('vh2-desc').value.trim(),
          };
          await callAdminAPI('updateVolunteerHour', { lineId: adminUserProfile.userId, ...payload });
          showAdminNotification('時數已更新', 'success');
          modal.hide();
          loadVolunteersManagement();
        } catch (err) {
          showAdminNotification('更新失敗：' + err.message, 'error');
        } finally {
          setAdminButtonLoading(btn, false);
        }
      });
    } catch (err) {
      showAdminNotification('載入時數資料失敗：' + err.message, 'error');
    }
  }

  async function deleteVolunteerHour(id, btnEl) {
    if (!confirm('確定要刪除此時數紀錄？')) return;
    try {
      setAdminButtonLoading(btnEl, true);
      await callAdminAPI('deleteVolunteerHour', { lineId: adminUserProfile.userId, id });
      showAdminNotification('已刪除', 'success');
      loadVolunteersManagement();
    } catch (err) {
      showAdminNotification('刪除失敗：' + err.message, 'error');
    } finally {
      setAdminButtonLoading(btnEl, false);
    }
  }

  // ========== 財務管理 ==========
  async function loadFinanceManagement() {
    try {
      const r = await callAdminAPI('getFinanceOverview', { lineId: adminUserProfile.userId });
      const d = r.data || {};
      document.getElementById('monthlyDonations').textContent = formatCurrency(d.monthlyDonations || 0).replace('NT$', '$');
      document.getElementById('monthlyExpenses').textContent = formatCurrency(d.monthlyExpenses || 0).replace('NT$', '$');
      document.getElementById('pendingExpenseApprovals').textContent = d.pendingExpenseApprovals || 0;
      document.getElementById('accountBalance').textContent = formatCurrency(d.accountBalance || 0).replace('NT$', '$');

      const approvals = await callAdminAPI('getExpenseApprovals', { lineId: adminUserProfile.userId });
      renderExpenseApprovals(Array.isArray(approvals.data) ? approvals.data : []);
    } catch (err) {
      showAdminNotification('載入財務資料失敗：' + err.message, 'error');
    }
  }

  function renderExpenseApprovals(list) {
    const container = document.getElementById('expenseApprovals');
    if (!list.length) {
      container.innerHTML = `
        <div class="admin-empty-state">
          <i class="bi bi-receipt"></i>
          <h5>沒有待審核支出</h5>
        </div>`;
      return;
    }
    container.innerHTML = list.map(x => `
      <div class="admin-item">
        <div class="admin-item-title">${x.title || '支出申請'}</div>
        <div class="admin-item-meta">
          <span><i class="bi bi-currency-dollar"></i> 金額：${formatCurrency(x.amount || 0)}</span>
          <span><i class="bi bi-person"></i> 申請人：${x.applicantName || '-'}</span>
          <span><i class="bi bi-calendar"></i> ${formatDateTime(x.createdAt)}</span>
        </div>
        <div class="admin-item-description">${x.note || ''}</div>
        <div class="admin-item-actions">
          <button class="admin-btn admin-btn-success admin-btn-sm" onclick="approveExpense('${x.id}')">
            <i class="bi bi-check2-circle"></i> 核准
          </button>
          <button class="admin-btn admin-btn-warning admin-btn-sm" onclick="rejectExpense('${x.id}')">
            <i class="bi bi-x-circle"></i> 退回
          </button>
        </div>
      </div>
    `).join('');
  }

  async function approveExpense(id) {
    try {
      await callAdminAPI('approveExpense', { lineId: adminUserProfile.userId, id });
      showAdminNotification('支出已核准', 'success');
      loadFinanceManagement();
      loadAdminDashboard();
    } catch (err) {
      showAdminNotification('核准失敗：' + err.message, 'error');
    }
  }

  async function rejectExpense(id) {
    try {
      await callAdminAPI('rejectExpense', { lineId: adminUserProfile.userId, id });
    showAdminNotification('支出已退回', 'warning');
      loadFinanceManagement();
    } catch (err) {
      showAdminNotification('退回失敗：' + err.message, 'error');
    }
  }

  async function generateMonthlyReport() {
    try {
      const r = await callAdminAPI('generateMonthlyReport', { lineId: adminUserProfile.userId });
      if (r.data?.url) {
        window.open(r.data.url, '_blank');
      }
      showAdminNotification('月報表已產生', 'success');
    } catch (err) {
      showAdminNotification('產生月報表失敗：' + err.message, 'error');
    }
  }

  async function generateYearlyReport() {
    try {
      const r = await callAdminAPI('generateYearlyReport', { lineId: adminUserProfile.userId });
      if (r.data?.url) {
        window.open(r.data.url, '_blank');
      }
      showAdminNotification('年報表已產生', 'success');
    } catch (err) {
      showAdminNotification('產生年報表失敗：' + err.message, 'error');
    }
  }

  // ========== 系統設定 ==========
  async function loadSystemSettings() {
    try {
      const [admins, stats] = await Promise.all([
        callAdminAPI('getAdmins', { lineId: adminUserProfile.userId }),
        callAdminAPI('getSystemStats', { lineId: adminUserProfile.userId })
      ]);

      renderAdmins(Array.isArray(admins.data) ? admins.data : []);
      renderSystemStats(stats?.data || {});
    } catch (err) {
      showAdminNotification('載入系統設定失敗：' + err.message, 'error');
    }
  }

  function renderAdmins(list) {
    const container = document.getElementById('adminsList');
    if (!container) return;

    if (!list.length) {
      container.innerHTML = `
        <div class="admin-empty-state">
          <i class="bi bi-people"></i>
          <h5>目前沒有管理員</h5>
          <p>請新增至少一位管理員</p>
        </div>`;
      return;
    }

    container.innerHTML = `
      <div class="admin-table-container">
        <table class="admin-table">
          <thead>
            <tr><th>姓名</th><th>LINE ID</th><th>角色</th><th>建立時間</th><th>操作</th></tr>
          </thead>
          <tbody>
            ${list.map(a => `
              <tr>
                <td>${a.name || '-'}</td>
                <td>${a.lineId || '-'}</td>
                <td>${a.role || 'admin'}</td>
                <td>${a.createdAt ? formatDateTime(a.createdAt) : '-'}</td>
                <td>
                  <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="removeAdmin('${a.lineId}', this)">
                    <i class="bi bi-person-dash"></i> 移除
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }

  async function addAdmin() {
    try {
      const name = (document.getElementById('newAdminName')?.value || '').trim();
      const lineId = (document.getElementById('newAdminLineId')?.value || '').trim();
      const role = (document.getElementById('newAdminRole')?.value || 'admin');

      if (!name || !lineId) {
        return showAdminNotification('請輸入管理員姓名與 LINE ID', 'warning');
      }

      await callAdminAPI('addAdmin', { lineId: adminUserProfile.userId, targetLineId: lineId, name, role });
      showAdminNotification('已新增管理員', 'success');
      document.getElementById('newAdminName').value = '';
      document.getElementById('newAdminLineId').value = '';
      loadSystemSettings();
    } catch (err) {
      showAdminNotification('新增管理員失敗：' + err.message, 'error');
    }
  }

  async function removeAdmin(targetLineId, btnEl) {
    if (!confirm('確定要移除該管理員？')) return;
    try {
      setAdminButtonLoading(btnEl, true);
      await callAdminAPI('removeAdmin', { lineId: adminUserProfile.userId, targetLineId });
      showAdminNotification('已移除管理員', 'success');
      loadSystemSettings();
    } catch (err) {
      showAdminNotification('移除失敗：' + err.message, 'error');
    } finally {
      setAdminButtonLoading(btnEl, false);
    }
  }

  function renderSystemStats(stats) {
    const elUsers = document.getElementById('sysTotalUsers');
    const elActive = document.getElementById('sysActiveUsers');
    const elStorage = document.getElementById('sysStorageUsage');
    const elVersion = document.getElementById('sysVersion');

    if (elUsers) elUsers.textContent = String(stats.totalUsers ?? '-');
    if (elActive) elActive.textContent = String(stats.activeUsers ?? '-');
    if (elStorage) elStorage.textContent = stats.storageUsed != null ? (formatBytes(stats.storageUsed) + (stats.storageQuota ? ' / ' + formatBytes(stats.storageQuota) : '')) : '-';
    if (elVersion) elVersion.textContent = stats.version || '-';
  }

  // 常用工具
  function formatBytes(bytes) {
    if (isNaN(bytes) || bytes === null) return '-';
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
  }

  // ========== 系統參數（公告、歡迎訊息、表單） ==========
  async function loadSystemPreferences() {
    try {
      const r = await callAdminAPI('getSystemPreferences', { lineId: adminUserProfile.userId });
      const p = r.data || {};
      const elWelcome = document.getElementById('prefWelcomeMessage');
      const elAnnouncement = document.getElementById('prefAnnouncement');
      const elAutoApproveMember = document.getElementById('prefAutoApproveMember');
      const elTimezone = document.getElementById('prefTimezone');

      if (elWelcome) elWelcome.value = p.welcomeMessage || '';
      if (elAnnouncement) elAnnouncement.value = p.announcement || '';
      if (elAutoApproveMember) elAutoApproveMember.checked = !!p.autoApproveMember;
      if (elTimezone) elTimezone.value = p.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone || 'Asia/Taipei';
    } catch (err) {
      showAdminNotification('載入系統參數失敗：' + err.message, 'error');
    }
  }

  async function saveSystemPreferences(btnEl) {
    try {
      setAdminButtonLoading(btnEl, true);
      const payload = {
        welcomeMessage: document.getElementById('prefWelcomeMessage')?.value?.trim() || '',
        announcement: document.getElementById('prefAnnouncement')?.value?.trim() || '',
        autoApproveMember: !!document.getElementById('prefAutoApproveMember')?.checked,
        timezone: document.getElementById('prefTimezone')?.value || 'Asia/Taipei'
      };
      await callAdminAPI('updateSystemPreferences', { lineId: adminUserProfile.userId, ...payload });
      showAdminNotification('系統參數已儲存', 'success');
      loadSystemPreferences();
    } catch (err) {
      showAdminNotification('儲存失敗：' + err.message, 'error');
    } finally {
      setAdminButtonLoading(btnEl, false);
    }
  }

  // ========== 資料備份與匯入 ==========
  async function createSystemBackup(btnEl) {
    try {
      setAdminButtonLoading(btnEl, true);
      const r = await callAdminAPI('createBackup', { lineId: adminUserProfile.userId });
      if (r.data?.url) {
        window.open(r.data.url, '_blank');
      }
      showAdminNotification('備份已建立', 'success');
    } catch (err) {
      showAdminNotification('建立備份失敗：' + err.message, 'error');
    } finally {
      setAdminButtonLoading(btnEl, false);
    }
  }

  async function listSystemBackups() {
    try {
      const r = await callAdminAPI('listBackups', { lineId: adminUserProfile.userId });
      renderBackupList(Array.isArray(r.data) ? r.data : []);
    } catch (err) {
      showAdminNotification('載入備份清單失敗：' + err.message, 'error');
    }
  }

  function renderBackupList(list) {
    const container = document.getElementById('backupList');
    if (!container) return;

    if (!list.length) {
      container.innerHTML = `
        <div class="admin-empty-state">
          <i class="bi bi-cloud-slash"></i>
          <h5>尚無備份</h5>
        </div>`;
      return;
    }

    container.innerHTML = `
      <div class="admin-table-container">
        <table class="admin-table">
          <thead><tr><th>檔名</th><th>大小</th><th>建立時間</th><th>操作</th></tr></thead>
          <tbody>
            ${list.map(b => `
              <tr>
                <td>${b.name || '-'}</td>
                <td>${b.size != null ? formatBytes(b.size) : '-'}</td>
                <td>${b.createdAt ? formatDateTime(b.createdAt) : '-'}</td>
                <td>
                  <button class="admin-btn admin-btn-info admin-btn-sm" onclick="downloadBackup('${b.id}')">
                    <i class="bi bi-download"></i> 下載
                  </button>
                  <button class="admin-btn admin-btn-warning admin-btn-sm" onclick="restoreBackup('${b.id}')">
                    <i class="bi bi-arrow-counterclockwise"></i> 還原
                  </button>
                  <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteBackup('${b.id}', this)">
                    <i class="bi bi-trash"></i> 刪除
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }

  async function downloadBackup(backupId) {
    try {
      const r = await callAdminAPI('getBackupDownloadUrl', { lineId: adminUserProfile.userId, backupId });
      if (r.data?.url) window.open(r.data.url, '_blank');
    } catch (err) {
      showAdminNotification('下載失敗：' + err.message, 'error');
    }
  }

  async function restoreBackup(backupId) {
    if (!confirm('確定要還原此備份？目前資料將被覆蓋。')) return;
    try {
      await callAdminAPI('restoreBackup', { lineId: adminUserProfile.userId, backupId });
      showAdminNotification('還原成功', 'success');
      // 視需求重新載入各管理頁面
      loadAdminDashboard?.();
      loadMembersManagement?.();
      loadActivitiesManagement?.();
      loadVolunteersManagement?.();
      loadFinanceManagement?.();
      loadSystemSettings?.();
    } catch (err) {
      showAdminNotification('還原失敗：' + err.message, 'error');
    }
  }

  async function deleteBackup(backupId, btnEl) {
    if (!confirm('確定要刪除此備份？')) return;
    try {
      setAdminButtonLoading(btnEl, true);
      await callAdminAPI('deleteBackup', { lineId: adminUserProfile.userId, backupId });
      showAdminNotification('備份已刪除', 'success');
      listSystemBackups();
    } catch (err) {
      showAdminNotification('刪除失敗：' + err.message, 'error');
    } finally {
      setAdminButtonLoading(btnEl, false);
    }
  }

  // ========== 匯出 ==========
  function exportAllData(type = 'all', extra = {}) {
    callAdminAPI('exportData', { lineId: adminUserProfile.userId, type, ...extra })
      .then(r => {
        if (r.data?.url) window.open(r.data.url, '_blank');
        else showAdminNotification('已產出匯出檔案', 'success');
      })
      .catch(err => showAdminNotification('匯出失敗：' + err.message, 'error'));
  }

  // ========== 初始化（若頁籤切換使用） ==========
  async function initSystemTab() {
    await Promise.allSettled([
      loadSystemSettings(),
      loadSystemPreferences(),
      listSystemBackups()
    ]);
  }

  // ========== 系統通知（示範 Modal） ==========
  function showSystemNotificationModal() {
    const modalHtml = `
      <div class="modal fade" id="sysNotifyModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content" style="border:0;border-radius:12px;">
            <div class="modal-header" style="border:0;">
              <h5 class="modal-title"><i class="bi bi-megaphone"></i> 發送系統通知</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="admin-form-group">
                <label class="admin-form-label">標題</label>
                <input id="sn-title" class="admin-form-control" placeholder="通知標題">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">內容</label>
                <textarea id="sn-message" class="admin-form-control" placeholder="通知內容"></textarea>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">對象</label>
                <select id="sn-target" class="admin-form-select">
                  <option value="all">全部會員</option>
                  <option value="active">僅限有效會員</option>
                  <option value="volunteer">志工</option>
                </select>
              </div>
            </div>
            <div class="modal-footer" style="border:0;">
              <button class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">取消</button>
              <button class="admin-btn admin-btn-primary" id="btnSendNotify">
                <i class="bi bi-send"></i> 發送
              </button>
            </div>
          </div>
        </div>
      </div>`;
    injectModal(modalHtml, 'sysNotifyModal');
    const modal = new bootstrap.Modal(document.getElementById('sysNotifyModal'));
    modal.show();

    document.getElementById('btnSendNotify').addEventListener('click', async (e) => {
      const btn = e.currentTarget;
      const title = document.getElementById('sn-title').value.trim();
      const message = document.getElementById('sn-message').value.trim();
      const target = document.getElementById('sn-target').value;
      if (!title || !message) return showAdminNotification('請輸入標題與內容', 'warning');
      try {
        setAdminButtonLoading(btn, true);
        await callAdminAPI('sendSystemNotification', {
          lineId: adminUserProfile.userId,
          title, message, target
        });
        showAdminNotification('通知已發送', 'success');
        modal.hide();
      } catch (err) {
        showAdminNotification('發送失敗：' + err.message, 'error');
      } finally {
        setAdminButtonLoading(btn, false);
      }
    });
  }

  // ========== 啟動 ==========
  document.addEventListener('DOMContentLoaded', () => {
    initializeAdminLiff();
  });
</script>
</body>
</html>



