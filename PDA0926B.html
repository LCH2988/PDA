<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>帕金森病友會 - 會員與管理員整合版</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=3.0" />
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAAD///8A..." />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    /* 基礎樣式（沿用會員端設計） */
    :root{
      --primary-color:#4CAF50;--primary-dark:#45a049;--secondary-color:#2196F3;
      --danger-color:#f44336;--warning-color:#ff9800;--success-color:#4CAF50;
      --info-color:#2196F3;--light-bg:#f8f9fa;--white:#ffffff;--text-primary:#212529;
      --text-secondary:#6c757d;--border-color:#dee2e6;--shadow:0 2px 10px rgba(0,0,0,0.1);
      --shadow-hover:0 4px 20px rgba(0,0,0,0.15)
    }
    html,body{height:100%}
    body{
      font-family:'Microsoft JhengHei','PingFang TC','Helvetica Neue',Arial,sans-serif;
      font-size:18px;line-height:1.6;color:var(--text-primary);
      background:linear-gradient(135deg,#e3f2fd 0%,#f3e5f5 100%);margin:0
    }
    .app-header{background:linear-gradient(135deg,var(--primary-color),var(--primary-dark));color:#fff;padding:16px;position:sticky;top:0;z-index:1000;box-shadow:var(--shadow)}
    .app-header .title{font-size:20px;font-weight:700;margin:0;text-align:center}
    .app-header .subtitle{font-size:14px;text-align:center;opacity:.9;margin-top:4px}
    .container-content{padding:16px 12px 100px}
    .card{background:#fff;border:none;border-radius:16px;padding:16px;box-shadow:var(--shadow);margin-bottom:16px}
    .card-title{font-size:18px;font-weight:700;margin-bottom:8px}
    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .stat-card{background:linear-gradient(135deg,var(--primary-color),var(--primary-dark));color:#fff;border-radius:16px;padding:16px;text-align:center}
    .stat-card .num{font-size:24px;font-weight:800}
    .btn{border-radius:12px}
    .bottom-nav{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--border-color);display:flex;justify-content:space-around;gap:8px;padding:8px 8px calc(8px + env(safe-area-inset-bottom));z-index:1000}
    .bottom-nav .nav-btn{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--text-secondary);text-decoration:none;padding:8px 10px;border-radius:12px}
    .bottom-nav .nav-btn.active{color:var(--primary-color);background:rgba(76,175,80,0.1)}
    .view{display:none}
    .view.active{display:block}
    .status-badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .status-開放報名{background:#d4edda;color:#155724}
    .status-報名截止{background:#fff3cd;color:#856404}
    .status-已取消,.status-已拒絕{background:#f8d7da;color:#721c24}
    .hidden{display:none!important}
    /* 管理端框架（獨立容器） */
    .admin-toolbar{position:sticky;top:56px;background:#fff;z-index:900;border-bottom:1px solid var(--border-color);padding:8px 12px;display:flex;gap:8px;flex-wrap:wrap}
    .admin-tabs{display:flex;gap:8px;flex-wrap:wrap}
    .admin-tab{padding:8px 12px;border-radius:999px;border:1px solid var(--border-color);cursor:pointer;background:#fff;color:#333}
    .admin-tab.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color)}
    .table-responsive{border-radius:12px;border:1px solid var(--border-color);overflow:auto}
    .badge{font-size:12px}
    @media (max-width:576px){.stats-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header class="app-header">
    <div class="title">帕金森病友會系統（整合版）</div>
    <div class="subtitle" id="subtitle">載入中...</div>
  </header>

  <main class="container-content">
    <!-- 會員端視圖 -->
    <section id="view-member" class="view">
      <div class="card">
        <div class="card-title">我的資訊</div>
        <div id="userInfo">尚未登入</div>
        <div id="adminEntry" class="mt-2 hidden">
          <button class="btn btn-outline-primary btn-sm" id="btnGoAdmin"><i class="bi bi-speedometer2"></i> 進入管理端</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">儀表板</div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="num" id="statMonthlyDonation">0</div>
            <div>本月捐款</div>
          </div>
          <div class="stat-card">
            <div class="num" id="statMonthlyExpense">0</div>
            <div>本月支出</div>
          </div>
        </div>
        <div class="mt-2">帳戶餘額：<b id="statBalance">0</b></div>
        <div class="mt-2" id="alertsWrap"></div>
      </div>

      <div class="card">
        <div class="card-title">活動列表</div>
        <div id="activityList"></div>
      </div>

      <div class="card">
        <div class="card-title">志工需求</div>
        <div id="volunteerNeeds"></div>
      </div>

      <div class="card">
        <div class="card-title">我的報名</div>
        <div id="myRegistrations"></div>
      </div>

      <div class="card">
        <div class="card-title">財務</div>
        <div class="d-grid gap-2">
          <button class="btn btn-primary" id="btnDonate"><i class="bi bi-cash-coin"></i> 我要捐款</button>
          <button class="btn btn-secondary" id="btnMyReceipts"><i class="bi bi-receipt"></i> 我的收據</button>
          <button class="btn btn-outline-primary" id="btnMyFinance"><i class="bi bi-list"></i> 我的收支</button>
        </div>
        <div id="financeLists" class="mt-3"></div>
      </div>
    </section>

    <!-- 管理端視圖 -->
    <section id="view-admin" class="view">
      <div class="card">
        <div class="d-flex justify-content-between align-items-center">
          <div class="card-title mb-0">管理員儀表板</div>
          <button class="btn btn-outline-secondary btn-sm" id="btnBackMember"><i class="bi bi-arrow-left"></i> 回會員端</button>
        </div>
        <div class="stats-grid mt-3">
          <div class="stat-card">
            <div class="num" id="adTotalMembers">0</div>
            <div>會員數</div>
          </div>
          <div class="stat-card">
            <div class="num" id="adActiveActivities">0</div>
            <div>開放活動</div>
          </div>
        </div>
        <div class="mt-3">本月捐款：<b id="adMonthlyDonations">0</b>、待審支出：<b id="adPendingExpenses">0</b>、餘額：<b id="adBalance">0</b></div>
      </div>

      <div class="admin-toolbar">
        <div class="admin-tabs">
          <button class="admin-tab active" data-admin-tab="members">會員</button>
          <button class="admin-tab" data-admin-tab="activities">活動</button>
          <button class="admin-tab" data-admin-tab="volunteers">志工</button>
          <button class="admin-tab" data-admin-tab="finance">財務</button>
          <button class="admin-tab" data-admin-tab="settings">設定/備份</button>
        </div>
      </div>

      <div id="adminTabMembers" class="card">
        <div class="d-flex justify-content-between align-items-center">
          <div class="card-title mb-0">會員管理</div>
          <div>
            <button class="btn btn-sm btn-primary" id="btnReloadMembers"><i class="bi bi-arrow-clockwise"></i> 重新載入</button>
          </div>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr><th>LINE ID</th><th>姓名</th><th>類型</th><th>狀態</th><th>電話</th><th>操作</th></tr>
            </thead>
            <tbody id="tblMembers"></tbody>
          </table>
        </div>
      </div>

      <div id="adminTabActivities" class="card hidden">
        <div class="d-flex justify-content-between align-items-center">
          <div class="card-title mb-0">活動管理</div>
          <button class="btn btn-sm btn-primary" id="btnNewActivity"><i class="bi bi-plus-lg"></i> 新增活動</button>
        </div>
        <div id="adminActivitiesList" class="mt-3"></div>
      </div>

      <div id="adminTabVolunteers" class="card hidden">
        <div class="card-title">志工管理</div>
        <div class="text-muted">最小可用版：清單/小計可載入，進階功能可再加。</div>
      </div>

      <div id="adminTabFinance" class="card hidden">
        <div class="card-title">財務管理</div>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-sm btn-outline-primary" id="btnLoadFinanceOverview">總覽</button>
          <button class="btn btn-sm btn-outline-secondary" id="btnLoadExpenseApprovals">待審支出</button>
          <button class="btn btn-sm btn-outline-success" id="btnGenMonthlyReport">月報表</button>
          <button class="btn btn-sm btn-outline-success" id="btnGenYearlyReport">年報表</button>
        </div>
        <div id="adminFinanceContent" class="mt-3"></div>
      </div>

      <div id="adminTabSettings" class="card hidden">
        <div class="card-title">設定與備份</div>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-sm btn-outline-primary" id="btnLoadSettings">讀取設定</button>
          <button class="btn btn-sm btn-outline-primary" id="btnSaveSettings">儲存設定</button>
          <button class="btn btn-sm btn-outline-secondary" id="btnListBackups">備份列表</button>
          <button class="btn btn-sm btn-outline-secondary" id="btnCreateBackup">建立備份</button>
        </div>
        <div id="adminSettingsContent" class="mt-3"></div>
      </div>
    </section>
  </main>

  <nav class="bottom-nav">
    <a class="nav-btn active" data-view="member"><i class="bi bi-house-door"></i><span>會員</span></a>
    <a class="nav-btn" data-view="admin"><i class="bi bi-speedometer2"></i><span>管理</span></a>
  </nav>

  <!-- 簡易對話框：捐款 -->
  <div class="modal fade" id="donateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">我要捐款</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">金額</label>
            <input type="number" id="donateAmount" class="form-control" placeholder="例如 1000" />
          </div>
          <div class="mb-2">
            <label class="form-label">類別</label>
            <select id="donateCategory" class="form-select">
              <option value="一般捐款">一般捐款</option>
              <option value="活動贊助">活動贊助</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">備註</label>
            <textarea id="donateNote" class="form-control" placeholder="備註（選填）"></textarea>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="needReceipt" />
            <label class="form-check-label" for="needReceipt">需要收據</label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary" id="btnSubmitDonate">送出</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== 可調整常數 ======
    const LIFF_ID = '1656516134-X9oq92g9'; // 如果使用 LIFF，填入你的 liffId。否則可留空以匿名測試。
    const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwXtuht4jBDbt9TFiRSLfexODoT9DaIkxBHsNg1RHTSyxuBnumQ8gf3eKHUgh29bCKu/exec';
    // (()=>{
    //   // 同源 API：與此頁相同的 Apps Script Web App
    //   const u = new URL(window.location.href);
    //   return u.origin + u.pathname; // script.google.com/macros/s/.../exec
    // })();

    // ====== 狀態 ======
    let currentUser = null; // { lineId, lineName, ... , isAdmin }
    let isAdminMode = false;

    // ====== 工具 ======
    function showSubtitle(text){ document.getElementById('subtitle').textContent = text || ''; }
    function $(sel){ return document.querySelector(sel); }
    function $all(sel){ return Array.from(document.querySelectorAll(sel)); }

    async function callAPI(action, data = {}){
      const payload = { action, data };
      const res = await fetch(API_BASE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      // 同源不會有 CORS 問題
      return await res.json();
    }

    function toast(msg, type='info'){
      const div = document.createElement('div');
      div.className = 'notification show ' + (type==='success'?'success': type==='error'?'error':'');
      div.style.position='fixed'; div.style.top='16px'; div.style.left='16px'; div.style.right='16px';
      div.style.zIndex=3000; div.style.padding='12px 16px'; div.style.borderRadius='12px'; div.style.background='#fff'; div.style.boxShadow='var(--shadow-hover)';
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(()=>{ div.remove(); }, 2500);
    }

    function switchView(view){
      isAdminMode = (view === 'admin');
      $('#view-member').classList.toggle('active', !isAdminMode);
      $('#view-admin').classList.toggle('active', isAdminMode);
      $all('.nav-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.view === view));
      if(isAdminMode) {
        loadAdminDashboard();
      } else {
        loadMemberDashboard();
      }
    }

    function switchAdminTab(tab){
      const map = {
        members: '#adminTabMembers',
        activities: '#adminTabActivities',
        volunteers: '#adminTabVolunteers',
        finance: '#adminTabFinance',
        settings: '#adminTabSettings'
      };
      $all('.admin-tab').forEach(t => t.classList.toggle('active', t.dataset.adminTab === tab));
      Object.values(map).forEach(sel => $(sel).classList.add('hidden'));
      $(map[tab]).classList.remove('hidden');
      // lazy load by tab
      if(tab==='members') loadAdminMembers();
      if(tab==='activities') loadAdminActivities();
    }

    // ====== 初始化（LIFF + 路由） ======
    async function initApp(){
      showSubtitle('初始化中...');
      const route = new URLSearchParams(location.search).get('route');
      let lineProfile = null;

      // LIFF 初始化（可選）
      if(LIFF_ID){
        try{
          await liff.init({ liffId: LIFF_ID });
          if(!liff.isLoggedIn()) liff.login({ redirectUri: location.href });
          const prof = await liff.getProfile();
          lineProfile = { userId: prof.userId, displayName: prof.displayName };
        }catch(e){
          console.warn('LIFF 初始化失敗，改匿名模式', e);
        }
      }

      // 嘗試讀取使用者資料（匿名模式允許先看公開資訊）
      if(lineProfile?.userId){
        const ures = await callAPI('getUserInfo', { lineId: lineProfile.userId });
        if(ures.success){
          currentUser = { ...ures.data };
        }else{
          // 未註冊也建立基本物件
          currentUser = { lineId: lineProfile.userId, lineName: lineProfile.displayName || 'LINE 使用者', isAdmin: false };
        }
      }else{
        // 無 LIFF → 以暫時訪客用戶（部分功能需登入）
        currentUser = { lineId: '', lineName: '訪客', isAdmin: false };
      }

      // 更新 UI
      $('#userInfo').textContent = currentUser.lineId ? `${currentUser.realName || currentUser.lineName || currentUser.lineId}（${currentUser.memberType || '一般'}）` : '訪客模式（部分功能需登入）';

      // 管理員檢查（有 lineId 才查）
      if(currentUser.lineId){
        const a = await callAPI('checkAdminPermission', { lineId: currentUser.lineId });
        if(a?.success){
          currentUser.isAdmin = true;
          $('#adminEntry').classList.remove('hidden');
        }
      }

      // 事件綁定
      $('#btnGoAdmin').addEventListener('click', ()=> switchView('admin'));
      $('#btnBackMember').addEventListener('click', ()=> switchView('member'));
      $all('.nav-btn').forEach(btn => btn.addEventListener('click', ()=> {
        if(btn.dataset.view==='admin' && !currentUser.isAdmin){
          toast('您沒有管理員權限', 'error'); return;
        }
        switchView(btn.dataset.view);
      }));
      $all('.admin-tab').forEach(btn => btn.addEventListener('click', ()=> switchAdminTab(btn.dataset.adminTab)));
      $('#btnReloadMembers').addEventListener('click', loadAdminMembers);
      $('#btnNewActivity').addEventListener('click', showNewActivityDialog);
      $('#btnLoadFinanceOverview').addEventListener('click', loadFinanceOverview);
      $('#btnLoadExpenseApprovals').addEventListener('click', loadExpenseApprovals);
      $('#btnGenMonthlyReport').addEventListener('click', genMonthlyReport);
      $('#btnGenYearlyReport').addEventListener('click', genYearlyReport);
      $('#btnLoadSettings').addEventListener('click', loadSystemSettings);
      $('#btnSaveSettings').addEventListener('click', saveSystemSettings);
      $('#btnListBackups').addEventListener('click', listBackups);
      $('#btnCreateBackup').addEventListener('click', createBackup);

      $('#btnDonate').addEventListener('click', ()=> new bootstrap.Modal(document.getElementById('donateModal')).show());
      $('#btnSubmitDonate').addEventListener('click', submitDonate);
      $('#btnMyReceipts').addEventListener('click', loadMyReceipts);
      $('#btnMyFinance').addEventListener('click', loadMyFinance);

      // 初始載入
      if(route === 'admin'){
        if(currentUser.isAdmin){ switchView('admin'); switchAdminTab('members'); }
        else { switchView('member'); toast('您沒有管理員權限','error'); }
      }else{
        switchView('member');
      }
      showSubtitle(currentUser.isAdmin ? '管理員模式可用' : '會員模式');
    }

    // ====== 會員端：資料載入與渲染 ======
    async function loadMemberDashboard(){
      const d = await callAPI('getDashboardData', { lineId: currentUser.lineId || '' });
      if(!d.success){ toast('儀表板載入失敗','error'); return; }
      const data = d.data || {};
      // 財務
      $('#statMonthlyDonation').textContent = toCurrency(data.finance?.monthlyDonation || 0);
      $('#statMonthlyExpense').textContent = toCurrency(data.finance?.monthlyExpense || 0);
      $('#statBalance').textContent = toCurrency(data.finance?.balance || 0);
      // 活動
      renderActivities(data.activities || []);
      // 我的報名
      renderMyRegistrations(data.myRegistrations || []);
      // 警示
      renderAlerts(data.alerts || []);
      // 志工需求（另外呼叫 getVolunteerData 取得）
      const v = await callAPI('getVolunteerData', { lineId: currentUser.lineId || '' });
      if(v.success){
        renderVolunteerNeeds(v.data?.needs || []);
      }
    }

    function renderActivities(list){
      const wrap = document.getElementById('activityList'); wrap.innerHTML = '';
      if(!list.length){ wrap.innerHTML = `<div class="text-muted">尚無活動</div>`; return; }
      list.forEach(a=>{
        const div = document.createElement('div');
        div.className='card';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold">${a.title || '-'}</div>
              <div class="text-muted" style="font-size:14px">${fmtDate(a.date)} ${a.time||''}｜${a.location||''}</div>
              <div class="mt-1"><span class="status-badge status-${a.status || '未知'}">${a.status || ''}</span></div>
            </div>
            <div>
              <button class="btn btn-sm btn-primary" ${a.status==='開放報名'?'':'disabled'} data-act="${a.id}">報名</button>
            </div>
          </div>`;
        wrap.appendChild(div);
        const btn = div.querySelector('button[data-act]');
        btn?.addEventListener('click', ()=> registerActivity(a.id));
      });
    }

    async function registerActivity(activityId){
      if(!currentUser.lineId){ toast('請先登入 LINE','error'); return; }
      const r = await callAPI('registerActivity',{ lineId: currentUser.lineId, activityId });
      if(r.success){ toast('報名成功','success'); loadMemberDashboard(); }
      else toast(r.message || '報名失敗','error');
    }

    function renderMyRegistrations(list){
      const wrap = document.getElementById('myRegistrations'); wrap.innerHTML='';
      if(!list.length){ wrap.innerHTML = `<div class="text-muted">尚無記錄</div>`; return; }
      list.forEach(r=>{
        const div = document.createElement('div');
        div.className='card';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold">${r.activityTitle || '-'}</div>
              <div class="text-muted" style="font-size:14px">${fmtDateTime(r.registrationTime)}</div>
              <div class="mt-1"><span class="status-badge status-${r.status}">${r.status}</span></div>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-danger" data-cancel="${r.id}" ${r.status==='已報名'?'':'disabled'}>取消</button>
            </div>
          </div>`;
        wrap.appendChild(div);
        div.querySelector('button[data-cancel]')?.addEventListener('click', ()=> cancelRegistration(r.id));
      });
    }

    async function cancelRegistration(regId){
      if(!currentUser.lineId) return;
      const r = await callAPI('cancelRegistration', { lineId: currentUser.lineId, registrationId: regId });
      if(r.success){ toast('已取消','success'); loadMemberDashboard(); }
      else toast(r.message || '取消失敗','error');
    }

    function renderAlerts(alerts){
      const wrap = document.getElementById('alertsWrap'); wrap.innerHTML='';
      alerts.forEach(a=>{
        const div = document.createElement('div');
        div.className='alert ' + (a.type==='warning'?'alert-warning': a.type==='error'?'alert-danger':'alert-info');
        div.textContent = `${a.title || ''}：${a.message || ''}`;
        wrap.appendChild(div);
      });
    }

    function renderVolunteerNeeds(needs){
      const wrap = document.getElementById('volunteerNeeds'); wrap.innerHTML='';
      if(!needs.length){ wrap.innerHTML='<div class="text-muted">目前無志工需求</div>'; return; }
      needs.forEach(n=>{
        const div = document.createElement('div');
        div.className='card';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold">${n.title || '-'}</div>
              <div class="text-muted" style="font-size:14px">${fmtDate(n.date)} ${n.time||''}</div>
              <div class="text-muted" style="font-size:14px">名額：${n.currentCount||0}/${n.needCount||0}｜時數：${n.hours||0}</div>
            </div>
            <div>
              <button class="btn btn-sm btn-success" data-need="${n.id}">申請</button>
            </div>
          </div>`;
        wrap.appendChild(div);
        div.querySelector('button[data-need]')?.addEventListener('click', ()=> applyVolunteer(n.id));
      });
    }

    async function applyVolunteer(needId){
      if(!currentUser.lineId){ toast('請先登入 LINE','error'); return; }
      const r = await callAPI('applyVolunteer',{ lineId: currentUser.lineId, needId });
      if(r.success){ toast('已申請','success'); loadMemberDashboard(); }
      else toast(r.message || '申請失敗','error');
    }

    // 捐款與收據
    async function submitDonate(){
      if(!currentUser.lineId){ toast('請先登入 LINE','error'); return; }
      const amount = Number($('#donateAmount').value || 0);
      const category = $('#donateCategory').value || '一般捐款';
      const note = $('#donateNote').value || '';
      const needReceipt = $('#needReceipt').checked;
      if(!(amount>0)){ toast('金額需為正數','error'); return; }
      const r = await callAPI('createDonation',{ lineId: currentUser.lineId, amount, category, note, needReceipt });
      if(r.success){
        bootstrap.Modal.getInstance($('#donateModal'))?.hide();
        toast('捐款成功','success');
        loadMemberDashboard();
      }else{
        toast(r.message || '捐款失敗','error');
      }
    }

    async function loadMyReceipts(){
      if(!currentUser.lineId){ toast('請先登入 LINE','error'); return; }
      const r = await callAPI('getMyReceipts', { lineId: currentUser.lineId });
      const wrap = $('#financeLists'); wrap.innerHTML = '<div class="card-title">我的收據</div>';
      if(!r.success){ wrap.innerHTML += '<div class="text-muted">讀取失敗</div>'; return; }
      if(!r.data?.length){ wrap.innerHTML += '<div class="text-muted">尚無收據</div>'; return; }
      r.data.forEach(x=>{
        const a = document.createElement('div');
        a.className='card';
        a.innerHTML = `<div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="fw-bold">收據：${x.receiptNumber}</div>
            <div class="text-muted" style="font-size:14px">${fmtDate(x.issueDate)}｜金額 ${toCurrency(x.amount||0)}</div>
          </div>
          <div><a class="btn btn-sm btn-outline-primary" href="${x.pdfUrl||x.url||'#'}" target="_blank">下載</a></div>
        </div>`;
        wrap.appendChild(a);
      });
    }

    async function loadMyFinance(){
      if(!currentUser.lineId){ toast('請先登入 LINE','error'); return; }
      const r = await callAPI('getFinanceData', { lineId: currentUser.lineId });
      const wrap = $('#financeLists'); wrap.innerHTML = '<div class="card-title">我的收支</div>';
      if(!r.success){ wrap.innerHTML += '<div class="text-muted">讀取失敗</div>'; return; }
      // 捐款
      wrap.innerHTML += '<div class="mt-2 fw-bold">捐款紀錄</div>';
      if(!(r.data?.donations||[]).length){ wrap.innerHTML += '<div class="text-muted">無捐款紀錄</div>'; }
      else r.data.donations.forEach(d=>{
        const div = document.createElement('div');
        div.className='card';
        div.innerHTML = `<div><b>${d.category}</b>｜${fmtDateTime(d.createdAt)}｜<span class="text-success">+${toCurrency(d.amount||0)}</span><br/><span class="text-muted">${d.description||''}</span></div>`;
        wrap.appendChild(div);
      });
      // 支出
      wrap.innerHTML += '<div class="mt-2 fw-bold">支出申請</div>';
      if(!(r.data?.expenses||[]).length){ wrap.innerHTML += '<div class="text-muted">無支出申請</div>'; }
      else r.data.expenses.forEach(e=>{
        const div = document.createElement('div');
        div.className='card';
        div.innerHTML = `<div class="d-flex justify-content-between">
          <div><b>${e.category}</b>｜${fmtDateTime(e.createdAt)}｜<span class="text-danger">-${toCurrency(e.amount||0)}</span><br/><span class="text-muted">${e.description||''}</span><br/><span class="badge bg-${e.status==='審核中'?'warning':'secondary'}">${e.status}</span></div>
          <div><button class="btn btn-sm btn-outline-danger" ${e.status==='審核中'?'':'disabled'} data-cancel-exp="${e.id}">撤回</button></div>
        </div>`;
        wrap.appendChild(div);
        div.querySelector('button[data-cancel-exp]')?.addEventListener('click', ()=> cancelExpense(e.id));
      });
    }

    async function cancelExpense(expenseId){
      const r = await callAPI('cancelExpense', { lineId: currentUser.lineId, expenseId });
      if(r.success){ toast('已撤回','success'); loadMyFinance(); }
      else toast(r.message || '撤回失敗','error');
    }

    // ====== 管理端 ======
    async function loadAdminDashboard(){
      if(!currentUser.isAdmin) return;
      const d = await callAPI('getAdminDashboard', { lineId: currentUser.lineId });
      if(!d.success){ toast('載入儀表板失敗','error'); return; }
      const s = d.data || {};
      $('#adTotalMembers').textContent = s.totalMembers || 0;
      $('#adActiveActivities').textContent = s.activeActivities || 0;
      $('#adMonthlyDonations').textContent = toCurrency(s.monthlyDonations || 0);
      $('#adPendingExpenses').textContent = s.pendingExpenseApprovals || 0;
      $('#adBalance').textContent = toCurrency(s.accountBalance || 0);
      switchAdminTab('members');
    }

    async function loadAdminMembers(){
      const r = await callAPI('getAllMembers', { lineId: currentUser.lineId });
      const tbody = $('#tblMembers'); tbody.innerHTML='';
      if(!r.success){ tbody.innerHTML = '<tr><td colspan="6" class="text-muted">載入失敗</td></tr>'; return; }
      (r.data||[]).forEach(m=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${m.lineId||''}</td><td>${m.realName||m.lineName||''}</td><td>${m.memberType||''}</td><td>${m.status||''}</td><td>${m.phone||''}</td>
          <td class="d-flex gap-2 flex-wrap">
            <button class="btn btn-sm btn-outline-primary" data-view="${m.lineId}">檢視</button>
            <button class="btn btn-sm btn-outline-warning" data-disable="${m.lineId}">停用</button>
            <button class="btn btn-sm btn-outline-danger" data-del="${m.lineId}">刪除</button>
          </td>`;
        tbody.appendChild(tr);
        tr.querySelector('[data-disable]')?.addEventListener('click', ()=> updateMemberStatus(m.lineId, 'disabled'));
        tr.querySelector('[data-del]')?.addEventListener('click', ()=> deleteMember(m.lineId));
        tr.querySelector('[data-view]')?.addEventListener('click', ()=> viewMember(m.lineId));
      });
    }

    async function updateMemberStatus(memberId, status){
      const r = await callAPI('updateMemberStatus', { lineId: currentUser.lineId, memberId, status });
      if(r.success){ toast('已更新','success'); loadAdminMembers(); }
      else toast(r.message || '更新失敗','error');
    }
    async function deleteMember(memberId){
      const r = await callAPI('deleteMember', { lineId: currentUser.lineId, memberId });
      if(r.success){ toast('已刪除','success'); loadAdminMembers(); }
      else toast(r.message || '刪除失敗','error');
    }
    async function viewMember(memberId){
      const r = await callAPI('getMemberDetail', { lineId: currentUser.lineId, memberId });
      if(!r.success){ toast(r.message || '讀取失敗','error'); return; }
      alert(`會員資訊：\n姓名：${r.data.realName||r.data.lineName}\n電話：${r.data.phone||''}\n備註：${r.data.notes||''}`);
    }

    async function loadAdminActivities(){
      const r = await callAPI('getActivities', {}); // 列表
      const wrap = $('#adminActivitiesList'); wrap.innerHTML='';
      if(!r.success){ wrap.innerHTML='<div class="text-muted">載入失敗</div>'; return; }
      (r.data||[]).forEach(a=>{
        const div = document.createElement('div');
        div.className='card';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold">${a.title||'-'}</div>
              <div class="text-muted" style="font-size:14px">${fmtDate(a.date)} ${a.time||''}｜${a.location||''}｜名額 ${a.currentCount||0}/${a.maxParticipants||0}</div>
              <div class="mt-1"><span class="badge bg-${a.status==='開放報名'?'success':'secondary'}">${a.status}</span></div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" data-open="${a.id}">上架</button>
              <button class="btn btn-sm btn-outline-warning" data-close="${a.id}">下架</button>
              <button class="btn btn-sm btn-outline-secondary" data-dupe="${a.id}">複製</button>
              <button class="btn btn-sm btn-outline-danger" data-del="${a.id}">刪除</button>
            </div>
          </div>`;
        wrap.appendChild(div);
        div.querySelector('[data-open]')?.addEventListener('click', ()=> updateActivityStatus(a.id,'open'));
        div.querySelector('[data-close]')?.addEventListener('click', ()=> updateActivityStatus(a.id,'closed'));
        div.querySelector('[data-dupe]')?.addEventListener('click', ()=> duplicateActivity(a.id));
        div.querySelector('[data-del]')?.addEventListener('click', ()=> deleteActivity(a.id));
      });
    }

    async function showNewActivityDialog(){
      const title = prompt('活動名稱？'); if(!title) return;
      const date = prompt('日期（YYYY-MM-DD）？'); if(!date) return;
      const capacity = prompt('名額（數字）？'); if(!capacity) return;
      const r = await callAPI('createActivity',{ lineId: currentUser.lineId, title, start: date+'T00:00:00', capacity: Number(capacity) });
      if(r.success){ toast('活動已建立','success'); loadAdminActivities(); }
      else toast(r.message||'建立失敗','error');
    }
    async function updateActivityStatus(activityId, status){
      const r = await callAPI('updateActivityStatus',{ lineId: currentUser.lineId, activityId, status });
      if(r.success){ toast('已更新','success'); loadAdminActivities(); }
      else toast(r.message||'更新失敗','error');
    }
    async function duplicateActivity(activityId){
      const r = await callAPI('duplicateActivity', { lineId: currentUser.lineId, activityId });
      if(r.success){ toast('已複製','success'); loadAdminActivities(); }
      else toast(r.message||'複製失敗','error');
    }
    async function deleteActivity(activityId){
      const r = await callAPI('deleteActivity', { lineId: currentUser.lineId, activityId });
      if(r.success){ toast('已刪除','success'); loadAdminActivities(); }
      else toast(r.message||'刪除失敗','error');
    }

    // 財務（管理端）
    async function loadFinanceOverview(){
      const r = await callAPI('getFinanceOverview', { lineId: currentUser.lineId });
      const wrap = $('#adminFinanceContent');
      if(!r.success){ wrap.innerHTML = '<div class="text-muted">載入失敗</div>'; return; }
      const d = r.data || {};
      wrap.innerHTML = `
        <div>本月捐款：<b>${toCurrency(d.monthlyDonations||0)}</b></div>
        <div>本月支出：<b>${toCurrency(d.monthlyExpenses||0)}</b></div>
        <div>待審支出：<b>${d.pendingExpenseApprovals||0}</b></div>
        <div>帳戶餘額：<b>${toCurrency(d.accountBalance||0)}</b></div>`;
    }
    async function loadExpenseApprovals(){
      const r = await callAPI('getExpenseApprovals', { lineId: currentUser.lineId });
      const wrap = $('#adminFinanceContent'); wrap.innerHTML = '<div class="fw-bold mb-2">待審支出</div>';
      if(!r.success){ wrap.innerHTML += '<div class="text-muted">載入失敗</div>'; return; }
      (r.data||[]).forEach(x=>{
        const div = document.createElement('div');
        div.className='card';
        div.innerHTML = `<div class="d-flex justify-content-between align-items-center">
          <div><div class="fw-bold">#${x.id}</div><div class="text-muted" style="font-size:14px">${fmtDateTime(x.createdAt)}｜${x.applicantName||''}</div><div>${x.note||''}</div></div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-success" data-approve="${x.id}">核准</button>
            <button class="btn btn-sm btn-danger" data-reject="${x.id}">拒絕</button>
          </div>
        </div>`;
        wrap.appendChild(div);
        div.querySelector('[data-approve]')?.addEventListener('click', ()=> approveExpense(x.id));
        div.querySelector('[data-reject]')?.addEventListener('click', ()=> rejectExpense(x.id));
      });
    }
    async function approveExpense(id){
      const r = await callAPI('approveExpense', { lineId: currentUser.lineId, id });
      if(r.success){ toast('已核准','success'); loadExpenseApprovals(); }
      else toast(r.message||'失敗','error');
    }
    async function rejectExpense(id){
      const r = await callAPI('rejectExpense', { lineId: currentUser.lineId, id });
      if(r.success){ toast('已拒絕','success'); loadExpenseApprovals(); }
      else toast(r.message||'失敗','error');
    }
    async function genMonthlyReport(){
      const r = await callAPI('generateMonthlyReport', { lineId: currentUser.lineId });
      toast(r.success?'已產生（月）':'失敗', r.success?'success':'error');
    }
    async function genYearlyReport(){
      const r = await callAPI('generateYearlyReport', { lineId: currentUser.lineId });
      toast(r.success?'已產生（年）':'失敗', r.success?'success':'error');
    }

    // 設定/備份
    async function loadSystemSettings(){
      const r = await callAPI('getSettings', { lineId: currentUser.lineId });
      const wrap = $('#adminSettingsContent');
      if(!r.success){ wrap.innerHTML = '<div class="text-muted">載入失敗</div>'; return; }
      const d = r.data || {};
      wrap.innerHTML = `
        <div class="mb-2">
          <label class="form-label">收據模板 DocID</label>
          <input class="form-control" id="setReceiptTpl" value="${escapeHtml(d.receiptTemplateDocId||'')}" />
        </div>
        <div class="mb-2">
          <label class="form-label">收據郵件尾段（HTML/純文字）</label>
          <textarea class="form-control" id="setEmailTail">${escapeHtml(d.emailReplyTemplate||'')}</textarea>
        </div>
        <div class="mb-2">
          <label class="form-label">收入類別（逗號分隔）</label>
          <input class="form-control" id="setIncomeCats" value="${(d.incomeCategories||[]).join(',')}" />
        </div>
        <div class="mb-2">
          <label class="form-label">支出類別（逗號分隔）</label>
          <input class="form-control" id="setExpenseCats" value="${(d.expenseCategories||[]).join(',')}" />
        </div>
        <div class="mb-2">
          <label class="form-label">支出憑證 DocID</label>
          <input class="form-control" id="setExpenseTpl" value="${escapeHtml(d.expenseVoucherTemplateDocId||'')}" />
        </div>
        <div class="mb-2">
          <label class="form-label">Drive Folder ID</label>
          <input class="form-control" id="setDriveFolder" value="${escapeHtml(d.driveFolderId||'')}" />
        </div>`;
    }
    async function saveSystemSettings(){
      const payload = {
        lineId: currentUser.lineId,
        receiptTemplateDocId: $('#setReceiptTpl')?.value || '',
        emailReplyTemplate: $('#setEmailTail')?.value || '',
        incomeCategories: ($('#setIncomeCats')?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
        expenseCategories: ($('#setExpenseCats')?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
        expenseVoucherTemplateDocId: $('#setExpenseTpl')?.value || '',
        driveFolderId: $('#setDriveFolder')?.value || ''
      };
      const r = await callAPI('updateSettings', payload);
      toast(r.success ? '已儲存' : (r.message||'儲存失敗'), r.success?'success':'error');
    }
    async function listBackups(){
      const r = await callAPI('listBackups', { lineId: currentUser.lineId });
      const wrap = $('#adminSettingsContent');
      if(!r.success){ toast('讀取失敗','error'); return; }
      wrap.innerHTML = '<div class="fw-bold mb-2">備份列表</div>' + ((r.data||[]).map(x=>`<div class="card"># ${escapeHtml(x.name||'備份')}｜${fmtDateTime(x.createdAt||'')}</div>`).join('') || '<div class="text-muted">尚無備份</div>');
    }
    async function createBackup(){
      const r = await callAPI('createBackup', { lineId: currentUser.lineId });
      toast(r.success?'已建立備份':'建立失敗', r.success?'success':'error');
      if(r.success) listBackups();
    }

    // ====== 小工具 ======
    function toCurrency(n){ return Number(n||0).toLocaleString('zh-TW'); }
    function fmtDate(d){
      if(!d) return '';
      const dt = new Date(d); if(isNaN(dt)) return '';
      return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
    }
    function fmtDateTime(d){
      if(!d) return '';
      const dt = new Date(d); if(isNaN(dt)) return '';
      const h = String(dt.getHours()).padStart(2,'0');
      const m = String(dt.getMinutes()).padStart(2,'0');
      return fmtDate(dt)+' '+h+':'+m;
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // ====== 啟動 ======
    initApp();
  </script>
</body>
</html>
