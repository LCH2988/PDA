<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帕金森病友權益促進會 - 財務收支登記系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #f8f9fa;
            --accent-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: var(--secondary-color);
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #1e3d72);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .sidebar {
            background: white;
            min-height: calc(100vh - 76px);
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            padding: 0;
        }
        
        .sidebar .nav-link {
            color: #333;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }
        
        .sidebar .nav-link:hover {
            background-color: #f8f9fa;
            color: var(--primary-color);
            transform: translateX(5px);
        }
        
        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .main-content {
            padding: 30px;
            background-color: var(--secondary-color);
            min-height: calc(100vh - 76px);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), #1e3d72);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .stat-card.income {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .stat-card.expense {
            background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
        }
        
        .stat-card.balance {
            background: linear-gradient(135deg, #fdbb2d 0%, #22c1c3 100%);
        }
        
        .stat-card.donors {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #1e3d72);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 90, 160, 0.4);
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table thead th {
            background-color: var(--primary-color);
            color: white;
            border: none;
            font-weight: 500;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #1e3d72);
            color: white;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 50px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25);
        }
        
        .page-title {
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 76px;
                left: -250px;
                width: 250px;
                z-index: 1000;
                transition: left 0.3s ease;
            }
            
            .sidebar.show {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
    <!-- 導航列 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <button class="navbar-toggler d-lg-none" type="button" id="sidebarToggle">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="#">
                <i class="fas fa-heartbeat me-2"></i>
                帕金森病友權益促進會 - 財務管理系統
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-user me-1"></i>
                    管理員
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 側邊欄 -->
            <nav class="col-lg-2 sidebar" id="sidebar">
                <div class="nav flex-column">
                    <a class="nav-link active" href="#" data-page="dashboard">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        儀表板
                    </a>
                    <a class="nav-link" href="#" data-page="donations">
                        <i class="fas fa-hand-holding-heart me-2"></i>
                        捐款管理
                    </a>
                    <a class="nav-link" href="#" data-page="expenses">
                        <i class="fas fa-money-bill-wave me-2"></i>
                        支出管理
                    </a>
                    <a class="nav-link" href="#" data-page="donors">
                        <i class="fas fa-users me-2"></i>
                        捐款人管理
                    </a>
                    <a class="nav-link" href="#" data-page="receipts">
                        <i class="fas fa-receipt me-2"></i>
                        收據管理
                    </a>
                    <a class="nav-link" href="#" data-page="budget">
                        <i class="fas fa-chart-pie me-2"></i>
                        預算管理
                    </a>
                    <a class="nav-link" href="#" data-page="reports">
                        <i class="fas fa-chart-bar me-2"></i>
                        報表分析
                    </a>
                    <a class="nav-link" href="#" data-page="accounts">
                        <i class="fas fa-list-alt me-2"></i>
                        科目管理
                    </a>
                    <a class="nav-link" href="#" data-page="settings">
                        <i class="fas fa-cog me-2"></i>
                        系統設定
                    </a>
                </div>
            </nav>

            <!-- 主要內容區 -->
            <main class="col-lg-10 main-content">
                <!-- 儀表板頁面 -->
                <div id="dashboard-page" class="page-content">
                    <h1 class="page-title">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        財務儀表板
                    </h1>
                    
                    <!-- 統計卡片 -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card income">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 class="mb-0" id="totalIncome">$0</h3>
                                        <p class="mb-0">總收入</p>
                                    </div>
                                    <i class="fas fa-arrow-up fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card expense">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 class="mb-0" id="totalExpense">$0</h3>
                                        <p class="mb-0">總支出</p>
                                    </div>
                                    <i class="fas fa-arrow-down fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card balance">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 class="mb-0" id="bankBalance">$0</h3>
                                        <p class="mb-0">帳戶餘額</p>
                                    </div>
                                    <i class="fas fa-wallet fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-card donors">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 class="mb-0" id="donorCount">0</h3>
                                        <p class="mb-0">捐款人數</p>
                                    </div>
                                    <i class="fas fa-users fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 圖表區域 -->
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-line me-2"></i>
                                        月度收支趨勢
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="monthlyTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-pie me-2"></i>
                                        收入來源分布
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="incomeDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 最近交易 -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-history me-2"></i>
                                        最近交易記錄
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>日期</th>
                                                    <th>說明</th>
                                                    <th>類型</th>
                                                    <th class="text-end">金額</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recentTransactions">
                                                <!-- 動態載入 -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 其他頁面將在後續載入 -->
                <div id="donations-page" class="page-content" style="display: none;"></div>
                <div id="expenses-page" class="page-content" style="display: none;"></div>
                <div id="donors-page" class="page-content" style="display: none;"></div>
                <div id="receipts-page" class="page-content" style="display: none;"></div>
                <div id="budget-page" class="page-content" style="display: none;"></div>
                <div id="reports-page" class="page-content" style="display: none;"></div>
                <div id="accounts-page" class="page-content" style="display: none;"></div>
                <div id="settings-page" class="page-content" style="display: none;"></div>

                <!-- 載入中畫面 -->
                <div class="loading" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                    <p class="mt-3">資料載入中，請稍候...</p>
                </div>
            </main>
        </div>
    </div>

    <!-- 通知區域 -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
        <div id="toast-container"></div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <script>
        // 全域變數
        const API_URL = 'https://script.google.com/macros/s/AKfycbyaqUdHrzZ48hIP6aPpkjRqOGw3V_oyzo81ifgTMczaSlDCuoGSG8DfOioBh7bopaoo/exec'; // 請替換為您的 GAS Web App URL
        let currentPage = 'dashboard';
        let dashboardData = {};
        let monthlyTrendChart = null;
        let incomeDistributionChart = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadDashboardData();
        });

        // 初始化應用程式
        function initializeApp() {
            console.log('財務管理系統初始化...');
        }

        // 設定事件監聽器
        function setupEventListeners() {
            // 側邊欄導航
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    navigateToPage(page);
                });
            });

            // 手機版側邊欄切換
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    document.getElementById('sidebar').classList.toggle('show');
                });
            }
        }

        // 頁面導航
        function navigateToPage(page) {
            // 更新導航狀態
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-page="${page}"]`).classList.add('active');

            // 隱藏所有頁面
            document.querySelectorAll('.page-content').forEach(pageElement => {
                pageElement.style.display = 'none';
            });

            // 顯示目標頁面
            const targetPage = document.getElementById(`${page}-page`);
            if (targetPage) {
                targetPage.style.display = 'block';
                currentPage = page;

                // 載入頁面內容
                loadPageContent(page);
            }

            // 關閉手機版側邊欄
            document.getElementById('sidebar').classList.remove('show');
        }

        // 載入頁面內容
        async function loadPageContent(page) {
            try {
                switch (page) {
                    case 'dashboard':
                        await loadDashboardData();
                        break;
                    case 'donations':
                        await loadDonationsPage();
                        break;
                    case 'expenses':
                        await loadExpensesPage();
                        break;
                    case 'donors':
                        await loadDonorsPage();
                        break;
                    case 'receipts':
                        await loadReceiptsPage();
                        break;
                    case 'budget':
                        await loadBudgetPage();
                        break;
                    case 'reports':
                        await loadReportsPage();
                        break;
                    case 'accounts':
                        await loadAccountsPage();
                        break;
                    case 'settings':
                        await loadSettingsPage();
                        break;
                }
            } catch (error) {
                console.error('載入頁面內容失敗:', error);
                showToast('載入頁面失敗', 'error');
            }
        }

        // 載入儀表板資料
        async function loadDashboardData() {
            try {
                showLoading(true);
                
                const response = await fetch(`${API_URL}?action=getDashboardData`);
                dashboardData = await response.json();

                // 更新統計卡片
                updateStatCards();
                
                // 更新圖表
                updateCharts();
                
                // 更新最近交易
                updateRecentTransactions();

            } catch (error) {
                console.error('載入儀表板資料失敗:', error);
                showToast('載入儀表板資料失敗', 'error');
            } finally {
                showLoading(false);
            }
        }

        // 更新統計卡片
        function updateStatCards() {
            document.getElementById('totalIncome').textContent = formatCurrency(dashboardData.totalIncome || 0);
            document.getElementById('totalExpense').textContent = formatCurrency(dashboardData.totalExpense || 0);
            document.getElementById('bankBalance').textContent = formatCurrency(dashboardData.bankBalance || 0);
            document.getElementById('donorCount').textContent = dashboardData.donorCount || 0;
        }

        // 更新圖表
        function updateCharts() {
            updateMonthlyTrendChart();
            updateIncomeDistributionChart();
        }

        // 更新月度趨勢圖表
        function updateMonthlyTrendChart() {
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
            
            if (monthlyTrendChart) {
                monthlyTrendChart.destroy();
            }

            const monthlyTrend = dashboardData.monthlyTrend || { labels: [], income: [], expense: [] };

            monthlyTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyTrend.labels,
                    datasets: [{
                        label: '收入',
                        data: monthlyTrend.income,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: '支出',
                        data: monthlyTrend.expense,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // 更新收入分布圖表
        function updateIncomeDistributionChart() {
            const ctx = document.getElementById('incomeDistributionChart').getContext('2d');
            
            if (incomeDistributionChart) {
                incomeDistributionChart.destroy();
            }

            const incomeDistribution = dashboardData.incomeDistribution || { labels: [], values: [] };

            incomeDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: incomeDistribution.labels,
                    datasets: [{
                        data: incomeDistribution.values,
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 更新最近交易
        function updateRecentTransactions() {
            const tbody = document.getElementById('recentTransactions');
            const transactions = dashboardData.recentTransactions || [];

            tbody.innerHTML = '';

            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">暫無交易記錄</td></tr>';
                return;
            }

            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                const typeClass = transaction.type === '收入' ? 'text-success' : 'text-danger';
                const typeIcon = transaction.type === '收入' ? 'fa-arrow-up' : 'fa-arrow-down';
                
                row.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.description}</td>
                    <td>
                        <span class="${typeClass}">
                            <i class="fas ${typeIcon} me-1"></i>
                            ${transaction.type}
                        </span>
                    </td>
                    <td class="text-end ${typeClass}">${formatCurrency(transaction.amount)}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // 工具函數
        function formatCurrency(amount) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW');
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            loading.style.display = show ? 'block' : 'none';
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'primary'} border-0" role="alert" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        // API 呼叫函數
        async function apiCall(action, data = null, method = 'GET') {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (method === 'POST' && data) {
                    options.body = JSON.stringify({
                        action: action,
                        ...data
                    });
                }

                const url = method === 'GET' ? `${API_URL}?action=${action}` : API_URL;
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API 呼叫失敗:', error);
                throw error;
            }
        }

        
            // 捐款管理相關函數
            let donationsData = [];
            let donorsData = [];

            async function loadDonationsPage() {
                const pageContent = `
                    <h1 class="page-title">
                        <i class="fas fa-hand-holding-heart me-2"></i>
                        捐款管理
                    </h1>
                    
                    <!-- 操作按鈕 -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-primary" onclick="showAddDonationModal()">
                                <i class="fas fa-plus me-1"></i>
                                新增捐款
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="exportDonations()">
                                <i class="fas fa-download me-1"></i>
                                匯出資料
                            </button>
                        </div>
                        
                        <!-- 篩選器 -->
                        <div class="d-flex gap-2">
                            <select class="form-select" id="donationYearFilter" onchange="filterDonations()">
                                <option value="">全部年度</option>
                            </select>
                            <select class="form-select" id="donationTypeFilter" onchange="filterDonations()">
                                <option value="">全部類型</option>
                                <option value="一般捐款">一般捐款</option>
                                <option value="指定捐款">指定捐款</option>
                                <option value="活動捐款">活動捐款</option>
                                <option value="物資捐贈">物資捐贈</option>
                            </select>
                        </div>
                    </div>

                    <!-- 捐款列表 -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>
                                捐款記錄
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>捐款日期</th>
                                            <th>捐款人</th>
                                            <th>捐款類型</th>
                                            <th>付款方式</th>
                                            <th class="text-end">金額</th>
                                            <th>收據狀態</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="donationsTableBody">
                                        <!-- 動態載入 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('donations-page').innerHTML = pageContent;
                
                // 載入資料
                await loadDonationsData();
                await loadDonorsData();
                setupDonationYearFilter();
            }

            async function loadDonationsData() {
                try {
                    showLoading(true);
                    donationsData = await apiCall('getDonations');
                    renderDonationsTable();
                } catch (error) {
                    console.error('載入捐款資料失敗:', error);
                    showToast('載入捐款資料失敗', 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function loadDonorsData() {
                try {
                    donorsData = await apiCall('getDonors');
                } catch (error) {
                    console.error('載入捐款人資料失敗:', error);
                }
            }

            function renderDonationsTable() {
                const tbody = document.getElementById('donationsTableBody');
                
                if (!donationsData || donationsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暫無捐款記錄</td></tr>';
                    return;
                }

                tbody.innerHTML = donationsData.map(donation => `
                    <tr>
                        <td>${formatDate(donation['捐款日期'])}</td>
                        <td>${donation['捐款人姓名']}</td>
                        <td>
                            <span class="badge bg-primary">${donation['捐款類型']}</span>
                        </td>
                        <td>${donation['付款方式']}</td>
                        <td class="text-end text-success fw-bold">${formatCurrency(donation['金額'])}</td>
                        <td>
                            <span class="badge ${getReceiptStatusClass(donation['收據狀態'])}">
                                ${donation['收據狀態']}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editDonation('${donation['ID']}')" title="編輯">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteDonation('${donation['ID']}')" title="刪除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            function setupDonationYearFilter() {
                const yearFilter = document.getElementById('donationYearFilter');
                const years = [...new Set(donationsData.map(d => new Date(d['捐款日期']).getFullYear()))].sort((a, b) => b - a);
                
                yearFilter.innerHTML = '<option value="">全部年度</option>' + 
                    years.map(year => `<option value="${year}">${year}年</option>`).join('');
            }

            function filterDonations() {
                const yearFilter = document.getElementById('donationYearFilter').value;
                const typeFilter = document.getElementById('donationTypeFilter').value;
                
                let filteredData = donationsData;
                
                if (yearFilter) {
                    filteredData = filteredData.filter(d => new Date(d['捐款日期']).getFullYear() == yearFilter);
                }
                
                if (typeFilter) {
                    filteredData = filteredData.filter(d => d['捐款類型'] === typeFilter);
                }
                
                // 暫時更新表格顯示
                const originalData = donationsData;
                donationsData = filteredData;
                renderDonationsTable();
                donationsData = originalData;
            }

            function getReceiptStatusClass(status) {
                switch (status) {
                    case '已開立': return 'bg-success';
                    case '已寄送': return 'bg-info';
                    case '待處理': return 'bg-warning';
                    default: return 'bg-secondary';
                }
            }

            function showAddDonationModal() {
                const modalHtml = `
                    <div class="modal fade" id="donationModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-plus me-2"></i>
                                        新增捐款記錄
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="donationForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">捐款日期 *</label>
                                                <input type="date" class="form-control" id="donationDate" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">捐款類型 *</label>
                                                <select class="form-select" id="donationType" required>
                                                    <option value="">請選擇</option>
                                                    <option value="一般捐款">一般捐款</option>
                                                    <option value="指定捐款">指定捐款</option>
                                                    <option value="活動捐款">活動捐款</option>
                                                    <option value="物資捐贈">物資捐贈</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">捐款人姓名 *</label>
                                                <input type="text" class="form-control" id="donorName" required 
                                                      list="donorsList" onchange="fillDonorInfo()">
                                                <datalist id="donorsList">
                                                    ${donorsData.map(donor => `<option value="${donor['姓名']}">`).join('')}
                                                </datalist>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">身分證字號</label>
                                                <input type="text" class="form-control" id="donorId" maxlength="10">
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">聯絡電話</label>
                                                <input type="tel" class="form-control" id="donorPhone">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">電子郵件</label>
                                                <input type="email" class="form-control" id="donorEmail">
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">聯絡地址</label>
                                            <input type="text" class="form-control" id="donorAddress">
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">捐款金額 *</label>
                                                <input type="number" class="form-control" id="donationAmount" required min="1">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">付款方式 *</label>
                                                <select class="form-select" id="paymentMethod" required>
                                                    <option value="">請選擇</option>
                                                    <option value="現金">現金</option>
                                                    <option value="支票">支票</option>
                                                    <option value="轉帳">轉帳</option>
                                                    <option value="信用卡">信用卡</option>
                                                    <option value="電子支付">電子支付</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">是否需要收據</label>
                                                <select class="form-select" id="receiptNeeded">
                                                    <option value="是">是</option>
                                                    <option value="否">否</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">備註</label>
                                            <textarea class="form-control" id="donationNotes" rows="3"></textarea>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" onclick="saveDonation()">儲存</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // 設定預設日期為今天
                document.getElementById('donationDate').value = new Date().toISOString().split('T')[0];
                
                const modal = new bootstrap.Modal(document.getElementById('donationModal'));
                modal.show();
                
                // 清理 modal
                document.getElementById('donationModal').addEventListener('hidden.bs.modal', function() {
                    this.remove();
                });
            }

            function fillDonorInfo() {
                const donorName = document.getElementById('donorName').value;
                const donor = donorsData.find(d => d['姓名'] === donorName);
                
                if (donor) {
                    document.getElementById('donorId').value = donor['身分證字號'] || '';
                    document.getElementById('donorPhone').value = donor['聯絡電話'] || '';
                    document.getElementById('donorEmail').value = donor['電子郵件'] || '';
                    document.getElementById('donorAddress').value = donor['聯絡地址'] || '';
                }
            }

            async function saveDonation() {
                const form = document.getElementById('donationForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const donationData = {
                    donationDate: document.getElementById('donationDate').value,
                    donorName: document.getElementById('donorName').value,
                    donorId: document.getElementById('donorId').value,
                    donorPhone: document.getElementById('donorPhone').value,
                    donorEmail: document.getElementById('donorEmail').value,
                    donorAddress: document.getElementById('donorAddress').value,
                    donationAmount: parseFloat(document.getElementById('donationAmount').value),
                    donationType: document.getElementById('donationType').value,
                    paymentMethod: document.getElementById('paymentMethod').value,
                    receiptNeeded: document.getElementById('receiptNeeded').value,
                    notes: document.getElementById('donationNotes').value
                };
                
                try {
                    showLoading(true);
                    const result = await apiCall('addDonation', { data: donationData }, 'POST');
                    
                    if (result.success) {
                        showToast('捐款記錄新增成功');
                        bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
                        await loadDonationsData();
                    } else {
                        showToast('新增失敗: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('新增捐款失敗:', error);
                    showToast('新增捐款失敗', 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function editDonation(donationId) {
                const donation = donationsData.find(d => d['ID'] === donationId);
                if (!donation) return;
                
                showAddDonationModal();
                
                // 等待 modal 完全載入
                setTimeout(() => {
                    document.getElementById('donationDate').value = formatDateForInput(donation['捐款日期']);
                    document.getElementById('donorName').value = donation['捐款人姓名'];
                    document.getElementById('donorId').value = donation['身分證字號'] || '';
                    document.getElementById('donorPhone').value = donation['聯絡電話'] || '';
                    document.getElementById('donorEmail').value = donation['電子郵件'] || '';
                    document.getElementById('donorAddress').value = donation['聯絡地址'] || '';
                    document.getElementById('donationAmount').value = donation['金額'];
                    document.getElementById('donationType').value = donation['捐款類型'];
                    document.getElementById('paymentMethod').value = donation['付款方式'];
                    document.getElementById('receiptNeeded').value = donation['需要收據'];
                    document.getElementById('donationNotes').value = donation['備註'] || '';
                    
                    // 更改標題和儲存函數
                    document.querySelector('#donationModal .modal-title').innerHTML = 
                        '<i class="fas fa-edit me-2"></i>編輯捐款記錄';
                    document.querySelector('#donationModal .btn-primary').onclick = () => updateDonation(donationId);
                }, 100);
            }

            async function updateDonation(donationId) {
                const form = document.getElementById('donationForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const donationData = {
                    id: donationId,
                    donationDate: document.getElementById('donationDate').value,
                    donorName: document.getElementById('donorName').value,
                    donorId: document.getElementById('donorId').value,
                    donorPhone: document.getElementById('donorPhone').value,
                    donorEmail: document.getElementById('donorEmail').value,
                    donorAddress: document.getElementById('donorAddress').value,
                    donationAmount: parseFloat(document.getElementById('donationAmount').value),
                    donationType: document.getElementById('donationType').value,
                    paymentMethod: document.getElementById('paymentMethod').value,
                    receiptNeeded: document.getElementById('receiptNeeded').value,
                    notes: document.getElementById('donationNotes').value
                };
                
                try {
                    showLoading(true);
                    const result = await apiCall('updateDonation', { data: donationData }, 'POST');
                    
                    if (result.success) {
                        showToast('捐款記錄更新成功');
                        bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
                        await loadDonationsData();
                    } else {
                        showToast('更新失敗: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('更新捐款失敗:', error);
                    showToast('更新捐款失敗', 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function deleteDonation(donationId) {
                if (!confirm('確定要刪除這筆捐款記錄嗎？此操作無法復原。')) {
                    return;
                }
                
                try {
                    showLoading(true);
                    const result = await apiCall('deleteDonation', { id: donationId }, 'POST');
                    
                    if (result.success) {
                        showToast('捐款記錄刪除成功');
                        await loadDonationsData();
                    } else {
                        showToast('刪除失敗: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('刪除捐款失敗:', error);
                    showToast('刪除捐款失敗', 'error');
                } finally {
                    showLoading(false);
                }
            }

            function exportDonations() {
                // 簡單的 CSV 匯出
                const headers = ['捐款日期', '捐款人姓名', '捐款類型', '付款方式', '金額', '收據狀態'];
                const csvContent = [
                    headers.join(','),
                    ...donationsData.map(donation => [
                        formatDate(donation['捐款日期']),
                        donation['捐款人姓名'],
                        donation['捐款類型'],
                        donation['付款方式'],
                        donation['金額'],
                        donation['收據狀態']
                    ].join(','))
                ].join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `捐款記錄_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            }

            function formatDateForInput(dateString) {
                const date = new Date(dateString);
                return date.toISOString().split('T')[0];
            }


// 支出管理相關函數
let expensesData = [];
let accountsData = [];

async function loadExpensesPage() {
    const pageContent = `
        <h1 class="page-title">
            <i class="fas fa-money-bill-wave me-2"></i>
            支出管理
        </h1>
        
        <!-- 操作按鈕 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary" onclick="showAddExpenseModal()">
                    <i class="fas fa-plus me-1"></i>
                    新增支出
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="exportExpenses()">
                    <i class="fas fa-download me-1"></i>
                    匯出資料
                </button>
            </div>
            
            <!-- 篩選器 -->
            <div class="d-flex gap-2">
                <select class="form-select" id="expenseYearFilter" onchange="filterExpenses()">
                    <option value="">全部年度</option>
                </select>
                <select class="form-select" id="expenseCategoryFilter" onchange="filterExpenses()">
                    <option value="">全部類別</option>
                </select>
            </div>
        </div>

        <!-- 支出列表 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    支出記錄
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>支出日期</th>
                                <th>支出類別</th>
                                <th>說明</th>
                                <th>收款人</th>
                                <th>付款方式</th>
                                <th class="text-end">金額</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <!-- 動態載入 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    document.getElementById('expenses-page').innerHTML = pageContent;
    
    // 載入資料
    await loadExpensesData();
    await loadAccountsData();
    setupExpenseFilters();
}

async function loadExpensesData() {
    try {
        showLoading(true);
        expensesData = await apiCall('getExpenses');
        renderExpensesTable();
    } catch (error) {
        console.error('載入支出資料失敗:', error);
        showToast('載入支出資料失敗', 'error');
    } finally {
        showLoading(false);
    }
}

async function loadAccountsData() {
    try {
        accountsData = await apiCall('getAccounts');
    } catch (error) {
        console.error('載入科目資料失敗:', error);
    }
}

function renderExpensesTable() {
    const tbody = document.getElementById('expensesTableBody');
    
    if (!expensesData || expensesData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暫無支出記錄</td></tr>';
        return;
    }

    tbody.innerHTML = expensesData.map(expense => `
        <tr>
            <td>${formatDate(expense['支出日期'])}</td>
            <td>
                <span class="badge bg-info">${expense['支出類別']}</span>
            </td>
            <td>${expense['說明']}</td>
            <td>${expense['收款人']}</td>
            <td>${expense['付款方式']}</td>
            <td class="text-end text-danger fw-bold">${formatCurrency(expense['金額'])}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editExpense('${expense['ID']}')" title="編輯">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteExpense('${expense['ID']}')" title="刪除">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function setupExpenseFilters() {
    // 年度篩選器
    const yearFilter = document.getElementById('expenseYearFilter');
    const years = [...new Set(expensesData.map(e => new Date(e['支出日期']).getFullYear()))].sort((a, b) => b - a);
    yearFilter.innerHTML = '<option value="">全部年度</option>' + 
        years.map(year => `<option value="${year}">${year}年</option>`).join('');
    
    // 類別篩選器
    const categoryFilter = document.getElementById('expenseCategoryFilter');
    const categories = [...new Set(expensesData.map(e => e['支出類別']))].sort();
    categoryFilter.innerHTML = '<option value="">全部類別</option>' + 
        categories.map(category => `<option value="${category}">${category}</option>`).join('');
}

function filterExpenses() {
    const yearFilter = document.getElementById('expenseYearFilter').value;
    const categoryFilter = document.getElementById('expenseCategoryFilter').value;
    
    let filteredData = expensesData;
    
    if (yearFilter) {
        filteredData = filteredData.filter(e => new Date(e['支出日期']).getFullYear() == yearFilter);
    }
    
    if (categoryFilter) {
        filteredData = filteredData.filter(e => e['支出類別'] === categoryFilter);
    }
    
    // 暫時更新表格顯示
    const originalData = expensesData;
    expensesData = filteredData;
    renderExpensesTable();
    expensesData = originalData;
}

function showAddExpenseModal() {
    const expenseCategories = accountsData
        .filter(account => account['科目類型'] === '支出科目' && account['狀態'] === '啟用')
        .map(account => account['科目名稱']);
    
    const modalHtml = `
        <div class="modal fade" id="expenseModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-plus me-2"></i>
                            新增支出記錄
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="expenseForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">支出日期 *</label>
                                    <input type="date" class="form-control" id="expenseDate" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">支出類別 *</label>
                                    <select class="form-select" id="expenseCategory" required>
                                        <option value="">請選擇</option>
                                        ${expenseCategories.map(category => 
                                            `<option value="${category}">${category}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">支出說明 *</label>
                                <input type="text" class="form-control" id="expenseDescription" required>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">收款人 *</label>
                                    <input type="text" class="form-control" id="expensePayee" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">支出金額 *</label>
                                    <input type="number" class="form-control" id="expenseAmount" required min="1">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">付款方式 *</label>
                                    <select class="form-select" id="expenseMethod" required>
                                        <option value="">請選擇</option>
                                        <option value="現金">現金</option>
                                        <option value="支票">支票</option>
                                        <option value="轉帳">轉帳</option>
                                        <option value="信用卡">信用卡</option>
                                        <option value="電子支付">電子支付</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">發票號碼</label>
                                    <input type="text" class="form-control" id="expenseInvoice">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">備註</label>
                                <textarea class="form-control" id="expenseNote" rows="3"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveExpense()">儲存</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // 設定預設日期為今天
    document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    
    const modal = new bootstrap.Modal(document.getElementById('expenseModal'));
    modal.show();
    
    // 清理 modal
    document.getElementById('expenseModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

async function saveExpense() {
    const form = document.getElementById('expenseForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const expenseData = {
        expenseDate: document.getElementById('expenseDate').value,
        expenseCategory: document.getElementById('expenseCategory').value,
        description: document.getElementById('expenseDescription').value,
        payee: document.getElementById('expensePayee').value,
        expenseAmount: parseFloat(document.getElementById('expenseAmount').value),
        expenseMethod: document.getElementById('expenseMethod').value,
        invoice: document.getElementById('expenseInvoice').value,
        note: document.getElementById('expenseNote').value
    };
    
    try {
        showLoading(true);
        const result = await apiCall('addExpense', { data: expenseData }, 'POST');
        
        if (result.success) {
            showToast('支出記錄新增成功');
            bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
            await loadExpensesData();
        } else {
            showToast('新增失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('新增支出失敗:', error);
        showToast('新增支出失敗', 'error');
    } finally {
        showLoading(false);
    }
}

async function editExpense(expenseId) {
    const expense = expensesData.find(e => e['ID'] === expenseId);
    if (!expense) return;
    
    showAddExpenseModal();
    
    // 等待 modal 完全載入
    setTimeout(() => {
        document.getElementById('expenseDate').value = formatDateForInput(expense['支出日期']);
        document.getElementById('expenseCategory').value = expense['支出類別'];
        document.getElementById('expenseDescription').value = expense['說明'];
        document.getElementById('expensePayee').value = expense['收款人'];
        document.getElementById('expenseAmount').value = expense['金額'];
        document.getElementById('expenseMethod').value = expense['付款方式'];
        document.getElementById('expenseInvoice').value = expense['發票號碼'] || '';
        document.getElementById('expenseNote').value = expense['備註'] || '';
        
        // 更改標題和儲存函數
        document.querySelector('#expenseModal .modal-title').innerHTML = 
            '<i class="fas fa-edit me-2"></i>編輯支出記錄';
        document.querySelector('#expenseModal .btn-primary').onclick = () => updateExpense(expenseId);
    }, 100);
}

async function updateExpense(expenseId) {
    const form = document.getElementById('expenseForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const expenseData = {
        id: expenseId,
        expenseDate: document.getElementById('expenseDate').value,
        expenseCategory: document.getElementById('expenseCategory').value,
        description: document.getElementById('expenseDescription').value,
        payee: document.getElementById('expensePayee').value,
        expenseAmount: parseFloat(document.getElementById('expenseAmount').value),
        expenseMethod: document.getElementById('expenseMethod').value,
        invoice: document.getElementById('expenseInvoice').value,
        note: document.getElementById('expenseNote').value
    };
    
    try {
        showLoading(true);
        const result = await apiCall('updateExpense', { data: expenseData }, 'POST');
        
        if (result.success) {
            showToast('支出記錄更新成功');
            bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
            await loadExpensesData();
        } else {
            showToast('更新失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('更新支出失敗:', error);
        showToast('更新支出失敗', 'error');
    } finally {
        showLoading(false);
    }
}

async function deleteExpense(expenseId) {
    if (!confirm('確定要刪除這筆支出記錄嗎？此操作無法復原。')) {
        return;
    }
    
    try {
        showLoading(true);
        const result = await apiCall('deleteExpense', { id: expenseId }, 'POST');
        
        if (result.success) {
            showToast('支出記錄刪除成功');
            await loadExpensesData();
        } else {
            showToast('刪除失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('刪除支出失敗:', error);
        showToast('刪除支出失敗', 'error');
    } finally {
        showLoading(false);
    }
}

function exportExpenses() {
    const headers = ['支出日期', '支出類別', '說明', '收款人', '付款方式', '金額'];
    const csvContent = [
        headers.join(','),
        ...expensesData.map(expense => [
            formatDate(expense['支出日期']),
            expense['支出類別'],
            expense['說明'],
            expense['收款人'],
            expense['付款方式'],
            expense['金額']
        ].join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `支出記錄_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

// 捐款人管理相關函數
async function loadDonorsPage() {
    const pageContent = `
        <h1 class="page-title">
            <i class="fas fa-users me-2"></i>
            捐款人管理
        </h1>
        
        <!-- 操作按鈕 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary" onclick="showAddDonorModal()">
                    <i class="fas fa-plus me-1"></i>
                    新增捐款人
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="exportDonors()">
                    <i class="fas fa-download me-1"></i>
                    匯出資料
                </button>
            </div>
            
            <!-- 搜尋框 -->
            <div class="input-group" style="width: 300px;">
                <input type="text" class="form-control" id="donorSearchInput" 
                       placeholder="搜尋捐款人姓名或電話..." onkeyup="searchDonors()">
                <button class="btn btn-outline-secondary" type="button" onclick="clearDonorSearch()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- 捐款人列表 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    捐款人資料
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>姓名</th>
                                <th>聯絡電話</th>
                                <th>電子郵件</th>
                                <th>捐款次數</th>
                                <th class="text-end">累計捐款</th>
                                <th>最後捐款</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="donorsTableBody">
                            <!-- 動態載入 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    document.getElementById('donors-page').innerHTML = pageContent;
    
    // 載入資料
    await loadAllDonorsData();
}

async function loadAllDonorsData() {
    try {
        showLoading(true);
        donorsData = await apiCall('getDonors');
        renderDonorsTable();
    } catch (error) {
        console.error('載入捐款人資料失敗:', error);
        showToast('載入捐款人資料失敗', 'error');
    } finally {
        showLoading(false);
    }
}

function renderDonorsTable() {
    const tbody = document.getElementById('donorsTableBody');
    
    if (!donorsData || donorsData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暫無捐款人資料</td></tr>';
        return;
    }

    tbody.innerHTML = donorsData.map(donor => `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <div class="avatar-circle me-2">
                        ${donor['姓名'].charAt(0)}
                    </div>
                    <div>
                        <div class="fw-bold">${donor['姓名']}</div>
                        <small class="text-muted">${donor['身分證字號'] || ''}</small>
                    </div>
                </div>
            </td>
            <td>${donor['聯絡電話'] || '-'}</td>
            <td>${donor['電子郵件'] || '-'}</td>
            <td>
                <span class="badge bg-info">${donor['捐款次數'] || 0}次</span>
            </td>
            <td class="text-end text-success fw-bold">${formatCurrency(donor['累計捐款金額'] || 0)}</td>
            <td>${donor['最後捐款日期'] ? formatDate(donor['最後捐款日期']) : '-'}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info" onclick="viewDonorDetail('${donor['ID']}')" title="詳細">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-primary" onclick="editDonor('${donor['ID']}')" title="編輯">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteDonor('${donor['ID']}')" title="刪除">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function searchDonors() {
    const searchTerm = document.getElementById('donorSearchInput').value.toLowerCase();
    
    if (!searchTerm) {
        renderDonorsTable();
        return;
    }
    
    const filteredDonors = donorsData.filter(donor => 
        donor['姓名'].toLowerCase().includes(searchTerm) ||
        (donor['聯絡電話'] && donor['聯絡電話'].includes(searchTerm)) ||
        (donor['電子郵件'] && donor['電子郵件'].toLowerCase().includes(searchTerm))
    );
    
    const originalData = donorsData;
    donorsData = filteredDonors;
    renderDonorsTable();
    donorsData = originalData;
}

function clearDonorSearch() {
    document.getElementById('donorSearchInput').value = '';
    renderDonorsTable();
}

function showAddDonorModal() {
    const modalHtml = `
        <div class="modal fade" id="donorModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-plus me-2"></i>
                            新增捐款人
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="donorForm">
                            <div class="mb-3">
                                <label class="form-label">姓名 *</label>
                                <input type="text" class="form-control" id="donorFormName" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">身分證字號</label>
                                <input type="text" class="form-control" id="donorFormId" maxlength="10">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">聯絡電話</label>
                                <input type="tel" class="form-control" id="donorFormPhone">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">電子郵件</label>
                                <input type="email" class="form-control" id="donorFormEmail">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">聯絡地址</label>
                                <textarea class="form-control" id="donorFormAddress" rows="3"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">備註</label>
                                <textarea class="form-control" id="donorFormNotes" rows="2"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveDonor()">儲存</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    const modal = new bootstrap.Modal(document.getElementById('donorModal'));
    modal.show();
    
    // 清理 modal
    document.getElementById('donorModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

async function saveDonor() {
    const form = document.getElementById('donorForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const donorData = {
        name: document.getElementById('donorFormName').value,
        idNumber: document.getElementById('donorFormId').value,
        phone: document.getElementById('donorFormPhone').value,
        email: document.getElementById('donorFormEmail').value,
        address: document.getElementById('donorFormAddress').value,
        notes: document.getElementById('donorFormNotes').value
    };
    
    try {
        showLoading(true);
        const result = await apiCall('addDonor', { data: donorData }, 'POST');
        
        if (result.success) {
            showToast('捐款人新增成功');
            bootstrap.Modal.getInstance(document.getElementById('donorModal')).hide();
            await loadAllDonorsData();
        } else {
            showToast('新增失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('新增捐款人失敗:', error);
        showToast('新增捐款人失敗', 'error');
    } finally {
        showLoading(false);
    }
}

async function editDonor(donorId) {
    const donor = donorsData.find(d => d['ID'] === donorId);
    if (!donor) return;
    
    showAddDonorModal();
    
    // 等待 modal 完全載入
    setTimeout(() => {
        document.getElementById('donorFormName').value = donor['姓名'];
        document.getElementById('donorFormId').value = donor['身分證字號'] || '';
        document.getElementById('donorFormPhone').value = donor['聯絡電話'] || '';
        document.getElementById('donorFormEmail').value = donor['電子郵件'] || '';
        document.getElementById('donorFormAddress').value = donor['聯絡地址'] || '';
        document.getElementById('donorFormNotes').value = donor['備註'] || '';
        
        // 更改標題和儲存函數
        document.querySelector('#donorModal .modal-title').innerHTML = 
            '<i class="fas fa-edit me-2"></i>編輯捐款人';
        document.querySelector('#donorModal .btn-primary').onclick = () => updateDonor(donorId);
    }, 100);
}

async function updateDonor(donorId) {
    const form = document.getElementById('donorForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const donorData = {
        id: donorId,
        name: document.getElementById('donorFormName').value,
        idNumber: document.getElementById('donorFormId').value,
        phone: document.getElementById('donorFormPhone').value,
        email: document.getElementById('donorFormEmail').value,
        address: document.getElementById('donorFormAddress').value,
        notes: document.getElementById('donorFormNotes').value
    };
    
    try {
        showLoading(true);
        const result = await apiCall('updateDonor', { data: donorData }, 'POST');
        
        if (result.success) {
            showToast('捐款人資料更新成功');
            bootstrap.Modal.getInstance(document.getElementById('donorModal')).hide();
            await loadAllDonorsData();
        } else {
            showToast('更新失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('更新捐款人失敗:', error);
        showToast('更新捐款人失敗', 'error');
    } finally {
        showLoading(false);
    }
}

async function deleteDonor(donorId) {
    if (!confirm('確定要刪除這位捐款人嗎？此操作無法復原。')) {
        return;
    }
    
    try {
        showLoading(true);
        const result = await apiCall('deleteDonor', { id: donorId }, 'POST');
        
        if (result.success) {
            showToast('捐款人刪除成功');
            await loadAllDonorsData();
        } else {
            showToast('刪除失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('刪除捐款人失敗:', error);
        showToast('刪除捐款人失敗', 'error');
    } finally {
        showLoading(false);
    }
}

function viewDonorDetail(donorId) {
    const donor = donorsData.find(d => d['ID'] === donorId);
    if (!donor) return;
    
    const modalHtml = `
        <div class="modal fade" id="donorDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-user me-2"></i>
                            捐款人詳細資料
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">基本資料</h6>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-borderless">
                                            <tr>
                                                <td class="fw-bold">姓名：</td>
                                                <td>${donor['姓名']}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">身分證字號：</td>
                                                <td>${donor['身分證字號'] || '-'}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">聯絡電話：</td>
                                                <td>${donor['聯絡電話'] || '-'}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">電子郵件：</td>
                                                <td>${donor['電子郵件'] || '-'}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">聯絡地址：</td>
                                                <td>${donor['聯絡地址'] || '-'}</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">捐款統計</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="text-center">
                                            <div class="stat-item mb-3">
                                                <h3 class="text-primary">${donor['捐款次數'] || 0}</h3>
                                                <p class="mb-0">捐款次數</p>
                                            </div>
                                            <div class="stat-item mb-3">
                                                <h3 class="text-success">${formatCurrency(donor['累計捐款金額'] || 0)}</h3>
                                                <p class="mb-0">累計捐款</p>
                                            </div>
                                            <div class="stat-item">
                                                <p class="mb-0">最後捐款日期</p>
                                                <p class="fw-bold">${donor['最後捐款日期'] ? formatDate(donor['最後捐款日期']) : '-'}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 捐款歷史記錄 -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">捐款歷史記錄</h6>
                            </div>
                            <div class="card-body">
                                <div id="donorDonationHistory">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">載入中...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                        <button type="button" class="btn btn-primary" onclick="editDonor('${donorId}')">編輯</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    const modal = new bootstrap.Modal(document.getElementById('donorDetailModal'));
    modal.show();
    
    // 載入捐款歷史
    loadDonorDonationHistory(donorId);
    
    // 清理 modal
    document.getElementById('donorDetailModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

async function loadDonorDonationHistory(donorId) {
    try {
        // 從現有的捐款資料中篩選
        const donorDonations = donationsData.filter(d => d['捐款人ID'] === donorId);
        
        const historyContainer = document.getElementById('donorDonationHistory');
        
        if (donorDonations.length === 0) {
            historyContainer.innerHTML = '<p class="text-muted text-center">暫無捐款記錄</p>';
            return;
        }
        
        const historyHtml = `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>類型</th>
                            <th>金額</th>
                            <th>付款方式</th>
                            <th>收據狀態</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${donorDonations.map(donation => `
                            <tr>
                                <td>${formatDate(donation['捐款日期'])}</td>
                                <td><span class="badge bg-primary">${donation['捐款類型']}</span></td>
                                <td class="text-success fw-bold">${formatCurrency(donation['金額'])}</td>
                                <td>${donation['付款方式']}</td>
                                <td><span class="badge ${getReceiptStatusClass(donation['收據狀態'])}">${donation['收據狀態']}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        historyContainer.innerHTML = historyHtml;
    } catch (error) {
        console.error('載入捐款歷史失敗:', error);
        document.getElementById('donorDonationHistory').innerHTML = 
            '<p class="text-danger text-center">載入捐款歷史失敗</p>';
    }
}

function exportDonors() {
    const headers = ['姓名', '身分證字號', '聯絡電話', '電子郵件', '聯絡地址', '捐款次數', '累計捐款金額', '最後捐款日期'];
    const csvContent = [
        headers.join(','),
        ...donorsData.map(donor => [
            donor['姓名'],
            donor['身分證字號'] || '',
            donor['聯絡電話'] || '',
            donor['電子郵件'] || '',
            donor['聯絡地址'] || '',
            donor['捐款次數'] || 0,
            donor['累計捐款金額'] || 0,
            donor['最後捐款日期'] ? formatDate(donor['最後捐款日期']) : ''
        ].join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `捐款人資料_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

// 收據管理相關函數
let receiptsData = [];

async function loadReceiptsPage() {
    const pageContent = `
        <h1 class="page-title">
            <i class="fas fa-receipt me-2"></i>
            收據管理
        </h1>
        
        <!-- 操作按鈕 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary" onclick="showBatchGenerateModal()">
                    <i class="fas fa-magic me-1"></i>
                    批次產生收據
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="showBatchSendModal()">
                    <i class="fas fa-paper-plane me-1"></i>
                    批次寄送收據
                </button>
            </div>
            
            <!-- 狀態篩選 -->
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="receiptStatus" id="statusAll" value="" checked onchange="filterReceiptsByStatus()">
                <label class="btn btn-outline-secondary" for="statusAll">全部</label>
                
                <input type="radio" class="btn-check" name="receiptStatus" id="statusPending" value="待處理" onchange="filterReceiptsByStatus()">
                <label class="btn btn-outline-warning" for="statusPending">待處理</label>
                
                <input type="radio" class="btn-check" name="receiptStatus" id="statusIssued" value="已開立" onchange="filterReceiptsByStatus()">
                <label class="btn btn-outline-success" for="statusIssued">已開立</label>
                
                <input type="radio" class="btn-check" name="receiptStatus" id="statusSent" value="已寄送" onchange="filterReceiptsByStatus()">
                <label class="btn btn-outline-info" for="statusSent">已寄送</label>
            </div>
        </div>

        <!-- 收據列表 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    收據清單
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllReceipts" onchange="toggleAllReceipts()">
                                </th>
                                <th>收據編號</th>
                                <th>捐款人</th>
                                <th>捐款日期</th>
                                <th class="text-end">金額</th>
                                <th>狀態</th>
                                <th>開立日期</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="receiptsTableBody">
                            <!-- 動態載入 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    document.getElementById('receipts-page').innerHTML = pageContent;
    
    // 載入資料
    await loadReceiptsData();
}

async function loadReceiptsData() {
    try {
        showLoading(true);
        
        // 載入各種狀態的收據
        const [pendingReceipts, issuedReceipts, sentReceipts] = await Promise.all([
            apiCall('getPendingReceipts'),
            apiCall('getIssuedReceipts'),
            apiCall('getSentReceipts')
        ]);
        
        receiptsData = [
            ...pendingReceipts.map(r => ({ ...r, status: '待處理' })),
            ...issuedReceipts.map(r => ({ ...r, status: '已開立' })),
            ...sentReceipts.map(r => ({ ...r, status: '已寄送' }))
        ];
        
        renderReceiptsTable();
    } catch (error) {
        console.error('載入收據資料失敗:', error);
        showToast('載入收據資料失敗', 'error');
    } finally {
        showLoading(false);
    }
}

function renderReceiptsTable() {
    const tbody = document.getElementById('receiptsTableBody');
    
    if (!receiptsData || receiptsData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">暫無收據記錄</td></tr>';
        return;
    }

    tbody.innerHTML = receiptsData.map(receipt => `
        <tr>
            <td>
                <input type="checkbox" class="receipt-checkbox" value="${receipt['收據ID'] || receipt['捐款ID']}">
            </td>
            <td>
                <span class="badge bg-secondary">${receipt['收據編號'] || '待產生'}</span>
            </td>
            <td>${receipt['捐款人姓名']}</td>
            <td>${formatDate(receipt['捐款日期'])}</td>
            <td class="text-end text-success fw-bold">${formatCurrency(receipt['捐款金額'])}</td>
            <td>
                <span class="badge ${getReceiptStatusClass(receipt.status)}">
                    ${receipt.status}
                </span>
            </td>
            <td>${receipt['開立日期'] ? formatDate(receipt['開立日期']) : '-'}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    ${receipt.status === '待處理' ? `
                        <button class="btn btn-outline-primary" onclick="generateSingleReceipt('${receipt['捐款ID']}')" title="產生收據">
                            <i class="fas fa-magic"></i>
                        </button>
                    ` : `
                        <button class="btn btn-outline-info" onclick="previewReceipt('${receipt['收據ID']}')" title="預覽">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="downloadReceipt('${receipt['收據ID']}')" title="下載">
                            <i class="fas fa-download"></i>
                        </button>
                        ${receipt.status === '已開立' ? `
                            <button class="btn btn-outline-warning" onclick="sendSingleReceipt('${receipt['收據ID']}')" title="寄送">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        ` : ''}
                    `}
                </div>
            </td>
        </tr>
    `).join('');
}

function filterReceiptsByStatus() {
    const selectedStatus = document.querySelector('input[name="receiptStatus"]:checked').value;
    
    let filteredData = receiptsData;
    if (selectedStatus) {
        filteredData = receiptsData.filter(r => r.status === selectedStatus);
    }
    
    // 暫時更新表格顯示
    const originalData = receiptsData;
    receiptsData = filteredData;
    renderReceiptsTable();
    receiptsData = originalData;
}

function toggleAllReceipts() {
    const selectAll = document.getElementById('selectAllReceipts');
    const checkboxes = document.querySelectorAll('.receipt-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function showBatchGenerateModal() {
    const pendingReceipts = receiptsData.filter(r => r.status === '待處理');
    
    if (pendingReceipts.length === 0) {
        showToast('沒有待處理的收據', 'warning');
        return;
    }
    
    const modalHtml = `
        <div class="modal fade" id="batchGenerateModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-magic me-2"></i>
                            批次產生收據
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>將為以下 <strong>${pendingReceipts.length}</strong> 筆捐款產生收據：</p>
                        
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>捐款人</th>
                                        <th>捐款日期</th>
                                        <th class="text-end">金額</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pendingReceipts.map(receipt => `
                                        <tr>
                                            <td>${receipt['捐款人姓名']}</td>
                                            <td>${formatDate(receipt['捐款日期'])}</td>
                                            <td class="text-end">${formatCurrency(receipt['捐款金額'])}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            收據將按照系統設定的格式自動產生，產生後可進行預覽和寄送。
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="executeBatchGenerate()">
                            <i class="fas fa-magic me-1"></i>
                            開始產生
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    const modal = new bootstrap.Modal(document.getElementById('batchGenerateModal'));
    modal.show();
    
    // 清理 modal
    document.getElementById('batchGenerateModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

async function executeBatchGenerate() {
    const pendingReceipts = receiptsData.filter(r => r.status === '待處理');
    const donationIds = pendingReceipts.map(r => r['捐款ID']);
    
    try {
        showLoading(true);
        const result = await apiCall('batchGenerateReceipts', { donationIds }, 'POST');
        
        if (result.success) {
            showToast(`成功產生 ${result.count} 張收據`);
            bootstrap.Modal.getInstance(document.getElementById('batchGenerateModal')).hide();
            await loadReceiptsData();
        } else {
            showToast('批次產生失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('批次產生收據失敗:', error);
        showToast('批次產生收據失敗', 'error');
    } finally {
        showLoading(false);
    }
}

function showBatchSendModal() {
    const issuedReceipts = receiptsData.filter(r => r.status === '已開立');
    
    if (issuedReceipts.length === 0) {
        showToast('沒有可寄送的收據', 'warning');
        return;
    }
    
    const modalHtml = `
        <div class="modal fade" id="batchSendModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-paper-plane me-2"></i>
                            批次寄送收據
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">寄送方式</label>
                            <select class="form-select" id="batchSendMethod">
                                <option value="email">電子郵件</option>
                                <option value="print">列印郵寄</option>
                                <option value="both">電子郵件 + 列印</option>
                            </select>
                        </div>
                        
                        <p>將寄送以下 <strong>${issuedReceipts.length}</strong> 張收據：</p>
                        
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>收據編號</th>
                                        <th>捐款人</th>
                                        <th>電子郵件</th>
                                        <th class="text-end">金額</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${issuedReceipts.map(receipt => `
                                        <tr>
                                            <td>${receipt['收據編號']}</td>
                                            <td>${receipt['捐款人姓名']}</td>
                                            <td>${receipt['電子郵件'] || '無'}</td>
                                            <td class="text-end">${formatCurrency(receipt['捐款金額'])}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            請確認捐款人的電子郵件地址正確，沒有電子郵件的將只能選擇列印方式。
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="executeBatchSend()">
                            <i class="fas fa-paper-plane me-1"></i>
                            開始寄送
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    const modal = new bootstrap.Modal(document.getElementById('batchSendModal'));
    modal.show();
    
    // 清理 modal
    document.getElementById('batchSendModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

async function executeBatchSend() {
    const issuedReceipts = receiptsData.filter(r => r.status === '已開立');
    const receiptIds = issuedReceipts.map(r => r['收據ID']);
    const method = document.getElementById('batchSendMethod').value;
    
    try {
        showLoading(true);
        const result = await apiCall('batchSendReceipts', { receiptIds, method }, 'POST');
        
        if (result.success) {
            showToast(`成功寄送 ${result.count} 張收據`);
            bootstrap.Modal.getInstance(document.getElementById('batchSendModal')).hide();
            await loadReceiptsData();
        } else {
            showToast('批次寄送失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('批次寄送收據失敗:', error);
        showToast('批次寄送收據失敗', 'error');
    } finally {
        showLoading(false);
    }
}

async function generateSingleReceipt(donationId) {
    try {
        showLoading(true);
        const result = await apiCall('generateReceipt', { donationId }, 'POST');
        
        if (result.success) {
            showToast('收據產生成功');
            await loadReceiptsData();
        } else {
            showToast('產生收據失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('產生收據失敗:', error);
        showToast('產生收據失敗', 'error');
    } finally {
        showLoading(false);
    }
}

async function previewReceipt(receiptId) {
    try {
        const response = await fetch(`${API_URL}?action=getReceiptPreview&receiptId=${receiptId}`);
        const html = await response.text();
        
        const previewWindow = window.open('', '_blank', 'width=800,height=600');
        previewWindow.document.write(html);
        previewWindow.document.close();
    } catch (error) {
        console.error('預覽收據失敗:', error);
        showToast('預覽收據失敗', 'error');
    }
}

async function downloadReceipt(receiptId) {
    try {
        const response = await fetch(`${API_URL}?action=getReceiptPreview&receiptId=${receiptId}`);
        const html = await response.text();
        
        // 簡單的下載實作 - 在實際應用中可能需要更複雜的 PDF 產生
        const blob = new Blob([html], { type: 'text/html' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `收據_${receiptId}.html`;
        link.click();
    } catch (error) {
        console.error('下載收據失敗:', error);
        showToast('下載收據失敗', 'error');
    }
}

async function sendSingleReceipt(receiptId) {
    const modalHtml = `
        <div class="modal fade" id="sendReceiptModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-paper-plane me-2"></i>
                            寄送收據
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">寄送方式</label>
                            <select class="form-select" id="sendMethod">
                                <option value="email">電子郵件</option>
                                <option value="print">列印郵寄</option>
                            </select>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            收據將根據選擇的方式進行寄送，電子郵件將自動發送到捐款人的信箱。
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="executeSingleSend('${receiptId}')">
                            <i class="fas fa-paper-plane me-1"></i>
                            寄送
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    const modal = new bootstrap.Modal(document.getElementById('sendReceiptModal'));
    modal.show();
    
    // 清理 modal
    document.getElementById('sendReceiptModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

async function executeSingleSend(receiptId) {
    const method = document.getElementById('sendMethod').value;
    
    try {
        showLoading(true);
        const result = await apiCall('sendReceipt', { receiptId, method }, 'POST');
        
        if (result.success) {
            showToast('收據寄送成功');
            bootstrap.Modal.getInstance(document.getElementById('sendReceiptModal')).hide();
            await loadReceiptsData();
        } else {
            showToast('寄送失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('寄送收據失敗:', error);
        showToast('寄送收據失敗', 'error');
    } finally {
        showLoading(false);
    }
}

// 預算管理相關函數
let budgetData = [];
let currentBudgetYear = new Date().getFullYear();

async function loadBudgetPage() {
    const pageContent = `
        <h1 class="page-title">
            <i class="fas fa-chart-pie me-2"></i>
            預算管理
        </h1>
        
        <!-- 年度選擇和操作按鈕 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <label class="form-label mb-0">預算年度：</label>
                <select class="form-select" id="budgetYearSelect" onchange="changeBudgetYear()" style="width: auto;">
                    ${generateYearOptions()}
                </select>
            </div>
            
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary" onclick="showAddBudgetModal()">
                    <i class="fas fa-plus me-1"></i>
                    新增預算項目
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="exportBudget()">
                    <i class="fas fa-download me-1"></i>
                    匯出預算表
                </button>
            </div>
        </div>

        <!-- 預算總覽 -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0" id="totalBudget">$0</h4>
                                <p class="mb-0">總預算</p>
                            </div>
                            <i class="fas fa-wallet fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0" id="totalUsed">$0</h4>
                                <p class="mb-0">已使用</p>
                            </div>
                            <i class="fas fa-chart-line fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0" id="totalRemaining">$0</h4>
                                <p class="mb-0">剩餘預算</p>
                            </div>
                            <i class="fas fa-piggy-bank fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0" id="usagePercentage">0%</h4>
                                <p class="mb-0">使用率</p>
                            </div>
                            <i class="fas fa-percentage fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 預算詳細列表 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    預算項目明細
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>科目名稱</th>
                                <th class="text-end">預算金額</th>
                                <th class="text-end">已使用金額</th>
                                <th class="text-end">剩餘金額</th>
                                <th class="text-center">使用率</th>
                                <th class="text-center">狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="budgetTableBody">
                            <!-- 動態載入 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 預算使用趨勢圖 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>
                            預算使用趨勢
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="budgetTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('budget-page').innerHTML = pageContent;
    
    // 設定當前年度
    document.getElementById('budgetYearSelect').value = currentBudgetYear;
    
    // 載入資料
    await loadBudgetData();
}

function generateYearOptions() {
    const currentYear = new Date().getFullYear();
    let options = '';
    
    for (let year = currentYear - 2; year <= currentYear + 2; year++) {
        options += `<option value="${year}">${year}年</option>`;
    }
    
    return options;
}

async function loadBudgetData() {
    try {
        showLoading(true);
        budgetData = await apiCall('getBudgetData', { year: currentBudgetYear });
        renderBudgetTable();
        updateBudgetSummary();
        updateBudgetTrendChart();
    } catch (error) {
        console.error('載入預算資料失敗:', error);
        showToast('載入預算資料失敗', 'error');
    } finally {
        showLoading(false);
    }
}

function renderBudgetTable() {
    const tbody = document.getElementById('budgetTableBody');
    
    if (!budgetData || budgetData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暫無預算項目</td></tr>';
        return;
    }

    tbody.innerHTML = budgetData.map(budget => {
        const usedAmount = budget['已使用金額'] || 0;
        const budgetAmount = budget['預算金額'] || 0;
        const remainingAmount = budgetAmount - usedAmount;
        const usageRate = budgetAmount > 0 ? (usedAmount / budgetAmount * 100) : 0;
        
        return `
            <tr>
                <td>
                    <div class="fw-bold">${budget['科目名稱']}</div>
                    <small class="text-muted">${budget['科目代碼'] || ''}</small>
                </td>
                <td class="text-end fw-bold">${formatCurrency(budgetAmount)}</td>
                <td class="text-end text-danger">${formatCurrency(usedAmount)}</td>
                <td class="text-end ${remainingAmount >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(remainingAmount)}</td>
                <td class="text-center">
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar ${getUsageProgressClass(usageRate)}" 
                             role="progressbar" 
                             style="width: ${Math.min(usageRate, 100)}%">
                            ${usageRate.toFixed(1)}%
                        </div>
                    </div>
                </td>
                <td class="text-center">
                    <span class="badge ${getBudgetStatusClass(usageRate)}">
                        ${getBudgetStatusText(usageRate)}
                    </span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editBudget('${budget['ID']}')" title="編輯">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteBudget('${budget['ID']}')" title="刪除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function updateBudgetSummary() {
    const totalBudget = budgetData.reduce((sum, item) => sum + (item['預算金額'] || 0), 0);
    const totalUsed = budgetData.reduce((sum, item) => sum + (item['已使用金額'] || 0), 0);
    const totalRemaining = totalBudget - totalUsed;
    const usagePercentage = totalBudget > 0 ? (totalUsed / totalBudget * 100) : 0;
    
    document.getElementById('totalBudget').textContent = formatCurrency(totalBudget);
    document.getElementById('totalUsed').textContent = formatCurrency(totalUsed);
    document.getElementById('totalRemaining').textContent = formatCurrency(totalRemaining);
    document.getElementById('usagePercentage').textContent = usagePercentage.toFixed(1) + '%';
}

function getUsageProgressClass(usageRate) {
    if (usageRate >= 90) return 'bg-danger';
    if (usageRate >= 75) return 'bg-warning';
    if (usageRate >= 50) return 'bg-info';
    return 'bg-success';
}

function getBudgetStatusClass(usageRate) {
    if (usageRate >= 100) return 'bg-danger';
    if (usageRate >= 90) return 'bg-warning';
    if (usageRate >= 75) return 'bg-info';
    return 'bg-success';
}

function getBudgetStatusText(usageRate) {
    if (usageRate >= 100) return '超支';
    if (usageRate >= 90) return '警戒';
    if (usageRate >= 75) return '注意';
    return '正常';
}

function updateBudgetTrendChart() {
    const ctx = document.getElementById('budgetTrendChart').getContext('2d');
    
    // 這裡應該從後端獲取月度預算使用趨勢資料
    const monthlyData = {
        labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
        budget: new Array(12).fill(0),
        actual: new Array(12).fill(0)
    };
    
    // 模擬資料 - 實際應用中應從 API 獲取
    const totalBudget = budgetData.reduce((sum, item) => sum + (item['預算金額'] || 0), 0);
    const monthlyBudget = totalBudget / 12;
    
    for (let i = 0; i < 12; i++) {
        monthlyData.budget[i] = monthlyBudget * (i + 1);
        monthlyData.actual[i] = monthlyBudget * (i + 1) * (0.7 + Math.random() * 0.4);
    }

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: monthlyData.labels,
            datasets: [{
                label: '累計預算',
                data: monthlyData.budget,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: false
            }, {
                label: '累計實際支出',
                data: monthlyData.actual,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
}

async function changeBudgetYear() {
    currentBudgetYear = parseInt(document.getElementById('budgetYearSelect').value);
    await loadBudgetData();
}

function showAddBudgetModal() {
    const modalHtml = `
        <div class="modal fade" id="budgetModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-plus me-2"></i>
                            新增預算項目
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="budgetForm">
                            <div class="mb-3">
                                <label class="form-label">預算年度</label>
                                <input type="number" class="form-control" id="budgetFormYear" 
                                       value="${currentBudgetYear}" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">科目名稱 *</label>
                                <select class="form-select" id="budgetAccount" required>
                                    <option value="">請選擇科目</option>
                                    ${accountsData
                                        .filter(account => account['科目類型'] === '支出科目' && account['狀態'] === '啟用')
                                        .map(account => `<option value="${account['科目名稱']}">${account['科目名稱']}</option>`)
                                        .join('')}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">預算金額 *</label>
                                <input type="number" class="form-control" id="budgetAmount" required min="1">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">預算說明</label>
                                <textarea class="form-control" id="budgetDescription" rows="3"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">預警比例 (%)</label>
                                <input type="number" class="form-control" id="budgetWarningRate" 
                                       value="80" min="1" max="100">
                                <div class="form-text">當使用率達到此比例時會發出警告</div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveBudget()">儲存</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    const modal = new bootstrap.Modal(document.getElementById('budgetModal'));
    modal.show();
    
    // 清理 modal
    document.getElementById('budgetModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

async function saveBudget() {
    const form = document.getElementById('budgetForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const budgetData = {
        year: parseInt(document.getElementById('budgetFormYear').value),
        account: document.getElementById('budgetAccount').value,
        amount: parseFloat(document.getElementById('budgetAmount').value),
        description: document.getElementById('budgetDescription').value,
        warningRate: parseFloat(document.getElementById('budgetWarningRate').value)
    };
    
    try {
        showLoading(true);
        const result = await apiCall('addBudget', { data: budgetData }, 'POST');
        
        if (result.success) {
            showToast('預算項目新增成功');
            bootstrap.Modal.getInstance(document.getElementById('budgetModal')).hide();
            await loadBudgetData();
        } else {
            showToast('新增失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('新增預算失敗:', error);
        showToast('新增預算失敗', 'error');
    } finally {
        showLoading(false);
    }
}

async function editBudget(budgetId) {
    const budget = budgetData.find(b => b['ID'] === budgetId);
    if (!budget) return;
    
    showAddBudgetModal();
    
    // 等待 modal 完全載入
    setTimeout(() => {
        document.getElementById('budgetAccount').value = budget['科目名稱'];
        document.getElementById('budgetAmount').value = budget['預算金額'];
        document.getElementById('budgetDescription').value = budget['預算說明'] || '';
        document.getElementById('budgetWarningRate').value = budget['預警比例'] || 80;
        
        // 更改標題和儲存函數
        document.querySelector('#budgetModal .modal-title').innerHTML = 
            '<i class="fas fa-edit me-2"></i>編輯預算項目';
        document.querySelector('#budgetModal .btn-primary').onclick = () => updateBudget(budgetId);
    }, 100);
}

async function updateBudget(budgetId) {
    const form = document.getElementById('budgetForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const budgetData = {
        id: budgetId,
        year: parseInt(document.getElementById('budgetFormYear').value),
        account: document.getElementById('budgetAccount').value,
        amount: parseFloat(document.getElementById('budgetAmount').value),
        description: document.getElementById('budgetDescription').value,
        warningRate: parseFloat(document.getElementById('budgetWarningRate').value)
    };
    
    try {
        showLoading(true);
        const result = await apiCall('updateBudget', { data: budgetData }, 'POST');
        
        if (result.success) {
            showToast('預算項目更新成功');
            bootstrap.Modal.getInstance(document.getElementById('budgetModal')).hide();
            await loadBudgetData();
        } else {
            showToast('更新失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('更新預算失敗:', error);
        showToast('更新預算失敗', 'error');
    } finally {
        showLoading(false);
    }
}

async function deleteBudget(budgetId) {
    if (!confirm('確定要刪除這個預算項目嗎？此操作無法復原。')) {
        return;
    }
    
    try {
        showLoading(true);
        const result = await apiCall('deleteBudget', { id: budgetId }, 'POST');
        
        if (result.success) {
            showToast('預算項目刪除成功');
            await loadBudgetData();
        } else {
            showToast('刪除失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('刪除預算失敗:', error);
        showToast('刪除預算失敗', 'error');
    } finally {
        showLoading(false);
    }
}

function exportBudget() {
    const headers = ['科目名稱', '預算金額', '已使用金額', '剩餘金額', '使用率', '狀態'];
    const csvContent = [
        `${currentBudgetYear}年度預算表`,
        '',
        headers.join(','),
        ...budgetData.map(budget => {
            const usedAmount = budget['已使用金額'] || 0;
            const budgetAmount = budget['預算金額'] || 0;
            const remainingAmount = budgetAmount - usedAmount;
            const usageRate = budgetAmount > 0 ? (usedAmount / budgetAmount * 100) : 0;
            
            return [
                budget['科目名稱'],
                budgetAmount,
                usedAmount,
                remainingAmount,
                usageRate.toFixed(1) + '%',
                getBudgetStatusText(usageRate)
            ].join(',');
        })
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `預算表_${currentBudgetYear}.csv`;
    link.click();
}

// 報表分析相關函數
let reportsData = {};

async function loadReportsPage() {
    const pageContent = `
        <h1 class="page-title">
            <i class="fas fa-chart-bar me-2"></i>
            報表分析
        </h1>
        
        <!-- 報表選擇和篩選 -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">報表篩選條件</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">報表類型</label>
                                <select class="form-select" id="reportType" onchange="changeReportType()">
                                    <option value="monthly">月度報表</option>
                                    <option value="yearly">年度報表</option>
                                    <option value="donor">捐款人分析</option>
                                    <option value="category">分類統計</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">年度</label>
                                <select class="form-select" id="reportYear">
                                    ${generateYearOptions()}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3" id="monthFilter">
                                <label class="form-label">月份</label>
                                <select class="form-select" id="reportMonth">
                                    <option value="">全年</option>
                                    ${Array.from({length: 12}, (_, i) => 
                                        `<option value="${i + 1}">${i + 1}月</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button class="btn btn-primary" onclick="generateReport()">
                                        <i class="fas fa-chart-line me-1"></i>
                                        產生報表
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">快速報表</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="generateQuickReport('thisMonth')">
                                <i class="fas fa-calendar-alt me-1"></i>
                                本月報表
                            </button>
                            <button class="btn btn-outline-primary" onclick="generateQuickReport('thisYear')">
                                <i class="fas fa-calendar me-1"></i>
                                本年度報表
                            </button>
                            <button class="btn btn-outline-primary" onclick="generateQuickReport('topDonors')">
                                <i class="fas fa-users me-1"></i>
                                主要捐款人
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 報表內容區域 -->
        <div id="reportContent">
            <div class="text-center text-muted py-5">
                <i class="fas fa-chart-bar fa-3x mb-3"></i>
                <p>請選擇報表類型並點擊「產生報表」</p>
            </div>
        </div>
    `;

    document.getElementById('reports-page').innerHTML = pageContent;
    
    // 設定預設值
    document.getElementById('reportYear').value = new Date().getFullYear();
}

function changeReportType() {
    const reportType = document.getElementById('reportType').value;
    const monthFilter = document.getElementById('monthFilter');
    
    if (reportType === 'monthly') {
        monthFilter.style.display = 'block';
    } else {
        monthFilter.style.display = 'none';
    }
}

async function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const year = document.getElementById('reportYear').value;
    const month = document.getElementById('reportMonth').value;
    
    try {
        showLoading(true);
        
        const params = { reportType, year };
        if (month) params.month = month;
        
        reportsData = await apiCall('generateReport', params);
        renderReport(reportType);
        
    } catch (error) {
        console.error('產生報表失敗:', error);
        showToast('產生報表失敗', 'error');
    } finally {
        showLoading(false);
    }
}

async function generateQuickReport(type) {
    const currentDate = new Date();
    
    try {
        showLoading(true);
        
        let params = {};
        switch (type) {
            case 'thisMonth':
                params = {
                    reportType: 'monthly',
                    year: currentDate.getFullYear(),
                    month: currentDate.getMonth() + 1
                };
                break;
            case 'thisYear':
                params = {
                    reportType: 'yearly',
                    year: currentDate.getFullYear()
                };
                break;
            case 'topDonors':
                params = {
                    reportType: 'donor',
                    year: currentDate.getFullYear()
                };
                break;
        }
        
        reportsData = await apiCall('generateReport', params);
        renderReport(params.reportType);
        
    } catch (error) {
        console.error('產生快速報表失敗:', error);
        showToast('產生快速報表失敗', 'error');
    } finally {
        showLoading(false);
    }
}

function renderReport(reportType) {
    const reportContent = document.getElementById('reportContent');
    
    switch (reportType) {
        case 'monthly':
            renderMonthlyReport();
            break;
        case 'yearly':
            renderYearlyReport();
            break;
        case 'donor':
            renderDonorReport();
            break;
        case 'category':
            renderCategoryReport();
            break;
    }
}

function renderMonthlyReport() {
    const reportContent = document.getElementById('reportContent');
    const data = reportsData;
    
    const reportHtml = `
        <div class="row">
            <!-- 月度統計卡片 -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h4>${formatCurrency(data.totalIncome || 0)}</h4>
                        <p class="mb-0">總收入</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h4>${formatCurrency(data.totalExpense || 0)}</h4>
                        <p class="mb-0">總支出</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h4>${formatCurrency((data.totalIncome || 0) - (data.totalExpense || 0))}</h4>
                        <p class="mb-0">淨收支</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h4>${data.donationCount || 0}</h4>
                        <p class="mb-0">捐款筆數</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 詳細表格 -->
        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">收入明細</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>類型</th>
                                        <th class="text-end">金額</th>
                                        <th class="text-end">筆數</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(data.incomeByType || []).map(item => `
                                        <tr>
                                            <td>${item.type}</td>
                                            <td class="text-end">${formatCurrency(item.amount)}</td>
                                            <td class="text-end">${item.count}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">支出明細</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>類別</th>
                                        <th class="text-end">金額</th>
                                        <th class="text-end">筆數</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(data.expenseByCategory || []).map(item => `
                                        <tr>
                                            <td>${item.category}</td>
                                            <td class="text-end">${formatCurrency(item.amount)}</td>
                                            <td class="text-end">${item.count}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 圖表 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <h5 class="mb-0">月度趨勢圖</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportReport()">
                            <i class="fas fa-download me-1"></i>
                            匯出報表
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monthlyReportChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    reportContent.innerHTML = reportHtml;
    
    // 繪製圖表
    setTimeout(() => {
        renderMonthlyChart();
    }, 100);
}

function renderYearlyReport() {
    const reportContent = document.getElementById('reportContent');
    const data = reportsData;
    
    const reportHtml = `
        <div class="row">
            <!-- 年度統計 -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <h5 class="mb-0">${data.year || new Date().getFullYear()}年度財務報表</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportReport()">
                            <i class="fas fa-download me-1"></i>
                            匯出報表
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-4">
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h3 class="text-success">${formatCurrency(data.totalIncome || 0)}</h3>
                                    <p class="text-muted">總收入</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h3 class="text-danger">${formatCurrency(data.totalExpense || 0)}</h3>
                                    <p class="text-muted">總支出</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h3 class="text-info">${formatCurrency((data.totalIncome || 0) - (data.totalExpense || 0))}</h3>
                                    <p class="text-muted">淨收支</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <h3 class="text-warning">${data.totalDonors || 0}</h3>
                                <p class="text-muted">捐款人數</p>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="yearlyReportChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 月度明細表 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">月度明細</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>月份</th>
                                        <th class="text-end">收入</th>
                                        <th class="text-end">支出</th>
                                        <th class="text-end">淨收支</th>
                                        <th class="text-end">捐款筆數</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(data.monthlyDetail || []).map(item => `
                                        <tr>
                                            <td>${item.month}月</td>
                                            <td class="text-end text-success">${formatCurrency(item.income)}</td>
                                            <td class="text-end text-danger">${formatCurrency(item.expense)}</td>
                                            <td class="text-end ${item.income - item.expense >= 0 ? 'text-success' : 'text-danger'}">
                                                ${formatCurrency(item.income - item.expense)}
                                            </td>
                                            <td class="text-end">${item.donationCount}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    reportContent.innerHTML = reportHtml;
    
    // 繪製圖表
    setTimeout(() => {
        renderYearlyChart();
    }, 100);
}

function renderDonorReport() {
    const reportContent = document.getElementById('reportContent');
    const data = reportsData;
    
    const reportHtml = `
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <h5 class="mb-0">捐款人分析報表</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="exportReport()">
                    <i class="fas fa-download me-1"></i>
                    匯出報表
                </button>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-4 text-center">
                        <h3 class="text-primary">${data.totalDonors || 0}</h3>
                        <p class="text-muted">總捐款人數</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <h3 class="text-success">${formatCurrency(data.averageDonation || 0)}</h3>
                        <p class="text-muted">平均捐款金額</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <h3 class="text-info">${data.repeatDonors || 0}</h3>
                        <p class="text-muted">重複捐款人數</p>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>捐款人姓名</th>
                                <th class="text-end">捐款次數</th>
                                <th class="text-end">累計金額</th>
                                <th class="text-end">平均金額</th>
                                <th>最後捐款</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(data.topDonors || []).map((donor, index) => `
                                <tr>
                                    <td>
                                        <span class="badge ${index < 3 ? 'bg-warning' : 'bg-secondary'}">
                                            ${index + 1}
                                        </span>
                                    </td>
                                    <td>${donor.name}</td>
                                    <td class="text-end">${donor.donationCount}</td>
                                    <td class="text-end text-success fw-bold">${formatCurrency(donor.totalAmount)}</td>
                                    <td class="text-end">${formatCurrency(donor.averageAmount)}</td>
                                    <td>${formatDate(donor.lastDonation)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    reportContent.innerHTML = reportHtml;
}

function renderCategoryReport() {
    const reportContent = document.getElementById('reportContent');
    const data = reportsData;
    
    const reportHtml = `
        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">捐款類型統計</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="donationTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">支出類別統計</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="expenseCategoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <h5 class="mb-0">分類明細表</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportReport()">
                            <i class="fas fa-download me-1"></i>
                            匯出報表
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-6">
                                <h6>捐款類型明細</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>類型</th>
                                                <th class="text-end">金額</th>
                                                <th class="text-end">筆數</th>
                                                <th class="text-end">比例</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${(data.donationTypes || []).map(item => `
                                                <tr>
                                                    <td>${item.type}</td>
                                                    <td class="text-end">${formatCurrency(item.amount)}</td>
                                                    <td class="text-end">${item.count}</td>
                                                    <td class="text-end">${item.percentage.toFixed(1)}%</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <h6>支出類別明細</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>類別</th>
                                                <th class="text-end">金額</th>
                                                <th class="text-end">筆數</th>
                                                <th class="text-end">比例</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${(data.expenseCategories || []).map(item => `
                                                <tr>
                                                    <td>${item.category}</td>
                                                    <td class="text-end">${formatCurrency(item.amount)}</td>
                                                    <td class="text-end">${item.count}</td>
                                                    <td class="text-end">${item.percentage.toFixed(1)}%</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    reportContent.innerHTML = reportHtml;
    
    // 繪製圖表
    setTimeout(() => {
        renderCategoryCharts();
    }, 100);
}

function renderMonthlyChart() {
    const ctx = document.getElementById('monthlyReportChart').getContext('2d');
    const data = reportsData;
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: (data.dailyData || []).map(item => item.day + '日'),
            datasets: [{
                label: '收入',
                data: (data.dailyData || []).map(item => item.income),
                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 1
            }, {
                label: '支出',
                data: (data.dailyData || []).map(item => item.expense),
                backgroundColor: 'rgba(220, 53, 69, 0.8)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
}

function renderYearlyChart() {
    const ctx = document.getElementById('yearlyReportChart').getContext('2d');
    const data = reportsData;
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
            datasets: [{
                label: '收入',
                data: (data.monthlyDetail || []).map(item => item.income),
                borderColor: 'rgba(40, 167, 69, 1)',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: '支出',
                data: (data.monthlyDetail || []).map(item => item.expense),
                borderColor: 'rgba(220, 53, 69, 1)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
}

function renderCategoryCharts() {
    // 捐款類型圓餅圖
    const donationCtx = document.getElementById('donationTypeChart').getContext('2d');
    const donationData = reportsData.donationTypes || [];
    
    new Chart(donationCtx, {
        type: 'doughnut',
        data: {
            labels: donationData.map(item => item.type),
            datasets: [{
                data: donationData.map(item => item.amount),
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // 支出類別圓餅圖
    const expenseCtx = document.getElementById('expenseCategoryChart').getContext('2d');
    const expenseData = reportsData.expenseCategories || [];
    
    new Chart(expenseCtx, {
        type: 'doughnut',
        data: {
            labels: expenseData.map(item => item.category),
            datasets: [{
                data: expenseData.map(item => item.amount),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function exportReport() {
    const reportType = document.getElementById('reportType').value;
    const year = document.getElementById('reportYear').value;
    const month = document.getElementById('reportMonth').value;
    
    // 簡單的 CSV 匯出實作
    let csvContent = '';
    let filename = '';
    
    switch (reportType) {
        case 'monthly':
            filename = `月度報表_${year}年${month}月.csv`;
            csvContent = generateMonthlyCsv();
            break;
        case 'yearly':
            filename = `年度報表_${year}年.csv`;
            csvContent = generateYearlyCsv();
            break;
        case 'donor':
            filename = `捐款人分析_${year}年.csv`;
            csvContent = generateDonorCsv();
            break;
        case 'category':
            filename = `分類統計_${year}年.csv`;
            csvContent = generateCategoryCsv();
            break;
    }
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
}

function generateMonthlyCsv() {
    const data = reportsData;
    return [
        '月度財務報表',
        '',
        '統計摘要',
        `總收入,${data.totalIncome || 0}`,
        `總支出,${data.totalExpense || 0}`,
        `淨收支,${(data.totalIncome || 0) - (data.totalExpense || 0)}`,
        `捐款筆數,${data.donationCount || 0}`,
        '',
        '收入明細',
        '類型,金額,筆數',
        ...(data.incomeByType || []).map(item => `${item.type},${item.amount},${item.count}`),
        '',
        '支出明細',
        '類別,金額,筆數',
        ...(data.expenseByCategory || []).map(item => `${item.category},${item.amount},${item.count}`)
    ].join('\n');
}

function generateYearlyCsv() {
    const data = reportsData;
    return [
        `${data.year || new Date().getFullYear()}年度財務報表`,
        '',
        '年度統計',
        `總收入,${data.totalIncome || 0}`,
        `總支出,${data.totalExpense || 0}`,
        `淨收支,${(data.totalIncome || 0) - (data.totalExpense || 0)}`,
        `捐款人數,${data.totalDonors || 0}`,
        '',
        '月度明細',
        '月份,收入,支出,淨收支,捐款筆數',
        ...(data.monthlyDetail || []).map(item => 
            `${item.month}月,${item.income},${item.expense},${item.income - item.expense},${item.donationCount}`
        )
    ].join('\n');
}

function generateDonorCsv() {
    const data = reportsData;
    return [
        '捐款人分析報表',
        '',
        '統計摘要',
        `總捐款人數,${data.totalDonors || 0}`,
        `平均捐款金額,${data.averageDonation || 0}`,
        `重複捐款人數,${data.repeatDonors || 0}`,
        '',
        '主要捐款人排行',
        '排名,姓名,捐款次數,累計金額,平均金額,最後捐款',
        ...(data.topDonors || []).map((donor, index) => 
            `${index + 1},${donor.name},${donor.donationCount},${donor.totalAmount},${donor.averageAmount},${formatDate(donor.lastDonation)}`
        )
    ].join('\n');
}

function generateCategoryCsv() {
    const data = reportsData;
    return [
        '分類統計報表',
        '',
        '捐款類型統計',
        '類型,金額,筆數,比例',
        ...(data.donationTypes || []).map(item => 
            `${item.type},${item.amount},${item.count},${item.percentage.toFixed(1)}%`
        ),
        '',
        '支出類別統計',
        '類別,金額,筆數,比例',
        ...(data.expenseCategories || []).map(item => 
            `${item.category},${item.amount},${item.count},${item.percentage.toFixed(1)}%`
        )
    ].join('\n');
}

// 系統設定相關函數
let systemSettings = {};

async function loadSettingsPage() {
    const pageContent = `
        <h1 class="page-title">
            <i class="fas fa-cog me-2"></i>
            系統設定
        </h1>
        
        <!-- 設定分頁 -->
        <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">
                    <i class="fas fa-building me-1"></i>
                    基本設定
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="accounts-tab" data-bs-toggle="tab" data-bs-target="#accounts" type="button" role="tab">
                    <i class="fas fa-list-alt me-1"></i>
                    會計科目
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="receipt-tab" data-bs-toggle="tab" data-bs-target="#receipt" type="button" role="tab">
                    <i class="fas fa-receipt me-1"></i>
                    收據設定
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup" type="button" role="tab">
                    <i class="fas fa-database me-1"></i>
                    備份還原
                </button>
            </li>
        </ul>

        <!-- 設定內容 -->
        <div class="tab-content" id="settingsTabContent">
            <!-- 基本設定 -->
            <div class="tab-pane fade show active" id="basic" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">機構基本資料</h5>
                    </div>
                    <div class="card-body">
                        <form id="basicSettingsForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">機構名稱 *</label>
                                    <input type="text" class="form-control" id="orgName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">統一編號</label>
                                    <input type="text" class="form-control" id="orgTaxId">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">聯絡電話</label>
                                    <input type="tel" class="form-control" id="orgPhone">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">傳真號碼</label>
                                    <input type="tel" class="form-control" id="orgFax">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">機構地址</label>
                                <input type="text" class="form-control" id="orgAddress">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">電子郵件</label>
                                <input type="email" class="form-control" id="orgEmail">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">網站網址</label>
                                <input type="url" class="form-control" id="orgWebsite">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">負責人姓名</label>
                                <input type="text" class="form-control" id="orgDirector">
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-primary" onclick="saveBasicSettings()">
                                    <i class="fas fa-save me-1"></i>
                                    儲存設定
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 會計科目 -->
            <div class="tab-pane fade" id="accounts" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">會計科目管理</h5>
                    <button type="button" class="btn btn-primary" onclick="showAddAccountModal()">
                        <i class="fas fa-plus me-1"></i>
                        新增科目
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>科目代碼</th>
                                        <th>科目名稱</th>
                                        <th>科目類型</th>
                                        <th>狀態</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="accountsTableBody">
                                    <!-- 動態載入 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 收據設定 -->
            <div class="tab-pane fade" id="receipt" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">收據格式設定</h5>
                    </div>
                    <div class="card-body">
                        <form id="receiptSettingsForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">收據編號前綴</label>
                                    <input type="text" class="form-control" id="receiptPrefix" placeholder="例如：R">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">收據編號長度</label>
                                    <select class="form-select" id="receiptNumberLength">
                                        <option value="6">6位數</option>
                                        <option value="8">8位數</option>
                                        <option value="10">10位數</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">收據標題</label>
                                <input type="text" class="form-control" id="receiptTitle" placeholder="捐款收據">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">收據備註</label>
                                <textarea class="form-control" id="receiptNote" rows="3" 
                                          placeholder="感謝您的愛心捐款，本收據可作為報稅憑證。"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="autoSendReceipt">
                                    <label class="form-check-label" for="autoSendReceipt">
                                        自動寄送電子收據
                                    </label>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-outline-secondary" onclick="previewReceiptFormat()">
                                    <i class="fas fa-eye me-1"></i>
                                    預覽格式
                                </button>
                                <button type="button" class="btn btn-primary" onclick="saveReceiptSettings()">
                                    <i class="fas fa-save me-1"></i>
                                    儲存設定
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 備份還原 -->
            <div class="tab-pane fade" id="backup" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-download me-2"></i>
                                    資料備份
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">定期備份資料以防止資料遺失</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">備份範圍</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="backupDonations" checked>
                                        <label class="form-check-label" for="backupDonations">捐款記錄</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="backupExpenses" checked>
                                        <label class="form-check-label" for="backupExpenses">支出記錄</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="backupDonors" checked>
                                        <label class="form-check-label" for="backupDonors">捐款人資料</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="backupSettings" checked>
                                        <label class="form-check-label" for="backupSettings">系統設定</label>
                                    </div>
                                </div>
                                
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary" onclick="createBackup()">
                                        <i class="fas fa-download me-1"></i>
                                        立即備份
                                    </button>
                                </div>
                                
                                <div class="mt-3">
                                    <small class="text-muted">
                                        最後備份時間：<span id="lastBackupTime">尚未備份</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-upload me-2"></i>
                                    資料還原
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">從備份檔案還原資料</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">選擇備份檔案</label>
                                    <input type="file" class="form-control" id="restoreFile" accept=".json,.csv">
                                </div>
                                
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>警告：</strong>還原操作將覆蓋現有資料，請確保已備份當前資料。
                                </div>
                                
                                <div class="d-grid">
                                    <button type="button" class="btn btn-warning" onclick="restoreData()">
                                        <i class="fas fa-upload me-1"></i>
                                        開始還原
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 自動備份設定 -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-clock me-2"></i>
                            自動備份設定
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableAutoBackup">
                                    <label class="form-check-label" for="enableAutoBackup">
                                        啟用自動備份
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <select class="form-select" id="autoBackupFrequency">
                                    <option value="daily">每日</option>
                                    <option value="weekly">每週</option>
                                    <option value="monthly">每月</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-primary" onclick="saveAutoBackupSettings()">
                                <i class="fas fa-save me-1"></i>
                                儲存自動備份設定
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('settings-page').innerHTML = pageContent;
    
    // 載入設定資料
    await loadSystemSettings();
    await loadAccountsData();
}

async function loadSystemSettings() {
    try {
        showLoading(true);
        systemSettings = await apiCall('getSystemSettings');
        populateSettingsForm();
    } catch (error) {
        console.error('載入系統設定失敗:', error);
        showToast('載入系統設定失敗', 'error');
    } finally {
        showLoading(false);
    }
}

function populateSettingsForm() {
    // 基本設定
    document.getElementById('orgName').value = systemSettings.orgName || '';
    document.getElementById('orgTaxId').value = systemSettings.orgTaxId || '';
    document.getElementById('orgPhone').value = systemSettings.orgPhone || '';
    document.getElementById('orgFax').value = systemSettings.orgFax || '';
    document.getElementById('orgAddress').value = systemSettings.orgAddress || '';
    document.getElementById('orgEmail').value = systemSettings.orgEmail || '';
    document.getElementById('orgWebsite').value = systemSettings.orgWebsite || '';
    document.getElementById('orgDirector').value = systemSettings.orgDirector || '';
    
    // 收據設定
    document.getElementById('receiptPrefix').value = systemSettings.receiptPrefix || 'R';
    document.getElementById('receiptNumberLength').value = systemSettings.receiptNumberLength || '8';
    document.getElementById('receiptTitle').value = systemSettings.receiptTitle || '捐款收據';
    document.getElementById('receiptNote').value = systemSettings.receiptNote || '';
    document.getElementById('autoSendReceipt').checked = systemSettings.autoSendReceipt || false;
    
    // 自動備份設定
    document.getElementById('enableAutoBackup').checked = systemSettings.enableAutoBackup || false;
    document.getElementById('autoBackupFrequency').value = systemSettings.autoBackupFrequency || 'weekly';
    
    // 最後備份時間
    if (systemSettings.lastBackupTime) {
        document.getElementById('lastBackupTime').textContent = formatDateTime(systemSettings.lastBackupTime);
    }
}

async function saveBasicSettings() {
    const form = document.getElementById('basicSettingsForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const settingsData = {
        orgName: document.getElementById('orgName').value,
        orgTaxId: document.getElementById('orgTaxId').value,
        orgPhone: document.getElementById('orgPhone').value,
        orgFax: document.getElementById('orgFax').value,
        orgAddress: document.getElementById('orgAddress').value,
        orgEmail: document.getElementById('orgEmail').value,
        orgWebsite: document.getElementById('orgWebsite').value,
        orgDirector: document.getElementById('orgDirector').value
    };
    
    try {
        showLoading(true);
        const result = await apiCall('saveBasicSettings', { data: settingsData }, 'POST');
        
        if (result.success) {
            showToast('基本設定儲存成功');
            systemSettings = { ...systemSettings, ...settingsData };
        } else {
            showToast('儲存失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('儲存基本設定失敗:', error);
        showToast('儲存基本設定失敗', 'error');
    } finally {
        showLoading(false);
    }
}

async function loadAccountsData() {
    try {
        accountsData = await apiCall('getAccounts');
        renderAccountsTable();
    } catch (error) {
        console.error('載入會計科目失敗:', error);
        showToast('載入會計科目失敗', 'error');
    }
}

function renderAccountsTable() {
    const tbody = document.getElementById('accountsTableBody');
    
    if (!accountsData || accountsData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">暫無會計科目</td></tr>';
        return;
    }

    tbody.innerHTML = accountsData.map(account => `
        <tr>
            <td><code>${account['科目代碼']}</code></td>
            <td>${account['科目名稱']}</td>
            <td>
                <span class="badge ${getAccountTypeClass(account['科目類型'])}">
                    ${account['科目類型']}
                </span>
            </td>
            <td>
                <span class="badge ${account['狀態'] === '啟用' ? 'bg-success' : 'bg-secondary'}">
                    ${account['狀態']}
                </span>
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editAccount('${account['ID']}')" title="編輯">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteAccount('${account['ID']}')" title="刪除">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function getAccountTypeClass(type) {
    switch (type) {
        case '收入科目': return 'bg-success';
        case '支出科目': return 'bg-danger';
        case '資產科目': return 'bg-primary';
        case '負債科目': return 'bg-warning';
        default: return 'bg-secondary';
    }
}

function showAddAccountModal() {
    const modalHtml = `
        <div class="modal fade" id="accountModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-plus me-2"></i>
                            新增會計科目
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="accountForm">
                            <div class="mb-3">
                                <label class="form-label">科目代碼 *</label>
                                <input type="text" class="form-control" id="accountCode" required>
                                <div class="form-text">建議使用4位數字，例如：1001</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">科目名稱 *</label>
                                <input type="text" class="form-control" id="accountName" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">科目類型 *</label>
                                <select class="form-select" id="accountType" required>
                                    <option value="">請選擇類型</option>
                                    <option value="收入科目">收入科目</option>
                                    <option value="支出科目">支出科目</option>
                                    <option value="資產科目">資產科目</option>
                                    <option value="負債科目">負債科目</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">科目說明</label>
                                <textarea class="form-control" id="accountDescription" rows="3"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">狀態</label>
                                <select class="form-select" id="accountStatus">
                                    <option value="啟用">啟用</option>
                                    <option value="停用">停用</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveAccount()">儲存</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    const modal = new bootstrap.Modal(document.getElementById('accountModal'));
    modal.show();
    
    // 清理 modal
    document.getElementById('accountModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

async function saveAccount() {
    const form = document.getElementById('accountForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const accountData = {
        code: document.getElementById('accountCode').value,
        name: document.getElementById('accountName').value,
        type: document.getElementById('accountType').value,
        description: document.getElementById('accountDescription').value,
        status: document.getElementById('accountStatus').value
    };
    
    try {
        showLoading(true);
        const result = await apiCall('addAccount', { data: accountData }, 'POST');
        
        if (result.success) {
            showToast('會計科目新增成功');
            bootstrap.Modal.getInstance(document.getElementById('accountModal')).hide();
            await loadAccountsData();
        } else {
            showToast('新增失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('新增會計科目失敗:', error);
        showToast('新增會計科目失敗', 'error');
    } finally {
        showLoading(false);
    }
}

async function editAccount(accountId) {
    const account = accountsData.find(a => a['ID'] === accountId);
    if (!account) return;
    
    showAddAccountModal();
    
    // 等待 modal 完全載入
    setTimeout(() => {
        document.getElementById('accountCode').value = account['科目代碼'];
        document.getElementById('accountName').value = account['科目名稱'];
        document.getElementById('accountType').value = account['科目類型'];
        document.getElementById('accountDescription').value = account['科目說明'] || '';
        document.getElementById('accountStatus').value = account['狀態'];
        
        // 更改標題和儲存函數
        document.querySelector('#accountModal .modal-title').innerHTML = 
            '<i class="fas fa-edit me-2"></i>編輯會計科目';
        document.querySelector('#accountModal .btn-primary').onclick = () => updateAccount(accountId);
    }, 100);
}

async function updateAccount(accountId) {
    const form = document.getElementById('accountForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const accountData = {
        id: accountId,
        code: document.getElementById('accountCode').value,
        name: document.getElementById('accountName').value,
        type: document.getElementById('accountType').value,
        description: document.getElementById('accountDescription').value,
        status: document.getElementById('accountStatus').value
    };
    
    try {
        showLoading(true);
        const result = await apiCall('updateAccount', { data: accountData }, 'POST');
        
        if (result.success) {
            showToast('會計科目更新成功');
            bootstrap.Modal.getInstance(document.getElementById('accountModal')).hide();
            await loadAccountsData();
        } else {
            showToast('更新失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('更新會計科目失敗:', error);
        showToast('更新會計科目失敗', 'error');
    } finally {
        showLoading(false);
    }
}

async function deleteAccount(accountId) {
    if (!confirm('確定要刪除這個會計科目嗎？此操作無法復原。')) {
        return;
    }
    
    try {
        showLoading(true);
        const result = await apiCall('deleteAccount', { id: accountId }, 'POST');
        
        if (result.success) {
            showToast('會計科目刪除成功');
            await loadAccountsData();
        } else {
            showToast('刪除失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('刪除會計科目失敗:', error);
        showToast('刪除會計科目失敗', 'error');
    } finally {
        showLoading(false);
    }
}

async function saveReceiptSettings() {
    const settingsData = {
        receiptPrefix: document.getElementById('receiptPrefix').value,
        receiptNumberLength: document.getElementById('receiptNumberLength').value,
        receiptTitle: document.getElementById('receiptTitle').value,
        receiptNote: document.getElementById('receiptNote').value,
        autoSendReceipt: document.getElementById('autoSendReceipt').checked
    };
    
    try {
        showLoading(true);
        const result = await apiCall('saveReceiptSettings', { data: settingsData }, 'POST');
        
        if (result.success) {
            showToast('收據設定儲存成功');
            systemSettings = { ...systemSettings, ...settingsData };
        } else {
            showToast('儲存失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('儲存收據設定失敗:', error);
        showToast('儲存收據設定失敗', 'error');
    } finally {
        showLoading(false);
    }
}

function previewReceiptFormat() {
    const previewData = {
        receiptNumber: document.getElementById('receiptPrefix').value + '00000001',
        donorName: '王小明',
        donationDate: formatDate(new Date()),
        amount: 1000,
        purpose: '一般捐款',
        title: document.getElementById('receiptTitle').value,
        note: document.getElementById('receiptNote').value,
        orgName: systemSettings.orgName || '慈善機構',
        orgAddress: systemSettings.orgAddress || '',
        orgPhone: systemSettings.orgPhone || ''
    };
    
    const previewHtml = generateReceiptPreview(previewData);
    
    const previewWindow = window.open('', '_blank', 'width=800,height=600');
    previewWindow.document.write(previewHtml);
    previewWindow.document.close();
}

function generateReceiptPreview(data) {
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>收據預覽</title>
            <style>
                body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 20px; }
                .receipt { border: 2px solid #000; padding: 20px; max-width: 600px; margin: 0 auto; }
                .header { text-align: center; margin-bottom: 20px; }
                .title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
                .receipt-number { font-size: 14px; margin-bottom: 20px; }
                .content { line-height: 1.8; }
                .amount { font-size: 18px; font-weight: bold; color: #d63384; }
                .footer { margin-top: 30px; text-align: right; }
                .org-info { margin-top: 20px; font-size: 12px; color: #666; }
            </style>
        </head>
        <body>
            <div class="receipt">
                <div class="header">
                    <div class="title">${data.title}</div>
                    <div class="receipt-number">收據編號：${data.receiptNumber}</div>
                </div>
                
                <div class="content">
                    <p>收據日期：${data.donationDate}</p>
                    <p>捐款人：${data.donorName}</p>
                    <p>捐款用途：${data.purpose}</p>
                    <p>捐款金額：<span class="amount">新台幣 ${formatCurrency(data.amount)} 元整</span></p>
                </div>
                
                <div class="footer">
                    <p>此致</p>
                    <p>${data.orgName}</p>
                    <p>開立日期：${formatDate(new Date())}</p>
                </div>
                
                <div class="org-info">
                    <p>${data.orgName}</p>
                    <p>地址：${data.orgAddress}</p>
                    <p>電話：${data.orgPhone}</p>
                    <p>${data.note}</p>
                </div>
            </div>
        </body>
        </html>
    `;
}

async function createBackup() {
    const backupOptions = {
        donations: document.getElementById('backupDonations').checked,
        expenses: document.getElementById('backupExpenses').checked,
        donors: document.getElementById('backupDonors').checked,
        settings: document.getElementById('backupSettings').checked
    };
    
    try {
        showLoading(true);
        const result = await apiCall('createBackup', { options: backupOptions }, 'POST');
        
        if (result.success) {
            // 下載備份檔案
            const blob = new Blob([JSON.stringify(result.data, null, 2)], { 
                type: 'application/json' 
            });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast('備份檔案已產生並下載');
            
            // 更新最後備份時間
            systemSettings.lastBackupTime = new Date().toISOString();
            document.getElementById('lastBackupTime').textContent = formatDateTime(systemSettings.lastBackupTime);
        } else {
            showToast('備份失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('建立備份失敗:', error);
        showToast('建立備份失敗', 'error');
    } finally {
        showLoading(false);
    }
}

async function restoreData() {
    const fileInput = document.getElementById('restoreFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('請選擇備份檔案', 'warning');
        return;
    }
    
    if (!confirm('確定要還原資料嗎？此操作將覆蓋現有資料，且無法復原。')) {
        return;
    }
    
    try {
        showLoading(true);
        
        const fileContent = await readFileAsText(file);
        let backupData;
        
        try {
            backupData = JSON.parse(fileContent);
        } catch (e) {
            throw new Error('備份檔案格式錯誤');
        }
        
        const result = await apiCall('restoreData', { data: backupData }, 'POST');
        
        if (result.success) {
            showToast('資料還原成功，請重新整理頁面');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showToast('還原失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('還原資料失敗:', error);
        showToast('還原資料失敗: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function readFileAsText(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = e => reject(e);
        reader.readAsText(file);
    });
}

async function saveAutoBackupSettings() {
    const settingsData = {
        enableAutoBackup: document.getElementById('enableAutoBackup').checked,
        autoBackupFrequency: document.getElementById('autoBackupFrequency').value
    };
    
    try {
        showLoading(true);
        const result = await apiCall('saveAutoBackupSettings', { data: settingsData }, 'POST');
        
        if (result.success) {
            showToast('自動備份設定儲存成功');
            systemSettings = { ...systemSettings, ...settingsData };
        } else {
            showToast('儲存失敗: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('儲存自動備份設定失敗:', error);
        showToast('儲存自動備份設定失敗', 'error');
    } finally {
        showLoading(false);
    }
}

// 應用程式初始化
document.addEventListener('DOMContentLoaded', function() {
    // 初始化 Bootstrap 工具提示
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // 載入儀表板
    loadDashboard();
    
    // 設定導航事件
    setupNavigation();
    
    // 載入基本資料
    loadInitialData();
});

function setupNavigation() {
    // 側邊欄導航點擊事件
    document.querySelectorAll('.nav-link[data-page]').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const page = this.dataset.page;
            const pageTitle = this.textContent.trim();
            
            // 更新活動狀態
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            
            // 隱藏所有頁面
            document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
            
            // 顯示目標頁面
            const targetPage = document.getElementById(page + '-page');
            if (targetPage) {
                targetPage.style.display = 'block';
                
                // 載入對應頁面內容
                loadPageContent(page);
            }
            
            // 更新頁面標題
            updatePageTitle(pageTitle);
        });
    });
}

async function loadInitialData() {
    try {
        // 載入基本資料
        await Promise.all([
            loadSystemSettings(),
            loadAccountsData()
        ]);
    } catch (error) {
        console.error('載入初始資料失敗:', error);
    }
}

function loadPageContent(page) {
    switch (page) {
        case 'dashboard':
            loadDashboard();
            break;
        case 'donations':
            loadDonationsPage();
            break;
        case 'expenses':
            loadExpensesPage();
            break;
        case 'donors':
            loadDonorsPage();
            break;
        case 'receipts':
            loadReceiptsPage();
            break;
        case 'budget':
            loadBudgetPage();
            break;
        case 'reports':
            loadReportsPage();
            break;
        case 'settings':
            loadSettingsPage();
            break;
    }
}

function updatePageTitle(title) {
    document.title = `${title} - 慈善機構管理系統`;
}

// 全域錯誤處理
window.addEventListener('error', function(e) {
    console.error('全域錯誤:', e.error);
    showToast('系統發生錯誤，請重新整理頁面', 'error');
});

// 離線檢測
window.addEventListener('online', function() {
    showToast('網路連線已恢復', 'success');
});

window.addEventListener('offline', function() {
    showToast('網路連線中斷，部分功能可能無法使用', 'warning');
});

// 鍵盤快捷鍵
document.addEventListener('keydown', function(e) {
    // Ctrl + S 儲存
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        // 根據當前頁面執行相應的儲存操作
        const activePage = document.querySelector('.nav-link.active')?.dataset.page;
        if (activePage === 'settings') {
            saveBasicSettings();
        }
    }
    
    // ESC 關閉 modal
    if (e.key === 'Escape') {
        const openModal = document.querySelector('.modal.show');
        if (openModal) {
            bootstrap.Modal.getInstance(openModal)?.hide();
        }
    }
});

// 自動儲存草稿功能（可選）
let autoSaveTimer;
function setupAutoSave(formId, saveFunction) {
    const form = document.getElementById(formId);
    if (!form) return;
    
    form.addEventListener('input', function() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            // 儲存草稿到 localStorage
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            localStorage.setItem(`draft_${formId}`, JSON.stringify(data));
        }, 1000);
    });
}

// 載入草稿
function loadDraft(formId) {
    const draft = localStorage.getItem(`draft_${formId}`);
    if (draft) {
        try {
            const data = JSON.parse(draft);
            Object.keys(data).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = data[key];
                }
            });
        } catch (e) {
            console.error('載入草稿失敗:', e);
        }
    }
}

// 清除草稿
function clearDraft(formId) {
    localStorage.removeItem(`draft_${formId}`);
}

// 匯出功能增強
function exportToExcel(data, filename, sheetName = 'Sheet1') {
    // 這裡可以整合 SheetJS 或其他 Excel 匯出庫
    // 目前使用 CSV 格式作為替代
    const csvContent = convertToCSV(data);
    downloadCSV(csvContent, filename);
}

function convertToCSV(data) {
    if (!data || data.length === 0) return '';
    
    const headers = Object.keys(data[0]);
    const csvRows = [
        headers.join(','),
        ...data.map(row => 
            headers.map(header => {
                const value = row[header];
                return typeof value === 'string' && value.includes(',') 
                    ? `"${value}"` 
                    : value;
            }).join(',')
        )
    ];
    
    return csvRows.join('\n');
}

function downloadCSV(csvContent, filename) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
}

// 列印功能
function printPage(elementId) {
    const element = document.getElementById(elementId);
    if (!element) {
        console.error('找不到要列印的元素:', elementId);
        showToast('找不到要列印的內容', 'error');
        return;
    }
    
    // 建立新的列印視窗
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    
    // 寫入 HTML 內容
    printWindow.document.write(`
        <!DOCTYPE html>
        <html lang="zh-TW">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>列印 - 慈善機構管理系統</title>
            
            <!-- Bootstrap CSS -->
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            
            <!-- 列印專用樣式 -->
            <style>
                /* 基本樣式 */
                body {
                    font-family: 'Microsoft JhengHei', Arial, sans-serif;
                    font-size: 12px;
                    line-height: 1.4;
                    color: #000;
                    background: white;
                    margin: 0;
                    padding: 20px;
                }
                
                /* 列印時隱藏不需要的元素 */
                @media print {
                    .no-print,
                    .btn,
                    .pagination,
                    .modal,
                    .toast,
                    .sidebar,
                    .navbar {
                        display: none !important;
                    }
                    
                    body {
                        font-size: 11px;
                        margin: 0;
                        padding: 10px;
                    }
                    
                    .container,
                    .container-fluid {
                        max-width: 100% !important;
                        padding: 0 !important;
                        margin: 0 !important;
                    }
                    
                    .card {
                        box-shadow: none !important;
                        border: 1px solid #ddd !important;
                        page-break-inside: avoid;
                    }
                    
                    .card-header {
                        background: #f8f9fa !important;
                        color: #000 !important;
                        -webkit-print-color-adjust: exact;
                    }
                    
                    .table {
                        font-size: 10px;
                    }
                    
                    .table th,
                    .table td {
                        padding: 4px !important;
                        border: 1px solid #ddd !important;
                    }
                    
                    .page-title {
                        color: #000 !important;
                        border-bottom: 2px solid #000 !important;
                        page-break-after: avoid;
                    }
                    
                    /* 強制顯示背景色 */
                    .bg-primary,
                    .bg-success,
                    .bg-danger,
                    .bg-warning,
                    .bg-info {
                        -webkit-print-color-adjust: exact;
                        color-adjust: exact;
                    }
                    
                    /* 分頁控制 */
                    .page-break {
                        page-break-before: always;
                    }
                    
                    .no-page-break {
                        page-break-inside: avoid;
                    }
                }
                
                /* 螢幕預覽樣式 */
                @media screen {
                    body {
                        max-width: 210mm;
                        margin: 0 auto;
                        box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        padding: 20mm;
                    }
                }
                
                /* 表格樣式優化 */
                .table {
                    width: 100%;
                    border-collapse: collapse;
                }
                
                .table th {
                    background-color: #f8f9fa;
                    font-weight: bold;
                    text-align: center;
                }
                
                .table td {
                    vertical-align: top;
                }
                
                /* 頁首頁尾 */
                .print-header {
                    text-align: center;
                    margin-bottom: 20px;
                    border-bottom: 2px solid #000;
                    padding-bottom: 10px;
                }
                
                .print-footer {
                    text-align: center;
                    margin-top: 20px;
                    border-top: 1px solid #ddd;
                    padding-top: 10px;
                    font-size: 10px;
                    color: #666;
                }
                
                /* 統計數字樣式 */
                .stats-number {
                    font-size: 18px;
                    font-weight: bold;
                    color: #000;
                }
                
                /* 金額樣式 */
                .currency {
                    text-align: right;
                    font-family: 'Courier New', monospace;
                }
            </style>
        </head>
        <body>
            <!-- 列印頁首 -->
            <div class="print-header">
                <h2>慈善機構管理系統</h2>
                <p>列印時間：${new Date().toLocaleString('zh-TW')}</p>
            </div>
            
            <!-- 主要內容 -->
            <div class="print-content">
                ${element.innerHTML}
            </div>
            
            <!-- 列印頁尾 -->
            <div class="print-footer">
                <p>此報表由慈善機構管理系統自動產生</p>
            </div>
            
            <script>
                // 等待頁面完全載入後執行列印
                window.onload = function() {
                    // 稍微延遲以確保樣式完全載入
                    setTimeout(function() {
                        window.print();
                        
                        // 列印完成後關閉視窗
                        setTimeout(function() {
                            window.close();
                        }, 1000);
                    }, 500);
                };
                
                // 如果用戶取消列印，也關閉視窗
                window.onafterprint = function() {
                    window.close();
                };
            </script>
        </body>
        </html>
    `);
    
    // 關閉文件寫入
    printWindow.document.close();
}

// 列印特定報表的函數
function printReport(reportType, reportData) {
    let printContent = '';
    
    switch (reportType) {
        case 'monthly':
            printContent = generateMonthlyReportPrint(reportData);
            break;
        case 'yearly':
            printContent = generateYearlyReportPrint(reportData);
            break;
        case 'donor':
            printContent = generateDonorReportPrint(reportData);
            break;
        case 'receipt':
            printContent = generateReceiptPrint(reportData);
            break;
        default:
            showToast('不支援的報表類型', 'error');
            return;
    }
    
    // 建立臨時元素用於列印
    const tempDiv = document.createElement('div');
    tempDiv.id = 'temp-print-content';
    tempDiv.innerHTML = printContent;
    tempDiv.style.display = 'none';
    document.body.appendChild(tempDiv);
    
    // 執行列印
    printPage('temp-print-content');
    
    // 清理臨時元素
    setTimeout(() => {
        document.body.removeChild(tempDiv);
    }, 1000);
}

// 產生月度報表列印內容
function generateMonthlyReportPrint(data) {
    return `
        <div class="report-container">
            <h1 class="page-title text-center">${data.year}年${data.month}月 財務報表</h1>
            
            <!-- 統計摘要 -->
            <div class="row mb-4 no-page-break">
                <div class="col-12">
                    <h3>統計摘要</h3>
                    <table class="table table-bordered">
                        <tr>
                            <td><strong>總收入</strong></td>
                            <td class="currency">${formatCurrency(data.totalIncome || 0)}</td>
                        </tr>
                        <tr>
                            <td><strong>總支出</strong></td>
                            <td class="currency">${formatCurrency(data.totalExpense || 0)}</td>
                        </tr>
                        <tr>
                            <td><strong>淨收支</strong></td>
                            <td class="currency"><strong>${formatCurrency((data.totalIncome || 0) - (data.totalExpense || 0))}</strong></td>
                        </tr>
                        <tr>
                            <td><strong>捐款筆數</strong></td>
                            <td class="text-end">${data.donationCount || 0} 筆</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- 收入明細 -->
            <div class="mb-4 no-page-break">
                <h3>收入明細</h3>
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>類型</th>
                            <th>金額</th>
                            <th>筆數</th>
                            <th>比例</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(data.incomeByType || []).map(item => `
                            <tr>
                                <td>${item.type}</td>
                                <td class="currency">${formatCurrency(item.amount)}</td>
                                <td class="text-end">${item.count}</td>
                                <td class="text-end">${((item.amount / (data.totalIncome || 1)) * 100).toFixed(1)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <!-- 支出明細 -->
            <div class="mb-4 no-page-break">
                <h3>支出明細</h3>
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>類別</th>
                            <th>金額</th>
                            <th>筆數</th>
                            <th>比例</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(data.expenseByCategory || []).map(item => `
                            <tr>
                                <td>${item.category}</td>
                                <td class="currency">${formatCurrency(item.amount)}</td>
                                <td class="text-end">${item.count}</td>
                                <td class="text-end">${((item.amount / (data.totalExpense || 1)) * 100).toFixed(1)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// 產生收據列印內容
function generateReceiptPrint(receiptData) {
    return `
        <div class="receipt-container" style="max-width: 600px; margin: 0 auto;">
            <div class="receipt-header text-center mb-4">
                <h2>${receiptData.title || '捐款收據'}</h2>
                <p><strong>收據編號：${receiptData.receiptNumber}</strong></p>
            </div>
            
            <div class="receipt-content">
                <table class="table table-borderless">
                    <tr>
                        <td width="30%"><strong>收據日期：</strong></td>
                        <td>${formatDate(receiptData.date)}</td>
                    </tr>
                    <tr>
                        <td><strong>捐款人：</strong></td>
                        <td>${receiptData.donorName}</td>
                    </tr>
                    <tr>
                        <td><strong>捐款用途：</strong></td>
                        <td>${receiptData.purpose}</td>
                    </tr>
                    <tr>
                        <td><strong>付款方式：</strong></td>
                        <td>${receiptData.paymentMethod}</td>
                    </tr>
                    <tr>
                        <td><strong>捐款金額：</strong></td>
                        <td class="stats-number">新台幣 ${formatCurrency(receiptData.amount)} 元整</td>
                    </tr>
                </table>
            </div>
            
            <div class="receipt-footer mt-4">
                <div class="text-end">
                    <p>此致</p>
                    <p><strong>${receiptData.orgName || '慈善機構'}</strong></p>
                    <p>開立日期：${formatDate(new Date())}</p>
                </div>
                
                <div class="mt-4 pt-3" style="border-top: 1px solid #ddd;">
                    <small>${receiptData.note || '感謝您的愛心捐款，本收據可作為報稅憑證。'}</small>
                </div>
            </div>
        </div>
    `;
}

// 批次列印收據
function batchPrintReceipts(receiptIds) {
    if (!receiptIds || receiptIds.length === 0) {
        showToast('請選擇要列印的收據', 'warning');
        return;
    }
    
    // 確認批次列印
    if (!confirm(`確定要列印 ${receiptIds.length} 張收據嗎？`)) {
        return;
    }
    
    // 逐一列印每張收據
    receiptIds.forEach((receiptId, index) => {
        setTimeout(() => {
            const receiptData = getReceiptData(receiptId);
            if (receiptData) {
                printReport('receipt', receiptData);
            }
        }, index * 1000); // 每秒列印一張，避免瀏覽器阻擋
    });
    
    showToast(`開始批次列印 ${receiptIds.length} 張收據`);
}

// 列印預覽功能
function printPreview(elementId) {
    const element = document.getElementById(elementId);
    if (!element) {
        showToast('找不到要預覽的內容', 'error');
        return;
    }
    
    // 建立預覽視窗
    const previewWindow = window.open('', '_blank', 'width=900,height=700');
    
    previewWindow.document.write(`
        <!DOCTYPE html>
        <html lang="zh-TW">
        <head>
            <meta charset="UTF-8">
            <title>列印預覽</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body {
                    font-family: 'Microsoft JhengHei', Arial, sans-serif;
                    padding: 20px;
                    background: #f5f5f5;
                }
                .preview-container {
                    background: white;
                    padding: 40px;
                    box-shadow: 0 0 20px rgba(0,0,0,0.1);
                    max-width: 210mm;
                    margin: 0 auto;
                }
                .preview-toolbar {
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    z-index: 1000;
                }
                @media print {
                    .preview-toolbar { display: none; }
                    body { background: white; }
                    .preview-container { box-shadow: none; padding: 0; }
                }
            </style>
        </head>
        <body>
            <div class="preview-toolbar">
                <button class="btn btn-primary me-2" onclick="window.print()">
                    <i class="fas fa-print"></i> 列印
                </button>
                <button class="btn btn-secondary" onclick="window.close()">
                    <i class="fas fa-times"></i> 關閉
                </button>
            </div>
            
            <div class="preview-container">
                ${element.innerHTML}
            </div>
        </body>
        </html>
    `);
    
    previewWindow.document.close();
}

// 系統效能監控
function monitorPerformance() {
    if ('performance' in window) {
        const navigation = performance.getEntriesByType('navigation')[0];
        if (navigation) {
            console.log('頁面載入時間:', navigation.loadEventEnd - navigation.loadEventStart, 'ms');
        }
    }
}

// 在頁面載入完成後執行效能監控
window.addEventListener('load', monitorPerformance);

console.log('慈善機構管理系統前端程式載入完成');

