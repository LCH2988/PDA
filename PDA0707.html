<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會 - 會計管理系統 v5.1</title>
  
  <style>
    /* 基礎樣式重置 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #4e73df;
      --primary-gradient: linear-gradient(135deg, #4e73df 0%, #6f42c1 100%);
      --secondary-color: #6c757d;
      --success-color: #1cc88a;
      --danger-color: #e74a3b;
      --warning-color: #f6c23e;
      --info-color: #36b9cc;
      --light-color: #f8f9fc;
      --dark-color: #5a5c69;
      --border-color: #e3e6f0;
      --shadow-sm: 0 .125rem .25rem rgba(0,0,0,.075);
      --shadow: 0 .5rem 1rem rgba(0,0,0,.15);
      --shadow-lg: 0 1rem 3rem rgba(0,0,0,.175);
      --font-family: 'Nunito', 'Microsoft JhengHei', sans-serif;
      --transition: all 0.3s ease;
      --border-radius: 0.35rem;
    }

    body {
      font-family: var(--font-family);
      line-height: 1.6;
      color: #333;
      background-color: #f8f9fc;
    }

    /* 頂部導航 */
    .navbar {
      background: var(--primary-gradient);
      color: white;
      padding: 1rem 0;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .navbar .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .navbar h1 {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .navbar .nav-info {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 0.9rem;
    }

    /* 主要容器 */
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 20px;
    }

    /* 載入動畫 */
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .loading.show {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading p {
      margin-top: 10px;
      font-weight: 500;
      color: var(--primary-color);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 標籤頁導航 */
    .tab-nav {
      display: flex;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: 20px;
      overflow: hidden;
      flex-wrap: wrap;
    }

    .tab-nav button {
      flex: 1;
      min-width: 120px;
      padding: 15px 20px;
      border: none;
      background: white;
      color: var(--secondary-color);
      cursor: pointer;
      transition: var(--transition);
      font-size: 1rem;
      font-weight: 500;
    }

    .tab-nav button:hover {
      background: #f8f9fa;
      color: var(--primary-color);
    }

    .tab-nav button.active {
      background: var(--primary-gradient);
      color: white;
    }

    /* 標籤頁內容 */
    .tab-content {
      display: none;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      padding: 30px;
      margin-bottom: 20px;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* 表單樣式 */
    .form-group {
      margin-bottom: 20px;
    }

    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .form-row .form-group {
      flex: 1;
      min-width: 200px;
      margin-bottom: 0;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark-color);
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
      background: white;
      font-family: var(--font-family);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* 按鈕樣式 */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      display: inline-block;
      text-align: center;
      line-height: 1.4;
    }

    .btn-primary {
      background: var(--primary-gradient);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn-secondary {
      background: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-success:hover {
      background: #17a673;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-danger:hover {
      background: #d52a1a;
      transform: translateY(-2px);
    }

    .btn-warning {
      background: var(--warning-color);
      color: #212529;
    }

    .btn-warning:hover {
      background: #f4b619;
      transform: translateY(-2px);
    }

    .btn-info {
      background: var(--info-color);
      color: white;
    }

    .btn-info:hover {
      background: #2ca0b9;
      transform: translateY(-2px);
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 0.875rem;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* 表格樣式 */
    .table-container {
      overflow-x: auto;
      margin: 20px 0;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      background: #f8f9fc;
      font-weight: 600;
      color: var(--dark-color);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tr:hover {
      background: #f8f9fa;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .table-actions {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    /* 卡片樣式 */
    .card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      padding: 25px;
      margin-bottom: 20px;
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .card-header {
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 15px;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--dark-color);
      margin: 0;
    }

    .card-subtitle {
      font-size: 0.9rem;
      color: var(--secondary-color);
      margin: 5px 0 0 0;
    }

    /* 統計卡片 */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow-sm);
      text-align: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-gradient);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--dark-color);
      margin-bottom: 10px;
    }

    .stat-label {
      font-size: 1rem;
      color: var(--secondary-color);
      font-weight: 500;
    }

    .stat-change {
      font-size: 0.875rem;
      margin-top: 8px;
    }

    .stat-change.positive {
      color: var(--success-color);
    }

    .stat-change.negative {
      color: var(--danger-color);
    }

    /* 警告和通知 */
    .alert {
      padding: 15px 20px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      border-left: 4px solid;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border-color: var(--success-color);
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border-color: var(--danger-color);
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border-color: var(--warning-color);
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border-color: var(--info-color);
    }

    .alert .close {
      margin-left: auto;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      opacity: 0.7;
    }

    .alert .close:hover {
      opacity: 1;
    }

    /* 搜尋和篩選 */
    .search-filters {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-sm);
    }

    .search-row {
      display: flex;
      gap: 15px;
      align-items: end;
      flex-wrap: wrap;
    }

    .search-group {
      flex: 1;
      min-width: 200px;
    }

    .search-group label {
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    /* 分頁 */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .pagination button {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      background: white;
      color: var(--dark-color);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
    }

    .pagination button:hover {
      background: #e9ecef;
    }

    .pagination button.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* 模態框 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: var(--border-radius);
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--dark-color);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: #999;
      line-height: 1;
    }

    .modal-close:hover {
      color: #333;
    }

    /* 詳情顯示樣式 */
    .detail-content {
      max-width: 100%;
    }

    .detail-row {
      display: flex;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f0f0f0;
    }

    .detail-row:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .detail-label {
      font-weight: 600;
      color: var(--dark-color);
      min-width: 120px;
      flex-shrink: 0;
    }

    .detail-value {
      color: #333;
      flex: 1;
    }

    /* 系統狀態樣式 */
    .system-status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .status-item {
      padding: 15px;
      background: #f8f9fa;
      border-radius: var(--border-radius);
      text-align: center;
    }

    .status-item h5 {
      margin-bottom: 10px;
      color: var(--secondary-color);
      font-size: 0.9rem;
    }

    .status-item p {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* 報表內容樣式 */
    .report-content {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
    }

    .report-summary {
      margin-bottom: 30px;
    }

    .report-summary h4 {
      color: var(--dark-color);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color);
    }

    .report-details {
      margin-top: 30px;
    }

    .report-details h4 {
      color: var(--dark-color);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color);
    }

    /* 空狀態 */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: #666;
    }

    .empty-state p {
      font-size: 1rem;
      margin-bottom: 20px;
    }

    /* 網路狀態指示器 */
    .network-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 600;
      z-index: 9999;
      transition: var(--transition);
    }

    .network-status.online {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .network-status.offline {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* 應用程式頁腳 */
    .app-footer {
      margin-top: 50px;
      padding: 20px 0;
      text-align: center;
      color: var(--secondary-color);
      font-size: 0.875rem;
      border-top: 1px solid var(--border-color);
    }

    .app-footer a {
      color: var(--primary-color);
      text-decoration: none;
    }

    .app-footer a:hover {
      text-decoration: underline;
    }

    /* 響應式設計 */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .form-row {
        flex-direction: column;
        gap: 0;
      }

      .search-row {
        flex-direction: column;
        align-items: stretch;
      }

      .search-group {
        min-width: auto;
      }

      .btn-group {
        flex-direction: column;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .navbar .container {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }

      .navbar .nav-info {
        justify-content: center;
      }

      .table-container {
        font-size: 0.875rem;
      }

      th, td {
        padding: 10px 8px;
      }
    }

    /* 深色主題支援 */
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #1a1a1a;
        color: #e0e0e0;
      }

      .card, .tab-content, .search-filters {
        background: #2d2d2d;
        color: #e0e0e0;
      }

      input, select, textarea {
        background: #3d3d3d;
        color: #e0e0e0;
        border-color: #555;
      }

      table {
        background: #2d2d2d;
      }

      th {
        background: #3d3d3d;
        color: #e0e0e0;
      }

      tr:hover {
        background: #3d3d3d;
      }
    }

    /* 列印樣式 */
    @media print {
      .navbar, .tab-nav, .btn, .search-filters {
        display: none !important;
      }

      .container {
        max-width: none;
        padding: 0;
      }

      .card, .tab-content {
        box-shadow: none;
        border: 1px solid #ddd;
      }
    }

    /* 輔助類別 */
    .text-success { color: var(--success-color) !important; }
    .text-danger { color: var(--danger-color) !important; }
    .text-warning { color: var(--warning-color) !important; }
    .text-info { color: var(--info-color) !important; }

    .mt-0 { margin-top: 0 !important; }
    .mt-1 { margin-top: 0.25rem !important; }
    .mt-2 { margin-top: 0.5rem !important; }
    .mt-3 { margin-top: 1rem !important; }
    .mt-4 { margin-top: 1.5rem !important; }
    .mt-5 { margin-top: 3rem !important; }

    .mb-0 { margin-bottom: 0 !important; }
    .mb-1 { margin-bottom: 0.25rem !important; }
    .mb-2 { margin-bottom: 0.5rem !important; }
    .mb-3 { margin-bottom: 1rem !important; }
    .mb-4 { margin-bottom: 1.5rem !important; }
    .mb-5 { margin-bottom: 3rem !important; }

    .p-0 { padding: 0 !important; }
    .p-1 { padding: 0.25rem !important; }
    .p-2 { padding: 0.5rem !important; }
    .p-3 { padding: 1rem !important; }
    .p-4 { padding: 1.5rem !important; }
    .p-5 { padding: 3rem !important; }

    .d-none { display: none !important; }
    .d-block { display: block !important; }
    .d-flex { display: flex !important; }
    .text-center { text-align: center !important; }
  </style>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
  <!-- 網路狀態指示器 -->
  <div id="networkStatus" class="network-status online">
    <span id="networkStatusText">線上</span>
  </div>

  <!-- 載入動畫 -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>載入中...</p>
  </div>

  <!-- 頂部導航 -->
  <nav class="navbar">
    <div class="container">
      <h1>台灣帕金森病友權益促進會 - 會計管理系統</h1>
      <div class="nav-info">
        <span id="currentTime"></span>
        <span>v5.1</span>
      </div>
    </div>
  </nav>

  <!-- 主要內容 -->
  <div class="container">
    <!-- 警告訊息區域 -->
    <div id="alertContainer"></div>

    <!-- 標籤頁導航 -->
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="dashboard">📊 儀表板</button>
      <button class="tab-btn" data-tab="transactions">💰 交易記錄</button>
      <button class="tab-btn" data-tab="receipts">🧾 收據管理</button>
      <button class="tab-btn" data-tab="vouchers">📋 支出憑證</button>
      <button class="tab-btn" data-tab="members">👥 會員管理</button>
      <button class="tab-btn" data-tab="reports">📈 報表分析</button>
      <button class="tab-btn" data-tab="settings">⚙️ 系統設定</button>
    </div>

    <!-- 儀表板 -->
    <div id="dashboard" class="tab-content active">
      <div class="card-header">
        <h2 class="card-title">財務概覽</h2>
        <p class="card-subtitle">本月財務狀況統計</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalIncome">$0</div>
          <div class="stat-label">本月收入</div>
          <div class="stat-change positive" id="incomeChange">+0%</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalExpense">$0</div>
          <div class="stat-label">本月支出</div>
          <div class="stat-change negative" id="expenseChange">+0%</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="receiptCount">0</div>
          <div class="stat-label">本月收據</div>
          <div class="stat-change positive" id="receiptChange">+0</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="memberCount">0</div>
          <div class="stat-label">會員總數</div>
          <div class="stat-change positive" id="memberChange">+0</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">最近活動</h3>
        </div>
        <div id="recentActivities">
          <div class="empty-state">
            <h3>載入中...</h3>
            <p>正在取得最新活動記錄</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 交易記錄 -->
    <div id="transactions" class="tab-content">
      <div class="card-header">
        <h2 class="card-title">交易記錄管理</h2>
        <p class="card-subtitle">記錄和管理所有收支交易</p>
      </div>

      <!-- 新增交易表單 -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">新增交易記錄</h3>
        </div>
        <form id="transactionForm">
          <div class="form-row">
            <div class="form-group">
              <label for="transactionDate">交易日期 *</label>
              <input type="date" id="transactionDate" name="date" required>
            </div>
            <div class="form-group">
              <label for="transactionType">收支類型 *</label>
              <select id="transactionType" name="type" required>
                <option value="">請選擇</option>
                <option value="收入">收入</option>
                <option value="支出">支出</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="transactionCategory">類別 *</label>
              <select id="transactionCategory" name="category" required>
                <option value="">請選擇</option>
                <option value="捐款">捐款</option>
                <option value="會費">會費</option>
                <option value="活動收入">活動收入</option>
                <option value="補助款">補助款</option>
                <option value="辦公費用">辦公費用</option>
                <option value="活動支出">活動支出</option>
                <option value="交通費">交通費</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="form-group">
              <label for="transactionAmount">金額 *</label>
              <input type="number" id="transactionAmount" name="amount" min="0" step="1" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="transactionName">交易對象 *</label>
              <input type="text" id="transactionName" name="name" required>
            </div>
            <div class="form-group">
              <label for="transactionAccount">帳戶</label>
              <select id="transactionAccount" name="account">
                <option value="">請選擇</option>
                <option value="現金">現金</option>
                <option value="銀行帳戶">銀行帳戶</option>
                <option value="郵局帳戶">郵局帳戶</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="transactionDescription">說明</label>
            <textarea id="transactionDescription" name="description" placeholder="請輸入交易說明..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>
                <input type="checkbox" id="generateReceipt" name="generateReceipt" value="true">
                自動產生收據（僅限收入）
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="generateVoucher" name="generateVoucher" value="true">
                自動產生憑證（僅限支出）
              </label>
            </div>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn btn-primary">儲存交易記錄</button>
            <button type="reset" class="btn btn-secondary">清除表單</button>
          </div>
        </form>
      </div>

      <!-- 交易記錄搜尋 -->
      <div class="search-filters">
        <div class="search-row">
          <div class="search-group">
            <label for="transactionSearch">搜尋</label>
            <input type="text" id="transactionSearch" placeholder="搜尋交易對象、說明...">
          </div>
          <div class="search-group">
            <label for="transactionTypeFilter">類型</label>
            <select id="transactionTypeFilter">
              <option value="">全部</option>
              <option value="收入">收入</option>
              <option value="支出">支出</option>
            </select>
          </div>
          <div class="search-group">
            <label for="transactionDateFrom">開始日期</label>
            <input type="date" id="transactionDateFrom">
          </div>
          <div class="search-group">
            <label for="transactionDateTo">結束日期</label>
            <input type="date" id="transactionDateTo">
          </div>
          <div class="search-group">
            <label>&nbsp;</label>
            <button type="button" class="btn btn-primary" onclick="searchTransactions()">搜尋</button>
          </div>
        </div>
      </div>

      <!-- 交易記錄列表 -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">交易記錄列表</h3>
        </div>
        <div class="table-container">
          <table id="transactionsTable">
            <thead>
              <tr>
                <th>日期</th>
                <th>類型</th>
                <th>類別</th>
                <th>交易對象</th>
                <th>金額</th>
                <th>帳戶</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="8" class="empty-state">
                  <h3>載入中...</h3>
                  <p>正在取得交易記錄</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div id="transactionsPagination" class="pagination"></div>
      </div>
    </div>

    <!-- 收據管理 -->
    <div id="receipts" class="tab-content">
      <div class="card-header">
        <h2 class="card-title">收據管理</h2>
        <p class="card-subtitle">開立和管理捐款收據</p>
      </div>

      <!-- 開立收據表單 -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">開立新收據</h3>
        </div>
        <form id="receiptForm">
          <div class="form-row">
            <div class="form-group">
              <label for="receiptDate">收據日期 *</label>
              <input type="date" id="receiptDate" name="date" required>
            </div>
            <div class="form-group">
              <label for="receiptPayer">付款人 *</label>
              <input type="text" id="receiptPayer" name="payer" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="receiptIdentity">身份類別</label>
              <select id="receiptIdentity" name="identity">
                <option value="一般民眾">一般民眾</option>
                <option value="會員">會員</option>
                <option value="企業">企業</option>
                <option value="團體">團體</option>
              </select>
            </div>
            <div class="form-group">
              <label for="receiptPhone">聯絡電話</label>
              <input type="tel" id="receiptPhone" name="phone">
            </div>
          </div>

          <div class="form-group">
            <label for="receiptEmail">電子郵件</label>
            <input type="email" id="receiptEmail" name="email" placeholder="用於自動寄送收據">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="receiptCategory">收據類別 *</label>
              <select id="receiptCategory" name="category" required>
                <option value="">請選擇</option>
                <option value="一般捐款">一般捐款</option>
                <option value="指定用途捐款">指定用途捐款</option>
                <option value="會費">會費</option>
                <option value="活動費用">活動費用</option>
              </select>
            </div>
            <div class="form-group">
              <label for="receiptAmount">金額 *</label>
              <input type="number" id="receiptAmount" name="amount" min="0" step="1" required>
            </div>
          </div>

          <div class="form-group">
            <label for="receiptPurpose">用途說明</label>
            <textarea id="receiptPurpose" name="purpose" placeholder="請輸入捐款用途..."></textarea>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="autoSendReceipt" name="autoSend" value="true">
              自動寄送收據至電子郵件
            </label>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn btn-primary">開立收據</button>
            <button type="reset" class="btn btn-secondary">清除表單</button>
          </div>
        </form>
      </div>

      <!-- 收據記錄搜尋 -->
      <div class="search-filters">
        <div class="search-row">
          <div class="search-group">
            <label for="receiptSearch">搜尋</label>
            <input type="text" id="receiptSearch" placeholder="搜尋收據編號、付款人...">
          </div>
          <div class="search-group">
            <label for="receiptStatusFilter">狀態</label>
            <select id="receiptStatusFilter">
              <option value="">全部</option>
              <option value="已開立">已開立</option>
              <option value="已寄送">已寄送</option>
              <option value="已作廢">已作廢</option>
            </select>
          </div>
          <div class="search-group">
            <label>&nbsp;</label>
            <button type="button" class="btn btn-primary" onclick="searchReceipts()">搜尋</button>
          </div>
        </div>
      </div>

      <!-- 收據記錄列表 -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">收據記錄列表</h3>
        </div>
        <div class="table-container">
          <table id="receiptsTable">
            <thead>
              <tr>
                <th>收據編號</th>
                <th>日期</th>
                <th>付款人</th>
                <th>類別</th>
                <th>金額</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" class="empty-state">
                  <h3>載入中...</h3>
                  <p>正在取得收據記錄</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div id="receiptsPagination" class="pagination"></div>
      </div>
    </div>

    <!-- 支出憑證 -->
    <div id="vouchers" class="tab-content">
      <div class="card-header">
        <h2 class="card-title">支出憑證管理</h2>
        <p class="card-subtitle">申請和管理支出憑證</p>
      </div>

      <!-- 申請憑證表單 -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">申請支出憑證</h3>
        </div>
        <form id="voucherForm">
          <div class="form-row">
            <div class="form-group">
              <label for="voucherDate">申請日期 *</label>
              <input type="date" id="voucherDate" name="date" required>
            </div>
            <div class="form-group">
              <label for="voucherApplicant">申請人 *</label>
              <input type="text" id="voucherApplicant" name="applicant" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="voucherCategory">支出類別 *</label>
              <select id="voucherCategory" name="category" required>
                <option value="">請選擇</option>
                <option value="辦公費用">辦公費用</option>
                <option value="交通費">交通費</option>
                <option value="活動支出">活動支出</option>
                <option value="設備採購">設備採購</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="form-group">
              <label for="voucherAmount">申請金額 *</label>
              <input type="number" id="voucherAmount" name="amount" min="0" step="1" required>
            </div>
          </div>

          <div class="form-group">
            <label for="voucherPurpose">用途說明 *</label>
            <textarea id="voucherPurpose" name="purpose" required placeholder="請詳細說明支出用途..."></textarea>
          </div>

          <div class="form-group">
            <label for="voucherAttachment">附件數量</label>
            <input type="number" id="voucherAttachment" name="attachmentCount" min="0" value="0">
            <small>請註明相關收據或發票數量</small>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn btn-primary">提交申請</button>
            <button type="reset" class="btn btn-secondary">清除表單</button>
          </div>
        </form>
      </div>

      <!-- 憑證記錄列表 -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">憑證記錄列表</h3>
        </div>
        <div class="table-container">
          <table id="vouchersTable">
            <thead>
              <tr>
                <th>憑證編號</th>
                <th>申請日期</th>
                <th>申請人</th>
                <th>類別</th>
                <th>金額</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" class="empty-state">
                  <h3>載入中...</h3>
                  <p>正在取得憑證記錄</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div id="vouchersPagination" class="pagination"></div>
      </div>
    </div>

    <!-- 會員管理 -->
    <div id="members" class="tab-content">
      <div class="card-header">
        <h2 class="card-title">會員管理</h2>
        <p class="card-subtitle">管理會員資料和會籍狀態</p>
      </div>

      <!-- 新增會員表單 -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">新增會員</h3>
        </div>
        <form id="memberForm">
          <div class="form-row">
            <div class="form-group">
              <label for="memberName">姓名 *</label>
              <input type="text" id="memberName" name="name" required>
            </div>
            <div class="form-group">
              <label for="memberGender">性別</label>
              <select id="memberGender" name="gender">
                <option value="">請選擇</option>
                <option value="男">男</option>
                <option value="女">女</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="memberBirthDate">出生日期</label>
              <input type="date" id="memberBirthDate" name="birthDate">
            </div>
            <div class="form-group">
              <label for="memberIdNumber">身份證字號</label>
              <input type="text" id="memberIdNumber" name="idNumber" pattern="[A-Z][0-9]{9}">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="memberPhone">聯絡電話 *</label>
              <input type="tel" id="memberPhone" name="phone" required>
            </div>
            <div class="form-group">
              <label for="memberEmail">電子郵件</label>
              <input type="email" id="memberEmail" name="email">
            </div>
          </div>

          <div class="form-group">
            <label for="memberAddress">聯絡地址</label>
            <textarea id="memberAddress" name="address" rows="3"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="memberType">會員類型 *</label>
              <select id="memberType" name="type" required>
                <option value="">請選擇</option>
                <option value="一般會員">一般會員</option>
                <option value="永久會員">永久會員</option>
                <option value="榮譽會員">榮譽會員</option>
                <option value="贊助會員">贊助會員</option>
              </select>
            </div>
            <div class="form-group">
              <label for="memberJoinDate">加入日期 *</label>
              <input type="date" id="memberJoinDate" name="joinDate" required>
            </div>
          </div>

          <div class="form-group">
            <label for="memberNotes">備註</label>
            <textarea id="memberNotes" name="notes" rows="3"></textarea>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn btn-primary">新增會員</button>
            <button type="reset" class="btn btn-secondary">清除表單</button>
          </div>
        </form>
      </div>

      <!-- 會員搜尋 -->
      <div class="search-filters">
        <div class="search-row">
          <div class="search-group">
            <label for="memberSearch">搜尋</label>
            <input type="text" id="memberSearch" placeholder="搜尋姓名、電話...">
          </div>
          <div class="search-group">
            <label for="memberTypeFilter">會員類型</label>
            <select id="memberTypeFilter">
              <option value="">全部</option>
              <option value="一般會員">一般會員</option>
              <option value="永久會員">永久會員</option>
              <option value="榮譽會員">榮譽會員</option>
              <option value="贊助會員">贊助會員</option>
            </select>
          </div>
          <div class="search-group">
            <label>&nbsp;</label>
            <button type="button" class="btn btn-primary" onclick="searchMembers()">搜尋</button>
          </div>
        </div>
      </div>

      <!-- 會員列表 -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">會員列表</h3>
        </div>
        <div class="table-container">
          <table id="membersTable">
            <thead>
              <tr>
                <th>會員編號</th>
                <th>姓名</th>
                <th>電話</th>
                <th>會員類型</th>
                <th>加入日期</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" class="empty-state">
                  <h3>載入中...</h3>
                  <p>正在取得會員記錄</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div id="membersPagination" class="pagination"></div>
      </div>
    </div>

    <!-- 報表分析 -->
    <div id="reports" class="tab-content">
      <div class="card-header">
        <h2 class="card-title">報表分析</h2>
        <p class="card-subtitle">產生各種財務和統計報表</p>
      </div>

      <!-- 報表選項 -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">報表產生</h3>
        </div>
        <form id="reportForm">
          <div class="form-row">
            <div class="form-group">
              <label for="reportType">報表類型 *</label>
              <select id="reportType" name="type" required>
                <option value="">請選擇</option>
                <option value="monthly">月度財務報表</option>
                <option value="yearly">年度財務報表</option>
                <option value="category">類別統計報表</option>
                <option value="member">會員統計報表</option>
                <option value="donation">捐款統計報表</option>
              </select>
            </div>
            <div class="form-group">
              <label for="reportYear">年份 *</label>
              <select id="reportYear" name="year" required>
                <option value="">請選擇</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="reportMonth">月份</label>
              <select id="reportMonth" name="month">
                <option value="">全年</option>
                <option value="1">1月</option>
                <option value="2">2月</option>
                <option value="3">3月</option>
                <option value="4">4月</option>
                <option value="5">5月</option>
                <option value="6">6月</option>
                <option value="7">7月</option>
                <option value="8">8月</option>
                <option value="9">9月</option>
                <option value="10">10月</option>
                <option value="11">11月</option>
                <option value="12">12月</option>
              </select>
            </div>
            <div class="form-group">
              <label for="reportFormat">匯出格式</label>
              <select id="reportFormat" name="format">
                <option value="excel">Excel (.xlsx)</option>
                <option value="pdf">PDF</option>
              </select>
            </div>
          </div>

          <div class="btn-group">
            <button type="button" class="btn btn-primary" onclick="generateReport()">產生報表</button>
            <button type="button" class="btn btn-success" onclick="exportReport()">匯出報表</button>
          </div>
        </form>
      </div>

      <!-- 報表預覽 -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">報表預覽</h3>
        </div>
        <div id="reportPreview">
          <div class="empty-state">
            <h3>請選擇報表類型</h3>
            <p>選擇報表類型和時間範圍後，點擊「產生報表」查看預覽</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 系統設定 -->
    <div id="settings" class="tab-content">
      <div class="card-header">
        <h2 class="card-title">系統設定</h2>
        <p class="card-subtitle">管理系統配置和組織資訊</p>
      </div>

      <!-- 組織資訊設定 -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">組織資訊</h3>
        </div>
        <form id="organizationForm">
          <div class="form-row">
            <div class="form-group">
              <label for="orgName">組織名稱 *</label>
              <input type="text" id="orgName" name="name" required>
            </div>
            <div class="form-group">
              <label for="orgTaxId">統一編號</label>
              <input type="text" id="orgTaxId" name="taxId">
            </div>
          </div>

          <div class="form-group">
            <label for="orgAddress">地址</label>
            <textarea id="orgAddress" name="address" rows="3"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="orgPhone">電話</label>
              <input type="tel" id="orgPhone" name="phone">
            </div>
            <div class="form-group">
              <label for="orgEmail">電子郵件</label>
              <input type="email" id="orgEmail" name="email">
            </div>
          </div>

          <div class="form-group">
            <label for="orgWebsite">網站</label>
            <input type="url" id="orgWebsite" name="website">
          </div>

          <div class="btn-group">
            <button type="submit" class="btn btn-primary">儲存設定</button>
          </div>
        </form>
      </div>

      <!-- 系統管理 -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">系統管理</h3>
        </div>
        <div class="btn-group">
          <button type="button" class="btn btn-info" onclick="performSystemCheck()">系統檢查</button>
          <button type="button" class="btn btn-warning" onclick="createBackup()">建立備份</button>
          <button type="button" class="btn btn-secondary" onclick="cleanupSystem()">清理系統</button>
        </div>

        <div id="systemStatus" class="card" style="margin-top: 20px; display: none;">
          <div class="card-header">
            <h4 class="card-title">系統狀態</h4>
          </div>
          <div id="systemStatusContent"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 應用程式頁腳 -->
  <footer class="app-footer">
    <div class="container">
      <p>&copy; 2025 台灣帕金森病友權益促進會. 版權所有 | 
         <a href="#" onclick="showModal('關於系統', getAboutContent())">關於系統</a> | 
         <a href="#" onclick="showModal('使用說明', getHelpContent())">使用說明</a> | 
         <a href="#" onclick="showModal('聯絡我們', getContactContent())">聯絡我們</a>
      </p>
      <p>系統版本：v5.1 | 最後更新：2025年7月</p>
    </div>
  </footer>

  <!-- 模態框 -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">標題</h3>
        <button class="modal-close" onclick="closeModal()" aria-label="關閉">&times;</button>
      </div>
      <div id="modalBody">
        內容
      </div>
      <div class="btn-group" style="margin-top: 20px;">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">關閉</button>
      </div>
    </div>
  </div>

  <script>
    // 全域變數
    let currentTab = 'dashboard';
    let currentPage = 1;
    let itemsPerPage = 10;

    // 系統配置
    const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbxwy35kgzSeiiPLebpQqiaLkOeaEenphL7jmTNYJZrhT5LWl_47uwl432uBjPWmZ9yH/exec';
    const SYSTEM_VERSION = 'v5.1';

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      updateCurrentTime();
      setInterval(updateCurrentTime, 1000);
      
      // 監聽網路狀態
      updateNetworkStatus();
      window.addEventListener('online', updateNetworkStatus);
      window.addEventListener('offline', updateNetworkStatus);
    });

    function initializeApp() {
      console.log('初始化應用程式...');
      
      // 顯示載入動畫
      showLoading();
      
      // 設定預設日期
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('transactionDate').value = today;
      document.getElementById('receiptDate').value = today;
      document.getElementById('voucherDate').value = today;
      document.getElementById('memberJoinDate').value = today;

      // 初始化年份選項
      initializeYearOptions();

      // 設定事件監聽器
      setupEventListeners();

      // 載入儀表板數據
      loadDashboard().finally(() => {
        // 隱藏載入動畫
        setTimeout(hideLoading, 500);
      });
      
      // 自動載入組織資訊
      loadOrganizationInfo();
    }

    function setupEventListeners() {
      // 標籤頁切換
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          switchTab(this.dataset.tab);
        });
      });

      // 表單提交
      document.getElementById('transactionForm').addEventListener('submit', handleTransactionSubmit);
      document.getElementById('receiptForm').addEventListener('submit', handleReceiptSubmit);
      document.getElementById('voucherForm').addEventListener('submit', handleVoucherSubmit);
      document.getElementById('memberForm').addEventListener('submit', handleMemberSubmit);
      document.getElementById('organizationForm').addEventListener('submit', handleOrganizationSubmit);

      // 交易類型變更時更新類別選項
      document.getElementById('transactionType').addEventListener('change', updateCategoryOptions);
      
      // 自動儲存草稿
      setupFormAutosave();
      
      // 模態框關閉
      document.getElementById('modal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeModal();
        }
      });
      
      // 鍵盤快捷鍵
      document.addEventListener('keydown', function(e) {
        // ESC 關閉模態框
        if (e.key === 'Escape') {
          closeModal();
        }
      });
    }

    function updateCurrentTime() {
      const now = new Date();
      const timeString = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('currentTime').textContent = timeString;
    }

    function initializeYearOptions() {
      const currentYear = new Date().getFullYear();
      const yearSelect = document.getElementById('reportYear');
      
      // 清空現有選項
      yearSelect.innerHTML = '<option value="">請選擇</option>';
      
      // 新增年份選項 (當年 + 前5年)
      for (let year = currentYear; year >= currentYear - 5; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + '年';
        yearSelect.appendChild(option);
      }
    }

    // 網路狀態監控
    function updateNetworkStatus() {
      const statusEl = document.getElementById('networkStatus');
      const textEl = document.getElementById('networkStatusText');
      
      if (navigator.onLine) {
        statusEl.className = 'network-status online';
        textEl.textContent = '線上';
        setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
      } else {
        statusEl.className = 'network-status offline';
        textEl.textContent = '離線';
        statusEl.style.display = 'block';
      }
    }

    // 標籤頁切換
    function switchTab(tabName) {
      // 隱藏所有標籤頁內容
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // 移除所有按鈕的active類別
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // 顯示選中的標籤頁
      document.getElementById(tabName).classList.add('active');
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

      currentTab = tabName;
      currentPage = 1; // 重置頁碼

      // 載入對應數據
      switch (tabName) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'transactions':
          loadTransactions();
          break;
        case 'receipts':
          loadReceipts();
          break;
        case 'vouchers':
          loadVouchers();
          break;
        case 'members':
          loadMembers();
          break;
        case 'reports':
          // 不需要立即載入數據
          break;
        case 'settings':
          loadOrganizationInfo();
          break;
      }
    }

    // 更新交易類別選項
    function updateCategoryOptions() {
      const typeSelect = document.getElementById('transactionType');
      const categorySelect = document.getElementById('transactionCategory');
      const selectedType = typeSelect.value;
      
      // 清空現有選項
      categorySelect.innerHTML = '<option value="">請選擇</option>';
      
      // 根據類型新增對應選項
      if (selectedType === '收入') {
        const incomeCategories = ['捐款', '會費', '活動收入', '補助款', '其他收入'];
        incomeCategories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        });
      } else if (selectedType === '支出') {
        const expenseCategories = ['辦公費用', '活動支出', '交通費', '設備採購', '人事費用', '其他支出'];
        expenseCategories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        });
      }
    }

    // API 呼叫函數
    async function callAPI(action, data = {}) {
      showLoading();
      
      try {
        const formData = new FormData();
        formData.append('action', action);
        formData.append('data', JSON.stringify(data));

        const response = await fetch(API_BASE_URL, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`HTTP錯誤：${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
          return result;
        } else {
          throw new Error(result.error || '操作失敗');
        }
      } catch (error) {
        console.error('API呼叫失敗:', error);
        showAlert('error', '操作失敗：' + error.message);
        return { success: false, error: error.message };
      } finally {
        hideLoading();
      }
    }

    // 載入儀表板
    async function loadDashboard() {
      try {
        const result = await callAPI('getDashboardStats');
        if (result.success) {
          updateDashboardStats(result.data);
          
          // 載入最近活動
          const activities = await callAPI('getRecentActivities');
          if (activities.success) {
            displayRecentActivities(activities.data);
          }
        }
      } catch (error) {
        console.error('載入儀表板失敗:', error);
        showAlert('error', '載入儀表板失敗');
      }
    }

    function updateDashboardStats(data) {
      document.getElementById('totalIncome').textContent = '$' + formatNumber(data.totalIncome || 0);
      document.getElementById('totalExpense').textContent = '$' + formatNumber(data.totalExpense || 0);
      document.getElementById('receiptCount').textContent = data.receiptCount || 0;
      document.getElementById('memberCount').textContent = data.memberCount || 0;

      // 更新變化百分比
      const incomeChange = document.getElementById('incomeChange');
      incomeChange.textContent = (data.incomeChange > 0 ? '+' : '') + data.incomeChange + '%';
      incomeChange.className = data.incomeChange >= 0 ? 'stat-change positive' : 'stat-change negative';
      
      const expenseChange = document.getElementById('expenseChange');
      expenseChange.textContent = (data.expenseChange > 0 ? '+' : '') + data.expenseChange + '%';
      expenseChange.className = data.expenseChange <= 0 ? 'stat-change positive' : 'stat-change negative';
      
      const receiptChange = document.getElementById('receiptChange');
      receiptChange.textContent = (data.receiptChange > 0 ? '+' : '') + data.receiptChange;
      receiptChange.className = data.receiptChange >= 0 ? 'stat-change positive' : 'stat-change negative';
      
      const memberChange = document.getElementById('memberChange');
      memberChange.textContent = (data.memberChange > 0 ? '+' : '') + data.memberChange;
      memberChange.className = data.memberChange >= 0 ? 'stat-change positive' : 'stat-change negative';
    }

    function displayRecentActivities(activities) {
      const container = document.getElementById('recentActivities');
      
      if (!activities || activities.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>尚無活動記錄</h3>
            <p>系統將自動記錄所有操作活動</p>
          </div>
        `;
        return;
      }
      
      let html = `<div class="table-container">
        <table>
          <thead>
            <tr>
              <th>時間</th>
              <th>類型</th>
              <th>活動內容</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      activities.forEach(activity => {
        const activityDate = new Date(activity.time);
        
        html += `
          <tr>
            <td>${formatDateTime(activityDate)}</td>
            <td>${getActivityTypeLabel(activity.type)}</td>
            <td>${activity.message}</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      </div>`;
      
      container.innerHTML = html;
    }

    function getActivityTypeLabel(type) {
      const types = {
        'TRANSACTION': '<span class="badge badge-primary">交易</span>',
        'RECEIPT': '<span class="badge badge-success">收據</span>',
        'VOUCHER': '<span class="badge badge-warning">憑證</span>',
        'MEMBER': '<span class="badge badge-info">會員</span>',
        'SYSTEM': '<span class="badge badge-secondary">系統</span>',
        'ERROR': '<span class="badge badge-danger">錯誤</span>',
        'BACKUP': '<span class="badge badge-secondary">備份</span>',
        'LOGIN': '<span class="badge badge-info">登入</span>'
      };
      
      return types[type] || `<span class="badge badge-secondary">${type}</span>`;
    }

    // 表單處理函數
    async function handleTransactionSubmit(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // 表單驗證
        if (!data.date || !data.type || !data.category || !data.name || !data.amount) {
          showAlert('warning', '請填寫所有必填欄位');
          return;
        }
        
        // 金額必須大於0
        if (parseFloat(data.amount) <= 0) {
          showAlert('warning', '金額必須大於0');
          return;
        }
        
        const result = await callAPI('saveTransaction', data);
        
        if (result.success) {
          showAlert('success', '交易記錄已成功新增');
          e.target.reset();
          document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
          clearFormDraft('transactionForm');
          loadTransactions();
        }
      } catch (error) {
        console.error('處理交易表單失敗:', error);
        showAlert('error', '處理交易表單失敗');
      }
    }

    async function handleReceiptSubmit(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // 表單驗證
        if (!data.date || !data.payer || !data.category || !data.amount) {
          showAlert('warning', '請填寫所有必填欄位');
          return;
        }
        
        // 金額必須大於0
        if (parseFloat(data.amount) <= 0) {
          showAlert('warning', '金額必須大於0');
          return;
        }
        
        const result = await callAPI('issueReceipt', data);
        
        if (result.success) {
          showAlert('success', '收據已成功開立，編號：' + result.receiptNumber);
          e.target.reset();
          document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
          clearFormDraft('receiptForm');
          loadReceipts();
        }
      } catch (error) {
        console.error('處理收據表單失敗:', error);
        showAlert('error', '處理收據表單失敗');
      }
    }

    async function handleVoucherSubmit(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // 表單驗證
        if (!data.date || !data.applicant || !data.category || !data.amount || !data.purpose) {
          showAlert('warning', '請填寫所有必填欄位');
          return;
        }
        
        // 金額必須大於0
        if (parseFloat(data.amount) <= 0) {
          showAlert('warning', '金額必須大於0');
          return;
        }
        
        const result = await callAPI('submitVoucher', data);
        
        if (result.success) {
          showAlert('success', '憑證申請已提交，編號：' + result.voucherNumber);
          e.target.reset();
          document.getElementById('voucherDate').value = new Date().toISOString().split('T')[0];
          clearFormDraft('voucherForm');
          loadVouchers();
        }
      } catch (error) {
        console.error('處理憑證表單失敗:', error);
        showAlert('error', '處理憑證表單失敗');
      }
    }

    async function handleMemberSubmit(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // 表單驗證
        if (!data.name || !data.phone || !data.type || !data.joinDate) {
          showAlert('warning', '請填寫所有必填欄位');
          return;
        }
        
        const result = await callAPI('saveMember', data);
        
        if (result.success) {
          showAlert('success', '會員已成功' + (data.id ? '更新' : '新增') + (result.memberNumber ? '，編號：' + result.memberNumber : ''));
          e.target.reset();
          document.getElementById('memberJoinDate').value = new Date().toISOString().split('T')[0];
          clearFormDraft('memberForm');
          loadMembers();
        }
      } catch (error) {
        console.error('處理會員表單失敗:', error);
        showAlert('error', '處理會員表單失敗');
      }
    }

    async function handleOrganizationSubmit(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // 表單驗證
        if (!data.name) {
          showAlert('warning', '請填寫組織名稱');
          return;
        }
        
        const result = await callAPI('saveOrganizationInfo', data);
        
        if (result.success) {
          showAlert('success', '組織資訊已成功儲存');
        }
      } catch (error) {
        console.error('儲存組織資訊失敗:', error);
        showAlert('error', '儲存組織資訊失敗');
      }
    }

    // 載入數據函數
    async function loadTransactions(filters = {}) {
      try {
        const params = {
          page: currentPage,
          limit: itemsPerPage,
          ...filters
        };
        
        // 更新表格為載入狀態
        document.querySelector('#transactionsTable tbody').innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              <h3>載入中...</h3>
              <p>正在取得交易記錄</p>
            </td>
          </tr>
        `;
        
        const result = await callAPI('getTransactions', params);
        
        if (result.success) {
          displayTransactions(result.data.items);
          
          // 更新分頁
          if (result.data.pagination) {
            renderPagination('transactionsPagination', result.data.pagination, loadTransactions);
          }
        }
      } catch (error) {
        console.error('載入交易記錄失敗:', error);
        showAlert('error', '載入交易記錄失敗');
      }
    }

    async function loadReceipts(filters = {}) {
      try {
        const params = {
          page: currentPage,
          limit: itemsPerPage,
          ...filters
        };
        
        // 更新表格為載入狀態
        document.querySelector('#receiptsTable tbody').innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <h3>載入中...</h3>
              <p>正在取得收據記錄</p>
            </td>
          </tr>
        `;
        
        const result = await callAPI('getReceipts', params);
        
        if (result.success) {
          displayReceipts(result.data.items);
          
          // 更新分頁
          if (result.data.pagination) {
            renderPagination('receiptsPagination', result.data.pagination, loadReceipts);
          }
        }
      } catch (error) {
        console.error('載入收據記錄失敗:', error);
        showAlert('error', '載入收據記錄失敗');
      }
    }

    async function loadVouchers(filters = {}) {
      try {
        const params = {
          page: currentPage,
          limit: itemsPerPage,
          ...filters
        };
        
        // 更新表格為載入狀態
        document.querySelector('#vouchersTable tbody').innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <h3>載入中...</h3>
              <p>正在取得憑證記錄</p>
            </td>
          </tr>
        `;
        
        const result = await callAPI('getVouchers', params);
        
        if (result.success) {
          displayVouchers(result.data.items);
          
          // 更新分頁
          if (result.data.pagination) {
            renderPagination('vouchersPagination', result.data.pagination, loadVouchers);
          }
        }
      } catch (error) {
        console.error('載入憑證記錄失敗:', error);
        showAlert('error', '載入憑證記錄失敗');
      }
    }

    async function loadMembers(filters = {}) {
      try {
        const params = {
          page: currentPage,
          limit: itemsPerPage,
          ...filters
        };
        
        // 更新表格為載入狀態
        document.querySelector('#membersTable tbody').innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <h3>載入中...</h3>
              <p>正在取得會員記錄</p>
            </td>
          </tr>
        `;
        
        const result = await callAPI('getMembers', params);
        
        if (result.success) {
          displayMembers(result.data.items);
          
          // 更新分頁
          if (result.data.pagination) {
            renderPagination('membersPagination', result.data.pagination, loadMembers);
          }
        }
      } catch (error) {
        console.error('載入會員記錄失敗:', error);
        showAlert('error', '載入會員記錄失敗');
      }
    }

    async function loadOrganizationInfo() {
      try {
        const result = await callAPI('getOrganizationInfo');
        
        if (result.success && result.data) {
          document.getElementById('orgName').value = result.data.name || '';
          document.getElementById('orgTaxId').value = result.data.taxId || '';
          document.getElementById('orgAddress').value = result.data.address || '';
          document.getElementById('orgPhone').value = result.data.phone || '';
          document.getElementById('orgEmail').value = result.data.email || '';
          document.getElementById('orgWebsite').value = result.data.website || '';
        }
      } catch (error) {
        console.error('載入組織資訊失敗:', error);
      }
    }

    // 顯示數據函數
    function displayTransactions(transactions) {
      const tbody = document.querySelector('#transactionsTable tbody');
      
      if (!transactions || transactions.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              <h3>尚無交易記錄</h3>
              <p>請新增第一筆交易記錄</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = transactions.map(transaction => `
        <tr>
          <td>${formatDate(transaction.date)}</td>
          <td><span class="badge badge-${transaction.type === '收入' ? 'success' : 'danger'}">${transaction.type}</span></td>
          <td>${transaction.category}</td>
          <td>${transaction.name}</td>
          <td>$${formatNumber(transaction.amount)}</td>
          <td>${transaction.account || '-'}</td>
          <td><span class="badge badge-${getStatusBadgeClass(transaction.status)}">${transaction.status || '正常'}</span></td>
          <td class="table-actions">
            <button class="btn btn-sm btn-info" onclick="viewTransaction('${transaction.id}')">查看</button>
            <button class="btn btn-sm btn-warning" onclick="editTransaction('${transaction.id}')">編輯</button>
          </td>
        </tr>
      `).join('');
    }

    function displayReceipts(receipts) {
      const tbody = document.querySelector('#receiptsTable tbody');
      
      if (!receipts || receipts.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <h3>尚無收據記錄</h3>
              <p>請開立第一張收據</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = receipts.map(receipt => `
        <tr>
          <td>${receipt.receiptNumber}</td>
          <td>${formatDate(receipt.date)}</td>
          <td>${receipt.payer}</td>
          <td>${receipt.category}</td>
          <td>$${formatNumber(receipt.amount)}</td>
          <td><span class="badge badge-${getStatusBadgeClass(receipt.status)}">${receipt.status || '已開立'}</span></td>
          <td class="table-actions">
            <button class="btn btn-sm btn-info" onclick="viewReceipt('${receipt.receiptNumber}')">查看</button>
            <button class="btn btn-sm btn-primary" onclick="printReceipt('${receipt.receiptNumber}')">列印</button>
            ${receipt.email ? `<button class="btn btn-sm btn-secondary" onclick="emailReceipt('${receipt.receiptNumber}', '${receipt.email}')">寄送</button>` : ''}
          </td>
        </tr>
      `).join('');
    }

    function displayVouchers(vouchers) {
      const tbody = document.querySelector('#vouchersTable tbody');
      
      if (!vouchers || vouchers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <h3>尚無憑證記錄</h3>
              <p>請提交第一筆憑證申請</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = vouchers.map(voucher => `
        <tr>
          <td>${voucher.voucherNumber}</td>
          <td>${formatDate(voucher.date)}</td>
          <td>${voucher.applicant}</td>
          <td>${voucher.category}</td>
          <td>$${formatNumber(voucher.amount)}</td>
          <td><span class="badge badge-${getStatusBadgeClass(voucher.status)}">${voucher.status || '待審核'}</span></td>
          <td class="table-actions">
            <button class="btn btn-sm btn-info" onclick="viewVoucher('${voucher.voucherNumber}')">查看</button>
            ${voucher.status === '待審核' ? `
              <button class="btn btn-sm btn-success" onclick="approveVoucher('${voucher.voucherNumber}')">核准</button>
              <button class="btn btn-sm btn-danger" onclick="rejectVoucher('${voucher.voucherNumber}')">駁回</button>
            ` : ''}
          </td>
        </tr>
      `).join('');
    }

    function displayMembers(members) {
      const tbody = document.querySelector('#membersTable tbody');
      
      if (!members || members.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <h3>尚無會員記錄</h3>
              <p>請新增第一位會員</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = members.map(member => `
        <tr>
          <td>${member.memberNumber}</td>
          <td>${member.name}</td>
          <td>${member.phone}</td>
          <td>${member.type}</td>
          <td>${formatDate(member.joinDate)}</td>
          <td><span class="badge badge-${getStatusBadgeClass(member.status)}">${member.status || '正常'}</span></td>
          <td class="table-actions">
            <button class="btn btn-sm btn-info" onclick="viewMember('${member.memberNumber}')">查看</button>
            <button class="btn btn-sm btn-warning" onclick="editMember('${member.memberNumber}')">編輯</button>
          </td>
        </tr>
      `).join('');
    }

    function renderPagination(containerId, pagination, loadFunction) {
      const container = document.getElementById(containerId);
      
      if (!pagination || pagination.totalPages <= 1) {
        container.innerHTML = '';
        return;
      }
      
      let html = '';
      
      // 上一頁按鈕
      html += `<button ${pagination.currentPage <= 1 ? 'disabled' : ''} onclick="changePage(${pagination.currentPage - 1}, ${loadFunction.name})">上一頁</button>`;
      
      // 頁碼按鈕
      const startPage = Math.max(1, pagination.currentPage - 2);
      const endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);
      
      if (startPage > 1) {
        html += `<button onclick="changePage(1, ${loadFunction.name})">1</button>`;
        if (startPage > 2) {
          html += `<span>...</span>`;
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="${i === pagination.currentPage ? 'active' : ''}" onclick="changePage(${i}, ${loadFunction.name})">${i}</button>`;
      }
      
      if (endPage < pagination.totalPages) {
        if (endPage < pagination.totalPages - 1) {
          html += `<span>...</span>`;
        }
        html += `<button onclick="changePage(${pagination.totalPages}, ${loadFunction.name})">${pagination.totalPages}</button>`;
      }
      
      // 下一頁按鈕
      html += `<button ${pagination.currentPage >= pagination.totalPages ? 'disabled' : ''} onclick="changePage(${pagination.currentPage + 1}, ${loadFunction.name})">下一頁</button>`;
      
      container.innerHTML = html;
    }

    function changePage(page, loadFunction) {
      currentPage = page;
      loadFunction();
    }

    // 搜尋函數
    function searchTransactions() {
      const filters = {
        search: document.getElementById('transactionSearch').value,
        type: document.getElementById('transactionTypeFilter').value,
        dateFrom: document.getElementById('transactionDateFrom').value,
        dateTo: document.getElementById('transactionDateTo').value
      };
      
      currentPage = 1; // 重置頁碼
      loadTransactions(filters);
    }

    function searchReceipts() {
      const filters = {
        search: document.getElementById('receiptSearch').value,
        status: document.getElementById('receiptStatusFilter').value
      };
      
      currentPage = 1; // 重置頁碼
      loadReceipts(filters);
    }

    function searchMembers() {
      const filters = {
        search: document.getElementById('memberSearch').value,
        type: document.getElementById('memberTypeFilter').value
      };
      
      currentPage = 1; // 重置頁碼
      loadMembers(filters);
    }

    // 詳細操作函數
    async function viewTransaction(id) {
      try {
        const result = await callAPI('getTransactionDetails', { id });
        
        if (result.success && result.data) {
          const transaction = result.data;
          
          let content = `
            <div class="detail-content">
              <div class="detail-row">
                <div class="detail-label">交易日期：</div>
                <div class="detail-value">${formatDate(transaction.date)}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">收支類型：</div>
                <div class="detail-value">${transaction.type}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">類別：</div>
                <div class="detail-value">${transaction.category}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">交易對象：</div>
                <div class="detail-value">${transaction.name}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">金額：</div>
                <div class="detail-value">$${formatNumber(transaction.amount)}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">帳戶：</div>
                <div class="detail-value">${transaction.account || '-'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">說明：</div>
                <div class="detail-value">${transaction.description || '-'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">狀態：</div>
                <div class="detail-value">${transaction.status || '正常'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">建立時間：</div>
                <div class="detail-value">${formatDateTime(transaction.createdAt)}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">最後更新：</div>
                <div class="detail-value">${formatDateTime(transaction.updatedAt)}</div>
              </div>
            </div>
            <div class="btn-group mt-3">
              <button type="button" class="btn btn-warning" onclick="editTransaction('${transaction.id}')">編輯</button>
              <button type="button" class="btn btn-danger" onclick="deleteTransaction('${transaction.id}')">刪除</button>
            </div>
          `;
          
          showModal('交易記錄詳情', content);
        }
      } catch (error) {
        console.error('載入交易詳情失敗:', error);
        showAlert('error', '載入交易詳情失敗');
      }
    }

    async function viewReceipt(receiptNumber) {
      try {
        const result = await callAPI('getReceiptDetails', { receiptNumber });
        
        if (result.success && result.data) {
          const receipt = result.data;
          
          let content = `
            <div class="detail-content">
              <div class="detail-row">
                <div class="detail-label">收據編號：</div>
                <div class="detail-value">${receipt.receiptNumber}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">收據日期：</div>
                <div class="detail-value">${formatDate(receipt.date)}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">付款人：</div>
                <div class="detail-value">${receipt.payer}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">身份類別：</div>
                <div class="detail-value">${receipt.identity || '-'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">聯絡電話：</div>
                <div class="detail-value">${receipt.phone || '-'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">電子郵件：</div>
                <div class="detail-value">${receipt.email || '-'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">收據類別：</div>
                <div class="detail-value">${receipt.category}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">金額：</div>
                <div class="detail-value">$${formatNumber(receipt.amount)}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">用途說明：</div>
                <div class="detail-value">${receipt.purpose || '-'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">狀態：</div>
                <div class="detail-value">${receipt.status || '已開立'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">建立時間：</div>
                <div class="detail-value">${formatDateTime(receipt.createdAt)}</div>
              </div>
            </div>
            <div class="btn-group mt-3">
              <button type="button" class="btn btn-primary" onclick="printReceipt('${receipt.receiptNumber}')">列印收據</button>
              ${receipt.email ? `<button type="button" class="btn btn-secondary" onclick="emailReceipt('${receipt.receiptNumber}', '${receipt.email}')">寄送收據</button>` : ''}
              ${receipt.status !== '已作廢' ? `<button type="button" class="btn btn-danger" onclick="voidReceipt('${receipt.receiptNumber}')">作廢收據</button>` : ''}
            </div>
          `;
          
          showModal('收據詳情', content);
        }
      } catch (error) {
        console.error('載入收據詳情失敗:', error);
        showAlert('error', '載入收據詳情失敗');
      }
    }

    async function viewVoucher(voucherNumber) {
      try {
        const result = await callAPI('getVoucherDetails', { voucherNumber });
        
        if (result.success && result.data) {
          const voucher = result.data;
          
          let content = `
            <div class="detail-content">
              <div class="detail-row">
                <div class="detail-label">憑證編號：</div>
                <div class="detail-value">${voucher.voucherNumber}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">申請日期：</div>
                <div class="detail-value">${formatDate(voucher.date)}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">申請人：</div>
                <div class="detail-value">${voucher.applicant}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">支出類別：</div>
                <div class="detail-value">${voucher.category}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">申請金額：</div>
                <div class="detail-value">$${formatNumber(voucher.amount)}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">用途說明：</div>
                <div class="detail-value">${voucher.purpose}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">附件數量：</div>
                <div class="detail-value">${voucher.attachmentCount || '0'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">狀態：</div>
                <div class="detail-value">${voucher.status || '待審核'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">建立時間：</div>
                <div class="detail-value">${formatDateTime(voucher.createdAt)}</div>
              </div>
              ${voucher.reviewedBy ? `
                <div class="detail-row">
                  <div class="detail-label">審核人：</div>
                  <div class="detail-value">${voucher.reviewedBy}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">審核時間：</div>
                  <div class="detail-value">${formatDateTime(voucher.reviewedAt)}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">審核備註：</div>
                  <div class="detail-value">${voucher.reviewNote || '-'}</div>
                </div>
              ` : ''}
            </div>
            <div class="btn-group mt-3">
              <button type="button" class="btn btn-primary" onclick="printVoucher('${voucher.voucherNumber}')">列印憑證</button>
              ${voucher.status === '待審核' ? `
                <button type="button" class="btn btn-success" onclick="approveVoucher('${voucher.voucherNumber}')">核准</button>
                <button type="button" class="btn btn-danger" onclick="rejectVoucher('${voucher.voucherNumber}')">駁回</button>
              ` : ''}
            </div>
          `;
          
          showModal('憑證詳情', content);
        }
      } catch (error) {
        console.error('載入憑證詳情失敗:', error);
        showAlert('error', '載入憑證詳情失敗');
      }
    }

    async function viewMember(memberNumber) {
      try {
        const result = await callAPI('getMemberDetails', { memberNumber });
        
        if (result.success && result.data) {
          const member = result.data;
          
          let content = `
            <div class="detail-content">
              <div class="detail-row">
                <div class="detail-label">會員編號：</div>
                <div class="detail-value">${member.memberNumber}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">姓名：</div>
                <div class="detail-value">${member.name}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">性別：</div>
                <div class="detail-value">${member.gender || '-'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">出生日期：</div>
                <div class="detail-value">${member.birthDate ? formatDate(member.birthDate) : '-'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">身份證字號：</div>
                <div class="detail-value">${member.idNumber || '-'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">聯絡電話：</div>
                <div class="detail-value">${member.phone}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">電子郵件：</div>
                <div class="detail-value">${member.email || '-'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">聯絡地址：</div>
                <div class="detail-value">${member.address || '-'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">會員類型：</div>
                <div class="detail-value">${member.type}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">加入日期：</div>
                <div class="detail-value">${formatDate(member.joinDate)}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">狀態：</div>
                <div class="detail-value">${member.status || '正常'}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">備註：</div>
                <div class="detail-value">${member.notes || '-'}</div>
              </div>
            </div>
            <div class="btn-group mt-3">
              <button type="button" class="btn btn-warning" onclick="editMember('${member.memberNumber}')">編輯</button>
              ${member.status === '正常' ? `
                <button type="button" class="btn btn-danger" onclick="deactivateMember('${member.memberNumber}')">停用</button>
              ` : `
                <button type="button" class="btn btn-success" onclick="activateMember('${member.memberNumber}')">啟用</button>
              `}
            </div>
          `;
          
          showModal('會員詳情', content);
        }
      } catch (error) {
        console.error('載入會員詳情失敗:', error);
        showAlert('error', '載入會員詳情失敗');
      }
    }

    async function editTransaction(id) {
      try {
        const result = await callAPI('getTransactionDetails', { id });
        
        if (result.success && result.data) {
          const transaction = result.data;
          
          document.getElementById('transactionDate').value = transaction.date;
          document.getElementById('transactionType').value = transaction.type;
          updateCategoryOptions(); // 更新類別選項
          setTimeout(() => {
            document.getElementById('transactionCategory').value = transaction.category;
          }, 100);
          document.getElementById('transactionAmount').value = transaction.amount;
          document.getElementById('transactionName').value = transaction.name;
          document.getElementById('transactionAccount').value = transaction.account || '';
          document.getElementById('transactionDescription').value = transaction.description || '';
          
          // 切換到交易標籤頁
          switchTab('transactions');
          
          // 滾動到表單
          document.getElementById('transactionForm').scrollIntoView({ behavior: 'smooth' });
          
          // 更新表單標題
          document.querySelector('#transactions .card-header .card-title').textContent = '編輯交易記錄';
          
          // 新增隱藏欄位儲存ID
          let idField = document.getElementById('transactionId');
          if (!idField) {
            idField = document.createElement('input');
            idField.type = 'hidden';
            idField.id = 'transactionId';
            idField.name = 'id';
            document.getElementById('transactionForm').appendChild(idField);
          }
          idField.value = id;
          
          showAlert('info', '正在編輯交易記錄，請修改後儲存');
        }
      } catch (error) {
        console.error('載入交易詳情失敗:', error);
        showAlert('error', '載入交易詳情失敗');
      }
    }

    async function editMember(memberNumber) {
      try {
        const result = await callAPI('getMemberDetails', { memberNumber });
        
        if (result.success && result.data) {
          const member = result.data;
          
          document.getElementById('memberName').value = member.name;
          document.getElementById('memberGender').value = member.gender || '';
          document.getElementById('memberBirthDate').value = member.birthDate || '';
          document.getElementById('memberIdNumber').value = member.idNumber || '';
          document.getElementById('memberPhone').value = member.phone;
          document.getElementById('memberEmail').value = member.email || '';
          document.getElementById('memberAddress').value = member.address || '';
          document.getElementById('memberType').value = member.type;
          document.getElementById('memberJoinDate').value = member.joinDate;
          document.getElementById('memberNotes').value = member.notes || '';
          
          // 切換到會員標籤頁
          switchTab('members');
          
          // 滾動到表單
          document.getElementById('memberForm').scrollIntoView({ behavior: 'smooth' });
          
          // 更新表單標題
          document.querySelector('#members .card-header .card-title').textContent = '編輯會員資料';
          
          // 新增隱藏欄位儲存會員編號
          let idField = document.getElementById('memberId');
          if (!idField) {
            idField = document.createElement('input');
            idField.type = 'hidden';
            idField.id = 'memberId';
            idField.name = 'id';
            document.getElementById('memberForm').appendChild(idField);
          }
          idField.value = memberNumber;
          
          showAlert('info', '正在編輯會員資料，請修改後儲存');
        }
      } catch (error) {
        console.error('載入會員詳情失敗:', error);
        showAlert('error', '載入會員詳情失敗');
      }
    }

    async function deleteTransaction(id) {
      if (!confirm('確定要刪除此交易記錄嗎？此操作無法復原。')) {
        return;
      }
      
      try {
        const result = await callAPI('deleteTransaction', { id });
        
        if (result.success) {
          showAlert('success', '交易記錄已成功刪除');
          closeModal();
          loadTransactions();
        }
      } catch (error) {
        console.error('刪除交易記錄失敗:', error);
        showAlert('error', '刪除交易記錄失敗');
      }
    }

    async function voidReceipt(receiptNumber) {
      if (!confirm('確定要作廢此收據嗎？此操作無法復原。')) {
        return;
      }
      
      try {
        const result = await callAPI('voidReceipt', { receiptNumber });
        
        if (result.success) {
          showAlert('success', '收據已成功作廢');
          closeModal();
          loadReceipts();
        }
      } catch (error) {
        console.error('作廢收據失敗:', error);
        showAlert('error', '作廢收據失敗');
      }
    }

    async function approveVoucher(voucherNumber) {
      const note = prompt('請輸入核准備註（可選）：');
      
      try {
        const result = await callAPI('approveVoucher', { 
          voucherNumber, 
          note 
        });
        
        if (result.success) {
          showAlert('success', '憑證已成功核准');
          closeModal();
          loadVouchers();
        }
      } catch (error) {
        console.error('核准憑證失敗:', error);
        showAlert('error', '核准憑證失敗');
      }
    }

    async function rejectVoucher(voucherNumber) {
      const note = prompt('請輸入駁回原因（必填）：');
      
      if (!note) {
        showAlert('warning', '請輸入駁回原因');
        return;
      }
      
      try {
        const result = await callAPI('rejectVoucher', { 
          voucherNumber, 
          note 
        });
        
        if (result.success) {
          showAlert('success', '憑證已駁回');
          closeModal();
          loadVouchers();
        }
      } catch (error) {
        console.error('駁回憑證失敗:', error);
        showAlert('error', '駁回憑證失敗');
      }
    }

    async function activateMember(memberNumber) {
      try {
        const result = await callAPI('updateMemberStatus', { 
          memberNumber, 
          status: '正常' 
        });
        
        if (result.success) {
          showAlert('success', '會員已成功啟用');
          closeModal();
          loadMembers();
        }
      } catch (error) {
        console.error('啟用會員失敗:', error);
        showAlert('error', '啟用會員失敗');
      }
    }

    async function deactivateMember(memberNumber) {
      const reason = prompt('請輸入停用原因（可選）：');
      
      try {
        const result = await callAPI('updateMemberStatus', { 
          memberNumber, 
          status: '停用', 
          reason 
        });
        
        if (result.success) {
          showAlert('success', '會員已成功停用');
          closeModal();
          loadMembers();
        }
      } catch (error) {
        console.error('停用會員失敗:', error);
        showAlert('error', '停用會員失敗');
      }
    }

    async function printReceipt(receiptNumber) {
      try {
        const result = await callAPI('generateReceiptPdf', { receiptNumber });
        
        if (result.success && result.pdfUrl) {
          window.open(result.pdfUrl, '_blank');
        } else {
          throw new Error('無法產生收據PDF');
        }
      } catch (error) {
        console.error('列印收據失敗:', error);
        showAlert('error', '列印收據失敗');
      }
    }

    async function emailReceipt(receiptNumber, email) {
      try {
        const result = await callAPI('emailReceipt', { 
          receiptNumber, 
          email 
        });
        
        if (result.success) {
          showAlert('success', '收據已成功寄送至 ' + email);
        }
      } catch (error) {
        console.error('寄送收據失敗:', error);
        showAlert('error', '寄送收據失敗');
      }
    }

    async function printVoucher(voucherNumber) {
      try {
        const result = await callAPI('generateVoucherPdf', { voucherNumber });
        
        if (result.success && result.pdfUrl) {
          window.open(result.pdfUrl, '_blank');
        } else {
          throw new Error('無法產生憑證PDF');
        }
      } catch (error) {
        console.error('列印憑證失敗:', error);
        showAlert('error', '列印憑證失敗');
      }
    }

    async function generateReport() {
      const type = document.getElementById('reportType').value;
      const year = document.getElementById('reportYear').value;
      const month = document.getElementById('reportMonth').value;
      
      if (!type || !year) {
        showAlert('warning', '請選擇報表類型和年份');
        return;
      }
      
      try {
        showLoading();
        
        const result = await callAPI('generateReport', { 
          type, 
          year, 
          month 
        });
        
        if (result.success && result.data) {
          displayReportPreview(result.data);
        }
      } catch (error) {
        console.error('產生報表失敗:', error);
        showAlert('error', '產生報表失敗');
      } finally {
        hideLoading();
      }
    }

    async function exportReport() {
      const type = document.getElementById('reportType').value;
      const year = document.getElementById('reportYear').value;
      const month = document.getElementById('reportMonth').value;
      const format = document.getElementById('reportFormat').value;
      
      if (!type || !year) {
        showAlert('warning', '請選擇報表類型和年份');
        return;
      }
      
      try {
        showLoading();
        
        const result = await callAPI('exportReport', { 
          type, 
          year, 
          month, 
          format 
        });
        
        if (result.success && result.fileUrl) {
          window.open(result.fileUrl, '_blank');
        } else {
          throw new Error('無法匯出報表');
        }
      } catch (error) {
        console.error('匯出報表失敗:', error);
        showAlert('error', '匯出報表失敗');
      } finally {
        hideLoading();
      }
    }

    function displayReportPreview(data) {
      const container = document.getElementById('reportPreview');
      let html = '';
      
      if (data.title) {
        html += `<h3 class="text-center mb-4">${data.title}</h3>`;
      }
      
      if (data.summary) {
        html += `
          <div class="report-summary">
            <h4>報表摘要</h4>
            <div class="stats-grid">
        `;
        
        for (const key in data.summary) {
          html += `
            <div class="stat-card">
              <div class="stat-number">${data.summary[key].value}</div>
              <div class="stat-label">${data.summary[key].label}</div>
            </div>
          `;
        }
        
        html += `
            </div>
          </div>
        `;
      }
      
      if (data.chart) {
        html += `
          <div class="report-chart">
            <img src="${data.chart}" alt="報表圖表" style="max-width: 100%; height: auto;">
          </div>
        `;
      }
      
      if (data.details && data.details.length > 0) {
        html += `
          <div class="report-details">
            <h4>詳細資料</h4>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
        `;
        
        // 表頭
        for (const key in data.details[0]) {
          html += `<th>${getColumnLabel(key)}</th>`;
        }
        
        html += `
                  </tr>
                </thead>
                <tbody>
        `;
        
        // 資料行
        data.details.forEach(row => {
          html += `<tr>`;
          for (const key in row) {
            let value = row[key];
            
            // 格式化數值
            if (typeof value === 'number') {
              if (key.includes('amount') || key.includes('total') || key.includes('balance')) {
                value = '$' + formatNumber(value);
              }
            } else if (key.includes('date')) {
              value = formatDate(value);
            }
            
            html += `<td>${value}</td>`;
          }
          html += `</tr>`;
        });
        
        html += `
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
      
      if (data.notes) {
        html += `
          <div class="report-notes mt-4">
            <h4>備註</h4>
            <p>${data.notes}</p>
          </div>
        `;
      }
      
      container.innerHTML = html;
    }

    function getColumnLabel(key) {
      const labels = {
        'date': '日期',
        'type': '類型',
        'category': '類別',
        'name': '名稱',
        'amount': '金額',
        'total': '總計',
        'balance': '餘額',
        'count': '數量',
        'payer': '付款人',
        'applicant': '申請人',
        'status': '狀態',
        'memberType': '會員類型',
        'donationType': '捐款類型',
        'month': '月份',
        'quarter': '季度',
        'year': '年度'
      };
      
      return labels[key] || key;
    }

    async function performSystemCheck() {
      try {
        showLoading();
        
        const result = await callAPI('performSystemCheck');
        
        if (result.success && result.status) {
          const statusEl = document.getElementById('systemStatus');
          const contentEl = document.getElementById('systemStatusContent');
          
          let html = `
            <div class="system-status-grid">
              <div class="status-item">
                <h5>資料庫狀態</h5>
                <p class="${result.status.database ? 'text-success' : 'text-danger'}">
                  ${result.status.database ? '正常' : '異常'}
                </p>
              </div>
              <div class="status-item">
                <h5>最後備份</h5>
                <p>${result.status.lastBackup ? formatDateTime(result.status.lastBackup) : '無'}</p>
              </div>
              <div class="status-item">
                <h5>系統版本</h5>
                <p>${result.status.version || SYSTEM_VERSION}</p>
              </div>
              <div class="status-item">
                <h5>儲存空間</h5>
                <p>${result.status.storage ? formatNumber(result.status.storage) + ' MB' : '未知'}</p>
              </div>
            </div>
            
            <div class="mt-4">
              <h5>系統檢查結果</h5>
              <ul>
          `;
          
          result.status.checks.forEach(check => {
            html += `<li class="${check.status ? 'text-success' : 'text-danger'}">${check.message}</li>`;
          });
          
          html += `
              </ul>
            </div>
          `;
          
          contentEl.innerHTML = html;
          statusEl.style.display = 'block';
          
          showAlert('info', '系統檢查完成');
        }
      } catch (error) {
        console.error('系統檢查失敗:', error);
        showAlert('error', '系統檢查失敗');
      } finally {
        hideLoading();
      }
    }

    async function createBackup() {
      try {
        showLoading();
        
        const result = await callAPI('createBackup');
        
        if (result.success) {
          showAlert('success', '備份已成功建立，檔案名稱：' + result.filename);
        }
      } catch (error) {
        console.error('建立備份失敗:', error);
        showAlert('error', '建立備份失敗');
      } finally {
        hideLoading();
      }
    }

    async function cleanupSystem() {
      if (!confirm('確定要執行系統清理嗎？這將刪除暫存檔案和優化資料庫。')) {
        return;
      }
      
      try {
        showLoading();
        
        const result = await callAPI('cleanupSystem');
        
        if (result.success) {
          showAlert('success', '系統清理完成，已釋放 ' + result.freedSpace + ' MB 空間');
        }
      } catch (error) {
        console.error('系統清理失敗:', error);
        showAlert('error', '系統清理失敗');
      } finally {
        hideLoading();
      }
    }

    // 表單自動儲存
    function setupFormAutosave() {
      const forms = ['transactionForm', 'receiptForm', 'voucherForm', 'memberForm'];
      
      forms.forEach(formId => {
        const form = document.getElementById(formId);
        
        if (form) {
          // 載入草稿
          loadFormDraft(formId);
          
          // 設定輸入事件監聽
          form.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('change', () => {
              saveFormDraft(formId);
            });
          });
        }
      });
    }

    function saveFormDraft(formId) {
      const form = document.getElementById(formId);
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      try {
        localStorage.setItem(`draft_${formId}`, JSON.stringify(data));
      } catch (error) {
        console.warn('無法儲存表單草稿:', error);
      }
    }

    function loadFormDraft(formId) {
      try {
        const savedData = localStorage.getItem(`draft_${formId}`);
        
        if (savedData) {
          const data = JSON.parse(savedData);
          const form = document.getElementById(formId);
          
          // 填入表單欄位
          for (const key in data) {
            const input = form.querySelector(`[name="${key}"]`);
            if (input) {
              input.value = data[key];
            }
          }
        }
      } catch (error) {
        console.warn('無法載入表單草稿:', error);
      }
    }

    function clearFormDraft(formId) {
      try {
        localStorage.removeItem(`draft_${formId}`);
      } catch (error) {
        console.warn('無法清除表單草稿:', error);
      }
    }

    // 輔助函數
    function showLoading() {
      document.getElementById('loading').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('show');
    }

    function showAlert(type, message) {
      const container = document.getElementById('alertContainer');
      const alertId = 'alert-' + Date.now();
      
      const alertHtml = `
        <div id="${alertId}" class="alert alert-${type}">
          ${message}
          <button type="button" class="close" onclick="closeAlert('${alertId}')">&times;</button>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', alertHtml);
      
      // 自動關閉
      setTimeout(() => {
        closeAlert(alertId);
      }, 5000);
    }

    function closeAlert(alertId) {
      const alert = document.getElementById(alertId);
      if (alert) {
        alert.style.opacity = '0';
        setTimeout(() => {
          alert.remove();
        }, 300);
      }
    }

    function showModal(title, content) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').innerHTML = content;
      document.getElementById('modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('show');
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-TW');
    }

    function formatDateTime(dateString) {
      if (!dateString) return '-';
      
      const date = new Date(dateString);
      return date.toLocaleString('zh-TW');
    }

    function formatNumber(number) {
      return Number(number).toLocaleString('zh-TW');
    }

    function getStatusBadgeClass(status) {
      const statusClasses = {
        '正常': 'success',
        '已開立': 'success',
        '已寄送': 'info',
        '已作廢': 'danger',
        '待審核': 'warning',
        '已核准': 'success',
        '已駁回': 'danger',
        '停用': 'danger'
      };
      
      return statusClasses[status] || 'secondary';
    }

    function getAboutContent() {
      return `
        <div>
          <h4>台灣帕金森病友權益促進會 - 會計管理系統</h4>
          <p>版本：${SYSTEM_VERSION}</p>
          <p>最後更新：2025年7月</p>
          <p>本系統專為台灣帕金森病友權益促進會開發，用於管理會計、收據、憑證和會員資料。</p>
          <h5>系統功能：</h5>
          <ul>
            <li>交易記錄管理</li>
            <li>收據開立與管理</li>
            <li>支出憑證申請與審核</li>
            <li>會員資料管理</li>
            <li>財務報表產生</li>
            <li>系統設定與維護</li>
          </ul>
          <p>如有任何問題或建議，請聯絡系統管理員。</p>
        </div>
      `;
    }

    function getHelpContent() {
      return `
        <div>
          <h4>使用說明</h4>
          <h5>1. 交易記錄管理</h5>
          <p>在「交易記錄」頁面，您可以新增、編輯和查看所有收支交易。填寫必要欄位後點擊「儲存交易記錄」按鈕即可新增交易。</p>
          
          <h5>2. 收據管理</h5>
          <p>在「收據管理」頁面，您可以開立捐款或會費收據。系統會自動產生收據編號，並可選擇自動寄送電子收據給捐款人。</p>
          
          <h5>3. 支出憑證</h5>
          <p>在「支出憑證」頁面，您可以申請支出憑證，並由管理員進行審核。核准後的憑證可用於報銷或記帳。</p>
          
          <h5>4. 會員管理</h5>
          <p>在「會員管理」頁面，您可以新增、編輯和查看會員資料，包括聯絡資訊和會籍狀態。</p>
          
          <h5>5. 報表分析</h5>
          <p>在「報表分析」頁面，您可以產生各種財務和統計報表，包括月度財務報表、年度財務報表、類別統計報表等。</p>
          
          <h5>6. 系統設定</h5>
          <p>在「系統設定」頁面，您可以管理組織資訊和執行系統維護任務，如建立備份和系統檢查。</p>
          
          <h5>快捷鍵</h5>
          <ul>
            <li>ESC：關閉模態框</li>
          </ul>
        </div>
      `;
    }

    function getContactContent() {
      return `
        <div>
          <h4>聯絡我們</h4>
          <p>如有任何系統問題或建議，請聯絡：</p>
          <p>系統管理員：<a href="mailto:admin@pdtaiwan.org">admin@pdtaiwan.org</a></p>
          <p>技術支援：<a href="mailto:support@pdtaiwan.org">support@pdtaiwan.org</a></p>
          <p>電話：(02) 1234-5678</p>
          <p>辦公時間：週一至週五 9:00-17:00</p>
        </div>
      `;
    }
  </script>
</body>
</html>



              
