<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>病友會 LIFF 前端</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --primary:#2563eb;
      --primary-hover:#1d4ed8;
      --bg:#f5f7fb;
      --card:#ffffff;
      --border:#dce2ee;
      --danger:#dc2626;
      --success:#16a34a;
      --warn:#d97706;
      --radius:8px;
      --text:#1f2937;
      --muted:#6b7280;
      font-family: system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    }
    body { margin:0; background:var(--bg); color:var(--text); }
    header {
      background:var(--primary); color:#fff; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between;
    }
    header h1 { font-size:18px; margin:0; }
    #userStatus { font-size:13px; opacity:.9; }
    main { padding:16px; max-width:1200px; margin:0 auto; }
    .tabs { display:flex; flex-wrap:wrap; gap:4px; margin-bottom:16px; }
    .tabs button {
      background:#e2e8f0; border:1px solid var(--border); padding:6px 12px;
      border-radius:var(--radius); cursor:pointer; font-size:14px;
    }
    .tabs button.active {
      background:var(--primary); color:#fff; border-color:var(--primary);
    }
    section.panel { display:none; animation:fade .25s ease; }
    section.panel.active { display:block; }
    @keyframes fade { from {opacity:0; transform:translateY(4px);} to {opacity:1; transform:translateY(0);} }

    .card {
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); padding:16px; margin-bottom:16px;
      box-shadow:0 2px 4px rgba(0,0,0,0.04);
    }
    h2 { margin:0 0 12px; font-size:18px; }
    h3 { margin:12px 0 8px; font-size:16px; }
    label { display:block; font-size:13px; margin-top:10px; }
    input, select, textarea {
      width:100%; padding:8px; box-sizing:border-box;
      border:1px solid var(--border); border-radius:6px;
      background:#fff; font-size:14px;
    }
    textarea { min-height:90px; resize:vertical; }
    input:focus, select:focus, textarea:focus {
      outline:2px solid var(--primary); border-color:var(--primary);
    }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .row .col { flex:1 1 200px; min-width:200px; }
    button, .btn {
      background:var(--primary); color:#fff; border:none; cursor:pointer;
      padding:8px 14px; border-radius:6px; font-size:14px;
      display:inline-flex; align-items:center; gap:4px;
    }
    button:hover, .btn:hover { background:var(--primary-hover); }
    button.outline {
      background:#fff; color:var(--primary); border:1px solid var(--primary);
    }
    button.outline:hover { background:#eff6ff; }
    button.small { padding:4px 8px; font-size:12px; }
    .danger { background:var(--danger) !important; }
    .success { background:var(--success) !important; }
    .warn { background:var(--warn) !important; }
    table {
      width:100%; border-collapse:collapse; font-size:13px; margin-top:8px;
    }
    th, td {
      padding:6px 8px; text-align:left; border-bottom:1px solid #e5e7eb;
      vertical-align:top;
    }
    th { background:#f1f5f9; font-weight:600; white-space:nowrap; }
    tr:hover { background:#f9fafb; }
    .muted { color:var(--muted); font-size:12px; }
    .pill {
      display:inline-block; padding:2px 8px; border-radius:999px;
      font-size:11px; background:#e2e8f0; margin-right:4px; margin-top:2px;
    }
    .pill.ok { background:#d1fae5; color:#065f46; }
    .pill.warn { background:#fef9c3; color:#854d0e; }
    .pill.err { background:#fee2e2; color:#991b1b; }
    .flex { display:flex; gap:8px; }
    .space-between { justify-content:space-between; align-items:center; }
    .divider { height:1px; background:#e2e8f0; margin:16px 0; }
    .inline-link { color:var(--primary); text-decoration:none; font-size:12px; }
    .badgeAdmin { background:#1e3a8a; color:#fff; padding:2px 6px; border-radius:4px; font-size:11px; }
    .scroll-x { overflow:auto; }
    .alert {
      background:#fff; border-left:4px solid var(--primary); padding:8px 12px; font-size:12px;
      border-radius:4px; margin:6px 0;
    }
    .alert.warn { border-color:var(--warn); }
    .alert.danger { border-color:var(--danger); }
    #toast {
      position:fixed; bottom:18px; right:18px; background:#111827;
      color:#fff; padding:10px 14px; border-radius:6px; font-size:13px;
      box-shadow:0 4px 12px rgba(0,0,0,0.2); opacity:0; pointer-events:none;
      transform:translateY(8px); transition:.25s;
      max-width:320px; line-height:1.5;
      white-space:pre-wrap;
    }
    #toast.show { opacity:1; transform:translateY(0); }
    .hidden { display:none !important; }
    .vote-option-bar {
      background:#e5e7eb; border-radius:4px; overflow:hidden; position:relative; height:18px;
      margin:4px 0 10px;
    }
    .vote-option-bar span {
      position:absolute; left:6px; top:0; bottom:0; font-size:11px;
      display:flex; align-items:center; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,0.4);
    }
    .vote-fill { background:linear-gradient(90deg,#2563eb,#1d4ed8); height:100%; }
    .skeleton {
      animation: pulse 1.5s infinite; background:linear-gradient(90deg,#e5e7eb 25%,#f3f4f6 50%,#e5e7eb 75%);
      background-size:200% 100%;
    }
    @keyframes pulse { 0%{background-position:200% 0;} 100%{background-position:-200% 0;} }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <header>
    <h1>病友會互動平台</h1>
    <div id="userStatus">未登入</div>
  </header>
  <main>
    <div class="tabs" id="tabBar">
      <button data-tab="auth" class="active">登入 / 會員</button>
      <button data-tab="activities">活動</button>
      <button data-tab="donation">捐款</button>
      <button data-tab="receipts">收據</button>
      <button data-tab="volunteer">志工</button>
      <button data-tab="voting">投票</button>
      <button data-tab="dashboard">總覽</button>
      <button data-tab="admin" id="adminTab" class="hidden">管理</button>
    </div>

    <!-- Auth / Profile -->
    <section class="panel active" id="panel-auth">
      <div class="card">
        <h2>LINE / 電話登入</h2>
        <div class="alert">
          1. 若於 LINE LIFF 中開啟，可直接使用 LINE 身分。<br>
          2. 若為一般瀏覽器，您可使用「電話會員」註冊 / 登入。<br>
          3. 登入後請再進行會員資料補充，以利活動 / 收據寄送。
        </div>
        <div class="row">
          <div class="col">
            <h3>LINE 身分</h3>
            <p id="lineProfileInfo" class="muted">尚未啟動 LIFF。</p>
            <div class="flex">
              <button id="btnInitLiff">啟動 LIFF</button>
              <button id="btnLineLogin" class="outline">重新登入</button>
              <button id="btnLineLogout" class="danger">登出 LINE</button>
            </div>
          </div>
          <div class="col">
            <h3>電話會員註冊</h3>
            <label>姓名
              <input id="regRealName" />
            </label>
            <label>手機（純數字）
              <input id="regPhone" placeholder="09xxxxxxxx" />
            </label>
            <label>密碼
              <input id="regPwd" type="password" />
            </label>
            <button id="btnPhoneRegister">電話註冊並登入</button>
          </div>
          <div class="col">
            <h3>電話會員登入</h3>
            <label>手機（或留空用姓名）<input id="loginPhone" /></label>
            <label>姓名（選用）<input id="loginRealName" /></label>
            <label>密碼 <input id="loginPwd" type="password" /></label>
            <button id="btnPhoneLogin">電話登入</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>會員資料</h2>
          <div class="row">
            <div class="col">
              <label>Line ID（唯讀）
                <input id="profileLineId" readonly />
              </label>
            </div>
            <div class="col">
              <label>暱稱
                <input id="profileLineName" />
              </label>
            </div>
            <div class="col">
              <label>真實姓名
                <input id="profileRealName" />
              </label>
            </div>
            <div class="col">
              <label>會員類型
                <select id="profileMemberType">
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                  <option value="贊助者">贊助者</option>
                </select>
              </label>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>手機<input id="profilePhone" /></label>
            </div>
            <div class="col">
              <label>Email<input id="profileEmail" type="email" /></label>
            </div>
            <div class="col">
              <label>生日<input id="profileBirthday" type="date" /></label>
            </div>
            <div class="col">
              <label>地址<input id="profileAddress" /></label>
            </div>
          </div>
          <label>備註
            <textarea id="profileNotes"></textarea>
          </label>
          <div class="flex space-between" style="margin-top:12px;">
            <button id="btnLoadProfile" class="outline">重新載入</button>
            <div class="flex">
              <button id="btnSaveProfile">儲存資料</button>
            </div>
          </div>
      </div>
    </section>

    <!-- Activities -->
    <section class="panel" id="panel-activities">
      <div class="card">
        <h2>活動列表</h2>
        <div class="flex space-between">
          <small class="muted">顯示所有開放/有效活動</small>
          <div class="flex">
            <button id="btnRefreshActivities" class="outline small">重新整理</button>
          </div>
        </div>
        <div id="activitiesContainer" class="scroll-x" style="margin-top:8px;"></div>
      </div>
    </section>

    <!-- Donation -->
    <section class="panel" id="panel-donation">
      <div class="card">
        <h2>捐款</h2>
        <div class="row">
          <div class="col">
            <label>捐款分類
              <select id="donCategory"></select>
            </label>
          </div>
          <div class="col">
            <label>金額
              <input id="donAmount" type="number" min="1" />
            </label>
          </div>
          <div class="col">
            <label>需要收據？
              <select id="donNeedReceipt">
                <option value="yes">是</option>
                <option value="no">否</option>
              </select>
            </label>
          </div>
        </div>
        <label>備註 / 描述
          <textarea id="donDesc"></textarea>
        </label>
        <div style="margin-top:10px;">
          <button id="btnCreateDonation">送出捐款</button>
        </div>
        <div id="donationResult" class="muted" style="margin-top:12px;"></div>
      </div>

      <div class="card">
        <h3>我的捐款 / 財務統計</h3>
        <button id="btnLoadFinance" class="outline small">載入</button>
        <div id="financeStats" class="row" style="margin-top:8px;"></div>
        <div id="myDonationsTable" class="scroll-x" style="margin-top:12px;"></div>
      </div>
    </section>

    <!-- Receipts -->
    <section class="panel" id="panel-receipts">
      <div class="card">
        <h2>我的收據</h2>
        <button id="btnLoadReceipts" class="outline small">載入收據</button>
        <div id="myReceiptsContainer" style="margin-top:8px;"></div>
      </div>
      <div class="card hidden" id="adminReceiptsCard">
        <h2>收據管理（管理員）</h2>
        <div class="row">
          <div class="col">
            <label>Line ID 篩選
              <input id="filterReceiptsLineId" />
            </label>
          </div>
          <div class="col">
            <label>收據號碼
              <input id="filterReceiptNumber" />
            </label>
          </div>
          <div class="col">
            <label>類型
              <select id="filterReceiptType">
                <option value="">全部</option>
                <option>捐款</option>
                <option>手動</option>
              </select>
            </label>
          </div>
          <div class="col">
            <label>起日
              <input id="filterReceiptFrom" type="date" />
            </label>
          </div>
          <div class="col">
            <label>迄日
              <input id="filterReceiptTo" type="date" />
            </label>
          </div>
        </div>
        <div class="flex" style="margin-top:8px;">
          <button id="btnSearchReceipts">查詢</button>
          <button id="btnCreateManualReceipt" class="outline">手動開立測試</button>
        </div>
        <div id="allReceiptsContainer" class="scroll-x" style="margin-top:12px;"></div>
      </div>
    </section>

    <!-- Volunteer -->
    <section class="panel" id="panel-volunteer">
      <div class="card">
        <h2>志工資訊</h2>
        <button id="btnLoadVolunteer" class="outline small">載入</button>
        <div id="volStats" class="row" style="margin-top:10px;"></div>
        <h3 style="margin-top:18px;">志工需求</h3>
        <div id="volNeedsContainer" class="scroll-x"></div>
        <h3 style="margin-top:18px;">我的志工紀錄</h3>
        <div id="volRecordsContainer" class="scroll-x"></div>
      </div>
    </section>

    <!-- Voting -->
    <section class="panel" id="panel-voting">
      <div class="card">
        <h2>投票主題</h2>
        <div class="flex">
          <button id="btnLoadVotingTopics" class="outline small">載入主題</button>
          <button id="btnLoadVotingResults" class="outline small">統計結果</button>
        </div>
        <div id="votingTopicsContainer" style="margin-top:10px;"></div>
        <div class="divider"></div>
        <h3>投票統計</h3>
          <div id="votingResultsContainer"></div>
      </div>
      <div class="card hidden" id="adminVotingCard">
        <h3>新增投票主題（管理員）</h3>
        <label>標題 <input id="newVoteTitle" /></label>
        <label>選項（每行一個）
          <textarea id="newVoteOptions" placeholder="選項A
選項B
選項C"></textarea>
        </label>
        <button id="btnCreateVotingTopic">建立主題</button>
      </div>
    </section>

    <!-- Dashboard -->
    <section class="panel" id="panel-dashboard">
      <div class="card">
        <h2>個人總覽</h2>
        <button id="btnLoadDashboard" class="outline small">重新整理</button>
        <div id="dashboardContent" style="margin-top:12px;"></div>
      </div>
    </section>

    <!-- Admin -->
    <section class="panel" id="panel-admin">
      <div class="card">
        <h2>管理工具</h2>
        <div class="row">
          <div class="col">
            <button id="btnAdminExportMembers" class="outline">匯出會員</button>
          </div>
          <div class="col">
            <button id="btnAdminExportFinance" class="outline">匯出財務</button>
          </div>
          <div class="col">
            <button id="btnAdminBackup" class="outline warn">建立備份</button>
          </div>
        </div>
        <div id="adminActionResult" class="muted" style="margin-top:10px;"></div>
      </div>
    </section>

  </main>

  <div id="toast"></div>

  <script>
    /**********************
     * 基本設定 (請自行填入)
     **********************/
    const APP_CONFIG = {
      API_URL: 'https://script.google.com/macros/s/AKfycbxyuvZe1Vc0JKPT1x1dN5SEMARaptXY8PtpyGOQn1GF8_LAr36LgkIbHN5N9Gp19uzc/exec', // TODO: 你的 Apps Script 部署 URL
      API_KEY: 'AAbb8520258185202581',          // TODO: 與後端一致
      LIFF_ID: '1656516134-VaGgmaPm' // TODO: 你的 LIFF ID
    };

    /**********************
     * 全域狀態
     **********************/
    const state = {
      lineId: null,
      lineName: null,
      isAdmin: false,
      sessionToken: null,   // 電話登入才有
      profileLoaded: false,
      categories: { incomeCategories:[], expenseCategories:[] },
      cachedActivities: [],
      votingTopics: []
    };

    const PUBLIC_ACTIONS = new Set([
      'registerUser','phoneRegister','phoneLogin',
      'getPublicCategories','getActivities','getVotingResults'
    ]);

    /**********************
     * UI 輔助
     **********************/
    function toast(msg, timeout=3200){
      const el=document.getElementById('toast');
      el.textContent=msg;
      el.classList.add('show');
      clearTimeout(el._t);
      el._t=setTimeout(()=> el.classList.remove('show'), timeout);
    }

    function setUserStatus(){
      const el=document.getElementById('userStatus');
      if(!state.lineId && !state.sessionToken){
        el.innerHTML='未登入';
      }else{
        el.innerHTML = `
          <span>${state.lineName||'（未有暱稱）'}</span>
          <span class="muted" style="margin-left:6px;">${state.lineId||'無ID'}</span>
          ${state.sessionToken?'<span class="pill ok">電話登入</span>':''}
          ${state.isAdmin?'<span class="badgeAdmin">Admin</span>':''}
        `;
      }
      document.getElementById('adminTab').classList.toggle('hidden', !state.isAdmin);
      document.getElementById('adminReceiptsCard').classList.toggle('hidden', !state.isAdmin);
      document.getElementById('adminVotingCard').classList.toggle('hidden', !state.isAdmin);
    }

    function switchTab(name){
      document.querySelectorAll('.tabs button').forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.tab===name);
      });
      document.querySelectorAll('section.panel').forEach(p=>{
        p.classList.toggle('active', p.id==='panel-'+name);
      });
    }

    document.getElementById('tabBar').addEventListener('click', e=>{
      if(e.target.tagName==='BUTTON'){
        switchTab(e.target.dataset.tab);
      }
    });

    /**********************
     * 呼叫 API
     **********************/
    async function callAPI(action, payload={}){
      const body = Object.assign({}, payload, {
        apiKey: APP_CONFIG.API_KEY,
        action
      });
      // 附加身份：優先 sessionToken
      if(state.sessionToken) body.sessionToken = state.sessionToken;
      // 若非電話登入也有 lineId
      if(state.lineId) body.lineId = state.lineId;

      // 安全性：如果不是 public action 仍無任何身份 → 拒絕
      if(!PUBLIC_ACTIONS.has(action) && !body.sessionToken && !body.lineId){
        throw new Error('尚未登入');
      }

      const res = await fetch(APP_CONFIG.API_URL, {
        method:'POST',
          headers:{ 'Content-Type':'application/json' },
        body:JSON.stringify(body)
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const json = await res.json();
      if(!json.success) throw new Error(json.message||'API 錯誤');
      return json;
    }

    /**********************
     * LIFF 相關
     **********************/
    async function initLIFF(){
      try{
        await liff.init({ liffId: APP_CONFIG.LIFF_ID });
        if(!liff.isLoggedIn()){
          document.getElementById('lineProfileInfo').textContent='尚未登入 LINE，請點「重新登入」。';
          return;
        }
        const profile = await liff.getProfile();
        state.lineId = profile.userId;
        state.lineName = profile.displayName;
        document.getElementById('lineProfileInfo').innerHTML = `
          已登入 LINE：<strong>${profile.displayName}</strong><br>
          userId: <code>${profile.userId}</code>
        `;
        setUserStatus();
        // 自動嘗試載入使用者資訊 / 註冊
        await ensureLineUserRegistered();
      }catch(e){
        console.error(e);
        document.getElementById('lineProfileInfo').textContent='LIFF 初始化失敗：'+e;
      }
    }

    document.getElementById('btnInitLiff').addEventListener('click', initLIFF);
    document.getElementById('btnLineLogin').addEventListener('click', ()=>{
      if(!liff.isLoggedIn()){
        liff.login();
      }else{
        toast('已登入，重新載入頁面以重新初始化');
      }
    });
    document.getElementById('btnLineLogout').addEventListener('click', ()=>{
      if(liff.isLoggedIn()){
        liff.logout();
        location.reload();
      }else{
        toast('未登入 LINE');
      }
    });

    async function ensureLineUserRegistered(){
      if(!state.lineId) return;
      try{
        // 先呼叫 getUserInfo 查是否註冊
        const infoRes = await callAPI('getUserInfo', { lineId: state.lineId });
        state.isAdmin = !!infoRes.data.isAdmin;
        // 同步顯示
        fillProfileForm(infoRes.data);
        toast('已載入 LINE 使用者資料');
      }catch(e){
        if(/未註冊/.test(e.message)){
          // 自動註冊
          try{
            await callAPI('registerUser', {
              lineId: state.lineId,
              lineName: state.lineName,
              realName: state.lineName
            });
            toast('已自動註冊 (LINE)');
            const infoRes2 = await callAPI('getUserInfo',{ lineId: state.lineId });
            state.isAdmin = !!infoRes2.data.isAdmin;
            fillProfileForm(infoRes2.data);
          }catch(e2){
            console.error(e2);
            toast('LINE 註冊失敗：'+e2.message);
          }
        }else{
          console.error(e);
          toast('取得 LINE 使用者失敗：'+e.message);
        }
      }finally{
        setUserStatus();
        loadCategories(); // 依賴後端
      }
    }

    /**********************
     * 電話註冊 / 登入
     **********************/
    document.getElementById('btnPhoneRegister').addEventListener('click', async ()=>{
      try{
        const realName=document.getElementById('regRealName').value.trim();
        const phone=document.getElementById('regPhone').value.trim();
        const pwd=document.getElementById('regPwd').value;
        if(!realName||!phone||!pwd) return toast('請填寫註冊欄位');
        const r=await callAPI('phoneRegister',{ realName, phone, password:pwd });
        state.sessionToken=r.data.sessionToken;
        state.lineId='TEL_'+phone;
        state.lineName=realName;
        state.isAdmin=false;
        toast('電話註冊成功');
        setUserStatus();
      }catch(e){
        toast('電話註冊失敗：'+e.message);
      }
    });

    document.getElementById('btnPhoneLogin').addEventListener('click', async ()=>{
      try{
        const phone=document.getElementById('loginPhone').value.trim();
        const realName=document.getElementById('loginRealName').value.trim();
        const pwd=document.getElementById('loginPwd').value;
          if(!pwd || (!phone && !realName)){
          return toast('請輸入手機或姓名 + 密碼');
        }
        const r=await callAPI('phoneLogin',{ phone, realName, password:pwd });
        state.sessionToken=r.data.sessionToken;
        state.lineId= phone? ('TEL_'+phone): state.lineId;
        state.lineName = realName || state.lineName;
        toast('電話登入成功');
        // 取得 getUserInfo 以判斷是否 admin
        try{
          const info=await callAPI('getUserInfo',{ lineId: state.lineId });
          state.isAdmin=!!info.data.isAdmin;
          fillProfileForm(info.data);
        }catch(e2){}
        setUserStatus();
        loadCategories();
      }catch(e){
        toast('電話登入失敗：'+e.message);
      }
    });

    /**********************
     * 會員資料
     **********************/
    function fillProfileForm(data){
      document.getElementById('profileLineId').value=data.lineId||'';
      document.getElementById('profileLineName').value=data.lineName||'';
      document.getElementById('profileRealName').value=data.realName||'';
      document.getElementById('profileMemberType').value=data.memberType||'病友';
      document.getElementById('profilePhone').value=data.phone||'';
      document.getElementById('profileEmail').value=data.email||'';
      if(data.birthday instanceof Date){
        document.getElementById('profileBirthday').value = data.birthday.toISOString().slice(0,10);
      }else if(data.birthday){
        // 若為字串
        const bStr = formatDateInput(data.birthday);
        if(bStr) document.getElementById('profileBirthday').value=bStr;
      }
      document.getElementById('profileAddress').value=data.address||'';
      document.getElementById('profileNotes').value=data.notes||'';
      state.profileLoaded=true;
    }

    function formatDateInput(val){
      try{
        if(!val) return '';
        if(typeof val==='string' && /^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
        const d=new Date(val);
        if(!isNaN(d.getTime())){
          return d.toISOString().slice(0,10);
        }
        return '';
      }catch(_){ return ''; }
    }

    document.getElementById('btnLoadProfile').addEventListener('click', async ()=>{
      if(!state.lineId) return toast('尚未登入');
      try{
        const r=await callAPI('getUserInfo',{ lineId: state.lineId });
        state.isAdmin=!!r.data.isAdmin;
        fillProfileForm(r.data);
        setUserStatus();
        toast('已載入');
      }catch(e){
        toast('載入失敗：'+e.message);
      }
    });

    document.getElementById('btnSaveProfile').addEventListener('click', async ()=>{
      if(!state.lineId) return toast('尚未登入');
      try{
        const payload={
          lineId: state.lineId,
          lineName: document.getElementById('profileLineName').value.trim(),
          realName: document.getElementById('profileRealName').value.trim(),
          memberType: document.getElementById('profileMemberType').value,
          phone: document.getElementById('profilePhone').value.trim(),
          email: document.getElementById('profileEmail').value.trim(),
          birthday: document.getElementById('profileBirthday').value,
          address: document.getElementById('profileAddress').value.trim(),
          notes: document.getElementById('profileNotes').value
        };
        await callAPI('updateProfile',payload);
        toast('更新成功');
        // 重新 fetch 以更新 admin 標記
        const info=await callAPI('getUserInfo',{ lineId: state.lineId });
        state.isAdmin=!!info.data.isAdmin;
        setUserStatus();
      }catch(e){
        toast('更新失敗：'+e.message);
      }
    });

    /**********************
     * 分類載入
     **********************/
    async function loadCategories(){
      try{
        const r=await callAPI('getPublicCategories',{});
        state.categories=r.data;
        const donSel=document.getElementById('donCategory');
        donSel.innerHTML = state.categories.incomeCategories.map(c=>`<option>${c}</option>`).join('');
      }catch(e){
        console.warn('載入分類失敗', e);
      }
    }

    /**********************
     * 活動
     **********************/
    document.getElementById('btnRefreshActivities').addEventListener('click', loadActivities);
    async function loadActivities(){
      try{
        const r=await callAPI('getActivities',{});
        state.cachedActivities=r.data||[];
        renderActivities();
      }catch(e){
        toast('載入活動失敗：'+e.message);
      }
    }

    function renderActivities(){
      const wrap=document.getElementById('activitiesContainer');
      if(!state.cachedActivities.length){
        wrap.innerHTML='<div class="muted">尚無活動</div>';
        return;
      }
      let html='<table><thead><tr><th>標題</th><th>日期</th><th>地點</th><th>人數</th><th>狀態</th><th></th></tr></thead><tbody>';
      state.cachedActivities.forEach(a=>{
        html+=`<tr>
          <td>${escapeHtml(a.title||'')}</td>
          <td>${escapeHtml(a.date||'')}</td>
          <td>${escapeHtml(a.location||'')}</td>
          <td>${a.currentCount||0}/${a.maxParticipants||0}</td>
          <td><span class="pill ${a.status==='開放報名'?'ok':'warn'}">${a.status||''}</span></td>
          <td>${a.status==='開放報名' && state.lineId? `<button class="small" data-act-register="${a.id}">報名</button>`:''}</td>
        </tr>`;
      });
      html+='</tbody></table>';
      wrap.innerHTML=html;
      wrap.querySelectorAll('[data-act-register]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id=btn.getAttribute('data-act-register');
          if(!confirm('確定報名此活動？')) return;
          try{
            await callAPI('registerActivity',{ activityId:id });
            toast('報名成功');
            loadActivities();
          }catch(e){
            toast('報名失敗：'+e.message);
          }
        });
      });
    }

    /**********************
     * 捐款
     **********************/
    document.getElementById('btnCreateDonation').addEventListener('click', async ()=>{
      if(!state.lineId) return toast('請先登入');
      const amount=Number(document.getElementById('donAmount').value);
      const category=document.getElementById('donCategory').value;
      const desc=document.getElementById('donDesc').value;
      const needReceipt=document.getElementById('donNeedReceipt').value==='yes';
      if(!(amount>0)) return toast('金額需 > 0');
      try{
        const r=await callAPI('createDonation',{
          amount, category, description:desc, needReceipt
        });
        document.getElementById('donationResult').innerHTML = `
          捐款成功：ID=${r.data.id || ''} ${
            r.data.receiptNumber? '｜收據：<strong>'+r.data.receiptNumber+'</strong>':''}
          ${r.data.pdfUrl? '｜<a href="'+r.data.pdfUrl+'" target="_blank">PDF</a>':''}
        `;
        toast('捐款成功');
        document.getElementById('donAmount').value='';
        loadFinance();
      }catch(e){
        toast('捐款失敗：'+e.message);
      }
    });

    document.getElementById('btnLoadFinance').addEventListener('click', loadFinance);
    async function loadFinance(){
      if(!state.lineId) return toast('請先登入');
      try{
        const r=await callAPI('getFinanceData',{});
        const stats=r.data.stats;
        const wrap=document.getElementById('financeStats');
        wrap.innerHTML = `
          <div class="col card" style="padding:10px;">
            <div class="muted">總捐款金額</div><div style="font-size:20px;font-weight:600;">${stats.totalDonation}</div>
          </div>
          <div class="col card" style="padding:10px;">
            <div class="muted">捐款筆數</div><div style="font-size:20px;font-weight:600;">${stats.donationCount}</div>
          </div>
          <div class="col card" style="padding:10px;">
            <div class="muted">我的支出申請（未核）</div><div style="font-size:20px;font-weight:600;">${stats.pendingExpenses}</div>
          </div>
        `;
        // donations table
        const dt=document.getElementById('myDonationsTable');
        if(r.data.donations?.length){
          let html='<table><thead><tr><th>時間</th><th>分類</th><th>金額</th><th>收據</th></tr></thead><tbody>';
          r.data.donations.forEach(d=>{
            html+=`<tr>
              <td>${formatDateTime(d.createdAt)}</td>
              <td>${escapeHtml(d.category||'')}</td>
              <td>${d.amount}</td>
              <td>${d.receiptNumber||''}</td>
            </tr>`;
          });
          html+='</tbody></table>';
          dt.innerHTML=html;
        }else{
          dt.innerHTML='<div class="muted">尚無捐款紀錄</div>';
        }
      }catch(e){
        toast('載入財務失敗：'+e.message);
      }
    }

    /**********************
     * 收據
     **********************/
    document.getElementById('btnLoadReceipts').addEventListener('click', loadMyReceipts);
    async function loadMyReceipts(){
      if(!state.lineId) return toast('請先登入');
      try{
        const r=await callAPI('getMyReceipts',{});
        const list=r.data||[];
        const wrap=document.getElementById('myReceiptsContainer');
        if(!list.length){
          wrap.innerHTML='<div class="muted">尚無收據</div>';
          return;
        }
        let html='<table><thead><tr><th>開立日期</th><th>收據號碼</th><th>類型</th><th>金額</th><th>PDF</th><th>寄送</th></tr></thead><tbody>';
        list.forEach(rec=>{
          html+=`<tr>
            <td>${formatDate(rec.issueDate)}</td>
            <td>${rec.receiptNumber}</td>
            <td>${escapeHtml(rec.type||'')}</td>
            <td>${rec.amount}</td>
            <td>${rec.pdfUrl? `<a href="${rec.pdfUrl}" target="_blank">開啟</a>`:''}</td>
            <td>${rec.emailSent?'<span class="pill ok">已寄送</span>':'<span class="pill">未寄</span>'}</td>
          </tr>`;
        });
        html+='</tbody></table>';
        wrap.innerHTML=html;
      }catch(e){
        toast('收據載入失敗：'+e.message);
      }
    }

    document.getElementById('btnSearchReceipts').addEventListener('click', async ()=>{
      try{
        const params={
          lineId: state.lineId, // 管理員自身身分
          lineIdFilter: document.getElementById('filterReceiptsLineId').value.trim(),
          receiptNumber: document.getElementById('filterReceiptNumber').value.trim(),
          type: document.getElementById('filterReceiptType').value,
          dateFrom: document.getElementById('filterReceiptFrom').value,
          dateTo: document.getElementById('filterReceiptTo').value
        };
        const r=await callAPI('getAllReceipts', params);
        renderAdminReceipts(r.data.receipts||[]);
      }catch(e){
        toast('查詢失敗：'+e.message);
      }
    });

    async function adminCreateManualReceipt(){
      if(!state.isAdmin) return toast('非管理員');
      const targetLineId=prompt('輸入目標 Line ID (或 TEL_xxx)');
      if(!targetLineId) return;
      const type=prompt('收據類型（例如：捐款）','捐款') || '捐款';
      const amount=parseInt(prompt('金額','1000'),10);
      if(!(amount>0)) return toast('金額需 > 0');
      try{
        const r=await callAPI('createManualReceipt',{ targetLineId, type, amount, createDonation: type==='捐款' });
        toast('開立成功：'+r.data.receiptNumber);
      }catch(e){
        toast('開立失敗：'+e.message);
      }
    }

    document.getElementById('btnCreateManualReceipt').addEventListener('click', adminCreateManualReceipt);

    function renderAdminReceipts(list){
      const wrap=document.getElementById('allReceiptsContainer');
      if(!list.length){
        wrap.innerHTML='<div class="muted">無資料</div>';
        return;
      }
      let html='<table><thead><tr><th>日期</th><th>號碼</th><th>LineID</th><th>類型</th><th>金額</th><th>PDF</th><th>寄送</th></tr></thead><tbody>';
      list.forEach(r=>{
        html+=`<tr>
          <td>${formatDate(r.issueDate)}</td>
          <td>${r.receiptNumber}</td>
          <td>${escapeHtml(r.lineId||'')}</td>
          <td>${escapeHtml(r.type||'')}</td>
          <td>${r.amount}</td>
          <td>${r.pdfUrl? `<a href="${r.pdfUrl}" target="_blank">PDF</a>`:''}</td>
          <td>${r.emailSent?'<span class="pill ok">已寄送</span>':'<span class="pill">未寄</span>'}</td>
        </tr>`;
      });
      html+='</tbody></table>';
      wrap.innerHTML=html;
    }

    /**********************
     * 志工
     **********************/
    document.getElementById('btnLoadVolunteer').addEventListener('click', loadVolunteer);
    async function loadVolunteer(){
      if(!state.lineId) return toast('需登入');
      try{
        const r=await callAPI('getVolunteerData',{});
        const stats=r.data.stats;
        document.getElementById('volStats').innerHTML=`
          <div class="col card" style="padding:8px;">
            <div class="muted">總時數</div><div style="font-size:18px;font-weight:600;">${stats.totalHours}</div>
          </div>
          <div class="col card" style="padding:8px;">
            <div class="muted">參與活動數</div><div style="font-size:18px;font-weight:600;">${stats.totalActivities}</div>
          </div>
          <div class="col card" style="padding:8px;">
            <div class="muted">開放需求</div><div style="font-size:18px;font-weight:600;">${stats.availableNeeds}</div>
          </div>
        `;
        // 需求
        if(r.data.needs?.length){
          let html='<table><thead><tr><th>標題</th><th>日期</th><th>人數</th><th>時數</th><th></th></tr></thead><tbody>';
          r.data.needs.forEach(n=>{
            html+=`<tr>
              <td>${escapeHtml(n.title||'')}</td>
              <td>${n.date||''}</td>
              <td>${n.currentCount||0}/${n.needCount||0}</td>
              <td>${n.hours||0}</td>
              <td>${ state.lineId? `<button class="small" data-vol-apply="${n.id}">報名</button>`:'' }</td>
            </tr>`;
          });
          html+='</tbody></table>';
          document.getElementById('volNeedsContainer').innerHTML=html;
          document.querySelectorAll('[data-vol-apply]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const id=btn.getAttribute('data-vol-apply');
              if(!confirm('確定報名此志工？')) return;
              try{
                await callAPI('applyVolunteer',{ needId:id });
                toast('志工報名成功');
                loadVolunteer();
              }catch(e){
                toast('報名失敗：'+e.message);
              }
            });
          });
        }else{
          document.getElementById('volNeedsContainer').innerHTML='<div class="muted">無需求</div>';
        }
        // 紀錄
          if(r.data.records?.length){
          let html='<table><thead><tr><th>標題</th><th>日期</th><th>時數</th><th>狀態</th></tr></thead><tbody>';
          r.data.records.forEach(rc=>{
            html+=`<tr>
              <td>${escapeHtml(rc.title||'')}</td>
              <td>${rc.date||''}</td>
              <td>${rc.hours||0}</td>
              <td><span class="pill ${rc.status==='已完成'?'ok':''}">${rc.status||''}</span></td>
            </tr>`;
          });
          html+='</tbody></table>';
          document.getElementById('volRecordsContainer').innerHTML=html;
        }else{
          document.getElementById('volRecordsContainer').innerHTML='<div class="muted">無紀錄</div>';
        }

      }catch(e){
        toast('載入志工失敗：'+e.message);
      }
    }

    /**********************
     * 投票
     **********************/
    document.getElementById('btnCreateVotingTopic').addEventListener('click', async ()=>{
      if(!state.isAdmin) return toast('非管理員');
      const title=document.getElementById('newVoteTitle').value.trim();
      const opts=document.getElementById('newVoteOptions').value
        .split(/\n+/).map(l=>l.trim()).filter(Boolean);
      if(!title || !opts.length) return toast('請輸入標題與至少一個選項');
      try{
        await callAPI('createVotingTopic',{ title, options:opts });
        toast('建立成功（草稿）請至後端 publish');
        document.getElementById('newVoteTitle').value='';
        document.getElementById('newVoteOptions').value='';
        loadVotingTopics();
      }catch(e){
        toast('建立失敗：'+e.message);
      }
    });

    document.getElementById('btnLoadVotingTopics').addEventListener('click', loadVotingTopics);
    async function loadVotingTopics(){
      try{
        const r=await callAPI('listVotingTopics',{});
        state.votingTopics=r.data||[];
        renderVotingTopics();
      }catch(e){
        toast('載入投票主題失敗：'+e.message);
      }
    }

    function renderVotingTopics(){
      const wrap=document.getElementById('votingTopicsContainer');
      if(!state.votingTopics.length){
        wrap.innerHTML='<div class="muted">尚無投票主題</div>';
        return;
      }
      let html='<div class="row">';
      state.votingTopics.forEach(t=>{
        html+=`
          <div class="col card" style="min-width:260px;">
            <h4 style="margin:0 0 6px;">${escapeHtml(t.title||'')}</h4>
            <div class="muted" style="font-size:12px;">狀態：${t.status}</div>
            <div style="margin:6px 0 8px;">
              ${(t.options||[]).map(o=>`<div>
                <label style="display:flex;align-items:center;gap:4px;font-size:13px;">
                  <input type="radio" name="vote_${t.id}" value="${escapeHtml(o.key||o)}" />
                  <span>${escapeHtml(o.text||o)}</span>
                </label>
              </div>`).join('')}
            </div>
            <button data-vote-topic="${t.id}" class="small">送出投票</button>
          </div>
        `;
      });
      html+='</div>';
      wrap.innerHTML=html;
      wrap.querySelectorAll('[data-vote-topic]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          if(!state.lineId && !state.sessionToken) return toast('需登入才可投票');
          const topicId=btn.getAttribute('data-vote-topic');
          const sel=wrap.querySelector(`input[name="vote_${topicId}"]:checked`);
          if(!sel) return toast('請先選擇選項');
          try{
            await callAPI('castVote',{ topicId, optionKey: sel.value });
            toast('投票成功');
            loadVotingResults();
          }catch(e){
            toast('投票失敗：'+e.message);
          }
        });
      });
    }

    document.getElementById('btnLoadVotingResults').addEventListener('click', loadVotingResults);
    async function loadVotingResults(){
      try{
        const r=await callAPI('getVotingResults',{});
        renderVotingResults(r.data.topics||[]);
      }catch(e){
        toast('載入統計失敗：'+e.message);
      }
    }

    function renderVotingResults(topics){
      const wrap=document.getElementById('votingResultsContainer');
      if(!topics.length){
        wrap.innerHTML='<div class="muted">無統計資料</div>';
        return;
      }
      let html='';
      topics.forEach(t=>{
        html+=`<div class="card" style="padding:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong>${escapeHtml(t.title)}</strong>
            <span class="muted" style="font-size:12px;">總票數：${t.totalVotes}</span>
          </div>
          <div style="margin-top:4px;">${t.options.map(o=>{
            const pct=o.percentage;
            const fillWidth=pct+'%';
            const voted = t.userVotedOption===o.key;
            return `<div style="margin:6px 0;">
              <div style="font-size:12px;display:flex;justify-content:space-between;">
                <span>${escapeHtml(o.text)} ${voted?'<span class="pill ok">我投</span>':''}</span>
                <span>${o.count} 票 (${pct}%)</span>
              </div>
              <div class="vote-option-bar">
                <div class="vote-fill" style="width:${fillWidth};"></div>
                <span>${pct>10? pct+'%':''}</span>
              </div>
            </div>`;
          }).join('')}</div>
        </div>`;
      });
      wrap.innerHTML=html;
    }

    /**********************
     * Dashboard
     **********************/
    document.getElementById('btnLoadDashboard').addEventListener('click', loadDashboard);
    async function loadDashboard(){
      if(!state.lineId) return toast('請先登入');
      try{
        const r=await callAPI('getDashboardData',{});
        const d=r.data;
        const html=`
          <div class="row">
            <div class="col card" style="padding:10px;">
              <div class="muted">開放活動數</div><div style="font-size:22px;">${d.totalActivities}</div>
            </div>
            <div class="col card" style="padding:10px;">
              <div class="muted">我的報名數</div><div style="font-size:22px;">${d.myRegistrations}</div>
            </div>
            <div class="col card" style="padding:10px;">
              <div class="muted">志工時數</div><div style="font-size:22px;">${d.myVolunteerHours}</div>
            </div>
            <div class="col card" style="padding:10px;">
              <div class="muted">累計捐款</div><div style="font-size:22px;">${d.myDonationAmount}</div>
            </div>
          </div>
          <h3>最新活動</h3>
          <ul style="padding-left:18px;">
            ${d.recentActivity.map(a=>`<li>${escapeHtml(a.title)} <span class="muted">${a.date||''}</span></li>`).join('')}
          </ul>
        `;
        document.getElementById('dashboardContent').innerHTML=html;
      }catch(e){
        toast('載入 Dashboard 失敗：'+e.message);
      }
    }

    /**********************
     * 管理
     **********************/
    document.getElementById('btnAdminExportMembers').addEventListener('click', async ()=>{
      if(!state.isAdmin) return toast('非管理員');
      try{
        const r=await callAPI('exportMembers',{});
        document.getElementById('adminActionResult').innerHTML=`<a href="${r.data.fileUrl}" target="_blank">會員 CSV</a>`;
      }catch(e){
        toast('匯出失敗：'+e.message);
      }
    });
    document.getElementById('btnAdminExportFinance').addEventListener('click', async ()=>{
      if(!state.isAdmin) return toast('非管理員');
      try{
        const r=await callAPI('exportFinanceData',{});
        document.getElementById('adminActionResult').innerHTML=`
          <a href="${r.data.donationUrl}" target="_blank">捐款 CSV</a> ｜ 
          <a href="${r.data.expenseUrl}" target="_blank">支出 CSV</a>`;
      }catch(e){
        toast('匯出失敗：'+e.message);
      }
    });
    document.getElementById('btnAdminBackup').addEventListener('click', async ()=>{
      if(!state.isAdmin) return toast('非管理員');
      if(!confirm('確定建立系統備份？')) return;
      try{
        const r=await callAPI('backupSystem',{});
        document.getElementById('adminActionResult').innerHTML='備份完成：'+escapeHtml(r.data.name);
        toast('備份完成');
      }catch(e){
        toast('備份失敗：'+e.message);
      }
    });

    /**********************
     * 工具函式
     **********************/
    function escapeHtml(str){
      if(str===null||str===undefined) return '';
      return String(str).replace(/[&<>"']/g, s=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[s]);
    }
    function formatDate(d){
      if(!d) return '';
      try{
        d = (d instanceof Date)? d : new Date(d);
        if(isNaN(d.getTime())) return '';
        return d.toISOString().slice(0,10);
      }catch(_){ return ''; }
    }
    function formatDateTime(d){
      if(!d) return '';
      try{
        d = (d instanceof Date)? d : new Date(d);
        if(isNaN(d.getTime())) return '';
        return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+' '
            +String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
      }catch(_){ return ''; }
    }

    /**********************
     * 初始化流程
     **********************/
    async function initialLoad(){
      setUserStatus();
      loadCategories();
      // 預載活動
      loadActivities();
      // 非 LIFF 環境不自動 init LIFF（避免報錯）
      if(window.liff){
        // 可選：自動 init
        // initLIFF();
      }
    }
    initialLoad();

  </script>
</body>
</html>
