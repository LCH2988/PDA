<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>病友會 LIFF</title>
  <style>
    body { font-family: system-ui, -apple-system, 'Noto Sans TC', Arial; margin: 0; padding: 0; color: #222; }
    header { background: #16a34a; color: #fff; padding: 12px 16px; }
    main { padding: 16px; }
    .tabs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    .tab-btn { padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; background: #f8f8f8; cursor: pointer; }
    .tab-btn.active { background: #dcfce7; border-color: #86efac; }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 10px; background: #fff; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .row > * { flex: 1 1 220px; }
    label { display: block; font-size: 12px; color: #555; margin-bottom: 4px; }
    input, select, textarea, button { width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; }
    button.primary { background: #16a34a; color: #fff; border: none; }
    button.warn { background: #ef4444; color: #fff; border: none; }
    .muted { color: #64748b; font-size: 12px; }
    .grid { display: grid; gap: 8px; }
    .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .hidden { display: none; }
    .badge { display:inline-block; padding:2px 6px; font-size:12px; border-radius:999px; background:#e5e7eb; }
    .badge.success{ background:#dcfce7; color:#14532d; }
    .badge.warn{ background:#fee2e2; color:#7f1d1d; }
    .hr { height:1px; background:#e5e7eb; margin:12px 0; }
    .actions { display:flex; gap:8px; }
    .right { text-align:right; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .small { font-size: 12px; }
    .section-title{ font-weight:600; margin:8px 0; }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { border:1px solid #e5e7eb; padding:6px 8px; font-size: 13px; }
    .table th { background:#f8fafc; text-align:left; }
    .help { font-size:12px; color:#6b7280; }
    .pill { padding:4px 10px; border-radius: 999px; background:#eef2ff; color:#3730a3; display:inline-block; }
    .nowrap { white-space: nowrap; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <div>
        <div style="font-weight:700;">病友會 LIFF</div>
        <div id="userLabel" class="small muted"></div>
      </div>
      <div id="adminBadge" class="badge hidden">管理員</div>
    </div>
  </header>
  <main>
    <div class="tabs">
      <button class="tab-btn active" data-tab="me">我的</button>
      <button class="tab-btn" data-tab="activities">活動</button>
      <button class="tab-btn" data-tab="volunteer">志工</button>
      <button class="tab-btn" data-tab="donation">捐款</button>
      <button class="tab-btn admin-only hidden" data-tab="admin">管理</button>
      <button class="tab-btn admin-only hidden" data-tab="finance">財務</button>
      <button class="tab-btn admin-only hidden" data-tab="settings">設定</button>
    </div>

    <!-- 我的 -->
    <section id="tab-me">
      <div class="card">
        <div class="section-title">會員資料</div>
        <div class="row">
          <div>
            <label>姓名</label>
            <input id="realName" placeholder="真實姓名"/>
          </div>
          <div>
            <label>會員類型</label>
            <select id="memberType">
              <option value="">請選擇</option>
              <option value="病友">病友</option>
              <option value="家屬">家屬</option>
              <option value="志工">志工</option>
              <option value="一般">一般</option>
            </select>
          </div>
          <div>
            <label>手機</label>
            <input id="phone" />
          </div>
          <div>
            <label>Email</label>
            <input id="email" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>生日</label>
            <input id="birthday" type="date"/>
          </div>
          <div>
            <label>地址</label>
            <input id="address"/>
          </div>
        </div>
        <div class="hr"></div>
        <div class="actions">
          <button class="primary" id="btnRegister">註冊</button>
          <button id="btnUpdateProfile">更新資料</button>
        </div>
        <div id="meMsg" class="small muted"></div>
      </div>

      <div class="card">
        <div class="section-title">我的報名</div>
        <div id="myRegs"></div>
      </div>

      <div class="card">
        <div class="section-title">活動回饋</div>
        <div class="row">
          <div>
            <label>活動 ID</label>
            <input id="fbActivityId" placeholder="請填活動ID（已完成活動）"/>
          </div>
          <div>
            <label>評分</label>
            <select id="fbRating">
              <option value="5">5 - 很滿意</option>
              <option value="4">4 - 滿意</option>
              <option value="3">3 - 普通</option>
              <option value="2">2 - 待加強</option>
              <option value="1">1 - 不滿意</option>
            </select>
          </div>
        </div>
        <div>
          <label>意見</label>
          <textarea id="fbComment" rows="3" placeholder="歡迎提供寶貴建議"></textarea>
        </div>
        <div class="actions">
          <button class="primary" id="btnSubmitFeedback">送出回饋</button>
        </div>
        <div id="fbMsg" class="small muted"></div>
      </div>
    </section>

    <!-- 活動 -->
    <section id="tab-activities" class="hidden">
      <div class="card">
        <div class="section-title">活動列表</div>
        <div id="activityList"></div>
      </div>

      <div class="card admin-only hidden">
        <div class="section-title">新增活動</div>
        <div class="row">
          <div><label>標題</label><input id="actTitle"/></div>
          <div><label>日期</label><input id="actDate" type="date"/></div>
          <div><label>時間</label><input id="actTime" type="time"/></div>
          <div><label>地點</label><input id="actLocation"/></div>
          <div><label>名額</label><input id="actMax" type="number" min="1"/></div>
          <div><label>費用</label><input id="actFee" type="number" min="0" value="0"/></div>
        </div>
        <div><label>說明</label><textarea id="actDesc" rows="3"></textarea></div>
        <div class="actions">
          <button class="primary" id="btnCreateActivity">建立活動</button>
        </div>
        <div id="actMsg" class="small muted"></div>
      </div>
    </section>

    <!-- 志工 -->
    <section id="tab-volunteer" class="hidden">
      <div class="card">
        <div class="section-title">志工需求</div>
        <div id="volNeeds"></div>
      </div>
      <div class="card admin-only hidden">
        <div class="section-title">建立志工需求</div>
        <div class="row">
          <div><label>標題</label><input id="vnTitle"/></div>
          <div><label>日期</label><input id="vnDate" type="date"/></div>
          <div><label>時間</label><input id="vnTime" type="time"/></div>
          <div><label>需求人數</label><input id="vnCount" type="number" min="1"/></div>
          <div><label>服務時數</label><input id="vnHours" type="number" min="1"/></div>
        </div>
        <div><label>說明</label><textarea id="vnDesc" rows="3"></textarea></div>
        <div class="actions"><button class="primary" id="btnCreateVN">建立需求</button></div>
        <div id="vnMsg" class="small muted"></div>
      </div>
    </section>

    <!-- 捐款 -->
    <section id="tab-donation" class="hidden">
      <div class="card">
        <div class="section-title">我要捐款</div>
        <div class="row">
          <div>
            <label>類別</label>
            <select id="donCategory">
              <option value="一般捐款">一般捐款</option>
              <option value="活動贊助">活動贊助</option>
            </select>
          </div>
          <div>
            <label>金額</label>
            <input id="donAmount" type="number" min="1" placeholder="1000"/>
          </div>
          <div>
            <label>是否需要收據</label>
            <select id="donReceipt">
              <option value="yes">是</option>
              <option value="no">否</option>
            </select>
          </div>
        </div>
        <div>
          <label>備註</label>
          <textarea id="donDesc" rows="2"></textarea>
        </div>
        <div class="actions">
          <button class="primary" id="btnDonate">送出捐款</button>
        </div>
        <div id="donMsg" class="small muted"></div>
      </div>
    </section>

    <!-- 管理 -->
    <section id="tab-admin" class="hidden">
      <div class="card">
        <div class="section-title">儀表板</div>
        <div id="dash"></div>
      </div>

      <div class="card">
        <div class="section-title">管理員名單</div>
        <div class="row">
          <div><label>新增管理員 Line ID</label><input id="admNewId"/></div>
          <div><label>暱稱（選填）</label><input id="admNewName"/></div>
        </div>
        <div class="actions">
          <button id="btnAddAdmin">新增</button>
        </div>
        <div id="adminsList" class="grid"></div>
      </div>

      <div class="card">
        <div class="section-title">匯出</div>
        <div class="row">
          <div>
            <label>工作表名稱</label>
            <select id="exportSheet">
              <option value="會員資料">會員資料</option>
              <option value="活動資料">活動資料</option>
              <option value="活動報名">活動報名</option>
              <option value="志工需求">志工需求</option>
              <option value="志工記錄">志工記錄</option>
              <option value="捐款記錄">捐款記錄</option>
              <option value="支出記錄">支出記錄</option>
              <option value="收據記錄">收據記錄</option>
              <option value="活動回饋">活動回饋</option>
              <option value="系統日誌">系統日誌</option>
            </select>
          </div>
          <div class="actions">
            <button id="btnExportCsv">匯出 CSV</button>
          </div>
        </div>
        <div class="small help">匯出為文字檔，由前端下載。</div>
      </div>
    </section>

    <!-- 財務 -->
    <section id="tab-finance" class="hidden">
      <div class="card">
        <div class="section-title">支出審核</div>
        <div id="expList"></div>
      </div>

      <div class="card">
        <div class="section-title">捐款入帳確認</div>
        <div id="donationList"></div>
      </div>

      <div class="card">
        <div class="section-title">收據列表</div>
        <div id="receiptList"></div>
      </div>
    </section>

    <!-- 設定 -->
    <section id="tab-settings" class="hidden">
      <div class="card">
        <div class="section-title">系統設定</div>
        <div class="row">
          <div><label>收據範本 Doc ID</label><input id="setReceiptTpl"/></div>
          <div><label>支出憑證範本 Doc ID</label><input id="setExpenseTpl"/></div>
          <div><label>Drive 目錄 ID</label><input id="setDriveFolder"/></div>
        </div>
        <div>
          <label>Email 回覆樣板（HTML/文字皆可）</label>
          <textarea id="setEmailTpl" rows="4"></textarea>
        </div>
        <div class="row">
          <div>
            <label>收入類別（逗號分隔）</label>
            <input id="setIncomeCats" placeholder="一般捐款,活動贊助"/>
          </div>
          <div>
            <label>支出類別（逗號分隔）</label>
            <input id="setExpenseCats" placeholder="活動費用,行政支出,設備支出"/>
          </div>
        </div>
        <div class="actions">
          <button class="primary" id="btnSaveSettings">儲存設定</button>
        </div>
        <div id="setMsg" class="small muted"></div>
      </div>
    </section>

  </main>

  <script>
    // === 請修改為你的實際設定 ===
    const LIFF_ID = '1656516134-VaGgmaPm';
    const API_URL = 'https://script.google.com/macros/s/AKfycbz087WQIBsWHlU_XqqP5SsS8Gg6HUAZfnSHUram2_UBdrv67Y_SwJ5UBO83TmQwUGBT/exec'; // e.g. https://script.google.com/macros/s/AKfycb.../exec
    const API_ORIGIN = 'https://lch2988.github.io'; // 與後端 CORS 相同

    // === LIFF 狀態 ===
    let state = {
      profile: null,
      lineId: '',
      isAdmin: false,
      userInfo: null,
      settings: null,
    };

    // === 工具 ===
    function toast(elId, msg, isError=false) {
      const el = document.getElementById(elId);
      if(!el) return;
      el.textContent = msg;
      el.style.color = isError ? '#b91c1c' : '#334155';
      setTimeout(()=> { el.textContent = ''; }, 3500);
    }

    async function apiPost(action, data = {}) {
      const payload = { action, ...data };
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        mode: 'cors',
      });
      const json = await res.json().catch(()=>({ success:false, message:'無法解析伺服器回應'}));
      return json;
    }

    async function apiGet(params = {}) {
      const qs = new URLSearchParams(params).toString();
      const url = API_URL + (qs ? ('?' + qs) : '');
      const res = await fetch(url, { method: 'GET', mode: 'cors' });
      return res.json ? res.json() : res.text();
    }

    function fmtDate(d) {
      try {
        const dt = (d instanceof Date) ? d : new Date(d);
        if (isNaN(dt.getTime())) return '-';
        return dt.toLocaleString('zh-TW', { hour12:false });
      } catch { return '-'; }
    }

    function setAdminUI(isAdmin){
      document.getElementById('adminBadge').classList.toggle('hidden', !isAdmin);
      document.querySelectorAll('.admin-only').forEach(el=> el.classList.toggle('hidden', !isAdmin));
    }

    function switchTab(tab){
      document.querySelectorAll('.tab-btn').forEach(b=>{
        b.classList.toggle('active', b.dataset.tab === tab);
      });
      document.querySelectorAll('main > section').forEach(s=>{
        s.classList.toggle('hidden', s.id !== 'tab-'+tab);
      });

      // lazy load
      if(tab==='activities') loadActivities();
      if(tab==='volunteer') loadVolunteer();
      if(tab==='donation') {} // no-op
      if(tab==='admin') { loadDashboard(); loadAdmins(); }
      if(tab==='finance') { loadExpenses(); loadDonations(); loadReceipts(); }
      if(tab==='settings') { loadSettings(); }
      if(tab==='me') { loadMyRegistrations(); }
    }

    // === LIFF 初始化 ===
    async function initLIFF(){
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }
      const profile = await liff.getProfile();
      state.profile = profile;
      state.lineId = profile.userId;
      document.getElementById('userLabel').textContent = profile.displayName + ' (' + profile.userId + ')';

      // 取得用戶
      await loadUser();
    }

    // === 用戶 ===
    async function loadUser(){
      const r = await apiPost('getUserInfo', { lineId: state.lineId });
      if(r.success){
        state.userInfo = r.data;
        state.isAdmin = !!r.data.isAdmin;
        setAdminUI(state.isAdmin);
        // 帶入欄位
        document.getElementById('realName').value = r.data.realName || '';
        document.getElementById('memberType').value = r.data.memberType || '';
        document.getElementById('phone').value = r.data.phone || '';
        document.getElementById('email').value = r.data.email || '';
        document.getElementById('birthday').value = r.data.birthday ? toInputDate(r.data.birthday) : '';
        document.getElementById('address').value = r.data.address || '';
        document.getElementById('btnRegister').disabled = true; // 已註冊
      }else{
        // 未註冊
        state.isAdmin = false;
        setAdminUI(false);
        document.getElementById('btnRegister').disabled = false;
      }
      loadMyRegistrations();
    }

    function toInputDate(v){
      try{
        const d = new Date(v);
        if(isNaN(d.getTime())) return '';
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${dd}`;
      }catch{ return ''; }
    }

    async function registerUser(){
      const realName = document.getElementById('realName').value.trim();
      const memberType = document.getElementById('memberType').value;
      if(!realName || !memberType){
        toast('meMsg', '請填姓名與會員類型', true); return;
      }
      const r = await apiPost('registerUser', {
        lineId: state.lineId,
        lineName: state.profile?.displayName || '',
        realName, memberType
      });
      toast('meMsg', r.message || (r.success?'註冊成功':'註冊失敗'), !r.success);
      if(r.success) loadUser();
    }

    async function updateProfile(){
      const payload = {
        lineId: state.lineId,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        birthday: document.getElementById('birthday').value,
        address: document.getElementById('address').value,
        memberType: document.getElementById('memberType').value,
      };
      const r = await apiPost('updateProfile', payload);
      toast('meMsg', r.message || (r.success?'更新成功':'更新失敗'), !r.success);
      if(r.success) loadUser();
    }

    async function loadMyRegistrations(){
      if(!state.lineId) return;
      const r = await apiPost('getMyRegistrations', { lineId: state.lineId });
      const wrap = document.getElementById('myRegs');
      if(!r.success){ wrap.innerHTML = '<div class="muted small">載入失敗</div>'; return; }
      if(!r.data || !r.data.length){ wrap.innerHTML = '<div class="muted small">目前沒有報名</div>'; return; }
      wrap.innerHTML = r.data.map(o=>`
        <div class="card">
          <div><b>${o.activityTitle || '-'}</b></div>
          <div class="small muted">狀態：${o.status}　報名時間：${fmtDate(o.registrationTime)}</div>
          <div class="actions" style="margin-top:6px;">
            ${o.status==='已報名' ? `<button class="warn" onclick="cancelReg('${o.id}')">取消</button>` : ''}
          </div>
        </div>
      `).join('');
    }

    async function cancelReg(regId){
      if(!confirm('確定取消？')) return;
      const r = await apiPost('cancelRegistration', { lineId: state.lineId, registrationId: regId });
      alert(r.message || (r.success?'已取消':'取消失敗'));
      if(r.success){ loadMyRegistrations(); loadActivities(); }
    }

    // === 活動 ===
    async function loadActivities(){
      const r = await apiGet({ action:'getActivities' });
      const list = r.data || [];
      const el = document.getElementById('activityList');
      if(!list.length){ el.innerHTML = '<div class="muted small">目前沒有活動</div>'; return; }
      el.innerHTML = list.map(a=>{
        const statusBadge = a.status==='開放報名' ? '<span class="badge success">開放</span>' : '<span class="badge">關閉</span>';
        return `
          <div class="card">
            <div class="row">
              <div><b>${a.title}</b> ${statusBadge}</div>
              <div class="muted small">日期：${toInputDate(a.date)} 時間：${a.time||'-'} 地點：${a.location||'-'}</div>
              <div class="muted small">名額：${a.currentCount||0}/${a.maxParticipants||0} 費用：${a.fee||0}</div>
            </div>
            <div class="small">${a.description||''}</div>
            <div class="actions" style="margin-top:8px;">
              ${a.status==='開放報名' ? `<button class="primary" onclick="regActivity('${a.id}','${a.title.replace(/'/g,"\\'")}')">報名</button>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    async function regActivity(activityId, title){
      const r = await apiPost('registerActivity', { lineId: state.lineId, activityId });
      alert(r.message || (r.success?'報名成功':'報名失敗'));
      if(r.success){ loadActivities(); loadMyRegistrations(); }
    }

    async function createActivity(){
      const payload = {
        lineId: state.lineId,
        title: document.getElementById('actTitle').value,
        date: document.getElementById('actDate').value,
        time: document.getElementById('actTime').value,
        location: document.getElementById('actLocation').value,
        maxParticipants: Number(document.getElementById('actMax').value||0),
        fee: Number(document.getElementById('actFee').value||0),
        description: document.getElementById('actDesc').value
      };
      const r = await apiPost('createActivity', payload);
      toast('actMsg', r.message || (r.success?'建立成功':'建立失敗'), !r.success);
      if(r.success){ document.getElementById('actTitle').value=''; loadActivities(); }
    }

    // === 志工 ===
    async function loadVolunteer(){
      const r = await apiPost('getVolunteerData', { lineId: state.lineId });
      const el = document.getElementById('volNeeds');
      if(!r.success){ el.innerHTML = '<div class="muted small">載入失敗</div>'; return; }
      const needs = r.data.needs || [];
      if(!needs.length){ el.innerHTML = '<div class="muted small">目前沒有志工需求</div>'; return; }
      el.innerHTML = needs.map(n=>`
        <div class="card">
          <div><b>${n.title}</b> <span class="badge">${n.status}</span></div>
          <div class="small muted">日期：${toInputDate(n.date)} 時間：${n.time||'-'} 需求：${n.currentCount||0}/${n.needCount||0} 人　時數：${n.hours||0}</div>
          <div class="small">${n.description||''}</div>
          <div class="actions" style="margin-top:8px;">
            ${n.status==='開放報名' ? `<button class="primary" onclick="applyVolunteer('${n.id}')">報名志工</button>` : ''}
          </div>
        </div>
      `).join('');
    }

    async function applyVolunteer(needId){
      const r = await apiPost('applyVolunteer', { lineId: state.lineId, needId });
      alert(r.message || (r.success?'報名成功':'報名失敗'));
      if(r.success) loadVolunteer();
    }

    async function createVolunteerNeed(){
      const payload = {
        lineId: state.lineId,
        title: document.getElementById('vnTitle').value,
        date: document.getElementById('vnDate').value,
        time: document.getElementById('vnTime').value,
        needCount: Number(document.getElementById('vnCount').value||0),
        hours: Number(document.getElementById('vnHours').value||0),
        description: document.getElementById('vnDesc').value
      };
      const r = await apiPost('createVolunteerNeed', payload);
      toast('vnMsg', r.message || (r.success?'建立成功':'建立失敗'), !r.success);
      if(r.success){ document.getElementById('vnTitle').value=''; loadVolunteer(); }
    }

    // === 捐款 ===
    async function donate(){
      const payload = {
        lineId: state.lineId,
        category: document.getElementById('donCategory').value,
        amount: Number(document.getElementById('donAmount').value||0),
        needReceipt: document.getElementById('donReceipt').value==='yes',
        description: document.getElementById('donDesc').value
      };
      if(!(payload.amount>0)){ toast('donMsg','請輸入有效金額',true); return; }
      const r = await apiPost('createDonation', payload);
      if(r.success){
        let msg = '捐款成功';
        if(r.data?.receiptNumber) msg += `，收據編號：${r.data.receiptNumber}`;
        toast('donMsg', msg);
      }else{
        toast('donMsg', r.message || '捐款失敗', true);
      }
    }

    // === 管理：儀表板/管理員 ===
    async function loadDashboard(){
      const r = await apiGet({ action:'getAdminDashboard', lineId: state.lineId });
      const el = document.getElementById('dash');
      if(!r.success){ el.innerHTML = '<div class="muted small">載入失敗</div>'; return; }
      const s = r.data;
      el.innerHTML = `
        <div class="grid grid-3">
          <div class="card"><div class="small muted">會員總數</div><div style="font-size:20px; font-weight:700;">${s.totalMembers||0}</div></div>
          <div class="card"><div class="small muted">活動數</div><div style="font-size:20px; font-weight:700;">${s.totalActivities||0}</div></div>
          <div class="card"><div class="small muted">帳戶餘額</div><div style="font-size:20px; font-weight:700;">${s.accountBalance||0}</div></div>
        </div>
        <div class="hr"></div>
        <div class="grid grid-3">
          <div class="card"><div class="small muted">本月收入</div><div style="font-size:18px; font-weight:700;">${s.monthlyDonations||0}</div></div>
          <div class="card"><div class="small muted">本月支出</div><div style="font-size:18px; font-weight:700;">${s.monthlyExpenses||0}</div></div>
          <div class="card"><div class="small muted">待審核支出</div><div style="font-size:18px; font-weight:700;">${s.pendingExpenseApprovals||0}</div></div>
        </div>
        <div class="hr"></div>
        ${(s.alerts||[]).map(a=>`<div class="pill">${a.title}：${a.message}</div>`).join('') || '<div class="small muted">無提醒</div>'}
      `;
    }

    async function loadAdmins(){
      const r = await apiPost('getAllAdmins', { lineId: state.lineId });
      const el = document.getElementById('adminsList');
      if(!r.success){ el.innerHTML = '<div class="muted small">載入失敗</div>'; return; }
      const list = r.data || [];
      el.innerHTML = list.map(a=>`
        <div class="card">
          <div><b>${a.displayName}</b></div>
          <div class="small mono muted">${a.lineId}</div>
          <div class="small muted">建立者：${a.createdBy}　時間：${fmtDate(a.createdAt)}</div>
          <div class="actions" style="margin-top:6px;">
            <button class="warn" onclick="removeAdmin('${a.lineId}')">移除</button>
          </div>
        </div>
      `).join('');
    }

    async function addAdmin(){
      const newAdminLineId = document.getElementById('admNewId').value.trim();
      const newAdminName = document.getElementById('admNewName').value.trim();
      if(!newAdminLineId){ alert('請輸入 Line ID'); return; }
      const r = await apiPost('addAdmin', { lineId: state.lineId, newAdminLineId, newAdminName });
      alert(r.message || (r.success?'新增成功':'新增失敗'));
      if(r.success) loadAdmins();
    }

    async function removeAdmin(targetLineId){
      if(!confirm('確定移除該管理員？')) return;
      const r = await apiPost('removeAdmin', { lineId: state.lineId, targetLineId });
      alert(r.message || (r.success?'已移除':'移除失敗'));
      if(r.success) loadAdmins();
    }

    // === 管理：匯出 ===
    async function exportCsv(){
      const sheetName = document.getElementById('exportSheet').value;
      const r = await apiPost('exportSheetToCsv', { lineId: state.lineId, sheetName });
      if(!r.success){ alert(r.message || '匯出失敗'); return; }
      const blob = new Blob([r.data.csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${sheetName}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // === 財務：支出審核/捐款入帳/收據 ===
    async function loadExpenses(){
      const r = await apiPost('listExpenses', { lineId: state.lineId });
      const el = document.getElementById('expList');
      if(!r.success){ el.innerHTML = '<div class="muted small">載入失敗</div>'; return; }
      const list = r.data || [];
      el.innerHTML = list.map(e=>{
        const canApprove = e.status==='審核中';
        return `
          <div class="card">
            <div><b>${e.category}</b> <span class="badge ${e.status==='已核准'?'success':''}">${e.status}</span></div>
            <div class="small muted">申請人：${e.lineId} 金額：${e.amount} 說明：${e.description||'-'}</div>
            ${canApprove ? `
              <div class="row" style="margin-top:6px;">
                <div><label>付款日期</label><input id="payDate-${e.id}" type="date"/></div>
                <div><label>付款帳戶</label><input id="payAcct-${e.id}" placeholder="e.g. 012-3456789"/></div>
                <div>
                  <label>付款方式</label>
                  <select id="payMethod-${e.id}">
                    <option value="轉帳">轉帳</option>
                    <option value="現金">現金</option>
                    <option value="支票">支票</option>
                  </select>
                </div>
                <div><label>入帳日期（轉帳）</label><input id="bankDt-${e.id}" type="date"/></div>
              </div>
              <div class="actions" style="margin-top:6px;">
                <button class="primary" onclick="approveExpense('${e.id}')">核准</button>
                <button class="warn" onclick="rejectExpense('${e.id}')">拒絕</button>
              </div>
            `:''}
          </div>
        `;
      }).join('');
    }

    async function approveExpense(expenseId){
      const payload = {
        lineId: state.lineId,
        expenseId,
        decision: 'approve',
        paymentInfo: {
          paymentDate: (document.getElementById('payDate-'+expenseId).value || ''),
          paymentAccount: (document.getElementById('payAcct-'+expenseId).value || ''),
          paymentMethod: (document.getElementById('payMethod-'+expenseId).value || ''),
          bankTransferDate: (document.getElementById('bankDt-'+expenseId).value || '')
        }
      };
      const r = await apiPost('approveExpenseWithPayment', payload);
      alert(r.message || (r.success?'核准完成':'核准失敗'));
      if(r.success) loadExpenses();
    }

    async function rejectExpense(expenseId){
      const r = await apiPost('approveExpenseWithPayment', { lineId: state.lineId, expenseId, decision: 'reject' });
      alert(r.message || (r.success?'已拒絕':'拒絕失敗'));
      if(r.success) loadExpenses();
    }

    async function loadDonations(){
      const r = await apiPost('listDonations', { lineId: state.lineId });
      const el = document.getElementById('donationList');
      if(!r.success){ el.innerHTML = '<div class="muted small">載入失敗</div>'; return; }
      const list = r.data || [];
      el.innerHTML = list.map(d=>`
        <div class="card">
          <div><b>${d.category}</b> <span class="badge">${d.status}</span></div>
          <div class="small muted">捐款人：${d.lineId} 金額：${d.amount} 收據：${d.receiptNumber||'-'}</div>
          <div class="actions" style="margin-top:6px;">
            ${d.status!=='已入帳' ? `<button class="primary" onclick="confirmDonation('${d.id}')">確認入帳</button>` : '<span class="small muted">已入帳</span>'}
          </div>
        </div>
      `).join('');
    }

    async function confirmDonation(donationId){
      const bankDate = prompt('請輸入入帳日期（YYYY-MM-DD），留空為今日', '');
      const bankAccount = prompt('請輸入入帳帳戶（選填）', '');
      const payload = { lineId: state.lineId, donationId, bankDate: bankDate || undefined, bankAccount: bankAccount || '' };
      const r = await apiPost('confirmDonationIncome', payload);
      alert(r.message || (r.success?'已入帳':'入帳失敗'));
      if(r.success) loadDonations();
    }

    async function loadReceipts(){
      const r = await apiPost('listReceipts', { lineId: state.lineId });
      const el = document.getElementById('receiptList');
      if(!r.success){ el.innerHTML = '<div class="muted small">載入失敗</div>'; return; }
      const list = r.data || [];
      if(!list.length){ el.innerHTML = '<div class="muted small">目前沒有收據</div>'; return; }
      const thead = `<tr><th>收據號</th><th>對象</th><th>金額</th><th>日期</th><th>狀態</th><th>檔案</th></tr>`;
      const rows = list.map(x=>`
        <tr>
          <td class="mono nowrap">${x.receiptNumber||'-'}</td>
          <td class="mono">${x.lineId||'-'}</td>
          <td>${x.amount||0}</td>
          <td>${x.issueDate ? fmtDate(x.issueDate) : '-'}</td>
          <td>${x.status||'-'}</td>
          <td>${x.pdfUrl ? `<a href="${x.pdfUrl}" target="_blank">查看</a>` : '-'}</td>
        </tr>
      `).join('');
      el.innerHTML = `<div class="small muted" style="margin-bottom:6px;">共 ${list.length} 筆</div><table class="table"><thead>${thead}</thead><tbody>${rows}</tbody></table>`;
    }

    // === 設定 ===
    async function loadSettings(){
      const r = await apiPost('getSettings', { lineId: state.lineId });
      if(!r.success){ toast('setMsg','載入失敗',true); return; }
      state.settings = r.data;
      document.getElementById('setReceiptTpl').value = r.data.receiptTemplateDocId || '';
      document.getElementById('setExpenseTpl').value = r.data.expenseVoucherTemplateDocId || '';
      document.getElementById('setDriveFolder').value = r.data.driveFolderId || '';
      document.getElementById('setEmailTpl').value = r.data.emailReplyTemplate || '';
      document.getElementById('setIncomeCats').value = (r.data.incomeCategories||[]).join(',');
      document.getElementById('setExpenseCats').value = (r.data.expenseCategories||[]).join(',');
    }

    async function saveSettings(){
      const payload = {
        lineId: state.lineId,
        receiptTemplateDocId: document.getElementById('setReceiptTpl').value.trim(),
        expenseVoucherTemplateDocId: document.getElementById('setExpenseTpl').value.trim(),
        driveFolderId: document.getElementById('setDriveFolder').value.trim(),
        emailReplyTemplate: document.getElementById('setEmailTpl').value,
        incomeCategories: document.getElementById('setIncomeCats').value.split(',').map(s=>s.trim()).filter(Boolean),
        expenseCategories: document.getElementById('setExpenseCats').value.split(',').map(s=>s.trim()).filter(Boolean),
      };
      const r = await apiPost('updateSettings', payload);
      toast('setMsg', r.message || (r.success?'已儲存':'儲存失敗'), !r.success);
      if(r.success) loadSettings();
    }

    // === 綁定 UI ===
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('.tab-btn').forEach(b=>{
        b.addEventListener('click', ()=> switchTab(b.dataset.tab));
      });
      document.getElementById('btnRegister').addEventListener('click', registerUser);
      document.getElementById('btnUpdateProfile').addEventListener('click', updateProfile);
      document.getElementById('btnSubmitFeedback').addEventListener('click', async ()=>{
        const r = await apiPost('submitFeedback', {
          lineId: state.lineId,
          activityId: document.getElementById('fbActivityId').value.trim(),
          rating: Number(document.getElementById('fbRating').value),
          comment: document.getElementById('fbComment').value
        });
        toast('fbMsg', r.message || (r.success?'已送出':'送出失敗'), !r.success);
        if(r.success){
          document.getElementById('fbActivityId').value='';
          document.getElementById('fbComment').value='';
        }
      });

      document.getElementById('btnCreateActivity').addEventListener('click', createActivity);
      document.getElementById('btnCreateVN').addEventListener('click', createVolunteerNeed);
      document.getElementById('btnDonate').addEventListener('click', donate);
      document.getElementById('btnAddAdmin').addEventListener('click', addAdmin);
      document.getElementById('btnExportCsv').addEventListener('click', exportCsv);
      document.getElementById('btnSaveSettings').addEventListener('click', saveSettings);

      // 初始化
      initLIFF().catch(err=>{
        alert('LIFF 初始化失敗：' + err);
      });
    });
  </script>
</body>
</html>
