<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>帕金森病友會管理系統</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<style>
  :root{
    --base-font-size:18px;
    --heading-color:#222;
  }
  body{
    font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial,sans-serif;
    font-size: var(--base-font-size);
    line-height:1.55;
    background: linear-gradient(135deg,#667eea,#764ba2);
    min-height:100vh;
    padding:18px;
    color:#222;
  }
  h1,h2,h3,h4,h5{
    color:var(--heading-color);
    line-height:1.3;
  }
  h1{font-size:2.2rem;}
  h2{font-size:1.9rem;}
  h3{font-size:1.55rem;}
  h4{font-size:1.35rem;}
  h5{font-size:1.18rem;}
  .nav-pills .nav-link{
    font-size:1.05rem;
    padding:12px 22px;
  }
  .btn{
    font-size:1rem;
    padding:12px 22px;
  }
  .form-control,.form-select{
    font-size:1rem;
    padding:12px 14px;
  }
  .table td,.table th{
    font-size:0.95rem;
    vertical-align:middle;
  }
  .small{font-size:0.85rem !important;}
  .user-info-bar{font-size:1rem;}
  .stat-card h3{font-size:1.9rem;}
  
  @media (max-width: 768px){
    body{font-size:17px;}
    .nav-pills .nav-link{font-size:1rem;}
    h1{font-size:1.9rem;}
    h2{font-size:1.6rem;}
    h3{font-size:1.4rem;}
    .stat-card h3{font-size:1.6rem;}
  }
  
  .container{max-width:1250px;margin:0 auto;}
  .main-header,.nav-container,.content-card{
    background:rgba(255,255,255,0.94);
    backdrop-filter:blur(10px);
    border-radius:16px;
    padding:28px;
    margin-bottom:18px;
    box-shadow:0 8px 24px rgba(0,0,0,0.18);
  }
  .header-content{
    background:linear-gradient(135deg,#4CAF50,#45a049);
    color:#fff;
    padding:26px;
    margin:-28px -28px 20px -28px;
    border-radius:16px 16px 12px 12px;
  }
  .user-info-bar{
    display:flex;gap:18px;align-items:center;
    background:#fff;
    padding:14px 20px;
    border-radius:40px;
    box-shadow:0 4px 14px rgba(0,0,0,0.08);
    margin-top:8px;
  }
  .user-avatar{
    width:54px;height:54px;
    border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);
    display:flex;align-items:center;justify-content:center;
    color:#fff;font-size:1.4rem;font-weight:600;
  }
  .quick-actions{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));}
  .quick-btn{
    background:#fff;
    border:2px solid #e2e8f0;
    border-radius:18px;
    padding:22px 12px;
    text-align:center;
    font-weight:600;
    cursor:pointer;
    transition:.3s;
    font-size:1rem;
  }
  .quick-btn i{font-size:2.1rem;margin-bottom:10px;display:block;}
  .quick-btn:hover{
    border-color:#4CAF50;
    color:#4CAF50;
    box-shadow:0 10px 24px rgba(76,175,80,.28);
    transform:translateY(-4px);
  }
  .stat-card{
    border-radius:18px;
    padding:24px;
    color:#fff;
    text-align:center;
    box-shadow:0 6px 18px rgba(0,0,0,0.18);
  }
  .activity-item{
    background:#f8fafc;
    border-radius:14px;
    padding:20px;
    margin-bottom:14px;
    border-left:5px solid #4CAF50;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
    font-size:0.97rem;
  }
  .activity-item strong{font-size:1.05rem;}
  .status-badge{
    display:inline-block;
    padding:6px 12px;
    border-radius:18px;
    font-size:0.75rem;
    font-weight:600;
    letter-spacing:.5px;
    margin-top:4px;
  }
  .status-開放報名,.status-active{background:#d4edda;color:#155724;}
  .status-已報名{background:#d1ecf1;color:#0c5460;}
  .status-已取消,.status-已拒絕{background:#f8d7da;color:#721c24;}
  .status-已完成{background:#e2e3ff;color:#383d41;}
  .status-審核中,.status-報名截止{background:#fff3cd;color:#856404;}
  .status-已核准{background:#d4edda;color:#155724;}
  .btn.loading{position:relative;color:transparent !important;}
  .btn.loading:after{
    content:'';
    position:absolute;top:50%;left:50%;width:20px;height:20px;
    margin:-10px;border:3px solid rgba(255,255,255,0.5);
    border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg);}}
  .notification{
    position:fixed;top:20px;right:20px;
    background:#fff;padding:16px 20px;
    border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.15);
    transform:translateX(420px);transition:.4s;
    max-width:380px;font-size:1rem;
    border-left:6px solid #4CAF50;z-index:2000;
  }
  .notification.show{transform:translateX(0);}
  .notification.success{background:#d4edda;color:#155724;border-left-color:#4CAF50;}
  .notification.error{background:#f8d7da;color:#721c24;border-left-color:#dc3545;}
  .notification.warning{background:#fff3cd;color:#856404;border-left-color:#ffc107;}
  .notification.info{background:#d1ecf1;color:#0c5460;border-left-color:#17a2b8;}
</style>
</head>
<body>
<div class="container">
  <div class="main-header">
    <div class="header-content">
      <h1 class="mb-2"><i class="bi bi-heart-pulse-fill me-2"></i>帕金森病友會管理系統</h1>
      <p class="mb-0" style="font-size:1.05rem;">關懷・支持・共好</p>
    </div>
    <div id="userInfoBar" class="user-info-bar" style="display:none;">
      <div class="user-avatar" id="userAvatar">?</div>
      <div>
        <div class="fw-bold" id="userName">載入中...</div>
        <div class="small text-muted" id="userLineName"></div>
        <div class="small text-muted" id="userRole">會員</div>
      </div>
      <div class="ms-auto">
        <button class="btn btn-sm btn-outline-secondary" onclick="refreshData()" title="刷新"><i class="bi bi-arrow-clockwise"></i></button>
      </div>
    </div>
  </div>

  <div id="notificationContainer"></div>

  <!-- 導航選單 -->
  <div class="nav-container">
    <ul class="nav nav-pills flex-wrap">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#dashboard">🏠 儀表板</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#profile">👤 個人資料</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#activities">🎪 活動管理</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#volunteer">🤝 志工服務</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#finance">💰 財務管理</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#feedback">💬 活動回饋</button></li>
      <li class="nav-item admin-only" style="display:none;"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#admin">⚙️ 系統管理</button></li>
    </ul>
  </div>

  <div class="tab-content">
    <!-- Dashboard -->
    <div class="tab-pane fade show active" id="dashboard">
      <div class="content-card">
        <div class="quick-actions mb-4">
          <div class="quick-btn" onclick="showTab('profile')"><i class="bi bi-person-check"></i>更新資料</div>
          <div class="quick-btn" onclick="showTab('activities')"><i class="bi bi-calendar-plus"></i>報名活動</div>
          <div class="quick-btn" onclick="showNewDonationModal()"><i class="bi bi-heart-fill"></i>愛心捐款</div>
          <div class="quick-btn" onclick="showTab('volunteer')"><i class="bi bi-hand-thumbs-up"></i>志工服務</div>
        </div>
        <div class="row g-3 mb-4" id="dashboardStats">
          <div class="col-12 text-center text-muted">載入中...</div>
        </div>
        <div>
          <h5 class="mb-3"><i class="bi bi-clock-history me-2"></i>最近活動</h5>
          <div id="recentActivity" class="mb-2 text-muted">載入中...</div>
        </div>
      </div>
    </div>

    <!-- Profile -->
    <div class="tab-pane fade" id="profile">
      <div class="content-card">
        <h3 class="mb-3"><i class="bi bi-person me-2"></i>個人資料管理</h3>
        <div id="registrationSection">
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>請先完成註冊以使用完整功能。
          </div>
          <form id="registrationForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="realName" name="realName" required>
                <label for="realName">真實姓名 *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="memberType" name="memberType" required>
                  <option value="">選擇</option>
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                  <option value="醫護">醫護人員</option>
                  <option value="支持者">支持者</option>
                </select>
                <label for="memberType">會員類別 *</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-primary" type="submit"><i class="bi bi-check-circle me-1"></i>完成註冊</button>
            </div>
          </form>
        </div>

        <div id="profileSection" style="display:none;">
          <form id="profileForm" class="row g-3">
            <div class="col-md-4">
              <div class="form-floating">
                <input type="text" class="form-control" id="profileRealName" readonly>
                <label for="profileRealName">真實姓名</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="text" class="form-control" id="lineName" readonly>
                <label for="lineName">LINE 名稱</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <select class="form-select" id="profileMemberType">
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                  <option value="醫護">醫護人員</option>
                  <option value="支持者">支持者</option>
                </select>
                <label for="profileMemberType">會員類別</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="tel" class="form-control" id="phone">
                <label for="phone">聯絡電話</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="email" class="form-control" id="email">
                <label for="email">電子郵件</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="date" class="form-control" id="birthday">
                <label for="birthday">生日</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="address" style="height:100px;"></textarea>
                <label for="address">通訊地址</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-primary" type="submit"><i class="bi bi-save me-1"></i>更新資料</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Activities -->
    <div class="tab-pane fade" id="activities">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="mb-0"><i class="bi bi-calendar-event me-2"></i>活動管理</h3>
          <div class="admin-only" style="display:none;">
            <button class="btn btn-success btn-sm" onclick="showNewActivityModal()"><i class="bi bi-plus-circle me-1"></i>新增活動</button>
          </div>
        </div>
        <div id="activitiesList" class="mb-4 text-muted">載入活動...</div>
        <div>
          <h5 class="mb-3"><i class="bi bi-clipboard-check me-2"></i>我的活動報名</h5>
          <div id="myRegistrations" class="text-muted">載入中...</div>
        </div>
      </div>
    </div>

    <!-- Volunteer -->
    <div class="tab-pane fade" id="volunteer">
      <div class="content-card">
        <h3 class="mb-3"><i class="bi bi-heart me-2"></i>志工服務</h3>
        <div class="row g-3 mb-4">
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);"><h3 id="volunteerHours">0</h3><p class="mb-0">服務時數</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#ffc107,#e0a800);"><h3 id="volunteerActivities">0</h3><p class="mb-0">參與次數</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#4CAF50,#45a049);"><h3 id="volunteerRank">-</h3><p class="mb-0">排名</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#dc3545,#b52a36);"><h3 id="availableNeeds">0</h3><p class="mb-0">可報名</p></div></div>
        </div>
        <h5 class="mb-3"><i class="bi bi-exclamation-circle me-2"></i>志工需求</h5>
        <div id="volunteerNeeds" class="mb-4 text-muted">載入中...</div>
        <h5 class="mb-3"><i class="bi bi-journal-text me-2"></i>我的志工記錄</h5>
        <div id="myVolunteerRecords" class="text-muted">載入中...</div>
        <div class="admin-only mt-4" style="display:none;">
          <button class="btn btn-success btn-sm" onclick="showNewVolunteerNeedModal()"><i class="bi bi-plus-circle me-1"></i>新增志工需求</button>
        </div>
      </div>
    </div>

    <!-- Finance -->
    <div class="tab-pane fade" id="finance">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="mb-0"><i class="bi bi-cash-coin me-2"></i>財務管理</h3>
          <div>
            <button class="btn btn-success btn-sm me-2" onclick="showNewDonationModal()"><i class="bi bi-heart-fill me-1"></i>捐款</button>
            <button class="btn btn-warning btn-sm" onclick="showNewExpenseModal()"><i class="bi bi-receipt me-1"></i>支出申請</button>
          </div>
        </div>
        <div class="row g-3 mb-4">
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#4CAF50,#45a049);"><h3 id="myDonationAmount">NT$ 0</h3><p class="mb-0">捐款總額</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);"><h3 id="myDonationCount">0</h3><p class="mb-0">捐款次數</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#ffc107,#e0a800);"><h3 id="myExpenseAmount">NT$ 0</h3><p class="mb-0">支出申請額</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#dc3545,#b52a36);"><h3 id="pendingExpenses">0</h3><p class="mb-0">待審核</p></div></div>
        </div>
        <h5 class="mb-2"><i class="bi bi-heart-fill me-2"></i>我的捐款</h5>
        <div id="donationHistory" class="mb-4 text-muted">載入中...</div>
        <h5 class="mb-2"><i class="bi bi-receipt me-2"></i>我的支出申請</h5>
        <div id="expenseHistory" class="mb-4 text-muted">載入中...</div>
        <div class="admin-only mt-4" style="display:none;">
          <h5 class="mb-3"><i class="bi bi-graph-up me-2"></i>財務總覽（管理員）</h5>
          <div class="row g-3 mb-3">
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#4CAF50,#45a049);"><h3 id="totalIncome">NT$ 0</h3><p class="mb-0">總收入</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#dc3545,#b52a36);"><h3 id="totalExpense">NT$ 0</h3><p class="mb-0">總支出</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);"><h3 id="currentBalance">NT$ 0</h3><p class="mb-0">目前餘額</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#ffc107,#e0a800);"><h3 id="monthlyDonations">NT$ 0</h3><p class="mb-0">本月捐款</p></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Feedback -->
    <div class="tab-pane fade" id="feedback">
      <div class="content-card">
        <h3 class="mb-3"><i class="bi bi-chat-dots me-2"></i>活動回饋</h3>
        <div class="card mb-4">
          <div class="card-header text-white" style="background:linear-gradient(135deg,#4CAF50,#45a049);">
            <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>新增回饋</h5>
          </div>
          <div class="card-body">
            <form id="feedbackForm" class="row g-3">
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="feedbackActivity" required>
                    <option value="">請選擇活動</option>
                  </select>
                  <label for="feedbackActivity">活動 *</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="feedbackRating" required>
                    <option value="">評分</option>
                    <option value="5">5 - 非常滿意</option>
                    <option value="4">4 - 滿意</option>
                    <option value="3">3 - 普通</option>
                    <option value="2">2 - 不滿意</option>
                    <option value="1">1 - 非常不滿意</option>
                  </select>
                  <label for="feedbackRating">評分 *</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <textarea class="form-control" id="feedbackComment" style="height:120px;" required></textarea>
                  <label for="feedbackComment">意見 / 建議 *</label>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-primary" type="submit"><i class="bi bi-send me-1"></i>提交</button>
              </div>
            </form>
          </div>
        </div>
        <h5 class="mb-3"><i class="bi bi-chat-left-text me-2"></i>我的回饋</h5>
        <div id="myFeedback" class="mb-4 text-muted">載入中...</div>
        <div class="admin-only" style="display:none;">
          <h5 class="mb-3"><i class="bi bi-chat-square-dots me-2"></i>全部回饋（管理員）</h5>
          <div id="allFeedback" class="text-muted">載入中...</div>
        </div>
      </div>
    </div>

    <!-- Admin -->
    <div class="tab-pane fade" id="admin">
      <div class="content-card">
        <h3 class="mb-3"><i class="bi bi-gear me-2"></i>系統管理</h3>
        <div class="row g-3">
          <div class="col-md-6">
            <h5>會員管理</h5>
            <div id="adminMemberList" class="text-muted">載入中...</div>
          </div>
          <div class="col-md-6">
            <h5>活動管理</h5>
            <div id="adminActivityList" class="text-muted">載入中...</div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- tab-content -->
</div>

<div id="modalContainer"></div>

<script>
  // ========== 設定 ==========
  const CONFIG = {
    LIFF_ID: '請替換為您的LIFF_ID',  // TODO: 替換為您的 LIFF ID
    API_BASE_URL: '請替換為您的GAS_WEB_APP_URL', // TODO: 替換為您的 Google Apps Script Web App URL
    API_KEY: 'AAbb8520258185202581'
  };

  // ========== 全域狀態 ==========
  let userProfile = null;
  let currentUser = null;
  let isAdmin = false;
  let allActivities = [];

  // ========== 工具函數 ==========
  const formatDate = d => {
    if(!d) return '-';
    const dt = new Date(d);
    return isNaN(dt)? '-' : dt.toLocaleDateString('zh-TW');
  };
  const formatDateTime = d => {
    if(!d) return '-';
    const dt = new Date(d);
    return isNaN(dt)? '-' : dt.toLocaleString('zh-TW');
  };
  const formatCurrency = n =>
    new Intl.NumberFormat('zh-TW',{style:'currency',currency:'TWD',minimumFractionDigits:0}).format(n||0);

  function showNotification(msg,type='success',ms=3500){
    const wrap = document.getElementById('notificationContainer');
    const el = document.createElement('div');
    el.className = `notification ${type}`;
    el.innerHTML = `
      <div class="d-flex justify-content-between align-items-start">
        <span>${msg}</span>
        <button style="background:none;border:none;font-size:20px;line-height:1;" onclick="this.closest('.notification').remove()">&times;</button>
      </div>`;
    wrap.appendChild(el);
    requestAnimationFrame(()=>el.classList.add('show'));
    setTimeout(()=>{
      el.classList.remove('show');
      setTimeout(()=>el.remove(),400);
    },ms);
  }

  function setButtonLoading(btn,loading=true){
    if(!btn) return;
    if(loading){
      if(!btn.dataset.originalText) btn.dataset.originalText = btn.innerHTML;
      btn.classList.add('loading');
      btn.disabled = true;
    }else{
      btn.classList.remove('loading');
      btn.disabled = false;
      if(btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText;
    }
  }

  async function callAPI(action,data={},retries=1){
    const payload = {
      action,
      apiKey: CONFIG.API_KEY,
      timestamp: Date.now(),
      ...data
    };
    let lastErr;
    for(let i=0;i<=retries;i++){
      try{
        const res = await fetch(CONFIG.API_BASE_URL,{
          method:'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });
        const text=await res.text();
        let json;
        try{ json=JSON.parse(text); }catch(e){ throw new Error('回應非 JSON: '+text.slice(0,120)); }
        if(!json.success) throw new Error(json.message||'API 錯誤');
        return json;
      }catch(err){
        lastErr=err;
        if(i<retries) await new Promise(r=>setTimeout(r,400*(i+1)));
      }
    }
    throw lastErr;
  }

  // ========== LIFF 初始化 ==========
  async function initializeLiff(){
    try{
      // 開發模式：跳過 LIFF 初始化
      if(CONFIG.LIFF_ID === '1656516134-VaGgmaPm'){
        showNotification('開發模式：請設定正確的 LIFF_ID','warning');
        // 模擬用戶資料
        userProfile = {
          userId: 'test-user-123',
          displayName: '測試用戶'
        };
        document.getElementById('userInfoBar').style.display='flex';
        document.getElementById('userLineName').textContent='LINE：測試用戶';
        document.getElementById('userName').textContent='測試用戶';
        document.getElementById('userAvatar').textContent='測';
        await loadUserData();
        await loadDashboard();
        return;
      }

      await liff.init({ liffId: CONFIG.LIFF_ID });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      userProfile = await liff.getProfile();
      const bar=document.getElementById('userInfoBar');
      bar.style.display='flex';
      document.getElementById('userLineName').textContent='LINE：'+(userProfile.displayName||'');
      document.getElementById('userName').textContent=userProfile.displayName||'會員';
      document.getElementById('userAvatar').textContent=(userProfile.displayName||'?').charAt(0);
      await loadUserData();
      await loadDashboard();
      showNotification('系統初始化完成','success');
    }catch(err){
      console.error(err);
      showNotification('初始化失敗：'+err.message,'error');
    }
  }

  // ========== 使用者相關 ==========
  async function loadUserData(){
    try{
      const r=await callAPI('getUserInfo',{ lineId:userProfile.userId });
      if(r.success){
        currentUser=r.data;
        isAdmin=!!currentUser.isAdmin;
        updateUserUI();
      }else{
        showRegistrationForm();
      }
    }catch{
      showRegistrationForm();
    }
  }

  function updateUserUI(){
    if(!currentUser) return;
    document.getElementById('userName').textContent =
      currentUser.realName || currentUser.lineName || userProfile.displayName || '會員';
    document.getElementById('userRole').textContent = currentUser.memberType || '會員';
    document.getElementById('userAvatar').textContent =
      (currentUser.realName || currentUser.lineName || userProfile.displayName || '?').charAt(0);
    document.querySelectorAll('.admin-only').forEach(el=> el.style.display = isAdmin ? 'block':'none');
    updateProfileSection();
  }

  function showRegistrationForm(){
    document.getElementById('registrationSection').style.display='block';
    document.getElementById('profileSection').style.display='none';
  }

  function updateProfileSection(){
    if(!currentUser) return;
    document.getElementById('registrationSection').style.display='none';
    document.getElementById('profileSection').style.display='block';
    document.getElementById('profileRealName').value=currentUser.realName||'';
    document.getElementById('lineName').value=currentUser.lineName||userProfile.displayName||'';
    document.getElementById('phone').value=currentUser.phone||'';
    document.getElementById('email').value=currentUser.email||'';
    document.getElementById('birthday').value=currentUser.birthday||'';
    document.getElementById('profileMemberType').value=currentUser.memberType||'病友';
    document.getElementById('address').value=currentUser.address||'';
  }

  // 註冊表單事件
  document.getElementById('registrationForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    const btn=e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn,true);
    try{
      await callAPI('registerUser',{
        lineId:userProfile.userId,
        lineName:userProfile.displayName,
        realName:fd.get('realName'),
        memberType:fd.get('memberType')
      });
      showNotification('註冊成功','success');
      await loadUserData();
    }catch(err){
      showNotification('註冊失敗：'+err.message,'error');
    }finally{ setButtonLoading(btn,false); }
  });

  // 個人資料更新表單事件
  document.getElementById('profileForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const btn=e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn,true);
    try{
      await callAPI('updateProfile',{
        lineId:userProfile.userId,
        phone:document.getElementById('phone').value,
        email:document.getElementById('email').value,
        birthday:document.getElementById('birthday').value,
        memberType:document.getElementById('profileMemberType').value,
        address:document.getElementById('address').value
      });
      showNotification('更新成功','success');
      await loadUserData();
    }catch(err){
      showNotification('更新失敗：'+err.message,'error');
    }finally{ setButtonLoading(btn,false); }
  });

  // ========== Dashboard ==========
  async function loadDashboard(){
    try{
      const r=await callAPI('getDashboardData',{ lineId:userProfile?.userId });
      const d=r.data;
      document.getElementById('dashboardStats').innerHTML=`
        <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#4CAF50,#45a049);"><h3>${d.totalActivities||0}</h3><p class="mb-0">可報名活動</p></div></div>
        <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);"><h3>${d.myRegistrations||0}</h3><p class="mb-0">我的報名</p></div></div>
        <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#ffc107,#e0a800);"><h3>${d.myVolunteerHours||0}</h3><p class="mb-0">志工時數</p></div></div>
        <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#dc3545,#b52a36);"><h3>${formatCurrency(d.myDonationAmount||0).replace('NT$','')}</h3><p class="mb-0">捐款總額</p></div></div>
      `;
      renderRecentActivity(d.recentActivity||[]);
    }catch(err){
      document.getElementById('dashboardStats').innerHTML=`<div class="col-12 text-center text-danger">${err.message}</div>`;
    }
  }

  function renderRecentActivity(list){
    const c=document.getElementById('recentActivity');
    if(!list.length){ c.textContent='暫無最近活動'; return; }
    c.innerHTML=list.map(a=>`
      <div class="activity-item">
        <div class="d-flex justify-content-between">
          <div>
            <strong>${a.title||''}</strong>
            <div class="small text-muted">${a.description||''}</div>
            <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(a.date)}</small>
          </div>
          <span class="status-badge status-${(a.status||'').trim()}">${a.status||''}</span>
        </div>
      </div>`).join('');
  }

  // ========== 活動管理 ==========
  async function loadActivities(){
    try{
      const r=await callAPI('getActivities');
      allActivities=r.data||[];
      renderActivities(allActivities);
    }catch(err){
      document.getElementById('activitiesList').innerHTML='<div class="text-danger text-center">'+err.message+'</div>';
    }
  }

  function renderActivities(list){
    const c=document.getElementById('activitiesList');
    if(!list.length){ c.innerHTML='<p class="text-muted mb-0">目前沒有活動</p>'; return; }
    c.innerHTML=list.map(a=>`
      <div class="activity-item">
        <div class="row">
          <div class="col-md-8">
            <strong>${a.title}</strong>
            <p class="mb-2 small text-muted">${a.description||''}</p>
            <div class="d-flex flex-wrap gap-3 small text-muted">
              <span><i class="bi bi-calendar me-1"></i>${formatDate(a.date)}</span>
              <span><i class="bi bi-clock me-1"></i>${a.time||'-'}</span>
              <span><i class="bi bi-geo-alt me-1"></i>${a.location||'-'}</span>
              <span><i class="bi bi-people me-1"></i>${a.currentCount||0}/${a.maxParticipants||0}</span>
            </div>
          </div>
          <div class="col-md-4 text-end">
            <span class="status-badge status-${a.status}">${a.status}</span><br>
            <span class="fw-bold text-primary d-inline-block mt-2">${formatCurrency(a.fee||0)}</span><br>
            ${(a.status==='開放報名')? `<button class="btn btn-primary btn-sm mt-2" onclick="registerActivity('${a.id}')"><i class="bi bi-plus-circle me-1"></i>報名</button>`:''}
          </div>
        </div>
      </div>`).join('');
  }

  async function registerActivity(id){
    if(!currentUser){ showNotification('請先註冊','warning'); return; }
    try{
      await callAPI('registerActivity',{ lineId:userProfile.userId, activityId:id });
      showNotification('報名成功','success');
      await loadActivities();
      await loadMyRegistrations();
      await loadDashboard();
    }catch(err){
      showNotification('報名失敗：'+err.message,'error');
    }
  }

  async function loadMyRegistrations(){
    if(!currentUser) return;
    try{
      const r=await callAPI('getMyRegistrations',{ lineId:userProfile.userId });
      renderMyRegistrations(r.data||[]);
    }catch(err){
      document.getElementById('myRegistrations').innerHTML='<div class="text-danger">'+err.message+'</div>';
    }
  }

  function renderMyRegistrations(list){
    const c=document.getElementById('myRegistrations');
    if(!list.length){ c.innerHTML='<p class="text-muted mb-0">尚無報名</p>'; return; }
    c.innerHTML=list.map(r=>`
      <div class="activity-item">
        <div class="d-flex justify-content-between">
          <div>
            <strong>${r.activityTitle}</strong>
            <div class="small text-muted mb-1"><i class="bi bi-calendar me-1"></i>${formatDateTime(r.registrationTime)}</div>
            <small class="text-muted">狀態：${r.status}</small>
          </div>
          <div class="text-end">
              <span class="status-badge status-${r.status}">${r.status}</span><br>
              ${r.status==='已報名'
                ? `<button class="btn btn-outline-danger btn-sm mt-2" onclick="cancelRegistration('${r.id}')">
                     <i class="bi bi-x-circle me-1"></i>取消
                   </button>`
                : ''
              }
          </div>
        </div>
      </div>`).join('');
  }

  async function cancelRegistration(regId){
    if(!confirm('確定要取消這筆報名？')) return;
    try{
      await callAPI('cancelRegistration',{ lineId:userProfile.userId, registrationId:regId });
      showNotification('已取消','success');
      await loadActivities();
      await loadMyRegistrations();
      await loadDashboard();
    }catch(err){
      showNotification('取消失敗：'+err.message,'error');
    }
  }

  // ========== 志工服務 ==========
  async function loadVolunteerData(){
    try{
      const r=await callAPI('getVolunteerData',{ lineId:userProfile.userId });
      const d=r.data||{};
      document.getElementById('volunteerHours').textContent=d.stats.totalHours||0;
      document.getElementById('volunteerActivities').textContent=d.stats.totalActivities||0;
      document.getElementById('volunteerRank').textContent=d.stats.rank||'-';
      document.getElementById('availableNeeds').textContent=d.stats.availableNeeds||0;
      renderVolunteerNeeds(d.needs||[]);
      renderVolunteerRecords(d.records||[]);
    }catch(err){
      document.getElementById('volunteerNeeds').innerHTML='<div class="text-danger">'+err.message+'</div>';
    }
  }

  function renderVolunteerNeeds(list){
    const c=document.getElementById('volunteerNeeds');
    if(!list.length){ c.innerHTML='<p class="text-muted mb-0">目前沒有開放的志工需求</p>'; return; }
    c.innerHTML=list.map(n=>`
      <div class="activity-item">
        <div class="row">
          <div class="col-md-8">
            <strong>${n.title}</strong>
            <p class="mb-2 small text-muted">${n.description||''}</p>
            <div class="d-flex flex-wrap gap-3 small text-muted">
              <span><i class="bi bi-calendar me-1"></i>${formatDate(n.date)}</span>
              <span><i class="bi bi-clock me-1"></i>${n.time||'-'}</span>
              <span><i class="bi bi-people me-1"></i>${n.currentCount||0}/${n.needCount||0}</span>
              <span><i class="bi bi-stopwatch me-1"></i>${n.hours||0} 時</span>
            </div>
          </div>
          <div class="col-md-4 text-end">
            <span class="status-badge status-${n.status}">${n.status}</span><br>
            <button class="btn btn-primary btn-sm mt-2" onclick="applyVolunteer('${n.id}')">
              <i class="bi bi-plus-circle me-1"></i>報名
            </button>
          </div>
        </div>
      </div>`).join('');
  }

  function renderVolunteerRecords(list){
    const c=document.getElementById('myVolunteerRecords');
    if(!list.length){ c.innerHTML='<p class="text-muted mb-0">尚無志工記錄</p>'; return; }
    c.innerHTML=list.map(r=>`
      <div class="activity-item">
        <div class="d-flex justify-content-between">
          <div>
            <strong>${r.title}</strong>
            <div class="small text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(r.date)} ｜ ${r.hours} 時</div>
            ${r.feedback? `<div class="small text-muted">回饋：${r.feedback}</div>`:''}
          </div>
          <span class="status-badge status-${r.status}">${r.status}</span>
        </div>
      </div>`).join('');
  }

  async function applyVolunteer(id){
    if(!currentUser){ showNotification('請先註冊','warning'); return; }
    try{
      await callAPI('applyVolunteer',{ lineId:userProfile.userId, needId:id });
      showNotification('志工報名成功','success');
      await loadVolunteerData();
      await loadDashboard();
    }catch(err){
      showNotification('報名失敗：'+err.message,'error');
    }
  }

  // ========== 財務管理 ==========
  async function loadFinanceData(){
    if(!currentUser) return;
    try{
      const r=await callAPI('getFinanceData',{ lineId:userProfile.userId });
      const d=r.data;
      document.getElementById('myDonationAmount').textContent='NT$ '+(d.stats.totalDonation||0).toLocaleString();
      document.getElementById('myDonationCount').textContent=d.stats.donationCount||0;
      document.getElementById('myExpenseAmount').textContent='NT$ '+(d.stats.totalExpense||0).toLocaleString();
      document.getElementById('pendingExpenses').textContent=d.stats.pendingExpenses||0;
      renderDonationHistory(d.donations||[]);
      renderExpenseHistory(d.expenses||[]);
      if(isAdmin){
        const a=d.adminStats||{};
        document.getElementById('totalIncome').textContent='NT$ '+(a.totalIncome||0).toLocaleString();
        document.getElementById('totalExpense').textContent='NT$ '+(a.totalExpense||0).toLocaleString();
        document.getElementById('currentBalance').textContent='NT$ '+(a.currentBalance||0).toLocaleString();
        document.getElementById('monthlyDonations').textContent='NT$ '+(a.monthlyDonations||0).toLocaleString();
      }
    }catch(err){
      document.getElementById('donationHistory').innerHTML='<div class="text-danger">'+err.message+'</div>';
    }
  }

  function renderDonationHistory(list){
    const c=document.getElementById('donationHistory');
    if(!list.length){ c.innerHTML='<p class="text-muted mb-0">尚無捐款記錄</p>'; return; }
    c.innerHTML=list.sort((a,b)=> new Date(b.date||0)-new Date(a.date||0)).map(r=>`
      <div class="activity-item">
        <div class="d-flex justify-content-between">
          <div>
            <strong>${r.category}</strong>
            <div class="small text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(r.date)}</div>
            <div class="small text-muted">收據：${r.receiptNumber||'-'}</div>
          </div>
          <div class="text-end">
            <div class="fw-bold text-success">${formatCurrency(r.amount)}</div>
            <span class="status-badge status-${r.status}">${r.status}</span>
          </div>
        </div>
      </div>`).join('');
  }

  function renderExpenseHistory(list){
    const c=document.getElementById('expenseHistory');
    if(!list.length){ c.innerHTML='<p class="text-muted mb-0">尚無支出申請</p>'; return; }
    c.innerHTML=list.sort((a,b)=> new Date(b.createdAt||0)-new Date(a.createdAt||0)).map(r=>`
      <div class="activity-item">
        <div class="d-flex justify-content-between small">
          <div>
            <strong>${r.category}</strong>
            <div class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(r.createdAt)}</div>
          </div>
          <div class="text-end">
            <div class="fw-bold text-danger">${formatCurrency(r.amount)}</div>
            <span class="status-badge status-${r.status}">${r.status}</span>
          </div>
        </div>
      </div>`).join('');
  }

  // ========== 回饋管理 ==========
  async function loadFeedbackData(){
    if(!currentUser) return;
    try{
      const mine=await callAPI('getMyFeedback',{ lineId:userProfile.userId });
      renderMyFeedback(mine.data||[]);
      const comp=await callAPI('getMyCompletedActivities',{ lineId:userProfile.userId });
      const sel=document.getElementById('feedbackActivity');
      sel.innerHTML='<option value="">請選擇活動</option>'+ (comp.data||[]).map(a=>`<option value="${a.id}">${a.title}</option>`).join('');
      if(isAdmin){
        const all=await callAPI('getAllFeedback',{ lineId:userProfile.userId });
        renderAllFeedback(all.data||[]);
      }
    }catch(err){
      document.getElementById('myFeedback').innerHTML='<div class="text-danger">'+err.message+'</div>';
    }
  }

  function renderMyFeedback(list){
    const c=document.getElementById('myFeedback');
    if(!list.length){ c.innerHTML='<p class="text-muted mb-0">尚無回饋</p>'; return; }
    c.innerHTML=list.sort((a,b)=> new Date(b.createdAt||0)-new Date(a.createdAt||0)).map(r=>`
      <div class="activity-item">
        <div class="d-flex justify-content-between">
          <div>
            <strong>${r.activityTitle}</strong>
            <div class="small text-muted">${formatDateTime(r.createdAt)}</div>
            <div class="small text-muted">${'★'.repeat(r.rating)}${'☆'.repeat(5-r.rating)}</div>
            <div class="small">${r.comment||''}</div>
          </div>
          <span class="status-badge status-已完成">評分 ${r.rating}</span>
        </div>
      </div>`).join('');
  }

  function renderAllFeedback(list){
    const c=document.getElementById('allFeedback');
    if(!list.length){ c.innerHTML='<p class="text-muted mb-0">尚無資料</p>'; return; }
    c.innerHTML=list.sort((a,b)=> new Date(b.createdAt||0)-new Date(a.createdAt||0)).map(r=>`
      <div class="activity-item small">
        <div class="d-flex justify-content-between">
          <div>
            <strong>${r.activityTitle}</strong>
            <div class="text-muted">${formatDateTime(r.createdAt)} ｜ ${r.lineId}</div>
            <div>${r.comment||''}</div>
          </div>
          <div style="min-width:70px;" class="text-end">${'★'.repeat(r.rating)}${'☆'.repeat(5-r.rating)}</div>
        </div>
      </div>`).join('');
  }

  // 回饋表單事件
  document.getElementById('feedbackForm').addEventListener('submit', async e=>{
    e.preventDefault();
    if(!currentUser){ showNotification('請先註冊','warning'); return; }
    const btn=e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn,true);
    try{
      await callAPI('createFeedback',{
        lineId:userProfile.userId,
        activityId:document.getElementById('feedbackActivity').value,
        rating:document.getElementById('feedbackRating').value,
        comment:document.getElementById('feedbackComment').value
      });
      showNotification('已提交','success');
      document.getElementById('feedbackForm').reset();
      await loadFeedbackData();
    }catch(err){
      showNotification('提交失敗：'+err.message,'error');
    }finally{ setButtonLoading(btn,false); }
  });

  // ========== 管理員功能 ==========
  async function loadAdminData(){
    if(!isAdmin) return;
    try{
      const r=await callAPI('getAdminData',{ lineId:userProfile.userId });
      renderAdminData(r.data);
    }catch(err){
      console.error(err);
    }
  }

  function renderAdminData(data){
    renderAdminMembers(data.members||[]);
    renderAdminActivities(data.activities||[]);
  }

  function renderAdminMembers(list){
    const c=document.getElementById('adminMemberList');
    if(!list.length){ c.innerHTML='<p class="text-muted mb-0">無會員資料</p>'; return; }
    c.innerHTML=list.slice(0,10).map(m=>`
      <div class="activity-item small">
        <div class="d-flex justify-content-between">
          <div>
            <strong>${m.realName||m.lineName||'-'}</strong>
            <div class="text-muted">${m.memberType||'-'} ｜ ${formatDate(m.joinDate)}</div>
          </div>
          <span class="status-badge status-${m.status||'active'}">${m.status||'正常'}</span>
        </div>
      </div>`).join('') + (list.length>10?`<div class="text-muted small">...還有 ${list.length-10} 位會員</div>`:'');
  }

  function renderAdminActivities(list){
    const c=document.getElementById('adminActivityList');
    if(!list.length){ c.innerHTML='<p class="text-muted mb-0">無活動</p>'; return; }
    c.innerHTML=list.slice(0,10).map(a=>`
      <div class="activity-item small">
        <div class="d-flex justify-content-between">
          <div>
            <strong>${a.title}</strong>
            <div class="text-muted">${formatDate(a.date)} ｜ ${a.currentCount||0}/${a.maxParticipants||0}</div>
          </div>
          <span class="status-badge status-${a.status}">${a.status}</span>
        </div>
      </div>`).join('') + (list.length>10?`<div class="text-muted small">...還有 ${list.length-10} 個活動</div>`:'');
  }

  // ========== Modal 相關 ==========
  function showNewDonationModal(){
    const modalHtml = `
      <div class="modal fade" id="donationModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">新增捐款</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="donationForm" class="row g-3">
                <div class="col-md-6">
                  <div class="form-floating">
                    <select class="form-select" id="donationCategory" required>
                      <option value="一般捐款">一般捐款</option>
                      <option value="活動贊助">活動贊助</option>
                    </select>
                    <label for="donationCategory">捐款類別 *</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="number" class="form-control" id="donationAmount" min="1" required>
                    <label for="donationAmount">金額 *</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-floating">
                    <textarea class="form-control" id="donationDesc" style="height:100px;"></textarea>
                    <label for="donationDesc">說明 (可空白)</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="needReceipt">
                    <label for="needReceipt" class="form-check-label">需要收據</label>
                  </div>
                </div>
                <div class="col-12">
                  <button class="btn btn-primary w-100" type="submit"><i class="bi bi-heart-fill me-1"></i>送出捐款</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>`;
    
    document.getElementById('modalContainer').innerHTML = modalHtml;
    const modal = new bootstrap.Modal(document.getElementById('donationModal'));
    modal.show();
    
    document.getElementById('donationForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('createDonation',{
          lineId:userProfile.userId,
          category:document.getElementById('donationCategory').value,
          amount:document.getElementById('donationAmount').value,
          description:document.getElementById('donationDesc').value,
          needReceipt:document.getElementById('needReceipt').checked
        });
        showNotification('捐款成功','success');
        modal.hide();
        await loadFinanceData();
        await loadDashboard();
      }catch(err){
        showNotification('捐款失敗：'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });
  }

  function showNewExpenseModal(){
    const modalHtml = `
      <div class="modal fade" id="expenseModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">新增支出申請</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="expenseForm" class="row g-3">
                <div class="col-md-6">
                  <div class="form-floating">
                    <select class="form-select" id="expenseCategory" required>
                      <option value="活動費用">活動費用</option>
                      <option value="行政支出">行政支出</option>
                      <option value="設備支出">設備支出</option>
                    </select>
                    <label for="expenseCategory">支出類別 *</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="number" class="form-control" id="expenseAmount" min="1" required>
                    <label for="expenseAmount">金額 *</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-floating">
                    <textarea class="form-control" id="expenseDesc" style="height:100px;"></textarea>
                    <label for="expenseDesc">說明</label>
                  </div>
                </div>
                <div class="col-12">
                  <button class="btn btn-warning w-100" type="submit"><i class="bi bi-receipt me-1"></i>送出申請</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>`;
    
    document.getElementById('modalContainer').innerHTML = modalHtml;
    const modal = new bootstrap.Modal(document.getElementById('expenseModal'));
    modal.show();
    
    document.getElementById('expenseForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('createExpense',{
          lineId:userProfile.userId,
          category:document.getElementById('expenseCategory').value,
          amount:document.getElementById('expenseAmount').value,
          description:document.getElementById('expenseDesc').value
        });
        showNotification('支出申請建立','success');
        modal.hide();
        await loadFinanceData();
      }catch(err){
        showNotification('申請失敗：'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });
  }

  function showNewActivityModal(){
    if(!isAdmin){ showNotification('權限不足','error'); return; }
    const modalHtml = `
      <div class="modal fade" id="activityModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">新增活動</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="newActivityForm" class="row g-3">
                <div class="col-md-6">
                  <div class="form-floating">
                    <input class="form-control" id="newActTitle" required>
                    <label for="newActTitle">活動名稱 *</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="date" class="form-control" id="newActDate" required>
                    <label for="newActDate">日期 *</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-floating">
                    <input class="form-control" id="newActTime">
                    <label for="newActTime">時間</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-floating">
                    <input class="form-control" id="newActLocation">
                    <label for="newActLocation">地點</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-floating">
                    <input type="number" class="form-control" id="newActMax" min="1" value="30">
                    <label for="newActMax">人數上限</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-floating">
                    <input type="number" class="form-control" id="newActFee" min="0" value="0">
                    <label for="newActFee">費用</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-floating">
                    <textarea class="form-control" id="newActDesc" style="height:120px;"></textarea>
                    <label for="newActDesc">活動說明</label>
                  </div>
                </div>
                <div class="col-12">
                  <button class="btn btn-success w-100" type="submit"><i class="bi bi-plus-circle me-1"></i>建立</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>`;
    
    document.getElementById('modalContainer').innerHTML = modalHtml;
    const modal = new bootstrap.Modal(document.getElementById('activityModal'));
    modal.show();
    
    document.getElementById('newActivityForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('createActivity',{
          lineId:userProfile.userId,
          title:document.getElementById('newActTitle').value,
          date:document.getElementById('newActDate').value,
          time:document.getElementById('newActTime').value,
          location:document.getElementById('newActLocation').value,
          maxParticipants:document.getElementById('newActMax').value,
          fee:document.getElementById('newActFee').value,
          description:document.getElementById('newActDesc').value
        });
        showNotification('活動建立成功','success');
        modal.hide();
        await loadActivities();
        await loadAdminData();
      }catch(err){
        showNotification('建立失敗：'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });
  }

  function showNewVolunteerNeedModal(){
    if(!isAdmin){ showNotification('權限不足','error'); return; }
    const modalHtml = `
      <div class="modal fade" id="volunteerModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">新增志工需求</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="newVolunteerNeedForm" class="row g-3">
                <div class="col-md-6">
                  <div class="form-floating">
                    <input class="form-control" id="volNeedTitle" required>
                    <label for="volNeedTitle">標題 *</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="date" class="form-control" id="volNeedDate" required>
                    <label for="volNeedDate">日期 *</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-floating">
                    <input class="form-control" id="volNeedTime">
                    <label for="volNeedTime">時間</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-floating">
                    <input type="number" class="form-control" id="volNeedCount" value="5" min="1">
                    <label for="volNeedCount">需求人數 *</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-floating">
                    <input type="number" class="form-control" id="volNeedHours" value="2" min="1">
                    <label for="volNeedHours">服務時數 *</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-floating">
                    <textarea class="form-control" id="volNeedDesc" style="height:120px;"></textarea>
                    <label for="volNeedDesc">說明</label>
                  </div>
                </div>
                <div class="col-12">
                  <button class="btn btn-success w-100" type="submit"><i class="bi bi-plus-circle me-1"></i>建立</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>`;
    
    document.getElementById('modalContainer').innerHTML = modalHtml;
    const modal = new bootstrap.Modal(document.getElementById('volunteerModal'));
    modal.show();
    
    document.getElementById('newVolunteerNeedForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('createVolunteerNeed',{
          lineId:userProfile.userId,
          title:document.getElementById('volNeedTitle').value,
          date:document.getElementById('volNeedDate').value,
          time:document.getElementById('volNeedTime').value,
          needCount:document.getElementById('volNeedCount').value,
          hours:document.getElementById('volNeedHours').value,
          description:document.getElementById('volNeedDesc').value
        });
        showNotification('志工需求建立','success');
        modal.hide();
        await loadVolunteerData();
      }catch(err){
        showNotification('建立失敗：'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });
  }

  // ========== 工具函數 ==========
  function showTab(id){
    const tabTrigger=document.querySelector(`.nav-link[data-bs-target="#${id}"]`);
    if(tabTrigger){
      new bootstrap.Tab(tabTrigger).show();
    }
  }

  async function refreshData(){
    showNotification('刷新中...','info',1200);
    try {
      await Promise.all([
        loadDashboard(),
        loadActivities(),
        loadMyRegistrations(),
        loadVolunteerData(),
        loadFinanceData(),
        loadFeedbackData(),
        loadAdminData()
      ]);
      showNotification('資料已更新','success');
    } catch(err) {
      showNotification('刷新失敗：' + err.message, 'error');
    }
  }

  // ========== 初始化 ==========
  document.addEventListener('DOMContentLoaded', ()=>{
    // 檢查設定
    if(CONFIG.API_BASE_URL === 'https://script.google.com/macros/s/AKfycbxcz_CclYwV9hpvz8QEuuD8nzCZHjR5aL5alVZY29By85X8bXIHj2rt96gvv5EBM-ZH/exec'){
      showNotification('請先設定 API_BASE_URL','error',10000);
      return;
    }
    
    initializeLiff().then(async ()=>{
      // 等 LIFF 初始化完再載入其他資料
      await Promise.all([
        loadActivities(),
        loadMyRegistrations(),
        loadVolunteerData(),
        loadFinanceData(),
        loadFeedbackData()
      ]);
      
      if(isAdmin) {
        await loadAdminData();
      }
    }).catch(err => {
      console.error('初始化失敗:', err);
      showNotification('系統初始化失敗，請重新整理頁面','error',10000);
    });
  });
</script>
</body>
</html>
