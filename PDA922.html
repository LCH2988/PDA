
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>管理後台 - 三鐵協會</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    body { font-family:Arial,sans-serif; background:linear-gradient(135deg,#667eea,#764ba2); margin:0; color:#333; }
    header { background:rgba(255,255,255,.96); padding:1rem 1.5rem; display:flex; justify-content:space-between; flex-wrap:wrap; align-items:center; box-shadow:0 4px 15px rgba(0,0,0,.1); }
    h1 { margin:0; font-size:1.4rem; color:#667eea; }
    .btn { padding:8px 16px; border:none; border-radius:24px; cursor:pointer; font-weight:bold; background:#667eea; color:#fff; font-size:.8rem; }
    .btn-outline { background:transparent; border:2px solid #667eea; color:#667eea; }
    .btn-danger { background:#e74c3c; }
    .btn-success { background:#27ae60; }
    .btn-small { padding:4px 10px; font-size:.7rem; border-radius:16px; }
    .container { max-width:1350px; margin:25px auto; padding:0 20px; }
    .panel, .section { background:rgba(255,255,255,.95); padding:1.6rem; border-radius:18px; box-shadow:0 6px 22px -6px rgba(0,0,0,.15); margin-bottom:2rem; }
    .login-box { max-width:380px; margin:50px auto; }
    label { font-size:.75rem; font-weight:bold; letter-spacing:.5px; display:block; margin-top:14px; }
    input, select { width:100%; padding:10px 12px; border:2px solid #dfe3fa; border-radius:8px; margin-top:4px; font-size:.85rem; }
    input:focus, select:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 2px rgba(102,126,234,.3); }
    .message { margin-top:10px; font-size:.7rem; min-height:18px; }
    .success { color:#1e7e34; }
    .error { color:#c0392b; }
    .tabs { display:flex; flex-wrap:wrap; gap:6px; }
    .tabs button { background:#eee; border:none; padding:10px 18px; border-radius:30px; cursor:pointer; font-weight:bold; font-size:.75rem; }
    .tabs button.active { background:#667eea; color:#fff; }
    table { width:100%; border-collapse:collapse; font-size:.7rem; background:#fff; }
    th, td { padding:8px 10px; border-bottom:1px solid #eee; vertical-align:top; }
    th { background:#f2f4ff; text-align:left; letter-spacing:.5px; white-space:nowrap; }
    tr:hover { background:#f9faff; }
    .table-container { overflow:auto; max-height:480px; border:1px solid #e0e4f5; border-radius:10px; }
    .stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(190px,1fr)); gap:18px; }
    .stat-card { background:linear-gradient(45deg,#667eea,#764ba2); color:#fff; padding:1rem 1.2rem; border-radius:18px; position:relative; overflow:hidden; }
    .stat-card h3 { margin:0; font-size:.75rem; letter-spacing:1px; opacity:.85; }
    .stat-card .num { font-size:2rem; font-weight:bold; margin-top:6px; }
    .floating-add { position:fixed; right:22px; bottom:22px; background:#ffb347; color:#503000; font-weight:bold; border:none; padding:14px 20px; border-radius:40px; cursor:pointer; box-shadow:0 8px 24px -8px rgba(0,0,0,.4); }
    .floating-add:hover { filter:brightness(1.05); }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:flex-start; justify-content:center; padding:50px 15px; overflow:auto; z-index:100; }
    .modal-content { background:#fff; width:100%; max-width:520px; border-radius:20px; padding:1.8rem 1.6rem 2.2rem; position:relative; animation:pop .35s ease; }
    @keyframes pop { from { transform:translateY(30px); opacity:0; } to { transform:translateY(0); opacity:1; } }
    .modal-content h2 { margin:0 0 6px; font-size:1rem; color:#555; }
    .close { position:absolute; top:10px; right:14px; background:#eee; width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px; cursor:pointer; }
    .row-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .empty { text-align:center; padding:1.2rem; font-size:.75rem; color:#666; }
    .badge-status { display:inline-block; padding:4px 10px; border-radius:14px; font-size:.6rem; background:#e8ecff; color:#445; font-weight:bold; }
    .loading { text-align:center; padding:1rem; font-size:.7rem; color:#555; }
    .spinner { width:28px; height:28px; border:4px solid #eee; border-top:4px solid #667eea; border-radius:50%; margin:0 auto 6px; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    @media (max-width:800px){ .row-2 { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>管理後台</h1>
    <div id="adminBar" style="display:none; gap:10px;">
      <a href="index.html" class="btn btn-outline">首頁</a>
      <button class="btn btn-danger" onclick="logout()">登出</button>
    </div>
  </header>
  <div class="container">
    <div id="loginPanel" class="panel login-box">
      <h2 style="margin-top:0;">管理員登入</h2>
      <form id="adminLoginForm">
        <label>帳號</label>
          <input name="username" required>
        <label>密碼</label>
          <input name="password" type="password" required>
        <button class="btn" type="submit" style="margin-top:20px;">登入</button>
        <div id="loginMessage" class="message"></div>
      </form>
      <hr style="margin:25px 0;border:none;border-top:1px dashed #ccd;">
      <h3 style="margin:0;font-size:.9rem;color:#667eea;">系統初始化</h3>
      <p style="font-size:.65rem; line-height:1.4; color:#555;">首次使用點擊下方按鈕建立資料表與預設管理員：admin / admin123</p>
      <button class="btn btn-success" onclick="initSystem()">初始化</button>
      <div id="initMessage" class="message"></div>
    </div>

    <div id="adminPanel" style="display:none;">
      <div class="section">
        <h2 style="margin-top:0;">📊 統計概覽</h2>
        <div class="stats" id="statsBox"></div>
      </div>
      <div class="section">
        <div class="tabs">
          <button class="active" data-tab="events" onclick="switchTab('events', this)">活動管理</button>
          <button data-tab="members" onclick="switchTab('members', this)">會員管理</button>
          <button data-tab="registrations" onclick="switchTab('registrations', this)">報名管理</button>
        </div>
        <!-- 活動 -->
        <div id="tab-events">
          <div class="table-container">
            <table id="eventsTable">
              <thead>
                <tr>
                  <th>名稱</th><th>日期</th><th>時間</th><th>地點</th>
                  <th>費用</th><th>限額</th><th>已報</th><th>狀態</th><th>操作</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="eventsLoading" class="loading" style="display:none;">
            <div class="spinner"></div>載入活動...
          </div>
        </div>
        <!-- 會員 -->
          <div id="tab-members" style="display:none;">
            <div class="table-container">
              <table id="membersTable">
                <thead>
                  <tr>
                    <th>ID</th><th>姓名</th><th>Email</th><th>電話</th><th>性別</th><th>註冊日期</th><th>狀態</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="membersLoading" class="loading" style="display:none;">
              <div class="spinner"></div>載入會員...
            </div>
          </div>
        <!-- 報名 -->
        <div id="tab-registrations" style="display:none;">
          <div class="table-container">
            <table id="registrationsTable">
              <thead>
                <tr>
                  <th>ID</th><th>會員</th><th>活動</th><th>日期</th><th>狀態</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="registrationsLoading" class="loading" style="display:none;">
            <div class="spinner"></div>載入報名...
          </div>
        </div>
      </div>
      <button class="floating-add" onclick="openModal('addEventModal')">＋ 新增活動</button>
    </div>
  </div>

  <!-- 新增活動 Modal -->
  <div id="addEventModal" class="modal">
    <div class="modal-content">
      <div class="close" onclick="closeModal('addEventModal')">&times;</div>
      <h2>新增活動</h2>
      <form id="addEventForm">
        <label>名稱 *</label>
        <input name="name" required>
        <div class="row-2">
          <div>
            <label>日期 *</label>
            <input name="date" type="date" required>
          </div>
          <div>
            <label>時間 *</label>
            <input name="time" type="time" required>
          </div>
        </div>
        <label>地點 *</label>
        <input name="location" required>
        <div class="row-2">
          <div>
            <label>費用 *</label>
            <input name="fee" type="number" min="0" required>
          </div>
          <div>
            <label>人數限制 *</label>
            <input name="maxParticipants" type="number" min="1" required>
          </div>
        </div>
        <button class="btn btn-success" type="submit" style="margin-top:18px;">建立</button>
        <div id="addEventMessage" class="message"></div>
      </form>
    </div>
  </div>

  <!-- 編輯活動 Modal -->
  <div id="editEventModal" class="modal">
    <div class="modal-content">
      <div class="close" onclick="closeModal('editEventModal')">&times;</div>
      <h2>編輯活動</h2>
      <form id="editEventForm">
        <input type="hidden" name="id" id="edit-id">
        <label>名稱 *</label>
        <input name="name" id="edit-name" required>
        <div class="row-2">
          <div>
            <label>日期 *</label>
            <input name="date" type="date" id="edit-date" required>
          </div>
          <div>
            <label>時間 *</label>
            <input name="time" type="time" id="edit-time" required>
          </div>
        </div>
        <label>地點 *</label>
        <input name="location" id="edit-location" required>
        <div class="row-2">
          <div>
            <label>費用 *</label>
            <input name="fee" type="number" id="edit-fee" required>
          </div>
          <div>
            <label>限額 *</label>
            <input name="maxParticipants" type="number" id="edit-maxParticipants" required>
          </div>
        </div>
        <label>狀態 *</label>
        <select name="status" id="edit-status" required>
          <option value="開放報名">開放報名</option>
          <option value="已結束">已結束</option>
          <option value="已取消">已取消</option>
        </select>
        <button class="btn" type="submit" style="margin-top:18px;">儲存變更</button>
        <div id="editEventMessage" class="message"></div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzi82aSpwo7Bfw1V-x0fiUxm3ydIwfkj76dm4_1y_G3-9tDiA7g8dTusEoQSpZ_iQEe/exec'; // <-- 替換
    let adminToken = null;
    let events = [], members = [], registrations = [];

    document.getElementById('adminLoginForm').addEventListener('submit', adminLogin);
    document.getElementById('addEventForm').addEventListener('submit', addEventSubmit);
    document.getElementById('editEventForm').addEventListener('submit', editEventSubmit);
    document.addEventListener('DOMContentLoaded', () => {
      adminToken = localStorage.getItem('adminSessionToken');
      if (adminToken) validateSession();
    });

    async function validateSession() {
      try {
        const res = await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'checkSession', sessionToken:adminToken})});
        const j = await res.json();
        if (j.success && j.isAdmin) {
          showAdmin();
        } else {
          localStorage.removeItem('adminSessionToken');
        }
      } catch {}
    }

    function showAdmin() {
      document.getElementById('loginPanel').style.display='none';
      document.getElementById('adminPanel').style.display='block';
      document.getElementById('adminBar').style.display='flex';
      // 載入資料
      loadEvents();
      loadMembers();
      loadRegistrations();
    }
    function logout() {
      if (confirm('確定登出？')) {
        localStorage.removeItem('adminSessionToken');
        location.reload();
      }
    }
    function switchTab(tab, btn) {
      document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      ['events','members','registrations'].forEach(t=>{
        document.getElementById('tab-'+t).style.display = (t===tab)?'block':'none';
      });
    }
    function setMsg(id,msg,ok) {
      const el = document.getElementById(id);
      el.className='message '+(ok?'success':'error');
      el.textContent = msg;
    }
    async function adminLogin(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      setMsg('loginMessage','登入中...', true);
      try {
        const res = await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
          action:'adminLogin',
          username: fd.get('username'),
          password: fd.get('password')
        })});
        const j = await res.json();
        if (j.success) {
          adminToken = j.sessionToken;
          localStorage.setItem('adminSessionToken', adminToken);
          setMsg('loginMessage','登入成功', true);
          showAdmin();
        } else setMsg('loginMessage', j.message, false);
      } catch(err) {
        setMsg('loginMessage','錯誤：'+err,false);
      }
    }
    async function initSystem() {
      if (!confirm('確定初始化？（已存在資料不會刪除）')) return;
      setMsg('initMessage','執行中...', true);
      try {
        const res = await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'initializeSystem'})});
        const j = await res.json();
        setMsg('initMessage', j.message, j.success);
      } catch(err) {
        setMsg('initMessage','錯誤：'+err,false);
      }
    }
    async function loadEvents() {
      const tbody = document.querySelector('#eventsTable tbody');
      const loading = document.getElementById('eventsLoading');
      tbody.innerHTML=''; loading.style.display='block';
      try {
        const res = await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'getEvents'})});
        const j = await res.json();
        if (!j.success) { tbody.innerHTML = `<tr><td colspan="9" class="empty" style="color:#c00;">載入失敗</td></tr>`; return; }
        events = j.events;
        if (!events.length) { tbody.innerHTML=`<tr><td colspan="9" class="empty">無活動</td></tr>`; }
        else {
          events.forEach(ev => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${ev.name}</td>
              <td>${ev.date}</td>
              <td>${ev.time}</td>
              <td>${ev.location}</td>
              <td>NT$ ${ev.fee}</td>
              <td>${ev.maxParticipants}</td>
              <td>${ev.currentParticipants||0}</td>
              <td><span class="badge-status">${ev.status}</span></td>
              <td>
                <button class="btn btn-small" onclick="openEdit('${ev.id}')">編</button>
                <button class="btn btn-small btn-danger" onclick="delEvent('${ev.id}')">刪</button>
              </td>`;
            tbody.appendChild(tr);
          });
        }
        updateStats();
      } catch(err) {
        tbody.innerHTML = `<tr><td colspan="9" class="empty" style="color:#c00;">錯誤：${err}</td></tr>`;
      } finally {
        loading.style.display='none';
      }
    }
    async function loadMembers() {
      const tbody = document.querySelector('#membersTable tbody');
      const loading = document.getElementById('membersLoading');
      tbody.innerHTML=''; loading.style.display='block';
      try {
        const res = await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'getMembers'})});
        const j = await res.json();
        if (!j.success) { tbody.innerHTML = `<tr><td colspan="7" class="empty" style="color:#c00;">載入失敗</td></tr>`; return; }
        members = j.members;
        if (!members.length) { tbody.innerHTML=`<tr><td colspan="7" class="empty">無會員</td></tr>`; }
        else members.forEach(m=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${m.id.slice(0,8)}...</td>
            <td>${m.name}</td>
            <td>${m.email}</td>
            <td>${m.phone||'-'}</td>
            <td>${m.gender||'-'}</td>
            <td>${(m.registerDate||'').substring(0,10)}</td>
            <td>${m.status}</td>`;
          tbody.appendChild(tr);
        });
        updateStats();
      } catch(err) {
        tbody.innerHTML = `<tr><td colspan="7" class="empty" style="color:#c00;">錯誤：${err}</td></tr>`;
      } finally {
        loading.style.display='none';
      }
    }
    async function loadRegistrations() {
      const tbody = document.querySelector('#registrationsTable tbody');
      const loading = document.getElementById('registrationsLoading');
      tbody.innerHTML=''; loading.style.display='block';
      try {
        const res = await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'getRegistrations'})});
        const j = await res.json();
        if (!j.success) { tbody.innerHTML = `<tr><td colspan="5" class="empty" style="color:#c00;">載入失敗</td></tr>`; return; }
        registrations = j.registrations;
        if (!registrations.length) { tbody.innerHTML=`<tr><td colspan="5" class="empty">無報名</td></tr>`; }
        else registrations.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.id.slice(0,8)}...</td>
            <td>${r.memberName}</td>
            <td>${r.eventName}</td>
            <td>${(r.registrationDate||'').substring(0,10)}</td>
            <td>${r.status}</td>`;
          tbody.appendChild(tr);
        });
        updateStats();
      } catch(err) {
        tbody.innerHTML = `<tr><td colspan="5" class="empty" style="color:#c00;">錯誤：${err}</td></tr>`;
      } finally {
        loading.style.display='none';
      }
    }
    function updateStats() {
      const statsBox = document.getElementById('statsBox');
      const totalEvents = events.length;
      const totalMembers = members.length;
      const totalRegs = (registrations||[]).filter(r=>r.status==='已報名').length;
      const openEvents = events.filter(e=>e.status==='開放報名').length;
      statsBox.innerHTML = `
        <div class="stat-card">
          <h3>活動總數</h3>
          <div class="num">${totalEvents}</div>
        </div>
        <div class="stat-card">
          <h3>開放報名中</h3>
          <div class="num">${openEvents}</div>
        </div>
          <div class="stat-card">
          <h3>會員總數</h3>
          <div class="num">${totalMembers}</div>
        </div>
        <div class="stat-card">
          <h3>有效報名</h3>
          <div class="num">${totalRegs}</div>
        </div>
      `;
    }
    function openModal(id) {
      document.getElementById(id).style.display='flex';
      if (id==='addEventModal') {
        document.getElementById('addEventForm').reset();
        setMsg('addEventMessage','',true);
      }
    }
    function closeModal(id) {
      document.getElementById(id).style.display='none';
    }
    window.addEventListener('click', e => {
      if (e.target.classList.contains('modal')) e.target.style.display='none';
    });
    async function addEventSubmit(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      setMsg('addEventMessage','處理中...', true);
      try {
        const res = await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
          action:'addEvent',
          name:fd.get('name'),
          date:fd.get('date'),
          time:fd.get('time'),
          location:fd.get('location'),
          fee:Number(fd.get('fee')),
          maxParticipants:Number(fd.get('maxParticipants'))
        })});
        const j = await res.json();
        setMsg('addEventMessage', j.message, j.success);
        if (j.success) {
          loadEvents();
          setTimeout(()=>closeModal('addEventModal'),800);
        }
      } catch(err) {
        setMsg('addEventMessage','錯誤：'+err,false);
      }
    }
    function openEdit(id) {
      const ev = events.find(e=>e.id===id);
      if (!ev) return alert('找不到活動');
      document.getElementById('edit-id').value = ev.id;
      document.getElementById('edit-name').value = ev.name;
      document.getElementById('edit-date').value = ev.date;
      document.getElementById('edit-time').value = ev.time;
      document.getElementById('edit-location').value = ev.location;
      document.getElementById('edit-fee').value = ev.fee;
      document.getElementById('edit-maxParticipants').value = ev.maxParticipants;
      document.getElementById('edit-status').value = ev.status;
      setMsg('editEventMessage','',true);
      openModal('editEventModal');
    }
    async function editEventSubmit(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      setMsg('editEventMessage','儲存中...', true);
      try {
        const res = await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
          action:'updateEvent',
          id:fd.get('id'),
          name:fd.get('name'),
          date:fd.get('date'),
          time:fd.get('time'),
          location:fd.get('location'),
          fee:Number(fd.get('fee')),
          maxParticipants:Number(fd.get('maxParticipants')),
          status:fd.get('status')
        })});
        const j = await res.json();
        setMsg('editEventMessage', j.message, j.success);
        if (j.success) {
          loadEvents();
          setTimeout(()=>closeModal('editEventModal'),800);
        }
      } catch(err) {
        setMsg('editEventMessage','錯誤：'+err,false);
      }
    }
    async function delEvent(id) {
      if (!confirm('確定刪除此活動？')) return;
      try {
        const res = await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'deleteEvent', eventId:id})});
        const j = await res.json();
        alert(j.message);
        if (j.success) loadEvents();
      } catch(err) {
        alert('錯誤：'+err);
      }
    }
  </script>
</body>
</html>
