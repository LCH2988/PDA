<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>帕金森病友會管理系統</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<!-- 帕金森病友會專用 favicon -->
<link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AOAgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AOAgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AOAgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A">

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
  /* ========== 全域樣式 ========== */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    --primary-color: #4CAF50;
    --secondary-color: #2196F3;
    --success-color: #4CAF50;
    --warning-color: #FF9800;
    --danger-color: #F44336;
    --info-color: #2196F3;
    --light-bg: #f8f9fa;
    --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    --border-radius: 20px;
  }

  body {
    font-family: 'Microsoft JhengHei', '微軟正黑體', sans-serif;
    font-size: 20px; /* 大字體 */
    line-height: 1.6;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 15px;
    margin: 0;
  }

  /* ========== 容器樣式 ========== */
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  /* ========== 標題區域 (非固定) ========== */
  .main-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: var(--border-radius);
    padding: 30px;
    margin-bottom: 25px;
    box-shadow: var(--card-shadow);
    text-align: center;
  }

  .header-content {
    background: linear-gradient(135deg, var(--primary-color) 0%, #45a049 100%);
    color: white;
    padding: 30px;
    margin: -30px -30px 20px -30px;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
  }

  .main-header h1 {
    font-size: 2.8em;
    margin-bottom: 15px;
    color: white;
    font-weight: 700;
  }

  .main-header .subtitle {
    font-size: 1.4em;
    opacity: 0.9;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 0;
  }

  .user-info-card {
    background: rgba(255, 255, 255, 0.95);
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    margin-top: 15px;
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .user-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), #45a049);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 24px;
  }

  .user-details h3 {
    margin: 0 0 5px 0;
    font-size: 1.3em;
    color: #333;
  }

  .user-details p {
    margin: 0;
    color: #666;
    font-size: 1em;
  }

  /* ========== 卡片式導航 ========== */
  .nav-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .nav-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: var(--border-radius);
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: var(--card-shadow);
    border: 3px solid transparent;
    min-height: 180px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .nav-card:hover, .nav-card.active {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    border-color: var(--primary-color);
  }

  .nav-card i {
    font-size: 3.5em;
    margin-bottom: 15px;
    color: var(--primary-color);
  }

  .nav-card h4 {
    font-size: 1.4em;
    margin: 0;
    color: #333;
    font-weight: 600;
  }

  .nav-card p {
    font-size: 1em;
    color: #666;
    margin: 8px 0 0 0;
  }

  /* ========== 內容區域 ========== */
  .content-section {
    background: rgba(255, 255, 255, 0.95);
    border-radius: var(--border-radius);
    padding: 40px;
    margin-bottom: 25px;
    box-shadow: var(--card-shadow);
    backdrop-filter: blur(10px);
    display: none;
  }

  .content-section.active {
    display: block;
  }

  .section-title {
    font-size: 2.2em;
    color: #333;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .section-title i {
    color: var(--primary-color);
  }

  /* ========== 大按鈕樣式 ========== */
  .btn-large {
    padding: 20px 30px;
    font-size: 1.2em;
    font-weight: 600;
    border-radius: 15px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 10px;
    min-width: 180px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .btn-primary-large {
    background: linear-gradient(135deg, var(--primary-color), #45a049);
    color: white;
  }

  .btn-primary-large:hover {
    background: linear-gradient(135deg, #45a049, #3d8b40);
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
  }

  .btn-success-large {
    background: linear-gradient(135deg, var(--success-color), #45a049);
    color: white;
  }

  .btn-warning-large {
    background: linear-gradient(135deg, var(--warning-color), #f57c00);
    color: white;
  }

  .btn-info-large {
    background: linear-gradient(135deg, var(--info-color), #1976d2);
    color: white;
  }

  .btn-danger-large {
    background: linear-gradient(135deg, var(--danger-color), #d32f2f);
    color: white;
  }

  /* ========== 統計卡片 ========== */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .stat-card-large {
    background: linear-gradient(135deg, var(--primary-color), #45a049);
    color: white;
    padding: 30px;
    border-radius: var(--border-radius);
    text-align: center;
    box-shadow: var(--card-shadow);
  }

  .stat-card-large h2 {
    font-size: 3em;
    margin: 0 0 10px 0;
    font-weight: 700;
  }

  .stat-card-large p {
    font-size: 1.2em;
    margin: 0;
    opacity: 0.9;
  }

  .stat-card-large.success {
    background: linear-gradient(135deg, var(--success-color), #45a049);
  }

  .stat-card-large.warning {
    background: linear-gradient(135deg, var(--warning-color), #f57c00);
  }

  .stat-card-large.info {
    background: linear-gradient(135deg, var(--info-color), #1976d2);
  }

  .stat-card-large.danger {
    background: linear-gradient(135deg, var(--danger-color), #d32f2f);
  }

  /* ========== 活動卡片 ========== */
  .activity-cards {
    display: grid;
    gap: 20px;
    margin-bottom: 30px;
  }

  .activity-card-large {
    background: white;
    border-radius: var(--border-radius);
    padding: 30px;
    box-shadow: var(--card-shadow);
    border-left: 6px solid var(--primary-color);
    transition: all 0.3s ease;
  }

  .activity-card-large:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
  }

  .activity-card-large h3 {
    font-size: 1.6em;
    color: #333;
    margin-bottom: 15px;
    font-weight: 600;
  }

  .activity-card-large .activity-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 15px;
    font-size: 1.1em;
    color: #666;
  }

  .activity-card-large .activity-meta span {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .activity-card-large .activity-description {
    font-size: 1.1em;
    color: #555;
    margin-bottom: 20px;
    line-height: 1.6;
  }

  /* ========== 狀態標籤 ========== */
  .status-badge-large {
    display: inline-block;
    padding: 12px 20px;
    border-radius: 25px;
    font-size: 1em;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .status-開放報名, .status-active {
    background: #d4edda;
    color: #155724;
  }

  .status-已報名 {
    background: #d1ecf1;
    color: #0c5460;
  }

  .status-已取消, .status-已拒絕, .status-inactive {
    background: #f8d7da;
    color: #721c24;
  }

  .status-已完成 {
    background: #e2e3ff;
    color: #383d41;
  }

  .status-報名截止, .status-待審核, .status-pending {
    background: #fff3cd;
    color: #856404;
  }

  .status-進行中 {
    background: #bee3f8;
    color: #2a69ac;
  }

  .status-已結束 {
    background: #e2e8f0;
    color: #2d3748;
  }

  .status-已核准 {
    background: #d4edda;
    color: #155724;
  }

  /* ========== 表單樣式 ========== */
  .form-group-large {
    margin-bottom: 25px;
  }

  .form-group-large label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: #333;
    font-size: 1.2em;
  }

  .form-control-large, .form-select-large {
    border: 3px solid #e1e5e9;
    border-radius: 12px;
    padding: 18px 20px;
    font-size: 1.1em;
    transition: border-color 0.3s ease;
    width: 100%;
  }

  .form-control-large:focus, .form-select-large:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
  }

  /* ========== 通知樣式 ========== */
  .notification-large {
    position: fixed;
    top: 30px;
    right: 30px;
    background: #fff;
    padding: 25px 30px;
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
    transform: translateX(420px);
    transition: all 0.4s ease;
    z-index: 2000;
    max-width: 400px;
    border-left: 6px solid var(--primary-color);
    font-size: 1.1em;
  }

  .notification-large.show {
    transform: translateX(0);
  }

  .notification-large.success {
    background: #d4edda;
    color: #155724;
    border-left-color: var(--success-color);
  }

  .notification-large.error {
    background: #f8d7da;
    color: #721c24;
    border-left-color: var(--danger-color);
  }

  .notification-large.warning {
    background: #fff3cd;
    color: #856404;
    border-left-color: var(--warning-color);
  }

  .notification-large.info {
    background: #d1ecf1;
    color: #0c5460;
    border-left-color: var(--info-color);
  }

  /* ========== 載入動畫 ========== */
  .loading-large {
    text-align: center;
    padding: 60px;
    color: #666;
    font-size: 1.2em;
  }

  .spinner-large {
    border: 6px solid #f3f3f3;
    border-top: 6px solid var(--primary-color);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
    margin: 0 auto 30px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ========== 響應式設計 ========== */
  @media (max-width: 768px) {
    body {
      padding: 10px;
      font-size: 18px;
    }

    .main-header h1 {
      font-size: 2.2em;
    }

    .nav-cards {
      grid-template-columns: 1fr;
    }

    .nav-card {
      min-height: 140px;
      padding: 25px;
    }

    .nav-card i {
      font-size: 2.8em;
    }

    .nav-card h4 {
      font-size: 1.2em;
    }

    .content-section {
      padding: 25px;
    }

    .section-title {
      font-size: 1.8em;
    }

    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .stat-card-large h2 {
      font-size: 2.2em;
    }

    .btn-large {
      min-width: 150px;
      padding: 18px 25px;
      font-size: 1.1em;
    }

    .user-info-card {
      flex-direction: column;
      text-align: center;
    }
  }

  @media (max-width: 480px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }

    .activity-card-large .activity-meta {
      flex-direction: column;
      gap: 10px;
    }
  }

  /* ========== 隱藏類別 ========== */
  .admin-only {
    display: none;
  }

  .d-none {
    display: none !important;
  }
</style>
</head>
<body>
<div class="container">
  <!-- 標題區域 (非固定) -->
  <div class="main-header">
    <div class="header-content">
      <h1><i class="bi bi-hospital"></i> 帕金森病友會</h1>
      <p class="subtitle">關懷、支持、共同成長</p>
    </div>
    
    <div id="userInfoCard" class="user-info-card d-none">
      <div class="user-avatar" id="userAvatar">?</div>
      <div class="user-details">
        <h3 id="userName">載入中...</h3>
        <p id="userLineName"></p>
        <p id="userRole">會員</p>
      </div>
      <div class="ms-auto">
        <button class="btn-large btn-info-large" onclick="refreshData()" title="刷新資料">
          <i class="bi bi-arrow-clockwise"></i>
          刷新
        </button>
      </div>
    </div>
  </div>

  <!-- 通知容器 -->
  <div id="notificationContainer"></div>

  <!-- 卡片式導航 -->
  <div class="nav-cards">
    <div class="nav-card active" data-target="dashboard">
      <i class="bi bi-house-door"></i>
      <h4>首頁</h4>
      <p>查看最新資訊</p>
    </div>
    <div class="nav-card" data-target="profile">
      <i class="bi bi-person-circle"></i>
      <h4>個人資料</h4>
      <p>管理我的資料</p>
    </div>
    <div class="nav-card" data-target="activities">
      <i class="bi bi-calendar-event"></i>
      <h4>活動報名</h4>
      <p>參與精彩活動</p>
    </div>
    <div class="nav-card" data-target="volunteer">
      <i class="bi bi-heart-fill"></i>
      <h4>志工服務</h4>
      <p>奉獻愛心服務</p>
    </div>
    <div class="nav-card" data-target="finance">
      <i class="bi bi-cash-coin"></i>
      <h4>愛心捐款</h4>
      <p>支持病友會</p>
    </div>
    <div class="nav-card" data-target="feedback">
      <i class="bi bi-chat-heart"></i>
      <h4>活動回饋</h4>
      <p>分享您的想法</p>
    </div>
    <div class="nav-card admin-only" data-target="admin">
      <i class="bi bi-gear"></i>
      <h4>系統管理</h4>
      <p>管理員功能</p>
    </div>
  </div>

  <!-- 內容區域 -->
  <div id="dashboard" class="content-section active">
    <h2 class="section-title">
      <i class="bi bi-speedometer2"></i>
      歡迎回來
    </h2>
    
    <div class="stats-grid" id="dashboardStats">
      <div class="loading-large">
        <div class="spinner-large"></div>
        <p>載入統計資料...</p>
      </div>
    </div>

    <div style="text-align: center; margin: 40px 0;">
      <button class="btn-large btn-primary-large" onclick="showSection('profile')">
        <i class="bi bi-person-check"></i>
        更新資料
      </button>
      <button class="btn-large btn-success-large" onclick="showSection('activities')">
        <i class="bi bi-calendar-plus"></i>
        報名活動
      </button>
      <button class="btn-large btn-warning-large" onclick="showNewDonationModal()">
        <i class="bi bi-heart-fill"></i>
        愛心捐款
      </button>
      <button class="btn-large btn-info-large" onclick="showSection('volunteer')">
        <i class="bi bi-hand-thumbs-up"></i>
        志工服務
      </button>
    </div>

    <h3 style="font-size: 1.8em; margin: 40px 0 20px 0; color: #333;">
      <i class="bi bi-clock-history"></i> 最近活動
    </h3>
    <div id="recentActivity">
      <div class="loading-large">
        <div class="spinner-large"></div>
        <p>載入中...</p>
      </div>
    </div>
  </div>

  <div id="profile" class="content-section">
    <h2 class="section-title">
      <i class="bi bi-person-circle"></i>
      個人資料管理
    </h2>

    <div id="registrationSection">
      <div style="background: #d1ecf1; color: #0c5460; padding: 25px; border-radius: 15px; margin-bottom: 30px; font-size: 1.1em;">
        <i class="bi bi-info-circle" style="font-size: 1.5em; margin-right: 10px;"></i>
        請先完成註冊以使用完整功能
      </div>
      <form id="registrationForm">
        <div class="form-group-large">
          <label for="realName">真實姓名 *</label>
          <input type="text" class="form-control-large" id="realName" name="realName" required>
        </div>
        <div class="form-group-large">
          <label for="memberType">會員類別 *</label>
          <select class="form-select-large" id="memberType" name="memberType" required>
            <option value="">請選擇</option>
            <option value="病友">病友</option>
            <option value="家屬">家屬</option>
            <option value="志工">志工</option>
            <option value="醫護">醫護人員</option>
            <option value="支持者">支持者</option>
          </select>
        </div>
        <div style="text-align: center;">
          <button class="btn-large btn-primary-large" type="submit">
            <i class="bi bi-check-circle"></i>
            完成註冊
          </button>
        </div>
      </form>
    </div>

    <div id="profileSection" class="d-none">
      <form id="profileForm">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group-large">
              <label for="profileRealName">真實姓名</label>
              <input type="text" class="form-control-large" id="profileRealName" name="profileRealName" readonly>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group-large">
              <label for="lineName">LINE 名稱</label>
              <input type="text" class="form-control-large" id="lineName" name="lineName" readonly>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group-large">
              <label for="phone">聯絡電話</label>
              <input type="tel" class="form-control-large" id="phone" name="phone">
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group-large">
              <label for="email">電子郵件</label>
              <input type="email" class="form-control-large" id="email" name="email">
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group-large">
              <label for="birthday">生日</label>
              <input type="date" class="form-control-large" id="birthday" name="birthday>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group-large">
              <label for="profileMemberType">會員類別</label>
              <select class="form-select-large" id="profileMemberType" name="memberType">
                <option value="病友">病友</option>
                <option value="家屬">家屬</option>
                <option value="志工">志工</option>
                <option value="醫護">醫護人員</option>
                <option value="支持者">支持者</option>
              </select>
            </div>
          </div>
          <div class="col-12">
            <div class="form-group-large">
              <label for="address">通訊地址</label>
              <textarea class="form-control-large" id="address" name="address" rows="3"></textarea>
            </div>
          </div>
        </div>
        <div style="text-align: center;">
          <button class="btn-large btn-primary-large" type="submit">
            <i class="bi bi-save"></i>
            更新資料
          </button>
        </div>
      </form>
      
      <div style="margin-top: 40px;">
        <h3 style="font-size: 1.8em; margin-bottom: 20px; color: #333;">
          <i class="bi bi-bar-chart"></i> 個人統計
        </h3>
        <div class="stats-grid" id="profileStats"></div>
      </div>
    </div>
  </div>

  <div id="activities" class="content-section">
    <h2 class="section-title">
      <i class="bi bi-calendar-event"></i>
      活動管理
    </h2>

    <div class="admin-only" style="text-align: center; margin-bottom: 30px;">
      <button class="btn-large btn-success-large" onclick="showNewActivityModal()">
        <i class="bi bi-plus-circle"></i>
        新增活動
      </button>
    </div>

    <div class="row" style="margin-bottom: 30px;">
      <div class="col-md-3">
        <div class="form-group-large">
          <label for="activityStatusFilter">狀態篩選</label>
          <select class="form-select-large" id="activityStatusFilter">
            <option value="">全部狀態</option>
            <option value="開放報名">開放報名</option>
            <option value="報名截止">報名截止</option>
            <option value="進行中">進行中</option>
            <option value="已結束">已結束</option>
          </select>
        </div>
      </div>
      <div class="col-md-3">
        <div class="form-group-large">
          <label for="activityDateFilter">日期篩選</label>
          <input type="date" class="form-control-large" id="activityDateFilter">
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group-large">
          <label for="activitySearchFilter">搜尋關鍵字</label>
          <input type="text" class="form-control-large" id="activitySearchFilter" placeholder="輸入關鍵字">
        </div>
      </div>
      <div class="col-md-2" style="display: flex; align-items: end;">
        <button class="btn-large btn-info-large" onclick="filterActivities()" style="width: 100%;">
          <i class="bi bi-search"></i>
          查詢
        </button>
      </div>
    </div>

    <div class="activity-cards" id="activitiesList">
      <div class="loading-large">
        <div class="spinner-large"></div>
        <p>載入活動...</p>
      </div>
    </div>

    <div style="margin-top: 50px;">
      <h3 style="font-size: 1.8em; margin-bottom: 20px; color: #333;">
        <i class="bi bi-clipboard-check"></i> 我的活動報名
      </h3>
      <div class="activity-cards" id="myRegistrations">
        <div class="loading-large">
          <div class="spinner-large"></div>
          <p>載入中...</p>
        </div>
      </div>
    </div>
  </div>

  <div id="volunteer" class="content-section">
    <h2 class="section-title">
      <i class="bi bi-heart-fill"></i>
      志工服務
    </h2>

    <div class="admin-only" style="text-align: center; margin-bottom: 30px;">
      <button class="btn-large btn-success-large" onclick="showNewVolunteerNeedModal()">
        <i class="bi bi-plus-circle"></i>
        新增志工需求
      </button>
    </div>

    <div class="stats-grid">
      <div class="stat-card-large info">
        <h2 id="volunteerHours">0</h2>
        <p>服務時數</p>
      </div>
      <div class="stat-card-large warning">
        <h2 id="volunteerActivities">0</h2>
        <p>參與次數</p>
      </div>
      <div class="stat-card-large success">
        <h2 id="volunteerRank">-</h2>
        <p>志工排名</p>
      </div>
      <div class="stat-card-large danger">
        <h2 id="availableNeeds">0</h2>
        <p>可報名需求</p>
      </div>
    </div>

    <h3 style="font-size: 1.8em; margin: 40px 0 20px 0; color: #333;">
      <i class="bi bi-exclamation-circle"></i> 志工需求
    </h3>
    <div class="activity-cards" id="volunteerNeeds">
      <div class="loading-large">
        <div class="spinner-large"></div>
        <p>載入中...</p>
      </div>
    </div>

    <div style="margin-top: 50px;">
      <h3 style="font-size: 1.8em; margin-bottom: 20px; color: #333;">
        <i class="bi bi-journal-text"></i> 我的志工記錄
      </h3>
      <div class="activity-cards" id="myVolunteerRecords">
        <div class="loading-large">
          <div class="spinner-large"></div>
          <p>載入中...</p>
        </div>
      </div>
    </div>
  </div>

  <div id="finance" class="content-section">
    <h2 class="section-title">
      <i class="bi bi-cash-coin"></i>
      財務管理
    </h2>

    <div style="text-align: center; margin-bottom: 30px;">
      <button class="btn-large btn-success-large" onclick="showNewDonationModal()">
        <i class="bi bi-heart-fill"></i>
        愛心捐款
      </button>
      <button class="btn-large btn-warning-large" onclick="showNewExpenseModal()">
        <i class="bi bi-receipt"></i>
        支出申請
      </button>
    </div>

    <div class="stats-grid">
      <div class="stat-card-large success">
        <h2 id="myDonationAmount">NT$ 0</h2>
        <p>捐款總額</p>
      </div>
      <div class="stat-card-large info">
        <h2 id="myDonationCount">0</h2>
        <p>捐款次數</p>
      </div>
      <div class="stat-card-large warning">
        <h2 id="myExpenseAmount">NT$ 0</h2>
        <p>支出申請額</p>
      </div>
      <div class="stat-card-large danger">
        <h2 id="pendingExpenses">0</h2>
        <p>待審核</p>
      </div>
    </div>

    <h3 style="font-size: 1.8em; margin: 40px 0 20px 0; color: #333;">
      <i class="bi bi-heart-fill"></i> 我的捐款記錄
    </h3>
    <div class="activity-cards" id="donationHistory">
      <div class="loading-large">
        <div class="spinner-large"></div>
        <p>載入中...</p>
      </div>
    </div>

    <div style="margin-top: 50px;">
      <h3 style="font-size: 1.8em; margin-bottom: 20px; color: #333;">
        <i class="bi bi-receipt"></i> 我的支出申請
      </h3>
      <div class="activity-cards" id="expenseHistory">
        <div class="loading-large">
          <div class="spinner-large"></div>
          <p>載入中...</p>
        </div>
      </div>
    </div>

    <div class="admin-only" style="margin-top: 50px;">
      <h3 style="font-size: 1.8em; margin-bottom: 20px; color: #333;">
        <i class="bi bi-graph-up"></i> 財務總覽（管理員）
      </h3>
      <div class="stats-grid">
        <div class="stat-card-large success">
          <h2 id="totalIncome">NT$ 0</h2>
          <p>總收入</p>
        </div>
        <div class="stat-card-large danger">
          <h2 id="totalExpense">NT$ 0</h2>
          <p>總支出</p>
        </div>
        <div class="stat-card-large info">
          <h2 id="currentBalance">NT$ 0</h2>
          <p>目前餘額</p>
        </div>
        <div class="stat-card-large warning">
          <h2 id="monthlyDonations">NT$ 0</h2>
          <p>本月捐款</p>
        </div>
      </div>
      <div style="text-align: center; margin-top: 20px;">
        <button class="btn-large btn-info-large" onclick="showNewTransactionModal()">
          <i class="bi bi-plus-circle"></i>
          新增交易
        </button>
      </div>
    </div>
  </div>

  <div id="feedback" class="content-section">
    <h2 class="section-title">
      <i class="bi bi-chat-heart"></i>
      活動回饋
    </h2>

    <div style="background: white; border-radius: var(--border-radius); padding: 30px; margin-bottom: 30px; box-shadow: var(--card-shadow);">
      <h3 style="font-size: 1.6em; margin-bottom: 25px; color: #333;">
        <i class="bi bi-plus-circle"></i> 新增回饋
      </h3>
      <form id="feedbackForm">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group-large">
              <label for="feedbackActivity">選擇活動 *</label>
              <select class="form-select-large" id="feedbackActivity" name="feedbackActivity" required>
                <option value="">請選擇活動</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group-large">
              <label for="feedbackRating">評分 *</label>
              <select class="form-select-large" id="feedbackRating" name="feedbackRating" required>
                <option value="">請評分</option>
                <option value="5">⭐⭐⭐⭐⭐ 非常滿意</option>
                <option value="4">⭐⭐⭐⭐ 滿意</option>
                <option value="3">⭐⭐⭐ 普通</option>
                <option value="2">⭐⭐ 不滿意</option>
                <option value="1">⭐ 非常不滿意</option>
              </select>
            </div>
          </div>
          <div class="col-12">
            <div class="form-group-large">
              <label for="feedbackComment">意見與建議 *</label>
              <textarea class="form-control-large" id="feedbackComment" name="feedbackComment" rows="4" required></textarea>
            </div>
          </div>
        </div>
        <div style="text-align: center;">
          <button class="btn-large btn-primary-large" type="submit">
            <i class="bi bi-send"></i>
            提交回饋
          </button>
        </div>
      </form>
    </div>

    <h3 style="font-size: 1.8em; margin: 40px 0 20px 0; color: #333;">
      <i class="bi bi-chat-left-text"></i> 我的回饋記錄
    </h3>
    <div class="activity-cards" id="myFeedback">
      <div class="loading-large">
        <div class="spinner-large"></div>
        <p>載入中...</p>
      </div>
    </div>

    <div class="admin-only" style="margin-top: 50px;">
      <h3 style="font-size: 1.8em; margin-bottom: 20px; color: #333;">
        <i class="bi bi-chat-square-dots"></i> 全部回饋（管理員）
      </h3>
      <div class="activity-cards" id="allFeedback">
        <div class="loading-large">
          <div class="spinner-large"></div>
          <p>載入中...</p>
        </div>
      </div>
    </div>
  </div>

  <div id="admin" class="content-section">
    <h2 class="section-title">
      <i class="bi bi-gear"></i>
      系統管理
    </h2>

    <div class="nav-cards" style="margin-bottom: 30px;">
      <div class="nav-card" data-target="memberManagement">
        <i class="bi bi-people"></i>
        <h4>會員管理</h4>
        <p>管理會員資料</p>
      </div>
      <div class="nav-card" data-target="activityManagement">
        <i class="bi bi-calendar-event"></i>
        <h4>活動管理</h4>
        <p>管理活動資訊</p>
      </div>
      <div class="nav-card" data-target="financeManagement">
        <i class="bi bi-cash-stack"></i>
        <h4>財務管理</h4>
        <p>管理財務記錄</p>
      </div>
      <div class="nav-card" data-target="receiptManagement">
        <i class="bi bi-receipt"></i>
        <h4>收據管理</h4>
        <p>管理收據開立</p>
      </div>
    </div>

    <div id="memberManagement" class="admin-tab-content">
      <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
        <h3 style="font-size: 1.6em; margin: 0; color: #333;">會員列表</h3>
        <button class="btn-large btn-info-large" onclick="exportMembers()">
          <i class="bi bi-download"></i>
          匯出資料
        </button>
      </div>
      <div style="background: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--card-shadow); overflow-x: auto;">
        <table class="table table-hover" style="font-size: 1.1em;">
          <thead>
            <tr>
              <th style="padding: 15px;">姓名</th>
              <th style="padding: 15px;">類別</th>
              <th style="padding: 15px;">狀態</th>
              <th style="padding: 15px;">加入日期</th>
              <th style="padding: 15px;">捐款次數</th>
              <th style="padding: 15px;">操作</th>
            </tr>
          </thead>
          <tbody id="memberList">
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                <div class="spinner-large" style="width: 40px; height: 40px; border-width: 4px;"></div>
                <p style="margin-top: 15px;">載入中...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="activityManagement" class="admin-tab-content d-none">
      <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
        <h3 style="font-size: 1.6em; margin: 0; color: #333;">活動列表</h3>
        <button class="btn-large btn-success-large" onclick="showNewActivityModal()">
          <i class="bi bi-plus-circle"></i>
          新增活動
        </button>
      </div>
      <div class="activity-cards" id="adminActivityList">
        <div class="loading-large">
          <div class="spinner-large"></div>
          <p>載入中...</p>
        </div>
      </div>
    </div>

    <div id="financeManagement" class="admin-tab-content d-none">
      <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
        <h3 style="font-size: 1.6em; margin: 0; color: #333;">交易記錄</h3>
        <div>
          <button class="btn-large btn-success-large" onclick="showNewTransactionModal()">
            <i class="bi bi-plus-circle"></i>
            新增交易
          </button>
          <button class="btn-large btn-info-large" onclick="exportFinanceData()">
            <i class="bi bi-download"></i>
            匯出資料
          </button>
        </div>
      </div>
      <div style="background: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--card-shadow); overflow-x: auto;">
        <table class="table table-hover" style="font-size: 1.1em;">
          <thead>
            <tr>
              <th style="padding: 15px;">日期</th>
              <th style="padding: 15px;">類型</th>
              <th style="padding: 15px;">金額</th>
              <th style="padding: 15px;">分類</th>
              <th style="padding: 15px;">說明</th>
              <th style="padding: 15px;">狀態</th>
            </tr>
          </thead>
          <tbody id="transactionList">
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                <div class="spinner-large" style="width: 40px; height: 40px; border-width: 4px;"></div>
                <p style="margin-top: 15px;">載入中...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="receiptManagement" class="admin-tab-content d-none">
      <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
        <h3 style="font-size: 1.6em; margin: 0; color: #333;">收據列表</h3>
        <div>
          <button class="btn-large btn-info-large" onclick="showReceiptTemplateModal()">
            <i class="bi bi-file-text"></i>
            模板設定
          </button>
          <button class="btn-large btn-success-large" onclick="showManualReceiptModal()">
            <i class="bi bi-plus-circle"></i>
            手動開立
          </button>
        </div>
      </div>
      <div class="activity-cards" id="receiptList">
        <div class="loading-large">
          <div class="spinner-large"></div>
          <p>載入中...</p>
        </div>
      </div>
    </div>

    <div style="margin-top: 50px; text-align: center;">
      <h3 style="font-size: 1.6em; margin-bottom: 20px; color: #333;">系統工具</h3>
      <button class="btn-large btn-warning-large" onclick="backupSystem()">
        <i class="bi bi-database"></i>
        立即備份
      </button>
      <button class="btn-large btn-info-large" onclick="showSystemNotificationModal()">
        <i class="bi bi-megaphone"></i>
        發送通知
      </button>
    </div>
  </div>

</div>

<div id="modalContainer"></div>

<script>
  // ========== 設定 ==========
  const CONFIG = {
    LIFF_ID: '1656516134-VaGgmaPm',
    API_BASE_URL: 'https://script.google.com/macros/s/AKfycbz29iFfhyXpW1hbpwSqjTF1NfcrfTsE2TveydrhWofS8O5RM4SuQSM_DfvGLeLTzSWA/exec',
    API_KEY: 'AAbb8520258185202581'
  };

  // ========== 全域狀態 ==========
  let userProfile = null;
  let currentUser = null;
  let isAdmin = false;
  let allActivities = [];
  let cachedAdminData = null;

  // ========== 工具函數 ==========
  const formatDate = d => {
    if(!d) return '-';
    const dt = new Date(d);
    if(isNaN(dt)) return '-';
    return dt.toLocaleDateString('zh-TW');
  };

  const formatDateTime = d => {
    if(!d) return '-';
    const dt = new Date(d);
    if(isNaN(dt)) return '-';
    return dt.toLocaleString('zh-TW');
  };

  const formatCurrency = n =>
    new Intl.NumberFormat('zh-TW',{style:'currency',currency:'TWD',minimumFractionDigits:0}).format(n||0);

  function showNotification(msg, type='success', ms=4000) {
    const wrap = document.getElementById('notificationContainer');
    const el = document.createElement('div');
    el.className = `notification-large ${type}`;
    el.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <span>${msg}</span>
        <button style="background:none;border:none;font-size:24px;line-height:1;margin-left:15px;" onclick="this.closest('.notification-large').remove()">&times;</button>
      </div>`;
    wrap.appendChild(el);
    requestAnimationFrame(() => el.classList.add('show'));
    setTimeout(() => {
      el.classList.remove('show');
      setTimeout(() => el.remove(), 350);
    }, ms);
  }

  function setButtonLoading(btn, loading=true) {
    if(!btn) return;
    if(loading) {
      if(!btn.dataset.originalText) btn.dataset.originalText = btn.innerHTML;
      btn.innerHTML = '<i class="bi bi-arrow-repeat" style="animation: spin 1s linear infinite;"></i> 處理中...';
      btn.disabled = true;
    } else {
      btn.disabled = false;
      if(btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText;
    }
  }

  async function callAPI(action, data={}, retries=2) {
    const payload = {
      action,
      apiKey: CONFIG.API_KEY,
      timestamp: Date.now(),
      ...data
    };
    let lastErr;
    for(let i=0; i<=retries; i++) {
      try {
        const res = await fetch(CONFIG.API_BASE_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        let json;
        try { 
          json = JSON.parse(text); 
        } catch(e) { 
          throw new Error('回應非 JSON: ' + text.slice(0,120)); 
        }
        if(!json.success) throw new Error(json.message || 'API 錯誤');
        return json;
      } catch(err) {
        lastErr = err;
        await new Promise(r => setTimeout(r, 400*(i+1)));
      }
    }
    throw lastErr;
  }

  // ========== 導航功能 ==========
  function showSection(sectionId) {
    // 隱藏所有內容區域
    document.querySelectorAll('.content-section').forEach(section => {
      section.classList.remove('active');
    });
    
    // 移除所有導航卡片的 active 狀態
    document.querySelectorAll('.nav-card').forEach(card => {
      card.classList.remove('active');
    });
    
    // 顯示目標區域
    const targetSection = document.getElementById(sectionId);
    if(targetSection) {
      targetSection.classList.add('active');
    }
    
    // 設定對應導航卡片為 active
    const targetCard = document.querySelector(`[data-target="${sectionId}"]`);
    if(targetCard) {
      targetCard.classList.add('active');
    }
    
    // 載入對應資料
    switch(sectionId) {
      case 'activities': 
        loadActivities(); 
        loadMyRegistrations(); 
        break;
      case 'volunteer': 
        loadVolunteerData(); 
        break;
      case 'finance': 
        loadFinanceData(); 
        break;
      case 'feedback': 
        loadFeedbackData(); 
        break;
      case 'admin': 
        if(isAdmin) loadAdminData(); 
        break;
    }
  }

  function showAdminTab(tabId) {
    // 隱藏所有管理員分頁
    document.querySelectorAll('.admin-tab-content').forEach(tab => {
      tab.classList.add('d-none');
    });
    
    // 顯示目標分頁
    const targetTab = document.getElementById(tabId);
    if(targetTab) {
      targetTab.classList.remove('d-none');
    }
  }

  // ========== LIFF 初始化 ==========
  async function initializeLiff() {
    try {
      await liff.init({ liffId: CONFIG.LIFF_ID });
      if(!liff.isLoggedIn()) { 
        liff.login(); 
        return; 
      }
      userProfile = await liff.getProfile();
      
      // 顯示使用者資訊
      const userCard = document.getElementById('userInfoCard');
      userCard.classList.remove('d-none');
      document.getElementById('userLineName').textContent = 'LINE：' + (userProfile.displayName || '');
      document.getElementById('userName').textContent = userProfile.displayName || '會員';
      document.getElementById('userAvatar').textContent = (userProfile.displayName || '?').charAt(0);

      await loadUserData();
      await loadDashboard();
      showNotification('歡迎使用帕金森病友會管理系統！', 'success');
    } catch(err) {
      console.error(err);
      showNotification('系統初始化失敗，請重新整理頁面', 'error');
    }
  }

  // ========== 使用者管理 ==========
  async function loadUserData() {
    try {
      const r = await callAPI('getUserInfo', { lineId: userProfile.userId });
      if(r.success && r.data) {
        currentUser = r.data;
        isAdmin = !!currentUser.isAdmin;
        updateUserUI();
      } else {
        showRegistrationForm();
      }
    } catch {
      showRegistrationForm();
    }
  }

  function updateUserUI() {
    if(!currentUser) return;
    document.getElementById('userName').textContent = 
      currentUser.realName || currentUser.lineName || userProfile.displayName || '會員';
    document.getElementById('userRole').textContent = currentUser.memberType || '會員';
    document.getElementById('userAvatar').textContent = 
      (currentUser.realName || currentUser.lineName || userProfile.displayName || '?').charAt(0);
    
    // 顯示/隱藏管理員功能
    document.querySelectorAll('.admin-only').forEach(el => {
      el.style.display = isAdmin ? 'block' : 'none';
    });
    
    updateProfileSection();
  }

  function showRegistrationForm() {
    document.getElementById('registrationSection').style.display = 'block';
      document.getElementById('profileSection').classList.add('d-none');
    }

    function updateProfileSection() {
      if(!currentUser) return;
      document.getElementById('registrationSection').style.display = 'none';
      document.getElementById('profileSection').classList.remove('d-none');
      
      document.getElementById('profileRealName').value = currentUser.realName || '';
      document.getElementById('lineName').value = currentUser.lineName || userProfile.displayName || '';
      document.getElementById('phone').value = currentUser.phone || '';
      document.getElementById('email').value = currentUser.email || '';
      document.getElementById('birthday').value = currentUser.birthday || '';
      document.getElementById('profileMemberType').value = currentUser.memberType || '病友';
      document.getElementById('address').value = currentUser.address || '';
      
      // 顯示個人統計
      document.getElementById('profileStats').innerHTML = `
        <div class="stat-card-large info">
          <h2>${currentUser.memberType || '-'}</h2>
          <p>會員身份</p>
        </div>
      `;
    }

    // ========== 表單事件處理 ==========
    document.getElementById('registrationForm').addEventListener('submit', async e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn, true);
      try {
        await callAPI('registerUser', {
          lineId: userProfile.userId,
          lineName: userProfile.displayName,
          realName: fd.get('realName'),
          memberType: fd.get('memberType')
        });
        showNotification('註冊成功！歡迎加入帕金森病友會', 'success');
        await loadUserData();
      } catch(err) {
        showNotification('註冊失敗：' + err.message, 'error');
      } finally { 
        setButtonLoading(btn, false); 
      }
    });

    document.getElementById('profileForm').addEventListener('submit', async e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn, true);
      try {
        await callAPI('updateProfile', {
          lineId: userProfile.userId,
          phone: fd.get('phone'),
          email: fd.get('email'),
          birthday: fd.get('birthday'),
          memberType: fd.get('memberType'),
          address: fd.get('address')
        });
        showNotification('資料更新成功', 'success');
        await loadUserData();
      } catch(err) {
        showNotification('更新失敗：' + err.message, 'error');
      } finally { 
        setButtonLoading(btn, false); 
      }
    });

    // ========== 儀表板 ==========
    async function loadDashboard() {
      try {
        const r = await callAPI('getDashboardData', { lineId: userProfile?.userId });
        renderDashboardStats(r.data);
        renderRecentActivity(r.data.recentActivity || []);
      } catch(err) {
        document.getElementById('dashboardStats').innerHTML = 
          `<div style="text-align: center; color: #dc3545; font-size: 1.2em;">載入失敗：${err.message}</div>`;
      }
    }

    function renderDashboardStats(d) {
      document.getElementById('dashboardStats').innerHTML = `
        <div class="stat-card-large success">
          <h2>${d.totalActivities || 0}</h2>
          <p>可報名活動</p>
        </div>
        <div class="stat-card-large info">
          <h2>${d.myRegistrations || 0}</h2>
          <p>我的報名</p>
        </div>
        <div class="stat-card-large warning">
          <h2>${d.myVolunteerHours || 0}</h2>
          <p>志工時數</p>
        </div>
        <div class="stat-card-large danger">
          <h2>${formatCurrency(d.myDonationAmount || 0).replace('NT$', '')}</h2>
          <p>捐款總額</p>
        </div>
      `;
    }

    function renderRecentActivity(list) {
      const c = document.getElementById('recentActivity');
      if(!list.length) {
        c.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.2em;">暫無最近活動</p>';
        return;
      }
      c.innerHTML = list.map(a => `
        <div class="activity-card-large">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <h3>${a.title || ''}</h3>
              <div style="color: #666; margin-bottom: 10px;">${a.description || ''}</div>
              <div style="color: #888; font-size: 1em;">
                <i class="bi bi-calendar"></i> ${formatDate(a.date)}
              </div>
            </div>
            <span class="status-badge-large status-${(a.status || '').trim()}">${a.status || ''}</span>
          </div>
        </div>
      `).join('');
    }

    // ========== 活動管理 ==========
    async function loadActivities() {
      try {
        const r = await callAPI('getActivities');
        allActivities = r.data || [];
        renderActivities(allActivities);
      } catch(err) {
        document.getElementById('activitiesList').innerHTML = 
          `<div style="text-align: center; color: #dc3545; padding: 40px; font-size: 1.2em;">載入失敗：${err.message}</div>`;
      }
    }

    function renderActivities(list) {
      const c = document.getElementById('activitiesList');
      if(!list.length) {
        c.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.2em;">目前沒有活動</p>';
        return;
      }
      c.innerHTML = list.map(a => `
        <div class="activity-card-large">
          <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px;">
              <h3>${a.title}</h3>
              <div class="activity-description">${a.description || ''}</div>
              <div class="activity-meta">
                <span><i class="bi bi-calendar"></i>${formatDate(a.date)}</span>
                <span><i class="bi bi-clock"></i>${a.time || '-'}</span>
                <span><i class="bi bi-geo-alt"></i>${a.location || '-'}</span>
                <span><i class="bi bi-people"></i>${a.currentCount || 0}/${a.maxParticipants || 0}</span>
              </div>
            </div>
            <div style="text-align: right; min-width: 200px;">
              <span class="status-badge-large status-${a.status}">${a.status}</span><br>
              <div style="font-size: 1.4em; font-weight: 700; color: var(--primary-color); margin: 15px 0;">
                ${formatCurrency(a.fee || 0)}
              </div>
              ${(a.status === '開放報名') ? 
                `<button class="btn-large btn-primary-large" onclick="registerActivity('${a.id}')">
                  <i class="bi bi-plus-circle"></i>立即報名
                </button>` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function filterActivities() {
      const s = document.getElementById('activityStatusFilter').value.trim();
      const d = document.getElementById('activityDateFilter').value.trim();
      const kw = document.getElementById('activitySearchFilter').value.trim().toLowerCase();
      let list = [...allActivities];
      if(s) list = list.filter(a => a.status === s);
      if(d) list = list.filter(a => (a.date || '').startsWith(d));
      if(kw) list = list.filter(a => 
        (a.title || '').toLowerCase().includes(kw) ||
        (a.description || '').toLowerCase().includes(kw) ||
        (a.location || '').toLowerCase().includes(kw)
      );
      renderActivities(list);
    }

    async function registerActivity(id) {
      if(!currentUser) { 
        showNotification('請先完成註冊', 'warning'); 
        return; 
      }
      try {
        await callAPI('registerActivity', { lineId: userProfile.userId, activityId: id });
        showNotification('報名成功！', 'success');
        await loadActivities();
        await loadMyRegistrations();
      } catch(err) {
        showNotification('報名失敗：' + err.message, 'error');
      }
    }

    async function loadMyRegistrations() {
      if(!currentUser) return;
      try {
        const r = await callAPI('getMyRegistrations', { lineId: userProfile.userId });
        renderMyRegistrations(r.data || []);
      } catch(err) {
        document.getElementById('myRegistrations').innerHTML = 
          `<div style="text-align: center; color: #dc3545; font-size: 1.2em;">載入失敗：${err.message}</div>`;
      }
    }

    function renderMyRegistrations(list) {
      const c = document.getElementById('myRegistrations');
      if(!list.length) {
        c.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.2em;">尚無報名記錄</p>';
        return;
      }
      c.innerHTML = list.map(r => `
        <div class="activity-card-large">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <h3>${r.activityTitle}</h3>
              <div style="color: #666; margin-bottom: 10px;">
                <i class="bi bi-calendar"></i> 報名時間：${formatDateTime(r.registrationTime)}
              </div>
              <div style="color: #888;">狀態：${r.status}</div>
            </div>
            <div style="text-align: right;">
              <span class="status-badge-large status-${r.status}">${r.status}</span><br>
              ${(r.status === '已報名') ? 
                `<button class="btn-large btn-danger-large" onclick="cancelRegistration('${r.id}')" style="margin-top: 15px;">
                  <i class="bi bi-x-circle"></i>取消報名
                </button>` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    async function cancelRegistration(regId) {
      if(!confirm('確定要取消這筆報名嗎？')) return;
      try {
        await callAPI('cancelRegistration', { lineId: userProfile.userId, registrationId: regId });
        showNotification('已成功取消報名', 'success');
        await loadMyRegistrations();
        await loadActivities();
      } catch(err) {
        showNotification('取消失敗：' + err.message, 'error');
      }
    }

    // ========== 志工服務 ==========
    async function loadVolunteerData() {
      if(!currentUser) return;
      try {
        const r = await callAPI('getVolunteerData', { lineId: userProfile.userId });
        const s = r.data.stats;
        document.getElementById('volunteerHours').textContent = s.totalHours || 0;
        document.getElementById('volunteerActivities').textContent = s.totalActivities || 0;
        document.getElementById('volunteerRank').textContent = s.rank || '-';
        document.getElementById('availableNeeds').textContent = s.availableNeeds || 0;
        renderVolunteerNeeds(r.data.needs || []);
        renderVolunteerRecords(r.data.records || []);
      } catch(err) {
        console.error(err);
      }
    }

    function renderVolunteerNeeds(list) {
      const c = document.getElementById('volunteerNeeds');
      if(!list.length) {
        c.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.2em;">目前無志工需求</p>';
        return;
      }
      c.innerHTML = list.map(n => `
        <div class="activity-card-large">
          <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px;">
              <h3>${n.title}</h3>
              <div class="activity-description">${n.description || ''}</div>
              <div class="activity-meta">
                <span><i class="bi bi-calendar"></i>${formatDate(n.date)}</span>
                <span><i class="bi bi-clock"></i>${n.time || '-'}</span>
                <span><i class="bi bi-people"></i>${n.currentCount || 0}/${n.needCount}</span>
                <span><i class="bi bi-award"></i>${n.hours} 小時</span>
              </div>
            </div>
            <div style="text-align: right;">
              <span class="status-badge-large status-${n.status}">${n.status}</span><br>
              ${(n.status === '開放報名') ? 
                `<button class="btn-large btn-success-large" onclick="applyVolunteer('${n.id}')" style="margin-top: 15px;">
                  <i class="bi bi-hand-thumbs-up"></i>我要報名
                </button>` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderVolunteerRecords(list) {
      const c = document.getElementById('myVolunteerRecords');
      if(!list.length) {
        c.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.2em;">尚無志工服務記錄</p>';
        return;
      }
      c.innerHTML = list.map(r => `
        <div class="activity-card-large">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <h3>${r.title}</h3>
              <div style="color: #666; margin-bottom: 10px;">
                <i class="bi bi-calendar"></i> ${formatDate(r.date)} / ${r.hours} 小時
              </div>
              <div style="color: #888;">狀態：${r.status}</div>
            </div>
            <span class="status-badge-large status-${r.status}">${r.status}</span>
          </div>
        </div>
      `).join('');
    }

    async function applyVolunteer(id) {
      if(!currentUser) { 
        showNotification('請先完成註冊', 'warning'); 
        return; 
      }
      try {
        await callAPI('applyVolunteer', { lineId: userProfile.userId, needId: id });
        showNotification('志工報名成功！', 'success');
        await loadVolunteerData();
      } catch(err) {
        showNotification('報名失敗：' + err.message, 'error');
      }
    }

    // ========== 財務管理 ==========
    async function loadFinanceData() {
      if(!currentUser) return;
      try {
        const r = await callAPI('getFinanceData', { lineId: userProfile.userId });
        const s = r.data.stats;
        document.getElementById('myDonationAmount').textContent = formatCurrency(s.totalDonation || 0).replace('NT$', '');
        document.getElementById('myDonationCount').textContent = s.donationCount || 0;
        document.getElementById('myExpenseAmount').textContent = formatCurrency(s.totalExpense || 0).replace('NT$', '');
        document.getElementById('pendingExpenses').textContent = s.pendingExpenses || 0;
        renderDonationHistory(r.data.donations || []);
        renderExpenseHistory(r.data.expenses || []);
        if(r.data.adminStats && isAdmin) updateAdminFinanceStats(r.data.adminStats);
      } catch(err) { 
        console.error(err); 
      }
    }

    function renderDonationHistory(list) {
      const c = document.getElementById('donationHistory');
      if(!list.length) {
        c.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.2em;">尚無捐款記錄</p>';
        return;
      }
      c.innerHTML = list.map(d => `
        <div class="activity-card-large">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <h3>捐款 - ${d.category}</h3>
              <div style="color: #666; margin-bottom: 10px;">${d.description || ''}</div>
              <div style="color: #888;">
                <i class="bi bi-calendar"></i> ${formatDateTime(d.date)}
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 1.6em; font-weight: 700; color: var(--success-color);">
                ${formatCurrency(d.amount)}
              </div>
              <div style="color: #666; margin-top: 5px;">
                收據：${d.receiptNumber || '處理中'}
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderExpenseHistory(list) {
      const c = document.getElementById('expenseHistory');
      if(!list.length) {
        c.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.2em;">尚無支出申請</p>';
        return;
      }
      c.innerHTML = list.map(e => `
        <div class="activity-card-large">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <h3>支出 - ${e.category}</h3>
              <div style="color: #666; margin-bottom: 10px;">${e.description || ''}</div>
              <div style="color: #888;">
                <i class="bi bi-calendar"></i> ${formatDateTime(e.date)}
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 1.6em; font-weight: 700; color: var(--danger-color);">
                ${formatCurrency(e.amount)}
              </div>
              <span class="status-badge-large status-${e.status}" style="margin-top: 10px;">${e.status}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    function updateAdminFinanceStats(s) {
      document.getElementById('totalIncome').textContent = formatCurrency(s.totalIncome);
      document.getElementById('totalExpense').textContent = formatCurrency(s.totalExpense);
      document.getElementById('currentBalance').textContent = formatCurrency(s.currentBalance);
      document.getElementById('monthlyDonations').textContent = formatCurrency(s.monthlyDonations);
    }

    // ========== Modal 功能 ==========
    function showNewDonationModal() {
      if(!currentUser) { 
        showNotification('請先完成註冊', 'warning'); 
        return; 
      }
      const html = `
        <div class="modal fade" id="donationModal" tabindex="-1" style="z-index: 2050;">
          <div class="modal-dialog modal-lg">
            <form class="modal-content" id="donationForm" style="font-size: 1.1em;">
              <div class="modal-header" style="padding: 25px;">
                <h4 class="modal-title"><i class="bi bi-heart-fill me-2"></i>愛心捐款</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="font-size: 1.5em;"></button>
              </div>
              <div class="modal-body" style="padding: 30px;">
                <div class="form-group-large">
                  <label for="donationCategory">捐款類別 *</label>
                  <select class="form-select-large" id="donationCategory" name="donationCategory" required>
                    <option value="">請選擇類別</option>
                    <option value="一般捐款">一般捐款</option>
                    <option value="活動贊助">活動贊助</option>
                    <option value="設備購置">設備購置</option>
                    <option value="其他">其他</option>
                  </select>
                </div>
                <div class="form-group-large">
                  <label for="donationAmount">捐款金額 *</label>
                  <input type="number" class="form-control-large" id="donationAmount" name="donationAmount" min="1" required>
                </div>
                <div class="form-group-large">
                  <label for="donationDescription">備註說明</label>
                  <textarea class="form-control-large" id="donationDescription" name="donationDescription" rows="3"></textarea>
                </div>
                <div style="margin-top: 20px;">
                  <label style="display: flex; align-items: center; font-size: 1.1em; cursor: pointer;">
                    <input type="checkbox" id="needReceipt" name="needReceipt" checked style="width: 20px; height: 20px; margin-right: 10px;">
                    需要開立收據
                  </label>
                </div>
              </div>
              <div class="modal-footer" style="padding: 25px;">
                <button class="btn-large btn-secondary" type="button" data-bs-dismiss="modal">取消</button>
                <button class="btn-large btn-success-large" type="submit">
                  <i class="bi bi-heart-fill"></i>確認捐款
                </button>
              </div>
            </form>
          </div>
        </div>`;
      document.getElementById('modalContainer').innerHTML = html;
      const modal = new bootstrap.Modal(document.getElementById('donationModal'));
      modal.show();
      document.getElementById('donationForm').addEventListener('submit', handleDonationSubmit);
    }

    async function handleDonationSubmit(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn, true);
      try {
        await callAPI('createDonation', {
          lineId: userProfile.userId,
          category: fd.get('donationCategory'),
          amount: parseInt(fd.get('donationAmount'), 10),
          description: fd.get('donationDescription'),
          needReceipt: fd.get('needReceipt') === 'on'
        });
        showNotification('捐款成功，感謝您的愛心！', 'success');
        bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
        await loadFinanceData();
      } catch(err) {
        showNotification('捐款失敗：' + err.message, 'error');
      } finally { 
        setButtonLoading(btn, false); 
      }
    }

    // ========== 其他 Modal 和功能 ==========
    function showNewExpenseModal() {
      if(!currentUser) { 
        showNotification('請先完成註冊', 'warning'); 
        return; 
      }
      // 類似 donationModal 的實作...
      showNotification('支出申請功能開發中', 'info');
    }

    function showNewActivityModal() {
      if(!isAdmin) { 
        showNotification('權限不足', 'error'); 
        return; 
      }
      showNotification('新增活動功能開發中', 'info');
    }

    function showNewVolunteerNeedModal() {
      if(!isAdmin) { 
        showNotification('權限不足', 'error'); 
        return; 
      }
      showNotification('新增志工需求功能開發中', 'info');
    }

    function showNewTransactionModal() {
      if(!isAdmin) { 
        showNotification('權限不足', 'error'); 
        return; 
      }
      showNotification('新增交易功能開發中', 'info');
    }

    function showManualReceiptModal() {
      if(!isAdmin) { 
        showNotification('權限不足', 'error'); 
        return; 
      }
      showNotification('手動開立收據功能開發中', 'info');
    }

    function showReceiptTemplateModal() {
      showNotification('收據模板設定功能開發中', 'info');
    }

    function showSystemNotificationModal() {
      if(!isAdmin) { 
        showNotification('權限不足', 'error'); 
        return; 
      }
      showNotification('系統通知功能開發中', 'info');
    }

    // ========== 回饋功能 ==========
    async function loadFeedbackData() {
      if(!currentUser) return;
      try {
        const acts = await callAPI('getMyCompletedActivities', { lineId: userProfile.userId });
        populateFeedbackActivities(acts.data || []);
        const my = await callAPI('getMyFeedback', { lineId: userProfile.userId });
        renderMyFeedback(my.data || []);
        if(isAdmin) {
          const all = await callAPI('getAllFeedback', { lineId: userProfile.userId });
          renderAllFeedback(all.data || []);
        }
      } catch(err) { 
        console.error(err); 
      }
    }

    function populateFeedbackActivities(list) {
      const sel = document.getElementById('feedbackActivity');
      sel.innerHTML = '<option value="">請選擇活動</option>';
      list.forEach(a => {
        sel.innerHTML += `<option value="${a.id}">${a.title} (${formatDate(a.date)})</option>`;
      });
    }

    function renderMyFeedback(list) {
      const c = document.getElementById('myFeedback');
      if(!list.length) { 
        c.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.2em;">尚無回饋記錄</p>'; 
        return; 
      }
      c.innerHTML = list.map(f => `
        <div class="activity-card-large">
          <h3>${f.activityTitle}</h3>
          <div style="margin: 15px 0; font-size: 1.2em;">
            ${'★'.repeat(f.rating)}${'☆'.repeat(5-f.rating)} 
            <span style="color: #666;">(${f.rating}/5)</span>
          </div>
          <div style="color: #555; margin-bottom: 15px; line-height: 1.6;">${f.comment}</div>
          <div style="color: #888;">
            <i class="bi bi-calendar"></i> ${formatDateTime(f.createdAt)}
          </div>
        </div>
      `).join('');
    }

    function renderAllFeedback(list) {
      const c = document.getElementById('allFeedback');
      if(!list.length) { 
        c.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.2em;">無回饋資料</p>'; 
        return; 
      }
      c.innerHTML = list.map(f => `
        <div class="activity-card-large">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <h3>${f.activityTitle}</h3>
              <div style="margin: 15px 0; font-size: 1.2em;">
                ${'★'.repeat(f.rating)}${'☆'.repeat(5-f.rating)} 
                <span style="color: #666;">(${f.rating}/5)</span>
              </div>
              <div style="color: #555; margin-bottom: 15px; line-height: 1.6;">${f.comment}</div>
              <div style="color: #888;">${formatDateTime(f.createdAt)}</div>
            </div>
            <div style="color: #888; font-size: 0.9em;">${f.lineId}</div>
          </div>
        </div>
      `).join('');
    }

    document.getElementById('feedbackForm').addEventListener('submit', async e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn, true);
      try {
        await callAPI('createFeedback', {
          lineId: userProfile.userId,
          activityId: fd.get('feedbackActivity'),
          rating: parseInt(fd.get('feedbackRating'), 10),
          comment: fd.get('feedbackComment')
        });
        showNotification('回饋提交成功，感謝您的意見！', 'success');
        e.target.reset();
        await loadFeedbackData();
      } catch(err) {
        showNotification('提交失敗：' + err.message, 'error');
      } finally { 
        setButtonLoading(btn, false); 
      }
    });

    // ========== 管理員功能 ==========
    async function loadAdminData() {
      if(!isAdmin) return;
      try {
        const r = await callAPI('getAdminData', { lineId: userProfile.userId });
        cachedAdminData = r.data;
        renderMemberList(r.data.members || []);
        renderAdminActivities(r.data.activities || []);
        renderTransactions(r.data.transactions || []);
        renderReceipts(r.data.receipts || []);
      } catch(err) { 
        console.error(err); 
      }
    }

    function renderMemberList(list) {
      const tb = document.getElementById('memberList');
      if(!list.length) {
        tb.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 40px;">暫無會員資料</td></tr>';
        return;
      }
      tb.innerHTML = list.map(m => `
        <tr>
          <td style="padding: 15px;">${m.realName || m.lineName || '-'}</td>
          <td style="padding: 15px;">${m.memberType || '-'}</td>
          <td style="padding: 15px;">
            <span class="status-badge-large status-${m.status || ''}">${m.status || ''}</span>
          </td>
          <td style="padding: 15px;">${formatDate(m.joinDate)}</td>
          <td style="padding: 15px;">${m.donationCount || 0}</td>
          <td style="padding: 15px;">
            <button class="btn-large btn-info-large" onclick="viewMemberDetail('${m.lineId}')" style="padding: 10px 15px; font-size: 1em;">
              <i class="bi bi-eye"></i>查看
            </button>
          </td>
        </tr>
      `).join('');
    }

    function renderAdminActivities(list) {
      const c = document.getElementById('adminActivityList');
      if(!list.length) {
        c.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.2em;">無活動資料</p>';
        return;
      }
      c.innerHTML = list.map(a => `
        <div class="activity-card-large">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <h3>${a.title}</h3>
              <div style="color: #666; margin-bottom: 10px;">
                ${formatDate(a.date)} / ${a.location || ''}
              </div>
            </div>
            <div style="text-align: right;">
              <span class="status-badge-large status-${a.status}">${a.status}</span><br>
              <div style="color: #888; margin-top: 10px;">
                ${a.currentCount || 0}/${a.maxParticipants || 0} 人
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderTransactions(list) {
      const tb = document.getElementById('transactionList');
      if(!list.length) { 
        tb.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 40px;">無交易記錄</td></tr>'; 
        return; 
      }
      tb.innerHTML = list.map(t => `
        <tr>
          <td style="padding: 15px;">${formatDateTime(t.date)}</td>
          <td style="padding: 15px;">${t.type}</td>
          <td style="padding: 15px;" class="${t.type === '收入' ? 'text-success' : 'text-danger'}">
            ${formatCurrency(t.amount)}
          </td>
          <td style="padding: 15px;">${t.category || ''}</td>
          <td style="padding: 15px;">${t.description || ''}</td>
          <td style="padding: 15px;">
            ${t.status ? `<span class="status-badge-large status-${t.status}">${t.status}</span>` : ''}
          </td>
        </tr>
      `).join('');
    }

    function renderReceipts(list) {
      const c = document.getElementById('receiptList');
      if(!list.length) { 
        c.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.2em;">尚無收據記錄</p>'; 
        return; 
      }
      c.innerHTML = list.map(r => `
        <div class="activity-card-large">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <h3>${r.receiptNumber}</h3>
              <div style="color: #666; margin-bottom: 10px;">
                ${formatDate(r.issueDate)} / ${r.type}
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 1.4em; font-weight: 700; color: var(--success-color);">
                ${formatCurrency(r.amount)}
              </div>
              <span class="status-badge-large status-${r.status}" style="margin-top: 10px;">${r.status}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    function viewMemberDetail(lineId) {
      const member = (cachedAdminData?.members || []).find(m => m.lineId === lineId);
      if(!member) { 
        showNotification('找不到會員資料', 'error'); 
        return; 
      }
      const html = `
        <div class="modal fade" id="memberDetailModal" tabindex="-1" style="z-index: 2050;">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content" style="font-size: 1.1em;">
              <div class="modal-header" style="padding: 25px;">
                <h4 class="modal-title">
                  <i class="bi bi-person me-2"></i>${member.realName || member.lineName || lineId}
                </h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="font-size: 1.5em;"></button>
              </div>
              <div class="modal-body" style="padding: 30px;">
                <div style="background: #f8f9fa; border-radius: 15px; padding: 25px;">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <strong>LINE ID：</strong>${member.lineId}
                    </div>
                    <div class="col-md-6">
                      <strong>真實姓名：</strong>${member.realName || '-'}
                    </div>
                    <div class="col-md-6">
                      <strong>會員類別：</strong>${member.memberType || '-'}
                    </div>
                    <div class="col-md-6">
                      <strong>聯絡電話：</strong>${member.phone || '-'}
                    </div>
                    <div class="col-md-6">
                      <strong>電子郵件：</strong>${member.email || '-'}
                    </div>
                    <div class="col-md-6">
                      <strong>生日：</strong>${member.birthday || '-'}
                    </div>
                    <div class="col-12">
                      <strong>通訊地址：</strong>${member.address || '-'}
                    </div>
                    <div class="col-md-6">
                      <strong>會員狀態：</strong>
                      <span class="status-badge-large status-${member.status || ''}">${member.status || '-'}</span>
                    </div>
                    <div class="col-md-6">
                      <strong>捐款次數：</strong>${member.donationCount || 0} 次
                    </div>
                    <div class="col-12">
                      <strong>加入日期：</strong>${formatDate(member.joinDate)}
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer" style="padding: 25px;">
                <button class="btn-large btn-secondary" data-bs-dismiss="modal">關閉</button>
              </div>
            </div>
          </div>
        </div>`;
      document.getElementById('modalContainer').innerHTML = html;
      new bootstrap.Modal(document.getElementById('memberDetailModal')).show();
    }

    // ========== 匯出和備份功能 ==========
    async function exportMembers() {
      if(!isAdmin) { 
        showNotification('權限不足', 'error'); 
        return; 
      }
      try {
        const r = await callAPI('exportMembers', { lineId: userProfile.userId });
        showNotification('會員資料匯出成功', 'success');
        console.log(r.data);
      } catch(err) { 
        showNotification('匯出失敗：' + err.message, 'error'); 
      }
    }

    async function exportFinanceData() {
      if(!isAdmin) { 
        showNotification('權限不足', 'error'); 
        return; 
      }
      try {
        const r = await callAPI('exportFinanceData', { lineId: userProfile.userId });
        showNotification('財務資料匯出成功', 'success');
        console.log(r.data);
      } catch(err) { 
        showNotification('匯出失敗：' + err.message, 'error'); 
      }
    }

    async function backupSystem() {
      if(!isAdmin) { 
        showNotification('權限不足', 'error'); 
        return; 
      }
      try {
        const r = await callAPI('backupSystem', { lineId: userProfile.userId });
        showNotification('系統備份完成', 'success');
        console.log(r.data);
      } catch(err) { 
        showNotification('備份失敗：' + err.message, 'error'); 
      }
    }

    // ========== 刷新功能 ==========
    async function refreshData() {
      try {
        await Promise.all([
          loadDashboard(),
          loadActivities(),
          loadMyRegistrations(),
          loadVolunteerData(),
          loadFinanceData(),
          loadFeedbackData(),
          isAdmin ? loadAdminData() : Promise.resolve()
        ]);
        showNotification('資料刷新完成', 'success');
      } catch(err) {
        showNotification('刷新失敗：' + err.message, 'error');
      }
    }

    // ========== 事件監聽器 ==========
    document.addEventListener('DOMContentLoaded', () => {
      // 導航卡片點擊事件
      document.querySelectorAll('.nav-card').forEach(card => {
        card.addEventListener('click', () => {
          const target = card.getAttribute('data-target');
          if(target) {
            showSection(target);
          }
        });
      });

      // 管理員分頁卡片點擊事件
      document.addEventListener('click', (e) => {
        const card = e.target.closest('.nav-card[data-target]');
        if(card && card.closest('#admin')) {
          const target = card.getAttribute('data-target');
          if(['memberManagement', 'activityManagement', 'financeManagement', 'receiptManagement'].includes(target)) {
            showAdminTab(target);
          }
        }
      });
    });

    // 禁用非 textarea 的 Enter 提交
    document.addEventListener('keydown', e => {
      if(e.key === 'Enter' && !['TEXTAREA', 'BUTTON'].includes(e.target.tagName)) {
        e.preventDefault();
      }
    });

    // ========== 全域函數 ==========
    window.showSection = showSection;
    window.showAdminTab = showAdminTab;
    window.refreshData = refreshData;
    window.registerActivity = registerActivity;
    window.cancelRegistration = cancelRegistration;
    window.applyVolunteer = applyVolunteer;
    window.showNewDonationModal = showNewDonationModal;
    window.showNewExpenseModal = showNewExpenseModal;
    window.showNewActivityModal = showNewActivityModal;
    window.showNewVolunteerNeedModal = showNewVolunteerNeedModal;
    window.showNewTransactionModal = showNewTransactionModal;
    window.showManualReceiptModal = showManualReceiptModal;
    window.showReceiptTemplateModal = showReceiptTemplateModal;
    window.showSystemNotificationModal = showSystemNotificationModal;
    window.exportMembers = exportMembers;
    window.exportFinanceData = exportFinanceData;
    window.backupSystem = backupSystem;
    window.viewMemberDetail = viewMemberDetail;
    window.filterActivities = filterActivities;

    // ========== 初始化 ==========
    window.addEventListener('load', initializeLiff);
  </script>
</body>
</html>

