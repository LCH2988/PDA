<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>帕金森病友會管理系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --success-gradient: linear-gradient(135deg,#28a745,#20c997);
      --danger-gradient: linear-gradient(135deg,#dc3545,#c82333);
      --warning-gradient: linear-gradient(135deg,#ffc107,#e0a800);
      --info-gradient: linear-gradient(135deg,#17a2b8,#138496);
    }
    * { box-sizing:border-box; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans TC',sans-serif;
      background:var(--primary-gradient);
      min-height:100vh;
    }
    .main-header,.nav-container,.content-card {
      background:rgba(255,255,255,.95);
      backdrop-filter:blur(10px);
      border-radius:20px;
      padding:20px;
      margin:20px;
      box-shadow:0 8px 32px rgba(0,0,0,.1);
    }
    .main-header { position:sticky; top:20px; z-index:1000; text-align:center; }
    .main-header h1 {
      font-size:28px; margin-bottom:8px;
      background:var(--primary-gradient);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .user-info-bar {
      background:rgba(255,255,255,.9);
      padding:10px 20px;
      border-radius:25px;
      display:inline-flex;
      gap:15px;
      align-items:center;
      box-shadow:0 4px 16px rgba(0,0,0,.1);
      margin-top:8px;
    }
    .user-avatar { width:40px;height:40px;border-radius:50%;background:var(--primary-gradient);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600; }
    .nav-pills { gap:5px; justify-content:center; flex-wrap:wrap; }
    .nav-pills .nav-link { font-weight:600; border:2px solid transparent; }
    .nav-pills .nav-link:hover { background:rgba(102,126,234,.1); color:#667eea; }
    .nav-pills .nav-link.active { background:var(--primary-gradient); }

    .content-card { transition:.2s; }
    .content-card:hover { transform:translateY(-2px); }

    .stat-card {
      border-radius:15px; padding:22px; color:#fff;
      text-align:center; box-shadow:0 4px 16px rgba(0,0,0,.15);
    }
    .stat-card h3 { font-size:1.9rem; margin:0 0 5px; }

    .form-floating { margin-bottom:18px; }
    .form-control,.form-select {
      border:2px solid #e2e8f0; border-radius:12px; background:rgba(255,255,255,.92);
    }
    .form-control:focus,.form-select:focus {
      border-color:#667eea; box-shadow:0 0 0 .2rem rgba(102,126,234,.15);
    }

    .btn { border-radius:12px; font-weight:600; }
    .btn-primary { background:var(--primary-gradient); border:none; }
    .btn-success { background:var(--success-gradient); border:none; }
    .btn-danger { background:var(--danger-gradient); border:none; }
    .btn-warning { background:var(--warning-gradient); border:none; color:#212529; }
    .btn-info { background:var(--info-gradient); border:none; }
    .btn.loading { position:relative; color:transparent !important; }
    .btn.loading:after {
      content:''; position:absolute; top:50%; left:50%; width:20px;height:20px; margin:-10px;
      border:2px solid rgba(255,255,255,.4); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg);} }

    .activity-item,.member-item,.transaction-item {
      background:#fff; border-radius:15px; padding:18px; margin-bottom:14px;
      box-shadow:0 2px 8px rgba(0,0,0,.08); border-left:4px solid #667eea; transition:.15s;
    }
    .activity-item:hover { box-shadow:0 4px 16px rgba(0,0,0,.15); transform:translateY(-2px); }

    .status-badge {
      display:inline-block; padding:6px 12px; border-radius:20px;
      font-size:12px; font-weight:600; line-height:1;
    }
    /* 中文狀態補齊 */
    .status-開放報名 { background:#c6f6d5; color:#22543d; }
    .status-報名截止 { background:#feebc8; color:#7b341e; }
    .status-進行中 { background:#bee3f8; color:#2a69ac; }
    .status-已結束 { background:#e2e8f0; color:#2d3748; }
    .status-已報名 { background:#bee3f8; color:#234e70; }
    .status-已取消 { background:#fed7d7; color:#742a2a; }
    .status-已完成 { background:#d6bcfa; color:#553c9a; }
    .status-待審核 { background:#feebc8; color:#7b341e; }
    .status-已核准 { background:#c6f6d5; color:#22543d; }
    .status-已拒絕 { background:#fed7d7; color:#742a2a; }

    .table-container { max-height:500px; overflow:auto; border:1px solid #dee2e6; border-radius:15px; background:#fff; }
    .table th { position:sticky; top:0; background:#f8f9fa; z-index:1; }

    .notification {
      position:fixed; top:20px; right:20px; padding:14px 18px; background:#fff;
      border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,.15); transform:translateX(400px);
      transition:transform .35s; max-width:360px; z-index:2000;
    }
    .notification.show { transform:translateX(0); }
    .notification.success { background:#c6f6d5; color:#22543d; border-left:4px solid #48bb78; }
    .notification.error { background:#fed7d7; color:#742a2a; border-left:4px solid #f56565; }
    .notification.warning { background:#feebc8; color:#7b341e; border-left:4px solid #ed8936; }

    .loading-container { display:flex; align-items:center; justify-content:center; padding:30px; color:#718096; }
    .loading-spinner { width:38px;height:38px;border:4px solid #e2e8f0;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin-right:12px;}

    .quick-actions { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:15px; }
    .quick-btn { background:rgba(255,255,255,.9); border:2px solid #e2e8f0; padding:18px; text-align:center; border-radius:15px; cursor:pointer; transition:.25s; }
    .quick-btn:hover { border-color:#667eea; transform:translateY(-3px); box-shadow:0 4px 14px rgba(102,126,234,.3); }

    @media (max-width:768px){
      .main-header,.nav-container,.content-card { margin:10px; padding:15px; }
      .quick-actions { grid-template-columns:repeat(2,1fr); }
    }

    @media (prefers-color-scheme: dark) {
      body { color:#e2e8f0; }
      .main-header,.nav-container,.content-card { background:rgba(45,55,72,.95); }
      .activity-item { background:#2d3748; color:#e2e8f0; }
      .table-container { background:#2d3748; }
      .table th { background:#4a5568; color:#fff; }
      .quick-btn { background:rgba(45,55,72,.9); border-color:#718096; color:#e2e8f0; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="main-header">
    <h1><i class="bi bi-hospital"></i> 帕金森病友會管理系統</h1>
    <p class="text-muted mb-2">完整功能整合版</p>
    <div id="userInfoBar" class="user-info-bar" style="display:none;">
      <div class="user-avatar" id="userAvatar">?</div>
      <div>
        <div class="fw-bold" id="userName">載入中...</div>
        <small class="text-muted d-block" id="userLineName"></small>
        <small class="text-muted" id="userRole">會員</small>
      </div>
      <div class="ms-auto d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary" onclick="refreshData()" title="刷新">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
    </div>
  </div>

  <div id="notificationContainer"></div>

  <!-- Navigation -->
  <div class="nav-container">
    <ul class="nav nav-pills" id="mainTabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#dashboard"><i class="bi bi-speedometer2"></i> 儀表板</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#profile"><i class="bi bi-person"></i> 個人資料</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#activities"><i class="bi bi-calendar-event"></i> 活動管理</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#volunteer"><i class="bi bi-heart"></i> 志工服務</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#finance"><i class="bi bi-cash-coin"></i> 財務管理</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#feedback"><i class="bi bi-chat-dots"></i> 活動回饋</button></li>
      <li class="nav-item admin-only"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#admin"><i class="bi bi-gear"></i> 系統管理</button></li>
    </ul>
  </div>

  <!-- Tabs -->
  <div class="tab-content">

    <!-- Dashboard -->
    <div class="tab-pane fade show active" id="dashboard">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3><i class="bi bi-speedometer2 me-2"></i>系統儀表板</h3>
          <button class="btn btn-outline-primary btn-sm" onclick="loadDashboard()"><i class="bi bi-arrow-clockwise me-1"></i>刷新</button>
        </div>
        <div class="quick-actions mb-4">
          <div class="quick-btn" onclick="showTab('profile')"><i class="bi bi-person-check"></i><div>更新資料</div></div>
          <div class="quick-btn" onclick="showTab('activities')"><i class="bi bi-calendar-plus"></i><div>報名活動</div></div>
          <div class="quick-btn" onclick="showNewDonationModal()"><i class="bi bi-heart-fill"></i><div>愛心捐款</div></div>
          <div class="quick-btn" onclick="showTab('volunteer')"><i class="bi bi-hand-thumbs-up"></i><div>志工服務</div></div>
        </div>
        <div class="row" id="dashboardStats">
          <div class="col-12">
            <div class="loading-container">
              <div class="loading-spinner"></div><span>載入統計資料中...</span>
            </div>
          </div>
        </div>
        <div class="mt-4">
          <h5><i class="bi bi-clock-history me-2"></i>最近活動</h5>
          <div id="recentActivity">
            <div class="loading-container">
              <div class="loading-spinner"></div><span>載入最近活動...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile -->
    <div class="tab-pane fade" id="profile">
      <div class="content-card">
        <h3><i class="bi bi-person me-2"></i>個人資料管理</h3>
        <!-- 未註冊 -->
          <div id="registrationSection">
            <div class="alert alert-info mt-3">
              <i class="bi bi-info-circle me-2"></i>請完成會員註冊以使用完整功能
            </div>
            <form id="registrationForm" class="row g-3 mt-1">
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" class="form-control" id="realName" name="realName" required>
                  <label for="realName">真實姓名 *</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="memberType" name="memberType" required>
                    <option value="">請選擇會員類別</option>
                    <option value="病友">病友</option>
                    <option value="家屬">家屬</option>
                    <option value="志工">志工</option>
                    <option value="醫護">醫護人員</option>
                    <option value="支持者">支持者</option>
                  </select>
                  <label for="memberType">會員類別 *</label>
                </div>
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle me-1"></i>完成註冊</button>
              </div>
            </form>
          </div>
        <!-- 已註冊 -->
        <div id="profileSection" style="display:none;">
          <form id="profileForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="profileRealName" name="profileRealName" readonly>
                <label for="profileRealName">真實姓名</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="lineName" name="lineName" readonly>
                <label for="lineName">LINE 名稱</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="tel" class="form-control" id="phone" name="phone">
                <label for="phone">聯絡電話</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="email" class="form-control" id="email" name="email">
                <label for="email">電子郵件</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="date" class="form-control" id="birthday" name="birthday">
                <label for="birthday">生日</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="profileMemberType" name="memberType">
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                  <option value="醫護">醫護人員</option>
                  <option value="支持者">支持者</option>
                </select>
                <label for="profileMemberType">會員類別</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" style="height:100px;" id="address" name="address"></textarea>
                <label for="address">通訊地址</label>
              </div>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>更新資料</button>
            </div>
          </form>
          <div class="mt-4">
            <h5><i class="bi bi-bar-chart me-2"></i>個人統計</h5>
            <div class="row g-3" id="profileStats"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Activities -->
    <div class="tab-pane fade" id="activities">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3><i class="bi bi-calendar-event me-2"></i>活動管理</h3>
          <div class="admin-only">
            <button class="btn btn-success btn-sm" onclick="showNewActivityModal()"><i class="bi bi-plus-circle me-1"></i>新增活動</button>
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <div class="form-floating">
              <select class="form-select" id="activityStatusFilter">
                <option value="">全部狀態</option>
                <option value="開放報名">開放報名</option>
                <option value="報名截止">報名截止</option>
                <option value="進行中">進行中</option>
                <option value="已結束">已結束</option>
              </select>
              <label for="activityStatusFilter">活動狀態</label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-floating">
              <input type="date" class="form-control" id="activityDateFilter">
              <label for="activityDateFilter">活動日期</label>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-floating">
              <input type="text" class="form-control" id="activitySearchFilter" placeholder="搜尋活動">
              <label for="activitySearchFilter">搜尋活動</label>
            </div>
          </div>
          <div class="col-md-2 d-grid">
            <button class="btn btn-outline-primary" onclick="filterActivities()"><i class="bi bi-search"></i> 搜尋</button>
          </div>
        </div>
        <div id="activitiesList">
          <div class="loading-container"><div class="loading-spinner"></div><span>載入活動中...</span></div>
        </div>
        <div class="mt-5">
          <h5><i class="bi bi-clipboard-check me-2"></i>我的活動報名</h5>
          <div id="myRegistrations">
            <div class="loading-container"><div class="loading-spinner"></div><span>載入報名記錄...</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Volunteer -->
    <div class="tab-pane fade" id="volunteer">
      <div class="content-card">
        <div class="d-flex justify-content-between mb-4">
          <h3><i class="bi bi-heart me-2"></i>志工服務</h3>
          <div class="admin-only">
            <button class="btn btn-success btn-sm" onclick="showNewVolunteerNeedModal()"><i class="bi bi-plus-circle me-1"></i>新增志工需求</button>
          </div>
        </div>
        <div class="row g-3 mb-4">
          <div class="col-md-3"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="volunteerHours">0</h3><p><i class="bi bi-clock me-1"></i>我的服務時數</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="volunteerActivities">0</h3><p><i class="bi bi-calendar me-1"></i>參與活動數</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="volunteerRank">-</h3><p><i class="bi bi-trophy me-1"></i>志工排名</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="availableNeeds">0</h3><p><i class="bi bi-hand-thumbs-up me-1"></i>可報名需求</p></div></div>
        </div>
        <h5><i class="bi bi-exclamation-circle me-2"></i>志工需求</h5>
        <div id="volunteerNeeds">
          <div class="loading-container"><div class="loading-spinner"></div><span>載入志工需求...</span></div>
        </div>
        <div class="mt-5">
          <h5><i class="bi bi-journal-text me-2"></i>我的志工記錄</h5>
          <div id="myVolunteerRecords">
            <div class="loading-container"><div class="loading-spinner"></div><span>載入志工記錄...</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Finance -->
    <div class="tab-pane fade" id="finance">
      <div class="content-card">
        <div class="d-flex justify-content-between mb-4">
          <h3><i class="bi bi-cash-coin me-2"></i>財務管理</h3>
          <div>
            <button class="btn btn-success btn-sm me-2" onclick="showNewDonationModal()"><i class="bi bi-heart-fill me-1"></i>愛心捐款</button>
            <button class="btn btn-warning btn-sm" onclick="showNewExpenseModal()"><i class="bi bi-receipt me-1"></i>支出申請</button>
          </div>
        </div>
        <div class="row g-3 mb-4">
          <div class="col-md-3"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="myDonationAmount">NT$ 0</h3><p><i class="bi bi-heart-fill me-1"></i>我的捐款總額</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="myDonationCount">0</h3><p><i class="bi bi-list-ol me-1"></i>捐款次數</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="myExpenseAmount">NT$ 0</h3><p><i class="bi bi-receipt me-1"></i>支出申請金額</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="pendingExpenses">0</h3><p><i class="bi bi-hourglass me-1"></i>待審核支出</p></div></div>
        </div>
        <h5><i class="bi bi-heart-fill me-2"></i>我的捐款記錄</h5>
        <div id="donationHistory">
          <div class="loading-container"><div class="loading-spinner"></div><span>載入捐款記錄...</span></div>
        </div>
        <div class="mt-5">
          <h5><i class="bi bi-receipt me-2"></i>我的支出申請</h5>
          <div id="expenseHistory">
            <div class="loading-container"><div class="loading-spinner"></div><span>載入支出記錄...</span></div>
          </div>
        </div>
        <div class="admin-only mt-5">
          <h5><i class="bi bi-graph-up me-2"></i>財務總覽（管理員）</h5>
          <div class="row g-3">
            <div class="col-md-3"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="totalIncome">NT$ 0</h3><p><i class="bi bi-arrow-up-circle me-1"></i>總收入</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="totalExpense">NT$ 0</h3><p><i class="bi bi-arrow-down-circle me-1"></i>總支出</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="currentBalance">NT$ 0</h3><p><i class="bi bi-wallet2 me-1"></i>目前餘額</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="monthlyDonations">NT$ 0</h3><p><i class="bi bi-calendar-month me-1"></i>本月捐款</p></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Feedback -->
    <div class="tab-pane fade" id="feedback">
      <div class="content-card">
        <h3><i class="bi bi-chat-dots me-2"></i>活動回饋</h3>
        <div class="card mb-4">
          <div class="card-header bg-primary text-white"><h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>新增活動回饋</h5></div>
          <div class="card-body">
            <form id="feedbackForm" class="row g-3">
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="feedbackActivity" name="feedbackActivity" required>
                    <option value="">請選擇活動</option>
                  </select>
                  <label for="feedbackActivity">選擇活動 *</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="feedbackRating" name="feedbackRating" required>
                    <option value="">請選擇評分</option>
                    <option value="5">5分 - 非常滿意</option>
                    <option value="4">4分 - 滿意</option>
                    <option value="3">3分 - 普通</option>
                    <option value="2">2分 - 不滿意</option>
                    <option value="1">1分 - 非常不滿意</option>
                  </select>
                  <label for="feedbackRating">評分 *</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <textarea class="form-control" style="height:120px;" id="feedbackComment" name="feedbackComment" required></textarea>
                  <label for="feedbackComment">意見與建議 *</label>
                </div>
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary"><i class="bi bi-send me-1"></i>提交回饋</button>
              </div>
            </form>
          </div>
        </div>
        <h5><i class="bi bi-chat-left-text me-2"></i>我的回饋記錄</h5>
        <div id="myFeedback">
          <div class="loading-container"><div class="loading-spinner"></div><span>載入回饋記錄...</span></div>
        </div>
        <div class="admin-only mt-5">
          <h5><i class="bi bi-chat-square-dots me-2"></i>所有活動回饋（管理員）</h5>
          <div id="allFeedback">
            <div class="loading-container"><div class="loading-spinner"></div><span>載入所有回饋...</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin -->
    <div class="tab-pane fade" id="admin">
      <div class="content-card">
        <h3><i class="bi bi-gear me-2"></i>系統管理</h3>
        <ul class="nav nav-tabs mb-4" id="adminTabs">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#memberManagement"><i class="bi bi-people me-1"></i>會員管理</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#activityManagement"><i class="bi bi-calendar-event me-1"></i>活動管理</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#financeManagement"><i class="bi bi-cash-stack me-1"></i>財務管理</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#receiptManagement"><i class="bi bi-receipt-cutoff me-1"></i>收據管理</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#systemSettings"><i class="bi bi-gear-fill me-1"></i>系統設定</button></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="memberManagement">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5>會員管理</h5>
              <button class="btn btn-outline-primary btn-sm" onclick="exportMembers()"><i class="bi bi-download me-1"></i>匯出會員資料</button>
            </div>
            <div class="table-container">
              <table class="table table-hover table-sm align-middle">
                <thead><tr><th>姓名</th><th>會員類別</th><th>註冊狀態</th><th>加入日期</th><th>捐款次數</th><th>操作</th></tr></thead>
                <tbody id="memberList">
                  <tr><td colspan="6" class="text-center">
                    <div class="loading-container"><div class="loading-spinner"></div><span>載入會員資料...</span></div>
                  </td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade" id="activityManagement">
            <div class="d-flex justify-content-between mb-3">
              <h5>活動管理</h5>
              <button class="btn btn-success btn-sm" onclick="showNewActivityModal()"><i class="bi bi-plus-circle me-1"></i>新增活動</button>
            </div>
            <div id="adminActivityList">
              <div class="loading-container"><div class="loading-spinner"></div><span>載入活動資料...</span></div>
            </div>
          </div>
          <div class="tab-pane fade" id="financeManagement">
            <div class="d-flex justify-content-between mb-3">
              <h5>財務管理</h5>
              <div>
                <button class="btn btn-success btn-sm me-2" onclick="showNewTransactionModal()"><i class="bi bi-plus-circle me-1"></i>新增交易</button>
                <button class="btn btn-outline-primary btn-sm" onclick="exportFinanceData()"><i class="bi bi-download me-1"></i>匯出財務資料</button>
              </div>
            </div>
            <div class="table-container">
              <table class="table table-hover table-sm">
                <thead><tr><th>日期</th><th>類型</th><th>金額</th><th>類別</th><th>說明</th><th>操作</th></tr></thead>
                <tbody id="transactionList">
                  <tr><td colspan="6" class="text-center">
                    <div class="loading-container"><div class="loading-spinner"></div><span>載入交易記錄...</span></div>
                  </td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade" id="receiptManagement">
            <div class="d-flex justify-content-between mb-3">
              <h5>收據管理</h5>
              <div>
                <button class="btn btn-info btn-sm me-2" onclick="showReceiptTemplateModal()"><i class="bi bi-file-text me-1"></i>模板設定</button>
                <button class="btn btn-success btn-sm" onclick="showManualReceiptModal()"><i class="bi bi-plus-circle me-1"></i>手動開立</button>
              </div>
            </div>
            <div id="receiptList">
              <div class="loading-container"><div class="loading-spinner"></div><span>載入收據記錄...</span></div>
            </div>
          </div>
          <div class="tab-pane fade" id="systemSettings">
            <h5>系統設定</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header"><h6 class="mb-0"><i class="bi bi-database me-2"></i>資料備份</h6></div>
                  <div class="card-body">
                    <p class="small text-muted mb-3">定期備份系統資料以確保安全</p>
                    <button class="btn btn-warning btn-sm" onclick="backupSystem()"><i class="bi bi-download me-1"></i>立即備份</button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header"><h6 class="mb-0"><i class="bi bi-bell me-2"></i>系統通知</h6></div>
                  <div class="card-body">
                    <p class="small text-muted mb-3">向所有會員發送公告</p>
                    <button class="btn btn-info btn-sm" onclick="showSystemNotificationModal()"><i class="bi bi-megaphone me-1"></i>發送通知</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div> <!-- admin tab-content -->
      </div>
    </div>
  </div>

  <div id="modalContainer"></div>

  <script>
    // ====== 設定 ======
    const CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycbxb_4JR0FgbQr54lGKQHWZTIssMAvlUGbf24eAl2w2uc6qFT9BVp4IJ9IZNgDpNCXT1ag/exec',
      API_KEY: 'AAbb8520258185202581'
    };

    // ====== 全域變數 ======
    let currentUser = null;
    let isAdmin = false;
    let userProfile = null;
    let allActivities = [];
    let cachedAdminData = null;

    // ====== 工具 ======
    function formatDate(d){
      if(!d) return '-';
      const date = new Date(d);
      if(isNaN(date)) return '-';
      return date.toLocaleDateString('zh-TW');
    }
    function formatDateTime(d){
      if(!d) return '-';
      const date = new Date(d);
      if(isNaN(date)) return '-';
      return date.toLocaleString('zh-TW');
    }
    function formatCurrency(n){
      return new Intl.NumberFormat('zh-TW',{style:'currency',currency:'TWD',minimumFractionDigits:0}).format(n||0);
    }
    function showNotification(msg,type='success',ms=3000){
      const c = document.getElementById('notificationContainer');
      const div = document.createElement('div');
      div.className = `notification ${type}`;
      div.innerHTML = `<div class="d-flex justify-content-between align-items-start">
        <span>${msg}</span>
        <button style="background:none;border:none;font-size:18px;line-height:1;" onclick="this.closest('.notification').remove()">&times;</button>
      </div>`;
      c.appendChild(div);
      requestAnimationFrame(()=>div.classList.add('show'));
      setTimeout(()=>{
        div.classList.remove('show');
        setTimeout(()=>div.remove(),350);
      },ms);
    }
    function setButtonLoading(btn, state=true){
      if(!btn) return;
      if(state){
        if(!btn.dataset.originalText) btn.dataset.originalText = btn.innerHTML;
        btn.classList.add('loading');
        btn.disabled = true;
      } else {
        btn.classList.remove('loading');
          btn.disabled = false;
        if(btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText;
      }
    }

    async function callAPI(action,data={}){
      const payload = {
        action,
        apiKey: CONFIG.API_KEY,
        timestamp: Date.now(),
        ...data
      };
      const res = await fetch(CONFIG.API_BASE_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const json = await res.json();
      if(!json.success) throw new Error(json.message||'API 錯誤');
      return json;
    }

    // ====== LIFF 初始化並顯示 LINE 名稱 ======
    async function initializeLiff(){
      try{
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if(!liff.isLoggedIn()){
          liff.login();
          return;
        }
        userProfile = await liff.getProfile();
        // 立即顯示 LINE 名稱
          const userInfoBar = document.getElementById('userInfoBar');
          userInfoBar.style.display = 'inline-flex';
          document.getElementById('userLineName').textContent = 'LINE：' + (userProfile.displayName||'');
          document.getElementById('userName').textContent = userProfile.displayName || '會員';
          document.getElementById('userAvatar').textContent = (userProfile.displayName||'?').charAt(0);

        await loadUserData();
        await loadDashboard();
        showNotification('系統初始化成功','success');
      }catch(err){
        console.error(err);
        showNotification('LIFF 初始化失敗','error');
      }
    }

    // ====== 使用者資料 ======
    async function loadUserData(){
      try{
        const r = await callAPI('getUserInfo',{ lineId: userProfile.userId });
        if(r.success && r.data){
          currentUser = r.data;
          isAdmin = !!currentUser.isAdmin;
          updateUserInterface();
        } else {
          showRegistrationForm();
        }
      }catch(err){
        showRegistrationForm();
      }
    }

    function updateUserInterface(){
      if(!currentUser) return;
      document.getElementById('userName').textContent = currentUser.realName || currentUser.lineName || userProfile.displayName || '會員';
      document.getElementById('userRole').textContent = currentUser.memberType || '會員';
      document.getElementById('userAvatar').textContent = (currentUser.realName || currentUser.lineName || userProfile.displayName || '?').charAt(0);
      document.getElementById('userLineName').textContent = 'LINE：' + (userProfile.displayName||'');

      document.querySelectorAll('.admin-only').forEach(el=>el.style.display = isAdmin ? 'block':'none');
      updateProfileSection();
    }

    function showRegistrationForm(){
      document.getElementById('registrationSection').style.display='block';
      document.getElementById('profileSection').style.display='none';
    }
    function updateProfileSection(){
      if(!currentUser) return;
      document.getElementById('registrationSection').style.display='none';
      document.getElementById('profileSection').style.display='block';
      document.getElementById('profileRealName').value = currentUser.realName||'';
      document.getElementById('lineName').value = currentUser.lineName||userProfile.displayName||'';
      document.getElementById('phone').value = currentUser.phone||'';
      document.getElementById('email').value = currentUser.email||'';
      document.getElementById('birthday').value = currentUser.birthday||'';
      document.getElementById('profileMemberType').value = currentUser.memberType||'病友';
      document.getElementById('address').value = currentUser.address||'';
    }

    // ====== 儀表板 ======
    async function loadDashboard(){
      try{
        const r = await callAPI('getDashboardData',{ lineId: userProfile?.userId });
        updateDashboardStats(r.data);
        updateRecentActivity(r.data.recentActivity||[]);
      }catch(err){
        document.getElementById('dashboardStats').innerHTML =
          `<div class="col-12 text-danger text-center">載入失敗：${err.message}</div>`;
      }
    }
    function updateDashboardStats(d){
      const c = document.getElementById('dashboardStats');
      c.innerHTML = `
        <div class="col-md-3">
          <div class="stat-card" style="background:var(--success-gradient);">
            <h3>${d.totalActivities||0}</h3><p><i class="bi bi-calendar-event me-1"></i>可報名活動</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card" style="background:var(--info-gradient);">
            <h3>${d.myRegistrations||0}</h3><p><i class="bi bi-clipboard-check me-1"></i>我的報名</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card" style="background:var(--warning-gradient);">
            <h3>${d.myVolunteerHours||0}</h3><p><i class="bi bi-clock me-1"></i>志工時數</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card" style="background:var(--danger-gradient);">
            <h3>${formatCurrency(d.myDonationAmount||0).replace('NT$','')}</h3><p><i class="bi bi-heart-fill me-1"></i>捐款總額</p>
          </div>
        </div>`;
    }
    function updateRecentActivity(activities){
      const container = document.getElementById('recentActivity');
      if(!activities.length){
        container.innerHTML = '<p class="text-muted text-center mb-0">暫無最近活動</p>';
        return;
      }
      container.innerHTML = activities.map(a=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="mb-1">${a.title||''}</h6>
              <p class="mb-1 text-muted">${a.description||''}</p>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(a.date)}</small>
            </div>
            <span class="status-badge status-${(a.status||'').trim()}">${a.status||''}</span>
          </div>
        </div>`).join('');
    }

    // ====== 註冊 ======
    document.getElementById('registrationForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('registerUser',{
          lineId: userProfile.userId,
          lineName: userProfile.displayName,
          realName: fd.get('realName'),
          memberType: fd.get('memberType')
        });
        showNotification('註冊成功','success');
        await loadUserData();
      }catch(err){
        showNotification('註冊失敗：'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });

    // ====== 更新個人資料 ======
    document.getElementById('profileForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('updateProfile',{
          lineId: userProfile.userId,
          phone: fd.get('phone'),
          email: fd.get('email'),
          birthday: fd.get('birthday'),
          memberType: fd.get('memberType'),
          address: fd.get('address')
        });
        showNotification('資料更新成功','success');
        await loadUserData();
      }catch(err){
        showNotification('更新失敗：'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });

    // ====== 活動 ======
    async function loadActivities(){
      try{
        const r = await callAPI('getActivities');
        allActivities = r.data || [];
        renderActivities(allActivities);
      }catch(err){
        document.getElementById('activitiesList').innerHTML =
          `<div class="text-danger text-center">載入活動失敗：${err.message}</div>`;
      }
    }
    function renderActivities(list){
      const c = document.getElementById('activitiesList');
      if(!list.length){
        c.innerHTML = '<p class="text-muted text-center">目前沒有活動</p>';
        return;
      }
      c.innerHTML = list.map(a=>`
        <div class="activity-item">
          <div class="row">
            <div class="col-md-8">
              <h5 class="mb-2">${a.title}</h5>
              <p class="mb-2">${a.description||''}</p>
              <div class="d-flex flex-wrap gap-3 small text-muted">
                <span><i class="bi bi-calendar me-1"></i>${formatDate(a.date)}</span>
                <span><i class="bi bi-clock me-1"></i>${a.time||'-'}</span>
                <span><i class="bi bi-geo-alt me-1"></i>${a.location||'-'}</span>
                <span><i class="bi bi-people me-1"></i>${a.currentCount||0}/${a.maxParticipants||0}</span>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <div class="mb-2"><span class="status-badge status-${(a.status||'').trim()}">${a.status}</span></div>
              <div class="mb-2 fw-bold text-primary">${formatCurrency(a.fee||0)}</div>
              ${(a.status==='開放報名')? `<button class="btn btn-primary btn-sm" onclick="registerActivity('${a.id}')"><i class="bi bi-plus-circle me-1"></i>報名</button>`:''}
            </div>
          </div>
        </div>`).join('');
    }
    function filterActivities(){
      const status = document.getElementById('activityStatusFilter').value.trim();
      const date = document.getElementById('activityDateFilter').value.trim();
      const kw = document.getElementById('activitySearchFilter').value.trim().toLowerCase();
      let filtered = [...allActivities];
      if(status) filtered = filtered.filter(a=>a.status===status);
      if(date) filtered = filtered.filter(a=> (a.date||'').startsWith(date));
      if(kw) filtered = filtered.filter(a=>
        (a.title||'').toLowerCase().includes(kw) ||
        (a.description||'').toLowerCase().includes(kw) ||
        (a.location||'').toLowerCase().includes(kw)
      );
      renderActivities(filtered);
    }
    async function registerActivity(id){
      if(!currentUser){ showNotification('請先註冊','warning'); return; }
      try{
        await callAPI('registerActivity',{ lineId:userProfile.userId, activityId:id });
        showNotification('報名成功','success');
        await loadActivities();
        await loadMyRegistrations();
      }catch(err){
        showNotification('報名失敗：'+err.message,'error');
      }
    }
    async function loadMyRegistrations(){
      if(!currentUser) return;
      try{
        const r = await callAPI('getMyRegistrations',{ lineId:userProfile.userId });
        renderMyRegistrations(r.data||[]);
      }catch(err){
        document.getElementById('myRegistrations').innerHTML =
          `<div class="text-danger text-center">載入失敗：${err.message}</div>`;
      }
    }
    function renderMyRegistrations(list){
      const c = document.getElementById('myRegistrations');
      if(!list.length){
        c.innerHTML = '<p class="text-muted text-center">尚無報名</p>';
        return;
      }
      c.innerHTML = list.map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="mb-1">${r.activityTitle}</h6>
              <small class="text-muted d-block mb-1">
                <i class="bi bi-calendar me-1"></i>${formatDate(r.registrationTime)}
              </small>
              <small class="text-muted">狀態：${r.status}</small>
            </div>
            <div class="text-end">
              <span class="status-badge status-${r.status}">${r.status}</span><br/>
              ${(r.status==='已報名')? `<button class="btn btn-danger btn-sm mt-2" onclick="cancelRegistration('${r.id}')"><i class="bi bi-x-circle me-1"></i>取消</button>`:''}
            </div>
          </div>
        </div>`).join('');
    }
    async function cancelRegistration(regId){
      if(!confirm('確定取消？')) return;
      try{
        await callAPI('cancelRegistration',{ lineId:userProfile.userId, registrationId:regId });
        showNotification('已取消','success');
        await loadMyRegistrations();
        await loadActivities();
      }catch(err){
        showNotification('取消失敗：'+err.message,'error');
      }
    }

    // ====== 志工 ======
    async function loadVolunteerData(){
      if(!currentUser) return;
      try{
        const r = await callAPI('getVolunteerData',{ lineId:userProfile.userId });
        const d = r.data;
        document.getElementById('volunteerHours').textContent = d.stats.totalHours||0;
        document.getElementById('volunteerActivities').textContent = d.stats.totalActivities||0;
        document.getElementById('volunteerRank').textContent = d.stats.rank||'-';
        document.getElementById('availableNeeds').textContent = d.stats.availableNeeds||0;
        renderVolunteerNeeds(d.needs||[]);
        renderVolunteerRecords(d.records||[]);
      }catch(err){
        console.error(err);
      }
    }
    function renderVolunteerNeeds(list){
      const c = document.getElementById('volunteerNeeds');
      if(!list.length){ c.innerHTML='<p class="text-muted text-center">目前無志工需求</p>'; return; }
      c.innerHTML = list.map(n=>`
        <div class="activity-item">
          <div class="row">
            <div class="col-md-8">
              <h6 class="mb-1">${n.title}</h6>
              <p class="mb-1 text-muted">${n.description||''}</p>
              <div class="small text-muted d-flex flex-wrap gap-3">
                <span><i class="bi bi-calendar me-1"></i>${formatDate(n.date)}</span>
                <span><i class="bi bi-clock me-1"></i>${n.time||'-'}</span>
                <span><i class="bi bi-people me-1"></i>${n.currentCount||0}/${n.needCount}</span>
                <span><i class="bi bi-award me-1"></i>${n.hours} 小時</span>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <span class="status-badge status-${n.status}">${n.status}</span><br/>
              ${(n.status==='開放報名')? `<button class="btn btn-success btn-sm mt-2" onclick="applyVolunteer('${n.id}')"><i class="bi bi-hand-thumbs-up me-1"></i>報名</button>`:''}
            </div>
          </div>
        </div>`).join('');
    }
    function renderVolunteerRecords(list){
      const c = document.getElementById('myVolunteerRecords');
      if(!list.length){ c.innerHTML='<p class="text-muted text-center">尚無記錄</p>'; return; }
      c.innerHTML = list.map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="mb-1">${r.title}</h6>
              <small class="text-muted d-block mb-1"><i class="bi bi-calendar me-1"></i>${formatDate(r.date)} / ${r.hours} 小時</small>
              <small class="text-muted">${r.status}</small>
            </div>
            <span class="status-badge status-${r.status}">${r.status}</span>
          </div>
        </div>`).join('');
    }
    async function applyVolunteer(id){
      if(!currentUser){ showNotification('請先註冊','warning'); return; }
      try{
        await callAPI('applyVolunteer',{ lineId:userProfile.userId, needId:id });
        showNotification('志工報名成功','success');
        await loadVolunteerData();
      }catch(err){
        showNotification('報名失敗：'+err.message,'error');
      }
    }

    // ====== 財務 ======
    async function loadFinanceData(){
      if(!currentUser) return;
      try{
        const r = await callAPI('getFinanceData',{ lineId:userProfile.userId });
        const s = r.data.stats;
        document.getElementById('myDonationAmount').textContent = formatCurrency(s.totalDonation||0).replace('NT$','');
        document.getElementById('myDonationCount').textContent = s.donationCount||0;
        document.getElementById('myExpenseAmount').textContent = formatCurrency(s.totalExpense||0).replace('NT$','');
        document.getElementById('pendingExpenses').textContent = s.pendingExpenses||0;
        renderDonations(r.data.donations||[]);
        renderExpenses(r.data.expenses||[]);
        if(r.data.adminStats && isAdmin) updateAdminFinanceStats(r.data.adminStats);
      }catch(err){
        console.error(err);
      }
    }
    function renderDonations(list){
      const c = document.getElementById('donationHistory');
      if(!list.length){ c.innerHTML='<p class="text-muted text-center">尚無捐款</p>'; return; }
      c.innerHTML = list.map(d=>`
        <div class="transaction-item">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="mb-1">捐款 - ${d.category}</h6>
              <p class="mb-1 text-muted">${d.description||''}</p>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(d.date)}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold text-success">${formatCurrency(d.amount)}</div>
              <small class="text-muted">收據：${d.receiptNumber||'處理中'}</small>
            </div>
          </div>
        </div>`).join('');
    }
    function renderExpenses(list){
      const c = document.getElementById('expenseHistory');
      if(!list.length){ c.innerHTML='<p class="text-muted text-center">尚無支出申請</p>'; return; }
      c.innerHTML = list.map(e=>`
        <div class="transaction-item">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="mb-1">支出 - ${e.category}</h6>
              <p class="mb-1 text-muted">${e.description||''}</p>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(e.date)}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold text-danger">${formatCurrency(e.amount)}</div>
              <span class="status-badge status-${e.status}">${e.status}</span>
            </div>
          </div>
        </div>`).join('');
    }
    function updateAdminFinanceStats(s){
      document.getElementById('totalIncome').textContent = formatCurrency(s.totalIncome);
      document.getElementById('totalExpense').textContent = formatCurrency(s.totalExpense);
      document.getElementById('currentBalance').textContent = formatCurrency(s.currentBalance);
      document.getElementById('monthlyDonations').textContent = formatCurrency(s.monthlyDonations);
    }

    // 捐款 Modal
    function showNewDonationModal(){
      if(!currentUser){ showNotification('請先註冊','warning'); return; }
      const html = `
        <div class="modal fade" id="donationModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <form id="donationForm">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>愛心捐款</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="form-floating mb-3">
                    <select class="form-select" id="donationCategory" name="donationCategory" required>
                      <option value="">選擇類別</option>
                      <option value="一般捐款">一般捐款</option>
                      <option value="活動贊助">活動贊助</option>
                      <option value="設備購置">設備購置</option>
                      <option value="其他">其他</option>
                    </select>
                    <label for="donationCategory">捐款類別 *</label>
                  </div>
                  <div class="form-floating mb-3">
                    <input type="number" class="form-control" id="donationAmount" name="donationAmount" min="1" required>
                    <label for="donationAmount">捐款金額 *</label>
                  </div>
                  <div class="form-floating mb-3">
                    <textarea class="form-control" style="height:100px;" id="donationDescription" name="donationDescription"></textarea>
                    <label for="donationDescription">備註</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="needReceipt" name="needReceipt" checked>
                    <label class="form-check-label" for="needReceipt">需要收據</label>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="submit" class="btn btn-success"><i class="bi bi-heart-fill me-1"></i>確認捐款</button>
                </div>
              </form>
            </div>
          </div>
        </div>`;
      document.getElementById('modalContainer').innerHTML = html;
      const modal = new bootstrap.Modal(document.getElementById('donationModal'));
      modal.show();
      document.getElementById('donationForm').addEventListener('submit',handleDonationSubmit);
    }
    async function handleDonationSubmit(e){
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('createDonation',{
          lineId:userProfile.userId,
          category:fd.get('donationCategory'),
          amount:parseInt(fd.get('donationAmount'),10),
          description:fd.get('donationDescription'),
          needReceipt: fd.get('needReceipt')==='on'
        });
        showNotification('捐款成功，感謝您的愛心！','success');
        bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
        await loadFinanceData();
      }catch(err){
        showNotification('捐款失敗：'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    }

    // ====== 回饋 ======
    async function loadFeedbackData(){
      if(!currentUser) return;
      try{
        const acts = await callAPI('getMyCompletedActivities',{ lineId:userProfile.userId });
        populateFeedbackActivities(acts.data||[]);
        const my = await callAPI('getMyFeedback',{ lineId:userProfile.userId });
        renderMyFeedback(my.data||[]);
        if(isAdmin){
          const all = await callAPI('getAllFeedback',{ lineId:userProfile.userId });
          updateAllFeedback(all.data||[]);
        }
      }catch(err){
        console.error(err);
      }
    }
    function populateFeedbackActivities(list){
      const sel = document.getElementById('feedbackActivity');
      sel.innerHTML = '<option value="">請選擇活動</option>';
      list.forEach(a=>{
        sel.innerHTML += `<option value="${a.id}">${a.title} (${formatDate(a.date)})</option>`;
      });
    }
    function renderMyFeedback(list){
      const c = document.getElementById('myFeedback');
      if(!list.length){ c.innerHTML='<p class="text-muted text-center">尚無回饋</p>'; return; }
      c.innerHTML = list.map(f=>`
        <div class="activity-item">
          <strong>${f.activityTitle}</strong>
          <div class="small mb-1">${'★'.repeat(f.rating)}${'☆'.repeat(5-f.rating)} <span class="text-muted">(${f.rating}/5)</span></div>
          <p class="mb-1">${f.comment}</p>
          <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(f.createdAt)}</small>
        </div>`).join('');
    }
    function updateAllFeedback(list){
      const c = document.getElementById('allFeedback');
      if(!list.length){ c.innerHTML='<p class="text-muted text-center">尚無資料</p>'; return; }
      c.innerHTML = list.map(f=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${f.activityTitle}</strong>
              <div class="small mb-1">${'★'.repeat(f.rating)}${'☆'.repeat(5-f.rating)} <span class="text-muted">(${f.rating}/5)</span></div>
              <p class="mb-1">${f.comment}</p>
              <small class="text-muted">${formatDateTime(f.createdAt)}</small>
            </div>
            <small class="text-muted">${f.lineId}</small>
          </div>
        </div>`).join('');
    }
    document.getElementById('feedbackForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('createFeedback',{
          lineId: userProfile.userId,
          activityId: fd.get('feedbackActivity'),
          rating: parseInt(fd.get('feedbackRating'),10),
          comment: fd.get('feedbackComment')
        });
        showNotification('回饋已提交','success');
        e.target.reset();
        await loadFeedbackData();
      }catch(err){
        showNotification('提交失敗：'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });

    // ====== Admin 區域 ======
    async function loadAdminData(){
      if(!isAdmin) return;
      try{
        const r = await callAPI('getAdminData',{ lineId:userProfile.userId });
        cachedAdminData = r.data;
        renderMemberList(r.data.members||[]);
        renderAdminActivities(r.data.activities||[]);
        renderTransactions(r.data.transactions||[]);
        renderReceipts(r.data.receipts||[]);
      }catch(err){
        console.error(err);
      }
    }
    function renderMemberList(list){
      const tb = document.getElementById('memberList');
      if(!list.length){
        tb.innerHTML='<tr><td colspan="6" class="text-center text-muted">暫無資料</td></tr>'; return;
      }
      tb.innerHTML = list.map(m=>`
        <tr>
          <td>${m.realName||m.lineName||'-'}</td>
          <td>${m.memberType||'-'}</td>
          <td><span class="status-badge status-${m.status||''}">${m.status||''}</span></td>
          <td>${formatDate(m.joinDate)}</td>
          <td>${m.donationCount||0}</td>
          <td><button class="btn btn-sm btn-outline-primary" onclick="viewMemberDetail('${m.lineId}')"><i class="bi bi-eye"></i></button></td>
        </tr>`).join('');
    }
    function renderAdminActivities(list){
      const c = document.getElementById('adminActivityList');
      if(!list.length){ c.innerHTML='<p class="text-muted text-center">無活動</p>'; return; }
      c.innerHTML = list.map(a=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div><strong>${a.title}</strong><br><small class="text-muted">${formatDate(a.date)} / ${a.location||''}</small></div>
            <div class="text-end">
              <span class="status-badge status-${a.status}">${a.status}</span><br>
              <small>${a.currentCount||0}/${a.maxParticipants||0}</small>
            </div>
          </div>
        </div>`).join('');
    }
    function renderTransactions(list){
      const tb = document.getElementById('transactionList');
      if(!list.length){
        tb.innerHTML='<tr><td colspan="6" class="text-center text-muted">無資料</td></tr>'; return;
      }
      tb.innerHTML = list.map(t=>`
        <tr>
          <td>${formatDateTime(t.date)}</td>
          <td>${t.type}</td>
          <td class="${t.type==='收入'?'text-success':'text-danger'}">${formatCurrency(t.amount)}</td>
          <td>${t.category||''}</td>
          <td>${t.description||''}</td>
          <td>${t.status? `<span class="status-badge status-${t.status}">${t.status}</span>`:''}</td>
        </tr>`).join('');
    }
    function renderReceipts(list){
      const c = document.getElementById('receiptList');
      if(!list.length){ c.innerHTML='<p class="text-muted text-center">尚無收據</p>'; return; }
      c.innerHTML = list.map(r=>`
        <div class="transaction-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.receiptNumber}</strong>
              <div class="small text-muted">${formatDate(r.issueDate)} / ${r.type}</div>
            </div>
            <div class="text-end">
              <div class="fw-bold">${formatCurrency(r.amount)}</div>
              <span class="status-badge status-${r.status}">${r.status}</span>
            </div>
          </div>
        </div>`).join('');
    }

    // 匯出 (管理員)
    async function exportMembers(){
      if(!isAdmin) return showNotification('權限不足','error');
      try{
        const r = await callAPI('exportMembers',{ lineId:userProfile.userId });
        showNotification('匯出成功，請至雲端硬碟下載','success');
        console.log(r.data);
      }catch(err){
        showNotification('匯出失敗：'+err.message,'error');
      }
    }
    async function exportFinanceData(){
      if(!isAdmin) return showNotification('權限不足','error');
      try{
        const r = await callAPI('exportFinanceData',{ lineId:userProfile.userId });
        showNotification('匯出成功','success');
        console.log(r.data);
      }catch(err){
        showNotification('匯出失敗：'+err.message,'error');
      }
    }
    async function backupSystem(){
      if(!isAdmin) return showNotification('權限不足','error');
      try{
        const r = await callAPI('backupSystem',{ lineId:userProfile.userId });
        showNotification('備份完成','success');
        console.log(r.data);
      }catch(err){
        showNotification('備份失敗：'+err.message,'error');
      }
    }

    // ====== 回饋 (Admin 顯示已實作) ======

    // ====== Tab 切換載入資料 ======
    document.addEventListener('DOMContentLoaded',()=>{
      document.querySelectorAll('[data-bs-toggle="pill"]').forEach(btn=>{
        btn.addEventListener('shown.bs.tab',e=>{
          const id = e.target.getAttribute('data-bs-target').substring(1);
          switch(id){
            case 'activities': loadActivities(); loadMyRegistrations(); break;
            case 'volunteer': loadVolunteerData(); break;
            case 'finance': loadFinanceData(); break;
            case 'feedback': loadFeedbackData(); break;
            case 'admin': if(isAdmin) loadAdminData(); break;
          }
        });
      });
    });

    // ====== 回饋表單等 ======

    // ====== 全域暴露 ======
    window.showTab = (id)=> {
      const btn = document.querySelector(`button[data-bs-target="#${id}"]`);
      if(btn) btn.click();
    };
    window.refreshData = async ()=>{
      try{
        await Promise.all([
          loadDashboard(),
          loadActivities(),
          loadMyRegistrations(),
          loadVolunteerData(),
          loadFinanceData(),
          loadFeedbackData(),
          isAdmin ? loadAdminData(): Promise.resolve()
        ]);
        showNotification('資料已刷新','success');
      }catch(err){
        showNotification('刷新失敗：'+err.message,'error');
      }
    };
    window.registerActivity = registerActivity;
    window.cancelRegistration = cancelRegistration;
    window.applyVolunteer = applyVolunteer;
    window.showNewDonationModal = showNewDonationModal;
    window.exportMembers = exportMembers;
    window.exportFinanceData = exportFinanceData;
    window.backupSystem = backupSystem;

    window.addEventListener('load',initializeLiff);

    // 禁止 Enter 在非 textarea 觸發 submit
    document.addEventListener('keydown',e=>{
      if(e.key==='Enter' && !['TEXTAREA','BUTTON'].includes(e.target.tagName)){
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
