<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>ç—…å‹æœƒ LIFF å‰ç«¯</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    --primary: #2563eb;
    --primary-hover: #1d4ed8;
    --primary-light: #eff6ff;
    --bg: #f8fafc;
    --card: #ffffff;
    --border: #e2e8f0;
    --danger: #dc2626;
    --success: #16a34a;
    --warning: #d97706;
    --info: #0ea5e9;
    --radius: 8px;
    --text: #1f2937;
    --text-light: #6b7280;
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
  }

  /* Header */
  header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
    color: #fff;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-lg);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  header h1 {
    font-size: 20px;
    margin: 0;
    font-weight: 600;
  }

  #userStatus {
    font-size: 14px;
    opacity: 0.95;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Main Layout */
  main {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Tabs */
  .tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 24px;
    background: var(--card);
    padding: 8px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  .tabs button {
    background: transparent;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    color: var(--text-light);
  }

  .tabs button:hover {
    background: var(--primary-light);
    color: var(--primary);
  }

  .tabs button.active {
    background: var(--primary);
    color: #fff;
    box-shadow: var(--shadow);
  }

  /* Panels */
  section.panel {
    display: none;
    animation: fadeIn 0.3s ease;
  }

  section.panel.active {
    display: block;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Cards */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
    transition: box-shadow 0.2s ease;
  }

  .card:hover {
    box-shadow: var(--shadow-lg);
  }

  /* Typography */
  h2 {
    margin: 0 0 16px;
    font-size: 20px;
    font-weight: 600;
    color: var(--text);
  }

  h3 {
    margin: 20px 0 12px;
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }

  h4 {
    margin: 12px 0 8px;
    font-size: 16px;
    font-weight: 600;
  }

  /* Form Elements */
  label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    margin-top: 12px;
    margin-bottom: 4px;
    color: var(--text);
  }

  input, select, textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: #fff;
    font-size: 14px;
    transition: all 0.2s ease;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  textarea {
    min-height: 100px;
    resize: vertical;
    font-family: inherit;
  }

  /* Layout */
  .row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
  }

  .col {
    min-width: 0;
  }

  /* Buttons */
  button, .btn {
    background: var(--primary);
    color: #fff;
    border: none;
    cursor: pointer;
    padding: 10px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  button:hover, .btn:hover {
    background: var(--primary-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow);
  }

  button:active, .btn:active {
    transform: translateY(0);
  }

  button.outline {
    background: transparent;
    color: var(--primary);
    border: 1px solid var(--primary);
  }

  button.outline:hover {
    background: var(--primary-light);
  }

  button.small {
    padding: 6px 12px;
    font-size: 12px;
  }

  button.danger {
    background: var(--danger);
  }

  button.danger:hover {
    background: #b91c1c;
  }

  button.success {
    background: var(--success);
  }

  button.success:hover {
    background: #15803d;
  }

  button.warning {
    background: var(--warning);
  }

  button.warning:hover {
    background: #c2410c;
  }

  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin-top: 12px;
    background: var(--card);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  th, td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
  }

  th {
    background: #f8fafc;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
  }

  tr:hover {
    background: #f9fafb;
  }

  tr:last-child td {
    border-bottom: none;
  }

  /* Utilities */
  .flex {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .space-between {
    justify-content: space-between;
  }

  .text-center {
    text-align: center;
  }

  .text-right {
    text-align: right;
  }

  .muted {
    color: var(--text-light);
    font-size: 13px;
  }

  .hidden {
    display: none !important;
  }

  .scroll-x {
    overflow-x: auto;
  }

  /* Pills & Badges */
  .pill {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    background: #e2e8f0;
    color: var(--text);
    margin: 2px;
  }

  .pill.ok {
    background: #dcfce7;
    color: #166534;
  }

  .pill.warning {
    background: #fef3c7;
    color: #92400e;
  }

  .pill.error {
    background: #fee2e2;
    color: #991b1b;
  }

  .pill.info {
    background: #e0f2fe;
    color: #0c4a6e;
  }

  .badge-admin {
    background: #1e3a8a;
    color: #fff;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
  }

  /* Alerts */
  .alert {
    background: var(--card);
    border-left: 4px solid var(--info);
    padding: 12px 16px;
    border-radius: 4px;
    margin: 12px 0;
    font-size: 14px;
    line-height: 1.5;
  }

  .alert.warning {
    border-color: var(--warning);
    background: #fffbeb;
  }

  .alert.danger {
    border-color: var(--danger);
    background: #fef2f2;
  }

  .alert.success {
    border-color: var(--success);
    background: #f0fdf4;
  }

  /* Toast */
  #toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #111827;
    color: #fff;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    box-shadow: var(--shadow-lg);
    opacity: 0;
    pointer-events: none;
    transform: translateY(10px);
    transition: all 0.3s ease;
    max-width: 350px;
    line-height: 1.5;
    white-space: pre-wrap;
    z-index: 1000;
  }

  #toast.show {
    opacity: 1;
    transform: translateY(0);
  }

  /* Vote Progress Bar */
  .vote-option-bar {
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
    height: 20px;
    margin: 6px 0 12px;
  }

  .vote-option-bar span {
    position: absolute;
    left: 8px;
    top: 0;
    bottom: 0;
    font-size: 11px;
    font-weight: 500;
    display: flex;
    align-items: center;
    color: #fff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    z-index: 2;
  }

  .vote-fill {
    background: linear-gradient(90deg, var(--primary), var(--primary-hover));
    height: 100%;
    transition: width 0.5s ease;
  }

  /* Loading Skeleton */
  .skeleton {
    animation: pulse 1.5s infinite;
    background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
    background-size: 200% 100%;
    border-radius: 4px;
  }

  @keyframes pulse {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* Stats Cards */
  .stats-card {
    background: var(--card);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    text-align: center;
    border: 1px solid var(--border);
  }

  .stats-number {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
    margin: 8px 0 4px;
  }

  .stats-label {
    color: var(--text-light);
    font-size: 13px;
    font-weight: 500;
  }

  /* Divider */
  .divider {
    height: 1px;
    background: var(--border);
    margin: 24px 0;
  }

  /* Links */
  .inline-link {
    color: var(--primary);
    text-decoration: none;
    font-size: 13px;
    font-weight: 500;
  }

  .inline-link:hover {
    text-decoration: underline;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    main {
      padding: 16px;
    }

    .card {
      padding: 16px;
    }

    .row {
      grid-template-columns: 1fr;
    }

    .tabs {
      padding: 6px;
    }

    .tabs button {
      padding: 8px 12px;
      font-size: 13px;
    }

    header {
      padding: 12px 16px;
    }

    header h1 {
      font-size: 18px;
    }

    #userStatus {
      font-size: 12px;
    }

    table {
      font-size: 12px;
    }

    th, td {
      padding: 8px 12px;
    }
  }

  /* Loading States */
  .loading {
    opacity: 0.6;
    pointer-events: none;
  }

  .loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid var(--primary);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <h1>ğŸ¥ ç—…å‹æœƒäº’å‹•å¹³å°</h1>
  <div id="userStatus">æœªç™»å…¥</div>
</header>

<main>
  <div class="tabs" id="tabBar">
    <button data-tab="auth" class="active">ğŸ‘¤ ç™»å…¥ / æœƒå“¡</button>
    <button data-tab="activities">ğŸ“… æ´»å‹•</button>
    <button data-tab="donation">ğŸ’° ææ¬¾</button>
    <button data-tab="receipts">ğŸ“„ æ”¶æ“š</button>
    <button data-tab="volunteer">ğŸ¤ å¿—å·¥</button>
    <button data-tab="voting">ğŸ—³ï¸ æŠ•ç¥¨</button>
    <button data-tab="dashboard">ğŸ“Š ç¸½è¦½</button>
    <button data-tab="admin" id="adminTab" class="hidden">âš™ï¸ ç®¡ç†</button>
  </div>

  <!-- Auth / Profile -->
  <section class="panel active" id="panel-auth">
    <div class="card">
      <h2>ğŸ” ç™»å…¥æ–¹å¼</h2>
      <div class="alert">
        <strong>ç™»å…¥èªªæ˜ï¼š</strong><br>
        1. è‹¥æ–¼ LINE LIFF ä¸­é–‹å•Ÿï¼Œå¯ç›´æ¥ä½¿ç”¨ LINE èº«åˆ†<br>
        2. è‹¥ç‚ºä¸€èˆ¬ç€è¦½å™¨ï¼Œæ‚¨å¯ä½¿ç”¨ã€Œé›»è©±æœƒå“¡ã€è¨»å†Š / ç™»å…¥<br>
        3. ç™»å…¥å¾Œè«‹è£œå……æœƒå“¡è³‡æ–™ï¼Œä»¥åˆ©æ´»å‹•é€šçŸ¥èˆ‡æ”¶æ“šå¯„é€
      </div>
      
      <div class="row">
        <div class="col">
          <h3>ğŸ“± LINE èº«åˆ†</h3>
          <p id="lineProfileInfo" class="muted">å°šæœªå•Ÿå‹• LIFF</p>
          <div class="flex">
            <button id="btnInitLiff">ğŸš€ å•Ÿå‹• LIFF</button>
            <button id="btnLineLogin" class="outline">ğŸ”„ é‡æ–°ç™»å…¥</button>
            <button id="btnLineLogout" class="danger">ğŸšª ç™»å‡º LINE</button>
          </div>
        </div>
        
        <div class="col">
          <h3>ğŸ“ é›»è©±æœƒå“¡è¨»å†Š</h3>
          <label>å§“å
            <input id="regRealName" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" />
          </label>
          <label>æ‰‹æ©Ÿè™Ÿç¢¼
            <input id="regPhone" placeholder="09xxxxxxxx" maxlength="10" />
          </label>
          <label>å¯†ç¢¼
            <input id="regPwd" type="password" placeholder="è‡³å°‘6ä½æ•¸" />
          </label>
          <button id="btnPhoneRegister" class="success">âœ… é›»è©±è¨»å†Šä¸¦ç™»å…¥</button>
        </div>
        
        <div class="col">
          <h3>ğŸ”‘ é›»è©±æœƒå“¡ç™»å…¥</h3>
          <label>æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆæˆ–ç•™ç©ºç”¨å§“åï¼‰
            <input id="loginPhone" placeholder="09xxxxxxxx" />
          </label>
          <label>å§“åï¼ˆé¸ç”¨ï¼‰
            <input id="loginRealName" placeholder="è‹¥ç„¡æ‰‹æ©Ÿè«‹å¡«å§“å" />
          </label>
          <label>å¯†ç¢¼
            <input id="loginPwd" type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
          </label>
          <button id="btnPhoneLogin" class="success">ğŸ”“ é›»è©±ç™»å…¥</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ‘¤ æœƒå“¡è³‡æ–™</h2>
      <div class="row">
        <div class="col">
          <label>Line IDï¼ˆå”¯è®€ï¼‰
            <input id="profileLineId" readonly />
          </label>
        </div>
        <div class="col">
          <label>æš±ç¨±
            <input id="profileLineName" placeholder="é¡¯ç¤ºç”¨æš±ç¨±" />
          </label>
        </div>
        <div class="col">
          <label>çœŸå¯¦å§“å *
            <input id="profileRealName" placeholder="æ”¶æ“šå¯„é€ç”¨" />
          </label>
        </div>
        <div class="col">
          <label>æœƒå“¡é¡å‹
            <select id="profileMemberType">
              <option value="ç—…å‹">ğŸ¥ ç—…å‹</option>
              <option value="å®¶å±¬">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶å±¬</option>
              <option value="å¿—å·¥">ğŸ¤ å¿—å·¥</option>
              <option value="è´ŠåŠ©è€…">ğŸ’ è´ŠåŠ©è€…</option>
            </select>
          </label>
        </div>
      </div>
      
      <div class="row">
        <div class="col">
          <label>æ‰‹æ©Ÿè™Ÿç¢¼ *
            <input id="profilePhone" placeholder="09xxxxxxxx" />
          </label>
        </div>
        <div class="col">
          <label>Email *
            <input id="profileEmail" type="email" placeholder="æ”¶æ“šå¯„é€ç”¨" />
          </label>
        </div>
        <div class="col">
          <label>ç”Ÿæ—¥
            <input id="profileBirthday" type="date" />
          </label>
        </div>
        <div class="col">
          <label>åœ°å€
            <input id="profileAddress" placeholder="æ”¶æ“šéƒµå¯„åœ°å€" />
          </label>
        </div>
      </div>
      
      <label>å‚™è¨»
        <textarea id="profileNotes" placeholder="å…¶ä»–æƒ³å‘Šè¨´æˆ‘å€‘çš„è³‡è¨Š..."></textarea>
      </label>
      
      <div class="flex space-between" style="margin-top: 16px;">
        <button id="btnLoadProfile" class="outline">ğŸ”„ é‡æ–°è¼‰å…¥</button>
        <button id="btnSaveProfile" class="success">ğŸ’¾ å„²å­˜è³‡æ–™</button>
      </div>
    </div>
  </section>

  <!-- Activities -->
  <section class="panel" id="panel-activities">
    <div class="card">
      <div class="flex space-between">
        <h2>ğŸ“… æ´»å‹•åˆ—è¡¨</h2>
        <button id="btnRefreshActivities" class="outline small">ğŸ”„ é‡æ–°æ•´ç†</button>
      </div>
      <div class="muted" style="margin-bottom: 16px;">é¡¯ç¤ºæ‰€æœ‰é–‹æ”¾å ±åçš„æ´»å‹•</div>
      <div id="activitiesContainer" class="scroll-x"></div>
    </div>
  </section>

  <!-- Donation -->
  <section class="panel" id="panel-donation">
    <div class="card">
      <h2>ğŸ’° æ„›å¿ƒææ¬¾</h2>
      <div class="row">
        <div class="col">
          <label>ææ¬¾åˆ†é¡
            <select id="donCategory">
              <option>ä¸€èˆ¬ææ¬¾</option>
            </select>
          </label>
        </div>
        <div class="col">
          <label>ææ¬¾é‡‘é¡ *
            <input id="donAmount" type="number" min="1" placeholder="è«‹è¼¸å…¥é‡‘é¡" />
          </label>
        </div>
        <div class="col">
          <label>éœ€è¦æ”¶æ“šï¼Ÿ
            <select id="donNeedReceipt">
              <option value="yes">âœ… æ˜¯ï¼Œéœ€è¦æ”¶æ“š</option>
              <option value="no">âŒ å¦ï¼Œä¸éœ€è¦</option>
            </select>
          </label>
        </div>
      </div>
      
      <label>å‚™è¨»èªªæ˜
        <textarea id="donDesc" placeholder="ææ¬¾ç”¨é€”èªªæ˜æˆ–æ„Ÿè¬ç•™è¨€..."></textarea>
      </label>
      
      <div style="margin-top: 16px;">
        <button id="btnCreateDonation" class="success">ğŸ’ é€å‡ºææ¬¾</button>
      </div>
      
      <div id="donationResult" class="muted" style="margin-top: 16px;"></div>
    </div>

    <div class="card">
      <div class="flex space-between">
        <h3>ğŸ“Š æˆ‘çš„ææ¬¾çµ±è¨ˆ</h3>
        <button id="btnLoadFinance" class="outline small">ğŸ“ˆ è¼‰å…¥çµ±è¨ˆ</button>
      </div>
      
      <div id="financeStats" class="row" style="margin-top: 12px;"></div>
      <div id="myDonationsTable" class="scroll-x" style="margin-top: 16px;"></div>
    </div>
  </section>

  <!-- Receipts -->
  <section class="panel" id="panel-receipts">
    <div class="card">
      <div class="flex space-between">
        <h2>ğŸ“„ æˆ‘çš„æ”¶æ“š</h2>
        <button id="btnLoadReceipts" class="outline small">ğŸ“‹ è¼‰å…¥æ”¶æ“š</button>
      </div>
      <div id="myReceiptsContainer" style="margin-top: 12px;"></div>
    </div>
    
    <div class="card hidden" id="adminReceiptsCard">
      <h2>ğŸ”§ æ”¶æ“šç®¡ç†ï¼ˆç®¡ç†å“¡ï¼‰</h2>
      <div class="row">
        <div class="col">
          <label>Line ID ç¯©é¸
            <input id="filterReceiptsLineId" placeholder="è¼¸å…¥ Line ID" />
          </label>
        </div>
        <div class="col">
          <label>æ”¶æ“šè™Ÿç¢¼
            <input id="filterReceiptNumber" placeholder="æ”¶æ“šç·¨è™Ÿ" />
          </label>
        </div>
        <div class="col">
          <label>æ”¶æ“šé¡å‹
            <select id="filterReceiptType">
              <option value="">å…¨éƒ¨é¡å‹</option>
              <option>ææ¬¾</option>
              <option>æ‰‹å‹•</option>
            </select>
          </label>
        </div>
        <div class="col">
          <label>é–‹å§‹æ—¥æœŸ
            <input id="filterReceiptFrom" type="date" />
          </label>
        </div>
        <div class="col">
          <label>çµæŸæ—¥æœŸ
            <input id="filterReceiptTo" type="date" />
          </label>
        </div>
      </div>
      
      <div class="flex" style="margin-top: 12px;">
        <button id="btnSearchReceipts">ğŸ” æŸ¥è©¢æ”¶æ“š</button>
        <button id="btnCreateManualReceipt" class="outline warning">â• æ‰‹å‹•é–‹ç«‹</button>
      </div>
      
      <div id="allReceiptsContainer" class="scroll-x" style="margin-top: 16px;"></div>
    </div>
  </section>

  <!-- Volunteer -->
  <section class="panel" id="panel-volunteer">
    <div class="card">
      <div class="flex space-between">
        <h2>ğŸ¤ å¿—å·¥æœå‹™</h2>
        <button id="btnLoadVolunteer" class="outline small">ğŸ”„ è¼‰å…¥è³‡æ–™</button>
      </div>
      
      <div id="volStats" class="row" style="margin-top: 16px;"></div>
      
      <h3 style="margin-top: 24px;">ğŸ“‹ å¿—å·¥éœ€æ±‚</h3>
      <div id="volNeedsContainer" class="scroll-x"></div>
      
      <h3 style="margin-top: 24px;">ğŸ“ æˆ‘çš„å¿—å·¥ç´€éŒ„</h3>
      <div id="volRecordsContainer" class="scroll-x"></div>
    </div>
  </section>

  <!-- Voting -->
  <section class="panel" id="panel-voting">
    <div class="card">
      <div class="flex space-between">
        <h2>ğŸ—³ï¸ æŠ•ç¥¨å°ˆå€</h2>
        <div class="flex">
          <button id="btnLoadVotingTopics" class="outline small">ğŸ“‹ è¼‰å…¥ä¸»é¡Œ</button>
          <button id="btnLoadVotingResults" class="outline small">ğŸ“Š çµ±è¨ˆçµæœ</button>
        </div>
      </div>
      
      <div id="votingTopicsContainer" style="margin-top: 16px;"></div>
      
      <div class="divider"></div>
      
      <h3>ğŸ“ˆ æŠ•ç¥¨çµ±è¨ˆçµæœ</h3>
      <div id="votingResultsContainer"></div>
    </div>
    
    <div class="card hidden" id="adminVotingCard">
      <h3>â• æ–°å¢æŠ•ç¥¨ä¸»é¡Œï¼ˆç®¡ç†å“¡ï¼‰</h3>
      <label>æŠ•ç¥¨æ¨™é¡Œ
        <input id="newVoteTitle" placeholder="è«‹è¼¸å…¥æŠ•ç¥¨ä¸»é¡Œ" />
      </label>
      <label>æŠ•ç¥¨é¸é …ï¼ˆæ¯è¡Œä¸€å€‹é¸é …ï¼‰
        <textarea id="newVoteOptions" placeholder="é¸é …A&#10;é¸é …B&#10;é¸é …C"></textarea>
      </label>
      <button id="btnCreateVotingTopic" class="success">ğŸ—³ï¸ å»ºç«‹æŠ•ç¥¨ä¸»é¡Œ</button>
    </div>
  </section>

  <!-- Dashboard -->
  <section class="panel" id="panel-dashboard">
    <div class="card">
      <div class="flex space-between">
        <h2>ğŸ“Š å€‹äººç¸½è¦½</h2>
        <button id="btnLoadDashboard" class="outline small">ğŸ”„ é‡æ–°æ•´ç†</button>
      </div>
      <div id="dashboardContent" style="margin-top: 16px;"></div>
    </div>
  </section>

  <!-- Admin -->
  <section class="panel" id="panel-admin">
    <div class="card">
      <h2>âš™ï¸ ç³»çµ±ç®¡ç†</h2>
      <div class="row">
        <div class="col">
          <button id="btnAdminExportMembers" class="outline">ğŸ‘¥ åŒ¯å‡ºæœƒå“¡è³‡æ–™</button>
        </div>
        <div class="col">
          <button id="btnAdminExportFinance" class="outline">ğŸ’° åŒ¯å‡ºè²¡å‹™è³‡æ–™</button>
        </div>
        <div class="col">
          <button id="btnAdminBackup" class="outline warning">ğŸ’¾ å»ºç«‹ç³»çµ±å‚™ä»½</button>
        </div>
      </div>
      <div id="adminActionResult" class="muted" style="margin-top: 16px;"></div>
    </div>
  </section>

</main>

<div id="toast"></div>

<script>
  /**********************
   * åŸºæœ¬è¨­å®š (è«‹è‡ªè¡Œå¡«å…¥)
   **********************/
  const APP_CONFIG = {
    API_URL: 'https://script.google.com/macros/s/AKfycbxRegzWvT2g1_fCDQjFsriTgej941aLNJ2B8xZbeqs_fH8SbeAihDVYEA92-AkRmRE/exec',
    API_KEY: 'AAbb8520258185202581',
    LIFF_ID: '1656516134-VaGgmaPm'
  };

  /**********************
   * å…¨åŸŸç‹€æ…‹
   **********************/
  const state = {
    lineId: null,
    lineName: null,
    isAdmin: false,
    sessionToken: null,
    profileLoaded: false,
    categories: { incomeCategories: [], expenseCategories: [] },
    cachedActivities: [],
    votingTopics: []
  };

  const PUBLIC_ACTIONS = new Set([
    'registerUser', 'phoneRegister', 'phoneLogin',
    'getPublicCategories', 'getActivities', 'getVotingResults'
  ]);

  /**********************
   * UI è¼”åŠ©å‡½æ•¸
   **********************/
  function toast(msg, timeout = 3500) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(el._t);
    el._t = setTimeout(() => el.classList.remove('show'), timeout);
  }

  function setUserStatus() {
    const el = document.getElementById('userStatus');
    if (!state.lineId && !state.sessionToken) {
      el.innerHTML = 'æœªç™»å…¥';
    } else {
      el.innerHTML = `
        <span>${state.lineName || 'ï¼ˆæœªæœ‰æš±ç¨±ï¼‰'}</span>
        <span class="muted" style="margin-left: 8px;">${state.lineId || 'ç„¡ID'}</span>
        ${state.sessionToken ? '<span class="pill ok">é›»è©±ç™»å…¥</span>' : ''}
        ${state.isAdmin ? '<span class="badge-admin">Admin</span>' : ''}
      `;
    }
    
    // é¡¯ç¤º/éš±è—ç®¡ç†å“¡åŠŸèƒ½
    document.getElementById('adminTab').classList.toggle('hidden', !state.isAdmin);
    document.getElementById('adminReceiptsCard').classList.toggle('hidden', !state.isAdmin);
    document.getElementById('adminVotingCard').classList.toggle('hidden', !state.isAdmin);
  }

  function switchTab(name) {
    document.querySelectorAll('.tabs button').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === name);
    });
    document.querySelectorAll('section.panel').forEach(p => {
      p.classList.toggle('active', p.id === 'panel-' + name);
    });
  }

  // Tab åˆ‡æ›äº‹ä»¶
  document.getElementById('tabBar').addEventListener('click', e => {
    if (e.target.tagName === 'BUTTON') {
      switchTab(e.target.dataset.tab);
    }
  });

  /**********************
   * API å‘¼å«
   **********************/
  async function callAPI(action, payload = {}) {
    const body = Object.assign({}, payload, {
      apiKey: APP_CONFIG.API_KEY,
      action
    });

    // é™„åŠ èº«ä»½é©—è­‰
    if (state.sessionToken) body.sessionToken = state.sessionToken;
    if (state.lineId) body.lineId = state.lineId;

    // å®‰å…¨æ€§æª¢æŸ¥
    if (!PUBLIC_ACTIONS.has(action) && !body.sessionToken && !body.lineId) {
      throw new Error('å°šæœªç™»å…¥ï¼Œè«‹å…ˆå®Œæˆç™»å…¥ç¨‹åº');
    }

    try {
      const res = await fetch(APP_CONFIG.API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      
      const json = await res.json();
      if (!json.success) throw new Error(json.message || 'API è™•ç†éŒ¯èª¤');
      
      return json;
    } catch (error) {
      console.error('API å‘¼å«å¤±æ•—:', error);
      throw error;
    }
  }

  /**********************
   * LIFF ç›¸é—œåŠŸèƒ½
   **********************/
  async function initLIFF() {
    try {
      await liff.init({ liffId: APP_CONFIG.LIFF_ID });
      
      if (!liff.isLoggedIn()) {
        document.getElementById('lineProfileInfo').innerHTML = '
          <div class="alert warning">
            å°šæœªç™»å…¥ LINEï¼Œè«‹é»æ“Šã€Œé‡æ–°ç™»å…¥ã€æŒ‰éˆ•é€²è¡Œç™»å…¥
          </div>';
        return;
      }

      const profile = await liff.getProfile();
      state.lineId = profile.userId;
      state.lineName = profile.displayName;
      
      document.getElementById('lineProfileInfo').innerHTML = `
        <div class="alert success">
          âœ… å·²æˆåŠŸç™»å…¥ LINE<br>
          <strong>æš±ç¨±ï¼š</strong>${profile.displayName}<br>
          <strong>ç”¨æˆ¶IDï¼š</strong><code>${profile.userId}</code>
        </div>
      `;
      
      setUserStatus();
      await ensureLineUserRegistered();
      
    } catch (error) {
      console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
      document.getElementById('lineProfileInfo').innerHTML = `
        <div class="alert danger">
          âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼š${error.message}
        </div>`;
    }
  }

  // LIFF æŒ‰éˆ•äº‹ä»¶
  document.getElementById('btnInitLiff').addEventListener('click', initLIFF);
  
  document.getElementById('btnLineLogin').addEventListener('click', () => {
    if (!liff.isLoggedIn()) {
      liff.login();
    } else {
      toast('å·²ç™»å…¥ LINEï¼Œé‡æ–°è¼‰å…¥é é¢ä»¥é‡æ–°åˆå§‹åŒ–');
      setTimeout(() => location.reload(), 1000);
    }
  });
  
  document.getElementById('btnLineLogout').addEventListener('click', () => {
    if (liff.isLoggedIn()) {
      if (confirm('ç¢ºå®šè¦ç™»å‡º LINE å—ï¼Ÿ')) {
        liff.logout();
        location.reload();
      }
    } else {
      toast('ç›®å‰æœªç™»å…¥ LINE');
    }
  });

  async function ensureLineUserRegistered() {
    if (!state.lineId) return;
    
    try {
      const infoRes = await callAPI('getUserInfo', { lineId: state.lineId });
      state.isAdmin = !!infoRes.data.isAdmin;
      fillProfileForm(infoRes.data);
      toast('âœ… å·²è¼‰å…¥ LINE ä½¿ç”¨è€…è³‡æ–™');
      
    } catch (error) {
      if (/æœªè¨»å†Š/.test(error.message)) {
        try {
          await callAPI('registerUser', {
            lineId: state.lineId,
            lineName: state.lineName,
            realName: state.lineName
          });
          
          toast('âœ… å·²è‡ªå‹•å®Œæˆ LINE ä½¿ç”¨è€…è¨»å†Š');
          
          const infoRes2 = await callAPI('getUserInfo', { lineId: state.lineId });
          state.isAdmin = !!infoRes2.data.isAdmin;
          fillProfileForm(infoRes2.data);
          
        } catch (regError) {
          console.error('LINE è¨»å†Šå¤±æ•—:', regError);
          toast('âŒ LINE ä½¿ç”¨è€…è¨»å†Šå¤±æ•—ï¼š' + regError.message);
        }
      } else {
        console.error('å–å¾—ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:', error);
        toast('âš ï¸ å–å¾— LINE ä½¿ç”¨è€…è³‡æ–™å¤±æ•—ï¼š' + error.message);
      }
    } finally {
      setUserStatus();
      await loadCategories();
    }
  }

  /**********************
   * é›»è©±è¨»å†Š/ç™»å…¥
   **********************/
  document.getElementById('btnPhoneRegister').addEventListener('click', async () => {
    try {
      const realName = document.getElementById('regRealName').value.trim();
      const phone = document.getElementById('regPhone').value.trim();
      const pwd = document.getElementById('regPwd').value;
      
      if (!realName || !phone || !pwd) {
        return toast('âš ï¸ è«‹å¡«å¯«å®Œæ•´çš„è¨»å†Šè³‡è¨Š');
      }
      
      if (!/^09\d{8}$/.test(phone)) {
        return toast('âš ï¸ è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼ï¼ˆ09xxxxxxxxï¼‰');
      }
      
      if (pwd.length < 6) {
        return toast('âš ï¸ å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6ä½æ•¸');
      }
      
      const result = await callAPI('phoneRegister', { 
        realName, 
        phone, 
        password: pwd 
      });
      
      state.sessionToken = result.data.sessionToken;
      state.lineId = 'TEL_' + phone;
      state.lineName = realName;
      state.isAdmin = false;
      
      toast('âœ… é›»è©±è¨»å†ŠæˆåŠŸï¼Œæ­¡è¿åŠ å…¥ç—…å‹æœƒï¼');
      setUserStatus();
      await loadCategories();
      
    } catch (error) {
      toast('âŒ é›»è©±è¨»å†Šå¤±æ•—ï¼š' + error.message);
    }
  });

  document.getElementById('btnPhoneLogin').addEventListener('click', async () => {
    try {
      const phone = document.getElementById('loginPhone').value.trim();
      const realName = document.getElementById('loginRealName').value.trim();
      const pwd = document.getElementById('loginPwd').value;
      
      if (!pwd || (!phone && !realName)) {
        return toast('âš ï¸ è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æˆ–å§“åï¼Œä»¥åŠå¯†ç¢¼');
      }
      
      const result = await callAPI('phoneLogin', { 
        phone, 
        realName, 
        password: pwd 
      });
      
      state.sessionToken = result.data.sessionToken;
      state.lineId = phone ? ('TEL_' + phone) : state.lineId;
      state.lineName = realName || state.lineName;
      
      toast('âœ… é›»è©±ç™»å…¥æˆåŠŸï¼');
      
      // å–å¾—ä½¿ç”¨è€…è³‡è¨Šä»¥åˆ¤æ–·ç®¡ç†å“¡æ¬Šé™
      try {
        const info = await callAPI('getUserInfo', { lineId: state.lineId });
        state.isAdmin = !!info.data.isAdmin;
        fillProfileForm(info.data);
      } catch (e) {
        console.warn('å–å¾—ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—:', e);
      }
      
      setUserStatus();
      await loadCategories();
      
    } catch (error) {
      toast('âŒ é›»è©±ç™»å…¥å¤±æ•—ï¼š' + error.message);
    }
  });

  /**********************
   * æœƒå“¡è³‡æ–™ç®¡ç†
   **********************/
  function fillProfileForm(data) {
    document.getElementById('profileLineId').value = data.lineId || '';
    document.getElementById('profileLineName').value = data.lineName || '';
    document.getElementById('profileRealName').value = data.realName || '';
    document.getElementById('profileMemberType').value = data.memberType || 'ç—…å‹';
    document.getElementById('profilePhone').value = data.phone || '';
    document.getElementById('profileEmail').value = data.email || '';
    
    if (data.birthday) {
      const bStr = formatDateInput(data.birthday);
      if (bStr) document.getElementById('profileBirthday').value = bStr;
    }
    
    document.getElementById('profileAddress').value = data.address || '';
    document.getElementById('profileNotes').value = data.notes || '';
    state.profileLoaded = true;
  }

  function formatDateInput(val) {
    try {
      if (!val) return '';
      if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
      
      const d = new Date(val);
      if (!isNaN(d.getTime())) {
        return d.toISOString().slice(0, 10);
      }
      return '';
    } catch (_) { 
      return ''; 
    }
  }

  document.getElementById('btnLoadProfile').addEventListener('click', async () => {
    if (!state.lineId) return toast('âš ï¸ è«‹å…ˆå®Œæˆç™»å…¥');
    
    try {
      const result = await callAPI('getUserInfo', { lineId: state.lineId });
      state.isAdmin = !!result.data.isAdmin;
      fillProfileForm(result.data);
      setUserStatus();
      toast('âœ… æœƒå“¡è³‡æ–™å·²é‡æ–°è¼‰å…¥');
    } catch (error) {
      toast('âŒ è¼‰å…¥æœƒå“¡è³‡æ–™å¤±æ•—ï¼š' + error.message);
    }
  });

  document.getElementById('btnSaveProfile').addEventListener('click', async () => {
    if (!state.lineId) return toast('âš ï¸ è«‹å…ˆå®Œæˆç™»å…¥');
    
    try {
      const payload = {
        lineId: state.lineId,
        lineName: document.getElementById('profileLineName').value.trim(),
        realName: document.getElementById('profileRealName').value.trim(),
        memberType: document.getElementById('profileMemberType').value,
        phone: document.getElementById('profilePhone').value.trim(),
        email: document.getElementById('profileEmail').value.trim(),
        birthday: document.getElementById('profileBirthday').value,
        address: document.getElementById('profileAddress').value.trim(),
        notes: document.getElementById('profileNotes').value
      };
      
      // åŸºæœ¬é©—è­‰
      if (!payload.realName) {
        return toast('âš ï¸ è«‹å¡«å¯«çœŸå¯¦å§“å');
      }
      
      if (!payload.phone || !/^09\d{8}$/.test(payload.phone)) {
        return toast('âš ï¸ è«‹å¡«å¯«æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼');
      }
      
      if (!payload.email || !/\S+@\S+\.\S+/.test(payload.email)) {
        return toast('âš ï¸ è«‹å¡«å¯«æ­£ç¢ºçš„Emailåœ°å€');
      }
      
      await callAPI('updateProfile', payload);
      toast('âœ… æœƒå“¡è³‡æ–™æ›´æ–°æˆåŠŸï¼');
      
      // é‡æ–°å–å¾—è³‡æ–™ä»¥æ›´æ–°ç®¡ç†å“¡æ¨™è¨˜
      const info = await callAPI('getUserInfo', { lineId: state.lineId });
      state.isAdmin = !!info.data.isAdmin;
      setUserStatus();
      
    } catch (error) {
      toast('âŒ æœƒå“¡è³‡æ–™æ›´æ–°å¤±æ•—ï¼š' + error.message);
    }
  });

  /**********************
   * åˆ†é¡è³‡æ–™è¼‰å…¥
   **********************/
  async function loadCategories() {
    try {
      const result = await callAPI('getPublicCategories', {});
      state.categories = result.data;
      
      const donSel = document.getElementById('donCategory');
      donSel.innerHTML = state.categories.incomeCategories
        .map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`)
        .join('');
        
    } catch (error) {
      console.warn('è¼‰å…¥åˆ†é¡è³‡æ–™å¤±æ•—:', error);
    }
  }

  /**********************
   * æ´»å‹•ç®¡ç†
   **********************/
  document.getElementById('btnRefreshActivities').addEventListener('click', loadActivities);

  async function loadActivities() {
    try {
      const result = await callAPI('getActivities', {});
      state.cachedActivities = result.data || [];
      renderActivities();
      toast('âœ… æ´»å‹•åˆ—è¡¨å·²æ›´æ–°');
    } catch (error) {
      toast('âŒ è¼‰å…¥æ´»å‹•å¤±æ•—ï¼š' + error.message);
    }
  }

  function renderActivities() {
    const wrap = document.getElementById('activitiesContainer');
    
    if (!state.cachedActivities.length) {
      wrap.innerHTML = '<div class="alert">ğŸ“… ç›®å‰æ²’æœ‰é–‹æ”¾å ±åçš„æ´»å‹•</div>';
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>ğŸ“‹ æ´»å‹•æ¨™é¡Œ</th>
            <th>ğŸ“… æ´»å‹•æ—¥æœŸ</th>
            <th>ğŸ“ æ´»å‹•åœ°é»</th>
            <th>ğŸ‘¥ å ±åäººæ•¸</th>
            <th>ğŸ“Š ç‹€æ…‹</th>
            <th>âš¡ æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    state.cachedActivities.forEach(activity => {
      const isOpen = activity.status === 'é–‹æ”¾å ±å';
      const canRegister = isOpen && state.lineId;
      
      html += `
        <tr>
          <td><strong>${escapeHtml(activity.title || '')}</strong></td>
          <td>${escapeHtml(activity.date || '')}</td>
          <td>${escapeHtml(activity.location || '')}</td>
          <td>${activity.currentCount || 0}/${activity.maxParticipants || 0}</td>
          <td>
            <span class="pill ${isOpen ? 'ok' : 'warning'}">
              ${activity.status || ''}
            </span>
          </td>
          <td>
            ${canRegister ? 
              `<button class="small success" data-act-register="${activity.id}">
                âœ… ç«‹å³å ±å
              </button>` : 
              (state.lineId ? '<span class="muted">å·²æˆªæ­¢</span>' : '<span class="muted">éœ€ç™»å…¥</span>')
            }
          </td>
        </tr>
      `;
    });
    
    html += '</tbody></table>';
    wrap.innerHTML = html;

    // ç¶å®šå ±åäº‹ä»¶
    wrap.querySelectorAll('[data-act-register]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const activityId = btn.getAttribute('data-act-register');
        const activity = state.cachedActivities.find(a => a.id == activityId);
        
        if (!confirm(`ç¢ºå®šè¦å ±åã€Œ${activity?.title || 'æ­¤æ´»å‹•'}ã€å—ï¼Ÿ`)) return;
        
        try {
          await callAPI('registerActivity', { activityId });
          toast('ğŸ‰ æ´»å‹•å ±åæˆåŠŸï¼');
          loadActivities(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°äººæ•¸
        } catch (error) {
          toast('âŒ æ´»å‹•å ±åå¤±æ•—ï¼š' + error.message);
        }
      });
    });
  }

  /**********************
   * ææ¬¾åŠŸèƒ½
   **********************/
  document.getElementById('btnCreateDonation').addEventListener('click', async () => {
    if (!state.lineId) return toast('âš ï¸ è«‹å…ˆå®Œæˆç™»å…¥');
    
    const amount = Number(document.getElementById('donAmount').value);
    const category = document.getElementById('donCategory').value;
    const desc = document.getElementById('donDesc').value;
    const needReceipt = document.getElementById('donNeedReceipt').value === 'yes';
    
    if (!(amount > 0)) return toast('âš ï¸ ææ¬¾é‡‘é¡éœ€å¤§æ–¼ 0');
    if (amount > 1000000) return toast('âš ï¸ å–®ç­†ææ¬¾é‡‘é¡ä¸èƒ½è¶…é 100 è¬');
    
    try {
      const result = await callAPI('createDonation', {
        amount,
        category,
        description: desc,
        needReceipt
      });
      
      document.getElementById('donationResult').innerHTML = `
        <div class="alert success">
          ğŸ‰ ææ¬¾æˆåŠŸï¼æ„Ÿè¬æ‚¨çš„æ„›å¿ƒæ”¯æŒ<br>
          <strong>ææ¬¾ç·¨è™Ÿï¼š</strong>${result.data.id || ''}<br>
          ${result.data.receiptNumber ? 
            `<strong>æ”¶æ“šè™Ÿç¢¼ï¼š</strong>${result.data.receiptNumber}<br>` : ''
          }
          ${result.data.pdfUrl ? 
            `<a href="${result.data.pdfUrl}" target="_blank" class="inline-link">ğŸ“„ ä¸‹è¼‰æ”¶æ“šPDF</a>` : ''
          }
        </div>
      `;
      
      toast('ğŸ’ ææ¬¾æˆåŠŸï¼Œæ„Ÿè¬æ‚¨çš„æ„›å¿ƒï¼');
      
      // æ¸…ç©ºè¡¨å–®
      document.getElementById('donAmount').value = '';
      document.getElementById('donDesc').value = '';
      
      // é‡æ–°è¼‰å…¥è²¡å‹™çµ±è¨ˆ
      loadFinance();
      
    } catch (error) {
      toast('âŒ ææ¬¾è™•ç†å¤±æ•—ï¼š' + error.message);
    }
  });

  document.getElementById('btnLoadFinance').addEventListener('click', loadFinance);

  async function loadFinance() {
    if (!state.lineId) return toast('âš ï¸ è«‹å…ˆå®Œæˆç™»å…¥');
    
    try {
      const result = await callAPI('getFinanceData', {});
      const stats = result.data.stats;
      
      // æ¸²æŸ“çµ±è¨ˆå¡ç‰‡
      const statsWrap = document.getElementById('financeStats');
      statsWrap.innerHTML = `
        <div class="col">
          <div class="stats-card">
            <div class="stats-label">ğŸ’° ç¸½ææ¬¾é‡‘é¡</div>
            <div class="stats-number">$${stats.totalDonation.toLocaleString()}</div>
          </div>
        </div>
        <div class="col">
          <div class="stats-card">
            <div class="stats-label">ğŸ“Š ææ¬¾ç­†æ•¸</div>
            <div class="stats-number">${stats.donationCount}</div>
          </div>
        </div>
        <div class="col">
          <div class="stats-card">
            <div class="stats-label">â³ å¾…æ ¸æ”¯å‡º</div>
            <div class="stats-number">$${stats.pendingExpenses.toLocaleString()}</div>
          </div>
        </div>
      `;

      // æ¸²æŸ“ææ¬¾æ˜ç´°è¡¨
      const tableWrap = document.getElementById('myDonationsTable');
      if (result.data.donations?.length) {
        let html = `
          <table>
            <thead>
              <tr>
                <th>ğŸ“… ææ¬¾æ™‚é–“</th>
                <th>ğŸ“‚ ææ¬¾åˆ†é¡</th>
                <th>ğŸ’° é‡‘é¡</th>
                <th>ğŸ“„ æ”¶æ“šè™Ÿç¢¼</th>
                <th>ğŸ“ å‚™è¨»</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        result.data.donations.forEach(donation => {
          html += `
            <tr>
              <td>${formatDateTime(donation.createdAt)}</td>
              <td>${escapeHtml(donation.category || '')}</td>
              <td class="text-right"><strong>$${donation.amount.toLocaleString()}</strong></td>
              <td>${donation.receiptNumber || '<span class="muted">ç„¡</span>'}</td>
              <td class="muted">${escapeHtml(donation.description || '')}</td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        tableWrap.innerHTML = html;
      } else {
        tableWrap.innerHTML = '<div class="alert">ğŸ“‹ å°šç„¡ææ¬¾ç´€éŒ„</div>';
      }
      
      toast('âœ… è²¡å‹™çµ±è¨ˆå·²æ›´æ–°');
      
    } catch (error) {
      toast('âŒ è¼‰å…¥è²¡å‹™çµ±è¨ˆå¤±æ•—ï¼š' + error.message);
    }
  }

  /**********************
   * æ”¶æ“šç®¡ç†
   **********************/
  document.getElementById('btnLoadReceipts').addEventListener('click', loadMyReceipts);

  async function loadMyReceipts() {
    if (!state.lineId) return toast('âš ï¸ è«‹å…ˆå®Œæˆç™»å…¥');
    
    try {
      const result = await callAPI('getMyReceipts', {});
      const receipts = result.data || [];
      const wrap = document.getElementById('myReceiptsContainer');
      
      if (!receipts.length) {
        wrap.innerHTML = '<div class="alert">ğŸ“„ å°šç„¡æ”¶æ“šè¨˜éŒ„</div>';
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>ğŸ“… é–‹ç«‹æ—¥æœŸ</th>
              <th>ğŸ“„ æ”¶æ“šè™Ÿç¢¼</th>
              <th>ğŸ“‚ é¡å‹</th>
              <th>ğŸ’° é‡‘é¡</th>
              <th>ğŸ“ PDFæª”æ¡ˆ</th>
              <th>ğŸ“§ Emailå¯„é€</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      receipts.forEach(receipt => {
        html += `
          <tr>
            <td>${formatDate(receipt.issueDate)}</td>
            <td><strong>${receipt.receiptNumber}</strong></td>
            <td>${escapeHtml(receipt.type || '')}</td>
            <td class="text-right">$${receipt.amount.toLocaleString()}</td>
            <td>
              ${receipt.pdfUrl ? 
                `<a href="${receipt.pdfUrl}" target="_blank" class="inline-link">ğŸ“ é–‹å•ŸPDF</a>` : 
                '<span class="muted">ç„¡æª”æ¡ˆ</span>'
              }
            </td>
            <td>
              ${receipt.emailSent ? 
                '<span class="pill ok">âœ… å·²å¯„é€</span>' : 
                '<span class="pill warning">â³ æœªå¯„é€</span>'
              }
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      wrap.innerHTML = html;
      
      toast('âœ… æ”¶æ“šåˆ—è¡¨å·²æ›´æ–°');
      
    } catch (error) {
      toast('âŒ è¼‰å…¥æ”¶æ“šå¤±æ•—ï¼š' + error.message);
    }
  }

  // ç®¡ç†å“¡æ”¶æ“šæŸ¥è©¢
  document.getElementById('btnSearchReceipts').addEventListener('click', async () => {
    if (!state.isAdmin) return toast('âš ï¸ éœ€è¦ç®¡ç†å“¡æ¬Šé™');
    
    try {
      const params = {
        lineId: state.lineId,
        lineIdFilter: document.getElementById('filterReceiptsLineId').value.trim(),
        receiptNumber: document.getElementById('filterReceiptNumber').value.trim(),
        type: document.getElementById('filterReceiptType').value,
        dateFrom: document.getElementById('filterReceiptFrom').value,
        dateTo: document.getElementById('filterReceiptTo').value
      };
      
      const result = await callAPI('getAllReceipts', params);
      renderAdminReceipts(result.data.receipts || []);
      toast('âœ… æ”¶æ“šæŸ¥è©¢å®Œæˆ');
      
    } catch (error) {
      toast('âŒ æ”¶æ“šæŸ¥è©¢å¤±æ•—ï¼š' + error.message);
    }
  });

  document.getElementById('btnCreateManualReceipt').addEventListener('click', async () => {
    if (!state.isAdmin) return toast('âš ï¸ éœ€è¦ç®¡ç†å“¡æ¬Šé™');
    
    const targetLineId = prompt('è«‹è¼¸å…¥ç›®æ¨™ä½¿ç”¨è€…çš„ Line ID (æˆ– TEL_xxx):');
    if (!targetLineId) return;
    
    const type = prompt('è«‹è¼¸å…¥æ”¶æ“šé¡å‹:', 'ææ¬¾') || 'ææ¬¾';
    const amountStr = prompt('è«‹è¼¸å…¥é‡‘é¡:', '1000');
    const amount = parseInt(amountStr, 10);
    
    if (!(amount > 0)) return toast('âš ï¸ é‡‘é¡éœ€å¤§æ–¼ 0');
    
    try {
      const result = await callAPI('createManualReceipt', {
        targetLineId,
        type,
        amount,
        createDonation: type === 'ææ¬¾'
      });
      
      toast('âœ… æ‰‹å‹•æ”¶æ“šé–‹ç«‹æˆåŠŸï¼š' + result.data.receiptNumber);
      
      // é‡æ–°æŸ¥è©¢ä»¥æ›´æ–°åˆ—è¡¨
      document.getElementById('btnSearchReceipts').click();
      
    } catch (error) {
      toast('âŒ æ‰‹å‹•æ”¶æ“šé–‹ç«‹å¤±æ•—ï¼š' + error.message);
    }
  });

  function renderAdminReceipts(receipts) {
    const wrap = document.getElementById('allReceiptsContainer');
    
    if (!receipts.length) {
      wrap.innerHTML = '<div class="alert">ğŸ“„ æŸ¥ç„¡æ”¶æ“šè³‡æ–™</div>';
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>ğŸ“… é–‹ç«‹æ—¥æœŸ</th>
            <th>ğŸ“„ æ”¶æ“šè™Ÿç¢¼</th>
            <th>ğŸ‘¤ Line ID</th>
            <th>ğŸ“‚ é¡å‹</th>
            <th>ğŸ’° é‡‘é¡</th>
            <th>ğŸ“ PDF</th>
            <th>ğŸ“§ å¯„é€ç‹€æ…‹</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    receipts.forEach(receipt => {
      html += `
        <tr>
          <td>${formatDate(receipt.issueDate)}</td>
          <td><strong>${receipt.receiptNumber}</strong></td>
          <td><code>${escapeHtml(receipt.lineId || '')}</code></td>
          <td>${escapeHtml(receipt.type || '')}</td>
          <td class="text-right">$${receipt.amount.toLocaleString()}</td>
          <td>${receipt.pdfUrl ? 
                `<a href="${receipt.pdfUrl}" target="_blank" class="inline-link">ğŸ“ PDF</a>` : 
                '<span class="muted">ç„¡</span>'
              }
            </td>
            <td>
              ${receipt.emailSent ? 
                '<span class="pill ok">âœ… å·²å¯„é€</span>' : 
                '<span class="pill warning">â³ æœªå¯„é€</span>'
              }
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }

    /**********************
     * å¿—å·¥æœå‹™
     **********************/
    document.getElementById('btnLoadVolunteer').addEventListener('click', loadVolunteer);

    async function loadVolunteer() {
      if (!state.lineId) return toast('âš ï¸ è«‹å…ˆå®Œæˆç™»å…¥');
      
      try {
        const result = await callAPI('getVolunteerData', {});
        const stats = result.data.stats;
        
        // æ¸²æŸ“çµ±è¨ˆè³‡æ–™
        document.getElementById('volStats').innerHTML = `
          <div class="col">
            <div class="stats-card">
              <div class="stats-label">â° ç¸½æœå‹™æ™‚æ•¸</div>
              <div class="stats-number">${stats.totalHours}</div>
            </div>
          </div>
          <div class="col">
            <div class="stats-card">
              <div class="stats-label">ğŸ“‹ åƒèˆ‡æ´»å‹•æ•¸</div>
              <div class="stats-number">${stats.totalActivities}</div>
            </div>
          </div>
          <div class="col">
            <div class="stats-card">
              <div class="stats-label">ğŸ”” é–‹æ”¾éœ€æ±‚</div>
              <div class="stats-number">${stats.availableNeeds}</div>
            </div>
          </div>
        `;

        // æ¸²æŸ“å¿—å·¥éœ€æ±‚
        const needsWrap = document.getElementById('volNeedsContainer');
        if (result.data.needs?.length) {
          let html = `
            <table>
              <thead>
                <tr>
                  <th>ğŸ“‹ éœ€æ±‚æ¨™é¡Œ</th>
                  <th>ğŸ“… æœå‹™æ—¥æœŸ</th>
                  <th>ğŸ‘¥ éœ€æ±‚äººæ•¸</th>
                  <th>â° æœå‹™æ™‚æ•¸</th>
                  <th>âš¡ æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          result.data.needs.forEach(need => {
            const isFull = need.currentCount >= need.needCount;
            html += `
              <tr>
                <td><strong>${escapeHtml(need.title || '')}</strong></td>
                <td>${need.date || ''}</td>
                <td>${need.currentCount || 0}/${need.needCount || 0}</td>
                <td>${need.hours || 0} å°æ™‚</td>
                <td>
                  ${state.lineId && !isFull ? 
                    `<button class="small success" data-vol-apply="${need.id}">
                      ğŸ™‹â€â™€ï¸ æˆ‘è¦å ±å
                    </button>` : 
                    (isFull ? '<span class="pill warning">å·²é¡æ»¿</span>' : '<span class="muted">éœ€ç™»å…¥</span>')
                  }
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
          needsWrap.innerHTML = html;

          // ç¶å®šå¿—å·¥å ±åäº‹ä»¶
          needsWrap.querySelectorAll('[data-vol-apply]').forEach(btn => {
            btn.addEventListener('click', async () => {
              const needId = btn.getAttribute('data-vol-apply');
              const need = result.data.needs.find(n => n.id == needId);
              
              if (!confirm(`ç¢ºå®šè¦å ±åå¿—å·¥æœå‹™ã€Œ${need?.title || 'æ­¤é …ç›®'}ã€å—ï¼Ÿ`)) return;
              
              try {
                await callAPI('applyVolunteer', { needId });
                toast('ğŸ‰ å¿—å·¥å ±åæˆåŠŸï¼');
                loadVolunteer(); // é‡æ–°è¼‰å…¥
              } catch (error) {
                toast('âŒ å¿—å·¥å ±åå¤±æ•—ï¼š' + error.message);
              }
            });
          });
        } else {
          needsWrap.innerHTML = '<div class="alert">ğŸ“‹ ç›®å‰æ²’æœ‰é–‹æ”¾çš„å¿—å·¥éœ€æ±‚</div>';
        }

        // æ¸²æŸ“å¿—å·¥ç´€éŒ„
        const recordsWrap = document.getElementById('volRecordsContainer');
        if (result.data.records?.length) {
          let html = `
            <table>
              <thead>
                <tr>
                  <th>ğŸ“‹ æœå‹™é …ç›®</th>
                  <th>ğŸ“… æœå‹™æ—¥æœŸ</th>
                  <th>â° æœå‹™æ™‚æ•¸</th>
                  <th>ğŸ“Š ç‹€æ…‹</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          result.data.records.forEach(record => {
            html += `
              <tr>
                <td><strong>${escapeHtml(record.title || '')}</strong></td>
                <td>${record.date || ''}</td>
                <td>${record.hours || 0} å°æ™‚</td>
                <td>
                  <span class="pill ${record.status === 'å·²å®Œæˆ' ? 'ok' : 'warning'}">
                    ${record.status || ''}
                  </span>
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
          recordsWrap.innerHTML = html;
        } else {
          recordsWrap.innerHTML = '<div class="alert">ğŸ“‹ å°šç„¡å¿—å·¥æœå‹™ç´€éŒ„</div>';
        }

        toast('âœ… å¿—å·¥è³‡æ–™å·²æ›´æ–°');
        
      } catch (error) {
        toast('âŒ è¼‰å…¥å¿—å·¥è³‡æ–™å¤±æ•—ï¼š' + error.message);
      }
    }

    /**********************
     * æŠ•ç¥¨åŠŸèƒ½
     **********************/
    document.getElementById('btnCreateVotingTopic').addEventListener('click', async () => {
      if (!state.isAdmin) return toast('âš ï¸ éœ€è¦ç®¡ç†å“¡æ¬Šé™');
      
      const title = document.getElementById('newVoteTitle').value.trim();
      const optionsText = document.getElementById('newVoteOptions').value;
      const options = optionsText.split(/\n+/).map(l => l.trim()).filter(Boolean);
      
      if (!title || !options.length) {
        return toast('âš ï¸ è«‹è¼¸å…¥æŠ•ç¥¨æ¨™é¡Œèˆ‡è‡³å°‘ä¸€å€‹é¸é …');
      }
      
      if (options.length < 2) {
        return toast('âš ï¸ æŠ•ç¥¨é¸é …è‡³å°‘éœ€è¦2å€‹');
      }
      
      try {
        await callAPI('createVotingTopic', { title, options });
        toast('âœ… æŠ•ç¥¨ä¸»é¡Œå»ºç«‹æˆåŠŸï¼ˆè‰ç¨¿ç‹€æ…‹ï¼Œè«‹è‡³å¾Œç«¯ç™¼å¸ƒï¼‰');
        
        // æ¸…ç©ºè¡¨å–®
        document.getElementById('newVoteTitle').value = '';
        document.getElementById('newVoteOptions').value = '';
        
        loadVotingTopics();
        
      } catch (error) {
        toast('âŒ å»ºç«‹æŠ•ç¥¨ä¸»é¡Œå¤±æ•—ï¼š' + error.message);
      }
    });

    document.getElementById('btnLoadVotingTopics').addEventListener('click', loadVotingTopics);

    async function loadVotingTopics() {
      try {
        const result = await callAPI('listVotingTopics', {});
        state.votingTopics = result.data || [];
        renderVotingTopics();
        toast('âœ… æŠ•ç¥¨ä¸»é¡Œå·²æ›´æ–°');
      } catch (error) {
        toast('âŒ è¼‰å…¥æŠ•ç¥¨ä¸»é¡Œå¤±æ•—ï¼š' + error.message);
      }
    }

    function renderVotingTopics() {
      const wrap = document.getElementById('votingTopicsContainer');
      
      if (!state.votingTopics.length) {
        wrap.innerHTML = '<div class="alert">ğŸ—³ï¸ ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„æŠ•ç¥¨</div>';
        return;
      }

      let html = '<div class="row">';
      
      state.votingTopics.forEach(topic => {
        const isActive = topic.status === 'active' || topic.status === 'é€²è¡Œä¸­';
        
        html += `
          <div class="col card" style="min-width: 300px;">
            <h4 style="margin: 0 0 8px;">${escapeHtml(topic.title || '')}</h4>
            <div class="muted" style="font-size: 12px; margin-bottom: 12px;">
              ç‹€æ…‹ï¼š<span class="pill ${isActive ? 'ok' : 'warning'}">${topic.status}</span>
            </div>
            
            ${isActive ? `
              <div style="margin-bottom: 12px;">
                ${(topic.options || []).map(option => `
                  <label style="display: flex; align-items: center; gap: 8px; margin: 6px 0; cursor: pointer;">
                    <input type="radio" name="vote_${topic.id}" value="${escapeHtml(option.key || option)}" />
                    <span style="font-size: 14px;">${escapeHtml(option.text || option)}</span>
                  </label>
                `).join('')}
              </div>
              <button data-vote-topic="${topic.id}" class="small success" style="width: 100%;">
                ğŸ—³ï¸ æŠ•ç¥¨
              </button>
            ` : `
              <div class="muted" style="font-size: 13px;">æ­¤æŠ•ç¥¨å·²çµæŸæˆ–å°šæœªé–‹æ”¾</div>
            `}
          </div>
        `;
      });
      
      html += '</div>';
      wrap.innerHTML = html;

      // ç¶å®šæŠ•ç¥¨äº‹ä»¶
      wrap.querySelectorAll('[data-vote-topic]').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!state.lineId && !state.sessionToken) {
            return toast('âš ï¸ è«‹å…ˆç™»å…¥æ‰èƒ½åƒèˆ‡æŠ•ç¥¨');
          }
          
          const topicId = btn.getAttribute('data-vote-topic');
          const selectedOption = wrap.querySelector(`input[name="vote_${topicId}"]:checked`);
          
          if (!selectedOption) {
            return toast('âš ï¸ è«‹å…ˆé¸æ“‡ä¸€å€‹é¸é …');
          }
          
          const topic = state.votingTopics.find(t => t.id == topicId);
          
          if (!confirm(`ç¢ºå®šè¦æŠ•ç¥¨çµ¦ã€Œ${selectedOption.nextElementSibling.textContent}ã€å—ï¼Ÿ`)) return;
          
          try {
            await callAPI('castVote', { 
              topicId, 
              optionKey: selectedOption.value 
            });
            
            toast('ğŸ‰ æŠ•ç¥¨æˆåŠŸï¼');
            loadVotingResults(); // è¼‰å…¥çµæœ
            
          } catch (error) {
            toast('âŒ æŠ•ç¥¨å¤±æ•—ï¼š' + error.message);
          }
        });
      });
    }

    document.getElementById('btnLoadVotingResults').addEventListener('click', loadVotingResults);

    async function loadVotingResults() {
      try {
        const result = await callAPI('getVotingResults', {});
        renderVotingResults(result.data.topics || []);
        toast('âœ… æŠ•ç¥¨çµ±è¨ˆå·²æ›´æ–°');
      } catch (error) {
        toast('âŒ è¼‰å…¥æŠ•ç¥¨çµ±è¨ˆå¤±æ•—ï¼š' + error.message);
      }
    }

    function renderVotingResults(topics) {
      const wrap = document.getElementById('votingResultsContainer');
      
      if (!topics.length) {
        wrap.innerHTML = '<div class="alert">ğŸ“Š æš«ç„¡æŠ•ç¥¨çµ±è¨ˆè³‡æ–™</div>';
        return;
      }

      let html = '';
      
      topics.forEach(topic => {
        html += `
          <div class="card" style="padding: 16px;">
            <div class="flex space-between" style="margin-bottom: 12px;">
              <strong style="font-size: 16px;">${escapeHtml(topic.title)}</strong>
              <span class="muted" style="font-size: 12px;">
                ğŸ“Š ç¸½ç¥¨æ•¸ï¼š<strong>${topic.totalVotes}</strong>
              </span>
            </div>
            
            <div>
              ${topic.options.map(option => {
                const percentage = option.percentage || 0;
                const isUserVoted = topic.userVotedOption === option.key;
                
                return `
                  <div style="margin: 8px 0;">
                    <div class="flex space-between" style="font-size: 13px; margin-bottom: 4px;">
                      <span>
                        ${escapeHtml(option.text)}
                        ${isUserVoted ? '<span class="pill ok" style="margin-left: 6px;">âœ… æˆ‘çš„é¸æ“‡</span>' : ''}
                      </span>
                      <span><strong>${option.count}</strong> ç¥¨ (${percentage}%)</span>
                    </div>
                    <div class="vote-option-bar">
                      <div class="vote-fill" style="width: ${percentage}%;"></div>
                      <span>${percentage > 15 ? percentage + '%' : ''}</span>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      });
      
      wrap.innerHTML = html;
    }

    /**********************
     * å€‹äººç¸½è¦½
     **********************/
    document.getElementById('btnLoadDashboard').addEventListener('click', loadDashboard);

    async function loadDashboard() {
      if (!state.lineId) return toast('âš ï¸ è«‹å…ˆå®Œæˆç™»å…¥');
      
      try {
        const result = await callAPI('getDashboardData', {});
        const data = result.data;
        
        const html = `
          <div class="row" style="margin-bottom: 24px;">
            <div class="col">
              <div class="stats-card">
                <div class="stats-label">ğŸ“… é–‹æ”¾æ´»å‹•æ•¸</div>
                <div class="stats-number">${data.totalActivities}</div>
              </div>
            </div>
            <div class="col">
              <div class="stats-card">
                <div class="stats-label">âœ… æˆ‘çš„å ±åæ•¸</div>
                <div class="stats-number">${data.myRegistrations}</div>
              </div>
            </div>
            <div class="col">
              <div class="stats-card">
                <div class="stats-label">ğŸ¤ å¿—å·¥æ™‚æ•¸</div>
                <div class="stats-number">${data.myVolunteerHours}</div>
              </div>
            </div>
            <div class="col">
              <div class="stats-card">
                <div class="stats-label">ğŸ’° ç´¯è¨ˆææ¬¾</div>
                <div class="stats-number">$${data.myDonationAmount.toLocaleString()}</div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <h3>ğŸ“‹ æœ€æ–°æ´»å‹•</h3>
            ${data.recentActivity?.length ? `
              <ul style="padding-left: 20px; margin: 0;">
                ${data.recentActivity.map(activity => `
                  <li style="margin: 6px 0;">
                    <strong>${escapeHtml(activity.title)}</strong>
                    <span class="muted" style="margin-left: 8px;">${activity.date || ''}</span>
                  </li>
                `).join('')}
              </ul>
            ` : '<div class="muted">æš«ç„¡æœ€æ–°æ´»å‹•</div>'}
          </div>
        `;
        
        document.getElementById('dashboardContent').innerHTML = html;
        toast('âœ… å€‹äººç¸½è¦½å·²æ›´æ–°');
        
      } catch (error) {
        toast('âŒ è¼‰å…¥å€‹äººç¸½è¦½å¤±æ•—ï¼š' + error.message);
      }
    }

    /**********************
     * ç®¡ç†åŠŸèƒ½
     **********************/
    document.getElementById('btnAdminExportMembers').addEventListener('click', async () => {
      if (!state.isAdmin) return toast('âš ï¸ éœ€è¦ç®¡ç†å“¡æ¬Šé™');
      
      try {
        const result = await callAPI('exportMembers', {});
        document.getElementById('adminActionResult').innerHTML = `
          <div class="alert success">
            âœ… æœƒå“¡è³‡æ–™åŒ¯å‡ºæˆåŠŸ<br>
            <a href="${result.data.fileUrl}" target="_blank" class="inline-link">ğŸ“„ ä¸‹è¼‰æœƒå“¡ CSV æª”æ¡ˆ</a>
          </div>
        `;
        toast('âœ… æœƒå“¡è³‡æ–™åŒ¯å‡ºå®Œæˆ');
      } catch (error) {
        toast('âŒ æœƒå“¡è³‡æ–™åŒ¯å‡ºå¤±æ•—ï¼š' + error.message);
      }
    });

    document.getElementById('btnAdminExportFinance').addEventListener('click', async () => {
      if (!state.isAdmin) return toast('âš ï¸ éœ€è¦ç®¡ç†å“¡æ¬Šé™');
      
      try {
        const result = await callAPI('exportFinanceData', {});
        document.getElementById('adminActionResult').innerHTML = `
          <div class="alert success">
            âœ… è²¡å‹™è³‡æ–™åŒ¯å‡ºæˆåŠŸ<br>
            <a href="${result.data.donationUrl}" target="_blank" class="inline-link">ğŸ“„ ä¸‹è¼‰ææ¬¾ CSV</a> ï½œ 
            <a href="${result.data.expenseUrl}" target="_blank" class="inline-link">ğŸ“„ ä¸‹è¼‰æ”¯å‡º CSV</a>
          </div>
        `;
        toast('âœ… è²¡å‹™è³‡æ–™åŒ¯å‡ºå®Œæˆ');
      } catch (error) {
        toast('âŒ è²¡å‹™è³‡æ–™åŒ¯å‡ºå¤±æ•—ï¼š' + error.message);
      }
    });

    document.getElementById('btnAdminBackup').addEventListener('click', async () => {
      if (!state.isAdmin) return toast('âš ï¸ éœ€è¦ç®¡ç†å“¡æ¬Šé™');
      
      if (!confirm('ç¢ºå®šè¦å»ºç«‹ç³»çµ±å‚™ä»½å—ï¼Ÿæ­¤æ“ä½œå¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“ã€‚')) return;
      
      try {
        const result = await callAPI('backupSystem', {});
        document.getElementById('adminActionResult').innerHTML = `
          <div class="alert success">
            âœ… ç³»çµ±å‚™ä»½å»ºç«‹å®Œæˆ<br>
            <strong>å‚™ä»½åç¨±ï¼š</strong>${escapeHtml(result.data.name)}
          </div>
        `;
        toast('âœ… ç³»çµ±å‚™ä»½å»ºç«‹å®Œæˆ');
      } catch (error) {
        toast('âŒ ç³»çµ±å‚™ä»½å»ºç«‹å¤±æ•—ï¼š' + error.message);
      }
    });

    /**********************
     * å·¥å…·å‡½æ•¸
     **********************/
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str).replace(/[&<>"']/g, s => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[s]);
    }

    function formatDate(d) {
      if (!d) return '';
      try {
        const date = (d instanceof Date) ? d : new Date(d);
        if (isNaN(date.getTime())) return '';
        return date.toLocaleDateString('zh-TW');
      } catch (_) { 
        return ''; 
      }
    }

    function formatDateTime(d) {
      if (!d) return '';
      try {
        const date = (d instanceof Date) ? d : new Date(d);
        if (isNaN(date.getTime())) return '';
        return date.toLocaleString('zh-TW');
      } catch (_) { 
        return ''; 
      }
    }

    /**********************
     * åˆå§‹åŒ–æµç¨‹
     **********************/
    async function initialLoad() {
      setUserStatus();
      await loadCategories();
      await loadActivities();
      
      // å¦‚æœåœ¨ LIFF ç’°å¢ƒä¸­ï¼Œå¯ä»¥é¸æ“‡è‡ªå‹•åˆå§‹åŒ–
      if (window.liff && typeof liff !== 'undefined') {
        // å¯é¸ï¼šè‡ªå‹•åˆå§‹åŒ– LIFF
        // await initLIFF();
      }
      
      toast('ğŸ‰ ç—…å‹æœƒå¹³å°è¼‰å…¥å®Œæˆï¼');
    }

    // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œåˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initialLoad);

  </script>
</body>
</html>
