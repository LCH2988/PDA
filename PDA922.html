<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>活動報名系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css">
  <style>
      .swiper {
          width: 100%;
          padding-top: 50px;
          padding-bottom: 50px;
      }
      .swiper-slide {
          background-position: center;
          background-size: cover;
          width: 300px;
          height: 300px;
      }
      .event-card {
          width: 100%;
          height: 100%;
          background: #fff;
          border-radius: 8px;
          padding: 20px;
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      .page {
          display: none;
      }
      .page.active {
          display: block;
      }
      .loading {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255,255,255,0.8);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }
      .loading.show {
          display: flex;
      }
  </style>
</head>
<body>
  <!-- Loading 指示器 -->
  <div class="loading">
      <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
      </div>
  </div>

  <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
          <a class="navbar-brand" href="#">活動報名系統</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
              <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav">
                  <li class="nav-item">
                      <a class="nav-link active" href="#" data-page="events">活動清單</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="#" data-page="my-events">個人活動</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="#" data-page="profile">個人基本資料</a>
                  </li>
              </ul>
          </div>
          <div class="d-flex">
              <span id="userName" class="navbar-text me-3"></span>
          </div>
      </div>
  </nav>

  <div class="container mt-4">
      <!-- 活動清單頁面 -->
      <div id="eventsPage" class="page active">
          <div id="featuredEvents" class="swiper">
              <div class="swiper-wrapper">
                  <!-- 動態載入活動卡片 -->
              </div>
              <div class="swiper-pagination"></div>
              <div class="swiper-button-next"></div>
              <div class="swiper-button-prev"></div>
          </div>

          <div id="eventsList" class="row mt-4">
              <!-- 動態載入活動列表 -->
          </div>
      </div>

      <!-- 個人活動頁面 -->
      <div id="myEventsPage" class="page">
          <h2>我的活動</h2>
          <div id="myEventsList" class="row mt-4">
              <!-- 動態載入個人活動列表 -->
          </div>
      </div>

      <!-- 個人資料頁面 -->
      <div id="profilePage" class="page">
          <h2>個人基本資料</h2>
          <form id="profileForm" class="mt-4">
              <div class="mb-3">
                  <label for="lineId" class="form-label">LINE ID</label>
                  <input type="text" class="form-control" id="lineId" readonly>
              </div>
              <div class="mb-3">
                  <label for="lineName" class="form-label">LINE 名稱</label>
                  <input type="text" class="form-control" id="lineName" readonly>
              </div>
              <div class="mb-3">
                  <label for="email" class="form-label">電子郵件</label>
                  <input type="email" class="form-control" id="email" required>
              </div>
              <div class="mb-3">
                  <label for="phone" class="form-label">電話</label>
                  <input type="tel" class="form-control" id="phone" required>
              </div>
              <button type="submit" class="btn btn-primary">儲存資料</button>
          </form>
      </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
  // 常數設定
  const LIFF_ID = '2001679903-r5VXNe5g';
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwyqvdvyCELgX_mzcUws0wvdYdqIkGKw7Tfu2V4ZqQ2ZwoQ_MnMKwmj12qXQx8-IIQk/exec';

  // 全域變數
  let userData = null;
  let swiper = null;

  // 顯示載入中
  function showLoading() {
      document.querySelector('.loading').classList.add('show');
  }

  // 隱藏載入中
  function hideLoading() {
      document.querySelector('.loading').classList.remove('show');
  }

  // 初始化 LIFF
  async function initializeLiff() {
      try {
          showLoading();
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) {
              liff.login();
              return;
          }
          
          const profile = await liff.getProfile();
          userData = {
              lineId: profile.userId,
              lineName: profile.displayName
          };
          
          document.getElementById('userName').textContent = userData.lineName;
          
          // 儲存使用者資料到 GAS
          await saveUserData(userData);
          
          // 載入活動資料
          await loadEvents();
          
          // 填充個人資料表單
          fillProfileForm();
          
          hideLoading();
      } catch (err) {
          console.error('LIFF 初始化失敗', err);
          alert('系統初始化失敗，請重新整理頁面');
          hideLoading();
      }
  }

  // 儲存使用者資料
  async function saveUserData(userData) {
      try {
          const response = await fetch(`${GAS_URL}?action=saveUser&lineId=${userData.lineId}&lineName=${userData.lineName}`);
          const data = await response.json();
          if (data.status !== 'success') {
              throw new Error(data.message);
          }
      } catch (err) {
          console.error('儲存使用者資料失敗', err);
          throw err;
      }
  }

  // 載入活動資料
  async function loadEvents() {
      try {
          showLoading();
          const response = await fetch(`${GAS_URL}?action=getEvents`);
          const data = await response.json();
          
          if (data.status === 'success') {
              renderFeaturedEvents(data.data);
              renderEventsList(data.data);
          }
          hideLoading();
      } catch (err) {
          console.error('載入活動資料失敗', err);
          alert('載入活動資料失敗，請重新整理頁面');
          hideLoading();
      }
  }

  // 載入個人活動
  async function loadMyEvents() {
      try {
          showLoading();
          const response = await fetch(`${GAS_URL}?action=getMyEvents&lineId=${userData.lineId}`);
          const data = await response.json();
          
          if (data.status === 'success') {
              renderMyEventsList(data.data);
          }
          hideLoading();
      } catch (err) {
          console.error('載入個人活動失敗', err);
          alert('載入個人活動失敗，請稍後再試');
          hideLoading();
      }
  }

  // 渲染輪播活動卡片
  function renderFeaturedEvents(events) {
      const swiperWrapper = document.querySelector('.swiper-wrapper');
      swiperWrapper.innerHTML = events.map(event => `
          <div class="swiper-slide">
              <div class="event-card">
                  <h5>${event.活動名稱}</h5>
                  <p>日期：${new Date(event.活動日期).toLocaleString()}</p>
                  <p>地點：${event.活動地點}</p>
                  <p>剩餘名額：${event.報名人數上限 - event.目前報名人數}</p>
                  <button class="btn btn-primary" onclick="registerEvent('${event.活動ID}')"
                      ${event.目前報名人數 >= event.報名人數上限 ? 'disabled' : ''}>
                      ${event.目前報名人數 >= event.報名人數上限 ? '已額滿' : '立即報名'}
                  </button>
              </div>
          </div>
      `).join('');

      // 初始化或更新 Swiper
      if (swiper) {
          swiper.update();
      } else {
          swiper = new Swiper('.swiper', {
              effect: 'cards',
              grabCursor: true,
              pagination: {
                  el: '.swiper-pagination',
              },
              navigation: {
                  nextEl: '.swiper-button-next',
                  prevEl: '.swiper-button-prev',
              },
          });
      }
  }

  // 渲染活動列表
  function renderEventsList(events) {
      const eventsList = document.getElementById('eventsList');
      eventsList.innerHTML = events.map(event => `
          <div class="col-md-4 mb-4">
              <div class="card">
                  <div class="card-body">
                      <h5 class="card-title">${event.活動名稱}</h5>
                      <p class="card-text">日期：${new Date(event.活動日期).toLocaleString()}</p>
                      <p class="card-text">地點：${event.活動地點}</p>
                      <p class="card-text">描述：${event.活動描述}</p>
                      <p class="card-text">剩餘名額：${event.報名人數上限 - event.目前報名人數}</p>
                      <button class="btn btn-primary" onclick="registerEvent('${event.活動ID}')"
                          ${event.目前報名人數 >= event.報名人數上限 ? 'disabled' : ''}>
                          ${event.目前報名人數 >= event.報名人數上限 ? '已額滿' : '立即報名'}
                      </button>
                  </div>
              </div>
          </div>
      `).join('');
  }

  // 渲染個人活動列表
  function renderMyEventsList(events) {
      const myEventsList = document.getElementById('myEventsList');
      myEventsList.innerHTML = events.length ? events.map(event => `
          <div class="col-md-4 mb-4">
              <div class="card">
                  <div class="card-body">
                      <h5 class="card-title">${event.活動名稱}</h5>
                      <p class="card-text">日期：${new Date(event.活動日期).toLocaleString()}</p>
                      <p class="card-text">地點：${event.活動地點}</p>
                      <p class="card-text">報名時間：${new Date(event.報名時間).toLocaleString()}</p>
                      <p class="card-text">報名狀態：${event.報名狀態}</p>
                  </div>
              </div>
          </div>
      `).join('') : '<div class="col-12"><p class="text-center">尚未報名任何活動</p></div>';
  }

  // 填充個人資料表單
  function fillProfileForm() {
      document.getElementById('lineId').value = userData.lineId;
      document.getElementById('lineName').value = userData.lineName;
  }

  // 活動報名
  async function registerEvent(eventId) {
      if (!userData) {
          alert('請先登入');
          return;
      }

      try {
          showLoading();
          const response = await fetch(`${GAS_URL}?action=register&eventId=${eventId}&lineId=${userData.lineId}`);
          const data = await response.json();
          
          if (data.status === 'success') {
              alert('報名成功！');
              await loadEvents();
          } else {
              alert(data.message || '報名失敗');
          }
          hideLoading();
      } catch (err) {
          console.error('報名失敗', err);
          alert('報名過程發生錯誤');
          hideLoading();
      }
  }

  // 更新個人資料
  async function updateProfile(formData) {
      try {
          showLoading();
          const response = await fetch(`${GAS_URL}?action=updateProfile&lineId=${userData.lineId}&email=${formData.email}&phone=${formData.phone}`);
          const data = await response.json();
          
          if (data.status === 'success') {
              alert('資料更新成功！');
          } else {
              throw new Error(data.message);
          }
          hideLoading();
      } catch (err) {
          console.error('更新個人資料失敗', err);
          alert('更新個人資料失敗，請稍後再試');
          hideLoading();
      }
  }

  // 頁面切換處理
  document.querySelectorAll('[data-page]').forEach(link => {
      link.addEventListener('click', async (e) => {
          e.preventDefault();
          const page = e.target.dataset.page;
          
          // 移除所有 active class
          document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
          document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
          
          // 添加 active class 到當前項目
          e.target.classList.add('active');
          
          // 切換頁面並載入資料
          switch(page) {
              case 'events':
                  document.getElementById('eventsPage').classList.add('active');
                  await loadEvents();
                  break;
              case 'my-events':
                  document.getElementById('myEventsPage').classList.add('active');
                  await loadMyEvents();
                  break;
              case 'profile':
                  document.getElementById('profilePage').classList.add('active');
                  break;
          }
      });
  });

  // 處理個人資料表單提交
  document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = {
          email: document.getElementById('email').value,
          phone: document.getElementById('phone').value
      };
      await updateProfile(formData);
  });

  // 初始化
  document.addEventListener('DOMContentLoaded', initializeLiff);
  </script>
</body>
</html>
