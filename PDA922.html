<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å°ç£å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒç³»çµ±</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<!-- å¯è‡ªè¡Œæ”¾ç½® favicon -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27><text y=%27.9em%27 font-size=%2790%27>ğŸ§ </text></svg>">

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #4CAF50, #66BB6A);
    --secondary-gradient: linear-gradient(135deg, #2196F3, #42A5F5);
    --success-gradient: linear-gradient(135deg, #8BC34A, #9CCC65);
    --danger-gradient: linear-gradient(135deg, #F44336, #EF5350);
    --warning-gradient: linear-gradient(135deg, #FF9800, #FFB74D);
    --info-gradient: linear-gradient(135deg, #00BCD4, #26C6DA);
    --purple-gradient: linear-gradient(135deg, #9C27B0, #AB47BC);
    --bg-color: #f8f9fa;
    --card-bg: rgba(255,255,255,0.95);
    --text-color: #333;
    --border-color: #e9ecef;
  }

  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  body {
    font-family: 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-color);
    min-height: 100vh;
    margin: 0;
    color: var(--text-color);
    font-size: 16px;
    line-height: 1.6;
  }

  /* ä¸»è¦å®¹å™¨ - APP é¢¨æ ¼ */
  .app-container {
    max-width: 414px;
    margin: 0 auto;
    min-height: 100vh;
    background: white;
    position: relative;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
  }

  /* é ‚éƒ¨æ¨™é¡Œå€ - æ¸›å°‘é«˜åº¦ */
  .main-header {
    background: var(--primary-gradient);
    color: white;
    padding: 10px 15px; /* æ¸›å°‘ä¸Šä¸‹å…§é–“è· */
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .main-header h1 {
    font-size: 18px; /* æ¸›å°å­—é«” */
    font-weight: bold;
    margin: 0;
  }

  .main-header p {
    font-size: 12px; /* æ¸›å°å­—é«” */
    margin: 0;
    opacity: 0.9;
  }

  .user-info-bar {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 6px 12px; /* æ¸›å°‘å…§é–“è· */
    margin-top: 8px;
    display: inline-flex;
    align-items: center;
    gap: 10px;
  }

  .user-avatar {
    width: 28px; /* æ¸›å°é ­åƒ */
    height: 28px; /* æ¸›å°é ­åƒ */
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
  }

  .user-details {
    flex: 1;
    min-width: 0;
  }

  .user-details .fw-bold {
    font-size: 12px;
    margin-bottom: 0;
  }

  .user-details .small {
    font-size: 10px;
    opacity: 0.8;
  }

  /* åº•éƒ¨å°èˆª */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 414px;
    background: white;
    border-top: 1px solid var(--border-color);
    display: flex;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    z-index: 1000;
  }

  .nav-item-bottom {
    flex: 1;
    padding: 8px 4px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    background: none;
    color: #666;
  }

  .nav-item-bottom:hover {
    background-color: rgba(76, 175, 80, 0.1);
    color: var(--primary-color);
  }

  .nav-item-bottom.active {
    background: var(--primary-gradient);
    color: white;
  }

  .nav-icon {
    font-size: 20px;
    margin-bottom: 2px;
    display: block;
  }

  .nav-text {
    font-size: 11px;
    font-weight: 500;
  }

  /* å…§å®¹å€åŸŸ */
  .app-content {
    padding: 20px;
    padding-bottom: 80px;
    min-height: calc(100vh - 120px);
  }

  .content-section {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    backdrop-filter: blur(10px);
  }

  .section-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border-color);
  }

  .section-title {
    font-size: 18px;
    font-weight: bold;
    color: var(--text-color);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* çµ±è¨ˆå¡ç‰‡ç¶²æ ¼ */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: var(--primary-gradient);
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    color: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  }

  .stat-card.success { background: var(--success-gradient); }
  .stat-card.info { background: var(--info-gradient); }
  .stat-card.warning { background: var(--warning-gradient); }
  .stat-card.danger { background: var(--danger-gradient); }
  .stat-card.purple { background: var(--purple-gradient); }

  .stat-card h3 {
    font-size: 28px;
    font-weight: bold;
    margin: 0 0 8px;
  }

  .stat-card p {
    font-size: 14px;
    margin: 0;
    opacity: 0.9;
  }

  /* å¿«é€Ÿæ“ä½œæŒ‰éˆ• */
  .quick-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .quick-btn {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 16px;
    padding: 16px 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text-color);
    text-decoration: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .quick-btn:hover {
    border-color: #4CAF50;
    color: #4CAF50;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    text-decoration: none;
  }

  .quick-btn i {
    font-size: 24px;
  }

  .quick-btn span {
    font-size: 13px;
    font-weight: 600;
  }

  /* æ´»å‹•é …ç›® */
  .activity-item, .transaction-item {
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.3s ease;
    border-left: 4px solid #4CAF50;
  }

  .activity-item:hover, .transaction-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }

  .activity-title {
    font-size: 16px;
    font-weight: bold;
    color: #4CAF50;
    margin-bottom: 6px;
  }

  .activity-info {
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
  }

  .activity-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    font-size: 12px;
    color: #888;
    align-items: center;
  }

  .activity-meta span {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  /* ç‹€æ…‹æ¨™ç±¤ */
  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
    line-height: 1;
  }

  .status-é–‹æ”¾å ±å { background: #E8F5E8; color: #2E7D32; }
  .status-å·²å ±å { background: #E3F2FD; color: #1565C0; }
  .status-å·²å–æ¶ˆ { background: #FFEBEE; color: #C62828; }
  .status-å·²å®Œæˆ { background: #F3E5F5; color: #7B1FA2; }
  .status-å ±åæˆªæ­¢ { background: #FFF3E0; color: #E65100; }
  .status-é€²è¡Œä¸­ { background: #E3F2FD; color: #1976D2; }
  .status-å·²çµæŸ { background: #F5F5F5; color: #424242; }
  .status-å¾…å¯©æ ¸ { background: #FFF3E0; color: #F57C00; }
  .status-å·²æ ¸å‡† { background: #E8F5E8; color: #388E3C; }
  .status-å·²æ‹’çµ• { background: #FFEBEE; color: #D32F2F; }
  .status-æ­£å¸¸ { background: #E8F5E8; color: #2E7D32; }

  /* æŒ‰éˆ•æ¨£å¼ */
  .btn {
    border-radius: 10px;
    font-weight: 600;
    padding: 10px 16px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
  }

  .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .btn-primary {
    background: var(--primary-gradient);
    color: white;
  }

  .btn-secondary {
    background: var(--secondary-gradient);
    color: white;
  }

  .btn-success {
    background: var(--success-gradient);
    color: white;
  }

  .btn-warning {
    background: var(--warning-gradient);
    color: white;
  }

  .btn-danger {
    background: var(--danger-gradient);
    color: white;
  }

  .btn-info {
    background: var(--info-gradient);
    color: white;
  }

  .btn-outline-primary {
    background: transparent;
    border: 2px solid #4CAF50;
    color: #4CAF50;
  }

  .btn-outline-primary:hover {
    background: #4CAF50;
    color: white;
  }

  .btn-sm {
    padding: 6px 12px;
    font-size: 12px;
  }

  /* è¡¨å–®æ¨£å¼ */
  .form-floating {
    margin-bottom: 16px;
  }

  .form-control, .form-select {
    border: 2px solid var(--border-color);
    border-radius: 10px;
    padding: 12px 16px;
    font-size: 14px;
    transition: border-color 0.3s ease;
  }

  .form-control:focus, .form-select:focus {
    border-color: #4CAF50;
    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
  }

  /* é€šçŸ¥ç³»çµ± */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 12px 16px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    transform: translateX(400px);
    transition: transform 0.4s ease;
    z-index: 2000;
    max-width: 320px;
    border-left: 4px solid #4CAF50;
  }

  .notification.show {
    transform: translateX(0);
  }

  .notification.success {
    background: #E8F5E8;
    color: #2E7D32;
    border-left-color: #4CAF50;
  }

  .notification.error {
    background: #FFEBEE;
    color: #C62828;
    border-left-color: #F44336;
  }

  .notification.warning {
    background: #FFF3E0;
    color: #E65100;
    border-left-color: #FF9800;
  }

  /* è¼‰å…¥å‹•ç•« */
  .spinner-border-sm {
    width: 16px;
    height: 16px;
  }

  .loading-container {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px 20px;
    color: #666;
  }

  /* ç©ºç‹€æ…‹ */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #999;
  }

  .empty-state i {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* Modal æ¨£å¼ */
  .modal-content {
    border-radius: 16px;
    border: none;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  }

  .modal-header {
    background: var(--primary-gradient);
    color: white;
    border-radius: 16px 16px 0 0;
    border-bottom: none;
    padding: 16px 20px;
  }

  .modal-title {
    font-weight: bold;
    font-size: 16px;
  }

  .btn-close {
    filter: invert(1);
  }

  .modal-body {
    padding: 20px;
  }

  .modal-footer {
    border-top: 1px solid var(--border-color);
    padding: 16px 20px;
  }

  /* è¡¨æ ¼æ¨£å¼ */
  .table-container {
    max-height: 400px;
    overflow: auto;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    background: white;
  }

  .table th {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    z-index: 1;
    font-size: 12px;
    padding: 8px;
  }

  .table td {
    font-size: 12px;
    padding: 8px;
    vertical-align: middle;
  }

  /* é é¢åˆ‡æ› */
  .page {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
  }

  .page.active {
    display: block;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* ç®¡ç†å“¡å°ˆç”¨ */
  .admin-only {
    display: none;
  }

  /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
  @media (max-width: 480px) {
    .app-container {
      max-width: 100%;
    }
    
    .stats-grid {
      gap: 8px;
    }
    
    .stat-card {
      padding: 16px;
    }
    
    .stat-card h3 {
      font-size: 24px;
    }
    
    .content-section {
      margin: 10px;
      padding: 16px;
    }
    
    .app-content {
      padding: 10px;
      padding-bottom: 80px;
    }
  }

  /* æš—è‰²æ¨¡å¼æ”¯æ´ */
  @media (prefers-color-scheme: dark) {
    :root {
      --bg-color: #121212;
      --card-bg: rgba(30, 30, 30, 0.95);
      --text-color: #e0e0e0;
      --border-color: #333;
    }
    
    body {
      background: var(--bg-color);
      color: var(--text-color);
    }
    
    .app-container {
      background: #1a1a1a;
    }
    
    .content-section {
      background: var(--card-bg);
    }
    
    .activity-item, .transaction-item {
      background: #2a2a2a;
      border-color: #333;
      color: var(--text-color);
    }
    
    .quick-btn {
      background: #2a2a2a;
      border-color: #333;
      color: var(--text-color);
    }
    
    .form-control, .form-select {
      background: #2a2a2a;
      border-color: #333;
      color: var(--text-color);
    }
    
    .table-container {
      background: #2a2a2a;
    }
    
    .table th {
      background: #333;
      color: var(--text-color);
    }
    
    .modal-content {
      background: #2a2a2a;
      color: var(--text-color);
    }
  }

  /* æŒ‰éˆ•è¼‰å…¥ç‹€æ…‹ */
  .btn.loading {
    position: relative;
    color: transparent !important;
  }

  .btn.loading:after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 16px;
    height: 16px;
    margin: -8px;
    border: 2px solid rgba(255,255,255,0.5);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body>
<div class="app-container">
  <!-- é ‚éƒ¨æ¨™é¡Œ - æ¸›å°‘é«˜åº¦ -->
  <div class="main-header">
    <!-- <h1><i class="bi bi-hospital"></i> å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</h1>
    <p>æ•´åˆå¹³å°</p> -->
    <!-- ä½¿ç”¨è€…è³‡è¨Šåªåœ¨ç™»å…¥å¾Œé¡¯ç¤º -->
    <div id="userInfoBar" class="user-info-bar" style="display:none;">
      <div class="user-avatar" id="userAvatar">?</div>
      <div class="user-details">
        <div class="fw-bold" id="userName">è¼‰å…¥ä¸­...</div>
        <div class="small text-muted" id="userRole">æœƒå“¡</div>
      </div>
      <button class="btn btn-sm" onclick="refreshData()" title="åˆ·æ–°" style="background:rgba(255,255,255,0.2);border:none;color:white;">
        <i class="bi bi-arrow-clockwise"></i>
      </button>
    </div>
  </div>

  <div id="notificationContainer"></div>

  <!-- å…§å®¹å€åŸŸ -->
  <div class="app-content">
    <!-- å„€è¡¨æ¿é é¢ -->
    <div id="dashboard" class="page active">
      <!-- çµ±è¨ˆå¡ç‰‡ -->
      <div class="stats-grid">
        <div class="stat-card success" onclick="showPage('activities')">
          <h3 id="totalActivities">0</h3>
          <p>å¯å ±åæ´»å‹•</p>
        </div>
        <div class="stat-card info" onclick="showPage('activities')">
          <h3 id="myRegistrations">0</h3>
          <p>æˆ‘çš„å ±å</p>
        </div>
        <div class="stat-card warning" onclick="showPage('volunteer')">
          <h3 id="myVolunteerHours">0</h3>
          <p>å¿—å·¥æ™‚æ•¸</p>
        </div>
        <div class="stat-card danger" onclick="showPage('finance')">
          <h3 id="myDonationAmount">0</h3>
          <p>ææ¬¾ç¸½é¡</p>
        </div>
      </div>

      <!-- å¿«é€Ÿæ“ä½œ -->
      <div class="content-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-lightning"></i>
            å¿«é€Ÿæ“ä½œ
          </h3>
        </div>
        <div class="quick-actions">
          <div class="quick-btn" onclick="showPage('profile')">
            <i class="bi bi-person-check"></i>
            <span>æ›´æ–°è³‡æ–™</span>
          </div>
          <div class="quick-btn" onclick="showPage('activities')">
            <i class="bi bi-calendar-plus"></i>
            <span>å ±åæ´»å‹•</span>
          </div>
          <div class="quick-btn" onclick="showNewDonationModal()">
            <i class="bi bi-heart-fill"></i>
            <span>æ„›å¿ƒææ¬¾</span>
          </div>
          <div class="quick-btn" onclick="showPage('volunteer')">
            <i class="bi bi-hand-thumbs-up"></i>
            <span>å¿—å·¥æœå‹™</span>
          </div>
        </div>
      </div>

      <!-- æœ€è¿‘æ´»å‹• -->
      <div class="content-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-clock-history"></i>
            æœ€è¿‘æ´»å‹•
          </h3>
          <button class="btn btn-outline-primary btn-sm" onclick="loadDashboard()">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
        <div id="recentActivity">
          <div class="loading-container">
            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
            è¼‰å…¥ä¸­...
          </div>
        </div>
      </div>

      <!-- ç®¡ç†å“¡åŠŸèƒ½ -->
      <div class="content-section admin-only" style="display:none;">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-gear"></i>
            ç³»çµ±ç®¡ç†
          </h3>
        </div>
        <div class="quick-actions">
          <div class="quick-btn" onclick="showNewActivityModal()">
            <i class="bi bi-plus-circle"></i>
            <span>æ–°å¢æ´»å‹•</span>
          </div>
          <div class="quick-btn" onclick="showNewVolunteerNeedModal()">
            <i class="bi bi-person-plus"></i>
            <span>å¿—å·¥éœ€æ±‚</span>
          </div>
          <div class="quick-btn" onclick="showSystemNotificationModal()">
            <i class="bi bi-megaphone"></i>
            <span>ç™¼é€é€šçŸ¥</span>
          </div>
          <div class="quick-btn" onclick="showPage('admin')">
            <i class="bi bi-speedometer2"></i>
            <span>ç®¡ç†é¢æ¿</span>
          </div>
        </div>
      </div>
    </div>

    <!-- å€‹äººè³‡æ–™é é¢ -->
    <div id="profile" class="page">
      <div class="content-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-person"></i>
            å€‹äººè³‡æ–™
          </h3>
        </div>
        
        <div id="registrationSection">
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>è«‹å…ˆå®Œæˆè¨»å†Šã€‚
          </div>
          <form id="registrationForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="realName" name="realName" required>
                <label for="realName">çœŸå¯¦å§“å *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="memberType" name="memberType" required>
                  <option value="">é¸æ“‡</option>
                  <option value="ç—…å‹">ç—…å‹</option>
                  <option value="å®¶å±¬">å®¶å±¬</option>
                  <option value="å¿—å·¥">å¿—å·¥</option>
                  <option value="é†«è­·">é†«è­·äººå“¡</option>
                  <option value="æ”¯æŒè€…">æ”¯æŒè€…</option>
                </select>
                <label for="memberType">æœƒå“¡é¡åˆ¥ *</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-primary" type="submit">
                <i class="bi bi-check-circle me-1"></i>å®Œæˆè¨»å†Š
              </button>
            </div>
          </form>
        </div>

        <div id="profileSection" style="display:none;">
          <form id="profileForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="profileRealName" name="profileRealName" readonly>
                <label for="profileRealName">çœŸå¯¦å§“å</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="lineName" name="lineName" readonly>
                <label for="lineName">LINE åç¨±</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="tel" class="form-control" id="phone" name="phone">
                <label for="phone">è¯çµ¡é›»è©±</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="email" class="form-control" id="email" name="email">
                <label for="email">é›»å­éƒµä»¶</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="date" class="form-control" id="birthday" name="birthday">
                <label for="birthday">ç”Ÿæ—¥</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="profileMemberType" name="profileMemberType">
                  <option value="ç—…å‹">ç—…å‹</option>
                  <option value="å®¶å±¬">å®¶å±¬</option>
                  <option value="å¿—å·¥">å¿—å·¥</option>
                  <option value="é†«è­·">é†«è­·äººå“¡</option>
                  <option value="æ”¯æŒè€…">æ”¯æŒè€…</option>
                </select>
                <label for="profileMemberType">æœƒå“¡é¡åˆ¥</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="address" name="address" style="height:100px;"></textarea>
                <label for="address">é€šè¨Šåœ°å€</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-primary" type="submit">
                <i class="bi bi-save me-1"></i>æ›´æ–°è³‡æ–™
              </button>
            </div>
          </form>
          
          <div class="content-section mt-4">
            <div class="section-header">
              <h3 class="section-title">
                <i class="bi bi-bar-chart"></i>
                å€‹äººçµ±è¨ˆ
              </h3>
            </div>
            <div class="stats-grid" id="profileStats">
              <!-- çµ±è¨ˆæ•¸æ“šå°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ´»å‹•ç®¡ç†é é¢ -->
    <div id="activities" class="page">
      <div class="content-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-calendar-event"></i>
            æ´»å‹•ç®¡ç†
          </h3>
          <div class="admin-only" style="display:none;">
            <button class="btn btn-success btn-sm" onclick="showNewActivityModal()">
              <i class="bi bi-plus-circle me-1"></i>æ–°å¢æ´»å‹•
            </button>
          </div>
        </div>
        
        <!-- ç¯©é¸å™¨ -->
        <div class="row g-2 mb-3">
          <div class="col-6">
            <div class="form-floating">
              <select class="form-select" id="activityStatusFilter">
                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                <option value="é–‹æ”¾å ±å">é–‹æ”¾å ±å</option>
                <option value="å ±åæˆªæ­¢">å ±åæˆªæ­¢</option>
                <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
                <option value="å·²çµæŸ">å·²çµæŸ</option>
              </select>
              <label for="activityStatusFilter">ç‹€æ…‹</label>
            </div>
          </div>
          <div class="col-6">
            <div class="form-floating">
              <input type="date" class="form-control" id="activityDateFilter">
              <label for="activityDateFilter">æ—¥æœŸ</label>
            </div>
          </div>
          <div class="col-8">
            <div class="form-floating">
              <input type="text" class="form-control" id="activitySearchFilter" placeholder="é—œéµå­—">
              <label for="activitySearchFilter">æœå°‹</label>
            </div>
          </div>
          <div class="col-4">
            <button class="btn btn-outline-primary h-100" onclick="filterActivities()">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>
        
        <div id="activitiesList">
          <div class="loading-container">
            <div class="spinner-border spinner-border-sm text-primary me-2"></div>è¼‰å…¥æ´»å‹•...
          </div>
        </div>
      </div>

      <div class="content-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-clipboard-check"></i>
            æˆ‘çš„æ´»å‹•å ±å
          </h3>
        </div>
        <div id="myRegistrations">
          <div class="loading-container">
            <div class="spinner-border spinner-border-sm text-primary me-2"></div>è¼‰å…¥ä¸­...
          </div>
        </div>
      </div>
    </div>

    <!-- å¿—å·¥æœå‹™é é¢ -->
    <div id="volunteer" class="page">
      <div class="content-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-heart"></i>
            å¿—å·¥æœå‹™
          </h3>
          <div class="admin-only" style="display:none;">
            <button class="btn btn-success btn-sm" onclick="showNewVolunteerNeedModal()">
              <i class="bi bi-plus-circle me-1"></i>æ–°å¢å¿—å·¥éœ€æ±‚
            </button>
          </div>
        </div>
        
        <div class="stats-grid mb-4">
          <div class="stat-card info">
            <h3 id="volunteerHours">0</h3>
            <p>æœå‹™æ™‚æ•¸</p>
          </div>
          <div class="stat-card warning">
            <h3 id="volunteerActivities">0</h3>
            <p>åƒèˆ‡æ¬¡æ•¸</p>
          </div>
          <div class="stat-card success">
            <h3 id="volunteerRank">-</h3>
            <p>å¿—å·¥æ’å</p>
          </div>
          <div class="stat-card danger">
            <h3 id="availableNeeds">0</h3>
            <p>å¯å ±åéœ€æ±‚</p>
          </div>
        </div>
        
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-exclamation-circle"></i>
            å¿—å·¥éœ€æ±‚
          </h3>
        </div>
        <div id="volunteerNeeds">
          <div class="loading-container">
            <div class="spinner-border spinner-border-sm text-primary me-2"></div>è¼‰å…¥ä¸­...
          </div>
        </div>
      </div>

      <div class="content-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-journal-text"></i>
            æˆ‘çš„å¿—å·¥è¨˜éŒ„
          </h3>
        </div>
        <div id="myVolunteerRecords">
          <div class="loading-container">
            <div class="spinner-border spinner-border-sm text-primary me-2"></div>è¼‰å…¥ä¸­...
          </div>
        </div>
      </div>
    </div>

    <!-- è²¡å‹™ç®¡ç†é é¢ -->
    <div id="finance" class="page">
      <div class="content-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-cash-coin"></i>
            è²¡å‹™ç®¡ç†
          </h3>
          <div>
            <button class="btn btn-success btn-sm me-2" onclick="showNewDonationModal()">
              <i class="bi bi-heart-fill me-1"></i>ææ¬¾
            </button>
            <button class="btn btn-warning btn-sm" onclick="showNewExpenseModal()">
              <i class="bi bi-receipt me-1"></i>æ”¯å‡ºç”³è«‹
            </button>
          </div>
        </div>
        
        <div class="stats-grid mb-4">
          <div class="stat-card success">
            <h3 id="myDonationAmountDetail">NT$ 0</h3>
            <p>ææ¬¾ç¸½é¡</p>
          </div>
          <div class="stat-card info">
            <h3 id="myDonationCount">0</h3>
            <p>ææ¬¾æ¬¡æ•¸</p>
          </div>
          <div class="stat-card warning">
            <h3 id="myExpenseAmount">NT$ 0</h3>
            <p>æ”¯å‡ºç”³è«‹é¡</p>
          </div>
          <div class="stat-card danger">
            <h3 id="pendingExpenses">0</h3>
            <p>å¾…å¯©æ ¸</p>
          </div>
        </div>
        
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-heart-fill"></i>
            æˆ‘çš„ææ¬¾
          </h3>
        </div>
        <div id="donationHistory">
          <div class="loading-container">
            <div class="spinner-border spinner-border-sm text-primary me-2"></div>è¼‰å…¥ä¸­...
          </div>
        </div>
      </div>

      <div class="content-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-receipt"></i>
            æˆ‘çš„æ”¯å‡ºç”³è«‹
          </h3>
        </div>
        <div id="expenseHistory">
          <div class="loading-container">
            <div class="spinner-border spinner-border-sm text-primary me-2"></div>è¼‰å…¥ä¸­...
          </div>
        </div>
      </div>

      <!-- ç®¡ç†å“¡è²¡å‹™ç¸½è¦½ -->
      <div class="content-section admin-only" style="display:none;">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-graph-up"></i>
            è²¡å‹™ç¸½è¦½ï¼ˆç®¡ç†å“¡ï¼‰
          </h3>
        </div>
        <div class="stats-grid">
          <div class="stat-card success">
            <h3 id="totalIncome">NT$ 0</h3>
            <p>ç¸½æ”¶å…¥</p>
          </div>
          <div class="stat-card danger">
            <h3 id="totalExpense">NT$ 0</h3>
            <p>ç¸½æ”¯å‡º</p>
          </div>
          <div class="stat-card info">
            <h3 id="currentBalance">NT$ 0</h3>
            <p>ç›®å‰é¤˜é¡</p>
          </div>
          <div class="stat-card warning">
            <h3 id="monthlyDonations">NT$ 0</h3>
            <p>æœ¬æœˆææ¬¾</p>
          </div>
        </div>
        <div class="mt-3">
          <button class="btn btn-outline-primary btn-sm" onclick="showNewTransactionModal()">
            <i class="bi bi-plus-circle me-1"></i>æ–°å¢äº¤æ˜“(å¿«é€Ÿ)
          </button>
        </div>
      </div>
    </div>

    <!-- æ´»å‹•å›é¥‹é é¢ -->
    <div id="feedback" class="page">
      <div class="content-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-chat-dots"></i>
            æ´»å‹•å›é¥‹
          </h3>
        </div>
        
        <div class="content-section mb-4">
          <div class="section-header">
            <h3 class="section-title">
              <i class="bi bi-plus-circle"></i>
              æ–°å¢å›é¥‹
            </h3>
          </div>
          <form id="feedbackForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="feedbackActivity" name="feedbackActivity" required>
                  <option value="">è«‹é¸æ“‡æ´»å‹•</option>
                </select>
                <label for="feedbackActivity">æ´»å‹• *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="feedbackRating" name="feedbackRating" required>
                  <option value="">è©•åˆ†</option>
                  <option value="5">5 - éå¸¸æ»¿æ„</option>
                  <option value="4">4 - æ»¿æ„</option>
                  <option value="3">3 - æ™®é€š</option>
                  <option value="2">2 - ä¸æ»¿æ„</option>
                  <option value="1">1 - éå¸¸ä¸æ»¿æ„</option>
                </select>
                <label for="feedbackRating">è©•åˆ† *</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="feedbackComment" name="feedbackComment" style="height:120px;" required></textarea>
                <label for="feedbackComment">æ„è¦‹ / å»ºè­° *</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-primary" type="submit">
                <i class="bi bi-send me-1"></i>æäº¤
              </button>
            </div>
          </form>
        </div>
        
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-chat-left-text"></i>
            æˆ‘çš„å›é¥‹
          </h3>
        </div>
        <div id="myFeedback">
          <div class="loading-container">
            <div class="spinner-border spinner-border-sm text-primary me-2"></div>è¼‰å…¥ä¸­...
          </div>
        </div>
      </div>

      <div class="content-section admin-only" style="display:none;">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-chat-square-dots"></i>
            å…¨éƒ¨å›é¥‹ï¼ˆç®¡ç†å“¡ï¼‰
          </h3>
        </div>
        <div id="allFeedback">
          <div class="loading-container">
            <div class="spinner-border spinner-border-sm text-primary me-2"></div>è¼‰å…¥ä¸­...
          </div>
        </div>
      </div>
    </div>

    <!-- ç³»çµ±ç®¡ç†é é¢ -->
    <div id="admin" class="page">
      <div class="content-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-gear"></i>
            ç³»çµ±ç®¡ç†
          </h3>
        </div>
        
        <!-- ç®¡ç†å“¡å°èˆª -->
        <ul class="nav nav-pills nav-fill mb-4">
          <li class="nav-item">
            <button class="nav-link active btn-sm" data-bs-toggle="tab" data-bs-target="#memberManagement">æœƒå“¡</button>
          </li>
          <li class="nav-item">
            <button class="nav-link btn-sm" data-bs-toggle="tab" data-bs-target="#activityManagement">æ´»å‹•</button>
          </li>
          <li class="nav-item">
            <button class="nav-link btn-sm" data-bs-toggle="tab" data-bs-target="#financeManagement">è²¡å‹™</button>
          </li>
          <li class="nav-item">
            <button class="nav-link btn-sm" data-bs-toggle="tab" data-bs-target="#receiptManagement">æ”¶æ“š</button>
          </li>
          <li class="nav-item">
            <button class="nav-link btn-sm" data-bs-toggle="tab" data-bs-target="#systemSettings">è¨­å®š</button>
          </li>
        </ul>
        
        <div class="tab-content">
          <div class="tab-pane fade show active" id="memberManagement">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">æœƒå“¡åˆ—è¡¨</h5>
              <button class="btn btn-outline-primary btn-sm" onclick="exportMembers()">
                <i class="bi bi-download me-1"></i>åŒ¯å‡º
              </button>
            </div>
            <div class="table-container">
              <table class="table table-hover table-sm align-middle">
                <thead>
                  <tr>
                    <th>å§“å</th><th>é¡åˆ¥</th><th>ç‹€æ…‹</th><th>åŠ å…¥æ—¥æœŸ</th><th>ææ¬¾æ¬¡æ•¸</th><th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="memberList">
                  <tr><td colspan="6" class="text-center text-muted py-4">
                    <div class="spinner-border spinner-border-sm me-2"></div>è¼‰å…¥ä¸­...
                  </td></tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="tab-pane fade" id="activityManagement">
            <div class="d-flex justify-content-between mb-3">
              <h5 class="mb-0">æ´»å‹•åˆ—è¡¨</h5>
              <button class="btn btn-success btn-sm" onclick="showNewActivityModal()">
                <i class="bi bi-plus-circle me-1"></i>æ–°å¢æ´»å‹•
              </button>
            </div>
            <div id="adminActivityList">
              <div class="loading-container">
                <div class="spinner-border spinner-border-sm text-primary me-2"></div>è¼‰å…¥ä¸­...
              </div>
            </div>
          </div>
          
          <div class="tab-pane fade" id="financeManagement">
            <div class="d-flex justify-content-between mb-3">
              <h5 class="mb-0">äº¤æ˜“è¨˜éŒ„</h5>
              <div class="d-flex gap-2">
                <button class="btn btn-success btn-sm" onclick="showNewTransactionModal()">
                  <i class="bi bi-plus-circle me-1"></i>æ–°å¢äº¤æ˜“
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="exportFinanceData()">
                  <i class="bi bi-download me-1"></i>åŒ¯å‡º
                </button>
              </div>
            </div>
            <div class="table-container">
              <table class="table table-sm table-hover align-middle">
                <thead>
                  <tr><th>æ—¥æœŸ</th><th>é¡å‹</th><th>é‡‘é¡</th><th>åˆ†é¡</th><th>èªªæ˜</th><th>ç‹€æ…‹</th></tr>
                </thead>
                <tbody id="transactionList">
                  <tr><td colspan="6" class="text-center text-muted py-4">
                    <div class="spinner-border spinner-border-sm me-2"></div>è¼‰å…¥ä¸­...
                  </td></tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="tab-pane fade" id="receiptManagement">
            <div class="d-flex justify-content-between mb-3">
              <h5 class="mb-0">æ”¶æ“šåˆ—è¡¨</h5>
              <div class="d-flex gap-2">
                <button class="btn btn-info btn-sm" onclick="showReceiptTemplateModal()">
                  <i class="bi bi-file-text me-1"></i>æ¨¡æ¿è¨­å®š
                </button>
                <button class="btn btn-success btn-sm" onclick="showManualReceiptModal()">
                  <i class="bi bi-plus-circle me-1"></i>æ‰‹å‹•é–‹ç«‹
                </button>
              </div>
            </div>
            <div id="receiptList">
              <div class="loading-container">
                <div class="spinner-border spinner-border-sm text-primary me-2"></div>è¼‰å…¥ä¸­...
              </div>
            </div>
          </div>
          
          <div class="tab-pane fade" id="systemSettings">
            <h5 class="mb-3">ç³»çµ±å·¥å…·</h5>
            <div class="d-flex flex-wrap gap-3">
              <button class="btn btn-warning" onclick="backupSystem()">
                <i class="bi bi-database me-1"></i>ç«‹å³å‚™ä»½
              </button>
              <button class="btn btn-info" onclick="showSystemNotificationModal()">
                <i class="bi bi-megaphone me-1"></i>ç™¼é€é€šçŸ¥
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨å°èˆª -->
  <div class="bottom-nav">
    <button class="nav-item-bottom active" onclick="showPage('dashboard')">
      <div class="nav-icon"><i class="bi bi-house-fill"></i></div>
      <div class="nav-text">é¦–é </div>
    </button>
    <button class="nav-item-bottom" onclick="showPage('activities')">
      <div class="nav-icon"><i class="bi bi-calendar-event"></i></div>
      <div class="nav-text">æ´»å‹•</div>
    </button>
    <button class="nav-item-bottom" onclick="showPage('volunteer')">
      <div class="nav-icon"><i class="bi bi-heart"></i></div>
      <div class="nav-text">å¿—å·¥</div>
    </button>
    <button class="nav-item-bottom" onclick="showPage('finance')">
      <div class="nav-icon"><i class="bi bi-cash-coin"></i></div>
      <div class="nav-text">è²¡å‹™</div>
    </button>
    <button class="nav-item-bottom" onclick="showPage('profile')">
      <div class="nav-icon"><i class="bi bi-person"></i></div>
      <div class="nav-text">å€‹äºº</div>
    </button>
  </div>
</div>

<div id="modalContainer"></div>

<script>
  // ========== è¨­å®š ==========
  const CONFIG = {
    LIFF_ID: '1656516134-VaGgmaPm',
    API_BASE_URL: 'https://script.google.com/macros/s/AKfycbyOvCygKg36jgSbbDYkO-xC-ffZOzuMnVLtM4NxDGp-V2FpBMsMxYWLL6bg87mMosY5/exec',
    API_KEY: 'AAbb8520258185202581'
  };

  // ========== å…¨åŸŸç‹€æ…‹ ==========
  let userProfile = null;
  let currentUser = null;
  let isAdmin = false;
  let allActivities = [];
  let cachedAdminData = null;
  let currentPage = 'dashboard';

  // ========== é é¢åˆ‡æ› ==========
  function showPage(pageId) {
    // éš±è—æ‰€æœ‰é é¢
    document.querySelectorAll('.page').forEach(page => {
      page.classList.remove('active');
    });
    
    // é¡¯ç¤ºç›®æ¨™é é¢
    document.getElementById(pageId).classList.add('active');
    
    // æ›´æ–°åº•éƒ¨å°èˆªç‹€æ…‹
    document.querySelectorAll('.nav-item-bottom').forEach(item => {
      item.classList.remove('active');
    });
    
    // æ ¹æ“šé é¢IDæ‰¾åˆ°å°æ‡‰çš„å°èˆªæŒ‰éˆ•
    const navButtons = document.querySelectorAll('.nav-item-bottom');
    const pageMap = {
      'dashboard': 0,
      'activities': 1,
      'volunteer': 2,
      'finance': 3,
      'profile': 4
    };
    
    const navIndex = pageMap[pageId];
    if (navIndex !== undefined && navButtons[navIndex]) {
      navButtons[navIndex].classList.add('active');
    }
    
    currentPage = pageId;
    
    // è¼‰å…¥å°æ‡‰é é¢æ•¸æ“š
    loadPageData(pageId);
  }

  // è¼‰å…¥é é¢æ•¸æ“š
  function loadPageData(pageId) {
    switch (pageId) {
      case 'dashboard':
        loadDashboard();
        break;
      case 'activities':
        loadActivities();
        loadMyRegistrations();
        break;
      case 'volunteer':
        loadVolunteerData();
        break;
      case 'finance':
        loadFinanceData();
        break;
      case 'feedback':
        loadFeedbackData();
        break;
      case 'admin':
        if (isAdmin) loadAdminData();
        break;
    }
  }

  // ========== å·¥å…·å‡½æ•¸ ==========
  const formatDate = d => {
    if(!d) return '-';
    const dt = new Date(d);
    if(isNaN(dt)) return '-';
    return dt.toLocaleDateString('zh-TW');
  };

  const formatDateTime = d => {
    if(!d) return '-';
    const dt = new Date(d);
    if(isNaN(dt)) return '-';
    return dt.toLocaleString('zh-TW');
  };

  const formatCurrency = n =>
    new Intl.NumberFormat('zh-TW',{style:'currency',currency:'TWD',minimumFractionDigits:0}).format(n||0);

  function showNotification(msg, type='success', ms=3000) {
    const wrap = document.getElementById('notificationContainer');
    const el = document.createElement('div');
    el.className = `notification ${type}`;
    el.innerHTML = `
      <div class="d-flex justify-content-between align-items-start">
        <span>${msg}</span>
        <button style="background:none;border:none;font-size:18px;line-height:1;" onclick="this.closest('.notification').remove()">&times;</button>
      </div>`;
    wrap.appendChild(el);
    requestAnimationFrame(() => el.classList.add('show'));
    setTimeout(() => {
      el.classList.remove('show');
      setTimeout(() => el.remove(), 350);
    }, ms);
  }

  function setButtonLoading(btn, loading=true) {
    if(!btn) return;
    if(loading) {
      if(!btn.dataset.originalText) btn.dataset.originalText = btn.innerHTML;
      btn.classList.add('loading');
      btn.disabled = true;
    } else {
      btn.classList.remove('loading');
      btn.disabled = false;
      if(btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText;
    }
  }

  // API èª¿ç”¨
  async function callAPI(action, data={}, retries=2) {
    const payload = {
      action,
      apiKey: CONFIG.API_KEY,
      timestamp: Date.now(),
      ...data
    };
    let lastErr;
    for(let i=0; i<=retries; i++) {
      try {
        const res = await fetch(CONFIG.API_BASE_URL, {
          method:'POST',
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch(e) { throw new Error('å›æ‡‰é JSON: '+text.slice(0,120)); }
        if(!json.success) throw new Error(json.message||'API éŒ¯èª¤');
        return json;
      } catch(err) {
        lastErr = err;
        await new Promise(r => setTimeout(r, 400*(i+1)));
      }
    }
    throw lastErr;
  }

  // ========== LIFF åˆå§‹åŒ– ==========
  async function initializeLiff() {
    try {
      await liff.init({ liffId: CONFIG.LIFF_ID });
      if(!liff.isLoggedIn()) { liff.login(); return; }
      userProfile = await liff.getProfile();
      
      // åªåœ¨ç™»å…¥å¾Œé¡¯ç¤ºç”¨æˆ¶è³‡è¨Šæ¬„
      const bar = document.getElementById('userInfoBar');
      bar.style.display='inline-flex';
      document.getElementById('userName').textContent = userProfile.displayName||'æœƒå“¡';
      document.getElementById('userAvatar').textContent = (userProfile.displayName||'?').charAt(0);

      await loadUserData();
      await loadDashboard();
      showNotification('ç³»çµ±åˆå§‹åŒ–å®Œæˆ','success');
    } catch(err) {
      console.error(err);
      showNotification('LIFF åˆå§‹åŒ–å¤±æ•—','error');
    }
  }

  // ========== ä½¿ç”¨è€…ç›¸é—œ ==========
  async function loadUserData() {
    try {
      const r = await callAPI('getUserInfo', { lineId:userProfile.userId });
      if(r.success && r.data) {
        currentUser = r.data;
        isAdmin = !!currentUser.isAdmin;
        updateUserUI();
      } else {
        showRegistrationForm();
      }
    } catch {
      showRegistrationForm();
    }
  }

  function updateUserUI() {
    if(!currentUser) return;
    document.getElementById('userName').textContent =
      currentUser.realName || currentUser.lineName || userProfile.displayName || 'æœƒå“¡';
    document.getElementById('userRole').textContent = currentUser.memberType || 'æœƒå“¡';
    document.getElementById('userAvatar').textContent =
      (currentUser.realName || currentUser.lineName || userProfile.displayName || '?').charAt(0);
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'block':'none');
    updateProfileSection();
  }

  function showRegistrationForm() {
    document.getElementById('registrationSection').style.display='block';
    document.getElementById('profileSection').style.display='none';
  }

  function updateProfileSection() {
    if(!currentUser) return;
    document.getElementById('registrationSection').style.display='none';
    document.getElementById('profileSection').style.display='block';
    document.getElementById('profileRealName').value = currentUser.realName||'';
    document.getElementById('lineName').value = currentUser.lineName||userProfile.displayName||'';
    document.getElementById('phone').value = currentUser.phone||'';
    document.getElementById('email').value = currentUser.email||'';
    document.getElementById('birthday').value = currentUser.birthday||'';
    document.getElementById('address').value = currentUser.address||'';
    document.getElementById('profileMemberType').value = currentUser.memberType||'';
    document.getElementById('profileStats').innerHTML = `
      <div class="stat-card success">
        <h3>${currentUser.activityCount||0}</h3><p>æ´»å‹•æ¬¡æ•¸</p>
      </div>
      <div class="stat-card warning">
        <h3>${currentUser.volunteerHours||0}</h3><p>å¿—å·¥æ™‚æ•¸</p>
      </div>
      <div class="stat-card danger">
        <h3>${formatCurrency(currentUser.donationAmount||0).replace('NT$','')}</h3><p>ææ¬¾ç¸½é¡</p>
      </div>
      <div class="stat-card info">
        <h3>${currentUser.memberType||'-'}</h3><p>èº«ä»½</p>
      </div>
    `;
  }

  // è¨»å†Šè¡¨å–®è™•ç†
  document.getElementById('registrationForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const btn = e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn, true);
    try {
      await callAPI('registerUser', {
        lineId: userProfile.userId,
        lineName: userProfile.displayName,
        realName: fd.get('realName'),
        memberType: fd.get('memberType')
      });
      showNotification('è¨»å†ŠæˆåŠŸ','success');
      await loadUserData();
    } catch(err) {
      showNotification('è¨»å†Šå¤±æ•—ï¼š'+err.message,'error');
    } finally { 
      setButtonLoading(btn, false); 
    }
  });

  // æ›´æ–°å€‹è³‡è¡¨å–®è™•ç†
  document.getElementById('profileForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const btn = e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn, true);
    try {
      await callAPI('updateProfile', {
        lineId: userProfile.userId,
        phone: fd.get('phone'),
        email: fd.get('email'),
        birthday: fd.get('birthday'),
        memberType: fd.get('profileMemberType'),
        address: fd.get('address')
      });
      showNotification('æ›´æ–°æˆåŠŸ','success');
      await loadUserData();
    } catch(err) {
      showNotification('æ›´æ–°å¤±æ•—ï¼š'+err.message,'error');
    } finally { 
      setButtonLoading(btn, false); 
    }
  });

  // ========== å„€è¡¨æ¿ ==========
  async function loadDashboard() {
    try {
      const r = await callAPI('getDashboardData', { lineId: userProfile?.userId });
      renderDashboardStats(r.data);
      renderRecentActivity(r.data.recentActivity||[]);
    } catch(err) {
      console.error('è¼‰å…¥å„€è¡¨æ¿å¤±æ•—:', err);
    }
  }

  function renderDashboardStats(d) {
    document.getElementById('totalActivities').textContent = d.totalActivities||0;
    document.getElementById('myRegistrations').textContent = d.myRegistrations||0;
    document.getElementById('myVolunteerHours').textContent = d.myVolunteerHours||0;
    document.getElementById('myDonationAmount').textContent = formatCurrency(d.myDonationAmount||0).replace('NT$','');
  }

  function renderRecentActivity(list) {
    const c = document.getElementById('recentActivity');
    if(!list.length) {
      c.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>æš«ç„¡æœ€è¿‘æ´»å‹•</p></div>';
      return;
    }
    c.innerHTML = list.map(a => `
      <div class="activity-item">
        <div class="activity-title">${a.title||''}</div>
        <div class="activity-info">${a.description||''}</div>
        <div class="activity-meta">
          <span><i class="bi bi-calendar"></i>${formatDate(a.date)}</span>
          <span class="status-badge status-${(a.status||'').trim()}">${a.status||''}</span>
        </div>
      </div>
    `).join('');
  }

  // ========== æ´»å‹•ç®¡ç† ==========
  async function loadActivities() {
    try {
      const r = await callAPI('getActivities');
      allActivities = r.data||[];
      renderActivities(allActivities);
    } catch(err) {
      document.getElementById('activitiesList').innerHTML =
        `<div class="empty-state"><i class="bi bi-exclamation-triangle"></i><p>è¼‰å…¥å¤±æ•—ï¼š${err.message}</p></div>`;
    }
  }

  function renderActivities(list) {
    const c = document.getElementById('activitiesList');
    if(!list.length) {
      c.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>ç›®å‰æ²’æœ‰æ´»å‹•</p></div>';
      return;
    }
    c.innerHTML = list.map(a => `
      <div class="activity-item">
        <div class="activity-title">${a.title}</div>
        <div class="activity-info">${a.description||''}</div>
        <div class="activity-meta">
          <span><i class="bi bi-calendar"></i>${formatDate(a.date)}</span>
          <span><i class="bi bi-clock"></i>${a.time||'-'}</span>
          <span><i class="bi bi-geo-alt"></i>${a.location||'-'}</span>
          <span><i class="bi bi-people"></i>${a.currentCount||0}/${a.maxParticipants||0}</span>
          <span class="status-badge status-${a.status}">${a.status}</span>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <span class="fw-bold text-success">${formatCurrency(a.fee||0)}</span>
          ${(a.status==='é–‹æ”¾å ±å')? `<button class="btn btn-primary btn-sm" onclick="registerActivity('${a.id}')"><i class="bi bi-plus-circle me-1"></i>å ±å</button>`:''}
        </div>
      </div>
    `).join('');
  }

  function filterActivities() {
    const s = document.getElementById('activityStatusFilter').value.trim();
    const d = document.getElementById('activityDateFilter').value.trim();
    const kw = document.getElementById('activitySearchFilter').value.trim().toLowerCase();
    let list = [...allActivities];
    if(s) list = list.filter(a => a.status===s);
    if(d) list = list.filter(a => (a.date||'').startsWith(d));
    if(kw) list = list.filter(a => (a.title||'').toLowerCase().includes(kw) ||
                               (a.description||'').toLowerCase().includes(kw) ||
                               (a.location||'').toLowerCase().includes(kw));
    renderActivities(list);
  }

  async function registerActivity(id) {
    if(!currentUser) { showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
    try {
      await callAPI('registerActivity', { lineId: userProfile.userId, activityId: id });
      showNotification('å ±åæˆåŠŸ','success');
      await loadActivities();
      await loadMyRegistrations();
    } catch(err) {
      showNotification('å ±åå¤±æ•—ï¼š'+err.message,'error');
    }
  }

  async function loadMyRegistrations() {
    if(!currentUser) return;
    try {
      const r = await callAPI('getMyRegistrations', { lineId: userProfile.userId });
      renderMyRegistrations(r.data||[]);
    } catch(err) {
      document.getElementById('myRegistrations').innerHTML =
        `<div class="empty-state"><i class="bi bi-exclamation-triangle"></i><p>è¼‰å…¥å¤±æ•—ï¼š${err.message}</p></div>`;
    }
  }

  function renderMyRegistrations(list) {
    const c = document.getElementById('myRegistrations');
    if(!list.length) {
      c.innerHTML='<div class="empty-state"><i class="bi bi-calendar-x"></i><p>å°šç„¡å ±å</p></div>';
      return;
    }
    c.innerHTML = list.map(r => `
      <div class="activity-item">
        <div class="activity-title">${r.activityTitle}</div>
        <div class="activity-meta">
          <span><i class="bi bi-calendar"></i>${formatDateTime(r.registrationTime)}</span>
          <span class="status-badge status-${r.status}">${r.status}</span>
        </div>
        ${(r.status==='å·²å ±å')? `<button class="btn btn-danger btn-sm mt-2" onclick="cancelRegistration('${r.id}')"><i class="bi bi-x-circle me-1"></i>å–æ¶ˆ</button>`:''}
      </div>
    `).join('');
  }

  async function cancelRegistration(regId) {
    if(!confirm('ç¢ºå®šå–æ¶ˆé€™ç­†å ±åï¼Ÿ')) return;
    try {
      await callAPI('cancelRegistration', { lineId: userProfile.userId, registrationId: regId });
      showNotification('å·²å–æ¶ˆ','success');
      await loadMyRegistrations();
      await loadActivities();
    } catch(err) {
      showNotification('å–æ¶ˆå¤±æ•—ï¼š'+err.message,'error');
    }
  }

  // ========== å¿—å·¥æœå‹™ ==========
  async function loadVolunteerData() {
    if(!currentUser) return;
    try {
      const r = await callAPI('getVolunteerData', { lineId: userProfile.userId });
      const s = r.data.stats;
      document.getElementById('volunteerHours').textContent = s.totalHours||0;
      document.getElementById('volunteerActivities').textContent = s.totalActivities||0;
      document.getElementById('volunteerRank').textContent = s.rank||'-';
      document.getElementById('availableNeeds').textContent = s.availableNeeds||0;
      renderVolunteerNeeds(r.data.needs||[]);
      renderVolunteerRecords(r.data.records||[]);
    } catch(err) {
      console.error(err);
    }
  }

  function renderVolunteerNeeds(list) {
    const c = document.getElementById('volunteerNeeds');
    if(!list.length) {
      c.innerHTML='<div class="empty-state"><i class="bi bi-person-x"></i><p>ç„¡å¿—å·¥éœ€æ±‚</p></div>';
      return;
    }
    c.innerHTML = list.map(n => `
      <div class="activity-item">
        <div class="activity-title">${n.title}</div>
        <div class="activity-info">${n.description||''}</div>
        <div class="activity-meta">
          <span><i class="bi bi-calendar"></i>${formatDate(n.date)}</span>
          <span><i class="bi bi-clock"></i>${n.time||'-'}</span>
          <span><i class="bi bi-people"></i>${n.currentCount||0}/${n.needCount}</span>
          <span><i class="bi bi-award"></i>${n.hours} å°æ™‚</span>
          <span class="status-badge status-${n.status}">${n.status}</span>
        </div>
        ${(n.status==='é–‹æ”¾å ±å')? `<button class="btn btn-success btn-sm mt-2" onclick="applyVolunteer('${n.id}')"><i class="bi bi-hand-thumbs-up me-1"></i>å ±å</button>`:''}
      </div>
    `).join('');
  }

  function renderVolunteerRecords(list) {
    const c = document.getElementById('myVolunteerRecords');
    if(!list.length) {
      c.innerHTML='<div class="empty-state"><i class="bi bi-journal-x"></i><p>å°šç„¡è¨˜éŒ„</p></div>';
      return;
    }
    c.innerHTML = list.map(r => `
      <div class="activity-item">
        <div class="activity-title">${r.title}</div>
        <div class="activity-meta">
          <span><i class="bi bi-calendar"></i>${formatDate(r.date)}</span>
          <span><i class="bi bi-clock"></i>${r.hours} å°æ™‚</span>
          <span class="status-badge status-${r.status}">${r.status}</span>
        </div>
      </div>
    `).join('');
  }

  async function applyVolunteer(id) {
    if(!currentUser) { showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
    try {
      await callAPI('applyVolunteer', { lineId: userProfile.userId, needId: id });
      showNotification('å ±åæˆåŠŸ','success');
      await loadVolunteerData();
    } catch(err) {
      showNotification('å ±åå¤±æ•—ï¼š'+err.message,'error');
    }
  }

  // ========== è²¡å‹™ç®¡ç† ==========
  async function loadFinanceData() {
    if(!currentUser) return;
    try {
      const r = await callAPI('getFinanceData', { lineId: userProfile.userId });
      const s = r.data.stats;
      document.getElementById('myDonationAmountDetail').textContent = formatCurrency(s.totalDonation||0).replace('NT$','');
      document.getElementById('myDonationCount').textContent = s.donationCount||0;
      document.getElementById('myExpenseAmount').textContent = formatCurrency(s.totalExpense||0).replace('NT$','');
      document.getElementById('pendingExpenses').textContent = s.pendingExpenses||0;
      renderDonationHistory(r.data.donations||[]);
      renderExpenseHistory(r.data.expenses||[]);
      if(r.data.adminStats && isAdmin) updateAdminFinanceStats(r.data.adminStats);
    } catch(err) { 
      console.error(err); 
    }
  }

  function renderDonationHistory(list) {
    const c = document.getElementById('donationHistory');
    if(!list.length) {
      c.innerHTML = '<div class="empty-state"><i class="bi bi-heart"></i><p>å°šç„¡ææ¬¾</p></div>';
      return;
    }
    c.innerHTML = list.map(d => `
      <div class="transaction-item">
        <div class="activity-title">ææ¬¾ - ${d.category}</div>
        <div class="activity-info">${d.description||''}</div>
        <div class="activity-meta">
          <span><i class="bi bi-calendar"></i>${formatDateTime(d.date)}</span>
          <span class="fw-bold text-success">${formatCurrency(d.amount)}</span>
          <span>æ”¶æ“šï¼š${d.receiptNumber||'è™•ç†ä¸­'}</span>
        </div>
      </div>
    `).join('');
  }

  function renderExpenseHistory(list) {
    const c = document.getElementById('expenseHistory');
    if(!list.length) {
      c.innerHTML = '<div class="empty-state"><i class="bi bi-receipt"></i><p>å°šç„¡æ”¯å‡º</p></div>'; 
      return;
    }
    c.innerHTML = list.map(e => `
      <div class="transaction-item">
        <div class="activity-title">æ”¯å‡º - ${e.category}</div>
        <div class="activity-info">${e.description||''}</div>
        <div class="activity-meta">
          <span><i class="bi bi-calendar"></i>${formatDateTime(e.date)}</span>
          <span class="fw-bold text-danger">${formatCurrency(e.amount)}</span>
          <span class="status-badge status-${e.status}">${e.status}</span>
        </div>
      </div>
    `).join('');
  }

  function updateAdminFinanceStats(s) {
    document.getElementById('totalIncome').textContent = formatCurrency(s.totalIncome);
    document.getElementById('totalExpense').textContent = formatCurrency(s.totalExpense);
    document.getElementById('currentBalance').textContent = formatCurrency(s.currentBalance);
    document.getElementById('monthlyDonations').textContent = formatCurrency(s.monthlyDonations);
  }

  // Modal å‡½æ•¸å€‘ (ä¿æŒåŸæœ‰åŠŸèƒ½)
  function showNewDonationModal() {
    if(!currentUser) { showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
    const html = `
      <div class="modal fade" id="donationModal" tabindex="-1">
        <div class="modal-dialog">
          <form class="modal-content" id="donationForm">
            <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>æ„›å¿ƒææ¬¾</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="form-floating mb-3">
                <select class="form-select" id="donationCategory" name="donationCategory" required>
                  <option value="">é¸æ“‡é¡åˆ¥</option>
                  <option value="ä¸€èˆ¬ææ¬¾">ä¸€èˆ¬ææ¬¾</option>
                  <option value="æ´»å‹•è´ŠåŠ©">æ´»å‹•è´ŠåŠ©</option>
                  <option value="è¨­å‚™è³¼ç½®">è¨­å‚™è³¼ç½®</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <label for="donationCategory">ææ¬¾é¡åˆ¥ *</label>
              </div>
              <div class="form-floating mb-3">
                <input type="number" class="form-control" id="donationAmount" name="donationAmount" min="1" required>
                <label for="donationAmount">é‡‘é¡ *</label>
              </div>
              <div class="form-floating mb-3">
                <textarea class="form-control" id="donationDescription" name="donationDescription" style="height:100px;"></textarea>
                <label for="donationDescription">å‚™è¨»</label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="needReceipt" name="needReceipt" checked>
                <label class="form-check-label" for="needReceipt">éœ€è¦æ”¶æ“š</label>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
              <button class="btn btn-success" type="submit"><i class="bi bi-heart-fill me-1"></i>ç¢ºèª</button>
            </div>
          </form>
        </div>
      </div>`;
    document.getElementById('modalContainer').innerHTML = html;
    const modal = new bootstrap.Modal(document.getElementById('donationModal'));
    modal.show();
    document.getElementById('donationForm').addEventListener('submit', handleDonationSubmit);
  }

  async function handleDonationSubmit(e) {
    e.preventDefault();
    const fd = new FormData(e.target);
    const btn = e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn, true);
    try {
      await callAPI('createDonation', {
        lineId: userProfile.userId,
        category: fd.get('donationCategory'),
        amount: parseInt(fd.get('donationAmount'), 10),
        description: fd.get('donationDescription'),
        needReceipt: fd.get('needReceipt')==='on'
      });
      showNotification('ææ¬¾æˆåŠŸ','success');
      bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
      await loadFinanceData();
    } catch(err) {
      showNotification('ææ¬¾å¤±æ•—ï¼š'+err.message,'error');
    } finally { 
      setButtonLoading(btn, false); 
    }
  }

  // å…¶ä»– Modal å’ŒåŠŸèƒ½å‡½æ•¸ (ä¿æŒåŸæœ‰å¯¦ç¾)
  function showNewExpenseModal() { /* åŸå¯¦ç¾ */ }
  function showNewActivityModal() { /* åŸå¯¦ç¾ */ }
  function showNewVolunteerNeedModal() { /* åŸå¯¦ç¾ */ }
  function showNewTransactionModal() { /* åŸå¯¦ç¾ */ }
  function showManualReceiptModal() { /* åŸå¯¦ç¾ */ }
  function showReceiptTemplateModal() { /* åŸå¯¦ç¾ */ }
  function showSystemNotificationModal() { /* åŸå¯¦ç¾ */ }
  
  // ç®¡ç†å“¡åŠŸèƒ½
  async function loadAdminData() { /* åŸå¯¦ç¾ */ }
  async function loadFeedbackData() { /* åŸå¯¦ç¾ */ }
  async function exportMembers() { /* åŸå¯¦ç¾ */ }
  async function exportFinanceData() { /* åŸå¯¦ç¾ */ }
  async function backupSystem() { /* åŸå¯¦ç¾ */ }
  function viewMemberDetail(lineId) { /* åŸå¯¦ç¾ */ }

  // åˆ·æ–°æ•¸æ“š
  async function refreshData() {
    try {
      await Promise.all([
        loadDashboard(),
        currentPage === 'activities' ? loadActivities() : Promise.resolve(),
        currentPage === 'activities' ? loadMyRegistrations() : Promise.resolve(),
        currentPage === 'volunteer' ? loadVolunteerData() : Promise.resolve(),
        currentPage === 'finance' ? loadFinanceData() : Promise.resolve(),
        currentPage === 'feedback' ? loadFeedbackData() : Promise.resolve(),
        (currentPage === 'admin' && isAdmin) ? loadAdminData() : Promise.resolve()
      ]);
      showNotification('è³‡æ–™å·²åˆ·æ–°','success');
    } catch(err) {
      showNotification('åˆ·æ–°å¤±æ•—ï¼š'+err.message,'error');
    }
  }

  // å…¨åŸŸå‡½æ•¸å°å‡º
  window.showPage = showPage;
  window.refreshData = refreshData;
  window.registerActivity = registerActivity;
  window.cancelRegistration = cancelRegistration;
  window.applyVolunteer = applyVolunteer;
  window.showNewDonationModal = showNewDonationModal;
  window.showNewExpenseModal = showNewExpenseModal;
  window.showNewActivityModal = showNewActivityModal;
  window.showNewVolunteerNeedModal = showNewVolunteerNeedModal;
  window.showNewTransactionModal = showNewTransactionModal;
  window.showManualReceiptModal = showManualReceiptModal;
  window.showReceiptTemplateModal = showReceiptTemplateModal;
  window.showSystemNotificationModal = showSystemNotificationModal;
  window.exportMembers = exportMembers;
  window.exportFinanceData = exportFinanceData;
  window.backupSystem = backupSystem;
  window.viewMemberDetail = viewMemberDetail;
  window.filterActivities = filterActivities;

  // åˆå§‹åŒ–
  window.addEventListener('load', initializeLiff);

  // åº•éƒ¨å°èˆªé»æ“Šäº‹ä»¶
  document.addEventListener('DOMContentLoaded', () => {
    const navButtons = document.querySelectorAll('.nav-item-bottom');
    navButtons.forEach((button, index) => {
      button.addEventListener('click', () => {
        const pages = ['dashboard', 'activities', 'volunteer', 'finance', 'profile'];
        if (pages[index]) {
          showPage(pages[index]);
        }
      });
    });
  });
</script>
</body>
</html>
