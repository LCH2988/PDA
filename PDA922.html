<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>帕金森病友會管理系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes,maximum-scale=3.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🧠</text></svg>'>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg,#667eea,#764ba2);
      --success-gradient: linear-gradient(135deg,#28a745,#20c997);
      --danger-gradient: linear-gradient(135deg,#dc3545,#c82333);
      --warning-gradient: linear-gradient(135deg,#ffc107,#e0a800);
      --info-gradient: linear-gradient(135deg,#17a2b8,#138496);
    }
    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans TC',sans-serif;
      background:var(--primary-gradient);
      min-height:100vh;
      margin:0;
      font-size:18px;
      line-height:1.6;
      color:#222;
    }
    .main-header,.nav-container,.content-card {
      background:rgba(255,255,255,.98);
      backdrop-filter:blur(10px);
      border-radius:20px;
      padding:20px 18px;
      margin:15px 10px;
      box-shadow:0 8px 30px rgba(0,0,0,.12);
    }
    h1,h2,h3,h4,h5 { font-weight:700; }
    h1 { font-size:2.1rem; }
    .nav-pills { justify-content:center; gap:8px; flex-wrap:wrap; }
    .nav-pills .nav-link { font-weight:600; border:3px solid transparent; padding:14px 18px; font-size:1rem; border-radius:15px; }
    .nav-pills .nav-link.active { background:var(--primary-gradient); }
    .user-info-bar { display:flex; flex-direction:column; gap:10px; align-items:center; background:rgba(255,255,255,.95); padding:18px; border-radius:18px; box-shadow:0 4px 16px rgba(0,0,0,.15); margin-top:10px;}
    .user-avatar { width:60px;height:60px;border-radius:50%;background:var(--primary-gradient);color:#fff;font-size:1.4rem;display:flex;align-items:center;justify-content:center;font-weight:700;}
    .stat-card { border-radius:18px; padding:22px 18px; color:#fff; text-align:center; box-shadow:0 6px 20px rgba(0,0,0,.18); }
    .stat-card h3 { margin:0 0 8px; font-size:2rem; font-weight:700; }
    .activity-item,.transaction-item,.receipt-item {
      background:#fff; border-radius:18px; padding:18px 18px; margin-bottom:16px;
      border-left:6px solid #667eea; box-shadow:0 4px 12px rgba(0,0,0,.1); transition:.25s;
    }
    .activity-item:hover,.transaction-item:hover,.receipt-item:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.15); }
    .status-badge { display:inline-block; padding:8px 14px; border-radius:20px; font-size:.85rem; font-weight:700; line-height:1; border:2px solid transparent; }
    .status-開放報名 { background:#c6f6d5;color:#22543d;border-color:#48bb78;}
    .status-已報名 { background:#bee3f8;color:#234e70;border-color:#4299e1;}
    .status-已取消 { background:#fed7d7;color:#742a2a;border-color:#f56565;}
    .status-已完成 { background:#d6bcfa;color:#553c9a;border-color:#9f7aea;}
    .status-報名截止 { background:#feebc8;color:#7b341e;border-color:#ed8936;}
    .status-進行中 { background:#bee3f8;color:#2a69ac;border-color:#4299e1;}
    .status-已結束 { background:#e2e8f0;color:#2d3748;border-color:#a0aec0;}
    .status-已核准 { background:#c6f6d5;color:#22543d;border-color:#48bb78;}
    .status-審核中 { background:#ffeeba;color:#7b5e00;border-color:#ffc107;}
    .status-已拒絕 { background:#fed7d7;color:#742a2a;border-color:#f56565;}
    .notification { position:fixed; top:20px; right:15px; left:15px; background:#fff; padding:18px; border-radius:15px; box-shadow:0 6px 20px rgba(0,0,0,.2); transform:translateY(-120px); transition:.35s; z-index:2000; font-size:1rem; }
    .notification.show { transform:translateY(0); }
    .notification.success { background:#c6f6d5;color:#22543d; border-left:6px solid #48bb78; }
    .notification.error { background:#fed7d7;color:#742a2a; border-left:6px solid #f56565; }
    .notification.warning { background:#feebc8;color:#7b341e; border-left:6px solid #ed8936; }
    .btn.loading { position:relative; color:transparent !important; }
    .btn.loading:after { content:''; position:absolute; top:50%; left:50%; width:22px; height:22px; margin:-11px; border:3px solid rgba(255,255,255,.5); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .table-container { max-height:480px; overflow:auto; border:2px solid #dee2e6; border-radius:16px; background:#fff; }
    .download-btn { background:var(--success-gradient); border:none; color:#fff; padding:8px 16px; border-radius:25px; font-weight:600; }
    .download-btn:hover { opacity:.9; }
    @media (max-width:768px){
      body { font-size:18px; }
      .main-header,.nav-container,.content-card { margin:10px 6px; padding:16px 14px; }
      .activity-item,.transaction-item,.receipt-item { padding:16px; }
      .stat-card h3 { font-size:1.8rem; }
    }
  </style>
</head>
<body>
  <div class="main-header">
    <h1><i class="bi bi-hospital"></i> 帕金森病友會管理系統</h1>
    <p class="text-muted mb-2">整合服務平台</p>
    <div id="userInfoBar" class="user-info-bar" style="display:none;">
      <div class="user-avatar" id="userAvatar">?</div>
      <div class="user-info-text text-center">
        <div class="fw-bold" id="userName">載入中...</div>
          <div class="small text-muted" id="userLineName"></div>
          <div class="small text-muted" id="userRole">會員</div>
      </div>
      <div><button class="btn btn-outline-secondary btn-sm" onclick="refreshData()"><i class="bi bi-arrow-clockwise"></i> 刷新</button></div>
    </div>
  </div>

  <div id="notificationContainer"></div>

  <div class="nav-container">
    <ul class="nav nav-pills">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#dashboard">儀表板</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#profile">個人資料</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#activities">活動</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#volunteer">志工</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#finance">財務</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#feedback">回饋</button></li>
      <li class="nav-item admin-only" style="display:none;"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#admin">管理</button></li>
    </ul>
  </div>

  <div class="tab-content">

    <!-- Dashboard -->
    <div class="tab-pane fade show active" id="dashboard">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>儀表板</h3>
          <button class="btn btn-outline-primary btn-sm" onclick="loadDashboard()"><i class="bi bi-arrow-clockwise"></i> 刷新</button>
        </div>
        <div class="row" id="dashboardStats">
          <div class="col-12">
            <div class="d-flex justify-content-center align-items-center py-4 text-muted">
              <div class="spinner-border text-primary me-2"></div>載入中...
            </div>
          </div>
        </div>
        <div class="mt-3">
          <h5><i class="bi bi-clock-history me-2"></i>最近活動</h5>
          <div id="recentActivity" class="mt-2">
            <div class="d-flex justify-content-center align-items-center py-4 text-muted">
              <div class="spinner-border text-primary me-2"></div>載入中...
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile -->
    <div class="tab-pane fade" id="profile">
      <div class="content-card">
        <h3><i class="bi bi-person me-2"></i>個人資料</h3>

        <div id="registrationSection" class="mt-3">
          <div class="alert alert-info">請完成註冊。</div>
          <form id="registrationForm" class="row g-3">
            <div class="col-12">
              <div class="form-floating">
                <input type="text" class="form-control" id="realName" name="realName" required>
                <label for="realName">真實姓名 *</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <select class="form-select" id="memberType" name="memberType" required>
                  <option value="">選擇</option>
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                  <option value="醫護">醫護人員</option>
                  <option value="支持者">支持者</option>
                </select>
                <label for="memberType">會員類別 *</label>
              </div>
            </div>
            <div class="col-12 d-grid">
              <button class="btn btn-primary btn-lg" type="submit"><i class="bi bi-check-circle me-2"></i>註冊</button>
            </div>
          </form>
        </div>

        <div id="profileSection" style="display:none;">
          <form id="profileForm" class="row g-3 mt-2">
            <div class="col-12"><h5 class="mt-3">基本資料</h5></div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="profileRealName" name="profileRealName" readonly>
                <label for="profileRealName">真實姓名</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="lineName" name="lineName" readonly>
                <label for="lineName">LINE 名稱</label>
              </div>
            </div>
            <div class="col-md-6"><div class="form-floating">
              <input type="tel" class="form-control" id="phone" name="phone"><label for="phone">電話</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <input type="email" class="form-control" id="email" name="email"><label for="email">Email</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <input type="date" class="form-control" id="birthday" name="birthday"><label for="birthday">生日</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <select class="form-select" id="profileMemberType" name="memberType">
                <option value="病友">病友</option><option value="家屬">家屬</option><option value="志工">志工</option><option value="醫護">醫護人員</option><option value="支持者">支持者</option>
              </select><label for="profileMemberType">會員類別</label>
            </div></div>
            <div class="col-12"><div class="form-floating">
              <textarea class="form-control" id="address" name="address" style="height:80px;"></textarea>
              <label for="address">地址</label>
            </div></div>

            <div class="col-12"><h5 class="mt-4">帕金森健康資料（選填）</h5></div>
            <div class="col-md-6"><div class="form-floating">
              <input type="date" class="form-control" id="diagnosisDate" name="diagnosisDate">
              <label for="diagnosisDate">確診日期</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <select class="form-select" id="diseaseStage" name="diseaseStage">          
                <option value="">請選擇</option>
                <option value="第一期">第一期 - 單側症狀</option>
                <option value="第二期">第二期 - 雙側症狀</option>
                <option value="第三期">第三期 - 平衡問題</option>
                <option value="第四期">第四期 - 嚴重失能</option>
                <option value="第五期">第五期 - 輪椅或臥床</option>
              </select>
              <label for="diseaseStage">疾病分期</label>
            </div></div>
            <div class="col-12"><div class="form-floating">
              <textarea class="form-control" id="medications" name="medications" style="height:70px;"></textarea>
              <label for="medications">目前用藥</label>
            </div></div>
            <div class="col-12"><div class="form-floating">
              <textarea class="form-control" id="symptoms" name="symptoms" style="height:70px;"></textarea>
              <label for="symptoms">主要症狀</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <select class="form-select" id="mobility" name="mobility">
                <option value="">選擇</option>
                <option value="正常行走">正常行走</option>
                <option value="需助行器">需助行器</option>
                <option value="需輪椅">需輪椅</option>
                <option value="臥床">臥床</option>
              </select>
              <label for="mobility">行動能力</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <input class="form-control" id="caregiverName" name="caregiverName">
              <label for="caregiverName">照護者姓名</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <input class="form-control" id="caregiverPhone" name="caregiverPhone">
              <label for="caregiverPhone">照護者電話</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <input class="form-control" id="emergencyContact" name="emergencyContact">
              <label for="emergencyContact">緊急聯絡人</label>
            </div></div>
            <div class="col-12"><div class="form-floating">
              <textarea class="form-control" id="medicalHistory" name="medicalHistory" style="height:70px;"></textarea>
              <label for="medicalHistory">病史</label>
            </div></div>
            <div class="col-12"><div class="form-floating">
              <textarea class="form-control" id="notes" name="notes" style="height:70px;"></textarea>
              <label for="notes">備註</label>
            </div></div>

            <div class="col-12 d-grid">
              <button class="btn btn-primary btn-lg" type="submit"><i class="bi bi-save me-2"></i>更新</button>
            </div>
          </form>

          <div class="mt-4">
            <h5><i class="bi bi-receipt me-2"></i>我的收據</h5>
            <div id="myReceipts" class="mt-2">
              <div class="py-4 text-center text-muted">
                <div class="spinner-border me-2"></div>載入中...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Activities -->
    <div class="tab-pane fade" id="activities">
      <div class="content-card">
        <div class="d-flex justify-content-between mb-3">
          <h3 class="mb-0"><i class="bi bi-calendar-event me-2"></i>活動</h3>
          <div class="admin-only" style="display:none;">
            <button class="btn btn-success btn-sm" onclick="showNewActivityModal()"><i class="bi bi-plus-circle me-1"></i>新增</button>
          </div>
        </div>
        <div class="row g-2 mb-3">
          <div class="col-6">
            <select class="form-select" id="activityStatusFilter">
              <option value="">全部狀態</option>
              <option value="開放報名">開放報名</option>
              <option value="報名截止">報名截止</option>
              <option value="進行中">進行中</option>
              <option value="已結束">已結束</option>
            </select>
          </div>
          <div class="col-6">
            <input type="date" class="form-control" id="activityDateFilter">
          </div>
          <div class="col-12">
            <input type="text" class="form-control" id="activitySearchFilter" placeholder="關鍵字">
          </div>
          <div class="col-12 d-grid">
            <button class="btn btn-outline-primary" onclick="filterActivities()"><i class="bi bi-search me-1"></i> 查詢</button>
          </div>
        </div>
        <div id="activitiesList"></div>
        <div class="mt-4">
          <h5><i class="bi bi-clipboard-check me-2"></i>我的報名</h5>
          <div id="myRegistrations" class="mt-2">
            <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>載入中...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Volunteer -->
    <div class="tab-pane fade" id="volunteer">
      <div class="content-card">
        <div class="d-flex justify-content-between mb-3">
          <h3 class="mb-0"><i class="bi bi-heart me-2"></i>志工</h3>
          <div class="admin-only" style="display:none;">
            <button class="btn btn-success btn-sm" onclick="showNewVolunteerNeedModal()"><i class="bi bi-plus-circle me-1"></i>新增需求</button>
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-6"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="volunteerHours">0</h3><p class="mb-0">服務時數</p></div></div>
          <div class="col-6"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="volunteerActivities">0</h3><p class="mb-0">參與次數</p></div></div>
          <div class="col-6"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="volunteerRank">-</h3><p class="mb-0">排名</p></div></div>
          <div class="col-6"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="availableNeeds">0</h3><p class="mb-0">可報名</p></div></div>
        </div>
        <h5>志工需求</h5>
        <div id="volunteerNeeds" class="mt-2">
          <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>載入中...</div>
        </div>
        <div class="mt-4">
          <h5><i class="bi bi-journal-text me-2"></i>我的志工記錄</h5>
          <div id="myVolunteerRecords" class="mt-2">
            <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>載入中...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Finance -->
    <div class="tab-pane fade" id="finance">
      <div class="content-card">
        <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
          <h3 class="mb-0"><i class="bi bi-cash-coin me-2"></i>財務</h3>
          <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" onclick="showNewDonationModal()"><i class="bi bi-heart-fill me-1"></i>捐款</button>
            <button class="btn btn-warning btn-sm" onclick="showNewExpenseModal()"><i class="bi bi-receipt me-1"></i>支出申請</button>
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-6"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="myDonationAmount">0</h3><p class="mb-0">捐款總額</p></div></div>
          <div class="col-6"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="myDonationCount">0</h3><p class="mb-0">捐款次數</p></div></div>
          <div class="col-6"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="myExpenseAmount">0</h3><p class="mb-0">支出金額</p></div></div>
          <div class="col-6"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="pendingExpenses">0</h3><p class="mb-0">待審核</p></div></div>
        </div>
        <h5><i class="bi bi-heart-fill me-2"></i>捐款紀錄</h5>
        <div id="donationHistory" class="mt-2">
          <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>載入中...</div>
        </div>
        <div class="mt-4">
          <h5><i class="bi bi-receipt me-2"></i>支出申請紀錄</h5>
          <div id="expenseHistory" class="mt-2">
            <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>載入中...</div>
          </div>
        </div>
        <div class="admin-only mt-4" style="display:none;">
          <h5><i class="bi bi-graph-up me-2"></i>總覽</h5>
          <div class="row g-3">
            <div class="col-6"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="totalIncome">0</h3><p class="mb-0">總收入</p></div></div>
            <div class="col-6"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="totalExpense">0</h3><p class="mb-0">總支出</p></div></div>
            <div class="col-6"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="currentBalance">0</h3><p class="mb-0">餘額</p></div></div>
            <div class="col-6"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="monthlyDonations">0</h3><p class="mb-0">本月捐款</p></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Feedback -->
    <div class="tab-pane fade" id="feedback">
      <div class="content-card">
        <h3><i class="bi bi-chat-dots me-2"></i>活動回饋</h3>
        <form id="feedbackForm" class="row g-3 mt-2">
          <div class="col-md-6">
            <div class="form-floating">
              <select class="form-select" id="feedbackActivity" required>
                <option value="">選擇活動</option>
              </select>
              <label for="feedbackActivity">活動 *</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <select class="form-select" id="feedbackRating" required>
                <option value="">評分</option>
                <option value="5">5 - 非常滿意</option>
                <option value="4">4 - 滿意</option>
                <option value="3">3 - 普通</option>
                <option value="2">2 - 不滿意</option>
                <option value="1">1 - 非常不滿意</option>
              </select>
              <label for="feedbackRating">評分 *</label>
            </div>
          </div>
          <div class="col-12">
            <div class="form-floating">
              <textarea class="form-control" id="feedbackComment" style="height:100px;" required></textarea>
              <label for="feedbackComment">意見 / 建議 *</label>
            </div>
          </div>
          <div class="col-12 d-grid">
            <button class="btn btn-primary btn-lg" type="submit"><i class="bi bi-send me-2"></i>提交</button>
          </div>
        </form>
        <div class="mt-4">
          <h5><i class="bi bi-chat-left-text me-2"></i>我的回饋</h5>
          <div id="myFeedback" class="mt-2">
            <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>載入中...</div>
          </div>
        </div>
          <div class="admin-only mt-4" style="display:none;">
            <h5><i class="bi bi-chat-square-dots me-2"></i>全部回饋</h5>
            <div id="allFeedback" class="mt-2">
              <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>載入中...</div>
            </div>
          </div>
      </div>
    </div>

    <!-- Admin -->
    <div class="tab-pane fade" id="admin">
      <div class="content-card">
        <h3><i class="bi bi-gear me-2"></i>管理</h3>
        <ul class="nav nav-tabs mb-3">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#memberManagement">會員</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#activityManagement">活動</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#financeManagement">財務</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#incomeVerification">收入確認</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#expenseApproval">支出審核</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#receiptManagement">收據</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#systemSettings">設定</button></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="memberManagement">
            <div class="d-flex justify-content-between mb-2">
              <h5 class="mb-0">會員列表</h5>
              <button class="btn btn-outline-primary btn-sm" onclick="exportMembers()"><i class="bi bi-download me-1"></i>匯出</button>
            </div>
            <div class="table-container">
              <table class="table table-hover align-middle mb-0">
                <thead>
                  <tr><th>姓名</th><th>類別</th><th>狀態</th><th>加入</th><th>捐款次數</th><th></th></tr>
                </thead>
                <tbody id="memberList">
                  <tr><td colspan="6" class="text-center text-muted py-4"><div class="spinner-border me-2"></div>載入中...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade" id="activityManagement">
            <div class="d-flex justify-content-between mb-2">
              <h5 class="mb-0">活動列表</h5>
              <button class="btn btn-success btn-sm" onclick="showNewActivityModal()"><i class="bi bi-plus-circle me-1"></i>新增</button>
            </div>
            <div id="adminActivityList" class="mt-2">
              <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>載入中...</div>
            </div>
          </div>
          <div class="tab-pane fade" id="financeManagement">
            <div class="d-flex justify-content-between mb-2 flex-wrap gap-2">
              <h5 class="mb-0">交易記錄</h5>
              <div class="d-flex gap-2">
                <button class="btn btn-success btn-sm" onclick="showNewTransactionModal()"><i class="bi bi-plus-circle me-1"></i>新增交易</button>
                <button class="btn btn-outline-primary btn-sm" onclick="exportFinanceData()"><i class="bi bi-download me-1"></i>匯出</button>
              </div>
            </div>
            <div class="table-container">
              <table class="table table-hover mb-0">
                <thead>
                  <tr><th>日期</th><th>類型</th><th>金額</th><th>分類</th><th>說明</th><th>狀態</th></tr>
                </thead>
                <tbody id="transactionList">
                  <tr><td colspan="6" class="text-center text-muted py-4"><div class="spinner-border me-2"></div>載入中...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade" id="incomeVerification">
            <div class="d-flex justify-content-between mb-2">
              <h5 class="mb-0">收入確認</h5>
              <button class="btn btn-outline-primary btn-sm" onclick="loadIncomeVerification()"><i class="bi bi-arrow-clockwise me-1"></i>刷新</button>
            </div>
            <div id="incomeVerificationList">
              <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>載入中...</div>
            </div>
          </div>
          <div class="tab-pane fade" id="expenseApproval">
            <div class="d-flex justify-content-between mb-2">
              <h5 class="mb-0">支出審核</h5>
              <button class="btn btn-outline-primary btn-sm" onclick="loadExpenseApproval()"><i class="bi bi-arrow-clockwise me-1"></i>刷新</button>
            </div>
            <div id="expenseApprovalList">
              <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>載入中...</div>
            </div>
          </div>
          <div class="tab-pane fade" id="receiptManagement">
            <div class="d-flex justify-content-between mb-2 flex-wrap gap-2">
              <h5 class="mb-0">收據列表</h5>
              <div class="d-flex gap-2">
                <button class="btn btn-success btn-sm" onclick="showManualReceiptModal()"><i class="bi bi-plus-circle me-1"></i>手動開立</button>
              </div>
            </div>
            <div id="receiptList" class="mt-2">
              <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>載入中...</div>
            </div>
          </div>
          <div class="tab-pane fade" id="systemSettings">
            <h5>系統工具</h5>
            <div class="d-grid gap-2 mt-2 mb-4">
              <button class="btn btn-warning" onclick="backupSystem()"><i class="bi bi-database me-2"></i>立即備份</button>
              <button class="btn btn-info" onclick="showSystemNotificationModal()"><i class="bi bi-megaphone me-2"></i>發送通知</button>
            </div>

            <!-- 新增：系統設定表單 -->
            <div class="mt-3">
              <h6><i class="bi bi-sliders me-2"></i>系統設定</h6>
              <form id="settingsForm" class="row g-3">
                <div class="col-12">
                  <div class="form-floating">
                    <input class="form-control" id="receiptTemplateDocId" placeholder="收據模版文件ID">
                    <label for="receiptTemplateDocId">收據 Google 文件模版 ID</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-floating">
                    <textarea class="form-control" id="emailReplyTemplate" style="height:120px;" placeholder="信件回覆模版"></textarea>
                    <label for="emailReplyTemplate">信件回覆模版</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <textarea class="form-control" id="incomeCategories" style="height:160px;" placeholder="每行一個收入類別"></textarea>
                    <label for="incomeCategories">收入類別設定 (每行一個)</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <textarea class="form-control" id="expenseCategoriesSetting" style="height:160px;" placeholder="每行一個支出類別"></textarea>
                    <label for="expenseCategoriesSetting">支出類別設定 (每行一個)</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-floating">
                    <input class="form-control" id="expenseVoucherTemplateDocId" placeholder="支出憑證模版文件ID">
                    <label for="expenseVoucherTemplateDocId">支出憑證 Google 文件模版 ID</label>
                  </div>
                </div>
                <div class="col-12 d-flex gap-2">
                  <button type="button" class="btn btn-outline-primary" onclick="loadSettings()"><i class="bi bi-arrow-clockwise me-1"></i>載入設定</button>
                  <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>儲存設定</button>
                </div>
              </form>
            </div>
            <!-- 系統設定表單結束 -->

          </div>
        </div>
      </div>
    </div>

  </div><!-- tab-content -->

  <div id="modalContainer"></div>

  <script>
    // ========== 前端設定 ==========
    const CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycbxK8hPwHXw43uO1bZdHxt9O-zsz6TMn_x0cEmb06Uy2knWwqoQzVaRklZaQFlFtB70OIQ/exec', // 部署後可替換
      API_KEY: 'AAbb8520258185202581'
    };

    // ========== 全域狀態 ==========
    let userProfile=null;
    let currentUser=null;
    let isAdmin=false;
    let allActivities=[];
    let cachedAdminData=null;
    let sysSettings = { incomeCategories:[], expenseCategories:[] }; // 新增設定緩存

    // ========== 工具 ==========
    const formatDate = d=>{ if(!d)return '-'; const dt=new Date(d); return isNaN(dt)?'-':dt.toLocaleDateString('zh-TW'); };
    const formatDateTime = d=>{ if(!d)return '-'; const dt=new Date(d); return isNaN(dt)?'-':dt.toLocaleString('zh-TW'); };
    const formatCurrency = n=> 'NT$ '+(Number(n||0)).toLocaleString('zh-TW');
    function showNotification(msg,type='success',ms=3000){
      const wrap=document.getElementById('notificationContainer');
      const el=document.createElement('div');
      el.className=`notification ${type}`;
      el.innerHTML=`<div class="d-flex justify-content-between align-items-start">
        <span>${msg}</span><button style="background:none;border:none;font-size:20px;line-height:1;" onclick="this.closest('.notification').remove()">×</button>
      </div>`;
      wrap.appendChild(el); requestAnimationFrame(()=>el.classList.add('show'));
      setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),300); },ms);
    }
    function setButtonLoading(btn,loading=true){
      if(!btn) return;
      if(loading){ if(!btn.dataset.originalText) btn.dataset.originalText=btn.innerHTML; btn.classList.add('loading'); btn.disabled=true; }
      else { btn.classList.remove('loading'); btn.disabled=false; if(btn.dataset.originalText) btn.innerHTML=btn.dataset.originalText; }
    }
    async function callAPI(action,data={},retries=2){
      const payload={ action, apiKey:CONFIG.API_KEY, ...data };
      let lastErr;
      for(let i=0;i<=retries;i++){
        try{
          const res=await fetch(CONFIG.API_BASE_URL,{ method:'POST', body:JSON.stringify(payload) });
          const text=await res.text();
          let json; try{ json=JSON.parse(text);}catch(e){ throw new Error('回應非 JSON: '+text.slice(0,120)); }
          if(!json.success) throw new Error(json.message||'API 錯誤');
          return json;
        }catch(err){ lastErr=err; await new Promise(r=>setTimeout(r,400*(i+1))); }
      }
      throw lastErr;
    }

    // ========== LIFF 初始化 ==========
    async function initializeLiff(){
      try{
        await liff.init({ liffId:CONFIG.LIFF_ID });
        if(!liff.isLoggedIn()){ liff.login(); return; }
        userProfile=await liff.getProfile();
        document.getElementById('userInfoBar').style.display='flex';
        document.getElementById('userLineName').textContent='LINE：'+(userProfile.displayName||'');
        document.getElementById('userName').textContent=userProfile.displayName||'會員';
        document.getElementById('userAvatar').textContent=(userProfile.displayName||'?').charAt(0);
        await loadUserData();
        await loadDashboard();
      }catch(e){
        console.error(e); showNotification('LIFF 初始化失敗','error',4000);
      }
    }

    // ========== 使用者 ==========
    async function loadUserData(){
      try{
        const r=await callAPI('getUserInfo',{ lineId:userProfile.userId });
        if(r.success && r.data){
          currentUser=r.data;
          isAdmin=!!currentUser.isAdmin;
          updateUserUI();
        }else showRegistrationForm();
      }catch{ showRegistrationForm(); }
    }
    function updateUserUI(){
      if(!currentUser) return;
      document.getElementById('userName').textContent=currentUser.realName||currentUser.lineName||userProfile.displayName||'會員';
      document.getElementById('userRole').textContent=currentUser.memberType||'會員';
      document.getElementById('userAvatar').textContent=(currentUser.realName||currentUser.lineName||userProfile.displayName||'?').charAt(0);
      document.querySelectorAll('.admin-only').forEach(el=> el.style.display=isAdmin?'block':'none');
      updateProfileSection();
    }
    function showRegistrationForm(){
      document.getElementById('registrationSection').style.display='block';
      document.getElementById('profileSection').style.display='none';
    }
    function updateProfileSection(){
      if(!currentUser) return;
      document.getElementById('registrationSection').style.display='none';
      document.getElementById('profileSection').style.display='block';
      // 基本
      document.getElementById('profileRealName').value=currentUser.realName||'';
      document.getElementById('lineName').value=currentUser.lineName||userProfile.displayName||'';
      document.getElementById('phone').value=currentUser.phone||'';
      document.getElementById('email').value=currentUser.email||'';
      document.getElementById('birthday').value=currentUser.birthday||'';
      document.getElementById('profileMemberType').value=currentUser.memberType||'病友';
      document.getElementById('address').value=currentUser.address||'';
      // 健康
      const fields=['diagnosisDate','diseaseStage','medications','symptoms','mobility','caregiverName','caregiverPhone','emergencyContact','medicalHistory','notes'];
      fields.forEach(f=>{ if(document.getElementById(f)) document.getElementById(f).value=currentUser[f]||''; });
      loadMyReceipts();
    }

    // 註冊
    document.getElementById('registrationForm').addEventListener('submit',async e=>{
      e.preventDefault();
      const fd=new FormData(e.target); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('registerUser',{
          lineId:userProfile.userId,
          lineName:userProfile.displayName,
          realName:fd.get('realName'),
          memberType:fd.get('memberType')
        });
        showNotification('註冊成功','success'); await loadUserData();
      }catch(err){ showNotification('註冊失敗：'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    });

    // 更新個資
    document.getElementById('profileForm').addEventListener('submit',async e=>{
      e.preventDefault();
      const fd=new FormData(e.target); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('updateProfile',{
          lineId:userProfile.userId,
          phone:fd.get('phone'), email:fd.get('email'), birthday:fd.get('birthday'),
          memberType:fd.get('memberType'), address:fd.get('address'),
          diagnosisDate:fd.get('diagnosisDate'), diseaseStage:fd.get('diseaseStage'),
          medications:fd.get('medications'), symptoms:fd.get('symptoms'),
          mobility:fd.get('mobility'), caregiverName:fd.get('caregiverName'),
          caregiverPhone:fd.get('caregiverPhone'), emergencyContact:fd.get('emergencyContact'),
          medicalHistory:fd.get('medicalHistory'), notes:fd.get('notes')
        });
        showNotification('更新成功','success');
        await loadUserData();
      }catch(err){ showNotification('更新失敗：'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    });

    // ========== 儀表板 ==========
    async function loadDashboard(){
      try{
        const r=await callAPI('getDashboardData',{ lineId:userProfile?.userId });
        renderDashboardStats(r.data); renderRecentActivity(r.data.recentActivity||[]);
      }catch(err){
        document.getElementById('dashboardStats').innerHTML=`<div class="col-12 text-danger text-center py-3">載入失敗：${err.message}</div>`;
      }
    }
    function renderDashboardStats(d){
      document.getElementById('dashboardStats').innerHTML=`
        <div class="col-6"><div class="stat-card" style="background:var(--success-gradient);"><h3>${d.totalActivities||0}</h3><p class="mb-0">可報名活動</p></div></div>
        <div class="col-6"><div class="stat-card" style="background:var(--info-gradient);"><h3>${d.myRegistrations||0}</h3><p class="mb-0">我的報名</p></div></div>
        <div class="col-6"><div class="stat-card" style="background:var(--warning-gradient);"><h3>${d.myVolunteerHours||0}</h3><p class="mb-0">志工時數</p></div></div>
        <div class="col-6"><div class="stat-card" style="background:var(--danger-gradient);"><h3>${(d.myDonationAmount||0).toLocaleString()}</h3><p class="mb-0">捐款總額</p></div></div>`;
    }
    function renderRecentActivity(list){
      const c=document.getElementById('recentActivity');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">無資料</p>'; return;}
      c.innerHTML=list.map(a=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div class="flex-grow-1">
              <strong>${a.title}</strong>
              <div class="text-muted small mt-1">${a.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(a.date)}</small>
            </div>
            <span class="status-badge status-${a.status||''}">${a.status||''}</span>
          </div>
        </div>`).join('');
    }

    // ========== 活動 ==========
    async function loadActivities(){
      try{
        const r=await callAPI('getActivities');
        allActivities=r.data||[];
        renderActivities(allActivities);
      }catch(err){
        document.getElementById('activitiesList').innerHTML=`<div class="text-danger text-center py-3">載入失敗：${err.message}</div>`;
      }
    }
    function renderActivities(list){
      const c=document.getElementById('activitiesList');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">尚無活動</p>'; return; }
      c.innerHTML=list.map(a=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between align-items-start flex-wrap">
            <div class="flex-grow-1">
              <strong>${a.title}</strong>
              <div class="small text-muted mt-1">${a.description||''}</div>
              <div class="row g-1 small mt-1">
                <div class="col-6"><i class="bi bi-calendar me-1"></i>${formatDate(a.date)}</div>
                <div class="col-6"><i class="bi bi-clock me-1"></i>${a.time||'-'}</div>
                <div class="col-6"><i class="bi bi-geo-alt me-1"></i>${a.location||'-'}</div>
                <div class="col-6"><i class="bi bi-people me-1"></i>${a.currentCount||0}/${a.maxParticipants||0}</div>
              </div>
            </div>
            <div class="text-end">
              <span class="status-badge status-${a.status}">${a.status}</span>
              <div class="fw-bold text-primary mt-2">${formatCurrency(a.fee||0)}</div>
              ${(a.status==='開放報名')? `<button class="btn btn-primary btn-sm mt-2" onclick="registerActivity('${a.id}')"><i class="bi bi-plus-circle me-1"></i>報名</button>`:''}
            </div>
          </div>
        </div>`).join('');
    }
    function filterActivities(){
      const s=document.getElementById('activityStatusFilter').value.trim();
      const d=document.getElementById('activityDateFilter').value.trim();
      const kw=document.getElementById('activitySearchFilter').value.trim().toLowerCase();
      let list=[...allActivities];
      if(s) list=list.filter(a=>a.status===s);
      if(d) list=list.filter(a=>(a.date||'').startsWith(d));
      if(kw) list=list.filter(a=>(a.title||'').toLowerCase().includes(kw)||(a.description||'').toLowerCase().includes(kw)||(a.location||'').toLowerCase().includes(kw));
      renderActivities(list);
    }
    async function registerActivity(id){
      if(!currentUser){ showNotification('請先註冊','warning'); return; }
      try{
        await callAPI('registerActivity',{ lineId:userProfile.userId, activityId:id });
        showNotification('報名成功','success'); await loadActivities(); await loadMyRegistrations();
      }catch(err){ showNotification('報名失敗：'+err.message,'error'); }
    }
    async function loadMyRegistrations(){
      if(!currentUser) return;
      try{
        const r=await callAPI('getMyRegistrations',{ lineId:userProfile.userId });
        renderMyRegistrations(r.data||[]);
      }catch(err){
        document.getElementById('myRegistrations').innerHTML=`<div class="text-danger text-center py-2">載入失敗：${err.message}</div>`;
      }
    }
    function renderMyRegistrations(list){
      const c=document.getElementById('myRegistrations');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">無報名</p>'; return; }
      c.innerHTML=list.map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div class="flex-grow-1">
              <strong>${r.activityTitle}</strong>
              <div class="small text-muted mt-1"><i class="bi bi-clock me-1"></i>${formatDateTime(r.registrationTime)}</div>
              <small class="text-muted">狀態：${r.status}</small>
            </div>
            <div class="text-end">
              <span class="status-badge status-${r.status}">${r.status}</span>
              ${(r.status==='已報名')? `<div><button class="btn btn-danger btn-sm mt-2" onclick="cancelRegistration('${r.id}')"><i class="bi bi-x-circle me-1"></i>取消</button></div>`:''}
            </div>
          </div>
        </div>`).join('');
    }
    async function cancelRegistration(id){
      if(!confirm('確定取消？')) return;
      try{
        await callAPI('cancelRegistration',{ lineId:userProfile.userId, registrationId:id });
        showNotification('已取消','success'); await loadMyRegistrations(); await loadActivities();
      }catch(err){ showNotification('取消失敗：'+err.message,'error'); }
    }

    // ========== 志工 ==========
    async function loadVolunteerData(){
      if(!currentUser) return;
      try{
        const r=await callAPI('getVolunteerData',{ lineId:userProfile.userId });
        const s=r.data.stats;
        document.getElementById('volunteerHours').textContent=s.totalHours||0;
        document.getElementById('volunteerActivities').textContent=s.totalActivities||0;
        document.getElementById('volunteerRank').textContent=s.rank||'-';
        document.getElementById('availableNeeds').textContent=s.availableNeeds||0;
        renderVolunteerNeeds(r.data.needs||[]);
        renderVolunteerRecords(r.data.records||[]);
      }catch(err){ console.error(err); }
    }
    function renderVolunteerNeeds(list){
      const c=document.getElementById('volunteerNeeds');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">無需求</p>'; return; }
      c.innerHTML=list.map(n=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div class="flex-grow-1">
              <strong>${n.title}</strong>
              <div class="small text-muted mt-1">${n.description||''}</div>
              <div class="row g-1 small mt-1">
                <div class="col-6"><i class="bi bi-calendar me-1"></i>${formatDate(n.date)}</div>
                <div class="col-6"><i class="bi bi-people me-1"></i>${n.currentCount||0}/${n.needCount}</div>
                <div class="col-6"><i class="bi bi-clock me-1"></i>${n.time||'-'}</div>
                <div class="col-6"><i class="bi bi-award me-1"></i>${n.hours} 小時</div>
              </div>
            </div>
            <div class="text-end">
              <span class="status-badge status-${n.status}">${n.status}</span>
              ${(n.status==='開放報名')? `<button class="btn btn-success btn-sm mt-2" onclick="applyVolunteer('${n.id}')"><i class="bi bi-hand-thumbs-up me-1"></i>報名</button>`:''}
            </div>
          </div>
        </div>`).join('');
    }
    function renderVolunteerRecords(list){
      const c=document.getElementById('myVolunteerRecords');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">無記錄</p>'; return; }
      c.innerHTML=list.map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.title}</strong>
              <div class="small text-muted mt-1"><i class="bi bi-calendar me-1"></i>${formatDate(r.date)} / ${r.hours} 小時</div>
            </div>
            <span class="status-badge status-${r.status}">${r.status}</span>
          </div>
        </div>`).join('');
    }
    async function applyVolunteer(id){
      if(!currentUser){ showNotification('請先註冊','warning'); return; }
      try{
        await callAPI('applyVolunteer',{ lineId:userProfile.userId, needId:id });
        showNotification('報名成功','success'); await loadVolunteerData();
      }catch(err){ showNotification('報名失敗：'+err.message,'error'); }
    }

    // ========== 財務 ==========
    async function loadFinanceData(){
      if(!currentUser) return;
      try{
        const r=await callAPI('getFinanceData',{ lineId:userProfile.userId });
        const s=r.data.stats;
        document.getElementById('myDonationAmount').textContent=(s.totalDonation||0).toLocaleString();
        document.getElementById('myDonationCount').textContent=s.donationCount||0;
        document.getElementById('myExpenseAmount').textContent=(s.totalExpense||0).toLocaleString();
        document.getElementById('pendingExpenses').textContent=s.pendingExpenses||0;
        renderDonationHistory(r.data.donations||[]);
        renderExpenseHistory(r.data.expenses||[]);
        if(r.data.adminStats && isAdmin){
          document.getElementById('totalIncome').textContent=(r.data.adminStats.totalIncome||0).toLocaleString();
          document.getElementById('totalExpense').textContent=(r.data.adminStats.totalExpense||0).toLocaleString();
          document.getElementById('currentBalance').textContent=(r.data.adminStats.currentBalance||0).toLocaleString();
          document.getElementById('monthlyDonations').textContent=(r.data.adminStats.monthlyDonations||0).toLocaleString();
        }
      }catch(err){ console.error(err); }
    }
    function renderDonationHistory(list){
      const c=document.getElementById('donationHistory');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">尚無捐款</p>'; return; }
      c.innerHTML=list.map(d=>`
        <div class="transaction-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div>
              <strong>捐款 - ${d.category}</strong>
              <div class="small text-muted mt-1">${d.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(d.createdAt)}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold text-success">${formatCurrency(d.amount)}</div>
              <small class="text-muted">收據：${d.receiptNumber||'處理中'}</small>
            </div>
          </div>
        </div>`).join('');
    }
    function renderExpenseHistory(list){
      const c=document.getElementById('expenseHistory');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">尚無支出</p>'; return; }
      c.innerHTML=list.map(e=>`
        <div class="transaction-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div>
              <strong>支出 - ${e.category}</strong>
              <div class="small text-muted mt-1">${e.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(e.createdAt)}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold text-danger">${formatCurrency(e.amount)}</div>
              <span class="status-badge status-${e.status}">${e.status}</span>
            </div>
          </div>
        </div>`).join('');
    }

    // 捐款 Modal（動態類別）
    function showNewDonationModal(){
      if(!currentUser){ showNotification('請先註冊','warning'); return;}
      if(isAdmin && sysSettings.incomeCategories.length===0){
        loadSettings().catch(()=>{});
      }
      const opts = (sysSettings.incomeCategories.length? sysSettings.incomeCategories:['一般捐款','活動贊助'])
        .map(c=>`<option value="${c}">${c}</option>`).join('');
      const html=`
      <div class="modal fade" id="donationModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="donationForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>捐款</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <select class="form-select" id="donationCategory" required>
                <option value="">選擇類別</option>
                ${opts}
              </select>
              <label for="donationCategory">捐款類別 *</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="donationAmount" min="1" required>
              <label for="donationAmount">金額 *</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" id="donationDescription" style="height:80px;"></textarea>
              <label for="donationDescription">備註</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="needReceipt" checked>
              <label class="form-check-label" for="needReceipt">需要收據</label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">取消</button>
            <button class="btn btn-success" type="submit"><i class="bi bi-heart-fill me-1"></i>捐款</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('donationModal')); m.show();
      document.getElementById('donationForm').addEventListener('submit',handleDonationSubmit);
    }
    async function handleDonationSubmit(e){
      e.preventDefault();
      const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('createDonation',{
          lineId:userProfile.userId,
          category:document.getElementById('donationCategory').value,
          amount:parseInt(document.getElementById('donationAmount').value,10),
          description:document.getElementById('donationDescription').value,
          needReceipt: document.getElementById('needReceipt').checked
        });
        showNotification('捐款成功','success'); bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
        await loadFinanceData(); await loadMyReceipts();
      }catch(err){ showNotification('捐款失敗：'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // 支出申請（動態類別）
    function showNewExpenseModal(){
      if(!currentUser){ showNotification('請先註冊','warning'); return;}
      if(isAdmin && sysSettings.expenseCategories.length===0){
        loadSettings().catch(()=>{});
      }
      const opts = (sysSettings.expenseCategories.length? sysSettings.expenseCategories:['活動費用','設備耗材','行政支出','其他'])
        .map(c=>`<option value="${c}">${c}</option>`).join('');
      const html=`
      <div class="modal fade" id="expenseModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="expenseForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-receipt me-2"></i>支出申請</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <select class="form-select" id="expenseCategory" required>
                <option value="">選擇分類</option>
                ${opts}
              </select><label for="expenseCategory">分類 *</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="expenseAmount" min="1" required>
              <label for="expenseAmount">金額 *</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" id="expenseDescription" style="height:80px;"></textarea>
              <label for="expenseDescription">說明</label>
            </div>
            <small class="text-muted">附件上傳功能可後續擴充</small>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">取消</button>
            <button class="btn btn-warning" type="submit"><i class="bi bi-send me-1"></i>送出</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('expenseModal')); m.show();
      document.getElementById('expenseForm').addEventListener('submit',handleExpenseSubmit);
    }
    async function handleExpenseSubmit(e){
      e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('createExpense',{
          lineId:userProfile.userId,
          category:document.getElementById('expenseCategory').value,
          amount:parseInt(document.getElementById('expenseAmount').value,10),
          description:document.getElementById('expenseDescription').value
        });
        showNotification('申請已送出','success'); bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
        await loadFinanceData();
      }catch(err){ showNotification('申請失敗：'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // 志工需求 (Admin)
    function showNewVolunteerNeedModal(){
      if(!isAdmin){ showNotification('權限不足','error'); return;}
      const html=`
      <div class="modal fade" id="volNeedModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="volNeedForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>新增志工需求</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="form-floating mb-3"><input class="form-control" id="needTitle" required><label for="needTitle">標題 *</label></div>
            <div class="form-floating mb-3"><textarea class="form-control" id="needDesc" style="height:80px;"></textarea><label for="needDesc">描述</label></div>
            <div class="form-floating mb-3"><input type="date" class="form-control" id="needDate" required><label for="needDate">日期 *</label></div>
            <div class="form-floating mb-3"><input class="form-control" id="needTime" placeholder="09:00-12:00"><label for="needTime">時間</label></div>
            <div class="form-floating mb-3"><input type="number" class="form-control" id="needCount" min="1" required><label for="needCount">需求人數 *</label></div>
            <div class="form-floating mb-3"><input type="number" class="form-control" id="needHours" min="1" required><label for="needHours">時數 *</label></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
            <button class="btn btn-success" type="submit"><i class="bi bi-save me-1"></i>建立</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('volNeedModal')); m.show();
      document.getElementById('volNeedForm').addEventListener('submit',handleVolunteerNeedSubmit);
    }
    async function handleVolunteerNeedSubmit(e){
      e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('createVolunteerNeed',{
          lineId:userProfile.userId,
          title:needTitle.value,
          description:needDesc.value,
          date:needDate.value,
          time:needTime.value,
          needCount:parseInt(needCount.value,10),
          hours:parseInt(needHours.value,10)
        });
        showNotification('建立成功','success'); bootstrap.Modal.getInstance(document.getElementById('volNeedModal')).hide();
        await loadVolunteerData();
      }catch(err){ showNotification('建立失敗：'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // 活動新增 (Admin)
    function showNewActivityModal(){
      if(!isAdmin){ showNotification('權限不足','error'); return;}
      const html=`
      <div class="modal fade" id="activityModal" tabindex="-1">
        <div class="modal-dialog modal-lg"><form class="modal-content" id="activityForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>新增活動</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body row g-3">
            <div class="col-12"><div class="form-floating"><input class="form-control" id="actTitle" required><label for="actTitle">標題 *</label></div></div>
            <div class="col-6"><div class="form-floating"><input type="date" class="form-control" id="actDate" required><label for="actDate">日期 *</label></div></div>
            <div class="col-6"><div class="form-floating"><input class="form-control" id="actTime"><label for="actTime">時間</label></div></div>
            <div class="col-12"><div class="form-floating"><input class="form-control" id="actLocation"><label for="actLocation">地點</label></div></div>
            <div class="col-6"><div class="form-floating"><input type="number" min="1" class="form-control" id="actMax" required><label for="actMax">名額 *</label></div></div>
            <div class="col-6"><div class="form-floating"><input type="number" min="0" class="form-control" id="actFee" value="0"><label for="actFee">費用</label></div></div>
            <div class="col-12"><div class="form-floating"><textarea class="form-control" id="actDesc" style="height:90px;"></textarea><label for="actDesc">描述</label></div></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
            <button class="btn btn-success" type="submit"><i class="bi bi-save me-1"></i>建立</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('activityModal')); m.show();
      document.getElementById('activityForm').addEventListener('submit',handleActivityCreate);
    }
    async function handleActivityCreate(e){
      e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('createActivity',{
          lineId:userProfile.userId,
          title:actTitle.value,
          date:actDate.value,
          time:actTime.value,
          location:actLocation.value,
          maxParticipants:parseInt(actMax.value,10),
          fee:parseInt(actFee.value||'0',10),
          description:actDesc.value
        });
        showNotification('活動已建立','success'); bootstrap.Modal.getInstance(document.getElementById('activityModal')).hide();
        await loadActivities(); if(isAdmin) await loadAdminData();
      }catch(err){ showNotification('建立失敗：'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // 快速交易 (Admin) - 此處未動態化分類，可自行延伸
    function showNewTransactionModal(){
      if(!isAdmin){ showNotification('權限不足','error'); return;}
      const html=`
      <div class="modal fade" id="txModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="txForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>快速新增交易</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <select class="form-select" id="txType" required>
                <option value="">選擇類型</option><option value="donation">捐款(收入)</option><option value="expense">支出</option>
              </select><label for="txType">類型 *</label>
            </div>
            <div class="form-floating mb-3"><input class="form-control" id="txCategory" required><label for="txCategory">分類 *</label></div>
            <div class="form-floating mb-3"><input type="number" class="form-control" id="txAmount" min="1" required><label for="txAmount">金額 *</label></div>
            <div class="form-floating mb-3"><textarea class="form-control" id="txDesc" style="height:80px;"></textarea><label for="txDesc">說明</label></div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="txNeedReceipt"><label class="form-check-label" for="txNeedReceipt">需要收據(捐款)</label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
            <button class="btn btn-primary" type="submit"><i class="bi bi-check2 me-1"></i>建立</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('txModal')); m.show();
      document.getElementById('txForm').addEventListener('submit',handleQuickTransactionSubmit);
    }
    async function handleQuickTransactionSubmit(e){
      e.preventDefault();
      const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        const type=document.getElementById('txType').value;
        if(type==='donation'){
          await callAPI('createDonation',{
            lineId:userProfile.userId,
            category:txCategory.value,
            amount:parseInt(txAmount.value,10),
            description:txDesc.value,
            needReceipt: txNeedReceipt.checked
          });
        }else if(type==='expense'){
          await callAPI('createExpense',{
            lineId:userProfile.userId,
            category:txCategory.value,
            amount:parseInt(txAmount.value,10),
            description:txDesc.value
          });
        }else throw new Error('未選擇類型');
        showNotification('交易建立成功','success');
        bootstrap.Modal.getInstance(document.getElementById('txModal')).hide();
        await loadFinanceData(); if(isAdmin) await loadAdminData(); loadMyReceipts();
      }catch(err){ showNotification('建立失敗：'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // 手動開立收據 (Admin)
    function showManualReceiptModal(){
      if(!isAdmin){ showNotification('權限不足','error'); return;}
      const html=`
      <div class="modal fade" id="manualReceiptModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="manualReceiptForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-receipt-cutoff me-2"></i>手動收據</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="form-floating mb-3"><input class="form-control" id="receiptLineId" required><label for="receiptLineId">會員 LINE ID *</label></div>
            <div class="form-floating mb-3">
              <select class="form-select" id="receiptType" required>
                <option value="">選擇類別</option><option value="捐款">捐款</option><option value="其他">其他</option>
              </select><label for="receiptType">類別 *</label>
            </div>
            <div class="form-floating mb-3"><input type="number" class="form-control" id="receiptAmount" min="1" required><label for="receiptAmount">金額 *</label></div>
            <div class="form-check mb-2"><input class="form-check-input" type="checkbox" id="createDonationSync" checked><label class="form-check-label" for="createDonationSync">同步新增捐款紀錄 (捐款類型)</label></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
            <button class="btn btn-success" type="submit"><i class="bi bi-save me-1"></i>開立</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('manualReceiptModal')); m.show();
      document.getElementById('manualReceiptForm').addEventListener('submit',handleManualReceiptSubmit);
    }
    async function handleManualReceiptSubmit(e){
      e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('createManualReceipt',{
          lineId:userProfile.userId,
          targetLineId:receiptLineId.value,
          type:receiptType.value,
          amount:parseInt(receiptAmount.value,10),
          createDonation: document.getElementById('createDonationSync').checked
        });
        showNotification('收據已建立','success'); bootstrap.Modal.getInstance(document.getElementById('manualReceiptModal')).hide();
        await loadAdminData();
      }catch(err){ showNotification('開立失敗：'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // 系統通知
    function showSystemNotificationModal(){
      if(!isAdmin){ showNotification('權限不足','error'); return; }
      const html=`
      <div class="modal fade" id="sysNotifyModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="sysNotifyForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-megaphone me-2"></i>系統通知</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="form-floating mb-3"><textarea class="form-control" id="notifyMessage" style="height:120px;" required></textarea><label for="notifyMessage">通知內容 *</label></div>
            <small class="text-muted">目前僅記錄於系統日誌，可後續串接 LINE Push。</small>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
            <button class="btn btn-info" type="submit"><i class="bi bi-send me-1"></i>發送</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('sysNotifyModal')); m.show();
      document.getElementById('sysNotifyForm').addEventListener('submit',async e=>{
        e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
        try{
          await callAPI('sendSystemNotification',{ lineId:userProfile.userId, message:notifyMessage.value });
          showNotification('已發送','success'); bootstrap.Modal.getInstance(document.getElementById('sysNotifyModal')).hide();
        }catch(err){ showNotification('發送失敗：'+err.message,'error'); }
        finally{ setButtonLoading(btn,false); }
      });
    }

    // 收據清單
    async function loadMyReceipts(){
      if(!currentUser) return;
      try{
        const r=await callAPI('getMyReceipts',{ lineId:userProfile.userId });
        renderMyReceipts(r.data||[]);
      }catch(err){
        document.getElementById('myReceipts').innerHTML=`<div class="text-danger text-center py-2">載入失敗：${err.message}</div>`;
      }
    }
    function renderMyReceipts(list){
      const c=document.getElementById('myReceipts');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">尚無收據</p>'; return; }
      c.innerHTML=list.map(r=>`
        <div class="receipt-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div>
              <strong>${r.receiptNumber}</strong>
              <div class="small text-muted mt-1">類型：${r.type} / 金額：${formatCurrency(r.amount)}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(r.issueDate)}</small>
              ${r.emailSent? '<div class="text-success small mt-1"><i class="bi bi-envelope-check me-1"></i>已寄送 Email</div>':''}
            </div>
            <div class="text-end">
              <span class="status-badge status-${r.status}">${r.status}</span>
              ${r.pdfUrl? `<div class="mt-2"><a href="${r.pdfUrl}" target="_blank" class="btn btn-sm download-btn"><i class="bi bi-download me-1"></i>PDF</a></div>`:''}
            </div>
          </div>
        </div>`).join('');
    }

    // 收入確認 (Admin)
    async function loadIncomeVerification(){
      if(!isAdmin) return;
      try{
        const r=await callAPI('getFinanceData',{ lineId:userProfile.userId });
        renderIncomeVerification(r.data.donations||[]);
      }catch(err){
        document.getElementById('incomeVerificationList').innerHTML=`<div class="text-danger text-center py-2">載入失敗：${err.message}</div>`;
      }
    }
    function renderIncomeVerification(list){
      const c=document.getElementById('incomeVerificationList');
      const unverified=list.filter(d=>!d.verifiedBy);
      if(!unverified.length){ c.innerHTML='<p class="text-muted mb-0 py-2">無待確認收入</p>'; return; }
      c.innerHTML=unverified.map(d=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div>
              <strong>${d.category} - ${formatCurrency(d.amount)}</strong>
              <div class="small text-muted mt-1">${d.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(d.createdAt)}</small>
            </div>
            <button class="btn btn-success btn-sm" onclick="showConfirmIncomeModal('${d.id}','${d.amount}','${d.category}')"><i class="bi bi-check-circle me-1"></i>確認</button>
          </div>
        </div>`).join('');
    }
    function showConfirmIncomeModal(id,amount,cat){
      const html=`
      <div class="modal fade" id="confirmIncomeModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="confirmIncomeForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-bank me-2"></i>收入確認</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="alert alert-info mb-3"><strong>${cat}</strong><br>金額：${formatCurrency(amount)}</div>
            <div class="form-floating mb-3"><input type="date" class="form-control" id="bankDate" required><label for="bankDate">銀行入帳日期 *</label></div>
            <div class="form-floating mb-3"><input class="form-control" id="bankAccount" placeholder="帳號後5碼"><label for="bankAccount">轉帳帳號</label></div>
            <input type="hidden" id="donationId" value="${id}">
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
            <button class="btn btn-success" type="submit"><i class="bi bi-check-circle me-1"></i>確認</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('confirmIncomeModal')); m.show();
      document.getElementById('confirmIncomeForm').addEventListener('submit',handleConfirmIncome);
    }
    async function handleConfirmIncome(e){
      e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('confirmDonationIncome',{
          lineId:userProfile.userId,
          donationId:document.getElementById('donationId').value,
          bankDate:document.getElementById('bankDate').value,
          bankAccount:document.getElementById('bankAccount').value
        });
        showNotification('收入已確認','success'); bootstrap.Modal.getInstance(document.getElementById('confirmIncomeModal')).hide();
        loadIncomeVerification();
      }catch(err){ showNotification('確認失敗：'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // 支出審核 (Admin)
    async function loadExpenseApproval(){
      if(!isAdmin) return;
      try{
        const r=await callAPI('getFinanceData',{ lineId:userProfile.userId });
        renderExpenseApproval(r.data.expenses||[]);
      }catch(err){
        document.getElementById('expenseApprovalList').innerHTML=`<div class="text-danger text-center py-2">載入失敗：${err.message}</div>`;
      }
    }
    function renderExpenseApproval(list){
      const c=document.getElementById('expenseApprovalList');
      const pending=list.filter(e=>e.status==='審核中');
      if(!pending.length){ c.innerHTML='<p class="text-muted mb-0 py-2">無待審核支出</p>'; return; }
      c.innerHTML=pending.map(e=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div>
              <strong>${e.category} - ${formatCurrency(e.amount)}</strong>
              <div class="small text-muted mt-1">${e.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(e.createdAt)}</small>
            </div>
            <div class="text-end d-flex flex-column gap-2">
              <button class="btn btn-success btn-sm" onclick="showApproveExpenseModal('${e.id}','approve','${e.amount}','${e.category}')"><i class="bi bi-check-circle me-1"></i>核准</button>
              <button class="btn btn-danger btn-sm" onclick="showApproveExpenseModal('${e.id}','reject','${e.amount}','${e.category}')"><i class="bi bi-x-circle me-1"></i>拒絕</button>
            </div>
          </div>
        </div>`).join('');
    }
    function showApproveExpenseModal(id,decision,amount,cat){
      const approve=decision==='approve';
      const html=`
      <div class="modal fade" id="approveExpenseModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="approveExpenseForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-${approve?'check-circle':'x-circle'} me-2"></i>${approve?'核准':'拒絕'}支出</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="alert alert-${approve?'success':'danger'} mb-3"><strong>${cat}</strong><br>金額：${formatCurrency(amount)}</div>
            ${approve? `
              <div class="form-floating mb-3"><input type="date" class="form-control" id="paymentDate"><label for="paymentDate">發款日期</label></div>
              <div class="form-floating mb-3"><input class="form-control" id="paymentAccount" placeholder="對方帳號後5碼"><label for="paymentAccount">對方帳號</label></div>
              <div class="form-floating mb-3">
                <select class="form-select" id="paymentMethod">
                  <option value="">付款方式</option><option value="銀行轉帳">銀行轉帳</option><option value="現金">現金</option><option value="支票">支票</option>
                </select><label for="paymentMethod">付款方式</label>
              </div>
              <div class="form-floating mb-3"><input type="datetime-local" class="form-control" id="bankTransferDate"><label for="bankTransferDate">銀行處理時間</label></div>
            `:`
              <div class="form-floating mb-3">
                <textarea class="form-control" id="rejectReason" style="height:80px;"></textarea>
                <label for="rejectReason">拒絕原因</label>
              </div>
            `}
            <input type="hidden" id="expenseId" value="${id}">
            <input type="hidden" id="decision" value="${decision}">
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">取消</button>
            <button class="btn btn-${approve?'success':'danger'}" type="submit"><i class="bi bi-${approve?'check-circle':'x-circle'} me-1"></i>確認</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('approveExpenseModal')); m.show();
      document.getElementById('approveExpenseForm').addEventListener('submit',handleApproveExpense);
    }
    async function handleApproveExpense(e){
      e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        const decision=document.getElementById('decision').value;
        const payload={
          lineId:userProfile.userId,
          expenseId:document.getElementById('expenseId').value,
          decision
        };
        if(decision==='approve'){
          payload.paymentInfo={
            paymentDate:paymentDate.value,
            paymentAccount:paymentAccount.value,
            paymentMethod:paymentMethod.value,
            bankTransferDate:bankTransferDate.value
          };
        }else{
          payload.rejectReason=document.getElementById('rejectReason').value;
        }
        await callAPI('approveExpenseWithPayment',payload);
        showNotification(`已${decision==='approve'?'核准':'拒絕'}`,'success');
        bootstrap.Modal.getInstance(document.getElementById('approveExpenseModal')).hide();
        loadExpenseApproval();
      }catch(err){ showNotification('處理失敗：'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // 回饋
    async function loadFeedbackData(){
      if(!currentUser) return;
      try{
        const acts=await callAPI('getMyCompletedActivities',{ lineId:userProfile.userId });
        populateFeedbackActivities(acts.data||[]);
        const my=await callAPI('getMyFeedback',{ lineId:userProfile.userId });
        renderMyFeedback(my.data||[]);
        if(isAdmin){
          const all=await callAPI('getAllFeedback',{ lineId:userProfile.userId });
          renderAllFeedback(all.data||[]);
        }
      }catch(err){ console.error(err); }
    }
    function populateFeedbackActivities(list){
      const sel=document.getElementById('feedbackActivity');
      sel.innerHTML='<option value="">選擇活動</option>';
      list.forEach(a=> sel.innerHTML+=`<option value="${a.id}">${a.title} (${formatDate(a.date)})</option>`);
    }
    function renderMyFeedback(list){
      const c=document.getElementById('myFeedback');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">尚無回饋</p>'; return; }
      c.innerHTML=list.map(f=>`
        <div class="activity-item">
          <strong>${f.activityTitle}</strong>
          <div class="mt-1">${'★'.repeat(f.rating)}${'☆'.repeat(5-f.rating)} <span class="text-muted small">(${f.rating}/5)</span></div>
          <div class="small mt-1">${f.comment}</div>
          <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(f.createdAt)}</small>
        </div>`).join('');
    }
    function renderAllFeedback(list){
      const c=document.getElementById('allFeedback');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">無資料</p>'; return;}
      c.innerHTML=list.map(f=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${f.activityTitle}</strong>
              <div class="mt-1">${'★'.repeat(f.rating)}${'☆'.repeat(5-f.rating)} <span class="text-muted small">(${f.rating}/5)</span></div>
              <div class="small mt-1">${f.comment}</div>
              <small class="text-muted">${formatDateTime(f.createdAt)}</small>
            </div>
            <small class="text-muted">${f.lineId}</small>
          </div>
        </div>`).join('');
    }
    document.getElementById('feedbackForm').addEventListener('submit',async e=>{
      e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('createFeedback',{
          lineId:userProfile.userId,
          activityId:feedbackActivity.value,
          rating:parseInt(feedbackRating.value,10),
          comment:feedbackComment.value
        });
        showNotification('已提交','success'); e.target.reset(); await loadFeedbackData();
      }catch(err){ showNotification('提交失敗：'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    });

    // Admin 資料
    async function loadAdminData(){
      if(!isAdmin) return;
      try{
        const r=await callAPI('getAdminData',{ lineId:userProfile.userId });
        cachedAdminData=r.data;
        renderMemberList(r.data.members||[]);
        renderAdminActivities(r.data.activities||[]);
        renderTransactions(r.data.transactions||[]);
        renderReceipts(r.data.receipts||[]);
      }catch(err){ console.error(err); }
    }
    function renderMemberList(list){
      const tb=document.getElementById('memberList');
      if(!list.length){ tb.innerHTML='<tr><td colspan="6" class="text-center text-muted py-3">無資料</td></tr>'; return; }
      tb.innerHTML=list.map(m=>`
        <tr>
          <td>${m.realName||m.lineName||'-'}</td>
          <td>${m.memberType||'-'}</td>
          <td><span class="status-badge status-${m.status||''}">${m.status||''}</span></td>
          <td>${formatDate(m.joinDate)}</td>
          <td>${m.donationCount||0}</td>
          <td><button class="btn btn-outline-primary btn-sm" onclick="viewMemberDetail('${m.lineId}')"><i class="bi bi-eye"></i></button></td>
        </tr>`).join('');
    }
    function renderAdminActivities(list){
      const c=document.getElementById('adminActivityList');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">無活動</p>'; return; }
      c.innerHTML=list.map(a=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${a.title}</strong>
              <div class="small text-muted mt-1">${formatDate(a.date)} / ${a.location||''}</div>
            </div>
            <div class="text-end">
              <span class="status-badge status-${a.status}">${a.status}</span>
              <div class="small mt-2">${a.currentCount||0}/${a.maxParticipants||0}</div>
            </div>
          </div>
        </div>`).join('');
    }
    function renderTransactions(list){
      const tb=document.getElementById('transactionList');
      if(!list.length){ tb.innerHTML='<tr><td colspan="6" class="text-center text-muted py-3">無交易</td></tr>'; return; }
      tb.innerHTML=list.map(t=>`
        <tr>
          <td class="small">${formatDateTime(t.date)}</td>
          <td>${t.type}</td>
          <td class="${t.type==='收入'?'text-success':'text-danger'}">${formatCurrency(t.amount)}</td>
          <td>${t.category||''}</td>
          <td class="small">${t.description||''}</td>
          <td>${t.status? `<span class="status-badge status-${t.status}">${t.status}</span>`:''}</td>
        </tr>`).join('');
    }
    function renderReceipts(list){
      const c=document.getElementById('receiptList');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">無收據</p>'; return; }
      c.innerHTML=list.map(r=>`
        <div class="receipt-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div>
              <strong>${r.receiptNumber}</strong>
              <div class="small text-muted mt-1">${formatDate(r.issueDate)} / ${r.type}</div>
            </div>
            <div class="text-end">
              <div class="fw-bold mb-1">${formatCurrency(r.amount)}</div>
              <span class="status-badge status-${r.status}">${r.status}</span>
              ${r.pdfUrl? `<div class="mt-2"><a href="${r.pdfUrl}" target="_blank" class="btn btn-sm download-btn"><i class="bi bi-download"></i></a></div>`:''}
            </div>
          </div>
        </div>`).join('');
    }
    function viewMemberDetail(lineId){
      const member=(cachedAdminData?.members||[]).find(m=>m.lineId===lineId);
      if(!member){ showNotification('找不到會員','error'); return;}
      const html=`
      <div class="modal fade" id="memberDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title"><i class="bi bi-person me-2"></i>${member.realName||member.lineName||lineId}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <ul class="list-group">
                <li class="list-group-item"><strong>LINE ID：</strong>${member.lineId}</li>
                <li class="list-group-item"><strong>姓名：</strong>${member.realName||'-'}</li>
                <li class="list-group-item"><strong>類別：</strong>${member.memberType||'-'}</li>
                <li class="list-group-item"><strong>電話：</strong>${member.phone||'-'}</li>
                <li class="list-group-item"><strong>Email：</strong>${member.email||'-'}</li>
                <li class="list-group-item"><strong>疾病分期：</strong>${member.diseaseStage||'-'}</li>
                <li class="list-group-item"><strong>用藥：</strong>${member.medications||'-'}</li>
                <li class="list-group-item"><strong>症狀：</strong>${member.symptoms||'-'}</li>
              </ul>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">關閉</button></div>
          </div>
        </div>
      </div>`;
      document.getElementById('modalContainer').innerHTML=html;
      new bootstrap.Modal(document.getElementById('memberDetailModal')).show();
    }

    // 匯出 / 備份
    async function exportMembers(){
      if(!isAdmin){ showNotification('權限不足','error'); return; }
      try{
        await callAPI('exportMembers',{ lineId:userProfile.userId });
        showNotification('匯出成功（雲端硬碟）','success');
      }catch(err){ showNotification('匯出失敗：'+err.message,'error'); }
    }
    async function exportFinanceData(){
      if(!isAdmin){ showNotification('權限不足','error'); return; }
      try{
        await callAPI('exportFinanceData',{ lineId:userProfile.userId });
        showNotification('匯出成功','success');
      }catch(err){ showNotification('匯出失敗：'+err.message,'error'); }
    }
    async function backupSystem(){
      if(!isAdmin){ showNotification('權限不足','error'); return; }
      try{
        await callAPI('backupSystem',{ lineId:userProfile.userId });
        showNotification('備份完成','success');
      }catch(err){ showNotification('備份失敗：'+err.message,'error'); }
    }

    // 刷新
    async function refreshData(){
      try{
        await Promise.all([
          loadDashboard(),
          loadActivities(),
          loadMyRegistrations(),
          loadVolunteerData(),
          loadFinanceData(),
          loadFeedbackData(),
          loadMyReceipts(),
          isAdmin? loadAdminData():Promise.resolve()
        ]);
        showNotification('已刷新','success');
      }catch(err){ showNotification('刷新失敗：'+err.message,'error'); }
    }

    // 設定：載入與儲存
    async function loadSettings(){
      if(!isAdmin) return;
      try{
        const r = await callAPI('getSettings',{ lineId:userProfile.userId });
        const s = r.data;
        document.getElementById('receiptTemplateDocId').value = s.receiptTemplateDocId||'';
        document.getElementById('emailReplyTemplate').value = s.emailReplyTemplate||'';
        document.getElementById('incomeCategories').value = (s.incomeCategories||[]).join('\\n');
        document.getElementById('expenseCategoriesSetting').value = (s.expenseCategories||[]).join('\\n');
        document.getElementById('expenseVoucherTemplateDocId').value = s.expenseVoucherTemplateDocId||'';
        sysSettings.incomeCategories = s.incomeCategories||[];
        sysSettings.expenseCategories = s.expenseCategories||[];
        showNotification('設定已載入','success');
      }catch(err){
        showNotification('設定載入失敗：'+err.message,'error');
      }
    }
    document.getElementById('settingsForm')?.addEventListener('submit', async e=>{
      e.preventDefault();
      if(!isAdmin) return;
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        const income = document.getElementById('incomeCategories').value.split('\\n').map(s=>s.trim()).filter(Boolean);
        const expense = document.getElementById('expenseCategoriesSetting').value.split('\\n').map(s=>s.trim()).filter(Boolean);
        await callAPI('updateSettings',{
          lineId:userProfile.userId,
          receiptTemplateDocId: document.getElementById('receiptTemplateDocId').value.trim(),
          emailReplyTemplate: document.getElementById('emailReplyTemplate').value,
          incomeCategories: income,
          expenseCategories: expense,
          expenseVoucherTemplateDocId: document.getElementById('expenseVoucherTemplateDocId').value.trim()
        });
        showNotification('設定已儲存','success');
        await loadSettings();
      }catch(err){
        showNotification('儲存失敗：'+err.message,'error');
      }finally{
        setButtonLoading(btn,false);
      }
    });

    // Tab 事件
    document.addEventListener('DOMContentLoaded',()=>{
      document.querySelectorAll('[data-bs-toggle="pill"],[data-bs-toggle="tab"]').forEach(btn=>{
        btn.addEventListener('shown.bs.tab',e=>{
          const id=e.target.getAttribute('data-bs-target').substring(1);
          switch(id){
            case 'activities': loadActivities(); loadMyRegistrations(); break;
            case 'volunteer': loadVolunteerData(); break;
            case 'finance': loadFinanceData(); break;
            case 'feedback': loadFeedbackData(); break;
            case 'admin': if(isAdmin) loadAdminData(); break;
            case 'incomeVerification': if(isAdmin) loadIncomeVerification(); break;
            case 'expenseApproval': if(isAdmin) loadExpenseApproval(); break;
            case 'systemSettings': if(isAdmin) loadSettings(); break;
          }
        });
      });
    });
    // 禁用非 textarea Enter
    document.addEventListener('keydown',e=>{
      if(e.key==='Enter' && !['TEXTAREA','BUTTON'].includes(e.target.tagName)) e.preventDefault();
    });

    // 暴露方法
    window.showNewActivityModal=showNewActivityModal;
    window.registerActivity=registerActivity;
    window.cancelRegistration=cancelRegistration;
    window.applyVolunteer=applyVolunteer;
    window.showNewDonationModal=showNewDonationModal;
    window.showNewExpenseModal=showNewExpenseModal;
    window.showNewVolunteerNeedModal=showNewVolunteerNeedModal;
    window.showNewTransactionModal=showNewTransactionModal;
    window.showManualReceiptModal=showManualReceiptModal;
    window.showSystemNotificationModal=showSystemNotificationModal;
    window.filterActivities=filterActivities;
    window.refreshData=refreshData;

    window.addEventListener('load',initializeLiff);
  </script>
</body>
</html>
