<!-- ä¸‹æ–¹æä¾›ï¼š
1. å‰ç«¯ LIFF å–®é ç‰ˆ (index.html) - å·²ä¿®æ­£æ‚¨æå‡ºçš„ã€Œç„¡æ³•è¼‰å…¥å€‹äººè³‡æ–™ã€å‰ç«¯ç„¡æ³•è¼‰å…¥æ•¸æ“šã€å•é¡Œ
2. å¾Œç«¯ Google Apps Script (Code.gs) - èˆ‡å‰ç«¯å°æ‡‰çš„ API è¡Œç‚º
3. ä¿®æ­£é‡é»èˆ‡éƒ¨ç½²èªªæ˜æ”¾åœ¨æœ€å‰
------------------------------------------------------------
âœ… ä¿®æ­£é‡é» (è«‹å…ˆé–±è®€)
------------------------------------------------------------
1. ä¿®æ­£èªæ³•éŒ¯èª¤ï¼šupdateRecentActivity ç¼ºæ‹¬è™Ÿå°è‡´æ•´å€‹ JS ä¸­æ–·
2. æ‰€æœ‰è¡¨å–®æ¬„ä½è£œä¸Š nameï¼ŒFormData èƒ½æ­£å¸¸å–å¾—å€¼
3. profile æ›´æ–°æ™‚æ¬„ä½ key èˆ‡å¾Œç«¯ä¸€è‡´ (memberType)
4. callAPI å¯æ”œå¸¶ lineIdï¼ˆéƒ¨åˆ† admin å‹•ä½œå·²åŠ  lineIdï¼‰
5. è£œé½Šç¼ºå¤±çš„å‰ç«¯å‡½å¼ï¼ˆæ´»å‹•æ–°å¢ / æ”¯å‡ºç”³è«‹ / åŒ¯å‡º / ç¯©é¸ / é é¢æ¸²æŸ“ stub ç­‰ï¼‰
6. doPost switch è£œä¸Š createActivity / updateActivity / createExpense / backupSystem ç­‰
7. getOrCreateSheet è£œé½Šæ‰€æœ‰å·¥ä½œè¡¨æ¨™é¡Œ (EXPENSES / FEEDBACK / VOLUNTEER_NEEDS / VOLUNTEER_APPLICATIONS)
8. æ´»å‹•å ±å / å–æ¶ˆå ±ååŠ  Lock é˜²ä½µç™¼
9. Admin è³‡æ–™è«‹æ±‚åŠ  lineId åƒæ•¸ï¼Œå¾Œç«¯é©—è­‰ isAdmin
10. é‡‘é¡/æ—¥æœŸæ ¼å¼åŒ–èˆ‡éŒ¯èª¤è™•ç†åŠ å¼·
11. æä¾›ç°¡æ˜“çš„æ´»å‹•éæ¿¾åŠŸèƒ½ (ç‹€æ…‹ / æ—¥æœŸ / é—œéµå­—)
12. æ–°å¢åŸºæœ¬çš„æ´»å‹• / æ”¯å‡º / ææ¬¾ / æ”¶æ“š / äº¤æ˜“åˆ—è¡¨æ¸²æŸ“
13. åŠ å…¥å°šæœªå¯¦ä½œåŠŸèƒ½çš„æç¤º (é¿å…å ±éŒ¯åœæ­¢)

âš  å®‰å…¨å»ºè­°ï¼ˆå°šæœªå®Œå…¨å¯¦ä½œï¼Œæ‚¨å¾ŒçºŒå¯å†åŠ å¼·ï¼‰
- API_KEY æš´éœ²æ–¼å‰ç«¯ä¸å®‰å…¨ï¼Œå»ºè­°æ”¹ç‚º HMAC ç°½ç« æˆ–ä½¿ç”¨ WebApp doGet å–å¾—è‡¨æ™‚ token
- Volunteerã€Receiptã€System Notification ç­‰åŠŸèƒ½ç›®å‰ç‚ºç¤ºä¾‹ï¼Œå¯ä¾éœ€æ±‚å»¶ä¼¸
- è‹¥è¦é€²ä¸€æ­¥æ¬Šé™æ§ç®¡ï¼Œå»ºè­° USERS è¡¨æ–°å¢ isAdmin æ¬„ä½ï¼ˆç¾åœ¨ç”¨ ADMIN_LINE_IDS åˆ¤æ–·ï¼‰

------------------------------------------------------------
ğŸ›  éƒ¨ç½²æ­¥é©Ÿæ‘˜è¦
------------------------------------------------------------
1. å»ºç«‹ Google è©¦ç®—è¡¨ï¼Œå°‡è©¦ç®—è¡¨ ID å¡«å…¥å¾Œç«¯å¸¸æ•¸ SPREADSHEET_ID
2. å»ºç«‹ Apps Script å°ˆæ¡ˆï¼Œè²¼ä¸Šå¾Œç«¯ç¨‹å¼ç¢¼ (Code.gs)
3. æ–°å¢ä¸€å€‹ HTML æª”ï¼ˆindexTT.html æˆ– index.htmlï¼‰ï¼Œè²¼ä¸Šå‰ç«¯ HTML
4. éƒ¨ç½² Web Appï¼šä»¥ã€Œä»»ä½•æ“æœ‰é€£çµçš„äººã€æˆ–ã€Œç™»å…¥çš„ä½¿ç”¨è€…ã€åŸ·è¡Œï¼ˆä¾æ‚¨éœ€æ±‚ï¼‰
5. åœ¨ LINE Developers è¨­å®š LIFF URL ç‚º WebApp éƒ¨ç½²å¾Œçš„ URL
6. å‰ç«¯ CONFIG å…§ LIFF_ID èˆ‡ API_BASE_URL æ”¹æˆæ‚¨çš„æ­£å¼å€¼
7. ç”¨ LINE æ‰“é–‹ LIFF ä¸¦æ¸¬è©¦è¨»å†Š â†’ å„€è¡¨æ¿ â†’ æ´»å‹• â†’ ææ¬¾

------------------------------------------------------------
ğŸ–¥ å‰ç«¯ï¼šindex.html (LIFFé é¢)
------------------------------------------------------------ -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --success-gradient: linear-gradient(135deg,#28a745,#20c997);
      --danger-gradient: linear-gradient(135deg,#dc3545,#c82333);
      --warning-gradient: linear-gradient(135deg,#ffc107,#e0a800);
      --info-gradient: linear-gradient(135deg,#17a2b8,#138496);
    }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans TC',sans-serif; background:var(--primary-gradient); min-height:100vh; }
    .main-header,.nav-container,.content-card {
      background:rgba(255,255,255,.95); backdrop-filter:blur(10px); border-radius:20px; padding:20px; margin:20px;
      box-shadow:0 8px 32px rgba(0,0,0,.1);
    }
    .main-header { position:sticky; top:20px; z-index:1000; text-align:center; }
    .main-header h1 { background:var(--primary-gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .user-info-bar { background:rgba(255,255,255,.9); padding:10px 20px; border-radius:25px; display:inline-flex; align-items:center; gap:15px; box-shadow:0 4px 16px rgba(0,0,0,.1); }
    .user-avatar { width:40px; height:40px; border-radius:50%; background:var(--primary-gradient); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; }
    .nav-pills .nav-link.active { background:var(--primary-gradient); }
    .content-card { transition:.2s; }
    .content-card:hover { transform:translateY(-2px); }
    .stat-card { background:var(--success-gradient); color:#fff; border-radius:15px; padding:20px; text-align:center; margin-bottom:20px; }
    .notification { position:fixed; top:20px; right:20px; padding:15px 20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.15); z-index:9999; transform:translateX(450px); transition:.3s; max-width:360px; }
    .notification.show { transform:translateX(0); }
    .notification.success { background:#c6f6d5; color:#22543d; border-left:4px solid #48bb78; }
    .notification.error { background:#fed7d7; color:#742a2a; border-left:4px solid #f56565; }
    .notification.warning { background:#feebc8; color:#7b341e; border-left:4px solid #ed8936; }
    .loading-spinner { width:40px; height:40px; border:4px solid #e2e8f0; border-top:4px solid #667eea; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .activity-item,.transaction-item { background:#fff; border-radius:15px; padding:16px 18px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,.08); border-left:4px solid #667eea; }
    .status-badge { display:inline-block; padding:4px 10px; border-radius:16px; font-size:12px; font-weight:600; }
    .status-é–‹æ”¾å ±å,.status-open { background:#c6f6d5; color:#22543d; }
    .status-å·²å ±å { background:#bee3f8; color:#2a4365; }
    .status-å·²å–æ¶ˆ { background:#fed7d7; color:#742a2a; }
    .status-å·²çµæŸ { background:#e2e8f0; color:#4a5568; }
    .admin-only { display:none; }
    .admin-only.show { display:block; }
    .btn.loading::after { content:''; position:absolute; top:50%; left:50%; width:18px; height:18px; margin:-9px 0 0 -9px; border:2px solid rgba(255,255,255,.4); border-top:2px solid #fff; border-radius:50%; animation:spin .8s linear infinite; }
    .quick-actions { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:12px; }
    .quick-btn { background:rgba(255,255,255,.95); padding:18px; border-radius:15px; text-align:center; cursor:pointer; border:2px solid #e2e8f0; transition:.25s; }
    .quick-btn:hover { background:#fff; border-color:#667eea; transform:translateY(-2px); }
    textarea.form-control { resize:vertical; }
    @media (max-width:768px){
      .main-header,.nav-container,.content-card { margin:12px; padding:16px; }
      .quick-actions { grid-template-columns:repeat(2,1fr); }
    }
    @media (prefers-color-scheme:dark){
      body { background:#1a202c; }
      .main-header,.nav-container,.content-card { background:rgba(45,55,72,.95); color:#e2e8f0; }
      .activity-item,.transaction-item { background:#2d3748; color:#e2e8f0; }
      .user-info-bar { background:#2d3748; }
    }
  </style>
</head>
<body>
  <div class="main-header">
    <h1><i class="bi bi-hospital"></i> å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</h1>
    <p class="text-muted small mb-2">æ•´åˆå¼æœƒå“¡ / æ´»å‹• / è²¡å‹™ / å›é¥‹å¹³å°</p>
    <div id="userInfoBar" class="user-info-bar" style="display:none;">
      <div class="user-avatar" id="userAvatar">?</div>
      <div>
        <div class="fw-bold" id="userName">è¼‰å…¥ä¸­...</div>
        <small class="text-muted" id="userRole">æœƒå“¡</small>
      </div>
      <div class="ms-auto d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary" onclick="refreshData()" title="é‡æ–°æ•´ç†">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger" onclick="logoutLiff()" title="ç™»å‡º">
          <i class="bi bi-box-arrow-right"></i>
        </button>
      </div>
    </div>
  </div>

  <div id="notificationContainer"></div>

  <div class="nav-container">
    <ul class="nav nav-pills justify-content-center" id="mainTabs">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#dashboard"><i class="bi bi-speedometer2"></i> å„€è¡¨æ¿</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#profile"><i class="bi bi-person"></i> å€‹äººè³‡æ–™</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#activities"><i class="bi bi-calendar-event"></i> æ´»å‹•ç®¡ç†</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#volunteer"><i class="bi bi-heart"></i> å¿—å·¥æœå‹™</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#finance"><i class="bi bi-cash-coin"></i> è²¡å‹™ç®¡ç†</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#feedback"><i class="bi bi-chat-dots"></i> æ´»å‹•å›é¥‹</button></li>
      <li class="nav-item admin-only"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#admin"><i class="bi bi-gear"></i> ç³»çµ±ç®¡ç†</button></li>
    </ul>
  </div>

  <div class="tab-content">
    <!-- å„€è¡¨æ¿ -->
    <div class="tab-pane fade show active" id="dashboard">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>ç³»çµ±å„€è¡¨æ¿</h5>
          <button class="btn btn-outline-primary btn-sm" onclick="loadDashboard()"><i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°</button>
        </div>
        <div class="quick-actions mb-3">
          <div class="quick-btn" onclick="showTab('profile')"><i class="bi bi-person-check"></i><div>æ›´æ–°è³‡æ–™</div></div>
          <div class="quick-btn" onclick="showTab('activities')"><i class="bi bi-calendar-plus"></i><div>å ±åæ´»å‹•</div></div>
          <div class="quick-btn" onclick="showNewDonationModal()"><i class="bi bi-heart-fill"></i><div>æ„›å¿ƒææ¬¾</div></div>
          <div class="quick-btn" onclick="showTab('volunteer')"><i class="bi bi-hand-thumbs-up"></i><div>å¿—å·¥æœå‹™</div></div>
        </div>
        <div class="row" id="dashboardStats">
          <div class="col-12 text-center py-4">
            <div class="loading-spinner mx-auto mb-2"></div>
            <div class="text-muted">è¼‰å…¥çµ±è¨ˆè³‡æ–™ä¸­...</div>
          </div>
        </div>
        <div class="mt-4">
          <h6><i class="bi bi-clock-history me-2"></i>æœ€è¿‘æ´»å‹•</h6>
          <div id="recentActivity">
            <div class="text-center py-4">
              <div class="loading-spinner mx-auto mb-2"></div>
              <div class="text-muted">è¼‰å…¥æœ€è¿‘æ´»å‹•...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å€‹äººè³‡æ–™ -->
    <div class="tab-pane fade" id="profile">
      <div class="content-card">
        <h5><i class="bi bi-person me-2"></i>å€‹äººè³‡æ–™ç®¡ç†</h5>
        <div id="registrationSection">
          <div class="alert alert-info mt-3"><i class="bi bi-info-circle me-2"></i>è«‹å®Œæˆæœƒå“¡è¨»å†Šä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½</div>
          <form id="registrationForm" class="row g-3 mt-1">
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="realName" name="realName" required>
                <label for="realName">çœŸå¯¦å§“å *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="memberType" name="memberType" required>
                  <option value="">è«‹é¸æ“‡æœƒå“¡é¡åˆ¥</option>
                  <option value="ç—…å‹">ç—…å‹</option>
                  <option value="å®¶å±¬">å®¶å±¬</option>
                  <option value="å¿—å·¥">å¿—å·¥</option>
                  <option value="é†«è­·">é†«è­·äººå“¡</option>
                  <option value="æ”¯æŒè€…">æ”¯æŒè€…</option>
                </select>
                <label for="memberType">æœƒå“¡é¡åˆ¥ *</label>
              </div>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle me-1"></i>å®Œæˆè¨»å†Š</button>
            </div>
          </form>
        </div>
        <div id="profileSection" style="display:none;">
          <form id="profileForm" class="row g-3 mt-2">
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="profileRealName" readonly>
                <label for="profileRealName">çœŸå¯¦å§“å</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="lineName" readonly>
                <label for="lineName">LINE åç¨±</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="tel" class="form-control" id="phone" name="phone">
                <label for="phone">è¯çµ¡é›»è©±</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="email" class="form-control" id="email" name="email">
                <label for="email">é›»å­éƒµä»¶</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="date" class="form-control" id="birthday" name="birthday">
                <label for="birthday">ç”Ÿæ—¥</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="profileMemberType" name="memberType">
                  <option value="ç—…å‹">ç—…å‹</option>
                  <option value="å®¶å±¬">å®¶å±¬</option>
                  <option value="å¿—å·¥">å¿—å·¥</option>
                  <option value="é†«è­·">é†«è­·äººå“¡</option>
                  <option value="æ”¯æŒè€…">æ”¯æŒè€…</option>
                </select>
                <label for="profileMemberType">æœƒå“¡é¡åˆ¥</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" style="height:100px" id="address" name="address"></textarea>
                <label for="address">é€šè¨Šåœ°å€</label>
              </div>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>æ›´æ–°è³‡æ–™</button>
            </div>
          </form>
          <div class="mt-4">
            <h6><i class="bi bi-bar-chart me-2"></i>å€‹äººçµ±è¨ˆ</h6>
            <div class="row g-3" id="profileStats">
              <div class="col-12 text-muted small">å°šç„¡çµ±è¨ˆè³‡æ–™</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ´»å‹•ç®¡ç† -->
    <div class="tab-pane fade" id="activities">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="bi bi-calendar-event me-2"></i>æ´»å‹•åˆ—è¡¨</h5>
          <div class="admin-only">
            <button class="btn btn-success btn-sm" onclick="showNewActivityModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢æ´»å‹•</button>
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <div class="form-floating">
              <select class="form-select" id="activityStatusFilter">
                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                <option value="é–‹æ”¾å ±å">é–‹æ”¾å ±å</option>
                <option value="å ±åæˆªæ­¢">å ±åæˆªæ­¢</option>
                <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
                <option value="å·²çµæŸ">å·²çµæŸ</option>
              </select>
              <label for="activityStatusFilter">ç‹€æ…‹</label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-floating">
              <input type="date" id="activityDateFilter" class="form-control">
              <label for="activityDateFilter">æ—¥æœŸ</label>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-floating">
              <input type="text" id="activitySearchFilter" class="form-control" placeholder="æœå°‹">
              <label for="activitySearchFilter">é—œéµå­—</label>
            </div>
          </div>
          <div class="col-md-2 d-grid">
            <button class="btn btn-outline-primary" onclick="filterActivities()"><i class="bi bi-search"></i> æœå°‹</button>
          </div>
        </div>
        <div id="activitiesList">
          <div class="text-center py-4">
            <div class="loading-spinner mx-auto mb-2"></div>
            <div class="text-muted">è¼‰å…¥æ´»å‹•ä¸­...</div>
          </div>
        </div>
        <div class="mt-4">
          <h6><i class="bi bi-clipboard-check me-2"></i>æˆ‘çš„å ±å</h6>
          <div id="myRegistrations">
            <div class="text-center py-4">
              <div class="loading-spinner mx-auto mb-2"></div>
              <div class="text-muted">è¼‰å…¥å ±åè¨˜éŒ„...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å¿—å·¥æœå‹™ -->
    <div class="tab-pane fade" id="volunteer">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="bi bi-heart me-2"></i>å¿—å·¥æœå‹™</h5>
          <div class="admin-only">
            <button class="btn btn-success btn-sm" onclick="showNewVolunteerNeedModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢éœ€æ±‚</button>
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-3"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="volunteerHours">0</h3><p class="mb-0"><i class="bi bi-clock me-1"></i>æˆ‘çš„æ™‚æ•¸</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="volunteerActivities">0</h3><p class="mb-0"><i class="bi bi-calendar me-1"></i>åƒèˆ‡æ´»å‹•</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="volunteerRank">-</h3><p class="mb-0"><i class="bi bi-trophy me-1"></i>æ’å</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="availableNeeds">0</h3><p class="mb-0"><i class="bi bi-hand-thumbs-up me-1"></i>å¯å ±å</p></div></div>
        </div>
        <h6><i class="bi bi-exclamation-circle me-2"></i>å¿—å·¥éœ€æ±‚</h6>
        <div id="volunteerNeeds">
          <div class="text-center py-4"><div class="loading-spinner mx-auto mb-2"></div><div class="text-muted">è¼‰å…¥å¿—å·¥éœ€æ±‚...</div></div>
        </div>
        <div class="mt-4">
          <h6><i class="bi bi-journal-text me-2"></i>æˆ‘çš„å¿—å·¥è¨˜éŒ„</h6>
          <div id="myVolunteerRecords">
            <div class="text-center py-4"><div class="loading-spinner mx-auto mb-2"></div><div class="text-muted">è¼‰å…¥å¿—å·¥è¨˜éŒ„...</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- è²¡å‹™ç®¡ç† -->
    <div class="tab-pane fade" id="finance">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="bi bi-cash-coin me-2"></i>è²¡å‹™ç®¡ç†</h5>
          <div>
            <button class="btn btn-success btn-sm me-2" onclick="showNewDonationModal()"><i class="bi bi-heart-fill me-1"></i>ææ¬¾</button>
            <button class="btn btn-warning btn-sm" onclick="showNewExpenseModal()"><i class="bi bi-receipt me-1"></i>æ”¯å‡ºç”³è«‹</button>
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-3"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="myDonationAmount">0</h3><p class="mb-0"><i class="bi bi-heart-fill me-1"></i>ææ¬¾ç¸½é¡</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="myDonationCount">0</h3><p class="mb-0"><i class="bi bi-list-ol me-1"></i>ææ¬¾æ¬¡æ•¸</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="myExpenseAmount">0</h3><p class="mb-0"><i class="bi bi-receipt me-1"></i>æ”¯å‡ºç”³è«‹</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="pendingExpenses">0</h3><p class="mb-0"><i class="bi bi-hourglass me-1"></i>å¾…å¯©æ ¸</p></div></div>
        </div>
        <h6><i class="bi bi-heart-fill me-2"></i>æˆ‘çš„ææ¬¾è¨˜éŒ„</h6>
        <div id="donationHistory">
          <div class="text-center py-4"><div class="loading-spinner mx-auto mb-2"></div><div class="text-muted">è¼‰å…¥ææ¬¾è¨˜éŒ„...</div></div>
        </div>
        <div class="mt-4">
          <h6><i class="bi bi-receipt me-2"></i>æˆ‘çš„æ”¯å‡ºç”³è«‹</h6>
          <div id="expenseHistory">
            <div class="text-center py-4"><div class="loading-spinner mx-auto mb-2"></div><div class="text-muted">è¼‰å…¥æ”¯å‡ºè¨˜éŒ„...</div></div>
          </div>
        </div>
        <div class="admin-only mt-4">
          <h6><i class="bi bi-graph-up me-2"></i>è²¡å‹™ç¸½è¦½ï¼ˆç®¡ç†å“¡ï¼‰</h6>
          <div class="row g-3">
            <div class="col-md-3"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="totalIncome">0</h3><p class="mb-0"><i class="bi bi-arrow-up-circle me-1"></i>ç¸½æ”¶å…¥</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="totalExpense">0</h3><p class="mb-0"><i class="bi bi-arrow-down-circle me-1"></i>ç¸½æ”¯å‡º</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="currentBalance">0</h3><p class="mb-0"><i class="bi bi-wallet2 me-1"></i>ç›®å‰é¤˜é¡</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="monthlyDonations">0</h3><p class="mb-0"><i class="bi bi-calendar-month me-1"></i>æœ¬æœˆææ¬¾</p></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ´»å‹•å›é¥‹ -->
    <div class="tab-pane fade" id="feedback">
      <div class="content-card">
        <h5><i class="bi bi-chat-dots me-2"></i>æ´»å‹•å›é¥‹</h5>
        <div class="card mb-4">
          <div class="card-header bg-primary text-white"><i class="bi bi-plus-circle me-2"></i>æ–°å¢å›é¥‹</div>
          <div class="card-body">
            <form id="feedbackForm" class="row g-3">
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="feedbackActivity" name="activityId" required>
                    <option value="">è«‹é¸æ“‡æ´»å‹•</option>
                  </select>
                  <label for="feedbackActivity">æ´»å‹• *</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="feedbackRating" name="rating" required>
                    <option value="">è©•åˆ†</option>
                    <option value="5">5 - éå¸¸æ»¿æ„</option>
                    <option value="4">4 - æ»¿æ„</option>
                    <option value="3">3 - æ™®é€š</option>
                    <option value="2">2 - ä¸æ»¿æ„</option>
                    <option value="1">1 - éå¸¸ä¸æ»¿æ„</option>
                  </select>
                  <label for="feedbackRating">è©•åˆ† *</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <textarea class="form-control" style="height:120px" id="feedbackComment" name="comment" required></textarea>
                  <label for="feedbackComment">æ„è¦‹èˆ‡å»ºè­° *</label>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-primary" type="submit"><i class="bi bi-send me-1"></i>æäº¤å›é¥‹</button>
              </div>
            </form>
          </div>
        </div>
        <h6><i class="bi bi-chat-left-text me-2"></i>æˆ‘çš„å›é¥‹</h6>
          <div id="myFeedback">
            <div class="text-center py-4"><div class="loading-spinner mx-auto mb-2"></div><div class="text-muted">è¼‰å…¥å›é¥‹...</div></div>
          </div>
        <div class="admin-only mt-4">
          <h6><i class="bi bi-chat-square-dots me-2"></i>æ‰€æœ‰æ´»å‹•å›é¥‹ï¼ˆç®¡ç†å“¡ï¼‰</h6>
          <div id="allFeedback">
            <div class="text-center py-4"><div class="loading-spinner mx-auto mb-2"></div><div class="text-muted">è¼‰å…¥æ‰€æœ‰å›é¥‹...</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç³»çµ±ç®¡ç† -->
    <div class="tab-pane fade" id="admin">
      <div class="content-card">
        <h5><i class="bi bi-gear me-2"></i>ç³»çµ±ç®¡ç†</h5>
        <ul class="nav nav-tabs mb-3" id="adminTabs">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#adminMembers">æœƒå“¡</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#adminActivities">æ´»å‹•</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#adminFinance">è²¡å‹™</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#adminReceipts">æ”¶æ“š</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#adminSystem">ç³»çµ±</button></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="adminMembers">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">æœƒå“¡åˆ—è¡¨</h6>
              <button class="btn btn-outline-primary btn-sm" onclick="exportMembers()"><i class="bi bi-download me-1"></i>åŒ¯å‡º</button>
            </div>
            <div class="table-responsive" style="max-height:400px;">
              <table class="table table-hover table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th>å§“å</th><th>é¡åˆ¥</th><th>ç‹€æ…‹</th><th>åŠ å…¥æ—¥æœŸ</th><th>ææ¬¾</th><th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="memberList">
                  <tr><td colspan="6" class="text-center py-4 text-muted">è¼‰å…¥ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade" id="adminActivities">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">æ´»å‹•ç®¡ç†</h6>
              <button class="btn btn-success btn-sm" onclick="showNewActivityModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢</button>
            </div>
            <div id="adminActivityList" class="mt-2 small"></div>
          </div>
          <div class="tab-pane fade" id="adminFinance">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">äº¤æ˜“ç®¡ç†</h6>
              <button class="btn btn-outline-primary btn-sm" onclick="exportFinanceData()"><i class="bi bi-download me-1"></i>åŒ¯å‡º</button>
            </div>
            <div id="adminTransactionList" class="small"></div>
          </div>
          <div class="tab-pane fade" id="adminReceipts">
            <h6>æ”¶æ“šç®¡ç†</h6>
            <div id="adminReceiptsList" class="small"></div>
          </div>
          <div class="tab-pane fade" id="adminSystem">
            <h6>ç³»çµ±å·¥å…·</h6>
            <button class="btn btn-warning btn-sm me-2" onclick="triggerBackup()"><i class="bi bi-download me-1"></i>ç«‹å³å‚™ä»½</button>
            <button class="btn btn-info btn-sm" onclick="showSystemNotificationModal()"><i class="bi bi-megaphone me-1"></i>ç™¼é€é€šçŸ¥</button>
            <div id="systemInfo" class="mt-3 text-muted small"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modalContainer"></div>

  <script>
    /********************
     * åŸºæœ¬è¨­å®š
     ********************/
    const CONFIG = {
      LIFF_ID: '1656516134-k8rMQwnQ', // TODO: æ”¹æˆæ­£å¼ LIFF ID
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycbxCefktYCAzxzaLSjH8GQ6j5PXCSqF710DqaaQ1Ix8oiOFbK5yZOayBBEHox8FW-N-E/exec', // ä¾‹å¦‚: https://script.google.com/macros/s/xxx/exec
      API_KEY: 'AAbb8520258185202581'
    };

    let currentUser = null;
    let userProfile = null;
    let isAdmin = false;
    let allActivitiesCache = [];
    let myRegistrationsCache = [];

    /********************
     * å·¥å…·
     ********************/
    function formatDate(d){
      if(!d) return '-';
      const dt = new Date(d);
      if(isNaN(dt.getTime())) return '-';
      return dt.toLocaleDateString('zh-TW');
    }
    function formatDateTime(d){
      if(!d) return '-';
      const dt = new Date(d);
      if(isNaN(dt.getTime())) return '-';
      return dt.toLocaleString('zh-TW');
    }
    function formatCurrency(n){
      return new Intl.NumberFormat('zh-TW',{style:'currency', currency:'TWD', minimumFractionDigits:0}).format(Number(n)||0);
    }
    function showNotification(msg,type='success',duration=3000){
      const c=document.getElementById('notificationContainer');
      const n=document.createElement('div');
      n.className=`notification ${type}`;
      n.innerHTML=`<div class="d-flex justify-content-between align-items-start"><div style="white-space:pre-line;">${msg}</div><button style="background:none;border:none;font-size:18px;line-height:1;" onclick="this.closest('.notification').remove()">Ã—</button></div>`;
      c.appendChild(n);
      requestAnimationFrame(()=>n.classList.add('show'));
      setTimeout(()=>{ n.classList.remove('show'); setTimeout(()=>n.remove(),300); }, duration);
    }
    function setButtonLoading(btn,loading=true){
      if(!btn) return;
      if(loading){ btn.disabled=true; btn.classList.add('loading'); }
      else { btn.disabled=false; btn.classList.remove('loading'); }
    }
    function showTab(id){
      const btn=document.querySelector(`[data-bs-target="#${id}"]`);
      if(btn) btn.click();
    }

    /********************
     * API å‘¼å«
     ********************/
    async function callAPI(action, data = {}, retries=2){
      const payload = {
        action,
        apiKey: CONFIG.API_KEY,
        timestamp: Date.now(),
        ...data
      };
      for(let i=0;i<=retries;i++){
        try{
          const res = await fetch(CONFIG.API_BASE_URL,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const json = await res.json();
          if(json.success===false) throw new Error(json.message||'ä¼ºæœå™¨éŒ¯èª¤');
          return json;
        }catch(err){
          if(i===retries) throw err;
          await new Promise(r=>setTimeout(r,500*(i+1)));
        }
      }
    }

    /********************
     * LIFF åˆå§‹åŒ–
     ********************/
    async function initializeLiff(){
      try{
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if(!liff.isLoggedIn()){ liff.login(); return; }
        userProfile = await liff.getProfile();
        await loadUserData();
        await loadDashboard();
        showNotification('ç³»çµ±åˆå§‹åŒ–å®Œæˆ','success');
      }catch(e){
        console.error(e);
        showNotification('LIFF åˆå§‹åŒ–å¤±æ•—','error');
      }
    }
    function logoutLiff(){
      if(liff.isLoggedIn()){
        liff.logout();
        location.reload();
      }
    }

    /********************
     * ä½¿ç”¨è€…è³‡æ–™
     ********************/
    async function loadUserData(){
      try{
        const result = await callAPI('getUserInfo',{ lineId: userProfile.userId });
        if(result.data){
          currentUser = result.data;
          isAdmin = !!currentUser.isAdmin;
          updateUserInterface();
        }else{
          // å°šæœªè¨»å†Š
          document.getElementById('registrationSection').style.display='block';
          document.getElementById('profileSection').style.display='none';
        }
      }catch(e){
        console.warn('getUserInfo å¤±æ•—', e);
        document.getElementById('registrationSection').style.display='block';
        document.getElementById('profileSection').style.display='none';
      }
    }
    function updateUserInterface(){
      if(!currentUser) return;
      const userInfoBar=document.getElementById('userInfoBar');
      userInfoBar.style.display='inline-flex';
      document.getElementById('userName').textContent = currentUser.realName || currentUser.lineName || 'æœƒå“¡';
      document.getElementById('userRole').textContent = currentUser.memberType || 'æœƒå“¡';
      document.getElementById('userAvatar').textContent = (currentUser.realName || currentUser.lineName || '?').substring(0,1);
      // é¡¯ç¤º admin
      document.querySelectorAll('.admin-only').forEach(el=>el.classList.toggle('show', isAdmin));

      // åˆ‡æ›è¨»å†Š/å€‹è³‡
      document.getElementById('registrationSection').style.display='none';
      document.getElementById('profileSection').style.display='block';

      // å¡«å¯«å€‹è³‡
      document.getElementById('profileRealName').value = currentUser.realName || '';
      document.getElementById('lineName').value = currentUser.lineName || '';
      document.getElementById('phone').value = currentUser.phone || '';
      document.getElementById('email').value = currentUser.email || '';
      document.getElementById('birthday').value = currentUser.birthday || '';
      document.getElementById('profileMemberType').value = currentUser.memberType || 'æ”¯æŒè€…';
      document.getElementById('address').value = currentUser.address || '';
    }

    /********************
     * å„€è¡¨æ¿
     ********************/
    async function loadDashboard(){
      if(!userProfile) return;
      try{
        const res = await callAPI('getDashboardData',{ lineId: userProfile.userId });
        const d = res.data || {};
        const statsEl=document.getElementById('dashboardStats');
        statsEl.innerHTML = `
          <div class="col-md-3">
            <div class="stat-card"><h3>${d.totalActivities||0}</h3><p class="mb-0"><i class="bi bi-calendar-event me-1"></i>å¯å ±åæ´»å‹•</p></div>
          </div>
          <div class="col-md-3">
            <div class="stat-card" style="background:var(--info-gradient);"><h3>${d.myRegistrations||0}</h3><p class="mb-0"><i class="bi bi-clipboard-check me-1"></i>æˆ‘çš„å ±å</p></div>
          </div>
          <div class="col-md-3">
            <div class="stat-card" style="background:var(--warning-gradient);"><h3>${d.myVolunteerHours||0}</h3><p class="mb-0"><i class="bi bi-clock me-1"></i>å¿—å·¥æ™‚æ•¸</p></div>
          </div>
          <div class="col-md-3">
            <div class="stat-card" style="background:var(--danger-gradient);"><h3>${(d.myDonationAmount||0)}</h3><p class="mb-0"><i class="bi bi-heart-fill me-1"></i>ææ¬¾ç¸½é¡</p></div>
          </div>
        `;
        updateRecentActivity(d.recentActivity||[]);
      }catch(e){
        document.getElementById('dashboardStats').innerHTML = `<div class="col-12 text-danger text-center">è¼‰å…¥å¤±æ•—ï¼š${e.message}</div>`;
      }
    }
    function updateRecentActivity(activities){
      const container = document.getElementById('recentActivity');
      if(!activities.length){
        container.innerHTML = '<p class="text-muted small">æš«ç„¡æœ€è¿‘æ´»å‹•</p>';
        return;
      }
      container.innerHTML = activities.map(a=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <div class="fw-semibold">${a.title||''}</div>
              <div class="text-muted small mb-1">${a.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(a.date)}</small>
            </div>
            <span class="status-badge status-${(a.status||'').replace(/\s/g,'')}">${a.status||''}</span>
          </div>
        </div>
      `).join('');
    }

    /********************
     * è¨»å†Šè¡¨å–®
     ********************/
    document.getElementById('registrationForm').addEventListener('submit', async e=>{
      e.preventDefault();
      if(!userProfile) return;
      const formData = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        const res = await callAPI('registerUser',{
          lineId: userProfile.userId,
          lineName: userProfile.displayName,
          realName: formData.get('realName')?.trim(),
          memberType: formData.get('memberType')
        });
        showNotification('è¨»å†ŠæˆåŠŸ','success');
        await loadUserData();
        await refreshData();
      }catch(err){
        showNotification('è¨»å†Šå¤±æ•—ï¼š'+err.message,'error');
      }finally{
        setButtonLoading(btn,false);
      }
    });

    /********************
     * å€‹è³‡æ›´æ–°
     ********************/
    document.getElementById('profileForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const formData = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('updateProfile',{
          lineId: userProfile.userId,
          phone: formData.get('phone'),
          email: formData.get('email'),
          birthday: formData.get('birthday'),
          memberType: formData.get('memberType'),
          address: formData.get('address')
        });
        showNotification('å€‹äººè³‡æ–™å·²æ›´æ–°','success');
        await loadUserData();
      }catch(err){
        showNotification('æ›´æ–°å¤±æ•—ï¼š'+err.message,'error');
      }finally{
        setButtonLoading(btn,false);
      }
    });

    /********************
     * æ´»å‹•ç®¡ç†
     ********************/
    async function loadActivities(){
      try{
        const res = await callAPI('getActivities');
        allActivitiesCache = res.data || [];
        renderActivities(allActivitiesCache);
      }catch(e){
        document.getElementById('activitiesList').innerHTML = `<div class="text-danger text-center">è¼‰å…¥å¤±æ•—ï¼š${e.message}</div>`;
      }
    }
    function renderActivities(list){
      const el = document.getElementById('activitiesList');
      if(!list.length){
        el.innerHTML = '<p class="text-muted small text-center">ç›®å‰æ²’æœ‰æ´»å‹•</p>';
        return;
      }
      el.innerHTML = list.map(act=>`
        <div class="activity-item">
          <div class="row">
            <div class="col-md-8">
              <h6 class="mb-1">${act.title}</h6>
              <div class="text-muted small mb-1">${act.description||''}</div>
              <div class="text-muted small d-flex flex-wrap gap-3">
                <span><i class="bi bi-calendar me-1"></i>${formatDate(act.date)}</span>
                <span><i class="bi bi-clock me-1"></i>${act.time||''}</span>
                <span><i class="bi bi-geo-alt me-1"></i>${act.location||''}</span>
                <span><i class="bi bi-people me-1"></i>${act.currentCount}/${act.maxParticipants}</span>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <div class="mb-1">
                <span class="status-badge status-${(act.status||'').replace(/\s/g,'')}">${act.status}</span>
              </div>
              <div class="mb-2 fw-semibold text-primary">${formatCurrency(act.fee||0)}</div>
              ${
                (act.status==='é–‹æ”¾å ±å')
                ? `<button class="btn btn-primary btn-sm" onclick="registerActivity('${act.id}')"><i class="bi bi-plus-circle me-1"></i>å ±å</button>`
                : ``
              }
            </div>
          </div>
        </div>
      `).join('');
    }
    function filterActivities(){
      const status = document.getElementById('activityStatusFilter').value.trim();
      const date = document.getElementById('activityDateFilter').value;
      const kw = document.getElementById('activitySearchFilter').value.trim().toLowerCase();
      let filtered=[...allActivitiesCache];
      if(status) filtered = filtered.filter(a=>a.status===status);
      if(date) filtered = filtered.filter(a=>String(a.date).startsWith(date));
      if(kw) filtered = filtered.filter(a=>(a.title||'').toLowerCase().includes(kw)||(a.description||'').toLowerCase().includes(kw));
      renderActivities(filtered);
    }
    async function registerActivity(id){
      if(!currentUser){ showNotification('è«‹å…ˆå®Œæˆè¨»å†Š','warning'); return; }
      try{
        await callAPI('registerActivity',{ lineId: userProfile.userId, activityId: id });
        showNotification('æ´»å‹•å ±åæˆåŠŸ','success');
        await Promise.all([loadActivities(), loadMyRegistrations(), loadDashboard()]);
      }catch(e){
        showNotification('å ±åå¤±æ•—ï¼š'+e.message,'error');
      }
    }
    async function loadMyRegistrations(){
      if(!currentUser) return;
      try{
        const res = await callAPI('getMyRegistrations',{ lineId: userProfile.userId });
        myRegistrationsCache = res.data||[];
        const el=document.getElementById('myRegistrations');
        if(!myRegistrationsCache.length){
          el.innerHTML='<p class="text-muted small">å°šæœªå ±åä»»ä½•æ´»å‹•</p>';
          return;
        }
        el.innerHTML = myRegistrationsCache.map(r=>`
          <div class="activity-item">
            <div class="d-flex justify-content-between">
              <div>
                <div class="fw-semibold">${r.activityTitle}</div>
                <div class="text-muted small mb-1">${r.activityDescription||''}</div>
                <small class="text-muted">
                  <i class="bi bi-calendar me-1"></i>${formatDate(r.activityDate)}
                  <i class="bi bi-clock ms-2 me-1"></i>${formatDateTime(r.registrationTime)}
                </small>
              </div>
              <div class="text-end">
                <span class="status-badge status-${r.status}">${r.status}</span>
                ${
                  r.status==='å·²å ±å'
                  ? `<button class="btn btn-danger btn-sm mt-2" onclick="cancelRegistration('${r.id}')"><i class="bi bi-x-circle me-1"></i>å–æ¶ˆ</button>`
                  : ''
                }
              </div>
            </div>
          </div>
        `).join('');
      }catch(e){
        document.getElementById('myRegistrations').innerHTML=`<div class="text-danger small">è¼‰å…¥å¤±æ•—ï¼š${e.message}</div>`;
      }
    }
    async function cancelRegistration(regId){
      if(!confirm('ç¢ºå®šå–æ¶ˆï¼Ÿ')) return;
      try{
        await callAPI('cancelRegistration',{ lineId:userProfile.userId, registrationId: regId });
        showNotification('å·²å–æ¶ˆå ±å','success');
        await Promise.all([loadMyRegistrations(), loadActivities(), loadDashboard()]);
      }catch(e){
        showNotification('å–æ¶ˆå¤±æ•—ï¼š'+e.message,'error');
      }
    }

    /********************
     * å¿—å·¥ï¼ˆç¤ºä¾‹è³‡æ–™ç”±å¾Œç«¯å‡è³‡æ–™ï¼‰
     ********************/
    async function loadVolunteerData(){
      if(!currentUser) return;
      try{
        const res = await callAPI('getVolunteerData',{ lineId:userProfile.userId });
        const d=res.data||{};
        document.getElementById('volunteerHours').textContent = d.stats?.totalHours||0;
          document.getElementById('volunteerActivities').textContent = d.stats?.totalActivities||0;
          document.getElementById('volunteerRank').textContent = d.stats?.rank||'-';
          document.getElementById('availableNeeds').textContent = d.stats?.availableNeeds||0;
          const needsEl=document.getElementById('volunteerNeeds');
          if(!d.needs||!d.needs.length){
            needsEl.innerHTML='<p class="text-muted small">ç›®å‰æ²’æœ‰å¿—å·¥éœ€æ±‚</p>';
          }else{
            needsEl.innerHTML=d.needs.map(n=>`
              <div class="activity-item">
                <div class="d-flex justify-content-between">
                  <div>
                    <div class="fw-semibold">${n.title}</div>
                    <div class="text-muted small mb-1">${n.description||''}</div>
                    <div class="text-muted small">
                      <i class="bi bi-calendar me-1"></i>${formatDate(n.date)}
                      <i class="bi bi-clock ms-3 me-1"></i>${n.time||''}
                      <i class="bi bi-award ms-3 me-1"></i>${n.hours} å°æ™‚
                    </div>
                  </div>
                  <div>
                    <span class="status-badge status-${n.status}">${n.status}</span><br>
                    ${
                      n.status==='é–‹æ”¾å ±å'
                      ? `<button class="btn btn-success btn-sm mt-2" onclick="applyVolunteer('${n.id}')"><i class="bi bi-hand-thumbs-up me-1"></i>å ±å</button>`
                      : ''
                    }
                  </div>
                </div>
              </div>
            `).join('');
          }
          const recEl=document.getElementById('myVolunteerRecords');
          if(!d.records||!d.records.length){
            recEl.innerHTML='<p class="text-muted small">å°šç„¡å¿—å·¥è¨˜éŒ„</p>';
          }else{
            recEl.innerHTML=d.records.map(r=>`
              <div class="activity-item">
                <div class="d-flex justify-content-between">
                  <div>
                    <div class="fw-semibold">${r.title}</div>
                    <div class="text-muted small mb-1">${r.description||''}</div>
                    <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(r.date)}  <i class="bi bi-clock ms-2 me-1"></i>${r.hours} å°æ™‚</small>
                  </div>
                  <span class="status-badge status-${r.status}">${r.status}</span>
                </div>
              </div>
            `).join('');
          }
      }catch(e){
        showNotification('å¿—å·¥è³‡æ–™è¼‰å…¥å¤±æ•—ï¼š'+e.message,'error');
      }
    }
    async function applyVolunteer(id){
      if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
      try{
        await callAPI('applyVolunteer',{ lineId:userProfile.userId, needId:id });
        showNotification('å¿—å·¥å ±åæˆåŠŸ','success');
        loadVolunteerData();
      }catch(e){
        showNotification('å ±åå¤±æ•—ï¼š'+e.message,'error');
      }
    }

    /********************
     * è²¡å‹™
     ********************/
    async function loadFinanceData(){
      if(!currentUser) return;
      try{
        const res=await callAPI('getFinanceData',{ lineId:userProfile.userId });
        const s=res.data?.stats||{};
        document.getElementById('myDonationAmount').textContent = (s.totalDonation||0);
        document.getElementById('myDonationCount').textContent = s.donationCount||0;
        document.getElementById('myExpenseAmount').textContent = (s.totalExpense||0);
        document.getElementById('pendingExpenses').textContent = s.pendingExpenses||0;

        if(isAdmin && res.data?.adminStats){
          document.getElementById('totalIncome').textContent = res.data.adminStats.totalIncome||0;
          document.getElementById('totalExpense').textContent = res.data.adminStats.totalExpense||0;
          document.getElementById('currentBalance').textContent = res.data.adminStats.currentBalance||0;
          document.getElementById('monthlyDonations').textContent = res.data.adminStats.monthlyDonations||0;
        }

        renderDonationHistory(res.data?.donations||[]);
        renderExpenseHistory(res.data?.expenses||[]);
      }catch(e){
        showNotification('è²¡å‹™è³‡æ–™è¼‰å…¥å¤±æ•—ï¼š'+e.message,'error');
      }
    }
    function renderDonationHistory(list){
      const el=document.getElementById('donationHistory');
      if(!list.length){ el.innerHTML='<p class="text-muted small">å°šç„¡ææ¬¾</p>'; return;}
      el.innerHTML = list.map(d=>`
        <div class="transaction-item">
          <div class="d-flex justify-content-between">
            <div>
              <div class="fw-semibold">ææ¬¾ - ${d.category}</div>
              <div class="text-muted small mb-1">${d.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(d.date)}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold text-success">${formatCurrency(d.amount)}</div>
              <small class="text-muted">æ”¶æ“šï¼š${d.receiptNumber||'è™•ç†ä¸­'}</small>
            </div>
          </div>
        </div>
      `).join('');
    }
    function renderExpenseHistory(list){
      const el=document.getElementById('expenseHistory');
      if(!list.length){ el.innerHTML='<p class="text-muted small">å°šç„¡æ”¯å‡ºç”³è«‹</p>'; return;}
      el.innerHTML = list.map(x=>`
        <div class="transaction-item">
          <div class="d-flex justify-content-between">
            <div>
              <div class="fw-semibold">æ”¯å‡ºç”³è«‹ - ${x.category}</div>
              <div class="text-muted small mb-1">${x.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(x.date)}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold text-danger">${formatCurrency(x.amount)}</div>
              <span class="status-badge status-${x.status}">${x.status}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    /********************
     * ææ¬¾ / æ”¯å‡º Modal
     ********************/
    function showNewDonationModal(){
      if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
      const html=`
        <div class="modal fade" id="donationModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <form id="donationForm">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>æ„›å¿ƒææ¬¾</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="form-floating mb-3">
                    <select class="form-select" id="donationCategory" name="category" required>
                      <option value="">é¸æ“‡é¡åˆ¥</option>
                      <option value="ä¸€èˆ¬ææ¬¾">ä¸€èˆ¬ææ¬¾</option>
                      <option value="æ´»å‹•è´ŠåŠ©">æ´»å‹•è´ŠåŠ©</option>
                      <option value="è¨­å‚™è³¼ç½®">è¨­å‚™è³¼ç½®</option>
                      <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                    <label for="donationCategory">ææ¬¾é¡åˆ¥ *</label>
                  </div>
                  <div class="form-floating mb-3">
                    <input type="number" class="form-control" id="donationAmount" name="amount" min="1" required>
                    <label for="donationAmount">é‡‘é¡ *</label>
                  </div>
                  <div class="form-floating mb-3">
                    <textarea class="form-control" style="height:100px" id="donationDescription" name="description"></textarea>
                    <label for="donationDescription">å‚™è¨»</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="needReceipt" name="needReceipt" checked>
                    <label for="needReceipt" class="form-check-label">éœ€è¦æ”¶æ“š</label>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                  <button type="submit" class="btn btn-success"><i class="bi bi-heart-fill me-1"></i>ç¢ºèª</button>
                </div>
              </form>
            </div>
          </div>
        </div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const modal=new bootstrap.Modal(document.getElementById('donationModal'));
      modal.show();
      document.getElementById('donationForm').addEventListener('submit', async ev=>{
        ev.preventDefault();
        const fd=new FormData(ev.target);
          const btn=ev.target.querySelector('button[type="submit"]');
          setButtonLoading(btn,true);
          try{
            await callAPI('createDonation',{
              lineId: userProfile.userId,
              category: fd.get('category'),
              amount: Number(fd.get('amount')),
              description: fd.get('description'),
              needReceipt: document.getElementById('needReceipt').checked
            });
            showNotification('ææ¬¾æˆåŠŸï¼Œæ„Ÿè¬æ‚¨çš„æ”¯æŒ','success');
            modal.hide();
            loadFinanceData();
            loadDashboard();
          }catch(e){
            showNotification('ææ¬¾å¤±æ•—ï¼š'+e.message,'error');
          }finally{
            setButtonLoading(btn,false);
          }
      });
    }

    function showNewExpenseModal(){
      if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
      const html=`
        <div class="modal fade" id="expenseModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <form id="expenseForm">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>æ”¯å‡ºç”³è«‹</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="form-floating mb-3">
                    <select class="form-select" id="expenseCategory" name="category" required>
                      <option value="">é¸æ“‡é¡åˆ¥</option>
                      <option value="æ´»å‹•ç¶“è²»">æ´»å‹•ç¶“è²»</option>
                      <option value="å™¨æè€—æ">å™¨æè€—æ</option>
                      <option value="è¡Œæ”¿æ”¯å‡º">è¡Œæ”¿æ”¯å‡º</option>
                      <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                    <label for="expenseCategory">æ”¯å‡ºé¡åˆ¥ *</label>
                  </div>
                  <div class="form-floating mb-3">
                    <input type="number" class="form-control" id="expenseAmount" name="amount" min="1" required>
                    <label for="expenseAmount">é‡‘é¡ *</label>
                  </div>
                  <div class="form-floating mb-3">
                    <textarea class="form-control" style="height:100px" id="expenseDescription" name="description" required></textarea>
                    <label for="expenseDescription">ç”¨é€”èªªæ˜ *</label>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                  <button type="submit" class="btn btn-warning"><i class="bi bi-send me-1"></i>æäº¤</button>
                </div>
              </form>
            </div>
          </div>
        </div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const modal=new bootstrap.Modal(document.getElementById('expenseModal'));
      modal.show();
      document.getElementById('expenseForm').addEventListener('submit', async ev=>{
        ev.preventDefault();
        const fd=new FormData(ev.target);
        const btn=ev.target.querySelector('button[type="submit"]');
        setButtonLoading(btn,true);
        try{
          await callAPI('createExpense',{
            lineId: userProfile.userId,
            category: fd.get('category'),
            amount: Number(fd.get('amount')),
            description: fd.get('description')
          });
          showNotification('æ”¯å‡ºç”³è«‹å·²é€å‡º','success');
          modal.hide();
          loadFinanceData();
        }catch(e){
          showNotification('ç”³è«‹å¤±æ•—ï¼š'+e.message,'error');
        }finally{
          setButtonLoading(btn,false);
        }
      });
    }

    /********************
     * æ´»å‹•æ–°å¢ (Admin)
     ********************/
    function showNewActivityModal(){
      if(!isAdmin){ showNotification('æ‚¨ç„¡æ¬Šé™','warning'); return; }
      const html=`
        <div class="modal fade" id="activityModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <form id="activityForm">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>æ–°å¢æ´»å‹•</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body row g-3">
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" class="form-control" id="actTitle" name="title" required>
                      <label for="actTitle">æ¨™é¡Œ *</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="date" class="form-control" id="actDate" name="date" required>
                      <label for="actDate">æ—¥æœŸ *</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="text" class="form-control" id="actTime" name="time" placeholder="14:00-16:00" required>
                      <label for="actTime">æ™‚é–“ *</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" class="form-control" id="actLocation" name="location" required>
                      <label for="actLocation">åœ°é» *</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="number" class="form-control" id="actFee" name="fee" min="0" value="0" required>
                      <label for="actFee">è²»ç”¨</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <input type="number" class="form-control" id="actMax" name="maxParticipants" min="1" value="20" required>
                      <label for="actMax">äººæ•¸ä¸Šé™ *</label>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-floating">
                      <textarea class="form-control" style="height:120px" id="actDesc" name="description" required></textarea>
                      <label for="actDesc">æè¿° *</label>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                  <button type="submit" class="btn btn-success"><i class="bi bi-save me-1"></i>å»ºç«‹</button>
                </div>
              </form>
            </div>
          </div>
        </div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const modal=new bootstrap.Modal(document.getElementById('activityModal'));
      modal.show();
      document.getElementById('activityForm').addEventListener('submit', async ev=>{
        ev.preventDefault();
        const fd=new FormData(ev.target);
        const btn=ev.target.querySelector('button[type="submit"]');
        setButtonLoading(btn,true);
        try{
          await callAPI('createActivity',{
            lineId: userProfile.userId,
            title: fd.get('title'),
            description: fd.get('description'),
            date: fd.get('date'),
            time: fd.get('time'),
            location: fd.get('location'),
            fee: Number(fd.get('fee')),
            maxParticipants: Number(fd.get('maxParticipants'))
          });
          showNotification('æ´»å‹•å»ºç«‹æˆåŠŸ','success');
          modal.hide();
          loadActivities();
          loadDashboard();
          if(isAdmin) loadAdminData();
        }catch(e){
          showNotification('å»ºç«‹å¤±æ•—ï¼š'+e.message,'error');
        }finally{
          setButtonLoading(btn,false);
        }
      });
    }

    /********************
     * å›é¥‹
     ********************/
    async function loadFeedbackData(){
      if(!currentUser) return;
      try{
        const acts = await callAPI('getMyCompletedActivities',{ lineId:userProfile.userId });
        const select=document.getElementById('feedbackActivity');
        select.innerHTML='<option value="">è«‹é¸æ“‡æ´»å‹•</option>';
        (acts.data||[]).forEach(a=>{
          select.innerHTML+=`<option value="${a.id}">${a.title} (${formatDate(a.date)})</option>`;
        });

        const myFb = await callAPI('getMyFeedback',{ lineId:userProfile.userId });
        renderMyFeedback(myFb.data||[]);

        if(isAdmin){
          const allFb = await callAPI('getAllFeedback',{ lineId:userProfile.userId });
          renderAllFeedback(allFb.data||[]);
        }
      }catch(e){
        showNotification('å›é¥‹è³‡æ–™è¼‰å…¥å¤±æ•—ï¼š'+e.message,'error');
      }
    }
    function renderMyFeedback(list){
      const el=document.getElementById('myFeedback');
      if(!list.length){ el.innerHTML='<p class="text-muted small">å°šæœªæäº¤å›é¥‹</p>'; return;}
      el.innerHTML=list.map(f=>`
        <div class="activity-item">
          <div class="fw-semibold">${f.activityTitle}</div>
          <div class="text-warning" style="font-size:14px;">${'â˜…'.repeat(f.rating)}${'â˜†'.repeat(5-f.rating)} <span class="text-muted ms-2">(${f.rating}/5)</span></div>
          <div class="small mb-1">${f.comment||''}</div>
          <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(f.createdAt)}</small>
        </div>
      `).join('');
    }
    function renderAllFeedback(list){
      const el=document.getElementById('allFeedback');
      if(!list.length){ el.innerHTML='<p class="text-muted small">å°šç„¡ä»»ä½•å›é¥‹</p>'; return;}
      el.innerHTML=list.map(f=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <div class="fw-semibold">${f.activityTitle} <small class="text-muted">/${f.userName||'åŒ¿å'}</small></div>
              <div class="text-warning" style="font-size:14px;">${'â˜…'.repeat(f.rating)}${'â˜†'.repeat(5-f.rating)}</div>
              <div class="small mb-1">${f.comment||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(f.createdAt)}</small>
            </div>
          </div>
        </div>
      `).join('');
    }
    document.getElementById('feedbackForm').addEventListener('submit', async e=>{
      e.preventDefault();
      if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
      const fd=new FormData(e.target);
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('createFeedback',{
          lineId: userProfile.userId,
          activityId: fd.get('activityId'),
          rating: Number(fd.get('rating')),
          comment: fd.get('comment')
        });
        showNotification('å·²æäº¤å›é¥‹ï¼Œæ„Ÿè¬æ‚¨çš„æ„è¦‹','success');
        e.target.reset();
        loadFeedbackData();
      }catch(err){
        showNotification('æäº¤å¤±æ•—ï¼š'+err.message,'error');
      }finally{
        setButtonLoading(btn,false);
      }
    });

    /********************
     * Admin è³‡æ–™ï¼ˆæœƒå“¡ / æ´»å‹• / è²¡å‹™ / æ”¶æ“šï¼‰
     ********************/
    async function loadAdminData(){
      if(!isAdmin) return;
      try{
        const res = await callAPI('getAdminData',{ lineId:userProfile.userId });
        updateMemberList(res.data?.members||[]);
        updateAdminActivityList(res.data?.activities||[]);
        updateTransactionList(res.data?.transactions?.combined||[]);
        updateReceiptList(res.data?.receipts||[]);
      }catch(e){
        showNotification('ç®¡ç†è³‡æ–™è¼‰å…¥å¤±æ•—ï¼š'+e.message,'error');
      }
    }
    function updateMemberList(members){
      const tbody=document.getElementById('memberList');
      if(!members.length){ tbody.innerHTML='<tr><td colspan="6" class="text-center text-muted small">æš«ç„¡æœƒå“¡è³‡æ–™</td></tr>'; return;}
      tbody.innerHTML = members.map(m=>`
        <tr>
          <td>${m.realName||m.lineName||'-'}</td>
          <td>${m.memberType||'-'}</td>
          <td><span class="status-badge status-å·²è¨»å†Š">å·²è¨»å†Š</span></td>
          <td>${formatDate(m.joinDate)}</td>
          <td>${m.donationCount||0}</td>
          <td><button class="btn btn-sm btn-outline-primary" onclick="viewMemberDetail('${m.lineId}')"><i class="bi bi-eye"></i></button></td>
        </tr>
      `).join('');
    }
    function updateAdminActivityList(list){
      const el=document.getElementById('adminActivityList');
      if(!list.length){ el.innerHTML='<p class="text-muted small">å°šç„¡æ´»å‹•</p>'; return;}
      el.innerHTML=list.map(a=>`
        <div class="border rounded p-2 mb-2">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${a.title}</strong>
              <div class="text-muted small">${formatDate(a.date)} ${a.time||''} / ${a.location||''}</div>
            </div>
            <div class="text-end">
              <span class="status-badge status-${(a.status||'').replace(/\s/g,'')}">${a.status}</span><br>
              <button class="btn btn-sm btn-outline-secondary mt-2" onclick="editActivity('${a.id}')"><i class="bi bi-pencil"></i></button>
            </div>
          </div>
        </div>
      `).join('');
    }
    function updateTransactionList(list){
      const el=document.getElementById('adminTransactionList');
      if(!list.length){ el.innerHTML='<p class="text-muted small">å°šç„¡äº¤æ˜“</p>'; return;}
      el.innerHTML = list.slice(0,100).map(t=>`
        <div class="border rounded p-2 mb-2 d-flex justify-content-between">
          <div>
            <div class="fw-semibold">${t.type==='æ”¶å…¥'?'ææ¬¾':'æ”¯å‡º'} - ${t.category}</div>
            <div class="text-muted small">${t.description||''}</div>
            <small class="text-muted">${formatDateTime(t.date)}</small>
          </div>
          <div class="text-end">
            <div class="${t.type==='æ”¶å…¥'?'text-success':'text-danger'} fw-bold">${formatCurrency(t.amount)}</div>
            <small class="text-muted">${t.status||''}</small>
          </div>
        </div>
      `).join('');
    }
    function updateReceiptList(list){
      const el=document.getElementById('adminReceiptsList');
      if(!list.length){ el.innerHTML='<p class="text-muted small">å°šç„¡æ”¶æ“š</p>'; return;}
      el.innerHTML = list.map(r=>`
        <div class="border rounded p-2 mb-2 d-flex justify-content-between">
          <div>
            <strong>${r.receiptNumber||'è™•ç†ä¸­'}</strong>
            <div class="text-muted small">${formatDate(r.date)} / ${r.lineId}</div>
          </div>
          <div class="text-end">
            <span class="status-badge status-${r.status}">${r.status}</span><br>
            <span class="fw-bold text-success">${formatCurrency(r.amount)}</span>
          </div>
        </div>
      `).join('');
    }

    /********************
     * å…¶ä»– Admin å‹•ä½œ
     ********************/
    function exportMembers(){ showNotification('åŒ¯å‡ºåŠŸèƒ½å°šæœªå¯¦ä½œ','warning'); }
    function exportFinanceData(){ showNotification('åŒ¯å‡ºåŠŸèƒ½å°šæœªå¯¦ä½œ','warning'); }
    function editActivity(id){ showNotification('æ´»å‹•ç·¨è¼¯å°šæœªå¯¦ä½œ: '+id,'info'); }
    function viewMemberDetail(lineId){ showNotification('æœƒå“¡è©³æƒ…å°šæœªå¯¦ä½œ: '+lineId,'info'); }
    function showNewVolunteerNeedModal(){ showNotification('å¿—å·¥éœ€æ±‚å»ºç«‹å°šæœªå¯¦ä½œ','warning'); }
    function showSystemNotificationModal(){ showNotification('ç³»çµ±é€šçŸ¥å°šæœªå¯¦ä½œ','warning'); }
    async function triggerBackup(){
      if(!isAdmin) return;
      try{
        const res=await callAPI('backupSystem',{ lineId:userProfile.userId });
        showNotification('å‚™ä»½å®Œæˆ','success');
        document.getElementById('systemInfo').textContent='æœ€å¾Œå‚™ä»½ï¼š'+res.data?.timestamp;
      }catch(e){
        showNotification('å‚™ä»½å¤±æ•—ï¼š'+e.message,'error');
      }
    }

    /********************
     * å›é¥‹ - å…¨éƒ¨åˆ—è¡¨ (admin ç”± renderAllFeedback å¯¦ä½œ)
     ********************/
    function renderSystemInfo(info){
      document.getElementById('systemInfo').textContent = JSON.stringify(info||{},null,2);
    }

    /********************
     * å›é¥‹äº‹ä»¶
     ********************/
    function updateAllFeedback(list){
      // å·²ç¶“ç”± renderAllFeedback è™•ç†ï¼ˆåç¨±å…¼å®¹ï¼‰
      renderAllFeedback(list);
    }

    /********************
     * è³‡æ–™åˆ·æ–°
     ********************/
    async function refreshData(){
      const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
      setButtonLoading(refreshBtn,true);
      try{
        await Promise.all([
          loadDashboard(),
          loadActivities(),
          loadMyRegistrations(),
          loadVolunteerData(),
          loadFinanceData(),
          loadFeedbackData(),
          isAdmin ? loadAdminData() : Promise.resolve()
        ]);
        showNotification('è³‡æ–™å·²åˆ·æ–°','success');
      }catch(e){
        showNotification('åˆ·æ–°å¤±æ•—ï¼š'+e.message,'error');
      }finally{
        setButtonLoading(refreshBtn,false);
      }
    }

    /********************
     * Tab äº‹ä»¶
     ********************/
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('[data-bs-toggle="pill"]').forEach(btn=>{
        btn.addEventListener('shown.bs.tab', e=>{
          const id=e.target.getAttribute('data-bs-target').substring(1);
          switch(id){
            case 'activities':
              loadActivities(); loadMyRegistrations(); break;
            case 'volunteer':
              loadVolunteerData(); break;
            case 'finance':
              loadFinanceData(); break;
            case 'feedback':
              loadFeedbackData(); break;
            case 'admin':
              if(isAdmin) loadAdminData(); break;
          }
        });
      });
      initializeLiff();
    });

    // é˜²æ­¢ Enter è‡ªå‹•é€å‡ºéé æœŸè¡¨å–®
    document.addEventListener('keydown', e=>{
      if(e.key==='Enter' && e.target.tagName!=='TEXTAREA' && e.target.tagName!=='BUTTON'){
        e.preventDefault();
      }
    });

    /********************
     * å°å¤– (å…¨åŸŸ)
     ********************/
    window.showTab = showTab;
    window.refreshData = refreshData;
    window.registerActivity = registerActivity;
    window.cancelRegistration = cancelRegistration;
    window.applyVolunteer = applyVolunteer;
    window.showNewActivityModal = showNewActivityModal;
    window.showNewDonationModal = showNewDonationModal;
    window.showNewExpenseModal = showNewExpenseModal;
    window.filterActivities = filterActivities;
    window.logoutLiff = logoutLiff;
  </script>
</body>
</html>
