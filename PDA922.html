<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>病友會系統（LIFF 前端）</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      :root{
        --bg:#0f172a;
        --panel:#111827;
        --muted:#94a3b8;
        --text:#e5e7eb;
        --primary:#22c55e;
        --primary-600:#16a34a;
        --danger:#ef4444;
        --warning:#f59e0b;
        --card:#0b1220;
        --border:#1f2937;
      }
      *{ box-sizing: border-box; }
      body{
        margin:0; background:linear-gradient(180deg,#0b1220,#0a0f1d);
        color:var(--text); font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
        min-height:100vh; display:flex; flex-direction:column;
      }
      header{
        position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
        background:rgba(11,18,32,.75); border-bottom:1px solid var(--border);
      }
      .wrap{ max-width:1100px; margin:0 auto; padding:16px; width:100%; }
      h1{ font-size:20px; margin:0 0 12px; display:flex; gap:8px; align-items:center; }
      h2{ font-size:18px; margin:16px 0 8px; }
      h3{ font-size:16px; margin:16px 0 8px; color:var(--muted); }
      .topbar{
        display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:8px; align-items:end;
      }
      .userbar{
        display:flex; align-items:center; gap:10px; margin-top:8px;
      }
      .avatar{ width:36px; height:36px; border-radius:999px; background:#1f2937; overflow:hidden; }
      .avatar img{ width:100%; height:100%; object-fit:cover; }
      .pill{
        font-size:12px; border:1px solid var(--border); padding:2px 8px; border-radius:999px; color:var(--muted);
      }
      label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
      input, select, textarea{
        width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
        background:rgba(255,255,255,.02); color:var(--text); outline:none;
      }
      textarea{ min-height:90px; resize:vertical; }
      .btn{
        appearance:none; border:none; border-radius:12px; padding:10px 14px;
        color:white; background:var(--primary); cursor:pointer; white-space:nowrap;
      }
      .btn:hover{ background:var(--primary-600); }
      .btn.secondary{ background:#334155; }
      .btn.danger{ background:var(--danger); }
      .btn.warning{ background:var(--warning); color:#111; }
      .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
      .tab{
        padding:8px 12px; border-radius:999px; border:1px solid var(--border);
        background:rgba(255,255,255,.03); color:var(--text); cursor:pointer; user-select:none;
      }
      .tab.active{ background:rgba(34,197,94,.15); border-color:#14532d; }
      main{ flex:1; }
      .sections{ padding:16px 0 32px; }
      .section{ display:none; }
      .section.active{ display:block; }
      .grid{
        display:grid; gap:12px;
      }
      @media(min-width:900px){
        .grid.cols-2{ grid-template-columns: 1fr 1fr; }
        .grid.cols-3{ grid-template-columns: repeat(3,1fr); }
      }
      .card{
        background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
        border:1px solid var(--border);
        border-radius:16px; padding:14px;
      }
      .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
      .right{ margin-left:auto; }
      .muted{ color:var(--muted); }
      .kpi{ display:flex; align-items:baseline; gap:8px; }
      .kpi .v{ font-size:22px; font-weight:700; }
      table{ width:100%; border-collapse: collapse; }
      th, td{ text-align:left; border-bottom:1px solid var(--border); padding:8px; }
      th{ color:var(--muted); font-weight:500; }
      tr:hover td{ background:rgba(255,255,255,.02); }
      .toast{
        position:fixed; left:50%; transform:translateX(-50%);
        bottom:20px; padding:10px 14px; border-radius:12px; background:#111827; color:#e5e7eb;
        border:1px solid var(--border); box-shadow:0 8px 30px rgba(0,0,0,.35); display:none; z-index:999;
        max-width:90%; word-break: break-word;
      }
      .toast.show{ display:block; }
      .small{ font-size:12px; }
      .spacer{ height:10px; }
      .hint{ font-size:12px; color:var(--muted); }
      .soft{ background:rgba(255,255,255,.02); border-radius:12px; padding:10px; }
      .list{ display:flex; flex-direction:column; gap:10px; }
      .badge{ background:#1f2937; color:#e5e7eb; border-radius:8px; padding:2px 8px; font-size:12px; }
      .center{ text-align:center; }
      .nowrap{ white-space:nowrap; }
      .dim{ opacity:.6; pointer-events:none; }
    </style>
  </head>
  <body>
    <header>
      <div class="wrap">
        <h1>台灣帕金森病友會 系統（LIFF）</h1>

        <div class="userbar">
          <div class="avatar" id="u-ava"></div>
          <div>
            <div id="u-name" class="row">
              <span class="muted">尚未登入</span>
            </div>
            <div class="small muted">
              <span id="u-id" class="pill">lineId: -</span>
              <span id="u-client" class="pill">Client: -</span>
            </div>
          </div>
          <div class="right row">
            <button class="btn secondary" id="btnLiffLogin" style="display:none;">登入</button>
            <button class="btn secondary" id="btnLiffLogout" style="display:none;">登出</button>
            <button class="btn" id="btnReload" title="重新整理資料" style="display:none;">重新整理</button>
          </div>
        </div>

        <div class="topbar">
          <div>
            <label>API_BASE（GAS Web App URL）</label>
            <input id="apiBase" placeholder="https://script.google.com/macros/s/xxx/exec" />
          </div>
          <div>
            <label>API_KEY（若後端有啟用）</label>
            <input id="apiKey" placeholder="可留空（若為 DEV_KEY 或未設定）" />
          </div>
          <div>
            <label>lineId（由 LIFF 自動取得，唯讀）</label>
            <input id="lineId" readonly />
          </div>
          <div class="row">
            <button class="btn" id="btnSaveConfig">儲存設定</button>
          </div>
        </div>

        <div class="tabs" id="tabs" style="display:none;">
          <div class="tab active" data-tab="profile">會員資料</div>
          <div class="tab" data-tab="activities">活動</div>
          <div class="tab" data-tab="volunteer">志工</div>
          <div class="tab" data-tab="finance">財務與收據</div>
          <div class="tab" data-tab="feedback">活動回饋</div>
          <div class="tab" data-tab="admin" id="tab-admin" style="display:none;">管理後台</div>
        </div>
      </div>
    </header>

    <main>
      <div class="wrap sections">
        <!-- Profile -->
        <section class="section active" id="sec-profile">
          <div class="grid cols-2">
            <div class="card">
              <h2>會員資料</h2>
              <div id="profileView" class="soft">
                <div class="muted">尚未載入</div>
              </div>
            </div>
            <div class="card">
              <h2>更新資料</h2>
              <div id="profileForm">
                <div class="grid">
                  <div><label>電話</label><input id="pf-phone" /></div>
                  <div><label>Email</label><input id="pf-email" /></div>
                  <div><label>生日（YYYY-MM-DD）</label><input id="pf-birthday" placeholder="1990-01-01" /></div>
                  <div><label>地址</label><input id="pf-address" /></div>
                  <div><label>會員類型</label><input id="pf-memberType" placeholder="病友 / 家屬 / 志工 ..." /></div>
                  <div><label>備註</label><input id="pf-notes" /></div>
                </div>
                <div class="spacer"></div>
                <button class="btn" id="btnUpdateProfile">儲存更新</button>
              </div>
            </div>
          </div>
          <div class="card" id="registerCard" style="display:none;">
            <h2>尚未註冊，請先建立會員</h2>
            <div class="grid cols-3">
              <div>
                <label>LINE 顯示名稱（自動帶入，可改）</label>
                <input id="reg-lineName" />
              </div>
              <div>
                <label>真實姓名（必填）</label>
                <input id="reg-realName" />
              </div>
              <div>
                <label>會員類型（必填）</label>
                <input id="reg-memberType" placeholder="病友 / 家屬 / 志工 ..." />
              </div>
            </div>
            <div class="spacer"></div>
            <button class="btn" id="btnRegister">立即註冊</button>
          </div>
        </section>

        <!-- Activities -->
        <section class="section" id="sec-activities">
          <div class="grid cols-2">
            <div class="card">
              <h2>活動列表</h2>
              <div id="actList" class="list"></div>
            </div>
            <div class="card">
              <h2>我的報名</h2>
              <div id="myRegs" class="list"></div>
            </div>
          </div>
        </section>

        <!-- Volunteer -->
        <section class="section" id="sec-volunteer">
          <div class="grid cols-2">
            <div class="card">
              <h2>志工需求</h2>
              <div id="volNeeds" class="list"></div>
            </div>
            <div class="card">
              <h2>我的志工紀錄</h2>
              <div id="volRecords" class="list"></div>
            </div>
          </div>
          <div class="card">
            <h3>統計</h3>
            <div class="row">
              <div class="kpi"><div class="v" id="k-totalHours">0</div><div>總時數</div></div>
              <div class="kpi"><div class="v" id="k-totalActivities">0</div><div>參與次數</div></div>
              <div class="kpi"><div class="v" id="k-availableNeeds">0</div><div>可報名</div></div>
            </div>
          </div>
        </section>

        <!-- Finance -->
        <section class="section" id="sec-finance">
          <div class="grid cols-2">
            <div class="card">
              <h2>我的資料統計</h2>
              <div class="row">
                <div class="kpi"><div class="v" id="fin-totalDonation">0</div><div>捐款總額</div></div>
                <div class="kpi"><div class="v" id="fin-donationCount">0</div><div>捐款次數</div></div>
                <div class="kpi"><div class="v" id="fin-totalExpense">0</div><div>支出總額</div></div>
                <div class="kpi"><div class="v" id="fin-pendingExpenses">0</div><div>待核支出</div></div>
              </div>
              <div class="spacer"></div>
              <div class="hint">管理員可於「管理後台」查看全站統計與交易列表。</div>
            </div>
            <div class="card">
              <h2>我的收據</h2>
              <table>
                <thead><tr><th>編號</th><th>類型</th><th>金額</th><th>日期</th><th>檔案</th></tr></thead>
                <tbody id="tb-receipts"></tbody>
              </table>
            </div>
          </div>

          <div class="grid cols-2">
            <div class="card">
              <h2>新增捐款</h2>
              <div class="grid">
                <div>
                  <label>捐款類別</label>
                  <input id="don-category" list="dl-income" placeholder="例如：一般捐款" />
                  <datalist id="dl-income">
                    <option value="一般捐款"></option>
                    <option value="活動贊助"></option>
                  </datalist>
                </div>
                <div>
                  <label>金額</label>
                  <input id="don-amount" type="number" min="1" />
                </div>
                <div>
                  <label>說明（可選）</label>
                  <input id="don-desc" />
                </div>
                <div class="row">
                  <label><input type="checkbox" id="don-needReceipt" /> 需要開立收據</label>
                </div>
                <button class="btn" id="btnDonate">送出捐款</button>
              </div>
            </div>

            <div class="card">
              <h2>新增支出申請</h2>
              <div class="grid">
                <div>
                  <label>支出類別</label>
                  <input id="exp-category" list="dl-expense" placeholder="例如：活動費用" />
                  <datalist id="dl-expense">
                    <option value="活動費用"></option>
                    <option value="行政支出"></option>
                    <option value="設備支出"></option>
                  </datalist>
                </div>
                <div>
                  <label>金額</label>
                  <input id="exp-amount" type="number" min="1" />
                </div>
                <div>
                  <label>說明（可選）</label>
                  <input id="exp-desc" />
                </div>
                <button class="btn" id="btnExpense">送出申請</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Feedback -->
        <section class="section" id="sec-feedback">
          <div class="grid cols-2">
            <div class="card">
              <h2>提交活動回饋</h2>
              <div class="grid">
                <div>
                  <label>活動（僅顯示已完成之活動）</label>
                  <select id="fb-activity"></select>
                </div>
                <div>
                  <label>評分（1~5）</label>
                  <select id="fb-rating">
                    <option value="5">5</option>
                    <option value="4">4</option>
                    <option value="3">3</option>
                    <option value="2">2</option>
                    <option value="1">1</option>
                  </select>
                </div>
                <div>
                  <label>回饋內容</label>
                  <textarea id="fb-comment" placeholder="寫下你的想法..."></textarea>
                </div>
                <button class="btn" id="btnFeedback">送出回饋</button>
              </div>
            </div>
            <div class="card">
              <h2>我的回饋</h2>
              <table>
                <thead><tr><th>活動</th><th>評分</th><th>內容</th><th>時間</th></tr></thead>
                <tbody id="tb-feedback"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Admin -->
        <section class="section" id="sec-admin">
          <div class="card">
            <h2>總覽</h2>
            <div id="admin-summary" class="muted">尚未載入</div>
          </div>

          <div class="grid cols-2">
            <div class="card">
              <h2>系統設定</h2>
              <div class="grid">
                <div>
                  <label>收據模板 Google Doc ID</label>
                  <input id="set-receiptTpl" placeholder="RECEIPT_TEMPLATE_DOC_ID" />
                </div>
                <div>
                  <label>支出憑證模板 Google Doc ID</label>
                  <input id="set-expenseTpl" placeholder="EXPENSE_VOUCHER_TEMPLATE_DOC_ID" />
                </div>
                <div>
                  <label>Email 回覆模板（HTML/純文字）</label>
                  <textarea id="set-emailTpl" placeholder="可換行，寄送收據時附在信尾"></textarea>
                </div>
                <div>
                  <label>收入分類（逗號分隔）</label>
                  <input id="set-incomeCats" placeholder="一般捐款, 活動贊助" />
                </div>
                <div>
                  <label>支出分類（逗號分隔）</label>
                  <input id="set-expenseCats" placeholder="活動費用, 行政支出, 設備支出" />
                </div>
                <div class="row">
                  <button class="btn" id="btnLoadSettings">讀取設定</button>
                  <button class="btn" id="btnSaveSettings">儲存設定</button>
                </div>
                <div class="hint">注意：更改後端設定需具管理員權限。</div>
              </div>
            </div>

            <div class="card">
              <h2>會員匯出</h2>
              <div class="row">
                <button class="btn" id="btnExportMembers">匯出 CSV</button>
                <div class="right" id="exportResult" class="muted"></div>
              </div>
            </div>
          </div>

          <div class="grid cols-2">
            <div class="card">
              <h2>建立活動</h2>
              <div class="grid">
                <div><label>標題</label><input id="adm-act-title" /></div>
                <div><label>日期（YYYY-MM-DD）</label><input id="adm-act-date" /></div>
                <div><label>時間</label><input id="adm-act-time" placeholder="14:00" /></div>
                <div><label>地點</label><input id="adm-act-loc" /></div>
                <div><label>名額</label><input id="adm-act-max" type="number" min="1" /></div>
                <div><label>報名費</label><input id="adm-act-fee" type="number" min="0" value="0" /></div>
                <div><label>描述</label><textarea id="adm-act-desc"></textarea></div>
                <button class="btn" id="btnCreateActivity">建立</button>
              </div>
            </div>
            <div class="card">
              <h2>建立志工需求</h2>
              <div class="grid">
                <div><label>標題</label><input id="adm-vol-title" /></div>
                <div><label>日期（YYYY-MM-DD）</label><input id="adm-vol-date" /></div>
                <div><label>時間</label><input id="adm-vol-time" /></div>
                <div><label>需要人數</label><input id="adm-vol-need" type="number" min="1" /></div>
                <div><label>時數</label><input id="adm-vol-hours" type="number" min="1" /></div>
                <div><label>描述</label><textarea id="adm-vol-desc"></textarea></div>
                <button class="btn" id="btnCreateVolNeed">建立</button>
              </div>
            </div>
          </div>

          <div class="grid cols-2">
            <div class="card">
              <h2>財務審核</h2>
              <div class="grid">
                <div class="soft">
                  <h3>核准/拒絕 支出</h3>
                  <div class="grid">
                    <div><label>支出 ID</label><input id="adm-exp-id" placeholder="至表單或試算表取得 ID" /></div>
                    <div>
                      <label>決策</label>
                      <select id="adm-exp-decision">
                        <option value="approve">核准</option>
                        <option value="reject">拒絕</option>
                      </select>
                    </div>
                    <div><label>付款日期</label><input id="adm-exp-payDate" placeholder="YYYY-MM-DD" /></div>
                    <div><label>付款帳戶</label><input id="adm-exp-account" /></div>
                    <div><label>付款方式</label><input id="adm-exp-method" placeholder="轉帳 / 現金 ..." /></div>
                    <div><label>銀行入帳日</label><input id="adm-exp-bankDate" placeholder="YYYY-MM-DD" /></div>
                    <button class="btn" id="btnApproveExpense">送出</button>
                  </div>
                  <div class="hint">若選「拒絕」，付款欄位可留空。</div>
                </div>

                <div class="soft">
                  <h3>確認收入（捐款入帳）</h3>
                  <div class="grid">
                    <div><label>捐款 ID</label><input id="adm-don-id" placeholder="至表單或試算表取得 ID" /></div>
                    <div><label>銀行入帳日</label><input id="adm-don-bankDate" placeholder="YYYY-MM-DD" /></div>
                    <div><label>入帳帳戶</label><input id="adm-don-account" /></div>
                    <button class="btn" id="btnConfirmIncome">確認</button>
                  </div>
                </div>

                <div class="soft">
                  <h3>手動開立收據</h3>
                  <div class="grid">
                    <div><label>對象 lineId</label><input id="adm-rct-target" /></div>
                    <div><label>類型</label>
                      <select id="adm-rct-type">
                        <option value="捐款">捐款</option>
                        <option value="其他">其他</option>
                      </select>
                    </div>
                    <div><label>金額</label><input id="adm-rct-amount" type="number" min="1" /></div>
                    <div><label>是否同時建立捐款紀錄（僅類型為捐款時有效）</label>
                      <select id="adm-rct-createDon">
                        <option value="true">是</option>
                        <option value="false">否</option>
                      </select>
                    </div>
                    <button class="btn" id="btnCreateManualReceipt">建立收據</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <h2>資料瀏覽</h2>
              <div class="hint">以下資料由 getAdminData 提供，僅作快速查核使用。</div>
              <h3>活動清單（含 ID）</h3>
              <table>
                <thead><tr><th>ID</th><th>標題</th><th>日期</th><th>狀態</th></tr></thead>
                <tbody id="adm-act-table"></tbody>
              </table>
              <div class="spacer"></div>
              <h3>收據</h3>
              <table>
                <thead><tr><th>編號</th><th>lineId</th><th>類型</th><th>金額</th><th>日期</th><th>狀態</th><th>PDF</th></tr></thead>
                <tbody id="adm-receipts"></tbody>
              </table>
              <div class="spacer"></div>
              <h3>交易（收入/支出）</h3>
              <table>
                <thead><tr><th>日期</th><th>類型</th><th>分類</th><th>金額</th><th>描述</th><th>狀態</th></tr></thead>
                <tbody id="adm-trans"></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </main>

    <div class="toast" id="toast"></div>

    <script>
      // ---- 請設定你的 LIFF_ID 與 API_BASE ----
      const CONFIG = {
        LIFF_ID: '1656516134-VaGgmaPm', // 例：165xxxx-xxxxx
        API_BASE: 'https://script.google.com/macros/s/AKfycbzJrta6n5bud25ypx7RF_rVvH9hUF2JUjv9ckIo-3paYCr1hfeHsezzDsil6vWHTF8/exec',            // 例：https://script.google.com/macros/s/xxxx/exec
        API_KEY: 'AAbb8520258185202581'              // 若 GAS 設為 DEV_KEY 或未設定，可留空
      };

      const $ = (sel)=> document.querySelector(sel);
      const $$= (sel)=> Array.from(document.querySelectorAll(sel));
      const state = {
        apiBase: '',
        apiKey: '',
        lineId: '',
        lineName: '',
        pictureUrl: '',
        isInClient: false,
        user: null,
        isAdmin: false,
        settings: null,
        cache: {},
        ready: false
      };

      function saveLocal(){
        localStorage.setItem('apiBase', state.apiBase);
        localStorage.setItem('apiKey', state.apiKey);
      }
      function loadLocal(){
        state.apiBase = localStorage.getItem('apiBase') || CONFIG.API_BASE || '';
        state.apiKey  = localStorage.getItem('apiKey')  || CONFIG.API_KEY || '';
        $('#apiBase').value = state.apiBase;
        $('#apiKey').value  = state.apiKey;
      }
      function toast(msg, type='info'){
        const t=$('#toast'); t.textContent = msg;
        t.className = 'toast show';
        if(type==='error'){ t.style.borderColor='#ef4444'; }
        else if(type==='warn'){ t.style.borderColor='#f59e0b'; }
        else { t.style.borderColor='var(--border)'; }
        setTimeout(()=>{ t.className='toast'; }, 2800);
      }

      function fmtDate(v, options){
        // options: { tz?: 'Asia/Taipei' | ... }
        const tz = (options && options.tz) || 'Asia/Taipei';

        function toDateFlexible(val){
          if(val === null || val === undefined || val === '') return null;

          // 已是 Date 物件
          if(val instanceof Date){
            return isNaN(val.getTime()) ? null : val;
          }

          // 數字：可能是毫秒、秒、或試算表序列值
          if(typeof val === 'number'){
            const n = val;

            // 試算表日期序列（1899-12-30），通常介於 25569（1970-01-01）之後
            // 範圍鬆一點以容許含時間的小數
            if(n > 25569 && n < 6000000){
              const ms = Math.round((n - 25569) * 86400 * 1000);
              return new Date(ms);
            }

            // 以數量級判斷秒/毫秒：小於 1e12 視為秒，否則視為毫秒
            return new Date(n < 1e12 ? n * 1000 : n);
          }

          // 字串：多種常見格式
          if(typeof val === 'string'){
            const s = val.trim();
            if(!s) return null;

            // 純數字字串：13 位(毫秒) / 10 位(秒) / 8 位(yyyyMMdd)
            if(/^\d{13}$/.test(s)) return new Date(parseInt(s,10));
            if(/^\d{10}$/.test(s)) return new Date(parseInt(s,10) * 1000);
            if(/^\d{8}$/.test(s)){
              const y=s.slice(0,4), m=s.slice(4,6), d=s.slice(6,8);
              return new Date(`${y}-${m}-${d}T00:00:00`);
            }

            // 常見日期格式：yyyy-MM-dd[ HH:mm[:ss]] 或 yyyy/MM/dd[ HH:mm[:ss]]
            let str = s.replace(/\//g,'-');
            if(/^\d{4}-\d{2}-\d{2}(?: \d{2}:\d{2}(?::\d{2})?)?$/.test(str)){
              str = str.replace(' ', 'T'); // Safari 對空白不友善，轉成 ISO T
              const d = new Date(str);
              if(!isNaN(d.getTime())) return d;
            }

            // 其他情況交給 Date 嘗試解析（含 ISO 8601）
            const d = new Date(s);
            if(!isNaN(d.getTime())) return d;
          }

          return null;
        }

        const d = toDateFlexible(v);
        if(!d) return '';

        // 使用 Intl 以指定時區組裝為 YYYY-MM-DD HH:mm
        const parts = new Intl.DateTimeFormat('zh-TW', {
          timeZone: tz,
          year:'numeric', month:'2-digit', day:'2-digit',
          hour:'2-digit', minute:'2-digit',
          hour12:false
        }).formatToParts(d);

        const map = {};
        parts.forEach(p => map[p.type] = p.value);
        const yyyy = map.year;
        const mm   = map.month;
        const dd   = map.day;
        const hh   = map.hour;
        const mi   = map.minute;

        return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
      }


      function money(n){ n=Number(n||0); return n.toLocaleString('zh-TW'); }

      async function api(action, payload={}){
        if(!state.apiBase) throw new Error('尚未設定 API_BASE');
        const body = { action, apiKey: state.apiKey || undefined, ...payload };
        const res = await fetch(state.apiBase, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        if(!res.ok) throw new Error('網路錯誤 '+res.status);
        const j = await res.json();
        if(!j || j.success===undefined) throw new Error('回應格式錯誤');
        if(!j.success) throw new Error(j.message||'操作失敗');
        return j;
      }

      function setLoginUI(){
        $('#u-client').textContent = 'Client: ' + (state.isInClient ? 'LINE 内嵌':'外部瀏覽器');
        if(state.lineId){
          $('#u-name').innerHTML = \`<b>\${state.lineName||'(未取得名稱)'}</b>\`;
          $('#u-id').textContent = 'lineId: '+state.lineId;
          $('#lineId').value = state.lineId;
          $('#btnLiffLogin').style.display='none';
          $('#btnLiffLogout').style.display='inline-flex';
          $('#btnReload').style.display='inline-flex';
          $('#u-ava').innerHTML = state.pictureUrl ? \`<img src="\${state.pictureUrl}" alt="avatar" />\` : '';
        }else{
          $('#u-name').innerHTML = '<span class="muted">尚未登入</span>';
          $('#u-id').textContent = 'lineId: -';
          $('#btnLiffLogin').style.display='inline-flex';
          $('#btnLiffLogout').style.display='none';
          $('#btnReload').style.display='none';
          $('#u-ava').innerHTML = '';
        }
      }

      function showTabs(){
        $('#tabs').style.display='flex';
        $('#tab-admin').style.display = state.isAdmin ? 'inline-flex':'none';
      }
      function switchTab(name){
        $$('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===name));
        $$('.section').forEach(s=> s.classList.toggle('active', s.id===('sec-'+name)));
      }

      // Profile
      function renderProfile(u){
        const el = $('#profileView');
        if(!u){
          el.innerHTML = '<div class="muted">尚未註冊</div>';
          $('#registerCard').style.display='block';
          // 預填註冊表單
          $('#reg-lineName').value = state.lineName||'';
          $('#reg-realName').value = state.lineName||'';
          return;
        }
        $('#registerCard').style.display='none';
        const rows = [
          ['lineId', u.lineId],
          ['LINE 名稱', u.lineName||''],
          ['真實姓名', u.realName||''],
          ['會員類型', u.memberType||''],
          ['電話', u.phone||''],
          ['Email', u.email||''],
          ['生日', u.birthday? fmtDate(u.birthday).slice(0,10):''],
          ['地址', u.address||''],
          ['狀態', u.status||''],
          ['加入日期', u.joinDate? fmtDate(u.joinDate).slice(0,10):''],
          ['是否管理員', u.isAdmin? '是':'否'],
          ['最後更新', u.lastUpdate? fmtDate(u.lastUpdate):'']
        ];
        el.innerHTML = rows.map(([k,v])=> \`<div class="row"><div class="muted" style="min-width:120px;">\${k}</div><div>\${v??''}</div></div>\`).join('');
        // fill editable fields
        $('#pf-phone').value = u.phone||'';
        $('#pf-email').value = u.email||'';
        $('#pf-birthday').value = u.birthday? String(u.birthday).slice(0,10):'';
        $('#pf-address').value = u.address||'';
        $('#pf-memberType').value = u.memberType||'';
        $('#pf-notes').value = u.notes||'';
      }

      async function loadAll(){
        if(!state.lineId) return;
        try{
          const r = await api('getUserInfo',{ lineId: state.lineId });
          state.user = r.data;
          state.isAdmin = !!r.data?.isAdmin;
          showTabs();
          renderProfile(state.user);
        }catch(e){
          if((e.message||'').includes('用戶未註冊')){
            state.user = null; state.isAdmin=false; showTabs(); renderProfile(null);
            toast('尚未註冊，請先建立會員','warn');
          }else{
            toast(e.message||'載入失敗','error');
          }
        }
        await Promise.allSettled([
          loadActivities(),
          loadMyRegistrations(),
          loadVolunteer(),
          loadFinance(),
          loadReceipts(),
          loadFeedback(),
          state.isAdmin? loadAdminSummary(): Promise.resolve()
        ]);
      }

      async function doRegister(){
        const lineName = $('#reg-lineName').value.trim();
        const realName = $('#reg-realName').value.trim();
        const memberType = $('#reg-memberType').value.trim();
        if(!realName || !memberType){ toast('請填寫必填欄位','warn'); return; }
        const r = await api('registerUser',{ lineId: state.lineId, lineName, realName, memberType });
        toast(r.message||'註冊成功');
        await loadAll();
      }
      async function doUpdateProfile(){
        const payload = {
          lineId: state.lineId,
          phone: $('#pf-phone').value.trim(),
          email: $('#pf-email').value.trim(),
          birthday: $('#pf-birthday').value.trim(),
          address: $('#pf-address').value.trim(),
          memberType: $('#pf-memberType').value.trim(),
          notes: $('#pf-notes').value.trim()
        };
        const r = await api('updateProfile', payload);
        toast(r.message||'更新成功');
        await loadAll();
      }

      // Activities
      async function loadActivities(){
        try{
          const r = await api('getActivities',{});
          state.cache.activities = r.data||[];
          const box = $('#actList');
          if(!r.data?.length){ box.innerHTML = '<div class="muted">目前沒有活動</div>'; return; }
          box.innerHTML = r.data.map(a=>{
            const open = a.status==='開放報名';
            return \`
              <div class="soft">
                <div class="row">
                  <div><b>\${a.title}</b> <span class="muted">(\${a.id})</span></div>
                  <div class="right pill">\${a.status||''}</div>
                </div>
                <div class="row muted small">
                  <div>\${a.date||''} \${a.time||''}</div>
                  <div class="badge">\${a.location||''}</div>
                  <div class="badge">\${a.currentCount||0}/\${a.maxParticipants||0}</div>
                  <div class="badge">費用：\${money(a.fee||0)}</div>
                </div>
                <div class="small">\${a.description||''}</div>
                <div class="spacer"></div>
                <button class="btn" \${open?'':'disabled'} data-actid="\${a.id}" onclick="registerAct('\${a.id}')">\${open?'我要報名':'未開放'}</button>
              </div>\`;
          }).join('');
        }catch(e){
          $('#actList').innerHTML = '<div class="muted">讀取失敗</div>';
        }
      }
      async function registerAct(id){
        try{
          const r = await api('registerActivity',{ lineId: state.lineId, activityId: id });
          toast(r.message||'報名成功');
          await Promise.all([loadActivities(), loadMyRegistrations()]);
        }catch(e){ toast(e.message||'報名失敗','error'); }
      }
      async function loadMyRegistrations(){
        if(!state.lineId) return;
        try{
          const r = await api('getMyRegistrations',{ lineId: state.lineId });
          const list = r.data||[];
          $('#myRegs').innerHTML = list.length? list.map(x=>{
            const canCancel = x.status==='已報名';
            return \`
              <div class="soft">
                <div class="row">
                  <div><b>\${x.activityTitle}</b></div>
                  <div class="pill right">\${x.status}</div>
                </div>
                <div class="muted small">報名時間：\${fmtDate(x.registrationTime)}</div>
                <div class="row">
                  <div class="muted small">付款：\${x.paymentStatus||'未設定'}</div>
                  <div class="right">
                    \${canCancel? \`<button class="btn danger" onclick="cancelReg('\${x.id}')">取消</button>\`:''}
                  </div>
                </div>
              </div>\`;
          }).join('') : '<div class="muted">尚無報名紀錄</div>';
        }catch(e){
          $('#myRegs').innerHTML = '<div class="muted">讀取失敗</div>';
        }
      }
      async function cancelReg(regId){
        try{
          const r = await api('cancelRegistration',{ lineId: state.lineId, registrationId: regId });
          toast(r.message||'已取消');
          await Promise.all([loadActivities(), loadMyRegistrations()]);
        }catch(e){ toast(e.message||'取消失敗','error'); }
      }

      // Volunteer
      async function loadVolunteer(){
        try{
          const r = await api('getVolunteerData',{ lineId: state.lineId });
          const needs = r.data?.needs||[];
          const recs  = r.data?.records||[];
          $('#volNeeds').innerHTML = needs.length? needs.map(n=>\`
            <div class="soft">
              <div class="row">
                <div><b>\${n.title}</b> <span class="muted">(\${n.id})</span></div>
                <div class="right pill">\${n.status}</div>
              </div>
              <div class="muted small">\${n.date||''} \${n.time||''} ｜ 需 \${n.needCount} 人，已 \${n.currentCount} 人 ｜ \${n.hours} 小時</div>
              <div class="small">\${n.description||''}</div>
              <div class="spacer"></div>
              <button class="btn" onclick="applyVol('\${n.id}')">報名志工</button>
            </div>\`).join('') : '<div class="muted">目前沒有志工需求</div>';
          $('#volRecords').innerHTML = recs.length? recs.map(v=>\`
            <div class="soft">
              <div class="row"><div><b>\${v.title}</b></div><div class="right pill">\${v.status}</div></div>
              <div class="muted small">\${v.date||''} ｜ \${v.hours||0} 小時</div>
              <div class="small">\${v.feedback||''}</div>
            </div>\`).join('') : '<div class="muted">尚無志工紀錄</div>';
          $('#k-totalHours').textContent = r.data?.stats?.totalHours||0;
          $('#k-totalActivities').textContent = r.data?.stats?.totalActivities||0;
          $('#k-availableNeeds').textContent = r.data?.stats?.availableNeeds||0;
        }catch(e){
          $('#volNeeds').innerHTML = '<div class="muted">讀取失敗</div>';
          $('#volRecords').innerHTML = '';
        }
      }
      async function applyVol(needId){
        try{
          const r = await api('applyVolunteer',{ lineId: state.lineId, needId });
          toast(r.message||'報名成功');
          await loadVolunteer();
        }catch(e){ toast(e.message||'報名失敗','error'); }
      }

      // Finance
      async function loadFinance(){
        if(!state.lineId) return;
        try{
          const r = await api('getFinanceData',{ lineId: state.lineId });
          const s = r.data?.stats||{};
          $('#fin-totalDonation').textContent = money(s.totalDonation||0);
          $('#fin-donationCount').textContent = s.donationCount||0;
          $('#fin-totalExpense').textContent = money(s.totalExpense||0);
          $('#fin-pendingExpenses').textContent = s.pendingExpenses||0;
          if(r.data?.adminStats && state.isAdmin){
            const a=r.data.adminStats;
            $('#admin-summary').innerHTML = \`
              <div class="row">
                <div class="kpi"><div class="v">\${money(a.totalIncome||0)}</div><div>累計收入</div></div>
                <div class="kpi"><div class="v">\${money(a.totalExpense||0)}</div><div>累計支出</div></div>
                <div class="kpi"><div class="v">\${money(a.currentBalance||0)}</div><div>目前餘額</div></div>
                <div class="kpi"><div class="v">\${money(a.monthlyDonations||0)}</div><div>本月捐款</div></div>
              </div>\`;
          }
        }catch(e){ /* ignore */ }
      }
      async function loadReceipts(){
        if(!state.lineId) return;
        try{
          const r = await api('getMyReceipts',{ lineId: state.lineId });
          const list = r.data||[];
          $('#tb-receipts').innerHTML = list.map(x=>\`
            <tr>
              <td class="nowrap">\${x.receiptNumber||''}</td>
              <td>\${x.type||''}</td>
              <td class="nowrap">\${money(x.amount||0)}</td>
              <td class="nowrap">\${fmtDate(x.issueDate||'').slice(0,10)}</td>
              <td>\${x.pdfUrl? \`<a href="\${x.pdfUrl}" target="_blank">檢視</a>\`:'-'}</td>
            </tr>\`).join('');
        }catch(e){
          $('#tb-receipts').innerHTML = '<tr><td colspan="5" class="muted">讀取失敗</td></tr>';
        }
      }

      async function doDonate(){
        const category = $('#don-category').value.trim();
        const amount = Number($('#don-amount').value||0);
        const description = $('#don-desc').value.trim();
        const needReceipt = $('#don-needReceipt').checked;
        if(!category || !(amount>0)){ return toast('請輸入正確的類別與金額','warn'); }
        try{
          const r = await api('createDonation',{ lineId: state.lineId, category, amount, description, needReceipt });
          toast(r.message||'捐款已建立');
          await Promise.all([loadFinance(), loadReceipts()]);
        }catch(e){ toast(e.message||'捐款失敗','error'); }
      }
      async function doExpense(){
        const category = $('#exp-category').value.trim();
        const amount = Number($('#exp-amount').value||0);
        const description = $('#exp-desc').value.trim();
        if(!category || !(amount>0)){ return toast('請輸入正確的類別與金額','warn'); }
        try{
          const r = await api('createExpense',{ lineId: state.lineId, category, amount, description });
          toast(r.message||'申請已送出');
          await loadFinance();
        }catch(e){ toast(e.message||'申請失敗','error'); }
      }

      // Feedback
      async function loadFeedback(){
        if(!state.lineId) return;
        try{
          const c = await api('getMyCompletedActivities',{ lineId: state.lineId });
          const sel = $('#fb-activity');
          const arr = c.data||[];
          sel.innerHTML = arr.length? arr.map(a=> \`<option value="\${a.id}">\${a.title}（\${a.date? fmtDate(a.date).slice(0,10):''}）</option>\`).join('') : '<option value="">（目前沒有可回饋的活動）</option>';
          const r = await api('getMyFeedback',{ lineId: state.lineId });
          const list = r.data||[];
          $('#tb-feedback').innerHTML = list.length? list.map(x=>\`
            <tr>
              <td>\${x.activityTitle||x.activityId||''}</td>
              <td>\${x.rating||''}</td>
              <td>\${x.comment||''}</td>
              <td>\${fmtDate(x.createdAt||'')}</td>
            </tr>\`).join('') : '<tr><td colspan="4" class="muted">尚無回饋</td></tr>';
        }catch(e){
          $('#tb-feedback').innerHTML = '<tr><td colspan="4" class="muted">讀取失敗</td></tr>';
        }
      }
      async function doFeedback(){
        const activityId = $('#fb-activity').value;
        const rating = Number($('#fb-rating').value||0);
        const comment = $('#fb-comment').value.trim();
        if(!activityId){ return toast('目前沒有可回饋的活動','warn'); }
        if(!(rating>=1 && rating<=5)){ return toast('評分需介於 1~5','warn'); }
        try{
          const r = await api('createFeedback',{ lineId: state.lineId, activityId, rating, comment });
          toast(r.message||'已送出');
          $('#fb-comment').value='';
          await loadFeedback();
        }catch(e){ toast(e.message||'送出失敗','error'); }
      }

      // Admin
      async function loadAdminSummary(){
        if(!state.isAdmin) return;
        try{
          await loadFinance();
          const r = await api('getAdminData',{ lineId: state.lineId });
          const { members=[], activities=[], transactions=[], receipts=[] } = r.data||{};
          $('#adm-act-table').innerHTML = activities.map(a=>\`
            <tr><td class="small">\${a.id}</td><td>\${a.title}</td><td class="nowrap">\${a.date||''}</td><td>\${a.status||''}</td></tr>\`).join('');
          $('#adm-receipts').innerHTML = receipts.map(x=>\`
            <tr>
              <td class="nowrap">\${x.receiptNumber||''}</td>
              <td class="small">\${x.lineId||''}</td>
              <td>\${x.type||''}</td>
              <td class="nowrap">\${money(x.amount||0)}</td>
              <td class="nowrap">\${fmtDate(x.issueDate||'').slice(0,10)}</td>
              <td>\${x.status||''}</td>
              <td>\${x.pdfUrl? \`<a href="\${x.pdfUrl}" target="_blank">PDF</a>\`:'-'}</td>
            </tr>\`).join('');
          $('#adm-trans').innerHTML = transactions.map(t=>\`
            <tr>
              <td class="nowrap">\${fmtDate(t.date||'')}</td>
              <td>\${t.type}</td>
              <td>\${t.category||''}</td>
              <td class="nowrap">\${money(t.amount||0)}</td>
              <td class="small">\${t.description||''}</td>
              <td>\${t.status||''}</td>
            </tr>\`).join('');
          $('#admin-summary').innerHTML += \`<div class="spacer"></div><div class="muted small">會員數：\${members.length}，活動數：\${activities.length}，收據數：\${receipts.length}</div>\`;
        }catch(e){
          $('#admin-summary').textContent = '載入失敗：'+(e.message||'');
        }
      }
      async function loadSettingsToUI(){
        try{
          const r = await api('getSettings',{ lineId: state.lineId });
          state.settings = r.data||{};
          $('#set-receiptTpl').value = state.settings.receiptTemplateDocId||'';
          $('#set-expenseTpl').value = state.settings.expenseVoucherTemplateDocId||'';
          $('#set-emailTpl').value = state.settings.emailReplyTemplate||'';
          $('#set-incomeCats').value = (state.settings.incomeCategories||[]).join(', ');
          $('#set-expenseCats').value = (state.settings.expenseCategories||[]).join(', ');
          // datalist 更新
          try{
            const inc = state.settings.incomeCategories||[];
            const exp = state.settings.expenseCategories||[];
            if(inc.length) $('#dl-income').innerHTML = inc.map(c=>\`<option value="\${c}"></option>\`).join('');
            if(exp.length) $('#dl-expense').innerHTML = exp.map(c=>\`<option value="\${c}"></option>\`).join('');
          }catch(_){}
          toast('設定已載入');
        }catch(e){ toast(e.message||'讀取設定失敗','error'); }
      }
      async function saveSettingsFromUI(){
        const income = $('#set-incomeCats').value.split(',').map(s=>s.trim()).filter(Boolean);
        const expense = $('#set-expenseCats').value.split(',').map(s=>s.trim()).filter(Boolean);
        const payload = {
          lineId: state.lineId,
          receiptTemplateDocId: $('#set-receiptTpl').value.trim(),
          expenseVoucherTemplateDocId: $('#set-expenseTpl').value.trim(),
          emailReplyTemplate: $('#set-emailTpl').value,
          incomeCategories: income,
          expenseCategories: expense
        };
        try{
          const r = await api('updateSettings', payload);
          toast(r.message||'設定已更新');
          await loadSettingsToUI();
        }catch(e){ toast(e.message||'更新失敗','error'); }
      }
      async function adminCreateActivity(){
        const title=$('#adm-act-title').value.trim();
        const date=$('#adm-act-date').value.trim();
        const time=$('#adm-act-time').value.trim();
        const location=$('#adm-act-loc').value.trim();
        const maxParticipants=Number($('#adm-act-max').value||0);
        const fee=Number($('#adm-act-fee').value||0);
        const description=$('#adm-act-desc').value.trim();
        if(!title || !date || !(maxParticipants>0)) return toast('請填寫必要欄位','warn');
        try{
          const r = await api('createActivity',{ lineId: state.lineId, title, date, time, location, maxParticipants, fee, description });
          toast(r.message||'建立成功');
          $('#adm-act-title').value=''; $('#adm-act-date').value=''; $('#adm-act-time').value='';
          $('#adm-act-loc').value=''; $('#adm-act-max').value=''; $('#adm-act-fee').value='0'; $('#adm-act-desc').value='';
          await Promise.all([loadActivities(), loadAdminSummary()]);
        }catch(e){ toast(e.message||'建立失敗','error'); }
      }
      async function adminCreateVolNeed(){
        const title=$('#adm-vol-title').value.trim();
        const date=$('#adm-vol-date').value.trim();
        const time=$('#adm-vol-time').value.trim();
        const needCount=Number($('#adm-vol-need').value||0);
        const hours=Number($('#adm-vol-hours').value||0);
        const description=$('#adm-vol-desc').value.trim();
        if(!title || !date || !(needCount>0) || !(hours>0)) return toast('請填寫必要欄位','warn');
        try{
          const r = await api('createVolunteerNeed',{ lineId: state.lineId, title, date, time, needCount, hours, description });
          toast(r.message||'建立成功');
          $('#adm-vol-title').value=''; $('#adm-vol-date').value=''; $('#adm-vol-time').value='';
          $('#adm-vol-need').value=''; $('#adm-vol-hours').value=''; $('#adm-vol-desc').value='';
          await loadAdminSummary();
        }catch(e){ toast(e.message||'建立失敗','error'); }
      }
      async function adminApproveExpense(){
        const expenseId=$('#adm-exp-id').value.trim();
        const decision = $('#adm-exp-decision').value;
        if(!expenseId) return toast('請填寫支出 ID','warn');
        const paymentInfo = (decision==='approve') ? {
          paymentDate: $('#adm-exp-payDate').value.trim()||'',
          paymentAccount: $('#adm-exp-account').value.trim()||'',
          paymentMethod: $('#adm-exp-method').value.trim()||'',
          bankTransferDate: $('#adm-exp-bankDate').value.trim()||''
        } : undefined;
        try{
          const r = await api('approveExpenseWithPayment',{ lineId: state.lineId, expenseId, decision, paymentInfo });
          toast(r.message||'完成');
          await loadAdminSummary();
        }catch(e){ toast(e.message||'操作失敗','error'); }
      }
      async function adminConfirmIncome(){
        const donationId=$('#adm-don-id').value.trim();
        const bankDate=$('#adm-don-bankDate').value.trim();
        const bankAccount=$('#adm-don-account').value.trim();
        if(!donationId) return toast('請填寫捐款 ID','warn');
        try{
          const r = await api('confirmDonationIncome',{ lineId: state.lineId, donationId, bankDate, bankAccount });
          toast(r.message||'已確認');
          await loadAdminSummary();
        }catch(e){ toast(e.message||'操作失敗','error'); }
      }
      async function adminCreateManualReceipt(){
        const targetLineId=$('#adm-rct-target').value.trim();
        const type=$('#adm-rct-type').value;
        const amount=Number($('#adm-rct-amount').value||0);
        const createDonation = $('#adm-rct-createDon').value==='true';
        if(!targetLineId || !(amount>0)) return toast('請填妥資料','warn');
        try{
          const r = await api('createManualReceipt',{ lineId: state.lineId, targetLineId, type, amount, createDonation });
          toast((r.message||'已建立') + (r.data?.receiptNumber? '｜編號：'+r.data.receiptNumber:'' ));
          await loadAdminSummary();
        }catch(e){ toast(e.message||'建立失敗','error'); }
      }
      async function adminExportMembers(){
        try{
          const r = await api('exportMembers',{ lineId: state.lineId });
          $('#exportResult').innerHTML = \`<a href="\${r.data.url}" target="_blank">下載 CSV</a>\`;
          toast('匯出完成');
        }catch(e){ toast(e.message||'匯出失敗','error'); }
      }

      // Tabs
      function bindTabs(){
        $$('#tabs .tab').forEach(t=>{
          t.addEventListener('click', ()=>{
            const name=t.dataset.tab;
            switchTab(name);
            if(name==='admin') loadAdminSummary();
            if(name==='activities'){ loadActivities(); loadMyRegistrations(); }
            if(name==='volunteer'){ loadVolunteer(); }
            if(name==='finance'){ loadFinance(); loadReceipts(); }
            if(name==='feedback'){ loadFeedback(); }
          });
        });
      }

      // Config
      function bindConfig(){
        $('#btnSaveConfig').addEventListener('click', ()=>{
          state.apiBase = $('#apiBase').value.trim();
          state.apiKey  = $('#apiKey').value.trim();
          saveLocal();
          toast('設定已儲存');
          if(state.ready && state.lineId){
            loadAll().catch(()=>{});
          }
        });
        $('#btnReload').addEventListener('click', ()=> loadAll().catch(()=>{}));
      }

      // Bind buttons
      function bindActions(){
        $('#btnRegister').addEventListener('click', ()=> doRegister().catch(e=> toast(e.message||'註冊失敗','error')));
        $('#btnUpdateProfile').addEventListener('click', ()=> doUpdateProfile().catch(e=> toast(e.message||'更新失敗','error')));
        $('#btnDonate').addEventListener('click', ()=> doDonate().catch(e=> toast(e.message||'捐款失敗','error')));
        $('#btnExpense').addEventListener('click', ()=> doExpense().catch(e=> toast(e.message||'申請失敗','error')));
        $('#btnFeedback').addEventListener('click', ()=> doFeedback().catch(e=> toast(e.message||'送出失敗','error')));

        // Admin
        $('#btnLoadSettings').addEventListener('click', ()=> loadSettingsToUI());
        $('#btnSaveSettings').addEventListener('click', ()=> saveSettingsFromUI());
        $('#btnExportMembers').addEventListener('click', ()=> adminExportMembers());
        $('#btnCreateActivity').addEventListener('click', ()=> adminCreateActivity());
        $('#btnCreateVolNeed').addEventListener('click', ()=> adminCreateVolNeed());
        $('#btnApproveExpense').addEventListener('click', ()=> adminApproveExpense());
        $('#btnConfirmIncome').addEventListener('click', ()=> adminConfirmIncome());
        $('#btnCreateManualReceipt').addEventListener('click', ()=> adminCreateManualReceipt());
      }

      // LIFF
      async function initLIFF(){
        if(!CONFIG.LIFF_ID || CONFIG.LIFF_ID==='YOUR_LIFF_ID'){
          toast('請先設定 CONFIG.LIFF_ID','warn');
        }
        await liff.init({ liffId: CONFIG.LIFF_ID });
        state.isInClient = liff.isInClient();
        if(!liff.isLoggedIn()){
          $('#btnLiffLogin').style.display='inline-flex';
          $('#btnLiffLogout').style.display='none';
          $('#btnLiffLogin').onclick = ()=> liff.login();
          setLoginUI();
          return false;
        }
        // 登入狀態，可取得個資
        const prof = await liff.getProfile();
        state.lineId   = prof.userId;     // 作為後端的 lineId 主鍵
        state.lineName = prof.displayName;
        state.pictureUrl = prof.pictureUrl || '';
        setLoginUI();

        // 登出
        $('#btnLiffLogout').style.display='inline-flex';
        $('#btnLiffLogin').style.display='none';
        $('#btnLiffLogout').onclick = ()=>{
          liff.logout();
          location.reload();
        };
        return true;
      }

      // Init
      (async function init(){
        loadLocal();
        bindTabs();
        bindConfig();
        bindActions();
        // initial UI
        setLoginUI();

        // 預設帶入 CONFIG 參數
        if(!$('#apiBase').value && CONFIG.API_BASE) $('#apiBase').value = CONFIG.API_BASE;
        if(!$('#apiKey').value && CONFIG.API_KEY)   $('#apiKey').value  = CONFIG.API_KEY;
        state.apiBase = $('#apiBase').value.trim();
        state.apiKey  = $('#apiKey').value.trim();

        const logged = await initLIFF();
        if(!logged) return;
        state.ready = true;
        // 自動載入
        await loadAll();
        showTabs();
      })();

      // 對外事件（按鈕需要全域）
      window.registerAct = registerAct;
      window.cancelReg   = cancelReg;
      window.applyVol    = applyVol;
    </script>
  </body>
</html>
