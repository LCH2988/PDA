<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- å¸•é‡‘æ£®ç—…å‹æœƒå°ˆç”¨ favicon -->
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AOAgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AOAgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AOAgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A">

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    /* ========== å…¨åŸŸæ¨£å¼ ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      --danger-gradient: linear-gradient(135deg, #dc3545, #c82333);
      --warning-gradient: linear-gradient(135deg, #ffc107, #e0a800);
      --info-gradient: linear-gradient(135deg, #17a2b8, #138496);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      margin: 0;
    }

    /* ========== å®¹å™¨æ¨£å¼ ========== */
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .main-header, .nav-container, .content-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    /* ========== æ¨™é¡Œå€åŸŸ ========== */
    .main-header {
      text-align: center;
      position: sticky;
      top: 20px;
      z-index: 999;
      background: white;
      border-radius: 15px;
      overflow: hidden;
    }

    .header-content {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      padding: 30px;
      margin: -30px -30px 20px -30px;
    }

    .main-header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      color: white;
    }

    .main-header .text-muted {
      font-size: 1.2em;
      opacity: 0.9;
      color: rgba(255, 255, 255, 0.9) !important;
    }

    .user-info-bar {
      display: inline-flex;
      gap: 15px;
      align-items: center;
      background: rgba(255, 255, 255, 0.9);
      padding: 15px 20px;
      border-radius: 30px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      margin-top: 10px;
    }

    .user-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: var(--primary-gradient);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
    }

    /* ========== å°èˆªæ¨™ç±¤ ========== */
    .nav-container {
      padding: 20px;
    }

    .nav-pills {
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .nav-pills .nav-link {
      font-weight: 600;
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 12px 20px;
      color: #6c757d;
      transition: all 0.3s ease;
      background: none;
    }

    .nav-pills .nav-link:hover {
      background: #e9ecef;
      color: #495057;
      border-color: #4CAF50;
    }

    .nav-pills .nav-link.active {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border-color: transparent;
    }

    /* ========== å…§å®¹å¡ç‰‡ ========== */
    .content-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #4CAF50;
    }

    .card h3, .card h5 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    .card p {
      color: #666;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    /* ========== çµ±è¨ˆå¡ç‰‡ ========== */
    .stat-card {
      border-radius: 16px;
      padding: 25px;
      color: #fff;
      text-align: center;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      margin-bottom: 20px;
    }

    .stat-card h3 {
      margin: 0 0 8px;
      font-size: 2.2rem;
      font-weight: 700;
    }

    .stat-card p {
      margin: 0;
      font-size: 1rem;
      opacity: 0.9;
    }

    /* ========== æ´»å‹•é …ç›® ========== */
    .activity-item, .transaction-item {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 4px solid #4CAF50;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }

    .activity-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    }

    .activity-item h4, .activity-item h5 {
      color: #333;
      margin-bottom: 10px;
    }

    .activity-item .meta {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .activity-item .description {
      color: #555;
      margin-bottom: 15px;
      line-height: 1.5;
    }

    /* ========== ç‹€æ…‹æ¨™ç±¤ ========== */
    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      line-height: 1;
      margin-top: 4px;
      text-transform: uppercase;
    }

    .status-é–‹æ”¾å ±å, .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-å·²å ±å {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-å·²å–æ¶ˆ, .status-å·²æ‹’çµ•, .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }

    .status-å·²å®Œæˆ {
      background: #e2e3ff;
      color: #383d41;
    }

    .status-å ±åæˆªæ­¢, .status-å¾…å¯©æ ¸, .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-é€²è¡Œä¸­ {
      background: #bee3f8;
      color: #2a69ac;
    }

    .status-å·²çµæŸ {
      background: #e2e8f0;
      color: #2d3748;
    }

    .status-å·²æ ¸å‡† {
      background: #d4edda;
      color: #155724;
    }

    /* ========== æŒ‰éˆ•æ¨£å¼ ========== */
    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    }

    .btn-success {
      background: var(--success-gradient);
      color: white;
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: var(--danger-gradient);
      color: white;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
      transform: translateY(-2px);
    }

    .btn-warning {
      background: var(--warning-gradient);
      color: white;
    }

    .btn-warning:hover {
      background: linear-gradient(135deg, #e0a800 0%, #c69500 100%);
      transform: translateY(-2px);
    }

    .btn-info {
      background: var(--info-gradient);
      color: white;
    }

    .btn-info:hover {
      background: linear-gradient(135deg, #138496 0%, #0f6674 100%);
      transform: translateY(-2px);
    }

    /* ========== è¡¨å–®æ¨£å¼ ========== */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-control, .form-select {
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      padding: 12px 15px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
    }

    .form-floating label {
      color: #6c757d;
    }

    /* ========== å¿«é€Ÿæ“ä½œ ========== */
    .quick-actions {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      margin-bottom: 30px;
    }

    .quick-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #333;
    }

    .quick-btn:hover {
      border-color: #4CAF50;
      color: #4CAF50;
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
      background: white;
    }

    .quick-btn i {
      font-size: 2rem;
      margin-bottom: 10px;
      display: block;
    }

    /* ========== é€šçŸ¥æ¨£å¼ ========== */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #fff;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      transform: translateX(420px);
      transition: all 0.4s ease;
      z-index: 2000;
      max-width: 360px;
      border-left: 4px solid #4CAF50;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: #d4edda;
      color: #155724;
      border-left-color: #4CAF50;
    }

    .notification.error {
      background: #f8d7da;
      color: #721c24;
      border-left-color: #dc3545;
    }

    .notification.warning {
      background: #fff3cd;
      color: #856404;
      border-left-color: #ffc107;
    }

    .notification.info {
      background: #d1ecf1;
      color: #0c5460;
      border-left-color: #17a2b8;
    }

    /* ========== è¼‰å…¥å‹•ç•« ========== */
    .btn.loading {
      position: relative;
      color: transparent !important;
    }

    .btn.loading:after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px;
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    /* ========== è¡¨æ ¼æ¨£å¼ ========== */
    .table-container {
      max-height: 480px;
      overflow: auto;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .table th {
      position: sticky;
      top: 0;
      background: #f8f9fa;
      z-index: 1;
      font-weight: 600;
      color: #333;
    }

    .table td, .table th {
      padding: 12px 15px;
      border-bottom: 1px solid #e9ecef;
    }

    .table-hover tbody tr:hover {
      background-color: rgba(76, 175, 80, 0.1);
    }

    /* ========== è­¦å‘Šæ¡†æ¨£å¼ ========== */
    .alert {
      padding: 15px 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      font-weight: 500;
      border-left: 4px solid;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left-color: #4CAF50;
    }

    .alert-error, .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border-left-color: #dc3545;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border-left-color: #17a2b8;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border-left-color: #ffc107;
    }

    /* ========== ç¤ºç¯„é€šçŸ¥ ========== */
    .demo-notice {
      background: #fff3cd;
      color: #856404;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid #ffeaa7;
      border-left: 4px solid #ffc107;
    }

    /* ========== éŸ¿æ‡‰å¼è¨­è¨ˆ ========== */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .main-header, .nav-container, .content-card {
        margin-bottom: 15px;
        padding: 20px;
        border-radius: 10px;
      }

      .header-content {
        margin: -20px -20px 15px -20px;
        padding: 20px;
      }

      .main-header h1 {
        font-size: 2em;
      }

      .nav-pills {
        flex-direction: column;
      }

      .nav-pills .nav-link {
        width: 100%;
        margin-bottom: 5px;
      }

      .quick-actions {
        grid-template-columns: repeat(2, 1fr);
      }

      .user-info-bar {
        flex-direction: column;
        text-align: center;
        gap: 10px;
      }

      .stat-card h3 {
        font-size: 1.8rem;
      }
    }

    /* ========== æ·±è‰²æ¨¡å¼æ”¯æ´ ========== */
    @media (prefers-color-scheme: dark) {
      .main-header, .nav-container, .content-card {
        background: rgba(45, 55, 72, 0.95);
        color: #e2e8f0;
      }

      .activity-item, .transaction-item {
        background: #2d3748;
        color: #e2e8f0;
      }

      .quick-btn {
        background: rgba(45, 55, 72, 0.9);
        border-color: #718096;
        color: #e2e8f0;
      }

      .table-container {
        background: #2d3748;
      }

      .table th {
        background: #4a5568;
        color: #fff;
      }

      .form-control, .form-select {
        background: #2d3748;
        border-color: #4a5568;
        color: #e2e8f0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-header">
      <div class="header-content">
        <h1><i class="bi bi-hospital"></i> å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</h1>
        <p class="text-muted mb-0">é—œæ‡·ã€æ”¯æŒã€å…±åŒæˆé•·</p>
      </div>
      
      <div id="userInfoBar" class="user-info-bar" style="display:none;">
        <div class="user-avatar" id="userAvatar">?</div>
        <div>
          <div class="fw-bold" id="userName">è¼‰å…¥ä¸­...</div>
          <div class="small text-muted" id="userLineName"></div>
          <div class="small text-muted" id="userRole">æœƒå“¡</div>
        </div>
        <div class="ms-auto">
          <button class="btn btn-sm btn-outline-secondary" onclick="refreshData()" title="åˆ·æ–°">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
      </div>
    </div>

    <div id="notificationContainer"></div>

    <div class="nav-container">
      <ul class="nav nav-pills">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#dashboard">ğŸ  å„€è¡¨æ¿</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#profile">ğŸ‘¤ å€‹äººè³‡æ–™</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#activities">ğŸª æ´»å‹•ç®¡ç†</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#volunteer">ğŸ¤ å¿—å·¥æœå‹™</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#finance">ğŸ’° è²¡å‹™ç®¡ç†</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#feedback">ğŸ’¬ æ´»å‹•å›é¥‹</button></li>
        <li class="nav-item admin-only" style="display:none;"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#admin">âš™ï¸ ç³»çµ±ç®¡ç†</button></li>
      </ul>
    </div>

    <div class="tab-content">

      <!-- Dashboard -->
      <div class="tab-pane fade show active" id="dashboard">
        <div class="content-card">
          <div class="card">
            <h3><i class="bi bi-speedometer2 me-2"></i>ç³»çµ±å„€è¡¨æ¿</h3>
            <p>æ­¡è¿ä½¿ç”¨å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±ï¼é€™è£¡æ˜¯æ‚¨çš„å€‹äººåŒ–æ§åˆ¶ä¸­å¿ƒã€‚</p>
          </div>

          <div class="quick-actions">
            <div class="quick-btn" onclick="showTab('profile')">
              <i class="bi bi-person-check"></i>
              æ›´æ–°è³‡æ–™
            </div>
            <div class="quick-btn" onclick="showTab('activities')">
              <i class="bi bi-calendar-plus"></i>
              å ±åæ´»å‹•
            </div>
            <div class="quick-btn" onclick="showNewDonationModal()">
              <i class="bi bi-heart-fill"></i>
              æ„›å¿ƒææ¬¾
            </div>
            <div class="quick-btn" onclick="showTab('volunteer')">
              <i class="bi bi-hand-thumbs-up"></i>
              å¿—å·¥æœå‹™
            </div>
          </div>

          <div class="row" id="dashboardStats">
            <div class="col-12">
              <div class="loading">
                <div class="spinner"></div>
                <p>è¼‰å…¥çµ±è¨ˆè³‡æ–™...</p>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <h5><i class="bi bi-clock-history me-2"></i>æœ€è¿‘æ´»å‹•</h5>
            <div id="recentActivity">
              <div class="loading">
                <div class="spinner"></div>
                <p>è¼‰å…¥ä¸­...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile -->
      <div class="tab-pane fade" id="profile">
        <div class="content-card">
          <div class="card">
            <h3><i class="bi bi-person me-2"></i>å€‹äººè³‡æ–™ç®¡ç†</h3>
            <p>ç®¡ç†æ‚¨çš„å€‹äººè³‡æ–™ï¼Œç¢ºä¿è³‡è¨Šæ­£ç¢ºå®Œæ•´ã€‚</p>
          </div>

          <div id="registrationSection" class="mt-3">
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>è«‹å…ˆå®Œæˆè¨»å†Šä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½ã€‚
            </div>
            <form id="registrationForm" class="row g-3">
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" class="form-control" id="realName" name="realName" required>
                  <label for="realName">çœŸå¯¦å§“å *</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="memberType" name="memberType" required>
                    <option value="">é¸æ“‡</option>
                    <option value="ç—…å‹">ç—…å‹</option>
                    <option value="å®¶å±¬">å®¶å±¬</option>
                    <option value="å¿—å·¥">å¿—å·¥</option>
                    <option value="é†«è­·">é†«è­·äººå“¡</option>
                    <option value="æ”¯æŒè€…">æ”¯æŒè€…</option>
                  </select>
                  <label for="memberType">æœƒå“¡é¡åˆ¥ *</label>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-primary" type="submit"><i class="bi bi-check-circle me-1"></i>å®Œæˆè¨»å†Š</button>
              </div>
            </form>
          </div>

          <div id="profileSection" style="display:none;">
            <form id="profileForm" class="row g-3 mt-2">
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" class="form-control" id="profileRealName" name="profileRealName" readonly>
                  <label for="profileRealName">çœŸå¯¦å§“å</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" class="form-control" id="lineName" name="lineName" readonly>
                  <label for="lineName">LINE åç¨±</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="tel" class="form-control" id="phone" name="phone">
                  <label for="phone">è¯çµ¡é›»è©±</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="email" class="form-control" id="email" name="email">
                  <label for="email">é›»å­éƒµä»¶</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="date" class="form-control" id="birthday" name="birthday">
                  <label for="birthday">ç”Ÿæ—¥</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <select class="form-select" id="profileMemberType" name="memberType">
                    <option value="ç—…å‹">ç—…å‹</option>
                    <option value="å®¶å±¬">å®¶å±¬</option>
                    <option value="å¿—å·¥">å¿—å·¥</option>
                    <option value="é†«è­·">é†«è­·äººå“¡</option>
                    <option value="æ”¯æŒè€…">æ”¯æŒè€…</option>
                  </select>
                  <label for="profileMemberType">æœƒå“¡é¡åˆ¥</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <textarea class="form-control" id="address" name="address" style="height:100px;"></textarea>
                  <label for="address">é€šè¨Šåœ°å€</label>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-primary" type="submit"><i class="bi bi-save me-1"></i>æ›´æ–°è³‡æ–™</button>
              </div>
            </form>
            <div class="mt-4">
              <h5><i class="bi bi-bar-chart me-2"></i>å€‹äººçµ±è¨ˆ</h5>
              <div class="row g-3" id="profileStats"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Activities -->
      <div class="tab-pane fade" id="activities">
        <div class="content-card">
          <div class="card">
            <h3><i class="bi bi-calendar-event me-2"></i>æ´»å‹•ç®¡ç†</h3>
            <p>åƒèˆ‡æˆ‘å€‘ç²¾å¿ƒå®‰æ’çš„å„ç¨®æ´»å‹•ï¼Œèˆ‡ç—…å‹å€‘ä¸€èµ·å­¸ç¿’æˆé•·ã€‚</p>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="admin-only" style="display:none;">
              <button class="btn btn-success btn-sm" onclick="showNewActivityModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢æ´»å‹•</button>
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <div class="form-floating">
                <select class="form-select" id="activityStatusFilter">
                  <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                  <option value="é–‹æ”¾å ±å">é–‹æ”¾å ±å</option>
                  <option value="å ±åæˆªæ­¢">å ±åæˆªæ­¢</option>
                  <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
                  <option value="å·²çµæŸ">å·²çµæŸ</option>
                </select>
                <label for="activityStatusFilter">ç‹€æ…‹</label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-floating">
                <input type="date" class="form-control" id="activityDateFilter">
                <label for="activityDateFilter">æ—¥æœŸ</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="text" class="form-control" id="activitySearchFilter" placeholder="é—œéµå­—">
                <label for="activitySearchFilter">æœå°‹</label>
              </div>
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-outline-primary" onclick="filterActivities()"><i class="bi bi-search"></i> æŸ¥è©¢</button>
            </div>
          </div>
          <div id="activitiesList">
            <div class="loading">
              <div class="spinner"></div>
              <p>è¼‰å…¥æ´»å‹•...</p>
            </div>
          </div>
          <div class="mt-5">
            <h5><i class="bi bi-clipboard-check me-2"></i>æˆ‘çš„æ´»å‹•å ±å</h5>
            <div id="myRegistrations" class="mt-2">
              <div class="loading">
                <div class="spinner"></div>
                <p>è¼‰å…¥ä¸­...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Volunteer -->
      <div class="tab-pane fade" id="volunteer">
        <div class="content-card">
          <div class="card">
            <h3><i class="bi bi-heart me-2"></i>å¿—å·¥æœå‹™</h3>
            <p>åŠ å…¥æˆ‘å€‘çš„å¿—å·¥è¡Œåˆ—ï¼Œç”¨æ„›å¿ƒå’Œè¡Œå‹•å¹«åŠ©æ›´å¤šéœ€è¦çš„äººã€‚</p>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="admin-only" style="display:none;">
              <button class="btn btn-success btn-sm" onclick="showNewVolunteerNeedModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢å¿—å·¥éœ€æ±‚</button>
            </div>
          </div>
          <div class="row g-3 mb-4">
            <div class="col-md-3"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="volunteerHours">0</h3><p class="mb-0">æœå‹™æ™‚æ•¸</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="volunteerActivities">0</h3><p class="mb-0">åƒèˆ‡æ¬¡æ•¸</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="volunteerRank">-</h3><p class="mb-0">å¿—å·¥æ’å</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="availableNeeds">0</h3><p class="mb-0">å¯å ±åéœ€æ±‚</p></div></div>
          </div>
          <h5><i class="bi bi-exclamation-circle me-2"></i>å¿—å·¥éœ€æ±‚</h5>
          <div id="volunteerNeeds">
            <div class="loading">
              <div class="spinner"></div>
              <p>è¼‰å…¥ä¸­...</p>
            </div>
          </div>
          <div class="mt-5">
            <h5><i class="bi bi-journal-text me-2"></i>æˆ‘çš„å¿—å·¥è¨˜éŒ„</h5>
            <div id="myVolunteerRecords" class="mt-2">
              <div class="loading">
                <div class="spinner"></div>
                <p>è¼‰å…¥ä¸­...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Finance -->
      <div class="tab-pane fade" id="finance">
        <div class="content-card">
          <div class="card">
            <h3><i class="bi bi-cash-coin me-2"></i>è²¡å‹™ç®¡ç†</h3>
            <p>æ‚¨çš„æ¯ä¸€ä»½æ„›å¿ƒéƒ½å°‡ç”¨æ–¼æ”¯æŒç—…å‹æœƒçš„å„é …æœå‹™å’Œæ´»å‹•ã€‚</p>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <button class="btn btn-success btn-sm me-2" onclick="showNewDonationModal()"><i class="bi bi-heart-fill me-1"></i>ææ¬¾</button>
              <button class="btn btn-warning btn-sm" onclick="showNewExpenseModal()"><i class="bi bi-receipt me-1"></i>æ”¯å‡ºç”³è«‹</button>
            </div>
          </div>
          <div class="row g-3 mb-4">
            <div class="col-md-3"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="myDonationAmount">NT$ 0</h3><p class="mb-0">ææ¬¾ç¸½é¡</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="myDonationCount">0</h3><p class="mb-0">ææ¬¾æ¬¡æ•¸</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="myExpenseAmount">NT$ 0</h3><p class="mb-0">æ”¯å‡ºç”³è«‹é¡</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="pendingExpenses">0</h3><p class="mb-0">å¾…å¯©æ ¸</p></div></div>
          </div>
          <h5><i class="bi bi-heart-fill me-2"></i>æˆ‘çš„ææ¬¾</h5>
          <div id="donationHistory" class="mt-2">
            <div class="loading">
              <div class="spinner"></div>
              <p>è¼‰å…¥ä¸­...</p>
            </div>
          </div>
          <div class="mt-5">
            <h5><i class="bi bi-receipt me-2"></i>æˆ‘çš„æ”¯å‡ºç”³è«‹</h5>
            <div id="expenseHistory" class="mt-2">
              <div class="loading">
                <div class="spinner"></div>
                <p>è¼‰å…¥ä¸­...</p>
              </div>
            </div>
          </div>
          <div class="admin-only mt-5" style="display:none;">
            <h5><i class="bi bi-graph-up me-2"></i>è²¡å‹™ç¸½è¦½ï¼ˆç®¡ç†å“¡ï¼‰</h5>
            <div class="row g-3">
              <div class="col-md-3"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="totalIncome">NT$ 0</h3><p class="mb-0">ç¸½æ”¶å…¥</p></div></div>
              <div class="col-md-3"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="totalExpense">NT$ 0</h3><p class="mb-0">ç¸½æ”¯å‡º</p></div></div>
              <div class="col-md-3"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="currentBalance">NT$ 0</h3><p class="mb-0">ç›®å‰é¤˜é¡</p></div></div>
              <div class="col-md-3"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="monthlyDonations">NT$ 0</h3><p class="mb-0">æœ¬æœˆææ¬¾</p></div></div>
            </div>
            <div class="mt-3">
              <button class="btn btn-outline-primary btn-sm" onclick="showNewTransactionModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢äº¤æ˜“(å¿«é€Ÿ)</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Feedback -->
      <div class="tab-pane fade" id="feedback">
        <div class="content-card">
          <div class="card">
            <h3><i class="bi bi-chat-dots me-2"></i>æ´»å‹•å›é¥‹</h3>
            <p>åˆ†äº«æ‚¨çš„æ´»å‹•é«”é©—ï¼Œå¹«åŠ©æˆ‘å€‘æä¾›æ›´å¥½çš„æœå‹™ã€‚</p>
          </div>

          <div class="card mb-4">
            <div class="card-header bg-primary text-white" style="background: var(--success-gradient) !important; margin: -20px -20px 20px -20px; padding: 15px 20px; border-radius: 10px 10px 0 0;">
              <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>æ–°å¢å›é¥‹</h5>
            </div>
            <div class="card-body">
              <form id="feedbackForm" class="row g-3">
                <div class="col-md-6">
                  <div class="form-floating">
                    <select class="form-select" id="feedbackActivity" name="feedbackActivity" required>
                      <option value="">è«‹é¸æ“‡æ´»å‹•</option>
                    </select>
                    <label for="feedbackActivity">æ´»å‹• *</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <select class="form-select" id="feedbackRating" name="feedbackRating" required>
                      <option value="">è©•åˆ†</option>
                      <option value="5">5 - éå¸¸æ»¿æ„</option>
                      <option value="4">4 - æ»¿æ„</option>
                      <option value="3">3 - æ™®é€š</option>
                      <option value="2">2 - ä¸æ»¿æ„</option>
                      <option value="1">1 - éå¸¸ä¸æ»¿æ„</option>
                    </select>
                    <label for="feedbackRating">è©•åˆ† *</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-floating">
                    <textarea class="form-control" id="feedbackComment" name="feedbackComment" style="height:120px;" required></textarea>
                    <label for="feedbackComment">æ„è¦‹ / å»ºè­° *</label>
                  </div>
                </div>
                <div class="col-12">
                  <button class="btn btn-primary" type="submit"><i class="bi bi-send me-1"></i>æäº¤</button>
                </div>
              </form>
            </div>
          </div>
          <h5><i class="bi bi-chat-left-text me-2"></i>æˆ‘çš„å›é¥‹</h5>
          <div id="myFeedback" class="mt-2">
            <div class="loading">
              <div class="spinner"></div>
              <p>è¼‰å…¥ä¸­...</p>
            </div>
          </div>
          <div class="admin-only mt-5" style="display:none;">
            <h5><i class="bi bi-chat-square-dots me-2"></i>å…¨éƒ¨å›é¥‹ï¼ˆç®¡ç†å“¡ï¼‰</h5>
            <div id="allFeedback">
              <div class="loading">
                <div class="spinner"></div>
                <p>è¼‰å…¥ä¸­...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin -->
      <div class="tab-pane fade" id="admin">
        <div class="content-card">
          <div class="card">
            <h3><i class="bi bi-gear me-2"></i>ç³»çµ±ç®¡ç†</h3>
            <p>ç®¡ç†å“¡å°ˆç”¨åŠŸèƒ½ï¼ŒåŒ…å«æœƒå“¡å¯©æ ¸ã€æ´»å‹•ç®¡ç†ç­‰ã€‚</p>
          </div>

          <ul class="nav nav-tabs mb-4">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#memberManagement">æœƒå“¡</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#activityManagement">æ´»å‹•</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#financeManagement">è²¡å‹™</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#receiptManagement">æ”¶æ“š</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#systemSettings">è¨­å®š</button></li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="memberManagement">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">æœƒå“¡åˆ—è¡¨</h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-primary btn-sm" onclick="exportMembers()"><i class="bi bi-download me-1"></i>åŒ¯å‡º</button>
                </div>
              </div>
              <div class="table-container">
                <table class="table table-hover table-sm align-middle">
                  <thead>
                    <tr>
                      <th>å§“å</th><th>é¡åˆ¥</th><th>ç‹€æ…‹</th><th>åŠ å…¥æ—¥æœŸ</th><th>ææ¬¾æ¬¡æ•¸</th><th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="memberList">
                    <tr><td colspan="6" class="text-center text-muted py-4"><div class="spinner-border spinner-border-sm me-2"></div>è¼‰å…¥ä¸­...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="activityManagement">
              <div class="d-flex justify-content-between mb-2">
                <h5 class="mb-0">æ´»å‹•åˆ—è¡¨</h5>
                <button class="btn btn-success btn-sm" onclick="showNewActivityModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢æ´»å‹•</button>
              </div>
              <div id="adminActivityList" class="mt-2">
                <div class="loading">
                  <div class="spinner"></div>
                  <p>è¼‰å…¥ä¸­...</p>
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="financeManagement">
              <div class="d-flex justify-content-between mb-2">
                <h5 class="mb-0">äº¤æ˜“è¨˜éŒ„</h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-success btn-sm" onclick="showNewTransactionModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢äº¤æ˜“</button>
                  <button class="btn btn-outline-primary btn-sm" onclick="exportFinanceData()"><i class="bi bi-download me-1"></i>åŒ¯å‡º</button>
                </div>
              </div>
              <div class="table-container">
                <table class="table table-sm table-hover align-middle">
                  <thead>
                    <tr><th>æ—¥æœŸ</th><th>é¡å‹</th><th>é‡‘é¡</th><th>åˆ†é¡</th><th>èªªæ˜</th><th>ç‹€æ…‹</th></tr>
                  </thead>
                  <tbody id="transactionList">
                    <tr><td colspan="6" class="text-center text-muted py-4"><div class="spinner-border spinner-border-sm me-2"></div>è¼‰å…¥ä¸­...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="receiptManagement">
              <div class="d-flex justify-content-between mb-2">
                <h5 class="mb-0">æ”¶æ“šåˆ—è¡¨</h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-info btn-sm" onclick="showReceiptTemplateModal()"><i class="bi bi-file-text me-1"></i>æ¨¡æ¿è¨­å®š</button>
                  <button class="btn btn-success btn-sm" onclick="showManualReceiptModal()"><i class="bi bi-plus-circle me-1"></i>æ‰‹å‹•é–‹ç«‹</button>
                </div>
              </div>
              <div id="receiptList" class="mt-2">
                <div class="loading">
                  <div class="spinner"></div>
                  <p>è¼‰å…¥ä¸­...</p>
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="systemSettings">
              <h5 class="mb-3">ç³»çµ±å·¥å…·</h5>
              <div class="d-flex flex-wrap gap-3">
                <button class="btn btn-warning" onclick="backupSystem()"><i class="bi bi-database me-1"></i>ç«‹å³å‚™ä»½</button>
                <button class="btn btn-info" onclick="showSystemNotificationModal()"><i class="bi bi-megaphone me-1"></i>ç™¼é€é€šçŸ¥</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- tab-content -->
  </div>

  <div id="modalContainer"></div>

  <script>
    // ========== è¨­å®š ==========
    const CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',
      // !!! è«‹æ›¿æ›ç‚ºæ‚¨æœ€æ–°éƒ¨ç½² Web App URL (ä»¥ https://script.google.com/macros/s/XXXXX/exec çµå°¾)
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycbzhjx7vV0PQUy3vOdkOrd0nqZPvsB2tmNK6-2Dia3fxS6YoM-O7slhWszTAN5MRLG2p/exec',
      API_KEY: 'AAbb8520258185202581'
    };

    // ========== å…¨åŸŸç‹€æ…‹ ==========
    let userProfile = null;
    let currentUser = null;
    let isAdmin = false;
    let allActivities = [];
    let cachedAdminData = null;

    // ========== å·¥å…· ==========
    const formatDate = d => {
      if(!d) return '-';
      const dt = new Date(d);
      if(isNaN(dt)) return '-';
      return dt.toLocaleDateString('zh-TW');
    };
    const formatDateTime = d => {
      if(!d) return '-';
      const dt = new Date(d);
      if(isNaN(dt)) return '-';
      return dt.toLocaleString('zh-TW');
    };
    const formatCurrency = n =>
      new Intl.NumberFormat('zh-TW',{style:'currency',currency:'TWD',minimumFractionDigits:0}).format(n||0);

    function showNotification(msg,type='success',ms=3000){
      const wrap = document.getElementById('notificationContainer');
      const el = document.createElement('div');
      el.className = `notification ${type}`;
      el.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <span>${msg}</span>
          <button style="background:none;border:none;font-size:18px;line-height:1;" onclick="this.closest('.notification').remove()">&times;</button>
        </div>`;
      wrap.appendChild(el);
      requestAnimationFrame(()=>el.classList.add('show'));
      setTimeout(()=>{
        el.classList.remove('show');
        setTimeout(()=>el.remove(),350);
      },ms);
    }

    function setButtonLoading(btn,loading=true){
      if(!btn) return;
      if(loading){
        if(!btn.dataset.originalText) btn.dataset.originalText = btn.innerHTML;
        btn.classList.add('loading');
        btn.disabled = true;
      }else{
        btn.classList.remove('loading');
        btn.disabled = false;
        if(btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText;
      }
    }

    // é¿å… CORSï¼šä¸åŠ  Content-Type (ç€è¦½å™¨é è¨­ text/plainï¼Œé¿å…é æª¢)
    async function callAPI(action,data={},retries=2){
      const payload = {
        action,
          apiKey: CONFIG.API_KEY,
        timestamp: Date.now(),
        ...data
      };
      let lastErr;
      for(let i=0;i<=retries;i++){
        try{
          const res = await fetch(CONFIG.API_BASE_URL,{
            method:'POST',
            body: JSON.stringify(payload) // ç„¡ headers â†’ text/plain
          });
          const text = await res.text();
          let json;
          try{ json = JSON.parse(text); }catch(e){ throw new Error('å›æ‡‰é JSON: '+text.slice(0,120)); }
          if(!json.success) throw new Error(json.message||'API éŒ¯èª¤');
          return json;
        }catch(err){
          lastErr = err;
          await new Promise(r=>setTimeout(r,400*(i+1)));
        }
      }
      throw lastErr;
    }

    // ========== LIFF åˆå§‹åŒ– ==========
    async function initializeLiff(){
      try{
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if(!liff.isLoggedIn()){ liff.login(); return; }
        userProfile = await liff.getProfile();
        // å…ˆé¡¯ç¤º LINE åç¨±
        const bar = document.getElementById('userInfoBar');
        bar.style.display='inline-flex';
        document.getElementById('userLineName').textContent = 'LINEï¼š'+(userProfile.displayName||'');
        document.getElementById('userName').textContent = userProfile.displayName||'æœƒå“¡';
        document.getElementById('userAvatar').textContent = (userProfile.displayName||'?').charAt(0);

        await loadUserData();
        await loadDashboard();
        showNotification('ç³»çµ±åˆå§‹åŒ–å®Œæˆ','success');
      }catch(err){
        console.error(err);
        showNotification('LIFF åˆå§‹åŒ–å¤±æ•—','error');
      }
    }

    // ========== ä½¿ç”¨è€… ==========
    async function loadUserData(){
      try{
        const r = await callAPI('getUserInfo',{ lineId:userProfile.userId });
        if(r.success && r.data){
          currentUser = r.data;
          isAdmin = !!currentUser.isAdmin;
          updateUserUI();
        }else{
          showRegistrationForm();
        }
      }catch{
        showRegistrationForm();
      }
    }

    function updateUserUI(){
      if(!currentUser) return;
      document.getElementById('userName').textContent =
        currentUser.realName || currentUser.lineName || userProfile.displayName || 'æœƒå“¡';
      document.getElementById('userRole').textContent = currentUser.memberType || 'æœƒå“¡';
      document.getElementById('userAvatar').textContent =
        (currentUser.realName || currentUser.lineName || userProfile.displayName || '?').charAt(0);
      document.querySelectorAll('.admin-only').forEach(el=> el.style.display = isAdmin ? 'block':'none');
      updateProfileSection();
    }

    function showRegistrationForm(){
      document.getElementById('registrationSection').style.display='block';
      document.getElementById('profileSection').style.display='none';
    }

    function updateProfileSection(){
      if(!currentUser) return;
      document.getElementById('registrationSection').style.display='none';
      document.getElementById('profileSection').style.display='block';
      document.getElementById('profileRealName').value = currentUser.realName||'';
      document.getElementById('lineName').value = currentUser.lineName||userProfile.displayName||'';
      document.getElementById('phone').value = currentUser.phone||'';
      document.getElementById('email').value = currentUser.email||'';
      document.getElementById('birthday').value = currentUser.birthday||'';
      document.getElementById('profileMemberType').value = currentUser.memberType||'ç—…å‹';
      document.getElementById('address').value = currentUser.address||'';
      // é¡¯ç¤ºå€‹äººçµ±è¨ˆ - å¯è‡ªè¡Œæ“´å……
      document.getElementById('profileStats').innerHTML = `
          <div class="col-sm-6 col-lg-3">
          <div class="stat-card" style="background:var(--info-gradient);">
            <h3>${currentUser.memberType||'-'}</h3><p class="mb-0">èº«ä»½</p>
          </div>
        </div>
      `;
    }

    // è¨»å†Š
    document.getElementById('registrationForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('registerUser',{
          lineId:userProfile.userId,
          lineName:userProfile.displayName,
          realName:fd.get('realName'),
          memberType:fd.get('memberType')
        });
        showNotification('è¨»å†ŠæˆåŠŸ','success');
        await loadUserData();
      }catch(err){
        showNotification('è¨»å†Šå¤±æ•—ï¼š'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });

    // æ›´æ–°å€‹è³‡
    document.getElementById('profileForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('updateProfile',{
          lineId:userProfile.userId,
          phone:fd.get('phone'),
          email:fd.get('email'),
          birthday:fd.get('birthday'),
          memberType:fd.get('memberType'),
          address:fd.get('address')
        });
        showNotification('æ›´æ–°æˆåŠŸ','success');
        await loadUserData();
      }catch(err){
        showNotification('æ›´æ–°å¤±æ•—ï¼š'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });

    // ========== å„€è¡¨æ¿ ==========
    async function loadDashboard(){
      try{
        const r = await callAPI('getDashboardData',{ lineId:userProfile?.userId });
        renderDashboardStats(r.data);
        renderRecentActivity(r.data.recentActivity||[]);
      }catch(err){
        document.getElementById('dashboardStats').innerHTML =
          `<div class="col-12 text-danger text-center">è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>`;
      }
    }
    function renderDashboardStats(d){
      document.getElementById('dashboardStats').innerHTML = `
        <div class="col-md-3"><div class="stat-card" style="background:var(--success-gradient);"><h3>${d.totalActivities||0}</h3><p class="mb-0">å¯å ±åæ´»å‹•</p></div></div>
        <div class="col-md-3"><div class="stat-card" style="background:var(--info-gradient);"><h3>${d.myRegistrations||0}</h3><p class="mb-0">æˆ‘çš„å ±å</p></div></div>
        <div class="col-md-3"><div class="stat-card" style="background:var(--warning-gradient);"><h3>${d.myVolunteerHours||0}</h3><p class="mb-0">å¿—å·¥æ™‚æ•¸</p></div></div>
        <div class="col-md-3"><div class="stat-card" style="background:var(--danger-gradient);"><h3>${formatCurrency(d.myDonationAmount||0).replace('NT$','')}</h3><p class="mb-0">ææ¬¾ç¸½é¡</p></div></div>
      `;
    }
    function renderRecentActivity(list){
      const c = document.getElementById('recentActivity');
      if(!list.length){
        c.innerHTML = '<p class="text-muted mb-0 text-center">æš«ç„¡æœ€è¿‘æ´»å‹•</p>';
        return;
      }
      c.innerHTML = list.map(a=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${a.title||''}</strong>
              <div class="small text-muted">${a.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(a.date)}</small>
            </div>
            <span class="status-badge status-${(a.status||'').trim()}">${a.status||''}</span>
          </div>
        </div>
      `).join('');
    }

    // ========== æ´»å‹• ==========
    async function loadActivities(){
      try{
        const r = await callAPI('getActivities');
        allActivities = r.data||[];
        renderActivities(allActivities);
      }catch(err){
        document.getElementById('activitiesList').innerHTML =
          `<div class="text-danger text-center py-4">è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>`;
      }
    }
    function renderActivities(list){
      const c = document.getElementById('activitiesList');
      if(!list.length){
        c.innerHTML = '<p class="text-muted text-center mb-0">ç›®å‰æ²’æœ‰æ´»å‹•</p>';
        return;
      }
      c.innerHTML = list.map(a=>`
        <div class="activity-item">
          <div class="row">
            <div class="col-md-8">
              <h5 class="mb-1">${a.title}</h5>
              <p class="mb-2 small text-muted">${a.description||''}</p>
              <div class="d-flex flex-wrap gap-3 small text-muted">
                <span><i class="bi bi-calendar me-1"></i>${formatDate(a.date)}</span>
                <span><i class="bi bi-clock me-1"></i>${a.time||'-'}</span>
                <span><i class="bi bi-geo-alt me-1"></i>${a.location||'-'}</span>
                <span><i class="bi bi-people me-1"></i>${a.currentCount||0}/${a.maxParticipants||0}</span>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <span class="status-badge status-${a.status}">${a.status}</span><br>
              <span class="fw-bold text-primary d-inline-block mt-2">${formatCurrency(a.fee||0)}</span><br>
              ${(a.status==='é–‹æ”¾å ±å')? `<button class="btn btn-primary btn-sm mt-2" onclick="registerActivity('${a.id}')"><i class="bi bi-plus-circle me-1"></i>å ±å</button>`:''}
            </div>
          </div>
        </div>
      `).join('');
    }
    function filterActivities(){
      const s = document.getElementById('activityStatusFilter').value.trim();
      const d = document.getElementById('activityDateFilter').value.trim();
      const kw = document.getElementById('activitySearchFilter').value.trim().toLowerCase();
      let list = [...allActivities];
      if(s) list = list.filter(a=>a.status===s);
      if(d) list = list.filter(a=>(a.date||'').startsWith(d));
      if(kw) list = list.filter(a=>(a.title||'').toLowerCase().includes(kw) ||
                                 (a.description||'').toLowerCase().includes(kw) ||
                                 (a.location||'').toLowerCase().includes(kw));
      renderActivities(list);
    }
    async function registerActivity(id){
      if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
      try{
        await callAPI('registerActivity',{ lineId:userProfile.userId, activityId:id });
        showNotification('å ±åæˆåŠŸ','success');
        await loadActivities();
        await loadMyRegistrations();
      }catch(err){
        showNotification('å ±åå¤±æ•—ï¼š'+err.message,'error');
      }
    }
    async function loadMyRegistrations(){
      if(!currentUser) return;
      try{
        const r = await callAPI('getMyRegistrations',{ lineId:userProfile.userId });
        renderMyRegistrations(r.data||[]);
      }catch(err){
        document.getElementById('myRegistrations').innerHTML =
          `<div class="text-danger text-center">è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>`;
      }
    }
    function renderMyRegistrations(list){
      const c = document.getElementById('myRegistrations');
      if(!list.length){
        c.innerHTML='<p class="text-muted text-center mb-0">å°šç„¡å ±å</p>';
        return;
      }
      c.innerHTML = list.map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.activityTitle}</strong>
              <div class="small text-muted mb-1"><i class="bi bi-calendar me-1"></i>${formatDateTime(r.registrationTime)}</div>
              <small class="text-muted">ç‹€æ…‹ï¼š${r.status}</small>
            </div>
            <div class="text-end">
              <span class="status-badge status-${r.status}">${r.status}</span><br>
              ${(r.status==='å·²å ±å')? `<button class="btn btn-danger btn-sm mt-2" onclick="cancelRegistration('${r.id}')"><i class="bi bi-x-circle me-1"></i>å–æ¶ˆ</button>`:''}
            </div>
          </div>
        </div>
      `).join('');
    }
    async function cancelRegistration(regId){
      if(!confirm('ç¢ºå®šå–æ¶ˆé€™ç­†å ±åï¼Ÿ')) return;
      try{
        await callAPI('cancelRegistration',{ lineId:userProfile.userId, registrationId:regId });
        showNotification('å·²å–æ¶ˆ','success');
        await loadMyRegistrations();
        await loadActivities();
      }catch(err){
        showNotification('å–æ¶ˆå¤±æ•—ï¼š'+err.message,'error');
      }
    }

    // ========== å¿—å·¥ ==========
    async function loadVolunteerData(){
      if(!currentUser) return;
      try{
        const r = await callAPI('getVolunteerData',{ lineId:userProfile.userId });
        const s = r.data.stats;
        document.getElementById('volunteerHours').textContent = s.totalHours||0;
        document.getElementById('volunteerActivities').textContent = s.totalActivities||0;
        document.getElementById('volunteerRank').textContent = s.rank||'-';
        document.getElementById('availableNeeds').textContent = s.availableNeeds||0;
        renderVolunteerNeeds(r.data.needs||[]);
        renderVolunteerRecords(r.data.records||[]);
      }catch(err){
        console.error(err);
      }
    }
    function renderVolunteerNeeds(list){
      const c = document.getElementById('volunteerNeeds');
      if(!list.length){
        c.innerHTML='<p class="text-muted text-center mb-0">ç„¡å¿—å·¥éœ€æ±‚</p>';
        return;
      }
      c.innerHTML = list.map(n=>`
        <div class="activity-item">
          <div class="row">
            <div class="col-md-8">
              <strong>${n.title}</strong>
              <div class="small text-muted mb-1">${n.description||''}</div>
              <div class="d-flex flex-wrap gap-3 small text-muted">
                <span><i class="bi bi-calendar me-1"></i>${formatDate(n.date)}</span>
                <span><i class="bi bi-clock me-1"></i>${n.time||'-'}</span>
                <span><i class="bi bi-people me-1"></i>${n.currentCount||0}/${n.needCount}</span>
                <span><i class="bi bi-award me-1"></i>${n.hours} å°æ™‚</span>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <span class="status-badge status-${n.status}">${n.status}</span><br>
              ${(n.status==='é–‹æ”¾å ±å')? `<button class="btn btn-success btn-sm mt-2" onclick="applyVolunteer('${n.id}')"><i class="bi bi-hand-thumbs-up me-1"></i>å ±å</button>`:''}
            </div>
          </div>
        </div>
      `).join('');
    }
    function renderVolunteerRecords(list){
      const c = document.getElementById('myVolunteerRecords');
      if(!list.length){
        c.innerHTML='<p class="text-muted text-center mb-0">å°šç„¡è¨˜éŒ„</p>';
        return;
      }
      c.innerHTML = list.map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.title}</strong>
              <div class="small text-muted mb-1"><i class="bi bi-calendar me-1"></i>${formatDate(r.date)} / ${r.hours} å°æ™‚</div>
              <small class="text-muted">${r.status}</small>
            </div>
            <span class="status-badge status-${r.status}">${r.status}</span>
          </div>
        </div>
      `).join('');
    }
    async function applyVolunteer(id){
      if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
      try{
        await callAPI('applyVolunteer',{ lineId:userProfile.userId, needId:id });
        showNotification('å ±åæˆåŠŸ','success');
        await loadVolunteerData();
      }catch(err){
        showNotification('å ±åå¤±æ•—ï¼š'+err.message,'error');
      }
    }

    // ========== è²¡å‹™ ==========
    async function loadFinanceData(){
      if(!currentUser) return;
      try{
        const r = await callAPI('getFinanceData',{ lineId:userProfile.userId });
        const s = r.data.stats;
        document.getElementById('myDonationAmount').textContent = formatCurrency(s.totalDonation||0).replace('NT$','');
        document.getElementById('myDonationCount').textContent = s.donationCount||0;
        document.getElementById('myExpenseAmount').textContent = formatCurrency(s.totalExpense||0).replace('NT$','');
        document.getElementById('pendingExpenses').textContent = s.pendingExpenses||0;
        renderDonationHistory(r.data.donations||[]);
        renderExpenseHistory(r.data.expenses||[]);
        if(r.data.adminStats && isAdmin) updateAdminFinanceStats(r.data.adminStats);
      }catch(err){ console.error(err); }
    }
    function renderDonationHistory(list){
      const c = document.getElementById('donationHistory');
      if(!list.length){
        c.innerHTML = '<p class="text-muted text-center mb-0">å°šç„¡ææ¬¾</p>';
        return;
      }
      c.innerHTML = list.map(d=>`
        <div class="transaction-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>ææ¬¾ - ${d.category}</strong>
              <div class="small text-muted mb-1">${d.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(d.date)}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold text-success">${formatCurrency(d.amount)}</div>
              <small class="text-muted">æ”¶æ“šï¼š${d.receiptNumber||'è™•ç†ä¸­'}</small>
            </div>
          </div>
        </div>
      `).join('');
    }
    function renderExpenseHistory(list){
      const c = document.getElementById('expenseHistory');
      if(!list.length){
        c.innerHTML = '<p class="text-muted text-center mb-0">å°šç„¡æ”¯å‡º</p>'; return;
      }
      c.innerHTML = list.map(e=>`
        <div class="transaction-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>æ”¯å‡º - ${e.category}</strong>
              <div class="small text-muted mb-1">${e.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(e.date)}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold text-danger">${formatCurrency(e.amount)}</div>
              <span class="status-badge status-${e.status}">${e.status}</span>
            </div>
          </div>
        </div>
      `).join('');
    }
    function updateAdminFinanceStats(s){
      document.getElementById('totalIncome').textContent = formatCurrency(s.totalIncome);
      document.getElementById('totalExpense').textContent = formatCurrency(s.totalExpense);
      document.getElementById('currentBalance').textContent = formatCurrency(s.currentBalance);
      document.getElementById('monthlyDonations').textContent = formatCurrency(s.monthlyDonations);
    }

    // ææ¬¾ Modal
    function showNewDonationModal(){
      if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
      const html = `
        <div class="modal fade" id="donationModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content" id="donationForm">
              <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>æ„›å¿ƒææ¬¾</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="form-floating mb-3">
                  <select class="form-select" id="donationCategory" name="donationCategory" required>
                    <option value="">é¸æ“‡é¡åˆ¥</option>
                    <option value="ä¸€èˆ¬ææ¬¾">ä¸€èˆ¬ææ¬¾</option>
                    <option value="æ´»å‹•è´ŠåŠ©">æ´»å‹•è´ŠåŠ©</option>
                    <option value="è¨­å‚™è³¼ç½®">è¨­å‚™è³¼ç½®</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                  </select>
                  <label for="donationCategory">ææ¬¾é¡åˆ¥ *</label>
                </div>
                <div class="form-floating mb-3">
                  <input type="number" class="form-control" id="donationAmount" name="donationAmount" min="1" required>
                  <label for="donationAmount">é‡‘é¡ *</label>
                </div>
                <div class="form-floating mb-3">
                  <textarea class="form-control" id="donationDescription" name="donationDescription" style="height:100px;"></textarea>
                  <label for="donationDescription">å‚™è¨»</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="needReceipt" name="needReceipt" checked>
                  <label class="form-check-label" for="needReceipt">éœ€è¦æ”¶æ“š</label>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button class="btn btn-success" type="submit"><i class="bi bi-heart-fill me-1"></i>ç¢ºèª</button>
              </div>
            </form>
          </div>
        </div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const modal = new bootstrap.Modal(document.getElementById('donationModal'));
      modal.show();
      document.getElementById('donationForm').addEventListener('submit',handleDonationSubmit);
    }
    async function handleDonationSubmit(e){
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('createDonation',{
          lineId:userProfile.userId,
          category:fd.get('donationCategory'),
          amount:parseInt(fd.get('donationAmount'),10),
          description:fd.get('donationDescription'),
          needReceipt: fd.get('needReceipt')==='on'
        });
        showNotification('ææ¬¾æˆåŠŸ','success');
        bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
        await loadFinanceData();
      }catch(err){
        showNotification('ææ¬¾å¤±æ•—ï¼š'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    }

    // æ”¯å‡ºç”³è«‹
    function showNewExpenseModal(){
      if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
      const html=`
        <div class="modal fade" id="expenseModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content" id="expenseForm">
              <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>æ”¯å‡ºç”³è«‹</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="form-floating mb-3">
                  <select class="form-select" id="expenseCategory" name="expenseCategory" required>
                    <option value="">é¸æ“‡åˆ†é¡</option>
                    <option value="æ´»å‹•è²»ç”¨">æ´»å‹•è²»ç”¨</option>
                    <option value="è¨­å‚™è€—æ">è¨­å‚™è€—æ</option>
                    <option value="è¡Œæ”¿æ”¯å‡º">è¡Œæ”¿æ”¯å‡º</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                  </select>
                  <label for="expenseCategory">æ”¯å‡ºåˆ†é¡ *</label>
                </div>
                <div class="form-floating mb-3">
                  <input type="number" class="form-control" id="expenseAmount" name="expenseAmount" min="1" required>
                  <label for="expenseAmount">é‡‘é¡ *</label>
                </div>
                <div class="form-floating mb-3">
                  <textarea class="form-control" id="expenseDescription" name="expenseDescription" style="height:100px;"></textarea>
                  <label for="expenseDescription">èªªæ˜</label>
                </div>
                <small class="text-muted">ï¼ˆæ”¶æ“šå½±åƒä¸Šå‚³åŠŸèƒ½å¯æ—¥å¾Œæ“´å……ï¼‰</small>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button class="btn btn-warning" type="submit"><i class="bi bi-send me-1"></i>é€å‡º</button>
              </div>
            </form>
          </div>
        </div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const modal=new bootstrap.Modal(document.getElementById('expenseModal'));
      modal.show();
      document.getElementById('expenseForm').addEventListener('submit',handleExpenseSubmit);
    }
    async function handleExpenseSubmit(e){
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('createExpense',{
          lineId:userProfile.userId,
          category:fd.get('expenseCategory'),
          amount:parseInt(fd.get('expenseAmount'),10),
          description:fd.get('expenseDescription')
        });
        showNotification('æ”¯å‡ºç”³è«‹å·²é€å‡º','success');
        bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
        await loadFinanceData();
      }catch(err){
        showNotification('ç”³è«‹å¤±æ•—ï¼š'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    }

    // å¿—å·¥éœ€æ±‚æ–°å¢ (Admin)
    function showNewVolunteerNeedModal(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
      const html=`
        <div class="modal fade" id="volNeedModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content" id="volNeedForm">
              <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>æ–°å¢å¿—å·¥éœ€æ±‚</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="needTitle" name="needTitle" required>
                  <label for="needTitle">æ¨™é¡Œ *</label>
                </div>
                <div class="form-floating mb-3">
                  <textarea class="form-control" id="needDesc" name="needDesc" style="height:100px;"></textarea>
                  <label for="needDesc">æè¿°</label>
                </div>
                <div class="form-floating mb-3">
                  <input type="date" class="form-control" id="needDate" name="needDate" required>
                  <label for="needDate">æ—¥æœŸ *</label>
                </div>
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="needTime" name="needTime" placeholder="09:00-12:00">
                  <label for="needTime">æ™‚é–“</label>
                </div>
                <div class="form-floating mb-3">
                  <input type="number" class="form-control" id="needCount" name="needCount" min="1" required>
                  <label for="needCount">éœ€æ±‚äººæ•¸ *</label>
                </div>
                <div class="form-floating mb-3">
                  <input type="number" class="form-control" id="needHours" name="needHours" min="1" required>
                  <label for="needHours">æ™‚æ•¸ *</label>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button class="btn btn-success" type="submit"><i class="bi bi-save me-1"></i>å»ºç«‹</button>
              </div>
            </form>
          </div>
        </div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const modal=new bootstrap.Modal(document.getElementById('volNeedModal'));
      modal.show();
      document.getElementById('volNeedForm').addEventListener('submit',handleVolunteerNeedSubmit);
    }
    async function handleVolunteerNeedSubmit(e){
      e.preventDefault();
      const fd=new FormData(e.target);
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('createVolunteerNeed',{
          lineId:userProfile.userId,
          title:fd.get('needTitle'),
          description:fd.get('needDesc'),
          date:fd.get('needDate'),
          time:fd.get('needTime'),
          needCount:parseInt(fd.get('needCount'),10),
          hours:parseInt(fd.get('needHours'),10)
        });
        showNotification('éœ€æ±‚å·²å»ºç«‹','success');
        bootstrap.Modal.getInstance(document.getElementById('volNeedModal')).hide();
        await loadVolunteerData();
      }catch(err){
        showNotification('å»ºç«‹å¤±æ•—ï¼š'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    }

    // æ´»å‹•æ–°å¢ (Admin)
    function showNewActivityModal(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
      const html=`
        <div class="modal fade" id="activityModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <form class="modal-content" id="activityForm">
              <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>æ–°å¢æ´»å‹•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body row g-3">
                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="actTitle" name="actTitle" required>
                    <label for="actTitle">æ¨™é¡Œ *</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="date" class="form-control" id="actDate" name="actDate" required>
                    <label for="actDate">æ—¥æœŸ *</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="actTime" name="actTime" placeholder="09:00-11:00">
                    <label for="actTime">æ™‚é–“</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="actLocation" name="actLocation">
                    <label for="actLocation">åœ°é»</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="number" class="form-control" id="actMax" name="actMax" min="1" required>
                    <label for="actMax">åé¡ *</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="number" class="form-control" id="actFee" name="actFee" min="0" value="0">
                    <label for="actFee">è²»ç”¨</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-floating">
                    <textarea class="form-control" id="actDesc" name="actDesc" style="height:120px;"></textarea>
                    <label for="actDesc">æè¿°</label>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button class="btn btn-success" type="submit"><i class="bi bi-save me-1"></i>å»ºç«‹</button>
              </div>
            </form>
          </div>
        </div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const modal=new bootstrap.Modal(document.getElementById('activityModal'));
      modal.show();
      document.getElementById('activityForm').addEventListener('submit',handleActivityCreate);
    }
    async function handleActivityCreate(e){
      e.preventDefault();
      const fd=new FormData(e.target);
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('createActivity',{
          lineId:userProfile.userId,
          title:fd.get('actTitle'),
          date:fd.get('actDate'),
          time:fd.get('actTime'),
          location:fd.get('actLocation'),
          maxParticipants:parseInt(fd.get('actMax'),10),
          fee:parseInt(fd.get('actFee')||'0',10),
          description:fd.get('actDesc')
        });
        showNotification('æ´»å‹•å·²å»ºç«‹','success');
        bootstrap.Modal.getInstance(document.getElementById('activityModal')).hide();
        await loadActivities();
        if(isAdmin) await loadAdminData();
      }catch(err){
        showNotification('å»ºç«‹å¤±æ•—ï¼š'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    }

    // æ–°å¢å¿—å·¥ / æ´»å‹• / äº¤æ˜“ / æ”¶æ“šç­‰ Admin Modal å…¶é¤˜ï¼š
    function showNewTransactionModal(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
      const html=`
        <div class="modal fade" id="txModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content" id="txForm">
              <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>å¿«é€Ÿæ–°å¢äº¤æ˜“</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="form-floating mb-3">
                  <select class="form-select" id="txType" name="txType" required>
                    <option value="">é¸æ“‡é¡å‹</option>
                    <option value="donation">ææ¬¾(æ”¶å…¥)</option>
                    <option value="expense">æ”¯å‡º</option>
                  </select>
                  <label for="txType">é¡å‹ *</label>
                </div>
                <div class="form-floating mb-3">
                  <input class="form-control" id="txCategory" name="txCategory" required>
                  <label for="txCategory">åˆ†é¡ *</label>
                </div>
                <div class="form-floating mb-3">
                  <input type="number" class="form-control" id="txAmount" name="txAmount" min="1" required>
                  <label for="txAmount">é‡‘é¡ *</label>
                </div>
                <div class="form-floating mb-3">
                  <textarea class="form-control" id="txDesc" name="txDesc" style="height:100px;"></textarea>
                  <label for="txDesc">èªªæ˜</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="txNeedReceipt" name="txNeedReceipt">
                  <label class="form-check-label" for="txNeedReceipt">éœ€è¦æ”¶æ“š(åƒ…ææ¬¾)</label>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button class="btn btn-primary" type="submit"><i class="bi bi-check2 me-1"></i>é€å‡º</button>
              </div>
            </form>
          </div>
        </div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const modal=new bootstrap.Modal(document.getElementById('txModal'));
      modal.show();
      document.getElementById('txForm').addEventListener('submit',handleQuickTransactionSubmit);
    }
    async function handleQuickTransactionSubmit(e){
      e.preventDefault();
      const fd=new FormData(e.target);
      const type=fd.get('txType');
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        if(type==='donation'){
          await callAPI('createDonation',{
            lineId:userProfile.userId,
            category:fd.get('txCategory'),
            amount:parseInt(fd.get('txAmount'),10),
            description:fd.get('txDesc'),
            needReceipt: fd.get('txNeedReceipt')==='on'
          });
        }else if(type==='expense'){
          await callAPI('createExpense',{
            lineId:userProfile.userId,
            category:fd.get('txCategory'),
            amount:parseInt(fd.get('txAmount'),10),
            description:fd.get('txDesc')
          });
        }else{
          throw new Error('æœªé¸æ“‡é¡å‹');
        }
        showNotification('å»ºç«‹æˆåŠŸ','success');
        bootstrap.Modal.getInstance(document.getElementById('txModal')).hide();
        await loadFinanceData();
        if(isAdmin) await loadAdminData();
      }catch(err){
        showNotification('å»ºç«‹å¤±æ•—ï¼š'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    }

    function showManualReceiptModal(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
      const html=`
        <div class="modal fade" id="manualReceiptModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content" id="manualReceiptForm">
              <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-receipt-cutoff me-2"></i>æ‰‹å‹•é–‹ç«‹æ”¶æ“š</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="form-floating mb-3">
                  <input class="form-control" id="receiptLineId" name="receiptLineId" placeholder="LINE ID" required>
                  <label for="receiptLineId">æœƒå“¡ LINE ID *</label>
                </div>
                <div class="form-floating mb-3">
                  <select class="form-select" id="receiptType" name="receiptType" required>
                    <option value="">é¸æ“‡é¡åˆ¥</option>
                    <option value="ææ¬¾">ææ¬¾</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                  </select>
                  <label for="receiptType">é¡åˆ¥ *</label>
                </div>
                <div class="form-floating mb-3">
                  <input type="number" class="form-control" id="receiptAmount" name="receiptAmount" min="1" required>
                  <label for="receiptAmount">é‡‘é¡ *</label>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button class="btn btn-success" type="submit"><i class="bi bi-save me-1"></i>é–‹ç«‹</button>
              </div>
            </form>
          </div>
        </div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('manualReceiptModal'));
      m.show();
      document.getElementById('manualReceiptForm').addEventListener('submit',handleManualReceiptSubmit);
    }
    async function handleManualReceiptSubmit(e){
      e.preventDefault();
      const fd=new FormData(e.target);
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('createManualReceipt',{
          lineId:userProfile.userId,
          targetLineId:fd.get('receiptLineId'),
          type:fd.get('receiptType'),
          amount:parseInt(fd.get('receiptAmount'),10)
        });
        showNotification('æ”¶æ“šå·²é–‹ç«‹','success');
        bootstrap.Modal.getInstance(document.getElementById('manualReceiptModal')).hide();
        if(isAdmin) await loadAdminData();
      }catch(err){
        showNotification('é–‹ç«‹å¤±æ•—ï¼š'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    }

    function showReceiptTemplateModal(){
      showNotification('æ¨¡æ¿è¨­å®šå°šæœªå¯¦ä½œï¼Œå¯å¾ŒçºŒæ“´å……','warning',3500);
    }

    function showSystemNotificationModal(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
      const html=`
        <div class="modal fade" id="sysNotifyModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content" id="sysNotifyForm">
              <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-megaphone me-2"></i>ç™¼é€ç³»çµ±é€šçŸ¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="form-floating">
                  <textarea class="form-control" id="notifyMessage" name="notifyMessage" style="height:140px;" required></textarea>
                  <label for="notifyMessage">é€šçŸ¥å…§å®¹ *</label>
                </div>
                <small class="text-muted d-block mt-2">ï¼ˆæ­¤åŠŸèƒ½ç›®å‰ç‚ºç¤ºæ„ï¼Œå¯æ¥ LINE BOT æ¨æ’­ï¼‰</small>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button class="btn btn-info" type="submit"><i class="bi bi-send me-1"></i>ç™¼é€</button>
              </div>
            </form>
          </div>
        </div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('sysNotifyModal'));
      m.show();
      document.getElementById('sysNotifyForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const fd=new FormData(e.target);
        const btn=e.target.querySelector('button[type="submit"]');
        setButtonLoading(btn,true);
        try{
          await callAPI('sendSystemNotification',{
            lineId:userProfile.userId,
            message:fd.get('notifyMessage')
          });
          showNotification('é€šçŸ¥å·²ç™¼é€','success');
          bootstrap.Modal.getInstance(document.getElementById('sysNotifyModal')).hide();
        }catch(err){
          showNotification('ç™¼é€å¤±æ•—ï¼š'+err.message,'error');
        }finally{ setButtonLoading(btn,false); }
      });
    }

    function viewMemberDetail(lineId){
      const member = (cachedAdminData?.members||[]).find(m=>m.lineId===lineId);
      if(!member){ showNotification('æ‰¾ä¸åˆ°æœƒå“¡','error'); return; }
      const html=`
        <div class="modal fade" id="memberDetailModal" tabindex="-1">
          <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person me-2"></i>${member.realName||member.lineName||lineId}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <ul class="list-group small">
                  <li class="list-group-item"><strong>LINE IDï¼š</strong>${member.lineId}</li>
                  <li class="list-group-item"><strong>å§“åï¼š</strong>${member.realName||'-'}</li>
                  <li class="list-group-item"><strong>é¡åˆ¥ï¼š</strong>${member.memberType||'-'}</li>
                  <li class="list-group-item"><strong>é›»è©±ï¼š</strong>${member.phone||'-'}</li>
                  <li class="list-group-item"><strong>Emailï¼š</strong>${member.email||'-'}</li>
                  <li class="list-group-item"><strong>ç”Ÿæ—¥ï¼š</strong>${member.birthday||'-'}</li>
                  <li class="list-group-item"><strong>åœ°å€ï¼š</strong>${member.address||'-'}</li>
                  <li class="list-group-item"><strong>ç‹€æ…‹ï¼š</strong>${member.status||'-'}</li>
                  <li class="list-group-item"><strong>ææ¬¾æ¬¡æ•¸ï¼š</strong>${member.donationCount||0}</li>
                  <li class="list-group-item"><strong>åŠ å…¥æ—¥æœŸï¼š</strong>${formatDate(member.joinDate)}</li>
                </ul>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">é—œé–‰</button>
              </div>
            </div>
          </div>
        </div>`;
      document.getElementById('modalContainer').innerHTML=html;
      new bootstrap.Modal(document.getElementById('memberDetailModal')).show();
    }

    // ========== å›é¥‹ ==========
    async function loadFeedbackData(){
      if(!currentUser) return;
      try{
        const acts = await callAPI('getMyCompletedActivities',{ lineId:userProfile.userId });
        populateFeedbackActivities(acts.data||[]);
        const my = await callAPI('getMyFeedback',{ lineId:userProfile.userId });
        renderMyFeedback(my.data||[]);
        if(isAdmin){
          const all = await callAPI('getAllFeedback',{ lineId:userProfile.userId });
          renderAllFeedback(all.data||[]);
        }
      }catch(err){ console.error(err); }
    }
    function populateFeedbackActivities(list){
      const sel=document.getElementById('feedbackActivity');
      sel.innerHTML='<option value="">è«‹é¸æ“‡æ´»å‹•</option>';
      list.forEach(a=>{
        sel.innerHTML += `<option value="${a.id}">${a.title} (${formatDate(a.date)})</option>`;
      });
    }
    function renderMyFeedback(list){
      const c=document.getElementById('myFeedback');
      if(!list.length){ c.innerHTML='<p class="text-muted text-center mb-0">å°šç„¡å›é¥‹</p>'; return; }
      c.innerHTML = list.map(f=>`
        <div class="activity-item">
          <strong>${f.activityTitle}</strong>
          <div class="small mb-1">${'â˜…'.repeat(f.rating)}${'â˜†'.repeat(5-f.rating)} <span class="text-muted">(${f.rating}/5)</span></div>
          <div class="mb-1">${f.comment}</div>
          <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(f.createdAt)}</small>
        </div>
      `).join('');
    }
    function renderAllFeedback(list){
      const c=document.getElementById('allFeedback');
      if(!list.length){ c.innerHTML='<p class="text-muted text-center mb-0">ç„¡è³‡æ–™</p>'; return; }
      c.innerHTML = list.map(f=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${f.activityTitle}</strong>
              <div class="small mb-1">${'â˜…'.repeat(f.rating)}${'â˜†'.repeat(5-f.rating)} <span class="text-muted">(${f.rating}/5)</span></div>
              <div class="mb-1">${f.comment}</div>
              <small class="text-muted">${formatDateTime(f.createdAt)}</small>
            </div>
            <small class="text-muted">${f.lineId}</small>
          </div>
        </div>
      `).join('');
    }
    document.getElementById('feedbackForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('createFeedback',{
          lineId:userProfile.userId,
          activityId:fd.get('feedbackActivity'),
          rating:parseInt(fd.get('feedbackRating'),10),
          comment:fd.get('feedbackComment')
        });
        showNotification('å›é¥‹å·²æäº¤','success');
        e.target.reset();
        await loadFeedbackData();
      }catch(err){
        showNotification('æäº¤å¤±æ•—ï¼š'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });

    // ========== Admin è³‡æ–™ ==========
    async function loadAdminData(){
      if(!isAdmin) return;
      try{
        const r=await callAPI('getAdminData',{ lineId:userProfile.userId });
        cachedAdminData=r.data;
        renderMemberList(r.data.members||[]);
        renderAdminActivities(r.data.activities||[]);
        renderTransactions(r.data.transactions||[]);
        renderReceipts(r.data.receipts||[]);
      }catch(err){ console.error(err); }
    }
    function renderMemberList(list){
      const tb=document.getElementById('memberList');
      if(!list.length){
        tb.innerHTML='<tr><td colspan="6" class="text-center text-muted">æš«ç„¡è³‡æ–™</td></tr>'; return;
      }
      tb.innerHTML=list.map(m=>`
        <tr>
          <td>${m.realName||m.lineName||'-'}</td>
          <td>${m.memberType||'-'}</td>
          <td><span class="status-badge status-${m.status||''}">${m.status||''}</span></td>
          <td>${formatDate(m.joinDate)}</td>
          <td>${m.donationCount||0}</td>
          <td><button class="btn btn-sm btn-outline-primary" onclick="viewMemberDetail('${m.lineId}')"><i class="bi bi-eye"></i></button></td>
        </tr>
      `).join('');
    }
    function renderAdminActivities(list){
      const c=document.getElementById('adminActivityList');
      if(!list.length){
        c.innerHTML='<p class="text-muted text-center mb-0">ç„¡æ´»å‹•</p>'; return;
      }
      c.innerHTML=list.map(a=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>${a.title}</strong>
              <div class="small text-muted">${formatDate(a.date)} / ${a.location||''}</div>
            </div>
            <div class="text-end">
              <span class="status-badge status-${a.status}">${a.status}</span><br>
              <small>${a.currentCount||0}/${a.maxParticipants||0}</small>
            </div>
          </div>
        </div>
      `).join('');
    }
    function renderTransactions(list){
      const tb=document.getElementById('transactionList');
      if(!list.length){ tb.innerHTML='<tr><td colspan="6" class="text-center text-muted">ç„¡äº¤æ˜“</td></tr>'; return; }
      tb.innerHTML=list.map(t=>`
        <tr>
          <td>${formatDateTime(t.date)}</td>
          <td>${t.type}</td>
          <td class="${t.type==='æ”¶å…¥'?'text-success':'text-danger'}">${formatCurrency(t.amount)}</td>
          <td>${t.category||''}</td>
          <td>${t.description||''}</td>
          <td>${t.status? `<span class="status-badge status-${t.status}">${t.status}</span>`:''}</td>
        </tr>
      `).join('');
    }
    function renderReceipts(list){
      const c=document.getElementById('receiptList');
      if(!list.length){ c.innerHTML='<p class="text-muted text-center mb-0">å°šç„¡æ”¶æ“š</p>'; return; }
      c.innerHTML=list.map(r=>`
        <div class="transaction-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.receiptNumber}</strong>
              <div class="small text-muted">${formatDate(r.issueDate)} / ${r.type}</div>
            </div>
            <div class="text-end">
              <div class="fw-bold">${formatCurrency(r.amount)}</div>
              <span class="status-badge status-${r.status}">${r.status}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    // åŒ¯å‡º / å‚™ä»½
    async function exportMembers(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
      try{
        const r=await callAPI('exportMembers',{ lineId:userProfile.userId });
        showNotification('æœƒå“¡è³‡æ–™åŒ¯å‡ºæˆåŠŸ (è‡³é›²ç«¯ç¡¬ç¢Ÿ)','success');
        console.log(r.data);
      }catch(err){ showNotification('åŒ¯å‡ºå¤±æ•—ï¼š'+err.message,'error'); }
    }
    async function exportFinanceData(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
      try{
        const r=await callAPI('exportFinanceData',{ lineId:userProfile.userId });
        showNotification('è²¡å‹™è³‡æ–™åŒ¯å‡ºæˆåŠŸ','success');
        console.log(r.data);
      }catch(err){ showNotification('åŒ¯å‡ºå¤±æ•—ï¼š'+err.message,'error'); }
    }
    async function backupSystem(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
      try{
        const r=await callAPI('backupSystem',{ lineId:userProfile.userId });
        showNotification('å‚™ä»½å®Œæˆ','success');
        console.log(r.data);
      }catch(err){ showNotification('å‚™ä»½å¤±æ•—ï¼š'+err.message,'error'); }
    }

    // ========== åˆ·æ–° ==========
    async function refreshData(){
      try{
        await Promise.all([
          loadDashboard(),
          loadActivities(),
          loadMyRegistrations(),
          loadVolunteerData(),
          loadFinanceData(),
          loadFeedbackData(),
          isAdmin? loadAdminData(): Promise.resolve()
        ]);
        showNotification('è³‡æ–™å·²åˆ·æ–°','success');
      }catch(err){
        showNotification('åˆ·æ–°å¤±æ•—ï¼š'+err.message,'error');
      }
    }

    // ========== Tab åˆ‡æ›äº‹ä»¶ ==========
    document.addEventListener('DOMContentLoaded',()=>{
      document.querySelectorAll('[data-bs-toggle="pill"]').forEach(btn=>{
        btn.addEventListener('shown.bs.tab',e=>{
          const id = e.target.getAttribute('data-bs-target').substring(1);
          switch(id){
            case 'activities': loadActivities(); loadMyRegistrations(); break;
            case 'volunteer': loadVolunteerData(); break;
            case 'finance': loadFinanceData(); break;
            case 'feedback': loadFeedbackData(); break;
            case 'admin': if(isAdmin) loadAdminData(); break;
          }
        });
      });
    });

    // ç¦ç”¨é textarea Enter submit
    document.addEventListener('keydown',e=>{
      if(e.key==='Enter' && !['TEXTAREA','BUTTON'].includes(e.target.tagName)){
        e.preventDefault();
      }
    });

    // å…¨åŸŸçµ¦æŒ‰éˆ•ä½¿ç”¨
    window.showTab = id=>{
      const btn=document.querySelector(`button[data-bs-target="#${id}"]`);
      if(btn) btn.click();
    };
    window.refreshData = refreshData;
    window.registerActivity = registerActivity;
    window.cancelRegistration = cancelRegistration;
    window.applyVolunteer = applyVolunteer;
    window.showNewDonationModal = showNewDonationModal;
    window.showNewExpenseModal = showNewExpenseModal;
    window.showNewActivityModal = showNewActivityModal;
    window.showNewVolunteerNeedModal = showNewVolunteerNeedModal;
    window.showNewTransactionModal = showNewTransactionModal;
    window.showManualReceiptModal = showManualReceiptModal;
    window.showReceiptTemplateModal = showReceiptTemplateModal;
    window.showSystemNotificationModal = showSystemNotificationModal;
    window.exportMembers = exportMembers;
    window.exportFinanceData = exportFinanceData;
    window.backupSystem = backupSystem;
    window.viewMemberDetail = viewMemberDetail;

    window.addEventListener('load',initializeLiff);
  </script>
</body>
</html>
