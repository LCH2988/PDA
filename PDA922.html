/**
 * å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ± - å¾Œç«¯æ•´åˆå®Œæ•´ç‰ˆ (Code.gs)
 * åŠŸèƒ½åŒ…å«ï¼š
 * - æœƒå“¡ / æ´»å‹• / å¿—å·¥ / è²¡å‹™ï¼ˆææ¬¾ã€æ”¯å‡ºï¼‰/ æ”¶æ“š / å›é¥‹ / ç³»çµ±æ—¥èªŒ
 * - è¨­å®šç®¡ç†ï¼ˆæ”¶æ“šæ¨¡ç‰ˆã€ä¿¡ä»¶å›è¦†æ¨¡ç‰ˆã€æ”¶å…¥/æ”¯å‡ºé¡åˆ¥ã€æ”¯å‡ºæ†‘è­‰æ¨¡ç‰ˆï¼‰
 * - æ”¶æ“š PDF / æ”¯å‡ºæ†‘è­‰ PDF ç”¢ç”Ÿï¼ˆæ”¯æ´æ¨¡ç‰ˆå ä½ç¬¦ï¼‰
 * - åŒ¯å‡º / å‚™ä»½ / ç³»çµ±é€šçŸ¥
 */

const CONFIG = {
  API_KEY: 'AAbb8520258185202581',
  ADMIN_LINE_IDS: [
    'U09b4c2535730fbb5643274ba1526ec9c',
    'U1234567890abcdef1234567890abcde2'
  ],
  SPREADSHEET_ID: '1ZIcuR4WMKGKU14XHk8HY1jqRbv6ntNIGmXmevOIIxNw',
  SHEETS: {
    USERS: 'æœƒå“¡è³‡æ–™',
    ACTIVITIES: 'æ´»å‹•è³‡æ–™',
    REGISTRATIONS: 'æ´»å‹•å ±å',
    VOLUNTEERS: 'å¿—å·¥éœ€æ±‚',
    VOLUNTEER_RECORDS: 'å¿—å·¥è¨˜éŒ„',
    DONATIONS: 'ææ¬¾è¨˜éŒ„',
    EXPENSES: 'æ”¯å‡ºè¨˜éŒ„',
    FEEDBACK: 'æ´»å‹•å›é¥‹',
    RECEIPTS: 'æ”¶æ“šè¨˜éŒ„',
    SYSTEM_LOG: 'ç³»çµ±æ—¥èªŒ'
    // SETTINGS ä¸æ”¾å…¥æ­¤åˆ—ï¼Œå°ˆç”¨å‡½å¼è™•ç†
  }
};

// ========== Utilities ==========
function resp(success,message,data){
  return ContentService.createTextOutput(JSON.stringify({
    success,message,data:data||null,timestamp:new Date().toISOString()
  })).setMimeType(ContentService.MimeType.JSON);
}
const getSS = ()=>SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
function getSheet(name){
  const ss=getSS();
  let sh=ss.getSheetByName(name);
  if(!sh){ sh=ss.insertSheet(name); initSheet(sh,name); }
  else ensureSheetColumns(sh,name);
  return sh;
}
function ensureSheetColumns(sh,name){
  const required={
    [CONFIG.SHEETS.USERS]: [
      'lineId','lineName','realName','memberType','phone','email','birthday','address',
      'status','joinDate','isAdmin','lastUpdate',
      'diagnosisDate','diseaseStage','medications','symptoms','mobility',
      'caregiverName','caregiverPhone','emergencyContact','medicalHistory','notes'
    ],
    [CONFIG.SHEETS.RECEIPTS]: [
      'id','receiptNumber','lineId','type','amount','issueDate','status','pdfUrl','fileId','emailSent','emailDate'
    ],
    [CONFIG.SHEETS.EXPENSES]: [
      'id','lineId','category','amount','description','receiptImage','status','approvedBy','createdAt','approvedAt',
      'paymentDate','paymentAccount','paymentMethod','bankTransferDate','verifiedBy',
      'voucherPdfUrl','voucherFileId'
    ],
    [CONFIG.SHEETS.DONATIONS]: [
      'id','lineId','category','amount','description','needReceipt','receiptNumber','status','createdAt',
      'bankDate','bankAccount','verifiedBy','verifiedAt'
    ]
  }[name];
  if(!required) return;
  const current=sh.getDataRange().getValues()[0]||[];
  const needAdd=required.filter(h=>current.indexOf(h)===-1);
  if(needAdd.length){
    sh.insertColumnsAfter(current.length||1,needAdd.length);
    sh.getRange(1,current.length+1,1,needAdd.length).setValues([needAdd]);
  }
}
function initSheet(sh,name){
  const headers={
    [CONFIG.SHEETS.USERS]: [
      'lineId','lineName','realName','memberType','phone','email','birthday','address',
      'status','joinDate','isAdmin','lastUpdate',
      'diagnosisDate','diseaseStage','medications','symptoms','mobility',
      'caregiverName','caregiverPhone','emergencyContact','medicalHistory','notes'
    ],
    [CONFIG.SHEETS.ACTIVITIES]: ['id','title','description','date','time','location','maxParticipants','currentCount','fee','status','createdBy','createdAt'],
    [CONFIG.SHEETS.REGISTRATIONS]: ['id','lineId','activityId','activityTitle','status','registrationTime','paymentStatus','notes'],
    [CONFIG.SHEETS.VOLUNTEERS]: ['id','title','description','date','time','needCount','currentCount','hours','status','createdBy','createdAt'],
    [CONFIG.SHEETS.VOLUNTEER_RECORDS]: ['id','lineId','needId','title','date','hours','status','feedback','createdAt'],
    [CONFIG.SHEETS.DONATIONS]: [
      'id','lineId','category','amount','description','needReceipt','receiptNumber','status','createdAt',
      'bankDate','bankAccount','verifiedBy','verifiedAt'
    ],
    [CONFIG.SHEETS.EXPENSES]: [
      'id','lineId','category','amount','description','receiptImage','status','approvedBy','createdAt','approvedAt',
      'paymentDate','paymentAccount','paymentMethod','bankTransferDate','verifiedBy','voucherPdfUrl','voucherFileId'
    ],
    [CONFIG.SHEETS.FEEDBACK]: ['id','lineId','activityId','activityTitle','rating','comment','createdAt'],
    [CONFIG.SHEETS.RECEIPTS]: ['id','receiptNumber','lineId','type','amount','issueDate','status','pdfUrl','fileId','emailSent','emailDate'],
    [CONFIG.SHEETS.SYSTEM_LOG]: ['timestamp','action','lineId','details','ip']
  }[name]||[];
  if(headers.length){
    sh.getRange(1,1,1,headers.length).setValues([headers]);
    sh.setFrozenRows(1);
  }
}
const genId = ()=>Utilities.getUuid().slice(0,10);
const isAdmin = id => CONFIG.ADMIN_LINE_IDS.indexOf(id)>=0;
function logAPICall(action,lineId,details){
  try{
    const sh=getSheet(CONFIG.SHEETS.SYSTEM_LOG);
    sh.appendRow([new Date(),action,lineId,JSON.stringify(details).slice(0,4000),'web']);
  }catch(e){}
}

// ====== è¨­å®š (SETTINGS) ======
function getSettingsSheet(){
  const ss = getSS();
  let sh = ss.getSheetByName('SETTINGS');
  if(!sh){
    sh = ss.insertSheet('SETTINGS');
    sh.getRange(1,1,1,4).setValues([['key','value','updatedAt','updatedBy']]);
    sh.setFrozenRows(1);
  }
  return sh;
}

// function getSettingsMap(){
//   const sh = getSettingsSheet();
//   const vals = sh.getDataRange().getValues();
//   const map = {};
//   for(let i=1;i<vals.length;i++){
//     map[vals[i][0]] = vals[i][1];
//   }
//   return map;
// }

// function getSettings(d){
//   if(!isAdmin(d.lineId)) return resp(false,'æ¬Šé™ä¸è¶³');
//   const map = getSettingsMap();
//   const out = {
//     receiptTemplateDocId: map.RECEIPT_TEMPLATE_DOC_ID || '',
//     emailReplyTemplate: map.EMAIL_REPLY_TEMPLATE || '',
//     incomeCategories: map.INCOME_CATEGORIES ? JSON.parse(map.INCOME_CATEGORIES) : [],
//     expenseCategories: map.EXPENSE_CATEGORIES ? JSON.parse(map.EXPENSE_CATEGORIES) : [],
//     expenseVoucherTemplateDocId: map.EXPENSE_VOUCHER_TEMPLATE_DOC_ID || ''
//   };
//   return resp(true,'OK',out);
// }
// function writeSettings(updates, adminLineId){
//   const sh = getSettingsSheet();
//   const now = new Date();
//   const data = sh.getDataRange().getValues();
//   const keyIndex = {};
//   for(let i=1;i<data.length;i++){
//     keyIndex[data[i][0]] = i+1;
//   }
//   Object.keys(updates).forEach(k=>{
//     const v = updates[k];
//     if(keyIndex[k]){
//       sh.getRange(keyIndex[k],2,1,3).setValues([[v, now, adminLineId]]);
//     }else{
//       sh.appendRow([k,v,now,adminLineId]);
//     }
//   });
// }
// function updateSettings(d){
//   if(!isAdmin(d.lineId)) return resp(false,'æ¬Šé™ä¸è¶³');
//   const updates = {};
//   if(d.receiptTemplateDocId !== undefined) updates.RECEIPT_TEMPLATE_DOC_ID = d.receiptTemplateDocId.trim();
//   if(d.emailReplyTemplate !== undefined) updates.EMAIL_REPLY_TEMPLATE = d.emailReplyTemplate;
//   if(d.incomeCategories !== undefined){
//     if(!Array.isArray(d.incomeCategories)) return resp(false,'incomeCategories éœ€ç‚ºé™£åˆ—');
//     updates.INCOME_CATEGORIES = JSON.stringify(d.incomeCategories.filter(x=>x && x.trim()));
//   }
//   if(d.expenseCategories !== undefined){
//     if(!Array.isArray(d.expenseCategories)) return resp(false,'expenseCategories éœ€ç‚ºé™£åˆ—');
//     updates.EXPENSE_CATEGORIES = JSON.stringify(d.expenseCategories.filter(x=>x && x.trim()));
//   }
//   if(d.expenseVoucherTemplateDocId !== undefined) updates.EXPENSE_VOUCHER_TEMPLATE_DOC_ID = d.expenseVoucherTemplateDocId.trim();
//   if(Object.keys(updates).length===0) return resp(false,'ç„¡å¯æ›´æ–°æ¬„ä½');
//   writeSettings(updates,d.lineId);
//   return resp(true,'è¨­å®šå·²æ›´æ–°');
// }
// function applyTemplateToDoc(docId, placeholderMap){
//   const doc = DocumentApp.openById(docId);
//   const body = doc.getBody();
//   Object.keys(placeholderMap).forEach(k=>{
//     body.replaceText('{{'+k+'}}', placeholderMap[k]===undefined?'':String(placeholderMap[k]));
//   });
//   doc.saveAndClose();
//   return doc;
// }



// ========== ä½¿ç”¨è€… ==========
function getUserInfo(d){
  const sh=getSheet(CONFIG.SHEETS.USERS);
  const vals=sh.getDataRange().getValues();
  const headers=vals[0];
  for(let i=1;i<vals.length;i++){
    if(vals[i][0]===d.lineId){
      const o={}; headers.forEach((h,j)=>o[h]=vals[i][j]);
      o.isAdmin=isAdmin(d.lineId);
      return resp(true,'OK',o);
    }
  }
  return resp(false,'ç”¨æˆ¶æœªè¨»å†Š');
}
function registerUser(d){
  if(!d.lineId||!d.realName||!d.memberType) return resp(false,'ç¼ºå°‘å¿…è¦æ¬„ä½');
  const sh=getSheet(CONFIG.SHEETS.USERS);
  const vals=sh.getDataRange().getValues();
  for(let i=1;i<vals.length;i++) if(vals[i][0]===d.lineId) return resp(false,'å·²è¨»å†Š');
  sh.appendRow([
    d.lineId,d.lineName||'',d.realName,d.memberType,'','', '', '', 'å·²è¨»å†Š', new Date(),
    isAdmin(d.lineId), new Date(),
    '','','','','','','','','',''
  ]);
  return resp(true,'è¨»å†ŠæˆåŠŸ');
}
function updateProfile(d){
  if(!d.lineId) return resp(false,'ç¼º lineId');
  const sh=getSheet(CONFIG.SHEETS.USERS);
  const vals=sh.getDataRange().getValues();
  const headers=vals[0];
  const idx=vals.findIndex(r=>r[0]===d.lineId);
  if(idx<1) return resp(false,'æ‰¾ä¸åˆ°ç”¨æˆ¶');
  const row=vals[idx];
  const set=(f,v)=>{ const i=headers.indexOf(f); if(i>-1 && v!==undefined) row[i]=v; };
  ['phone','email','birthday','address','memberType','diagnosisDate','diseaseStage','medications','symptoms','mobility','caregiverName','caregiverPhone','emergencyContact','medicalHistory','notes']
    .forEach(f=> set(f,d[f]));
  set('lastUpdate',new Date());
  sh.getRange(idx+1,1,1,row.length).setValues([row]);
  return resp(true,'æ›´æ–°æˆåŠŸ');
}

// ========== å„€è¡¨æ¿ ==========
function getDashboardData(d){
  const out={ totalActivities:0,myRegistrations:0,myVolunteerHours:0,myDonationAmount:0,recentActivity:[] };
  const actSh=getSheet(CONFIG.SHEETS.ACTIVITIES).getDataRange().getValues();
  out.totalActivities=actSh.slice(1).filter(r=>r[9]==='é–‹æ”¾å ±å').length;
  if(d.lineId){
    const regSh=getSheet(CONFIG.SHEETS.REGISTRATIONS).getDataRange().getValues();
    out.myRegistrations=regSh.slice(1).filter(r=>r[1]===d.lineId && r[4]==='å·²å ±å').length;
    const volSh=getSheet(CONFIG.SHEETS.VOLUNTEER_RECORDS).getDataRange().getValues();
    out.myVolunteerHours=volSh.slice(1).filter(r=>r[1]===d.lineId && r[6]==='å·²å®Œæˆ').reduce((s,r)=>s+(r[5]||0),0);
    const donSh=getSheet(CONFIG.SHEETS.DONATIONS).getDataRange().getValues();
    out.myDonationAmount=donSh.slice(1).filter(r=>r[1]===d.lineId).reduce((s,r)=>s+(r[3]||0),0);
    out.recentActivity=regSh.slice(1).filter(r=>r[1]===d.lineId).slice(-5)
      .map(r=>({ title:r[3], description:'æ´»å‹•å ±å', date:r[5], status:r[4]}))
      .sort((a,b)=> new Date(b.date)-new Date(a.date));
  }
  return resp(true,'OK',out);
}

// ========== æ´»å‹• ==========
function getActivities(){
  const sh=getSheet(CONFIG.SHEETS.ACTIVITIES);
  const vals=sh.getDataRange().getValues();
  const headers=vals[0];
  const list=vals.slice(1).map(r=>{
    const o={}; headers.forEach((h,i)=>o[h]=r[i]); return o;
  }).filter(o=>o.status!=='å·²åˆªé™¤');
  return resp(true,'OK',list);
}
function registerActivity(d){
  if(!d.lineId||!d.activityId) return resp(false,'ç¼ºåƒæ•¸');
  const lock=LockService.getScriptLock(); lock.tryLock(20000);
  try{
    const actSh=getSheet(CONFIG.SHEETS.ACTIVITIES);
    const acts=actSh.getDataRange().getValues();
    let target=null,rowIdx=-1;
    for(let i=1;i<acts.length;i++){
      if(acts[i][0]===d.activityId){ target=acts[i]; rowIdx=i+1; break; }
    }
    if(!target) return resp(false,'æ´»å‹•ä¸å­˜åœ¨');
    if(target[9]!=='é–‹æ”¾å ±å') return resp(false,'ä¸é–‹æ”¾å ±å');
    const regSh=getSheet(CONFIG.SHEETS.REGISTRATIONS);
    const regs=regSh.getDataRange().getValues();
    for(let i=1;i<regs.length;i++){
      if(regs[i][1]===d.lineId && regs[i][2]===d.activityId && regs[i][4]==='å·²å ±å') return resp(false,'å·²å ±å');
    }
    const current=regs.slice(1).filter(r=>r[2]===d.activityId && r[4]==='å·²å ±å').length;
    if(current>=target[6]) return resp(false,'åé¡å·²æ»¿');
    regSh.appendRow([genId(),d.lineId,d.activityId,target[1],'å·²å ±å',new Date(),'å¾…ä»˜æ¬¾','']);
    actSh.getRange(rowIdx,8).setValue(current+1);
    return resp(true,'å ±åæˆåŠŸ');
  }finally{ lock.releaseLock(); }
}
function cancelRegistration(d){
  if(!d.lineId||!d.registrationId) return resp(false,'ç¼ºåƒæ•¸');
  const sh=getSheet(CONFIG.SHEETS.REGISTRATIONS);
  const vals=sh.getDataRange().getValues();
  for(let i=1;i<vals.length;i++){
    if(vals[i][0]===d.registrationId && vals[i][1]===d.lineId){
      sh.getRange(i+1,5).setValue('å·²å–æ¶ˆ');
      updateActivityCount(vals[i][2]);
      return resp(true,'å·²å–æ¶ˆ');
    }
  }
  return resp(false,'æ‰¾ä¸åˆ°å ±å');
}
function getMyRegistrations(d){
  if(!d.lineId) return resp(false,'ç¼º lineId');
  const sh=getSheet(CONFIG.SHEETS.REGISTRATIONS);
  const vals=sh.getDataRange().getValues();
  const headers=vals[0];
  const list=vals.slice(1).filter(r=>r[1]===d.lineId).map(r=>{
    const o={}; headers.forEach((h,i)=>o[h]=r[i]); return o;
  });
  return resp(true,'OK',list);
}
function getMyCompletedActivities(d){
  if(!d.lineId) return resp(false,'ç¼º lineId');
  const sh=getSheet(CONFIG.SHEETS.REGISTRATIONS);
  const vals=sh.getDataRange().getValues();
  const list=vals.slice(1).filter(r=>r[1]===d.lineId && r[4]==='å·²å®Œæˆ')
    .map(r=>({ id:r[2], title:r[3], date:r[5] }));
  return resp(true,'OK',list);
}
function updateActivityCount(activityId){
  const reg=getSheet(CONFIG.SHEETS.REGISTRATIONS).getDataRange().getValues();
  const cnt=reg.slice(1).filter(r=>r[2]===activityId && r[4]==='å·²å ±å').length;
  const actSh=getSheet(CONFIG.SHEETS.ACTIVITIES);
  const acts=actSh.getDataRange().getValues();
  for(let i=1;i<acts.length;i++){
    if(acts[i][0]===activityId){
      actSh.getRange(i+1,8).setValue(cnt);
      break;
    }
  }
}

// ========== å¿—å·¥ ==========
function getVolunteerData(d){
  const out={ stats:{ totalHours:0,totalActivities:0,rank:'-',availableNeeds:0 }, needs:[], records:[] };
  if(d.lineId){
    const rec=getSheet(CONFIG.SHEETS.VOLUNTEER_RECORDS).getDataRange().getValues();
    const mine=rec.slice(1).filter(r=>r[1]===d.lineId);
    out.stats.totalHours=mine.filter(r=>r[6]==='å·²å®Œæˆ').reduce((s,r)=>s+(r[5]||0),0);
    out.stats.totalActivities=mine.length;
    out.records=mine.map(r=>({ id:r[0], title:r[3], description:r[3], date:r[4], hours:r[5], status:r[6], feedback:r[7] }));
  }
  const needSh=getSheet(CONFIG.SHEETS.VOLUNTEERS).getDataRange().getValues();
  out.needs=needSh.slice(1).filter(r=>r[8]==='é–‹æ”¾å ±å').map(r=>({
    id:r[0], title:r[1], description:r[2], date:r[3], time:r[4],
    needCount:r[5], currentCount:r[6], hours:r[7], status:r[8]
  }));
  out.stats.availableNeeds=out.needs.length;
  return resp(true,'OK',out);
}
function applyVolunteer(d){
  if(!d.lineId||!d.needId) return resp(false,'ç¼ºåƒæ•¸');
  const lock=LockService.getScriptLock(); lock.tryLock(15000);
  try{
    const sh=getSheet(CONFIG.SHEETS.VOLUNTEERS);
    const vals=sh.getDataRange().getValues();
    let target=null,rowIdx=-1;
    for(let i=1;i<vals.length;i++){
      if(vals[i][0]===d.needId){ target=vals[i]; rowIdx=i+1; break; }
    }
    if(!target) return resp(false,'éœ€æ±‚ä¸å­˜åœ¨');
    if(target[8]!=='é–‹æ”¾å ±å') return resp(false,'å·²é—œé–‰');
    const recSh=getSheet(CONFIG.SHEETS.VOLUNTEER_RECORDS);
    const rec=recSh.getDataRange().getValues();
    for(let i=1;i<rec.length;i++){
      if(rec[i][1]===d.lineId && rec[i][2]===d.needId && rec[i][6]!=='å·²å–æ¶ˆ')
        return resp(false,'å·²å ±å');
    }
    const current=rec.slice(1).filter(r=>r[2]===d.needId && r[6]==='å·²å ±å').length;
    if(current>=target[5]) return resp(false,'åé¡æ»¿');
    recSh.appendRow([ genId(), d.lineId, d.needId, target[1], target[3], target[7], 'å·²å ±å','', new Date() ]);
    sh.getRange(rowIdx,7).setValue(current+1);
    return resp(true,'å¿—å·¥å ±åæˆåŠŸ');
  }finally{ lock.releaseLock(); }
}
function createVolunteerNeed(d){
  if(!isAdmin(d.lineId)) return resp(false,'æ¬Šé™ä¸è¶³');
  if(!d.title || !d.date || !d.needCount || !d.hours) return resp(false,'ç¼ºå°‘æ¬„ä½');
  const sh=getSheet(CONFIG.SHEETS.VOLUNTEERS);
  sh.appendRow([
    genId(), d.title, d.description||'', d.date, d.time||'',
    parseInt(d.needCount,10), 0, parseInt(d.hours,10),
    'é–‹æ”¾å ±å', d.lineId, new Date()
  ]);
  return resp(true,'éœ€æ±‚å»ºç«‹æˆåŠŸ');
}

// ========== è²¡å‹™è³‡æ–™ ========== 
function getFinanceData(d){
  const out={ stats:{ totalDonation:0,donationCount:0,totalExpense:0,pendingExpenses:0 }, donations:[], expenses:[], adminStats:{} };
  if(d.lineId){
    const donVals=getSheet(CONFIG.SHEETS.DONATIONS).getDataRange().getValues();
    const donHeaders=donVals[0];
    const myDonations=donVals.slice(1).filter(r=>r[1]===d.lineId);
    out.donations=myDonations.map(r=>{ const o={}; donHeaders.forEach((h,i)=>o[h]=r[i]); return o; });
    out.stats.totalDonation=myDonations.reduce((s,r)=>s+(Number(r[3])||0),0);
    out.stats.donationCount=myDonations.length;

    const expVals=getSheet(CONFIG.SHEETS.EXPENSES).getDataRange().getValues();
    const expHeaders=expVals[0];
    const myExpenses=expVals.slice(1).filter(r=>r[1]===d.lineId);
    out.expenses=myExpenses.map(r=>{ const o={}; expHeaders.forEach((h,i)=>o[h]=r[i]); return o; });
    out.stats.totalExpense=myExpenses.reduce((s,r)=>s+(Number(r[3])||0),0);
    out.stats.pendingExpenses=myExpenses.filter(r=>r[6]==='å¯©æ ¸ä¸­').length;
  }
  if(isAdmin(d.lineId)){
    const donVals=getSheet(CONFIG.SHEETS.DONATIONS).getDataRange().getValues().slice(1);
    const expVals=getSheet(CONFIG.SHEETS.EXPENSES).getDataRange().getValues().slice(1);
    const totalIncome=donVals.filter(r=>r[7]!=='ä½œå»¢').reduce((s,r)=>s+(Number(r[3])||0),0);
    const totalExpense=expVals.filter(r=>r[6]==='å·²æ ¸å‡†').reduce((s,r)=>s+(Number(r[3])||0),0);
    const now=new Date(); const y=now.getFullYear(); const m=now.getMonth();
    const monthlyDonations=donVals.filter(r=>{
      const dt=r[8];
      return dt && dt.getFullYear && dt.getFullYear()===y && dt.getMonth()===m;
    }).reduce((s,r)=>s+(Number(r[3])||0),0);
    out.adminStats={ totalIncome,totalExpense,currentBalance:totalIncome-totalExpense,monthlyDonations };
  }
  return resp(true,'OK',out);
}

// ========== æ”¶æ“šèˆ‡ææ¬¾ ==========
const RECEIPT_TEMPLATE={
  ORGANIZATION:'å°ç£å¸•é‡‘æ£®ç—…å‹æœƒ',
  ADDRESS:'å°åŒ—å¸‚ä¸­æ­£å€ç¯„ä¾‹è·¯ 1 è™Ÿ',
  PHONE:'02-2388-0000',
  EMAIL:'info@parkinson.org.tw',
  TAX_ID:'12345678'
};
function getUserInfoByLineId(lineId){
  const sh=getSheet(CONFIG.SHEETS.USERS);
  const vals=sh.getDataRange().getValues();
  const headers=vals[0];
  for(let i=1;i<vals.length;i++){
    if(vals[i][0]===lineId){
      const o={}; headers.forEach((h,j)=>o[h]=vals[i][j]); return o;
    }
  }
  return null;
}
function generateReceiptPDF(receiptData){
  const settings = getSettingsMap();
  const tplId = settings.RECEIPT_TEMPLATE_DOC_ID;
  const userInfo = getUserInfoByLineId(receiptData.lineId);
  const donorName = userInfo?.realName || 'åŒ¿å';
  const amountStr = receiptData.amount.toLocaleString();
  const issueDateStr = Utilities.formatDate(receiptData.issueDate,'Asia/Taipei','yyyyå¹´MMæœˆddæ—¥');

  let pdfFile, docFile;
  if(tplId){
    const tplFile = DriveApp.getFileById(tplId);
    docFile = tplFile.makeCopy('æ”¶æ“š_'+receiptData.receiptNumber);
    const placeholderMap = {
      ORG_NAME: RECEIPT_TEMPLATE.ORGANIZATION,
      ORG_ADDRESS: RECEIPT_TEMPLATE.ADDRESS,
      ORG_PHONE: RECEIPT_TEMPLATE.PHONE,
      ORG_TAX_ID: RECEIPT_TEMPLATE.TAX_ID,
      RECEIPT_NUMBER: receiptData.receiptNumber,
      DONOR_NAME: donorName,
      DONATION_TYPE: receiptData.type,
      DONATION_AMOUNT: amountStr,
      DONATION_AMOUNT_CH: amountStr,
      ISSUE_DATE: issueDateStr
    };
    applyTemplateToDoc(docFile.getId(), placeholderMap);
  }else{
    const doc=DocumentApp.create(`æ”¶æ“š_${receiptData.receiptNumber}`);
    const body=doc.getBody();
    body.setMarginTop(50); body.setMarginBottom(50); body.setMarginLeft(60); body.setMarginRight(60);
    const title=body.appendParagraph('ææ¬¾æ”¶æ“š');
    title.setAlignment(DocumentApp.HorizontalAlignment.CENTER);
    title.editAsText().setBold(true).setFontSize(20);
    body.appendParagraph(`æ”¶æ“šç·¨è™Ÿï¼š${receiptData.receiptNumber}`).editAsText().setBold(true);
    body.appendParagraph('');
    body.appendParagraph(`æ©Ÿæ§‹åç¨±ï¼š${RECEIPT_TEMPLATE.ORGANIZATION}`);
    body.appendParagraph(`åœ°å€ï¼š${RECEIPT_TEMPLATE.ADDRESS}`);
    body.appendParagraph(`é›»è©±ï¼š${RECEIPT_TEMPLATE.PHONE}`);
    body.appendParagraph(`çµ±ä¸€ç·¨è™Ÿï¼š${RECEIPT_TEMPLATE.TAX_ID}`);
    body.appendParagraph('');
    body.appendParagraph(`ææ¬¾äººï¼š${donorName}`).editAsText().setBold(true);
    if(userInfo?.email) body.appendParagraph(`Emailï¼š${userInfo.email}`);
    if(userInfo?.phone) body.appendParagraph(`é›»è©±ï¼š${userInfo.phone}`);
    body.appendParagraph('');
    body.appendParagraph(`ææ¬¾é¡å‹ï¼š${receiptData.type}`);
    body.appendParagraph(`ææ¬¾é‡‘é¡ï¼šæ–°å°å¹£ ${amountStr} å…ƒæ•´`).editAsText().setBold(true);
    body.appendParagraph(`é–‹ç«‹æ—¥æœŸï¼š${issueDateStr}`);
    body.appendParagraph('');
    body.appendParagraph('æ„Ÿè¬æ‚¨å°æœ¬æœƒçš„æ”¯æŒï¼').setAlignment(DocumentApp.HorizontalAlignment.CENTER);
    body.appendParagraph('');
    body.appendParagraph(RECEIPT_TEMPLATE.ORGANIZATION).editAsText().setBold(true);
    doc.saveAndClose();
    docFile=DriveApp.getFileById(doc.getId());
  }

  const pdfBlob=docFile.getBlob().getAs('application/pdf');
  let folder;
  const it=DriveApp.getFoldersByName('æ”¶æ“šæª”æ¡ˆ');
  folder=it.hasNext()?it.next():DriveApp.createFolder('æ”¶æ“šæª”æ¡ˆ');
  pdfFile=folder.createFile(pdfBlob.setName(`æ”¶æ“š_${receiptData.receiptNumber}.pdf`));
  pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK,DriveApp.Permission.VIEW);

  if(!tplId){ docFile.setTrashed(true); }

  return { fileId:pdfFile.getId(), url:pdfFile.getUrl(), downloadUrl:`https://drive.google.com/uc?export=download&id=${pdfFile.getId()}` };
}
function sendReceiptEmail(receiptData,pdfInfo,userInfo){
  try{
    if(!userInfo?.email) return false;
    const settings = getSettingsMap();
    const replyTpl = settings.EMAIL_REPLY_TEMPLATE || '';
    const subject=`ã€${RECEIPT_TEMPLATE.ORGANIZATION}ã€‘ææ¬¾æ”¶æ“š - ${receiptData.receiptNumber}`;
    const tail = replyTpl ? `<hr style="margin:24px 0;">${replyTpl.replace(/\n/g,'<br>')}` : '';
    const htmlBody=`
      <div>è¦ªæ„›çš„ ${userInfo.realName||'ææ¬¾äºº'} æ‚¨å¥½ï¼š<br><br>
      æ„Ÿè¬æ‚¨å° <strong>${RECEIPT_TEMPLATE.ORGANIZATION}</strong> çš„æ”¯æŒã€‚ä»¥ä¸‹ç‚ºæ‚¨çš„ææ¬¾è³‡è¨Šï¼š<br><br>
      æ”¶æ“šç·¨è™Ÿï¼š${receiptData.receiptNumber}<br>
      é‡‘é¡ï¼šæ–°å°å¹£ ${receiptData.amount.toLocaleString()} å…ƒ<br>
      é¡å‹ï¼š${receiptData.type}<br>
      æ—¥æœŸï¼š${Utilities.formatDate(receiptData.issueDate,'Asia/Taipei','yyyy/MM/dd')}<br><br>
      <a href="${pdfInfo.downloadUrl}">ä¸‹è¼‰æ”¶æ“š PDF</a><br><br>
      å¦‚æœ‰å•é¡Œè«‹ä¾†ä¿¡ ${RECEIPT_TEMPLATE.EMAIL}<br><br>
      ${RECEIPT_TEMPLATE.ORGANIZATION}
      ${tail}
      </div>`;
    const pdfFile=DriveApp.getFileById(pdfInfo.fileId);
    GmailApp.sendEmail(userInfo.email,subject,'',{ htmlBody,attachments:[pdfFile.getBlob()], name:RECEIPT_TEMPLATE.ORGANIZATION });
    return true;
  }catch(e){ return false; }
}
function generateReceiptNumber(){
  const sh=getSheet(CONFIG.SHEETS.RECEIPTS);
  const vals=sh.getDataRange().getValues();
  const today=Utilities.formatDate(new Date(),'Asia/Taipei','yyyyMMdd');
  let maxSeq=0;
  for(let i=1;i<vals.length;i++){
    const num=vals[i][1];
    if(typeof num==='string' && num.startsWith(today)){
      const seq=parseInt(num.slice(8),10);
      if(seq>maxSeq) maxSeq=seq;
    }
  }
  const nextSeq=(maxSeq+1).toString().padStart(3,'0');
  return today+nextSeq;
}
function createDonation(d){
  if(!d.lineId) return resp(false,'ç¼º lineId');
  if(!d.category || d.amount===undefined) return resp(false,'ç¼ºå°‘æ¬„ä½');
  const amount=Number(d.amount);
  if(!(amount>0)) return resp(false,'é‡‘é¡éœ€å¤§æ–¼ 0');
  const sh=getSheet(CONFIG.SHEETS.DONATIONS);
  const id=genId();
  let receiptNumber='', receiptCreated=false, pdfInfo=null, emailSent=false;
  if(d.needReceipt){
    receiptNumber=generateReceiptNumber();
    const receiptData={ receiptNumber, lineId:d.lineId, type:d.category, amount, issueDate:new Date() };
    try{
      pdfInfo=generateReceiptPDF(receiptData);
      const recSh=getSheet(CONFIG.SHEETS.RECEIPTS);
      recSh.appendRow([
        genId(), receiptNumber, d.lineId,'ææ¬¾', amount, new Date(),'å·²é–‹ç«‹', pdfInfo.url, pdfInfo.fileId, false,''
      ]);
      receiptCreated=true;
      const userInfo=getUserInfoByLineId(d.lineId);
      if(userInfo && pdfInfo){
        emailSent=sendReceiptEmail(receiptData,pdfInfo,userInfo);
        if(emailSent){
          const rVals=recSh.getDataRange().getValues();
          const headers=rVals[0];
          for(let i=1;i<rVals.length;i++){
            if(rVals[i][1]===receiptNumber){
              const idxEmail=headers.indexOf('emailSent');
              const idxDate=headers.indexOf('emailDate');
              if(idxEmail>-1) rVals[i][idxEmail]=true;
              if(idxDate>-1) rVals[i][idxDate]=new Date();
              recSh.getRange(i+1,1,1,rVals[i].length).setValues([rVals[i]]);
              break;
            }
          }
        }
      }
    }catch(e){ Logger.log('æ”¶æ“šç”Ÿæˆå¤±æ•—:'+e); }
  }
  sh.appendRow([ id, d.lineId, d.category, amount, d.description||'', !!d.needReceipt, receiptNumber, 'å·²ææ¬¾', new Date(), '', '', '', '' ]);
  return resp(true,'ææ¬¾å»ºç«‹æˆåŠŸ',{
    id, receiptNumber:receiptNumber||null, receiptCreated,
    pdfGenerated:!!pdfInfo, emailSent, pdfUrl:pdfInfo?.url||null
  });
}

// ========== æ”¯å‡º ==========
function createExpense(d){
  if(!d.lineId) return resp(false,'ç¼º lineId');
  if(!d.category || d.amount===undefined) return resp(false,'ç¼ºå°‘æ¬„ä½');
  const amount=Number(d.amount);
  if(!(amount>0)) return resp(false,'é‡‘é¡éœ€å¤§æ–¼ 0');
  const sh=getSheet(CONFIG.SHEETS.EXPENSES);
  const id=genId();
  sh.appendRow([ id, d.lineId, d.category, amount, d.description||'', d.receiptImage||'', 'å¯©æ ¸ä¸­', '', new Date(), '', '', '', '', '', '', '', '' ]);
  return resp(true,'æ”¯å‡ºç”³è«‹å·²å»ºç«‹',{ id });
}
function approveExpense(d){
  if(!isAdmin(d.lineId)) return resp(false,'æ¬Šé™ä¸è¶³');
  if(!d.expenseId||!d.decision) return resp(false,'ç¼ºå°‘åƒæ•¸');
  const sh=getSheet(CONFIG.SHEETS.EXPENSES);
  const vals=sh.getDataRange().getValues();
  const headers=vals[0];
  const idx=vals.findIndex(r=>r[0]===d.expenseId);
  if(idx<1) return resp(false,'æ‰¾ä¸åˆ°æ”¯å‡ºç”³è«‹');
  const row=vals[idx];
  const statusIdx=headers.indexOf('status');
  const approvedByIdx=headers.indexOf('approvedBy');
  const approvedAtIdx=headers.indexOf('approvedAt');
  if(row[statusIdx]!=='å¯©æ ¸ä¸­') return resp(false,'å·²è™•ç†');
  if(d.decision==='approve') row[statusIdx]='å·²æ ¸å‡†';
  else if(d.decision==='reject') row[statusIdx]='å·²æ‹’çµ•';
  else return resp(false,'æœªçŸ¥ decision');
  row[approvedByIdx]=d.lineId;
  row[approvedAtIdx]=new Date();
  sh.getRange(idx+1,1,1,row.length).setValues([row]);
  return resp(true,'è™•ç†å®Œæˆ',{ status:row[statusIdx] });
}
function approveExpenseWithPayment(d){
  if(!isAdmin(d.lineId)) return resp(false,'æ¬Šé™ä¸è¶³');
  if(!d.expenseId||!d.decision) return resp(false,'ç¼ºå°‘åƒæ•¸');
  const sh=getSheet(CONFIG.SHEETS.EXPENSES);
  const vals=sh.getDataRange().getValues();
  const headers=vals[0];
  const idx=vals.findIndex(r=>r[0]===d.expenseId);
  if(idx<1) return resp(false,'æ‰¾ä¸åˆ°æ”¯å‡ºç”³è«‹');
  const row=vals[idx];
  const statusIdx=headers.indexOf('status');
  if(row[statusIdx]!=='å¯©æ ¸ä¸­') return resp(false,'æ­¤ç”³è«‹å·²è™•ç†');
  const approvedByIdx=headers.indexOf('approvedBy');
  const approvedAtIdx=headers.indexOf('approvedAt');
  const paymentDateIdx=headers.indexOf('paymentDate');
  const paymentAccountIdx=headers.indexOf('paymentAccount');
  const paymentMethodIdx=headers.indexOf('paymentMethod');
  const bankTransferDateIdx=headers.indexOf('bankTransferDate');

  if(d.decision==='approve'){
    row[statusIdx]='å·²æ ¸å‡†';
    row[approvedByIdx]=d.lineId;
    row[approvedAtIdx]=new Date();
    if(d.paymentInfo){
      if(paymentDateIdx>-1) row[paymentDateIdx]=d.paymentInfo.paymentDate||'';
      if(paymentAccountIdx>-1) row[paymentAccountIdx]=d.paymentInfo.paymentAccount||'';
      if(paymentMethodIdx>-1) row[paymentMethodIdx]=d.paymentInfo.paymentMethod||'';
      if(bankTransferDateIdx>-1) row[bankTransferDateIdx]=d.paymentInfo.bankTransferDate||'';
    }
    // æ”¯å‡ºæ†‘è­‰
    const settings = getSettingsMap();
    const voucherTpl = settings.EXPENSE_VOUCHER_TEMPLATE_DOC_ID;
    if(voucherTpl){
      try{
        const applicant = getUserInfoByLineId(row[1]);
        const placeholderMap = {
          ORG_NAME: RECEIPT_TEMPLATE.ORGANIZATION,
          ORG_ADDRESS: RECEIPT_TEMPLATE.ADDRESS,
          ORG_PHONE: RECEIPT_TEMPLATE.PHONE,
          ORG_TAX_ID: RECEIPT_TEMPLATE.TAX_ID,
          EXPENSE_CATEGORY: row[2],
          EXPENSE_AMOUNT: row[3],
          PAYMENT_DATE: d.paymentInfo?.paymentDate || '',
          PAYMENT_METHOD: d.paymentInfo?.paymentMethod || '',
          APPLICANT_NAME: applicant?.realName || applicant?.lineName || row[1]
        };
        const tplFile = DriveApp.getFileById(voucherTpl);
        const copy = tplFile.makeCopy('æ”¯å‡ºæ†‘è­‰_'+row[0]);
        applyTemplateToDoc(copy.getId(), placeholderMap);
        const pdfBlob = copy.getBlob().getAs('application/pdf');
        let folder;
        const it = DriveApp.getFoldersByName('æ”¯å‡ºæ†‘è­‰');
        folder = it.hasNext()? it.next(): DriveApp.createFolder('æ”¯å‡ºæ†‘è­‰');
        const pdf = folder.createFile(pdfBlob.setName('æ”¯å‡ºæ†‘è­‰_'+row[0]+'.pdf'));
        pdf.setSharing(DriveApp.Access.ANYONE_WITH_LINK,DriveApp.Permission.VIEW);
        const voucherPdfUrlIdx=headers.indexOf('voucherPdfUrl');
        const voucherFileIdIdx=headers.indexOf('voucherFileId');
        if(voucherPdfUrlIdx>-1) row[voucherPdfUrlIdx]=pdf.getUrl();
        if(voucherFileIdIdx>-1) row[voucherFileIdIdx]=pdf.getId();
      }catch(e){ Logger.log('æ”¯å‡ºæ†‘è­‰ç”¢ç”Ÿå¤±æ•—: '+e); }
    }
  }else if(d.decision==='reject'){
    row[statusIdx]='å·²æ‹’çµ•';
    row[approvedByIdx]=d.lineId;
    row[approvedAtIdx]=new Date();
  }else{
    return resp(false,'æœªçŸ¥æ±ºç­–');
  }
  sh.getRange(idx+1,1,1,row.length).setValues([row]);
  return resp(true,'è™•ç†å®Œæˆ',{ status:row[statusIdx] });
}

// ========== ææ¬¾æ”¶å…¥ç¢ºèª ==========
function confirmDonationIncome(d){
  if(!isAdmin(d.lineId)) return resp(false,'æ¬Šé™ä¸è¶³');
  if(!d.donationId) return resp(false,'ç¼º donationId');
  const sh=getSheet(CONFIG.SHEETS.DONATIONS);
  const vals=sh.getDataRange().getValues();
  const headers=vals[0];
  const idx=vals.findIndex(r=>r[0]===d.donationId);
  if(idx<1) return resp(false,'æ‰¾ä¸åˆ°ææ¬¾');
  const row=vals[idx];
  const verifiedByIdx=headers.indexOf('verifiedBy');
  if(row[verifiedByIdx]) return resp(false,'å·²ç¢ºèª');
  const bankDateIdx=headers.indexOf('bankDate');
  const bankAccountIdx=headers.indexOf('bankAccount');
  const verifiedAtIdx=headers.indexOf('verifiedAt');
  if(bankDateIdx>-1) row[bankDateIdx]=d.bankDate? new Date(d.bankDate):'';
  if(bankAccountIdx>-1) row[bankAccountIdx]=d.bankAccount||'';
  if(verifiedByIdx>-1) row[verifiedByIdx]=d.lineId;
  if(verifiedAtIdx>-1) row[verifiedAtIdx]=new Date();
  sh.getRange(idx+1,1,1,row.length).setValues([row]);
  return resp(true,'æ”¶å…¥å·²ç¢ºèª');
}

// ========== æ‰‹å‹•æ”¶æ“š ==========
function createManualReceipt(d){
  if(!isAdmin(d.lineId)) return resp(false,'æ¬Šé™ä¸è¶³');
  if(!d.targetLineId || !d.type || !d.amount) return resp(false,'ç¼ºå°‘æ¬„ä½');
  const amount=Number(d.amount);
  if(!(amount>0)) return resp(false,'é‡‘é¡éœ€ > 0');
  const receiptNumber=generateReceiptNumber();
  const receiptData={
    receiptNumber,
    lineId:d.targetLineId,
    type:d.type,
    amount,
    issueDate:new Date()
  };
  let pdfInfo=null, emailSent=false;
  try{
    pdfInfo=generateReceiptPDF(receiptData);
    const userInfo=getUserInfoByLineId(d.targetLineId);
    if(userInfo && userInfo.email){
      emailSent=sendReceiptEmail(receiptData,pdfInfo,userInfo);
    }
  }catch(e){
    Logger.log('æ‰‹å‹•æ”¶æ“š PDF å¤±æ•—: '+e);
  }
  const recSh=getSheet(CONFIG.SHEETS.RECEIPTS);
  recSh.appendRow([
    genId(), receiptNumber, d.targetLineId, d.type, amount,
    new Date(), 'å·²é–‹ç«‹',
    pdfInfo? pdfInfo.url:'', pdfInfo? pdfInfo.fileId:'', emailSent, emailSent? new Date():''
  ]);
  let donationId=null;
  if(d.createDonation && d.type==='ææ¬¾'){
    const donSh=getSheet(CONFIG.SHEETS.DONATIONS);
    donationId=genId();
    donSh.appendRow([
      donationId, d.targetLineId, 'æ‰‹å‹•é–‹ç«‹', amount, 'æ‰‹å‹•æ”¶æ“š', true,
      receiptNumber, 'å·²ææ¬¾', new Date(), '', '', d.lineId, new Date()
    ]);
  }
  return resp(true,'æ”¶æ“šå»ºç«‹æˆåŠŸ',{ receiptNumber, pdfUrl:pdfInfo? pdfInfo.url:null, emailSent, donationId });
}

function getMyReceipts(d){
  if(!d.lineId) return resp(false,'ç¼º lineId');
  const sh=getSheet(CONFIG.SHEETS.RECEIPTS);
  const vals=sh.getDataRange().getValues();
  const headers=vals[0];
  const list=vals.slice(1).filter(r=>r[2]===d.lineId)
    .map(r=>{ const o={}; headers.forEach((h,i)=>o[h]=r[i]); return o; })
    .sort((a,b)=> new Date(b.issueDate||0)-new Date(a.issueDate||0));
  return resp(true,'OK',list);
}

// ========== å›é¥‹ ==========
function createFeedback(d){
  if(!d.lineId || !d.activityId || !d.rating) return resp(false,'ç¼ºå°‘æ¬„ä½');
  const rating=Number(d.rating);
  if(!(rating>=1 && rating<=5)) return resp(false,'è©•åˆ†éœ€ 1~5');
  const sh=getSheet(CONFIG.SHEETS.FEEDBACK);
  const vals=sh.getDataRange().getValues();
  for(let i=1;i<vals.length;i++){
    if(vals[i][1]===d.lineId && vals[i][2]===d.activityId) return resp(false,'å·²æäº¤é');
  }
  const actSh=getSheet(CONFIG.SHEETS.ACTIVITIES);
  const acts=actSh.getDataRange().getValues();
  let title=d.activityId;
  for(let i=1;i<acts.length;i++){ if(acts[i][0]===d.activityId){ title=acts[i][1]; break; } }
  sh.appendRow([ genId(), d.lineId, d.activityId, title, rating, d.comment||'', new Date() ]);
  return resp(true,'å›é¥‹å·²é€å‡º');
}
function getMyFeedback(d){
  if(!d.lineId) return resp(false,'ç¼º lineId');
  const sh=getSheet(CONFIG.SHEETS.FEEDBACK);
  const vals=sh.getDataRange().getValues();
  const headers=vals[0];
  const list=vals.slice(1).filter(r=>r[1]===d.lineId).map(r=>{ const o={}; headers.forEach((h,i)=>o[h]=r[i]); return o; });
  return resp(true,'OK',list);
}
function getAllFeedback(d){
  if(!isAdmin(d.lineId)) return resp(false,'æ¬Šé™ä¸è¶³');
  const sh=getSheet(CONFIG.SHEETS.FEEDBACK);
  const vals=sh.getDataRange().getValues();
  const headers=vals[0];
  const list=vals.slice(1).map(r=>{ const o={}; headers.forEach((h,i)=>o[h]=r[i]); return o; });
  return resp(true,'OK',list);
}

// ========== Admin èšåˆ ==========
function getAdminData(d){
  if(!isAdmin(d.lineId)) return resp(false,'æ¬Šé™ä¸è¶³');
  const userVals=getSheet(CONFIG.SHEETS.USERS).getDataRange().getValues();
  const userHeaders=userVals[0];
  const members=userVals.slice(1).map(r=>{ const o={}; userHeaders.forEach((h,i)=>o[h]=r[i]); return o; });
  const actVals=getSheet(CONFIG.SHEETS.ACTIVITIES).getDataRange().getValues();
  const actHeaders=actVals[0];
  const activities=actVals.slice(1).map(r=>{ const o={}; actHeaders.forEach((h,i)=>o[h]=r[i]); return o; });
  const donVals=getSheet(CONFIG.SHEETS.DONATIONS).getDataRange().getValues().slice(1);
  const expVals=getSheet(CONFIG.SHEETS.EXPENSES).getDataRange().getValues().slice(1);
  const transactions=[];
  donVals.forEach(r=>transactions.push({ date:r[8], type:'æ”¶å…¥', amount:r[3], category:r[2], description:r[4], status:r[7] }));
  expVals.forEach(r=>transactions.push({ date:r[8], type:'æ”¯å‡º', amount:r[3], category:r[2], description:r[4], status:r[6] }));
  transactions.sort((a,b)=> new Date(b.date||0)-new Date(a.date||0));
  const recVals=getSheet(CONFIG.SHEETS.RECEIPTS).getDataRange().getValues();
  const recHeaders=recVals[0];
  const receipts=recVals.slice(1).map(r=>{ const o={}; recHeaders.forEach((h,i)=>o[h]=r[i]); return o; });
  return resp(true,'OK',{ members,activities,transactions,receipts });
}

// ========== æ´»å‹•å»ºç«‹èˆ‡æ›´æ–° ==========
function createActivity(d){
  if(!isAdmin(d.lineId)) return resp(false,'æ¬Šé™ä¸è¶³');
  if(!d.title||!d.date||!d.maxParticipants) return resp(false,'ç¼ºå°‘æ¬„ä½');
  const sh=getSheet(CONFIG.SHEETS.ACTIVITIES);
  const id=genId();
  sh.appendRow([ id, d.title, d.description||'', d.date, d.time||'', d.location||'', parseInt(d.maxParticipants,10), 0, parseInt(d.fee||'0',10), 'é–‹æ”¾å ±å', d.lineId, new Date() ]);
  return resp(true,'æ´»å‹•å·²å»ºç«‹',{ id });
}
function updateActivity(d){
  if(!isAdmin(d.lineId)) return resp(false,'æ¬Šé™ä¸è¶³');
  if(!d.activityId) return resp(false,'ç¼ºå°‘ activityId');
  const sh=getSheet(CONFIG.SHEETS.ACTIVITIES);
  const vals=sh.getDataRange().getValues();
  const headers=vals[0];
  const findIdx=vals.findIndex(r=>r[0]===d.activityId);
  if(findIdx<1) return resp(false,'æ‰¾ä¸åˆ°æ´»å‹•');
  const row=vals[findIdx];
  const set=(field,value)=>{
    if(value===undefined||value===null) return;
    const idx=headers.indexOf(field);
    if(idx>-1) row[idx]=value;
  };
  set('title',d.title); set('description',d.description); set('date',d.date);
  set('time',d.time); set('location',d.location);
  if(d.maxParticipants!==undefined){ const mp=parseInt(d.maxParticipants,10); if(mp>0) set('maxParticipants',mp); }
  if(d.fee!==undefined) set('fee',parseInt(d.fee||'0',10));
  set('status',d.status);
  sh.getRange(findIdx+1,1,1,row.length).setValues([row]);
  return resp(true,'æ´»å‹•å·²æ›´æ–°');
}

// ========== åŒ¯å‡º / å‚™ä»½ / é€šçŸ¥ ==========
function exportMembers(d){
  if(!isAdmin(d.lineId)) return resp(false,'æ¬Šé™ä¸è¶³');
  const srcSheet=getSheet(CONFIG.SHEETS.USERS);
  const values=srcSheet.getDataRange().getValues();
  const folderName='åŒ¯å‡º_æœƒå“¡';
  let folderIter=DriveApp.getFoldersByName(folderName);
  const folder=folderIter.hasNext()?folderIter.next():DriveApp.createFolder(folderName);
  const fileName='æœƒå“¡åŒ¯å‡º_'+Utilities.formatDate(new Date(),'Asia/Taipei','yyyyMMdd_HHmmss')+'.csv';
  const csv=values.map(r=>r.map(v=>{
    if(v instanceof Date) return Utilities.formatDate(v,'Asia/Taipei','yyyy/MM/dd HH:mm:ss');
    if((v||'').toString().indexOf(',')>-1) return '"'+v+'"';
    return v;
  }).join(',')).join('\n');
  const blob=Utilities.newBlob(csv,'text/csv',fileName);
  const file=folder.createFile(blob);
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK,DriveApp.Permission.VIEW);
  return resp(true,'åŒ¯å‡ºå®Œæˆ',{ fileUrl:file.getUrl() });
}
function exportFinanceData(d){
  if(!isAdmin(d.lineId)) return resp(false,'æ¬Šé™ä¸è¶³');
  const donSh=getSheet(CONFIG.SHEETS.DONATIONS).getDataRange().getValues();
  const expSh=getSheet(CONFIG.SHEETS.EXPENSES).getDataRange().getValues();
  const folderName='åŒ¯å‡º_è²¡å‹™';
  let folderIter=DriveApp.getFoldersByName(folderName);
  const folder=folderIter.hasNext()?folderIter.next():DriveApp.createFolder(folderName);
  function toCSV(vals){
    return vals.map(r=>r.map(v=>{
      if(v instanceof Date) return Utilities.formatDate(v,'Asia/Taipei','yyyy/MM/dd HH:mm:ss');
      if((v||'').toString().includes(',')) return '"'+v+'"';
      return v;
    }).join(',')).join('\n');
  }
  const ts=Utilities.formatDate(new Date(),'Asia/Taipei','yyyyMMdd_HHmmss');
  const donFile=folder.createFile(Utilities.newBlob(toCSV(donSh),'text/csv','ææ¬¾_'+ts+'.csv'));
  const expFile=folder.createFile(Utilities.newBlob(toCSV(expSh),'text/csv','æ”¯å‡º_'+ts+'.csv'));
  donFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK,DriveApp.Permission.VIEW);
  expFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK,DriveApp.Permission.VIEW);
  return resp(true,'åŒ¯å‡ºå®Œæˆ',{ donationUrl:donFile.getUrl(), expenseUrl:expFile.getUrl() });
}
function backupSystem(d){
  if(!isAdmin(d.lineId)) return resp(false,'æ¬Šé™ä¸è¶³');
  const ss=getSS();
  const ts=Utilities.formatDate(new Date(),'Asia/Taipei','yyyyMMdd_HHmmss');
  const copy=ss.copy('ç³»çµ±å‚™ä»½_'+ts);
  copy.setSharing(DriveApp.Access.ANYONE_WITH_LINK,DriveApp.Permission.NONE);
  return resp(true,'å‚™ä»½å®Œæˆ',{ backupId:copy.getId(), name:copy.getName() });
}
function sendSystemNotification(d){
  if(!isAdmin(d.lineId)) return resp(false,'æ¬Šé™ä¸è¶³');
  if(!d.message) return resp(false,'ç¼º message');
  logAPICall('SYSTEM_NOTIFICATION',d.lineId,{ message:d.message });
  return resp(true,'é€šçŸ¥å·²è¨˜éŒ„');
}

// ========== Router ==========
function doPost(e){
  try{
    const data=JSON.parse(e.postData.contents||'{}');
    if(data.apiKey!==CONFIG.API_KEY) return resp(false,'API KEY éŒ¯èª¤');
    const action=data.action;
    if(!action) return resp(false,'ç¼º action');
    const map={
      getUserInfo,
      registerUser,
      updateProfile,
      getDashboardData,
      getActivities,
      registerActivity,
      cancelRegistration,
      getMyRegistrations,
      getMyCompletedActivities,
      getVolunteerData,
      applyVolunteer,
      createVolunteerNeed,
      getFinanceData,
      createDonation,
      createExpense,
      createActivity,
      updateActivity,
      approveExpense,
      approveExpenseWithPayment,
      confirmDonationIncome,
      createManualReceipt,
      getMyReceipts,
      createFeedback,
      getMyFeedback,
      getAllFeedback,
      getAdminData,
      exportMembers,
      exportFinanceData,
      backupSystem,
      sendSystemNotification,
      getSettings,
      updateSettings
    };
    if(!map[action]) return resp(false,'æœªçŸ¥ action: '+action);
    const result=map[action](data);
    logAPICall(action,data.lineId||'',data);
    return result;
  }catch(err){
    return resp(false,'ä¼ºæœå™¨éŒ¯èª¤: '+err);
  }
}
function doGet(){
  return ContentService.createTextOutput('Parkinson Management API Online');
}


















<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes,maximum-scale=3.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ§ </text></svg>'>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg,#667eea,#764ba2);
      --success-gradient: linear-gradient(135deg,#28a745,#20c997);
      --danger-gradient: linear-gradient(135deg,#dc3545,#c82333);
      --warning-gradient: linear-gradient(135deg,#ffc107,#e0a800);
      --info-gradient: linear-gradient(135deg,#17a2b8,#138496);
    }
    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans TC',sans-serif;
      background:var(--primary-gradient);
      min-height:100vh;
      margin:0;
      font-size:18px;
      line-height:1.6;
      color:#222;
    }
    .main-header,.nav-container,.content-card {
      background:rgba(255,255,255,.98);
      backdrop-filter:blur(10px);
      border-radius:20px;
      padding:20px 18px;
      margin:15px 10px;
      box-shadow:0 8px 30px rgba(0,0,0,.12);
    }
    h1,h2,h3,h4,h5 { font-weight:700; }
    h1 { font-size:2.1rem; }
    .nav-pills { justify-content:center; gap:8px; flex-wrap:wrap; }
    .nav-pills .nav-link { font-weight:600; border:3px solid transparent; padding:14px 18px; font-size:1rem; border-radius:15px; }
    .nav-pills .nav-link.active { background:var(--primary-gradient); }
    .user-info-bar { display:flex; flex-direction:column; gap:10px; align-items:center; background:rgba(255,255,255,.95); padding:18px; border-radius:18px; box-shadow:0 4px 16px rgba(0,0,0,.15); margin-top:10px;}
    .user-avatar { width:60px;height:60px;border-radius:50%;background:var(--primary-gradient);color:#fff;font-size:1.4rem;display:flex;align-items:center;justify-content:center;font-weight:700;}
    .stat-card { border-radius:18px; padding:22px 18px; color:#fff; text-align:center; box-shadow:0 6px 20px rgba(0,0,0,.18); }
    .stat-card h3 { margin:0 0 8px; font-size:2rem; font-weight:700; }
    .activity-item,.transaction-item,.receipt-item {
      background:#fff; border-radius:18px; padding:18px 18px; margin-bottom:16px;
      border-left:6px solid #667eea; box-shadow:0 4px 12px rgba(0,0,0,.1); transition:.25s;
    }
    .activity-item:hover,.transaction-item:hover,.receipt-item:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.15); }
    .status-badge { display:inline-block; padding:8px 14px; border-radius:20px; font-size:.85rem; font-weight:700; line-height:1; border:2px solid transparent; }
    .status-é–‹æ”¾å ±å { background:#c6f6d5;color:#22543d;border-color:#48bb78;}
    .status-å·²å ±å { background:#bee3f8;color:#234e70;border-color:#4299e1;}
    .status-å·²å–æ¶ˆ { background:#fed7d7;color:#742a2a;border-color:#f56565;}
    .status-å·²å®Œæˆ { background:#d6bcfa;color:#553c9a;border-color:#9f7aea;}
    .status-å ±åæˆªæ­¢ { background:#feebc8;color:#7b341e;border-color:#ed8936;}
    .status-é€²è¡Œä¸­ { background:#bee3f8;color:#2a69ac;border-color:#4299e1;}
    .status-å·²çµæŸ { background:#e2e8f0;color:#2d3748;border-color:#a0aec0;}
    .status-å·²æ ¸å‡† { background:#c6f6d5;color:#22543d;border-color:#48bb78;}
    .status-å¯©æ ¸ä¸­ { background:#ffeeba;color:#7b5e00;border-color:#ffc107;}
    .status-å·²æ‹’çµ• { background:#fed7d7;color:#742a2a;border-color:#f56565;}
    .notification { position:fixed; top:20px; right:15px; left:15px; background:#fff; padding:18px; border-radius:15px; box-shadow:0 6px 20px rgba(0,0,0,.2); transform:translateY(-120px); transition:.35s; z-index:2000; font-size:1rem; }
    .notification.show { transform:translateY(0); }
    .notification.success { background:#c6f6d5;color:#22543d; border-left:6px solid #48bb78; }
    .notification.error { background:#fed7d7;color:#742a2a; border-left:6px solid #f56565; }
    .notification.warning { background:#feebc8;color:#7b341e; border-left:6px solid #ed8936; }
    .btn.loading { position:relative; color:transparent !important; }
    .btn.loading:after { content:''; position:absolute; top:50%; left:50%; width:22px; height:22px; margin:-11px; border:3px solid rgba(255,255,255,.5); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .table-container { max-height:480px; overflow:auto; border:2px solid #dee2e6; border-radius:16px; background:#fff; }
    .download-btn { background:var(--success-gradient); border:none; color:#fff; padding:8px 16px; border-radius:25px; font-weight:600; }
    .download-btn:hover { opacity:.9; }
    @media (max-width:768px){
      body { font-size:18px; }
      .main-header,.nav-container,.content-card { margin:10px 6px; padding:16px 14px; }
      .activity-item,.transaction-item,.receipt-item { padding:16px; }
      .stat-card h3 { font-size:1.8rem; }
    }
  </style>
</head>
<body>
  <div class="main-header">
    <h1><i class="bi bi-hospital"></i> å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</h1>
    <p class="text-muted mb-2">æ•´åˆæœå‹™å¹³å°</p>
    <div id="userInfoBar" class="user-info-bar" style="display:none;">
      <div class="user-avatar" id="userAvatar">?</div>
      <div class="user-info-text text-center">
        <div class="fw-bold" id="userName">è¼‰å…¥ä¸­...</div>
          <div class="small text-muted" id="userLineName"></div>
          <div class="small text-muted" id="userRole">æœƒå“¡</div>
      </div>
      <div><button class="btn btn-outline-secondary btn-sm" onclick="refreshData()"><i class="bi bi-arrow-clockwise"></i> åˆ·æ–°</button></div>
    </div>
  </div>

  <div id="notificationContainer"></div>

  <div class="nav-container">
    <ul class="nav nav-pills">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#dashboard">å„€è¡¨æ¿</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#profile">å€‹äººè³‡æ–™</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#activities">æ´»å‹•</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#volunteer">å¿—å·¥</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#finance">è²¡å‹™</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#feedback">å›é¥‹</button></li>
      <li class="nav-item admin-only" style="display:none;"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#admin">ç®¡ç†</button></li>
    </ul>
  </div>

  <div class="tab-content">

    <!-- Dashboard -->
    <div class="tab-pane fade show active" id="dashboard">
      <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>å„€è¡¨æ¿</h3>
          <button class="btn btn-outline-primary btn-sm" onclick="loadDashboard()"><i class="bi bi-arrow-clockwise"></i> åˆ·æ–°</button>
        </div>
        <div class="row" id="dashboardStats">
          <div class="col-12">
            <div class="d-flex justify-content-center align-items-center py-4 text-muted">
              <div class="spinner-border text-primary me-2"></div>è¼‰å…¥ä¸­...
            </div>
          </div>
        </div>
        <div class="mt-3">
          <h5><i class="bi bi-clock-history me-2"></i>æœ€è¿‘æ´»å‹•</h5>
          <div id="recentActivity" class="mt-2">
            <div class="d-flex justify-content-center align-items-center py-4 text-muted">
              <div class="spinner-border text-primary me-2"></div>è¼‰å…¥ä¸­...
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile -->
    <div class="tab-pane fade" id="profile">
      <div class="content-card">
        <h3><i class="bi bi-person me-2"></i>å€‹äººè³‡æ–™</h3>

        <div id="registrationSection" class="mt-3">
          <div class="alert alert-info">è«‹å®Œæˆè¨»å†Šã€‚</div>
          <form id="registrationForm" class="row g-3">
            <div class="col-12">
              <div class="form-floating">
                <input type="text" class="form-control" id="realName" name="realName" required>
                <label for="realName">çœŸå¯¦å§“å *</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <select class="form-select" id="memberType" name="memberType" required>
                  <option value="">é¸æ“‡</option>
                  <option value="ç—…å‹">ç—…å‹</option>
                  <option value="å®¶å±¬">å®¶å±¬</option>
                  <option value="å¿—å·¥">å¿—å·¥</option>
                  <option value="é†«è­·">é†«è­·äººå“¡</option>
                  <option value="æ”¯æŒè€…">æ”¯æŒè€…</option>
                </select>
                <label for="memberType">æœƒå“¡é¡åˆ¥ *</label>
              </div>
            </div>
            <div class="col-12 d-grid">
              <button class="btn btn-primary btn-lg" type="submit"><i class="bi bi-check-circle me-2"></i>è¨»å†Š</button>
            </div>
          </form>
        </div>

        <div id="profileSection" style="display:none;">
          <form id="profileForm" class="row g-3 mt-2">
            <div class="col-12"><h5 class="mt-3">åŸºæœ¬è³‡æ–™</h5></div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="profileRealName" name="profileRealName" readonly>
                <label for="profileRealName">çœŸå¯¦å§“å</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="lineName" name="lineName" readonly>
                <label for="lineName">LINE åç¨±</label>
              </div>
            </div>
            <div class="col-md-6"><div class="form-floating">
              <input type="tel" class="form-control" id="phone" name="phone"><label for="phone">é›»è©±</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <input type="email" class="form-control" id="email" name="email"><label for="email">Email</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <input type="date" class="form-control" id="birthday" name="birthday"><label for="birthday">ç”Ÿæ—¥</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <select class="form-select" id="profileMemberType" name="memberType">
                <option value="ç—…å‹">ç—…å‹</option><option value="å®¶å±¬">å®¶å±¬</option><option value="å¿—å·¥">å¿—å·¥</option><option value="é†«è­·">é†«è­·äººå“¡</option><option value="æ”¯æŒè€…">æ”¯æŒè€…</option>
              </select><label for="profileMemberType">æœƒå“¡é¡åˆ¥</label>
            </div></div>
            <div class="col-12"><div class="form-floating">
              <textarea class="form-control" id="address" name="address" style="height:80px;"></textarea>
              <label for="address">åœ°å€</label>
            </div></div>

            <div class="col-12"><h5 class="mt-4">å¸•é‡‘æ£®å¥åº·è³‡æ–™ï¼ˆé¸å¡«ï¼‰</h5></div>
            <div class="col-md-6"><div class="form-floating">
              <input type="date" class="form-control" id="diagnosisDate" name="diagnosisDate">
              <label for="diagnosisDate">ç¢ºè¨ºæ—¥æœŸ</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <select class="form-select" id="diseaseStage" name="diseaseStage">          
                <option value="">è«‹é¸æ“‡</option>
                <option value="ç¬¬ä¸€æœŸ">ç¬¬ä¸€æœŸ - å–®å´ç—‡ç‹€</option>
                <option value="ç¬¬äºŒæœŸ">ç¬¬äºŒæœŸ - é›™å´ç—‡ç‹€</option>
                <option value="ç¬¬ä¸‰æœŸ">ç¬¬ä¸‰æœŸ - å¹³è¡¡å•é¡Œ</option>
                <option value="ç¬¬å››æœŸ">ç¬¬å››æœŸ - åš´é‡å¤±èƒ½</option>
                <option value="ç¬¬äº”æœŸ">ç¬¬äº”æœŸ - è¼ªæ¤…æˆ–è‡¥åºŠ</option>
              </select>
              <label for="diseaseStage">ç–¾ç—…åˆ†æœŸ</label>
            </div></div>
            <div class="col-12"><div class="form-floating">
              <textarea class="form-control" id="medications" name="medications" style="height:70px;"></textarea>
              <label for="medications">ç›®å‰ç”¨è—¥</label>
            </div></div>
            <div class="col-12"><div class="form-floating">
              <textarea class="form-control" id="symptoms" name="symptoms" style="height:70px;"></textarea>
              <label for="symptoms">ä¸»è¦ç—‡ç‹€</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <select class="form-select" id="mobility" name="mobility">
                <option value="">é¸æ“‡</option>
                <option value="æ­£å¸¸è¡Œèµ°">æ­£å¸¸è¡Œèµ°</option>
                <option value="éœ€åŠ©è¡Œå™¨">éœ€åŠ©è¡Œå™¨</option>
                <option value="éœ€è¼ªæ¤…">éœ€è¼ªæ¤…</option>
                <option value="è‡¥åºŠ">è‡¥åºŠ</option>
              </select>
              <label for="mobility">è¡Œå‹•èƒ½åŠ›</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <input class="form-control" id="caregiverName" name="caregiverName">
              <label for="caregiverName">ç…§è­·è€…å§“å</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <input class="form-control" id="caregiverPhone" name="caregiverPhone">
              <label for="caregiverPhone">ç…§è­·è€…é›»è©±</label>
            </div></div>
            <div class="col-md-6"><div class="form-floating">
              <input class="form-control" id="emergencyContact" name="emergencyContact">
              <label for="emergencyContact">ç·Šæ€¥è¯çµ¡äºº</label>
            </div></div>
            <div class="col-12"><div class="form-floating">
              <textarea class="form-control" id="medicalHistory" name="medicalHistory" style="height:70px;"></textarea>
              <label for="medicalHistory">ç—…å²</label>
            </div></div>
            <div class="col-12"><div class="form-floating">
              <textarea class="form-control" id="notes" name="notes" style="height:70px;"></textarea>
              <label for="notes">å‚™è¨»</label>
            </div></div>

            <div class="col-12 d-grid">
              <button class="btn btn-primary btn-lg" type="submit"><i class="bi bi-save me-2"></i>æ›´æ–°</button>
            </div>
          </form>

          <div class="mt-4">
            <h5><i class="bi bi-receipt me-2"></i>æˆ‘çš„æ”¶æ“š</h5>
            <div id="myReceipts" class="mt-2">
              <div class="py-4 text-center text-muted">
                <div class="spinner-border me-2"></div>è¼‰å…¥ä¸­...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Activities -->
    <div class="tab-pane fade" id="activities">
      <div class="content-card">
        <div class="d-flex justify-content-between mb-3">
          <h3 class="mb-0"><i class="bi bi-calendar-event me-2"></i>æ´»å‹•</h3>
          <div class="admin-only" style="display:none;">
            <button class="btn btn-success btn-sm" onclick="showNewActivityModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢</button>
          </div>
        </div>
        <div class="row g-2 mb-3">
          <div class="col-6">
            <select class="form-select" id="activityStatusFilter">
              <option value="">å…¨éƒ¨ç‹€æ…‹</option>
              <option value="é–‹æ”¾å ±å">é–‹æ”¾å ±å</option>
              <option value="å ±åæˆªæ­¢">å ±åæˆªæ­¢</option>
              <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
              <option value="å·²çµæŸ">å·²çµæŸ</option>
            </select>
          </div>
          <div class="col-6">
            <input type="date" class="form-control" id="activityDateFilter">
          </div>
          <div class="col-12">
            <input type="text" class="form-control" id="activitySearchFilter" placeholder="é—œéµå­—">
          </div>
          <div class="col-12 d-grid">
            <button class="btn btn-outline-primary" onclick="filterActivities()"><i class="bi bi-search me-1"></i> æŸ¥è©¢</button>
          </div>
        </div>
        <div id="activitiesList"></div>
        <div class="mt-4">
          <h5><i class="bi bi-clipboard-check me-2"></i>æˆ‘çš„å ±å</h5>
          <div id="myRegistrations" class="mt-2">
            <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>è¼‰å…¥ä¸­...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Volunteer -->
    <div class="tab-pane fade" id="volunteer">
      <div class="content-card">
        <div class="d-flex justify-content-between mb-3">
          <h3 class="mb-0"><i class="bi bi-heart me-2"></i>å¿—å·¥</h3>
          <div class="admin-only" style="display:none;">
            <button class="btn btn-success btn-sm" onclick="showNewVolunteerNeedModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢éœ€æ±‚</button>
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-6"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="volunteerHours">0</h3><p class="mb-0">æœå‹™æ™‚æ•¸</p></div></div>
          <div class="col-6"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="volunteerActivities">0</h3><p class="mb-0">åƒèˆ‡æ¬¡æ•¸</p></div></div>
          <div class="col-6"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="volunteerRank">-</h3><p class="mb-0">æ’å</p></div></div>
          <div class="col-6"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="availableNeeds">0</h3><p class="mb-0">å¯å ±å</p></div></div>
        </div>
        <h5>å¿—å·¥éœ€æ±‚</h5>
        <div id="volunteerNeeds" class="mt-2">
          <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>è¼‰å…¥ä¸­...</div>
        </div>
        <div class="mt-4">
          <h5><i class="bi bi-journal-text me-2"></i>æˆ‘çš„å¿—å·¥è¨˜éŒ„</h5>
          <div id="myVolunteerRecords" class="mt-2">
            <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>è¼‰å…¥ä¸­...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Finance -->
    <div class="tab-pane fade" id="finance">
      <div class="content-card">
        <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
          <h3 class="mb-0"><i class="bi bi-cash-coin me-2"></i>è²¡å‹™</h3>
          <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" onclick="showNewDonationModal()"><i class="bi bi-heart-fill me-1"></i>ææ¬¾</button>
            <button class="btn btn-warning btn-sm" onclick="showNewExpenseModal()"><i class="bi bi-receipt me-1"></i>æ”¯å‡ºç”³è«‹</button>
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-6"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="myDonationAmount">0</h3><p class="mb-0">ææ¬¾ç¸½é¡</p></div></div>
          <div class="col-6"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="myDonationCount">0</h3><p class="mb-0">ææ¬¾æ¬¡æ•¸</p></div></div>
          <div class="col-6"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="myExpenseAmount">0</h3><p class="mb-0">æ”¯å‡ºé‡‘é¡</p></div></div>
          <div class="col-6"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="pendingExpenses">0</h3><p class="mb-0">å¾…å¯©æ ¸</p></div></div>
        </div>
        <h5><i class="bi bi-heart-fill me-2"></i>ææ¬¾ç´€éŒ„</h5>
        <div id="donationHistory" class="mt-2">
          <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>è¼‰å…¥ä¸­...</div>
        </div>
        <div class="mt-4">
          <h5><i class="bi bi-receipt me-2"></i>æ”¯å‡ºç”³è«‹ç´€éŒ„</h5>
          <div id="expenseHistory" class="mt-2">
            <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>è¼‰å…¥ä¸­...</div>
          </div>
        </div>
        <div class="admin-only mt-4" style="display:none;">
          <h5><i class="bi bi-graph-up me-2"></i>ç¸½è¦½</h5>
          <div class="row g-3">
            <div class="col-6"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="totalIncome">0</h3><p class="mb-0">ç¸½æ”¶å…¥</p></div></div>
            <div class="col-6"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="totalExpense">0</h3><p class="mb-0">ç¸½æ”¯å‡º</p></div></div>
            <div class="col-6"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="currentBalance">0</h3><p class="mb-0">é¤˜é¡</p></div></div>
            <div class="col-6"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="monthlyDonations">0</h3><p class="mb-0">æœ¬æœˆææ¬¾</p></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Feedback -->
    <div class="tab-pane fade" id="feedback">
      <div class="content-card">
        <h3><i class="bi bi-chat-dots me-2"></i>æ´»å‹•å›é¥‹</h3>
        <form id="feedbackForm" class="row g-3 mt-2">
          <div class="col-md-6">
            <div class="form-floating">
              <select class="form-select" id="feedbackActivity" required>
                <option value="">é¸æ“‡æ´»å‹•</option>
              </select>
              <label for="feedbackActivity">æ´»å‹• *</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <select class="form-select" id="feedbackRating" required>
                <option value="">è©•åˆ†</option>
                <option value="5">5 - éå¸¸æ»¿æ„</option>
                <option value="4">4 - æ»¿æ„</option>
                <option value="3">3 - æ™®é€š</option>
                <option value="2">2 - ä¸æ»¿æ„</option>
                <option value="1">1 - éå¸¸ä¸æ»¿æ„</option>
              </select>
              <label for="feedbackRating">è©•åˆ† *</label>
            </div>
          </div>
          <div class="col-12">
            <div class="form-floating">
              <textarea class="form-control" id="feedbackComment" style="height:100px;" required></textarea>
              <label for="feedbackComment">æ„è¦‹ / å»ºè­° *</label>
            </div>
          </div>
          <div class="col-12 d-grid">
            <button class="btn btn-primary btn-lg" type="submit"><i class="bi bi-send me-2"></i>æäº¤</button>
          </div>
        </form>
        <div class="mt-4">
          <h5><i class="bi bi-chat-left-text me-2"></i>æˆ‘çš„å›é¥‹</h5>
          <div id="myFeedback" class="mt-2">
            <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>è¼‰å…¥ä¸­...</div>
          </div>
        </div>
          <div class="admin-only mt-4" style="display:none;">
            <h5><i class="bi bi-chat-square-dots me-2"></i>å…¨éƒ¨å›é¥‹</h5>
            <div id="allFeedback" class="mt-2">
              <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>è¼‰å…¥ä¸­...</div>
            </div>
          </div>
      </div>
    </div>

    <!-- Admin -->
    <div class="tab-pane fade" id="admin">
      <div class="content-card">
        <h3><i class="bi bi-gear me-2"></i>ç®¡ç†</h3>
        <ul class="nav nav-tabs mb-3">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#memberManagement">æœƒå“¡</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#activityManagement">æ´»å‹•</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#financeManagement">è²¡å‹™</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#incomeVerification">æ”¶å…¥ç¢ºèª</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#expenseApproval">æ”¯å‡ºå¯©æ ¸</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#receiptManagement">æ”¶æ“š</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#systemSettings">è¨­å®š</button></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="memberManagement">
            <div class="d-flex justify-content-between mb-2">
              <h5 class="mb-0">æœƒå“¡åˆ—è¡¨</h5>
              <button class="btn btn-outline-primary btn-sm" onclick="exportMembers()"><i class="bi bi-download me-1"></i>åŒ¯å‡º</button>
            </div>
            <div class="table-container">
              <table class="table table-hover align-middle mb-0">
                <thead>
                  <tr><th>å§“å</th><th>é¡åˆ¥</th><th>ç‹€æ…‹</th><th>åŠ å…¥</th><th>ææ¬¾æ¬¡æ•¸</th><th></th></tr>
                </thead>
                <tbody id="memberList">
                  <tr><td colspan="6" class="text-center text-muted py-4"><div class="spinner-border me-2"></div>è¼‰å…¥ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade" id="activityManagement">
            <div class="d-flex justify-content-between mb-2">
              <h5 class="mb-0">æ´»å‹•åˆ—è¡¨</h5>
              <button class="btn btn-success btn-sm" onclick="showNewActivityModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢</button>
            </div>
            <div id="adminActivityList" class="mt-2">
              <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>è¼‰å…¥ä¸­...</div>
            </div>
          </div>
          <div class="tab-pane fade" id="financeManagement">
            <div class="d-flex justify-content-between mb-2 flex-wrap gap-2">
              <h5 class="mb-0">äº¤æ˜“è¨˜éŒ„</h5>
              <div class="d-flex gap-2">
                <button class="btn btn-success btn-sm" onclick="showNewTransactionModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢äº¤æ˜“</button>
                <button class="btn btn-outline-primary btn-sm" onclick="exportFinanceData()"><i class="bi bi-download me-1"></i>åŒ¯å‡º</button>
              </div>
            </div>
            <div class="table-container">
              <table class="table table-hover mb-0">
                <thead>
                  <tr><th>æ—¥æœŸ</th><th>é¡å‹</th><th>é‡‘é¡</th><th>åˆ†é¡</th><th>èªªæ˜</th><th>ç‹€æ…‹</th></tr>
                </thead>
                <tbody id="transactionList">
                  <tr><td colspan="6" class="text-center text-muted py-4"><div class="spinner-border me-2"></div>è¼‰å…¥ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade" id="incomeVerification">
            <div class="d-flex justify-content-between mb-2">
              <h5 class="mb-0">æ”¶å…¥ç¢ºèª</h5>
              <button class="btn btn-outline-primary btn-sm" onclick="loadIncomeVerification()"><i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°</button>
            </div>
            <div id="incomeVerificationList">
              <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>è¼‰å…¥ä¸­...</div>
            </div>
          </div>
          <div class="tab-pane fade" id="expenseApproval">
            <div class="d-flex justify-content-between mb-2">
              <h5 class="mb-0">æ”¯å‡ºå¯©æ ¸</h5>
              <button class="btn btn-outline-primary btn-sm" onclick="loadExpenseApproval()"><i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°</button>
            </div>
            <div id="expenseApprovalList">
              <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>è¼‰å…¥ä¸­...</div>
            </div>
          </div>
          <div class="tab-pane fade" id="receiptManagement">
            <div class="d-flex justify-content-between mb-2 flex-wrap gap-2">
              <h5 class="mb-0">æ”¶æ“šåˆ—è¡¨</h5>
              <div class="d-flex gap-2">
                <button class="btn btn-success btn-sm" onclick="showManualReceiptModal()"><i class="bi bi-plus-circle me-1"></i>æ‰‹å‹•é–‹ç«‹</button>
              </div>
            </div>
            <div id="receiptList" class="mt-2">
              <div class="py-4 text-center text-muted"><div class="spinner-border me-2"></div>è¼‰å…¥ä¸­...</div>
            </div>
          </div>
          <div class="tab-pane fade" id="systemSettings">
            <h5>ç³»çµ±å·¥å…·</h5>
            <div class="d-grid gap-2 mt-2 mb-4">
              <button class="btn btn-warning" onclick="backupSystem()"><i class="bi bi-database me-2"></i>ç«‹å³å‚™ä»½</button>
              <button class="btn btn-info" onclick="showSystemNotificationModal()"><i class="bi bi-megaphone me-2"></i>ç™¼é€é€šçŸ¥</button>
            </div>

            <!-- æ–°å¢ï¼šç³»çµ±è¨­å®šè¡¨å–® -->
            <div class="mt-3">
              <h6><i class="bi bi-sliders me-2"></i>ç³»çµ±è¨­å®š</h6>
              <form id="settingsForm" class="row g-3">
                <div class="col-12">
                  <div class="form-floating">
                    <input class="form-control" id="receiptTemplateDocId" placeholder="æ”¶æ“šæ¨¡ç‰ˆæ–‡ä»¶ID">
                    <label for="receiptTemplateDocId">æ”¶æ“š Google æ–‡ä»¶æ¨¡ç‰ˆ ID</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-floating">
                    <textarea class="form-control" id="emailReplyTemplate" style="height:120px;" placeholder="ä¿¡ä»¶å›è¦†æ¨¡ç‰ˆ"></textarea>
                    <label for="emailReplyTemplate">ä¿¡ä»¶å›è¦†æ¨¡ç‰ˆ</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <textarea class="form-control" id="incomeCategories" style="height:160px;" placeholder="æ¯è¡Œä¸€å€‹æ”¶å…¥é¡åˆ¥"></textarea>
                    <label for="incomeCategories">æ”¶å…¥é¡åˆ¥è¨­å®š (æ¯è¡Œä¸€å€‹)</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <textarea class="form-control" id="expenseCategoriesSetting" style="height:160px;" placeholder="æ¯è¡Œä¸€å€‹æ”¯å‡ºé¡åˆ¥"></textarea>
                    <label for="expenseCategoriesSetting">æ”¯å‡ºé¡åˆ¥è¨­å®š (æ¯è¡Œä¸€å€‹)</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-floating">
                    <input class="form-control" id="expenseVoucherTemplateDocId" placeholder="æ”¯å‡ºæ†‘è­‰æ¨¡ç‰ˆæ–‡ä»¶ID">
                    <label for="expenseVoucherTemplateDocId">æ”¯å‡ºæ†‘è­‰ Google æ–‡ä»¶æ¨¡ç‰ˆ ID</label>
                  </div>
                </div>
                <div class="col-12 d-flex gap-2">
                  <button type="button" class="btn btn-outline-primary" onclick="loadSettings()"><i class="bi bi-arrow-clockwise me-1"></i>è¼‰å…¥è¨­å®š</button>
                  <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>å„²å­˜è¨­å®š</button>
                </div>
              </form>
            </div>
            <!-- ç³»çµ±è¨­å®šè¡¨å–®çµæŸ -->

          </div>
        </div>
      </div>
    </div>

  </div><!-- tab-content -->

  <div id="modalContainer"></div>

  <script>
    // ========== å‰ç«¯è¨­å®š ==========
    const CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycbwvMd7vnpp2c_d0adQ9Pe-gI1L3jFGBuBjAhZ6eqAUeygFzUpk5_GZLC9GL61th2qIM/exec', // éƒ¨ç½²å¾Œå¯æ›¿æ›
      API_KEY: 'AAbb8520258185202581'
    };

    // ========== å…¨åŸŸç‹€æ…‹ ==========
    let userProfile=null;
    let currentUser=null;
    let isAdmin=false;
    let allActivities=[];
    let cachedAdminData=null;
    let sysSettings = { incomeCategories:[], expenseCategories:[] }; // æ–°å¢è¨­å®šç·©å­˜

    // ========== å·¥å…· ==========
    const formatDate = d=>{ if(!d)return '-'; const dt=new Date(d); return isNaN(dt)?'-':dt.toLocaleDateString('zh-TW'); };
    const formatDateTime = d=>{ if(!d)return '-'; const dt=new Date(d); return isNaN(dt)?'-':dt.toLocaleString('zh-TW'); };
    const formatCurrency = n=> 'NT$ '+(Number(n||0)).toLocaleString('zh-TW');
    function showNotification(msg,type='success',ms=3000){
      const wrap=document.getElementById('notificationContainer');
      const el=document.createElement('div');
      el.className=`notification ${type}`;
      el.innerHTML=`<div class="d-flex justify-content-between align-items-start">
        <span>${msg}</span><button style="background:none;border:none;font-size:20px;line-height:1;" onclick="this.closest('.notification').remove()">Ã—</button>
      </div>`;
      wrap.appendChild(el); requestAnimationFrame(()=>el.classList.add('show'));
      setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),300); },ms);
    }
    function setButtonLoading(btn,loading=true){
      if(!btn) return;
      if(loading){ if(!btn.dataset.originalText) btn.dataset.originalText=btn.innerHTML; btn.classList.add('loading'); btn.disabled=true; }
      else { btn.classList.remove('loading'); btn.disabled=false; if(btn.dataset.originalText) btn.innerHTML=btn.dataset.originalText; }
    }
    async function callAPI(action,data={},retries=2){
      const payload={ action, apiKey:CONFIG.API_KEY, ...data };
      let lastErr;
      for(let i=0;i<=retries;i++){
        try{
          const res=await fetch(CONFIG.API_BASE_URL,{ method:'POST', body:JSON.stringify(payload) });
          const text=await res.text();
          let json; try{ json=JSON.parse(text);}catch(e){ throw new Error('å›æ‡‰é JSON: '+text.slice(0,120)); }
          if(!json.success) throw new Error(json.message||'API éŒ¯èª¤');
          return json;
        }catch(err){ lastErr=err; await new Promise(r=>setTimeout(r,400*(i+1))); }
      }
      throw lastErr;
    }

    // ========== LIFF åˆå§‹åŒ– ==========
    async function initializeLiff(){
      try{
        await liff.init({ liffId:CONFIG.LIFF_ID });
        if(!liff.isLoggedIn()){ liff.login(); return; }
        userProfile=await liff.getProfile();
        document.getElementById('userInfoBar').style.display='flex';
        document.getElementById('userLineName').textContent='LINEï¼š'+(userProfile.displayName||'');
        document.getElementById('userName').textContent=userProfile.displayName||'æœƒå“¡';
        document.getElementById('userAvatar').textContent=(userProfile.displayName||'?').charAt(0);
        await loadUserData();
        await loadDashboard();
      }catch(e){
        console.error(e); showNotification('LIFF åˆå§‹åŒ–å¤±æ•—','error',4000);
      }
    }

    // ========== ä½¿ç”¨è€… ==========
    async function loadUserData(){
      try{
        const r=await callAPI('getUserInfo',{ lineId:userProfile.userId });
        if(r.success && r.data){
          currentUser=r.data;
          isAdmin=!!currentUser.isAdmin;
          updateUserUI();
        }else showRegistrationForm();
      }catch{ showRegistrationForm(); }
    }
    function updateUserUI(){
      if(!currentUser) return;
      document.getElementById('userName').textContent=currentUser.realName||currentUser.lineName||userProfile.displayName||'æœƒå“¡';
      document.getElementById('userRole').textContent=currentUser.memberType||'æœƒå“¡';
      document.getElementById('userAvatar').textContent=(currentUser.realName||currentUser.lineName||userProfile.displayName||'?').charAt(0);
      document.querySelectorAll('.admin-only').forEach(el=> el.style.display=isAdmin?'block':'none');
      updateProfileSection();
    }
    function showRegistrationForm(){
      document.getElementById('registrationSection').style.display='block';
      document.getElementById('profileSection').style.display='none';
    }
    function updateProfileSection(){
      if(!currentUser) return;
      document.getElementById('registrationSection').style.display='none';
      document.getElementById('profileSection').style.display='block';
      // åŸºæœ¬
      document.getElementById('profileRealName').value=currentUser.realName||'';
      document.getElementById('lineName').value=currentUser.lineName||userProfile.displayName||'';
      document.getElementById('phone').value=currentUser.phone||'';
      document.getElementById('email').value=currentUser.email||'';
      document.getElementById('birthday').value=currentUser.birthday||'';
      document.getElementById('profileMemberType').value=currentUser.memberType||'ç—…å‹';
      document.getElementById('address').value=currentUser.address||'';
      // å¥åº·
      const fields=['diagnosisDate','diseaseStage','medications','symptoms','mobility','caregiverName','caregiverPhone','emergencyContact','medicalHistory','notes'];
      fields.forEach(f=>{ if(document.getElementById(f)) document.getElementById(f).value=currentUser[f]||''; });
      loadMyReceipts();
    }

    // è¨»å†Š
    document.getElementById('registrationForm').addEventListener('submit',async e=>{
      e.preventDefault();
      const fd=new FormData(e.target); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('registerUser',{
          lineId:userProfile.userId,
          lineName:userProfile.displayName,
          realName:fd.get('realName'),
          memberType:fd.get('memberType')
        });
        showNotification('è¨»å†ŠæˆåŠŸ','success'); await loadUserData();
      }catch(err){ showNotification('è¨»å†Šå¤±æ•—ï¼š'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    });

    // æ›´æ–°å€‹è³‡
    document.getElementById('profileForm').addEventListener('submit',async e=>{
      e.preventDefault();
      const fd=new FormData(e.target); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('updateProfile',{
          lineId:userProfile.userId,
          phone:fd.get('phone'), email:fd.get('email'), birthday:fd.get('birthday'),
          memberType:fd.get('memberType'), address:fd.get('address'),
          diagnosisDate:fd.get('diagnosisDate'), diseaseStage:fd.get('diseaseStage'),
          medications:fd.get('medications'), symptoms:fd.get('symptoms'),
          mobility:fd.get('mobility'), caregiverName:fd.get('caregiverName'),
          caregiverPhone:fd.get('caregiverPhone'), emergencyContact:fd.get('emergencyContact'),
          medicalHistory:fd.get('medicalHistory'), notes:fd.get('notes')
        });
        showNotification('æ›´æ–°æˆåŠŸ','success');
        await loadUserData();
      }catch(err){ showNotification('æ›´æ–°å¤±æ•—ï¼š'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    });

    // ========== å„€è¡¨æ¿ ==========
    async function loadDashboard(){
      try{
        const r=await callAPI('getDashboardData',{ lineId:userProfile?.userId });
        renderDashboardStats(r.data); renderRecentActivity(r.data.recentActivity||[]);
      }catch(err){
        document.getElementById('dashboardStats').innerHTML=`<div class="col-12 text-danger text-center py-3">è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>`;
      }
    }
    function renderDashboardStats(d){
      document.getElementById('dashboardStats').innerHTML=`
        <div class="col-6"><div class="stat-card" style="background:var(--success-gradient);"><h3>${d.totalActivities||0}</h3><p class="mb-0">å¯å ±åæ´»å‹•</p></div></div>
        <div class="col-6"><div class="stat-card" style="background:var(--info-gradient);"><h3>${d.myRegistrations||0}</h3><p class="mb-0">æˆ‘çš„å ±å</p></div></div>
        <div class="col-6"><div class="stat-card" style="background:var(--warning-gradient);"><h3>${d.myVolunteerHours||0}</h3><p class="mb-0">å¿—å·¥æ™‚æ•¸</p></div></div>
        <div class="col-6"><div class="stat-card" style="background:var(--danger-gradient);"><h3>${(d.myDonationAmount||0).toLocaleString()}</h3><p class="mb-0">ææ¬¾ç¸½é¡</p></div></div>`;
    }
    function renderRecentActivity(list){
      const c=document.getElementById('recentActivity');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">ç„¡è³‡æ–™</p>'; return;}
      c.innerHTML=list.map(a=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div class="flex-grow-1">
              <strong>${a.title}</strong>
              <div class="text-muted small mt-1">${a.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(a.date)}</small>
            </div>
            <span class="status-badge status-${a.status||''}">${a.status||''}</span>
          </div>
        </div>`).join('');
    }

    // ========== æ´»å‹• ==========
    async function loadActivities(){
      try{
        const r=await callAPI('getActivities');
        allActivities=r.data||[];
        renderActivities(allActivities);
      }catch(err){
        document.getElementById('activitiesList').innerHTML=`<div class="text-danger text-center py-3">è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>`;
      }
    }
    function renderActivities(list){
      const c=document.getElementById('activitiesList');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">å°šç„¡æ´»å‹•</p>'; return; }
      c.innerHTML=list.map(a=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between align-items-start flex-wrap">
            <div class="flex-grow-1">
              <strong>${a.title}</strong>
              <div class="small text-muted mt-1">${a.description||''}</div>
              <div class="row g-1 small mt-1">
                <div class="col-6"><i class="bi bi-calendar me-1"></i>${formatDate(a.date)}</div>
                <div class="col-6"><i class="bi bi-clock me-1"></i>${a.time||'-'}</div>
                <div class="col-6"><i class="bi bi-geo-alt me-1"></i>${a.location||'-'}</div>
                <div class="col-6"><i class="bi bi-people me-1"></i>${a.currentCount||0}/${a.maxParticipants||0}</div>
              </div>
            </div>
            <div class="text-end">
              <span class="status-badge status-${a.status}">${a.status}</span>
              <div class="fw-bold text-primary mt-2">${formatCurrency(a.fee||0)}</div>
              ${(a.status==='é–‹æ”¾å ±å')? `<button class="btn btn-primary btn-sm mt-2" onclick="registerActivity('${a.id}')"><i class="bi bi-plus-circle me-1"></i>å ±å</button>`:''}
            </div>
          </div>
        </div>`).join('');
    }
    function filterActivities(){
      const s=document.getElementById('activityStatusFilter').value.trim();
      const d=document.getElementById('activityDateFilter').value.trim();
      const kw=document.getElementById('activitySearchFilter').value.trim().toLowerCase();
      let list=[...allActivities];
      if(s) list=list.filter(a=>a.status===s);
      if(d) list=list.filter(a=>(a.date||'').startsWith(d));
      if(kw) list=list.filter(a=>(a.title||'').toLowerCase().includes(kw)||(a.description||'').toLowerCase().includes(kw)||(a.location||'').toLowerCase().includes(kw));
      renderActivities(list);
    }
    async function registerActivity(id){
      if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
      try{
        await callAPI('registerActivity',{ lineId:userProfile.userId, activityId:id });
        showNotification('å ±åæˆåŠŸ','success'); await loadActivities(); await loadMyRegistrations();
      }catch(err){ showNotification('å ±åå¤±æ•—ï¼š'+err.message,'error'); }
    }
    async function loadMyRegistrations(){
      if(!currentUser) return;
      try{
        const r=await callAPI('getMyRegistrations',{ lineId:userProfile.userId });
        renderMyRegistrations(r.data||[]);
      }catch(err){
        document.getElementById('myRegistrations').innerHTML=`<div class="text-danger text-center py-2">è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>`;
      }
    }
    function renderMyRegistrations(list){
      const c=document.getElementById('myRegistrations');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">ç„¡å ±å</p>'; return; }
      c.innerHTML=list.map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div class="flex-grow-1">
              <strong>${r.activityTitle}</strong>
              <div class="small text-muted mt-1"><i class="bi bi-clock me-1"></i>${formatDateTime(r.registrationTime)}</div>
              <small class="text-muted">ç‹€æ…‹ï¼š${r.status}</small>
            </div>
            <div class="text-end">
              <span class="status-badge status-${r.status}">${r.status}</span>
              ${(r.status==='å·²å ±å')? `<div><button class="btn btn-danger btn-sm mt-2" onclick="cancelRegistration('${r.id}')"><i class="bi bi-x-circle me-1"></i>å–æ¶ˆ</button></div>`:''}
            </div>
          </div>
        </div>`).join('');
    }
    async function cancelRegistration(id){
      if(!confirm('ç¢ºå®šå–æ¶ˆï¼Ÿ')) return;
      try{
        await callAPI('cancelRegistration',{ lineId:userProfile.userId, registrationId:id });
        showNotification('å·²å–æ¶ˆ','success'); await loadMyRegistrations(); await loadActivities();
      }catch(err){ showNotification('å–æ¶ˆå¤±æ•—ï¼š'+err.message,'error'); }
    }

    // ========== å¿—å·¥ ==========
    async function loadVolunteerData(){
      if(!currentUser) return;
      try{
        const r=await callAPI('getVolunteerData',{ lineId:userProfile.userId });
        const s=r.data.stats;
        document.getElementById('volunteerHours').textContent=s.totalHours||0;
        document.getElementById('volunteerActivities').textContent=s.totalActivities||0;
        document.getElementById('volunteerRank').textContent=s.rank||'-';
        document.getElementById('availableNeeds').textContent=s.availableNeeds||0;
        renderVolunteerNeeds(r.data.needs||[]);
        renderVolunteerRecords(r.data.records||[]);
      }catch(err){ console.error(err); }
    }
    function renderVolunteerNeeds(list){
      const c=document.getElementById('volunteerNeeds');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">ç„¡éœ€æ±‚</p>'; return; }
      c.innerHTML=list.map(n=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div class="flex-grow-1">
              <strong>${n.title}</strong>
              <div class="small text-muted mt-1">${n.description||''}</div>
              <div class="row g-1 small mt-1">
                <div class="col-6"><i class="bi bi-calendar me-1"></i>${formatDate(n.date)}</div>
                <div class="col-6"><i class="bi bi-people me-1"></i>${n.currentCount||0}/${n.needCount}</div>
                <div class="col-6"><i class="bi bi-clock me-1"></i>${n.time||'-'}</div>
                <div class="col-6"><i class="bi bi-award me-1"></i>${n.hours} å°æ™‚</div>
              </div>
            </div>
            <div class="text-end">
              <span class="status-badge status-${n.status}">${n.status}</span>
              ${(n.status==='é–‹æ”¾å ±å')? `<button class="btn btn-success btn-sm mt-2" onclick="applyVolunteer('${n.id}')"><i class="bi bi-hand-thumbs-up me-1"></i>å ±å</button>`:''}
            </div>
          </div>
        </div>`).join('');
    }
    function renderVolunteerRecords(list){
      const c=document.getElementById('myVolunteerRecords');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">ç„¡è¨˜éŒ„</p>'; return; }
      c.innerHTML=list.map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.title}</strong>
              <div class="small text-muted mt-1"><i class="bi bi-calendar me-1"></i>${formatDate(r.date)} / ${r.hours} å°æ™‚</div>
            </div>
            <span class="status-badge status-${r.status}">${r.status}</span>
          </div>
        </div>`).join('');
    }
    async function applyVolunteer(id){
      if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
      try{
        await callAPI('applyVolunteer',{ lineId:userProfile.userId, needId:id });
        showNotification('å ±åæˆåŠŸ','success'); await loadVolunteerData();
      }catch(err){ showNotification('å ±åå¤±æ•—ï¼š'+err.message,'error'); }
    }

    // ========== è²¡å‹™ ==========
    async function loadFinanceData(){
      if(!currentUser) return;
      try{
        const r=await callAPI('getFinanceData',{ lineId:userProfile.userId });
        const s=r.data.stats;
        document.getElementById('myDonationAmount').textContent=(s.totalDonation||0).toLocaleString();
        document.getElementById('myDonationCount').textContent=s.donationCount||0;
        document.getElementById('myExpenseAmount').textContent=(s.totalExpense||0).toLocaleString();
        document.getElementById('pendingExpenses').textContent=s.pendingExpenses||0;
        renderDonationHistory(r.data.donations||[]);
        renderExpenseHistory(r.data.expenses||[]);
        if(r.data.adminStats && isAdmin){
          document.getElementById('totalIncome').textContent=(r.data.adminStats.totalIncome||0).toLocaleString();
          document.getElementById('totalExpense').textContent=(r.data.adminStats.totalExpense||0).toLocaleString();
          document.getElementById('currentBalance').textContent=(r.data.adminStats.currentBalance||0).toLocaleString();
          document.getElementById('monthlyDonations').textContent=(r.data.adminStats.monthlyDonations||0).toLocaleString();
        }
      }catch(err){ console.error(err); }
    }
    function renderDonationHistory(list){
      const c=document.getElementById('donationHistory');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">å°šç„¡ææ¬¾</p>'; return; }
      c.innerHTML=list.map(d=>`
        <div class="transaction-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div>
              <strong>ææ¬¾ - ${d.category}</strong>
              <div class="small text-muted mt-1">${d.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(d.createdAt)}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold text-success">${formatCurrency(d.amount)}</div>
              <small class="text-muted">æ”¶æ“šï¼š${d.receiptNumber||'è™•ç†ä¸­'}</small>
            </div>
          </div>
        </div>`).join('');
    }
    function renderExpenseHistory(list){
      const c=document.getElementById('expenseHistory');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">å°šç„¡æ”¯å‡º</p>'; return; }
      c.innerHTML=list.map(e=>`
        <div class="transaction-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div>
              <strong>æ”¯å‡º - ${e.category}</strong>
              <div class="small text-muted mt-1">${e.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(e.createdAt)}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold text-danger">${formatCurrency(e.amount)}</div>
              <span class="status-badge status-${e.status}">${e.status}</span>
            </div>
          </div>
        </div>`).join('');
    }

    // ææ¬¾ Modalï¼ˆå‹•æ…‹é¡åˆ¥ï¼‰
    function showNewDonationModal(){
      if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return;}
      if(isAdmin && sysSettings.incomeCategories.length===0){
        loadSettings().catch(()=>{});
      }
      const opts = (sysSettings.incomeCategories.length? sysSettings.incomeCategories:['ä¸€èˆ¬ææ¬¾','æ´»å‹•è´ŠåŠ©'])
        .map(c=>`<option value="${c}">${c}</option>`).join('');
      const html=`
      <div class="modal fade" id="donationModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="donationForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>ææ¬¾</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <select class="form-select" id="donationCategory" required>
                <option value="">é¸æ“‡é¡åˆ¥</option>
                ${opts}
              </select>
              <label for="donationCategory">ææ¬¾é¡åˆ¥ *</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="donationAmount" min="1" required>
              <label for="donationAmount">é‡‘é¡ *</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" id="donationDescription" style="height:80px;"></textarea>
              <label for="donationDescription">å‚™è¨»</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="needReceipt" checked>
              <label class="form-check-label" for="needReceipt">éœ€è¦æ”¶æ“š</label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button class="btn btn-success" type="submit"><i class="bi bi-heart-fill me-1"></i>ææ¬¾</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('donationModal')); m.show();
      document.getElementById('donationForm').addEventListener('submit',handleDonationSubmit);
    }
    async function handleDonationSubmit(e){
      e.preventDefault();
      const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('createDonation',{
          lineId:userProfile.userId,
          category:document.getElementById('donationCategory').value,
          amount:parseInt(document.getElementById('donationAmount').value,10),
          description:document.getElementById('donationDescription').value,
          needReceipt: document.getElementById('needReceipt').checked
        });
        showNotification('ææ¬¾æˆåŠŸ','success'); bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
        await loadFinanceData(); await loadMyReceipts();
      }catch(err){ showNotification('ææ¬¾å¤±æ•—ï¼š'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // æ”¯å‡ºç”³è«‹ï¼ˆå‹•æ…‹é¡åˆ¥ï¼‰
    function showNewExpenseModal(){
      if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return;}
      if(isAdmin && sysSettings.expenseCategories.length===0){
        loadSettings().catch(()=>{});
      }
      const opts = (sysSettings.expenseCategories.length? sysSettings.expenseCategories:['æ´»å‹•è²»ç”¨','è¨­å‚™è€—æ','è¡Œæ”¿æ”¯å‡º','å…¶ä»–'])
        .map(c=>`<option value="${c}">${c}</option>`).join('');
      const html=`
      <div class="modal fade" id="expenseModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="expenseForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-receipt me-2"></i>æ”¯å‡ºç”³è«‹</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <select class="form-select" id="expenseCategory" required>
                <option value="">é¸æ“‡åˆ†é¡</option>
                ${opts}
              </select><label for="expenseCategory">åˆ†é¡ *</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="expenseAmount" min="1" required>
              <label for="expenseAmount">é‡‘é¡ *</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" id="expenseDescription" style="height:80px;"></textarea>
              <label for="expenseDescription">èªªæ˜</label>
            </div>
            <small class="text-muted">é™„ä»¶ä¸Šå‚³åŠŸèƒ½å¯å¾ŒçºŒæ“´å……</small>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button class="btn btn-warning" type="submit"><i class="bi bi-send me-1"></i>é€å‡º</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('expenseModal')); m.show();
      document.getElementById('expenseForm').addEventListener('submit',handleExpenseSubmit);
    }
    async function handleExpenseSubmit(e){
      e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('createExpense',{
          lineId:userProfile.userId,
          category:document.getElementById('expenseCategory').value,
          amount:parseInt(document.getElementById('expenseAmount').value,10),
          description:document.getElementById('expenseDescription').value
        });
        showNotification('ç”³è«‹å·²é€å‡º','success'); bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
        await loadFinanceData();
      }catch(err){ showNotification('ç”³è«‹å¤±æ•—ï¼š'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // å¿—å·¥éœ€æ±‚ (Admin)
    function showNewVolunteerNeedModal(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return;}
      const html=`
      <div class="modal fade" id="volNeedModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="volNeedForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>æ–°å¢å¿—å·¥éœ€æ±‚</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="form-floating mb-3"><input class="form-control" id="needTitle" required><label for="needTitle">æ¨™é¡Œ *</label></div>
            <div class="form-floating mb-3"><textarea class="form-control" id="needDesc" style="height:80px;"></textarea><label for="needDesc">æè¿°</label></div>
            <div class="form-floating mb-3"><input type="date" class="form-control" id="needDate" required><label for="needDate">æ—¥æœŸ *</label></div>
            <div class="form-floating mb-3"><input class="form-control" id="needTime" placeholder="09:00-12:00"><label for="needTime">æ™‚é–“</label></div>
            <div class="form-floating mb-3"><input type="number" class="form-control" id="needCount" min="1" required><label for="needCount">éœ€æ±‚äººæ•¸ *</label></div>
            <div class="form-floating mb-3"><input type="number" class="form-control" id="needHours" min="1" required><label for="needHours">æ™‚æ•¸ *</label></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">å–æ¶ˆ</button>
            <button class="btn btn-success" type="submit"><i class="bi bi-save me-1"></i>å»ºç«‹</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('volNeedModal')); m.show();
      document.getElementById('volNeedForm').addEventListener('submit',handleVolunteerNeedSubmit);
    }
    async function handleVolunteerNeedSubmit(e){
      e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('createVolunteerNeed',{
          lineId:userProfile.userId,
          title:needTitle.value,
          description:needDesc.value,
          date:needDate.value,
          time:needTime.value,
          needCount:parseInt(needCount.value,10),
          hours:parseInt(needHours.value,10)
        });
        showNotification('å»ºç«‹æˆåŠŸ','success'); bootstrap.Modal.getInstance(document.getElementById('volNeedModal')).hide();
        await loadVolunteerData();
      }catch(err){ showNotification('å»ºç«‹å¤±æ•—ï¼š'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // æ´»å‹•æ–°å¢ (Admin)
    function showNewActivityModal(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return;}
      const html=`
      <div class="modal fade" id="activityModal" tabindex="-1">
        <div class="modal-dialog modal-lg"><form class="modal-content" id="activityForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>æ–°å¢æ´»å‹•</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body row g-3">
            <div class="col-12"><div class="form-floating"><input class="form-control" id="actTitle" required><label for="actTitle">æ¨™é¡Œ *</label></div></div>
            <div class="col-6"><div class="form-floating"><input type="date" class="form-control" id="actDate" required><label for="actDate">æ—¥æœŸ *</label></div></div>
            <div class="col-6"><div class="form-floating"><input class="form-control" id="actTime"><label for="actTime">æ™‚é–“</label></div></div>
            <div class="col-12"><div class="form-floating"><input class="form-control" id="actLocation"><label for="actLocation">åœ°é»</label></div></div>
            <div class="col-6"><div class="form-floating"><input type="number" min="1" class="form-control" id="actMax" required><label for="actMax">åé¡ *</label></div></div>
            <div class="col-6"><div class="form-floating"><input type="number" min="0" class="form-control" id="actFee" value="0"><label for="actFee">è²»ç”¨</label></div></div>
            <div class="col-12"><div class="form-floating"><textarea class="form-control" id="actDesc" style="height:90px;"></textarea><label for="actDesc">æè¿°</label></div></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">å–æ¶ˆ</button>
            <button class="btn btn-success" type="submit"><i class="bi bi-save me-1"></i>å»ºç«‹</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('activityModal')); m.show();
      document.getElementById('activityForm').addEventListener('submit',handleActivityCreate);
    }
    async function handleActivityCreate(e){
      e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('createActivity',{
          lineId:userProfile.userId,
          title:actTitle.value,
          date:actDate.value,
          time:actTime.value,
          location:actLocation.value,
          maxParticipants:parseInt(actMax.value,10),
          fee:parseInt(actFee.value||'0',10),
          description:actDesc.value
        });
        showNotification('æ´»å‹•å·²å»ºç«‹','success'); bootstrap.Modal.getInstance(document.getElementById('activityModal')).hide();
        await loadActivities(); if(isAdmin) await loadAdminData();
      }catch(err){ showNotification('å»ºç«‹å¤±æ•—ï¼š'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // å¿«é€Ÿäº¤æ˜“ (Admin) - æ­¤è™•æœªå‹•æ…‹åŒ–åˆ†é¡ï¼Œå¯è‡ªè¡Œå»¶ä¼¸
    function showNewTransactionModal(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return;}
      const html=`
      <div class="modal fade" id="txModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="txForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>å¿«é€Ÿæ–°å¢äº¤æ˜“</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <select class="form-select" id="txType" required>
                <option value="">é¸æ“‡é¡å‹</option><option value="donation">ææ¬¾(æ”¶å…¥)</option><option value="expense">æ”¯å‡º</option>
              </select><label for="txType">é¡å‹ *</label>
            </div>
            <div class="form-floating mb-3"><input class="form-control" id="txCategory" required><label for="txCategory">åˆ†é¡ *</label></div>
            <div class="form-floating mb-3"><input type="number" class="form-control" id="txAmount" min="1" required><label for="txAmount">é‡‘é¡ *</label></div>
            <div class="form-floating mb-3"><textarea class="form-control" id="txDesc" style="height:80px;"></textarea><label for="txDesc">èªªæ˜</label></div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="txNeedReceipt"><label class="form-check-label" for="txNeedReceipt">éœ€è¦æ”¶æ“š(ææ¬¾)</label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">å–æ¶ˆ</button>
            <button class="btn btn-primary" type="submit"><i class="bi bi-check2 me-1"></i>å»ºç«‹</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('txModal')); m.show();
      document.getElementById('txForm').addEventListener('submit',handleQuickTransactionSubmit);
    }
    async function handleQuickTransactionSubmit(e){
      e.preventDefault();
      const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        const type=document.getElementById('txType').value;
        if(type==='donation'){
          await callAPI('createDonation',{
            lineId:userProfile.userId,
            category:txCategory.value,
            amount:parseInt(txAmount.value,10),
            description:txDesc.value,
            needReceipt: txNeedReceipt.checked
          });
        }else if(type==='expense'){
          await callAPI('createExpense',{
            lineId:userProfile.userId,
            category:txCategory.value,
            amount:parseInt(txAmount.value,10),
            description:txDesc.value
          });
        }else throw new Error('æœªé¸æ“‡é¡å‹');
        showNotification('äº¤æ˜“å»ºç«‹æˆåŠŸ','success');
        bootstrap.Modal.getInstance(document.getElementById('txModal')).hide();
        await loadFinanceData(); if(isAdmin) await loadAdminData(); loadMyReceipts();
      }catch(err){ showNotification('å»ºç«‹å¤±æ•—ï¼š'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // æ‰‹å‹•é–‹ç«‹æ”¶æ“š (Admin)
    function showManualReceiptModal(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return;}
      const html=`
      <div class="modal fade" id="manualReceiptModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="manualReceiptForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-receipt-cutoff me-2"></i>æ‰‹å‹•æ”¶æ“š</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="form-floating mb-3"><input class="form-control" id="receiptLineId" required><label for="receiptLineId">æœƒå“¡ LINE ID *</label></div>
            <div class="form-floating mb-3">
              <select class="form-select" id="receiptType" required>
                <option value="">é¸æ“‡é¡åˆ¥</option><option value="ææ¬¾">ææ¬¾</option><option value="å…¶ä»–">å…¶ä»–</option>
              </select><label for="receiptType">é¡åˆ¥ *</label>
            </div>
            <div class="form-floating mb-3"><input type="number" class="form-control" id="receiptAmount" min="1" required><label for="receiptAmount">é‡‘é¡ *</label></div>
            <div class="form-check mb-2"><input class="form-check-input" type="checkbox" id="createDonationSync" checked><label class="form-check-label" for="createDonationSync">åŒæ­¥æ–°å¢ææ¬¾ç´€éŒ„ (ææ¬¾é¡å‹)</label></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">å–æ¶ˆ</button>
            <button class="btn btn-success" type="submit"><i class="bi bi-save me-1"></i>é–‹ç«‹</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('manualReceiptModal')); m.show();
      document.getElementById('manualReceiptForm').addEventListener('submit',handleManualReceiptSubmit);
    }
    async function handleManualReceiptSubmit(e){
      e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('createManualReceipt',{
          lineId:userProfile.userId,
          targetLineId:receiptLineId.value,
          type:receiptType.value,
          amount:parseInt(receiptAmount.value,10),
          createDonation: document.getElementById('createDonationSync').checked
        });
        showNotification('æ”¶æ“šå·²å»ºç«‹','success'); bootstrap.Modal.getInstance(document.getElementById('manualReceiptModal')).hide();
        await loadAdminData();
      }catch(err){ showNotification('é–‹ç«‹å¤±æ•—ï¼š'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // ç³»çµ±é€šçŸ¥
    function showSystemNotificationModal(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
      const html=`
      <div class="modal fade" id="sysNotifyModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="sysNotifyForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-megaphone me-2"></i>ç³»çµ±é€šçŸ¥</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="form-floating mb-3"><textarea class="form-control" id="notifyMessage" style="height:120px;" required></textarea><label for="notifyMessage">é€šçŸ¥å…§å®¹ *</label></div>
            <small class="text-muted">ç›®å‰åƒ…è¨˜éŒ„æ–¼ç³»çµ±æ—¥èªŒï¼Œå¯å¾ŒçºŒä¸²æ¥ LINE Pushã€‚</small>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">å–æ¶ˆ</button>
            <button class="btn btn-info" type="submit"><i class="bi bi-send me-1"></i>ç™¼é€</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('sysNotifyModal')); m.show();
      document.getElementById('sysNotifyForm').addEventListener('submit',async e=>{
        e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
        try{
          await callAPI('sendSystemNotification',{ lineId:userProfile.userId, message:notifyMessage.value });
          showNotification('å·²ç™¼é€','success'); bootstrap.Modal.getInstance(document.getElementById('sysNotifyModal')).hide();
        }catch(err){ showNotification('ç™¼é€å¤±æ•—ï¼š'+err.message,'error'); }
        finally{ setButtonLoading(btn,false); }
      });
    }

    // æ”¶æ“šæ¸…å–®
    async function loadMyReceipts(){
      if(!currentUser) return;
      try{
        const r=await callAPI('getMyReceipts',{ lineId:userProfile.userId });
        renderMyReceipts(r.data||[]);
      }catch(err){
        document.getElementById('myReceipts').innerHTML=`<div class="text-danger text-center py-2">è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>`;
      }
    }
    function renderMyReceipts(list){
      const c=document.getElementById('myReceipts');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">å°šç„¡æ”¶æ“š</p>'; return; }
      c.innerHTML=list.map(r=>`
        <div class="receipt-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div>
              <strong>${r.receiptNumber}</strong>
              <div class="small text-muted mt-1">é¡å‹ï¼š${r.type} / é‡‘é¡ï¼š${formatCurrency(r.amount)}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(r.issueDate)}</small>
              ${r.emailSent? '<div class="text-success small mt-1"><i class="bi bi-envelope-check me-1"></i>å·²å¯„é€ Email</div>':''}
            </div>
            <div class="text-end">
              <span class="status-badge status-${r.status}">${r.status}</span>
              ${r.pdfUrl? `<div class="mt-2"><a href="${r.pdfUrl}" target="_blank" class="btn btn-sm download-btn"><i class="bi bi-download me-1"></i>PDF</a></div>`:''}
            </div>
          </div>
        </div>`).join('');
    }

    // æ”¶å…¥ç¢ºèª (Admin)
    async function loadIncomeVerification(){
      if(!isAdmin) return;
      try{
        const r=await callAPI('getFinanceData',{ lineId:userProfile.userId });
        renderIncomeVerification(r.data.donations||[]);
      }catch(err){
        document.getElementById('incomeVerificationList').innerHTML=`<div class="text-danger text-center py-2">è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>`;
      }
    }
    function renderIncomeVerification(list){
      const c=document.getElementById('incomeVerificationList');
      const unverified=list.filter(d=>!d.verifiedBy);
      if(!unverified.length){ c.innerHTML='<p class="text-muted mb-0 py-2">ç„¡å¾…ç¢ºèªæ”¶å…¥</p>'; return; }
      c.innerHTML=unverified.map(d=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div>
              <strong>${d.category} - ${formatCurrency(d.amount)}</strong>
              <div class="small text-muted mt-1">${d.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(d.createdAt)}</small>
            </div>
            <button class="btn btn-success btn-sm" onclick="showConfirmIncomeModal('${d.id}','${d.amount}','${d.category}')"><i class="bi bi-check-circle me-1"></i>ç¢ºèª</button>
          </div>
        </div>`).join('');
    }
    function showConfirmIncomeModal(id,amount,cat){
      const html=`
      <div class="modal fade" id="confirmIncomeModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="confirmIncomeForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-bank me-2"></i>æ”¶å…¥ç¢ºèª</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="alert alert-info mb-3"><strong>${cat}</strong><br>é‡‘é¡ï¼š${formatCurrency(amount)}</div>
            <div class="form-floating mb-3"><input type="date" class="form-control" id="bankDate" required><label for="bankDate">éŠ€è¡Œå…¥å¸³æ—¥æœŸ *</label></div>
            <div class="form-floating mb-3"><input class="form-control" id="bankAccount" placeholder="å¸³è™Ÿå¾Œ5ç¢¼"><label for="bankAccount">è½‰å¸³å¸³è™Ÿ</label></div>
            <input type="hidden" id="donationId" value="${id}">
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">å–æ¶ˆ</button>
            <button class="btn btn-success" type="submit"><i class="bi bi-check-circle me-1"></i>ç¢ºèª</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('confirmIncomeModal')); m.show();
      document.getElementById('confirmIncomeForm').addEventListener('submit',handleConfirmIncome);
    }
    async function handleConfirmIncome(e){
      e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('confirmDonationIncome',{
          lineId:userProfile.userId,
          donationId:document.getElementById('donationId').value,
          bankDate:document.getElementById('bankDate').value,
          bankAccount:document.getElementById('bankAccount').value
        });
        showNotification('æ”¶å…¥å·²ç¢ºèª','success'); bootstrap.Modal.getInstance(document.getElementById('confirmIncomeModal')).hide();
        loadIncomeVerification();
      }catch(err){ showNotification('ç¢ºèªå¤±æ•—ï¼š'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // æ”¯å‡ºå¯©æ ¸ (Admin)
    async function loadExpenseApproval(){
      if(!isAdmin) return;
      try{
        const r=await callAPI('getFinanceData',{ lineId:userProfile.userId });
        renderExpenseApproval(r.data.expenses||[]);
      }catch(err){
        document.getElementById('expenseApprovalList').innerHTML=`<div class="text-danger text-center py-2">è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>`;
      }
    }
    function renderExpenseApproval(list){
      const c=document.getElementById('expenseApprovalList');
      const pending=list.filter(e=>e.status==='å¯©æ ¸ä¸­');
      if(!pending.length){ c.innerHTML='<p class="text-muted mb-0 py-2">ç„¡å¾…å¯©æ ¸æ”¯å‡º</p>'; return; }
      c.innerHTML=pending.map(e=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div>
              <strong>${e.category} - ${formatCurrency(e.amount)}</strong>
              <div class="small text-muted mt-1">${e.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(e.createdAt)}</small>
            </div>
            <div class="text-end d-flex flex-column gap-2">
              <button class="btn btn-success btn-sm" onclick="showApproveExpenseModal('${e.id}','approve','${e.amount}','${e.category}')"><i class="bi bi-check-circle me-1"></i>æ ¸å‡†</button>
              <button class="btn btn-danger btn-sm" onclick="showApproveExpenseModal('${e.id}','reject','${e.amount}','${e.category}')"><i class="bi bi-x-circle me-1"></i>æ‹’çµ•</button>
            </div>
          </div>
        </div>`).join('');
    }
    function showApproveExpenseModal(id,decision,amount,cat){
      const approve=decision==='approve';
      const html=`
      <div class="modal fade" id="approveExpenseModal" tabindex="-1">
        <div class="modal-dialog"><form class="modal-content" id="approveExpenseForm">
          <div class="modal-header"><h5 class="modal-title"><i class="bi bi-${approve?'check-circle':'x-circle'} me-2"></i>${approve?'æ ¸å‡†':'æ‹’çµ•'}æ”¯å‡º</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="alert alert-${approve?'success':'danger'} mb-3"><strong>${cat}</strong><br>é‡‘é¡ï¼š${formatCurrency(amount)}</div>
            ${approve? `
              <div class="form-floating mb-3"><input type="date" class="form-control" id="paymentDate"><label for="paymentDate">ç™¼æ¬¾æ—¥æœŸ</label></div>
              <div class="form-floating mb-3"><input class="form-control" id="paymentAccount" placeholder="å°æ–¹å¸³è™Ÿå¾Œ5ç¢¼"><label for="paymentAccount">å°æ–¹å¸³è™Ÿ</label></div>
              <div class="form-floating mb-3">
                <select class="form-select" id="paymentMethod">
                  <option value="">ä»˜æ¬¾æ–¹å¼</option><option value="éŠ€è¡Œè½‰å¸³">éŠ€è¡Œè½‰å¸³</option><option value="ç¾é‡‘">ç¾é‡‘</option><option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
                </select><label for="paymentMethod">ä»˜æ¬¾æ–¹å¼</label>
              </div>
              <div class="form-floating mb-3"><input type="datetime-local" class="form-control" id="bankTransferDate"><label for="bankTransferDate">éŠ€è¡Œè™•ç†æ™‚é–“</label></div>
            `:`
              <div class="form-floating mb-3">
                <textarea class="form-control" id="rejectReason" style="height:80px;"></textarea>
                <label for="rejectReason">æ‹’çµ•åŸå› </label>
              </div>
            `}
            <input type="hidden" id="expenseId" value="${id}">
            <input type="hidden" id="decision" value="${decision}">
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button class="btn btn-${approve?'success':'danger'}" type="submit"><i class="bi bi-${approve?'check-circle':'x-circle'} me-1"></i>ç¢ºèª</button>
          </div>
        </form></div></div>`;
      document.getElementById('modalContainer').innerHTML=html;
      const m=new bootstrap.Modal(document.getElementById('approveExpenseModal')); m.show();
      document.getElementById('approveExpenseForm').addEventListener('submit',handleApproveExpense);
    }
    async function handleApproveExpense(e){
      e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        const decision=document.getElementById('decision').value;
        const payload={
          lineId:userProfile.userId,
          expenseId:document.getElementById('expenseId').value,
          decision
        };
        if(decision==='approve'){
          payload.paymentInfo={
            paymentDate:paymentDate.value,
            paymentAccount:paymentAccount.value,
            paymentMethod:paymentMethod.value,
            bankTransferDate:bankTransferDate.value
          };
        }else{
          payload.rejectReason=document.getElementById('rejectReason').value;
        }
        await callAPI('approveExpenseWithPayment',payload);
        showNotification(`å·²${decision==='approve'?'æ ¸å‡†':'æ‹’çµ•'}`,'success');
        bootstrap.Modal.getInstance(document.getElementById('approveExpenseModal')).hide();
        loadExpenseApproval();
      }catch(err){ showNotification('è™•ç†å¤±æ•—ï¼š'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    }

    // å›é¥‹
    async function loadFeedbackData(){
      if(!currentUser) return;
      try{
        const acts=await callAPI('getMyCompletedActivities',{ lineId:userProfile.userId });
        populateFeedbackActivities(acts.data||[]);
        const my=await callAPI('getMyFeedback',{ lineId:userProfile.userId });
        renderMyFeedback(my.data||[]);
        if(isAdmin){
          const all=await callAPI('getAllFeedback',{ lineId:userProfile.userId });
          renderAllFeedback(all.data||[]);
        }
      }catch(err){ console.error(err); }
    }
    function populateFeedbackActivities(list){
      const sel=document.getElementById('feedbackActivity');
      sel.innerHTML='<option value="">é¸æ“‡æ´»å‹•</option>';
      list.forEach(a=> sel.innerHTML+=`<option value="${a.id}">${a.title} (${formatDate(a.date)})</option>`);
    }
    function renderMyFeedback(list){
      const c=document.getElementById('myFeedback');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">å°šç„¡å›é¥‹</p>'; return; }
      c.innerHTML=list.map(f=>`
        <div class="activity-item">
          <strong>${f.activityTitle}</strong>
          <div class="mt-1">${'â˜…'.repeat(f.rating)}${'â˜†'.repeat(5-f.rating)} <span class="text-muted small">(${f.rating}/5)</span></div>
          <div class="small mt-1">${f.comment}</div>
          <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDateTime(f.createdAt)}</small>
        </div>`).join('');
    }
    function renderAllFeedback(list){
      const c=document.getElementById('allFeedback');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">ç„¡è³‡æ–™</p>'; return;}
      c.innerHTML=list.map(f=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${f.activityTitle}</strong>
              <div class="mt-1">${'â˜…'.repeat(f.rating)}${'â˜†'.repeat(5-f.rating)} <span class="text-muted small">(${f.rating}/5)</span></div>
              <div class="small mt-1">${f.comment}</div>
              <small class="text-muted">${formatDateTime(f.createdAt)}</small>
            </div>
            <small class="text-muted">${f.lineId}</small>
          </div>
        </div>`).join('');
    }
    document.getElementById('feedbackForm').addEventListener('submit',async e=>{
      e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'); setButtonLoading(btn,true);
      try{
        await callAPI('createFeedback',{
          lineId:userProfile.userId,
          activityId:feedbackActivity.value,
          rating:parseInt(feedbackRating.value,10),
          comment:feedbackComment.value
        });
        showNotification('å·²æäº¤','success'); e.target.reset(); await loadFeedbackData();
      }catch(err){ showNotification('æäº¤å¤±æ•—ï¼š'+err.message,'error'); }
      finally{ setButtonLoading(btn,false); }
    });

    // Admin è³‡æ–™
    async function loadAdminData(){
      if(!isAdmin) return;
      try{
        const r=await callAPI('getAdminData',{ lineId:userProfile.userId });
        cachedAdminData=r.data;
        renderMemberList(r.data.members||[]);
        renderAdminActivities(r.data.activities||[]);
        renderTransactions(r.data.transactions||[]);
        renderReceipts(r.data.receipts||[]);
      }catch(err){ console.error(err); }
    }
    function renderMemberList(list){
      const tb=document.getElementById('memberList');
      if(!list.length){ tb.innerHTML='<tr><td colspan="6" class="text-center text-muted py-3">ç„¡è³‡æ–™</td></tr>'; return; }
      tb.innerHTML=list.map(m=>`
        <tr>
          <td>${m.realName||m.lineName||'-'}</td>
          <td>${m.memberType||'-'}</td>
          <td><span class="status-badge status-${m.status||''}">${m.status||''}</span></td>
          <td>${formatDate(m.joinDate)}</td>
          <td>${m.donationCount||0}</td>
          <td><button class="btn btn-outline-primary btn-sm" onclick="viewMemberDetail('${m.lineId}')"><i class="bi bi-eye"></i></button></td>
        </tr>`).join('');
    }
    function renderAdminActivities(list){
      const c=document.getElementById('adminActivityList');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">ç„¡æ´»å‹•</p>'; return; }
      c.innerHTML=list.map(a=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${a.title}</strong>
              <div class="small text-muted mt-1">${formatDate(a.date)} / ${a.location||''}</div>
            </div>
            <div class="text-end">
              <span class="status-badge status-${a.status}">${a.status}</span>
              <div class="small mt-2">${a.currentCount||0}/${a.maxParticipants||0}</div>
            </div>
          </div>
        </div>`).join('');
    }
    function renderTransactions(list){
      const tb=document.getElementById('transactionList');
      if(!list.length){ tb.innerHTML='<tr><td colspan="6" class="text-center text-muted py-3">ç„¡äº¤æ˜“</td></tr>'; return; }
      tb.innerHTML=list.map(t=>`
        <tr>
          <td class="small">${formatDateTime(t.date)}</td>
          <td>${t.type}</td>
          <td class="${t.type==='æ”¶å…¥'?'text-success':'text-danger'}">${formatCurrency(t.amount)}</td>
          <td>${t.category||''}</td>
          <td class="small">${t.description||''}</td>
          <td>${t.status? `<span class="status-badge status-${t.status}">${t.status}</span>`:''}</td>
        </tr>`).join('');
    }
    function renderReceipts(list){
      const c=document.getElementById('receiptList');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0 py-2">ç„¡æ”¶æ“š</p>'; return; }
      c.innerHTML=list.map(r=>`
        <div class="receipt-item">
          <div class="d-flex justify-content-between flex-wrap">
            <div>
              <strong>${r.receiptNumber}</strong>
              <div class="small text-muted mt-1">${formatDate(r.issueDate)} / ${r.type}</div>
            </div>
            <div class="text-end">
              <div class="fw-bold mb-1">${formatCurrency(r.amount)}</div>
              <span class="status-badge status-${r.status}">${r.status}</span>
              ${r.pdfUrl? `<div class="mt-2"><a href="${r.pdfUrl}" target="_blank" class="btn btn-sm download-btn"><i class="bi bi-download"></i></a></div>`:''}
            </div>
          </div>
        </div>`).join('');
    }
    function viewMemberDetail(lineId){
      const member=(cachedAdminData?.members||[]).find(m=>m.lineId===lineId);
      if(!member){ showNotification('æ‰¾ä¸åˆ°æœƒå“¡','error'); return;}
      const html=`
      <div class="modal fade" id="memberDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title"><i class="bi bi-person me-2"></i>${member.realName||member.lineName||lineId}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <ul class="list-group">
                <li class="list-group-item"><strong>LINE IDï¼š</strong>${member.lineId}</li>
                <li class="list-group-item"><strong>å§“åï¼š</strong>${member.realName||'-'}</li>
                <li class="list-group-item"><strong>é¡åˆ¥ï¼š</strong>${member.memberType||'-'}</li>
                <li class="list-group-item"><strong>é›»è©±ï¼š</strong>${member.phone||'-'}</li>
                <li class="list-group-item"><strong>Emailï¼š</strong>${member.email||'-'}</li>
                <li class="list-group-item"><strong>ç–¾ç—…åˆ†æœŸï¼š</strong>${member.diseaseStage||'-'}</li>
                <li class="list-group-item"><strong>ç”¨è—¥ï¼š</strong>${member.medications||'-'}</li>
                <li class="list-group-item"><strong>ç—‡ç‹€ï¼š</strong>${member.symptoms||'-'}</li>
              </ul>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button></div>
          </div>
        </div>
      </div>`;
      document.getElementById('modalContainer').innerHTML=html;
      new bootstrap.Modal(document.getElementById('memberDetailModal')).show();
    }

    // åŒ¯å‡º / å‚™ä»½
    async function exportMembers(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
      try{
        await callAPI('exportMembers',{ lineId:userProfile.userId });
        showNotification('åŒ¯å‡ºæˆåŠŸï¼ˆé›²ç«¯ç¡¬ç¢Ÿï¼‰','success');
      }catch(err){ showNotification('åŒ¯å‡ºå¤±æ•—ï¼š'+err.message,'error'); }
    }
    async function exportFinanceData(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
      try{
        await callAPI('exportFinanceData',{ lineId:userProfile.userId });
        showNotification('åŒ¯å‡ºæˆåŠŸ','success');
      }catch(err){ showNotification('åŒ¯å‡ºå¤±æ•—ï¼š'+err.message,'error'); }
    }
    async function backupSystem(){
      if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
      try{
        await callAPI('backupSystem',{ lineId:userProfile.userId });
        showNotification('å‚™ä»½å®Œæˆ','success');
      }catch(err){ showNotification('å‚™ä»½å¤±æ•—ï¼š'+err.message,'error'); }
    }

    // åˆ·æ–°
    async function refreshData(){
      try{
        await Promise.all([
          loadDashboard(),
          loadActivities(),
          loadMyRegistrations(),
          loadVolunteerData(),
          loadFinanceData(),
          loadFeedbackData(),
          loadMyReceipts(),
          isAdmin? loadAdminData():Promise.resolve()
        ]);
        showNotification('å·²åˆ·æ–°','success');
      }catch(err){ showNotification('åˆ·æ–°å¤±æ•—ï¼š'+err.message,'error'); }
    }

    // è¨­å®šï¼šè¼‰å…¥èˆ‡å„²å­˜
    async function loadSettings(){
      if(!isAdmin) return;
      try{
        const r = await callAPI('getSettings',{ lineId:userProfile.userId });
        const s = r.data;
        document.getElementById('receiptTemplateDocId').value = s.receiptTemplateDocId||'';
        document.getElementById('emailReplyTemplate').value = s.emailReplyTemplate||'';
        document.getElementById('incomeCategories').value = (s.incomeCategories||[]).join('\\n');
        document.getElementById('expenseCategoriesSetting').value = (s.expenseCategories||[]).join('\\n');
        document.getElementById('expenseVoucherTemplateDocId').value = s.expenseVoucherTemplateDocId||'';
        sysSettings.incomeCategories = s.incomeCategories||[];
        sysSettings.expenseCategories = s.expenseCategories||[];
        showNotification('è¨­å®šå·²è¼‰å…¥','success');
      }catch(err){
        showNotification('è¨­å®šè¼‰å…¥å¤±æ•—ï¼š'+err.message,'error');
      }
    }
    document.getElementById('settingsForm')?.addEventListener('submit', async e=>{
      e.preventDefault();
      if(!isAdmin) return;
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        const income = document.getElementById('incomeCategories').value.split('\\n').map(s=>s.trim()).filter(Boolean);
        const expense = document.getElementById('expenseCategoriesSetting').value.split('\\n').map(s=>s.trim()).filter(Boolean);
        await callAPI('updateSettings',{
          lineId:userProfile.userId,
          receiptTemplateDocId: document.getElementById('receiptTemplateDocId').value.trim(),
          emailReplyTemplate: document.getElementById('emailReplyTemplate').value,
          incomeCategories: income,
          expenseCategories: expense,
          expenseVoucherTemplateDocId: document.getElementById('expenseVoucherTemplateDocId').value.trim()
        });
        showNotification('è¨­å®šå·²å„²å­˜','success');
        await loadSettings();
      }catch(err){
        showNotification('å„²å­˜å¤±æ•—ï¼š'+err.message,'error');
      }finally{
        setButtonLoading(btn,false);
      }
    });

    // Tab äº‹ä»¶
    document.addEventListener('DOMContentLoaded',()=>{
      document.querySelectorAll('[data-bs-toggle="pill"],[data-bs-toggle="tab"]').forEach(btn=>{
        btn.addEventListener('shown.bs.tab',e=>{
          const id=e.target.getAttribute('data-bs-target').substring(1);
          switch(id){
            case 'activities': loadActivities(); loadMyRegistrations(); break;
            case 'volunteer': loadVolunteerData(); break;
            case 'finance': loadFinanceData(); break;
            case 'feedback': loadFeedbackData(); break;
            case 'admin': if(isAdmin) loadAdminData(); break;
            case 'incomeVerification': if(isAdmin) loadIncomeVerification(); break;
            case 'expenseApproval': if(isAdmin) loadExpenseApproval(); break;
            case 'systemSettings': if(isAdmin) loadSettings(); break;
          }
        });
      });
    });
    // ç¦ç”¨é textarea Enter
    document.addEventListener('keydown',e=>{
      if(e.key==='Enter' && !['TEXTAREA','BUTTON'].includes(e.target.tagName)) e.preventDefault();
    });

    // æš´éœ²æ–¹æ³•
    window.showNewActivityModal=showNewActivityModal;
    window.registerActivity=registerActivity;
    window.cancelRegistration=cancelRegistration;
    window.applyVolunteer=applyVolunteer;
    window.showNewDonationModal=showNewDonationModal;
    window.showNewExpenseModal=showNewExpenseModal;
    window.showNewVolunteerNeedModal=showNewVolunteerNeedModal;
    window.showNewTransactionModal=showNewTransactionModal;
    window.showManualReceiptModal=showManualReceiptModal;
    window.showSystemNotificationModal=showSystemNotificationModal;
    window.filterActivities=filterActivities;
    window.refreshData=refreshData;

    window.addEventListener('load',initializeLiff);
  </script>
</body>
</html>
