
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>帕金森病友會管理系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root{
      --base-font-size:18px;
      --heading-color:#222;
    }
    body{
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial,sans-serif;
      font-size: var(--base-font-size);
      line-height:1.55;
      background: linear-gradient(135deg,#667eea,#764ba2);
      min-height:100vh;
      padding:18px;
      color:#222;
    }
    h1,h2,h3,h4,h5{
      color:var(--heading-color);
      line-height:1.3;
    }
    h1{font-size:2.2rem;}
    h2{font-size:1.9rem;}
    h3{font-size:1.55rem;}
    h4{font-size:1.35rem;}
    h5{font-size:1.18rem;}
    .nav-pills .nav-link{
      font-size:1.05rem;
      padding:12px 22px;
    }
    .btn{
      font-size:1rem;
      padding:12px 22px;
    }
    .form-control,.form-select{
      font-size:1rem;
      padding:12px 14px;
    }
    .table td,.table th{
      font-size:0.95rem;
      vertical-align:middle;
    }
    .small{font-size:0.85rem !important;}
    .user-info-bar{font-size:1rem;}
    .stat-card h3{font-size:1.9rem;}
    /* 避免放大後破版 */
    @media (max-width: 768px){
      body{font-size:17px;}
      .nav-pills .nav-link{font-size:1rem;}
      h1{font-size:1.9rem;}
      h2{font-size:1.6rem;}
      h3{font-size:1.4rem;}
      .stat-card h3{font-size:1.6rem;}
    }
    /* 原先樣式（僅保留必要 & 字體已放大） */
    .container{max-width:1250px;margin:0 auto;}
    .main-header,.nav-container,.content-card{
      background:rgba(255,255,255,0.94);
      backdrop-filter:blur(10px);
      border-radius:16px;
      padding:28px;
      margin-bottom:18px;
      box-shadow:0 8px 24px rgba(0,0,0,0.18);
    }
    .header-content{
      background:linear-gradient(135deg,#4CAF50,#45a049);
      color:#fff;
      padding:26px;
      margin:-28px -28px 20px -28px;
      border-radius:16px 16px 12px 12px;
    }
    .user-info-bar{
      display:flex;gap:18px;align-items:center;
      background:#fff;
      padding:14px 20px;
      border-radius:40px;
      box-shadow:0 4px 14px rgba(0,0,0,0.08);
      margin-top:8px;
    }
    .user-avatar{
      width:54px;height:54px;
      border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:1.4rem;font-weight:600;
    }
    .quick-actions{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));}
    .quick-btn{
      background:#fff;
      border:2px solid #e2e8f0;
      border-radius:18px;
      padding:22px 12px;
      text-align:center;
      font-weight:600;
      cursor:pointer;
      transition:.3s;
      font-size:1rem;
    }
    .quick-btn i{font-size:2.1rem;margin-bottom:10px;display:block;}
    .quick-btn:hover{
      border-color:#4CAF50;
      color:#4CAF50;
      box-shadow:0 10px 24px rgba(76,175,80,.28);
      transform:translateY(-4px);
    }
    .stat-card{
      border-radius:18px;
      padding:24px;
      color:#fff;
      text-align:center;
      box-shadow:0 6px 18px rgba(0,0,0,0.18);
    }
    .activity-item,.transaction-item{
      background:#f8fafc;
      border-radius:14px;
      padding:20px;
      margin-bottom:14px;
      border-left:5px solid #4CAF50;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
      font-size:0.97rem;
    }
    .activity-item strong{font-size:1.05rem;}
    .status-badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:18px;
      font-size:0.75rem;
      font-weight:600;
      letter-spacing:.5px;
      margin-top:4px;
    }
    .status-開放報名,.status-active{background:#d4edda;color:#155724;}
    .status-已報名{background:#d1ecf1;color:#0c5460;}
    .status-已取消,.status-已拒絕{background:#f8d7da;color:#721c24;}
    .status-已完成{background:#e2e3ff;color:#383d41;}
    .status-審核中,.status-報名截止{background:#fff3cd;color:#856404;}
    .status-已核准{background:#d4edda;color:#155724;}
    .btn.loading{position:relative;color:transparent !important;}
    .btn.loading:after{
      content:'';
      position:absolute;top:50%;left:50%;width:20px;height:20px;
      margin:-10px;border:3px solid rgba(255,255,255,0.5);
      border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg);}}
    .table-container{max-height:500px;overflow:auto;border:1px solid #e2e8f0;border-radius:12px;background:#fff;}
    .table th{position:sticky;top:0;background:#f1f5f9;z-index:1;}
    .notification{
      position:fixed;top:20px;right:20px;
      background:#fff;padding:16px 20px;
      border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.15);
      transform:translateX(420px);transition:.4s;
      max-width:380px;font-size:1rem;
      border-left:6px solid #4CAF50;z-index:2000;
    }
    .notification.show{transform:translateX(0);}
    .notification.success{background:#d4edda;color:#155724;border-left-color:#4CAF50;}
    .notification.error{background:#f8d7da;color:#721c24;border-left-color:#dc3545;}
    .notification.warning{background:#fff3cd;color:#856404;border-left-color:#ffc107;}
    .notification.info{background:#d1ecf1;color:#0c5460;border-left-color:#17a2b8;}
    /* 深色模式 */
    @media (prefers-color-scheme: dark){
      body{background:#1f2333;color:#e2e8f0;}
      .main-header,.nav-container,.content-card{background:rgba(45,55,72,0.95);}
      .activity-item,.transaction-item{background:#2d3748;color:#e2e8f0;}
      .quick-btn{background:rgba(45,55,72,0.9);color:#e2e8f0;border-color:#4a5568;}
      .table-container{background:#2d3748;}
      .table th{background:#4a5568;color:#fff;}
      .form-control,.form-select{background:#2d3748;border-color:#4a5568;color:#e2e8f0;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-header">
      <div class="header-content">
        <h1 class="mb-2"><i class="bi bi-heart-pulse-fill me-2"></i>帕金森病友會管理系統</h1>
        <p class="mb-0" style="font-size:1.05rem;">關懷・支持・共好</p>
      </div>
      <div id="userInfoBar" class="user-info-bar" style="display:none;">
        <div class="user-avatar" id="userAvatar">?</div>
        <div>
          <div class="fw-bold" id="userName">載入中...</div>
          <div class="small text-muted" id="userLineName"></div>
          <div class="small text-muted" id="userRole">會員</div>
        </div>
        <div class="ms-auto">
          <button class="btn btn-sm btn-outline-secondary" onclick="refreshData()" title="刷新"><i class="bi bi-arrow-clockwise"></i></button>
        </div>
      </div>
    </div>

    <div id="notificationContainer"></div>

    <div class="nav-container">
      <ul class="nav nav-pills flex-wrap">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#dashboard">🏠 儀表板</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#profile">👤 個人資料</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#activities">🎪 活動管理</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#volunteer">🤝 志工服務</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#finance">💰 財務管理</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#feedback">💬 活動回饋</button></li>
        <li class="nav-item admin-only" style="display:none;"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#admin">⚙️ 系統管理</button></li>
      </ul>
    </div>

    <div class="tab-content">
      <!-- Dashboard -->
      <div class="tab-pane fade show active" id="dashboard">
        <div class="content-card">
          <div class="quick-actions mb-4">
            <div class="quick-btn" onclick="showTab('profile')"><i class="bi bi-person-check"></i>更新資料</div>
            <div class="quick-btn" onclick="showTab('activities')"><i class="bi bi-calendar-plus"></i>報名活動</div>
            <div class="quick-btn" onclick="showNewDonationModal()"><i class="bi bi-heart-fill"></i>愛心捐款</div>
            <div class="quick-btn" onclick="showTab('volunteer')"><i class="bi bi-hand-thumbs-up"></i>志工服務</div>
          </div>
          <div class="row g-3 mb-4" id="dashboardStats">
            <div class="col-12 text-center text-muted">載入中...</div>
          </div>
          <div>
            <h5 class="mb-3"><i class="bi bi-clock-history me-2"></i>最近活動</h5>
            <div id="recentActivity" class="mb-2 text-muted">載入中...</div>
          </div>
        </div>
      </div>

      <!-- Profile -->
      <div class="tab-pane fade" id="profile">
        <div class="content-card">
          <h3 class="mb-3"><i class="bi bi-person me-2"></i>個人資料管理</h3>
          <div id="registrationSection">
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>請先完成註冊以使用完整功能。
            </div>
            <form id="registrationForm" class="row g-3">
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" class="form-control" id="realName" name="realName" required>
                  <label for="realName">真實姓名 *</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="memberType" name="memberType" required>
                    <option value="">選擇</option>
                    <option value="病友">病友</option>
                    <option value="家屬">家屬</option>
                    <option value="志工">志工</option>
                    <option value="醫護">醫護人員</option>
                    <option value="支持者">支持者</option>
                  </select>
                  <label for="memberType">會員類別 *</label>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-primary" type="submit"><i class="bi bi-check-circle me-1"></i>完成註冊</button>
              </div>
            </form>
          </div>

          <div id="profileSection" style="display:none;">
            <form id="profileForm" class="row g-3">
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="text" class="form-control" id="profileRealName" readonly>
                  <label for="profileRealName">真實姓名</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="text" class="form-control" id="lineName" readonly>
                  <label for="lineName">LINE 名稱</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <select class="form-select" id="profileMemberType">
                    <option value="病友">病友</option>
                    <option value="家屬">家屬</option>
                    <option value="志工">志工</option>
                    <option value="醫護">醫護人員</option>
                    <option value="支持者">支持者</option>
                  </select>
                  <label for="profileMemberType">會員類別</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="tel" class="form-control" id="phone">
                  <label for="phone">聯絡電話</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="email" class="form-control" id="email">
                  <label for="email">電子郵件</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="date" class="form-control" id="birthday">
                  <label for="birthday">生日</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <textarea class="form-control" id="address" style="height:100px;"></textarea>
                  <label for="address">通訊地址</label>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-primary" type="submit"><i class="bi bi-save me-1"></i>更新資料</button>
              </div>
            </form>
            <div class="mt-4">
              <h5><i class="bi bi-bar-chart me-2"></i>個人統計</h5>
              <div class="row g-3" id="profileStats"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Activities -->
      <div class="tab-pane fade" id="activities">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="bi bi-calendar-event me-2"></i>活動管理</h3>
            <div class="admin-only" style="display:none;">
              <button class="btn btn-success btn-sm" onclick="showNewActivityModal()"><i class="bi bi-plus-circle me-1"></i>新增活動</button>
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <div class="form-floating">
                <select class="form-select" id="activityStatusFilter">
                  <option value="">全部狀態</option>
                  <option value="開放報名">開放報名</option>
                  <option value="報名截止">報名截止</option>
                  <option value="進行中">進行中</option>
                  <option value="已結束">已結束</option>
                </select>
                <label for="activityStatusFilter">狀態</label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-floating">
                <input type="date" class="form-control" id="activityDateFilter">
                <label for="activityDateFilter">日期</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="text" class="form-control" id="activitySearchFilter" placeholder="關鍵字">
                <label for="activitySearchFilter">搜尋</label>
              </div>
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-outline-primary" onclick="filterActivities()"><i class="bi bi-search"></i> 查詢</button>
            </div>
          </div>
          <div id="activitiesList" class="mb-4 text-muted">載入活動...</div>
          <div>
            <h5 class="mb-3"><i class="bi bi-clipboard-check me-2"></i>我的活動報名</h5>
            <div id="myRegistrations" class="text-muted">載入中...</div>
          </div>
        </div>
      </div>

      <!-- Volunteer -->
      <div class="tab-pane fade" id="volunteer">
        <div class="content-card">
          <h3 class="mb-3"><i class="bi bi-heart me-2"></i>志工服務</h3>
          <div class="row g-3 mb-4">
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);"><h3 id="volunteerHours">0</h3><p class="mb-0">服務時數</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#ffc107,#e0a800);"><h3 id="volunteerActivities">0</h3><p class="mb-0">參與次數</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#4CAF50,#45a049);"><h3 id="volunteerRank">-</h3><p class="mb-0">排名</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#dc3545,#b52a36);"><h3 id="availableNeeds">0</h3><p class="mb-0">可報名</p></div></div>
          </div>
          <h5 class="mb-3"><i class="bi bi-exclamation-circle me-2"></i>志工需求</h5>
          <div id="volunteerNeeds" class="mb-4 text-muted">載入中...</div>
          <h5 class="mb-3"><i class="bi bi-journal-text me-2"></i>我的志工記錄</h5>
          <div id="myVolunteerRecords" class="text-muted">載入中...</div>
          <div class="admin-only mt-4" style="display:none;">
            <button class="btn btn-success btn-sm" onclick="showNewVolunteerNeedModal()"><i class="bi bi-plus-circle me-1"></i>新增志工需求</button>
          </div>
        </div>
      </div>

      <!-- Finance -->
      <div class="tab-pane fade" id="finance">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="bi bi-cash-coin me-2"></i>財務管理</h3>
            <div>
              <button class="btn btn-success btn-sm me-2" onclick="showNewDonationModal()"><i class="bi bi-heart-fill me-1"></i>捐款</button>
              <button class="btn btn-warning btn-sm" onclick="showNewExpenseModal()"><i class="bi bi-receipt me-1"></i>支出申請</button>
            </div>
          </div>
          <div class="row g-3 mb-4">
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#4CAF50,#45a049);"><h3 id="myDonationAmount">NT$ 0</h3><p class="mb-0">捐款總額</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);"><h3 id="myDonationCount">0</h3><p class="mb-0">捐款次數</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#ffc107,#e0a800);"><h3 id="myExpenseAmount">NT$ 0</h3><p class="mb-0">支出申請額</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#dc3545,#b52a36);"><h3 id="pendingExpenses">0</h3><p class="mb-0">待審核</p></div></div>
          </div>
          <h5 class="mb-2"><i class="bi bi-heart-fill me-2"></i>我的捐款</h5>
          <div id="donationHistory" class="mb-4 text-muted">載入中...</div>
          <h5 class="mb-2"><i class="bi bi-receipt me-2"></i>我的支出申請</h5>
          <div id="expenseHistory" class="mb-4 text-muted">載入中...</div>
          <div class="admin-only mt-4" style="display:none;">
            <h5 class="mb-3"><i class="bi bi-graph-up me-2"></i>財務總覽（管理員）</h5>
            <div class="row g-3 mb-3">
              <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#4CAF50,#45a049);"><h3 id="totalIncome">NT$ 0</h3><p class="mb-0">總收入</p></div></div>
              <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#dc3545,#b52a36);"><h3 id="totalExpense">NT$ 0</h3><p class="mb-0">總支出</p></div></div>
              <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);"><h3 id="currentBalance">NT$ 0</h3><p class="mb-0">目前餘額</p></div></div>
              <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#ffc107,#e0a800);"><h3 id="monthlyDonations">NT$ 0</h3><p class="mb-0">本月捐款</p></div></div>
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="showNewTransactionModal()"><i class="bi bi-plus-circle me-1"></i>新增交易(快速)</button>
          </div>
        </div>
      </div>

      <!-- Feedback -->
      <div class="tab-pane fade" id="feedback">
        <div class="content-card">
          <h3 class="mb-3"><i class="bi bi-chat-dots me-2"></i>活動回饋</h3>
          <div class="card mb-4">
            <div class="card-header text-white" style="background:linear-gradient(135deg,#4CAF50,#45a049);">
              <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>新增回饋</h5>
            </div>
            <div class="card-body">
              <form id="feedbackForm" class="row g-3">
                <div class="col-md-6">
                  <div class="form-floating">
                    <select class="form-select" id="feedbackActivity" required>
                      <option value="">請選擇活動</option>
                    </select>
                    <label for="feedbackActivity">活動 *</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <select class="form-select" id="feedbackRating" required>
                      <option value="">評分</option>
                      <option value="5">5 - 非常滿意</option>
                      <option value="4">4 - 滿意</option>
                      <option value="3">3 - 普通</option>
                      <option value="2">2 - 不滿意</option>
                      <option value="1">1 - 非常不滿意</option>
                    </select>
                    <label for="feedbackRating">評分 *</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-floating">
                    <textarea class="form-control" id="feedbackComment" style="height:120px;" required></textarea>
                    <label for="feedbackComment">意見 / 建議 *</label>
                  </div>
                </div>
                <div class="col-12">
                  <button class="btn btn-primary" type="submit"><i class="bi bi-send me-1"></i>提交</button>
                </div>
              </form>
            </div>
          </div>
          <h5 class="mb-3"><i class="bi bi-chat-left-text me-2"></i>我的回饋</h5>
          <div id="myFeedback" class="mb-4 text-muted">載入中...</div>
          <div class="admin-only" style="display:none;">
            <h5 class="mb-3"><i class="bi bi-chat-square-dots me-2"></i>全部回饋（管理員）</h5>
            <div id="allFeedback" class="text-muted">載入中...</div>
          </div>
        </div>
      </div>

      <!-- Admin -->
      <div class="tab-pane fade" id="admin">
        <div class="content-card">
          <h3 class="mb-3"><i class="bi bi-gear me-2"></i>系統管理</h3>
          <ul class="nav nav-tabs mb-4">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#memberManagement">會員</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#activityManagement">活動</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#financeManagement">財務</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#receiptManagement">收據</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#systemSettings">設定</button></li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="memberManagement">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">會員列表</h5>
                <div>
                  <button class="btn btn-outline-primary btn-sm" onclick="exportMembers()"><i class="bi bi-download me-1"></i>匯出</button>
                </div>
              </div>
              <div class="table-container">
                <table class="table table-hover table-sm">
                  <thead>
                    <tr><th>姓名</th><th>類別</th><th>狀態</th><th>加入日期</th><th>捐款次數</th><th>操作</th></tr>
                  </thead>
                  <tbody id="memberList">
                    <tr><td colspan="6" class="text-center text-muted py-4">載入中...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="activityManagement">
              <div class="d-flex justify-content-between mb-2">
                <h5 class="mb-0">活動列表</h5>
                <button class="btn btn-success btn-sm" onclick="showNewActivityModal()"><i class="bi bi-plus-circle me-1"></i>新增活動</button>
              </div>
              <div id="adminActivityList" class="text-muted">載入中...</div>
            </div>
            <div class="tab-pane fade" id="financeManagement">
              <div class="d-flex justify-content-between mb-2">
                <h5 class="mb-0">交易記錄</h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-success btn-sm" onclick="showNewTransactionModal()"><i class="bi bi-plus-circle me-1"></i>新增交易</button>
                  <button class="btn btn-outline-primary btn-sm" onclick="exportFinanceData()"><i class="bi bi-download me-1"></i>匯出</button>
                </div>
              </div>
              <div class="table-container">
                <table class="table table-sm table-hover">
                  <thead><tr><th>日期</th><th>類型</th><th>金額</th><th>分類</th><th>說明</th><th>狀態</th></tr></thead>
                  <tbody id="transactionList"><tr><td colspan="6" class="text-center text-muted py-4">載入中...</td></tr></tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="receiptManagement">
              <div class="d-flex justify-content-between mb-2">
                <h5 class="mb-0">收據列表</h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-info btn-sm" onclick="showReceiptTemplateModal()"><i class="bi bi-file-text me-1"></i>模板設定</button>
                  <button class="btn btn-success btn-sm" onclick="showManualReceiptModal()"><i class="bi bi-plus-circle me-1"></i>手動開立</button>
                </div>
              </div>
              <div id="receiptList" class="text-muted">載入中...</div>
            </div>
            <div class="tab-pane fade" id="systemSettings">
              <h5 class="mb-3">系統工具</h5>
              <div class="d-flex flex-wrap gap-3">
                <button class="btn btn-warning" onclick="backupSystem()"><i class="bi bi-database me-1"></i>立即備份</button>
                <button class="btn btn-info" onclick="showSystemNotificationModal()"><i class="bi bi-megaphone me-1"></i>發送通知</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- tab-content -->
  </div>

  <div id="modalContainer"></div>

  <script>
    // ========== 設定 ==========
    const CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',  // TODO: 替換
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycbyjst47cTooNlcCtQQmuBIMbJLe4RxvB9Cq9WfSk545ayoi5_RzOj3PWoABmUv7Pk7C/exec', // TODO: 替換
      API_KEY: 'AAbb8520258185202581' // TODO: 替換
    };

    // ========== 全域狀態 ==========
    let userProfile = null;
    let currentUser = null;
    let isAdmin = false;
    let allActivities = [];
    let cachedAdminData = null;

    // ========== 工具 ==========
    const formatDate = d => {
      if(!d) return '-';
      const dt = new Date(d);
      return isNaN(dt)? '-' : dt.toLocaleDateString('zh-TW');
    };
    const formatDateTime = d => {
      if(!d) return '-';
      const dt = new Date(d);
      return isNaN(dt)? '-' : dt.toLocaleString('zh-TW');
    };
    const formatCurrency = n =>
      new Intl.NumberFormat('zh-TW',{style:'currency',currency:'TWD',minimumFractionDigits:0}).format(n||0);

    function showNotification(msg,type='success',ms=3500){
      const wrap = document.getElementById('notificationContainer');
      const el = document.createElement('div');
      el.className = `notification ${type}`;
      el.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <span>${msg}</span>
          <button style="background:none;border:none;font-size:20px;line-height:1;" onclick="this.closest('.notification').remove()">&times;</button>
        </div>`;
      wrap.appendChild(el);
      requestAnimationFrame(()=>el.classList.add('show'));
      setTimeout(()=>{
        el.classList.remove('show');
        setTimeout(()=>el.remove(),400);
      },ms);
    }
    function setButtonLoading(btn,loading=true){
      if(!btn) return;
      if(loading){
        if(!btn.dataset.originalText) btn.dataset.originalText = btn.innerHTML;
        btn.classList.add('loading');
        btn.disabled = true;
      }else{
        btn.classList.remove('loading');
        btn.disabled = false;
        if(btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText;
      }
    }

    async function callAPI(action,data={},retries=1){
      const payload = {
        action,
        apiKey: CONFIG.API_KEY,
        timestamp: Date.now(),
        ...data
      };
      let lastErr;
      for(let i=0;i<=retries;i++){
        try{
          const res = await fetch(CONFIG.API_BASE_URL,{
            method:'POST',
            body: JSON.stringify(payload)
          });
          const text=await res.text();
          let json;
          try{ json=JSON.parse(text); }catch(e){ throw new Error('回應非 JSON: '+text.slice(0,120)); }
          if(!json.success) throw new Error(json.message||'API 錯誤');
          return json;
        }catch(err){
          lastErr=err;
          await new Promise(r=>setTimeout(r,400*(i+1)));
        }
      }
      throw lastErr;
    }

    // ========== LIFF 初始化 ==========
    async function initializeLiff(){
      try{
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if(!liff.isLoggedIn()){ liff.login(); return; }
        userProfile = await liff.getProfile();
        const bar=document.getElementById('userInfoBar');
          bar.style.display='flex';
        document.getElementById('userLineName').textContent='LINE：'+(userProfile.displayName||'');
        document.getElementById('userName').textContent=userProfile.displayName||'會員';
        document.getElementById('userAvatar').textContent=(userProfile.displayName||'?').charAt(0);
        await loadUserData();
        await loadDashboard();
        showNotification('系統初始化完成','success');
      }catch(err){
        console.error(err);
        showNotification('LIFF 初始化失敗：'+err.message,'error');
      }
    }

    // ========== 使用者 ==========
    async function loadUserData(){
      try{
        const r=await callAPI('getUserInfo',{ lineId:userProfile.userId });
        if(r.success){
          currentUser=r.data;
          isAdmin=!!currentUser.isAdmin;
          updateUserUI();
        }else{
          showRegistrationForm();
        }
      }catch{
        showRegistrationForm();
      }
    }
    function updateUserUI(){
      if(!currentUser) return;
      document.getElementById('userName').textContent =
        currentUser.realName || currentUser.lineName || userProfile.displayName || '會員';
      document.getElementById('userRole').textContent = currentUser.memberType || '會員';
      document.getElementById('userAvatar').textContent =
        (currentUser.realName || currentUser.lineName || userProfile.displayName || '?').charAt(0);
      document.querySelectorAll('.admin-only').forEach(el=> el.style.display = isAdmin ? 'block':'none');
      updateProfileSection();
    }
    function showRegistrationForm(){
      document.getElementById('registrationSection').style.display='block';
      document.getElementById('profileSection').style.display='none';
    }
    function updateProfileSection(){
      if(!currentUser) return;
      document.getElementById('registrationSection').style.display='none';
      document.getElementById('profileSection').style.display='block';
      document.getElementById('profileRealName').value=currentUser.realName||'';
      document.getElementById('lineName').value=currentUser.lineName||userProfile.displayName||'';
      document.getElementById('phone').value=currentUser.phone||'';
      document.getElementById('email').value=currentUser.email||'';
      document.getElementById('birthday').value=currentUser.birthday||'';
      document.getElementById('profileMemberType').value=currentUser.memberType||'病友';
      document.getElementById('address').value=currentUser.address||'';
      document.getElementById('profileStats').innerHTML=`
        <div class="col-sm-6 col-lg-3">
          <div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);">
            <h3>${currentUser.memberType||'-'}</h3><p class="mb-0">身份</p>
          </div>
        </div>`;
    }

    document.getElementById('registrationForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('registerUser',{
          lineId:userProfile.userId,
          lineName:userProfile.displayName,
          realName:fd.get('realName'),
          memberType:fd.get('memberType')
        });
        showNotification('註冊成功','success');
        await loadUserData();
      }catch(err){
        showNotification('註冊失敗：'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });

    document.getElementById('profileForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('updateProfile',{
          lineId:userProfile.userId,
          phone:fd.get('phone'),
          email:fd.get('email'),
          birthday:fd.get('birthday'),
          memberType:fd.get('profileMemberType'),
          address:fd.get('address')
        });
        showNotification('更新成功','success');
        await loadUserData();
      }catch(err){
        showNotification('更新失敗：'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });

    // ========== Dashboard ==========
    async function loadDashboard(){
      try{
        const r=await callAPI('getDashboardData',{ lineId:userProfile?.userId });
        const d=r.data;
        document.getElementById('dashboardStats').innerHTML=`
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#4CAF50,#45a049);"><h3>${d.totalActivities||0}</h3><p class="mb-0">可報名活動</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);"><h3>${d.myRegistrations||0}</h3><p class="mb-0">我的報名</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#ffc107,#e0a800);"><h3>${d.myVolunteerHours||0}</h3><p class="mb-0">志工時數</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#dc3545,#b52a36);"><h3>${formatCurrency(d.myDonationAmount||0).replace('NT$','')}</h3><p class="mb-0">捐款總額</p></div></div>
        `;
        renderRecentActivity(d.recentActivity||[]);
      }catch(err){
        document.getElementById('dashboardStats').innerHTML=`<div class="col-12 text-center text-danger">${err.message}</div>`;
      }
    }
    function renderRecentActivity(list){
      const c=document.getElementById('recentActivity');
      if(!list.length){ c.textContent='暫無最近活動'; return; }
      c.innerHTML=list.map(a=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${a.title||''}</strong>
              <div class="small text-muted">${a.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(a.date)}</small>
            </div>
            <span class="status-badge status-${(a.status||'').trim()}">${a.status||''}</span>
          </div>
        </div>`).join('');
    }

    // ========== 活動 ==========
    async function loadActivities(){
      try{
        const r=await callAPI('getActivities');
        allActivities=r.data||[];
        renderActivities(allActivities);
      }catch(err){
        document.getElementById('activitiesList').innerHTML='<div class="text-danger text-center">'+err.message+'</div>';
      }
    }
    function renderActivities(list){
      const c=document.getElementById('activitiesList');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">目前沒有活動</p>'; return; }
      c.innerHTML=list.map(a=>`
        <div class="activity-item">
          <div class="row">
            <div class="col-md-8">
              <strong>${a.title}</strong>
              <p class="mb-2 small text-muted">${a.description||''}</p>
              <div class="d-flex flex-wrap gap-3 small text-muted">
                <span><i class="bi bi-calendar me-1"></i>${formatDate(a.date)}</span>
                <span><i class="bi bi-clock me-1"></i>${a.time||'-'}</span>
                <span><i class="bi bi-geo-alt me-1"></i>${a.location||'-'}</span>
                <span><i class="bi bi-people me-1"></i>${a.currentCount||0}/${a.maxParticipants||0}</span>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <span class="status-badge status-${a.status}">${a.status}</span><br>
              <span class="fw-bold text-primary d-inline-block mt-2">${formatCurrency(a.fee||0)}</span><br>
              ${(a.status==='開放報名')? `<button class="btn btn-primary btn-sm mt-2" onclick="registerActivity('${a.id}')"><i class="bi bi-plus-circle me-1"></i>報名</button>`:''}
            </div>
          </div>
        </div>`).join('');
    }
    function filterActivities(){
      const s=document.getElementById('activityStatusFilter').value.trim();
      const d=document.getElementById('activityDateFilter').value.trim();
      const kw=document.getElementById('activitySearchFilter').value.trim().toLowerCase();
      let list=[...allActivities];
      if(s) list=list.filter(a=>a.status===s);
      if(d) list=list.filter(a=>(a.date||'').startsWith(d));
      if(kw) list=list.filter(a=>(a.title||'').toLowerCase().includes(kw) ||
                               (a.description||'').toLowerCase().includes(kw) ||
                               (a.location||'').toLowerCase().includes(kw));
      renderActivities(list);
    }
    async function registerActivity(id){
      if(!currentUser){ showNotification('請先註冊','warning'); return; }
      try{
        await callAPI('registerActivity',{ lineId:userProfile.userId, activityId:id });
        showNotification('報名成功','success');
        await loadActivities();
        await loadMyRegistrations();
        await loadDashboard();
      }catch(err){
        showNotification('報名失敗：'+err.message,'error');
      }
    }
    async function loadMyRegistrations(){
      if(!currentUser) return;
      try{
        const r=await callAPI('getMyRegistrations',{ lineId:userProfile.userId });
        renderMyRegistrations(r.data||[]);
      }catch(err){
        document.getElementById('myRegistrations').innerHTML='<div class="text-danger">'+err.message+'</div>';
      }
    }
    function renderMyRegistrations(list){
      const c=document.getElementById('myRegistrations');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">尚無報名</p>'; return; }
      c.innerHTML=list.map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.activityTitle}</strong>
              <div class="small text-muted mb-1"><i class="bi bi-calendar me-1"></i>${formatDateTime(r.registrationTime)}</div>
              <small class="text-muted">狀態：${r.status}</small>
            </div>
            <div class="text-end">
                <span class="status-badge status-${r.status}">${r.status}</span><br>
                ${r.status==='已報名'
                  ? `<button class="btn btn-outline-danger btn-sm mt-2" onclick="cancelRegistration('${r.id}')">
                       <i class="bi bi-x-circle me-1"></i>取消
                     </button>`
                  : ''
                }
            </div>
          </div>
        </div>`).join('');
    }

    async function cancelRegistration(regId){
      if(!confirm('確定要取消這筆報名？')) return;
      try{
        await callAPI('cancelRegistration',{ lineId:userProfile.userId, registrationId:regId });
        showNotification('已取消','success');
        await loadActivities();
        await loadMyRegistrations();
        await loadDashboard();
      }catch(err){
        showNotification('取消失敗：'+err.message,'error');
      }
    }

    // ========== 志工 ==========
    async function loadVolunteerData(){
      try{
        const r=await callAPI('getVolunteerData',{ lineId:userProfile.userId });
        const d=r.data||{};
        document.getElementById('volunteerHours').textContent=d.stats.totalHours||0;
        document.getElementById('volunteerActivities').textContent=d.stats.totalActivities||0;
        document.getElementById('volunteerRank').textContent=d.stats.rank||'-';
        document.getElementById('availableNeeds').textContent=d.stats.availableNeeds||0;
        renderVolunteerNeeds(d.needs||[]);
        renderVolunteerRecords(d.records||[]);
      }catch(err){
        document.getElementById('volunteerNeeds').innerHTML='<div class="text-danger">'+err.message+'</div>';
      }
    }
    function renderVolunteerNeeds(list){
      const c=document.getElementById('volunteerNeeds');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">目前沒有開放的志工需求</p>'; return; }
      c.innerHTML=list.map(n=>`
        <div class="activity-item">
          <div class="row">
            <div class="col-md-8">
              <strong>${n.title}</strong>
              <p class="mb-2 small text-muted">${n.description||''}</p>
              <div class="d-flex flex-wrap gap-3 small text-muted">
                <span><i class="bi bi-calendar me-1"></i>${formatDate(n.date)}</span>
                <span><i class="bi bi-clock me-1"></i>${n.time||'-'}</span>
                <span><i class="bi bi-people me-1"></i>${n.currentCount||0}/${n.needCount||0}</span>
                <span><i class="bi bi-stopwatch me-1"></i>${n.hours||0} 時</span>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <span class="status-badge status-${n.status}">${n.status}</span><br>
              <button class="btn btn-primary btn-sm mt-2" onclick="applyVolunteer('${n.id}')">
                <i class="bi bi-plus-circle me-1"></i>報名
              </button>
            </div>
          </div>
        </div>`).join('');
    }
    function renderVolunteerRecords(list){
      const c=document.getElementById('myVolunteerRecords');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">尚無志工記錄</p>'; return; }
      c.innerHTML=list.map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.title}</strong>
              <div class="small text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(r.date)} ｜ ${r.hours} 時</div>
              ${r.feedback? `<div class="small text-muted">回饋：${r.feedback}</div>`:''}
            </div>
            <span class="status-badge status-${r.status}">${r.status}</span>
          </div>
        </div>`).join('');
    }
    async function applyVolunteer(id){
      if(!currentUser){ showNotification('請先註冊','warning'); return; }
      try{
        await callAPI('applyVolunteer',{ lineId:userProfile.userId, needId:id });
        showNotification('志工報名成功','success');
        await loadVolunteerData();
        await loadDashboard();
      }catch(err){
        showNotification('報名失敗：'+err.message,'error');
      }
    }

    // ========== 財務 ==========
    async function loadFinanceData(){
      if(!currentUser) return;
      try{
        const r=await callAPI('getFinanceData',{ lineId:userProfile.userId });
        const d=r.data;
        // 個人統計
        document.getElementById('myDonationAmount').textContent='NT$ '+(d.stats.totalDonation||0).toLocaleString();
        document.getElementById('myDonationCount').textContent=d.stats.donationCount||0;
        document.getElementById('myExpenseAmount').textContent='NT$ '+(d.stats.totalExpense||0).toLocaleString();
        document.getElementById('pendingExpenses').textContent=d.stats.pendingExpenses||0;
        renderDonationHistory(d.donations||[]);
        renderExpenseHistory(d.expenses||[]);
        if(isAdmin){
          const a=d.adminStats||{};
            document.getElementById('totalIncome').textContent='NT$ '+(a.totalIncome||0).toLocaleString();
            document.getElementById('totalExpense').textContent='NT$ '+(a.totalExpense||0).toLocaleString();
            document.getElementById('currentBalance').textContent='NT$ '+(a.currentBalance||0).toLocaleString();
            document.getElementById('monthlyDonations').textContent='NT$ '+(a.monthlyDonations||0).toLocaleString();
        }
      }catch(err){
        document.getElementById('donationHistory').innerHTML='<div class="text-danger">'+err.message+'</div>';
      }
    }
    function renderDonationHistory(list){
      const c=document.getElementById('donationHistory');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">尚無捐款記錄</p>'; return; }
      c.innerHTML=list.sort((a,b)=> new Date(b.date||0)-new Date(a.date||0)).map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.category}</strong>
              <div class="small text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(r.date)}</div>
              <div class="small text-muted">收據：${r.receiptNumber||'-'}</div>
            </div>
            <div class="text-end">
              <div class="fw-bold text-success">${formatCurrency(r.amount)}</div>
              <span class="status-badge status-${r.status}">${r.status}</span>
            </div>
          </div>
        </div>`).join('');
    }
    function renderExpenseHistory(list){
      const c=document.getElementById('expenseHistory');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">尚無支出申請</p>'; return; }
      c.innerHTML=list.sort((a,b)=> new Date(b.createdAt||0)-new Date(a.createdAt||0)).map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between small">
            <div>
              <strong>${r.category}</strong>
              <div class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(r.createdAt)}</div>
              ${r.voucherUrl? `<a href="${r.voucherUrl}" target="_blank" class="small">憑證PDF</a>`:''}
            </div>
            <div class="text-end">
              <div class="fw-bold text-danger">${formatCurrency(r.amount)}</div>
              <span class="status-badge status-${r.status}">${r.status}</span>
            </div>
          </div>
        </div>`).join('');
    }

    function showNewDonationModal(){
      showModal({
        title:'新增捐款',
        body:`
          <form id="donationForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="donationCategory" required>
                  <option value="一般捐款">一般捐款</option>
                  <option value="活動贊助">活動贊助</option>
                </select>
                <label for="donationCategory">捐款類別 *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="number" class="form-control" id="donationAmount" min="1" required>
                <label for="donationAmount">金額 *</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="donationDesc" style="height:100px;"></textarea>
                <label for="donationDesc">說明 (可空白)</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="needReceipt">
                <label for="needReceipt" class="form-check-label">需要收據</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-primary w-100" type="submit"><i class="bi bi-heart-fill me-1"></i>送出捐款</button>
            </div>
          </form>`,
        onShown:()=>{
          document.getElementById('donationForm').addEventListener('submit',async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              const res=await callAPI('createDonation',{
                lineId:userProfile.userId,
                category:document.getElementById('donationCategory').value,
                amount:document.getElementById('donationAmount').value,
                description:document.getElementById('donationDesc').value,
                needReceipt:document.getElementById('needReceipt').checked
              });
              showNotification('捐款成功','success');
              closeModal();
              await loadFinanceData();
              await loadDashboard();
              if(res.data?.pdfUrl){
                if(confirm('收據已開立，是否前往查看？')) window.open(res.data.pdfUrl,'_blank');
              }
            }catch(err){
              showNotification('捐款失敗：'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    function showNewExpenseModal(){
      showModal({
        title:'新增支出申請',
        body:`
          <form id="expenseForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="expenseCategory" required>
                  <option value="活動費用">活動費用</option>
                  <option value="行政支出">行政支出</option>
                  <option value="設備支出">設備支出</option>
                </select>
                <label for="expenseCategory">支出類別 *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="number" class="form-control" id="expenseAmount" min="1" required>
                <label for="expenseAmount">金額 *</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="expenseDesc" style="height:100px;"></textarea>
                <label for="expenseDesc">說明</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-warning w-100" type="submit"><i class="bi bi-receipt me-1"></i>送出申請</button>
            </div>
          </form>`,
        onShown:()=>{
          document.getElementById('expenseForm').addEventListener('submit', async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              await callAPI('createExpense',{
                lineId:userProfile.userId,
                category:document.getElementById('expenseCategory').value,
                amount:document.getElementById('expenseAmount').value,
                description:document.getElementById('expenseDesc').value
              });
              showNotification('支出申請建立','success');
              closeModal();
              await loadFinanceData();
            }catch(err){
              showNotification('申請失敗：'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    // ========== 回饋 ==========
    async function loadFeedbackData(){
      if(!currentUser) return;
      try{
        // 我的回饋
        const mine=await callAPI('getMyFeedback',{ lineId:userProfile.userId });
        renderMyFeedback(mine.data||[]);
        // 取得我已完成活動（供下拉）
        const comp=await callAPI('getMyCompletedActivities',{ lineId:userProfile.userId });
        const sel=document.getElementById('feedbackActivity');
        sel.innerHTML='<option value="">請選擇活動</option>'+ (comp.data||[]).map(a=>`<option value="${a.id}">${a.title}</option>`).join('');
        // 全部回饋（管理員）
        if(isAdmin){
          const all=await callAPI('getAllFeedback',{ lineId:userProfile.userId });
          renderAllFeedback(all.data||[]);
        }
      }catch(err){
        document.getElementById('myFeedback').innerHTML='<div class="text-danger">'+err.message+'</div>';
      }
    }
    function renderMyFeedback(list){
      const c=document.getElementById('myFeedback');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">尚無回饋</p>'; return; }
      c.innerHTML=list.sort((a,b)=> new Date(b.createdAt||0)-new Date(a.createdAt||0)).map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.activityTitle}</strong>
              <div class="small text-muted">${formatDateTime(r.createdAt)}</div>
              <div class="small text-muted">${'★'.repeat(r.rating)}${'☆'.repeat(5-r.rating)}</div>
              <div class="small">${r.comment||''}</div>
            </div>
            <span class="status-badge status-已完成">評分 ${r.rating}</span>
          </div>
        </div>`).join('');
    }
    function renderAllFeedback(list){
      const c=document.getElementById('allFeedback');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">尚無資料</p>'; return; }
      c.innerHTML=list.sort((a,b)=> new Date(b.createdAt||0)-new Date(a.createdAt||0)).map(r=>`
        <div class="activity-item small">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.activityTitle}</strong>
              <div class="text-muted">${formatDateTime(r.createdAt)} ｜ ${r.lineId}</div>
              <div>${r.comment||''}</div>
            </div>
            <div style="min-width:70px;" class="text-end">${'★'.repeat(r.rating)}${'☆'.repeat(5-r.rating)}</div>
          </div>
        </div>`).join('');
    }

    document.getElementById('feedbackForm').addEventListener('submit', async e=>{
      e.preventDefault();
      if(!currentUser){ showNotification('請先註冊','warning'); return; }
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('createFeedback',{
          lineId:userProfile.userId,
          activityId:document.getElementById('feedbackActivity').value,
          rating:document.getElementById('feedbackRating').value,
          comment:document.getElementById('feedbackComment').value
        });
        showNotification('已提交','success');
        document.getElementById('feedbackForm').reset();
        await loadFeedbackData();
      }catch(err){
        showNotification('提交失敗：'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });

    // ========== 系統管理 (Admin) ==========
    async function loadAdminData(force=false){
      if(!isAdmin) return;
      if(cachedAdminData && !force){
        renderAdminData(cachedAdminData);
        return;
      }
      try{
        const r=await callAPI('getAdminData',{ lineId:userProfile.userId });
        cachedAdminData=r.data;
        renderAdminData(r.data);
      }catch(err){
        console.error(err);
      }
    }
    function renderAdminData(data){
      renderMemberList(data.members||[]);
      renderAdminActivities(data.activities||[]);
      renderTransactions(data.transactions||[]);
      renderReceiptList(data.receipts||[]);
    }
    function renderMemberList(list){
      const tb=document.getElementById('memberList');
      if(!list.length){
        tb.innerHTML='<tr><td colspan="6" class="text-center text-muted py-4">無資料</td></tr>'; return;
      }
      tb.innerHTML=list.sort((a,b)=> new Date(b.joinDate||0)-new Date(a.joinDate||0)).map(m=>`
        <tr>
          <td>${m.realName||m.lineName||'-'}</td>
          <td>${m.memberType||'-'}</td>
          <td>${m.status||'-'}</td>
          <td>${formatDate(m.joinDate)}</td>
          <td>${m.donationCount||0}</td>
          <td><button class="btn btn-outline-secondary btn-sm" onclick="viewMember('${m.lineId}')">查看</button></td>
        </tr>`).join('');
    }
    function viewMember(lineId){
      const m=(cachedAdminData?.members||[]).find(x=>x.lineId===lineId);
      if(!m) return;
      showModal({
        title:'會員資料',
        body:`
          <div class="small">
            <p><strong>姓名：</strong>${m.realName||'-'}</p>
            <p><strong>LINE：</strong>${m.lineName||'-'}</p>
            <p><strong>類別：</strong>${m.memberType||'-'}</p>
            <p><strong>電話：</strong>${m.phone||'-'}</p>
            <p><strong>Email：</strong>${m.email||'-'}</p>
            <p><strong>地址：</strong>${m.address||'-'}</p>
            <p><strong>加入：</strong>${formatDate(m.joinDate)}</p>
            <p><strong>捐款次數：</strong>${m.donationCount||0}</p>
          </div>`
      });
    }
    function renderAdminActivities(list){
      const c=document.getElementById('adminActivityList');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">無活動</p>'; return; }
      c.innerHTML=list.map(a=>`
        <div class="activity-item small">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${a.title}</strong>
              <div class="text-muted">${formatDate(a.date)} ｜ ${a.location||'-'}</div>
              <div class="text-muted">人數：${a.currentCount||0}/${a.maxParticipants||0}</div>
            </div>
            <div class="text-end">
              <span class="status-badge status-${a.status}">${a.status}</span><br>
              <button class="btn btn-outline-primary btn-sm mt-2" onclick="editActivity('${a.id}')">
                <i class="bi bi-pencil"></i>
              </button>
            </div>
          </div>
        </div>`).join('');
    }
    function editActivity(id){
      const a=(cachedAdminData?.activities||[]).find(x=>x.id===id) || allActivities.find(x=>x.id===id);
      if(!a) return;
      showModal({
        title:'編輯活動',
        body:`
          <form id="editActivityForm" class="row g-3">
            <input type="hidden" id="editActivityId" value="${a.id}">
            <div class="col-md-6">
              <div class="form-floating">
                <input class="form-control" id="editActivityTitle" required value="${a.title||''}">
                <label for="editActivityTitle">活動名稱 *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="date" class="form-control" id="editActivityDate" value="${(a.date||'').split('T')[0]||a.date||''}">
                <label for="editActivityDate">日期</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input class="form-control" id="editActivityTime" value="${a.time||''}">
                <label for="editActivityTime">時間</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input class="form-control" id="editActivityLocation" value="${a.location||''}">
                <label for="editActivityLocation">地點</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="number" class="form-control" id="editActivityMax" value="${a.maxParticipants||0}">
                <label for="editActivityMax">人數上限</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="editActivityDesc" style="height:120px;">${a.description||''}</textarea>
                <label for="editActivityDesc">說明</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="editActivityStatus">
                  ${['開放報名','報名截止','進行中','已結束','已刪除'].map(s=>`<option value="${s}" ${a.status===s?'selected':''}>${s}</option>`).join('')}
                </select>
                <label for="editActivityStatus">狀態</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="number" class="form-control" id="editActivityFee" value="${a.fee||0}">
                <label for="editActivityFee">費用</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-primary w-100" type="submit"><i class="bi bi-save me-1"></i>儲存</button>
            </div>
          </form>`,
        onShown:()=>{
          document.getElementById('editActivityForm').addEventListener('submit', async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              await callAPI('updateActivity',{
                lineId:userProfile.userId,
                activityId:document.getElementById('editActivityId').value,
                title:document.getElementById('editActivityTitle').value,
                date:document.getElementById('editActivityDate').value,
                time:document.getElementById('editActivityTime').value,
                location:document.getElementById('editActivityLocation').value,
                maxParticipants:document.getElementById('editActivityMax').value,
                description:document.getElementById('editActivityDesc').value,
                status:document.getElementById('editActivityStatus').value,
                fee:document.getElementById('editActivityFee').value
              });
              showNotification('已更新活動','success');
              closeModal();
              await loadActivities();
              await loadAdminData(true);
            }catch(err){
              showNotification('更新失敗：'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    function renderTransactions(list){
      const tb=document.getElementById('transactionList');
      if(!list.length){
        tb.innerHTML='<tr><td colspan="6" class="text-center text-muted py-4">無資料</td></tr>'; return;
      }
      tb.innerHTML=list.map(t=>`
        <tr>
          <td>${formatDate(t.date)}</td>
          <td>${t.type}</td>
          <td>${formatCurrency(t.amount)}</td>
          <td>${t.category||'-'}</td>
          <td>${t.description||''}</td>
          <td><span class="status-badge status-${t.status}">${t.status}</span></td>
        </tr>`).join('');
    }

    function renderReceiptList(list){
      const c=document.getElementById('receiptList');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">尚無收據</p>'; return; }
      c.innerHTML=list.sort((a,b)=> new Date(b.issueDate||0)-new Date(a.issueDate||0)).map(r=>`
        <div class="activity-item small">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.receiptNumber}</strong>
              <div class="text-muted">${formatDate(r.issueDate)} ｜ ${r.type}</div>
              <div class="text-muted">金額：${formatCurrency(r.amount)}</div>
            </div>
            <div class="text-end">
              <span class="status-badge status-${r.status}">${r.status}</span><br>
              ${r.pdfUrl? `<a href="${r.pdfUrl}" target="_blank" class="btn btn-outline-primary btn-sm mt-2">PDF</a>`:''}
            </div>
          </div>
        </div>`).join('');
    }

    function showNewActivityModal(){
      showModal({
        title:'新增活動',
        body:`
          <form id="newActivityForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input class="form-control" id="newActTitle" required>
                <label for="newActTitle">活動名稱 *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="date" class="form-control" id="newActDate" required>
                <label for="newActDate">日期 *</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input class="form-control" id="newActTime">
                <label for="newActTime">時間</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input class="form-control" id="newActLocation">
                <label for="newActLocation">地點</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="number" class="form-control" id="newActMax" min="1" value="30">
                <label for="newActMax">人數上限</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="number" class="form-control" id="newActFee" min="0" value="0">
                <label for="newActFee">費用</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="newActDesc" style="height:120px;"></textarea>
                <label for="newActDesc">活動說明</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-success w-100" type="submit"><i class="bi bi-plus-circle me-1"></i>建立</button>
            </div>
          </form>`,
        onShown:()=>{
          document.getElementById('newActivityForm').addEventListener('submit', async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              await callAPI('createActivity',{
                lineId:userProfile.userId,
                title:document.getElementById('newActTitle').value,
                date:document.getElementById('newActDate').value,
                time:document.getElementById('newActTime').value,
                location:document.getElementById('newActLocation').value,
                maxParticipants:document.getElementById('newActMax').value,
                fee:document.getElementById('newActFee').value,
                description:document.getElementById('newActDesc').value
              });
              showNotification('活動建立成功','success');
              closeModal();
              await loadActivities();
              await loadAdminData(true);
            }catch(err){
              showNotification('建立失敗：'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    function showNewVolunteerNeedModal(){
      showModal({
        title:'新增志工需求',
        body:`
          <form id="newVolunteerNeedForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input class="form-control" id="volNeedTitle" required>
                <label for="volNeedTitle">標題 *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="date" class="form-control" id="volNeedDate" required>
                <label for="volNeedDate">日期 *</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input class="form-control" id="volNeedTime">
                <label for="volNeedTime">時間</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="number" class="form-control" id="volNeedCount" value="5" min="1">
                <label for="volNeedCount">需求人數 *</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="number" class="form-control" id="volNeedHours" value="2" min="1">
                <label for="volNeedHours">服務時數 *</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="volNeedDesc" style="height:120px;"></textarea>
                <label for="volNeedDesc">說明</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-success w-100" type="submit"><i class="bi bi-plus-circle me-1"></i>建立</button>
            </div>
          </form>`,
        onShown:()=>{
          document.getElementById('newVolunteerNeedForm').addEventListener('submit', async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              await callAPI('createVolunteerNeed',{
                lineId:userProfile.userId,
                title:document.getElementById('volNeedTitle').value,
                date:document.getElementById('volNeedDate').value,
                time:document.getElementById('volNeedTime').value,
                needCount:document.getElementById('volNeedCount').value,
                hours:document.getElementById('volNeedHours').value,
                description:document.getElementById('volNeedDesc').value
              });
              showNotification('志工需求建立','success');
              closeModal();
              await loadVolunteerData();
            }catch(err){
              showNotification('建立失敗：'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    function showReceiptTemplateModal(){
      showModal({
        title:'收據 / 模板設定',
        body:`
          <form id="receiptTplForm" class="row g-3">
            <div class="col-12">
              <div class="form-floating">
                <input class="form-control" id="receiptTemplateDocId" placeholder="Google 文件 ID">
                <label for="receiptTemplateDocId">收據模板文件 ID</label>
              </div>
              <div class="form-text">模板中可使用 {{RECEIPT_NUMBER}} {{DONOR_NAME}} {{DONATION_AMOUNT}} 等占位符。</div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <input class="form-control" id="expenseVoucherTemplateDocId" placeholder="Google 文件 ID">
                <label for="expenseVoucherTemplateDocId">支出憑證模板文件 ID</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="emailReplyTemplate" style="height:120px;" placeholder="Email 回覆尾段"></textarea>
                <label for="emailReplyTemplate">Email 回覆模板 (尾段)</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-primary w-100" type="submit"><i class="bi bi-save me-1"></i>儲存設定</button>
            </div>
          </form>`,
        onShown: async ()=>{
          try{
            const r=await callAPI('getSettings',{ lineId:userProfile.userId });
            document.getElementById('receiptTemplateDocId').value=r.data.receiptTemplateDocId||'';
            document.getElementById('expenseVoucherTemplateDocId').value=r.data.expenseVoucherTemplateDocId||'';
            document.getElementById('emailReplyTemplate').value=r.data.emailReplyTemplate||'';
          }catch{}
          document.getElementById('receiptTplForm').addEventListener('submit', async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              await callAPI('updateSettings',{
                lineId:userProfile.userId,
                receiptTemplateDocId:document.getElementById('receiptTemplateDocId').value.trim(),
                expenseVoucherTemplateDocId:document.getElementById('expenseVoucherTemplateDocId').value.trim(),
                emailReplyTemplate:document.getElementById('emailReplyTemplate').value
              });
              showNotification('設定已更新','success');
              closeModal();
            }catch(err){
              showNotification('更新失敗：'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    function showManualReceiptModal(){
      showModal({
        title:'手動開立收據',
        body:`
          <form id="manualReceiptForm" class="row g-3">
            <div class="col-12">
              <div class="form-floating">
                <input class="form-control" id="targetLineId" required>
                <label for="targetLineId">目標 LINE ID *</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <select class="form-select" id="manualReceiptType" required>
                  <option value="捐款">捐款</option>
                  <option value="活動">活動</option>
                  <option value="其他">其他</option>
                </select>
                <label for="manualReceiptType">類型 *</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="number" class="form-control" id="manualReceiptAmount" min="1" required>
                <label for="manualReceiptAmount">金額 *</label>
              </div>
            </div>
            <div class="col-md-4 d-flex align-items-center">
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="createDonation" checked>
                <label class="form-check-label" for="createDonation">建立捐款記錄</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-success w-100" type="submit"><i class="bi bi-plus-circle me-1"></i>開立收據</button>
            </div>
          </form>`,
        onShown:()=>{
          document.getElementById('manualReceiptForm').addEventListener('submit', async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              const res=await callAPI('createManualReceipt',{
                lineId:userProfile.userId,
                targetLineId:document.getElementById('targetLineId').value.trim(),
                type:document.getElementById('manualReceiptType').value,
                amount:document.getElementById('manualReceiptAmount').value,
                createDonation:document.getElementById('createDonation').checked
              });
              showNotification('收據建立成功','success');
              closeModal();
              await loadAdminData(true);
              if(res.data?.pdfUrl){
                if(confirm('收據已產生，是否查看 PDF？')) window.open(res.data.pdfUrl,'_blank');
              }
            }catch(err){
              showNotification('建立失敗：'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    function showSystemNotificationModal(){
      showModal({
        title:'發送系統通知（記錄）',
        body:`
          <form id="systemNotifyForm" class="row g-3">
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="systemNotifyMsg" style="height:140px;" required></textarea>
                <label for="systemNotifyMsg">通知內容 *</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-info w-100" type="submit"><i class="bi bi-megaphone me-1"></i>送出</button>
            </div>
          </form>`,
        onShown:()=>{
          document.getElementById('systemNotifyForm').addEventListener('submit', async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              await callAPI('sendSystemNotification',{ lineId:userProfile.userId, message:document.getElementById('systemNotifyMsg').value });
              showNotification('通知已記錄','success');
              closeModal();
            }catch(err){
              showNotification('失敗：'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    async function exportMembers(){
      if(!isAdmin) return;
      try{
        const r=await callAPI('exportMembers',{ lineId:userProfile.userId });
        showNotification('匯出完成','success');
        window.open(r.data.fileUrl,'_blank');
      }catch(err){
        showNotification('匯出失敗：'+err.message,'error');
      }
    }
    async function exportFinanceData(){
      if(!isAdmin) return;
      try{
        const r=await callAPI('exportFinanceData',{ lineId:userProfile.userId });
        showNotification('匯出完成','success');
        if(r.data.donationUrl) window.open(r.data.donationUrl,'_blank');
        if(r.data.expenseUrl) window.open(r.data.expenseUrl,'_blank');
      }catch(err){
        showNotification('匯出失敗：'+err.message,'error');
      }
    }
    async function backupSystem(){
      if(!isAdmin) return;
      if(!confirm('建立即時備份？')) return;
      try{
        const r=await callAPI('backupSystem',{ lineId:userProfile.userId });
        showNotification('備份完成：'+r.data.name,'success',5000);
      }catch(err){
        showNotification('備份失敗：'+err.message,'error');
      }
    }

    // ========== Modal 公用 ==========
    let currentModal=null;
    function showModal({ title, body, onShown }){
      const wrap=document.getElementById('modalContainer');
      wrap.innerHTML=`
        <div class="modal fade" id="globalModal">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">${title}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">${body}</div>
            </div>
          </div>
        </div>`;
      const modalEl=document.getElementById('globalModal');
      currentModal=new bootstrap.Modal(modalEl);
      modalEl.addEventListener('hidden.bs.modal',()=>{ wrap.innerHTML=''; });
      currentModal.show();
      if(typeof onShown==='function') setTimeout(onShown,20);
    }
    function closeModal(){
      if(currentModal){ currentModal.hide(); currentModal=null; }
    }

    // ========== 其它 ==========
    function showTab(id){
      const tabTrigger=document.querySelector(`.nav-link[data-bs-target="#${id}"]`);
      if(tabTrigger){
        new bootstrap.Tab(tabTrigger).show();
      }
    }

    async function refreshData(){
      showNotification('刷新中...','info',1200);
      await Promise.all([
        loadDashboard(),
        loadActivities(),
        loadMyRegistrations(),
        loadVolunteerData(),
        loadFinanceData(),
        loadFeedbackData(),
        loadAdminData(true)
      ]);
      showNotification('資料已更新','success');
    }

    // 初始載入其他區塊資料（活動等）
    document.addEventListener('DOMContentLoaded', ()=>{
      initializeLiff().then(async ()=>{
        // 等 LIFF 初始化完再做
        await loadActivities();
        await loadMyRegistrations();
        await loadVolunteerData();
        await loadFinanceData();
        await loadFeedbackData();
        if(isAdmin) loadAdminData();
      });
    });
  </script>
</body>
</html>
