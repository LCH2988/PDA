<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>病友會 LIFF 前端</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    --primary: #2563eb;
    --primary-hover: #1d4ed8;
    --primary-light: #eff6ff;
    --bg: #f8fafc;
    --card: #ffffff;
    --border: #e2e8f0;
    --danger: #dc2626;
    --success: #16a34a;
    --warning: #d97706;
    --info: #0ea5e9;
    --radius: 8px;
    --text: #1f2937;
    --text-light: #6b7280;
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
  }

  /* Header */
  header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
    color: #fff;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-lg);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  header h1 {
    font-size: 20px;
    margin: 0;
    font-weight: 600;
  }

  #userStatus {
    font-size: 14px;
    opacity: 0.95;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Main Layout */
  main {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Tabs */
  .tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 24px;
    background: var(--card);
    padding: 8px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  .tabs button {
    background: transparent;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    color: var(--text-light);
  }

  .tabs button:hover {
    background: var(--primary-light);
    color: var(--primary);
  }

  .tabs button.active {
    background: var(--primary);
    color: #fff;
    box-shadow: var(--shadow);
  }

  /* Panels */
  section.panel {
    display: none;
    animation: fadeIn 0.3s ease;
  }

  section.panel.active {
    display: block;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Cards */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
    transition: box-shadow 0.2s ease;
  }

  .card:hover {
    box-shadow: var(--shadow-lg);
  }

  /* Typography */
  h2 {
    margin: 0 0 16px;
    font-size: 20px;
    font-weight: 600;
    color: var(--text);
  }

  h3 {
    margin: 20px 0 12px;
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }

  h4 {
    margin: 12px 0 8px;
    font-size: 16px;
    font-weight: 600;
  }

  /* Form Elements */
  label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    margin-top: 12px;
    margin-bottom: 4px;
    color: var(--text);
  }

  input, select, textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: #fff;
    font-size: 14px;
    transition: all 0.2s ease;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  textarea {
    min-height: 100px;
    resize: vertical;
    font-family: inherit;
  }

  /* Layout */
  .row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
  }

  .col {
    min-width: 0;
  }

  /* Buttons */
  button, .btn {
    background: var(--primary);
    color: #fff;
    border: none;
    cursor: pointer;
    padding: 10px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  button:hover, .btn:hover {
    background: var(--primary-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow);
  }

  button:active, .btn:active {
    transform: translateY(0);
  }

  button.outline {
    background: transparent;
    color: var(--primary);
    border: 1px solid var(--primary);
  }

  button.outline:hover {
    background: var(--primary-light);
  }

  button.small {
    padding: 6px 12px;
    font-size: 12px;
  }

  button.danger {
    background: var(--danger);
  }

  button.danger:hover {
    background: #b91c1c;
  }

  button.success {
    background: var(--success);
  }

  button.success:hover {
    background: #15803d;
  }

  button.warning {
    background: var(--warning);
  }

  button.warning:hover {
    background: #c2410c;
  }

  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin-top: 12px;
    background: var(--card);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  th, td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
  }

  th {
    background: #f8fafc;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
  }

  tr:hover {
    background: #f9fafb;
  }

  tr:last-child td {
    border-bottom: none;
  }

  /* Utilities */
  .flex {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .space-between {
    justify-content: space-between;
  }

  .text-center {
    text-align: center;
  }

  .text-right {
    text-align: right;
  }

  .muted {
    color: var(--text-light);
    font-size: 13px;
  }

  .hidden {
    display: none !important;
  }

  .scroll-x {
    overflow-x: auto;
  }

  /* Pills & Badges */
  .pill {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    background: #e2e8f0;
    color: var(--text);
    margin: 2px;
  }

  .pill.ok {
    background: #dcfce7;
    color: #166534;
  }

  .pill.warning {
    background: #fef3c7;
    color: #92400e;
  }

  .pill.error {
    background: #fee2e2;
    color: #991b1b;
  }

  .pill.info {
    background: #e0f2fe;
    color: #0c4a6e;
  }

  .badge-admin {
    background: #1e3a8a;
    color: #fff;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
  }

  /* Alerts */
  .alert {
    background: var(--card);
    border-left: 4px solid var(--info);
    padding: 12px 16px;
    border-radius: 4px;
    margin: 12px 0;
    font-size: 14px;
    line-height: 1.5;
  }

  .alert.warning {
    border-color: var(--warning);
    background: #fffbeb;
  }

  .alert.danger {
    border-color: var(--danger);
    background: #fef2f2;
  }

  .alert.success {
    border-color: var(--success);
    background: #f0fdf4;
  }

  /* Toast */
  #toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #111827;
    color: #fff;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    box-shadow: var(--shadow-lg);
    opacity: 0;
    pointer-events: none;
    transform: translateY(10px);
    transition: all 0.3s ease;
    max-width: 350px;
    line-height: 1.5;
    white-space: pre-wrap;
    z-index: 1000;
  }

  #toast.show {
    opacity: 1;
    transform: translateY(0);
  }

  /* Vote Progress Bar */
  .vote-option-bar {
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
    height: 20px;
    margin: 6px 0 12px;
  }

  .vote-option-bar span {
    position: absolute;
    left: 8px;
    top: 0;
    bottom: 0;
    font-size: 11px;
    font-weight: 500;
    display: flex;
    align-items: center;
    color: #fff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    z-index: 2;
  }

  .vote-fill {
    background: linear-gradient(90deg, var(--primary), var(--primary-hover));
    height: 100%;
    transition: width 0.5s ease;
  }

  /* Loading Skeleton */
  .skeleton {
    animation: pulse 1.5s infinite;
    background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
    background-size: 200% 100%;
    border-radius: 4px;
  }

  @keyframes pulse {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* Stats Cards */
  .stats-card {
    background: var(--card);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    text-align: center;
    border: 1px solid var(--border);
  }

  .stats-number {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
    margin: 8px 0 4px;
  }

  .stats-label {
    color: var(--text-light);
    font-size: 13px;
    font-weight: 500;
  }

  /* Divider */
  .divider {
    height: 1px;
    background: var(--border);
    margin: 24px 0;
  }

  /* Links */
  .inline-link {
    color: var(--primary);
    text-decoration: none;
    font-size: 13px;
    font-weight: 500;
  }

  .inline-link:hover {
    text-decoration: underline;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    main {
      padding: 16px;
    }

    .card {
      padding: 16px;
    }

    .row {
      grid-template-columns: 1fr;
    }

    .tabs {
      padding: 6px;
    }

    .tabs button {
      padding: 8px 12px;
      font-size: 13px;
    }

    header {
      padding: 12px 16px;
    }

    header h1 {
      font-size: 18px;
    }

    #userStatus {
      font-size: 12px;
    }

    table {
      font-size: 12px;
    }

    th, td {
      padding: 8px 12px;
    }
  }

  /* Loading States */
  .loading {
    opacity: 0.6;
    pointer-events: none;
  }

  .loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid var(--primary);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <h1>🏥 病友會互動平台</h1>
  <div id="userStatus">未登入</div>
</header>

<main>
  <div class="tabs" id="tabBar">
    <button data-tab="auth" class="active">👤 登入 / 會員</button>
    <button data-tab="activities">📅 活動</button>
    <button data-tab="donation">💰 捐款</button>
    <button data-tab="receipts">📄 收據</button>
    <button data-tab="volunteer">🤝 志工</button>
    <button data-tab="voting">🗳️ 投票</button>
    <button data-tab="dashboard">📊 總覽</button>
    <button data-tab="admin" id="adminTab" class="hidden">⚙️ 管理</button>
  </div>

  <!-- Auth / Profile -->
  <section class="panel active" id="panel-auth">
    <div class="card">
      <h2>🔐 登入方式</h2>
      <div class="alert">
        <strong>登入說明：</strong><br>
        1. 若於 LINE LIFF 中開啟，可直接使用 LINE 身分<br>
        2. 若為一般瀏覽器，您可使用「電話會員」註冊 / 登入<br>
        3. 登入後請補充會員資料，以利活動通知與收據寄送
      </div>
      
      <div class="row">
        <div class="col">
          <h3>📱 LINE 身分</h3>
          <p id="lineProfileInfo" class="muted">尚未啟動 LIFF</p>
          <div class="flex">
            <button id="btnInitLiff">🚀 啟動 LIFF</button>
            <button id="btnLineLogin" class="outline">🔄 重新登入</button>
            <button id="btnLineLogout" class="danger">🚪 登出 LINE</button>
          </div>
        </div>
        
        <div class="col">
          <h3>📝 電話會員註冊</h3>
          <label>姓名
            <input id="regRealName" placeholder="請輸入真實姓名" />
          </label>
          <label>手機號碼
            <input id="regPhone" placeholder="09xxxxxxxx" maxlength="10" />
          </label>
          <label>密碼
            <input id="regPwd" type="password" placeholder="至少6位數" />
          </label>
          <button id="btnPhoneRegister" class="success">✅ 電話註冊並登入</button>
        </div>
        
        <div class="col">
          <h3>🔑 電話會員登入</h3>
          <label>手機號碼（或留空用姓名）
            <input id="loginPhone" placeholder="09xxxxxxxx" />
          </label>
          <label>姓名（選用）
            <input id="loginRealName" placeholder="若無手機請填姓名" />
          </label>
          <label>密碼
            <input id="loginPwd" type="password" placeholder="請輸入密碼" />
          </label>
          <button id="btnPhoneLogin" class="success">🔓 電話登入</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>👤 會員資料</h2>
      <div class="row">
        <div class="col">
          <label>Line ID（唯讀）
            <input id="profileLineId" readonly />
          </label>
        </div>
        <div class="col">
          <label>暱稱
            <input id="profileLineName" placeholder="顯示用暱稱" />
          </label>
        </div>
        <div class="col">
          <label>真實姓名 *
            <input id="profileRealName" placeholder="收據寄送用" />
          </label>
        </div>
        <div class="col">
          <label>會員類型
            <select id="profileMemberType">
              <option value="病友">🏥 病友</option>
              <option value="家屬">👨‍👩‍👧‍👦 家屬</option>
              <option value="志工">🤝 志工</option>
              <option value="贊助者">💝 贊助者</option>
            </select>
          </label>
        </div>
      </div>
      
      <div class="row">
        <div class="col">
          <label>手機號碼 *
            <input id="profilePhone" placeholder="09xxxxxxxx" />
          </label>
        </div>
        <div class="col">
          <label>Email *
            <input id="profileEmail" type="email" placeholder="收據寄送用" />
          </label>
        </div>
        <div class="col">
          <label>生日
            <input id="profileBirthday" type="date" />
          </label>
        </div>
        <div class="col">
          <label>地址
            <input id="profileAddress" placeholder="收據郵寄地址" />
          </label>
        </div>
      </div>
      
      <label>備註
        <textarea id="profileNotes" placeholder="其他想告訴我們的資訊..."></textarea>
      </label>
      
      <div class="flex space-between" style="margin-top: 16px;">
        <button id="btnLoadProfile" class="outline">🔄 重新載入</button>
        <button id="btnSaveProfile" class="success">💾 儲存資料</button>
      </div>
    </div>
  </section>

  <!-- Activities -->
  <section class="panel" id="panel-activities">
    <div class="card">
      <div class="flex space-between">
        <h2>📅 活動列表</h2>
        <button id="btnRefreshActivities" class="outline small">🔄 重新整理</button>
      </div>
      <div class="muted" style="margin-bottom: 16px;">顯示所有開放報名的活動</div>
      <div id="activitiesContainer" class="scroll-x"></div>
    </div>
  </section>

  <!-- Donation -->
  <section class="panel" id="panel-donation">
    <div class="card">
      <h2>💰 愛心捐款</h2>
      <div class="row">
        <div class="col">
          <label>捐款分類
            <select id="donCategory">
              <option>一般捐款</option>
            </select>
          </label>
        </div>
        <div class="col">
          <label>捐款金額 *
            <input id="donAmount" type="number" min="1" placeholder="請輸入金額" />
          </label>
        </div>
        <div class="col">
          <label>需要收據？
            <select id="donNeedReceipt">
              <option value="yes">✅ 是，需要收據</option>
              <option value="no">❌ 否，不需要</option>
            </select>
          </label>
        </div>
      </div>
      
      <label>備註說明
        <textarea id="donDesc" placeholder="捐款用途說明或感謝留言..."></textarea>
      </label>
      
      <div style="margin-top: 16px;">
        <button id="btnCreateDonation" class="success">💝 送出捐款</button>
      </div>
      
      <div id="donationResult" class="muted" style="margin-top: 16px;"></div>
    </div>

    <div class="card">
      <div class="flex space-between">
        <h3>📊 我的捐款統計</h3>
        <button id="btnLoadFinance" class="outline small">📈 載入統計</button>
      </div>
      
      <div id="financeStats" class="row" style="margin-top: 12px;"></div>
      <div id="myDonationsTable" class="scroll-x" style="margin-top: 16px;"></div>
    </div>
  </section>

  <!-- Receipts -->
  <section class="panel" id="panel-receipts">
    <div class="card">
      <div class="flex space-between">
        <h2>📄 我的收據</h2>
        <button id="btnLoadReceipts" class="outline small">📋 載入收據</button>
      </div>
      <div id="myReceiptsContainer" style="margin-top: 12px;"></div>
    </div>
    
    <div class="card hidden" id="adminReceiptsCard">
      <h2>🔧 收據管理（管理員）</h2>
      <div class="row">
        <div class="col">
          <label>Line ID 篩選
            <input id="filterReceiptsLineId" placeholder="輸入 Line ID" />
          </label>
        </div>
        <div class="col">
          <label>收據號碼
            <input id="filterReceiptNumber" placeholder="收據編號" />
          </label>
        </div>
        <div class="col">
          <label>收據類型
            <select id="filterReceiptType">
              <option value="">全部類型</option>
              <option>捐款</option>
              <option>手動</option>
            </select>
          </label>
        </div>
        <div class="col">
          <label>開始日期
            <input id="filterReceiptFrom" type="date" />
          </label>
        </div>
        <div class="col">
          <label>結束日期
            <input id="filterReceiptTo" type="date" />
          </label>
        </div>
      </div>
      
      <div class="flex" style="margin-top: 12px;">
        <button id="btnSearchReceipts">🔍 查詢收據</button>
        <button id="btnCreateManualReceipt" class="outline warning">➕ 手動開立</button>
      </div>
      
      <div id="allReceiptsContainer" class="scroll-x" style="margin-top: 16px;"></div>
    </div>
  </section>

  <!-- Volunteer -->
  <section class="panel" id="panel-volunteer">
    <div class="card">
      <div class="flex space-between">
        <h2>🤝 志工服務</h2>
        <button id="btnLoadVolunteer" class="outline small">🔄 載入資料</button>
      </div>
      
      <div id="volStats" class="row" style="margin-top: 16px;"></div>
      
      <h3 style="margin-top: 24px;">📋 志工需求</h3>
      <div id="volNeedsContainer" class="scroll-x"></div>
      
      <h3 style="margin-top: 24px;">📝 我的志工紀錄</h3>
      <div id="volRecordsContainer" class="scroll-x"></div>
    </div>
  </section>

  <!-- Voting -->
  <section class="panel" id="panel-voting">
    <div class="card">
      <div class="flex space-between">
        <h2>🗳️ 投票專區</h2>
        <div class="flex">
          <button id="btnLoadVotingTopics" class="outline small">📋 載入主題</button>
          <button id="btnLoadVotingResults" class="outline small">📊 統計結果</button>
        </div>
      </div>
      
      <div id="votingTopicsContainer" style="margin-top: 16px;"></div>
      
      <div class="divider"></div>
      
      <h3>📈 投票統計結果</h3>
      <div id="votingResultsContainer"></div>
    </div>
    
    <div class="card hidden" id="adminVotingCard">
      <h3>➕ 新增投票主題（管理員）</h3>
      <label>投票標題
        <input id="newVoteTitle" placeholder="請輸入投票主題" />
      </label>
      <label>投票選項（每行一個選項）
        <textarea id="newVoteOptions" placeholder="選項A&#10;選項B&#10;選項C"></textarea>
      </label>
      <button id="btnCreateVotingTopic" class="success">🗳️ 建立投票主題</button>
    </div>
  </section>

  <!-- Dashboard -->
  <section class="panel" id="panel-dashboard">
    <div class="card">
      <div class="flex space-between">
        <h2>📊 個人總覽</h2>
        <button id="btnLoadDashboard" class="outline small">🔄 重新整理</button>
      </div>
      <div id="dashboardContent" style="margin-top: 16px;"></div>
    </div>
  </section>

  <!-- Admin -->
  <section class="panel" id="panel-admin">
    <div class="card">
      <h2>⚙️ 系統管理</h2>
      <div class="row">
        <div class="col">
          <button id="btnAdminExportMembers" class="outline">👥 匯出會員資料</button>
        </div>
        <div class="col">
          <button id="btnAdminExportFinance" class="outline">💰 匯出財務資料</button>
        </div>
        <div class="col">
          <button id="btnAdminBackup" class="outline warning">💾 建立系統備份</button>
        </div>
      </div>
      <div id="adminActionResult" class="muted" style="margin-top: 16px;"></div>
    </div>
  </section>

</main>

<div id="toast"></div>

<script>
  /**********************
   * 基本設定 (請自行填入)
   **********************/
  const APP_CONFIG = {
    API_URL: 'https://script.google.com/macros/s/AKfycbxRegzWvT2g1_fCDQjFsriTgej941aLNJ2B8xZbeqs_fH8SbeAihDVYEA92-AkRmRE/exec',
    API_KEY: 'AAbb8520258185202581',
    LIFF_ID: '1656516134-VaGgmaPm'
  };

  /**********************
   * 全域狀態
   **********************/
  const state = {
    lineId: null,
    lineName: null,
    isAdmin: false,
    sessionToken: null,
    profileLoaded: false,
    categories: { incomeCategories: [], expenseCategories: [] },
    cachedActivities: [],
    votingTopics: []
  };

  const PUBLIC_ACTIONS = new Set([
    'registerUser', 'phoneRegister', 'phoneLogin',
    'getPublicCategories', 'getActivities', 'getVotingResults'
  ]);

  /**********************
   * UI 輔助函數
   **********************/
  function toast(msg, timeout = 3500) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(el._t);
    el._t = setTimeout(() => el.classList.remove('show'), timeout);
  }

  function setUserStatus() {
    const el = document.getElementById('userStatus');
    if (!state.lineId && !state.sessionToken) {
      el.innerHTML = '未登入';
    } else {
      el.innerHTML = `
        <span>${state.lineName || '（未有暱稱）'}</span>
        <span class="muted" style="margin-left: 8px;">${state.lineId || '無ID'}</span>
        ${state.sessionToken ? '<span class="pill ok">電話登入</span>' : ''}
        ${state.isAdmin ? '<span class="badge-admin">Admin</span>' : ''}
      `;
    }
    
    // 顯示/隱藏管理員功能
    document.getElementById('adminTab').classList.toggle('hidden', !state.isAdmin);
    document.getElementById('adminReceiptsCard').classList.toggle('hidden', !state.isAdmin);
    document.getElementById('adminVotingCard').classList.toggle('hidden', !state.isAdmin);
  }

  function switchTab(name) {
    document.querySelectorAll('.tabs button').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === name);
    });
    document.querySelectorAll('section.panel').forEach(p => {
      p.classList.toggle('active', p.id === 'panel-' + name);
    });
  }

  // Tab 切換事件
  document.getElementById('tabBar').addEventListener('click', e => {
    if (e.target.tagName === 'BUTTON') {
      switchTab(e.target.dataset.tab);
    }
  });

  /**********************
   * API 呼叫
   **********************/
  async function callAPI(action, payload = {}) {
    const body = Object.assign({}, payload, {
      apiKey: APP_CONFIG.API_KEY,
      action
    });

    // 附加身份驗證
    if (state.sessionToken) body.sessionToken = state.sessionToken;
    if (state.lineId) body.lineId = state.lineId;

    // 安全性檢查
    if (!PUBLIC_ACTIONS.has(action) && !body.sessionToken && !body.lineId) {
      throw new Error('尚未登入，請先完成登入程序');
    }

    try {
      const res = await fetch(APP_CONFIG.API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      
      const json = await res.json();
      if (!json.success) throw new Error(json.message || 'API 處理錯誤');
      
      return json;
    } catch (error) {
      console.error('API 呼叫失敗:', error);
      throw error;
    }
  }

  /**********************
   * LIFF 相關功能
   **********************/
  async function initLIFF() {
    try {
      await liff.init({ liffId: APP_CONFIG.LIFF_ID });
      
      if (!liff.isLoggedIn()) {
        document.getElementById('lineProfileInfo').innerHTML = '
          <div class="alert warning">
            尚未登入 LINE，請點擊「重新登入」按鈕進行登入
          </div>';
        return;
      }

      const profile = await liff.getProfile();
      state.lineId = profile.userId;
      state.lineName = profile.displayName;
      
      document.getElementById('lineProfileInfo').innerHTML = `
        <div class="alert success">
          ✅ 已成功登入 LINE<br>
          <strong>暱稱：</strong>${profile.displayName}<br>
          <strong>用戶ID：</strong><code>${profile.userId}</code>
        </div>
      `;
      
      setUserStatus();
      await ensureLineUserRegistered();
      
    } catch (error) {
      console.error('LIFF 初始化失敗:', error);
      document.getElementById('lineProfileInfo').innerHTML = `
        <div class="alert danger">
          ❌ LIFF 初始化失敗：${error.message}
        </div>`;
    }
  }

  // LIFF 按鈕事件
  document.getElementById('btnInitLiff').addEventListener('click', initLIFF);
  
  document.getElementById('btnLineLogin').addEventListener('click', () => {
    if (!liff.isLoggedIn()) {
      liff.login();
    } else {
      toast('已登入 LINE，重新載入頁面以重新初始化');
      setTimeout(() => location.reload(), 1000);
    }
  });
  
  document.getElementById('btnLineLogout').addEventListener('click', () => {
    if (liff.isLoggedIn()) {
      if (confirm('確定要登出 LINE 嗎？')) {
        liff.logout();
        location.reload();
      }
    } else {
      toast('目前未登入 LINE');
    }
  });

  async function ensureLineUserRegistered() {
    if (!state.lineId) return;
    
    try {
      const infoRes = await callAPI('getUserInfo', { lineId: state.lineId });
      state.isAdmin = !!infoRes.data.isAdmin;
      fillProfileForm(infoRes.data);
      toast('✅ 已載入 LINE 使用者資料');
      
    } catch (error) {
      if (/未註冊/.test(error.message)) {
        try {
          await callAPI('registerUser', {
            lineId: state.lineId,
            lineName: state.lineName,
            realName: state.lineName
          });
          
          toast('✅ 已自動完成 LINE 使用者註冊');
          
          const infoRes2 = await callAPI('getUserInfo', { lineId: state.lineId });
          state.isAdmin = !!infoRes2.data.isAdmin;
          fillProfileForm(infoRes2.data);
          
        } catch (regError) {
          console.error('LINE 註冊失敗:', regError);
          toast('❌ LINE 使用者註冊失敗：' + regError.message);
        }
      } else {
        console.error('取得使用者資料失敗:', error);
        toast('⚠️ 取得 LINE 使用者資料失敗：' + error.message);
      }
    } finally {
      setUserStatus();
      await loadCategories();
    }
  }

  /**********************
   * 電話註冊/登入
   **********************/
  document.getElementById('btnPhoneRegister').addEventListener('click', async () => {
    try {
      const realName = document.getElementById('regRealName').value.trim();
      const phone = document.getElementById('regPhone').value.trim();
      const pwd = document.getElementById('regPwd').value;
      
      if (!realName || !phone || !pwd) {
        return toast('⚠️ 請填寫完整的註冊資訊');
      }
      
      if (!/^09\d{8}$/.test(phone)) {
        return toast('⚠️ 請輸入正確的手機號碼格式（09xxxxxxxx）');
      }
      
      if (pwd.length < 6) {
        return toast('⚠️ 密碼長度至少需要6位數');
      }
      
      const result = await callAPI('phoneRegister', { 
        realName, 
        phone, 
        password: pwd 
      });
      
      state.sessionToken = result.data.sessionToken;
      state.lineId = 'TEL_' + phone;
      state.lineName = realName;
      state.isAdmin = false;
      
      toast('✅ 電話註冊成功，歡迎加入病友會！');
      setUserStatus();
      await loadCategories();
      
    } catch (error) {
      toast('❌ 電話註冊失敗：' + error.message);
    }
  });

  document.getElementById('btnPhoneLogin').addEventListener('click', async () => {
    try {
      const phone = document.getElementById('loginPhone').value.trim();
      const realName = document.getElementById('loginRealName').value.trim();
      const pwd = document.getElementById('loginPwd').value;
      
      if (!pwd || (!phone && !realName)) {
        return toast('⚠️ 請輸入手機號碼或姓名，以及密碼');
      }
      
      const result = await callAPI('phoneLogin', { 
        phone, 
        realName, 
        password: pwd 
      });
      
      state.sessionToken = result.data.sessionToken;
      state.lineId = phone ? ('TEL_' + phone) : state.lineId;
      state.lineName = realName || state.lineName;
      
      toast('✅ 電話登入成功！');
      
      // 取得使用者資訊以判斷管理員權限
      try {
        const info = await callAPI('getUserInfo', { lineId: state.lineId });
        state.isAdmin = !!info.data.isAdmin;
        fillProfileForm(info.data);
      } catch (e) {
        console.warn('取得使用者資訊失敗:', e);
      }
      
      setUserStatus();
      await loadCategories();
      
    } catch (error) {
      toast('❌ 電話登入失敗：' + error.message);
    }
  });

  /**********************
   * 會員資料管理
   **********************/
  function fillProfileForm(data) {
    document.getElementById('profileLineId').value = data.lineId || '';
    document.getElementById('profileLineName').value = data.lineName || '';
    document.getElementById('profileRealName').value = data.realName || '';
    document.getElementById('profileMemberType').value = data.memberType || '病友';
    document.getElementById('profilePhone').value = data.phone || '';
    document.getElementById('profileEmail').value = data.email || '';
    
    if (data.birthday) {
      const bStr = formatDateInput(data.birthday);
      if (bStr) document.getElementById('profileBirthday').value = bStr;
    }
    
    document.getElementById('profileAddress').value = data.address || '';
    document.getElementById('profileNotes').value = data.notes || '';
    state.profileLoaded = true;
  }

  function formatDateInput(val) {
    try {
      if (!val) return '';
      if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
      
      const d = new Date(val);
      if (!isNaN(d.getTime())) {
        return d.toISOString().slice(0, 10);
      }
      return '';
    } catch (_) { 
      return ''; 
    }
  }

  document.getElementById('btnLoadProfile').addEventListener('click', async () => {
    if (!state.lineId) return toast('⚠️ 請先完成登入');
    
    try {
      const result = await callAPI('getUserInfo', { lineId: state.lineId });
      state.isAdmin = !!result.data.isAdmin;
      fillProfileForm(result.data);
      setUserStatus();
      toast('✅ 會員資料已重新載入');
    } catch (error) {
      toast('❌ 載入會員資料失敗：' + error.message);
    }
  });

  document.getElementById('btnSaveProfile').addEventListener('click', async () => {
    if (!state.lineId) return toast('⚠️ 請先完成登入');
    
    try {
      const payload = {
        lineId: state.lineId,
        lineName: document.getElementById('profileLineName').value.trim(),
        realName: document.getElementById('profileRealName').value.trim(),
        memberType: document.getElementById('profileMemberType').value,
        phone: document.getElementById('profilePhone').value.trim(),
        email: document.getElementById('profileEmail').value.trim(),
        birthday: document.getElementById('profileBirthday').value,
        address: document.getElementById('profileAddress').value.trim(),
        notes: document.getElementById('profileNotes').value
      };
      
      // 基本驗證
      if (!payload.realName) {
        return toast('⚠️ 請填寫真實姓名');
      }
      
      if (!payload.phone || !/^09\d{8}$/.test(payload.phone)) {
        return toast('⚠️ 請填寫正確的手機號碼');
      }
      
      if (!payload.email || !/\S+@\S+\.\S+/.test(payload.email)) {
        return toast('⚠️ 請填寫正確的Email地址');
      }
      
      await callAPI('updateProfile', payload);
      toast('✅ 會員資料更新成功！');
      
      // 重新取得資料以更新管理員標記
      const info = await callAPI('getUserInfo', { lineId: state.lineId });
      state.isAdmin = !!info.data.isAdmin;
      setUserStatus();
      
    } catch (error) {
      toast('❌ 會員資料更新失敗：' + error.message);
    }
  });

  /**********************
   * 分類資料載入
   **********************/
  async function loadCategories() {
    try {
      const result = await callAPI('getPublicCategories', {});
      state.categories = result.data;
      
      const donSel = document.getElementById('donCategory');
      donSel.innerHTML = state.categories.incomeCategories
        .map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`)
        .join('');
        
    } catch (error) {
      console.warn('載入分類資料失敗:', error);
    }
  }

  /**********************
   * 活動管理
   **********************/
  document.getElementById('btnRefreshActivities').addEventListener('click', loadActivities);

  async function loadActivities() {
    try {
      const result = await callAPI('getActivities', {});
      state.cachedActivities = result.data || [];
      renderActivities();
      toast('✅ 活動列表已更新');
    } catch (error) {
      toast('❌ 載入活動失敗：' + error.message);
    }
  }

  function renderActivities() {
    const wrap = document.getElementById('activitiesContainer');
    
    if (!state.cachedActivities.length) {
      wrap.innerHTML = '<div class="alert">📅 目前沒有開放報名的活動</div>';
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>📋 活動標題</th>
            <th>📅 活動日期</th>
            <th>📍 活動地點</th>
            <th>👥 報名人數</th>
            <th>📊 狀態</th>
            <th>⚡ 操作</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    state.cachedActivities.forEach(activity => {
      const isOpen = activity.status === '開放報名';
      const canRegister = isOpen && state.lineId;
      
      html += `
        <tr>
          <td><strong>${escapeHtml(activity.title || '')}</strong></td>
          <td>${escapeHtml(activity.date || '')}</td>
          <td>${escapeHtml(activity.location || '')}</td>
          <td>${activity.currentCount || 0}/${activity.maxParticipants || 0}</td>
          <td>
            <span class="pill ${isOpen ? 'ok' : 'warning'}">
              ${activity.status || ''}
            </span>
          </td>
          <td>
            ${canRegister ? 
              `<button class="small success" data-act-register="${activity.id}">
                ✅ 立即報名
              </button>` : 
              (state.lineId ? '<span class="muted">已截止</span>' : '<span class="muted">需登入</span>')
            }
          </td>
        </tr>
      `;
    });
    
    html += '</tbody></table>';
    wrap.innerHTML = html;

    // 綁定報名事件
    wrap.querySelectorAll('[data-act-register]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const activityId = btn.getAttribute('data-act-register');
        const activity = state.cachedActivities.find(a => a.id == activityId);
        
        if (!confirm(`確定要報名「${activity?.title || '此活動'}」嗎？`)) return;
        
        try {
          await callAPI('registerActivity', { activityId });
          toast('🎉 活動報名成功！');
          loadActivities(); // 重新載入以更新人數
        } catch (error) {
          toast('❌ 活動報名失敗：' + error.message);
        }
      });
    });
  }

  /**********************
   * 捐款功能
   **********************/
  document.getElementById('btnCreateDonation').addEventListener('click', async () => {
    if (!state.lineId) return toast('⚠️ 請先完成登入');
    
    const amount = Number(document.getElementById('donAmount').value);
    const category = document.getElementById('donCategory').value;
    const desc = document.getElementById('donDesc').value;
    const needReceipt = document.getElementById('donNeedReceipt').value === 'yes';
    
    if (!(amount > 0)) return toast('⚠️ 捐款金額需大於 0');
    if (amount > 1000000) return toast('⚠️ 單筆捐款金額不能超過 100 萬');
    
    try {
      const result = await callAPI('createDonation', {
        amount,
        category,
        description: desc,
        needReceipt
      });
      
      document.getElementById('donationResult').innerHTML = `
        <div class="alert success">
          🎉 捐款成功！感謝您的愛心支持<br>
          <strong>捐款編號：</strong>${result.data.id || ''}<br>
          ${result.data.receiptNumber ? 
            `<strong>收據號碼：</strong>${result.data.receiptNumber}<br>` : ''
          }
          ${result.data.pdfUrl ? 
            `<a href="${result.data.pdfUrl}" target="_blank" class="inline-link">📄 下載收據PDF</a>` : ''
          }
        </div>
      `;
      
      toast('💝 捐款成功，感謝您的愛心！');
      
      // 清空表單
      document.getElementById('donAmount').value = '';
      document.getElementById('donDesc').value = '';
      
      // 重新載入財務統計
      loadFinance();
      
    } catch (error) {
      toast('❌ 捐款處理失敗：' + error.message);
    }
  });

  document.getElementById('btnLoadFinance').addEventListener('click', loadFinance);

  async function loadFinance() {
    if (!state.lineId) return toast('⚠️ 請先完成登入');
    
    try {
      const result = await callAPI('getFinanceData', {});
      const stats = result.data.stats;
      
      // 渲染統計卡片
      const statsWrap = document.getElementById('financeStats');
      statsWrap.innerHTML = `
        <div class="col">
          <div class="stats-card">
            <div class="stats-label">💰 總捐款金額</div>
            <div class="stats-number">$${stats.totalDonation.toLocaleString()}</div>
          </div>
        </div>
        <div class="col">
          <div class="stats-card">
            <div class="stats-label">📊 捐款筆數</div>
            <div class="stats-number">${stats.donationCount}</div>
          </div>
        </div>
        <div class="col">
          <div class="stats-card">
            <div class="stats-label">⏳ 待核支出</div>
            <div class="stats-number">$${stats.pendingExpenses.toLocaleString()}</div>
          </div>
        </div>
      `;

      // 渲染捐款明細表
      const tableWrap = document.getElementById('myDonationsTable');
      if (result.data.donations?.length) {
        let html = `
          <table>
            <thead>
              <tr>
                <th>📅 捐款時間</th>
                <th>📂 捐款分類</th>
                <th>💰 金額</th>
                <th>📄 收據號碼</th>
                <th>📝 備註</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        result.data.donations.forEach(donation => {
          html += `
            <tr>
              <td>${formatDateTime(donation.createdAt)}</td>
              <td>${escapeHtml(donation.category || '')}</td>
              <td class="text-right"><strong>$${donation.amount.toLocaleString()}</strong></td>
              <td>${donation.receiptNumber || '<span class="muted">無</span>'}</td>
              <td class="muted">${escapeHtml(donation.description || '')}</td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        tableWrap.innerHTML = html;
      } else {
        tableWrap.innerHTML = '<div class="alert">📋 尚無捐款紀錄</div>';
      }
      
      toast('✅ 財務統計已更新');
      
    } catch (error) {
      toast('❌ 載入財務統計失敗：' + error.message);
    }
  }

  /**********************
   * 收據管理
   **********************/
  document.getElementById('btnLoadReceipts').addEventListener('click', loadMyReceipts);

  async function loadMyReceipts() {
    if (!state.lineId) return toast('⚠️ 請先完成登入');
    
    try {
      const result = await callAPI('getMyReceipts', {});
      const receipts = result.data || [];
      const wrap = document.getElementById('myReceiptsContainer');
      
      if (!receipts.length) {
        wrap.innerHTML = '<div class="alert">📄 尚無收據記錄</div>';
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>📅 開立日期</th>
              <th>📄 收據號碼</th>
              <th>📂 類型</th>
              <th>💰 金額</th>
              <th>📎 PDF檔案</th>
              <th>📧 Email寄送</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      receipts.forEach(receipt => {
        html += `
          <tr>
            <td>${formatDate(receipt.issueDate)}</td>
            <td><strong>${receipt.receiptNumber}</strong></td>
            <td>${escapeHtml(receipt.type || '')}</td>
            <td class="text-right">$${receipt.amount.toLocaleString()}</td>
            <td>
              ${receipt.pdfUrl ? 
                `<a href="${receipt.pdfUrl}" target="_blank" class="inline-link">📎 開啟PDF</a>` : 
                '<span class="muted">無檔案</span>'
              }
            </td>
            <td>
              ${receipt.emailSent ? 
                '<span class="pill ok">✅ 已寄送</span>' : 
                '<span class="pill warning">⏳ 未寄送</span>'
              }
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      wrap.innerHTML = html;
      
      toast('✅ 收據列表已更新');
      
    } catch (error) {
      toast('❌ 載入收據失敗：' + error.message);
    }
  }

  // 管理員收據查詢
  document.getElementById('btnSearchReceipts').addEventListener('click', async () => {
    if (!state.isAdmin) return toast('⚠️ 需要管理員權限');
    
    try {
      const params = {
        lineId: state.lineId,
        lineIdFilter: document.getElementById('filterReceiptsLineId').value.trim(),
        receiptNumber: document.getElementById('filterReceiptNumber').value.trim(),
        type: document.getElementById('filterReceiptType').value,
        dateFrom: document.getElementById('filterReceiptFrom').value,
        dateTo: document.getElementById('filterReceiptTo').value
      };
      
      const result = await callAPI('getAllReceipts', params);
      renderAdminReceipts(result.data.receipts || []);
      toast('✅ 收據查詢完成');
      
    } catch (error) {
      toast('❌ 收據查詢失敗：' + error.message);
    }
  });

  document.getElementById('btnCreateManualReceipt').addEventListener('click', async () => {
    if (!state.isAdmin) return toast('⚠️ 需要管理員權限');
    
    const targetLineId = prompt('請輸入目標使用者的 Line ID (或 TEL_xxx):');
    if (!targetLineId) return;
    
    const type = prompt('請輸入收據類型:', '捐款') || '捐款';
    const amountStr = prompt('請輸入金額:', '1000');
    const amount = parseInt(amountStr, 10);
    
    if (!(amount > 0)) return toast('⚠️ 金額需大於 0');
    
    try {
      const result = await callAPI('createManualReceipt', {
        targetLineId,
        type,
        amount,
        createDonation: type === '捐款'
      });
      
      toast('✅ 手動收據開立成功：' + result.data.receiptNumber);
      
      // 重新查詢以更新列表
      document.getElementById('btnSearchReceipts').click();
      
    } catch (error) {
      toast('❌ 手動收據開立失敗：' + error.message);
    }
  });

  function renderAdminReceipts(receipts) {
    const wrap = document.getElementById('allReceiptsContainer');
    
    if (!receipts.length) {
      wrap.innerHTML = '<div class="alert">📄 查無收據資料</div>';
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>📅 開立日期</th>
            <th>📄 收據號碼</th>
            <th>👤 Line ID</th>
            <th>📂 類型</th>
            <th>💰 金額</th>
            <th>📎 PDF</th>
            <th>📧 寄送狀態</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    receipts.forEach(receipt => {
      html += `
        <tr>
          <td>${formatDate(receipt.issueDate)}</td>
          <td><strong>${receipt.receiptNumber}</strong></td>
          <td><code>${escapeHtml(receipt.lineId || '')}</code></td>
          <td>${escapeHtml(receipt.type || '')}</td>
          <td class="text-right">$${receipt.amount.toLocaleString()}</td>
          <td>${receipt.pdfUrl ? 
                `<a href="${receipt.pdfUrl}" target="_blank" class="inline-link">📎 PDF</a>` : 
                '<span class="muted">無</span>'
              }
            </td>
            <td>
              ${receipt.emailSent ? 
                '<span class="pill ok">✅ 已寄送</span>' : 
                '<span class="pill warning">⏳ 未寄送</span>'
              }
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }

    /**********************
     * 志工服務
     **********************/
    document.getElementById('btnLoadVolunteer').addEventListener('click', loadVolunteer);

    async function loadVolunteer() {
      if (!state.lineId) return toast('⚠️ 請先完成登入');
      
      try {
        const result = await callAPI('getVolunteerData', {});
        const stats = result.data.stats;
        
        // 渲染統計資料
        document.getElementById('volStats').innerHTML = `
          <div class="col">
            <div class="stats-card">
              <div class="stats-label">⏰ 總服務時數</div>
              <div class="stats-number">${stats.totalHours}</div>
            </div>
          </div>
          <div class="col">
            <div class="stats-card">
              <div class="stats-label">📋 參與活動數</div>
              <div class="stats-number">${stats.totalActivities}</div>
            </div>
          </div>
          <div class="col">
            <div class="stats-card">
              <div class="stats-label">🔔 開放需求</div>
              <div class="stats-number">${stats.availableNeeds}</div>
            </div>
          </div>
        `;

        // 渲染志工需求
        const needsWrap = document.getElementById('volNeedsContainer');
        if (result.data.needs?.length) {
          let html = `
            <table>
              <thead>
                <tr>
                  <th>📋 需求標題</th>
                  <th>📅 服務日期</th>
                  <th>👥 需求人數</th>
                  <th>⏰ 服務時數</th>
                  <th>⚡ 操作</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          result.data.needs.forEach(need => {
            const isFull = need.currentCount >= need.needCount;
            html += `
              <tr>
                <td><strong>${escapeHtml(need.title || '')}</strong></td>
                <td>${need.date || ''}</td>
                <td>${need.currentCount || 0}/${need.needCount || 0}</td>
                <td>${need.hours || 0} 小時</td>
                <td>
                  ${state.lineId && !isFull ? 
                    `<button class="small success" data-vol-apply="${need.id}">
                      🙋‍♀️ 我要報名
                    </button>` : 
                    (isFull ? '<span class="pill warning">已額滿</span>' : '<span class="muted">需登入</span>')
                  }
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
          needsWrap.innerHTML = html;

          // 綁定志工報名事件
          needsWrap.querySelectorAll('[data-vol-apply]').forEach(btn => {
            btn.addEventListener('click', async () => {
              const needId = btn.getAttribute('data-vol-apply');
              const need = result.data.needs.find(n => n.id == needId);
              
              if (!confirm(`確定要報名志工服務「${need?.title || '此項目'}」嗎？`)) return;
              
              try {
                await callAPI('applyVolunteer', { needId });
                toast('🎉 志工報名成功！');
                loadVolunteer(); // 重新載入
              } catch (error) {
                toast('❌ 志工報名失敗：' + error.message);
              }
            });
          });
        } else {
          needsWrap.innerHTML = '<div class="alert">📋 目前沒有開放的志工需求</div>';
        }

        // 渲染志工紀錄
        const recordsWrap = document.getElementById('volRecordsContainer');
        if (result.data.records?.length) {
          let html = `
            <table>
              <thead>
                <tr>
                  <th>📋 服務項目</th>
                  <th>📅 服務日期</th>
                  <th>⏰ 服務時數</th>
                  <th>📊 狀態</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          result.data.records.forEach(record => {
            html += `
              <tr>
                <td><strong>${escapeHtml(record.title || '')}</strong></td>
                <td>${record.date || ''}</td>
                <td>${record.hours || 0} 小時</td>
                <td>
                  <span class="pill ${record.status === '已完成' ? 'ok' : 'warning'}">
                    ${record.status || ''}
                  </span>
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
          recordsWrap.innerHTML = html;
        } else {
          recordsWrap.innerHTML = '<div class="alert">📋 尚無志工服務紀錄</div>';
        }

        toast('✅ 志工資料已更新');
        
      } catch (error) {
        toast('❌ 載入志工資料失敗：' + error.message);
      }
    }

    /**********************
     * 投票功能
     **********************/
    document.getElementById('btnCreateVotingTopic').addEventListener('click', async () => {
      if (!state.isAdmin) return toast('⚠️ 需要管理員權限');
      
      const title = document.getElementById('newVoteTitle').value.trim();
      const optionsText = document.getElementById('newVoteOptions').value;
      const options = optionsText.split(/\n+/).map(l => l.trim()).filter(Boolean);
      
      if (!title || !options.length) {
        return toast('⚠️ 請輸入投票標題與至少一個選項');
      }
      
      if (options.length < 2) {
        return toast('⚠️ 投票選項至少需要2個');
      }
      
      try {
        await callAPI('createVotingTopic', { title, options });
        toast('✅ 投票主題建立成功（草稿狀態，請至後端發布）');
        
        // 清空表單
        document.getElementById('newVoteTitle').value = '';
        document.getElementById('newVoteOptions').value = '';
        
        loadVotingTopics();
        
      } catch (error) {
        toast('❌ 建立投票主題失敗：' + error.message);
      }
    });

    document.getElementById('btnLoadVotingTopics').addEventListener('click', loadVotingTopics);

    async function loadVotingTopics() {
      try {
        const result = await callAPI('listVotingTopics', {});
        state.votingTopics = result.data || [];
        renderVotingTopics();
        toast('✅ 投票主題已更新');
      } catch (error) {
        toast('❌ 載入投票主題失敗：' + error.message);
      }
    }

    function renderVotingTopics() {
      const wrap = document.getElementById('votingTopicsContainer');
      
      if (!state.votingTopics.length) {
        wrap.innerHTML = '<div class="alert">🗳️ 目前沒有進行中的投票</div>';
        return;
      }

      let html = '<div class="row">';
      
      state.votingTopics.forEach(topic => {
        const isActive = topic.status === 'active' || topic.status === '進行中';
        
        html += `
          <div class="col card" style="min-width: 300px;">
            <h4 style="margin: 0 0 8px;">${escapeHtml(topic.title || '')}</h4>
            <div class="muted" style="font-size: 12px; margin-bottom: 12px;">
              狀態：<span class="pill ${isActive ? 'ok' : 'warning'}">${topic.status}</span>
            </div>
            
            ${isActive ? `
              <div style="margin-bottom: 12px;">
                ${(topic.options || []).map(option => `
                  <label style="display: flex; align-items: center; gap: 8px; margin: 6px 0; cursor: pointer;">
                    <input type="radio" name="vote_${topic.id}" value="${escapeHtml(option.key || option)}" />
                    <span style="font-size: 14px;">${escapeHtml(option.text || option)}</span>
                  </label>
                `).join('')}
              </div>
              <button data-vote-topic="${topic.id}" class="small success" style="width: 100%;">
                🗳️ 投票
              </button>
            ` : `
              <div class="muted" style="font-size: 13px;">此投票已結束或尚未開放</div>
            `}
          </div>
        `;
      });
      
      html += '</div>';
      wrap.innerHTML = html;

      // 綁定投票事件
      wrap.querySelectorAll('[data-vote-topic]').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!state.lineId && !state.sessionToken) {
            return toast('⚠️ 請先登入才能參與投票');
          }
          
          const topicId = btn.getAttribute('data-vote-topic');
          const selectedOption = wrap.querySelector(`input[name="vote_${topicId}"]:checked`);
          
          if (!selectedOption) {
            return toast('⚠️ 請先選擇一個選項');
          }
          
          const topic = state.votingTopics.find(t => t.id == topicId);
          
          if (!confirm(`確定要投票給「${selectedOption.nextElementSibling.textContent}」嗎？`)) return;
          
          try {
            await callAPI('castVote', { 
              topicId, 
              optionKey: selectedOption.value 
            });
            
            toast('🎉 投票成功！');
            loadVotingResults(); // 載入結果
            
          } catch (error) {
            toast('❌ 投票失敗：' + error.message);
          }
        });
      });
    }

    document.getElementById('btnLoadVotingResults').addEventListener('click', loadVotingResults);

    async function loadVotingResults() {
      try {
        const result = await callAPI('getVotingResults', {});
        renderVotingResults(result.data.topics || []);
        toast('✅ 投票統計已更新');
      } catch (error) {
        toast('❌ 載入投票統計失敗：' + error.message);
      }
    }

    function renderVotingResults(topics) {
      const wrap = document.getElementById('votingResultsContainer');
      
      if (!topics.length) {
        wrap.innerHTML = '<div class="alert">📊 暫無投票統計資料</div>';
        return;
      }

      let html = '';
      
      topics.forEach(topic => {
        html += `
          <div class="card" style="padding: 16px;">
            <div class="flex space-between" style="margin-bottom: 12px;">
              <strong style="font-size: 16px;">${escapeHtml(topic.title)}</strong>
              <span class="muted" style="font-size: 12px;">
                📊 總票數：<strong>${topic.totalVotes}</strong>
              </span>
            </div>
            
            <div>
              ${topic.options.map(option => {
                const percentage = option.percentage || 0;
                const isUserVoted = topic.userVotedOption === option.key;
                
                return `
                  <div style="margin: 8px 0;">
                    <div class="flex space-between" style="font-size: 13px; margin-bottom: 4px;">
                      <span>
                        ${escapeHtml(option.text)}
                        ${isUserVoted ? '<span class="pill ok" style="margin-left: 6px;">✅ 我的選擇</span>' : ''}
                      </span>
                      <span><strong>${option.count}</strong> 票 (${percentage}%)</span>
                    </div>
                    <div class="vote-option-bar">
                      <div class="vote-fill" style="width: ${percentage}%;"></div>
                      <span>${percentage > 15 ? percentage + '%' : ''}</span>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      });
      
      wrap.innerHTML = html;
    }

    /**********************
     * 個人總覽
     **********************/
    document.getElementById('btnLoadDashboard').addEventListener('click', loadDashboard);

    async function loadDashboard() {
      if (!state.lineId) return toast('⚠️ 請先完成登入');
      
      try {
        const result = await callAPI('getDashboardData', {});
        const data = result.data;
        
        const html = `
          <div class="row" style="margin-bottom: 24px;">
            <div class="col">
              <div class="stats-card">
                <div class="stats-label">📅 開放活動數</div>
                <div class="stats-number">${data.totalActivities}</div>
              </div>
            </div>
            <div class="col">
              <div class="stats-card">
                <div class="stats-label">✅ 我的報名數</div>
                <div class="stats-number">${data.myRegistrations}</div>
              </div>
            </div>
            <div class="col">
              <div class="stats-card">
                <div class="stats-label">🤝 志工時數</div>
                <div class="stats-number">${data.myVolunteerHours}</div>
              </div>
            </div>
            <div class="col">
              <div class="stats-card">
                <div class="stats-label">💰 累計捐款</div>
                <div class="stats-number">$${data.myDonationAmount.toLocaleString()}</div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <h3>📋 最新活動</h3>
            ${data.recentActivity?.length ? `
              <ul style="padding-left: 20px; margin: 0;">
                ${data.recentActivity.map(activity => `
                  <li style="margin: 6px 0;">
                    <strong>${escapeHtml(activity.title)}</strong>
                    <span class="muted" style="margin-left: 8px;">${activity.date || ''}</span>
                  </li>
                `).join('')}
              </ul>
            ` : '<div class="muted">暫無最新活動</div>'}
          </div>
        `;
        
        document.getElementById('dashboardContent').innerHTML = html;
        toast('✅ 個人總覽已更新');
        
      } catch (error) {
        toast('❌ 載入個人總覽失敗：' + error.message);
      }
    }

    /**********************
     * 管理功能
     **********************/
    document.getElementById('btnAdminExportMembers').addEventListener('click', async () => {
      if (!state.isAdmin) return toast('⚠️ 需要管理員權限');
      
      try {
        const result = await callAPI('exportMembers', {});
        document.getElementById('adminActionResult').innerHTML = `
          <div class="alert success">
            ✅ 會員資料匯出成功<br>
            <a href="${result.data.fileUrl}" target="_blank" class="inline-link">📄 下載會員 CSV 檔案</a>
          </div>
        `;
        toast('✅ 會員資料匯出完成');
      } catch (error) {
        toast('❌ 會員資料匯出失敗：' + error.message);
      }
    });

    document.getElementById('btnAdminExportFinance').addEventListener('click', async () => {
      if (!state.isAdmin) return toast('⚠️ 需要管理員權限');
      
      try {
        const result = await callAPI('exportFinanceData', {});
        document.getElementById('adminActionResult').innerHTML = `
          <div class="alert success">
            ✅ 財務資料匯出成功<br>
            <a href="${result.data.donationUrl}" target="_blank" class="inline-link">📄 下載捐款 CSV</a> ｜ 
            <a href="${result.data.expenseUrl}" target="_blank" class="inline-link">📄 下載支出 CSV</a>
          </div>
        `;
        toast('✅ 財務資料匯出完成');
      } catch (error) {
        toast('❌ 財務資料匯出失敗：' + error.message);
      }
    });

    document.getElementById('btnAdminBackup').addEventListener('click', async () => {
      if (!state.isAdmin) return toast('⚠️ 需要管理員權限');
      
      if (!confirm('確定要建立系統備份嗎？此操作可能需要較長時間。')) return;
      
      try {
        const result = await callAPI('backupSystem', {});
        document.getElementById('adminActionResult').innerHTML = `
          <div class="alert success">
            ✅ 系統備份建立完成<br>
            <strong>備份名稱：</strong>${escapeHtml(result.data.name)}
          </div>
        `;
        toast('✅ 系統備份建立完成');
      } catch (error) {
        toast('❌ 系統備份建立失敗：' + error.message);
      }
    });

    /**********************
     * 工具函數
     **********************/
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str).replace(/[&<>"']/g, s => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[s]);
    }

    function formatDate(d) {
      if (!d) return '';
      try {
        const date = (d instanceof Date) ? d : new Date(d);
        if (isNaN(date.getTime())) return '';
        return date.toLocaleDateString('zh-TW');
      } catch (_) { 
        return ''; 
      }
    }

    function formatDateTime(d) {
      if (!d) return '';
      try {
        const date = (d instanceof Date) ? d : new Date(d);
        if (isNaN(date.getTime())) return '';
        return date.toLocaleString('zh-TW');
      } catch (_) { 
        return ''; 
      }
    }

    /**********************
     * 初始化流程
     **********************/
    async function initialLoad() {
      setUserStatus();
      await loadCategories();
      await loadActivities();
      
      // 如果在 LIFF 環境中，可以選擇自動初始化
      if (window.liff && typeof liff !== 'undefined') {
        // 可選：自動初始化 LIFF
        // await initLIFF();
      }
      
      toast('🎉 病友會平台載入完成！');
    }

    // 頁面載入完成後執行初始化
    document.addEventListener('DOMContentLoaded', initialLoad);

  </script>
</body>
</html>
