<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友會管理系統 - 強化版</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #28a745, #20c997);
      --danger-gradient: linear-gradient(135deg, #dc3545, #c82333);
      --warning-gradient: linear-gradient(135deg, #ffc107, #e0a800);
      --info-gradient: linear-gradient(135deg, #17a2b8, #138496);
      --health-gradient: linear-gradient(135deg, #6f42c1, #e83e8c);
      --medicine-gradient: linear-gradient(135deg, #fd7e14, #ffc107);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', sans-serif;
      background: var(--primary-gradient);
      min-height: 100vh;
      color: #333;
    }

    /* 登入頁面樣式 */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 450px;
    }

    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .login-header h1 {
      color: #4a5568;
      font-size: 28px;
      margin-bottom: 10px;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .login-tabs {
      margin-bottom: 30px;
    }

    .login-tabs .nav-link {
      border-radius: 12px;
      font-weight: 600;
      padding: 12px 20px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .login-tabs .nav-link.active {
      background: var(--primary-gradient);
      color: white;
      border-color: transparent;
    }

    /* Header & Navigation */
    .main-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      margin: 20px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 20px;
      z-index: 1000;
    }

    .main-header h1 {
      color: #4a5568;
      font-size: 28px;
      margin-bottom: 10px;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .user-info-bar {
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 20px;
      border-radius: 25px;
      display: inline-flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      margin-top: 10px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    /* Navigation Tabs */
    .nav-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 15px;
      margin: 0 20px 20px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .nav-pills {
      --bs-nav-pills-border-radius: 12px;
      --bs-nav-pills-link-active-bg: transparent;
      gap: 5px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .nav-pills .nav-link {
      background: transparent;
      border: 2px solid transparent;
      color: #6c757d;
      font-weight: 600;
      padding: 12px 20px;
      transition: all 0.3s ease;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-pills .nav-link:hover {
      background: rgba(102, 126, 234, 0.1);
      border-color: rgba(102, 126, 234, 0.3);
      color: #667eea;
    }

    .nav-pills .nav-link.active {
      background: var(--primary-gradient);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    /* Content Cards */
    .content-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
    }

    .content-card:hover {
      transform: translateY(-2px);
    }

    /* Statistics Cards */
    .stat-card {
      background: var(--success-gradient);
      color: white;
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3);
      transition: transform 0.2s ease;
      margin-bottom: 20px;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    .stat-card h3 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .stat-card p {
      margin: 0;
      opacity: 0.9;
    }

    /* Health & Medicine specific styles */
    .health-card {
      background: var(--health-gradient);
      box-shadow: 0 4px 16px rgba(111, 66, 193, 0.3);
    }

    .medicine-card {
      background: var(--medicine-gradient);
      box-shadow: 0 4px 16px rgba(253, 126, 20, 0.3);
    }

    /* Form Elements */
    .form-floating {
      margin-bottom: 20px;
    }

    .form-control, .form-select {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
    }

    .form-control:focus, .form-select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
      background: white;
    }

    /* Buttons */
    .btn {
      border-radius: 12px;
      font-weight: 600;
      padding: 12px 24px;
      transition: all 0.3s ease;
      border: none;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: var(--primary-gradient);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-success {
      background: var(--success-gradient);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .btn-danger {
      background: var(--danger-gradient);
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    .btn-warning {
      background: var(--warning-gradient);
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
      color: #212529;
    }

    .btn-info {
      background: var(--info-gradient);
      box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Activity Items */
    .activity-item, .member-item, .transaction-item, .health-record-item, .medicine-item {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #667eea;
      transition: all 0.2s ease;
    }

    .health-record-item {
      border-left-color: #6f42c1;
    }

    .medicine-item {
      border-left-color: #fd7e14;
    }

    .activity-item:hover, .member-item:hover, .transaction-item:hover, 
    .health-record-item:hover, .medicine-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-registered { background: #c6f6d5; color: #22543d; }
    .status-pending { background: #feebc8; color: #7b341e; }
    .status-approved { background: #c6f6d5; color: #22543d; }
    .status-rejected { background: #fed7d7; color: #742a2a; }
    .status-active { background: #bee3f8; color: #2a69ac; }
    .status-taken { background: #c6f6d5; color: #22543d; }
    .status-missed { background: #fed7d7; color: #742a2a; }
    .status-scheduled { background: #feebc8; color: #7b341e; }

    /* Tables */
    .table-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 15px;
      background: white;
    }

    .table {
      margin-bottom: 0;
    }

    .table th {
      background: #f8f9fa;
      border-bottom: 2px solid #dee2e6;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      max-width: 400px;
      transform: translateX(450px);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: #c6f6d5;
      color: #22543d;
      border-left: 4px solid #48bb78;
    }

    .notification.error {
      background: #fed7d7;
      color: #742a2a;
      border-left: 4px solid #f56565;
    }

    .notification.warning {
      background: #feebc8;
      color: #7b341e;
      border-left: 4px solid #ed8936;
    }

    /* Loading States */
    .loading-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      color: #718096;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 15px;
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .quick-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #e2e8f0;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      color: #4a5568;
    }

    .quick-btn:hover {
      border-color: #667eea;
      background: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      color: #667eea;
      text-decoration: none;
    }

    .quick-btn i {
      font-size: 24px;
      margin-bottom: 10px;
      display: block;
    }

    /* Health Chart Container */
    .chart-container {
      position: relative;
      height: 300px;
      margin: 20px 0;
    }

    /* Medicine Schedule */
    .medicine-schedule {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .time-slot {
      display: flex;
      align-items: center;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 10px;
      background: #f8f9fa;
      transition: all 0.2s ease;
    }

    .time-slot:hover {
      background: #e9ecef;
    }

    .time-slot.taken {
      background: #d4edda;
      border-left: 4px solid #28a745;
    }

    .time-slot.missed {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
    }

    .time-slot.upcoming {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .main-header, .nav-container, .content-card {
        margin: 10px;
        padding: 15px;
      }

      .main-header h1 {
        font-size: 24px;
      }

      .nav-pills .nav-link {
        padding: 8px 12px;
        font-size: 14px;
      }

      .stat-card h3 {
        font-size: 2rem;
      }

      .quick-actions {
        grid-template-columns: repeat(2, 1fr);
      }

      .table-container {
        max-height: 400px;
      }

      .login-card {
        padding: 30px 20px;
      }
    }

    /* Hide inactive tabs */
    .tab-pane:not(.active) {
      display: none;
    }

    /* Admin specific styles */
    .admin-only {
      display: none;
    }

    .admin-only.show {
      display: block;
    }

    /* Hide main app initially */
    .main-app {
      display: none;
    }

    .main-app.show {
      display: block;
    }

    /* Animation Classes */
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <!-- Login Page -->
  <div id="loginPage" class="login-container">
    <div class="login-card fade-in">
      <div class="login-header">
        <h1><i class="bi bi-hospital"></i> 帕金森病友會</h1>
        <p class="text-muted">歡迎使用管理系統</p>
      </div>

      <!-- Login Tabs -->
      <ul class="nav nav-pills login-tabs justify-content-center" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#lineLogin" role="tab">
            <i class="bi bi-line me-1"></i>LINE 登入
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#emailLogin" role="tab">
            <i class="bi bi-envelope me-1"></i>帳號登入
          </button>
        </li>
      </ul>

      <!-- Login Tab Content -->
      <div class="tab-content">
        <!-- LINE Login -->
        <div class="tab-pane fade show active" id="lineLogin">
          <div class="text-center mb-4">
            <i class="bi bi-line text-success" style="font-size: 3rem;"></i>
            <h5 class="mt-3">使用 LINE 帳號登入</h5>
            <p class="text-muted">快速安全的登入方式</p>
          </div>
          <button class="btn btn-success w-100 mb-3" onclick="initializeLiff()">
            <i class="bi bi-line me-2"></i>使用 LINE 登入
          </button>
          <div class="text-center">
            <small class="text-muted">首次使用需要完成註冊程序</small>
          </div>
        </div>

        <!-- Email Login -->
        <div class="tab-pane fade" id="emailLogin">
          <!-- Login Form -->
          <div id="loginForm">
            <form id="accountLoginForm">
              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="loginIdentifier" required>
                <label for="loginIdentifier">電話號碼或姓名</label>
              </div>
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="loginPassword" required>
                <label for="loginPassword">密碼</label>
              </div>
              <button type="submit" class="btn btn-primary w-100 mb-3">
                <i class="bi bi-box-arrow-in-right me-2"></i>登入
              </button>
            </form>
            <div class="text-center">
              <button class="btn btn-link" onclick="showRegisterForm()">
                還沒有帳號？立即註冊
              </button>
            </div>
          </div>

          <!-- Register Form -->
          <div id="registerForm" style="display: none;">
            <form id="accountRegisterForm">
              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="registerName" required>
                <label for="registerName">真實姓名</label>
              </div>
              <div class="form-floating mb-3">
                <input type="tel" class="form-control" id="registerPhone" required>
                <label for="registerPhone">電話號碼</label>
              </div>
              <div class="form-floating mb-3">
                <input type="email" class="form-control" id="registerEmail" required>
                <label for="registerEmail">電子郵件</label>
              </div>
              <div class="form-floating mb-3">
                <select class="form-select" id="registerMemberType" required>
                  <option value="">請選擇會員類別</option>
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                  <option value="醫護">醫護人員</option>
                  <option value="支持者">支持者</option>
                </select>
                <label for="registerMemberType">會員類別</label>
              </div>
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="registerPassword" required>
                <label for="registerPassword">設定密碼</label>
              </div>
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="confirmPassword" required>
                <label for="confirmPassword">確認密碼</label>
              </div>
              <button type="submit" class="btn btn-primary w-100 mb-3">
                <i class="bi bi-person-plus me-2"></i>完成註冊
              </button>
            </form>
            <div class="text-center">
              <button class="btn btn-link" onclick="showLoginForm()">
                已有帳號？返回登入
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="mainApp" class="main-app">
    <!-- Main Header -->
    <div class="main-header">
      <h1><i class="bi bi-hospital"></i> 帕金森病友會管理系統</h1>
      <p class="text-muted">強化功能整合版</p>
      <div id="userInfoBar" class="user-info-bar" style="display: none;">
        <div class="user-avatar" id="userAvatar">?</div>
        <div>
          <div class="fw-bold" id="userName">載入中...</div>
          <small class="text-muted" id="userRole">會員</small>
        </div>
        <div class="ms-auto">
          <button class="btn btn-sm btn-outline-secondary me-2" onclick="refreshData()">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="logout()">
            <i class="bi bi-box-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Navigation -->
    <div class="nav-container">
      <ul class="nav nav-pills" id="mainTabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#dashboard" role="tab">
            <i class="bi bi-speedometer2"></i> 儀表板
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#profile" role="tab">
            <i class="bi bi-person"></i> 個人資料
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#health" role="tab">
            <i class="bi bi-heart-pulse"></i> 健康記錄
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#medicine" role="tab">
            <i class="bi bi-capsule"></i> 用藥管理
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#activities" role="tab">
            <i class="bi bi-calendar-event"></i> 活動管理
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#volunteer" role="tab">
            <i class="bi bi-heart"></i> 志工服務
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#finance" role="tab">
            <i class="bi bi-cash-coin"></i> 財務管理
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#feedback" role="tab">
            <i class="bi bi-chat-dots"></i> 活動回饋
          </button>
        </li>
        <li class="nav-item admin-only">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#admin" role="tab">
            <i class="bi bi-gear"></i> 系統管理
          </button>
        </li>
      </ul>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Dashboard -->
      <div class="tab-pane fade show active" id="dashboard">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-speedometer2 me-2"></i>系統儀表板</h3>
            <button class="btn btn-outline-primary btn-sm" onclick="loadDashboard()">
              <i class="bi bi-arrow-clockwise me-1"></i>刷新
            </button>
          </div>

          <!-- Quick Actions -->
          <div class="quick-actions">
            <div class="quick-btn" onclick="showTab('profile')">
              <i class="bi bi-person-check"></i>
              <div>更新資料</div>
            </div>
            <div class="quick-btn" onclick="showTab('health')">
              <i class="bi bi-heart-pulse"></i>
              <div>健康記錄</div>
            </div>
            <div class="quick-btn" onclick="showTab('medicine')">
              <i class="bi bi-capsule"></i>
              <div>今日用藥</div>
            </div>
            <div class="quick-btn" onclick="showTab('activities')">
              <i class="bi bi-calendar-plus"></i>
              <div>報名活動</div>
            </div>
          </div>

          <!-- Statistics -->
          <div class="row">
            <div class="col-md-3 col-sm-6">
              <div class="stat-card">
                <h3 id="totalMembers">0</h3>
                <p>總會員數</p>
              </div>
            </div>
            <div class="col-md-3 col-sm-6">
              <div class="stat-card health-card">
                <h3 id="healthRecords">0</h3>
                <p>健康記錄</p>
              </div>
            </div>
            <div class="col-md-3 col-sm-6">
              <div class="stat-card medicine-card">
                <h3 id="medicineReminders">0</h3>
                <p>用藥提醒</p>
              </div>
            </div>
            <div class="col-md-3 col-sm-6">
              <div class="stat-card" style="background: var(--info-gradient);">
                <h3 id="upcomingActivities">0</h3>
                <p>即將舉行活動</p>
              </div>
            </div>
          </div>

          <!-- Recent Activities -->
          <div class="mt-4">
            <h5><i class="bi bi-clock-history me-2"></i>最近活動</h5>
            <div id="recentActivities" class="loading-container">
              <div class="loading-spinner"></div>
              <span>載入中...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Management -->
      <div class="tab-pane fade" id="profile">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-person me-2"></i>個人資料管理</h3>
            <button class="btn btn-outline-primary btn-sm" onclick="loadProfile()">
              <i class="bi bi-arrow-clockwise me-1"></i>重新載入
            </button>
          </div>

          <form id="profileForm">
            <div class="row">
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="profileName" readonly>
                  <label for="profileName">姓名</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="tel" class="form-control" id="profilePhone">
                  <label for="profilePhone">電話</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="email" class="form-control" id="profileEmail">
                  <label for="profileEmail">電子郵件</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <select class="form-select" id="profileMemberType">
                    <option value="病友">病友</option>
                    <option value="家屬">家屬</option>
                    <option value="志工">志工</option>
                    <option value="醫護">醫護人員</option>
                    <option value="支持者">支持者</option>
                  </select>
                  <label for="profileMemberType">會員類別</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating mb-3">
                  <textarea class="form-control" id="profileNotes" style="height: 100px"></textarea>
                  <label for="profileNotes">備註</label>
                </div>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-circle me-2"></i>更新資料
            </button>
          </form>
        </div>
      </div>

      <!-- Health Records -->
      <div class="tab-pane fade" id="health">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-heart-pulse me-2"></i>健康記錄管理</h3>
            <button class="btn btn-success" onclick="showAddHealthRecord()">
              <i class="bi bi-plus-circle me-1"></i>新增記錄
            </button>
          </div>

          <!-- Health Chart -->
          <div class="chart-container">
            <canvas id="healthChart"></canvas>
          </div>

          <!-- Add Health Record Form -->
          <div id="addHealthRecordForm" style="display: none;" class="mb-4">
            <div class="card">
              <div class="card-header">
                <h5><i class="bi bi-plus-circle me-2"></i>新增健康記錄</h5>
              </div>
              <div class="card-body">
                <form id="healthRecordForm">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <input type="datetime-local" class="form-control" id="healthRecordDate" required>
                        <label for="healthRecordDate">記錄時間</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <select class="form-select" id="healthRecordType" required>
                          <option value="">請選擇記錄類型</option>
                          <option value="血壓">血壓</option>
                          <option value="血糖">血糖</option>
                          <option value="體重">體重</option>
                          <option value="症狀">症狀記錄</option>
                          <option value="運動">運動記錄</option>
                          <option value="睡眠">睡眠品質</option>
                          <option value="情緒">情緒狀態</option>
                        </select>
                        <label for="healthRecordType">記錄類型</label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="healthValue1" step="0.1">
                        <label for="healthValue1">數值1</label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="healthValue2" step="0.1">
                        <label for="healthValue2">數值2</label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="healthUnit">
                        <label for="healthUnit">單位</label>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-floating mb-3">
                        <textarea class="form-control" id="healthNotes" style="height: 100px"></textarea>
                        <label for="healthNotes">備註說明</label>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success">
                      <i class="bi bi-check-circle me-2"></i>保存記錄
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddHealthRecord()">
                      <i class="bi bi-x-circle me-2"></i>取消
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Health Records List -->
          <div class="table-container">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>記錄時間</th>
                  <th>類型</th>
                  <th>數值</th>
                  <th>備註</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="healthRecordsList">
                <tr>
                  <td colspan="5" class="text-center text-muted">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Medicine Management -->
      <div class="tab-pane fade" id="medicine">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-capsule me-2"></i>用藥管理系統</h3>
            <button class="btn btn-warning" onclick="showAddMedicine()">
              <i class="bi bi-plus-circle me-1"></i>新增用藥
            </button>
          </div>

          <!-- Today's Medicine Schedule -->
          <div class="medicine-schedule">
            <h5><i class="bi bi-clock me-2"></i>今日用藥時程</h5>
            <div id="todayMedicineSchedule">
              <div class="loading-container">
                <div class="loading-spinner"></div>
                <span>載入中...</span>
              </div>
            </div>
          </div>

          <!-- Add Medicine Form -->
          <div id="addMedicineForm" style="display: none;" class="mb-4">
            <div class="card">
              <div class="card-header">
                <h5><i class="bi bi-plus-circle me-2"></i>新增用藥提醒</h5>
              </div>
              <div class="card-body">
                <form id="medicineForm">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="medicineName" required>
                        <label for="medicineName">藥物名稱</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <select class="form-select" id="medicineType" required>
                          <option value="">請選擇藥物類型</option>
                          <option value="口服藥">口服藥</option>
                          <option value="注射劑">注射劑</option>
                          <option value="外用藥">外用藥</option>
                          <option value="保健品">保健品</option>
                        </select>
                        <label for="medicineType">藥物類型</label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="medicineDosage" step="0.5" required>
                        <label for="medicineDosage">劑量</label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-floating mb-3">
                        <select class="form-select" id="medicineUnit" required>
                          <option value="">單位</option>
                          <option value="錠">錠</option>
                          <option value="顆">顆</option>
                          <option value="ml">ml</option>
                          <option value="mg">mg</option>
                          <option value="滴">滴</option>
                        </select>
                        <label for="medicineUnit">單位</label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-floating mb-3">
                        <select class="form-select" id="medicineFrequency" required>
                          <option value="">服用頻率</option>
                          <option value="每日一次">每日一次</option>
                          <option value="每日兩次">每日兩次</option>
                          <option value="每日三次">每日三次</option>
                          <option value="每日四次">每日四次</option>
                          <option value="每週一次">每週一次</option>
                          <option value="需要時">需要時</option>
                        </select>
                        <label for="medicineFrequency">服用頻率</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <input type="date" class="form-control" id="medicineStartDate" required>
                        <label for="medicineStartDate">開始日期</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <input type="date" class="form-control" id="medicineEndDate">
                        <label for="medicineEndDate">結束日期（可選）</label>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-floating mb-3">
                        <textarea class="form-control" id="medicineNotes" style="height: 80px"></textarea>
                        <label for="medicineNotes">用藥說明</label>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-warning">
                      <i class="bi bi-check-circle me-2"></i>新增用藥
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddMedicine()">
                      <i class="bi bi-x-circle me-2"></i>取消
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Medicine List -->
          <div class="table-container">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>藥物名稱</th>
                  <th>類型</th>
                  <th>劑量</th>
                  <th>頻率</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="medicineList">
                <tr>
                  <td colspan="6" class="text-center text-muted">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Activities Management -->
      <div class="tab-pane fade" id="activities">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-calendar-event me-2"></i>活動管理</h3>
            <div>
              <button class="btn btn-info admin-only" onclick="showAddActivity()">
                <i class="bi bi-plus-circle me-1"></i>新增活動
              </button>
              <button class="btn btn-outline-primary btn-sm" onclick="loadActivities()">
                <i class="bi bi-arrow-clockwise me-1"></i>刷新
              </button>
            </div>
          </div>

          <!-- Add Activity Form (Admin Only) -->
          <div id="addActivityForm" style="display: none;" class="mb-4 admin-only">
            <div class="card">
              <div class="card-header">
                <h5><i class="bi bi-plus-circle me-2"></i>新增活動</h5>
              </div>
              <div class="card-body">
                <form id="activityForm">
                  <div class="row">
                    <div class="col-md-8">
                      <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="activityTitle" required>
                        <label for="activityTitle">活動標題</label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-floating mb-3">
                        <select class="form-select" id="activityType" required>
                          <option value="">活動類型</option>
                          <option value="講座">講座</option>
                          <option value="運動">運動</option>
                          <option value="聚會">聚會</option>
                          <option value="義診">義診</option>
                          <option value="旅遊">旅遊</option>
                          <option value="其他">其他</option>
                        </select>
                        <label for="activityType">活動類型</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <input type="datetime-local" class="form-control" id="activityDate" required>
                        <label for="activityDate">活動日期時間</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="activityLocation" required>
                        <label for="activityLocation">活動地點</label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="activityFee" min="0">
                        <label for="activityFee">活動費用</label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="activityCapacity" min="1">
                        <label for="activityCapacity">人數限制</label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-floating mb-3">
                        <input type="date" class="form-control" id="activityDeadline">
                        <label for="activityDeadline">報名截止日</label>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-floating mb-3">
                        <textarea class="form-control" id="activityDescription" style="height: 120px"></textarea>
                        <label for="activityDescription">活動描述</label>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-info">
                      <i class="bi bi-check-circle me-2"></i>建立活動
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddActivity()">
                      <i class="bi bi-x-circle me-2"></i>取消
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Activities List -->
          <div id="activitiesList">
            <div class="loading-container">
              <div class="loading-spinner"></div>
              <span>載入活動資料中...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Volunteer Services -->
      <div class="tab-pane fade" id="volunteer">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-heart me-2"></i>志工服務</h3>
            <div>
              <button class="btn btn-danger admin-only" onclick="showAddVolunteer()">
                <i class="bi bi-plus-circle me-1"></i>發布需求
              </button>
              <button class="btn btn-outline-primary btn-sm" onclick="loadVolunteers()">
                <i class="bi bi-arrow-clockwise me-1"></i>刷新
              </button>
            </div>
          </div>

          <!-- Volunteer Stats -->
          <div class="row mb-4">
            <div class="col-md-4">
              <div class="stat-card" style="background: var(--danger-gradient);">
                <h3 id="myVolunteerHours">0</h3>
                <p>我的服務時數</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat-card" style="background: var(--warning-gradient); color: #212529;">
                <h3 id="availableVolunteerJobs">0</h3>
                <p>可報名需求</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat-card" style="background: var(--success-gradient);">
                <h3 id="completedVolunteerJobs">0</h3>
                <p>已完成服務</p>
              </div>
            </div>
          </div>

          <!-- Add Volunteer Need Form (Admin Only) -->
          <div id="addVolunteerForm" style="display: none;" class="mb-4 admin-only">
            <div class="card">
              <div class="card-header">
                <h5><i class="bi bi-plus-circle me-2"></i>發布志工需求</h5>
              </div>
              <div class="card-body">
                <form id="volunteerForm">
                  <div class="row">
                    <div class="col-md-8">
                      <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="volunteerTitle" required>
                        <label for="volunteerTitle">需求標題</label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-floating mb-3">
                        <select class="form-select" id="volunteerCategory" required>
                          <option value="">服務類別</option>
                          <option value="活動協助">活動協助</option>
                          <option value="陪伴服務">陪伴服務</option>
                          <option value="交通接送">交通接送</option>
                          <option value="行政協助">行政協助</option>
                          <option value="專業服務">專業服務</option>
                          <option value="其他">其他</option>
                        </select>
                        <label for="volunteerCategory">服務類別</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <input type="datetime-local" class="form-control" id="volunteerDate" required>
                        <label for="volunteerDate">服務日期時間</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="volunteerLocation" required>
                        <label for="volunteerLocation">服務地點</label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="volunteerHours" min="0.5" step="0.5" required>
                        <label for="volunteerHours">預計時數</label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="volunteerNeeded" min="1" required>
                        <label for="volunteerNeeded">需要人數</label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-floating mb-3">
                        <input type="date" class="form-control" id="volunteerDeadline">
                        <label for="volunteerDeadline">報名截止</label>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-floating mb-3">
                        <textarea class="form-control" id="volunteerDescription" style="height: 100px"></textarea>
                        <label for="volunteerDescription">需求描述</label>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-danger">
                      <i class="bi bi-check-circle me-2"></i>發布需求
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddVolunteer()">
                      <i class="bi bi-x-circle me-2"></i>取消
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Volunteer Opportunities List -->
          <div id="volunteerList">
            <div class="loading-container">
              <div class="loading-spinner"></div>
              <span>載入志工需求中...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Finance Management -->
      <div class="tab-pane fade" id="finance">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-cash-coin me-2"></i>財務管理</h3>
            <div>
              <button class="btn btn-success" onclick="showAddDonation()">
                <i class="bi bi-plus-circle me-1"></i>新增捐款
              </button>
              <button class="btn btn-warning admin-only" onclick="showAddExpense()">
                <i class="bi bi-plus-circle me-1"></i>支出申請
              </button>
            </div>
          </div>

          <!-- Financial Summary -->
          <div class="row mb-4">
            <div class="col-md-4">
              <div class="stat-card" style="background: var(--success-gradient);">
                <h3 id="totalDonations">$0</h3>
                <p>總捐款金額</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat-card" style="background: var(--warning-gradient); color: #212529;">
                <h3 id="totalExpenses">$0</h3>
                <p>總支出金額</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stat-card" style="background: var(--info-gradient);">
                <h3 id="netBalance">$0</h3>
                <p>淨餘額</p>
              </div>
            </div>
          </div>

          <!-- Add Donation Form -->
          <div id="addDonationForm" style="display: none;" class="mb-4">
            <div class="card">
              <div class="card-header">
                <h5><i class="bi bi-plus-circle me-2"></i>新增捐款記錄</h5>
              </div>
              <div class="card-body">
                <form id="donationForm">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="donationAmount" min="1" required>
                        <label for="donationAmount">捐款金額</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <select class="form-select" id="donationType" required>
                          <option value="">捐款類型</option>
                          <option value="一般捐款">一般捐款</option>
                          <option value="指定用途">指定用途</option>
                          <option value="活動贊助">活動贊助</option>
                          <option value="設備捐贈">設備捐贈</option>
                        </select>
                        <label for="donationType">捐款類型</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <input type="date" class="form-control" id="donationDate" required>
                        <label for="donationDate">捐款日期</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <select class="form-select" id="donationMethod" required>
                          <option value="">付款方式</option>
                          <option value="現金">現金</option>
                          <option value="轉帳">轉帳</option>
                          <option value="支票">支票</option>
                          <option value="信用卡">信用卡</option>
                        </select>
                        <label for="donationMethod">付款方式</label>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-floating mb-3">
                        <textarea class="form-control" id="donationNotes" style="height: 80px"></textarea>
                        <label for="donationNotes">備註</label>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success">
                      <i class="bi bi-check-circle me-2"></i>新增捐款
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddDonation()">
                      <i class="bi bi-x-circle me-2"></i>取消
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Add Expense Form (Admin Only) -->
          <div id="addExpenseForm" style="display: none;" class="mb-4 admin-only">
            <div class="card">
              <div class="card-header">
                <h5><i class="bi bi-plus-circle me-2"></i>新增支出申請</h5>
              </div>
              <div class="card-body">
                <form id="expenseForm">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="expenseAmount" min="1" required>
                        <label for="expenseAmount">支出金額</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <select class="form-select" id="expenseCategory" required>
                          <option value="">支出類別</option>
                          <option value="活動費用">活動費用</option>
                          <option value="行政費用">行政費用</option>
                          <option value="設備採購">設備採購</option>
                          <option value="場地租借">場地租借</option>
                          <option value="交通費">交通費</option>
                          <option value="其他">其他</option>
                        </select>
                        <label for="expenseCategory">支出類別</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <input type="date" class="form-control" id="expenseDate" required>
                        <label for="expenseDate">支出日期</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="expenseVendor">
                        <label for="expenseVendor">廠商/收款人</label>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-floating mb-3">
                        <textarea class="form-control" id="expenseDescription" style="height: 80px" required></textarea>
                        <label for="expenseDescription">支出說明</label>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-warning">
                      <i class="bi bi-check-circle me-2"></i>提交申請
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddExpense()">
                      <i class="bi bi-x-circle me-2"></i>取消
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Financial Records -->
          <div class="table-container">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>日期</th>
                  <th>類型</th>
                  <th>金額</th>
                  <th>說明</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="financialRecords">
                <tr>
                  <td colspan="6" class="text-center text-muted">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Feedback Management -->
      <div class="tab-pane fade" id="feedback">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-chat-dots me-2"></i>活動回饋</h3>
            <button class="btn btn-info" onclick="showAddFeedback()">
              <i class="bi bi-plus-circle me-1"></i>新增回饋
            </button>
          </div>

          <!-- Add Feedback Form -->
          <div id="addFeedbackForm" style="display: none;" class="mb-4">
            <div class="card">
              <div class="card-header">
                <h5><i class="bi bi-plus-circle me-2"></i>新增活動回饋</h5>
              </div>
              <div class="card-body">
                <form id="feedbackForm">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <select class="form-select" id="feedbackActivity" required>
                          <option value="">選擇活動</option>
                        </select>
                        <label for="feedbackActivity">參與活動</label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating mb-3">
                        <select class="form-select" id="feedbackRating" required>
                          <option value="">評分</option>
                          <option value="5">非常滿意 (5分)</option>
                          <option value="4">滿意 (4分)</option>
                          <option value="3">普通 (3分)</option>
                          <option value="2">不滿意 (2分)</option>
                          <option value="1">非常不滿意 (1分)</option>
                        </select>
                        <label for="feedbackRating">整體評分</label>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-floating mb-3">
                        <textarea class="form-control" id="feedbackContent" style="height: 120px" required></textarea>
                        <label for="feedbackContent">回饋內容</label>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-floating mb-3">
                        <textarea class="form-control" id="feedbackSuggestion" style="height: 80px"></textarea>
                        <label for="feedbackSuggestion">改善建議</label>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-info">
                      <i class="bi bi-check-circle me-2"></i>提交回饋
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddFeedback()">
                      <i class="bi bi-x-circle me-2"></i>取消
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Feedback List -->
          <div id="feedbackList">
            <div class="loading-container">
              <div class="loading-spinner"></div>
              <span>載入回饋資料中...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin Panel -->
      <div class="tab-pane fade admin-only" id="admin">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-gear me-2"></i>系統管理</h3>
            <button class="btn btn-outline-primary btn-sm" onclick="loadAdminData()">
              <i class="bi bi-arrow-clockwise me-1"></i>刷新數據
            </button>
          </div>

          <!-- Admin Stats -->
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="stat-card">
                <h3 id="adminTotalMembers">0</h3>
                <p>總會員數</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card" style="background: var(--info-gradient);">
                <h3 id="adminPendingApprovals">0</h3>
                <p>待審核</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card" style="background: var(--warning-gradient); color: #212529;">
                <h3 id="adminActiveActivities">0</h3>
                <p>進行中活動</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card" style="background: var(--success-gradient);">
                <h3 id="adminMonthlyRevenue">$0</h3>
                <p>本月收入</p>
              </div>
            </div>
          </div>

          <!-- Admin Tabs -->
          <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#adminMembers" role="tab">
                <i class="bi bi-people me-1"></i>會員管理
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#adminReports" role="tab">
                <i class="bi bi-graph-up me-1"></i>報表統計
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#adminSettings" role="tab">
                <i class="bi bi-sliders me-1"></i>系統設定
              </button>
            </li>
          </ul>

          <!-- Admin Tab Content -->
          <div class="tab-content">
            <!-- Members Management -->
            <div class="tab-pane fade show active" id="adminMembers">
              <div class="table-container">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>姓名</th>
                      <th>會員類別</th>
                      <th>電話</th>
                      <th>註冊日期</th>
                      <th>狀態</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="adminMembersList">
                    <tr>
                      <td colspan="6" class="text-center text-muted">載入中...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Reports -->
            <div class="tab-pane fade" id="adminReports">
              <div class="row">
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-header">
                      <h6><i class="bi bi-graph-up me-2"></i>會員成長趨勢</h6>
                    </div>
                    <div class="card-body">
                      <canvas id="memberGrowthChart" style="height: 200px;"></canvas>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-header">
                      <h6><i class="bi bi-pie-chart me-2"></i>活動參與分布</h6>
                    </div>
                    <div class="card-body">
                      <canvas id="activityDistributionChart" style="height: 200px;"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Settings -->
            <div class="tab-pane fade" id="adminSettings">
              <form id="systemSettingsForm">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-floating mb-3">
                      <input type="text" class="form-control" id="systemName" value="帕金森病友會">
                      <label for="systemName">系統名稱</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating mb-3">
                      <input type="email" class="form-control" id="systemEmail">
                      <label for="systemEmail">系統信箱</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating mb-3">
                      <input type="tel" class="form-control" id="systemPhone">
                      <label for="systemPhone">聯絡電話</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating mb-3">
                      <select class="form-select" id="autoApproval">
                        <option value="false">需要審核</option>
                        <option value="true">自動通過</option>
                      </select>
                      <label for="autoApproval">會員註冊審核</label>
                    </div>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-check-circle me-2"></i>保存設定
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global Variables
    let currentUser = null;
    let isAdmin = false;
    let liffInitialized = false;
    let systemData = {
      members: [],
      activities: [],
      volunteers: [],
      finances: [],
      feedback: [],
      healthRecords: [],
      medicines: []
    };

    // Initialize System
    document.addEventListener('DOMContentLoaded', function() {
      initializeSystem();
      loadSampleData();
    });

    function initializeSystem() {
      // Check if user is already logged in
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showMainApp();
      }

      // Set current date for date inputs
      const today = new Date().toISOString().split('T')[0];
      const now = new Date().toISOString().slice(0, 16);
      
      document.querySelectorAll('input[type="date"]').forEach(input => {
        if (!input.value) input.value = today;
      });
      
      document.querySelectorAll('input[type="datetime-local"]').forEach(input => {
        if (!input.value) input.value = now;
      });

      // Initialize event listeners
      setupEventListeners();
    }

    function setupEventListeners() {
      // Login forms
      document.getElementById('accountLoginForm').addEventListener('submit', handleAccountLogin);
      document.getElementById('accountRegisterForm').addEventListener('submit', handleAccountRegister);
      
      // Profile form
      document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
      
      // Health record form
      document.getElementById('healthRecordForm').addEventListener('submit', handleHealthRecord);
      
      // Medicine form
      document.getElementById('medicineForm').addEventListener('submit', handleMedicine);
      
      // Activity form
      document.getElementById('activityForm').addEventListener('submit', handleActivity);
      
      // Volunteer form
      document.getElementById('volunteerForm').addEventListener('submit', handleVolunteer);
      
      // Financial forms
      document.getElementById('donationForm').addEventListener('submit', handleDonation);
      document.getElementById('expenseForm').addEventListener('submit', handleExpense);
      
      // Feedback form
      document.getElementById('feedbackForm').addEventListener('submit', handleFeedback);
      
      // System settings form
      document.getElementById('systemSettingsForm').addEventListener('submit', handleSystemSettings);
    }

    // LIFF Integration
    async function initializeLiff() {
      try {
        showNotification('正在初始化 LINE 登入...', 'info');
        
        // Simulate LIFF initialization
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Mock LINE user data
        const lineUser = {
          userId: 'U' + Math.random().toString(36).substr(2, 9),
          displayName: 'LINE 使用者',
          pictureUrl: null
        };
        
        // Check if user exists
        const existingUser = systemData.members.find(m => m.lineId === lineUser.userId);
        
        if (existingUser) {
          currentUser = existingUser;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          showMainApp();
          showNotification('LINE 登入成功！', 'success');
        } else {
          // Show LINE registration form
          showLineRegistration(lineUser);
        }
        
      } catch (error) {
        console.error('LIFF initialization failed:', error);
        showNotification('LINE 登入失敗，請稍後再試', 'error');
      }
    }

    function showLineRegistration(lineUser) {
      const modal = document.createElement('div');
      modal.className = 'modal fade show';
      modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">完成 LINE 註冊</h5>
            </div>
            <div class="modal-body">
              <form id="lineRegisterForm">
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="lineRealName" required>
                  <label for="lineRealName">真實姓名</label>
                </div>
                <div class="form-floating mb-3">
                  <input type="tel" class="form-control" id="linePhone" required>
                  <label for="linePhone">電話號碼</label>
                </div>
                <div class="form-floating mb-3">
                  <select class="form-select" id="lineMemberType" required>
                    <option value="">請選擇會員類別</option>
                    <option value="病友">病友</option>
                    <option value="家屬">家屬</option>
                    <option value="志工">志工</option>
                    <option value="醫護">醫護人員</option>
                    <option value="支持者">支持者</option>
                  </select>
                  <label for="lineMemberType">會員類別</label>
                </div>
                <button type="submit" class="btn btn-success w-100">完成註冊</button>
              </form>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('lineRegisterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const newUser = {
          id: Date.now(),
          name: document.getElementById('lineRealName').value,
          phone: document.getElementById('linePhone').value,
          memberType: document.getElementById('lineMemberType').value,
          lineId: lineUser.userId,
          lineName: lineUser.displayName,
          email: '',
          registrationDate: new Date().toISOString().split('T')[0],
          status: 'approved',
          role: 'member'
        };
        
        systemData.members.push(newUser);
        currentUser = newUser;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        document.body.removeChild(modal);
        showMainApp();
        showNotification('註冊成功！歡迎加入帕金森病友會', 'success');
      });
    }

    // Account Login/Register
    function handleAccountLogin(e) {
      e.preventDefault();
      
      const identifier = document.getElementById('loginIdentifier').value;
      const password = document.getElementById('loginPassword').value;
      
      const user = systemData.members.find(m => 
        (m.phone === identifier || m.name === identifier) && m.password === password
      );
      
      if (user) {
        currentUser = user;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        showMainApp();
        showNotification('登入成功！', 'success');
      } else {
        showNotification('帳號或密碼錯誤', 'error');
      }
    }

    function handleAccountRegister(e) {
      e.preventDefault();
      
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (password !== confirmPassword) {
        showNotification('密碼確認不符', 'error');
        return;
      }
      
      const phone = document.getElementById('registerPhone').value;
      const email = document.getElementById('registerEmail').value;
      
      // Check if user already exists
      const existingUser = systemData.members.find(m => m.phone === phone || m.email === email);
      if (existingUser) {
        showNotification('電話或信箱已被註冊', 'error');
        return;
      }
      
      const newUser = {
        id: Date.now(),
        name: document.getElementById('registerName').value,
        phone: phone,
        email: email,
        memberType: document.getElementById('registerMemberType').value,
        password: password,
        lineId: '',
        lineName: '',
        registrationDate: new Date().toISOString().split('T')[0],
        status: 'approved',
        role: 'member'
      };
      
      systemData.members.push(newUser);
      currentUser = newUser;
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      
      showMainApp();
      showNotification('註冊成功！歡迎加入帕金森病友會', 'success');
    }

    function showRegisterForm() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
    }

    function showLoginForm() {
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
    }

    function showMainApp() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('mainApp').classList.add('show');
      
      updateUserInfo();
      loadDashboard();
      
      // Show admin features if user is admin
      if (currentUser && (currentUser.role === 'admin' || currentUser.memberType === '管理員')) {
        isAdmin = true;
        document.querySelectorAll('.admin-only').forEach(el => el.classList.add('show'));
      }
    }

    function updateUserInfo() {
      if (!currentUser) return;
      
      document.getElementById('userInfoBar').style.display = 'flex';
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userRole').textContent = currentUser.memberType;
      document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
      
      // Load profile data
      document.getElementById('profileName').value = currentUser.name;
      document.getElementById('profilePhone').value = currentUser.phone || '';
      document.getElementById('profileEmail').value = currentUser.email || '';
      document.getElementById('profileMemberType').value = currentUser.memberType || '';
    }

    function logout() {
      currentUser = null;
      isAdmin = false;
      localStorage.removeItem('currentUser');
      
      document.getElementById('mainApp').classList.remove('show');
      document.getElementById('loginPage').style.display = 'flex';
      document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('show'));
      
      showNotification('已安全登出', 'info');
    }

    // Data Loading Functions
    function loadDashboard() {
      // Update statistics
      document.getElementById('totalMembers').textContent = systemData.members.length;
      document.getElementById('healthRecords').textContent = systemData.healthRecords.filter(r => r.userId === currentUser.id).length;
      document.getElementById('medicineReminders').textContent = systemData.medicines.filter(m => m.userId === currentUser.id).length;
      document.getElementById('upcomingActivities').textContent = systemData.activities.filter(a => new Date(a.date) > new Date()).length;
      
      // Load recent activities
      loadRecentActivities();
    }

    function loadRecentActivities() {
      const container = document.getElementById('recentActivities');
      const recentActivities = systemData.activities
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
        .slice(0, 5);
      
      if (recentActivities.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">暫無活動記錄</p>';
        return;
      }
      
      container.innerHTML = recentActivities.map(activity => `
        <div class="activity-item">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="mb-1">${activity.title}</h6>
              <p class="mb-1 text-muted">${activity.location} | ${formatDateTime(activity.date)}</p>
              <span class="status-badge status-${activity.status}">${getActivityStatus(activity.status)}</span>
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="viewActivity(${activity.id})">
              <i class="bi bi-eye"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    function loadProfile() {
      if (!currentUser) return;
      updateUserInfo();
    }

    function handleProfileUpdate(e) {
      e.preventDefault();
      
      if (!currentUser) return;
      
      currentUser.phone = document.getElementById('profilePhone').value;
      currentUser.email = document.getElementById('profileEmail').value;
      currentUser.memberType = document.getElementById('profileMemberType').value;
      currentUser.notes = document.getElementById('profileNotes').value;
      
      // Update in members array
      const memberIndex = systemData.members.findIndex(m => m.id === currentUser.id);
      if (memberIndex !== -1) {
        systemData.members[memberIndex] = { ...currentUser };
      }
      
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      showNotification('個人資料更新成功', 'success');
    }

    // Health Records Functions
    function showAddHealthRecord() {
      document.getElementById('addHealthRecordForm').style.display = 'block';
      document.getElementById('healthRecordDate').value = new Date().toISOString().slice(0, 16);
    }

    function hideAddHealthRecord() {
      document.getElementById('addHealthRecordForm').style.display = 'none';
      document.getElementById('healthRecordForm').reset();
    }

    function handleHealthRecord(e) {
      e.preventDefault();
      
      const record = {
        id: Date.now(),
        userId: currentUser.id,
        date: document.getElementById('healthRecordDate').value,
        type: document.getElementById('healthRecordType').value,
        value1: document.getElementById('healthValue1').value,
        value2: document.getElementById('healthValue2').value,
        unit: document.getElementById('healthUnit').value,
        notes: document.getElementById('healthNotes').value,
        createdAt: new Date().toISOString()
      };
      
      systemData.healthRecords.push(record);
      hideAddHealthRecord();
      loadHealthRecords();
      updateHealthChart();
      showNotification('健康記錄新增成功', 'success');
    }

    function loadHealthRecords() {
      const tbody = document.getElementById('healthRecordsList');
      const userRecords = systemData.healthRecords
        .filter(r => r.userId === currentUser.id)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (userRecords.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">暫無健康記錄</td></tr>';
        return;
      }
      
      tbody.innerHTML = userRecords.map(record => `
        <tr>
          <td>${formatDateTime(record.date)}</td>
          <td>${record.type}</td>
          <td>${record.value1}${record.value2 ? '/' + record.value2 : ''} ${record.unit || ''}</td>
          <td>${record.notes || '-'}</td>
          <td>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteHealthRecord(${record.id})">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    function deleteHealthRecord(id) {
      if (confirm('確定要刪除此健康記錄嗎？')) {
        systemData.healthRecords = systemData.healthRecords.filter(r => r.id !== id);
        loadHealthRecords();
        updateHealthChart();
        showNotification('健康記錄已刪除', 'info');
      }
    }

    function updateHealthChart() {
      const ctx = document.getElementById('healthChart').getContext('2d');
      const userRecords = systemData.healthRecords
        .filter(r => r.userId === currentUser.id && r.type === '血壓')
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(-10);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: userRecords.map(r => formatDate(r.date)),
          datasets: [{
            label: '收縮壓',
            data: userRecords.map(r => r.value1),
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4
          }, {
            label: '舒張壓',
            data: userRecords.map(r => r.value2),
            borderColor: '#f093fb',
            backgroundColor: 'rgba(240, 147, 251, 0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: '血壓趨勢圖'
            }
          },
          scales: {
            y: {
              beginAtZero: false
            }
          }
        }
      });
    }

    // Medicine Management Functions
    function showAddMedicine() {
      document.getElementById('addMedicineForm').style.display = 'block';
      document.getElementById('medicineStartDate').value = new Date().toISOString().split('T')[0];
    }

    function hideAddMedicine() {
      document.getElementById('addMedicineForm').style.display = 'none';
      document.getElementById('medicineForm').reset();
    }

    function handleMedicine(e) {
      e.preventDefault();
      
      const medicine = {
        id: Date.now(),
        userId: currentUser.id,
        name: document.getElementById('medicineName').value,
        type: document.getElementById('medicineType').value,
        dosage: document.getElementById('medicineDosage').value,
        unit: document.getElementById('medicineUnit').value,
        frequency: document.getElementById('medicineFrequency').value,
        startDate: document.getElementById('medicineStartDate').value,
        endDate: document.getElementById('medicineEndDate').value,
        notes: document.getElementById('medicineNotes').value,
        status: 'active',
        createdAt: new Date().toISOString()
      };
      
      systemData.medicines.push(medicine);
      hideAddMedicine();
      loadMedicines();
      loadTodayMedicineSchedule();
      showNotification('用藥提醒新增成功', 'success');
    }

    function loadMedicines() {
      const tbody = document.getElementById('medicineList');
      const userMedicines = systemData.medicines
        .filter(m => m.userId === currentUser.id)
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      if (userMedicines.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">暫無用藥記錄</td></tr>';
        return;
      }
      
      tbody.innerHTML = userMedicines.map(medicine => `
        <tr>
          <td>${medicine.name}</td>
          <td>${medicine.type}</td>
          <td>${medicine.dosage} ${medicine.unit}</td>
          <td>${medicine.frequency}</td>
          <td><span class="status-badge status-${medicine.status}">${getMedicineStatus(medicine.status)}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="toggleMedicineStatus(${medicine.id})">
              <i class="bi bi-toggle-on"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteMedicine(${medicine.id})">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    function loadTodayMedicineSchedule() {
      const container = document.getElementById('todayMedicineSchedule');
      const userMedicines = systemData.medicines.filter(m => m.userId === currentUser.id && m.status === 'active');
      
      if (userMedicines.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">今日無用藥安排</p>';
        return;
      }
      
      // Generate schedule based on frequency
      const schedule = [];
      userMedicines.forEach(medicine => {
        const times = generateMedicineTimes(medicine.frequency);
        times.forEach(time => {
          schedule.push({
            ...medicine,
            time: time,
            status: Math.random() > 0.7 ? 'taken' : (Math.random() > 0.5 ? 'upcoming' : 'missed')
          });
        });
      });
      
      schedule.sort((a, b) => a.time.localeCompare(b.time));
      
      container.innerHTML = schedule.map(item => `
        <div class="time-slot ${item.status}">
          <div class="d-flex align-items-center">
            <div class="me-3">
              <strong>${item.time}</strong>
            </div>
            <div class="flex-grow-1">
              <div>${item.name}</div>
              <small class="text-muted">${item.dosage} ${item.unit}</small>
            </div>
            <div>
              <button class="btn btn-sm ${item.status === 'taken' ? 'btn-success' : 'btn-outline-success'}" 
                      onclick="markMedicineTaken(${item.id}, '${item.time}')">
                <i class="bi bi-check"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function generateMedicineTimes(frequency) {
      const times = [];
      switch (frequency) {
        case '每日一次':
          times.push('08:00');
          break;
        case '每日兩次':
          times.push('08:00', '20:00');
          break;
        case '每日三次':
          times.push('08:00', '14:00', '20:00');
          break;
        case '每日四次':
          times.push('08:00', '12:00', '16:00', '20:00');
          break;
        default:
          times.push('08:00');
      }
      return times;
    }

    function markMedicineTaken(medicineId, time) {
      showNotification(`${time} 用藥記錄已標記`, 'success');
      loadTodayMedicineSchedule();
    }

    function toggleMedicineStatus(id) {
      const medicine = systemData.medicines.find(m => m.id === id);
      if (medicine) {
        medicine.status = medicine.status === 'active' ? 'inactive' : 'active';
        loadMedicines();
        loadTodayMedicineSchedule();
        showNotification('用藥狀態已更新', 'info');
      }
    }

    function deleteMedicine(id) {
      if (confirm('確定要刪除此用藥記錄嗎？')) {
        systemData.medicines = systemData.medicines.filter(m => m.id !== id);
        loadMedicines();
        loadTodayMedicineSchedule();
        showNotification('用藥記錄已刪除', 'info');
      }
    }

    // Activities Management
    function showAddActivity() {
      document.getElementById('addActivityForm').style.display = 'block';
    }

    function hideAddActivity() {
      document.getElementById('addActivityForm').style.display = 'none';
      document.getElementById('activityForm').reset();
    }

    function handleActivity(e) {
      e.preventDefault();
      
      const activity = {
        id: Date.now(),
        title: document.getElementById('activityTitle').value,
        type: document.getElementById('activityType').value,
        date: document.getElementById('activityDate').value,
        location: document.getElementById('activityLocation').value,
        fee: document.getElementById('activityFee').value || 0,
        capacity: document.getElementById('activityCapacity').value,
        deadline: document.getElementById('activityDeadline').value,
        description: document.getElementById('activityDescription').value,
        status: 'active',
        participants: [],
        createdAt: new Date().toISOString(),
        createdBy: currentUser.id
      };
      
      systemData.activities.push(activity);
      hideAddActivity();
      loadActivities();
      showNotification('活動建立成功', 'success');
    }

    function loadActivities() {
      const container = document.getElementById('activitiesList');
      const activities = systemData.activities
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (activities.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">暫無活動</p>';
        return;
      }
      
      container.innerHTML = activities.map(activity => `
        <div class="activity-item">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h5 class="mb-2">${activity.title}</h5>
              <p class="mb-1"><i class="bi bi-calendar me-2"></i>${formatDateTime(activity.date)}</p>
              <p class="mb-1"><i class="bi bi-geo-alt me-2"></i>${activity.location}</p>
              <p class="mb-2"><i class="bi bi-people me-2"></i>${activity.participants.length}/${activity.capacity || '∞'} 人</p>
              <p class="text-muted">${activity.description}</p>
            </div>
            <div class="text-end">
              <div class="mb-2">
                <span class="status-badge status-${activity.status}">${getActivityStatus(activity.status)}</span>
              </div>
              <div class="btn-group-vertical">
                ${!activity.participants.includes(currentUser.id) ? 
                  `<button class="btn btn-sm btn-success" onclick="joinActivity(${activity.id})">
                    <i class="bi bi-person-plus me-1"></i>報名
                  </button>` : 
                  `<button class="btn btn-sm btn-warning" onclick="leaveActivity(${activity.id})">
                    <i class="bi bi-person-dash me-1"></i>取消
                  </button>`
                }
                ${isAdmin ? 
                  `<button class="btn btn-sm btn-outline-primary" onclick="editActivity(${activity.id})">
                    <i class="bi bi-pencil"></i>
                  </button>` : ''
                }
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function joinActivity(id) {
      const activity = systemData.activities.find(a => a.id === id);
      if (activity && !activity.participants.includes(currentUser.id)) {
        if (activity.capacity && activity.participants.length >= activity.capacity) {
          showNotification('活動人數已滿', 'warning');
          return;
        }
        activity.participants.push(currentUser.id);
        loadActivities();
        showNotification('報名成功！', 'success');
      }
    }

    function leaveActivity(id) {
      const activity = systemData.activities.find(a => a.id === id);
      if (activity) {
        activity.participants = activity.participants.filter(p => p !== currentUser.id);
        loadActivities();
        showNotification('已取消報名', 'info');
      }
    }

    // Volunteer Management
    function showAddVolunteer() {
      document.getElementById('addVolunteerForm').style.display = 'block';
    }

    function hideAddVolunteer() {
      document.getElementById('addVolunteerForm').style.display = 'none';
      document.getElementById('volunteerForm').reset();
    }

    function handleVolunteer(e) {
      e.preventDefault();
      
      const volunteer = {
        id: Date.now(),
        title: document.getElementById('volunteerTitle').value,
        category: document.getElementById('volunteerCategory').value,
        date: document.getElementById('volunteerDate').value,
        location: document.getElementById('volunteerLocation').value,
        hours: document.getElementById('volunteerHours').value,
        needed: document.getElementById('volunteerNeeded').value,
        deadline: document.getElementById('volunteerDeadline').value,
        description: document.getElementById('volunteerDescription').value,
        status: 'active',
        volunteers: [],
        createdAt: new Date().toISOString(),
        createdBy: currentUser.id
      };
      
      systemData.volunteers.push(volunteer);
      hideAddVolunteer();
      loadVolunteers();
      showNotification('志工需求發布成功', 'success');
    }

    function loadVolunteers() {
      const container = document.getElementById('volunteerList');
      const volunteers = systemData.volunteers
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Update stats
      const myHours = volunteers
        .filter(v => v.volunteers.includes(currentUser.id) && v.status === 'completed')
        .reduce((sum, v) => sum + parseFloat(v.hours), 0);
      document.getElementById('myVolunteerHours').textContent = myHours;
      document.getElementById('availableVolunteerJobs').textContent = volunteers.filter(v => v.status === 'active').length;
      document.getElementById('completedVolunteerJobs').textContent = volunteers.filter(v => v.volunteers.includes(currentUser.id) && v.status === 'completed').length;
      
      if (volunteers.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">暫無志工需求</p>';
        return;
      }
      
      container.innerHTML = volunteers.map(volunteer => `
        <div class="activity-item">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h5 class="mb-2">${volunteer.title}</h5>
              <p class="mb-1"><i class="bi bi-calendar me-2"></i>${formatDateTime(volunteer.date)}</p>
              <p class="mb-1"><i class="bi bi-geo-alt me-2"></i>${volunteer.location}</p>
              <p class="mb-1"><i class="bi bi-clock me-2"></i>${volunteer.hours} 小時</p>
              <p class="mb-2"><i class="bi bi-people me-2"></i>${volunteer.volunteers.length}/${volunteer.needed} 人</p>
              <p class="text-muted">${volunteer.description}</p>
            </div>
            <div class="text-end">
              <div class="mb-2">
                <span class="status-badge status-${volunteer.status}">${getVolunteerStatus(volunteer.status)}</span>
              </div>
              ${!volunteer.volunteers.includes(currentUser.id) ? 
                `<button class="btn btn-sm btn-danger" onclick="joinVolunteer(${volunteer.id})">
                  <i class="bi bi-heart me-1"></i>報名服務
                </button>` : 
                `<button class="btn btn-sm btn-warning" onclick="leaveVolunteer(${volunteer.id})">
                  <i class="bi bi-person-dash me-1"></i>取消報名
                </button>`
              }
            </div>
          </div>
        </div>
      `).join('');
    }

    function joinVolunteer(id) {
      const volunteer = systemData.volunteers.find(v => v.id === id);
      if (volunteer && !volunteer.volunteers.includes(currentUser.id)) {
        if (volunteer.volunteers.length >= volunteer.needed) {
          showNotification('志工人數已滿', 'warning');
          return;
        }
        volunteer.volunteers.push(currentUser.id);
        loadVolunteers();
        showNotification('志工報名成功！', 'success');
      }
    }

    function leaveVolunteer(id) {
      const volunteer = systemData.volunteers.find(v => v.id === id);
      if (volunteer) {
        volunteer.volunteers = volunteer.volunteers.filter(v => v !== currentUser.id);
        loadVolunteers();
        showNotification('已取消志工報名', 'info');
      }
    }

    // Financial Management
    function showAddDonation() {
      document.getElementById('addDonationForm').style.display = 'block';
    }

    function hideAddDonation() {
      document.getElementById('addDonationForm').style.display = 'none';
      document.getElementById('donationForm').reset();
    }

    function showAddExpense() {
      document.getElementById('addExpenseForm').style.display = 'block';
    }

    function hideAddExpense() {
      document.getElementById('addExpenseForm').style.display = 'none';
      document.getElementById('expenseForm').reset();
    }

    function handleDonation(e) {
      e.preventDefault();
      
      const donation = {
        id: Date.now(),
        type: 'donation',
        amount: parseFloat(document.getElementById('donationAmount').value),
        donationType: document.getElementById('donationType').value,
        date: document.getElementById('donationDate').value,
        method: document.getElementById('donationMethod').value,
        notes: document.getElementById('donationNotes').value,
        donorId: currentUser.id,
        donorName: currentUser.name,
        status: 'completed',
        createdAt: new Date().toISOString()
      };
      
      systemData.finances.push(donation);
      hideAddDonation();
      loadFinancialRecords();
      updateFinancialStats();
      showNotification('捐款記錄新增成功', 'success');
    }

    function handleExpense(e) {
      e.preventDefault();
      
      const expense = {
        id: Date.now(),
        type: 'expense',
        amount: parseFloat(document.getElementById('expenseAmount').value),
        category: document.getElementById('expenseCategory').value,
        date: document.getElementById('expenseDate').value,
        vendor: document.getElementById('expenseVendor').value,
        description: document.getElementById('expenseDescription').value,
        applicantId: currentUser.id,
        applicantName: currentUser.name,
        status: 'pending',
        createdAt: new Date().toISOString()
      };
      
      systemData.finances.push(expense);
      hideAddExpense();
      loadFinancialRecords();
      updateFinancialStats();
      showNotification('支出申請提交成功', 'success');
    }

    function loadFinancialRecords() {
      const tbody = document.getElementById('financialRecords');
      const records = systemData.finances
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">暫無財務記錄</td></tr>';
        return;
      }
      
      tbody.innerHTML = records.map(record => `
        <tr>
          <td>${formatDate(record.date)}</td>
          <td>${record.type === 'donation' ? '捐款' : '支出'}</td>
          <td class="${record.type === 'donation' ? 'text-success' : 'text-danger'}">
            ${record.type === 'donation' ? '+' : '-'}$${record.amount.toLocaleString()}
          </td>
          <td>${record.type === 'donation' ? record.donationType : record.description}</td>
          <td><span class="status-badge status-${record.status}">${getFinancialStatus(record.status)}</span></td>
          <td>
            ${isAdmin && record.status === 'pending' ? 
              `<button class="btn btn-sm btn-success me-1" onclick="approveExpense(${record.id})">
                <i class="bi bi-check"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="rejectExpense(${record.id})">
                <i class="bi bi-x"></i>
              </button>` : 
              `<button class="btn btn-sm btn-outline-primary" onclick="viewFinancialRecord(${record.id})">
                <i class="bi bi-eye"></i>
              </button>`
            }
          </td>
        </tr>
      `).join('');
    }

    function updateFinancialStats() {
      const donations = systemData.finances
        .filter(f => f.type === 'donation' && f.status === 'completed')
        .reduce((sum, f) => sum + f.amount, 0);
      
      const expenses = systemData.finances
        .filter(f => f.type === 'expense' && f.status === 'approved')
        .reduce((sum, f) => sum + f.amount, 0);
      
      document.getElementById('totalDonations').textContent = `$${donations.toLocaleString()}`;
      document.getElementById('totalExpenses').textContent = `$${expenses.toLocaleString()}`;
      document.getElementById('netBalance').textContent = `$${(donations - expenses).toLocaleString()}`;
    }

    // Feedback Management
    function showAddFeedback() {
      document.getElementById('addFeedbackForm').style.display = 'block';
      loadFeedbackActivities();
    }

    function hideAddFeedback() {
      document.getElementById('addFeedbackForm').style.display = 'none';
      document.getElementById('feedbackForm').reset();
    }

    function loadFeedbackActivities() {
      const select = document.getElementById('feedbackActivity');
      const userActivities = systemData.activities.filter(a => a.participants.includes(currentUser.id));
      
      select.innerHTML = '<option value="">選擇活動</option>' + 
        userActivities.map(activity => 
          `<option value="${activity.id}">${activity.title} - ${formatDate(activity.date)}</option>`
        ).join('');
    }

    function handleFeedback(e) {
      e.preventDefault();
      
      const feedback = {
        id: Date.now(),
        activityId: document.getElementById('feedbackActivity').value,
        userId: currentUser.id,
        userName: currentUser.name,
        rating: document.getElementById('feedbackRating').value,
        content: document.getElementById('feedbackContent').value,
        suggestion: document.getElementById('feedbackSuggestion').value,
        createdAt: new Date().toISOString()
      };
      
      systemData.feedback.push(feedback);
      hideAddFeedback();
      loadFeedback();
      showNotification('回饋提交成功', 'success');
    }

    function loadFeedback() {
      const container = document.getElementById('feedbackList');
      const feedbacks = systemData.feedback
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      if (feedbacks.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">暫無回饋記錄</p>';
        return;
      }
      
      container.innerHTML = feedbacks.map(feedback => {
        const activity = systemData.activities.find(a => a.id == feedback.activityId);
        return `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="mb-1">${activity ? activity.title : '未知活動'}</h6>
                <div class="mb-2">
                  <span class="me-2">評分：</span>
                  ${Array(5).fill().map((_, i) => 
                    `<i class="bi bi-star${i < feedback.rating ? '-fill text-warning' : ' text-muted'}"></i>`
                  ).join('')}
                </div>
                <p class="mb-2">${feedback.content}</p>
                ${feedback.suggestion ? `<p class="text-muted"><strong>建議：</strong>${feedback.suggestion}</p>` : ''}
              </div>
              <div class="text-end">
                <small class="text-muted">${formatDate(feedback.createdAt)}</small>
                <br>
                <small class="text-muted">by ${feedback.userName}</small>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Admin Functions
    function loadAdminData() {
      if (!isAdmin) return;
      
      // Update admin stats
      document.getElementById('adminTotalMembers').textContent = systemData.members.length;
      document.getElementById('adminPendingApprovals').textContent = systemData.members.filter(m => m.status === 'pending').length;
      document.getElementById('adminActiveActivities').textContent = systemData.activities.filter(a => a.status === 'active').length;
      
      const monthlyRevenue = systemData.finances
        .filter(f => f.type === 'donation' && new Date(f.date).getMonth() === new Date().getMonth())
        .reduce((sum, f) => sum + f.amount, 0);
      document.getElementById('adminMonthlyRevenue').textContent = `$${monthlyRevenue.toLocaleString()}`;
      
      loadAdminMembers();
    }

    function loadAdminMembers() {
      const tbody = document.getElementById('adminMembersList');
      const members = systemData.members
        .sort((a, b) => new Date(b.registrationDate) - new Date(a.registrationDate));
      
      tbody.innerHTML = members.map(member => `
        <tr>
          <td>${member.name}</td>
          <td>${member.memberType}</td>
          <td>${member.phone}</td>
          <td>${formatDate(member.registrationDate)}</td>
          <td><span class="status-badge status-${member.status}">${getMemberStatus(member.status)}</span></td>
          <td>
            ${member.status === 'pending' ? 
              `<button class="btn btn-sm btn-success me-1" onclick="approveMember(${member.id})">
                <i class="bi bi-check"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="rejectMember(${member.id})">
                <i class="bi bi-x"></i>
              </button>` : 
              `<button class="btn btn-sm btn-outline-primary" onclick="viewMember(${member.id})">
                <i class="bi bi-eye"></i>
              </button>`
            }
          </td>
        </tr>
      `).join('');
    }

    function handleSystemSettings(e) {
      e.preventDefault();
      showNotification('系統設定已保存', 'success');
    }

    // Utility Functions
    function showTab(tabName) {
      const tab = document.querySelector(`[data-bs-target="#${tabName}"]`);
      if (tab) {
        tab.click();
      }
    }

    function refreshData() {
      loadDashboard();
      showNotification('資料已刷新', 'info');
    }

    function showNotification(message, type = 'info') {
      const container = document.getElementById('notificationContainer');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
          <span>${message}</span>
          <button class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
      `;
      
      container.appendChild(notification);
      
      setTimeout(() => notification.classList.add('show'), 100);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('zh-TW');
    }

    function formatDateTime(dateString) {
      return new Date(dateString).toLocaleString('zh-TW');
    }

    function getActivityStatus(status) {
      const statusMap = {
        'active': '進行中',
        'completed': '已結束',
        'cancelled': '已取消'
      };
      return statusMap[status] || status;
    }

    function getMedicineStatus(status) {
      const statusMap = {
        'active': '使用中',
        'inactive': '已停用',
        'completed': '已完成'
      };
      return statusMap[status] || status;
    }

    function getVolunteerStatus(status) {
      const statusMap = {
        'active': '招募中',
        'completed': '已完成',
        'cancelled': '已取消'
      };
      return statusMap[status] || status;
    }

    function getFinancialStatus(status) {
      const statusMap = {
        'completed': '已完成',
        'pending': '待審核',
        'approved': '已核准',
        'rejected': '已拒絕'
      };
      return statusMap[status] || status;
    }

    function getMemberStatus(status) {
      const statusMap = {
        'approved': '已核准',
        'pending': '待審核',
        'rejected': '已拒絕',
        'suspended': '已停權'
      };
      return statusMap[status] || status;
    }

    // Sample Data Loading
    function loadSampleData() {
      // Sample members
      systemData.members = [
        {
          id: 1,
          name: '王大明',
          phone: '0912345678',
          email: 'wang@example.com',
          memberType: '病友',
          password: '123456',
          lineId: '',
          lineName: '',
          registrationDate: '2024-01-15',
          status: 'approved',
          role: 'member'
        },
        {
          id: 2,
          name: '李小華',
          phone: '0987654321',
          email: 'li@example.com',
          memberType: '家屬',
          password: '123456',
          lineId: '',
          lineName: '',
          registrationDate: '2024-02-20',
          status: 'approved',
          role: 'member'
        },
        {
          id: 999,
          name: '系統管理員',
          phone: 'admin',
          email: 'admin@example.com',
          memberType: '管理員',
          password: 'admin',
          lineId: '',
          lineName: '',
          registrationDate: '2024-01-01',
          status: 'approved',
          role: 'admin'
        }
      ];

      // Sample activities
      systemData.activities = [
        {
          id: 1,
          title: '帕金森病友健康講座',
          type: '講座',
          date: '2024-12-15T14:00',
          location: '社區活動中心',
          fee: 0,
          capacity: 50,
          deadline: '2024-12-10',
          description: '邀請專業醫師分享帕金森病的日常照護知識',
          status: 'active',
          participants: [1, 2],
          createdAt: '2024-11-01T10:00:00Z',
          createdBy: 999
        },
        {
          id: 2,
          title: '太極拳運動課程',
          type: '運動',
          date: '2024-12-20T09:00',
          location: '公園廣場',
          fee: 100,
          capacity: 20,
          deadline: '2024-12-15',
          description: '適合帕金森病友的溫和運動課程',
          status: 'active',
          participants: [1],
          createdAt: '2024-11-05T15:30:00Z',
          createdBy: 999
        }
      ];

      // Sample health records
      systemData.healthRecords = [
        {
          id: 1,
          userId: 1,
          date: '2024-11-25T08:00',
          type: '血壓',
          value1: 130,
          value2: 85,
          unit: 'mmHg',
          notes: '早晨測量',
          createdAt: '2024-11-25T08:05:00Z'
        },
        {
          id: 2,
          userId: 1,
          date: '2024-11-24T08:00',
          type: '血壓',
          value1: 125,
          value2: 80,
          unit: 'mmHg',
          notes: '正常',
          createdAt: '2024-11-24T08:05:00Z'
        }
      ];

      // Sample medicines
      systemData.medicines = [
        {
          id: 1,
          userId: 1,
          name: '左旋多巴',
          type: '口服藥',
          dosage: 1,
          unit: '錠',
          frequency: '每日三次',
          startDate: '2024-11-01',
          endDate: '',
          notes: '飯前服用',
          status: 'active',
          createdAt: '2024-11-01T10:00:00Z'
        }
      ];

      // Sample volunteers
      systemData.volunteers = [
        {
          id: 1,
          title: '活動場地布置協助',
          category: '活動協助',
          date: '2024-12-14T13:00',
          location: '社區活動中心',
          hours: 3,
          needed: 5,
          deadline: '2024-12-12',
          description: '協助講座場地布置與設備準備',
          status: 'active',
          volunteers: [2],
          createdAt: '2024-11-20T10:00:00Z',
          createdBy: 999
        }
      ];

      // Sample finances
      systemData.finances = [
        {
          id: 1,
          type: 'donation',
          amount: 5000,
          donationType: '一般捐款',
          date: '2024-11-20',
          method: '轉帳',
          notes: '支持病友會活動',
          donorId: 1,
          donorName: '王大明',
          status: 'completed',
          createdAt: '2024-11-20T14:00:00Z'
        },
        {
          id: 2,
          type: 'expense',
          amount: 2000,
          category: '活動費用',
          date: '2024-11-22',
          vendor: '講師費',
          description: '健康講座講師費用',
          applicantId: 999,
          applicantName: '系統管理員',
          status: 'approved',
          createdAt: '2024-11-22T10:00:00Z'
        }
      ];

      // Sample feedback
      systemData.feedback = [
        {
          id: 1,
          activityId: 1,
          userId: 1,
          userName: '王大明',
          rating: 5,
          content: '講座內容很實用，講師解說清楚易懂',
          suggestion: '希望能增加更多實作演練',
          createdAt: '2024-11-25T16:00:00Z'
        }
      ];

      // Initialize data after loading
      setTimeout(() => {
        if (currentUser) {
          loadDashboard();
          loadHealthRecords();
          loadMedicines();
          loadTodayMedicineSchedule();
          loadActivities();
          loadVolunteers();
          loadFinancialRecords();
          updateFinancialStats();
          loadFeedback();
          
          if (isAdmin) {
            loadAdminData();
          }
        }
      }, 1000);
    }

    // Initialize Chart.js if available
    if (typeof Chart !== 'undefined') {
      Chart.defaults.font.family = "'Noto Sans TC', sans-serif";
      Chart.defaults.color = '#6c757d';
    }
  </script>

  <!-- Notification Container -->
  <div id="notificationContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
