<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>帕金森病友會管理系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    html{font-size:16px;}
    body{font-family:'Segoe UI',system-ui,sans-serif;background:#f1f3f9;margin:0;min-height:100vh;color:#2d3748;}
    @media (max-width:480px){ html{font-size:17px;} .btn{font-size:.95rem;} }
    a{text-decoration:none}
    .login-wrapper{max-width:420px;margin:40px auto;padding:30px;background:#fff;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.1);}
    .app-shell{display:none;}
    .topbar{display:flex;align-items:center;gap:12px;padding:10px 16px;background:#fff;border-bottom:1px solid #e2e8f0;position:sticky;top:0;z-index:100;}
    .avatar{width:40px;height:40px;border-radius:50%;background:#4CAF50;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;}
    .nav-pills .nav-link{font-weight:600;}
    .content-area{padding:16px;max-width:1200px;margin:0 auto;}
    .stat-card{border-radius:14px;padding:18px;color:#fff;box-shadow:0 4px 15px rgba(0,0,0,.12);text-align:center;}
    .stat-card h3{margin:0 0 6px;font-size:1.6rem;font-weight:700;}
    .status-badge{display:inline-block;padding:5px 10px;border-radius:14px;font-size:12px;font-weight:600;}
    .status-開放報名{background:#d4edda;color:#155724;}
    .status-已報名{background:#d1ecf1;color:#0c5460;}
    .status-已取消,.status-已拒絕{background:#f8d7da;color:#721c24;}
    .status-已完成{background:#e2e3ff;color:#383d41;}
    .status-審核中{background:#fff3cd;color:#856404;}
    .notification{position:fixed;top:20px;right:20px;z-index:2000;background:#fff;padding:14px 18px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.15);transform:translateX(380px);transition:.4s;}
    .notification.show{transform:translateX(0);}
    .notification.success{border-left:4px solid #4CAF50;}
    .notification.error{border-left:4px solid #dc3545;}
    .shortcut-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));}
    .shortcut{background:#fff;border:1px solid #e2e8f0;padding:16px;border-radius:16px;text-align:center;font-weight:600;cursor:pointer;transition:.3s;}
    .shortcut:hover{border-color:#4CAF50;color:#4CAF50;box-shadow:0 8px 18px rgba(76,175,80,.25);}
    .section-card{background:#fff;border-radius:16px;padding:20px;margin-bottom:18px;box-shadow:0 4px 18px rgba(0,0,0,.08);}
    .activity-item{background:#f8fafc;border-radius:12px;padding:14px 16px;margin-bottom:12px;border-left:4px solid #4CAF50;}
    .btn-gradient{background:linear-gradient(135deg,#4CAF50,#45a049);color:#fff;border:none;}
    .btn-gradient:hover{background:linear-gradient(135deg,#45a049,#3d8b40);}
    .login-tabs .nav-link{font-weight:600;}
    .small-link{font-size:.85rem;cursor:pointer;color:#4CAF50;}
  </style>
</head>
<body>
  <div id="notificationContainer"></div>

  <div id="loginView" class="login-wrapper">
    <h3 class="mb-3 text-center"><i class="bi bi-hospital me-2"></i>帕金森病友會</h3>
    <ul class="nav nav-pills mb-3 login-tabs" id="loginTab" role="tablist">
      <li class="nav-item flex-fill" role="presentation">
        <button class="nav-link active w-100" data-bs-toggle="pill" data-bs-target="#loginLine">LINE 登入</button>
      </li>
      <li class="nav-item flex-fill" role="presentation">
        <button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#loginPhone">電話登入</button>
      </li>
      <li class="nav-item flex-fill" role="presentation">
        <button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#registerPhone">電話註冊</button>
      </li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="loginLine">
        <p class="text-muted small">使用 LINE 快速登入（首次需填寫姓名）。</p>
        <button class="btn btn-gradient w-100 mb-2" onclick="loginWithLINE()"><i class="bi bi-line me-1"></i> 使用 LINE 登入</button>
      </div>
      <div class="tab-pane fade" id="loginPhone">
        <form id="phoneLoginForm" class="mt-2">
          <div class="form-floating mb-2">
            <input type="text" id="loginPhoneInput" class="form-control" placeholder="電話或留空改用姓名">
            <label for="loginPhoneInput">電話 (或留空改用姓名)</label>
          </div>
          <div class="form-floating mb-2">
            <input type="text" id="loginRealNameInput" class="form-control" placeholder="姓名">
            <label for="loginRealNameInput">姓名 (電話留空時必填)</label>
          </div>
          <div class="form-floating mb-3">
            <input type="password" id="loginPasswordInput" class="form-control" placeholder="密碼" required>
            <label for="loginPasswordInput">密碼 *</label>
          </div>
          <button class="btn btn-gradient w-100" type="submit">登入</button>
        </form>
      </div>
      <div class="tab-pane fade" id="registerPhone">
        <form id="phoneRegisterForm" class="mt-2">
          <div class="form-floating mb-2">
            <input type="text" id="regPhoneInput" class="form-control" required>
            <label for="regPhoneInput">電話 *</label>
          </div>
          <div class="form-floating mb-2">
            <input type="text" id="regRealNameInput" class="form-control" required>
            <label for="regRealNameInput">真實姓名 *</label>
          </div>
          <div class="form-floating mb-3">
            <input type="password" id="regPasswordInput" class="form-control" required>
            <label for="regPasswordInput">密碼 *</label>
          </div>
          <button class="btn btn-gradient w-100" type="submit">註冊並登入</button>
        </form>
      </div>
    </div>
  </div>

  <div id="appShell" class="app-shell">
    <div class="topbar">
      <div class="avatar" id="avatarBox">?</div>
      <div style="flex:1;">
        <div id="topUserName" class="fw-bold"></div>
        <small id="topUserRole" class="text-muted"></small>
      </div>
      <button class="btn btn-sm btn-outline-secondary" onclick="logout()"><i class="bi bi-box-arrow-right"></i></button>
    </div>

    <div class="content-area">
      <ul class="nav nav-pills mb-3 flex-wrap" id="mainTabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tabDashboard">🏠 儀表板</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabProfile">👤 個人</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabActivities">🎪 活動</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabVolunteer">🤝 志工</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabFinance">💰 財務</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabFeedback">💬 回饋</button></li>
        <li class="nav-item admin-only" style="display:none;"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabAdmin">⚙️ 管理</button></li>
      </ul>

      <div class="tab-content">
        <div class="tab-pane fade show active" id="tabDashboard">
          <div class="section-card">
            <h5 class="mb-3">快速功能</h5>
            <div class="shortcut-grid mb-3">
              <div class="shortcut" onclick="showTab('tabProfile')"><i class="bi bi-person"></i><br>資料</div>
              <div class="shortcut" onclick="showNewDonationModal()"><i class="bi bi-heart-fill"></i><br>捐款</div>
              <div class="shortcut" onclick="showTab('tabActivities')"><i class="bi bi-calendar-event"></i><br>活動</div>
              <div class="shortcut" onclick="showTab('tabVolunteer')"><i class="bi bi-hand-thumbs-up"></i><br>志工</div>
            </div>
            <div id="dashboardStats" class="row g-3"></div>
            <hr>
            <h6>最近活動</h6>
            <div id="recentActivity"></div>
          </div>
        </div>

        <div class="tab-pane fade" id="tabProfile">
          <div class="section-card">
            <h5>個人資料</h5>
            <form id="profileForm" class="row g-3 mt-1">
              <div class="col-md-4">
                <div class="form-floating">
                  <input class="form-control" id="pfRealName" readonly>
                  <label>姓名</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input class="form-control" id="pfPhone">
                  <label>電話</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input class="form-control" id="pfEmail" type="email">
                  <label>Email</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input class="form-control" id="pfBirthday" type="date">
                  <label>生日</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <select class="form-select" id="pfMemberType">
                    <option value="病友">病友</option>
                    <option value="家屬">家屬</option>
                    <option value="志工">志工</option>
                    <option value="醫護">醫護人員</option>
                    <option value="支持者">支持者</option>
                  </select>
                  <label>會員類別</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <textarea id="pfAddress" class="form-control" style="height:80px;"></textarea>
                  <label>地址</label>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-gradient" type="submit">更新</button>
              </div>
            </form>
          </div>
        </div>

        <div class="tab-pane fade" id="tabActivities">
          <div class="section-card">
            <div class="d-flex justify-content-between">
              <h5>活動列表</h5>
              <button class="btn btn-sm btn-success admin-only" style="display:none;" onclick="showNewActivityModal()">新增活動</button>
            </div>
            <div id="activitiesList" class="mt-3"></div>
            <hr>
            <h6>我的報名</h6>
            <div id="myRegistrations"></div>
          </div>
        </div>

        <div class="tab-pane fade" id="tabVolunteer">
          <div class="section-card">
            <div class="d-flex justify-content-between">
              <h5>志工服務</h5>
              <button class="btn btn-sm btn-success admin-only" style="display:none;" onclick="showNewVolunteerNeedModal()">新增需求</button>
            </div>
            <div id="volunteerStats" class="row g-3 my-2"></div>
            <h6>志工需求</h6>
            <div id="volunteerNeeds"></div>
            <hr>
            <h6>我的志工記錄</h6>
            <div id="myVolunteerRecords"></div>
          </div>
        </div>

        <div class="tab-pane fade" id="tabFinance">
          <div class="section-card">
            <div class="d-flex justify-content-between align-items-center">
              <h5>財務</h5>
              <div>
                <button class="btn btn-sm btn-success me-2" onclick="showNewDonationModal()">捐款</button>
                <button class="btn btn-sm btn-warning" onclick="showNewExpenseModal()">支出申請</button>
              </div>
            </div>
            <div id="financeStats" class="row g-3 my-2"></div>
            <h6>捐款紀錄</h6>
            <div id="donationHistory"></div>
            <hr>
            <h6>支出申請</h6>
            <div id="expenseHistory"></div>
            <div class="admin-only mt-4" style="display:none;">
              <h6>管理員統計</h6>
              <div id="adminFinanceStats" class="row g-3"></div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="tabFeedback">
          <div class="section-card">
            <h5>活動回饋</h5>
            <form id="feedbackForm" class="row g-3 mt-1">
              <div class="col-md-6">
                <div class="form-floating">
                  <select id="fbActivity" class="form-select" required></select>
                  <label>活動 *</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <select id="fbRating" class="form-select" required>
                    <option value="">評分</option>
                    <option value="5">5</option><option value="4">4</option>
                    <option value="3">3</option><option value="2">2</option>
                    <option value="1">1</option>
                  </select>
                  <label>評分 *</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <textarea id="fbComment" class="form-control" style="height:90px;" required></textarea>
                  <label>意見 *</label>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-gradient" type="submit">提交</button>
              </div>
            </form>
            <hr>
            <h6>我的回饋</h6>
            <div id="myFeedback"></div>
            <div class="admin-only mt-4" style="display:none;">
              <h6>全部回饋</h6>
              <div id="allFeedback"></div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="tabAdmin">
          <div class="section-card">
            <h5>管理面板</h5>
            <p class="text-muted small">（可再擴充：提案審查 / 投票管理 / 憑證審核）</p>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button class="btn btn-sm btn-outline-primary" onclick="exportMembers()">匯出會員</button>
              <button class="btn btn-sm btn-outline-primary" onclick="exportFinanceData()">匯出財務</button>
              <button class="btn btn-sm btn-outline-warning" onclick="backupSystem()">備份</button>
            </div>
            <h6>收據列表</h6>
            <div id="receiptList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modalContainer"></div>

  <script>
    const CONFIG = {
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycbxJ-3LYJPlHGLv8DYHzIb3HpTrt6dpwPdFcOhEmdTw9bHvMvxcmUPypV9rqN7xWRRVF/exec',
      API_KEY: 'AAbb8520258185202581',
      LIFF_ID: '1656516134-VaGgmaPm'
    };
    let currentUser=null;
    let isAdmin=false;
    let lineProfile=null;
    let allActivities=[];

    function showNotification(msg,type='success',ms=3000){
      const wrap=document.getElementById('notificationContainer');
      const el=document.createElement('div');
      el.className='notification '+type;
      el.innerHTML=\`<div class="d-flex justify-content-between align-items-start">
        <div>\${msg}</div>
        <button style="background:none;border:none;font-size:18px;line-height:1;" onclick="this.closest('.notification').remove()">&times;</button>
      </div>\`;
      wrap.appendChild(el);
      requestAnimationFrame(()=>el.classList.add('show'));
      setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),350); },ms);
    }

    async function callAPI(action,data={}){
      const payload={ action, apiKey:CONFIG.API_KEY, ...data };
      const res=await fetch(CONFIG.API_BASE_URL,{ method:'POST', body:JSON.stringify(payload) });
      const text=await res.text();
      let json; try{ json=JSON.parse(text);}catch(e){throw new Error('非 JSON 回應:'+text);}
      if(!json.success) throw new Error(json.message||'API 錯誤');
      return json;
    }

    // ========== 登入流程 ==========
    async function tryAutoLogin(){
      const token=localStorage.getItem('sessionToken');
      if(token){
        try{
          const r=await callAPI('getUserInfo',{ sessionToken:token });
          currentUser=r.data; isAdmin=!!currentUser.isAdmin;
          afterLogin();
          return;
        }catch(e){
          localStorage.removeItem('sessionToken');
        }
      }
    }

    async function loginWithLINE(){
      try{
        if(!lineProfile){
          await liff.init({ liffId:CONFIG.LIFF_ID });
          if(!liff.isLoggedIn()){ liff.login(); return; }
          lineProfile=await liff.getProfile();
        }
        // 試著取得 userInfo
        try{
          const r=await callAPI('getUserInfo',{ lineId:lineProfile.userId });
          currentUser=r.data; isAdmin=!!currentUser.isAdmin;
          afterLogin();
        }catch(e){
          // 未註冊 → 自動註冊只需名稱
          const rn=prompt('首次使用，請輸入真實姓名：', lineProfile.displayName||'');
          if(!rn){ showNotification('未輸入姓名，登入取消','warning'); return; }
          await callAPI('registerUser',{ lineId:lineProfile.userId, lineName:lineProfile.displayName, realName:rn });
          const r2=await callAPI('getUserInfo',{ lineId:lineProfile.userId });
          currentUser=r2.data; isAdmin=!!currentUser.isAdmin;
          afterLogin();
        }
      }catch(err){
        showNotification('LINE 登入失敗:'+err.message,'error');
      }
    }

    document.getElementById('phoneLoginForm').addEventListener('submit', async e=>{
      e.preventDefault();
      try{
        const phone=document.getElementById('loginPhoneInput').value.trim();
        const realName=document.getElementById('loginRealNameInput').value.trim();
        const password=document.getElementById('loginPasswordInput').value;
        if(!phone && !realName){ showNotification('需輸入電話或姓名','warning'); return; }
        const r=await callAPI('phoneLogin',{ phone:phone||undefined, realName:realName||undefined, password });
        localStorage.setItem('sessionToken', r.data.sessionToken);
        const info=await callAPI('getUserInfo',{ sessionToken:r.data.sessionToken });
        currentUser=info.data; isAdmin=!!currentUser.isAdmin;
        afterLogin();
      }catch(err){
        showNotification('登入失敗：'+err.message,'error');
      }
    });

    document.getElementById('phoneRegisterForm').addEventListener('submit', async e=>{
      e.preventDefault();
      try{
        const phone=document.getElementById('regPhoneInput').value.trim();
        const realName=document.getElementById('regRealNameInput').value.trim();
        const password=document.getElementById('regPasswordInput').value;
        const r=await callAPI('phoneRegister',{ phone, realName, password });
        localStorage.setItem('sessionToken', r.data.sessionToken);
        const info=await callAPI('getUserInfo',{ sessionToken:r.data.sessionToken });
        currentUser=info.data; isAdmin=!!currentUser.isAdmin;
        afterLogin();
      }catch(err){
        showNotification('註冊失敗：'+err.message,'error');
      }
    });

    function afterLogin(){
      document.getElementById('loginView').style.display='none';
      document.getElementById('appShell').style.display='block';
      renderUserTop();
      loadAllInitial();
    }

    function renderUserTop(){
      const name=currentUser.realName || currentUser.lineName || '會員';
      document.getElementById('avatarBox').textContent=name.charAt(0);
      document.getElementById('topUserName').textContent=name;
      document.getElementById('topUserRole').textContent=currentUser.memberType||'會員';
      document.querySelectorAll('.admin-only').forEach(el=> el.style.display=isAdmin?'block':'none');
      fillProfileForm();
    }

    function logout(){
      localStorage.removeItem('sessionToken');
      location.reload();
    }

    // ========== Profile ==========
    function fillProfileForm(){
      document.getElementById('pfRealName').value=currentUser.realName||'';
      document.getElementById('pfPhone').value=currentUser.phone||'';
      document.getElementById('pfEmail').value=currentUser.email||'';
      document.getElementById('pfBirthday').value=currentUser.birthday||'';
      document.getElementById('pfMemberType').value=currentUser.memberType||'病友';
      document.getElementById('pfAddress').value=currentUser.address||'';
    }

    document.getElementById('profileForm').addEventListener('submit', async e=>{
      e.preventDefault();
      try{
        await callAPI('updateProfile',{
          lineId: currentUser.lineId,
          phone:document.getElementById('pfPhone').value.trim(),
          email:document.getElementById('pfEmail').value.trim(),
          birthday:document.getElementById('pfBirthday').value,
          memberType:document.getElementById('pfMemberType').value,
          address:document.getElementById('pfAddress').value
        });
        showNotification('更新成功','success');
        const info=await callAPI('getUserInfo',{ lineId:currentUser.lineId });
        currentUser=info.data;
        renderUserTop();
      }catch(err){
        showNotification('更新失敗：'+err.message,'error');
      }
    });

    // ========== Dashboard ==========
    async function loadDashboard(){
      try{
        const r=await callAPI('getDashboardData',{ lineId: currentUser.lineId });
        const d=r.data;
        document.getElementById('dashboardStats').innerHTML=\`
          <div class="col-6 col-md-3"><div class="stat-card" style="background:#4CAF50;"><h3>\${d.totalActivities}</h3><p class="mb-0">可報名活動</p></div></div>
          <div class="col-6 col-md-3"><div class="stat-card" style="background:#17a2b8;"><h3>\${d.myRegistrations}</h3><p class="mb-0">我的報名</p></div></div>
          <div class="col-6 col-md-3"><div class="stat-card" style="background:#ff9800;"><h3>\${d.myVolunteerHours}</h3><p class="mb-0">志工時數</p></div></div>
          <div class="col-6 col-md-3"><div class="stat-card" style="background:#e91e63;"><h3>\${(d.myDonationAmount||0)}</h3><p class="mb-0">捐款總額</p></div></div>\`;
        const ra=document.getElementById('recentActivity');
        ra.innerHTML=d.recentActivity.map(a=>\`
          <div class="activity-item">
            <div class="d-flex justify-content-between">
              <div><strong>\${a.title}</strong><div class="small text-muted">\${a.description||''}</div></div>
              <span class="status-badge status-\${a.status}">\${a.status}</span>
            </div>
          </div>\`).join('') || '<div class="text-muted small">無</div>';
      }catch(err){
        showNotification('Dashboard 載入失敗:'+err.message,'error');
      }
    }

    // ========== Activities ==========
    async function loadActivities(){
      try{
        const r=await callAPI('getActivities',{});
        allActivities=r.data||[];
        renderActivities();
        loadMyRegistrations();
      }catch(err){
        document.getElementById('activitiesList').innerHTML='<div class="text-danger">載入失敗</div>';
      }
    }
    function renderActivities(){
      const c=document.getElementById('activitiesList');
      if(!allActivities.length){ c.innerHTML='<div class="text-muted small">無活動</div>'; return; }
      c.innerHTML=allActivities.map(a=>\`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>\${a.title}</strong>
              <div class="small text-muted">\${a.date} / \${a.location||''}</div>
            </div>
            <div class="text-end">
              <span class="status-badge status-\${a.status}">\${a.status}</span><br>
              \${a.status==='開放報名' ? '<button class="btn btn-sm btn-gradient mt-1" onclick="registerActivity(\\'\'+a.id+'\\')">報名</button>':''}
            </div>
          </div>
        </div>\`).join('');
    }
    async function registerActivity(id){
      try{
        await callAPI('registerActivity',{ lineId:currentUser.lineId, activityId:id });
        showNotification('報名成功','success');
        loadActivities();
      }catch(err){
        showNotification('報名失敗:'+err.message,'error');
      }
    }
    async function loadMyRegistrations(){
      try{
        const r=await callAPI('getMyRegistrations',{ lineId:currentUser.lineId });
        const c=document.getElementById('myRegistrations');
        if(!r.data.length){ c.innerHTML='<div class="text-muted small">尚無報名</div>';return;}
        c.innerHTML=r.data.map(rg=>\`
          <div class="activity-item d-flex justify-content-between">
            <div><strong>\${rg.activityTitle}</strong><div class="small text-muted">\${rg.status}</div></div>
            \${rg.status==='已報名'?'<button class="btn btn-sm btn-outline-danger" onclick="cancelRegistration(\\'\'+rg.id+'\\')">取消</button>':''}
          </div>\`).join('');
      }catch{}
    }
    async function cancelRegistration(regId){
      if(!confirm('確定取消?')) return;
      try{
        await callAPI('cancelRegistration',{ lineId:currentUser.lineId, registrationId:regId });
        showNotification('已取消','success');
        loadMyRegistrations();
        loadActivities();
      }catch(err){
        showNotification('取消失敗:'+err.message,'error');
      }
    }

    // ========== Volunteer ==========
    async function loadVolunteer(){
      try{
        const r=await callAPI('getVolunteerData',{ lineId:currentUser.lineId });
        const s=r.data.stats;
          document.getElementById('volunteerStats').innerHTML=\`
          <div class="col-6 col-md-3"><div class="stat-card" style="background:#17a2b8;"><h3>\${s.totalHours}</h3><p>時數</p></div></div>
          <div class="col-6 col-md-3"><div class="stat-card" style="background:#ff9800;"><h3>\${s.totalActivities}</h3><p>次數</p></div></div>
          <div class="col-6 col-md-3"><div class="stat-card" style="background:#4CAF50;"><h3>\${s.rank}</h3><p>排名</p></div></div>
          <div class="col-6 col-md-3"><div class="stat-card" style="background:#e91e63;"><h3>\${s.availableNeeds}</h3><p>開放</p></div></div>\`;
        const needs=document.getElementById('volunteerNeeds');
        needs.innerHTML=r.data.needs.map(n=>\`
          <div class="activity-item d-flex justify-content-between">
            <div><strong>\${n.title}</strong><div class="small text-muted">\${n.date} / \${n.currentCount}/\${n.needCount}</div></div>
            \${n.status==='開放報名'?'<button class="btn btn-sm btn-gradient" onclick="applyVolunteer(\\'\'+n.id+'\\')">報名</button>':''}
          </div>\`).join('') || '<div class="text-muted small">無需求</div>';
        const rec=document.getElementById('myVolunteerRecords');
        rec.innerHTML=r.data.records.map(rg=>\`
          <div class="activity-item d-flex justify-content-between">
            <div><strong>\${rg.title}</strong><div class="small text-muted">\${rg.date} / \${rg.hours}h</div></div>
            <span class="status-badge status-\${rg.status}">\${rg.status}</span>
          </div>\`).join('') || '<div class="text-muted small">尚無記錄</div>';
      }catch(err){
        showNotification('志工載入失敗:'+err.message,'error');
      }
    }
    async function applyVolunteer(id){
      try{
        await callAPI('applyVolunteer',{ lineId:currentUser.lineId, needId:id });
        showNotification('報名成功','success');
        loadVolunteer();
      }catch(err){ showNotification('失敗:'+err.message,'error'); }
    }

    // ========== Finance ==========
    async function loadFinance(){
      try{
        const r=await callAPI('getFinanceData',{ lineId:currentUser.lineId });
        const s=r.data.stats;
        document.getElementById('financeStats').innerHTML=\`
          <div class="col-6 col-md-3"><div class="stat-card" style="background:#4CAF50;"><h3>\${s.totalDonation}</h3><p>捐款</p></div></div>
          <div class="col-6 col-md-3"><div class="stat-card" style="background:#17a2b8;"><h3>\${s.donationCount}</h3><p>次數</p></div></div>
          <div class="col-6 col-md-3"><div class="stat-card" style="background:#ff9800;"><h3>\${s.totalExpense}</h3><p>支出</p></div></div>
          <div class="col-6 col-md-3"><div class="stat-card" style="background:#e91e63;"><h3>\${s.pendingExpenses}</h3><p>待審核</p></div></div>\`;
        const don=document.getElementById('donationHistory');
        don.innerHTML=r.data.donations.map(d=>\`
          <div class="activity-item d-flex justify-content-between">
            <div><strong>捐款-\${d.category}</strong><div class="small text-muted">\${d.description||''}</div></div>
            <div class="text-end">\${d.amount}<br><small>\${d.receiptNumber||''}</small></div>
          </div>\`).join('') || '<div class="text-muted small">無捐款</div>';
        const exp=document.getElementById('expenseHistory');
        exp.innerHTML=r.data.expenses.map(e=>\`
          <div class="activity-item d-flex justify-content-between">
            <div><strong>支出-\${e.category}</strong><div class="small text-muted">\${e.description||''}</div></div>
            <span class="status-badge status-\${e.status}">\${e.status}</span>
          </div>\`).join('') || '<div class="text-muted small">無支出</div>';

        if(isAdmin){
          const ad=document.getElementById('adminFinanceStats');
          const a=r.data.adminStats;
          ad.innerHTML=\`
            <div class="col-6 col-md-3"><div class="stat-card" style="background:#4CAF50;"><h3>\${a.totalIncome}</h3><p>總收入</p></div></div>
            <div class="col-6 col-md-3"><div class="stat-card" style="background:#e91e63;"><h3>\${a.totalExpense}</h3><p>總支出</p></div></div>
            <div class="col-6 col-md-3"><div class="stat-card" style="background:#17a2b8;"><h3>\${a.currentBalance}</h3><p>餘額</p></div></div>
            <div class="col-6 col-md-3"><div class="stat-card" style="background:#ff9800;"><h3>\${a.monthlyDonations}</h3><p>本月捐款</p></div></div>\`;
        }
      }catch(err){
        showNotification('財務載入失敗:'+err.message,'error');
      }
    }

    // ========== Feedback ==========
    async function loadFeedback(){
      try{
        const acts=await callAPI('getMyCompletedActivities',{ lineId:currentUser.lineId });
        const sel=document.getElementById('fbActivity');
        sel.innerHTML='<option value="">選擇活動</option>'+acts.data.map(a=>\`<option value="\${a.id}">\${a.title}</option>\`).join('');
        const mine=await callAPI('getMyFeedback',{ lineId:currentUser.lineId });
        renderFeedbackList('myFeedback', mine.data);
        if(isAdmin){
          const all=await callAPI('getAllFeedback',{ lineId:currentUser.lineId });
          renderFeedbackList('allFeedback', all.data,true);
        }
      }catch(err){ showNotification('回饋載入失敗:'+err.message,'error'); }
    }
    function renderFeedbackList(id,list,isAll){
      const c=document.getElementById(id);
      if(!list.length){ c.innerHTML='<div class="text-muted small">無</div>'; return; }
      c.innerHTML=list.map(f=>\`
        <div class="activity-item">
          <strong>\${f.activityTitle}</strong>
          <div class="small">\${'★'.repeat(f.rating)}\${'☆'.repeat(5-f.rating)}</div>
          <div class="small text-muted">\${f.comment}</div>
          \${isAll?'<div class="small text-muted">'+f.lineId+'</div>':''}
        </div>\`).join('');
    }
    document.getElementById('feedbackForm').addEventListener('submit', async e=>{
      e.preventDefault();
      try{
        await callAPI('createFeedback',{
          lineId:currentUser.lineId,
          activityId:document.getElementById('fbActivity').value,
          rating:document.getElementById('fbRating').value,
          comment:document.getElementById('fbComment').value
        });
        showNotification('已提交','success');
        loadFeedback();
        e.target.reset();
      }catch(err){ showNotification('提交失敗:'+err.message,'error'); }
    });

    // ========== Receipts (Admin簡化顯示) ==========
    async function loadReceipts(){
      if(!isAdmin) return;
      try{
        const r=await callAPI('getMyReceipts',{ lineId:currentUser.lineId }); // 可改為 admin 列出全部
        const c=document.getElementById('receiptList');
        if(!r.data.length){ c.innerHTML='<div class="text-muted small">無</div>';return;}
        c.innerHTML = r.data.map(rc => `
          <div class="activity-item d-flex justify-content-between">
            <div>
              <strong>${rc.type || '收據'} - ${rc.receiptNumber}</strong>
              <div class="small text-muted">
                金額：${rc.amount} | 狀態：${rc.status || ''} ${rc.emailSent ? ' | 已寄出' : ''}
              </div>
            </div>
            <div class="text-end">
              ${rc.pdfUrl ? `<a href="${rc.pdfUrl}" target="_blank" class="btn btn-sm btn-outline-primary">PDF</a>`:''}
            </div>
          </div>
        `).join('');
      }catch(err){
        showNotification('收據載入失敗：'+err.message,'error');
      }
    }

    // ========== 通用工具：顯示 / 切換分頁 ==========
    function showTab(tabId){
      const triggerEl = document.querySelector(`[data-bs-target="#${tabId}"]`);
      if(triggerEl){
        const tab = new bootstrap.Tab(triggerEl);
        tab.show();
      }
      window.scrollTo({ top:0, behavior:'smooth' });
    }

    // ========== 通用 Modal 生成 ==========
    function showFormModal(opts){
      // opts: { id, title, bodyHTML, onSubmit(formEl, close), submitText, size }
      const id = opts.id || ('m_'+Date.now());
      const exist = document.getElementById(id);
      if(exist) exist.remove();
      const wrap = document.getElementById('modalContainer');
      const sizeClass = opts.size ? `modal-${opts.size}` : '';
      const html = `
        <div class="modal fade" id="${id}" tabindex="-1">
          <div class="modal-dialog ${sizeClass}">
            <div class="modal-content">
              <form id="${id}_form">
                <div class="modal-header">
                  <h5 class="modal-title">${opts.title||''}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  ${opts.bodyHTML||''}
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">關閉</button>
                  <button type="submit" class="btn btn-gradient">${opts.submitText||'確定'}</button>
                </div>
              </form>
            </div>
          </div>
        </div>`;
      wrap.insertAdjacentHTML('beforeend', html);
      const modalEl = document.getElementById(id);
      const bsModal = new bootstrap.Modal(modalEl);
      const formEl = document.getElementById(id+'_form');
      formEl.addEventListener('submit', async e=>{
        e.preventDefault();
        try{
          await opts.onSubmit?.(formEl, ()=>bsModal.hide());
        }catch(err){
          showNotification(err.message||'發生錯誤','error');
        }
      });
      modalEl.addEventListener('hidden.bs.modal', ()=> modalEl.remove());
      bsModal.show();
    }

    // ========== 新增：捐款 ==========
    async function showNewDonationModal(){
      showFormModal({
        id:'modalDonation',
        title:'新增捐款',
        submitText:'送出捐款',
        bodyHTML:`
          <div class="form-floating mb-3">
            <input type="number" min="1" class="form-control" id="donAmount" required>
            <label>金額 *</label>
          </div>
          <div class="form-floating mb-3">
            <select class="form-select" id="donCategory" required>
              <option value="一般捐款">一般捐款</option>
              <option value="活動贊助">活動贊助</option>
              <option value="其他">其他</option>
            </select>
            <label>捐款類別 *</label>
          </div>
          <div class="form-floating mb-3">
            <textarea class="form-control" style="height:90px;" id="donDesc"></textarea>
            <label>備註 / 說明</label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="donNeedReceipt">
            <label class="form-check-label" for="donNeedReceipt">需要開立收據</label>
          </div>
        `,
        onSubmit: async (form, close)=>{
          const amount = Number(form.querySelector('#donAmount').value);
          if(!(amount>0)) throw new Error('金額需 > 0');
          const category = form.querySelector('#donCategory').value.trim();
          const description = form.querySelector('#donDesc').value.trim();
            const needReceipt = form.querySelector('#donNeedReceipt').checked;
          const r = await callAPI('createDonation',{
            lineId: currentUser.lineId,
            amount, category, description, needReceipt
          });
          close();
          showNotification('捐款成功','success');
          loadFinance();
          if(r.data.receiptNumber){
            loadReceipts();
          }
        }
      });
    }

    // ========== 新增：支出申請 ==========
    function showNewExpenseModal(){
      showFormModal({
        id:'modalExpense',
        title:'支出申請',
        submitText:'送出申請',
        bodyHTML:`
          <div class="form-floating mb-3">
            <select class="form-select" id="expCategory" required>
              <option value="活動費用">活動費用</option>
              <option value="行政支出">行政支出</option>
              <option value="設備支出">設備支出</option>
              <option value="其他">其他</option>
            </select>
            <label>支出類別 *</label>
          </div>
          <div class="form-floating mb-3">
            <input type="number" min="1" class="form-control" id="expAmount" required>
            <label>金額 *</label>
          </div>
          <div class="form-floating mb-3">
            <textarea class="form-control" style="height:90px;" id="expDesc"></textarea>
            <label>說明</label>
          </div>
        `,
        onSubmit: async (form, close)=>{
          const category=form.querySelector('#expCategory').value;
          const amount=Number(form.querySelector('#expAmount').value);
          if(!(amount>0)) throw new Error('金額需 > 0');
          const description=form.querySelector('#expDesc').value.trim();
          await callAPI('createExpense',{ lineId:currentUser.lineId, category, amount, description });
          close();
          showNotification('已送出支出申請','success');
          loadFinance();
        }
      });
    }

    // ========== 新增：活動 (Admin) ==========
    function showNewActivityModal(){
      if(!isAdmin) return;
      showFormModal({
        id:'modalActivity',
        title:'新增活動',
        submitText:'建立',
        bodyHTML:`
          <div class="form-floating mb-3">
            <input class="form-control" id="actTitle" required>
            <label>標題 *</label>
          </div>
          <div class="form-floating mb-3">
            <textarea class="form-control" id="actDesc" style="height:90px;"></textarea>
            <label>描述</label>
          </div>
          <div class="row g-2">
            <div class="col-6">
              <div class="form-floating mb-3">
                <input type="date" class="form-control" id="actDate" required>
                <label>日期 *</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="actTime" placeholder="例如 14:00-16:00">
                <label>時間</label>
              </div>
            </div>
          </div>
          <div class="row g-2">
            <div class="col-6">
              <div class="form-floating mb-3">
                <input type="number" min="1" class="form-control" id="actMax" required>
                <label>名額 *</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-floating mb-3">
                <input class="form-control" type="number" min="0" id="actFee" value="0">
                <label>費用</label>
              </div>
            </div>
          </div>
          <div class="form-floating mb-3">
            <input class="form-control" id="actLocation">
            <label>地點</label>
          </div>
        `,
        onSubmit: async (form, close)=>{
          const title=form.querySelector('#actTitle').value.trim();
          const date=form.querySelector('#actDate').value;
          const max=form.querySelector('#actMax').value;
          if(!title||!date||!max) throw new Error('請填必填欄位');
          await callAPI('createActivity',{
            lineId: currentUser.lineId,
            title, description: form.querySelector('#actDesc').value.trim(),
            date, time: form.querySelector('#actTime').value.trim(),
            location: form.querySelector('#actLocation').value.trim(),
            maxParticipants:max,
            fee: form.querySelector('#actFee').value||0
          });
          close();
            showNotification('活動建立成功','success');
          loadActivities();
          loadDashboard();
        }
      });
    }

    // ========== 新增：志工需求 (Admin) ==========
    function showNewVolunteerNeedModal(){
      if(!isAdmin) return;
      showFormModal({
        id:'modalVolunteerNeed',
        title:'新增志工需求',
        submitText:'建立',
        bodyHTML:`
          <div class="form-floating mb-3">
            <input class="form-control" id="vnTitle" required>
            <label>標題 *</label>
          </div>
          <div class="form-floating mb-3">
            <textarea class="form-control" style="height:90px;" id="vnDesc"></textarea>
            <label>說明</label>
          </div>
          <div class="row g-2">
            <div class="col-6">
              <div class="form-floating mb-3">
                <input type="date" class="form-control" id="vnDate" required>
                <label>日期 *</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="vnTime" placeholder="時間段">
                <label>時間</label>
              </div>
            </div>
          </div>
          <div class="row g-2">
            <div class="col-6">
              <div class="form-floating mb-3">
                <input type="number" min="1" class="form-control" id="vnNeed" required>
                <label>需求人數 *</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-floating mb-3">
                <input type="number" min="1" class="form-control" id="vnHours" required>
                <label>時數 *</label>
              </div>
            </div>
          </div>
        `,
        onSubmit: async (form, close)=>{
          const title=form.querySelector('#vnTitle').value.trim();
          const date=form.querySelector('#vnDate').value;
          const need=form.querySelector('#vnNeed').value;
          const hours=form.querySelector('#vnHours').value;
          if(!title||!date||!need||!hours) throw new Error('請填必填欄位');
          await callAPI('createVolunteerNeed',{
            lineId: currentUser.lineId,
            title,
            description: form.querySelector('#vnDesc').value.trim(),
            date,
            time: form.querySelector('#vnTime').value.trim(),
            needCount: need,
            hours
          });
          close();
          showNotification('志工需求建立成功','success');
          loadVolunteer();
          loadDashboard();
        }
      });
    }

    // ========== 初始載入整合 ==========
    async function loadAllInitial(){
      await Promise.allSettled([
        loadDashboard(),
        loadActivities(),
        loadVolunteer(),
        loadFinance(),
        loadFeedback(),
        loadReceipts()
      ]);
    }

    // ========== 首次執行點 ==========
    (async function initApp(){
      try{
        await tryAutoLogin();
        // 若自動登入未成功 → 顯示登入區 (預設已顯示)
      }catch(e){
        console.warn('Auto login failed', e);
      }
    })();

  </script>
</body>
</html>
========================= index.html (結束) =========================
