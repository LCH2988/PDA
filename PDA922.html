<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes,maximum-scale=3.0">
<!-- å¯è‡ªè¡Œæ”¾ç½® favicon -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27><text y=%27.9em%27 font-size=%2790%27>ğŸ§ </text></svg>">

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
  :root {
    --primary-color: #4169E1;
    --secondary-color: #6c757d;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --info-color: #17a2b8;
    --light-color: #f8f9fa;
    --dark-color: #343a40;
    --primary-gradient: linear-gradient(135deg, #4169E1, #7B68EE);
    --success-gradient: linear-gradient(135deg, #28a745, #20c997);
    --danger-gradient: linear-gradient(135deg, #dc3545, #ff6b6b);
    --warning-gradient: linear-gradient(135deg, #ffc107, #ffbb33);
    --info-gradient: linear-gradient(135deg, #17a2b8, #5bc0de);
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 18px;
    line-height: 1.6;
    color: #333;
    background-color: #f5f5f5;
    padding-bottom: 100px;
  }

  @media (max-width: 576px) {
    body { font-size: 19px; }
  }
  @media (max-width: 400px) {
    body { font-size: 20px; }
  }

  /* æ¨™é¡Œæ¬„ - ä¸å†å›ºå®š */
  .header {
    background: var(--primary-gradient);
    color: white;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    z-index: 1030;
  }

  .header h1 {
    margin: 0;
    font-size: 2.2rem;
    font-weight: 600;
  }

  .user-info {
    display: flex;
    align-items: center;
    margin-top: 15px;
  }

  .user-avatar {
    width: 50px;
    height: 50px;
    background-color: rgba(255,255,255,0.2);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 500;
    margin-right: 15px;
  }

  .user-details {
    flex-grow: 1;
  }

  .user-name {
    font-size: 1.3rem;
    font-weight: 500;
    margin: 0;
  }

  .user-role {
    font-size: 1rem;
    opacity: 0.9;
    margin: 0;
  }

  /* å°èˆª */
  .nav-pills {
    background-color: white;
    border-radius: 15px;
    padding: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    margin-bottom: 20px;
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
  }

  .nav-pills .nav-link {
    border-radius: 10px;
    padding: 15px;
    margin: 0 5px;
    font-size: 1.2rem;
    font-weight: 500;
    color: var(--dark-color);
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .nav-pills .nav-link.active {
    background-color: var(--primary-color);
    color: white;
    box-shadow: 0 4px 8px rgba(65, 105, 225, 0.3);
  }

  .nav-pills .nav-link i {
    margin-right: 8px;
    font-size: 1.3rem;
  }

  /* å…§å®¹å¡ç‰‡ */
  .content-card {
    background-color: white;
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    margin-bottom: 20px;
  }

  .content-card h3 {
    font-size: 1.8rem;
    font-weight: 600;
    margin-bottom: 20px;
    color: var(--dark-color);
  }

  .content-card h5 {
    font-size: 1.4rem;
    font-weight: 600;
    margin-bottom: 15px;
    color: var(--dark-color);
  }

  /* çµ±è¨ˆå¡ç‰‡ */
  .stat-card {
    background: var(--primary-gradient);
    color: white;
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    height: 100%;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .stat-card h3 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 5px;
    color: white;
  }

  .stat-card p {
    font-size: 1.1rem;
    opacity: 0.9;
  }

  /* æ´»å‹•é …ç›® */
  .activity-item {
    background-color: #f9f9f9;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border-left: 5px solid var(--primary-color);
  }

  /* äº¤æ˜“é …ç›® */
  .transaction-item {
    background-color: #f9f9f9;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border-left: 5px solid var(--info-color);
  }

  /* ç‹€æ…‹æ¨™ç±¤ */
  .status-badge {
    display: inline-block;
    padding: 8px 15px;
    border-radius: 30px;
    font-size: 1rem;
    font-weight: 500;
    text-align: center;
    min-width: 100px;
  }

  .status-é–‹æ”¾å ±å {
    background-color: rgba(40, 167, 69, 0.15);
    color: #28a745;
    border: 1px solid rgba(40, 167, 69, 0.3);
  }

  .status-å·²å ±å {
    background-color: rgba(65, 105, 225, 0.15);
    color: #4169E1;
    border: 1px solid rgba(65, 105, 225, 0.3);
  }

  .status-å·²çµæŸ {
    background-color: rgba(108, 117, 125, 0.15);
    color: #6c757d;
    border: 1px solid rgba(108, 117, 125, 0.3);
  }

  .status-å·²å–æ¶ˆ {
    background-color: rgba(220, 53, 69, 0.15);
    color: #dc3545;
    border: 1px solid rgba(220, 53, 69, 0.3);
  }

  .status-å·²å®Œæˆ {
    background-color: rgba(23, 162, 184, 0.15);
    color: #17a2b8;
    border: 1px solid rgba(23, 162, 184, 0.3);
  }

  .status-å·²æ ¸å‡† {
    background-color: rgba(40, 167, 69, 0.15);
    color: #28a745;
    border: 1px solid rgba(40, 167, 69, 0.3);
  }

  .status-å¾…å¯©æ ¸ {
    background-color: rgba(255, 193, 7, 0.15);
    color: #ffc107;
    border: 1px solid rgba(255, 193, 7, 0.3);
  }

  .status-å·²æ‹’çµ• {
    background-color: rgba(220, 53, 69, 0.15);
    color: #dc3545;
    border: 1px solid rgba(220, 53, 69, 0.3);
  }

  /* æŒ‰éˆ• */
  .btn {
    font-size: 1.1rem;
    font-weight: 500;
    padding: 12px 20px;
    border-radius: 10px;
    min-height: 50px;
    transition: all 0.3s;
  }

  .btn-sm {
    padding: 8px 15px;
    font-size: 1rem;
    min-height: 40px;
  }

  .btn-lg {
    padding: 15px 25px;
    font-size: 1.2rem;
  }

  .btn-primary {
    background: var(--primary-gradient);
    border: none;
    box-shadow: 0 4px 10px rgba(65, 105, 225, 0.3);
  }

  .btn-primary:hover, .btn-primary:focus {
    background: linear-gradient(135deg, #3a5ecc, #6a5adb);
    box-shadow: 0 5px 15px rgba(65, 105, 225, 0.4);
  }

  .btn-success {
    background: var(--success-gradient);
    border: none;
    box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
  }

  .btn-success:hover, .btn-success:focus {
    background: linear-gradient(135deg, #218838, #1ca585);
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
  }

  .btn-danger {
    background: var(--danger-gradient);
    border: none;
    box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
  }

  .btn-danger:hover, .btn-danger:focus {
    background: linear-gradient(135deg, #c82333, #ff5b5b);
    box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
  }

  .btn-warning {
    background: var(--warning-gradient);
    border: none;
    box-shadow: 0 4px 10px rgba(255, 193, 7, 0.3);
    color: #212529;
  }

  .btn-warning:hover, .btn-warning:focus {
    background: linear-gradient(135deg, #e0a800, #ffaa00);
    box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
    color: #212529;
  }

  .btn-info {
    background: var(--info-gradient);
    border: none;
    box-shadow: 0 4px 10px rgba(23, 162, 184, 0.3);
    color: white;
  }

  .btn-info:hover, .btn-info:focus {
    background: linear-gradient(135deg, #138496, #4bacc8);
    box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
    color: white;
  }

  .btn-outline-primary {
    border-color: var(--primary-color);
    color: var(--primary-color);
  }

  .btn-outline-primary:hover, .btn-outline-primary:focus {
    background-color: var(--primary-color);
    color: white;
  }

  .btn.loading {
    position: relative;
    color: transparent !important;
  }

  .btn.loading::after {
    content: "";
    position: absolute;
    width: 20px;
    height: 20px;
    top: 50%;
    left: 50%;
    margin: -10px 0 0 -10px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* è¡¨å–®å…ƒç´  */
  .form-control, .form-select {
    font-size: 1.1rem;
    padding: 15px;
    border-radius: 10px;
    border: 2px solid #dee2e6;
    min-height: 60px;
  }

  .form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(65, 105, 225, 0.25);
  }

  .form-floating > label {
    padding: 15px;
    color: #6c757d;
  }

  .form-floating > .form-control, .form-floating > .form-select {
    height: auto;
    min-height: 60px;
  }

  .form-floating > .form-control:focus ~ label, 
  .form-floating > .form-control:not(:placeholder-shown) ~ label,
  .form-floating > .form-select ~ label {
    transform: scale(0.85) translateY(-0.75rem) translateX(0.15rem);
    color: var(--primary-color);
  }

  .form-check-input {
    width: 1.2em;
    height: 1.2em;
    margin-top: 0.15em;
  }

  .form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
  }

  .form-check-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(65, 105, 225, 0.25);
  }

  /* è¡¨æ ¼ */
  .table-container {
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 0 15px rgba(0,0,0,0.05);
  }

  .table {
    margin-bottom: 0;
  }

  .table th {
    background-color: #f8f9fa;
    font-weight: 600;
    font-size: 1.1rem;
    padding: 15px;
  }

  .table td {
    padding: 15px;
    vertical-align: middle;
  }

  /* é€šçŸ¥ */
  #notificationContainer {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    max-width: 90%;
    width: 350px;
  }

  .notification {
    background-color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    transform: translateX(120%);
    transition: transform 0.3s ease-out;
    border-left: 5px solid #4169E1;
  }

  .notification.show {
    transform: translateX(0);
  }

  .notification.success {
    border-left-color: #28a745;
  }

  .notification.error {
    border-left-color: #dc3545;
  }

  .notification.warning {
    border-left-color: #ffc107;
  }

  .notification.info {
    border-left-color: #17a2b8;
  }

  /* æ¨¡æ…‹æ¡† */
  .modal-content {
    border-radius: 20px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }

  .modal-header {
    border-bottom: 1px solid rgba(0,0,0,0.1);
  }

  .modal-footer {
    border-top: 1px solid rgba(0,0,0,0.1);
  }

  /* å¿«é€Ÿæ“ä½œæŒ‰éˆ• */
  .quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
  }

  .quick-actions .btn {
    flex: 1;
    min-width: 120px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 15px;
    height: 100px;
  }

  .quick-actions .btn i {
    font-size: 1.8rem;
    margin-bottom: 8px;
  }

  @media (max-width: 576px) {
    .quick-actions .btn {
      flex: 0 0 calc(50% - 5px);
    }
  }

  @media (max-width: 400px) {
    .quick-actions .btn {
      flex: 0 0 100%;
    }
  }

  /* ç„¡éšœç¤™ */
  :focus-visible {
    outline: 3px solid rgba(65, 105, 225, 0.5);
    outline-offset: 2px;
  }

  /* éŸ¿æ‡‰å¼èª¿æ•´ */
  @media (max-width: 576px) {
    .header h1 {
      font-size: 1.8rem;
    }
    
    .content-card {
      padding: 20px;
    }
    
    .content-card h3 {
      font-size: 1.6rem;
    }
    
    .content-card h5 {
      font-size: 1.3rem;
    }
    
    .user-info {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .user-avatar {
      margin-bottom: 10px;
    }
  }
</style>
</head>
<body>
<div class="main-header">
  <h1><i class="bi bi-hospital"></i> å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</h1>
  <p class="text-muted mb-2">æ•´åˆå¹³å°</p>
  <div id="userInfoBar" class="user-info-bar" style="display:none;">
    <div class="user-avatar" id="userAvatar">?</div>
    <div class="user-info-text">
      <div class="fw-bold" id="userName">è¼‰å…¥ä¸­...</div>
      <div class="small text-muted" id="userLineName"></div>
      <div class="small text-muted" id="userRole">æœƒå“¡</div>
    </div>
    <div>
      <button class="btn btn-outline-secondary btn-sm" onclick="refreshData()" title="åˆ·æ–°">
        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
      </button>
    </div>
  </div>
</div>

<div id="notificationContainer"></div>

<div class="nav-container">
  <ul class="nav nav-pills">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#dashboard">å„€è¡¨æ¿</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#profile">å€‹äººè³‡æ–™</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#activities">æ´»å‹•ç®¡ç†</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#volunteer">å¿—å·¥æœå‹™</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#finance">è²¡å‹™ç®¡ç†</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#feedback">æ´»å‹•å›é¥‹</button></li>
    <li class="nav-item admin-only" style="display:none;"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#admin">ç³»çµ±ç®¡ç†</button></li>
  </ul>
</div>

<div class="tab-content">

  <!-- Dashboard -->
  <div class="tab-pane fade show active" id="dashboard">
    <div class="content-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>å„€è¡¨æ¿</h3>
        <button class="btn btn-outline-primary btn-sm" onclick="loadDashboard()">
          <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°
        </button>
      </div>
      <div class="quick-actions">
        <div class="quick-btn" onclick="showTab('profile')">
          <i class="bi bi-person-check"></i>
          æ›´æ–°è³‡æ–™
        </div>
        <div class="quick-btn" onclick="showTab('activities')">
          <i class="bi bi-calendar-plus"></i>
          å ±åæ´»å‹•
        </div>
        <div class="quick-btn" onclick="showNewDonationModal()">
          <i class="bi bi-heart-fill"></i>
          æ„›å¿ƒææ¬¾
        </div>
        <div class="quick-btn" onclick="showTab('volunteer')">
          <i class="bi bi-hand-thumbs-up"></i>
          å¿—å·¥æœå‹™
        </div>
      </div>
      <div class="row" id="dashboardStats">
        <div class="col-12">
          <div class="d-flex justify-content-center align-items-center py-5 text-muted">
            <div class="me-3 spinner-border text-primary"></div>
            <span style="font-size: 1.2rem;">è¼‰å…¥çµ±è¨ˆè³‡æ–™...</span>
          </div>
        </div>
      </div>
      <div class="mt-4">
        <h5><i class="bi bi-clock-history me-2"></i>æœ€è¿‘æ´»å‹•</h5>
        <div id="recentActivity">
          <div class="d-flex justify-content-center align-items-center py-5 text-muted">
            <div class="me-3 spinner-border text-primary"></div>
            <span style="font-size: 1.2rem;">è¼‰å…¥ä¸­...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile -->
  <div class="tab-pane fade" id="profile">
    <div class="content-card">
      <h3><i class="bi bi-person me-2"></i>å€‹äººè³‡æ–™</h3>
      <div id="registrationSection" class="mt-4">
        <div class="alert alert-info" style="font-size: 1.1rem; padding: 20px;">
          <i class="bi bi-info-circle me-2"></i>è«‹å…ˆå®Œæˆè¨»å†Šã€‚
        </div>
        <form id="registrationForm" class="row g-4">
          <div class="col-12">
            <div class="form-floating">
              <input type="text" class="form-control" id="realName" name="realName" required>
              <label for="realName">çœŸå¯¦å§“å *</label>
            </div>
          </div>
          <div class="col-12">
            <div class="form-floating">
              <select class="form-select" id="memberType" name="memberType" required>
                <option value="">é¸æ“‡</option>
                <option value="ç—…å‹">ç—…å‹</option>
                <option value="å®¶å±¬">å®¶å±¬</option>
                <option value="å¿—å·¥">å¿—å·¥</option>
                <option value="é†«è­·">é†«è­·äººå“¡</option>
                <option value="æ”¯æŒè€…">æ”¯æŒè€…</option>
              </select>
              <label for="memberType">æœƒå“¡é¡åˆ¥ *</label>
            </div>
          </div>
          <div class="col-12 d-grid">
            <button class="btn btn-primary btn-lg" type="submit">
              <i class="bi bi-check-circle me-2"></i>å®Œæˆè¨»å†Š
            </button>
          </div>
        </form>
      </div>

      <div id="profileSection" style="display:none;">
        <form id="profileForm" class="row g-4 mt-2">
          <div class="col-12">
            <div class="form-floating">
              <input type="text" class="form-control" id="profileRealName" name="profileRealName" readonly>
              <label for="profileRealName">çœŸå¯¦å§“å</label>
            </div>
          </div>
          <div class="col-12">
            <div class="form-floating">
              <input type="text" class="form-control" id="lineName" name="lineName" readonly>
              <label for="lineName">LINE åç¨±</label>
            </div>
          </div>
          <div class="col-12">
            <div class="form-floating">
              <input type="tel" class="form-control" id="phone" name="phone">
              <label for="phone">è¯çµ¡é›»è©±</label>
            </div>
          </div>
          <div class="col-12">
            <div class="form-floating">
              <input type="email" class="form-control" id="email" name="email">
              <label for="email">é›»å­éƒµä»¶</label>
            </div>
          </div>
          <div class="col-12">
            <div class="form-floating">
              <input type="date" class="form-control" id="birthday" name="birthday">
              <label for="birthday">ç”Ÿæ—¥</label>
            </div>
          </div>
          <div class="col-12">
            <div class="form-floating">
              <select class="form-select" id="profileMemberType" name="memberType">
                <option value="ç—…å‹">ç—…å‹</option>
                <option value="å®¶å±¬">å®¶å±¬</option>
                <option value="å¿—å·¥">å¿—å·¥</option>
                <option value="é†«è­·">é†«è­·äººå“¡</option>
                <option value="æ”¯æŒè€…">æ”¯æŒè€…</option>
              </select>
              <label for="profileMemberType">æœƒå“¡é¡åˆ¥</label>
            </div>
          </div>
          <div class="col-12">
            <div class="form-floating">
              <textarea class="form-control" id="address" name="address" style="height:120px;"></textarea>
              <label for="address">é€šè¨Šåœ°å€</label>
            </div>
          </div>
          <div class="col-12 d-grid">
            <button class="btn btn-primary btn-lg" type="submit">
              <i class="bi bi-save me-2"></i>æ›´æ–°è³‡æ–™
            </button>
          </div>
        </form>
        <div class="mt-5">
          <h5><i class="bi bi-bar-chart me-2"></i>å€‹äººçµ±è¨ˆ</h5>
          <div class="row g-3" id="profileStats"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Activities -->
  <div class="tab-pane fade" id="activities">
    <div class="content-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0"><i class="bi bi-calendar-event me-2"></i>æ´»å‹•ç®¡ç†</h3>
        <div class="admin-only" style="display:none;">
          <button class="btn btn-success btn-sm" onclick="showNewActivityModal()">
            <i class="bi bi-plus-circle me-1"></i>æ–°å¢æ´»å‹•
          </button>
        </div>
      </div>
      <div class="row g-3 mb-4">
        <div class="col-12">
          <div class="form-floating">
            <select class="form-select" id="activityStatusFilter">
              <option value="">å…¨éƒ¨ç‹€æ…‹</option>
              <option value="é–‹æ”¾å ±å">é–‹æ”¾å ±å</option>
              <option value="å ±åæˆªæ­¢">å ±åæˆªæ­¢</option>
              <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
              <option value="å·²çµæŸ">å·²çµæŸ</option>
            </select>
            <label for="activityStatusFilter">ç‹€æ…‹</label>
          </div>
        </div>
        <div class="col-12">
          <div class="form-floating">
            <input type="date" class="form-control" id="activityDateFilter">
            <label for="activityDateFilter">æ—¥æœŸ</label>
          </div>
        </div>
        <div class="col-12">
          <div class="form-floating">
            <input type="text" class="form-control" id="activitySearchFilter" placeholder="é—œéµå­—">
            <label for="activitySearchFilter">æœå°‹</label>
          </div>
        </div>
        <div class="col-12 d-grid">
          <button class="btn btn-outline-primary btn-lg" onclick="filterActivities()">
            <i class="bi bi-search me-2"></i> æŸ¥è©¢
          </button>
        </div>
      </div>
      <div id="activitiesList">
        <div class="py-5 text-center text-muted">
          <div class="spinner-border me-3"></div>
          <span style="font-size: 1.2rem;">è¼‰å…¥æ´»å‹•...</span>
        </div>
      </div>
      <div class="mt-5">
        <h5><i class="bi bi-clipboard-check me-2"></i>æˆ‘çš„æ´»å‹•å ±å</h5>
        <div id="myRegistrations" class="mt-3">
          <div class="py-5 text-center text-muted">
            <div class="spinner-border me-3"></div>
            <span style="font-size: 1.2rem;">è¼‰å…¥ä¸­...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Volunteer -->
  <div class="tab-pane fade" id="volunteer">
    <div class="content-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0"><i class="bi bi-heart me-2"></i>å¿—å·¥æœå‹™</h3>
        <div class="admin-only" style="display:none;">
          <button class="btn btn-success btn-sm" onclick="showNewVolunteerNeedModal()">
            <i class="bi bi-plus-circle me-1"></i>æ–°å¢å¿—å·¥éœ€æ±‚
          </button>
        </div>
      </div>
      <div class="row g-3 mb-4">
        <div class="col-6"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="volunteerHours">0</h3><p class="mb-0">æœå‹™æ™‚æ•¸</p></div></div>
        <div class="col-6"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="volunteerActivities">0</h3><p class="mb-0">åƒèˆ‡æ¬¡æ•¸</p></div></div>
        <div class="col-6"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="volunteerRank">-</h3><p class="mb-0">å¿—å·¥æ’å</p></div></div>
        <div class="col-6"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="availableNeeds">0</h3><p class="mb-0">å¯å ±åéœ€æ±‚</p></div></div>
      </div>
      <h5><i class="bi bi-exclamation-circle me-2"></i>å¿—å·¥éœ€æ±‚</h5>
      <div id="volunteerNeeds">
        <div class="py-5 text-center text-muted">
          <div class="spinner-border me-3"></div>
          <span style="font-size: 1.2rem;">è¼‰å…¥ä¸­...</span>
        </div>
      </div>
      <div class="mt-5">
        <h5><i class="bi bi-journal-text me-2"></i>æˆ‘çš„å¿—å·¥è¨˜éŒ„</h5>
        <div id="myVolunteerRecords" class="mt-3">
          <div class="py-5 text-center text-muted">
            <div class="spinner-border me-3"></div>
            <span style="font-size: 1.2rem;">è¼‰å…¥ä¸­...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Finance -->
  <div class="tab-pane fade" id="finance">
    <div class="content-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0"><i class="bi bi-cash-coin me-2"></i>è²¡å‹™ç®¡ç†</h3>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-success btn-sm" onclick="showNewDonationModal()">
            <i class="bi bi-heart-fill me-1"></i>ææ¬¾
          </button>
          <button class="btn btn-warning btn-sm" onclick="showNewExpenseModal()">
            <i class="bi bi-receipt me-1"></i>æ”¯å‡ºç”³è«‹
          </button>
        </div>
      </div>
      <div class="row g-3 mb-4">
        <div class="col-6"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="myDonationAmount">NT$ 0</h3><p class="mb-0">ææ¬¾ç¸½é¡</p></div></div>
        <div class="col-6"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="myDonationCount">0</h3><p class="mb-0">ææ¬¾æ¬¡æ•¸</p></div></div>
        <div class="col-6"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="myExpenseAmount">NT$ 0</h3><p class="mb-0">æ”¯å‡ºç”³è«‹é¡</p></div></div>
        <div class="col-6"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="pendingExpenses">0</h3><p class="mb-0">å¾…å¯©æ ¸</p></div></div>
      </div>
      <h5><i class="bi bi-heart-fill me-2"></i>æˆ‘çš„ææ¬¾</h5>
      <div id="donationHistory" class="mt-3">
        <div class="py-5 text-center text-muted">
          <div class="spinner-border me-3"></div>
          <span style="font-size: 1.2rem;">è¼‰å…¥ä¸­...</span>
        </div>
      </div>
      <div class="mt-5">
        <h5><i class="bi bi-receipt me-2"></i>æˆ‘çš„æ”¯å‡ºç”³è«‹</h5>
        <div id="expenseHistory" class="mt-3">
          <div class="py-5 text-center text-muted">
            <div class="spinner-border me-3"></div>
            <span style="font-size: 1.2rem;">è¼‰å…¥ä¸­...</span>
          </div>
        </div>
      </div>
      <div class="admin-only mt-5" style="display:none;">
        <h5><i class="bi bi-graph-up me-2"></i>è²¡å‹™ç¸½è¦½ï¼ˆç®¡ç†å“¡ï¼‰</h5>
        <div class="row g-3 mb-3">
          <div class="col-6"><div class="stat-card" style="background:var(--success-gradient);"><h3 id="totalIncome">NT$ 0</h3><p class="mb-0">ç¸½æ”¶å…¥</p></div></div>
          <div class="col-6"><div class="stat-card" style="background:var(--danger-gradient);"><h3 id="totalExpense">NT$ 0</h3><p class="mb-0">ç¸½æ”¯å‡º</p></div></div>
          <div class="col-6"><div class="stat-card" style="background:var(--info-gradient);"><h3 id="currentBalance">NT$ 0</h3><p class="mb-0">ç›®å‰é¤˜é¡</p></div></div>
          <div class="col-6"><div class="stat-card" style="background:var(--warning-gradient);"><h3 id="monthlyDonations">NT$ 0</h3><p class="mb-0">æœ¬æœˆææ¬¾</p></div></div>
        </div>
        <div class="d-grid">
          <button class="btn btn-outline-primary" onclick="showNewTransactionModal()">
            <i class="bi bi-plus-circle me-2"></i>æ–°å¢äº¤æ˜“(å¿«é€Ÿ)
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback -->
  <div class="tab-pane fade" id="feedback">
    <div class="content-card">
      <h3><i class="bi bi-chat-dots me-2"></i>æ´»å‹•å›é¥‹</h3>
      <div class="card mb-4" style="border-radius: 20px; border-width: 2px;">
        <div class="card-header bg-primary text-white" style="border-radius: 18px 18px 0 0; padding: 20px;">
          <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>æ–°å¢å›é¥‹</h5>
        </div>
        <div class="card-body" style="padding: 25px;">
          <form id="feedbackForm" class="row g-4">
            <div class="col-12">
              <div class="form-floating">
                <select class="form-select" id="feedbackActivity" name="feedbackActivity" required>
                  <option value="">è«‹é¸æ“‡æ´»å‹•</option>
                </select>
                <label for="feedbackActivity">æ´»å‹• *</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <select class="form-select" id="feedbackRating" name="feedbackRating" required>
                  <option value="">è©•åˆ†</option>
                  <option value="5">5 - éå¸¸æ»¿æ„</option>
                  <option value="4">4 - æ»¿æ„</option>
                  <option value="3">3 - æ™®é€š</option>
                  <option value="2">2 - ä¸æ»¿æ„</option>
                  <option value="1">1 - éå¸¸ä¸æ»¿æ„</option>
                </select>
                <label for="feedbackRating">è©•åˆ† *</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="feedbackComment" name="feedbackComment" style="height:140px;" required></textarea>
                <label for="feedbackComment">æ„è¦‹ / å»ºè­° *</label>
              </div>
            </div>
            <div class="col-12 d-grid">
              <button class="btn btn-primary btn-lg" type="submit">
                <i class="bi bi-send me-2"></i>æäº¤
              </button>
            </div>
          </form>
        </div>
      </div>
      <h5><i class="bi bi-chat-left-text me-2"></i>æˆ‘çš„å›é¥‹</h5>
      <div id="myFeedback" class="mt-3">
        <div class="py-5 text-center text-muted">
          <div class="spinner-border me-3"></div>
          <span style="font-size: 1.2rem;">è¼‰å…¥ä¸­...</span>
        </div>
      </div>
      <div class="admin-only mt-5" style="display:none;">
        <h5><i class="bi bi-chat-square-dots me-2"></i>å…¨éƒ¨å›é¥‹ï¼ˆç®¡ç†å“¡ï¼‰</h5>
        <div id="allFeedback">
          <div class="py-5 text-center text-muted">
            <div class="spinner-border me-3"></div>
            <span style="font-size: 1.2rem;">è¼‰å…¥ä¸­...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin -->
  <div class="tab-pane fade" id="admin">
    <div class="content-card">
      <h3><i class="bi bi-gear me-2"></i>ç³»çµ±ç®¡ç†</h3>
      <ul class="nav nav-tabs mb-4" style="font-size: 1.1rem;">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#memberManagement" style="padding: 15px 20px;">æœƒå“¡</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#activityManagement" style="padding: 15px 20px;">æ´»å‹•</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#financeManagement" style="padding: 15px 20px;">è²¡å‹™</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#receiptManagement" style="padding: 15px 20px;">æ”¶æ“š</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#systemSettings" style="padding: 15px 20px;">è¨­å®š</button></li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="memberManagement">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">æœƒå“¡åˆ—è¡¨</h5>
            <button class="btn btn-outline-primary btn-sm" onclick="exportMembers()">
              <i class="bi bi-download me-1"></i>åŒ¯å‡º
            </button>
          </div>
          <div class="table-responsive">
            <div class="table-container">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>å§“å</th><th>é¡åˆ¥</th><th>ç‹€æ…‹</th><th>åŠ å…¥æ—¥æœŸ</th><th>ææ¬¾æ¬¡æ•¸</th><th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="memberList">
                  <tr><td colspan="6" class="text-center text-muted py-5"><div class="spinner-border me-3"></div>è¼‰å…¥ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="activityManagement">
          <div class="d-flex justify-content-between mb-3">
            <h5 class="mb-0">æ´»å‹•åˆ—è¡¨</h5>
            <button class="btn btn-success btn-sm" onclick="showNewActivityModal()">
              <i class="bi bi-plus-circle me-1"></i>æ–°å¢æ´»å‹•
            </button>
          </div>
          <div id="adminActivityList" class="mt-3">
            <div class="py-5 text-center text-muted">
              <div class="spinner-border me-3"></div>
              <span style="font-size: 1.2rem;">è¼‰å…¥ä¸­...</span>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="financeManagement">
          <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
            <h5 class="mb-0">äº¤æ˜“è¨˜éŒ„</h5>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-success btn-sm" onclick="showNewTransactionModal()">
                <i class="bi bi-plus-circle me-1"></i>æ–°å¢äº¤æ˜“
              </button>
              <button class="btn btn-outline-primary btn-sm" onclick="exportFinanceData()">
                <i class="bi bi-download me-1"></i>åŒ¯å‡º
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <div class="table-container">
              <table class="table table-hover align-middle">
                <thead>
                  <tr><th>æ—¥æœŸ</th><th>é¡å‹</th><th>é‡‘é¡</th><th>åˆ†é¡</th><th>èªªæ˜</th><th>ç‹€æ…‹</th></tr>
                </thead>
                <tbody id="transactionList">
                  <tr><td colspan="6" class="text-center text-muted py-5"><div class="spinner-border me-3"></div>è¼‰å…¥ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="receiptManagement">
          <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
            <h5 class="mb-0">æ”¶æ“šåˆ—è¡¨</h5>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-info btn-sm" onclick="showReceiptTemplateModal()">
                <i class="bi bi-file-text me-1"></i>æ¨¡æ¿è¨­å®š
              </button>
              <button class="btn btn-success btn-sm" onclick="showManualReceiptModal()">
                <i class="bi bi-plus-circle me-1"></i>æ‰‹å‹•é–‹ç«‹
              </button>
            </div>
          </div>
          <div id="receiptList" class="mt-3">
            <div class="py-5 text-center text-muted">
              <div class="spinner-border me-3"></div>
              <span style="font-size: 1.2rem;">è¼‰å…¥ä¸­...</span>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="systemSettings">
          <h5 class="mb-4">ç³»çµ±å·¥å…·</h5>
          <div class="d-grid gap-3">
            <button class="btn btn-warning btn-lg" onclick="backupSystem()">
              <i class="bi bi-database me-2"></i>ç«‹å³å‚™ä»½
            </button>
            <button class="btn btn-info btn-lg" onclick="showSystemNotificationModal()">
              <i class="bi bi-megaphone me-2"></i>ç™¼é€é€šçŸ¥
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div><!-- tab-content -->

<div id="modalContainer"></div>

<script>
  // ========== è¨­å®š ==========
  const CONFIG = {
    LIFF_ID: '1656516134-VaGgmaPm',
    // !!! è«‹æ›¿æ›ç‚ºæ‚¨æœ€æ–°éƒ¨ç½² Web App URL (ä»¥ https://script.google.com/macros/s/XXXXX/exec çµå°¾)
    API_BASE_URL: 'https://script.google.com/macros/s/AKfycbxD3u_DlXG9aIFfc2R4MciO9yGFxojKPWgbM5Ky7VrJURZBzrfpLzf1p4dxtNiyJkp1Vw/exec',
    API_KEY: 'AAbb8520258185202581'
  };

  // ========== å…¨åŸŸç‹€æ…‹ ==========
  let userProfile = null;
  let currentUser = null;
  let isAdmin = false;
  let allActivities = [];
  let cachedAdminData = null;

  // ========== å·¥å…· ==========
  const formatDate = d => {
    if(!d) return '-';
    const dt = new Date(d);
    if(isNaN(dt)) return '-';
    return dt.toLocaleDateString('zh-TW');
  };
  const formatDateTime = d => {
    if(!d) return '-';
    const dt = new Date(d);
    if(isNaN(dt)) return '-';
    return dt.toLocaleString('zh-TW');
  };
  const formatCurrency = n =>
    new Intl.NumberFormat('zh-TW',{style:'currency',currency:'TWD',minimumFractionDigits:0}).format(n||0);

  function showNotification(msg,type='success',ms=3000){
    const wrap = document.getElementById('notificationContainer');
    const el = document.createElement('div');
    el.className = `notification ${type}`;
    el.innerHTML = `
      <div class="d-flex justify-content-between align-items-start">
        <span style="font-size: 1.1rem; font-weight: 500;">${msg}</span>
        <button style="background:none;border:none;font-size:24px;line-height:1;padding:0;margin-left:15px;" onclick="this.closest('.notification').remove()">&times;</button>
      </div>`;
    wrap.appendChild(el);
    requestAnimationFrame(()=>el.classList.add('show'));
    setTimeout(()=>{
      el.classList.remove('show');
      setTimeout(()=>el.remove(),350);
    },ms);
  }

  function setButtonLoading(btn,loading=true){
    if(!btn) return;
    if(loading){
      if(!btn.dataset.originalText) btn.dataset.originalText = btn.innerHTML;
      btn.classList.add('loading');
      btn.disabled = true;
    }else{
      btn.classList.remove('loading');
      btn.disabled = false;
      if(btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText;
    }
  }

  // é¿å… CORSï¼šä¸åŠ  Content-Type (ç€è¦½å™¨é è¨­ text/plainï¼Œé¿å…é æª¢)
  async function callAPI(action,data={},retries=2){
    const payload = {
      action,
        apiKey: CONFIG.API_KEY,
      timestamp: Date.now(),
      ...data
    };
    let lastErr;
    for(let i=0;i<=retries;i++){
      try{
        const res = await fetch(CONFIG.API_BASE_URL,{
          method:'POST',
          body: JSON.stringify(payload) // ç„¡ headers â†’ text/plain
        });
        const text = await res.text();
        let json;
        try{ json = JSON.parse(text); }catch(e){ throw new Error('å›æ‡‰é JSON: '+text.slice(0,120)); }
        if(!json.success) throw new Error(json.message||'API éŒ¯èª¤');
        return json;
      }catch(err){
        lastErr = err;
        await new Promise(r=>setTimeout(r,400*(i+1)));
      }
    }
    throw lastErr;
  }

  // ========== LIFF åˆå§‹åŒ– ==========
  async function initializeLiff(){
    try{
      await liff.init({ liffId: CONFIG.LIFF_ID });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      userProfile = await liff.getProfile();
      // å…ˆé¡¯ç¤º LINE åç¨±
      const bar = document.getElementById('userInfoBar');
      bar.style.display='inline-flex';
      document.getElementById('userLineName').textContent = 'LINEï¼š'+(userProfile.displayName||'');
      document.getElementById('userName').textContent = userProfile.displayName||'æœƒå“¡';
      document.getElementById('userAvatar').textContent = (userProfile.displayName||'?').charAt(0);

      await loadUserData();
      await loadDashboard();
      showNotification('ç³»çµ±åˆå§‹åŒ–å®Œæˆ','success');
    }catch(err){
      console.error(err);
      showNotification('LIFF åˆå§‹åŒ–å¤±æ•—','error');
    }
  }

  // ========== ä½¿ç”¨è€… ==========
  async function loadUserData(){
    try{
      const r = await callAPI('getUserInfo',{ lineId:userProfile.userId });
      if(r.success && r.data){
        currentUser = r.data;
        isAdmin = !!currentUser.isAdmin;
        updateUserUI();
      }else{
        showRegistrationForm();
      }
    }catch{
      showRegistrationForm();
    }
  }

  function updateUserUI(){
    if(!currentUser) return;
    document.getElementById('userName').textContent =
      currentUser.realName || currentUser.lineName || userProfile.displayName || 'æœƒå“¡';
    document.getElementById('userRole').textContent = currentUser.memberType || 'æœƒå“¡';
    document.getElementById('userAvatar').textContent =
      (currentUser.realName || currentUser.lineName || userProfile.displayName || '?').charAt(0);
    document.querySelectorAll('.admin-only').forEach(el=> el.style.display = isAdmin ? 'block':'none');
    updateProfileSection();
  }

  function showRegistrationForm(){
    document.getElementById('registrationSection').style.display='block';
    document.getElementById('profileSection').style.display='none';
  }

  function updateProfileSection(){
    if(!currentUser) return;
    document.getElementById('registrationSection').style.display='none';
    document.getElementById('profileSection').style.display='block';
    document.getElementById('profileRealName').value = currentUser.realName||'';
    document.getElementById('lineName').value = currentUser.lineName||userProfile.displayName||'';
    document.getElementById('phone').value = currentUser.phone||'';
    document.getElementById('email').value = currentUser.email||'';
    document.getElementById('birthday').value = currentUser.birthday||'';
    document.getElementById('profileMemberType').value = currentUser.memberType||'ç—…å‹';
    document.getElementById('address').value = currentUser.address||'';
    // é¡¯ç¤ºå€‹äººçµ±è¨ˆ - å¯è‡ªè¡Œæ“´å……
    document.getElementById('profileStats').innerHTML = `
      <div class="col-12">
        <div class="stat-card" style="background:var(--info-gradient);">
          <h3>${currentUser.memberType||'-'}</h3><p class="mb-0">èº«ä»½</p>
        </div>
      </div>
    `;
  }

  // è¨»å†Š
  document.getElementById('registrationForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const btn = e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn,true);
    try{
      await callAPI('registerUser',{
        lineId:userProfile.userId,
        lineName:userProfile.displayName,
        realName:fd.get('realName'),
        memberType:fd.get('memberType')
      });
      showNotification('è¨»å†ŠæˆåŠŸ','success');
      await loadUserData();
    }catch(err){
      showNotification('è¨»å†Šå¤±æ•—ï¼š'+err.message,'error');
    }finally{ setButtonLoading(btn,false); }
  });

  // æ›´æ–°å€‹è³‡
  document.getElementById('profileForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const btn = e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn,true);
    try{
      await callAPI('updateProfile',{
        lineId:userProfile.userId,
        phone:fd.get('phone'),
        email:fd.get('email'),
        birthday:fd.get('birthday'),
        memberType:fd.get('memberType'),
        address:fd.get('address')
      });
      showNotification('æ›´æ–°æˆåŠŸ','success');
      await loadUserData();
    }catch(err){
      showNotification('æ›´æ–°å¤±æ•—ï¼š'+err.message,'error');
    }finally{ setButtonLoading(btn,false); }
  });

  // ========== å„€è¡¨æ¿ ==========
  async function loadDashboard(){
    try{
      const r = await callAPI('getDashboardData',{ lineId:userProfile?.userId });
      renderDashboardStats(r.data);
      renderRecentActivity(r.data.recentActivity||[]);
    }catch(err){
      document.getElementById('dashboardStats').innerHTML =
        `<div class="col-12 text-danger text-center py-4"><h5>è¼‰å…¥å¤±æ•—ï¼š${err.message}</h5></div>`;
    }
  }
  function renderDashboardStats(d){
    document.getElementById('dashboardStats').innerHTML = `
      <div class="col-6"><div class="stat-card" style="background:var(--success-gradient);"><h3>${d.totalActivities||0}</h3><p class="mb-0">å¯å ±åæ´»å‹•</p></div></div>
      <div class="col-6"><div class="stat-card" style="background:var(--info-gradient);"><h3>${d.myRegistrations||0}</h3><p class="mb-0">æˆ‘çš„å ±å</p></div></div>
      <div class="col-6"><div class="stat-card" style="background:var(--warning-gradient);"><h3>${d.myVolunteerHours||0}</h3><p class="mb-0">å¿—å·¥æ™‚æ•¸</p></div></div>
      <div class="col-6"><div class="stat-card" style="background:var(--danger-gradient);"><h3>${formatCurrency(d.myDonationAmount||0).replace('NT$','')}</h3><p class="mb-0">ææ¬¾ç¸½é¡</p></div></div>
    `;
  }
  function renderRecentActivity(list){
    const c = document.getElementById('recentActivity');
    if(!list.length){
      c.innerHTML = '<p class="text-muted mb-0 text-center py-4" style="font-size: 1.2rem;">æš«ç„¡æœ€è¿‘æ´»å‹•</p>';
      return;
    }
    c.innerHTML = list.map(a=>`
      <div class="activity-item">
        <div class="d-flex justify-content-between flex-wrap">
          <div class="flex-grow-1 mb-2">
            <strong style="font-size: 1.3rem;">${a.title||''}</strong>
            <div class="text-muted mb-2" style="font-size: 1.1rem;">${a.description||''}</div>
            <small class="text-muted" style="font-size: 1rem;"><i class="bi bi-calendar me-2"></i>${formatDate(a.date)}</small>
          </div>
          <span class="status-badge status-${(a.status||'').trim()}">${a.status||''}</span>
        </div>
      </div>
    `).join('');
  }

  // ========== æ´»å‹• ==========
  async function loadActivities(){
    try{
      const r = await callAPI('getActivities');
      allActivities = r.data||[];
      renderActivities(allActivities);
    }catch(err){
      document.getElementById('activitiesList').innerHTML =
        `<div class="text-danger text-center py-5"><h5>è¼‰å…¥å¤±æ•—ï¼š${err.message}</h5></div>`;
    }
  }
  function renderActivities(list){
    const c = document.getElementById('activitiesList');
    if(!list.length){
      c.innerHTML = '<p class="text-muted text-center mb-0 py-4" style="font-size: 1.2rem;">ç›®å‰æ²’æœ‰æ´»å‹•</p>';
      return;
    }
    c.innerHTML = list.map(a=>`
      <div class="activity-item">
        <div class="mb-3">
          <h5 class="mb-2" style="font-size: 1.4rem;">${a.title}</h5>
          <p class="mb-3 text-muted" style="font-size: 1.1rem;">${a.description||''}</p>
          <div class="row g-2 mb-3" style="font-size: 1rem;">
            <div class="col-6"><i class="bi bi-calendar me-2"></i>${formatDate(a.date)}</div>
            <div class="col-6"><i class="bi bi-clock me-2"></i>${a.time||'-'}</div>
            <div class="col-6"><i class="bi bi-geo-alt me-2"></i>${a.location||'-'}</div>
            <div class="col-6"><i class="bi bi-people me-2"></i>${a.currentCount||0}/${a.maxParticipants||0}</div>
          </div>
        </div>
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <span class="status-badge status-${a.status}">${a.status}</span>
            <div class="fw-bold text-primary mt-2" style="font-size: 1.2rem;">${formatCurrency(a.fee||0)}</div>
          </div>
          ${(a.status==='é–‹æ”¾å ±å')? `<button class="btn btn-primary" onclick="registerActivity('${a.id}')"><i class="bi bi-plus-circle me-2"></i>å ±å</button>`:''}
        </div>
      </div>
    `).join('');
  }
  function filterActivities(){
    const s = document.getElementById('activityStatusFilter').value.trim();
    const d = document.getElementById('activityDateFilter').value.trim();
    const kw = document.getElementById('activitySearchFilter').value.trim().toLowerCase();
    let list = [...allActivities];
    if(s) list = list.filter(a=>a.status===s);
    if(d) list = list.filter(a=>(a.date||'').startsWith(d));
    if(kw) list = list.filter(a=>(a.title||'').toLowerCase().includes(kw) ||
                               (a.description||'').toLowerCase().includes(kw) ||
                               (a.location||'').toLowerCase().includes(kw));
    renderActivities(list);
  }
  async function registerActivity(id){
    if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
    try{
      await callAPI('registerActivity',{ lineId:userProfile.userId, activityId:id });
      showNotification('å ±åæˆåŠŸ','success');
      await loadActivities();
      await loadMyRegistrations();
    }catch(err){
      showNotification('å ±åå¤±æ•—ï¼š'+err.message,'error');
    }
  }
  async function loadMyRegistrations(){
    if(!currentUser) return;
    try{
      const r = await callAPI('getMyRegistrations',{ lineId:userProfile.userId });
      renderMyRegistrations(r.data||[]);
    }catch(err){
      document.getElementById('myRegistrations').innerHTML =
        `<div class="text-danger text-center py-4"><h5>è¼‰å…¥å¤±æ•—ï¼š${err.message}</h5></div>`;
    }
  }
  function renderMyRegistrations(list){
    const c = document.getElementById('myRegistrations');
    if(!list.length){
      c.innerHTML='<p class="text-muted text-center mb-0 py-4" style="font-size: 1.2rem;">å°šç„¡å ±å</p>';
      return;
    }
    c.innerHTML = list.map(r=>`
      <div class="activity-item">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
          <div class="flex-grow-1">
            <strong style="font-size: 1.3rem;">${r.activityTitle}</strong>
            <div class="text-muted mb-2 mt-1" style="font-size: 1rem;"><i class="bi bi-calendar me-2"></i>${formatDateTime(r.registrationTime)}</div>
            <small class="text-muted" style="font-size: 1rem;">ç‹€æ…‹ï¼š${r.status}</small>
          </div>
          <div class="text-end">
            <span class="status-badge status-${r.status}">${r.status}</span>
            ${(r.status==='å·²å ±å')? `<div class="mt-2"><button class="btn btn-danger btn-sm" onclick="cancelRegistration('${r.id}')"><i class="bi bi-x-circle me-1"></i>å–æ¶ˆ</button></div>`:''}
          </div>
        </div>
      </div>
    `).join('');
  }
  async function cancelRegistration(regId){
    if(!confirm('ç¢ºå®šå–æ¶ˆé€™ç­†å ±åï¼Ÿ')) return;
    try{
      await callAPI('cancelRegistration',{ lineId:userProfile.userId, registrationId:regId });
      showNotification('å·²å–æ¶ˆ','success');
      await loadMyRegistrations();
      await loadActivities();
    }catch(err){
      showNotification('å–æ¶ˆå¤±æ•—ï¼š'+err.message,'error');
    }
  }

  // ========== å¿—å·¥ ==========
  async function loadVolunteerData(){
    if(!currentUser) return;
    try{
      const r = await callAPI('getVolunteerData',{ lineId:userProfile.userId });
      const s = r.data.stats;
      document.getElementById('volunteerHours').textContent = s.totalHours||0;
      document.getElementById('volunteerActivities').textContent = s.totalActivities||0;
      document.getElementById('volunteerRank').textContent = s.rank||'-';
      document.getElementById('availableNeeds').textContent = s.availableNeeds||0;
      renderVolunteerNeeds(r.data.needs||[]);
      renderVolunteerRecords(r.data.records||[]);
    }catch(err){
      console.error(err);
    }
  }
  function renderVolunteerNeeds(list){
    const c = document.getElementById('volunteerNeeds');
    if(!list.length){
      c.innerHTML='<p class="text-muted text-center mb-0 py-4" style="font-size: 1.2rem;">ç„¡å¿—å·¥éœ€æ±‚</p>';
      return;
    }
    c.innerHTML = list.map(n=>`
      <div class="activity-item">
        <div class="mb-3">
          <strong style="font-size: 1.3rem;">${n.title}</strong>
          <div class="text-muted mb-3 mt-1" style="font-size: 1.1rem;">${n.description||''}</div>
          <div class="row g-2 mb-3" style="font-size: 1rem;">
            <div class="col-6"><i class="bi bi-calendar me-2"></i>${formatDate(n.date)}</div>
            <div class="col-6"><i class="bi bi-clock me-2"></i>${n.time||'-'}</div>
            <div class="col-6"><i class="bi bi-people me-2"></i>${n.currentCount||0}/${n.needCount}</div>
            <div class="col-6"><i class="bi bi-award me-2"></i>${n.hours} å°æ™‚</div>
          </div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <span class="status-badge status-${n.status}">${n.status}</span>
          ${(n.status==='é–‹æ”¾å ±å')? `<button class="btn btn-success" onclick="applyVolunteer('${n.id}')"><i class="bi bi-hand-thumbs-up me-2"></i>å ±å</button>`:''}
        </div>
      </div>
    `).join('');
  }
  function renderVolunteerRecords(list){
    const c = document.getElementById('myVolunteerRecords');
    if(!list.length){
      c.innerHTML='<p class="text-muted text-center mb-0 py-4" style="font-size: 1.2rem;">å°šç„¡è¨˜éŒ„</p>';
      return;
    }
    c.innerHTML = list.map(r=>`
      <div class="activity-item">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <strong style="font-size: 1.3rem;">${r.title}</strong>
            <div class="text-muted mb-2 mt-1" style="font-size: 1rem;"><i class="bi bi-calendar me-2"></i>${formatDate(r.date)} / ${r.hours} å°æ™‚</div>
            <small class="text-muted" style="font-size: 1rem;">${r.status}</small>
          </div>
          <span class="status-badge status-${r.status}">${r.status}</span>
        </div>
      </div>
    `).join('');
  }
  async function applyVolunteer(id){
    if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
    try{
      await callAPI('applyVolunteer',{ lineId:userProfile.userId, needId:id });
      showNotification('å ±åæˆåŠŸ','success');
      await loadVolunteerData();
    }catch(err){
      showNotification('å ±åå¤±æ•—ï¼š'+err.message,'error');
    }
  }

  // ========== è²¡å‹™ ==========
  async function loadFinanceData(){
    if(!currentUser) return;
    try{
      const r = await callAPI('getFinanceData',{ lineId:userProfile.userId });
      const s = r.data.stats;
      document.getElementById('myDonationAmount').textContent = formatCurrency(s.totalDonation||0).replace('NT$','');
      document.getElementById('myDonationCount').textContent = s.donationCount||0;
      document.getElementById('myExpenseAmount').textContent = formatCurrency(s.totalExpense||0).replace('NT$','');
      document.getElementById('pendingExpenses').textContent = s.pendingExpenses||0;
      renderDonationHistory(r.data.donations||[]);
      renderExpenseHistory(r.data.expenses||[]);
      if(r.data.adminStats && isAdmin) updateAdminFinanceStats(r.data.adminStats);
    }catch(err){ console.error(err); }
  }
  function renderDonationHistory(list){
    const c = document.getElementById('donationHistory');
    if(!list.length){
      c.innerHTML = '<p class="text-muted text-center mb-0 py-4" style="font-size: 1.2rem;">å°šç„¡ææ¬¾</p>';
      return;
    }
    c.innerHTML = list.map(d=>`
      <div class="transaction-item">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div class="flex-grow-1">
            <strong style="font-size: 1.3rem;">ææ¬¾ - ${d.category}</strong>
            <div class="text-muted mb-2 mt-1" style="font-size: 1.1rem;">${d.description||''}</div>
            <small class="text-muted" style="font-size: 1rem;"><i class="bi bi-calendar me-2"></i>${formatDateTime(d.date)}</small>
          </div>
          <div class="text-end">
            <div class="fw-bold text-success mb-1" style="font-size: 1.3rem;">${formatCurrency(d.amount)}</div>
            <small class="text-muted" style="font-size: 1rem;">æ”¶æ“šï¼š${d.receiptNumber||'è™•ç†ä¸­'}</small>
          </div>
        </div>
      </div>
    `).join('');
  }
  function renderExpenseHistory(list){
    const c = document.getElementById('expenseHistory');
    if(!list.length){
      c.innerHTML = '<p class="text-muted text-center mb-0 py-4" style="font-size: 1.2rem;">å°šç„¡æ”¯å‡º</p>'; return;
    }
    c.innerHTML = list.map(e=>`
      <div class="transaction-item">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div class="flex-grow-1">
            <strong style="font-size: 1.3rem;">æ”¯å‡º - ${e.category}</strong>
            <div class="text-muted mb-2 mt-1" style="font-size: 1.1rem;">${e.description||''}</div>
            <small class="text-muted" style="font-size: 1rem;"><i class="bi bi-calendar me-2"></i>${formatDateTime(e.date)}</small>
          </div>
          <div class="text-end">
            <div class="fw-bold text-danger mb-2" style="font-size: 1.3rem;">${formatCurrency(e.amount)}</div>
            <span class="status-badge status-${e.status}">${e.status}</span>
          </div>
        </div>
      </div>
    `).join('');
  }
  function updateAdminFinanceStats(s){
    document.getElementById('totalIncome').textContent = formatCurrency(s.totalIncome);
    document.getElementById('totalExpense').textContent = formatCurrency(s.totalExpense);
    document.getElementById('currentBalance').textContent = formatCurrency(s.currentBalance);
    document.getElementById('monthlyDonations').textContent = formatCurrency(s.monthlyDonations);
  }

  // ææ¬¾ Modal
  function showNewDonationModal(){
    if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
    const html = `
      <div class="modal fade" id="donationModal" tabindex="-1">
        <div class="modal-dialog">
          <form class="modal-content" id="donationForm">
            <div class="modal-header" style="padding: 25px;">
              <h5 class="modal-title" style="font-size: 1.4rem;"><i class="bi bi-heart-fill me-2"></i>æ„›å¿ƒææ¬¾</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" style="font-size: 1.2rem;"></button>
            </div>
            <div class="modal-body" style="padding: 25px;">
              <div class="form-floating mb-4">
                <select class="form-select" id="donationCategory" name="donationCategory" required>
                  <option value="">é¸æ“‡é¡åˆ¥</option>
                  <option value="ä¸€èˆ¬ææ¬¾">ä¸€èˆ¬ææ¬¾</option>
                  <option value="æ´»å‹•è´ŠåŠ©">æ´»å‹•è´ŠåŠ©</option>
                  <option value="è¨­å‚™è³¼ç½®">è¨­å‚™è³¼ç½®</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <label for="donationCategory">ææ¬¾é¡åˆ¥ *</label>
              </div>
              <div class="form-floating mb-4">
                <input type="number" class="form-control" id="donationAmount" name="donationAmount" min="1" required>
                <label for="donationAmount">é‡‘é¡ *</label>
              </div>
              <div class="form-floating mb-4">
                <textarea class="form-control" id="donationDescription" name="donationDescription" style="height:120px;"></textarea>
                <label for="donationDescription">å‚™è¨»</label>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="needReceipt" name="needReceipt" checked style="transform: scale(1.3);">
                <label class="form-check-label" for="needReceipt" style="font-size: 1.1rem; margin-left: 10px;">éœ€è¦æ”¶æ“š</label>
              </div>
            </div>
            <div class="modal-footer" style="padding: 25px;">
              <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
              <button class="btn btn-success btn-lg" type="submit"><i class="bi bi-heart-fill me-2"></i>ç¢ºèª</button>
            </div>
          </form>
        </div>
      </div>`;
    document.getElementById('modalContainer').innerHTML=html;
    const modal = new bootstrap.Modal(document.getElementById('donationModal'));
    modal.show();
    document.getElementById('donationForm').addEventListener('submit',handleDonationSubmit);
  }
  async function handleDonationSubmit(e){
    e.preventDefault();
    const fd = new FormData(e.target);
    const btn = e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn,true);
    try{
      await callAPI('createDonation',{
        lineId:userProfile.userId,
        category:fd.get('donationCategory'),
        amount:parseInt(fd.get('donationAmount'),10),
        description:fd.get('donationDescription'),
        needReceipt: fd.get('needReceipt')==='on'
      });
      showNotification('ææ¬¾æˆåŠŸ','success');
      bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
      await loadFinanceData();
    }catch(err){
      showNotification('ææ¬¾å¤±æ•—ï¼š'+err.message,'error');
    }finally{ setButtonLoading(btn,false); }
  }

  // æ”¯å‡ºç”³è«‹
  function showNewExpenseModal(){
    if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
    const html=`
      <div class="modal fade" id="expenseModal" tabindex="-1">
        <div class="modal-dialog">
          <form class="modal-content" id="expenseForm">
            <div class="modal-header" style="padding: 25px;">
              <h5 class="modal-title" style="font-size: 1.4rem;"><i class="bi bi-receipt me-2"></i>æ”¯å‡ºç”³è«‹</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" style="font-size: 1.2rem;"></button>
            </div>
            <div class="modal-body" style="padding: 25px;">
              <div class="form-floating mb-4">
                <select class="form-select" id="expenseCategory" name="expenseCategory" required>
                  <option value="">é¸æ“‡åˆ†é¡</option>
                  <option value="æ´»å‹•è²»ç”¨">æ´»å‹•è²»ç”¨</option>
                  <option value="è¨­å‚™è€—æ">è¨­å‚™è€—æ</option>
                  <option value="è¡Œæ”¿æ”¯å‡º">è¡Œæ”¿æ”¯å‡º</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <label for="expenseCategory">æ”¯å‡ºåˆ†é¡ *</label>
              </div>
              <div class="form-floating mb-4">
                <input type="number" class="form-control" id="expenseAmount" name="expenseAmount" min="1" required>
                <label for="expenseAmount">é‡‘é¡ *</label>
              </div>
              <div class="form-floating mb-4">
                <textarea class="form-control" id="expenseDescription" name="expenseDescription" style="height:120px;"></textarea>
                <label for="expenseDescription">èªªæ˜</label>
              </div>
              <small class="text-muted" style="font-size: 1rem;">ï¼ˆæ”¶æ“šå½±åƒä¸Šå‚³åŠŸèƒ½å¯æ—¥å¾Œæ“´å……ï¼‰</small>
            </div>
            <div class="modal-footer" style="padding: 25px;">
              <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
              <button class="btn btn-warning btn-lg" type="submit"><i class="bi bi-send me-2"></i>é€å‡º</button>
            </div>
          </form>
        </div>
      </div>`;
    document.getElementById('modalContainer').innerHTML=html;
    const modal=new bootstrap.Modal(document.getElementById('expenseModal'));
    modal.show();
    document.getElementById('expenseForm').addEventListener('submit',handleExpenseSubmit);
  }
  async function handleExpenseSubmit(e){
    e.preventDefault();
    const fd = new FormData(e.target);
    const btn = e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn,true);
    try{
      await callAPI('createExpense',{
        lineId:userProfile.userId,
        category:fd.get('expenseCategory'),
        amount:parseInt(fd.get('expenseAmount'),10),
        description:fd.get('expenseDescription')
      });
      showNotification('æ”¯å‡ºç”³è«‹å·²é€å‡º','success');
      bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
      await loadFinanceData();
    }catch(err){
      showNotification('ç”³è«‹å¤±æ•—ï¼š'+err.message,'error');
    }finally{ setButtonLoading(btn,false); }
  }

  // å¿—å·¥éœ€æ±‚æ–°å¢ (Admin)
  function showNewVolunteerNeedModal(){
    if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
    const html=`
      <div class="modal fade" id="volNeedModal" tabindex="-1">
        <div class="modal-dialog">
          <form class="modal-content" id="volNeedForm">
            <div class="modal-header" style="padding: 25px;">
              <h5 class="modal-title" style="font-size: 1.4rem;"><i class="bi bi-plus-circle me-2"></i>æ–°å¢å¿—å·¥éœ€æ±‚</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" style="font-size: 1.2rem;"></button>
            </div>
            <div class="modal-body" style="padding: 25px;">
              <div class="form-floating mb-4">
                <input type="text" class="form-control" id="needTitle" name="needTitle" required>
                <label for="needTitle">æ¨™é¡Œ *</label>
              </div>
              <div class="form-floating mb-4">
                <textarea class="form-control" id="needDesc" name="needDesc" style="height:120px;"></textarea>
                <label for="needDesc">æè¿°</label>
              </div>
              <div class="form-floating mb-4">
                <input type="date" class="form-control" id="needDate" name="needDate" required>
                <label for="needDate">æ—¥æœŸ *</label>
              </div>
              <div class="form-floating mb-4">
                <input type="text" class="form-control" id="needTime" name="needTime" placeholder="09:00-12:00">
                <label for="needTime">æ™‚é–“</label>
              </div>
              <div class="form-floating mb-4">
                <input type="number" class="form-control" id="needCount" name="needCount" min="1" required>
                <label for="needCount">éœ€æ±‚äººæ•¸ *</label>
              </div>
              <div class="form-floating mb-4">
                <input type="number" class="form-control" id="needHours" name="needHours" min="1" required>
                <label for="needHours">æ™‚æ•¸ *</label>
              </div>
            </div>
            <div class="modal-footer" style="padding: 25px;">
              <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
              <button class="btn btn-success btn-lg" type="submit"><i class="bi bi-save me-2"></i>å»ºç«‹</button>
            </div>
          </form>
        </div>
      </div>`;
    document.getElementById('modalContainer').innerHTML=html;
    const modal=new bootstrap.Modal(document.getElementById('volNeedModal'));
    modal.show();
    document.getElementById('volNeedForm').addEventListener('submit',handleVolunteerNeedSubmit);
  }
  async function handleVolunteerNeedSubmit(e){
    e.preventDefault();
    const fd=new FormData(e.target);
    const btn=e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn,true);
    try{
      await callAPI('createVolunteerNeed',{
        lineId:userProfile.userId,
        title:fd.get('needTitle'),
        description:fd.get('needDesc'),
        date:fd.get('needDate'),
        time:fd.get('needTime'),
        needCount:parseInt(fd.get('needCount'),10),
        hours:parseInt(fd.get('needHours'),10)
      });
      showNotification('éœ€æ±‚å·²å»ºç«‹','success');
      bootstrap.Modal.getInstance(document.getElementById('volNeedModal')).hide();
      await loadVolunteerData();
    }catch(err){
      showNotification('å»ºç«‹å¤±æ•—ï¼š'+err.message,'error');
    }finally{ setButtonLoading(btn,false); }
  }

  // æ´»å‹•æ–°å¢ (Admin)
  function showNewActivityModal(){
    if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
    const html=`
      <div class="modal fade" id="activityModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <form class="modal-content" id="activityForm">
            <div class="modal-header" style="padding: 25px;">
              <h5 class="modal-title" style="font-size: 1.4rem;"><i class="bi bi-plus-circle me-2"></i>æ–°å¢æ´»å‹•</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" style="font-size: 1.2rem;"></button>
            </div>
            <div class="modal-body row g-4" style="padding: 25px;">
              <div class="col-12">
                <div class="form-floating">
                  <input type="text" class="form-control" id="actTitle" name="actTitle" required>
                  <label for="actTitle">æ¨™é¡Œ *</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <input type="date" class="form-control" id="actDate" name="actDate" required>
                  <label for="actDate">æ—¥æœŸ *</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <input type="text" class="form-control" id="actTime" name="actTime" placeholder="09:00-11:00">
                  <label for="actTime">æ™‚é–“</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <input type="text" class="form-control" id="actLocation" name="actLocation">
                  <label for="actLocation">åœ°é»</label>
                </div>
              </div>
              <div class="col-6">
                <div class="form-floating">
                  <input type="number" class="form-control" id="actMax" name="actMax" min="1" required>
                  <label for="actMax">åé¡ *</label>
                </div>
              </div>
              <div class="col-6">
                <div class="form-floating">
                  <input type="number" class="form-control" id="actFee" name="actFee" min="0" value="0">
                  <label for="actFee">è²»ç”¨</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <textarea class="form-control" id="actDesc" name="actDesc" style="height:140px;"></textarea>
                  <label for="actDesc">æè¿°</label>
                </div>
              </div>
            </div>
            <div class="modal-footer" style="padding: 25px;">
              <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
              <button class="btn btn-success btn-lg" type="submit"><i class="bi bi-save me-2"></i>å»ºç«‹</button>
            </div>
          </form>
        </div>
      </div>`;
    document.getElementById('modalContainer').innerHTML=html;
    const modal=new bootstrap.Modal(document.getElementById('activityModal'));
    modal.show();
    document.getElementById('activityForm').addEventListener('submit',handleActivityCreate);
  }
  async function handleActivityCreate(e){
    e.preventDefault();
    const fd=new FormData(e.target);
    const btn=e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn,true);
    try{
      await callAPI('createActivity',{
        lineId:userProfile.userId,
        title:fd.get('actTitle'),
        date:fd.get('actDate'),
        time:fd.get('actTime'),
        location:fd.get('actLocation'),
        maxParticipants:parseInt(fd.get('actMax'),10),
        fee:parseInt(fd.get('actFee')||'0',10),
        description:fd.get('actDesc')
      });
      showNotification('æ´»å‹•å·²å»ºç«‹','success');
      bootstrap.Modal.getInstance(document.getElementById('activityModal')).hide();
      await loadActivities();
      if(isAdmin) await loadAdminData();
    }catch(err){
      showNotification('å»ºç«‹å¤±æ•—ï¼š'+err.message,'error');
    }finally{ setButtonLoading(btn,false); }
  }

  // å…¶ä»– Admin Modal å‡½æ•¸ä¿æŒåŸæ¨£ï¼Œä½†å¢åŠ æ¨£å¼å„ªåŒ–
  function showNewTransactionModal(){
    if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
    const html=`
      <div class="modal fade" id="txModal" tabindex="-1">
        <div class="modal-dialog">
          <form class="modal-content" id="txForm">
            <div class="modal-header" style="padding: 25px;">
              <h5 class="modal-title" style="font-size: 1.4rem;"><i class="bi bi-plus-circle me-2"></i>å¿«é€Ÿæ–°å¢äº¤æ˜“</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" style="font-size: 1.2rem;"></button>
            </div>
            <div class="modal-body" style="padding: 25px;">
              <div class="form-floating mb-4">
                <select class="form-select" id="txType" name="txType" required>
                  <option value="">é¸æ“‡é¡å‹</option>
                  <option value="donation">ææ¬¾(æ”¶å…¥)</option>
                  <option value="expense">æ”¯å‡º</option>
                </select>
                <label for="txType">é¡å‹ *</label>
              </div>
              <div class="form-floating mb-4">
                <input class="form-control" id="txCategory" name="txCategory" required>
                <label for="txCategory">åˆ†é¡ *</label>
              </div>
              <div class="form-floating mb-4">
                <input type="number" class="form-control" id="txAmount" name="txAmount" min="1" required>
                <label for="txAmount">é‡‘é¡ *</label>
              </div>
              <div class="form-floating mb-4">
                <textarea class="form-control" id="txDesc" name="txDesc" style="height:120px;"></textarea>
                <label for="txDesc">èªªæ˜</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="txNeedReceipt" name="txNeedReceipt" style="transform: scale(1.3);">
                <label class="form-check-label" for="txNeedReceipt" style="font-size: 1.1rem; margin-left: 10px;">éœ€è¦æ”¶æ“š(åƒ…ææ¬¾)</label>
              </div>
            </div>
            <div class="modal-footer" style="padding: 25px;">
              <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
              <button class="btn btn-primary btn-lg" type="submit"><i class="bi bi-check2 me-2"></i>é€å‡º</button>
            </div>
          </form>
        </div>
      </div>`;
    document.getElementById('modalContainer').innerHTML=html;
    const modal=new bootstrap.Modal(document.getElementById('txModal'));
    modal.show();
    document.getElementById('txForm').addEventListener('submit',handleQuickTransactionSubmit);
  }
  async function handleQuickTransactionSubmit(e){
    e.preventDefault();
    const fd=new FormData(e.target);
    const type=fd.get('txType');
    const btn=e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn,true);
    try{
      if(type==='donation'){
        await callAPI('createDonation',{
          lineId:userProfile.userId,
          category:fd.get('txCategory'),
          amount:parseInt(fd.get('txAmount'),10),
          description:fd.get('txDesc'),
          needReceipt: fd.get('txNeedReceipt')==='on'
        });
      }else if(type==='expense'){
        await callAPI('createExpense',{
          lineId:userProfile.userId,
          category:fd.get('txCategory'),
          amount:parseInt(fd.get('txAmount'),10),
          description:fd.get('txDesc')
        });
      }else{
        throw new Error('æœªé¸æ“‡é¡å‹');
      }
      showNotification('å»ºç«‹æˆåŠŸ','success');
      bootstrap.Modal.getInstance(document.getElementById('txModal')).hide();
      await loadFinanceData();
      if(isAdmin) await loadAdminData();
    }catch(err){
      showNotification('å»ºç«‹å¤±æ•—ï¼š'+err.message,'error');
    }finally{ setButtonLoading(btn,false); }
  }

  function showManualReceiptModal(){
    if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
    const html=`
      <div class="modal fade" id="manualReceiptModal" tabindex="-1">
        <div class="modal-dialog">
          <form class="modal-content" id="manualReceiptForm">
            <div class="modal-header" style="padding: 25px;">
              <h5 class="modal-title" style="font-size: 1.4rem;"><i class="bi bi-receipt-cutoff me-2"></i>æ‰‹å‹•é–‹ç«‹æ”¶æ“š</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" style="font-size: 1.2rem;"></button>
            </div>
            <div class="modal-body" style="padding: 25px;">
              <div class="form-floating mb-4">
                <input class="form-control" id="receiptLineId" name="receiptLineId" placeholder="LINE ID" required>
                <label for="receiptLineId">æœƒå“¡ LINE ID *</label>
              </div>
              <div class="form-floating mb-4">
                <select class="form-select" id="receiptType" name="receiptType" required>
                  <option value="">é¸æ“‡é¡åˆ¥</option>
                  <option value="ææ¬¾">ææ¬¾</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <label for="receiptType">é¡åˆ¥ *</label>
              </div>
              <div class="form-floating mb-4">
                <input type="number" class="form-control" id="receiptAmount" name="receiptAmount" min="1" required>
                <label for="receiptAmount">é‡‘é¡ *</label>
              </div>
            </div>
            <div class="modal-footer" style="padding: 25px;">
              <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
              <button class="btn btn-success btn-lg" type="submit"><i class="bi bi-save me-2"></i>é–‹ç«‹</button>
            </div>
          </form>
        </div>
      </div>`;
    document.getElementById('modalContainer').innerHTML=html;
    const m=new bootstrap.Modal(document.getElementById('manualReceiptModal'));
    m.show();
    document.getElementById('manualReceiptForm').addEventListener('submit',handleManualReceiptSubmit);
  }
  async function handleManualReceiptSubmit(e){
    e.preventDefault();
    const fd=new FormData(e.target);
    const btn=e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn,true);
    try{
      await callAPI('createManualReceipt',{
        lineId:userProfile.userId,
        targetLineId:fd.get('receiptLineId'),
        type:fd.get('receiptType'),
        amount:parseInt(fd.get('receiptAmount'),10)
      });
      showNotification('æ”¶æ“šå·²é–‹ç«‹','success');
      bootstrap.Modal.getInstance(document.getElementById('manualReceiptModal')).hide();
      if(isAdmin) await loadAdminData();
    }catch(err){
      showNotification('é–‹ç«‹å¤±æ•—ï¼š'+err.message,'error');
    }finally{ setButtonLoading(btn,false); }
  }

  function showReceiptTemplateModal(){
    showNotification('æ¨¡æ¿è¨­å®šå°šæœªå¯¦ä½œï¼Œå¯å¾ŒçºŒæ“´å……','warning',3500);
  }

  function showSystemNotificationModal(){
    if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
    const html=`
      <div class="modal fade" id="sysNotifyModal" tabindex="-1">
        <div class="modal-dialog">
          <form class="modal-content" id="sysNotifyForm">
            <div class="modal-header" style="padding: 25px;">
              <h5 class="modal-title" style="font-size: 1.4rem;"><i class="bi bi-megaphone me-2"></i>ç™¼é€ç³»çµ±é€šçŸ¥</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" style="font-size: 1.2rem;"></button>
            </div>
            <div class="modal-body" style="padding: 25px;">
              <div class="form-floating mb-3">
                <textarea class="form-control" id="notifyMessage" name="notifyMessage" style="height:160px;" required></textarea>
                <label for="notifyMessage">é€šçŸ¥å…§å®¹ *</label>
              </div>
              <small class="text-muted d-block" style="font-size: 1rem;">ï¼ˆæ­¤åŠŸèƒ½ç›®å‰ç‚ºç¤ºæ„ï¼Œå¯æ¥ LINE BOT æ¨æ’­ï¼‰</small>
            </div>
            <div class="modal-footer" style="padding: 25px;">
              <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
              <button class="btn btn-info btn-lg" type="submit"><i class="bi bi-send me-2"></i>ç™¼é€</button>
            </div>
          </form>
        </div>
      </div>`;
    document.getElementById('modalContainer').innerHTML=html;
    const m=new bootstrap.Modal(document.getElementById('sysNotifyModal'));
    m.show();
    document.getElementById('sysNotifyForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('sendSystemNotification',{
          lineId:userProfile.userId,
          message:fd.get('notifyMessage')
        });
        showNotification('é€šçŸ¥å·²ç™¼é€','success');
        bootstrap.Modal.getInstance(document.getElementById('sysNotifyModal')).hide();
      }catch(err){
        showNotification('ç™¼é€å¤±æ•—ï¼š'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });
  }

  function viewMemberDetail(lineId){
    const member = (cachedAdminData?.members||[]).find(m=>m.lineId===lineId);
    if(!member){ showNotification('æ‰¾ä¸åˆ°æœƒå“¡','error'); return; }
    const html=`
      <div class="modal fade" id="memberDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header" style="padding: 25px;">
              <h5 class="modal-title" style="font-size: 1.4rem;"><i class="bi bi-person me-2"></i>${member.realName||member.lineName||lineId}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" style="font-size: 1.2rem;"></button>
            </div>
            <div class="modal-body" style="padding: 25px;">
              <ul class="list-group" style="font-size: 1.1rem;">
                <li class="list-group-item" style="padding: 15px;"><strong>LINE IDï¼š</strong>${member.lineId}</li>
                <li class="list-group-item" style="padding: 15px;"><strong>å§“åï¼š</strong>${member.realName||'-'}</li>
                <li class="list-group-item" style="padding: 15px;"><strong>é¡åˆ¥ï¼š</strong>${member.memberType||'-'}</li>
                <li class="list-group-item" style="padding: 15px;"><strong>é›»è©±ï¼š</strong>${member.phone||'-'}</li>
                <li class="list-group-item" style="padding: 15px;"><strong>Emailï¼š</strong>${member.email||'-'}</li>
                <li class="list-group-item" style="padding: 15px;"><strong>ç”Ÿæ—¥ï¼š</strong>${member.birthday||'-'}</li>
                <li class="list-group-item" style="padding: 15px;"><strong>åœ°å€ï¼š</strong>${member.address||'-'}</li>
                <li class="list-group-item" style="padding: 15px;"><strong>ç‹€æ…‹ï¼š</strong>${member.status||'-'}</li>
                <li class="list-group-item" style="padding: 15px;"><strong>ææ¬¾æ¬¡æ•¸ï¼š</strong>${member.donationCount||0}</li>
                <li class="list-group-item" style="padding: 15px;"><strong>åŠ å…¥æ—¥æœŸï¼š</strong>${formatDate(member.joinDate)}</li>
              </ul>
            </div>
            <div class="modal-footer" style="padding: 25px;">
              <button class="btn btn-secondary btn-lg" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
          </div>
        </div>
      </div>`;
    document.getElementById('modalContainer').innerHTML=html;
    new bootstrap.Modal(document.getElementById('memberDetailModal')).show();
  }

  // ========== å›é¥‹ ==========
  async function loadFeedbackData(){
    if(!currentUser) return;
    try{
      const acts = await callAPI('getMyCompletedActivities',{ lineId:userProfile.userId });
      populateFeedbackActivities(acts.data||[]);
      const my = await callAPI('getMyFeedback',{ lineId:userProfile.userId });
      renderMyFeedback(my.data||[]);
      if(isAdmin){
        const all = await callAPI('getAllFeedback',{ lineId:userProfile.userId });
        renderAllFeedback(all.data||[]);
      }
    }catch(err){ console.error(err); }
  }
  function populateFeedbackActivities(list){
    const sel=document.getElementById('feedbackActivity');
    sel.innerHTML='<option value="">è«‹é¸æ“‡æ´»å‹•</option>';
    list.forEach(a=>{
      sel.innerHTML += `<option value="${a.id}">${a.title} (${formatDate(a.date)})</option>`;
    });
  }
  function renderMyFeedback(list){
    const c=document.getElementById('myFeedback');
    if(!list.length){ c.innerHTML='<p class="text-muted text-center mb-0 py-4" style="font-size: 1.2rem;">å°šç„¡å›é¥‹</p>'; return; }
    c.innerHTML = list.map(f=>`
      <div class="activity-item">
        <strong style="font-size: 1.3rem;">${f.activityTitle}</strong>
        <div class="mb-2 mt-1" style="font-size: 1.2rem;">${'â˜…'.repeat(f.rating)}${'â˜†'.repeat(5-f.rating)} <span class="text-muted">(${f.rating}/5)</span></div>
        <div class="mb-2" style="font-size: 1.1rem;">${f.comment}</div>
        <small class="text-muted" style="font-size: 1rem;"><i class="bi bi-calendar me-2"></i>${formatDateTime(f.createdAt)}</small>
      </div>
    `).join('');
  }
  function renderAllFeedback(list){
    const c=document.getElementById('allFeedback');
    if(!list.length){ c.innerHTML='<p class="text-muted text-center mb-0 py-4" style="font-size: 1.2rem;">ç„¡è³‡æ–™</p>'; return; }
    c.innerHTML = list.map(f=>`
      <div class="activity-item">
        <div class="d-flex justify-content-between flex-wrap gap-2">
          <div class="flex-grow-1">
            <strong style="font-size: 1.3rem;">${f.activityTitle}</strong>
            <div class="mb-2 mt-1" style="font-size: 1.2rem;">${'â˜…'.repeat(f.rating)}${'â˜†'.repeat(5-f.rating)} <span class="text-muted">(${f.rating}/5)</span></div>
            <div class="mb-2" style="font-size: 1.1rem;">${f.comment}</div>
            <small class="text-muted" style="font-size: 1rem;">${formatDateTime(f.createdAt)}</small>
          </div>
          <small class="text-muted" style="font-size: 1rem;">${f.lineId}</small>
        </div>
      </div>
    `).join('');
  }
  document.getElementById('feedbackForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    const btn=e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn,true);
    try{
      await callAPI('createFeedback',{
        lineId:userProfile.userId,
        activityId:fd.get('feedbackActivity'),
        rating:parseInt(fd.get('feedbackRating'),10),
        comment:fd.get('feedbackComment')
      });
      showNotification('å›é¥‹å·²æäº¤','success');
      e.target.reset();
      await loadFeedbackData();
    }catch(err){
      showNotification('æäº¤å¤±æ•—ï¼š'+err.message,'error');
    }finally{ setButtonLoading(btn,false); }
  });

  // ========== Admin è³‡æ–™ ==========
  async function loadAdminData(){
    if(!isAdmin) return;
    try{
      const r=await callAPI('getAdminData',{ lineId:userProfile.userId });
      cachedAdminData=r.data;
      renderMemberList(r.data.members||[]);
      renderAdminActivities(r.data.activities||[]);
      renderTransactions(r.data.transactions||[]);
      renderReceipts(r.data.receipts||[]);
    }catch(err){ console.error(err); }
  }
  function renderMemberList(list){
    const tb=document.getElementById('memberList');
    if(!list.length){
      tb.innerHTML='<tr><td colspan="6" class="text-center text-muted py-4" style="font-size: 1.1rem;">æš«ç„¡è³‡æ–™</td></tr>'; return;
    }
    tb.innerHTML=list.map(m=>`
      <tr>
        <td style="font-size: 1rem;">${m.realName||m.lineName||'-'}</td>
        <td style="font-size: 1rem;">${m.memberType||'-'}</td>
        <td><span class="status-badge status-${m.status||''}">${m.status||''}</span></td>
        <td style="font-size: 1rem;">${formatDate(m.joinDate)}</td>
        <td style="font-size: 1rem;">${m.donationCount||0}</td>
        <td><button class="btn btn-outline-primary" onclick="viewMemberDetail('${m.lineId}')"><i class="bi bi-eye"></i></button></td>
      </tr>
    `).join('');
  }
  function renderAdminActivities(list){
    const c=document.getElementById('adminActivityList');
    if(!list.length){
      c.innerHTML='<p class="text-muted text-center mb-0 py-4" style="font-size: 1.2rem;">ç„¡æ´»å‹•</p>'; return;
    }
    c.innerHTML=list.map(a=>`
      <div class="activity-item">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div class="flex-grow-1">
            <strong style="font-size: 1.3rem;">${a.title}</strong>
            <div class="text-muted mt-1" style="font-size: 1.1rem;">${formatDate(a.date)} / ${a.location||''}</div>
          </div>
          <div class="text-end">
            <span class="status-badge status-${a.status}">${a.status}</span>
            <div class="mt-2" style="font-size: 1rem;">${a.currentCount||0}/${a.maxParticipants||0}</div>
          </div>
        </div>
      </div>
    `).join('');
  }
  function renderTransactions(list){
    const tb=document.getElementById('transactionList');
    if(!list.length){ tb.innerHTML='<tr><td colspan="6" class="text-center text-muted py-4" style="font-size: 1.1rem;">ç„¡äº¤æ˜“</td></tr>'; return; }
    tb.innerHTML=list.map(t=>`
      <tr>
        <td style="font-size: 0.9rem;">${formatDateTime(t.date)}</td>
        <td style="font-size: 1rem;">${t.type}</td>
        <td class="${t.type==='æ”¶å…¥'?'text-success':'text-danger'}" style="font-size: 1rem;">${formatCurrency(t.amount)}</td>
        <td style="font-size: 1rem;">${t.category||''}</td>
        <td style="font-size: 0.9rem;">${t.description||''}</td>
        <td>${t.status? `<span class="status-badge status-${t.status}">${t.status}</span>`:''}</td>
      </tr>
    `).join('');
  }
  function renderReceipts(list){
    const c=document.getElementById('receiptList');
    if(!list.length){ c.innerHTML='<p class="text-muted text-center mb-0 py-4" style="font-size: 1.2rem;">å°šç„¡æ”¶æ“š</p>'; return; }
    c.innerHTML=list.map(r=>`
      <div class="transaction-item">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div class="flex-grow-1">
            <strong style="font-size: 1.3rem;">${r.receiptNumber}</strong>
            <div class="text-muted mt-1" style="font-size: 1.1rem;">${formatDate(r.issueDate)} / ${r.type}</div>
          </div>
          <div class="text-end">
            <div class="fw-bold mb-2" style="font-size: 1.2rem;">${formatCurrency(r.amount)}</div>
            <span class="status-badge status-${r.status}">${r.status}</span>
          </div>
        </div>
      </div>
    `).join('');
  }

  // åŒ¯å‡º / å‚™ä»½
  async function exportMembers(){
    if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
    try{
      const r=await callAPI('exportMembers',{ lineId:userProfile.userId });
      showNotification('æœƒå“¡è³‡æ–™åŒ¯å‡ºæˆåŠŸ (è‡³é›²ç«¯ç¡¬ç¢Ÿ)','success');
      console.log(r.data);
    }catch(err){ showNotification('åŒ¯å‡ºå¤±æ•—ï¼š'+err.message,'error'); }
  }
  async function exportFinanceData(){
    if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
    try{
      const r=await callAPI('exportFinanceData',{ lineId:userProfile.userId });
      showNotification('è²¡å‹™è³‡æ–™åŒ¯å‡ºæˆåŠŸ','success');
      console.log(r.data);
    }catch(err){ showNotification('åŒ¯å‡ºå¤±æ•—ï¼š'+err.message,'error'); }
  }
  async function backupSystem(){
    if(!isAdmin){ showNotification('æ¬Šé™ä¸è¶³','error'); return; }
    try{
      const r=await callAPI('backupSystem',{ lineId:userProfile.userId });
      showNotification('å‚™ä»½å®Œæˆ','success');
      console.log(r.data);
    }catch(err){ showNotification('å‚™ä»½å¤±æ•—ï¼š'+err.message,'error'); }
  }

  // ========== åˆ·æ–° ==========
  async function refreshData(){
    try{
      await Promise.all([
        loadDashboard(),
        loadActivities(),
        loadMyRegistrations(),
        loadVolunteerData(),
        loadFinanceData(),
        loadFeedbackData(),
        isAdmin? loadAdminData(): Promise.resolve()
      ]);
      showNotification('è³‡æ–™å·²åˆ·æ–°','success');
    }catch(err){
      showNotification('åˆ·æ–°å¤±æ•—ï¼š'+err.message,'error');
    }
  }

  // ========== Tab åˆ‡æ›äº‹ä»¶ ==========
  document.addEventListener('DOMContentLoaded',()=>{
    document.querySelectorAll('[data-bs-toggle="pill"]').forEach(btn=>{
      btn.addEventListener('shown.bs.tab',e=>{
        const id = e.target.getAttribute('data-bs-target').substring(1);
        switch(id){
          case 'activities': loadActivities(); loadMyRegistrations(); break;
          case 'volunteer': loadVolunteerData(); break;
          case 'finance': loadFinanceData(); break;
          case 'feedback': loadFeedbackData(); break;
          case 'admin': if(isAdmin) loadAdminData(); break;
        }
      });
    });
  });

  // ç¦ç”¨é textarea Enter submit
  document.addEventListener('keydown',e=>{
    if(e.key==='Enter' && !['TEXTAREA','BUTTON'].includes(e.target.tagName)){
      e.preventDefault();
    }
  });

  // å…¨åŸŸçµ¦æŒ‰éˆ•ä½¿ç”¨
  window.showTab = id=>{
    const btn=document.querySelector(`button[data-bs-target="#${id}"]`);
    if(btn) btn.click();
  };
  window.refreshData = refreshData;
  window.registerActivity = registerActivity;
  window.cancelRegistration = cancelRegistration;
  window.applyVolunteer = applyVolunteer;
  window.showNewDonationModal = showNewDonationModal;
  window.showNewExpenseModal = showNewExpenseModal;
  window.showNewActivityModal = showNewActivityModal;
  window.showNewVolunteerNeedModal = showNewVolunteerNeedModal;
  window.showNewTransactionModal = showNewTransactionModal;
  window.showManualReceiptModal = showManualReceiptModal;
  window.showReceiptTemplateModal = showReceiptTemplateModal;
  window.showSystemNotificationModal = showSystemNotificationModal;
  window.exportMembers = exportMembers;
  window.exportFinanceData = exportFinanceData;
  window.backupSystem = backupSystem;
  window.viewMemberDetail = viewMemberDetail;
  window.filterActivities = filterActivities;
  window.loadDashboard = loadDashboard;

  window.addEventListener('load',initializeLiff);
</script>
</body>
</html>
