
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root{
      --base-font-size:18px;
      --heading-color:#222;
    }
    body{
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial,sans-serif;
      font-size: var(--base-font-size);
      line-height:1.55;
      background: linear-gradient(135deg,#667eea,#764ba2);
      min-height:100vh;
      padding:18px;
      color:#222;
    }
    h1,h2,h3,h4,h5{
      color:var(--heading-color);
      line-height:1.3;
    }
    h1{font-size:2.2rem;}
    h2{font-size:1.9rem;}
    h3{font-size:1.55rem;}
    h4{font-size:1.35rem;}
    h5{font-size:1.18rem;}
    .nav-pills .nav-link{
      font-size:1.05rem;
      padding:12px 22px;
    }
    .btn{
      font-size:1rem;
      padding:12px 22px;
    }
    .form-control,.form-select{
      font-size:1rem;
      padding:12px 14px;
    }
    .table td,.table th{
      font-size:0.95rem;
      vertical-align:middle;
    }
    .small{font-size:0.85rem !important;}
    .user-info-bar{font-size:1rem;}
    .stat-card h3{font-size:1.9rem;}
    /* é¿å…æ”¾å¤§å¾Œç ´ç‰ˆ */
    @media (max-width: 768px){
      body{font-size:17px;}
      .nav-pills .nav-link{font-size:1rem;}
      h1{font-size:1.9rem;}
      h2{font-size:1.6rem;}
      h3{font-size:1.4rem;}
      .stat-card h3{font-size:1.6rem;}
    }
    /* åŸå…ˆæ¨£å¼ï¼ˆåƒ…ä¿ç•™å¿…è¦ & å­—é«”å·²æ”¾å¤§ï¼‰ */
    .container{max-width:1250px;margin:0 auto;}
    .main-header,.nav-container,.content-card{
      background:rgba(255,255,255,0.94);
      backdrop-filter:blur(10px);
      border-radius:16px;
      padding:28px;
      margin-bottom:18px;
      box-shadow:0 8px 24px rgba(0,0,0,0.18);
    }
    .header-content{
      background:linear-gradient(135deg,#4CAF50,#45a049);
      color:#fff;
      padding:26px;
      margin:-28px -28px 20px -28px;
      border-radius:16px 16px 12px 12px;
    }
    .user-info-bar{
      display:flex;gap:18px;align-items:center;
      background:#fff;
      padding:14px 20px;
      border-radius:40px;
      box-shadow:0 4px 14px rgba(0,0,0,0.08);
      margin-top:8px;
    }
    .user-avatar{
      width:54px;height:54px;
      border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:1.4rem;font-weight:600;
    }
    .quick-actions{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));}
    .quick-btn{
      background:#fff;
      border:2px solid #e2e8f0;
      border-radius:18px;
      padding:22px 12px;
      text-align:center;
      font-weight:600;
      cursor:pointer;
      transition:.3s;
      font-size:1rem;
    }
    .quick-btn i{font-size:2.1rem;margin-bottom:10px;display:block;}
    .quick-btn:hover{
      border-color:#4CAF50;
      color:#4CAF50;
      box-shadow:0 10px 24px rgba(76,175,80,.28);
      transform:translateY(-4px);
    }
    .stat-card{
      border-radius:18px;
      padding:24px;
      color:#fff;
      text-align:center;
      box-shadow:0 6px 18px rgba(0,0,0,0.18);
    }
    .activity-item,.transaction-item{
      background:#f8fafc;
      border-radius:14px;
      padding:20px;
      margin-bottom:14px;
      border-left:5px solid #4CAF50;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
      font-size:0.97rem;
    }
    .activity-item strong{font-size:1.05rem;}
    .status-badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:18px;
      font-size:0.75rem;
      font-weight:600;
      letter-spacing:.5px;
      margin-top:4px;
    }
    .status-é–‹æ”¾å ±å,.status-active{background:#d4edda;color:#155724;}
    .status-å·²å ±å{background:#d1ecf1;color:#0c5460;}
    .status-å·²å–æ¶ˆ,.status-å·²æ‹’çµ•{background:#f8d7da;color:#721c24;}
    .status-å·²å®Œæˆ{background:#e2e3ff;color:#383d41;}
    .status-å¯©æ ¸ä¸­,.status-å ±åæˆªæ­¢{background:#fff3cd;color:#856404;}
    .status-å·²æ ¸å‡†{background:#d4edda;color:#155724;}
    .btn.loading{position:relative;color:transparent !important;}
    .btn.loading:after{
      content:'';
      position:absolute;top:50%;left:50%;width:20px;height:20px;
      margin:-10px;border:3px solid rgba(255,255,255,0.5);
      border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg);}}
    .table-container{max-height:500px;overflow:auto;border:1px solid #e2e8f0;border-radius:12px;background:#fff;}
    .table th{position:sticky;top:0;background:#f1f5f9;z-index:1;}
    .notification{
      position:fixed;top:20px;right:20px;
      background:#fff;padding:16px 20px;
      border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.15);
      transform:translateX(420px);transition:.4s;
      max-width:380px;font-size:1rem;
      border-left:6px solid #4CAF50;z-index:2000;
    }
    .notification.show{transform:translateX(0);}
    .notification.success{background:#d4edda;color:#155724;border-left-color:#4CAF50;}
    .notification.error{background:#f8d7da;color:#721c24;border-left-color:#dc3545;}
    .notification.warning{background:#fff3cd;color:#856404;border-left-color:#ffc107;}
    .notification.info{background:#d1ecf1;color:#0c5460;border-left-color:#17a2b8;}
    /* æ·±è‰²æ¨¡å¼ */
    @media (prefers-color-scheme: dark){
      body{background:#1f2333;color:#e2e8f0;}
      .main-header,.nav-container,.content-card{background:rgba(45,55,72,0.95);}
      .activity-item,.transaction-item{background:#2d3748;color:#e2e8f0;}
      .quick-btn{background:rgba(45,55,72,0.9);color:#e2e8f0;border-color:#4a5568;}
      .table-container{background:#2d3748;}
      .table th{background:#4a5568;color:#fff;}
      .form-control,.form-select{background:#2d3748;border-color:#4a5568;color:#e2e8f0;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-header">
      <div class="header-content">
        <h1 class="mb-2"><i class="bi bi-heart-pulse-fill me-2"></i>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</h1>
        <p class="mb-0" style="font-size:1.05rem;">é—œæ‡·ãƒ»æ”¯æŒãƒ»å…±å¥½</p>
      </div>
      <div id="userInfoBar" class="user-info-bar" style="display:none;">
        <div class="user-avatar" id="userAvatar">?</div>
        <div>
          <div class="fw-bold" id="userName">è¼‰å…¥ä¸­...</div>
          <div class="small text-muted" id="userLineName"></div>
          <div class="small text-muted" id="userRole">æœƒå“¡</div>
        </div>
        <div class="ms-auto">
          <button class="btn btn-sm btn-outline-secondary" onclick="refreshData()" title="åˆ·æ–°"><i class="bi bi-arrow-clockwise"></i></button>
        </div>
      </div>
    </div>

    <div id="notificationContainer"></div>

    <div class="nav-container">
      <ul class="nav nav-pills flex-wrap">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#dashboard">ğŸ  å„€è¡¨æ¿</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#profile">ğŸ‘¤ å€‹äººè³‡æ–™</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#activities">ğŸª æ´»å‹•ç®¡ç†</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#volunteer">ğŸ¤ å¿—å·¥æœå‹™</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#finance">ğŸ’° è²¡å‹™ç®¡ç†</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#feedback">ğŸ’¬ æ´»å‹•å›é¥‹</button></li>
        <li class="nav-item admin-only" style="display:none;"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#admin">âš™ï¸ ç³»çµ±ç®¡ç†</button></li>
      </ul>
    </div>

    <div class="tab-content">
      <!-- Dashboard -->
      <div class="tab-pane fade show active" id="dashboard">
        <div class="content-card">
          <div class="quick-actions mb-4">
            <div class="quick-btn" onclick="showTab('profile')"><i class="bi bi-person-check"></i>æ›´æ–°è³‡æ–™</div>
            <div class="quick-btn" onclick="showTab('activities')"><i class="bi bi-calendar-plus"></i>å ±åæ´»å‹•</div>
            <div class="quick-btn" onclick="showNewDonationModal()"><i class="bi bi-heart-fill"></i>æ„›å¿ƒææ¬¾</div>
            <div class="quick-btn" onclick="showTab('volunteer')"><i class="bi bi-hand-thumbs-up"></i>å¿—å·¥æœå‹™</div>
          </div>
          <div class="row g-3 mb-4" id="dashboardStats">
            <div class="col-12 text-center text-muted">è¼‰å…¥ä¸­...</div>
          </div>
          <div>
            <h5 class="mb-3"><i class="bi bi-clock-history me-2"></i>æœ€è¿‘æ´»å‹•</h5>
            <div id="recentActivity" class="mb-2 text-muted">è¼‰å…¥ä¸­...</div>
          </div>
        </div>
      </div>

      <!-- Profile -->
      <div class="tab-pane fade" id="profile">
        <div class="content-card">
          <h3 class="mb-3"><i class="bi bi-person me-2"></i>å€‹äººè³‡æ–™ç®¡ç†</h3>
          <div id="registrationSection">
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>è«‹å…ˆå®Œæˆè¨»å†Šä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½ã€‚
            </div>
            <form id="registrationForm" class="row g-3">
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" class="form-control" id="realName" name="realName" required>
                  <label for="realName">çœŸå¯¦å§“å *</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="memberType" name="memberType" required>
                    <option value="">é¸æ“‡</option>
                    <option value="ç—…å‹">ç—…å‹</option>
                    <option value="å®¶å±¬">å®¶å±¬</option>
                    <option value="å¿—å·¥">å¿—å·¥</option>
                    <option value="é†«è­·">é†«è­·äººå“¡</option>
                    <option value="æ”¯æŒè€…">æ”¯æŒè€…</option>
                  </select>
                  <label for="memberType">æœƒå“¡é¡åˆ¥ *</label>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-primary" type="submit"><i class="bi bi-check-circle me-1"></i>å®Œæˆè¨»å†Š</button>
              </div>
            </form>
          </div>

          <div id="profileSection" style="display:none;">
            <form id="profileForm" class="row g-3">
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="text" class="form-control" id="profileRealName" readonly>
                  <label for="profileRealName">çœŸå¯¦å§“å</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="text" class="form-control" id="lineName" readonly>
                  <label for="lineName">LINE åç¨±</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <select class="form-select" id="profileMemberType">
                    <option value="ç—…å‹">ç—…å‹</option>
                    <option value="å®¶å±¬">å®¶å±¬</option>
                    <option value="å¿—å·¥">å¿—å·¥</option>
                    <option value="é†«è­·">é†«è­·äººå“¡</option>
                    <option value="æ”¯æŒè€…">æ”¯æŒè€…</option>
                  </select>
                  <label for="profileMemberType">æœƒå“¡é¡åˆ¥</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="tel" class="form-control" id="phone">
                  <label for="phone">è¯çµ¡é›»è©±</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="email" class="form-control" id="email">
                  <label for="email">é›»å­éƒµä»¶</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="date" class="form-control" id="birthday">
                  <label for="birthday">ç”Ÿæ—¥</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <textarea class="form-control" id="address" style="height:100px;"></textarea>
                  <label for="address">é€šè¨Šåœ°å€</label>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-primary" type="submit"><i class="bi bi-save me-1"></i>æ›´æ–°è³‡æ–™</button>
              </div>
            </form>
            <div class="mt-4">
              <h5><i class="bi bi-bar-chart me-2"></i>å€‹äººçµ±è¨ˆ</h5>
              <div class="row g-3" id="profileStats"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Activities -->
      <div class="tab-pane fade" id="activities">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="bi bi-calendar-event me-2"></i>æ´»å‹•ç®¡ç†</h3>
            <div class="admin-only" style="display:none;">
              <button class="btn btn-success btn-sm" onclick="showNewActivityModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢æ´»å‹•</button>
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <div class="form-floating">
                <select class="form-select" id="activityStatusFilter">
                  <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                  <option value="é–‹æ”¾å ±å">é–‹æ”¾å ±å</option>
                  <option value="å ±åæˆªæ­¢">å ±åæˆªæ­¢</option>
                  <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
                  <option value="å·²çµæŸ">å·²çµæŸ</option>
                </select>
                <label for="activityStatusFilter">ç‹€æ…‹</label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-floating">
                <input type="date" class="form-control" id="activityDateFilter">
                <label for="activityDateFilter">æ—¥æœŸ</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="text" class="form-control" id="activitySearchFilter" placeholder="é—œéµå­—">
                <label for="activitySearchFilter">æœå°‹</label>
              </div>
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-outline-primary" onclick="filterActivities()"><i class="bi bi-search"></i> æŸ¥è©¢</button>
            </div>
          </div>
          <div id="activitiesList" class="mb-4 text-muted">è¼‰å…¥æ´»å‹•...</div>
          <div>
            <h5 class="mb-3"><i class="bi bi-clipboard-check me-2"></i>æˆ‘çš„æ´»å‹•å ±å</h5>
            <div id="myRegistrations" class="text-muted">è¼‰å…¥ä¸­...</div>
          </div>
        </div>
      </div>

      <!-- Volunteer -->
      <div class="tab-pane fade" id="volunteer">
        <div class="content-card">
          <h3 class="mb-3"><i class="bi bi-heart me-2"></i>å¿—å·¥æœå‹™</h3>
          <div class="row g-3 mb-4">
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);"><h3 id="volunteerHours">0</h3><p class="mb-0">æœå‹™æ™‚æ•¸</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#ffc107,#e0a800);"><h3 id="volunteerActivities">0</h3><p class="mb-0">åƒèˆ‡æ¬¡æ•¸</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#4CAF50,#45a049);"><h3 id="volunteerRank">-</h3><p class="mb-0">æ’å</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#dc3545,#b52a36);"><h3 id="availableNeeds">0</h3><p class="mb-0">å¯å ±å</p></div></div>
          </div>
          <h5 class="mb-3"><i class="bi bi-exclamation-circle me-2"></i>å¿—å·¥éœ€æ±‚</h5>
          <div id="volunteerNeeds" class="mb-4 text-muted">è¼‰å…¥ä¸­...</div>
          <h5 class="mb-3"><i class="bi bi-journal-text me-2"></i>æˆ‘çš„å¿—å·¥è¨˜éŒ„</h5>
          <div id="myVolunteerRecords" class="text-muted">è¼‰å…¥ä¸­...</div>
          <div class="admin-only mt-4" style="display:none;">
            <button class="btn btn-success btn-sm" onclick="showNewVolunteerNeedModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢å¿—å·¥éœ€æ±‚</button>
          </div>
        </div>
      </div>

      <!-- Finance -->
      <div class="tab-pane fade" id="finance">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="bi bi-cash-coin me-2"></i>è²¡å‹™ç®¡ç†</h3>
            <div>
              <button class="btn btn-success btn-sm me-2" onclick="showNewDonationModal()"><i class="bi bi-heart-fill me-1"></i>ææ¬¾</button>
              <button class="btn btn-warning btn-sm" onclick="showNewExpenseModal()"><i class="bi bi-receipt me-1"></i>æ”¯å‡ºç”³è«‹</button>
            </div>
          </div>
          <div class="row g-3 mb-4">
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#4CAF50,#45a049);"><h3 id="myDonationAmount">NT$ 0</h3><p class="mb-0">ææ¬¾ç¸½é¡</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);"><h3 id="myDonationCount">0</h3><p class="mb-0">ææ¬¾æ¬¡æ•¸</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#ffc107,#e0a800);"><h3 id="myExpenseAmount">NT$ 0</h3><p class="mb-0">æ”¯å‡ºç”³è«‹é¡</p></div></div>
            <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#dc3545,#b52a36);"><h3 id="pendingExpenses">0</h3><p class="mb-0">å¾…å¯©æ ¸</p></div></div>
          </div>
          <h5 class="mb-2"><i class="bi bi-heart-fill me-2"></i>æˆ‘çš„ææ¬¾</h5>
          <div id="donationHistory" class="mb-4 text-muted">è¼‰å…¥ä¸­...</div>
          <h5 class="mb-2"><i class="bi bi-receipt me-2"></i>æˆ‘çš„æ”¯å‡ºç”³è«‹</h5>
          <div id="expenseHistory" class="mb-4 text-muted">è¼‰å…¥ä¸­...</div>
          <div class="admin-only mt-4" style="display:none;">
            <h5 class="mb-3"><i class="bi bi-graph-up me-2"></i>è²¡å‹™ç¸½è¦½ï¼ˆç®¡ç†å“¡ï¼‰</h5>
            <div class="row g-3 mb-3">
              <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#4CAF50,#45a049);"><h3 id="totalIncome">NT$ 0</h3><p class="mb-0">ç¸½æ”¶å…¥</p></div></div>
              <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#dc3545,#b52a36);"><h3 id="totalExpense">NT$ 0</h3><p class="mb-0">ç¸½æ”¯å‡º</p></div></div>
              <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);"><h3 id="currentBalance">NT$ 0</h3><p class="mb-0">ç›®å‰é¤˜é¡</p></div></div>
              <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#ffc107,#e0a800);"><h3 id="monthlyDonations">NT$ 0</h3><p class="mb-0">æœ¬æœˆææ¬¾</p></div></div>
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="showNewTransactionModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢äº¤æ˜“(å¿«é€Ÿ)</button>
          </div>
        </div>
      </div>

      <!-- Feedback -->
      <div class="tab-pane fade" id="feedback">
        <div class="content-card">
          <h3 class="mb-3"><i class="bi bi-chat-dots me-2"></i>æ´»å‹•å›é¥‹</h3>
          <div class="card mb-4">
            <div class="card-header text-white" style="background:linear-gradient(135deg,#4CAF50,#45a049);">
              <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>æ–°å¢å›é¥‹</h5>
            </div>
            <div class="card-body">
              <form id="feedbackForm" class="row g-3">
                <div class="col-md-6">
                  <div class="form-floating">
                    <select class="form-select" id="feedbackActivity" required>
                      <option value="">è«‹é¸æ“‡æ´»å‹•</option>
                    </select>
                    <label for="feedbackActivity">æ´»å‹• *</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <select class="form-select" id="feedbackRating" required>
                      <option value="">è©•åˆ†</option>
                      <option value="5">5 - éå¸¸æ»¿æ„</option>
                      <option value="4">4 - æ»¿æ„</option>
                      <option value="3">3 - æ™®é€š</option>
                      <option value="2">2 - ä¸æ»¿æ„</option>
                      <option value="1">1 - éå¸¸ä¸æ»¿æ„</option>
                    </select>
                    <label for="feedbackRating">è©•åˆ† *</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-floating">
                    <textarea class="form-control" id="feedbackComment" style="height:120px;" required></textarea>
                    <label for="feedbackComment">æ„è¦‹ / å»ºè­° *</label>
                  </div>
                </div>
                <div class="col-12">
                  <button class="btn btn-primary" type="submit"><i class="bi bi-send me-1"></i>æäº¤</button>
                </div>
              </form>
            </div>
          </div>
          <h5 class="mb-3"><i class="bi bi-chat-left-text me-2"></i>æˆ‘çš„å›é¥‹</h5>
          <div id="myFeedback" class="mb-4 text-muted">è¼‰å…¥ä¸­...</div>
          <div class="admin-only" style="display:none;">
            <h5 class="mb-3"><i class="bi bi-chat-square-dots me-2"></i>å…¨éƒ¨å›é¥‹ï¼ˆç®¡ç†å“¡ï¼‰</h5>
            <div id="allFeedback" class="text-muted">è¼‰å…¥ä¸­...</div>
          </div>
        </div>
      </div>

      <!-- Admin -->
      <div class="tab-pane fade" id="admin">
        <div class="content-card">
          <h3 class="mb-3"><i class="bi bi-gear me-2"></i>ç³»çµ±ç®¡ç†</h3>
          <ul class="nav nav-tabs mb-4">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#memberManagement">æœƒå“¡</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#activityManagement">æ´»å‹•</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#financeManagement">è²¡å‹™</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#receiptManagement">æ”¶æ“š</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#systemSettings">è¨­å®š</button></li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="memberManagement">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">æœƒå“¡åˆ—è¡¨</h5>
                <div>
                  <button class="btn btn-outline-primary btn-sm" onclick="exportMembers()"><i class="bi bi-download me-1"></i>åŒ¯å‡º</button>
                </div>
              </div>
              <div class="table-container">
                <table class="table table-hover table-sm">
                  <thead>
                    <tr><th>å§“å</th><th>é¡åˆ¥</th><th>ç‹€æ…‹</th><th>åŠ å…¥æ—¥æœŸ</th><th>ææ¬¾æ¬¡æ•¸</th><th>æ“ä½œ</th></tr>
                  </thead>
                  <tbody id="memberList">
                    <tr><td colspan="6" class="text-center text-muted py-4">è¼‰å…¥ä¸­...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="activityManagement">
              <div class="d-flex justify-content-between mb-2">
                <h5 class="mb-0">æ´»å‹•åˆ—è¡¨</h5>
                <button class="btn btn-success btn-sm" onclick="showNewActivityModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢æ´»å‹•</button>
              </div>
              <div id="adminActivityList" class="text-muted">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="tab-pane fade" id="financeManagement">
              <div class="d-flex justify-content-between mb-2">
                <h5 class="mb-0">äº¤æ˜“è¨˜éŒ„</h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-success btn-sm" onclick="showNewTransactionModal()"><i class="bi bi-plus-circle me-1"></i>æ–°å¢äº¤æ˜“</button>
                  <button class="btn btn-outline-primary btn-sm" onclick="exportFinanceData()"><i class="bi bi-download me-1"></i>åŒ¯å‡º</button>
                </div>
              </div>
              <div class="table-container">
                <table class="table table-sm table-hover">
                  <thead><tr><th>æ—¥æœŸ</th><th>é¡å‹</th><th>é‡‘é¡</th><th>åˆ†é¡</th><th>èªªæ˜</th><th>ç‹€æ…‹</th></tr></thead>
                  <tbody id="transactionList"><tr><td colspan="6" class="text-center text-muted py-4">è¼‰å…¥ä¸­...</td></tr></tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="receiptManagement">
              <div class="d-flex justify-content-between mb-2">
                <h5 class="mb-0">æ”¶æ“šåˆ—è¡¨</h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-info btn-sm" onclick="showReceiptTemplateModal()"><i class="bi bi-file-text me-1"></i>æ¨¡æ¿è¨­å®š</button>
                  <button class="btn btn-success btn-sm" onclick="showManualReceiptModal()"><i class="bi bi-plus-circle me-1"></i>æ‰‹å‹•é–‹ç«‹</button>
                </div>
              </div>
              <div id="receiptList" class="text-muted">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="tab-pane fade" id="systemSettings">
              <h5 class="mb-3">ç³»çµ±å·¥å…·</h5>
              <div class="d-flex flex-wrap gap-3">
                <button class="btn btn-warning" onclick="backupSystem()"><i class="bi bi-database me-1"></i>ç«‹å³å‚™ä»½</button>
                <button class="btn btn-info" onclick="showSystemNotificationModal()"><i class="bi bi-megaphone me-1"></i>ç™¼é€é€šçŸ¥</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- tab-content -->
  </div>

  <div id="modalContainer"></div>

  <script>
    // ========== è¨­å®š ==========
    const CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',  // TODO: æ›¿æ›
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycbyjst47cTooNlcCtQQmuBIMbJLe4RxvB9Cq9WfSk545ayoi5_RzOj3PWoABmUv7Pk7C/exec', // TODO: æ›¿æ›
      API_KEY: 'AAbb8520258185202581' // TODO: æ›¿æ›
    };

    // ========== å…¨åŸŸç‹€æ…‹ ==========
    let userProfile = null;
    let currentUser = null;
    let isAdmin = false;
    let allActivities = [];
    let cachedAdminData = null;

    // ========== å·¥å…· ==========
    const formatDate = d => {
      if(!d) return '-';
      const dt = new Date(d);
      return isNaN(dt)? '-' : dt.toLocaleDateString('zh-TW');
    };
    const formatDateTime = d => {
      if(!d) return '-';
      const dt = new Date(d);
      return isNaN(dt)? '-' : dt.toLocaleString('zh-TW');
    };
    const formatCurrency = n =>
      new Intl.NumberFormat('zh-TW',{style:'currency',currency:'TWD',minimumFractionDigits:0}).format(n||0);

    function showNotification(msg,type='success',ms=3500){
      const wrap = document.getElementById('notificationContainer');
      const el = document.createElement('div');
      el.className = `notification ${type}`;
      el.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <span>${msg}</span>
          <button style="background:none;border:none;font-size:20px;line-height:1;" onclick="this.closest('.notification').remove()">&times;</button>
        </div>`;
      wrap.appendChild(el);
      requestAnimationFrame(()=>el.classList.add('show'));
      setTimeout(()=>{
        el.classList.remove('show');
        setTimeout(()=>el.remove(),400);
      },ms);
    }
    function setButtonLoading(btn,loading=true){
      if(!btn) return;
      if(loading){
        if(!btn.dataset.originalText) btn.dataset.originalText = btn.innerHTML;
        btn.classList.add('loading');
        btn.disabled = true;
      }else{
        btn.classList.remove('loading');
        btn.disabled = false;
        if(btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText;
      }
    }

    async function callAPI(action,data={},retries=1){
      const payload = {
        action,
        apiKey: CONFIG.API_KEY,
        timestamp: Date.now(),
        ...data
      };
      let lastErr;
      for(let i=0;i<=retries;i++){
        try{
          const res = await fetch(CONFIG.API_BASE_URL,{
            method:'POST',
            body: JSON.stringify(payload)
          });
          const text=await res.text();
          let json;
          try{ json=JSON.parse(text); }catch(e){ throw new Error('å›æ‡‰é JSON: '+text.slice(0,120)); }
          if(!json.success) throw new Error(json.message||'API éŒ¯èª¤');
          return json;
        }catch(err){
          lastErr=err;
          await new Promise(r=>setTimeout(r,400*(i+1)));
        }
      }
      throw lastErr;
    }

    // ========== LIFF åˆå§‹åŒ– ==========
    async function initializeLiff(){
      try{
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if(!liff.isLoggedIn()){ liff.login(); return; }
        userProfile = await liff.getProfile();
        const bar=document.getElementById('userInfoBar');
          bar.style.display='flex';
        document.getElementById('userLineName').textContent='LINEï¼š'+(userProfile.displayName||'');
        document.getElementById('userName').textContent=userProfile.displayName||'æœƒå“¡';
        document.getElementById('userAvatar').textContent=(userProfile.displayName||'?').charAt(0);
        await loadUserData();
        await loadDashboard();
        showNotification('ç³»çµ±åˆå§‹åŒ–å®Œæˆ','success');
      }catch(err){
        console.error(err);
        showNotification('LIFF åˆå§‹åŒ–å¤±æ•—ï¼š'+err.message,'error');
      }
    }

    // ========== ä½¿ç”¨è€… ==========
    async function loadUserData(){
      try{
        const r=await callAPI('getUserInfo',{ lineId:userProfile.userId });
        if(r.success){
          currentUser=r.data;
          isAdmin=!!currentUser.isAdmin;
          updateUserUI();
        }else{
          showRegistrationForm();
        }
      }catch{
        showRegistrationForm();
      }
    }
    function updateUserUI(){
      if(!currentUser) return;
      document.getElementById('userName').textContent =
        currentUser.realName || currentUser.lineName || userProfile.displayName || 'æœƒå“¡';
      document.getElementById('userRole').textContent = currentUser.memberType || 'æœƒå“¡';
      document.getElementById('userAvatar').textContent =
        (currentUser.realName || currentUser.lineName || userProfile.displayName || '?').charAt(0);
      document.querySelectorAll('.admin-only').forEach(el=> el.style.display = isAdmin ? 'block':'none');
      updateProfileSection();
    }
    function showRegistrationForm(){
      document.getElementById('registrationSection').style.display='block';
      document.getElementById('profileSection').style.display='none';
    }
    function updateProfileSection(){
      if(!currentUser) return;
      document.getElementById('registrationSection').style.display='none';
      document.getElementById('profileSection').style.display='block';
      document.getElementById('profileRealName').value=currentUser.realName||'';
      document.getElementById('lineName').value=currentUser.lineName||userProfile.displayName||'';
      document.getElementById('phone').value=currentUser.phone||'';
      document.getElementById('email').value=currentUser.email||'';
      document.getElementById('birthday').value=currentUser.birthday||'';
      document.getElementById('profileMemberType').value=currentUser.memberType||'ç—…å‹';
      document.getElementById('address').value=currentUser.address||'';
      document.getElementById('profileStats').innerHTML=`
        <div class="col-sm-6 col-lg-3">
          <div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);">
            <h3>${currentUser.memberType||'-'}</h3><p class="mb-0">èº«ä»½</p>
          </div>
        </div>`;
    }

    document.getElementById('registrationForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('registerUser',{
          lineId:userProfile.userId,
          lineName:userProfile.displayName,
          realName:fd.get('realName'),
          memberType:fd.get('memberType')
        });
        showNotification('è¨»å†ŠæˆåŠŸ','success');
        await loadUserData();
      }catch(err){
        showNotification('è¨»å†Šå¤±æ•—ï¼š'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });

    document.getElementById('profileForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('updateProfile',{
          lineId:userProfile.userId,
          phone:fd.get('phone'),
          email:fd.get('email'),
          birthday:fd.get('birthday'),
          memberType:fd.get('profileMemberType'),
          address:fd.get('address')
        });
        showNotification('æ›´æ–°æˆåŠŸ','success');
        await loadUserData();
      }catch(err){
        showNotification('æ›´æ–°å¤±æ•—ï¼š'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });

    // ========== Dashboard ==========
    async function loadDashboard(){
      try{
        const r=await callAPI('getDashboardData',{ lineId:userProfile?.userId });
        const d=r.data;
        document.getElementById('dashboardStats').innerHTML=`
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#4CAF50,#45a049);"><h3>${d.totalActivities||0}</h3><p class="mb-0">å¯å ±åæ´»å‹•</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);"><h3>${d.myRegistrations||0}</h3><p class="mb-0">æˆ‘çš„å ±å</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#ffc107,#e0a800);"><h3>${d.myVolunteerHours||0}</h3><p class="mb-0">å¿—å·¥æ™‚æ•¸</p></div></div>
          <div class="col-md-3"><div class="stat-card" style="background:linear-gradient(135deg,#dc3545,#b52a36);"><h3>${formatCurrency(d.myDonationAmount||0).replace('NT$','')}</h3><p class="mb-0">ææ¬¾ç¸½é¡</p></div></div>
        `;
        renderRecentActivity(d.recentActivity||[]);
      }catch(err){
        document.getElementById('dashboardStats').innerHTML=`<div class="col-12 text-center text-danger">${err.message}</div>`;
      }
    }
    function renderRecentActivity(list){
      const c=document.getElementById('recentActivity');
      if(!list.length){ c.textContent='æš«ç„¡æœ€è¿‘æ´»å‹•'; return; }
      c.innerHTML=list.map(a=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${a.title||''}</strong>
              <div class="small text-muted">${a.description||''}</div>
              <small class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(a.date)}</small>
            </div>
            <span class="status-badge status-${(a.status||'').trim()}">${a.status||''}</span>
          </div>
        </div>`).join('');
    }

    // ========== æ´»å‹• ==========
    async function loadActivities(){
      try{
        const r=await callAPI('getActivities');
        allActivities=r.data||[];
        renderActivities(allActivities);
      }catch(err){
        document.getElementById('activitiesList').innerHTML='<div class="text-danger text-center">'+err.message+'</div>';
      }
    }
    function renderActivities(list){
      const c=document.getElementById('activitiesList');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">ç›®å‰æ²’æœ‰æ´»å‹•</p>'; return; }
      c.innerHTML=list.map(a=>`
        <div class="activity-item">
          <div class="row">
            <div class="col-md-8">
              <strong>${a.title}</strong>
              <p class="mb-2 small text-muted">${a.description||''}</p>
              <div class="d-flex flex-wrap gap-3 small text-muted">
                <span><i class="bi bi-calendar me-1"></i>${formatDate(a.date)}</span>
                <span><i class="bi bi-clock me-1"></i>${a.time||'-'}</span>
                <span><i class="bi bi-geo-alt me-1"></i>${a.location||'-'}</span>
                <span><i class="bi bi-people me-1"></i>${a.currentCount||0}/${a.maxParticipants||0}</span>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <span class="status-badge status-${a.status}">${a.status}</span><br>
              <span class="fw-bold text-primary d-inline-block mt-2">${formatCurrency(a.fee||0)}</span><br>
              ${(a.status==='é–‹æ”¾å ±å')? `<button class="btn btn-primary btn-sm mt-2" onclick="registerActivity('${a.id}')"><i class="bi bi-plus-circle me-1"></i>å ±å</button>`:''}
            </div>
          </div>
        </div>`).join('');
    }
    function filterActivities(){
      const s=document.getElementById('activityStatusFilter').value.trim();
      const d=document.getElementById('activityDateFilter').value.trim();
      const kw=document.getElementById('activitySearchFilter').value.trim().toLowerCase();
      let list=[...allActivities];
      if(s) list=list.filter(a=>a.status===s);
      if(d) list=list.filter(a=>(a.date||'').startsWith(d));
      if(kw) list=list.filter(a=>(a.title||'').toLowerCase().includes(kw) ||
                               (a.description||'').toLowerCase().includes(kw) ||
                               (a.location||'').toLowerCase().includes(kw));
      renderActivities(list);
    }
    async function registerActivity(id){
      if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
      try{
        await callAPI('registerActivity',{ lineId:userProfile.userId, activityId:id });
        showNotification('å ±åæˆåŠŸ','success');
        await loadActivities();
        await loadMyRegistrations();
        await loadDashboard();
      }catch(err){
        showNotification('å ±åå¤±æ•—ï¼š'+err.message,'error');
      }
    }
    async function loadMyRegistrations(){
      if(!currentUser) return;
      try{
        const r=await callAPI('getMyRegistrations',{ lineId:userProfile.userId });
        renderMyRegistrations(r.data||[]);
      }catch(err){
        document.getElementById('myRegistrations').innerHTML='<div class="text-danger">'+err.message+'</div>';
      }
    }
    function renderMyRegistrations(list){
      const c=document.getElementById('myRegistrations');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">å°šç„¡å ±å</p>'; return; }
      c.innerHTML=list.map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.activityTitle}</strong>
              <div class="small text-muted mb-1"><i class="bi bi-calendar me-1"></i>${formatDateTime(r.registrationTime)}</div>
              <small class="text-muted">ç‹€æ…‹ï¼š${r.status}</small>
            </div>
            <div class="text-end">
                <span class="status-badge status-${r.status}">${r.status}</span><br>
                ${r.status==='å·²å ±å'
                  ? `<button class="btn btn-outline-danger btn-sm mt-2" onclick="cancelRegistration('${r.id}')">
                       <i class="bi bi-x-circle me-1"></i>å–æ¶ˆ
                     </button>`
                  : ''
                }
            </div>
          </div>
        </div>`).join('');
    }

    async function cancelRegistration(regId){
      if(!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†å ±åï¼Ÿ')) return;
      try{
        await callAPI('cancelRegistration',{ lineId:userProfile.userId, registrationId:regId });
        showNotification('å·²å–æ¶ˆ','success');
        await loadActivities();
        await loadMyRegistrations();
        await loadDashboard();
      }catch(err){
        showNotification('å–æ¶ˆå¤±æ•—ï¼š'+err.message,'error');
      }
    }

    // ========== å¿—å·¥ ==========
    async function loadVolunteerData(){
      try{
        const r=await callAPI('getVolunteerData',{ lineId:userProfile.userId });
        const d=r.data||{};
        document.getElementById('volunteerHours').textContent=d.stats.totalHours||0;
        document.getElementById('volunteerActivities').textContent=d.stats.totalActivities||0;
        document.getElementById('volunteerRank').textContent=d.stats.rank||'-';
        document.getElementById('availableNeeds').textContent=d.stats.availableNeeds||0;
        renderVolunteerNeeds(d.needs||[]);
        renderVolunteerRecords(d.records||[]);
      }catch(err){
        document.getElementById('volunteerNeeds').innerHTML='<div class="text-danger">'+err.message+'</div>';
      }
    }
    function renderVolunteerNeeds(list){
      const c=document.getElementById('volunteerNeeds');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">ç›®å‰æ²’æœ‰é–‹æ”¾çš„å¿—å·¥éœ€æ±‚</p>'; return; }
      c.innerHTML=list.map(n=>`
        <div class="activity-item">
          <div class="row">
            <div class="col-md-8">
              <strong>${n.title}</strong>
              <p class="mb-2 small text-muted">${n.description||''}</p>
              <div class="d-flex flex-wrap gap-3 small text-muted">
                <span><i class="bi bi-calendar me-1"></i>${formatDate(n.date)}</span>
                <span><i class="bi bi-clock me-1"></i>${n.time||'-'}</span>
                <span><i class="bi bi-people me-1"></i>${n.currentCount||0}/${n.needCount||0}</span>
                <span><i class="bi bi-stopwatch me-1"></i>${n.hours||0} æ™‚</span>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <span class="status-badge status-${n.status}">${n.status}</span><br>
              <button class="btn btn-primary btn-sm mt-2" onclick="applyVolunteer('${n.id}')">
                <i class="bi bi-plus-circle me-1"></i>å ±å
              </button>
            </div>
          </div>
        </div>`).join('');
    }
    function renderVolunteerRecords(list){
      const c=document.getElementById('myVolunteerRecords');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">å°šç„¡å¿—å·¥è¨˜éŒ„</p>'; return; }
      c.innerHTML=list.map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.title}</strong>
              <div class="small text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(r.date)} ï½œ ${r.hours} æ™‚</div>
              ${r.feedback? `<div class="small text-muted">å›é¥‹ï¼š${r.feedback}</div>`:''}
            </div>
            <span class="status-badge status-${r.status}">${r.status}</span>
          </div>
        </div>`).join('');
    }
    async function applyVolunteer(id){
      if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
      try{
        await callAPI('applyVolunteer',{ lineId:userProfile.userId, needId:id });
        showNotification('å¿—å·¥å ±åæˆåŠŸ','success');
        await loadVolunteerData();
        await loadDashboard();
      }catch(err){
        showNotification('å ±åå¤±æ•—ï¼š'+err.message,'error');
      }
    }

    // ========== è²¡å‹™ ==========
    async function loadFinanceData(){
      if(!currentUser) return;
      try{
        const r=await callAPI('getFinanceData',{ lineId:userProfile.userId });
        const d=r.data;
        // å€‹äººçµ±è¨ˆ
        document.getElementById('myDonationAmount').textContent='NT$ '+(d.stats.totalDonation||0).toLocaleString();
        document.getElementById('myDonationCount').textContent=d.stats.donationCount||0;
        document.getElementById('myExpenseAmount').textContent='NT$ '+(d.stats.totalExpense||0).toLocaleString();
        document.getElementById('pendingExpenses').textContent=d.stats.pendingExpenses||0;
        renderDonationHistory(d.donations||[]);
        renderExpenseHistory(d.expenses||[]);
        if(isAdmin){
          const a=d.adminStats||{};
            document.getElementById('totalIncome').textContent='NT$ '+(a.totalIncome||0).toLocaleString();
            document.getElementById('totalExpense').textContent='NT$ '+(a.totalExpense||0).toLocaleString();
            document.getElementById('currentBalance').textContent='NT$ '+(a.currentBalance||0).toLocaleString();
            document.getElementById('monthlyDonations').textContent='NT$ '+(a.monthlyDonations||0).toLocaleString();
        }
      }catch(err){
        document.getElementById('donationHistory').innerHTML='<div class="text-danger">'+err.message+'</div>';
      }
    }
    function renderDonationHistory(list){
      const c=document.getElementById('donationHistory');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">å°šç„¡ææ¬¾è¨˜éŒ„</p>'; return; }
      c.innerHTML=list.sort((a,b)=> new Date(b.date||0)-new Date(a.date||0)).map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.category}</strong>
              <div class="small text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(r.date)}</div>
              <div class="small text-muted">æ”¶æ“šï¼š${r.receiptNumber||'-'}</div>
            </div>
            <div class="text-end">
              <div class="fw-bold text-success">${formatCurrency(r.amount)}</div>
              <span class="status-badge status-${r.status}">${r.status}</span>
            </div>
          </div>
        </div>`).join('');
    }
    function renderExpenseHistory(list){
      const c=document.getElementById('expenseHistory');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">å°šç„¡æ”¯å‡ºç”³è«‹</p>'; return; }
      c.innerHTML=list.sort((a,b)=> new Date(b.createdAt||0)-new Date(a.createdAt||0)).map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between small">
            <div>
              <strong>${r.category}</strong>
              <div class="text-muted"><i class="bi bi-calendar me-1"></i>${formatDate(r.createdAt)}</div>
              ${r.voucherUrl? `<a href="${r.voucherUrl}" target="_blank" class="small">æ†‘è­‰PDF</a>`:''}
            </div>
            <div class="text-end">
              <div class="fw-bold text-danger">${formatCurrency(r.amount)}</div>
              <span class="status-badge status-${r.status}">${r.status}</span>
            </div>
          </div>
        </div>`).join('');
    }

    function showNewDonationModal(){
      showModal({
        title:'æ–°å¢ææ¬¾',
        body:`
          <form id="donationForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="donationCategory" required>
                  <option value="ä¸€èˆ¬ææ¬¾">ä¸€èˆ¬ææ¬¾</option>
                  <option value="æ´»å‹•è´ŠåŠ©">æ´»å‹•è´ŠåŠ©</option>
                </select>
                <label for="donationCategory">ææ¬¾é¡åˆ¥ *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="number" class="form-control" id="donationAmount" min="1" required>
                <label for="donationAmount">é‡‘é¡ *</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="donationDesc" style="height:100px;"></textarea>
                <label for="donationDesc">èªªæ˜ (å¯ç©ºç™½)</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="needReceipt">
                <label for="needReceipt" class="form-check-label">éœ€è¦æ”¶æ“š</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-primary w-100" type="submit"><i class="bi bi-heart-fill me-1"></i>é€å‡ºææ¬¾</button>
            </div>
          </form>`,
        onShown:()=>{
          document.getElementById('donationForm').addEventListener('submit',async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              const res=await callAPI('createDonation',{
                lineId:userProfile.userId,
                category:document.getElementById('donationCategory').value,
                amount:document.getElementById('donationAmount').value,
                description:document.getElementById('donationDesc').value,
                needReceipt:document.getElementById('needReceipt').checked
              });
              showNotification('ææ¬¾æˆåŠŸ','success');
              closeModal();
              await loadFinanceData();
              await loadDashboard();
              if(res.data?.pdfUrl){
                if(confirm('æ”¶æ“šå·²é–‹ç«‹ï¼Œæ˜¯å¦å‰å¾€æŸ¥çœ‹ï¼Ÿ')) window.open(res.data.pdfUrl,'_blank');
              }
            }catch(err){
              showNotification('ææ¬¾å¤±æ•—ï¼š'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    function showNewExpenseModal(){
      showModal({
        title:'æ–°å¢æ”¯å‡ºç”³è«‹',
        body:`
          <form id="expenseForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="expenseCategory" required>
                  <option value="æ´»å‹•è²»ç”¨">æ´»å‹•è²»ç”¨</option>
                  <option value="è¡Œæ”¿æ”¯å‡º">è¡Œæ”¿æ”¯å‡º</option>
                  <option value="è¨­å‚™æ”¯å‡º">è¨­å‚™æ”¯å‡º</option>
                </select>
                <label for="expenseCategory">æ”¯å‡ºé¡åˆ¥ *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="number" class="form-control" id="expenseAmount" min="1" required>
                <label for="expenseAmount">é‡‘é¡ *</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="expenseDesc" style="height:100px;"></textarea>
                <label for="expenseDesc">èªªæ˜</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-warning w-100" type="submit"><i class="bi bi-receipt me-1"></i>é€å‡ºç”³è«‹</button>
            </div>
          </form>`,
        onShown:()=>{
          document.getElementById('expenseForm').addEventListener('submit', async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              await callAPI('createExpense',{
                lineId:userProfile.userId,
                category:document.getElementById('expenseCategory').value,
                amount:document.getElementById('expenseAmount').value,
                description:document.getElementById('expenseDesc').value
              });
              showNotification('æ”¯å‡ºç”³è«‹å»ºç«‹','success');
              closeModal();
              await loadFinanceData();
            }catch(err){
              showNotification('ç”³è«‹å¤±æ•—ï¼š'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    // ========== å›é¥‹ ==========
    async function loadFeedbackData(){
      if(!currentUser) return;
      try{
        // æˆ‘çš„å›é¥‹
        const mine=await callAPI('getMyFeedback',{ lineId:userProfile.userId });
        renderMyFeedback(mine.data||[]);
        // å–å¾—æˆ‘å·²å®Œæˆæ´»å‹•ï¼ˆä¾›ä¸‹æ‹‰ï¼‰
        const comp=await callAPI('getMyCompletedActivities',{ lineId:userProfile.userId });
        const sel=document.getElementById('feedbackActivity');
        sel.innerHTML='<option value="">è«‹é¸æ“‡æ´»å‹•</option>'+ (comp.data||[]).map(a=>`<option value="${a.id}">${a.title}</option>`).join('');
        // å…¨éƒ¨å›é¥‹ï¼ˆç®¡ç†å“¡ï¼‰
        if(isAdmin){
          const all=await callAPI('getAllFeedback',{ lineId:userProfile.userId });
          renderAllFeedback(all.data||[]);
        }
      }catch(err){
        document.getElementById('myFeedback').innerHTML='<div class="text-danger">'+err.message+'</div>';
      }
    }
    function renderMyFeedback(list){
      const c=document.getElementById('myFeedback');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">å°šç„¡å›é¥‹</p>'; return; }
      c.innerHTML=list.sort((a,b)=> new Date(b.createdAt||0)-new Date(a.createdAt||0)).map(r=>`
        <div class="activity-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.activityTitle}</strong>
              <div class="small text-muted">${formatDateTime(r.createdAt)}</div>
              <div class="small text-muted">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5-r.rating)}</div>
              <div class="small">${r.comment||''}</div>
            </div>
            <span class="status-badge status-å·²å®Œæˆ">è©•åˆ† ${r.rating}</span>
          </div>
        </div>`).join('');
    }
    function renderAllFeedback(list){
      const c=document.getElementById('allFeedback');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">å°šç„¡è³‡æ–™</p>'; return; }
      c.innerHTML=list.sort((a,b)=> new Date(b.createdAt||0)-new Date(a.createdAt||0)).map(r=>`
        <div class="activity-item small">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.activityTitle}</strong>
              <div class="text-muted">${formatDateTime(r.createdAt)} ï½œ ${r.lineId}</div>
              <div>${r.comment||''}</div>
            </div>
            <div style="min-width:70px;" class="text-end">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5-r.rating)}</div>
          </div>
        </div>`).join('');
    }

    document.getElementById('feedbackForm').addEventListener('submit', async e=>{
      e.preventDefault();
      if(!currentUser){ showNotification('è«‹å…ˆè¨»å†Š','warning'); return; }
      const btn=e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn,true);
      try{
        await callAPI('createFeedback',{
          lineId:userProfile.userId,
          activityId:document.getElementById('feedbackActivity').value,
          rating:document.getElementById('feedbackRating').value,
          comment:document.getElementById('feedbackComment').value
        });
        showNotification('å·²æäº¤','success');
        document.getElementById('feedbackForm').reset();
        await loadFeedbackData();
      }catch(err){
        showNotification('æäº¤å¤±æ•—ï¼š'+err.message,'error');
      }finally{ setButtonLoading(btn,false); }
    });

    // ========== ç³»çµ±ç®¡ç† (Admin) ==========
    async function loadAdminData(force=false){
      if(!isAdmin) return;
      if(cachedAdminData && !force){
        renderAdminData(cachedAdminData);
        return;
      }
      try{
        const r=await callAPI('getAdminData',{ lineId:userProfile.userId });
        cachedAdminData=r.data;
        renderAdminData(r.data);
      }catch(err){
        console.error(err);
      }
    }
    function renderAdminData(data){
      renderMemberList(data.members||[]);
      renderAdminActivities(data.activities||[]);
      renderTransactions(data.transactions||[]);
      renderReceiptList(data.receipts||[]);
    }
    function renderMemberList(list){
      const tb=document.getElementById('memberList');
      if(!list.length){
        tb.innerHTML='<tr><td colspan="6" class="text-center text-muted py-4">ç„¡è³‡æ–™</td></tr>'; return;
      }
      tb.innerHTML=list.sort((a,b)=> new Date(b.joinDate||0)-new Date(a.joinDate||0)).map(m=>`
        <tr>
          <td>${m.realName||m.lineName||'-'}</td>
          <td>${m.memberType||'-'}</td>
          <td>${m.status||'-'}</td>
          <td>${formatDate(m.joinDate)}</td>
          <td>${m.donationCount||0}</td>
          <td><button class="btn btn-outline-secondary btn-sm" onclick="viewMember('${m.lineId}')">æŸ¥çœ‹</button></td>
        </tr>`).join('');
    }
    function viewMember(lineId){
      const m=(cachedAdminData?.members||[]).find(x=>x.lineId===lineId);
      if(!m) return;
      showModal({
        title:'æœƒå“¡è³‡æ–™',
        body:`
          <div class="small">
            <p><strong>å§“åï¼š</strong>${m.realName||'-'}</p>
            <p><strong>LINEï¼š</strong>${m.lineName||'-'}</p>
            <p><strong>é¡åˆ¥ï¼š</strong>${m.memberType||'-'}</p>
            <p><strong>é›»è©±ï¼š</strong>${m.phone||'-'}</p>
            <p><strong>Emailï¼š</strong>${m.email||'-'}</p>
            <p><strong>åœ°å€ï¼š</strong>${m.address||'-'}</p>
            <p><strong>åŠ å…¥ï¼š</strong>${formatDate(m.joinDate)}</p>
            <p><strong>ææ¬¾æ¬¡æ•¸ï¼š</strong>${m.donationCount||0}</p>
          </div>`
      });
    }
    function renderAdminActivities(list){
      const c=document.getElementById('adminActivityList');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">ç„¡æ´»å‹•</p>'; return; }
      c.innerHTML=list.map(a=>`
        <div class="activity-item small">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${a.title}</strong>
              <div class="text-muted">${formatDate(a.date)} ï½œ ${a.location||'-'}</div>
              <div class="text-muted">äººæ•¸ï¼š${a.currentCount||0}/${a.maxParticipants||0}</div>
            </div>
            <div class="text-end">
              <span class="status-badge status-${a.status}">${a.status}</span><br>
              <button class="btn btn-outline-primary btn-sm mt-2" onclick="editActivity('${a.id}')">
                <i class="bi bi-pencil"></i>
              </button>
            </div>
          </div>
        </div>`).join('');
    }
    function editActivity(id){
      const a=(cachedAdminData?.activities||[]).find(x=>x.id===id) || allActivities.find(x=>x.id===id);
      if(!a) return;
      showModal({
        title:'ç·¨è¼¯æ´»å‹•',
        body:`
          <form id="editActivityForm" class="row g-3">
            <input type="hidden" id="editActivityId" value="${a.id}">
            <div class="col-md-6">
              <div class="form-floating">
                <input class="form-control" id="editActivityTitle" required value="${a.title||''}">
                <label for="editActivityTitle">æ´»å‹•åç¨± *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="date" class="form-control" id="editActivityDate" value="${(a.date||'').split('T')[0]||a.date||''}">
                <label for="editActivityDate">æ—¥æœŸ</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input class="form-control" id="editActivityTime" value="${a.time||''}">
                <label for="editActivityTime">æ™‚é–“</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input class="form-control" id="editActivityLocation" value="${a.location||''}">
                <label for="editActivityLocation">åœ°é»</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="number" class="form-control" id="editActivityMax" value="${a.maxParticipants||0}">
                <label for="editActivityMax">äººæ•¸ä¸Šé™</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="editActivityDesc" style="height:120px;">${a.description||''}</textarea>
                <label for="editActivityDesc">èªªæ˜</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="editActivityStatus">
                  ${['é–‹æ”¾å ±å','å ±åæˆªæ­¢','é€²è¡Œä¸­','å·²çµæŸ','å·²åˆªé™¤'].map(s=>`<option value="${s}" ${a.status===s?'selected':''}>${s}</option>`).join('')}
                </select>
                <label for="editActivityStatus">ç‹€æ…‹</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="number" class="form-control" id="editActivityFee" value="${a.fee||0}">
                <label for="editActivityFee">è²»ç”¨</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-primary w-100" type="submit"><i class="bi bi-save me-1"></i>å„²å­˜</button>
            </div>
          </form>`,
        onShown:()=>{
          document.getElementById('editActivityForm').addEventListener('submit', async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              await callAPI('updateActivity',{
                lineId:userProfile.userId,
                activityId:document.getElementById('editActivityId').value,
                title:document.getElementById('editActivityTitle').value,
                date:document.getElementById('editActivityDate').value,
                time:document.getElementById('editActivityTime').value,
                location:document.getElementById('editActivityLocation').value,
                maxParticipants:document.getElementById('editActivityMax').value,
                description:document.getElementById('editActivityDesc').value,
                status:document.getElementById('editActivityStatus').value,
                fee:document.getElementById('editActivityFee').value
              });
              showNotification('å·²æ›´æ–°æ´»å‹•','success');
              closeModal();
              await loadActivities();
              await loadAdminData(true);
            }catch(err){
              showNotification('æ›´æ–°å¤±æ•—ï¼š'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    function renderTransactions(list){
      const tb=document.getElementById('transactionList');
      if(!list.length){
        tb.innerHTML='<tr><td colspan="6" class="text-center text-muted py-4">ç„¡è³‡æ–™</td></tr>'; return;
      }
      tb.innerHTML=list.map(t=>`
        <tr>
          <td>${formatDate(t.date)}</td>
          <td>${t.type}</td>
          <td>${formatCurrency(t.amount)}</td>
          <td>${t.category||'-'}</td>
          <td>${t.description||''}</td>
          <td><span class="status-badge status-${t.status}">${t.status}</span></td>
        </tr>`).join('');
    }

    function renderReceiptList(list){
      const c=document.getElementById('receiptList');
      if(!list.length){ c.innerHTML='<p class="text-muted mb-0">å°šç„¡æ”¶æ“š</p>'; return; }
      c.innerHTML=list.sort((a,b)=> new Date(b.issueDate||0)-new Date(a.issueDate||0)).map(r=>`
        <div class="activity-item small">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${r.receiptNumber}</strong>
              <div class="text-muted">${formatDate(r.issueDate)} ï½œ ${r.type}</div>
              <div class="text-muted">é‡‘é¡ï¼š${formatCurrency(r.amount)}</div>
            </div>
            <div class="text-end">
              <span class="status-badge status-${r.status}">${r.status}</span><br>
              ${r.pdfUrl? `<a href="${r.pdfUrl}" target="_blank" class="btn btn-outline-primary btn-sm mt-2">PDF</a>`:''}
            </div>
          </div>
        </div>`).join('');
    }

    function showNewActivityModal(){
      showModal({
        title:'æ–°å¢æ´»å‹•',
        body:`
          <form id="newActivityForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input class="form-control" id="newActTitle" required>
                <label for="newActTitle">æ´»å‹•åç¨± *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="date" class="form-control" id="newActDate" required>
                <label for="newActDate">æ—¥æœŸ *</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input class="form-control" id="newActTime">
                <label for="newActTime">æ™‚é–“</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input class="form-control" id="newActLocation">
                <label for="newActLocation">åœ°é»</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="number" class="form-control" id="newActMax" min="1" value="30">
                <label for="newActMax">äººæ•¸ä¸Šé™</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="number" class="form-control" id="newActFee" min="0" value="0">
                <label for="newActFee">è²»ç”¨</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="newActDesc" style="height:120px;"></textarea>
                <label for="newActDesc">æ´»å‹•èªªæ˜</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-success w-100" type="submit"><i class="bi bi-plus-circle me-1"></i>å»ºç«‹</button>
            </div>
          </form>`,
        onShown:()=>{
          document.getElementById('newActivityForm').addEventListener('submit', async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              await callAPI('createActivity',{
                lineId:userProfile.userId,
                title:document.getElementById('newActTitle').value,
                date:document.getElementById('newActDate').value,
                time:document.getElementById('newActTime').value,
                location:document.getElementById('newActLocation').value,
                maxParticipants:document.getElementById('newActMax').value,
                fee:document.getElementById('newActFee').value,
                description:document.getElementById('newActDesc').value
              });
              showNotification('æ´»å‹•å»ºç«‹æˆåŠŸ','success');
              closeModal();
              await loadActivities();
              await loadAdminData(true);
            }catch(err){
              showNotification('å»ºç«‹å¤±æ•—ï¼š'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    function showNewVolunteerNeedModal(){
      showModal({
        title:'æ–°å¢å¿—å·¥éœ€æ±‚',
        body:`
          <form id="newVolunteerNeedForm" class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input class="form-control" id="volNeedTitle" required>
                <label for="volNeedTitle">æ¨™é¡Œ *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="date" class="form-control" id="volNeedDate" required>
                <label for="volNeedDate">æ—¥æœŸ *</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input class="form-control" id="volNeedTime">
                <label for="volNeedTime">æ™‚é–“</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="number" class="form-control" id="volNeedCount" value="5" min="1">
                <label for="volNeedCount">éœ€æ±‚äººæ•¸ *</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="number" class="form-control" id="volNeedHours" value="2" min="1">
                <label for="volNeedHours">æœå‹™æ™‚æ•¸ *</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="volNeedDesc" style="height:120px;"></textarea>
                <label for="volNeedDesc">èªªæ˜</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-success w-100" type="submit"><i class="bi bi-plus-circle me-1"></i>å»ºç«‹</button>
            </div>
          </form>`,
        onShown:()=>{
          document.getElementById('newVolunteerNeedForm').addEventListener('submit', async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              await callAPI('createVolunteerNeed',{
                lineId:userProfile.userId,
                title:document.getElementById('volNeedTitle').value,
                date:document.getElementById('volNeedDate').value,
                time:document.getElementById('volNeedTime').value,
                needCount:document.getElementById('volNeedCount').value,
                hours:document.getElementById('volNeedHours').value,
                description:document.getElementById('volNeedDesc').value
              });
              showNotification('å¿—å·¥éœ€æ±‚å»ºç«‹','success');
              closeModal();
              await loadVolunteerData();
            }catch(err){
              showNotification('å»ºç«‹å¤±æ•—ï¼š'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    function showReceiptTemplateModal(){
      showModal({
        title:'æ”¶æ“š / æ¨¡æ¿è¨­å®š',
        body:`
          <form id="receiptTplForm" class="row g-3">
            <div class="col-12">
              <div class="form-floating">
                <input class="form-control" id="receiptTemplateDocId" placeholder="Google æ–‡ä»¶ ID">
                <label for="receiptTemplateDocId">æ”¶æ“šæ¨¡æ¿æ–‡ä»¶ ID</label>
              </div>
              <div class="form-text">æ¨¡æ¿ä¸­å¯ä½¿ç”¨ {{RECEIPT_NUMBER}} {{DONOR_NAME}} {{DONATION_AMOUNT}} ç­‰å ä½ç¬¦ã€‚</div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <input class="form-control" id="expenseVoucherTemplateDocId" placeholder="Google æ–‡ä»¶ ID">
                <label for="expenseVoucherTemplateDocId">æ”¯å‡ºæ†‘è­‰æ¨¡æ¿æ–‡ä»¶ ID</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="emailReplyTemplate" style="height:120px;" placeholder="Email å›è¦†å°¾æ®µ"></textarea>
                <label for="emailReplyTemplate">Email å›è¦†æ¨¡æ¿ (å°¾æ®µ)</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-primary w-100" type="submit"><i class="bi bi-save me-1"></i>å„²å­˜è¨­å®š</button>
            </div>
          </form>`,
        onShown: async ()=>{
          try{
            const r=await callAPI('getSettings',{ lineId:userProfile.userId });
            document.getElementById('receiptTemplateDocId').value=r.data.receiptTemplateDocId||'';
            document.getElementById('expenseVoucherTemplateDocId').value=r.data.expenseVoucherTemplateDocId||'';
            document.getElementById('emailReplyTemplate').value=r.data.emailReplyTemplate||'';
          }catch{}
          document.getElementById('receiptTplForm').addEventListener('submit', async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              await callAPI('updateSettings',{
                lineId:userProfile.userId,
                receiptTemplateDocId:document.getElementById('receiptTemplateDocId').value.trim(),
                expenseVoucherTemplateDocId:document.getElementById('expenseVoucherTemplateDocId').value.trim(),
                emailReplyTemplate:document.getElementById('emailReplyTemplate').value
              });
              showNotification('è¨­å®šå·²æ›´æ–°','success');
              closeModal();
            }catch(err){
              showNotification('æ›´æ–°å¤±æ•—ï¼š'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    function showManualReceiptModal(){
      showModal({
        title:'æ‰‹å‹•é–‹ç«‹æ”¶æ“š',
        body:`
          <form id="manualReceiptForm" class="row g-3">
            <div class="col-12">
              <div class="form-floating">
                <input class="form-control" id="targetLineId" required>
                <label for="targetLineId">ç›®æ¨™ LINE ID *</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <select class="form-select" id="manualReceiptType" required>
                  <option value="ææ¬¾">ææ¬¾</option>
                  <option value="æ´»å‹•">æ´»å‹•</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <label for="manualReceiptType">é¡å‹ *</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="number" class="form-control" id="manualReceiptAmount" min="1" required>
                <label for="manualReceiptAmount">é‡‘é¡ *</label>
              </div>
            </div>
            <div class="col-md-4 d-flex align-items-center">
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="createDonation" checked>
                <label class="form-check-label" for="createDonation">å»ºç«‹ææ¬¾è¨˜éŒ„</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-success w-100" type="submit"><i class="bi bi-plus-circle me-1"></i>é–‹ç«‹æ”¶æ“š</button>
            </div>
          </form>`,
        onShown:()=>{
          document.getElementById('manualReceiptForm').addEventListener('submit', async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              const res=await callAPI('createManualReceipt',{
                lineId:userProfile.userId,
                targetLineId:document.getElementById('targetLineId').value.trim(),
                type:document.getElementById('manualReceiptType').value,
                amount:document.getElementById('manualReceiptAmount').value,
                createDonation:document.getElementById('createDonation').checked
              });
              showNotification('æ”¶æ“šå»ºç«‹æˆåŠŸ','success');
              closeModal();
              await loadAdminData(true);
              if(res.data?.pdfUrl){
                if(confirm('æ”¶æ“šå·²ç”¢ç”Ÿï¼Œæ˜¯å¦æŸ¥çœ‹ PDFï¼Ÿ')) window.open(res.data.pdfUrl,'_blank');
              }
            }catch(err){
              showNotification('å»ºç«‹å¤±æ•—ï¼š'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    function showSystemNotificationModal(){
      showModal({
        title:'ç™¼é€ç³»çµ±é€šçŸ¥ï¼ˆè¨˜éŒ„ï¼‰',
        body:`
          <form id="systemNotifyForm" class="row g-3">
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="systemNotifyMsg" style="height:140px;" required></textarea>
                <label for="systemNotifyMsg">é€šçŸ¥å…§å®¹ *</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-info w-100" type="submit"><i class="bi bi-megaphone me-1"></i>é€å‡º</button>
            </div>
          </form>`,
        onShown:()=>{
          document.getElementById('systemNotifyForm').addEventListener('submit', async e=>{
            e.preventDefault();
            const btn=e.target.querySelector('button[type="submit"]');
            setButtonLoading(btn,true);
            try{
              await callAPI('sendSystemNotification',{ lineId:userProfile.userId, message:document.getElementById('systemNotifyMsg').value });
              showNotification('é€šçŸ¥å·²è¨˜éŒ„','success');
              closeModal();
            }catch(err){
              showNotification('å¤±æ•—ï¼š'+err.message,'error');
            }finally{ setButtonLoading(btn,false); }
          });
        }
      });
    }

    async function exportMembers(){
      if(!isAdmin) return;
      try{
        const r=await callAPI('exportMembers',{ lineId:userProfile.userId });
        showNotification('åŒ¯å‡ºå®Œæˆ','success');
        window.open(r.data.fileUrl,'_blank');
      }catch(err){
        showNotification('åŒ¯å‡ºå¤±æ•—ï¼š'+err.message,'error');
      }
    }
    async function exportFinanceData(){
      if(!isAdmin) return;
      try{
        const r=await callAPI('exportFinanceData',{ lineId:userProfile.userId });
        showNotification('åŒ¯å‡ºå®Œæˆ','success');
        if(r.data.donationUrl) window.open(r.data.donationUrl,'_blank');
        if(r.data.expenseUrl) window.open(r.data.expenseUrl,'_blank');
      }catch(err){
        showNotification('åŒ¯å‡ºå¤±æ•—ï¼š'+err.message,'error');
      }
    }
    async function backupSystem(){
      if(!isAdmin) return;
      if(!confirm('å»ºç«‹å³æ™‚å‚™ä»½ï¼Ÿ')) return;
      try{
        const r=await callAPI('backupSystem',{ lineId:userProfile.userId });
        showNotification('å‚™ä»½å®Œæˆï¼š'+r.data.name,'success',5000);
      }catch(err){
        showNotification('å‚™ä»½å¤±æ•—ï¼š'+err.message,'error');
      }
    }

    // ========== Modal å…¬ç”¨ ==========
    let currentModal=null;
    function showModal({ title, body, onShown }){
      const wrap=document.getElementById('modalContainer');
      wrap.innerHTML=`
        <div class="modal fade" id="globalModal">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">${title}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">${body}</div>
            </div>
          </div>
        </div>`;
      const modalEl=document.getElementById('globalModal');
      currentModal=new bootstrap.Modal(modalEl);
      modalEl.addEventListener('hidden.bs.modal',()=>{ wrap.innerHTML=''; });
      currentModal.show();
      if(typeof onShown==='function') setTimeout(onShown,20);
    }
    function closeModal(){
      if(currentModal){ currentModal.hide(); currentModal=null; }
    }

    // ========== å…¶å®ƒ ==========
    function showTab(id){
      const tabTrigger=document.querySelector(`.nav-link[data-bs-target="#${id}"]`);
      if(tabTrigger){
        new bootstrap.Tab(tabTrigger).show();
      }
    }

    async function refreshData(){
      showNotification('åˆ·æ–°ä¸­...','info',1200);
      await Promise.all([
        loadDashboard(),
        loadActivities(),
        loadMyRegistrations(),
        loadVolunteerData(),
        loadFinanceData(),
        loadFeedbackData(),
        loadAdminData(true)
      ]);
      showNotification('è³‡æ–™å·²æ›´æ–°','success');
    }

    // åˆå§‹è¼‰å…¥å…¶ä»–å€å¡Šè³‡æ–™ï¼ˆæ´»å‹•ç­‰ï¼‰
    document.addEventListener('DOMContentLoaded', ()=>{
      initializeLiff().then(async ()=>{
        // ç­‰ LIFF åˆå§‹åŒ–å®Œå†åš
        await loadActivities();
        await loadMyRegistrations();
        await loadVolunteerData();
        await loadFinanceData();
        await loadFeedbackData();
        if(isAdmin) loadAdminData();
      });
    });
  </script>
</body>
</html>
