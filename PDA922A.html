<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>NGO 後台系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .hidden { display: none; }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <div class="max-w-6xl mx-auto p-4">
      <header class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold">NGO 後台系統</h1>
        <div id="userArea" class="flex items-center gap-2">
          <input id="lineIdInput" class="border rounded px-3 py-1" placeholder="輸入 lineId 模擬登入">
          <button id="loginBtn" class="px-3 py-1 bg-blue-600 text-white rounded">登入</button>
          <button id="logoutBtn" class="px-3 py-1 bg-gray-300 rounded hidden">登出</button>
        </div>
      </header>

      <div id="notice" class="mb-4"></div>

      <nav class="flex gap-2 mb-4 flex-wrap">
        <button data-tab="home" class="tab-btn px-3 py-1 rounded bg-blue-600 text-white">首頁</button>
        <button data-tab="activities" class="tab-btn px-3 py-1 rounded bg-gray-200">活動</button>
        <button data-tab="finance" class="tab-btn px-3 py-1 rounded bg-gray-200">財務</button>
        <button data-tab="receipts" class="tab-btn px-3 py-1 rounded bg-gray-200">收據</button>
        <button data-tab="admin" class="tab-btn px-3 py-1 rounded bg-gray-200 hidden">管理員</button>
      </nav>

      <main>
        <!-- 首頁 -->
        <section id="tab-home">
          <div class="grid md:grid-cols-3 gap-4">
            <div class="p-4 bg-white rounded shadow">
              <h2 class="font-semibold mb-2">快速資訊</h2>
              <ul class="text-sm leading-7">
                <li>本月收入：<span id="homeMonthlyDonation">-</span></li>
                <li>本月支出：<span id="homeMonthlyExpense">-</span></li>
                <li>帳戶餘額：<span id="homeBalance">-</span></li>
              </ul>
              <div id="homeAlerts" class="mt-2 text-sm text-amber-700"></div>
            </div>
            <div class="p-4 bg-white rounded shadow md:col-span-2">
              <h2 class="font-semibold mb-2">我的報名</h2>
              <div id="homeMyRegs" class="text-sm"></div>
            </div>
          </div>
        </section>

        <!-- 活動 -->
        <section id="tab-activities" class="hidden">
          <div class="p-4 bg-white rounded shadow">
            <div class="flex items-center justify-between mb-3">
              <h2 class="font-semibold">活動列表</h2>
              <div class="text-sm text-gray-500">點擊報名或取消</div>
            </div>
            <div id="activitiesList" class="space-y-3"></div>
          </div>
        </section>

        <!-- 財務 -->
        <section id="tab-finance" class="hidden">
          <div class="grid md:grid-cols-2 gap-4">
            <div class="p-4 bg-white rounded shadow">
              <h2 class="font-semibold mb-2">我的捐款</h2>
              <div class="text-sm">合計：<span id="myDonationTotal">-</span>（<span id="myDonationCount">-</span> 筆）</div>
              <div id="myDonations" class="mt-2 text-sm space-y-2"></div>
            </div>
            <div class="p-4 bg-white rounded shadow">
              <h2 class="font-semibold mb-2">我的支出</h2>
              <div class="text-sm">合計：<span id="myExpenseTotal">-</span>，待審核：<span id="myExpensePending">-</span></div>
              <div id="myExpenses" class="mt-2 text-sm space-y-2"></div>
            </div>
          </div>

          <div id="financeAdminStats" class="p-4 bg-white rounded shadow mt-4 hidden">
            <h2 class="font-semibold mb-2">管理員統計</h2>
            <ul class="text-sm leading-7">
              <li>累計收入：<span id="adminTotalIncome">-</span></li>
              <li>累計支出：<span id="adminTotalExpense">-</span></li>
              <li>目前餘額：<span id="adminCurrentBalance">-</span></li>
              <li>本月捐款：<span id="adminMonthlyDonations">-</span></li>
            </ul>
          </div>
        </section>

        <!-- 收據 -->
        <section id="tab-receipts" class="hidden">
          <div class="p-4 bg-white rounded shadow">
            <h2 class="font-semibold mb-2">我的收據</h2>
            <div id="myReceiptsList" class="text-sm space-y-2"></div>
          </div>
        </section>

        <!-- 管理員 -->
        <section id="tab-admin" class="hidden">
          <div class="grid md:grid-cols-2 gap-4">
            <div class="p-4 bg-white rounded shadow">
              <h2 class="font-semibold mb-3">快速統計</h2>
              <div>待審核支出：<span id="adminPendingExpenses">-</span></div>
              <div class="mt-2 text-sm text-amber-700" id="adminAlerts"></div>
            </div>

            <div class="p-4 bg-white rounded shadow">
              <h2 class="font-semibold mb-3">建立活動</h2>
              <div class="grid gap-2 text-sm">
                <input id="newActTitle" class="border rounded px-2 py-1" placeholder="標題">
                <input id="newActDate" type="date" class="border rounded px-2 py-1">
                <input id="newActTime" type="time" class="border rounded px-2 py-1">
                <input id="newActLocation" class="border rounded px-2 py-1" placeholder="地點">
                <input id="newActMax" type="number" class="border rounded px-2 py-1" placeholder="名額">
                <input id="newActFee" type="number" class="border rounded px-2 py-1" placeholder="費用(可空)">
                <textarea id="newActDesc" class="border rounded px-2 py-1" placeholder="描述"></textarea>
                <button id="createActBtn" class="px-3 py-1 bg-blue-600 text-white rounded">建立</button>
              </div>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-4 mt-4">
            <div class="p-4 bg-white rounded shadow">
              <h2 class="font-semibold mb-2">建立捐款</h2>
              <div class="grid gap-2 text-sm">
                <input id="donAmount" type="number" class="border rounded px-2 py-1" placeholder="金額">
                <input id="donCategory" class="border rounded px-2 py-1" placeholder="類別(如: 一般捐款)">
                <input id="donTargetLineId" class="border rounded px-2 py-1" placeholder="lineId (留空=自己)">
                <label class="inline-flex items-center gap-2"><input id="donNeedReceipt" type="checkbox">需要收據</label>
                <button id="createDonBtn" class="px-3 py-1 bg-emerald-600 text-white rounded">建立捐款</button>
              </div>
            </div>

            <div class="p-4 bg-white rounded shadow">
              <h2 class="font-semibold mb-2">建立支出</h2>
              <div class="grid gap-2 text-sm">
                <input id="expAmount" type="number" class="border rounded px-2 py-1" placeholder="金額">
                <input id="expCategory" class="border rounded px-2 py-1" placeholder="類別(如: 活動費用)">
                <input id="expDesc" class="border rounded px-2 py-1" placeholder="說明">
                <button id="createExpBtn" class="px-3 py-1 bg-rose-600 text-white rounded">建立支出申請</button>
              </div>
            </div>
          </div>

          <div class="p-4 bg-white rounded shadow mt-4">
            <h2 class="font-semibold mb-2">活動與收據列表</h2>
            <div id="adminActivities" class="text-sm space-y-2"></div>
            <hr class="my-3">
            <div id="adminReceipts" class="text-sm space-y-2"></div>
          </div>
        </section>
      </main>

      <footer class="mt-10 text-center text-xs text-gray-500">
        Powered by gpt-5
      </footer>
    </div>

    <script>
      // === 設定你的 Apps Script Web App URL ===
      const API_URL = 'https://script.google.com/macros/s/AKfycbxU-xIq2JEddtwZ1mnH7iGzdXzaJMLiC5wWQVELLIaNINfc_2AlDtXPt65pvcVGFDua/exec';

      // 狀態
      const state = {
        lineId: null,
        isAdmin: false,
        cache: {
          activities: [],
          myRegs: [],
          dashboard: null,
          finance: null,
          receipts: []
        }
      };

      function fmt(n) {
        if (typeof n !== 'number') n = Number(n)||0;
        return n.toLocaleString('zh-TW');
      }

      function showNotice(html, type='info') {
        const box = document.getElementById('notice');
        const color = type==='error' ? 'bg-rose-100 text-rose-700' :
                      type==='success' ? 'bg-emerald-100 text-emerald-700' :
                      'bg-blue-100 text-blue-700';
        box.innerHTML = '<div class="p-3 rounded '+color+'">'+ html +'</div>';
        setTimeout(()=>box.innerHTML='', 3500);
      }

      function switchTab(name){
        document.querySelectorAll('section[id^="tab-"]').forEach(sec=>{
          sec.classList.add('hidden');
        });
        document.getElementById('tab-'+name).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(btn=>{
          btn.classList.remove('bg-blue-600','text-white');
          btn.classList.add('bg-gray-200');
          if(btn.dataset.tab===name){
            btn.classList.add('bg-blue-600','text-white');
            btn.classList.remove('bg-gray-200');
          }
        });
      }

      async function api(action, data){
        const payload = { action, data };
        const res = await fetch(API_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        return res.json();
      }

      async function refreshUserInfo() {
        if(!state.lineId) return;
        const r = await api('getUserInfo', { lineId: state.lineId });
        if(r.success){
          state.isAdmin = !!r.data.isAdmin;
          document.querySelector('button[data-tab="admin"]').classList.toggle('hidden', !state.isAdmin);
        }else{
          // 自動幫未註冊使用者做快速註冊（以 lineName=同lineId，memberType=一般）
          const reg = await api('registerUser', { lineId: state.lineId, realName: state.lineId, memberType: '一般', lineName: state.lineId });
          if(!reg.success) showNotice('尚未註冊且自動註冊失敗：'+reg.message, 'error');
          await refreshUserInfo();
        }
      }

      async function loadDashboard() {
        if(!state.lineId) return;
        const r = await api('getDashboardData', { lineId: state.lineId });
        if(r.success){
          state.cache.dashboard = r.data;
          // 首頁數字
          document.getElementById('homeMonthlyDonation').textContent = fmt(r.data.finance.monthlyDonation);
          document.getElementById('homeMonthlyExpense').textContent = fmt(r.data.finance.monthlyExpense);
          document.getElementById('homeBalance').textContent = fmt(r.data.finance.balance);
          // Alerts
          const alertBox = document.getElementById('homeAlerts');
          alertBox.innerHTML = (r.data.alerts||[]).map(a => {
            return '<div>• ['+a.type+'] '+a.title+' - '+a.message+'</div>';
          }).join('') || '<div class="text-gray-400">無</div>';
          // 我的報名
          const regBox = document.getElementById('homeMyRegs');
          const regs = r.data.myRegistrations || [];
          regBox.innerHTML = regs.length ? regs.map(x=>{
            return '<div class="p-2 border rounded flex justify-between items-center">'+
              '<div><div class="font-medium">'+x.activityTitle+'</div><div class="text-xs text-gray-500">'+(x.registrationTime || '')+'</div></div>'+
              '<div class="text-sm">'+x.status+'</div>'+
            '</div>';
          }).join('') : '<div class="text-gray-400">尚無資料</div>';

          // 活動清單
          state.cache.activities = r.data.activities || [];
          renderActivities();
        }else{
          showNotice('載入儀表板失敗：'+r.message, 'error');
        }
      }

      async function loadFinance() {
        if(!state.lineId) return;
        const r = await api('getFinanceData', { lineId: state.lineId });
        if(r.success){
          state.cache.finance = r.data;

          document.getElementById('myDonationTotal').textContent = fmt(r.data.stats.totalDonation);
          document.getElementById('myDonationCount').textContent = fmt(r.data.stats.donationCount);
          document.getElementById('myExpenseTotal').textContent = fmt(r.data.stats.totalExpense);
          document.getElementById('myExpensePending').textContent = fmt(r.data.stats.pendingExpenses);

          const donBox = document.getElementById('myDonations');
          donBox.innerHTML = (r.data.donations||[]).map(d=>{
            return '<div class="p-2 border rounded flex justify-between"><div>'+
              '<div class="font-medium">'+(d.category||'未分類')+'</div>'+
              '<div class="text-xs text-gray-500">'+(d.createdAt||'')+'</div></div>'+
              '<div>+'+fmt(d.amount)+'</div></div>';
          }).join('') || '<div class="text-gray-400">尚無資料</div>';

          const expBox = document.getElementById('myExpenses');
          expBox.innerHTML = (r.data.expenses||[]).map(d=>{
            return '<div class="p-2 border rounded flex justify-between"><div>'+
              '<div class="font-medium">'+(d.category||'未分類')+'</div>'+
              '<div class="text-xs text-gray-500">'+(d.createdAt||'')+'</div></div>'+
              '<div class="'+(d.status==='審核中'?'text-amber-700':'')+'">-'+fmt(d.amount)+'（'+d.status+'）</div></div>';
          }).join('') || '<div class="text-gray-400">尚無資料</div>';

          const adminBlock = document.getElementById('financeAdminStats');
          adminBlock.classList.toggle('hidden', !state.isAdmin);
          if(state.isAdmin){
            const s = r.data.adminStats || {};
            document.getElementById('adminTotalIncome').textContent = fmt(s.totalIncome || 0);
            document.getElementById('adminTotalExpense').textContent = fmt(s.totalExpense || 0);
            document.getElementById('adminCurrentBalance').textContent = fmt((s.currentBalance||0));
            document.getElementById('adminMonthlyDonations').textContent = fmt(s.monthlyDonations || 0);
          }
        }else{
          showNotice('載入財務資料失敗：'+r.message, 'error');
        }
      }

      async function loadReceipts(){
        if(!state.lineId) return;
        const r = await api('getMyReceipts', { lineId: state.lineId });
        if(r.success){
          const box = document.getElementById('myReceiptsList');
          const list = r.data || [];
          box.innerHTML = list.map(x=>{
            const link = x.pdfUrl ? ('<a class="text-blue-600 underline" target="_blank" href="'+x.pdfUrl+'">檢視</a>') : '';
            return '<div class="p-2 border rounded flex justify-between items-center">'+
              '<div><div class="font-medium">'+x.receiptNumber+' - '+x.type+'</div>'+
              '<div class="text-xs text-gray-500">'+(x.issueDate || '')+'</div></div>'+
              '<div>'+fmt(x.amount)+' '+link+'</div></div>';
          }).join('') || '<div class="text-gray-400">尚無資料</div>';
        }else{
          showNotice('載入收據失敗：'+r.message, 'error');
        }
      }

      function renderActivities(){
        const box = document.getElementById('activitiesList');
        const list = state.cache.activities || [];
        box.innerHTML = list.length ? list.map(a=>{
          const open = a.status === '開放報名';
          return '<div class="p-3 border rounded flex flex-col md:flex-row md:items-center md:justify-between">'+
            '<div><div class="font-semibold">'+a.title+'</div>'+
            '<div class="text-xs text-gray-500">'+(a.date||'')+' '+(a.time||'')+' @ '+(a.location||'')+'</div>'+
            '<div class="text-xs text-gray-500">名額 '+(a.currentCount||0)+'/'+(a.maxParticipants||0)+' • 費用 '+fmt(a.fee||0)+'</div></div>'+
            '<div class="mt-2 md:mt-0 flex gap-2">'+
              (open ? '<button class="px-3 py-1 bg-blue-600 text-white rounded" onclick="onRegisterActivity(\''+a.id+'\')">報名</button>' : '<span class="text-gray-400">未開放</span>')+
            '</div></div>';
        }).join('') : '<div class="text-gray-400">尚無活動</div>';
      }

      async function onRegisterActivity(activityId){
        if(!state.lineId) return showNotice('請先登入', 'error');
        const r = await api('registerActivity', { lineId: state.lineId, activityId });
        if(r.success){
          showNotice('報名成功','success');
          await loadDashboard();
        }else{
          showNotice('報名失敗：'+r.message, 'error');
        }
      }

      // 管理員專區載入（活動、收據和警示）
      async function loadAdminBlocks(){
        if(!state.isAdmin) return;
        const dash = await api('getAdminDashboard', state.lineId);
        if(dash.success){
          document.getElementById('adminPendingExpenses').textContent = dash.data.pendingExpenseApprovals;
          document.getElementById('adminAlerts').innerHTML = (dash.data.alerts||[]).map(a=>(
            '<div>• '+a.title+'：'+a.message+'</div>'
          )).join('') || '<div class="text-gray-400">無</div>';
        }

        const ad = await api('getAdminData', { lineId: state.lineId });
        if(ad.success){
          const activities = ad.data.activities || [];
          const receipts = ad.data.receipts || [];
          const aBox = document.getElementById('adminActivities');
          aBox.innerHTML = activities.slice(0,20).map(a=>{
            return '<div class="p-2 border rounded flex justify-between items-center">'+
              '<div><div class="font-medium">'+a.title+'</div>'+
              '<div class="text-xs text-gray-500">'+(a.date||'')+' '+(a.time||'')+'</div></div>'+
              '<div class="text-xs">'+a.status+'</div></div>';
          }).join('') || '<div class="text-gray-400">尚無活動</div>';

          const rBox = document.getElementById('adminReceipts');
          rBox.innerHTML = receipts.slice(0,20).map(rc=>{
            const link = rc.pdfUrl ? ('<a class="text-blue-600 underline" target="_blank" href="'+rc.pdfUrl+'">PDF</a>') : '';
            return '<div class="p-2 border rounded flex justify-between items-center">'+
              '<div><div class="font-medium">'+rc.receiptNumber+' - '+rc.type+'</div>'+
              '<div class="text-xs text-gray-500">'+(rc.issueDate||'')+'</div></div>'+
              '<div>'+fmt(rc.amount)+' '+link+'</div></div>';
          }).join('') || '<div class="text-gray-400">尚無收據</div>';
        }
      }

      // 綁定事件
      document.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          switchTab(btn.dataset.tab);
          if(btn.dataset.tab==='finance') loadFinance();
          if(btn.dataset.tab==='receipts') loadReceipts();
          if(btn.dataset.tab==='admin') loadAdminBlocks();
        });
      });

      document.getElementById('loginBtn').addEventListener('click', async ()=>{
        const id = document.getElementById('lineIdInput').value.trim();
        if(!id) return showNotice('請輸入 lineId','error');
        state.lineId = id;
        document.getElementById('lineIdInput').disabled = true;
        document.getElementById('loginBtn').classList.add('hidden');
        document.getElementById('logoutBtn').classList.remove('hidden');
        await refreshUserInfo();
        await loadDashboard();
        await loadFinance();
        await loadReceipts();
        showNotice('登入成功','success');
      });

      document.getElementById('logoutBtn').addEventListener('click', ()=>{
        state.lineId = null;
        state.isAdmin = false;
        document.getElementById('lineIdInput').disabled = false;
        document.getElementById('lineIdInput').value = '';
        document.getElementById('loginBtn').classList.remove('hidden');
        document.querySelector('button[data-tab="admin"]').classList.add('hidden');
        document.getElementById('logoutBtn').classList.add('hidden');
        showNotice('已登出');
      });

      document.getElementById('createActBtn').addEventListener('click', async ()=>{
        if(!state.isAdmin) return showNotice('需管理員權限','error');
        const title = document.getElementById('newActTitle').value.trim();
        const date = document.getElementById('newActDate').value;
        const time = document.getElementById('newActTime').value;
        const location = document.getElementById('newActLocation').value.trim();
        const maxParticipants = Number(document.getElementById('newActMax').value);
        const fee = Number(document.getElementById('newActFee').value||0);
        const description = document.getElementById('newActDesc').value.trim();
        if(!title || !date || !maxParticipants) return showNotice('請填齊活動必要欄位','error');
        const r = await api('createActivity', { lineId: state.lineId, title, date, time, location, maxParticipants, fee, description });
        if(r.success){
          showNotice('活動建立成功','success');
          await loadDashboard();
          await loadAdminBlocks();
        }else{
          showNotice('建立失敗：'+r.message,'error');
        }
      });

      document.getElementById('createDonBtn').addEventListener('click', async ()=>{
        if(!state.lineId) return showNotice('請先登入','error');
        const amount = Number(document.getElementById('donAmount').value);
        const category = document.getElementById('donCategory').value.trim() || '一般捐款';
        const targetLineId = document.getElementById('donTargetLineId').value.trim();
        const needReceipt = document.getElementById('donNeedReceipt').checked;
        const payload = { lineId: targetLineId || state.lineId, amount, category, needReceipt };
        const action = targetLineId ? 'createManualReceipt' : 'createDonation';
        // 說明：若指定另一人且需要收據，使用 createManualReceipt（同時可選擇是否建立 Donation），此處簡化為直接開立收據
        if(targetLineId){
          payload.targetLineId = targetLineId;
          payload.type = '捐款';
          payload.createDonation = true;
        }
        const r = await api(action, payload);
        if(r.success){
          showNotice('建立成功','success');
          await loadFinance();
          await loadReceipts();
        }else{
          showNotice('建立失敗：'+r.message,'error');
        }
      });

      document.getElementById('createExpBtn').addEventListener('click', async ()=>{
        if(!state.lineId) return showNotice('請先登入','error');
        const amount = Number(document.getElementById('expAmount').value);
        const category = document.getElementById('expCategory').value.trim() || '活動費用';
        const description = document.getElementById('expDesc').value.trim();
        const r = await api('createExpense', { lineId: state.lineId, amount, category, description });
        if(r.success){
          showNotice('支出申請已建立','success');
          await loadFinance();
        }else{
          showNotice('建立失敗：'+r.message,'error');
        }
      });

      // 預設載入首頁
      switchTab('home');
    </script>
  </body>
</html>
