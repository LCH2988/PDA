<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>帕金森病友會管理系統 - 管理員</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes,maximum-scale=3.0">
<link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AOAgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AOAgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AOAgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A">

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
  /* ========== 基礎設定 ========== */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: rgba(220, 53, 69, 0.3);
  }

  :root {
    --admin-primary: #dc3545;
    --admin-primary-dark: #c82333;
    --admin-secondary: #6f42c1;
    --admin-success: #28a745;
    --admin-warning: #ffc107;
    --admin-info: #17a2b8;
    --admin-danger: #dc3545;
    --light-bg: #f8f9fa;
    --white: #ffffff;
    --text-primary: #212529;
    --text-secondary: #6c757d;
    --border-color: #dee2e6;
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-hover: 0 4px 20px rgba(0,0,0,0.15);
  }

  body {
    font-family: 'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
    font-size: 16px;
    line-height: 1.6;
    color: var(--text-primary);
    background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
    min-height: 100vh;
    padding: 0;
    margin: 0;
  }

  /* ========== 管理員專用樣式 ========== */
  .admin-container {
    max-width: 100%;
    min-height: 100vh;
    background: var(--white);
    position: relative;
  }

  .admin-header {
    background: linear-gradient(135deg, var(--admin-primary) 0%, var(--admin-primary-dark) 100%);
    color: white;
    padding: 20px 15px 15px;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: var(--shadow);
  }

  .admin-header h1 {
    font-size: 22px;
    font-weight: 700;
    margin: 0 0 8px 0;
    text-align: center;
  }

  .admin-header .subtitle {
    font-size: 14px;
    text-align: center;
    opacity: 0.9;
    margin: 0;
  }

  .admin-user-info {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 15px;
    padding: 12px 15px;
    margin-top: 15px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .admin-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 600;
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }

  /* ========== 管理員導航 ========== */
  .admin-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--white);
    border-top: 1px solid var(--border-color);
    padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
    z-index: 1000;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  }

  .admin-nav-items {
    display: flex;
    justify-content: space-around;
    align-items: center;
    max-width: 100%;
    margin: 0 auto;
  }

  .admin-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 6px 4px;
    text-decoration: none;
    color: var(--text-secondary);
    transition: all 0.3s ease;
    border-radius: 10px;
    min-width: 55px;
    cursor: pointer;
    border: none;
    background: none;
    font-size: 12px;
  }

  .admin-nav-item.active {
    color: var(--admin-primary);
    background: rgba(220, 53, 69, 0.1);
  }

  .admin-nav-item i {
    font-size: 20px;
    margin-bottom: 2px;
  }

  .admin-nav-item span {
    font-size: 10px;
    font-weight: 500;
    text-align: center;
    line-height: 1.1;
  }

  /* ========== 主要內容區域 ========== */
  .admin-content {
    padding: 15px 15px 90px;
    min-height: calc(100vh - 160px);
  }

  .admin-section {
    display: none;
  }

  .admin-section.active {
    display: block;
  }

  /* ========== 卡片設計 ========== */
  .admin-card {
    background: var(--white);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 15px;
    box-shadow: var(--shadow);
    border: none;
  }

  .admin-card-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 12px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .admin-card-text {
    font-size: 14px;
    color: var(--text-secondary);
    margin: 0 0 12px 0;
    line-height: 1.4;
  }

  /* ========== 統計卡片 ========== */
  .admin-stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .admin-stat-card {
    background: linear-gradient(135deg, var(--admin-primary), var(--admin-primary-dark));
    color: white;
    padding: 16px;
    border-radius: 12px;
    text-align: center;
    box-shadow: var(--shadow);
  }

  .admin-stat-card.secondary {
    background: linear-gradient(135deg, var(--admin-secondary), #5a2d91);
  }

  .admin-stat-card.success {
    background: linear-gradient(135deg, var(--admin-success), #1e7e34);
  }

  .admin-stat-card.warning {
    background: linear-gradient(135deg, var(--admin-warning), #e0a800);
  }

  .admin-stat-card.info {
    background: linear-gradient(135deg, var(--admin-info), #117a8b);
  }

  .admin-stat-number {
    font-size: 24px;
    font-weight: 700;
    margin: 0 0 4px 0;
  }

  .admin-stat-label {
    font-size: 12px;
    opacity: 0.9;
    margin: 0;
  }

  /* ========== 按鈕設計 ========== */
  .admin-btn {
    font-size: 14px;
    font-weight: 600;
    padding: 10px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    min-height: 40px;
    touch-action: manipulation;
  }

  .admin-btn-primary {
    background: linear-gradient(135deg, var(--admin-primary), var(--admin-primary-dark));
    color: white;
  }

  .admin-btn-success {
    background: linear-gradient(135deg, var(--admin-success), #1e7e34);
    color: white;
  }

  .admin-btn-warning {
    background: linear-gradient(135deg, var(--admin-warning), #e0a800);
    color: white;
  }

  .admin-btn-info {
    background: linear-gradient(135deg, var(--admin-info), #117a8b);
    color: white;
  }

  .admin-btn-secondary {
    background: #6c757d;
    color: white;
  }

  .admin-btn-outline {
    background: transparent;
    color: var(--admin-primary);
    border: 1px solid var(--admin-primary);
  }

  .admin-btn-sm {
    font-size: 12px;
    padding: 6px 12px;
    min-height: 32px;
  }

  .admin-btn-block {
    width: 100%;
    margin-bottom: 10px;
  }

  /* ========== 表單設計 ========== */
  .admin-form-group {
    margin-bottom: 15px;
  }

  .admin-form-label {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 6px;
    display: block;
  }

  .admin-form-control, .admin-form-select {
    font-size: 14px;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--white);
    color: var(--text-primary);
    width: 100%;
    transition: border-color 0.3s ease;
    min-height: 40px;
  }

  .admin-form-control:focus, .admin-form-select:focus {
    outline: none;
    border-color: var(--admin-primary);
    box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.1);
  }

  textarea.admin-form-control {
    min-height: 80px;
    resize: vertical;
  }

  /* ========== 表格設計 ========== */
  .admin-table-container {
    background: var(--white);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: var(--shadow);
    margin-bottom: 15px;
  }

  .admin-table {
    width: 100%;
    font-size: 13px;
    margin: 0;
  }

  .admin-table th {
    background: #f8f9fa;
    font-weight: 600;
    padding: 12px 8px;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
    font-size: 12px;
  }

  .admin-table td {
    padding: 10px 8px;
    border-bottom: 1px solid #f1f3f4;
    vertical-align: middle;
  }

  .admin-table tbody tr:hover {
    background-color: rgba(220, 53, 69, 0.05);
  }

  /* ========== 項目列表 ========== */
  .admin-item {
    background: var(--white);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 12px;
    box-shadow: var(--shadow);
    border-left: 3px solid var(--admin-primary);
  }

  .admin-item-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 8px 0;
  }

  .admin-item-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 8px;
    font-size: 12px;
    color: var(--text-secondary);
  }

  .admin-item-meta span {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .admin-item-description {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 10px;
    line-height: 1.4;
  }

  .admin-item-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* ========== 狀態標籤 ========== */
  .admin-status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .admin-status-active {
    background: #d4edda;
    color: #155724;
  }

  .admin-status-pending {
    background: #fff3cd;
    color: #856404;
  }

  .admin-status-rejected {
    background: #f8d7da;
    color: #721c24;
  }

  .admin-status-completed {
    background: #e2e3ff;
    color: #383d41;
  }

  /* ========== 快速操作區 ========== */
  .admin-quick-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }

  .admin-quick-btn {
    background: var(--white);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    text-decoration: none;
    color: var(--text-primary);
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }

  .admin-quick-btn:hover, .admin-quick-btn:active {
    border-color: var(--admin-primary);
    color: var(--admin-primary);
    background: rgba(220, 53, 69, 0.05);
  }

  .admin-quick-btn i {
    font-size: 24px;
  }

  .admin-quick-btn span {
    font-size: 12px;
    font-weight: 600;
  }

  /* ========== 通知系統 ========== */
  .admin-notification {
    position: fixed;
    top: 15px;
    left: 15px;
    right: 15px;
    background: var(--white);
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: var(--shadow-hover);
    z-index: 2000;
    transform: translateY(-80px);
    opacity: 0;
    transition: all 0.4s ease;
    font-size: 14px;
  }

  .admin-notification.show {
    transform: translateY(0);
    opacity: 1;
  }

  .admin-notification.success {
    border-left: 3px solid var(--admin-success);
    background: #d4edda;
    color: #155724;
  }

  .admin-notification.error {
    border-left: 3px solid var(--admin-danger);
    background: #f8d7da;
    color: #721c24;
  }

  .admin-notification.warning {
    border-left: 3px solid var(--admin-warning);
    background: #fff3cd;
    color: #856404;
  }

  /* ========== 載入動畫 ========== */
  .admin-loading {
    text-align: center;
    padding: 30px 15px;
    color: var(--text-secondary);
  }

  .admin-spinner {
    width: 30px;
    height: 30px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--admin-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ========== 空狀態 ========== */
  .admin-empty-state {
    text-align: center;
    padding: 30px 15px;
    color: var(--text-secondary);
  }

  .admin-empty-state i {
    font-size: 36px;
    margin-bottom: 10px;
    opacity: 0.5;
  }

  .admin-empty-state h5 {
    font-size: 16px;
    margin-bottom: 8px;
  }

  .admin-empty-state p {
    font-size: 14px;
    margin: 0;
  }

  /* ========== Modal 設計 ========== */
  .admin-modal-content {
    border-radius: 12px;
    border: none;
    box-shadow: var(--shadow-hover);
  }

  .admin-modal-header {
    border-bottom: 1px solid var(--border-color);
    padding: 15px;
  }

  .admin-modal-title {
    font-size: 18px;
    font-weight: 700;
  }

  .admin-modal-body {
    padding: 15px;
  }

  .admin-modal-footer {
    border-top: 1px solid var(--border-color);
    padding: 15px;
    gap: 8px;
  }

  /* ========== 響應式設計 ========== */
  @media (max-width: 576px) {
    .admin-stats-grid {
      grid-template-columns: 1fr;
    }
    
    .admin-quick-actions {
      grid-template-columns: 1fr;
    }
    
    .admin-item-meta {
      flex-direction: column;
      gap: 6px;
    }
    
    .admin-table {
      font-size: 11px;
    }
    
    .admin-table th,
    .admin-table td {
      padding: 8px 4px;
    }
  }

  /* ========== 特殊功能 ========== */
  .admin-badge {
    background: var(--admin-primary);
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 600;
  }

  .admin-highlight {
    background: rgba(220, 53, 69, 0.1);
    padding: 2px 4px;
    border-radius: 4px;
  }

  /* 金額顯示 */
  .admin-amount {
    font-weight: 700;
    font-size: 14px;
  }

  .admin-amount.positive {
    color: var(--admin-success);
  }

  .admin-amount.negative {
    color: var(--admin-danger);
  }

  /* ========== 安全區域適配 ========== */
  .admin-container {
    padding-top: env(safe-area-inset-top);
  }

  .admin-nav {
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
  }
</style>
</head>
<body>
<div class="admin-container">
  <!-- 管理員標題列 -->
  <div class="admin-header">
    <h1><i class="bi bi-shield-check"></i> 管理員控制台</h1>
    <p class="subtitle">帕金森病友會管理系統</p>
    
    <div id="adminUserInfo" class="admin-user-info" style="display:none;">
      <div class="admin-avatar" id="adminUserAvatar">A</div>
      <div style="flex: 1;">
        <div style="font-weight: 600; font-size: 14px;" id="adminUserName">管理員</div>
        <div style="font-size: 12px; opacity: 0.8;" id="adminUserRole">系統管理員</div>
      </div>
      <button class="admin-btn admin-btn-sm" onclick="refreshAdminData()" style="background:rgba(255,255,255,0.2);color:white;">
        <i class="bi bi-arrow-clockwise"></i>
      </button>
    </div>
  </div>

  <!-- 通知容器 -->
  <div id="adminNotificationContainer"></div>

  <!-- 主要內容區域 -->
  <div class="admin-content">
    
    <!-- 儀表板 -->
    <div class="admin-section active" id="adminDashboard">
      <div class="admin-card">
        <div class="admin-card-title">
          <i class="bi bi-speedometer2"></i>
          系統概覽
        </div>
        <div class="admin-card-text">
          管理員專用的系統監控和快速操作中心
        </div>
      </div>

      <div class="admin-stats-grid" id="adminDashboardStats">
        <div class="admin-stat-card">
          <div class="admin-stat-number" id="totalMembers">0</div>
          <div class="admin-stat-label">總會員數</div>
        </div>
        <div class="admin-stat-card secondary">
          <div class="admin-stat-number" id="activeActivities">0</div>
          <div class="admin-stat-label">進行中活動</div>
        </div>
        <div class="admin-stat-card success">
          <div class="admin-stat-number" id="totalDonations">$0</div>
          <div class="admin-stat-label">總捐款額</div>
        </div>
        <div class="admin-stat-card warning">
          <div class="admin-stat-number" id="pendingApprovals">0</div>
          <div class="admin-stat-label">待審核項目</div>
        </div>
      </div>

      <div class="admin-quick-actions">
        <div class="admin-quick-btn" onclick="switchAdminTab('members')">
          <i class="bi bi-people"></i>
          <span>會員管理</span>
        </div>
        <div class="admin-quick-btn" onclick="switchAdminTab('activities')">
          <i class="bi bi-calendar-plus"></i>
          <span>新增活動</span>
        </div>
        <div class="admin-quick-btn" onclick="showSystemNotificationModal()">
          <i class="bi bi-megaphone"></i>
          <span>發送通知</span>
        </div>
        <div class="admin-quick-btn" onclick="exportAllData()">
          <i class="bi bi-download"></i>
          <span>匯出資料</span>
        </div>
      </div>

      <div class="admin-card">
        <div class="admin-card-title">
          <i class="bi bi-exclamation-triangle"></i>
          需要注意的項目
        </div>
        <div id="adminAlerts">
          <div class="admin-loading">
            <div class="admin-spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 會員管理 -->
    <div class="admin-section" id="adminMembers">
      <div class="admin-card">
        <div class="admin-card-title">
          <i class="bi bi-people"></i>
          會員管理
        </div>
        <div class="admin-card-text">
          管理所有會員資料、審核申請和權限設定
        </div>
      </div>

      <div class="admin-card">
        <div style="display: flex; justify-content-between; align-items: center; margin-bottom: 15px;">
          <h6 style="margin: 0;">會員列表</h6>
          <button class="admin-btn admin-btn-info admin-btn-sm" onclick="exportMembers()">
            <i class="bi bi-download"></i> 匯出
          </button>
        </div>
        
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>姓名</th>
                <th>類別</th>
                <th>狀態</th>
                <th>加入日期</th>
                <th>操作</th>
                </tr>
              </thead>
              <tbody id="adminMembersList">
                <tr>
                  <td colspan="5">
                    <div class="admin-loading">
                      <div class="admin-spinner"></div>
                      <p>載入中...</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="admin-card">
          <div class="admin-card-title">
            <i class="bi bi-person-plus"></i>
            待審核會員
          </div>
          <div id="pendingMembers">
            <div class="admin-loading">
              <div class="admin-spinner"></div>
              <p>載入中...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 活動管理 -->
      <div class="admin-section" id="adminActivities">
        <div class="admin-card">
          <div class="admin-card-title">
            <i class="bi bi-calendar-event"></i>
            活動管理
          </div>
          <div class="admin-card-text">
            建立、編輯和管理所有活動，監控報名狀況
          </div>
        </div>

        <div class="admin-card">
          <button class="admin-btn admin-btn-primary admin-btn-block" onclick="showCreateActivityModal()">
            <i class="bi bi-plus-circle"></i>
            建立新活動
          </button>
        </div>

        <div class="admin-card">
          <div class="admin-card-title">
            <i class="bi bi-list-ul"></i>
            活動列表
          </div>
          <div id="adminActivitiesList">
            <div class="admin-loading">
              <div class="admin-spinner"></div>
              <p>載入中...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 志工管理 -->
      <div class="admin-section" id="adminVolunteers">
        <div class="admin-card">
          <div class="admin-card-title">
            <i class="bi bi-heart"></i>
            志工管理
          </div>
          <div class="admin-card-text">
            管理志工需求、審核申請和記錄服務時數
          </div>
        </div>

        <div class="admin-card">
          <button class="admin-btn admin-btn-success admin-btn-block" onclick="showCreateVolunteerNeedModal()">
            <i class="bi bi-plus-circle"></i>
            發布志工需求
          </button>
        </div>

        <div class="admin-card">
          <div class="admin-card-title">
            <i class="bi bi-clipboard-check"></i>
            志工申請審核
          </div>
          <div id="volunteerApplications">
            <div class="admin-loading">
              <div class="admin-spinner"></div>
              <p>載入中...</p>
            </div>
          </div>
        </div>

        <div class="admin-card">
          <div class="admin-card-title">
            <i class="bi bi-award"></i>
            服務時數管理
          </div>
          <div id="volunteerHoursManagement">
            <div class="admin-loading">
              <div class="admin-spinner"></div>
              <p>載入中...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 財務管理 -->
      <div class="admin-section" id="adminFinance">
        <div class="admin-card">
          <div class="admin-card-title">
            <i class="bi bi-cash-stack"></i>
            財務管理
          </div>
          <div class="admin-card-text">
            管理捐款記錄、審核支出申請和財務報表
          </div>
        </div>

        <div class="admin-stats-grid">
          <div class="admin-stat-card success">
            <div class="admin-stat-number" id="monthlyDonations">$0</div>
            <div class="admin-stat-label">本月捐款</div>
          </div>
          <div class="admin-stat-card warning">
            <div class="admin-stat-number" id="monthlyExpenses">$0</div>
            <div class="admin-stat-label">本月支出</div>
          </div>
          <div class="admin-stat-card info">
            <div class="admin-stat-number" id="pendingExpenseApprovals">0</div>
            <div class="admin-stat-label">待審核支出</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-number" id="accountBalance">$0</div>
            <div class="admin-stat-label">帳戶餘額</div>
          </div>
        </div>

        <div class="admin-card">
          <div class="admin-card-title">
            <i class="bi bi-receipt"></i>
            支出申請審核
          </div>
          <div id="expenseApprovals">
            <div class="admin-loading">
              <div class="admin-spinner"></div>
              <p>載入中...</p>
            </div>
          </div>
        </div>

        <div class="admin-card">
          <div class="admin-card-title">
            <i class="bi bi-graph-up"></i>
            財務報表
          </div>
          <div class="admin-quick-actions">
            <button class="admin-btn admin-btn-info" onclick="generateMonthlyReport()">
              <i class="bi bi-file-earmark-text"></i>
              月報表
            </button>
            <button class="admin-btn admin-btn-info" onclick="generateYearlyReport()">
              <i class="bi bi-file-earmark-bar-graph"></i>
              年報表
            </button>
          </div>
        </div>
      </div>

      <!-- 系統設定 -->
      <div class="admin-section" id="adminSettings">
        <div class="admin-card">
          <div class="admin-card-title">
            <i class="bi bi-gear"></i>
            系統設定
          </div>
          <div class="admin-card-text">
            管理系統參數、權限設定和資料備份
          </div>
        </div>

        <div class="admin-card">
          <div class="admin-card-title">
            <i class="bi bi-shield-lock"></i>
            管理員權限
          </div>
          <form id="adminPermissionsForm">
            <div class="admin-form-group">
              <label class="admin-form-label">新增管理員</label>
              <div style="display: flex; gap: 8px;">
                <input type="text" class="admin-form-control" placeholder="輸入會員 LINE ID" id="newAdminLineId">
                <button type="button" class="admin-btn admin-btn-primary" onclick="addAdmin()">
                  <i class="bi bi-plus"></i>
                </button>
              </div>
            </div>
          </form>
          
          <div id="adminsList">
            <div class="admin-loading">
              <div class="admin-spinner"></div>
              <p>載入中...</p>
            </div>
          </div>
        </div>

        <div class="admin-card">
          <div class="admin-card-title">
            <i class="bi bi-database"></i>
            資料管理
          </div>
          <div class="admin-quick-actions">
            <button class="admin-btn admin-btn-info" onclick="backupData()">
              <i class="bi bi-cloud-upload"></i>
              備份資料
            </button>
            <button class="admin-btn admin-btn-warning" onclick="showRestoreModal()">
              <i class="bi bi-cloud-download"></i>
              還原資料
            </button>
          </div>
        </div>

        <div class="admin-card">
          <div class="admin-card-title">
            <i class="bi bi-graph-up-arrow"></i>
            系統統計
          </div>
          <div id="systemStats">
            <div class="admin-loading">
              <div class="admin-spinner"></div>
              <p>載入中...</p>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 管理員底部導航 -->
    <div class="admin-nav">
      <div class="admin-nav-items">
        <button class="admin-nav-item active" onclick="switchAdminTab('dashboard')">
          <i class="bi bi-speedometer2"></i>
          <span>儀表板</span>
        </button>
        <button class="admin-nav-item" onclick="switchAdminTab('members')">
          <i class="bi bi-people"></i>
          <span>會員</span>
        </button>
        <button class="admin-nav-item" onclick="switchAdminTab('activities')">
          <i class="bi bi-calendar-event"></i>
          <span>活動</span>
        </button>
        <button class="admin-nav-item" onclick="switchAdminTab('volunteers')">
          <i class="bi bi-heart"></i>
          <span>志工</span>
        </button>
        <button class="admin-nav-item" onclick="switchAdminTab('finance')">
          <i class="bi bi-cash-stack"></i>
          <span>財務</span>
        </button>
        <button class="admin-nav-item" onclick="switchAdminTab('settings')">
          <i class="bi bi-gear"></i>
          <span>設定</span>
        </button>
      </div>
    </div>

    <!-- Modal 容器 -->
    <div id="adminModalContainer"></div>
  </div>

  <script>
    // ========== 管理員設定 ==========
    const ADMIN_CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycbzrCTMy_YbLthK9p4oi9S2Dy8VxnfjZySqm8y0-x3lNNtVrQa7yOE666JnIF3aaYa4v/exec',
      API_KEY: 'AAbb8520258185202581'
    };

    // ========== 全域狀態 ==========
    let adminUserProfile = null;
    let currentAdminUser = null;
    let currentAdminTab = 'dashboard';

    // ========== 工具函數 ==========
    const formatDate = d => {
      if(!d) return '-';
      const dt = new Date(d);
      if(isNaN(dt)) return '-';
      return dt.toLocaleDateString('zh-TW');
    };

    const formatDateTime = d => {
      if(!d) return '-';
      const dt = new Date(d);
      if(isNaN(dt)) return '-';
      return dt.toLocaleString('zh-TW');
    };

    const formatCurrency = n =>
      new Intl.NumberFormat('zh-TW',{style:'currency',currency:'TWD',minimumFractionDigits:0}).format(n||0);

    // ========== 通知系統 ==========
    function showAdminNotification(msg, type = 'success', ms = 3000) {
      const wrap = document.getElementById('adminNotificationContainer');
      const el = document.createElement('div');
      el.className = `admin-notification ${type}`;
      el.innerHTML = `
        <div style="display: flex; justify-content: between; align-items: start;">
          <span style="font-size: 14px; font-weight: 500; flex: 1;">${msg}</span>
          <button style="background:none;border:none;font-size:18px;line-height:1;margin-left:10px;" onclick="this.closest('.admin-notification').remove()">&times;</button>
        </div>`;
      wrap.appendChild(el);
      requestAnimationFrame(() => el.classList.add('show'));
      setTimeout(() => {
        el.classList.remove('show');
        setTimeout(() => el.remove(), 350);
      }, ms);
    }

    // ========== 載入狀態管理 ==========
    function setAdminButtonLoading(btn, loading = true) {
      if (!btn) return;
      if (loading) {
        if (!btn.dataset.originalText) btn.dataset.originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-arrow-repeat" style="animation: spin 1s linear infinite;"></i> 處理中...';
        btn.disabled = true;
      } else {
        btn.disabled = false;
        if (btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText;
      }
    }

    // ========== API 呼叫 ==========
    async function callAdminAPI(action, data = {}, retries = 2) {
      const payload = {
        action,
        apiKey: ADMIN_CONFIG.API_KEY,
        timestamp: Date.now(),
        isAdmin: true,
        ...data
      };
      
      let lastErr;
      for (let i = 0; i <= retries; i++) {
        try {
          const res = await fetch(ADMIN_CONFIG.API_BASE_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
          });
          const text = await res.text();
          let json;
          try { 
            json = JSON.parse(text); 
          } catch(e) { 
            throw new Error('回應非 JSON: ' + text.slice(0, 120)); 
          }
          if (!json.success) throw new Error(json.message || 'API 錯誤');
          return json;
        } catch (err) {
          lastErr = err;
          await new Promise(r => setTimeout(r, 400 * (i + 1)));
        }
      }
      throw lastErr;
    }

    // ========== Tab 切換 ==========
    function switchAdminTab(tabName) {
      // 隱藏所有內容區域
      document.querySelectorAll('.admin-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // 移除所有導航項目的 active 狀態
      document.querySelectorAll('.admin-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // 顯示目標內容區域
      document.getElementById('admin' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
      
      // 設定對應導航項目為 active
      document.querySelector(`[onclick="switchAdminTab('${tabName}')"]`).classList.add('active');
      
      currentAdminTab = tabName;
      
      // 載入對應資料
      switch(tabName) {
        case 'dashboard':
          loadAdminDashboard();
          break;
        case 'members':
          loadMembersManagement();
          break;
        case 'activities':
          loadActivitiesManagement();
          break;
        case 'volunteers':
          loadVolunteersManagement();
          break;
        case 'finance':
          loadFinanceManagement();
          break;
        case 'settings':
          loadSystemSettings();
          break;
      }
    }

    // ========== LIFF 初始化 ==========
    async function initializeAdminLiff() {
      try {
        await liff.init({ liffId: ADMIN_CONFIG.LIFF_ID });
        if (!liff.isLoggedIn()) { 
          liff.login(); 
          return; 
        }
        
        adminUserProfile = await liff.getProfile();
        
        // 檢查管理員權限
        await checkAdminPermission();
        
        // 顯示用戶資訊
        const userInfo = document.getElementById('adminUserInfo');
        userInfo.style.display = 'flex';
        document.getElementById('adminUserName').textContent = adminUserProfile.displayName || '管理員';
        document.getElementById('adminUserAvatar').textContent = (adminUserProfile.displayName || '?').charAt(0);

        await loadAdminDashboard();
        showAdminNotification('管理員系統初始化完成', 'success');
      } catch (err) {
        console.error(err);
        showAdminNotification('系統初始化失敗：' + err.message, 'error');
      }
    }

    // ========== 權限檢查 ==========
    async function checkAdminPermission() {
      try {
        const r = await callAdminAPI('checkAdminPermission', { lineId: adminUserProfile.userId });
        if (!r.success || !r.data.isAdmin) {
          throw new Error('您沒有管理員權限');
        }
        currentAdminUser = r.data;
        document.getElementById('adminUserRole').textContent = '系統管理員';
      } catch (err) {
        alert('權限驗證失敗：' + err.message);
        window.location.href = '/';
      }
    }

    // ========== 儀表板 ==========
    async function loadAdminDashboard() {
      try {
        const r = await callAdminAPI('getAdminDashboard', { lineId: adminUserProfile?.userId });
        const data = r.data || {};
        
        // 更新統計數據
        document.getElementById('totalMembers').textContent = data.totalMembers || 0;
        document.getElementById('activeActivities').textContent = data.activeActivities || 0;
        document.getElementById('totalDonations').textContent = formatCurrency(data.totalDonations || 0).replace('NT$', '$');
        document.getElementById('pendingApprovals').textContent = data.pendingApprovals || 0;
        
        renderAdminAlerts(data.alerts || []);
      } catch (err) {
        showAdminNotification('載入儀表板失敗', 'error');
      }
    }

    function renderAdminAlerts(alerts) {
      const container = document.getElementById('adminAlerts');
      if (!alerts.length) {
        container.innerHTML = `
          <div class="admin-empty-state">
            <i class="bi bi-check-circle"></i>
            <h5>系統運作正常</h5>
            <p>目前沒有需要注意的項目</p>
          </div>`;
        return;
      }
      
      container.innerHTML = alerts.map(alert => `
        <div class="admin-item" style="border-left-color: ${alert.type === 'warning' ? '#ffc107' : '#dc3545'};">
          <div class="admin-item-title">${alert.title}</div>
          <div class="admin-item-description">${alert.message}</div>
          <div class="admin-item-meta">
            <span><i class="bi bi-clock"></i> ${formatDateTime(alert.timestamp)}</span>
          </div>
        </div>
      `).join('');
    }

    // ========== 會員管理 ==========
    async function loadMembersManagement() {
      try {
        const r = await callAdminAPI('getAllMembers', { lineId: adminUserProfile.userId });
        renderMembersList(r.data || []);
        
        const pending = await callAdminAPI('getPendingMembers', { lineId: adminUserProfile.userId });
        renderPendingMembers(pending.data || []);
      } catch (err) {
        showAdminNotification('載入會員資料失敗', 'error');
      }
    }

    function renderMembersList(members) {
      const tbody = document.getElementById('adminMembersList');
      if (!members.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5">
              <div class="admin-empty-state">
                <i class="bi bi-people"></i>
                <h5>暫無會員資料</h5>
              </div>
            </td>
          </tr>`;
        return;
      }
      
      tbody.innerHTML = members.map(member => `
        <tr>
          <td>${member.realName || member.lineName || '-'}</td>
          <td><span class="admin-badge">${member.memberType || '一般'}</span></td>
          <td><span class="admin-status-badge admin-status-${member.status || 'active'}">${member.status || '正常'}</span></td>
          <td>${formatDate(member.joinDate)}</td>
          <td>
            <button class="admin-btn admin-btn-info admin-btn-sm" onclick="viewMemberDetail('${member.lineId}')">
              <i class="bi bi-eye"></i>
            </button>
            <button class="admin-btn admin-btn-warning admin-btn-sm" onclick="editMember('${member.lineId}')">
              <i class="bi bi-pencil"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    function renderPendingMembers(pending) {
      const container = document.getElementById('pendingMembers');
      if (!pending.length) {
        container.innerHTML = `
          <div class="admin-empty-state">
            <i class="bi bi-check-circle"></i>
            <h5>沒有待審核會員</h5>
            <p>所有申請都已處理完成</p>
          </div>`;
        return;
      }
      
      container.innerHTML = pending.map(member => `
        <div class="admin-item">
          <div class="admin-item-title">${member.realName || member.lineName}</div>
          <div class="admin-item-meta">
            <span><i class="bi bi-person"></i> ${member.memberType}</span>
            <span><i class="bi bi-calendar"></i> ${formatDateTime(member.applicationDate)}</span>
          </div>
          <div class="admin-item-actions">
            <button class="admin-btn admin-btn-success admin-btn-sm" onclick="approveMember('${member.lineId}')">
              <i class="bi bi-check"></i> 核准
            </button>
            <button class="admin-btn admin-btn-secondary admin-btn-sm" onclick="rejectMember('${member.lineId}')">
              <i class="bi bi-x"></i> 拒絕
            </button>
          </div>
        </div>
      `).join('');
    }

    // ========== 活動管理 ==========
    async function loadActivitiesManagement() {
      try {
        const r = await callAdminAPI('getAllActivitiesForAdmin', { lineId: adminUserProfile.userId });
        renderAdminActivitiesList(r.data || []);
      } catch (err) {
        showAdminNotification('載入活動資料失敗', 'error');
      }
    }

    function renderAdminActivitiesList(activities) {
      const container = document.getElementById('adminActivitiesList');
      if (!activities.length) {
        container.innerHTML = `
          <div class="admin-empty-state">
            <i class="bi bi-calendar-x"></i>
            <h5>暫無活動</h5>
            <p>點擊上方按鈕建立第一個活動</p>
          </div>`;
        return;
      }
      
      container.innerHTML = activities.map(activity => `
        <div class="admin-item">
          <div class="admin-item-title">${activity.title}</div>
          <div class="admin-item-meta">
            <span><i class="bi bi-calendar"></i> ${formatDate(activity.date)}</span>
            <span><i class="bi bi-people"></i> ${activity.currentCount || 0}/${activity.maxParticipants || 0}</span>
            <span><i class="bi bi-cash"></i> ${formatCurrency(activity.fee || 0)}</span>
          </div>
          <div class="admin-item-description">${activity.description || ''}</div>
          <div style="display: flex; justify-content: between; align-items: center; margin-top: 10px;">
            <span class="admin-status-badge admin-status-${activity.status}">${activity.status}</span>
            <div class="admin-item-actions">
              <button class="admin-btn admin-btn-info admin-btn-sm" onclick="viewActivityDetail('${activity.id}')">
                <i class="bi bi-eye"></i> 詳情
              </button>
              <button class="admin-btn admin-btn-warning admin-btn-sm" onclick="editActivity('${activity.id}')">
                <i class="bi bi-pencil"></i> 編輯
              </button>
              <button class="admin-btn admin-btn-secondary admin-btn-sm" onclick="manageActivityRegistrations('${activity.id}')">
                <i class="bi bi-list"></i> 報名
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // ========== Modal 處理函數 ==========
    function showCreateActivityModal() {
      const html = `
        <div class="modal fade" id="createActivityModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="admin-modal-content" id="createActivityForm">
              <div class="admin-modal-header">
                <h5 class="admin-modal-title"><i class="bi bi-plus-circle me-2"></i>建立新活動</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="admin-modal-body">
                <div class="admin-form-group">
                  <label class="admin-form-label">活動名稱 *</label>
                  <input type="text" class="admin-form-control" name="title" required>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">活動日期 *</label>
                  <input type="date" class="admin-form-control" name="date" required>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">活動時間</label>
                  <input type="time" class="admin-form-control" name="time">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">活動地點</label>
                  <input type="text" class="admin-form-control" name="location">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">活動描述</label>
                  <textarea class="admin-form-control" name="description"></textarea>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">參與人數上限</label>
                  <input type="number" class="admin-form-control" name="maxParticipants" min="1">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">活動費用</label>
                  <input type="number" class="admin-form-control" name="fee" min="0">
                </div>
              </div>
              <div class="admin-modal-footer">
                <button class="admin-btn admin-btn-secondary" type="button" data-bs-dismiss="modal">取消</button>
                <button class="admin-btn admin-btn-primary" type="submit">
                  <i class="bi bi-check"></i> 建立活動
                </button>
              </div>
            </form>
          </div>
        </div>`;
      
      document.getElementById('adminModalContainer').innerHTML = html;
      const modal = new bootstrap.Modal(document.getElementById('createActivityModal'));
      modal.show();
      
      document.getElementById('createActivityForm').addEventListener('submit', handleCreateActivity);
    }

    async function handleCreateActivity(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setAdminButtonLoading(btn, true);
      
      try {
        await callAdminAPI('createActivity', {
          lineId: adminUserProfile.userId,
          title: fd.get('title'),
          date: fd.get('date'),
          time: fd.get('time'),
          location: fd.get('location'),
          description: fd.get('description'),
          maxParticipants: parseInt(fd.get('maxParticipants')) || null,
          fee: parseInt(fd.get('fee')) || 0
        });
        showAdminNotification('活動建立成功！', 'success');
        bootstrap.Modal.getInstance(document.getElementById('createActivityModal')).hide();
        await loadActivitiesManagement();
      } catch (err) {
        showAdminNotification('建立失敗：' + err.message, 'error');
      } finally { 
        setAdminButtonLoading(btn, false); 
      }
    }

    // ========== 刷新資料 ==========
    async function refreshAdminData() {
      try {
        showAdminNotification('正在刷新資料...', 'info', 1000);
        
        await Promise.all([
          loadAdminDashboard(),
          currentAdminTab === 'members' ? loadMembersManagement() : Promise.resolve(),
          currentAdminTab === 'activities' ? loadActivitiesManagement() : Promise.resolve(),
          currentAdminTab === 'volunteers' ? loadVolunteersManagement() : Promise.resolve(),
          currentAdminTab === 'finance' ? loadFinanceManagement() : Promise.resolve(),
          currentAdminTab === 'settings' ? loadSystemSettings() : Promise.resolve()
        ]);
        
        showAdminNotification('資料刷新完成！', 'success');
      } catch (err) {
        showAdminNotification('刷新失敗：' + err.message, 'error');
      }
    }

    // ========== 會員操作 ==========
    async function approveMember(lineId) {
      if (!confirm('確定要核准這位會員嗎？')) return;
      
      try {
        await callAdminAPI('approveMember', { 
          lineId: adminUserProfile.userId, 
          targetLineId: lineId 
        });
        showAdminNotification('會員核准成功', 'success');
        await loadMembersManagement();
        await loadAdminDashboard();
      } catch (err) {
        showAdminNotification('核准失敗：' + err.message, 'error');
      }
    }

    async function rejectMember(lineId) {
      if (!confirm('確定要拒絕這位會員申請嗎？')) return;
      
      try {
        await callAdminAPI('rejectMember', { 
          lineId: adminUserProfile.userId, 
          targetLineId: lineId 
        });
        showAdminNotification('已拒絕會員申請', 'success');
        await loadMembersManagement();
      } catch (err) {
        showAdminNotification('操作失敗：' + err.message, 'error');
      }
    }

    // ========== 志工管理 ==========
    async function loadVolunteersManagement() {
      try {
        const applications = await callAdminAPI('getVolunteerApplications', { lineId: adminUserProfile.userId });
        renderVolunteerApplications(applications.data || []);
        
        const hours = await callAdminAPI('getVolunteerHoursForAdmin', { lineId: adminUserProfile.userId });
        renderVolunteerHoursManagement(hours.data || []);
      } catch (err) {
        showAdminNotification('載入志工資料失敗', 'error');
      }
    }

    function renderVolunteerApplications(applications) {
      const container = document.getElementById('volunteerApplications');
      if (!applications.length) {
        container.innerHTML = `
          <div class="admin-empty-state">
            <i class="bi bi-check-circle"></i>
            <h5>沒有待審核申請</h5>
            <p>所有志工申請都已處理完成</p>
          </div>`;
        return;
      }
      
      container.innerHTML = applications.map(app => `
        <div class="admin-item">
          <div class="admin-item-title">${app.volunteerNeedTitle}</div>
          <div class="admin-item-meta">
            <span><i class="bi bi-person"></i> ${app.memberName}</span>
            <span><i class="bi bi-calendar"></i> ${formatDateTime(app.applicationDate)}</span>
            <span><i class="bi bi-award"></i> ${app.hours} 小時</span>
          </div>
          <div class="admin-item-actions">
            <button class="admin-btn admin-btn-success admin-btn-sm" onclick="approveVolunteerApplication('${app.id}')">
              <i class="bi bi-check"></i> 核准
            </button>
            <button class="admin-btn admin-btn-secondary admin-btn-sm" onclick="rejectVolunteerApplication('${app.id}')">
              <i class="bi bi-x"></i> 拒絕
            </button>
          </div>
        </div>
      `).join('');
    }

    function renderVolunteerHoursManagement(records) {
      const container = document.getElementById('volunteerHoursManagement');
      if (!records.length) {
        container.innerHTML = `
          <div class="admin-empty-state">
            <i class="bi bi-award"></i>
            <h5>暫無服務記錄</h5>
            <p>志工完成服務後會顯示在這裡</p>
          </div>`;
        return;
      }
      
      container.innerHTML = records.map(record => `
        <div class="admin-item">
          <div class="admin-item-title">${record.volunteerNeedTitle}</div>
          <div class="admin-item-meta">
            <span><i class="bi bi-person"></i> ${record.memberName}</span>
            <span><i class="bi bi-calendar"></i> ${formatDate(record.serviceDate)}</span>
            <span><i class="bi bi-award"></i> ${record.hours} 小時</span>
          </div>
          <div style="display: flex; justify-content: between; align-items: center; margin-top: 10px;">
            <span class="admin-status-badge admin-status-${record.status}">${record.status}</span>
            ${record.status === '待確認' ? `
              <div class="admin-item-actions">
                <button class="admin-btn admin-btn-success admin-btn-sm" onclick="confirmVolunteerHours('${record.id}')">
                  <i class="bi bi-check"></i> 確認
                </button>
              </div>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    function showCreateVolunteerNeedModal() {
      const html = `
        <div class="modal fade" id="createVolunteerNeedModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="admin-modal-content" id="createVolunteerNeedForm">
              <div class="admin-modal-header">
                <h5 class="admin-modal-title"><i class="bi bi-plus-circle me-2"></i>發布志工需求</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="admin-modal-body">
                <div class="admin-form-group">
                  <label class="admin-form-label">需求標題 *</label>
                  <input type="text" class="admin-form-control" name="title" required>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">服務日期 *</label>
                  <input type="date" class="admin-form-control" name="date" required>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">服務時間</label>
                  <input type="text" class="admin-form-control" name="time" placeholder="例：09:00-17:00">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">需求描述</label>
                  <textarea class="admin-form-control" name="description"></textarea>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">需要人數 *</label>
                  <input type="number" class="admin-form-control" name="needCount" min="1" required>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">服務時數 *</label>
                  <input type="number" class="admin-form-control" name="hours" min="1" required>
                </div>
              </div>
              <div class="admin-modal-footer">
                <button class="admin-btn admin-btn-secondary" type="button" data-bs-dismiss="modal">取消</button>
                <button class="admin-btn admin-btn-success" type="submit">
                  <i class="bi bi-check"></i> 發布需求
                </button>
              </div>
            </form>
          </div>
        </div>`;
      
      document.getElementById('adminModalContainer').innerHTML = html;
      const modal = new bootstrap.Modal(document.getElementById('createVolunteerNeedModal'));
      modal.show();
      
      document.getElementById('createVolunteerNeedForm').addEventListener('submit', handleCreateVolunteerNeed);
    }

    async function handleCreateVolunteerNeed(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setAdminButtonLoading(btn, true);
      
      try {
        await callAdminAPI('createVolunteerNeed', {
          lineId: adminUserProfile.userId,
          title: fd.get('title'),
          date: fd.get('date'),
          time: fd.get('time'),
          description: fd.get('description'),
          needCount: parseInt(fd.get('needCount')),
          hours: parseInt(fd.get('hours'))
        });
        showAdminNotification('志工需求發布成功！', 'success');
        bootstrap.Modal.getInstance(document.getElementById('createVolunteerNeedModal')).hide();
        await loadVolunteersManagement();
      } catch (err) {
        showAdminNotification('發布失敗：' + err.message, 'error');
      } finally { 
        setAdminButtonLoading(btn, false); 
      }
    }

    // ========== 財務管理 ==========
    async function loadFinanceManagement() {
      try {
        const r = await callAdminAPI('getFinanceDataForAdmin', { lineId: adminUserProfile.userId });
        const data = r.data || {};
        
        // 更新財務統計
        document.getElementById('monthlyDonations').textContent = formatCurrency(data.monthlyDonations || 0).replace('NT$', '$');
        document.getElementById('monthlyExpenses').textContent = formatCurrency(data.monthlyExpenses || 0).replace('NT$', '$');
        document.getElementById('pendingExpenseApprovals').textContent = data.pendingExpenseApprovals || 0;
        document.getElementById('accountBalance').textContent = formatCurrency(data.accountBalance || 0).replace('NT$', '$');
        
        renderExpenseApprovals(data.expenseApprovals || []);
      } catch (err) {
        showAdminNotification('載入財務資料失敗', 'error');
      }
    }

    function renderExpenseApprovals(expenses) {
      const container = document.getElementById('expenseApprovals');
      if (!expenses.length) {
        container.innerHTML = `
          <div class="admin-empty-state">
            <i class="bi bi-check-circle"></i>
            <h5>沒有待審核支出</h5>
            <p>所有支出申請都已處理完成</p>
          </div>`;
        return;
      }
      
      container.innerHTML = expenses.map(expense => `
        <div class="admin-item">
          <div class="admin-item-title">${expense.category} - ${expense.memberName}</div>
          <div class="admin-item-meta">
            <span><i class="bi bi-calendar"></i> ${formatDateTime(expense.applicationDate)}</span>
            <span><i class="bi bi-cash"></i> ${formatCurrency(expense.amount)}</span>
          </div>
          <div class="admin-item-description">${expense.description}</div>
          <div class="admin-item-actions">
            <button class="admin-btn admin-btn-success admin-btn-sm" onclick="approveExpense('${expense.id}')">
              <i class="bi bi-check"></i> 核准
            </button>
            <button class="admin-btn admin-btn-secondary admin-btn-sm" onclick="rejectExpense('${expense.id}')">
              <i class="bi bi-x"></i> 拒絕
            </button>
          </div>
        </div>
      `).join('');
    }

    async function approveExpense(expenseId) {
      if (!confirm('確定要核准這筆支出申請嗎？')) return;
      
      try {
        await callAdminAPI('approveExpense', { 
          lineId: adminUserProfile.userId, 
          expenseId 
        });
        showAdminNotification('支出申請已核准', 'success');
        await loadFinanceManagement();
        await loadAdminDashboard();
      } catch (err) {
        showAdminNotification('核准失敗：' + err.message, 'error');
      }
    }

    async function rejectExpense(expenseId) {
      if (!confirm('確定要拒絕這筆支出申請嗎？')) return;
      
      try {
        await callAdminAPI('rejectExpense', { 
          lineId: adminUserProfile.userId, 
          expenseId 
        });
        showAdminNotification('已拒絕支出申請', 'success');
        await loadFinanceManagement();
      } catch (err) {
        showAdminNotification('操作失敗：' + err.message, 'error');
      }
    }

    // ========== 系統設定 ==========
    async function loadSystemSettings() {
      try {
        const admins = await callAdminAPI('getAllAdmins', { lineId: adminUserProfile.userId });
        renderAdminsList(admins.data || []);
        
        const stats = await callAdminAPI('getSystemStats', { lineId: adminUserProfile.userId });
        renderSystemStats(stats.data || {});
      } catch (err) {
        showAdminNotification('載入系統設定失敗', 'error');
      }
    }

    function renderAdminsList(admins) {
      const container = document.getElementById('adminsList');
      if (!admins.length) {
        container.innerHTML = `
          <div class="admin-empty-state">
            <i class="bi bi-person-x"></i>
            <h5>暫無其他管理員</h5>
          </div>`;
        return;
      }
      
      container.innerHTML = admins.map(admin => `
        <div class="admin-item">
          <div class="admin-item-title">${admin.displayName || admin.lineId}</div>
          <div class="admin-item-meta">
            <span><i class="bi bi-calendar"></i> ${formatDate(admin.createdAt)}</span>
          </div>
          <div class="admin-item-actions">
            ${admin.lineId !== adminUserProfile.userId ? `
              <button class="admin-btn admin-btn-secondary admin-btn-sm" onclick="removeAdmin('${admin.lineId}')">
                <i class="bi bi-x"></i> 移除
              </button>
            ` : '<span class="admin-badge">目前使用者</span>'}
          </div>
        </div>
      `).join('');
    }

    function renderSystemStats(stats) {
      const container = document.getElementById('systemStats');
      container.innerHTML = `
        <div class="admin-stats-grid">
          <div class="admin-stat-card">
            <div class="admin-stat-number">${stats.totalActivities || 0}</div>
            <div class="admin-stat-label">總活動數</div>
          </div>
          <div class="admin-stat-card secondary">
            <div class="admin-stat-number">${stats.totalVolunteerHours || 0}</div>
            <div class="admin-stat-label">志工總時數</div>
          </div>
          <div class="admin-stat-card success">
            <div class="admin-stat-number">${stats.totalDonationCount || 0}</div>
            <div class="admin-stat-label">捐款筆數</div>
          </div>
          <div class="admin-stat-card info">
            <div class="admin-stat-number">${stats.avgActivityParticipation || 0}%</div>
            <div class="admin-stat-label">平均參與率</div>
          </div>
        </div>`;
    }

    async function addAdmin() {
      const lineId = document.getElementById('newAdminLineId').value.trim();
      if (!lineId) {
        showAdminNotification('請輸入 LINE ID', 'warning');
        return;
      }
      
      try {
        await callAdminAPI('addAdmin', { 
          lineId: adminUserProfile.userId, 
          newAdminLineId: lineId 
        });
        showAdminNotification('管理員新增成功', 'success');
        document.getElementById('newAdminLineId').value = '';
        await loadSystemSettings();
      } catch (err) {
        showAdminNotification('新增失敗：' + err.message, 'error');
      }
    }

    async function removeAdmin(targetLineId) {
      if (!confirm('確定要移除這位管理員嗎？')) return;
      
      try {
        await callAdminAPI('removeAdmin', { 
          lineId: adminUserProfile.userId, 
          targetLineId 
        });
        showAdminNotification('管理員已移除', 'success');
        await loadSystemSettings();
      } catch (err) {
        showAdminNotification('移除失敗：' + err.message, 'error');
      }
    }

    // ========== 系統通知 ==========
    function showSystemNotificationModal() {
      const html = `
        <div class="modal fade" id="systemNotificationModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="admin-modal-content" id="systemNotificationForm">
              <div class="admin-modal-header">
                <h5 class="admin-modal-title"><i class="bi bi-megaphone me-2"></i>發送系統通知</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="admin-modal-body">
                <div class="admin-form-group">
                  <label class="admin-form-label">通知標題 *</label>
                  <input type="text" class="admin-form-control" name="title" required>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">通知內容 *</label>
                  <textarea class="admin-form-control" name="message" required rows="4"></textarea>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">發送對象</label>
                  <select class="admin-form-select" name="target">
                    <option value="all">所有會員</option>
                    <option value="active">活躍會員</option>
                    <option value="volunteers">志工會員</option>
                  </select>
                </div>
              </div>
              <div class="admin-modal-footer">
                <button class="admin-btn admin-btn-secondary" type="button" data-bs-dismiss="modal">取消</button>
                <button class="admin-btn admin-btn-primary" type="submit">
                  <i class="bi bi-send"></i> 發送通知
                </button>
              </div>
            </form>
          </div>
        </div>`;
      
      document.getElementById('adminModalContainer').innerHTML = html;
      const modal = new bootstrap.Modal(document.getElementById('systemNotificationModal'));
      modal.show();
      
      document.getElementById('systemNotificationForm').addEventListener('submit', handleSystemNotification);
    }

    async function handleSystemNotification(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setAdminButtonLoading(btn, true);
      
      try {
        await callAdminAPI('sendSystemNotification', {
          lineId: adminUserProfile.userId,
          title: fd.get('title'),
          message: fd.get('message'),
          target: fd.get('target')
        });
        showAdminNotification('系統通知發送成功！', 'success');
        bootstrap.Modal.getInstance(document.getElementById('systemNotificationModal')).hide();
      } catch (err) {
        showAdminNotification('發送失敗：' + err.message, 'error');
      } finally { 
        setAdminButtonLoading(btn, false); 
      }
    }

    // ========== 資料匯出 ==========
    async function exportAllData() {
      try {
        showAdminNotification('正在匯出資料...', 'info');
        const r = await callAdminAPI('exportAllData', { lineId: adminUserProfile.userId });
        
        // 建立下載連結
        const blob = new Blob([JSON.stringify(r.data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `帕金森病友會資料_${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showAdminNotification('資料匯出完成', 'success');
      } catch (err) {
        showAdminNotification('匯出失敗：' + err.message, 'error');
      }
    }

    async function exportMembers() {
      try {
        const r = await callAdminAPI('exportMembers', { lineId: adminUserProfile.userId });
        const csv = convertToCSV(r.data);
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `會員資料_${new Date().toISOString().slice(0, 10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        showAdminNotification('會員資料匯出完成', 'success');
      } catch (err) {
        showAdminNotification('匯出失敗：' + err.message, 'error');
      }
    }

    function convertToCSV(data) {
      if (!data.length) return '';
      const headers = Object.keys(data[0]);
      const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
      ].join('\n');
      return '\ufeff' + csvContent; // BOM for UTF-8
    }

    // ========== 資料備份與還原 ==========
    async function backupData() {
      if (!confirm('確定要備份所有資料嗎？')) return;
      
      try {
        showAdminNotification('正在備份資料...', 'info');
        await callAdminAPI('backupData', { lineId: adminUserProfile.userId });
        showAdminNotification('資料備份完成', 'success');
      } catch (err) {
        showAdminNotification('備份失敗：' + err.message, 'error');
      }
    }

    function showRestoreModal() {
      const html = `
        <div class="modal fade" id="restoreModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="admin-modal-content">
              <div class="admin-modal-header">
                <h5 class="admin-modal-title"><i class="bi bi-exclamation-triangle me-2"></i>資料還原</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="admin-modal-body">
                <div class="alert alert-warning">
                  <i class="bi bi-exclamation-triangle"></i>
                  <strong>警告：</strong>此操作將覆蓋現有資料，請謹慎操作！
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">選擇備份檔案</label>
                  <input type="file" class="admin-form-control" id="restoreFile" accept=".json">
                </div>
              </div>
              <div class="admin-modal-footer">
                <button class="admin-btn admin-btn-secondary" type="button" data-bs-dismiss="modal">取消</button>
                <button class="admin-btn admin-btn-warning" onclick="handleRestore()">
                  <i class="bi bi-upload"></i> 確認還原
                </button>
              </div>
            </div>
          </div>
        </div>`;
      
      document.getElementById('adminModalContainer').innerHTML = html;
      const modal = new bootstrap.Modal(document.getElementById('restoreModal'));
      modal.show();
    }

    async function handleRestore() {
      const fileInput = document.getElementById('restoreFile');
      if (!fileInput.files[0]) {
        showAdminNotification('請選擇備份檔案', 'warning');
        return;
      }
      
      if (!confirm('確定要還原資料嗎？此操作無法復原！')) return;
      
      try {
        const file = fileInput.files[0];
        const text = await file.text();
        const data = JSON.parse(text);
        
        await callAdminAPI('restoreData', { 
          lineId: adminUserProfile.userId, 
          backupData: data 
        });
        
        showAdminNotification('資料還原完成', 'success');
        bootstrap.Modal.getInstance(document.getElementById('restoreModal')).hide();
        await refreshAdminData();
      } catch (err) {
        showAdminNotification('還原失敗：' + err.message, 'error');
      }
    }

    // ========== 報表生成 ==========
    async function generateMonthlyReport() {
      try {
        showAdminNotification('正在生成月報表...', 'info');
        const r = await callAdminAPI('generateMonthlyReport', { lineId: adminUserProfile.userId });
        
        const blob = new Blob([r.data.content], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `月報表_${new Date().toISOString().slice(0, 7)}.html`;
        a.click();
        URL.revokeObjectURL(url);
        
        showAdminNotification('月報表生成完成', 'success');
      } catch (err) {
        showAdminNotification('生成失敗：' + err.message, 'error');
      }
    }

    async function generateYearlyReport() {
      try {
        showAdminNotification('正在生成年報表...', 'info');
        const r = await callAdminAPI('generateYearlyReport', { lineId: adminUserProfile.userId });
        
        const blob = new Blob([r.data.content], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `年報表_${new Date().getFullYear()}.html`;
        a.click();
        URL.revokeObjectURL(url);
        
        showAdminNotification('年報表生成完成', 'success');
      } catch (err) {
        showAdminNotification('生成失敗：' + err.message, 'error');
      }
    }

    // ========== 全域函數 ==========
    window.switchAdminTab = switchAdminTab;
    window.refreshAdminData = refreshAdminData;
    window.approveMember = approveMember;
    window.rejectMember = rejectMember;
    window.showCreateActivityModal = showCreateActivityModal;
    window.showCreateVolunteerNeedModal = showCreateVolunteerNeedModal;
    window.approveExpense = approveExpense;
    window.rejectExpense = rejectExpense;
    window.addAdmin = addAdmin;
    window.removeAdmin = removeAdmin;
    window.showSystemNotificationModal = showSystemNotificationModal;
    window.exportAllData = exportAllData;
    window.exportMembers = exportMembers;
    window.backupData = backupData;
    window.showRestoreModal = showRestoreModal;
    window.handleRestore = handleRestore;
    window.generateMonthlyReport = generateMonthlyReport;
    window.generateYearlyReport = generateYearlyReport;

    // ========== 初始化 ==========
    window.addEventListener('load', initializeAdminLiff);

    // ========== 防止意外操作 ==========
    window.addEventListener('beforeunload', function(e) {
      e.preventDefault();
      e.returnValue = '確定要離開管理員系統嗎？';
    });
  </script>
</body>
</html>
