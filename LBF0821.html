<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>收據開立表單</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  :root {
    --primary-color: #b40000;
    --secondary-color: #666;
    --success-color: #4CAF50;
    --warning-color: #FF9800;
    --error-color: #f44336;
    --light-bg: #f8f9fa;
    --border-color: #ddd;
    --shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px 10px;
  }

  .container {
    max-width: 600px;
    margin: 0 auto;
    background: white;
    border-radius: 16px;
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #8b0000 100%);
    color: white;
    padding: 24px 20px;
    text-align: center;
    position: relative;
  }

  .header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="60" r="1.5" fill="rgba(255,255,255,0.1)"/></svg>');
  }

  .header-content {
    position: relative;
    z-index: 1;
  }

  .header h1 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 8px;
    letter-spacing: 1px;
  }

  .header p {
    font-size: 14px;
    opacity: 0.9;
  }

  .form-container {
    padding: 30px 20px;
  }

  .form-section {
    margin-bottom: 32px;
    background: var(--light-bg);
    border-radius: 12px;
    padding: 20px;
    border-left: 4px solid var(--primary-color);
  }

  .section-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  @media (max-width: 480px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }

  label {
    display: block;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    font-size: 14px;
  }

  .required {
    color: var(--error-color);
  }

  input, select, textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.3s ease;
    background: white;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(180, 0, 0, 0.1);
  }

  textarea {
    resize: vertical;
    min-height: 80px;
  }

  .amount-input {
    position: relative;
  }

  .amount-input::before {
    content: 'NT$';
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--secondary-color);
    font-weight: 600;
    z-index: 1;
  }

  .amount-input input {
    padding-left: 50px;
    font-weight: 600;
    color: var(--primary-color);
  }

  .color-picker-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 12px;
    margin-top: 8px;
  }

  .color-option {
    position: relative;
    cursor: pointer;
  }

  .color-option input[type="radio"] {
    display: none;
  }

  .color-swatch {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 3px solid transparent;
    transition: all 0.3s ease;
    position: relative;
    margin: 0 auto 8px;
  }

  .color-option input[type="radio"]:checked + .color-swatch {
    border-color: #333;
    transform: scale(1.1);
  }

  .color-label {
    text-align: center;
    font-size: 12px;
    color: var(--secondary-color);
  }

  .preview-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: 20px;
    margin: 24px 0;
    border: 2px dashed var(--border-color);
  }

  .preview-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 12px;
    text-align: center;
  }

  .preview-content {
    text-align: center;
    color: var(--secondary-color);
    font-size: 14px;
  }

  .button-group {
    display: flex;
    gap: 12px;
    margin-top: 32px;
  }

  .btn {
    flex: 1;
    padding: 16px 24px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    transition: all 0.5s ease;
    transform: translate(-50%, -50%);
  }

  .btn:active::before {
    width: 300px;
    height: 300px;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, #8b0000 100%);
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(180, 0, 0, 0.3);
  }

  .btn-secondary {
    background: white;
    color: var(--secondary-color);
    border: 2px solid var(--border-color);
  }

  .btn-secondary:hover {
    background: var(--light-bg);
    border-color: var(--secondary-color);
  }

  .loading {
    display: none;
    text-align: center;
    padding: 20px;
  }

  .loading.show {
    display: block;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--border-color);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .alert {
    padding: 16px 20px;
    border-radius: 8px;
    margin: 16px 0;
    font-weight: 500;
    display: none;
  }

  .alert.show {
    display: block;
  }

  .alert-success {
    background: rgba(76, 175, 80, 0.1);
    color: var(--success-color);
    border: 1px solid rgba(76, 175, 80, 0.3);
  }

  .alert-error {
    background: rgba(244, 67, 54, 0.1);
    color: var(--error-color);
    border: 1px solid rgba(244, 67, 54, 0.3);
  }

  .step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 32px;
  }

  .step {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--border-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    position: relative;
    margin: 0 8px;
  }

  .step.active {
    background: var(--primary-color);
  }

  .step.completed {
    background: var(--success-color);
  }

  .step::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 100%;
    width: 16px;
    height: 2px;
    background: var(--border-color);
    transform: translateY(-50%);
  }

  .step:last-child::after {
    display: none;
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="header-content">
      <h1>📋 收據開立表單</h1>
      <p>請填寫以下資訊以生成專業二聯式收據</p>
    </div>
  </div>

  <div class="form-container">
    <div class="step-indicator">
      <div class="step active">1</div>
      <div class="step">2</div>
      <div class="step">3</div>
    </div>

    <form id="receiptForm">
      <!-- 基本資訊 -->
      <div class="form-section">
        <div class="section-title">
          <span>👤</span>
          付款人資訊
        </div>
        
        <div class="form-group">
          <label>付款人姓名 <span class="required">*</span></label>
          <input type="text" id="payerName" name="payerName" required placeholder="請輸入付款人姓名">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>身分證字號</label>
            <input type="text" id="payerId" name="payerId" placeholder="A123456789">
          </div>
          <div class="form-group">
            <label>聯絡電話</label>
            <input type="tel" id="payerPhone" name="payerPhone" placeholder="0912-345-678">
          </div>
        </div>
      </div>

      <!-- 收款資訊 -->
      <div class="form-section">
        <div class="section-title">
          <span>💰</span>
          收款資訊
        </div>
        
        <div class="form-group">
          <label>收款項目 <span class="required">*</span></label>
          <select id="itemName" name="itemName" required>
            <option value="">請選擇收款項目</option>
            <option value="年度會費">年度會費</option>
            <option value="捐款">捐款</option>
            <option value="活動費用">活動費用</option>
            <option value="報名費">報名費</option>
            <option value="其他">其他</option>
          </select>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>收款金額 <span class="required">*</span></label>
            <div class="amount-input">
              <input type="number" id="amount" name="amount" required placeholder="50000" min="1">
            </div>
          </div>
          <div class="form-group">
            <label>收款日期 <span class="required">*</span></label>
            <input type="date" id="receiveDate" name="receiveDate" required>
          </div>
        </div>
      </div>

      <!-- 機構資訊 -->
      <div class="form-section">
        <div class="section-title">
          <span>🏢</span>
          機構資訊
        </div>
        
        <div class="form-group">
          <label>機構名稱 <span class="required">*</span></label>
          <input type="text" id="orgName" name="orgName" required placeholder="台灣公益協會" value="台灣公益協會">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>機構英文名稱</label>
            <input type="text" id="orgNameEn" name="orgNameEn" placeholder="Taiwan Charity Association" value="Taiwan Charity Association">
          </div>
          <div class="form-group">
            <label>統一編號</label>
            <input type="text" id="taxId" name="taxId" placeholder="12345678" value="12345678">
          </div>
        </div>
        
        <div class="form-group">
          <label>機構地址</label>
          <textarea id="orgAddress" name="orgAddress" placeholder="台北市中正區重慶南路一段122號">台北市中正區重慶南路一段122號</textarea>
        </div>
      </div>

      <!-- 印章設定 -->
      <div class="form-section">
        <div class="section-title">
          <span>🔖</span>
          印章設定
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>出納姓名</label>
            <input type="text" id="cashierName" name="cashierName" placeholder="李小華" value="李小華">
          </div>
          <div class="form-group">
            <label>會計姓名</label>
            <input type="text" id="accountantName" name="accountantName" placeholder="陳小美" value="陳小美">
          </div>
        </div>
        
        <div class="form-group">
          <label>理事長姓名</label>
          <input type="text" id="chairmanName" name="chairmanName" placeholder="張大同" value="張大同">
        </div>
        
        <div class="form-group">
          <label>印章顏色</label>
          <div class="color-picker-group">
            <div class="color-option">
              <input type="radio" id="color1" name="sealColor" value="#d32f2f" checked>
              <label for="color1">
                <div class="color-swatch" style="background: #d32f2f;"></div>
                <div class="color-label">傳統紅</div>
              </label>
            </div>
            <div class="color-option">
              <input type="radio" id="color2" name="sealColor" value="#b71c1c">
              <label for="color2">
                <div class="color-swatch" style="background: #b71c1c;"></div>
                <div class="color-label">深紅</div>
              </label>
            </div>
            <div class="color-option">
              <input type="radio" id="color3" name="sealColor" value="#c62828">
              <label for="color3">
                <div class="color-swatch" style="background: #c62828;"></div>
                <div class="color-label">朱紅</div>
              </label>
            </div>
            <div class="color-option">
              <input type="radio" id="color4" name="sealColor" value="#1976d2">
              <label for="color4">
                <div class="color-swatch" style="background: #1976d2;"></div>
                <div class="color-label">藍色</div>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- 預覽區域 -->
      <div class="preview-section">
        <div class="preview-title">📄 收據預覽</div>
        <div class="preview-content" id="previewContent">
          請填寫必要資訊後預覽收據
        </div>
      </div>

      <!-- 操作按鈕 -->
      <div class="button-group">
        <button type="button" class="btn btn-secondary" onclick="previewReceipt()">
          👁️ 預覽收據
        </button>
        <button type="submit" class="btn btn-primary">
          ✅ 生成收據
        </button>
      </div>
    </form>

    <!-- 載入中 -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>正在生成收據，請稍候...</p>
    </div>

    <!-- 提示訊息 -->
    <div class="alert alert-success" id="successAlert"></div>
    <div class="alert alert-error" id="errorAlert"></div>
  </div>
</div>

<script>
  let liffReady = false;

  // 初始化 LIFF
  document.addEventListener('DOMContentLoaded', function() {
    // 設定今日日期為預設值
    document.getElementById('receiveDate').value = new Date().toISOString().split('T')[0];
    
    // 初始化 LIFF
    liff.init({
      liffId: '1656516134-VaGgmaPm' // 請替換為實際的 LIFF ID
    }).then(() => {
      liffReady = true;
      console.log('LIFF initialized');
      
      // 獲取用戶資訊
      if (liff.isLoggedIn()) {
        liff.getProfile().then(profile => {
          console.log('User profile:', profile);
          // 可以使用用戶資訊預填表單
        });
      }
    }).catch(err => {
      console.error('LIFF initialization failed', err);
      showError('系統初始化失敗，請重新開啟');
    });

    // 綁定表單事件
    bindFormEvents();
  });

  // 綁定表單事件
  function bindFormEvents() {
    const form = document.getElementById('receiptForm');
    
    // 表單提交
    form.addEventListener('submit', handleFormSubmit);
    
    // 即時預覽
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      input.addEventListener('input', updatePreview);
    });
    
    // 金額格式化
    document.getElementById('amount').addEventListener('input', function(e) {
      const value = e.target.value.replace(/[^\d]/g, '');
      if (value) {
        const formatted = parseInt(value).toLocaleString('zh-TW');
        updatePreview();
      }
    });
  }

  // 處理表單提交
  async function handleFormSubmit(e) {
    e.preventDefault();
    
    if (!validateForm()) {
      return;
    }
    
    showLoading(true);
    
    try {
      const formData = getFormData();
      
      // 生成收據編號
      formData.receiptNo = generateReceiptNumber();
      
      // 獲取用戶 ID
      if (liffReady && liff.isLoggedIn()) {
        const profile = await liff.getProfile();
        formData.userId = profile.userId;
      }
      
      // 發送到 GAS
      const response = await fetch(getGASUrl(), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: 'saveReceipt',
          data: formData
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        showSuccess('收據生成成功！');
        
        // 更新步驟指示器
        updateStepIndicator(3);
        
        // 顯示成功頁面
        setTimeout(() => {
          showReceiptSuccess(result.id);
        }, 1500);
        
      } else {
        throw new Error(result.error || '生成失敗');
      }
      
    } catch (error) {
      console.error('Error:', error);
      showError('生成收據時發生錯誤：' + error.message);
    } finally {
      showLoading(false);
    }
  }

  // 獲取表單資料
  function getFormData() {
    const form = document.getElementById('receiptForm');
    const formData = new FormData(form);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
      data[key] = value;
    }
    
    return data;
  }

  // 驗證表單
  function validateForm() {
    const requiredFields = ['payerName', 'itemName', 'amount', 'receiveDate', 'orgName'];
    let isValid = true;
    
    requiredFields.forEach(field => {
      const input = document.getElementById(field);
      if (!input.value.trim()) {
        input.style.borderColor = '#f44336';
        isValid = false;
      } else {
        input.style.borderColor = '#ddd';
      }
    });
    
    if (!isValid) {
      showError('請填寫所有必填欄位');
    }
    
    return isValid;
  }

  // 更新預覽
  function updatePreview() {
    const data = getFormData();
    const preview = document.getElementById('previewContent');
    
    if (data.payerName && data.amount && data.itemName) {
      const amount = parseInt(data.amount || 0);
      preview.innerHTML = `
        <div style="text-align: left; padding: 16px; background: white; border-radius: 8px; border: 1px solid #ddd;">
          <strong>付款人：</strong>${data.payerName}<br>
          <strong>收款項目：</strong>${data.itemName}<br>
          <strong>收款金額：</strong>NT$ ${amount.toLocaleString('zh-TW')}<br>
          <strong>收款日期：</strong>${data.receiveDate}<br>
          <strong>機構名稱：</strong>${data.orgName}
        </div>
      `;
      updateStepIndicator(2);
    } else {
      preview.innerHTML = '請填寫必要資訊後預覽收據';
      updateStepIndicator(1);
    }
  }

  // 預覽收據
  function previewReceipt() {
    if (!validateForm()) {
      return;
    }
    
    const data = getFormData();
    data.receiptNo = generateReceiptNumber();
    
    // 開啟預覽視窗
    const previewUrl = `${getGASUrl()}?action=preview&data=${encodeURIComponent(JSON.stringify(data))}`;
    window.open(previewUrl, '_blank', 'width=800,height=600');
  }

  // 更新步驟指示器
  function updateStepIndicator(step) {
    const steps = document.querySelectorAll('.step');
    steps.forEach((stepEl, index) => {
      stepEl.classList.remove('active', 'completed');
      if (index + 1 < step) {
        stepEl.classList.add('completed');
      } else if (index + 1 === step) {
        stepEl.classList.add('active');
      }
    });
  }

  // 顯示成功頁面
  function showReceiptSuccess(receiptId) {
    const container = document.querySelector('.form-container');
    container.innerHTML = `
      <div style="text-align: center; padding: 40px 20px;">
        <div style="font-size: 60px; margin-bottom: 20px;">✅</div>
        <h2 style="color: var(--success-color); margin-bottom: 16px;">收據生成成功！</h2>
        <p style="color: var(--secondary-color); margin-bottom: 32px;">您的收據已成功生成並儲存</p>
        
        <div class="button-group">
          <button class="btn btn-secondary" onclick="viewReceipt('${receiptId}')">
            👁️ 查看收據
          </button>
          <button class="btn btn-primary" onclick="downloadReceipt('${receiptId}')">
            📥 下載收據
          </button>
        </div>
        
        <div style="margin-top: 24px;">
          <button class="btn btn-secondary" onclick="location.reload()">
            ➕ 再開一張
          </button>
        </div>
      </div>
    `;
  }

  // 查看收據
  function viewReceipt(receiptId) {
    const url = `${getGASUrl()}?action=view&id=${receiptId}`;
    window.open(url, '_blank');
  }

  // 下載收據
  function downloadReceipt(receiptId) {
    const url = `${getGASUrl()}?action=download&id=${receiptId}`;
    window.open(url, '_blank');
  }

  // 工具函數
  function showLoading(show) {
    document.getElementById('loading').classList.toggle('show', show);
  }

  function showSuccess(message) {
    const alert = document.getElementById('successAlert');
    alert.textContent = message;
    alert.classList.add('show');
    setTimeout(() => alert.classList.remove('show'), 3000);
  }

  function showError(message) {
    const alert = document.getElementById('errorAlert');
    alert.textContent = message;
    alert.classList.add('show');
    setTimeout(() => alert.classList.remove('show'), 5000);
  }

  function generateReceiptNumber() {
    const now = new Date();
    return now.getFullYear() + 
           String(now.getMonth() + 1).padStart(2, '0') + 
           String(now.getDate()).padStart(2, '0') + 
           String(now.getHours()).padStart(2, '0') + 
           String(now.getMinutes()).padStart(2, '0') + 
           String(now.getSeconds()).padStart(2, '0');
  }

  function getGASUrl() {
    return 'https://script.google.com/macros/s/AKfycbx_AbUMy7NOAILgOanEZH-HnzEfHqft1sgtIBU5B2tzswDw5Zz8_UaLxgCwRRoM9JvV/exec'; // 請替換為實際的 GAS URL
  }
</script>
</body>
</html>
    
