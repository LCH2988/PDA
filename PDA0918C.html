<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¥</text></svg>">
  <style>
      /* åŸºç¤æ¨£å¼é‡ç½® */
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      
      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          color: #333;
          line-height: 1.6;
      }
      
      .container {
          max-width: 420px;
          margin: 0 auto;
          padding: 15px;
          min-height: 100vh;
      }
      
      /* å¡ç‰‡æ¨£å¼ */
      .card {
          background: white;
          border-radius: 16px;
          padding: 24px;
          margin-bottom: 16px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.12);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255,255,255,0.2);
      }
      
      /* æ¨™é¡Œå€åŸŸ */
      .header {
          text-align: center;
          margin-bottom: 24px;
      }
      
      .header h1 {
          color: #2d3748;
          font-size: 28px;
          font-weight: 700;
          margin-bottom: 8px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
      }
      
      .header p {
          color: #718096;
          font-size: 14px;
      }
      
      /* è¼‰å…¥å‹•ç•« */
      .loading {
          text-align: center;
          padding: 60px 20px;
      }
      
      .spinner {
          border: 3px solid #f3f4f6;
          border-top: 3px solid #667eea;
          border-radius: 50%;
          width: 48px;
          height: 48px;
          animation: spin 1s linear infinite;
          margin: 0 auto 24px;
      }
      
      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }
      
      .loading-text {
          color: #4a5568;
          font-size: 16px;
          margin-bottom: 12px;
      }
      
      .loading-subtext {
          color: #718096;
          font-size: 14px;
      }
      
      /* å·¥å…·é¡åˆ¥ */
      .hidden {
          display: none !important;
      }
      
      .text-center {
          text-align: center;
      }
      
      .mb-4 {
          margin-bottom: 16px;
      }
      
      /* ç”¨æˆ¶è³‡è¨Šå€åŸŸ */
      .user-info {
          display: flex;
          align-items: center;
          padding: 16px;
          background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
          border-radius: 12px;
          margin-bottom: 24px;
          border: 1px solid #e2e8f0;
      }
      
      .avatar {
          width: 56px;
          height: 56px;
          border-radius: 50%;
          margin-right: 16px;
          border: 3px solid #667eea;
          object-fit: cover;
      }
      
      .user-details h3 {
          font-size: 18px;
          font-weight: 600;
          color: #2d3748;
          margin-bottom: 4px;
      }
      
      .user-details p {
          font-size: 14px;
          color: #718096;
      }
      
      .user-status {
          margin-left: auto;
          padding: 4px 12px;
          background: #667eea;
          color: white;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 500;
      }
      
      /* é¸å–®ç¶²æ ¼ */
      .menu-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 16px;
          margin-bottom: 24px;
      }
      
      .menu-item {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 16px;
          padding: 24px 16px;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
          position: relative;
          overflow: hidden;
      }
      
      .menu-item:hover {
          transform: translateY(-4px);
          box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
      }
      
      .menu-item:active {
          transform: translateY(-2px);
      }
      
      .menu-item::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
          transition: left 0.5s;
      }
      
      .menu-item:hover::before {
          left: 100%;
      }
      
      .menu-icon {
          font-size: 28px;
          margin-bottom: 8px;
          display: block;
      }
      
      .menu-text {
          font-size: 14px;
          font-weight: 600;
          letter-spacing: 0.5px;
      }
      
      /* ç®¡ç†å“¡é¸å–® */
      .admin-section {
          margin-top: 24px;
          padding-top: 24px;
          border-top: 2px solid #e2e8f0;
      }
      
      .admin-title {
          display: flex;
          align-items: center;
          margin-bottom: 16px;
          color: #e53e3e;
          font-weight: 600;
      }
      
      .admin-title::before {
          content: 'ğŸ”';
          margin-right: 8px;
          font-size: 18px;
      }
      
      .admin-menu .menu-item {
          background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
          box-shadow: 0 4px 16px rgba(229, 62, 62, 0.3);
      }
      
      .admin-menu .menu-item:hover {
          box-shadow: 0 8px 24px rgba(229, 62, 62, 0.4);
      }
      
      /* è­¦å‘Šè¨Šæ¯ */
      .alert {
          padding: 16px;
          border-radius: 12px;
          margin-bottom: 16px;
          font-size: 14px;
          font-weight: 500;
          position: relative;
          animation: slideIn 0.3s ease-out;
      }
      
      @keyframes slideIn {
          from {
              opacity: 0;
              transform: translateY(-10px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }
      
      .alert-success {
          background: #f0fff4;
          color: #22543d;
          border: 1px solid #9ae6b4;
      }
      
      .alert-error {
          background: #fed7d7;
          color: #742a2a;
          border: 1px solid #feb2b2;
      }
      
      .alert-warning {
          background: #fefcbf;
          color: #744210;
          border: 1px solid #f6e05e;
      }
      
      .alert-info {
          background: #ebf8ff;
          color: #2a4365;
          border: 1px solid #90cdf4;
      }
      
      /* éŒ¯èª¤é é¢ */
      .error-page {
          text-align: center;
          padding: 40px 20px;
      }
      
      .error-icon {
          font-size: 64px;
          margin-bottom: 16px;
      }
      
      .error-title {
          font-size: 24px;
          font-weight: 700;
          color: #e53e3e;
          margin-bottom: 8px;
      }
      
      .error-message {
          color: #718096;
          margin-bottom: 24px;
          line-height: 1.6;
      }
      
      .retry-btn {
          background: #667eea;
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: background 0.3s ease;
      }
      
      .retry-btn:hover {
          background: #5a67d8;
      }
      
      /* ç‰ˆæœ¬è³‡è¨Š */
      .version-info {
          text-align: center;
          margin-top: 24px;
          padding: 16px;
          background: rgba(255,255,255,0.1);
          border-radius: 8px;
          color: rgba(255,255,255,0.8);
          font-size: 12px;
      }
      
      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 480px) {
          .container {
              padding: 10px;
          }
          
          .card {
              padding: 20px;
              margin-bottom: 12px;
          }
          
          .menu-grid {
              gap: 12px;
          }
          
          .menu-item {
              padding: 20px 12px;
          }
          
          .header h1 {
              font-size: 24px;
          }
      }
      
      /* æ·±è‰²æ¨¡å¼æ”¯æ´ */
      @media (prefers-color-scheme: dark) {
          .card {
              background: rgba(45, 55, 72, 0.9);
              color: #f7fafc;
              border: 1px solid rgba(255,255,255,0.1);
          }
          
          .user-info {
              background: rgba(74, 85, 104, 0.3);
              border: 1px solid rgba(255,255,255,0.1);
          }
          
          .user-details h3 {
              color: #f7fafc;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <!-- è¼‰å…¥ç•«é¢ -->
      <div id="loading" class="loading">
          <div class="card">
              <div class="spinner"></div>
              <div class="loading-text">æ­£åœ¨è¼‰å…¥ç³»çµ±...</div>
              <div class="loading-subtext">è«‹ç¨å€™ï¼Œæ­£åœ¨åˆå§‹åŒ– LINE LIFF</div>
          </div>
      </div>
      
      <!-- éŒ¯èª¤é é¢ -->
      <div id="errorPage" class="hidden">
          <div class="card">
              <div class="error-page">
                  <div class="error-icon">âš ï¸</div>
                  <div class="error-title">è¼‰å…¥å¤±æ•—</div>
                  <div id="errorMessage" class="error-message">ç³»çµ±åˆå§‹åŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤</div>
                  <button class="retry-btn" onclick="retryInitialization()">é‡æ–°è¼‰å…¥</button>
              </div>
          </div>
      </div>
      
      <!-- ä¸»é¸å–® -->
      <div id="mainMenu" class="hidden">
          <div class="card">
              <div class="header">
                  <h1>å¸•é‡‘æ£®ç—…å‹æœƒ</h1>
                  <p>é—œæ‡·æœå‹™ç®¡ç†ç³»çµ±</p>
              </div>
              
              <!-- ç”¨æˆ¶è³‡è¨Š -->
              <div id="userInfo" class="user-info">
                  <img id="userAvatar" class="avatar" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23667eea'/><text x='50' y='60' text-anchor='middle' fill='white' font-size='30'>ğŸ‘¤</text></svg>" alt="ç”¨æˆ¶é ­åƒ">
                  <div class="user-details">
                      <h3 id="userName">è¼‰å…¥ä¸­...</h3>
                      <p id="userEmail">æº–å‚™ä¸­...</p>
                  </div>
                  <div id="userStatus" class="user-status">æœƒå“¡</div>
              </div>
              
              <!-- ä¸»è¦åŠŸèƒ½é¸å–® -->
              <div class="menu-grid">
                  <button id="activitiesBtn" class="menu-item">
                      <div class="menu-icon">ğŸ“…</div>
                      <div class="menu-text">æ´»å‹•å ±å</div>
                  </button>
                  <button id="profileBtn" class="menu-item">
                      <div class="menu-icon">ğŸ‘¤</div>
                      <div class="menu-text">å€‹äººè³‡æ–™</div>
                  </button>
                  <button id="donationsBtn" class="menu-item">
                      <div class="menu-icon">ğŸ’°</div>
                      <div class="menu-text">ææ¬¾è¨˜éŒ„</div>
                  </button>
                  <button id="volunteerBtn" class="menu-item">
                      <div class="menu-icon">ğŸ¤</div>
                      <div class="menu-text">å¿—å·¥æœå‹™</div>
                  </button>
              </div>
              
              <!-- ç®¡ç†å“¡åŠŸèƒ½é¸å–® -->
              <div id="adminMenu" class="hidden admin-section">
                  <div class="admin-title">ç®¡ç†åŠŸèƒ½</div>
                  <div class="menu-grid admin-menu">
                      <button id="dashboardBtn" class="menu-item">
                          <div class="menu-icon">ğŸ“Š</div>
                          <div class="menu-text">å¾Œå°ç®¡ç†</div>
                      </button>
                      <button id="membersBtn" class="menu-item">
                          <div class="menu-icon">ğŸ‘¥</div>
                          <div class="menu-text">æœƒå“¡ç®¡ç†</div>
                      </button>
                      <button id="reportsBtn" class="menu-item">
                          <div class="menu-icon">ğŸ“ˆ</div>
                          <div class="menu-text">çµ±è¨ˆå ±è¡¨</div>
                      </button>
                      <button id="settingsBtn" class="menu-item">
                          <div class="menu-icon">âš™ï¸</div>
                          <div class="menu-text">ç³»çµ±è¨­å®š</div>
                      </button>
                  </div>
              </div>
              
              <!-- ç‰ˆæœ¬è³‡è¨Š -->
              <div class="version-info">
                  <div>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ± v1.0.0</div>
                  <div>Powered by LINE LIFF & Google Apps Script</div>
              </div>
          </div>
      </div>
      
      <!-- è¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
      <div id="alertContainer"></div>
  </div>

  <script>
      // ç³»çµ±è¨­å®š - é€™äº›å€¼æœƒç”±å¾Œç«¯å‹•æ…‹æ›¿æ›
      const APP_CONFIG = {
          LIFF_ID: '<?= 1656516134-VaGgmaPm ?>',
          API_URL: '<?= https://script.google.com/macros/s/AKfycbx4Y5r024ZX5dhSb45msj6Bvo8Hix44ogGRNNaAqJKTTwd6UPvSv6y_uBlqZQCfvYF4/exec ?>',
          API_KEY: '<?= AAbb8520258185202581>',
          VERSION: '1.0.0',
          DEBUG: true
      };
      
      // å…¨åŸŸè®Šæ•¸
      let currentUser = null;
      let liffProfile = null;
      let isInitialized = false;
      let initializationAttempts = 0;
      const MAX_INIT_ATTEMPTS = 3;
      
      // æ—¥èªŒå·¥å…·
      const Logger = {
          log: (message, data = null) => {
              if (APP_CONFIG.DEBUG) {
                  console.log(`[LIFF] ${message}`, data || '');
              }
          },
          error: (message, error = null) => {
              console.error(`[LIFF ERROR] ${message}`, error || '');
          },
          warn: (message, data = null) => {
              console.warn(`[LIFF WARN] ${message}`, data || '');
          }
      };
      
      // DOM å·¥å…·å‡½å¼
      const DOM = {
          get: (id) => document.getElementById(id),
          show: (id) => {
              const element = DOM.get(id);
              if (element) element.classList.remove('hidden');
              return element;
          },
          hide: (id) => {
              const element = DOM.get(id);
              if (element) element.classList.add('hidden');
              return element;
          },
          hideAll: (ids) => ids.forEach(id => DOM.hide(id)),
          setText: (id, text) => {
              const element = DOM.get(id);
              if (element) element.textContent = text;
          },
          setHTML: (id, html) => {
              const element = DOM.get(id);
              if (element) element.innerHTML = html;
          }
      };
      
      // å®‰å…¨çš„äº‹ä»¶ç¶å®š
      function safeAddEventListener(elementId, event, callback, options = {}) {
          const element = DOM.get(elementId);
          if (element) {
              element.addEventListener(event, callback, options);
              Logger.log(`äº‹ä»¶ç¶å®šæˆåŠŸ: ${elementId} -> ${event}`);
              return true;
          } else {
              Logger.warn(`æ‰¾ä¸åˆ°å…ƒç´ ï¼Œç„¡æ³•ç¶å®šäº‹ä»¶: ${elementId}`);
              return false;
          }
      }
      
      // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
      function initializeEventListeners() {
          Logger.log('åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨...');
          
          const eventBindings = [
              ['activitiesBtn', 'click', () => navigateTo('activities')],
              ['profileBtn', 'click', () => navigateTo('profile')],
              ['donationsBtn', 'click', () => navigateTo('donations')],
              ['volunteerBtn', 'click', () => navigateTo('volunteer')],
              ['dashboardBtn', 'click', () => navigateTo('dashboard')],
              ['membersBtn', 'click', () => navigateTo('members')],
              ['reportsBtn', 'click', () => navigateTo('reports')],
              ['settingsBtn', 'click', () => navigateTo('settings')]
          ];
          
          let successCount = 0;
          eventBindings.forEach(([elementId, event, callback]) => {
              if (safeAddEventListener(elementId, event, callback)) {
                  successCount++;
              }
          });
          
          Logger.log(`äº‹ä»¶ç¶å®šå®Œæˆ: ${successCount}/${eventBindings.length}`);
          return successCount === eventBindings.length;
      }
      
      // LIFF åˆå§‹åŒ–
      async function initializeLiff() {
          if (isInitialized) {
              Logger.warn('LIFF å·²ç¶“åˆå§‹åŒ–éäº†');
              return true;
          }
          
          initializationAttempts++;
          Logger.log(`é–‹å§‹ LIFF åˆå§‹åŒ– (å˜—è©¦ ${initializationAttempts}/${MAX_INIT_ATTEMPTS})`);
          
          try {
              // æª¢æŸ¥ LIFF SDK
              if (typeof liff === 'undefined') {
                  throw new Error('LIFF SDK æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
              }
              
              // æª¢æŸ¥è¨­å®š
              if (!APP_CONFIG.LIFF_ID || APP_CONFIG.LIFF_ID.includes('<?=')) {
                  throw new Error('LIFF ID æœªæ­£ç¢ºè¨­å®šï¼Œè«‹è¯çµ¡ç³»çµ±ç®¡ç†å“¡');
              }
              
              Logger.log('åˆå§‹åŒ– LIFF SDK...', { liffId: APP_CONFIG.LIFF_ID });
              
              // åˆå§‹åŒ– LIFF
              await liff.init({ 
                  liffId: APP_CONFIG.LIFF_ID,
                  withLoginOnExternalBrowser: true
              });
              
              Logger.log('LIFF SDK åˆå§‹åŒ–æˆåŠŸ');
              
              // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
              if (!liff.isLoggedIn()) {
                  Logger.log('ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                  showAlert('è«‹å…ˆç™»å…¥ LINE å¸³è™Ÿ', 'info');
                  
                  setTimeout(() => {
                      liff.login({
                          redirectUri: window.location.href
                      });
                  }, 1500);
                  return false;
              }
              
              Logger.log('ç”¨æˆ¶å·²ç™»å…¥ï¼Œå–å¾—ç”¨æˆ¶è³‡æ–™...');
              
              // å–å¾—ç”¨æˆ¶è³‡æ–™
              liffProfile = await liff.getProfile();
              Logger.log('ç”¨æˆ¶è³‡æ–™å–å¾—æˆåŠŸ', {
                  userId: liffProfile.userId,
                  displayName: liffProfile.displayName
              });
              
              // è¨»å†Šæˆ–ç™»å…¥ç”¨æˆ¶
              await registerOrLoginUser();
              
              // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
              if (!initializeEventListeners()) {
                  throw new Error('äº‹ä»¶ç›£è½å™¨åˆå§‹åŒ–å¤±æ•—');
              }
              
              // é¡¯ç¤ºä¸»é¸å–®
              showMainMenu();
              
              isInitialized = true;
              Logger.log('LIFF åˆå§‹åŒ–å®Œæˆ');
              
              return true;
              
          } catch (error) {
              Logger.error('LIFF åˆå§‹åŒ–å¤±æ•—', error);
              
              if (initializationAttempts < MAX_INIT_ATTEMPTS) {
                  Logger.log(`å°‡åœ¨ 3 ç§’å¾Œé‡è©¦...`);
                  showAlert(`åˆå§‹åŒ–å¤±æ•—ï¼Œæ­£åœ¨é‡è©¦... (${initializationAttempts}/${MAX_INIT_ATTEMPTS})`, 'warning');
                  
                  setTimeout(() => {
                      initializeLiff();
                  }, 3000);
              } else {
                  showErrorPage(error.message);
              }
              
              return false;
          }
      }
      
      // API å‘¼å«
      async function callAPI(action, data = {}) {
          try {
              Logger.log(`API å‘¼å«: ${action}`, data);
              
              if (!APP_CONFIG.API_URL || APP_CONFIG.API_URL.includes('<?=')) {
                  throw new Error('API URL æœªæ­£ç¢ºè¨­å®š');
              }
              
              const requestData = {
                  action: action,
                  apiKey: APP_CONFIG.API_KEY,
                  timestamp: Date.now(),
                  ...data
              };
              
              const response = await fetch(APP_CONFIG.API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(requestData)
              });
              
              if (!response.ok) {
                  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              
              const result = await response.json();
              Logger.log(`API å›æ‡‰: ${action}`, result);
              
              if (!result.success) {
                  throw new Error(result.message || `${action} æ“ä½œå¤±æ•—`);
              }
              
              return result;
              
          } catch (error) {
              Logger.error(`API å‘¼å«å¤±æ•—: ${action}`, error);
              throw error;
          }
      }
      
      // ç”¨æˆ¶è¨»å†Šæˆ–ç™»å…¥
      async function registerOrLoginUser() {
          try {
              if (!liffProfile) {
                  throw new Error('æ‰¾ä¸åˆ° LIFF ç”¨æˆ¶è³‡æ–™');
              }
              
              Logger.log('è¨»å†Šæˆ–ç™»å…¥ç”¨æˆ¶...', {
                  lineId: liffProfile.userId,
                  displayName: liffProfile.displayName
              });
              
              const result = await callAPI('register', {
                  lineId: liffProfile.userId,
                  lineName: liffProfile.displayName,
                  realName: liffProfile.displayName,
                  pictureUrl: liffProfile.pictureUrl
              });
              
              currentUser = result.data;
              Logger.log('ç”¨æˆ¶è³‡æ–™è¨­å®šå®Œæˆ', currentUser);
              
              // æ›´æ–°ç”¨æˆ¶ä»‹é¢
              updateUserInterface();
              
              return currentUser;
              
          } catch (error) {
              Logger.error('ç”¨æˆ¶è¨»å†Šå¤±æ•—', error);
              throw new Error(`ç”¨æˆ¶è¨»å†Šå¤±æ•—: ${error.message}`);
          }
      }
      
      // æ›´æ–°ç”¨æˆ¶ä»‹é¢
      function updateUserInterface() {
          if (!currentUser) {
              Logger.warn('æ²’æœ‰ç”¨æˆ¶è³‡æ–™ï¼Œç„¡æ³•æ›´æ–°ä»‹é¢');
              return;
          }
          
          Logger.log('æ›´æ–°ç”¨æˆ¶ä»‹é¢...', currentUser);
          
          // æ›´æ–°ç”¨æˆ¶è³‡è¨Š
          DOM.setText('userName', currentUser.realName || currentUser.lineName || 'æœªçŸ¥ç”¨æˆ¶');
          DOM.setText('userEmail', currentUser.email || 'æœªè¨­å®š Email');
          DOM.setText('userStatus', getUserStatusText(currentUser));
          
          // æ›´æ–°é ­åƒ
          const avatarElement = DOM.get('userAvatar');
          if (avatarElement && liffProfile && liffProfile.pictureUrl) {
              avatarElement.src = liffProfile.pictureUrl;
              avatarElement.onerror = () => {
                  avatarElement.src = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23667eea'/><text x='50' y='60' text-anchor='middle' fill='white' font-size='30'>ğŸ‘¤</text></svg>";
              };
          }
          
          // é¡¯ç¤ºç®¡ç†å“¡é¸å–®
          if (isAdmin(currentUser)) {
              DOM.show('adminMenu');
              Logger.log('é¡¯ç¤ºç®¡ç†å“¡é¸å–®');
          }
          
          Logger.log('ç”¨æˆ¶ä»‹é¢æ›´æ–°å®Œæˆ');
      }
      
      // å–å¾—ç”¨æˆ¶ç‹€æ…‹æ–‡å­—
      function getUserStatusText(user) {
          if (isAdmin(user)) return 'ç®¡ç†å“¡';
          if (user.memberType) return user.memberType;
          if (user.role) return user.role;
          return 'ä¸€èˆ¬æœƒå“¡';
      }
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
      function isAdmin(user) {
          return user && (user.isAdmin || user.role === 'admin' || user.memberType === 'ç®¡ç†å“¡');
      }
      
      // é¡¯ç¤ºä¸»é¸å–®
      function showMainMenu() {
          Logger.log('é¡¯ç¤ºä¸»é¸å–®');
          DOM.hideAll(['loading', 'errorPage']);
          DOM.show('mainMenu');
      }
      
      // é¡¯ç¤ºéŒ¯èª¤é é¢
      function showErrorPage(message) {
          Logger.error('é¡¯ç¤ºéŒ¯èª¤é é¢', message);
          DOM.hideAll(['loading', 'mainMenu']);
          DOM.setText('errorMessage', message);
          DOM.show('errorPage');
      }
      
      // é‡è©¦åˆå§‹åŒ–
      function retryInitialization() {
          Logger.log('ç”¨æˆ¶æ‰‹å‹•é‡è©¦åˆå§‹åŒ–');
          initializationAttempts = 0;
          isInitialized = false;
          DOM.hideAll(['errorPage', 'mainMenu']);
          DOM.show('loading');
          
          setTimeout(() => {
              initializeLiff();
          }, 500);
      }
      
      // å°èˆªåŠŸèƒ½
      function navigateTo(page) {
          Logger.log(`å°èˆªåˆ°: ${page}`);
          
          const pageMessages = {
              activities: 'æ´»å‹•å ±ååŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼',
              profile: 'å€‹äººè³‡æ–™åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼',
              donations: 'ææ¬¾è¨˜éŒ„åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼',
              volunteer: 'å¿—å·¥æœå‹™åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼',
              dashboard: 'å¾Œå°ç®¡ç†åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼',
              members: 'æœƒå“¡ç®¡ç†åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼',
              reports: 'çµ±è¨ˆå ±è¡¨åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼',
              settings: 'ç³»çµ±è¨­å®šåŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼'
          };
          
          const message = pageMessages[page] || 'åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼';
          showAlert(message, 'info');
          
            // é€™è£¡å¯ä»¥åŠ å…¥å¯¦éš›çš„é é¢å°èˆªé‚è¼¯
            // ä¾‹å¦‚ï¼šloadPage(page);
        }
        
        // é¡¯ç¤ºè­¦å‘Šè¨Šæ¯
        function showAlert(message, type = 'success', duration = 4000) {
            const alertContainer = DOM.get('alertContainer');
            if (!alertContainer) {
                Logger.warn('æ‰¾ä¸åˆ° alertContainerï¼Œä½¿ç”¨ console é¡¯ç¤ºè¨Šæ¯', message);
                return;
            }
            
            const alertId = `alert-${Date.now()}`;
            const alert = document.createElement('div');
            alert.id = alertId;
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            // æ·»åŠ é—œé–‰æŒ‰éˆ•
            const closeBtn = document.createElement('span');
            closeBtn.innerHTML = '&times;';
            closeBtn.style.cssText = `
                position: absolute;
                top: 8px;
                right: 12px;
                cursor: pointer;
                font-size: 20px;
                line-height: 1;
                opacity: 0.7;
            `;
            closeBtn.onclick = () => removeAlert(alertId);
            
            alert.style.position = 'relative';
            alert.appendChild(closeBtn);
            
            alertContainer.appendChild(alert);
            Logger.log(`é¡¯ç¤ºè¨Šæ¯: ${type} - ${message}`);
            
            // è‡ªå‹•ç§»é™¤
            if (duration > 0) {
                setTimeout(() => removeAlert(alertId), duration);
            }
        }
        
        // ç§»é™¤è­¦å‘Šè¨Šæ¯
        function removeAlert(alertId) {
            const alert = DOM.get(alertId);
            if (alert && alert.parentNode) {
                alert.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }
        }
        
        // æª¢æŸ¥ç³»çµ±éœ€æ±‚
        function checkSystemRequirements() {
            const requirements = {
                fetch: typeof fetch !== 'undefined',
                localStorage: typeof localStorage !== 'undefined',
                addEventListener: typeof document.addEventListener !== 'undefined',
                JSON: typeof JSON !== 'undefined'
            };
            
            const failed = Object.entries(requirements)
                .filter(([key, supported]) => !supported)
                .map(([key]) => key);
            
            if (failed.length > 0) {
                throw new Error(`ç€è¦½å™¨ä¸æ”¯æ´ä»¥ä¸‹åŠŸèƒ½: ${failed.join(', ')}`);
            }
            
            Logger.log('ç³»çµ±éœ€æ±‚æª¢æŸ¥é€šé', requirements);
            return true;
        }
        
        // é é¢è¼‰å…¥å®Œæˆè™•ç†
        function handleDOMContentLoaded() {
            Logger.log('DOM è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            
            try {
                // æª¢æŸ¥ç³»çµ±éœ€æ±‚
                checkSystemRequirements();
                
                // æª¢æŸ¥å¿…è¦çš„ DOM å…ƒç´ 
                const requiredElements = [
                    'loading', 'mainMenu', 'errorPage', 'alertContainer',
                    'userInfo', 'userName', 'userStatus', 'activitiesBtn'
                ];
                
                const missingElements = requiredElements.filter(id => !DOM.get(id));
                
                if (missingElements.length > 0) {
                    throw new Error(`ç¼ºå°‘å¿…è¦çš„ DOM å…ƒç´ : ${missingElements.join(', ')}`);
                }
                
                Logger.log('DOM å…ƒç´ æª¢æŸ¥é€šé');
                
                // å»¶é²åˆå§‹åŒ–ä»¥ç¢ºä¿æ‰€æœ‰è³‡æºè¼‰å…¥å®Œæˆ
                setTimeout(() => {
                    initializeLiff().catch(error => {
                        Logger.error('å»¶é²åˆå§‹åŒ–å¤±æ•—', error);
                        showErrorPage(error.message);
                    });
                }, 200);
                
            } catch (error) {
                Logger.error('DOM åˆå§‹åŒ–å¤±æ•—', error);
                showErrorPage(error.message);
            }
        }
        
        // å…¨åŸŸéŒ¯èª¤è™•ç†
        function setupGlobalErrorHandlers() {
            // JavaScript éŒ¯èª¤
            window.addEventListener('error', function(event) {
                Logger.error('å…¨åŸŸ JavaScript éŒ¯èª¤', {
                    message: event.message,
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno,
                    error: event.error
                });
                
                if (!isInitialized) {
                    showErrorPage(`è¼‰å…¥éŒ¯èª¤: ${event.message}`);
                } else {
                    showAlert('ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
                }
            });
            
            // Promise æ‹’çµ•
            window.addEventListener('unhandledrejection', function(event) {
                Logger.error('æœªè™•ç†çš„ Promise æ‹’çµ•', event.reason);
                
                if (!isInitialized) {
                    showErrorPage(`ç³»çµ±éŒ¯èª¤: ${event.reason}`);
                } else {
                    showAlert('ç³»çµ±è™•ç†è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
                }
                
                // é˜²æ­¢éŒ¯èª¤é¡¯ç¤ºåœ¨ console
                event.preventDefault();
            });
            
            // ç¶²è·¯éŒ¯èª¤
            window.addEventListener('offline', function() {
                Logger.warn('ç¶²è·¯é€£ç·šä¸­æ–·');
                showAlert('ç¶²è·¯é€£ç·šä¸­æ–·ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨', 'warning', 0);
            });
            
            window.addEventListener('online', function() {
                Logger.log('ç¶²è·¯é€£ç·šæ¢å¾©');
                showAlert('ç¶²è·¯é€£ç·šå·²æ¢å¾©', 'success');
            });
        }
        
        // æ•ˆèƒ½ç›£æ§
        function setupPerformanceMonitoring() {
            if ('performance' in window) {
                window.addEventListener('load', function() {
                    setTimeout(() => {
                        const perfData = performance.timing;
                        const loadTime = perfData.loadEventEnd - perfData.navigationStart;
                        const domReady = perfData.domContentLoadedEventEnd - perfData.navigationStart;
                        
                        Logger.log('æ•ˆèƒ½æ•¸æ“š', {
                            totalLoadTime: `${loadTime}ms`,
                            domReadyTime: `${domReady}ms`,
                            liffInitTime: isInitialized ? 'æˆåŠŸ' : 'å¤±æ•—'
                        });
                        
                        // å¦‚æœè¼‰å…¥æ™‚é–“éé•·ï¼Œé¡¯ç¤ºæç¤º
                        if (loadTime > 5000) {
                            showAlert('ç³»çµ±è¼‰å…¥è¼ƒæ…¢ï¼Œå¯èƒ½æ˜¯ç¶²è·¯é€£ç·šå•é¡Œ', 'warning');
                        }
                    }, 1000);
                });
            }
        }
        
        // æ–°å¢ slideOut å‹•ç•«
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideOut {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateY(-10px);
                }
            }
        `;
        document.head.appendChild(style);
        
        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        function initializeApp() {
            Logger.log('é–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...', {
                userAgent: navigator.userAgent,
                url: window.location.href,
                timestamp: new Date().toISOString()
            });
            
            // è¨­å®šå…¨åŸŸéŒ¯èª¤è™•ç†
            setupGlobalErrorHandlers();
            
            // è¨­å®šæ•ˆèƒ½ç›£æ§
            setupPerformanceMonitoring();
            
            // DOM è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', handleDOMContentLoaded);
            } else {
                // DOM å·²ç¶“è¼‰å…¥å®Œæˆ
                handleDOMContentLoaded();
            }
        }
        
        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        initializeApp();
        
    </script>
</body>
</html>
