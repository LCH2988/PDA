<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>帕金森病友會 - 管理後台</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
  <style>
    :root {
      --primary-color: #00B900;
      --secondary-color: #06C755;
    }
    body { font-family: 'Noto Sans TC', sans-serif; background: #f8f9fa; }
    .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 250px; background: linear-gradient(180deg, var(--primary-color), var(--secondary-color)); color: #fff; padding: 20px; overflow-y: auto; z-index: 1000; }
    .sidebar h4 { font-weight: bold; margin-bottom: 30px; text-align: center; }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 12px 15px; border-radius: 10px; margin-bottom: 5px; transition: all .3s; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { background: rgba(255,255,255,0.2); color: #fff; }
    .main-content { margin-left: 250px; padding: 30px; }
    .top-bar { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,.08); margin-bottom: 30px; }
    .stat-card { background: #fff; border-radius: 15px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,.08); text-align: center; }
    .stat-card .icon { font-size: 3rem; margin-bottom: 15px; }
    .stat-card .number { font-size: 2.5rem; font-weight: bold; margin-bottom: 5px; }
    .stat-card .label { color: #666; font-size: 1rem; }
    .card { border: none; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,.08); margin-bottom: 20px; }
    .card-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: #fff; font-weight: bold; border-radius: 15px 15px 0 0 !important; }
    .table { margin-bottom: 0; }
    .table thead th { border-bottom: 2px solid #dee2e6; font-weight: 600; }
    .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border: none; }
    .page-section { display: none; }
    .page-section.active { display: block; }
    .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
    .spinner-border { width: 3rem; height: 3rem; color: #fff; }
    @media (max-width: 768px) {
      .sidebar { width: 100%; position: relative; }
      .main-content { margin-left: 0; }
    }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner-border"></div>
  </div>

  <div class="sidebar">
    <h4><i class="bi bi-shield-check"></i> 管理後台</h4>
    <nav class="nav flex-column">
      <a class="nav-link active" data-page="dashboard"><i class="bi bi-speedometer2"></i> 儀表板</a>
      <a class="nav-link" data-page="members"><i class="bi bi-people"></i> 會員管理</a>
      <a class="nav-link" data-page="activities"><i class="bi bi-calendar-event"></i> 活動管理</a>
      <a class="nav-link" data-page="volunteers"><i class="bi bi-hand-thumbs-up"></i> 志工管理</a>
      <a class="nav-link" data-page="finance"><i class="bi bi-wallet2"></i> 財務管理</a>
      <a class="nav-link" data-page="reports"><i class="bi bi-bar-chart"></i> 統計報表</a>
    </nav>
  </div>

  <div class="main-content">
    <div class="top-bar">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0">歡迎回來，<span id="adminName">管理員</span></h5>
          <small class="text-muted">最後登入：<span id="lastLogin">--</span></small>
        </div>
        <button class="btn btn-outline-danger btn-sm" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i> 登出
        </button>
      </div>
    </div>

    <!-- 儀表板 -->
    <div id="dashboardSection" class="page-section active">
      <div class="row g-4 mb-4">
        <div class="col-md-3">
          <div class="stat-card">
            <i class="bi bi-people text-primary icon"></i>
            <div class="number text-primary" id="totalMembers">0</div>
            <div class="label">總會員數</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <i class="bi bi-calendar-check text-success icon"></i>
            <div class="number text-success" id="activeActivities">0</div>
            <div class="label">進行中活動</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <i class="bi bi-hand-thumbs-up text-info icon"></i>
            <div class="number text-info" id="activeVolunteers">0</div>
            <div class="label">活躍志工</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <i class="bi bi-currency-dollar text-warning icon"></i>
            <div class="number text-warning" id="totalBalance">$0</div>
            <div class="label">財務結餘</div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">最新會員</div>
            <div class="card-body" id="recentMembersContainer">
              <p class="text-muted">載入中...</p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">近期活動</div>
            <div class="card-body" id="upcomingActivitiesContainer">
              <p class="text-muted">載入中...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 會員管理 -->
    <div id="membersSection" class="page-section">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="bi bi-people"></i> 會員管理</h4>
        <div>
          <input type="text" class="form-control d-inline-block w-auto me-2" id="searchMember" placeholder="搜尋會員..." />
          <button class="btn btn-primary" onclick="exportMembers()">
            <i class="bi bi-download"></i> 匯出
          </button>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <div class="table-responsive" id="membersTableContainer">
            <p class="text-muted">載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 活動管理 -->
    <div id="activitiesSection" class="page-section">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="bi bi-calendar-event"></i> 活動管理</h4>
        <button class="btn btn-primary" onclick="showCreateActivityModal()">
          <i class="bi bi-plus-circle"></i> 新增活動
        </button>
      </div>
      <div class="card">
        <div class="card-body">
          <div id="activitiesTableContainer">
            <p class="text-muted">載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 志工管理 -->
    <div id="volunteersSection" class="page-section">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="bi bi-hand-thumbs-up"></i> 志工管理</h4>
        <button class="btn btn-primary" onclick="showCreateVolunteerModal()">
          <i class="bi bi-plus-circle"></i> 新增需求
        </button>
      </div>
      <div class="card">
        <div class="card-body">
          <div id="volunteersTableContainer">
            <p class="text-muted">載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 財務管理 -->
    <div id="financeSection" class="page-section">
      <h4 class="mb-3"><i class="bi bi-wallet2"></i> 財務管理</h4>
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="stat-card">
            <div class="number text-success" id="finTotalIncome">$0</div>
            <div class="label">總收入</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card">
            <div class="number text-danger" id="finTotalExpense">$0</div>
            <div class="label">總支出</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card">
            <div class="number text-primary" id="finBalance">$0</div>
            <div class="label">結餘</div>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>收入記錄</span>
          <button class="btn btn-sm btn-light" onclick="showAddDonationModal()">
            <i class="bi bi-plus"></i> 新增
          </button>
        </div>
        <div class="card-body">
          <div id="donationsTableContainer">
            <p class="text-muted">載入中...</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>支出記錄</span>
          <button class="btn btn-sm btn-light" onclick="showAddExpenseModal()">
            <i class="bi bi-plus"></i> 新增
          </button>
        </div>
        <div class="card-body">
          <div id="expensesTableContainer">
            <p class="text-muted">載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 統計報表 -->
    <div id="reportsSection" class="page-section">
      <h4 class="mb-3"><i class="bi bi-bar-chart"></i> 統計報表</h4>
      <div class="card">
        <div class="card-body">
          <h5>會員統計</h5>
          <div id="memberStatsContainer">
            <p class="text-muted">載入中...</p>
          </div>
          <hr>
          <h5>活動統計</h5>
          <div id="activityStatsContainer">
            <p class="text-muted">載入中...</p>
          </div>
          <hr>
          <h5>財務統計</h5>
          <div id="financeStatsContainer">
            <p class="text-muted">載入中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 會員詳情 Modal -->
  <div class="modal fade" id="memberDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">會員詳情</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="memberDetailContent">
          <p class="text-muted">載入中...</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
          <button type="button" class="btn btn-primary" onclick="editMember()">編輯</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 活動參與者 Modal -->
  <div class="modal fade" id="activityParticipantsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">活動參與者</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="participantsContent">
          <p class="text-muted">載入中...</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const CONFIG = {
      LIFF_ID: '1656516134-k8rMQwnQ',
      API_URL: 'https://script.google.com/macros/s/AKfycbxFamy3G2rIFOWQQ846L0m9p1ikJE8XlHTfkP87Q8g-kLR-ljDqO0hOln2GuYn7_6-SYw/exec',
      API_KEY: 'AAbb8520258185202581'
    };

    let currentUser = null;

    async function initializeLiff() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if (!liff.isLoggedIn()) { 
          liff.login(); 
          return; 
        }
        const profile = await liff.getProfile();
        currentUser = { lineId: profile.userId, lineName: profile.displayName };
        await checkAdminPermission();
      } catch (error) {
        console.error('LIFF 初始化失敗:', error);
        showAlert('系統初始化失敗', 'danger');
      }
    }

    async function callAPI(action, data = {}) {
      showLoading(true);
      try {
        const response = await fetch(CONFIG.API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action, apiKey: CONFIG.API_KEY, lineId: currentUser?.lineId || '', ...data }),
          redirect: 'follow'
        });
        if (!response.ok) throw new Error('HTTP 錯誤: ' + response.status);
        const text = await response.text();
        const result = JSON.parse(text);
        if (!result.success) throw new Error(result.message || '操作失敗');
        return result.data;
      } catch (error) {
        console.error('API 呼叫失敗:', error);
        showAlert(error.message || 'API 呼叫失敗', 'danger');
        throw error;
      } finally {
        showLoading(false);
      }
    }

    async function checkAdminPermission() {
      try {
        const userData = await callAPI('getUserInfo');
        if (!userData || !userData.isAdmin) {
          showAlert('您沒有管理員權限', 'danger');
          setTimeout(() => liff.closeWindow(), 2000);
          return;
        }
        currentUser = { ...currentUser, ...userData };
        document.getElementById('adminName').textContent = userData.realName || userData.lineName;
        document.getElementById('lastLogin').textContent = new Date().toLocaleString('zh-TW');
        initializeAdmin();
      } catch (error) {
        showAlert('權限驗證失敗', 'danger');
        setTimeout(() => liff.closeWindow(), 2000);
      }
    }

    function initializeAdmin() {
      setupEventListeners();
      loadDashboard();
    }

    function setupEventListeners() {
      document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.addEventListener('click', function() {
          document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
          this.classList.add('active');
          switchPage(this.dataset.page);
        });
      });

      const searchInput = document.getElementById('searchMember');
      if (searchInput) {
        searchInput.addEventListener('input', debounce(() => loadMembers(), 500));
      }
    }

    function switchPage(page) {
      document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
      document.getElementById(`${page}Section`).classList.add('active');

      switch(page) {
        case 'dashboard': loadDashboard(); break;
        case 'members': loadMembers(); break;
        case 'activities': loadActivitiesAdmin(); break;
        case 'volunteers': loadVolunteersAdmin(); break;
        case 'finance': loadFinanceAdmin(); break;
        case 'reports': loadReports(); break;
      }
    }

    async function loadDashboard() {
      try {
        const data = await callAPI('getAdminDashboard');
        document.getElementById('totalMembers').textContent = data.totalMembers || 0;
        document.getElementById('activeActivities').textContent = data.activeActivities || 0;
        document.getElementById('activeVolunteers').textContent = data.activeVolunteers || 0;
        document.getElementById('totalBalance').textContent = '$' + (data.totalBalance || 0).toLocaleString();

        const recentMembers = document.getElementById('recentMembersContainer');
        if (data.recentMembers && data.recentMembers.length > 0) {
          recentMembers.innerHTML = data.recentMembers.map(m => `
            <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
              <div>
                <strong>${m.realName}</strong>
                <br><small class="text-muted">${m.memberType}</small>
              </div>
              <small class="text-muted">${new Date(m.createdAt).toLocaleDateString('zh-TW')}</small>
            </div>
          `).join('');
        } else {
          recentMembers.innerHTML = '<p class="text-muted">暫無資料</p>';
        }

        const upcomingActivities = document.getElementById('upcomingActivitiesContainer');
        if (data.upcomingActivities && data.upcomingActivities.length > 0) {
          upcomingActivities.innerHTML = data.upcomingActivities.map(a => `
            <div class="mb-2 pb-2 border-bottom">
              <strong>${a.title}</strong>
              <br><small class="text-muted">${a.date} | ${a.currentParticipants || 0}/${a.maxParticipants} 人</small>
            </div>
          `).join('');
        } else {
          upcomingActivities.innerHTML = '<p class="text-muted">暫無活動</p>';
        }
      } catch (e) { 
        console.error(e); 
      }
    }

    async function loadMembers() {
      try {
        const searchTerm = document.getElementById('searchMember')?.value || '';
        const members = await callAPI('getAllMembers', { search: searchTerm });
        const container = document.getElementById('membersTableContainer');
        
        if (!members || members.length === 0) {
          container.innerHTML = '<p class="text-muted">暫無會員資料</p>';
          return;
        }

        container.innerHTML = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>姓名</th>
                <th>會員類型</th>
                <th>電話</th>
                <th>狀態</th>
                <th>註冊日期</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              ${members.map(m => `
                <tr>
                  <td>${m.realName || m.lineName}</td>
                  <td><span class="badge bg-primary">${m.memberType || '未設定'}</span></td>
                  <td>${m.phone || '--'}</td>
                  <td><span class="badge bg-${m.status === '正常' ? 'success' : 'secondary'}">${m.status || '未知'}</span></td>
                  <td>${new Date(m.createdAt).toLocaleDateString('zh-TW')}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewMemberDetail('${m.lineId}')">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-${m.status === '正常' ? 'warning' : 'success'}" onclick="toggleMemberStatus('${m.lineId}', '${m.status}')">
                      <i class="bi bi-${m.status === '正常' ? 'pause' : 'play'}"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (e) { 
        console.error(e); 
      }
    }

    async function viewMemberDetail(lineId) {
      try {
        const member = await callAPI('getMemberDetail', { targetLineId: lineId });
        const content = document.getElementById('memberDetailContent');
        content.innerHTML = `
          <div class="row">
            <div class="col-md-6 mb-3"><strong>真實姓名：</strong>${member.realName ||'--'}</div>
            <div class="col-md-6 mb-3"><strong>LINE 名稱：</strong>${member.lineName || '--'}</div>
            <div class="col-md-6 mb-3"><strong>會員類型：</strong>${member.memberType || '--'}</div>
            <div class="col-md-6 mb-3"><strong>電話：</strong>${member.phone || '--'}</div>
            <div class="col-md-6 mb-3"><strong>Email：</strong>${member.email || '--'}</div>
            <div class="col-md-6 mb-3"><strong>生日：</strong>${member.birthday || '--'}</div>
            <div class="col-md-12 mb-3"><strong>地址：</strong>${member.address || '--'}</div>
            <div class="col-md-6 mb-3"><strong>確診日期：</strong>${member.diagnosisDate || '--'}</div>
            <div class="col-md-6 mb-3"><strong>疾病階段：</strong>${member.diseaseStage || '--'}</div>
            <div class="col-md-12 mb-3"><strong>目前用藥：</strong>${member.medications || '--'}</div>
            <div class="col-md-12 mb-3"><strong>主要症狀：</strong>${member.symptoms || '--'}</div>
            <div class="col-md-6 mb-3"><strong>行動能力：</strong>${member.mobility || '--'}</div>
            <div class="col-md-6 mb-3"><strong>照顧者：</strong>${member.caregiverName || '--'}</div>
            <div class="col-md-12 mb-3"><strong>緊急聯絡人：</strong>${member.emergencyContact || '--'}</div>
            <div class="col-md-12 mb-3"><strong>備註：</strong>${member.notes || '--'}</div>
            <div class="col-md-6 mb-3"><strong>狀態：</strong><span class="badge bg-${member.status === '正常' ? 'success' : 'secondary'}">${member.status}</span></div>
            <div class="col-md-6 mb-3"><strong>註冊日期：</strong>${new Date(member.createdAt).toLocaleString('zh-TW')}</div>
          </div>
        `;
        const modal = new bootstrap.Modal(document.getElementById('memberDetailModal'));
        modal.show();
      } catch (e) { 
        showAlert('載入會員詳情失敗', 'danger'); 
      }
    }

    async function toggleMemberStatus(lineId, currentStatus) {
      const newStatus = currentStatus === '正常' ? '停用' : '正常';
      if (!confirm(`確定要將此會員狀態改為「${newStatus}」嗎？`)) return;
      try {
        await callAPI('updateMemberStatus', { targetLineId: lineId, status: newStatus });
        showAlert('狀態已更新', 'success');
        loadMembers();
      } catch (e) { 
        showAlert('更新失敗', 'danger'); 
      }
    }

    async function loadActivitiesAdmin() {
      try {
        const activities = await callAPI('getAllActivities');
        const container = document.getElementById('activitiesTableContainer');
        
        if (!activities || activities.length === 0) {
          container.innerHTML = '<p class="text-muted">暫無活動資料</p>';
          return;
        }

        container.innerHTML = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>活動名稱</th>
                <th>日期</th>
                <th>地點</th>
                <th>人數</th>
                <th>費用</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              ${activities.map(a => `
                <tr>
                  <td>${a.title}</td>
                  <td>${a.date} ${a.time || ''}</td>
                  <td>${a.location || '--'}</td>
                  <td>${a.currentParticipants || 0}/${a.maxParticipants}</td>
                  <td>$${a.fee || 0}</td>
                  <td><span class="badge bg-${a.status === '開放報名' ? 'success' : 'secondary'}">${a.status}</span></td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewActivityParticipants('${a.id}')">
                      <i class="bi bi-people"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="editActivity('${a.id}')">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteActivity('${a.id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (e) { 
        console.error(e); 
      }
    }

    async function viewActivityParticipants(activityId) {
      try {
        const participants = await callAPI('getActivityParticipants', { activityId });
        const content = document.getElementById('participantsContent');
        
        if (!participants || participants.length === 0) {
          content.innerHTML = '<p class="text-muted">暫無參與者</p>';
        } else {
          content.innerHTML = `
            <table class="table">
              <thead>
                <tr>
                  <th>姓名</th>
                  <th>會員類型</th>
                  <th>電話</th>
                  <th>報名時間</th>
                  <th>付款狀態</th>
                  <th>簽到</th>
                </tr>
              </thead>
              <tbody>
                ${participants.map(p => `
                  <tr>
                    <td>${p.realName || p.lineName}</td>
                    <td>${p.memberType || '--'}</td>
                    <td>${p.phone || '--'}</td>
                    <td>${new Date(p.registeredAt).toLocaleString('zh-TW')}</td>
                    <td><span class="badge bg-${p.paymentStatus === '已付款' ? 'success' : 'warning'}">${p.paymentStatus || '未付款'}</span></td>
                    <td>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" ${p.attended ? 'checked' : ''} 
                          onchange="toggleAttendance('${p.registrationId}', this.checked)">
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('activityParticipantsModal'));
        modal.show();
      } catch (e) { 
        showAlert('載入參與者失敗', 'danger'); 
      }
    }

    async function toggleAttendance(registrationId, attended) {
      try {
        await callAPI('updateAttendance', { registrationId, attended });
        showAlert('簽到狀態已更新', 'success');
      } catch (e) { 
        showAlert('更新失敗', 'danger'); 
      }
    }

    async function deleteActivity(activityId) {
      if (!confirm('確定要刪除此活動嗎？此操作無法復原！')) return;
      try {
        await callAPI('deleteActivity', { activityId });
        showAlert('活動已刪除', 'success');
        loadActivitiesAdmin();
      } catch (e) { 
        showAlert('刪除失敗', 'danger'); 
      }
    }

    async function loadVolunteersAdmin() {
      try {
        const volunteers = await callAPI('getAllVolunteerNeeds');
        const container = document.getElementById('volunteersTableContainer');
        
        if (!volunteers || volunteers.length === 0) {
          container.innerHTML = '<p class="text-muted">暫無志工需求</p>';
          return;
        }

        container.innerHTML = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>需求標題</th>
                <th>服務日期</th>
                <th>需求人數</th>
                <th>服務時數</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              ${volunteers.map(v => `
                <tr>
                  <td>${v.title}</td>
                  <td>${v.date} ${v.time || ''}</td>
                  <td>${v.currentCount || 0}/${v.needCount}</td>
                  <td>${v.hours} 小時</td>
                  <td><span class="badge bg-${v.status === '招募中' ? 'success' : 'secondary'}">${v.status}</span></td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewVolunteerApplicants('${v.id}')">
                      <i class="bi bi-people"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteVolunteerNeed('${v.id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (e) { 
        console.error(e); 
      }
    }

    async function viewVolunteerApplicants(needId) {
      try {
        const applicants = await callAPI('getVolunteerApplicants', { needId });
        const content = document.getElementById('participantsContent');
        
        if (!applicants || applicants.length === 0) {
          content.innerHTML = '<p class="text-muted">暫無報名者</p>';
        } else {
          content.innerHTML = `
            <table class="table">
              <thead>
                <tr>
                  <th>姓名</th>
                  <th>電話</th>
                  <th>報名時間</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                ${applicants.map(a => `
                  <tr>
                    <td>${a.realName || a.lineName}</td>
                    <td>${a.phone || '--'}</td>
                    <td>${new Date(a.appliedAt).toLocaleString('zh-TW')}</td>
                    <td><span class="badge bg-${a.status === '已完成' ? 'success' : 'primary'}">${a.status}</span></td>
                    <td>
                      ${a.status !== '已完成' ? `
                        <button class="btn btn-sm btn-outline-success" onclick="completeVolunteerRecord('${a.recordId}')">
                          <i class="bi bi-check-circle"></i> 完成
                        </button>
                      ` : ''}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('activityParticipantsModal'));
        modal.show();
      } catch (e) { 
        showAlert('載入報名者失敗', 'danger'); 
      }
    }

    async function completeVolunteerRecord(recordId) {
      if (!confirm('確認此志工服務已完成？')) return;
      try {
        await callAPI('completeVolunteerRecord', { recordId });
        showAlert('已標記為完成', 'success');
        loadVolunteersAdmin();
      } catch (e) { 
        showAlert('更新失敗', 'danger'); 
      }
    }

    async function deleteVolunteerNeed(needId) {
      if (!confirm('確定要刪除此志工需求嗎？')) return;
      try {
        await callAPI('deleteVolunteerNeed', { needId });
        showAlert('需求已刪除', 'success');
        loadVolunteersAdmin();
      } catch (e) { 
        showAlert('刪除失敗', 'danger'); 
      }
    }

    async function loadFinanceAdmin() {
      try {
        const data = await callAPI('getFinancialSummary');
        document.getElementById('finTotalIncome').textContent = '$' + (data.totalIncome || 0).toLocaleString();
        document.getElementById('finTotalExpense').textContent = '$' + (data.totalExpense || 0).toLocaleString();
        document.getElementById('finBalance').textContent = '$' + (data.balance || 0).toLocaleString();

        const donations = await callAPI('getAllDonations');
        const donationsContainer = document.getElementById('donationsTableContainer');
        if (!donations || donations.length === 0) {
          donationsContainer.innerHTML = '<p class="text-muted">暫無收入記錄</p>';
        } else {
          donationsContainer.innerHTML = `
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>日期</th>
                  <th>捐款人</th>
                  <th>類別</th>
                  <th>金額</th>
                  <th>說明</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                ${donations.map(d => `
                  <tr>
                    <td>${new Date(d.createdAt).toLocaleDateString('zh-TW')}</td>
                    <td>${d.donorName || '--'}</td>
                    <td>${d.category}</td>
                    <td class="text-success">$${(d.amount || 0).toLocaleString()}</td>
                    <td>${d.description || '--'}</td>
                    <td><span class="badge bg-${d.status === '已確認' ? 'success' : 'warning'}">${d.status}</span></td>
                    <td>
                      ${d.status !== '已確認' ? `
                        <button class="btn btn-sm btn-outline-success" onclick="confirmDonation('${d.id}')">
                          <i class="bi bi-check"></i>
                        </button>
                      ` : ''}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }

        const expenses = await callAPI('getAllExpenses');
        const expensesContainer = document.getElementById('expensesTableContainer');
        if (!expenses || expenses.length === 0) {
          expensesContainer.innerHTML = '<p class="text-muted">暫無支出記錄</p>';
        } else {
          expensesContainer.innerHTML = `
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>日期</th>
                  <th>類別</th>
                  <th>金額</th>
                  <th>說明</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                ${expenses.map(e => `
                  <tr>
                    <td>${new Date(e.createdAt).toLocaleDateString('zh-TW')}</td>
                    <td>${e.category}</td>
                    <td class="text-danger">$${(e.amount || 0).toLocaleString()}</td>
                    <td>${e.description || '--'}</td>
                    <td><span class="badge bg-${e.status === '已核准' ? 'success' : 'warning'}">${e.status}</span></td>
                    <td>
                      ${e.status !== '已核准' ? `
                        <button class="btn btn-sm btn-outline-success" onclick="approveExpense('${e.id}')">
                          <i class="bi bi-check"></i>
                        </button>
                      ` : ''}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (e) { 
        console.error(e); 
      }
    }

    async function confirmDonation(donationId) {
      if (!confirm('確認此筆捐款？')) return;
      try {
        await callAPI('confirmDonation', { donationId });
        showAlert('已確認', 'success');
        loadFinanceAdmin();
      } catch (e) { 
        showAlert('確認失敗', 'danger'); 
      }
    }

    async function approveExpense(expenseId) {
      if (!confirm('核准此筆支出？')) return;
      try {
        await callAPI('approveExpense', { expenseId });
        showAlert('已核准', 'success');
        loadFinanceAdmin();
      } catch (e) { 
        showAlert('核准失敗', 'danger'); 
      }
    }

    async function loadReports() {
      try {
        const reports = await callAPI('getStatisticsReports');
        
        const memberStats = document.getElementById('memberStatsContainer');
        memberStats.innerHTML = `
          <div class="row">
            <div class="col-md-3"><strong>總會員數：</strong>${reports.memberStats.total || 0}</div>
            <div class="col-md-3"><strong>病友：</strong>${reports.memberStats.patients || 0}</div>
            <div class="col-md-3"><strong>家屬：</strong>${reports.memberStats.family || 0}</div>
            <div class="col-md-3"><strong>志工：</strong>${reports.memberStats.volunteers || 0}</div>
          </div>
        `;

        const activityStats = document.getElementById('activityStatsContainer');
        activityStats.innerHTML = `
          <div class="row">
            <div class="col-md-3"><strong>總活動數：</strong>${reports.activityStats.total || 0}</div>
            <div class="col-md-3"><strong>進行中：</strong>${reports.activityStats.active || 0}</div>
            <div class="col-md-3"><strong>已完成：</strong>${reports.activityStats.completed || 0}</div>
            <div class="col-md-3"><strong>總參與人次：</strong>${reports.activityStats.totalParticipants || 0}</div>
          </div>
        `;

        const financeStats = document.getElementById('financeStatsContainer');
        financeStats.innerHTML = `
          <div class="row">
            <div class="col-md-4"><strong>總收入：</strong><span class="text-success">$${(reports.financeStats.totalIncome || 0).toLocaleString()}</span></div>
            <div class="col-md-4"><strong>總支出：</strong><span class="text-danger">$${(reports.financeStats.totalExpense || 0).toLocaleString()}</span></div>
            <div class="col-md-4"><strong>結餘：</strong><span class="text-primary">$${(reports.financeStats.balance || 0).toLocaleString()}</span></div>
          </div>
        `;
      } catch (e) { 
        console.error(e); 
      }
    }

    function exportMembers() {
      showAlert('匯出功能開發中...', 'info');
    }

    function showCreateActivityModal() {
      showAlert('請使用前台新增活動', 'info');
    }

    function showCreateVolunteerModal() {
      showAlert('請使用前台新增志工需求', 'info');
    }

    function showAddDonationModal() {
      showAlert('請使用前台新增捐款', 'info');
    }

    function showAddExpenseModal() {
      showAlert('請使用前台新增支出', 'info');
    }

    function editActivity(activityId) {
      showAlert('編輯功能開發中...', 'info');
    }

    function editMember() {
      showAlert('編輯功能開發中...', 'info');
    }

    function logout() {
      if (confirm('確定要登出嗎？')) {
        liff.logout();
        window.location.reload();
      }
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function showAlert(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
      alertDiv.style.zIndex = '10000';
      alertDiv.style.minWidth = '300px';
      alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
      document.body.appendChild(alertDiv);
      setTimeout(() => alertDiv.remove(), 5000);
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    window.addEventListener('DOMContentLoaded', initializeLiff);
  </script>
</body>
</html>

