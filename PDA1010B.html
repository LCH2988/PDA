<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友會 - 管理後台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <style>
    :root {
      --primary-color: #00B900;
      --secondary-color: #06C755;
      --sidebar-width: 250px;
      --header-height: 60px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f6fa;
    }

    /* Loading Screen */
    #loadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Header */
    .admin-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .admin-header h1 {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 0;
    }

    .admin-user {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .admin-user img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid white;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: var(--header-height);
      left: 0;
      width: var(--sidebar-width);
      height: calc(100vh - var(--header-height));
      background: white;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
      overflow-y: auto;
      z-index: 999;
    }

    .sidebar-menu {
      list-style: none;
      padding: 20px 0;
    }

    .sidebar-menu li {
      margin: 5px 0;
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 15px 25px;
      color: #333;
      text-decoration: none;
      transition: all 0.3s;
      font-weight: 500;
    }

    .sidebar-menu a:hover {
      background: rgba(0, 185, 0, 0.1);
      color: var(--primary-color);
    }

    .sidebar-menu a.active {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border-left: 4px solid var(--primary-color);
    }

    .sidebar-menu a i {
      margin-right: 15px;
      font-size: 1.2rem;
      width: 25px;
    }

    /* Main Content */
    .main-content {
      margin-left: var(--sidebar-width);
      margin-top: var(--header-height);
      padding: 30px;
      min-height: calc(100vh - var(--header-height));
    }

    /* Cards */
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }

    .stat-card .icon {
      width: 60px;
      height: 60px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      margin-bottom: 15px;
    }

    .stat-card.primary .icon {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .stat-card.success .icon {
      background: linear-gradient(135deg, #f093fb, #f5576c);
      color: white;
    }

    .stat-card.warning .icon {
      background: linear-gradient(135deg, #ffecd2, #fcb69f);
      color: #ff6b6b;
    }

    .stat-card.info .icon {
      background: linear-gradient(135deg, #a8edea, #fed6e3);
      color: #667eea;
    }

    .stat-card .number {
      font-size: 2.5rem;
      font-weight: bold;
      color: #333;
      margin: 10px 0;
    }

    .stat-card .label {
      color: #666;
      font-size: 0.95rem;
    }

    .stat-card .change {
      font-size: 0.85rem;
      margin-top: 10px;
    }

    .stat-card .change.up {
      color: #28a745;
    }

    .stat-card .change.down {
      color: #dc3545;
    }

    /* Content Card */
    .content-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    .content-card-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .content-card-header h5 {
      margin: 0;
      font-weight: bold;
      color: #333;
    }

    /* Tables */
    .table {
      margin-bottom: 0;
    }

    .table thead th {
      background: #f8f9fa;
      border: none;
      font-weight: 600;
      color: #333;
      padding: 15px;
    }

    .table tbody td {
      padding: 15px;
      vertical-align: middle;
    }

    /* Buttons */
    .btn {
      border-radius: 8px;
      padding: 8px 20px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 185, 0, 0.3);
    }

    /* Badges */
    .badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 500;
      font-size: 0.85rem;
    }

    /* Forms */
    .form-control, .form-select {
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      padding: 10px 15px;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(0, 185, 0, 0.15);
    }

    .form-label {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    /* Modal */
    .modal-content {
      border-radius: 15px;
      border: none;
    }

    .modal-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border-radius: 15px 15px 0 0;
    }

    /* Charts */
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }

    /* Page Sections */
    .page-section {
      display: none;
    }

    .page-section.active {
      display: block;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9998;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s;
      }

      .sidebar.show {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .admin-header {
        padding: 0 15px;
      }

      .mobile-menu-btn {
        display: block !important;
      }
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
    }

    /* Activity Status Colors */
    .status-open { color: #28a745; }
    .status-full { color: #ffc107; }
    .status-closed { color: #dc3545; }
    .status-completed { color: #6c757d; }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }

    .quick-action-btn {
      flex: 1;
      min-width: 200px;
      padding: 20px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .quick-action-btn:hover {
      border-color: var(--primary-color);
      transform: translateY(-3px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .quick-action-btn i {
      font-size: 2rem;
      color: var(--primary-color);
      margin-bottom: 10px;
    }

    /* Export Buttons */
    .export-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingScreen">
    <div class="spinner"></div>
    <p class="mt-3 text-muted">載入中...</p>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Admin Container -->
  <div id="adminContainer" style="display: none;">
    
    <!-- Header -->
    <header class="admin-header">
      <div class="d-flex align-items-center">
        <button class="mobile-menu-btn me-3" id="mobileMenuBtn">
          <i class="bi bi-list"></i>
        </button>
        <h1><i class="bi bi-heart-pulse"></i> 帕金森病友會管理系統</h1>
      </div>
      <div class="admin-user">
        <div class="text-end d-none d-md-block">
          <div id="adminName" style="font-weight: 600;">管理員</div>
          <small id="lastLogin">最後登入：--</small>
        </div>
        <img id="adminAvatar" src="https://via.placeholder.com/40" alt="Admin">
        <button class="btn btn-sm btn-light" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i> 登出
        </button>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <ul class="sidebar-menu">
        <li>
          <a href="#" class="menu-link active" data-page="dashboard">
            <i class="bi bi-speedometer2"></i>
            <span>儀表板</span>
          </a>
        </li>
        <li>
          <a href="#" class="menu-link" data-page="members">
            <i class="bi bi-people"></i>
            <span>會員管理</span>
          </a>
        </li>
        <li>
          <a href="#" class="menu-link" data-page="activities">
            <i class="bi bi-calendar-event"></i>
            <span>活動管理</span>
          </a>
        </li>
        <li>
          <a href="#" class="menu-link" data-page="registrations">
            <i class="bi bi-list-check"></i>
            <span>報名管理</span>
          </a>
        </li>
        <li>
          <a href="#" class="menu-link" data-page="volunteers">
            <i class="bi bi-hand-thumbs-up"></i>
            <span>志工管理</span>
          </a>
        </li>
        <li>
          <a href="#" class="menu-link" data-page="finance">
            <i class="bi bi-wallet2"></i>
            <span>財務管理</span>
          </a>
        </li>
        <li>
          <a href="#" class="menu-link" data-page="reports">
            <i class="bi bi-bar-chart"></i>
            <span>統計報表</span>
          </a>
        </li>
        <li>
          <a href="#" class="menu-link" data-page="settings">
            <i class="bi bi-gear"></i>
            <span>系統設定</span>
          </a>
        </li>
        <li>
          <a href="#" class="menu-link" data-page="logs">
            <i class="bi bi-file-text"></i>
            <span>系統日誌</span>
          </a>
        </li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      
      <!-- Dashboard Section -->
      <div id="dashboardSection" class="page-section active">
        <h2 class="mb-4">儀表板總覽</h2>

        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
          <div class="col-md-3">
            <div class="stat-card primary">
              <div class="icon">
                <i class="bi bi-people"></i>
              </div>
              <div class="number" id="statTotalMembers">0</div>
              <div class="label">總會員數</div>
              <div class="change up">
                <i class="bi bi-arrow-up"></i> <span id="statMembersChange">0</span> 本月新增
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card success">
              <div class="icon">
                <i class="bi bi-calendar-event"></i>
              </div>
              <div class="number" id="statTotalActivities">0</div>
              <div class="label">進行中活動</div>
              <div class="change">
                <span id="statActivitiesTotal">0</span> 總活動數
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card warning">
              <div class="icon">
                <i class="bi bi-hand-thumbs-up"></i>
              </div>
              <div class="number" id="statTotalVolunteers">0</div>
              <div class="label">志工服務次數</div>
              <div class="change">
                <span id="statVolunteerHours">0</span> 總服務時數
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card info">
              <div class="icon">
                <i class="bi bi-currency-dollar"></i>
              </div>
              <div class="number" id="statTotalDonations">$0</div>
              <div class="label">總捐款金額</div>
              <div class="change up">
                <i class="bi bi-arrow-up"></i> <span id="statDonationsChange">$0</span> 本月
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <div class="quick-action-btn" onclick="showCreateActivityModal()">
            <i class="bi bi-plus-circle"></i>
            <div>新增活動</div>
          </div>
          <div class="quick-action-btn" onclick="showCreateVolunteerModal()">
            <i class="bi bi-plus-circle"></i>
            <div>新增志工需求</div>
          </div>
          <div class="quick-action-btn" onclick="switchPage('members')">
            <i class="bi bi-person-plus"></i>
            <div>新增會員</div>
          </div>
          <div class="quick-action-btn" onclick="switchPage('reports')">
            <i class="bi bi-file-earmark-arrow-down"></i>
            <div>匯出報表</div>
          </div>
        </div>

        <!-- Recent Activities & Registrations -->
        <div class="row g-4">
          <div class="col-md-6">
            <div class="content-card">
              <div class="content-card-header">
                <h5><i class="bi bi-clock-history"></i> 最新活動</h5>
              </div>
              <div id="recentActivitiesContainer">
                <div class="text-center text-muted py-4">
                  <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                  <p>載入中...</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="content-card">
              <div class="content-card-header">
                <h5><i class="bi bi-bell"></i> 最新報名</h5>
              </div>
              <div id="recentRegistrationsContainer">
                <div class="text-center text-muted py-4">
                  <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                  <p>載入中...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Members Section -->
      <div id="membersSection" class="page-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>會員管理</h2>
          <button class="btn btn-primary" onclick="showAddMemberModal()">
            <i class="bi bi-person-plus"></i> 新增會員
          </button>
        </div>

        <div class="content-card">
          <div class="export-buttons">
            <button class="btn btn-success btn-sm" onclick="exportMembers('excel')">
              <i class="bi bi-file-earmark-excel"></i> 匯出 Excel
            </button>
            <button class="btn btn-info btn-sm" onclick="exportMembers('csv')">
              <i class="bi bi-filetype-csv"></i> 匯出 CSV
            </button>
          </div>
          
          <div class="table-responsive">
            <table id="membersTable" class="table table-hover">
              <thead>
                <tr>
                  <th>LINE 名稱</th>
                  <th>真實姓名</th>
                  <th>會員類型</th>
                  <th>電話</th>
                  <th>Email</th>
                  <th>狀態</th>
                  <th>註冊日期</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="membersTableBody">
                <tr>
                  <td colspan="8" class="text-center">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Activities Section -->
      <div id="activitiesSection" class="page-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>活動管理</h2>
          <button class="btn btn-primary" onclick="showCreateActivityModal()">
            <i class="bi bi-plus-circle"></i> 新增活動
          </button>
        </div>

        <div class="content-card">
          <div class="table-responsive">
            <table id="activitiesTable" class="table table-hover">
              <thead>
                <tr>
                  <th>活動名稱</th>
                  <th>日期</th>
                  <th>地點</th>
                  <th>報名人數</th>
                  <th>費用</th>
                  <th>狀態</th>
                  <th>建立日期</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="activitiesTableBody">
                <tr>
                  <td colspan="8" class="text-center">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Registrations Section -->
      <div id="registrationsSection" class="page-section">
        <h2 class="mb-4">報名管理</h2>

        <div class="content-card">
          <div class="mb-3">
            <label class="form-label">篩選活動</label>
            <select class="form-select" id="filterActivity" onchange="loadRegistrations()">
              <option value="">全部活動</option>
            </select>
          </div>

          <div class="table-responsive">
            <table id="registrationsTable" class="table table-hover">
              <thead>
                <tr>
                  <th>活動名稱</th>
                  <th>會員姓名</th>
                  <th>電話</th>
                  <th>報名時間</th>
                  <th>付款狀態</th>
                  <th>簽到狀態</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="registrationsTableBody">
                <tr>
                  <td colspan="8" class="text-center">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Volunteers Section -->
      <div id="volunteersSection" class="page-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>志工管理</h2>
          <button class="btn btn-primary" onclick="showCreateVolunteerModal()">
            <i class="bi bi-plus-circle"></i> 新增志工需求
          </button>
        </div>

        <div class="row g-4">
          <div class="col-md-6">
            <div class="content-card">
              <div class="content-card-header">
                <h5><i class="bi bi-clipboard-check"></i> 志工需求列表</h5>
              </div>
              <div id="volunteerNeedsContainer">
                <div class="text-center text-muted py-4">載入中...</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="content-card">
              <div class="content-card-header">
                <h5><i class="bi bi-award"></i> 志工排行榜</h5>
              </div>
              <div id="volunteerLeaderboardContainer">
                <div class="text-center text-muted py-4">載入中...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Finance Section -->
      <div id="financeSection" class="page-section">
        <h2 class="mb-4">財務管理</h2>

        <!-- Financial Summary -->
        <div class="row g-4 mb-4">
          <div class="col-md-4">
            <div class="content-card text-center">
              <h6 class="text-muted mb-3">總收入</h6>
              <h2 class="text-success mb-0" id="financeTotalIncome">$0</h2>
            </div>
          </div>
          <div class="col-md-4">
            <div class="content-card text-center">
              <h6 class="text-muted mb-3">總支出</h6>
              <h2 class="text-danger mb-0" id="financeTotalExpense">$0</h2>
            </div>
          </div>
          <div class="col-md-4">
            <div class="content-card text-center">
              <h6 class="text-muted mb-3">結餘</h6>
              <h2 class="text-primary mb-0" id="financeBalance">$0</h2>
            </div>
          </div>
        </div>

        <!-- Donations & Expenses -->
        <div class="row g-4">
          <div class="col-md-6">
            <div class="content-card">
              <div class="content-card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-currency-dollar"></i> 捐款記錄</h5>
                <button class="btn btn-sm btn-primary" onclick="showAddDonationModal()">
                  <i class="bi bi-plus"></i> 新增
                </button>
              </div>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>捐款人</th>
                      <th>類別</th>
                      <th>金額</th>
                      <th>日期</th>
                      <th>狀態</th>
                    </tr>
                  </thead>
                  <tbody id="donationsTableBody">
                    <tr>
                      <td colspan="5" class="text-center">載入中...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="content-card">
              <div class="content-card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-receipt"></i> 支出記錄</h5>
                <button class="btn btn-sm btn-primary" onclick="showAddExpenseModal()">
                  <i class="bi bi-plus"></i> 新增
                </button>
              </div>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>類別</th>
                      <th>金額</th>
                      <th>日期</th>
                      <th>狀態</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="expensesTableBody">
                    <tr>
                      <td colspan="5" class="text-center">載入中...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Reports Section -->
      <div id="reportsSection" class="page-section">
        <h2 class="mb-4">統計報表</h2>

        <div class="row g-4">
          <div class="col-md-12">
            <div class="content-card">
              <div class="content-card-header">
                <h5><i class="bi bi-graph-up"></i> 會員成長趨勢</h5>
              </div>
              <canvas id="memberGrowthChart"></canvas>
            </div>
          </div>

          <div class="col-md-6">
            <div class="content-card">
              <div class="content-card-header">
                <h5><i class="bi bi-pie-chart"></i> 會員類型分布</h5>
              </div>
              <canvas id="memberTypeChart"></canvas>
            </div>
          </div>

          <div class="col-md-6">
            <div class="content-card">
              <div class="content-card-header">
                <h5><i class="bi bi-bar-chart"></i> 活動參與統計</h5>
              </div>
              <canvas id="activityParticipationChart"></canvas>
            </div>
          </div>

          <div class="col-md-12">
            <div class="content-card">
              <div class="content-card-header">
                <h5><i class="bi bi-cash-stack"></i> 財務月報表</h5>
              </div>
              <canvas id="financialChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Export Reports -->
        <div class="content-card mt-4">
          <h5 class="mb-3">匯出報表</h5>
          <div class="row g-3">
            <div class="col-md-3">
              <button class="btn btn-outline-primary w-100" onclick="exportReport('members')">
                <i class="bi bi-people"></i><br>會員清單
              </button>
            </div>
            <div class="col-md-3">
              <button class="btn btn-outline-success w-100" onclick="exportReport('activities')">
                <i class="bi bi-calendar-event"></i><br>活動報表
              </button>
            </div>
            <div class="col-md-3">
              <button class="btn btn-outline-warning w-100" onclick="exportReport('volunteers')">
                <i class="bi bi-hand-thumbs-up"></i><br>志工報表
              </button>
            </div>
            <div class="col-md-3">
              <button class="btn btn-outline-info w-100" onclick="exportReport('finance')">
                <i class="bi bi-wallet2"></i><br>財務報表
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div id="settingsSection" class="page-section">
        <h2 class="mb-4">系統設定</h2>

        <div class="row g-4">
          <div class="col-md-6">
            <div class="content-card">
              <h5 class="mb-3"><i class="bi bi-gear"></i> 基本設定</h5>
              <form id="basicSettingsForm">
                <div class="mb-3">
                  <label class="form-label">協會名稱</label>
                  <input type="text" class="form-control" id="settingOrgName" value="帕金森病友會">
                </div>
                <div class="mb-3">
                  <label class="form-label">聯絡電話</label>
                  <input type="tel" class="form-control" id="settingPhone">
                </div>
                <div class="mb-3">
                  <label class="form-label">聯絡Email</label>
                  <input type="email" class="form-control" id="settingEmail">
                </div>
                <div class="mb-3">
                  <label class="form-label">地址</label>
                  <input type="text" class="form-control" id="settingAddress">
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-save"></i> 儲存設定
                </button>
              </form>
            </div>
          </div>

          <div class="col-md-6">
            <div class="content-card">
              <h5 class="mb-3"><i class="bi bi-shield-check"></i> 管理員設定</h5>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>管理員</th>
                      <th>權限</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="adminListBody">
                    <tr>
                      <td colspan="3" class="text-center">載入中...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <button class="btn btn-primary btn-sm" onclick="showAddAdminModal()">
                <i class="bi bi-person-plus"></i> 新增管理員
              </button>
            </div>

            <div class="content-card mt-4">
              <h5 class="mb-3"><i class="bi bi-bell"></i> 通知設定</h5>
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="notifyNewRegistration" checked>
                <label class="form-check-label" for="notifyNewRegistration">
                  新報名通知
                </label>
              </div>
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="notifyNewDonation" checked>
                <label class="form-check-label" for="notifyNewDonation">
                  新捐款通知
                </label>
              </div>
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="notifyNewMember" checked>
                <label class="form-check-label" for="notifyNewMember">
                  新會員通知
                </label>
              </div>
              <button class="btn btn-primary btn-sm" onclick="saveNotificationSettings()">
                <i class="bi bi-save"></i> 儲存設定
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Logs Section -->
      <div id="logsSection" class="page-section">
        <h2 class="mb-4">系統日誌</h2>

        <div class="content-card">
          <div class="mb-3">
            <div class="row g-3">
              <div class="col-md-3">
                <select class="form-select" id="logTypeFilter" onchange="loadLogs()">
                  <option value="">全部類型</option>
                  <option value="登入">登入</option>
                  <option value="新增">新增</option>
                  <option value="修改">修改</option>
                  <option value="刪除">刪除</option>
                </select>
              </div>
              <div class="col-md-3">
                <input type="date" class="form-control" id="logDateFilter" onchange="loadLogs()">
              </div>
              <div class="col-md-4">
                <input type="text" class="form-control" placeholder="搜尋..." id="logSearchFilter" onkeyup="loadLogs()">
              </div>
              <div class="col-md-2">
                <button class="btn btn-outline-danger w-100" onclick="clearOldLogs()">
                  <i class="bi bi-trash"></i> 清除舊日誌
                </button>
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th>時間</th>
                  <th>操作者</th>
                  <th>類型</th>
                  <th>動作</th>
                  <th>詳細內容</th>
                </tr>
              </thead>
              <tbody id="logsTableBody">
                <tr>
                  <td colspan="5" class="text-center">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Modals -->

  <!-- Create Activity Modal -->
  <div class="modal fade" id="createActivityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 新增活動</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="createActivityForm">
            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label">活動名稱 *</label>
                <input type="text" class="form-control" id="activityTitle" required>
              </div>
              <div class="col-md-12">
                <label class="form-label">活動說明</label>
                <textarea class="form-control" id="activityDescription" rows="3"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">活動日期 *</label>
                <input type="date" class="form-control" id="activityDate" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">活動時間</label>
                <input type="time" class="form-control" id="activityTime">
              </div>
              <div class="col-md-12">
                <label class="form-label">活動地點</label>
                <input type="text" class="form-control" id="activityLocation">
              </div>
              <div class="col-md-6">
                <label class="form-label">報名人數上限 *</label>
                <input type="number" class="form-control" id="activityMaxParticipants" min="1" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">活動費用</label>
                <input type="number" class="form-control" id="activityFee" min="0" value="0">
              </div>
              <div class="col-md-12">
                <label class="form-label">活動狀態</label>
                <select class="form-select" id="activityStatus">
                  <option value="開放報名">開放報名</option>
                  <option value="報名截止">報名截止</option>
                  <option value="活動結束">活動結束</option>
                </select>
              </div>
            </div>
            <div class="mt-4">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle"></i> 建立活動
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Activity Modal -->
  <div class="modal fade" id="editActivityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil"></i> 編輯活動</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editActivityForm">
            <input type="hidden" id="editActivityId">
            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label">活動名稱 *</label>
                <input type="text" class="form-control" id="editActivityTitle" required>
              </div>
              <div class="col-md-12">
                <label class="form-label">活動說明</label>
                <textarea class="form-control" id="editActivityDescription" rows="3"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">活動日期 *</label>
                <input type="date" class="form-control" id="editActivityDate" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">活動時間</label>
                <input type="time" class="form-control" id="editActivityTime">
              </div>
              <div class="col-md-12">
                <label class="form-label">活動地點</label>
                <input type="text" class="form-control" id="editActivityLocation">
              </div>
              <div class="col-md-6">
                <label class="form-label">報名人數上限 *</label>
                <input type="number" class="form-control" id="editActivityMaxParticipants" min="1" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">活動費用</label>
                <input type="number" class="form-control" id="editActivityFee" min="0">
              </div>
              <div class="col-md-12">
                <label class="form-label">活動狀態</label>
                <select class="form-select" id="editActivityStatus">
                  <option value="開放報名">開放報名</option>
                  <option value="報名截止">報名截止</option>
                  <option value="活動結束">活動結束</option>
                </select>
              </div>
            </div>
            <div class="mt-4">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> 儲存變更
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Volunteer Modal -->
  <div class="modal fade" id="createVolunteerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 新增志工需求</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="createVolunteerForm">
            <div class="mb-3">
              <label class="form-label">需求標題 *</label>
              <input type="text" class="form-control" id="volunteerTitle" required>
            </div>
            <div class="mb-3">
              <label class="form-label">需求說明</label>
              <textarea class="form-control" id="volunteerDescription" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">服務日期 *</label>
              <input type="date" class="form-control" id="volunteerDate" required>
            </div>
            <div class="mb-3">
              <label class="form-label">服務時間</label>
              <input type="time" class="form-control" id="volunteerTime">
            </div>
            <div class="mb-3">
              <label class="form-label">需求人數 *</label>
              <input type="number" class="form-control" id="volunteerNeedCount" min="1" required>
            </div>
            <div class="mb-3">
              <label class="form-label">服務時數 *</label>
              <input type="number" class="form-control" id="volunteerHours" min="0.5" step="0.5" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-check-circle"></i> 建立需求
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Member Modal -->
  <div class="modal fade" id="addMemberModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-person-plus"></i> 新增會員</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addMemberForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">LINE ID *</label>
                <input type="text" class="form-control" id="memberLineId" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">LINE 名稱 *</label>
                <input type="text" class="form-control" id="memberLineName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">真實姓名 *</label>
                <input type="text" class="form-control" id="memberRealName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">會員類型 *</label>
                <select class="form-select" id="memberType" required>
                  <option value="">請選擇</option>
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                  <option value="贊助者">贊助者</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">電話</label>
                <input type="tel" class="form-control" id="memberPhone">
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" id="memberEmail">
              </div>
            </div>
            <div class="mt-4">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle"></i> 新增會員
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Member Modal -->
  <div class="modal fade" id="editMemberModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil"></i> 編輯會員資料</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editMemberForm">
            <input type="hidden" id="editMemberLineId">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">真實姓名 *</label>
                <input type="text" class="form-control" id="editMemberRealName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">會員類型 *</label>
                <select class="form-select" id="editMemberType" required>
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                  <option value="贊助者">贊助者</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">電話</label>
                <input type="tel" class="form-control" id="editMemberPhone">
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" id="editMemberEmail">
              </div>
              <div class="col-md-6">
                <label class="form-label">會員狀態</label>
                <select class="form-select" id="editMemberStatus">
                  <option value="正常">正常</option>
                  <option value="停權">停權</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">管理員權限</label>
                <select class="form-select" id="editMemberIsAdmin">
                  <option value="false">否</option>
                  <option value="true">是</option>
                </select>
              </div>
            </div>
            <div class="mt-4">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> 儲存變更
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Donation Modal -->
  <div class="modal fade" id="addDonationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-currency-dollar"></i> 新增捐款</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addDonationForm">
            <div class="mb-3">
              <label class="form-label">捐款人 LINE ID</label>
              <input type="text" class="form-control" id="donationLineId" placeholder="選填">
            </div>
            <div class="mb-3">
              <label class="form-label">捐款類別 *</label>
              <select class="form-select" id="donationCategory" required>
                <option value="">請選擇</option>
                <option value="一般捐款">一般捐款</option>
                <option value="活動贊助">活動贊助</option>
                <option value="設備捐贈">設備捐贈</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">捐款金額 *</label>
              <input type="number" class="form-control" id="donationAmount" min="1" required>
            </div>
            <div class="mb-3">
              <label class="form-label">說明</label>
              <textarea class="form-control" id="donationDescription" rows="2"></textarea>
            </div>
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-check-circle"></i> 新增捐款
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Expense Modal -->
  <div class="modal fade" id="addExpenseModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-receipt"></i> 新增支出</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addExpenseForm">
            <div class="mb-3">
              <label class="form-label">支出類別 *</label>
              <select class="form-select" id="expenseCategory" required>
                <option value="">請選擇</option>
                <option value="活動費用">活動費用</option>
                <option value="行政支出">行政支出</option>
                <option value="設備支出">設備支出</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">支出金額 *</label>
              <input type="number" class="form-control" id="expenseAmount" min="1" required>
            </div>
            <div class="mb-3">
              <label class="form-label">說明</label>
              <textarea class="form-control" id="expenseDescription" rows="2"></textarea>
            </div>
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-check-circle"></i> 新增支出
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    // ========== 全域變數 ==========
    const CONFIG = {
      LIFF_ID: '1656516134-k8rMQwnQ', // ⚠️ 請替換為您的管理後台 LIFF ID
      API_URL: 'https://script.google.com/macros/s/AKfycbzN1R9KjJ48ixgLX8cjHkX6bQ01b5QMJF9N57ujgO0lREbZzToyhl0cAEeAzJ1Qe5Esug/exec', // ⚠️ 請替換為您的 GAS URL
      API_KEY: 'AAbb8520258185202581'
    };

    let currentAdmin = null;
    let charts = {};

    // ========== LIFF 初始化 ==========
    async function initializeLiff() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        currentAdmin = {
          lineId: profile.userId,
          lineName: profile.displayName,
          pictureUrl: profile.pictureUrl
        };

        // 檢查管理員權限
        await checkAdminPermission();
        
      } catch (error) {
        console.error('LIFF 初始化失敗:', error);
        showAlert('系統初始化失敗，請重新整理頁面', 'danger');
      }
    }

    // ========== 檢查管理員權限 ==========
    async function checkAdminPermission() {
      try {
        const userData = await callAPI('getUserInfo');
        
        if (!userData || !userData.isAdmin) {
          alert('您沒有管理員權限');
          liff.closeWindow();
          return;
        }

        currentAdmin = { ...currentAdmin, ...userData };
        
        document.getElementById('adminName').textContent = userData.realName || userData.lineName;
        document.getElementById('adminAvatar').src = currentAdmin.pictureUrl || 'https://via.placeholder.com/40';
        
        initializeAdmin();
        
      } catch (error) {
        alert('權限驗證失敗');
        liff.closeWindow();
      }
    }

    // ========== API 呼叫函數（修正版）==========
    async function callAPI(action, data = {}) {
      showLoading(true);
      try {
        const response = await fetch(CONFIG.API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'  // ✅ 改為 JSON
          },
          body: JSON.stringify({  // ✅ 使用 JSON.stringify
            action,
            apiKey: CONFIG.API_KEY,
            lineId: currentAdmin?.lineId || '',
            ...data
          })
        });

        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || '操作失敗');
        }
        
        return result.data;
      } catch (error) {
        console.error('API Error:', error);
        showAlert(error.message || 'API 呼叫失敗', 'danger');
        throw error;
      } finally {
        showLoading(false);
      }
    }

    // ========== 初始化管理後台 ==========
    function initializeAdmin() {
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('adminContainer').style.display = 'block';
      
      setupEventListeners();
      loadDashboardData();
      addLog('登入', '管理員登入系統');
    }

    // ========== DataTables 中文化設定 ==========
    const dataTablesLanguage = {
      "sProcessing": "處理中...",
      "sLengthMenu": "顯示 _MENU_ 項結果",
      "sZeroRecords": "沒有匹配結果",
      "sInfo": "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
      "sInfoEmpty": "顯示第 0 至 0 項結果，共 0 項",
      "sInfoFiltered": "(由 _MAX_ 項結果過濾)",
      "sSearch": "搜尋:",
      "oPaginate": {
        "sFirst": "首頁",
        "sPrevious": "上頁",
        "sNext": "下頁",
        "sLast": "末頁"
      }
    };

    // ========== 設置事件監聽器 ==========
    function setupEventListeners() {
      // 側邊欄選單
      document.querySelectorAll('.menu-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const page = this.dataset.page;
          switchPage(page);
        });
      });

      // 手機選單按鈕
      document.getElementById('mobileMenuBtn').addEventListener('click', function() {
        document.getElementById('sidebar').classList.toggle('show');
      });

      // 新增活動表單
      document.getElementById('createActivityForm').addEventListener('submit', handleCreateActivity);
      
      // 編輯活動表單
      document.getElementById('editActivityForm').addEventListener('submit', handleEditActivity);
      
      // 新增志工需求表單
      document.getElementById('createVolunteerForm').addEventListener('submit', handleCreateVolunteer);
      
      // 新增會員表單
      document.getElementById('addMemberForm').addEventListener('submit', handleAddMember);
      
      // 編輯會員表單
      document.getElementById('editMemberForm').addEventListener('submit', handleEditMember);
      
      // 新增捐款表單
      document.getElementById('addDonationForm').addEventListener('submit', handleAddDonation);
      
      // 新增支出表單
      document.getElementById('addExpenseForm').addEventListener('submit', handleAddExpense);
      
      // 基本設定表單
      document.getElementById('basicSettingsForm').addEventListener('submit', handleSaveSettings);
    }

    // ========== 頁面切換 ==========
    function switchPage(page) {
      // 更新選單狀態
      document.querySelectorAll('.menu-link').forEach(link => {
        link.classList.remove('active');
      });
      document.querySelector(`[data-page="${page}"]`).classList.add('active');
      
      // 隱藏所有頁面
      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // 顯示選中的頁面
      document.getElementById(page + 'Section').classList.add('active');
      
      // 載入對應數據
      switch(page) {
        case 'dashboard':
          loadDashboardData();
          break;
        case 'members':
          loadMembers();
          break;
        case 'activities':
          loadActivities();
          break;
        case 'registrations':
          loadRegistrations();
          loadActivitiesForFilter();
          break;
        case 'volunteers':
          loadVolunteerNeeds();
          loadVolunteerLeaderboard();
          break;
        case 'finance':
          loadFinanceData();
          break;
        case 'reports':
          loadReports();
          break;
        case 'settings':
          loadSettings();
          break;
        case 'logs':
          loadLogs();
          break;
      }
      
      // 關閉手機選單
      document.getElementById('sidebar').classList.remove('show');
    }

    // ========== 載入儀表板數據 ==========
    async function loadDashboardData() {
      try {
        const stats = await callAPI('getAdminStats');
        
        // 更新統計卡片
        document.getElementById('statTotalMembers').textContent = stats.totalMembers || 0;
        document.getElementById('statMembersChange').textContent = stats.newMembersThisMonth || 0;
        document.getElementById('statTotalActivities').textContent = stats.activeActivities || 0;
        document.getElementById('statActivitiesTotal').textContent = stats.totalActivities || 0;
        document.getElementById('statTotalVolunteers').textContent = stats.totalVolunteerRecords || 0;
        document.getElementById('statVolunteerHours').textContent = stats.totalVolunteerHours || 0;
        document.getElementById('statTotalDonations').textContent = '$' + (stats.totalDonations || 0).toLocaleString();
        document.getElementById('statDonationsChange').textContent = '$' + (stats.donationsThisMonth || 0).toLocaleString();
        
        // 載入最新活動
        loadRecentActivities();
        
        // 載入最新報名
        loadRecentRegistrations();
        
      } catch (error) {
        console.error('載入儀表板數據失敗:', error);
      }
    }

    // ========== 載入最新活動 ==========
    async function loadRecentActivities() {
      try {
        const activities = await callAPI('getActivities', { limit: 5 });
        const container = document.getElementById('recentActivitiesContainer');
        
        if (!activities || activities.length === 0) {
          container.innerHTML = '<div class="text-center text-muted py-3">暫無活動</div>';
          return;
        }
        
        container.innerHTML = activities.map(act => `
          <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
            <div>
              <h6 class="mb-1">${act.title}</h6>
              <small class="text-muted">
                <i class="bi bi-calendar"></i> ${act.date}
                <i class="bi bi-people ms-2"></i> ${act.currentParticipants || 0}/${act.maxParticipants}
              </small>
            </div>
            <span class="badge bg-${getActivityStatusColor(act.status)}">${act.status}</span>
          </div>
        `).join('');
      } catch (error) {
        console.error('載入最新活動失敗:', error);
      }
    }

    // ========== 載入最新報名 ==========
    async function loadRecentRegistrations() {
      try {
        const registrations = await callAPI('getRecentRegistrations', { limit: 5 });
        const container = document.getElementById('recentRegistrationsContainer');
        
        if (!registrations || registrations.length === 0) {
          container.innerHTML = '<div class="text-center text-muted py-3">暫無報名</div>';
          return;
        }
        
        container.innerHTML = registrations.map(reg => `
          <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
            <div>
              <h6 class="mb-1">${reg.activityTitle}</h6>
              <small class="text-muted">${reg.userName} - ${new Date(reg.createdAt).toLocaleString('zh-TW')}</small>
            </div>
            <span class="badge bg-success">已報名</span>
          </div>
        `).join('');
      } catch (error) {
        console.error('載入最新報名失敗:', error);
      }
    }

    // ========== 載入會員列表 ==========
    async function loadMembers() {
      try {
        const members = await callAPI('getAllMembers');
        const tbody = document.getElementById('membersTableBody');
        
        if (!members || members.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center">暫無會員資料</td></tr>';
          return;
        }
        
        tbody.innerHTML = members.map(member => `
          <tr>
            <td>${member.lineName}</td>
            <td>${member.realName || '-'}</td>
            <td><span class="badge bg-info">${member.memberType || '-'}</span></td>
            <td>${member.phone || '-'}</td>
            <td>${member.email || '-'}</td>
            <td>
              <span class="badge bg-${member.status === '正常' ? 'success' : 'danger'}">
                ${member.status || '正常'}
              </span>
            </td>
            <td>${new Date(member.createdAt).toLocaleDateString('zh-TW')}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="editMember('${member.lineId}')">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteMember('${member.lineId}')">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');
        
        // 初始化 DataTable
        if ($.fn.DataTable.isDataTable('#membersTable')) {
          $('#membersTable').DataTable().destroy();
        }
        $('#membersTable').DataTable({
          language: dataTablesLanguage,
          order: [[6, 'desc']]
        });
        
      } catch (error) {
        console.error('載入會員列表失敗:', error);
      }
    }

    // ========== 載入活動列表 ==========
    async function loadActivities() {
      try {
        const activities = await callAPI('getActivities');
        const tbody = document.getElementById('activitiesTableBody');
        
        if (!activities || activities.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center">暫無活動資料</td></tr>';
          return;
        }
        
        tbody.innerHTML = activities.map(act => `
          <tr>
            <td>${act.title}</td>
            <td>${act.date}</td>
            <td>${act.location || '-'}</td>
            <td>${act.currentParticipants || 0}/${act.maxParticipants}</td>
            <td>$${act.fee || 0}</td>
            <td><span class="badge bg-${getActivityStatusColor(act.status)}">${act.status}</span></td>
            <td>${new Date(act.createdAt).toLocaleDateString('zh-TW')}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="editActivity('${act.id}')">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-info" onclick="viewActivityDetails('${act.id}')">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteActivity('${act.id}')">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');
        
        if ($.fn.DataTable.isDataTable('#activitiesTable')) {
          $('#activitiesTable').DataTable().destroy();
        }
        $('#activitiesTable').DataTable({
          language: dataTablesLanguage,
          order: [[1, 'desc']]
        });
        
      } catch (error) {
        console.error('載入活動列表失敗:', error);
      }
    }

    // ========== 完整的活動詳情 Modal（修正版）==========
    async function viewActivityDetails(activityId) {
      try {
        const data = await callAPI('getActivityDetail', { activityId });
        
        // 建立 Modal HTML
        const modalHtml = `
          <div class="modal fade" id="activityDetailViewModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="bi bi-info-circle"></i> 活動詳情</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <h5>${data.activity.title}</h5>
                  <p>${data.activity.description || '無說明'}</p>
                  <hr>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <p><strong>日期：</strong>${data.activity.date} ${data.activity.time || ''}</p>
                      <p><strong>地點：</strong>${data.activity.location || '待定'}</p>
                      <p><strong>費用：</strong>$${data.activity.fee || 0}</p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>人數：</strong>${data.activity.currentParticipants || 0}/${data.activity.maxParticipants}</p>
                      <p><strong>狀態：</strong><span class="badge bg-${getActivityStatusColor(data.activity.status)}">${data.activity.status}</span></p>
                    </div>
                  </div>
                  
                  <h6 class="mt-4">報名名單 (${data.registrations.length}人)</h6>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>姓名</th>
                          <th>會員類型</th>
                          <th>報名時間</th>
                          <th>付款狀態</th>
                          <th>簽到</th>
                          <th>操作</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${data.registrations.map(reg => `
                          <tr>
                            <td>${reg.userName}</td>
                            <td>${reg.memberType}</td>
                            <td>${new Date(reg.createdAt).toLocaleString('zh-TW')}</td>
                            <td><span class="badge bg-${reg.paymentStatus === '已付款' ? 'success' : 'warning'}">${reg.paymentStatus || '未付款'}</span></td>
                            <td>
                              ${reg.attended ? 
                                '<span class="badge bg-success">已簽到</span>' : 
                                `<button class="btn btn-sm btn-outline-primary" onclick="markAttendance('${reg.id}', '${activityId}')">簽到</button>`
                              }
                            </td>
                            <td>
                              <button class="btn btn-sm btn-danger" onclick="cancelRegistration('${reg.id}', '${activityId}')">
                                <i class="bi bi-x"></i>
                              </button>
                            </td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // 移除舊的 Modal
        const oldModal = document.getElementById('activityDetailViewModal');
        if (oldModal) oldModal.remove();
        
        // 插入新 Modal
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // 顯示 Modal
        const modal = new bootstrap.Modal(document.getElementById('activityDetailViewModal'));
        modal.show();
        
      } catch (error) {
        showAlert('載入活動詳情失敗', 'danger');
      }
    }

    // ========== 標記簽到 ==========
    async function markAttendance(registrationId, activityId) {
      if (!confirm('確認簽到？')) return;
      
      try {
        await callAPI('markAttendance', { registrationId });
        showAlert('簽到成功', 'success');
        viewActivityDetails(activityId);
        addLog('簽到', `標記報名 ${registrationId} 為已簽到`);
      } catch (error) {
        showAlert('簽到失敗', 'danger');
      }
    }

    // ========== 取消報名 ==========
    async function cancelRegistration(registrationId, activityId) {
      if (!confirm('確定要取消此報名？')) return;
      
      try {
        await callAPI('cancelRegistration', { registrationId });
        showAlert('已取消報名', 'success');
        viewActivityDetails(activityId);
        addLog('取消報名', `取消報名 ${registrationId}`);
      } catch (error) {
        showAlert('取消失敗', 'danger');
      }
    }

    // ========== 編輯活動 ==========
    async function editActivity(activityId) {
      try {
        const activity = await callAPI('getActivity', { activityId });
        
        document.getElementById('editActivityId').value = activity.id;
        document.getElementById('editActivityTitle').value = activity.title;
        document.getElementById('editActivityDescription').value = activity.description || '';
        document.getElementById('editActivityDate').value = activity.date;
        document.getElementById('editActivityTime').value = activity.time || '';
        document.getElementById('editActivityLocation').value = activity.location || '';
        document.getElementById('editActivityMaxParticipants').value = activity.maxParticipants;
        document.getElementById('editActivityFee').value = activity.fee || 0;
        document.getElementById('editActivityStatus').value = activity.status;
        
        const modal = new bootstrap.Modal(document.getElementById('editActivityModal'));
        modal.show();
      } catch (error) {
        showAlert('載入活動資料失敗', 'danger');
      }
    }

    // ========== 刪除活動 ==========
    async function deleteActivity(activityId) {
      if (!confirm('確定要刪除此活動？此操作無法復原！')) return;
      
      try {
        await callAPI('deleteActivity', { activityId });
        showAlert('活動已刪除', 'success');
        loadActivities();
        addLog('刪除活動', `刪除活動 ${activityId}`);
      } catch (error) {
        showAlert('刪除失敗', 'danger');
      }
    }

    // ========== 載入報名記錄 ==========
    async function loadRegistrations() {
      try {
        const registrations = await callAPI('getAllRegistrations');
        const tbody = document.getElementById('registrationsTableBody');
        
        if (!registrations || registrations.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center">暫無報名記錄</td></tr>';
          return;
        }
        
        tbody.innerHTML = registrations.map(reg => `
          <tr>
            <td>${reg.activityTitle}</td>
            <td>${reg.userName}</td>
            <td>${reg.memberType}</td>
            <td>${new Date(reg.createdAt).toLocaleString('zh-TW')}</td>
            <td><span class="badge bg-${getRegistrationStatusColor(reg.status)}">${reg.status}</span></td>
            <td><span class="badge bg-${reg.paymentStatus === '已付款' ? 'success' : 'warning'}">${reg.paymentStatus || '未付款'}</span></td>
            <td>${reg.attended ? '<span class="badge bg-success">是</span>' : '<span class="badge bg-secondary">否</span>'}</td>
            <td>
              ${!reg.attended ? 
                `<button class="btn btn-sm btn-primary" onclick="markAttendance('${reg.id}', '')">
                  <i class="bi bi-check"></i> 簽到
                </button>` : ''}
              <button class="btn btn-sm btn-danger" onclick="cancelRegistration('${reg.id}', '')">
                <i class="bi bi-x"></i> 取消
              </button>
            </td>
          </tr>
        `).join('');
        
        if ($.fn.DataTable.isDataTable('#registrationsTable')) {
          $('#registrationsTable').DataTable().destroy();
        }
        $('#registrationsTable').DataTable({
          language: dataTablesLanguage,
          order: [[3, 'desc']]
        });
        
      } catch (error) {
        console.error('載入報名記錄失敗:', error);
      }
    }

    // ========== 載入活動篩選選項 ==========
    async function loadActivitiesForFilter() {
      try {
        const activities = await callAPI('getActivities');
        const select = document.getElementById('filterActivity');
        
        select.innerHTML = '<option value="">全部活動</option>' + 
          activities.map(act => `<option value="${act.id}">${act.title}</option>`).join('');
        
        select.addEventListener('change', filterRegistrations);
      } catch (error) {
        console.error('載入活動選項失敗:', error);
      }
    }

    // ========== 篩選報名記錄 ==========
    function filterRegistrations() {
      const activityId = document.getElementById('filterActivity').value;
      const status = document.getElementById('filterStatus').value;
      
      const table = $('#registrationsTable').DataTable();
      
      if (activityId) {
        table.column(0).search(activityId);
      } else {
        table.column(0).search('');
      }
      
      if (status) {
        table.column(4).search(status);
      } else {
        table.column(4).search('');
      }
      
      table.draw();
    }

    // ========== 載入志工需求 ==========
    async function loadVolunteerNeeds() {
      try {
        const needs = await callAPI('getVolunteerNeeds');
        const tbody = document.getElementById('volunteerNeedsTableBody');
        
        if (!needs || needs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center">暫無志工需求</td></tr>';
          return;
        }
        
        tbody.innerHTML = needs.map(need => `
          <tr>
            <td>${need.title}</td>
            <td>${need.date}</td>
            <td>${need.currentCount || 0}/${need.needCount}</td>
            <td>${need.hours}小時</td>
            <td><span class="badge bg-${need.status === '招募中' ? 'success' : 'secondary'}">${need.status}</span></td>
            <td>${new Date(need.createdAt).toLocaleDateString('zh-TW')}</td>
            <td>
              <button class="btn btn-sm btn-info" onclick="viewVolunteerRecords('${need.id}')">
                <i class="bi bi-people"></i> 查看
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteVolunteerNeed('${need.id}')">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');
        
        if ($.fn.DataTable.isDataTable('#volunteerNeedsTable')) {
          $('#volunteerNeedsTable').DataTable().destroy();
        }
        $('#volunteerNeedsTable').DataTable({
          language: dataTablesLanguage,
          order: [[1, 'desc']]
        });
        
      } catch (error) {
        console.error('載入志工需求失敗:', error);
      }
    }

    // ========== 查看志工記錄 ==========
    async function viewVolunteerRecords(needId) {
      try {
        const records = await callAPI('getVolunteerRecordsByNeed', { needId });
        
        const modalHtml = `
          <div class="modal fade" id="volunteerRecordsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">志工報名記錄</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>姓名</th>
                        <th>報名時間</th>
                        <th>狀態</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${records.map(rec => `
                        <tr>
                          <td>${rec.userName}</td>
                          <td>${new Date(rec.createdAt).toLocaleString('zh-TW')}</td>
                          <td><span class="badge bg-${rec.status === '已完成' ? 'success' : 'primary'}">${rec.status}</span></td>
                          <td>
                            ${rec.status !== '已完成' ? 
                              `<button class="btn btn-sm btn-success" onclick="completeVolunteer('${rec.id}', '${needId}')">
                                <i class="bi bi-check"></i> 完成
                              </button>` : ''}
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        `;
        
        const oldModal = document.getElementById('volunteerRecordsModal');
        if (oldModal) oldModal.remove();
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('volunteerRecordsModal'));
        modal.show();
        
      } catch (error) {
        showAlert('載入志工記錄失敗', 'danger');
      }
    }

    // ========== 完成志工服務 ==========
    async function completeVolunteer(recordId, needId) {
      if (!confirm('確認此志工已完成服務？')) return;
      
      try {
        await callAPI('completeVolunteerRecord', { recordId });
        showAlert('已標記為完成', 'success');
        viewVolunteerRecords(needId);
        addLog('完成志工', `志工記錄 ${recordId} 已完成`);
      } catch (error) {
        showAlert('操作失敗', 'danger');
      }
    }

    // ========== 刪除志工需求 ==========
    async function deleteVolunteerNeed(needId) {
      if (!confirm('確定要刪除此志工需求？')) return;
      
      try {
        await callAPI('deleteVolunteerNeed', { needId });
        showAlert('已刪除', 'success');
        loadVolunteerNeeds();
        addLog('刪除志工需求', `刪除需求 ${needId}`);
      } catch (error) {
        showAlert('刪除失敗', 'danger');
      }
    }

    // ========== 載入志工排行榜 ==========
    async function loadVolunteerLeaderboard() {
      try {
        const leaderboard = await callAPI('getVolunteerLeaderboard');
        const tbody = document.getElementById('volunteerLeaderboardBody');
        
        if (!leaderboard || leaderboard.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center">暫無資料</td></tr>';
          return;
        }
        
        tbody.innerHTML = leaderboard.map((item, index) => `
          <tr>
            <td>${index + 1}</td>
            <td>${item.userName}</td>
            <td>${item.totalHours}小時</td>
            <td>${item.totalRecords}次</td>
          </tr>
        `).join('');
        
      } catch (error) {
        console.error('載入志工排行榜失敗:', error);
      }
    }

    // ========== 載入財務數據 ==========
    async function loadFinanceData() {
      try {
        const data = await callAPI('getFinanceData');
        
        // 更新總覽
        document.getElementById('totalIncome').textContent = '$' + (data.totalIncome || 0).toLocaleString();
        document.getElementById('totalExpense').textContent = '$' + (data.totalExpense || 0).toLocaleString();
        document.getElementById('currentBalance').textContent = '$' + (data.balance || 0).toLocaleString();
        
        // 載入捐款記錄
        loadDonations(data.donations);
        
        // 載入支出記錄
        loadExpenses(data.expenses);
        
      } catch (error) {
        console.error('載入財務數據失敗:', error);
      }
    }

    // ========== 載入捐款記錄 ==========
    function loadDonations(donations) {
      const tbody = document.getElementById('donationsTableBody');
      
      if (!donations || donations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">暫無捐款記錄</td></tr>';
        return;
      }
      
      tbody.innerHTML = donations.map(don => `
        <tr>
          <td>${don.userName}</td>
          <td>${don.category}</td>
          <td>$${don.amount.toLocaleString()}</td>
          <td>${don.description || '-'}</td>
          <td><span class="badge bg-${don.status === '已確認' ? 'success' : 'warning'}">${don.status}</span></td>
          <td>${new Date(don.createdAt).toLocaleDateString('zh-TW')}</td>
          <td>
            ${don.status !== '已確認' ? 
              `<button class="btn btn-sm btn-success" onclick="confirmDonation('${don.id}')">
                <i class="bi bi-check"></i> 確認
              </button>` : ''}
          </td>
        </tr>
      `).join('');
      
      if ($.fn.DataTable.isDataTable('#donationsTable')) {
        $('#donationsTable').DataTable().destroy();
      }
      $('#donationsTable').DataTable({
        language: dataTablesLanguage,
        order: [[5, 'desc']]
      });
    }

    // ========== 載入支出記錄 ==========
    function loadExpenses(expenses) {
      const tbody = document.getElementById('expensesTableBody');
      
      if (!expenses || expenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">暫無支出記錄</td></tr>';
        return;
      }
      
      tbody.innerHTML = expenses.map(exp => `
        <tr>
          <td>${exp.category}</td>
          <td>$${exp.amount.toLocaleString()}</td>
          <td>${exp.description || '-'}</td>
          <td>${exp.createdBy}</td>
          <td><span class="badge bg-${exp.status === '已核准' ? 'success' : 'warning'}">${exp.status}</span></td>
          <td>${new Date(exp.createdAt).toLocaleDateString('zh-TW')}</td>
          <td>
            ${exp.status !== '已核准' ? 
              `<button class="btn btn-sm btn-success" onclick="approveExpense('${exp.id}')">
                <i class="bi bi-check"></i> 核准
              </button>` : ''}
            <button class="btn btn-sm btn-danger" onclick="deleteExpense('${exp.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
      
      if ($.fn.DataTable.isDataTable('#expensesTable')) {
        $('#expensesTable').DataTable().destroy();
      }
      $('#expensesTable').DataTable({
        language: dataTablesLanguage,
        order: [[5, 'desc']]
      });
    }

    // ========== 確認捐款 ==========
    async function confirmDonation(donationId) {
      if (!confirm('確認此捐款？')) return;
      
      try {
        await callAPI('confirmDonation', { donationId });
        showAlert('捐款已確認', 'success');
        loadFinanceData();
        addLog('確認捐款', `確認捐款 ${donationId}`);
      } catch (error) {
        showAlert('確認失敗', 'danger');
      }
    }

    // ========== 核准支出 ==========
    async function approveExpense(expenseId) {
      if (!confirm('確認核准此支出？')) return;
      
      try {
        await callAPI('approveExpense', { expenseId });
        showAlert('支出已核准', 'success');
        loadFinanceData();
        addLog('核准支出', `核准支出 ${expenseId}`);
      } catch (error) {
        showAlert('核准失敗', 'danger');
      }
    }

    // ========== 刪除支出 ==========
    async function deleteExpense(expenseId) {
      if (!confirm('確定要刪除此支出記錄？')) return;
      
      try {
        await callAPI('deleteExpense', { expenseId });
        showAlert('已刪除', 'success');
        loadFinanceData();
        addLog('刪除支出', `刪除支出 ${expenseId}`);
      } catch (error) {
        showAlert('刪除失敗', 'danger');
      }
    }

    // ========== 載入報表 ==========
    async function loadReports() {
      try {
        const data = await callAPI('getReportsData');
        
        // 會員統計圖表
        createMemberChart(data.memberStats);
        
        // 活動統計圖表
        createActivityChart(data.activityStats);
        
        // 財務統計圖表
        createFinanceChart(data.financeStats);
        
      } catch (error) {
        console.error('載入報表失敗:', error);
      }
    }

    // ========== 建立會員統計圖表 ==========
    function createMemberChart(data) {
      const ctx = document.getElementById('memberStatsChart');
      if (!ctx) return;
      
      if (charts.memberChart) {
        charts.memberChart.destroy();
      }
      
      charts.memberChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.labels || ['病友', '家屬', '志工', '贊助者'],
          datasets: [{
            data: data.values || [0, 0, 0, 0],
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // ========== 建立活動統計圖表 ==========
    function createActivityChart(data) {
      const ctx = document.getElementById('activityStatsChart');
      if (!ctx) return;
      
      if (charts.activityChart) {
        charts.activityChart.destroy();
      }
      
      charts.activityChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels || [],
          datasets: [{
            label: '參與人數',
            data: data.values || [],
            backgroundColor: '#36A2EB'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // ========== 建立財務統計圖表 ==========
    function createFinanceChart(data) {
      const ctx = document.getElementById('financeStatsChart');
      if (!ctx) return;
      
      if (charts.financeChart) {
        charts.financeChart.destroy();
      }
      
      charts.financeChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels || [],
          datasets: [{
            label: '收入',
            data: data.income || [],
            borderColor: '#4BC0C0',
            fill: false
          }, {
            label: '支出',
            data: data.expense || [],
            borderColor: '#FF6384',
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // ========== 載入設定 ==========
    async function loadSettings() {
      try {
        const settings = await callAPI('getSettings');
        
        document.getElementById('settingOrgName').value = settings.orgName || '';
        document.getElementById('settingContactEmail').value = settings.contactEmail || '';
        document.getElementById('settingContactPhone').value = settings.contactPhone || '';
        document.getElementById('settingAddress').value = settings.address || '';
        
      } catch (error) {
        console.error('載入設定失敗:', error);
      }
    }

    // ========== 儲存設定 ==========
    async function handleSaveSettings(e) {
      e.preventDefault();
      
      try {
        await callAPI('updateSettings', {
          orgName: document.getElementById('settingOrgName').value,
          contactEmail: document.getElementById('settingContactEmail').value,
          contactPhone: document.getElementById('settingContactPhone').value,
          address: document.getElementById('settingAddress').value
        });
        
        showAlert('設定已儲存', 'success');
        addLog('更新設定', '更新系統設定');
      } catch (error) {
        showAlert('儲存失敗', 'danger');
      }
    }

    // ========== 載入日誌 ==========
    async function loadLogs() {
      try {
        const logs = await callAPI('getLogs');
        const tbody = document.getElementById('logsTableBody');
        
        if (!logs || logs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center">暫無日誌記錄</td></tr>';
          return;
        }
        
        tbody.innerHTML = logs.map(log => `
          <tr>
            <td>${new Date(log.timestamp).toLocaleString('zh-TW')}</td>
            <td><span class="badge bg-info">${log.action}</span></td>
            <td>${log.description}</td>
            <td>${log.userName}</td>
          </tr>
        `).join('');
        
        if ($.fn.DataTable.isDataTable('#logsTable')) {
          $('#logsTable').DataTable().destroy();
        }
        $('#logsTable').DataTable({
          language: dataTablesLanguage,
          order: [[0, 'desc']]
        });
        
      } catch (error) {
        console.error('載入日誌失敗:', error);
      }
    }

    // ========== 新增日誌 ==========
    async function addLog(action, description) {
      try {
        await callAPI('addLog', { action, description });
      } catch (error) {
        console.error('新增日誌失敗:', error);
      }
    }

    // ========== 表單處理函數 ==========
    async function handleCreateActivity(e) {
      e.preventDefault();
      
      try {
        await callAPI('createActivity', {
          title: document.getElementById('activityTitle').value,
          description: document.getElementById('activityDescription').value,
          date: document.getElementById('activityDate').value,
          time: document.getElementById('activityTime').value,
          location: document.getElementById('activityLocation').value,
          maxParticipants: document.getElementById('activityMaxParticipants').value,
          fee: document.getElementById('activityFee').value
        });
        
        showAlert('活動已建立', 'success');
        bootstrap.Modal.getInstance(document.getElementById('createActivityModal')).hide();
        e.target.reset();
        loadActivities();
        addLog('新增活動', '建立新活動');
      } catch (error) {
        showAlert('建立失敗', 'danger');
      }
    }

    async function handleEditActivity(e) {
      e.preventDefault();
      
      try {
        await callAPI('updateActivity', {
          activityId: document.getElementById('editActivityId').value,
          title: document.getElementById('editActivityTitle').value,
          description: document.getElementById('editActivityDescription').value,
          date: document.getElementById('editActivityDate').value,
          time: document.getElementById('editActivityTime').value,
          location: document.getElementById('editActivityLocation').value,
          maxParticipants: document.getElementById('editActivityMaxParticipants').value,
          fee: document.getElementById('editActivityFee').value,
          status: document.getElementById('editActivityStatus').value
        });
        
        showAlert('活動已更新', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editActivityModal')).hide();
        loadActivities();
        addLog('更新活動', '更新活動資訊');
      } catch (error) {
        showAlert('更新失敗', 'danger');
      }
    }

    async function handleCreateVolunteer(e) {
      e.preventDefault();
      
      try {
        await callAPI('createVolunteerNeed', {
          title: document.getElementById('volunteerTitle').value,
          description: document.getElementById('volunteerDescription').value,
          date: document.getElementById('volunteerDate').value,
          time: document.getElementById('volunteerTime').value,
          needCount: document.getElementById('volunteerNeedCount').value,
          hours: document.getElementById('volunteerHours').value
        });
        
        showAlert('志工需求已建立', 'success');
        bootstrap.Modal.getInstance(document.getElementById('createVolunteerModal')).hide();
        e.target.reset();
        loadVolunteerNeeds();
        addLog('新增志工需求', '建立新志工需求');
      } catch (error) {
        showAlert('建立失敗', 'danger');
      }
    }

    async function handleAddMember(e) {
      e.preventDefault();
      
      try {
        await callAPI('addMember', {
          lineName: document.getElementById('memberLineName').value,
          realName: document.getElementById('memberRealName').value,
          memberType: document.getElementById('memberMemberType').value,
          phone: document.getElementById('memberPhone').value,
          email: document.getElementById('memberEmail').value
        });
        
        showAlert('會員已新增', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addMemberModal')).hide();
        e.target.reset();
        loadMembers();
        addLog('新增會員', '手動新增會員');
      } catch (error) {
        showAlert('新增失敗', 'danger');
      }
    }

    async function handleEditMember(e) {
      e.preventDefault();
      
      try {
        await callAPI('updateMember', {
          lineId: document.getElementById('editMemberLineId').value,
          realName: document.getElementById('editMemberRealName').value,
          memberType: document.getElementById('editMemberMemberType').value,
          phone: document.getElementById('editMemberPhone').value,
          email: document.getElementById('editMemberEmail').value,
          status: document.getElementById('editMemberStatus').value,
          isAdmin: document.getElementById('editMemberIsAdmin').checked
        });
        
        showAlert('會員資料已更新', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editMemberModal')).hide();
        loadMembers();
        addLog('更新會員', '更新會員資料');
      } catch (error) {
        showAlert('更新失敗', 'danger');
      }
    }

    async function handleAddDonation(e) {
      e.preventDefault();
      
      try {
        await callAPI('addDonationByAdmin', {
          lineId: document.getElementById('donationLineId').value,
          category: document.getElementById('donationCategory').value,
          amount: document.getElementById('donationAmount').value,
          description: document.getElementById('donationDescription').value
        });
        
        showAlert('捐款記錄已新增', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addDonationModal')).hide();
        e.target.reset();
        loadFinanceData();
        addLog('新增捐款', '管理員新增捐款記錄');
      } catch (error) {
        showAlert('新增失敗', 'danger');
      }
    }

    async function handleAddExpense(e) {
      e.preventDefault();
      
      try {
        await callAPI('createExpense', {
          category: document.getElementById('expenseCategory').value,
          amount: document.getElementById('expenseAmount').value,
          description: document.getElementById('expenseDescription').value
        });
        
        showAlert('支出記錄已新增', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addExpenseModal')).hide();
        e.target.reset();
        loadFinanceData();
        addLog('新增支出', '新增支出記錄');
      } catch (error) {
        showAlert('新增失敗', 'danger');
      }
    }

    // ========== 編輯會員 ==========
    async function editMember(lineId) {
      try {
        const member = await callAPI('getMember', { lineId });
        
        document.getElementById('editMemberLineId').value = member.lineId;
        document.getElementById('editMemberRealName').value = member.realName || '';
        document.getElementById('editMemberMemberType').value = member.memberType || '';
        document.getElementById('editMemberPhone').value = member.phone || '';
        document.getElementById('editMemberEmail').value = member.email || '';
        document.getElementById('editMemberStatus').value = member.status || '正常';
        document.getElementById('editMemberIsAdmin').checked = member.isAdmin || false;
        
        const modal = new bootstrap.Modal(document.getElementById('editMemberModal'));
        modal.show();
      } catch (error) {
        showAlert('載入會員資料失敗', 'danger');
      }
    }

    // ========== 刪除會員 ==========
    async function deleteMember(lineId) {
      if (!confirm('確定要刪除此會員？此操作無法復原！')) return;
      
      try {
        await callAPI('deleteMember', { lineId });
        showAlert('會員已刪除', 'success');
        loadMembers();
        addLog('刪除會員', `刪除會員 ${lineId}`);
      } catch (error) {
        showAlert('刪除失敗', 'danger');
      }
    }

    // ========== 匯出功能 ==========
    function exportMembers() {
      const table = document.getElementById('membersTable');
      exportTableToCSV(table, '會員資料.csv');
      addLog('匯出資料', '匯出會員資料');
    }

    function exportActivities() {
      const table = document.getElementById('activitiesTable');
      exportTableToCSV(table, '活動資料.csv');
      addLog('匯出資料', '匯出活動資料');
    }

    function exportRegistrations() {
      const table = document.getElementById('registrationsTable');
      exportTableToCSV(table, '報名記錄.csv');
      addLog('匯出資料', '匯出報名記錄');
    }

    function exportDonations() {
      const table = document.getElementById('donationsTable');
      exportTableToCSV(table, '捐款記錄.csv');
      addLog('匯出資料', '匯出捐款記錄');
    }

    function exportExpenses() {
      const table = document.getElementById('expensesTable');
      exportTableToCSV(table, '支出記錄.csv');
      addLog('匯出資料', '匯出支出記錄');
    }

    // ========== CSV 匯出工具 ==========
    function exportTableToCSV(table, filename) {
      const rows = table.querySelectorAll('tr');
      const csv = [];
      
      for (let i = 0; i < rows.length; i++) {
        const row = [];
        const cols = rows[i].querySelectorAll('td, th');
        
        for (let j = 0; j < cols.length - 1; j++) { // 排除最後一欄（操作）
          let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/(\s\s)/gm, ' ');
          data = data.replace(/"/g, '""');
          row.push('"' + data + '"');
        }
        
        csv.push(row.join(','));
      }
      
      const csvFile = new Blob(['\ufeff' + csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const downloadLink = document.createElement('a');
      downloadLink.download = filename;
      downloadLink.href = window.URL.createObjectURL(csvFile);
      downloadLink.style.display = 'none';
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }

    // ========== 工具函數 ==========
    function showLoading(show) {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.style.display = show ? 'flex' : 'none';
      }
    }

    function showAlert(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
      alertDiv.style.zIndex = '9999';
      alertDiv.style.minWidth = '300px';
      alertDiv.style.maxWidth = '90%';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    function getActivityStatusColor(status) {
      const colors = {
        '開放報名': 'success',
        '報名截止': 'warning',
        '已結束': 'secondary',
        '已取消': 'danger'
      };
      return colors[status] || 'secondary';
    }

    function getRegistrationStatusColor(status) {
      const colors = {
        '已報名': 'success',
        '已取消': 'secondary',
        '已完成': 'primary'
      };
      return colors[status] || 'secondary';
    }

    // ========== 啟動應用程式 ==========
    window.addEventListener('load', () => {
      initializeLiff();
    });

    // ========== 批次操作功能 ==========
    function sendBulkNotification() {
      const message = prompt('請輸入要發送的通知訊息：');
      if (!message) return;
      
      if (confirm('確定要發送群發通知給所有會員？')) {
        callAPI('sendBulkNotification', { message })
          .then(() => {
            showAlert('通知已發送', 'success');
            addLog('群發通知', '發送群發通知給所有會員');
          })
          .catch(() => {
            showAlert('發送失敗', 'danger');
          });
      }
    }

    // ========== 備份與還原 ==========
    async function backupData() {
      if (!confirm('確定要備份所有資料？')) return;
      
      try {
        const backup = await callAPI('backupAllData');
        
        const dataStr = JSON.stringify(backup, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const downloadLink = document.createElement('a');
        downloadLink.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
        downloadLink.href = window.URL.createObjectURL(dataBlob);
        downloadLink.click();
        
        showAlert('資料已備份', 'success');
        addLog('備份資料', '執行完整資料備份');
      } catch (error) {
        showAlert('備份失敗', 'danger');
      }
    }

    function restoreData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!confirm('警告：還原資料將覆蓋現有資料，確定要繼續？')) return;
        
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          
          await callAPI('restoreAllData', { backupData: data });
          
          showAlert('資料已還原，請重新整理頁面', 'success');
          addLog('還原資料', '執行資料還原');
          
          setTimeout(() => location.reload(), 2000);
        } catch (error) {
          showAlert('還原失敗：' + error.message, 'danger');
        }
      };
      
      input.click();
    }

    // ========== 登出 ==========
    function logout() {
      if (confirm('確定要登出？')) {
        addLog('登出', '管理員登出系統');
        setTimeout(() => {
          liff.logout();
          window.location.reload();
        }, 500);
      }
    }
  </script>
</body>
</html>
