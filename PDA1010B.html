<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>管理後台 - 帕金森病友會</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #dc3545;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --info-color: #17a2b8;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --dark-color: #343a40;
      --light-bg: #f8f9fa;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--light-bg);
      padding-bottom: 80px;
    }

    /* Loading Screen */
    #loadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Header */
    .admin-header {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .admin-header h1 {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 0;
    }

    .admin-header .subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-top: 5px;
    }

    /* Stats Cards */
    .stats-container {
      padding: 20px 15px;
      margin-top: -30px;
    }

    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 15px;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-card .icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .stat-card.members .icon { color: #007bff; }
    .stat-card.activities .icon { color: #28a745; }
    .stat-card.volunteers .icon { color: #17a2b8; }
    .stat-card.finance .icon { color: #ffc107; }

    .stat-card .number {
      font-size: 2rem;
      font-weight: bold;
      color: var(--dark-color);
    }

    .stat-card .label {
      color: #666;
      font-size: 0.9rem;
    }

    /* Content Area */
    .content-area {
      padding: 20px 15px;
    }

    /* Cards */
    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .card-header {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
      font-weight: bold;
      border: none;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-body {
      padding: 20px;
    }

    /* Tables */
    .table-responsive {
      border-radius: 10px;
      overflow: hidden;
    }

    .table {
      margin-bottom: 0;
    }

    .table thead {
      background: var(--light-bg);
    }

    .table td, .table th {
      vertical-align: middle;
      padding: 12px;
    }

    /* Buttons */
    .btn {
      border-radius: 10px;
      padding: 8px 16px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-sm {
      padding: 5px 12px;
      font-size: 0.875rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #dc3545, #c82333);
      border: none;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }

    /* Badges */
    .badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 500;
      font-size: 0.85rem;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      z-index: 1000;
    }

    .bottom-nav-item {
      flex: 1;
      text-align: center;
      padding: 5px;
      color: #666;
      text-decoration: none;
      transition: all 0.3s;
      cursor: pointer;
    }

    .bottom-nav-item.active {
      color: var(--primary-color);
    }

    .bottom-nav-item i {
      font-size: 1.5rem;
      display: block;
      margin-bottom: 3px;
    }

    .bottom-nav-item span {
      font-size: 0.75rem;
    }

    /* Modal */
    .modal-content {
      border-radius: 20px;
      border: none;
    }

    .modal-header {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
      border-radius: 20px 20px 0 0;
    }

    .modal-header .btn-close {
      filter: brightness(0) invert(1);
    }

    /* Forms */
    .form-control, .form-select {
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      padding: 10px 15px;
      transition: all 0.3s;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.15);
    }

    .form-label {
      font-weight: 600;
      color: var(--dark-color);
      margin-bottom: 8px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 15px;
      opacity: 0.3;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9998;
    }

    .loading-overlay .spinner-border {
      width: 3rem;
      height: 3rem;
      color: white;
    }

    /* Member Item */
    .member-item {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 4px solid #007bff;
    }

    .member-item.inactive {
      border-left-color: #6c757d;
      opacity: 0.7;
    }

    .member-item .member-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .member-item .member-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-right: 15px;
      border: 2px solid #007bff;
    }

    .member-item .member-info h6 {
      margin: 0;
      font-weight: bold;
    }

    .member-item .member-info small {
      color: #666;
    }

    /* Activity Item */
    .activity-item {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 4px solid #28a745;
    }

    .activity-item.closed {
      border-left-color: #dc3545;
    }

    /* Financial Item */
    .financial-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    .financial-item:last-child {
      border-bottom: none;
    }

    .financial-item.income {
      border-left: 4px solid #28a745;
    }

    .financial-item.expense {
      border-left: 4px solid #dc3545;
    }

    /* Search Box */
    .search-box {
      position: relative;
      margin-bottom: 20px;
    }

    .search-box input {
      padding-left: 45px;
    }

    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
    }

    /* Filter Buttons */
    .filter-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .filter-buttons .btn {
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Page Sections */
    .page-section {
      display: none;
    }

    .page-section.active {
      display: block;
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .quick-action-btn {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }

    .quick-action-btn:hover {
      border-color: var(--primary-color);
      transform: translateY(-3px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .quick-action-btn i {
      font-size: 2rem;
      margin-bottom: 10px;
      color: var(--primary-color);
    }

    .quick-action-btn .label {
      font-weight: 600;
      color: var(--dark-color);
    }

    /* Responsive */
    @media (max-width: 576px) {
      .admin-header h1 {
        font-size: 1.2rem;
      }
      
      .stat-card .number {
        font-size: 1.5rem;
      }

      .quick-actions {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingScreen">
    <div class="spinner"></div>
    <p class="mt-3 text-muted">載入中...</p>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- App Container -->
  <div id="appContainer" style="display: none;">
    
    <!-- Header -->
    <div class="admin-header">
      <h1><i class="bi bi-shield-lock-fill"></i> 管理後台</h1>
      <div class="subtitle">帕金森病友會管理系統</div>
    </div>

    <!-- Stats Container -->
    <div class="stats-container">
      <div class="row g-3">
        <div class="col-6">
          <div class="stat-card members">
            <i class="bi bi-people-fill icon"></i>
            <div class="number" id="statMembers">0</div>
            <div class="label">會員數</div>
          </div>
        </div>
        <div class="col-6">
          <div class="stat-card activities">
            <i class="bi bi-calendar-event-fill icon"></i>
            <div class="number" id="statActivities">0</div>
            <div class="label">活動數</div>
          </div>
        </div>
        <div class="col-6">
          <div class="stat-card volunteers">
            <i class="bi bi-hand-thumbs-up-fill icon"></i>
            <div class="number" id="statVolunteers">0</div>
            <div class="label">志工數</div>
          </div>
        </div>
        <div class="col-6">
          <div class="stat-card finance">
            <i class="bi bi-currency-dollar icon"></i>
            <div class="number" id="statBalance">$0</div>
            <div class="label">財務結餘</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="content-area">
      
      <!-- Dashboard Section -->
      <div id="dashboardSection" class="page-section active">
        <h5 class="mb-3"><i class="bi bi-speedometer2"></i> 快速操作</h5>
        
        <div class="quick-actions">
          <div class="quick-action-btn" onclick="switchPage('members')">
            <i class="bi bi-people"></i>
            <div class="label">會員管理</div>
          </div>
          <div class="quick-action-btn" onclick="switchPage('activities')">
            <i class="bi bi-calendar-event"></i>
            <div class="label">活動管理</div>
          </div>
          <div class="quick-action-btn" onclick="switchPage('volunteers')">
            <i class="bi bi-hand-thumbs-up"></i>
            <div class="label">志工管理</div>
          </div>
          <div class="quick-action-btn" onclick="switchPage('finance')">
            <i class="bi bi-wallet2"></i>
            <div class="label">財務管理</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span><i class="bi bi-clock-history"></i> 最近活動</span>
          </div>
          <div class="card-body" id="recentActivitiesContainer">
            <div class="empty-state">
              <i class="bi bi-inbox"></i>
              <p>載入中...</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span><i class="bi bi-person-plus"></i> 最新會員</span>
          </div>
          <div class="card-body" id="recentMembersContainer">
            <div class="empty-state">
              <i class="bi bi-inbox"></i>
              <p>載入中...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Members Section -->
      <div id="membersSection" class="page-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="bi bi-people"></i> 會員管理</h5>
          <button class="btn btn-primary btn-sm" id="btnExportMembers">
            <i class="bi bi-download"></i> 匯出
          </button>
        </div>

        <div class="search-box">
          <i class="bi bi-search"></i>
          <input type="text" class="form-control" id="memberSearch" placeholder="搜尋會員姓名、電話...">
        </div>

        <div class="filter-buttons">
          <button class="btn btn-sm btn-outline-secondary active" data-filter="all">全部</button>
          <button class="btn btn-sm btn-outline-primary" data-filter="病友">病友</button>
          <button class="btn btn-sm btn-outline-success" data-filter="家屬">家屬</button>
          <button class="btn btn-sm btn-outline-info" data-filter="志工">志工</button>
          <button class="btn btn-sm btn-outline-warning" data-filter="贊助者">贊助者</button>
        </div>

        <div id="membersContainer">
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>

      <!-- Activities Section -->
      <div id="activitiesSection" class="page-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="bi bi-calendar-event"></i> 活動管理</h5>
          <button class="btn btn-primary btn-sm" id="btnCreateActivity">
            <i class="bi bi-plus-circle"></i> 新增
          </button>
        </div>

        <div class="filter-buttons">
          <button class="btn btn-sm btn-outline-secondary active" data-filter-activity="all">全部</button>
          <button class="btn btn-sm btn-outline-success" data-filter-activity="開放報名">開放報名</button>
          <button class="btn btn-sm btn-outline-warning" data-filter-activity="報名截止">報名截止</button>
          <button class="btn btn-sm btn-outline-danger" data-filter-activity="已結束">已結束</button>
        </div>

        <div id="activitiesContainer">
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>

      <!-- Volunteers Section -->
      <div id="volunteersSection" class="page-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="bi bi-hand-thumbs-up"></i> 志工管理</h5>
          <button class="btn btn-primary btn-sm" id="btnCreateVolunteerNeed">
            <i class="bi bi-plus-circle"></i> 新增需求
          </button>
        </div>

        <div class="card mb-3">
          <div class="card-header">志工需求列表</div>
          <div class="card-body" id="volunteerNeedsContainer">
            <div class="empty-state">
              <i class="bi bi-inbox"></i>
              <p>載入中...</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">志工服務記錄</div>
          <div class="card-body" id="volunteerRecordsContainer">
            <div class="empty-state">
              <i class="bi bi-inbox"></i>
              <p>載入中...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Finance Section -->
      <div id="financeSection" class="page-section">
        <h5 class="mb-3"><i class="bi bi-wallet2"></i> 財務管理</h5>

        <div class="card mb-3">
          <div class="card-header">財務總覽</div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-4">
                <h4 class="text-success mb-0" id="totalIncome">$0</h4>
                <small class="text-muted">總收入</small>
              </div>
              <div class="col-4">
                <h4 class="text-danger mb-0" id="totalExpense">$0</h4>
                <small class="text-muted">總支出</small>
              </div>
              <div class="col-4">
                <h4 class="text-primary mb-0" id="totalBalance">$0</h4>
                <small class="text-muted">結餘</small>
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>捐款記錄</span>
            <button class="btn btn-sm btn-light" id="btnAddDonation">
              <i class="bi bi-plus"></i> 新增
            </button>
          </div>
          <div class="card-body" id="donationsContainer">
            <div class="empty-state">
              <i class="bi bi-inbox"></i>
              <p>載入中...</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>支出記錄</span>
            <button class="btn btn-sm btn-light" id="btnAddExpense">
              <i class="bi bi-plus"></i> 新增
            </button>
          </div>
          <div class="card-body" id="expensesContainer">
            <div class="empty-state">
              <i class="bi bi-inbox"></i>
              <p>載入中...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Reports Section -->
      <div id="reportsSection" class="page-section">
        <h5 class="mb-3"><i class="bi bi-file-earmark-bar-graph"></i> 報表統計</h5>

        <div class="card mb-3">
          <div class="card-header">會員統計</div>
          <div class="card-body">
            <canvas id="memberChart"></canvas>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header">活動參與統計</div>
          <div class="card-body">
            <canvas id="activityChart"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">財務統計</div>
          <div class="card-body">
            <canvas id="financeChart"></canvas>
          </div>
        </div>
      </div>

    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <a class="bottom-nav-item active" data-page="dashboard">
        <i class="bi bi-speedometer2"></i>
        <span>儀表板</span>
      </a>
      <a class="bottom-nav-item" data-page="members">
        <i class="bi bi-people"></i>
        <span>會員</span>
      </a>
      <a class="bottom-nav-item" data-page="activities">
        <i class="bi bi-calendar-event"></i>
        <span>活動</span>
      </a>
      <a class="bottom-nav-item" data-page="volunteers">
        <i class="bi bi-hand-thumbs-up"></i>
        <span>志工</span>
      </a>
      <a class="bottom-nav-item" data-page="finance">
        <i class="bi bi-wallet2"></i>
        <span>財務</span>
      </a>
    </div>

  </div>

  <!-- Modals -->

  <!-- Edit Member Modal -->
  <div class="modal fade" id="editMemberModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-person-gear"></i> 編輯會員</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editMemberForm">
            <input type="hidden" id="editMemberId">
            
            <div class="mb-3">
              <label class="form-label">真實姓名 *</label>
              <input type="text" class="form-control" id="editMemberName" required>
            </div>

            <div class="mb-3">
              <label class="form-label">會員類型 *</label>
              <select class="form-select" id="editMemberType" required>
                <option value="病友">病友</option>
                <option value="家屬">家屬</option>
                <option value="志工">志工</option>
                <option value="贊助者">贊助者</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">電話</label>
              <input type="tel" class="form-control" id="editMemberPhone">
            </div>

            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="editMemberEmail">
            </div>

            <div class="mb-3">
              <label class="form-label">狀態 *</label>
              <select class="form-select" id="editMemberStatus" required>
                <option value="正常">正常</option>
                <option value="停權">停權</option>
              </select>
            </div>

            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="editMemberIsAdmin">
                <label class="form-check-label" for="editMemberIsAdmin">
                  設為管理員
                </label>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">備註</label>
              <textarea class="form-control" id="editMemberNotes" rows="3"></textarea>
            </div>

            <button type="submit" class="btn btn-primary w-100">儲存變更</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- View Activity Details Modal -->
  <div class="modal fade" id="activityDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-info-circle"></i> 活動詳情</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="activityDetailsContent">
          <!-- 動態載入內容 -->
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Activity Modal -->
  <div class="modal fade" id="editActivityModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil"></i> 編輯活動</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editActivityForm">
            <input type="hidden" id="editActivityId">
            
            <div class="mb-3">
              <label class="form-label">活動名稱 *</label>
              <input type="text" class="form-control" id="editActivityTitle" required>
            </div>

            <div class="mb-3">
              <label class="form-label">活動說明</label>
              <textarea class="form-control" id="editActivityDescription" rows="3"></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">活動日期 *</label>
              <input type="date" class="form-control" id="editActivityDate" required>
            </div>

            <div class="mb-3">
              <label class="form-label">活動時間</label>
              <input type="time" class="form-control" id="editActivityTime">
            </div>

            <div class="mb-3">
              <label class="form-label">活動地點</label>
              <input type="text" class="form-control" id="editActivityLocation">
            </div>

            <div class="mb-3">
              <label class="form-label">人數上限 *</label>
              <input type="number" class="form-control" id="editActivityMaxParticipants" min="1" required>
            </div>

            <div class="mb-3">
              <label class="form-label">活動費用</label>
              <input type="number" class="form-control" id="editActivityFee" min="0" value="0">
            </div>

            <div class="mb-3">
              <label class="form-label">活動狀態 *</label>
              <select class="form-select" id="editActivityStatus" required>
                <option value="開放報名">開放報名</option>
                <option value="報名截止">報名截止</option>
                <option value="已結束">已結束</option>
                <option value="已取消">已取消</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary w-100">儲存變更</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Donation Modal -->
  <div class="modal fade" id="addDonationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-currency-dollar"></i> 新增捐款</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addDonationForm">
            <div class="mb-3">
              <label class="form-label">捐款人 LINE ID</label>
              <input type="text" class="form-control" id="donationLineId" placeholder="選填，可留空">
            </div>

            <div class="mb-3">
              <label class="form-label">捐款類別 *</label>
              <select class="form-select" id="donationCategory" required>
                <option value="">請選擇</option>
                <option value="一般捐款">一般捐款</option>
                <option value="活動贊助">活動贊助</option>
                <option value="設備捐贈">設備捐贈</option>
                <option value="其他">其他</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">捐款金額 *</label>
              <input type="number" class="form-control" id="donationAmount" min="1" required>
            </div>

            <div class="mb-3">
              <label class="form-label">說明</label>
              <textarea class="form-control" id="donationDescription" rows="2"></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">狀態 *</label>
              <select class="form-select" id="donationStatus" required>
                <option value="待確認">待確認</option>
                <option value="已確認">已確認</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary w-100">新增捐款</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Expense Modal -->
  <div class="modal fade" id="addExpenseModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-receipt"></i> 新增支出</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addExpenseForm">
            <div class="mb-3">
              <label class="form-label">支出類別 *</label>
              <select class="form-select" id="expenseCategory" required>
                <option value="">請選擇</option>
                <option value="活動費用">活動費用</option>
                <option value="行政支出">行政支出</option>
                <option value="設備支出">設備支出</option>
                <option value="其他">其他</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">支出金額 *</label>
              <input type="number" class="form-control" id="expenseAmount" min="1" required>
            </div>

            <div class="mb-3">
              <label class="form-label">說明</label>
              <textarea class="form-control" id="expenseDescription" rows="2"></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">狀態 *</label>
              <select class="form-select" id="expenseStatus" required>
                <option value="待核准">待核准</option>
                <option value="已核准">已核准</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary w-100">新增支出</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // ========== 全域變數 ==========
    const CONFIG = {
      LIFF_ID: '1656516134-k8rMQwnQ', // ⚠️ 請替換為您的管理後台 LIFF ID
      API_URL: 'https://script.google.com/macros/s/AKfycbzgWX10UKj7PqokWRMANjLRYm1XustRR00pYSMS8bqMzdV1455ei-y3N_4q-N34n_HJng/exec', // ⚠️ 請替換為您的 GAS URL
      API_KEY: 'AAbb8520258185202581'
    };

    let currentUser = null;
    let allMembers = [];
    let allActivities = [];
    let allVolunteerNeeds = [];
    let allDonations = [];
    let allExpenses = [];

    // ========== LIFF 初始化 ==========
    async function initializeLiff() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        currentUser = {
          lineId: profile.userId,
          lineName: profile.displayName
        };

        await checkAdminPermission();
        
      } catch (error) {
        console.error('LIFF 初始化失敗:', error);
        showAlert('系統初始化失敗，請重新整理頁面', 'danger');
      }
    }

    // ========== 檢查管理員權限 ==========
    async function checkAdminPermission() {
      try {
        const userData = await callAPI('getUserInfo');
        
        if (!userData || !userData.isAdmin) {
          alert('您沒有管理員權限！');
          liff.closeWindow();
          return;
        }

        currentUser = { ...currentUser, ...userData };
        await loadAllData();
        initializeApp();
        
      } catch (error) {
        alert('權限驗證失敗！');
        liff.closeWindow();
      }
    }

    // ========== API 呼叫函數 ==========
    async function callAPI(action, data = {}) {
      showLoading(true);
      try {
        const response = await fetch(CONFIG.API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action,
            apiKey: CONFIG.API_KEY,
            lineId: currentUser?.lineId || '',
            ...data
          })
        });

        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || '操作失敗');
        }

        return result.data;
      } catch (error) {
        console.error('API 呼叫失敗:', error);
        showAlert(error.message || 'API 呼叫失敗', 'danger');
        throw error;
      } finally {
        showLoading(false);
      }
    }

    // ========== 載入所有數據 ==========
    async function loadAllData() {
      try {
        const [members, activities, volunteers, donations, expenses, stats] = await Promise.all([
          callAPI('getAllMembers'),
          callAPI('getActivities'),
          callAPI('getVolunteerNeeds'),
          callAPI('getAllDonations'),
          callAPI('getAllExpenses'),
          callAPI('getAdminStats')
        ]);

        allMembers = members || [];
        allActivities = activities || [];
        allVolunteerNeeds = volunteers || [];
        allDonations = donations || [];
        allExpenses = expenses || [];

        updateStats(stats);
        
      } catch (error) {
        console.error('載入數據失敗:', error);
      }
    }

    // ========== 更新統計數據 ==========
    function updateStats(stats) {
      if (!stats) return;
      
      document.getElementById('statMembers').textContent = stats.totalMembers || 0;
      document.getElementById('statActivities').textContent = stats.totalActivities || 0;
      document.getElementById('statVolunteers').textContent = stats.totalVolunteers || 0;
      document.getElementById('statBalance').textContent = '$' + (stats.balance || 0).toLocaleString();
    }

    // ========== 初始化應用程式 ==========
    function initializeApp() {
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('appContainer').style.display = 'block';
      
      setupEventListeners();
      loadDashboard();
    }

    // ========== 載入儀表板 ==========
    function loadDashboard() {
      // 最近活動
      const recentActivities = allActivities.slice(0, 5);
      const activitiesContainer = document.getElementById('recentActivitiesContainer');
      
      if (recentActivities.length === 0) {
        activitiesContainer.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有活動</p></div>';
      } else {
        activitiesContainer.innerHTML = recentActivities.map(act => `
          <div class="mb-2 pb-2 border-bottom">
            <h6 class="mb-1">${act.title}</h6>
            <small class="text-muted">
              <i class="bi bi-calendar"></i> ${act.date}
              <span class="badge bg-${act.status === '開放報名' ? 'success' : 'secondary'} ms-2">${act.status}</span>
            </small>
          </div>
        `).join('');
      }

      // 最新會員
      const recentMembers = allMembers.slice(0, 5);
      const membersContainer = document.getElementById('recentMembersContainer');
      
      if (recentMembers.length === 0) {
        membersContainer.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有會員</p></div>';
      } else {
        membersContainer.innerHTML = recentMembers.map(member => `
          <div class="mb-2 pb-2 border-bottom">
            <h6 class="mb-1">${member.realName || member.lineName}</h6>
            <small class="text-muted">
              <span class="badge bg-primary">${member.memberType || '未設定'}</span>
              ${member.isAdmin ? '<span class="badge bg-danger ms-2">管理員</span>' : ''}
            </small>
          </div>
        `).join('');
      }
    }

    // ========== 載入會員列表 ==========
    function loadMembers(filter = 'all') {
      const container = document.getElementById('membersContainer');
      
      let filteredMembers = allMembers;
      if (filter !== 'all') {
        filteredMembers = allMembers.filter(m => m.memberType === filter);
      }

      if (filteredMembers.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>沒有符合條件的會員</p></div>';
        return;
      }

      container.innerHTML = filteredMembers.map(member => `
        <div class="member-item ${member.status === '停權' ? 'inactive' : ''}">
          <div class="member-header">
            <img src="${member.pictureUrl || 'https://via.placeholder.com/50'}" alt="avatar" class="member-avatar">
            <div class="member-info flex-grow-1">
              <h6>${member.realName || member.lineName}</h6>
              <small class="text-muted">
                <i class="bi bi-telephone"></i> ${member.phone || '未提供'}
              </small>
            </div>
          </div>
          <div class="mb-2">
            <span class="badge bg-primary">${member.memberType || '未設定'}</span>
            <span class="badge bg-${member.status === '正常' ? 'success' : 'secondary'}">${member.status || '正常'}</span>
            ${member.isAdmin ? '<span class="badge bg-danger">管理員</span>' : ''}
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="editMember('${member.lineId}')">
              <i class="bi bi-pencil"></i> 編輯
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="viewMemberDetails('${member.lineId}')">
              <i class="bi bi-info-circle"></i> 詳情
            </button>
          </div>
        </div>
      `).join('');
    }

    // ========== 編輯會員 ==========
    function editMember(lineId) {
      const member = allMembers.find(m => m.lineId === lineId);
      if (!member) return;

      document.getElementById('editMemberId').value = member.lineId;
      document.getElementById('editMemberName').value = member.realName || '';
      document.getElementById('editMemberType').value = member.memberType || '';
      document.getElementById('editMemberPhone').value = member.phone || '';
      document.getElementById('editMemberEmail').value = member.email || '';
      document.getElementById('editMemberStatus').value = member.status || '正常';
      document.getElementById('editMemberIsAdmin').checked = member.isAdmin || false;
      document.getElementById('editMemberNotes').value = member.notes || '';

      const modal = new bootstrap.Modal(document.getElementById('editMemberModal'));
      modal.show();
    }

    // ========== 查看會員詳情 ==========
    function viewMemberDetails(lineId) {
      const member = allMembers.find(m => m.lineId === lineId);
      if (!member) return;

      const info = `
        <div class="alert alert-info">
          <h5>${member.realName || member.lineName}</h5>
          <hr>
          <p><strong>LINE 名稱：</strong>${member.lineName}</p>
          <p><strong>會員類型：</strong>${member.memberType || '未設定'}</p>
          <p><strong>電話：</strong>${member.phone || '未提供'}</p>
          <p><strong>Email：</strong>${member.email || '未提供'}</p>
          <p><strong>狀態：</strong>${member.status || '正常'}</p>
          <p><strong>註冊時間：</strong>${member.createdAt ? new Date(member.createdAt).toLocaleString('zh-TW') : '未知'}</p>
          ${member.notes ? `<p><strong>備註：</strong>${member.notes}</p>` : ''}
        </div>
      `;

      showAlert(info, 'info');
    }

    // ========== 載入活動列表 ==========
    function loadActivities(filter = 'all') {
      const container = document.getElementById('activitiesContainer');
      
      let filteredActivities = allActivities;
      if (filter !== 'all') {
        filteredActivities = allActivities.filter(a => a.status === filter);
      }

      if (filteredActivities.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>沒有符合條件的活動</p></div>';
        return;
      }

      container.innerHTML = filteredActivities.map(act => `
        <div class="activity-item ${act.status === '已結束' || act.status === '已取消' ? 'closed' : ''}">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="mb-0">${act.title}</h6>
            <span class="badge bg-${act.status === '開放報名' ? 'success' : 'secondary'}">${act.status}</span>
          </div>
          <p class="text-muted mb-2">${act.description || '無說明'}</p>
          <div class="mb-2">
            <small>
              <i class="bi bi-calendar"></i> ${act.date} ${act.time || ''}
              <br>
              <i class="bi bi-geo-alt"></i> ${act.location || '待定'}
              <br>
              <i class="bi bi-people"></i> ${act.currentParticipants || 0}/${act.maxParticipants} 人
            </small>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" onclick="editActivity('${act.id}')">
              <i class="bi bi-pencil"></i> 編輯
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="viewActivityDetails('${act.id}')">
              <i class="bi bi-info-circle"></i> 詳情
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteActivity('${act.id}')">
              <i class="bi bi-trash"></i> 刪除
            </button>
          </div>
        </div>
      `).join('');
    }

    // ========== 編輯活動 ==========
    function editActivity(activityId) {
      const activity = allActivities.find(a => a.id === activityId);
      if (!activity) return;

      document.getElementById('editActivityId').value = activity.id;
      document.getElementById('editActivityTitle').value = activity.title;
      document.getElementById('editActivityDescription').value = activity.description || '';
      document.getElementById('editActivityDate').value = activity.date;
      document.getElementById('editActivityTime').value = activity.time || '';
      document.getElementById('editActivityLocation').value = activity.location || '';
      document.getElementById('editActivityMaxParticipants').value = activity.maxParticipants;
      document.getElementById('editActivityFee').value = activity.fee || 0;
      document.getElementById('editActivityStatus').value = activity.status;

      const modal = new bootstrap.Modal(document.getElementById('editActivityModal'));
      modal.show();
    }

    // ========== 查看活動詳情 ==========
    async function viewActivityDetails(activityId) {
      try {
        const details = await callAPI('getActivityDetails', { activityId });
        
        const content = `
          <h5>${details.activity.title}</h5>
          <p>${details.activity.description || '無說明'}</p>
          <hr>
          <p><strong>日期：</strong>${details.activity.date} ${details.activity.time || ''}</p>
          <p><strong>地點：</strong>${details.activity.location || '待定'}</p>
          <p><strong>人數：</strong>${details.activity.currentParticipants || 0}/${details.activity.maxParticipants}</p>
          <p><strong>費用：</strong>$${details.activity.fee || 0}</p>
          <p><strong>狀態：</strong>${details.activity.status}</p>
          <hr>
          <h6>報名名單 (${details.registrations.length}人)</h6>
          <div class="list-group">
            ${details.registrations.map(reg => `
              <div class="list-group-item">
                <div class="d-flex justify-content-between">
                  <span>${reg.memberName}</span>
                  <span class="badge bg-${reg.status === '已報名' ? 'success' : 'secondary'}">${reg.status}</span>
                </div>
                <small class="text-muted">${new Date(reg.createdAt).toLocaleString('zh-TW')}</small>
              </div>
            `).join('')}
          </div>
        `;

        document.getElementById('activityDetailsContent').innerHTML = content;
        const modal = new bootstrap.Modal(document.getElementById('activityDetailsModal'));
        modal.show();
      } catch (error) {
        showAlert('載入活動詳情失敗', 'danger');
      }
    }

    // ========== 刪除活動 ==========
    async function deleteActivity(activityId) {
      if (!confirm('確定要刪除此活動嗎？此操作無法復原！')) return;

      try {
        await callAPI('deleteActivity', { activityId });
        showAlert('活動已刪除', 'success');
        await loadAllData();
        loadActivities();
      } catch (error) {
        showAlert('刪除失敗：' + error.message, 'danger');
      }
    }

    // ========== 載入志工管理 ==========
    function loadVolunteers() {
      // 志工需求
      const needsContainer = document.getElementById('volunteerNeedsContainer');
      
      if (allVolunteerNeeds.length === 0) {
        needsContainer.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有志工需求</p></div>';
      } else {
        needsContainer.innerHTML = allVolunteerNeeds.map(need => `
          <div class="activity-item mb-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="mb-0">${need.title}</h6>
              <span class="badge bg-${need.status === '招募中' ? 'success' : 'secondary'}">${need.status}</span>
            </div>
            <p class="text-muted mb-2">${need.description || '無說明'}</p>
            <div class="mb-2">
              <small>
                <i class="bi bi-calendar"></i> ${need.date} ${need.time || ''}
                <br>
                <i class="bi bi-people"></i> ${need.currentCount || 0}/${need.needCount} 人
                <br>
                <i class="bi bi-clock"></i> ${need.hours} 小時
              </small>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteVolunteerNeed('${need.id}')">
              <i class="bi bi-trash"></i> 刪除
            </button>
          </div>
        `).join('');
      }

      // 志工記錄 - 需要從 API 獲取所有志工記錄
      loadAllVolunteerRecords();
    }

    // ========== 載入所有志工記錄 ==========
    async function loadAllVolunteerRecords() {
      try {
        const records = await callAPI('getAllVolunteerRecords');
        const container = document.getElementById('volunteerRecordsContainer');
        
        if (!records || records.length === 0) {
          container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有志工記錄</p></div>';
          return;
        }

        container.innerHTML = records.map(rec => `
          <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
            <div>
              <h6 class="mb-1">${rec.memberName}</h6>
              <small class="text-muted">
                ${rec.title || '志工服務'} | ${rec.hours} 小時
                <br>
                ${new Date(rec.createdAt).toLocaleDateString('zh-TW')}
              </small>
            </div>
            <span class="badge bg-${rec.status === '已完成' ? 'success' : 'primary'}">${rec.status}</span>
          </div>
        `).join('');
      } catch (error) {
        console.error('載入志工記錄失敗:', error);
      }
    }

    // ========== 刪除志工需求 ==========
    async function deleteVolunteerNeed(needId) {
      if (!confirm('確定要刪除此志工需求嗎？')) return;

      try {
        await callAPI('deleteVolunteerNeed', { needId });
        showAlert('志工需求已刪除', 'success');
        await loadAllData();
        loadVolunteers();
      } catch (error) {
        showAlert('刪除失敗：' + error.message, 'danger');
      }
    }

    // ========== 載入財務管理 ==========
    function loadFinance() {
      // 計算財務總覽
      let totalIncome = 0;
      let totalExpense = 0;

      allDonations.forEach(don => {
        if (don.status === '已確認') {
          totalIncome += don.amount || 0;
        }
      });

      allExpenses.forEach(exp => {
        if (exp.status === '已核准') {
          totalExpense += exp.amount || 0;
        }
      });

      const balance = totalIncome - totalExpense;

      document.getElementById('totalIncome').textContent = '$' + totalIncome.toLocaleString();
      document.getElementById('totalExpense').textContent = '$' + totalExpense.toLocaleString();
      document.getElementById('totalBalance').textContent = '$' + balance.toLocaleString();

      // 捐款記錄
      const donationsContainer = document.getElementById('donationsContainer');
      
      if (allDonations.length === 0) {
        donationsContainer.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有捐款記錄</p></div>';
      } else {
        donationsContainer.innerHTML = allDonations.map(don => `
          <div class="financial-item income">
            <div>
              <h6 class="mb-1">${don.category}</h6>
              <small class="text-muted">
                ${don.memberName || '匿名'}
                <br>
                ${new Date(don.createdAt).toLocaleDateString('zh-TW')}
                <br>
                ${don.description || ''}
              </small>
            </div>
            <div class="text-end">
              <h6 class="text-success mb-1">$${don.amount.toLocaleString()}</h6>
              <span class="badge bg-${don.status === '已確認' ? 'success' : 'warning'}">${don.status}</span>
            </div>
          </div>
        `).join('');
      }

      // 支出記錄
      const expensesContainer = document.getElementById('expensesContainer');
      
      if (allExpenses.length === 0) {
        expensesContainer.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有支出記錄</p></div>';
      } else {
        expensesContainer.innerHTML = allExpenses.map(exp => `
          <div class="financial-item expense">
            <div>
              <h6 class="mb-1">${exp.category}</h6>
              <small class="text-muted">
                ${new Date(exp.createdAt).toLocaleDateString('zh-TW')}
                <br>
                ${exp.description || ''}
              </small>
            </div>
            <div class="text-end">
              <h6 class="text-danger mb-1">$${exp.amount.toLocaleString()}</h6>
              <span class="badge bg-${exp.status === '已核准' ? 'success' : 'warning'}">${exp.status}</span>
            </div>
          </div>
        `).join('');
      }
    }

    // ========== 設置事件監聽器 ==========
    function setupEventListeners() {
      // 底部導航
      document.querySelectorAll('.bottom-nav-item').forEach(item => {
        item.addEventListener('click', function() {
          const page = this.dataset.page;
          switchPage(page);
        });
      });

      // 會員搜尋
      document.getElementById('memberSearch').addEventListener('input', function(e) {
        const keyword = e.target.value.toLowerCase();
        const filtered = allMembers.filter(m => 
          (m.realName && m.realName.toLowerCase().includes(keyword)) ||
          (m.lineName && m.lineName.toLowerCase().includes(keyword)) ||
          (m.phone && m.phone.includes(keyword))
        );
        renderFilteredMembers(filtered);
      });

      // 會員篩選按鈕
      document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          loadMembers(this.dataset.filter);
        });
      });

      // 活動篩選按鈕
      document.querySelectorAll('[data-filter-activity]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-filter-activity]').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          loadActivities(this.dataset.filterActivity);
        });
      });

      // 編輯會員表單
      document.getElementById('editMemberForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
          await callAPI('updateMember', {
            targetLineId: document.getElementById('editMemberId').value,
            realName: document.getElementById('editMemberName').value,
            memberType: document.getElementById('editMemberType').value,
            phone: document.getElementById('editMemberPhone').value,
            email: document.getElementById('editMemberEmail').value,
            status: document.getElementById('editMemberStatus').value,
            isAdmin: document.getElementById('editMemberIsAdmin').checked,
            notes: document.getElementById('editMemberNotes').value
          });
          
          showAlert('會員資料已更新', 'success');
          bootstrap.Modal.getInstance(document.getElementById('editMemberModal')).hide();
          await loadAllData();
          loadMembers();
        } catch (error) {
          showAlert('更新失敗：' + error.message, 'danger');
        }
      });

      // 編輯活動表單
      document.getElementById('editActivityForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
          await callAPI('updateActivity', {
            activityId: document.getElementById('editActivityId').value,
            title: document.getElementById('editActivityTitle').value,
            description: document.getElementById('editActivityDescription').value,
            date: document.getElementById('editActivityDate').value,
            time: document.getElementById('editActivityTime').value,
            location: document.getElementById('editActivityLocation').value,
            maxParticipants: document.getElementById('editActivityMaxParticipants').value,
            fee: document.getElementById('editActivityFee').value,
            status: document.getElementById('editActivityStatus').value
          });
          
          showAlert('活動已更新', 'success');
          bootstrap.Modal.getInstance(document.getElementById('editActivityModal')).hide();
          await loadAllData();
          loadActivities();
        } catch (error) {
          showAlert('更新失敗：' + error.message, 'danger');
        }
      });

      // 新增活動按鈕
      const btnCreateActivity = document.getElementById('btnCreateActivity');
      if (btnCreateActivity) {
        btnCreateActivity.addEventListener('click', () => {
          // 跳轉到前台新增活動
          liff.openWindow({
            url: 'https://liff.line.me/2006559832-8rMQwnQ', // ⚠️ 請替換為前台 LIFF URL
            external: false
          });
        });
      }

      // 新增志工需求按鈕
      const btnCreateVolunteerNeed = document.getElementById('btnCreateVolunteerNeed');
      if (btnCreateVolunteerNeed) {
        btnCreateVolunteerNeed.addEventListener('click', () => {
          liff.openWindow({
            url: 'https://liff.line.me/2006559832-8rMQwnQ',
            external: false
          });
        });
      }

      // 新增捐款按鈕
      document.getElementById('btnAddDonation').addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('addDonationModal'));
        modal.show();
      });

      // 新增捐款表單
      document.getElementById('addDonationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
          await callAPI('createDonationByAdmin', {
            lineId: document.getElementById('donationLineId').value || null,
            category: document.getElementById('donationCategory').value,
            amount: document.getElementById('donationAmount').value,
            description: document.getElementById('donationDescription').value,
            status: document.getElementById('donationStatus').value
          });
          
          showAlert('捐款記錄已建立', 'success');
          bootstrap.Modal.getInstance(document.getElementById('addDonationModal')).hide();
          document.getElementById('addDonationForm').reset();
          await loadAllData();
          loadFinance();
        } catch (error) {
          showAlert('建立失敗：' + error.message, 'danger');
        }
      });

      // 新增支出按鈕
      document.getElementById('btnAddExpense').addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('addExpenseModal'));
        modal.show();
      });

      // 新增支出表單
      document.getElementById('addExpenseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
          await callAPI('createExpense', {
            category: document.getElementById('expenseCategory').value,
            amount: document.getElementById('expenseAmount').value,
            description: document.getElementById('expenseDescription').value,
            status: document.getElementById('expenseStatus').value
          });
          
          showAlert('支出記錄已建立', 'success');
          bootstrap.Modal.getInstance(document.getElementById('addExpenseModal')).hide();
          document.getElementById('addExpenseForm').reset();
          await loadAllData();
          loadFinance();
        } catch (error) {
          showAlert('建立失敗：' + error.message, 'danger');
        }
      });

      // 匯出會員按鈕
      const btnExportMembers = document.getElementById('btnExportMembers');
      if (btnExportMembers) {
        btnExportMembers.addEventListener('click', exportMembers);
      }
    }

    // ========== 渲染篩選後的會員 ==========
    function renderFilteredMembers(members) {
      const container = document.getElementById('membersContainer');
      
      if (members.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>沒有符合條件的會員</p></div>';
        return;
      }

      container.innerHTML = members.map(member => `
        <div class="member-item ${member.status === '停權' ? 'inactive' : ''}">
          <div class="member-header">
            <img src="${member.pictureUrl || 'https://via.placeholder.com/50'}" alt="avatar" class="member-avatar">
            <div class="member-info flex-grow-1">
              <h6>${member.realName || member.lineName}</h6>
              <small class="text-muted">
                <i class="bi bi-telephone"></i> ${member.phone || '未提供'}
              </small>
            </div>
          </div>
          <div class="mb-2">
            <span class="badge bg-primary">${member.memberType || '未設定'}</span>
            <span class="badge bg-${member.status === '正常' ? 'success' : 'secondary'}">${member.status || '正常'}</span>
            ${member.isAdmin ? '<span class="badge bg-danger">管理員</span>' : ''}
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="editMember('${member.lineId}')">
              <i class="bi bi-pencil"></i> 編輯
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="viewMemberDetails('${member.lineId}')">
              <i class="bi bi-info-circle"></i> 詳情
            </button>
          </div>
        </div>
      `).join('');
    }

    // ========== 匯出會員資料 ==========
    function exportMembers() {
      if (allMembers.length === 0) {
        showAlert('目前沒有會員資料可匯出', 'warning');
        return;
      }

      // 準備 CSV 資料
      const headers = ['姓名', '會員類型', '電話', 'Email', '狀態', '管理員', '註冊時間'];
      const rows = allMembers.map(m => [
        m.realName || m.lineName,
        m.memberType || '未設定',
        m.phone || '',
        m.email || '',
        m.status || '正常',
        m.isAdmin ? '是' : '否',
        m.createdAt ? new Date(m.createdAt).toLocaleString('zh-TW') : ''
      ]);

      let csvContent = '\uFEFF'; // UTF-8 BOM
      csvContent += headers.join(',') + '\n';
      rows.forEach(row => {
        csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
      });

      // 下載檔案
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `會員資料_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showAlert('會員資料已匯出', 'success');
    }

    // ========== 頁面切換 ==========
    function switchPage(page) {
      // 更新導航狀態
      document.querySelectorAll('.bottom-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-page="${page}"]`).classList.add('active');
      
      // 隱藏所有頁面
      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // 顯示選中的頁面
      const sectionMap = {
        'dashboard': 'dashboardSection',
        'members': 'membersSection',
        'activities': 'activitiesSection',
        'volunteers': 'volunteersSection',
        'finance': 'financeSection',
        'reports': 'reportsSection'
      };
      
      const sectionId = sectionMap[page];
      if (sectionId) {
        document.getElementById(sectionId).classList.add('active');
        
        // 載入對應數據
        switch(page) {
          case 'dashboard':
            loadDashboard();
            break;
          case 'members':
            loadMembers();
            break;
          case 'activities':
            loadActivities();
            break;
          case 'volunteers':
            loadVolunteers();
            break;
          case 'finance':
            loadFinance();
            break;
          case 'reports':
            loadReports();
            break;
        }
      }
    }

    // ========== 載入報表（預留功能） ==========
    function loadReports() {
      // 可以使用 Chart.js 繪製統計圖表
      showAlert('報表功能開發中', 'info');
    }

    // ========== 工具函數 ==========
    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function showAlert(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
      alertDiv.style.zIndex = '9999';
      alertDiv.style.minWidth = '300px';
      alertDiv.style.maxWidth = '90%';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    // ========== 啟動應用程式 ==========
    window.addEventListener('load', () => {
      initializeLiff();
    });
  </script>
</body>
</html>

