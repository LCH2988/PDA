<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BOGO æ¶è³¼å®Œæ•´åˆ†æç³»çµ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 30px;
      text-align: center;
    }
    
    .header h1 {
      color: #667eea;
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .card h2 {
      color: #667eea;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .stat-card h3 {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }
    
    .btn {
      padding: 12px 30px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .btn:hover {
      background: #5568d3;
    }
    
    .btn-success {
      background: #10b981;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-export {
      background: #f59e0b;
    }
    
    .btn-export:hover {
      background: #d97706;
    }
    
    input[type="text"] {
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      width: 100%;
      max-width: 700px;
    }
    
    .filter-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 20px;
    }
    
    select {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
      margin-top: 20px;
    }
    
    thead {
      background: #667eea;
      color: white;
    }
    
    th, td {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    
    tbody tr:hover {
      background: #f8f9ff;
    }
    
    .team-section {
      background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #8b5cf6;
    }
    
    .team-section h3 {
      color: #6b21a8;
      margin-bottom: 15px;
    }
    
    .person-block {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .person-header {
      font-size: 1.1em;
      font-weight: bold;
      color: #374151;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .product-row {
      display: grid;
      grid-template-columns: 100px 200px 100px 120px 100px;
      gap: 15px;
      padding: 8px 0;
      align-items: center;
    }
    
    .product-row.header {
      font-weight: bold;
      color: #666;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .total-row {
      background: #fef3c7;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      font-weight: bold;
      text-align: right;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 600;
    }
    
    .badge-1a {
      background: #d1fae5;
      color: #065f46;
    }
    
    .badge-1b {
      background: #fef3c7;
      color: #92400e;
    }
    
    .badge-team {
      background: #e9d5ff;
      color: #6b21a8;
    }
    
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }
    
    .loading.show {
      display: flex;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    .loading-text {
      color: white;
      font-size: 1.2em;
      font-weight: 600;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .alert {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .alert-success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .alert-error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .alert-info {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .tab-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      color: #6b7280;
      border-bottom: 3px solid transparent;
    }
    
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .summary-box {
      background: #f0f9ff;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .table-container {
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .info-box {
      background: #f0f9ff;
      border-left: 4px solid #3b82f6;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    .step-list {
      margin-top: 10px;
      padding-left: 20px;
      line-height: 1.8;
    }
    
    .example-url {
      background: #f3f4f6;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 0.9em;
      margin-top: 10px;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">è¼‰å…¥ä¸­...</div>
  </div>
  
  <div class="container">
    <div class="header">
      <h1>ğŸ¯ BOGO æ¶è³¼å®Œæ•´åˆ†æç³»çµ±</h1>
      <p>è²¼ä¸Š Google Sheets é€£çµï¼Œå³å¯è‡ªå‹•åˆ†ææ‰€æœ‰æ•¸æ“š</p>
    </div>
    
    <!-- é€£æ¥è¨­å®š -->
    <div class="card">
      <h2>ğŸ”— é€£æ¥ Google Sheets</h2>
      <div id="alertContainer"></div>
      
      <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px;">
        <input type="text" id="sheetsUrl" placeholder="è²¼ä¸Š Google Sheets é€£çµï¼Œä¾‹å¦‚ï¼šhttps://docs.google.com/spreadsheets/d/...">
        <button class="btn btn-success" onclick="connectAndAnalyze()">ğŸš€ é–‹å§‹åˆ†æ</button>
      </div>
      
      <div class="info-box">
        <strong>ğŸ“Œ ä½¿ç”¨èªªæ˜ï¼š</strong>
        <ol class="step-list">
          <li><strong>é–‹å•Ÿä½ çš„ Google Sheets</strong></li>
          <li><strong>é»æ“Šã€Œæ“´å……åŠŸèƒ½ã€â†’ã€ŒApps Scriptã€</strong></li>
          <li><strong>åˆªé™¤é è¨­ç¨‹å¼ç¢¼ï¼Œè²¼ä¸Šä¸‹æ–¹æä¾›çš„å®Œæ•´ç¨‹å¼ç¢¼</strong></li>
          <li><strong>é»æ“Šã€Œéƒ¨ç½²ã€â†’ã€Œæ–°å¢éƒ¨ç½²ä½œæ¥­ã€</strong></li>
          <li><strong>é¸æ“‡ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€</strong>
            <ul style="margin-top: 5px;">
              <li>åŸ·è¡Œèº«åˆ†ï¼š<strong>æˆ‘</strong></li>
              <li>å…·æœ‰å­˜å–æ¬Šçš„ä½¿ç”¨è€…ï¼š<strong>ä»»ä½•äºº</strong></li>
            </ul>
          </li>
          <li><strong>é»æ“Šã€Œéƒ¨ç½²ã€ï¼Œè¤‡è£½ Web App URL</strong></li>
          <li><strong>å›åˆ°é€™å€‹é é¢ï¼Œè²¼ä¸Š URL æˆ–ç›´æ¥è²¼ä¸Šè©¦ç®—è¡¨é€£çµ</strong></li>
          <li><strong>é»æ“Šã€Œé–‹å§‹åˆ†æã€</strong></li>
        </ol>
        
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #bfdbfe;">
          <strong>ğŸ’¡ æ”¯æ´å…©ç¨®è¼¸å…¥æ–¹å¼ï¼š</strong>
          <div style="margin-top: 10px;">
            <div style="margin-bottom: 10px;">
              <strong>æ–¹å¼ 1ï¼š</strong> ç›´æ¥è²¼ä¸Šè©¦ç®—è¡¨é€£çµ
              <div class="example-url">https://docs.google.com/spreadsheets/d/1Sw9kXorO4oHwPIa2LJ5WJo-0bTcQgSLRvS-jhZKqRLY/edit...</div>
            </div>
            <div>
              <strong>æ–¹å¼ 2ï¼š</strong> è²¼ä¸Š Apps Script éƒ¨ç½²çš„ Web App URL
              <div class="example-url">https://script.google.com/macros/s/AKfycby.../exec</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="stats-grid" id="statsCards" style="display: none;">
      <div class="stat-card">
        <h3>ç¸½è¨‚è³¼æ•¸é‡</h3>
        <div class="value" id="totalOrderQty">0</div>
      </div>
      <div class="stat-card">
        <h3>ç¸½æ¶è³¼æ•¸é‡</h3>
        <div class="value" id="totalReportQty">0</div>
      </div>
      <div class="stat-card">
        <h3>åƒèˆ‡åœ˜éšŠ</h3>
        <div class="value" id="totalTeams">0</div>
      </div>
      <div class="stat-card">
        <h3>ç¸½é‡‘é¡</h3>
        <div class="value" id="totalAmount">$0</div>
      </div>
      <div class="stat-card">
        <h3>ç¸½ PV</h3>
        <div class="value" id="totalPV">0</div>
      </div>
    </div>
    
    <!-- ä¸»è¦åˆ†æå€ -->
    <div class="card" id="mainAnalysis" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <h2 style="margin: 0;">ğŸ“Š å®Œæ•´åˆ†æå ±å‘Š</h2>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-export" onclick="exportData()">ğŸ“¥ åŒ¯å‡ºæ•¸æ“š</button>
          <button class="btn" onclick="printReport()">ğŸ–¨ï¸ åˆ—å°å ±å‘Š</button>
        </div>
      </div>
      
      <div class="tab-container">
        <button class="tab active" onclick="switchTab('summary')">ğŸ“ˆ ç¸½è¦½åˆ†æ</button>
        <button class="tab" onclick="switchTab('team-order')">ğŸ‘¥ åœ˜éšŠè¨‚è³¼æ¸…å–®</button>
        <button class="tab" onclick="switchTab('group-analysis')">ğŸ“¦ çµ„åˆ¥åˆ†æ</button>
        <button class="tab" onclick="switchTab('personal-stats')">ğŸ‘¤ å€‹äººçµ±è¨ˆ</button>
        <button class="tab" onclick="switchTab('detailed-list')">ğŸ“‹ è©³ç´°æ¸…å–®</button>
      </div>
      
      <!-- ç¸½è¦½åˆ†æ -->
      <div id="tab-summary" class="tab-content active">
        <div id="summaryContent"></div>
      </div>
      
      <!-- åœ˜éšŠè¨‚è³¼æ¸…å–® -->
      <div id="tab-team-order" class="tab-content">
        <div class="filter-group">
          <label>é¸æ“‡åœ˜éšŠï¼š</label>
          <select id="teamSelect" onchange="filterTeamOrders()">
            <option value="all">å…¨éƒ¨åœ˜éšŠ</option>
          </select>
        </div>
        <div id="teamOrderContent"></div>
      </div>
      
      <!-- çµ„åˆ¥åˆ†æ -->
      <div id="tab-group-analysis" class="tab-content">
        <div id="groupAnalysisContent"></div>
      </div>
      
      <!-- å€‹äººçµ±è¨ˆ -->
      <div id="tab-personal-stats" class="tab-content">
        <div id="personalStatsContent"></div>
      </div>
      
      <!-- è©³ç´°æ¸…å–® -->
      <div id="tab-detailed-list" class="tab-content">
        <div class="filter-group">
          <label>ç¯©é¸ï¼š</label>
          <select id="detailFilter">
            <option value="all">å…¨éƒ¨</option>
            <option value="orders">åƒ…è¨‚å–®</option>
            <option value="reports">åƒ…æ¶è³¼</option>
          </select>
          <input type="text" id="searchInput" placeholder="æœå°‹å§“å..." style="max-width: 300px;">
          <button class="btn" onclick="applyDetailFilter()">æœå°‹</button>
        </div>
        <div id="detailedListContent"></div>
      </div>
    </div>
  </div>
  
  <script>
    let WEB_APP_URL = '';
    let SPREADSHEET_ID = '';
    let allOrders = [];
    let allReports = [];
    let teamOrderData = {};
    let groupAnalysisData = {};
    let personalStatsData = {};
    
    // æå– Spreadsheet ID
    function extractSpreadsheetId(url) {
      const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      return match ? match[1] : null;
    }
    
    // åˆ¤æ–·æ˜¯è©¦ç®—è¡¨é€£çµé‚„æ˜¯ Web App URL
    function parseUrl(url) {
      if (url.includes('docs.google.com/spreadsheets')) {
        // è©¦ç®—è¡¨é€£çµ
        const id = extractSpreadsheetId(url);
        if (id) {
          return { type: 'spreadsheet', id: id };
        }
      } else if (url.includes('script.google.com')) {
        // Web App URL
        return { type: 'webapp', url: url };
      }
      return null;
    }
    
    // åˆ‡æ›åˆ†é 
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');
    }
    
    // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
    function showLoading(show, text = 'è¼‰å…¥ä¸­...') {
      document.getElementById('loading').classList.toggle('show', show);
      document.getElementById('loadingText').textContent = text;
    }
    
    // é¡¯ç¤ºæç¤º
    function showAlert(message, type = 'success') {
      const container = document.getElementById('alertContainer');
      container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => container.innerHTML = '', 8000);
    }
    
    // é€£æ¥ä¸¦åˆ†æ
    async function connectAndAnalyze() {
      const url = document.getElementById('sheetsUrl').value.trim();
      
      if (!url) {
        showAlert('è«‹è¼¸å…¥ Google Sheets é€£çµæˆ– Web App URL', 'error');
        return;
      }
      
      const parsed = parseUrl(url);
      
      if (!parsed) {
        showAlert('âŒ ç„¡æ•ˆçš„é€£çµæ ¼å¼ã€‚è«‹ç¢ºèªæ˜¯ Google Sheets é€£çµæˆ– Apps Script Web App URL', 'error');
        return;
      }
      
      if (parsed.type === 'spreadsheet') {
        showAlert('âš ï¸ åµæ¸¬åˆ°è©¦ç®—è¡¨é€£çµã€‚è«‹å…ˆå®Œæˆ Apps Script è¨­å®šï¼Œç„¶å¾Œè²¼ä¸Šéƒ¨ç½²çš„ Web App URL', 'info');
        SPREADSHEET_ID = parsed.id;
        showAlert(`ğŸ“‹ è©¦ç®—è¡¨ IDï¼š${SPREADSHEET_ID}<br><br>è«‹æŒ‰ç…§ä¸Šæ–¹èªªæ˜å®Œæˆ Apps Script éƒ¨ç½²å¾Œï¼Œè²¼ä¸Š Web App URL`, 'info');
        return;
      }
      
      WEB_APP_URL = parsed.url;
      localStorage.setItem('webAppUrl', WEB_APP_URL);
      
      showLoading(true, 'æ­£åœ¨é€£æ¥è©¦ç®—è¡¨...');
      
      try {
        // æ¸¬è©¦é€£ç·š
        showLoading(true, 'æ¸¬è©¦é€£ç·šä¸­...');
        const testResponse = await fetch(WEB_APP_URL + '?action=test');
        const testResult = await testResponse.json();
        
        if (!testResult.success) {
          throw new Error('é€£ç·šæ¸¬è©¦å¤±æ•—ï¼š' + testResult.data);
        }
        
        showAlert(`âœ… é€£ç·šæˆåŠŸï¼è©¦ç®—è¡¨ï¼š${testResult.data.spreadsheetName}`, 'success');
        
        // è¼‰å…¥è¨‚å–®è³‡æ–™
        showLoading(true, 'è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­...');
        const ordersResponse = await fetch(WEB_APP_URL + '?action=getOrders');
        const ordersResult = await ordersResponse.json();
        
        if (!ordersResult.success) {
          throw new Error('è¼‰å…¥è¨‚å–®å¤±æ•—ï¼š' + ordersResult.data);
        }
        
        allOrders = ordersResult.data;
        
        // è¼‰å…¥æ¶è³¼å›å ±
        showLoading(true, 'è¼‰å…¥æ¶è³¼å›å ±ä¸­...');
        const reportsResponse = await fetch(WEB_APP_URL + '?action=getReports');
        const reportsResult = await reportsResponse.json();
        
        if (!reportsResult.success) {
          throw new Error('è¼‰å…¥æ¶è³¼å›å ±å¤±æ•—ï¼š' + reportsResult.data);
        }
        
        allReports = reportsResult.data;
        
        // é–‹å§‹åˆ†æ
        showLoading(true, 'åˆ†ææ•¸æ“šä¸­...');
        analyzeAllData();
        
        showAlert(`âœ… åˆ†æå®Œæˆï¼è¨‚å–®ï¼š${allOrders.length} ç­†ï¼Œæ¶è³¼ï¼š${allReports.length} ç­†`, 'success');
        
        document.getElementById('statsCards').style.display = 'grid';
        document.getElementById('mainAnalysis').style.display = 'block';
        
        // å„²å­˜é€£çµ
        localStorage.setItem('sheetsUrl', url);
        
      } catch (error) {
        showAlert('âŒ ' + error.message, 'error');
        console.error(error);
      } finally {
        showLoading(false);
      }
    }
    
    // åˆ†ææ‰€æœ‰æ•¸æ“š
    function analyzeAllData() {
      buildTeamOrderData();
      buildGroupAnalysisData();
      buildPersonalStatsData();
      updateStatsCards();
      generateSummary();
      generateTeamOrderList();
      generateGroupAnalysis();
      generatePersonalStats();
      generateDetailedList();
    }
    
    // å»ºç«‹åœ˜éšŠè¨‚è³¼æ•¸æ“š
    function buildTeamOrderData() {
      teamOrderData = {};
      
      const buyerTeamMap = {};
      allReports.forEach(report => {
        if (report.æ¶è³¼è€… && report.åœ˜éšŠ) {
          buyerTeamMap[report.æ¶è³¼è€…] = report.åœ˜éšŠ;
        }
      });
      
      allOrders.forEach(order => {
        const name = order.LINEåç¨±;
        const mainName = name.split('(ä»£)')[0].trim();
        const team = buyerTeamMap[mainName] || buyerTeamMap[name] || 'æœªåˆ†é…';
        
        if (!teamOrderData[team]) {
          teamOrderData[team] = {};
        }
        
        if (!teamOrderData[team][mainName]) {
          teamOrderData[team][mainName] = {
            '1A': { qty: 0, amount: 0, pv: 0 },
            '1B': { qty: 0, amount: 0, pv: 0 },
            total: { qty: 0, amount: 0, pv: 0 }
          };
        }
        
        const product = order.ç”¢å“ç·¨è™Ÿ;
        const qty = parseInt(order.è¨‚è³¼æ•¸é‡) || 0;
        const price = parseInt(order.å–®åƒ¹) || 0;
        const pv = parseInt(order.PV) || 0;
        const amount = parseInt(order.åˆè¨ˆè²»ç”¨) || 0;
        
        if (product === '1A' || product === '1B') {
          teamOrderData[team][mainName][product].qty += qty;
          teamOrderData[team][mainName][product].amount += amount;
          teamOrderData[team][mainName][product].pv += pv * qty;
        }
        
        teamOrderData[team][mainName].total.qty += qty;
        teamOrderData[team][mainName].total.amount += amount;
        teamOrderData[team][mainName].total.pv += pv * qty;
      });
    }
    
    // å»ºç«‹çµ„åˆ¥åˆ†ææ•¸æ“š
    function buildGroupAnalysisData() {
      groupAnalysisData = {
        byGroup: {},
        byTeam: {}
      };
      
      allOrders.forEach(order => {
        const group = order.çµ„åˆ¥ || 'æœªåˆ†çµ„';
        if (!groupAnalysisData.byGroup[group]) {
          groupAnalysisData.byGroup[group] = {
            orderQty: 0,
            reportQty: 0,
            amount: 0,
            pv: 0
          };
        }
        
        groupAnalysisData.byGroup[group].orderQty += parseInt(order.è¨‚è³¼æ•¸é‡) || 0;
        groupAnalysisData.byGroup[group].amount += parseInt(order.åˆè¨ˆè²»ç”¨) || 0;
        groupAnalysisData.byGroup[group].pv += (parseInt(order.PV) || 0) * (parseInt(order.è¨‚è³¼æ•¸é‡) || 0);
      });
      
      allReports.forEach(report => {
        const group = report.çµ„åˆ¥ä»£è™Ÿ || 'æœªåˆ†çµ„';
        if (!groupAnalysisData.byGroup[group]) {
          groupAnalysisData.byGroup[group] = {
            orderQty: 0,
            reportQty: 0,
            amount: 0,
            pv: 0
          };
        }
        
        groupAnalysisData.byGroup[group].reportQty += parseInt(report.æ¶è³¼çµ„æ•¸) || 0;
        
        const team = report.åœ˜éšŠ || 'æœªåˆ†é…';
        if (!groupAnalysisData.byTeam[team]) {
          groupAnalysisData.byTeam[team] = {
            orderQty: 0,
            reportQty: 0,
            amount: 0,
            pv: 0
          };
        }
        
        groupAnalysisData.byTeam[team].reportQty += parseInt(report.æ¶è³¼çµ„æ•¸) || 0;
        groupAnalysisData.byTeam[team].pv += (parseInt(report.PVæ•¸) || 0) * (parseInt(report.æ¶è³¼çµ„æ•¸) || 0);
        groupAnalysisData.byTeam[team].amount += (parseInt(report.å–®åƒ¹) || 0) * (parseInt(report.æ¶è³¼çµ„æ•¸) || 0);
      });
    }
    
    // å»ºç«‹å€‹äººçµ±è¨ˆæ•¸æ“š
    function buildPersonalStatsData() {
      personalStatsData = {};
      
      allOrders.forEach(order => {
        const name = order.LINEåç¨±.split('(ä»£)')[0].trim();
        const date = order.æ™‚é–“ ? order.æ™‚é–“.split('_')[0] : '';
        
        if (!personalStatsData[name]) {
          personalStatsData[name] = {
            dates: new Set(),
            totalQty: 0,
            totalAmount: 0,
            totalPV: 0,
            orders: []
          };
        }
        
        if (date) {
          personalStatsData[name].dates.add(date);
        }
        
        personalStatsData[name].totalQty += parseInt(order.è¨‚è³¼æ•¸é‡) || 0;
        personalStatsData[name].totalAmount += parseInt(order.åˆè¨ˆè²»ç”¨) || 0;
        personalStatsData[name].totalPV += (parseInt(order.PV) || 0) * (parseInt(order.è¨‚è³¼æ•¸é‡) || 0);
        personalStatsData[name].orders.push(order);
      });
    }
    
    // æ›´æ–°çµ±è¨ˆå¡ç‰‡
    function updateStatsCards() {
      const totalOrderQty = allOrders.reduce((sum, o) => sum + (parseInt(o.è¨‚è³¼æ•¸é‡) || 0), 0);
      const totalReportQty = allReports.reduce((sum, r) => sum + (parseInt(r.æ¶è³¼çµ„æ•¸) || 0), 0);
      const totalAmount = allOrders.reduce((sum, o) => sum + (parseInt(o.åˆè¨ˆè²»ç”¨) || 0), 0);
      const totalPV = allOrders.reduce((sum, o) => sum + ((parseInt(o.PV) || 0) * (parseInt(o.è¨‚è³¼æ•¸é‡) || 0)), 0);
      const totalTeams = new Set(allReports.map(r => r.åœ˜éšŠ).filter(t => t)).size;
      
      document.getElementById('totalOrderQty').textContent = totalOrderQty;
      document.getElementById('totalReportQty').textContent = totalReportQty;
      document.getElementById('totalTeams').textContent = totalTeams;
      document.getElementById('totalAmount').textContent = '$' + totalAmount.toLocaleString();
      document.getElementById('totalPV').textContent = totalPV.toLocaleString();
    }
    
    // ç”Ÿæˆç¸½è¦½åˆ†æ
    function generateSummary() {
      let html = '<h3>ğŸ“Š æ•¸æ“šç¸½è¦½</h3>';
      
      html += '<div class="summary-box"><h4>å„çµ„åˆ¥çµ±è¨ˆ</h4>';
      html += '<div class="table-container"><table><thead><tr><th>çµ„åˆ¥</th><th>è¨‚è³¼æ•¸é‡</th><th>æ¶è³¼æ•¸é‡</th><th>å·®ç•°</th><th>é‡‘é¡</th><th>PV</th></tr></thead><tbody>';
      
      for (const [group, data] of Object.entries(groupAnalysisData.byGroup)) {
        const diff = data.reportQty - data.orderQty;
        const diffColor = diff > 0 ? 'color: green;' : diff < 0 ? 'color: red;' : '';
        
        html += `
          <tr>
            <td><strong>${group}</strong></td>
            <td>${data.orderQty}</td>
            <td>${data.reportQty}</td>
            <td style="${diffColor}"><strong>${diff > 0 ? '+' : ''}${diff}</strong></td>
            <td>$${data.amount.toLocaleString()}</td>
            <td>${data.pv}</td>
          </tr>
        `;
      }
      html += '</tbody></table></div></div>';
      
      html += '<div class="summary-box" style="margin-top: 20px;"><h4>å„åœ˜éšŠçµ±è¨ˆ</h4>';
      html += '<div class="table-container"><table><thead><tr><th>åœ˜éšŠ</th><th>æ¶è³¼æ•¸é‡</th><th>é‡‘é¡</th><th>PV</th></tr></thead><tbody>';
      
      for (const [team, data] of Object.entries(groupAnalysisData.byTeam)) {
        html += `
          <tr>
            <td><span class="badge badge-team">${team}</span></td>
            <td>${data.reportQty}</td>
            <td>$${data.amount.toLocaleString()}</td>
            <td>${data.pv}</td>
          </tr>
        `;
      }
      html += '</tbody></table></div></div>';
      
      document.getElementById('summaryContent').innerHTML = html;
    }
    
    // ç”Ÿæˆåœ˜éšŠè¨‚è³¼æ¸…å–®
    function generateTeamOrderList() {
      const teamSelect = document.getElementById('teamSelect');
      teamSelect.innerHTML = '<option value="all">å…¨éƒ¨åœ˜éšŠ</option>';
      for (const team of Object.keys(teamOrderData)) {
        teamSelect.innerHTML += `<option value="${team}">${team}</option>`;
      }
      
      filterTeamOrders();
    }
    
    // ç¯©é¸åœ˜éšŠè¨‚è³¼
    function filterTeamOrders() {
      const selectedTeam = document.getElementById('teamSelect').value;
      let html = '';
      
      const teamsToShow = selectedTeam === 'all' ? Object.keys(teamOrderData) : [selectedTeam];
      
      teamsToShow.forEach(team => {
        const teamData = teamOrderData[team];
        
        html += `<div class="team-section">`;
        html += `<h3>ğŸ¢ ${team}</h3>`;
        
        let teamTotal = { qty: 0, amount: 0, pv: 0 };
        
        for (const [person, data] of Object.entries(teamData)) {
          html += `<div class="person-block">`;
          html += `<div class="person-header">ğŸ‘¤ ${person}</div>`;
          
          html += `<div class="product-row header">`;
          html += `<div>ç”¢å“</div><div>åç¨±</div><div>æ•¸é‡</div><div>é‡‘é¡</div><div>PV</div>`;
          html += `</div>`;
          
          if (data['1A'].qty > 0) {
            html += `<div class="product-row">`;
            html += `<div><span class="badge badge-1a">1A</span></div>`;
            html += `<div>é †æš¢æ¸…æ–°è¤‡æ–¹</div>`;
            html += `<div>${data['1A'].qty}</div>`;
            html += `<div>$${data['1A'].amount.toLocaleString()}</div>`;
            html += `<div>${data['1A'].pv}</div>`;
            html += `</div>`;
          }
          
          if (data['1B'].qty > 0) {
            html += `<div class="product-row">`;
            html += `<div><span class="badge badge-1b">1B</span></div>`;
            html += `<div>å¤å·´é¦™è„‚</div>`;
            html += `<div>${data['1B'].qty}</div>`;
            html += `<div>$${data['1B'].amount.toLocaleString()}</div>`;
            html += `<div>${data['1B'].pv}</div>`;
            html += `</div>`;
          }
          
          html += `<div class="total-row">`;
          html += `${person} ç¸½é‡‘é¡ï¼š$${data.total.amount.toLocaleString()} | ç¸½ PVï¼š${data.total.pv}`;
          html += `</div>`;
          
          html += `</div>`;
          
          teamTotal.qty += data.total.qty;
          teamTotal.amount += data.total.amount;
          teamTotal.pv += data.total.pv;
        }
        
        html += `<div style="background: #667eea; color: white; padding: 15px; border-radius: 8px; margin-top: 15px; font-weight: bold;">`;
        html += `${team} ç¸½è¨ˆï¼šæ•¸é‡ ${teamTotal.qty} | é‡‘é¡ $${teamTotal.amount.toLocaleString()} | PV ${teamTotal.pv}`;
        html += `</div>`;
        
        html += `</div>`;
      });
      
      document.getElementById('teamOrderContent').innerHTML = html;
    }
    
    // ç”Ÿæˆçµ„åˆ¥åˆ†æ
    function generateGroupAnalysis() {
      let html = '<h3>ğŸ“¦ çµ„åˆ¥è©³ç´°åˆ†æ</h3>';
      
      html += '<div class="table-container"><table><thead><tr><th>çµ„åˆ¥</th><th>è¨‚è³¼æ•¸é‡</th><th>æ¶è³¼æ•¸é‡</th><th>å·®ç•°</th><th>é‡‘é¡</th><th>PV</th></tr></thead><tbody>';
      
      for (const [group, data] of Object.entries(groupAnalysisData.byGroup)) {
        const diff = data.reportQty - data.orderQty;
        const diffColor = diff > 0 ? 'color: green;' : diff < 0 ? 'color: red;' : '';
        
        html += `
          <tr>
            <td><strong>${group}</strong></td>
            <td>${data.orderQty}</td>
            <td>${data.reportQty}</td>
            <td style="${diffColor}"><strong>${diff > 0 ? '+' : ''}${diff}</strong></td>
            <td>$${data.amount.toLocaleString()}</td>
            <td>${data.pv}</td>
          </tr>
        `;
      }
      
      html += '</tbody></table></div>';
      
      document.getElementById('groupAnalysisContent').innerHTML = html;
    }
    
    // ç”Ÿæˆå€‹äººçµ±è¨ˆ
    function generatePersonalStats() {
      let html = '<h3>ğŸ‘¤ å€‹äººè¨‚è³¼å¤©æ•¸çµ±è¨ˆ</h3>';
      
      html += '<div class="table-container"><table><thead><tr><th>å§“å</th><th>è¨‚è³¼å¤©æ•¸</th><th>ç¸½æ•¸é‡</th><th>ç¸½é‡‘é¡</th><th>ç¸½ PV</th><th>å¹³å‡/å¤©</th></tr></thead><tbody>';
      
      const sorted = Object.entries(personalStatsData).sort((a, b) => b[1].dates.size - a[1].dates.size);
      
      sorted.forEach(([name, data]) => {
        const days = data.dates.size;
        const avgPerDay = days > 0 ? (data.totalQty / days).toFixed(1) : 0;
        
        html += `
          <tr>
            <td><strong>${name}</strong></td>
            <td>${days} å¤©</td>
            <td>${data.totalQty}</td>
            <td>$${data.totalAmount.toLocaleString()}</td>
            <td>${data.totalPV}</td>
            <td>${avgPerDay}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table></div>';
      
      document.getElementById('personalStatsContent').innerHTML = html;
    }
    
    // ç”Ÿæˆè©³ç´°æ¸…å–®
    function generateDetailedList() {
      applyDetailFilter();
    }
    
    // å¥—ç”¨è©³ç´°æ¸…å–®ç¯©é¸
    function applyDetailFilter() {
      const filter = document.getElementById('detailFilter').value;
      const search = document.getElementById('searchInput').value.toLowerCase();
      
      let html = '';
      
      if (filter === 'all' || filter === 'orders') {
        html += '<h3>ğŸ“‹ è¨‚å–®æ˜ç´°</h3>';
        html += '<div class="table-container"><table><thead><tr><th>LINEåç¨±</th><th>ç”¢å“</th><th>æ•¸é‡</th><th>å–®åƒ¹</th><th>PV</th><th>åˆè¨ˆ</th><th>çµ„åˆ¥</th><th>æ™‚é–“</th></tr></thead><tbody>';
        
        allOrders.forEach(order => {
          if (search && !order.LINEåç¨±.toLowerCase().includes(search)) return;
          
          html += `
            <tr>
              <td>${order.LINEåç¨±}</td>
              <td><span class="badge badge-${order.ç”¢å“ç·¨è™Ÿ === '1A' ? '1a' : '1b'}">${order.ç”¢å“ç·¨è™Ÿ}</span></td>
              <td>${order.è¨‚è³¼æ•¸é‡}</td>
              <td>$${(order.å–®åƒ¹ || 0).toLocaleString()}</td>
              <td>${order.PV}</td>
              <td><strong>$${(order.åˆè¨ˆè²»ç”¨ || 0).toLocaleString()}</strong></td>
              <td>${order.çµ„åˆ¥ || '-'}</td>
              <td>${order.æ™‚é–“ || '-'}</td>
            </tr>
          `;
        });
        
        html += '</tbody></table></div>';
      }
      
      if (filter === 'all' || filter === 'reports') {
        html += '<h3 style="margin-top: 30px;">ğŸ¯ æ¶è³¼å›å ±æ˜ç´°</h3>';
        html += '<div class="table-container"><table><thead><tr><th>çµ„åˆ¥ä»£è™Ÿ</th><th>æ¶è³¼çµ„æ•¸</th><th>æ¶è³¼è€…</th><th>å–®åƒ¹</th><th>PVæ•¸</th><th>è²·/é€</th><th>åœ˜éšŠ</th></tr></thead><tbody>';
        
        allReports.forEach(report => {
          if (search && !report.æ¶è³¼è€….toLowerCase().includes(search)) return;
          
          html += `
            <tr>
              <td>${report.çµ„åˆ¥ä»£è™Ÿ}</td>
              <td><strong>${report.æ¶è³¼çµ„æ•¸}</strong></td>
              <td>${report.æ¶è³¼è€…}</td>
              <td>$${(report.å–®åƒ¹ || 0).toLocaleString()}</td>
              <td>${report.PVæ•¸}</td>
              <td>${report['è²·/é€'] || '-'}</td>
              <td><span class="badge badge-team">${report.åœ˜éšŠ}</span></td>
            </tr>
          `;
        });
        
        html += '</tbody></table></div>';
      }
      
      document.getElementById('detailedListContent').innerHTML = html;
    }
    
    // åŒ¯å‡ºæ•¸æ“š
    function exportData() {
      let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
      
      // è¨‚å–®æ•¸æ“š
      csvContent += "è¨‚å–®æ˜ç´°\n";
      csvContent += "LINEåç¨±,ç”¢å“,æ•¸é‡,å–®åƒ¹,PV,åˆè¨ˆ,çµ„åˆ¥,æ™‚é–“\n";
      allOrders.forEach(order => {
        csvContent += `${order.LINEåç¨±},${order.ç”¢å“ç·¨è™Ÿ},${order.è¨‚è³¼æ•¸é‡},${order.å–®åƒ¹},${order.PV},${order.åˆè¨ˆè²»ç”¨},${order.çµ„åˆ¥ || ''},${order.æ™‚é–“ || ''}\n`;
      });
      
      csvContent += "\n\næ¶è³¼å›å ±æ˜ç´°\n";
      csvContent += "çµ„åˆ¥ä»£è™Ÿ,æ¶è³¼çµ„æ•¸,æ¶è³¼è€…,å–®åƒ¹,PVæ•¸,è²·/é€,åœ˜éšŠ\n";
      allReports.forEach(report => {
        csvContent += `${report.çµ„åˆ¥ä»£è™Ÿ},${report.æ¶è³¼çµ„æ•¸},${report.æ¶è³¼è€…},${report.å–®åƒ¹},${report.PVæ•¸},${report['è²·/é€'] || ''},${report.åœ˜éšŠ}\n`;
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "BOGOåˆ†æå ±å‘Š_" + new Date().toISOString().split('T')[0] + ".csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showAlert('âœ… æ•¸æ“šå·²åŒ¯å‡ºç‚º CSV æª”æ¡ˆ', 'success');
    }
    
    // åˆ—å°å ±å‘Š
    function printReport() {
      window.print();
    }
    
    // é é¢è¼‰å…¥æ™‚æ¢å¾© URL
    window.addEventListener('DOMContentLoaded', () => {
      const savedUrl = localStorage.getItem('sheetsUrl') || localStorage.getItem('webAppUrl');
      if (savedUrl) {
        document.getElementById('sheetsUrl').value = savedUrl;
      }
    });
  </script>
</body>
</html>
