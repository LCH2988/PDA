<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BOGO æ¶è³¼è¨‚å–®åˆ†æç³»çµ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 30px;
      text-align: center;
    }
    
    .header h1 {
      color: #667eea;
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .header p {
      color: #666;
      font-size: 1.1em;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .stat-card h3 {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    
    .stat-card .value {
      font-size: 2.5em;
      font-weight: bold;
      color: #667eea;
    }
    
    .stat-card .label {
      color: #999;
      font-size: 0.9em;
      margin-top: 5px;
    }
    
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 968px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .card h2 {
      color: #667eea;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .table-container {
      overflow-x: auto;
      max-height: 500px;
      overflow-y: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
    }
    
    thead {
      position: sticky;
      top: 0;
      background: #667eea;
      color: white;
      z-index: 10;
    }
    
    th {
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
    }
    
    td {
      padding: 10px 8px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    tbody tr:hover {
      background: #f8f9ff;
    }
    
    .product-a {
      color: #10b981;
      font-weight: bold;
    }
    
    .product-b {
      color: #f59e0b;
      font-weight: bold;
    }
    
    .filter-section {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .filter-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filter-group label {
      color: #666;
      font-weight: 600;
    }
    
    .filter-group select,
    .filter-group input {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      outline: none;
      transition: border-color 0.3s;
    }
    
    .filter-group select:focus,
    .filter-group input:focus {
      border-color: #667eea;
    }
    
    .btn {
      padding: 10px 25px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .btn:hover {
      background: #5568d3;
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #6b7280;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    .btn-success {
      background: #10b981;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .sync-info {
      background: #e0e7ff;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      text-align: center;
      color: #4338ca;
    }
    
    .sync-info strong {
      display: block;
      margin-bottom: 5px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }
    
    .badge-success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .loading.show {
      display: flex;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .status-connected {
      background: #10b981;
    }
    
    .status-disconnected {
      background: #ef4444;
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>
  
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>ğŸ¯ BOGO æ¶è³¼è¨‚å–®åˆ†æç³»çµ±</h1>
      <p>
        <span class="status-indicator" id="statusIndicator"></span>
        <span id="connectionStatus">æœªé€£æ¥</span>
      </p>
    </div>
    
    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>ç¸½è¨‚å–®æ•¸</h3>
        <div class="value" id="totalOrders">0</div>
        <div class="label">ç­†è¨‚å–®</div>
      </div>
      <div class="stat-card">
        <h3>ç¸½éŠ·å”®é¡</h3>
        <div class="value" id="totalSales">$0</div>
        <div class="label">æ–°å°å¹£</div>
      </div>
      <div class="stat-card">
        <h3>ç¸½ PV æ•¸</h3>
        <div class="value" id="totalPV">0</div>
        <div class="label">ç©åˆ†</div>
      </div>
      <div class="stat-card">
        <h3>åƒèˆ‡äººæ•¸</h3>
        <div class="value" id="totalUsers">0</div>
        <div class="label">ä½æœƒå“¡</div>
      </div>
    </div>
    
    <!-- Connection Setup -->
    <div class="card" style="margin-bottom: 30px;">
      <h2>ğŸ”— é€£æ¥ Google Sheets</h2>
      <div class="filter-group">
        <label>Web App URLï¼š</label>
        <input type="text" id="webAppUrl" placeholder="è²¼ä¸Š Apps Script éƒ¨ç½²çš„ URL" style="flex: 1; min-width: 300px;">
        <button class="btn btn-success" onclick="connectAndLoad()">é€£æ¥ä¸¦è¼‰å…¥æ•¸æ“š</button>
        <button class="btn" onclick="testConnection()">æ¸¬è©¦é€£ç·š</button>
        <button class="btn btn-secondary" onclick="refreshData()">é‡æ–°æ•´ç†</button>
      </div>
      
      <div class="sync-info">
        <strong>ğŸ“Œ å¿«é€Ÿè¨­å®šï¼š</strong>
        <p>1. åœ¨ Google Sheets é–‹å•Ÿ Apps Scriptï¼ˆæ“´å……åŠŸèƒ½ â†’ Apps Scriptï¼‰</p>
        <p>2. è²¼ä¸Šæä¾›çš„ç¨‹å¼ç¢¼ä¸¦å„²å­˜</p>
        <p>3. éƒ¨ç½² â†’ æ–°å¢éƒ¨ç½²ä½œæ¥­ â†’ ç¶²é æ‡‰ç”¨ç¨‹å¼</p>
        <p>4. è¤‡è£½éƒ¨ç½² URL ä¸¦è²¼åˆ°ä¸Šæ–¹è¼¸å…¥æ¡†</p>
      </div>
    </div>
    
    <!-- Filter Section -->
    <div class="filter-section">
      <h2 style="color: #667eea; margin-bottom: 15px;">ğŸ” ç¯©é¸èˆ‡æœå°‹</h2>
      <div class="filter-group">
        <label>ç”¢å“é¡å‹ï¼š</label>
        <select id="productFilter">
          <option value="all">å…¨éƒ¨</option>
          <option value="1A">1A - é †æš¢æ¸…æ–°è¤‡æ–¹</option>
          <option value="1B">1B - å¤å·´é¦™è„‚</option>
        </select>
        
        <label>æœå°‹å§“åï¼š</label>
        <input type="text" id="nameSearch" placeholder="è¼¸å…¥å§“å...">
        
        <button class="btn" onclick="applyFilters()">å¥—ç”¨ç¯©é¸</button>
        <button class="btn btn-secondary" onclick="resetFilters()">é‡ç½®</button>
      </div>
    </div>
    
    <!-- Orders Table -->
    <div class="card">
      <h2>ğŸ“‹ è¨‚å–®æ˜ç´°åˆ—è¡¨ (<span id="orderCount">0</span> ç­†)</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ç·¨è™Ÿ</th>
              <th>LINEåç¨±</th>
              <th>ç”¢å“</th>
              <th>æ•¸é‡</th>
              <th>å–®åƒ¹</th>
              <th>PV</th>
              <th>åˆè¨ˆ</th>
              <th>æ™‚é–“</th>
            </tr>
          </thead>
          <tbody id="ordersTable">
            <tr>
              <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                è«‹å…ˆé€£æ¥ Google Sheets ä»¥è¼‰å…¥æ•¸æ“š
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <script>
    // å…¨åŸŸè®Šæ•¸
    let WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw9jAla5dWjUr3Vow80F41k9B3leqxNvW95edwPaFklQIxYReM-IZraqceumxxfDindSg/exec';
    let allOrders = [];
    
    // é€£æ¥ä¸¦è¼‰å…¥æ•¸æ“š
    async function connectAndLoad() {
      const url = document.getElementById('webAppUrl').value.trim();
      
      if (!url) {
        alert('è«‹è¼¸å…¥ Web App URL');
        return;
      }
      
      WEB_APP_URL = url;
      localStorage.setItem('webAppUrl', url);
      
      await loadOrders();
      await loadStats();
    }
    
    // è¼‰å…¥è¨‚å–®è³‡æ–™
    async function loadOrders() {
      if (!WEB_APP_URL) {
        alert('è«‹å…ˆè¨­å®š Web App URL');
        return;
      }
      
      try {
        showLoading(true);
        updateStatus('connecting');
        
        const response = await fetch(WEB_APP_URL + '?action=getOrders');
        const result = await response.json();
        
        if (result.success) {
          allOrders = result.data.map(order => ({
            id: order.id,
            name: order.LINEåç¨±,
            product: order.ç”¢å“ç·¨è™Ÿ,
            qty: order.è¨‚è³¼æ•¸é‡,
            price: order.å–®åƒ¹,
            pv: order.PV,
            time: order.æ™‚é–“,
            group: order.ç¾¤çµ„ID,
            total: order.åˆè¨ˆè²»ç”¨
          }));
          
          renderOrders(allOrders);
          updateStatus('connected');
          
          console.log('âœ… è¼‰å…¥æˆåŠŸï¼š', allOrders.length, 'ç­†è¨‚å–®');
        } else {
          updateStatus('disconnected');
          alert('âŒ è¼‰å…¥å¤±æ•—ï¼š' + result.data);
        }
      } catch (error) {
        updateStatus('disconnected');
        alert('âŒ é€£ç·šéŒ¯èª¤ï¼š' + error.message);
        console.error(error);
      } finally {
        showLoading(false);
      }
    }
    
    // è¼‰å…¥çµ±è¨ˆè³‡æ–™
    async function loadStats() {
      if (!WEB_APP_URL) return;
      
      try {
        const response = await fetch(WEB_APP_URL + '?action=getStats');
        const result = await response.json();
        
        if (result.success) {
          const stats = result.data;
          
          document.getElementById('totalOrders').textContent = stats.totalOrders;
          document.getElementById('totalSales').textContent = '$' + stats.totalSales.toLocaleString();
          document.getElementById('totalPV').textContent = stats.totalPV.toLocaleString();
          document.getElementById('totalUsers').textContent = stats.totalUsers;
        }
      } catch (error) {
        console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—ï¼š', error);
      }
    }
    
    // æ¸¬è©¦é€£ç·š
    async function testConnection() {
      const url = document.getElementById('webAppUrl').value.trim() || WEB_APP_URL;
      
      if (!url) {
        alert('è«‹è¼¸å…¥ Web App URL');
        return;
      }
      
      try {
        showLoading(true);
        
        const response = await fetch(url + '?action=test');
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… é€£ç·šæˆåŠŸï¼\n\n' + 
                'è©¦ç®—è¡¨ï¼š' + result.data.spreadsheetName + '\n' +
                'å·¥ä½œè¡¨ï¼š' + result.data.sheetName + '\n' +
                'ç¸½åˆ—æ•¸ï¼š' + result.data.totalRows + '\n' +
                'æ™‚é–“ï¼š' + new Date(result.data.timestamp).toLocaleString('zh-TW'));
          
          WEB_APP_URL = url;
          localStorage.setItem('webAppUrl', url);
        } else {
          alert('âŒ é€£ç·šå¤±æ•—ï¼š' + result.data);
        }
      } catch (error) {
        alert('âŒ é€£ç·šéŒ¯èª¤ï¼š' + error.message + '\n\nè«‹ç¢ºèªï¼š\n1. URL æ˜¯å¦æ­£ç¢º\n2. éƒ¨ç½²æ¬Šé™æ˜¯å¦è¨­ç‚ºã€Œä»»ä½•äººã€\n3. Apps Script æ˜¯å¦å·²å„²å­˜ä¸¦éƒ¨ç½²');
      } finally {
        showLoading(false);
      }
    }
    
    // é‡æ–°æ•´ç†æ•¸æ“š
    async function refreshData() {
      if (!WEB_APP_URL) {
        alert('è«‹å…ˆé€£æ¥ Google Sheets');
        return;
      }
      
      await loadOrders();
      await loadStats();
    }
    
    // æ¸²æŸ“è¨‚å–®è¡¨æ ¼
    function renderOrders(orders) {
      const tbody = document.getElementById('ordersTable');
      tbody.innerHTML = '';
      
      if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</td></tr>';
        document.getElementById('orderCount').textContent = '0';
        return;
      }
      
      orders.forEach(order => {
        const productClass = order.product === '1A' ? 'product-a' : 'product-b';
        const badge = order.product === '1A' ? 'badge-success' : 'badge-warning';
        
        tbody.innerHTML += `
          <tr>
            <td>${order.id}</td>
            <td>${order.name}</td>
            <td><span class="badge ${badge}">${order.product}</span></td>
            <td class="${productClass}">${order.qty}</td>
            <td>$${order.price.toLocaleString()}</td>
            <td>${order.pv}</td>
            <td><strong>$${order.total.toLocaleString()}</strong></td>
            <td style="font-size: 0.85em;">${order.time}</td>
          </tr>
        `;
      });
      
      document.getElementById('orderCount').textContent = orders.length;
    }
    
    // å¥—ç”¨ç¯©é¸
    function applyFilters() {
      const productFilter = document.getElementById('productFilter').value;
      const nameSearch = document.getElementById('nameSearch').value.toLowerCase();
      
      let filtered = allOrders.filter(order => {
        const matchProduct = productFilter === 'all' || order.product === productFilter;
        const matchName = nameSearch === '' || order.name.toLowerCase().includes(nameSearch);
        
        return matchProduct && matchName;
      });
      
      renderOrders(filtered);
    }
    
    // é‡ç½®ç¯©é¸
    function resetFilters() {
      document.getElementById('productFilter').value = 'all';
      document.getElementById('nameSearch').value = '';
      renderOrders(allOrders);
    }
    
    // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
    function showLoading(show) {
      const loading = document.getElementById('loading');
      if (show) {
        loading.classList.add('show');
      } else {
        loading.classList.remove('show');
      }
    }
    
    // æ›´æ–°é€£ç·šç‹€æ…‹
    function updateStatus(status) {
      const indicator = document.getElementById('statusIndicator');
      const statusText = document.getElementById('connectionStatus');
      
      switch(status) {
        case 'connected':
          indicator.className = 'status-indicator status-connected';
          statusText.textContent = 'å·²é€£æ¥';
          break;
        case 'connecting':
          indicator.className = 'status-indicator';
          indicator.style.background = '#f59e0b';
          statusText.textContent = 'é€£æ¥ä¸­...';
          break;
        case 'disconnected':
          indicator.className = 'status-indicator status-disconnected';
          statusText.textContent = 'æœªé€£æ¥';
          break;
      }
    }
    
    // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¢å¾©è¨­å®š
    window.addEventListener('DOMContentLoaded', () => {
      const savedUrl = localStorage.getItem('webAppUrl');
      if (savedUrl) {
        document.getElementById('webAppUrl').value = savedUrl;
        WEB_APP_URL = savedUrl;
        
        // è‡ªå‹•è¼‰å…¥æ•¸æ“š
        loadOrders();
        loadStats();
      } else {
        updateStatus('disconnected');
      }
    });
  </script>
</body>
</html>
