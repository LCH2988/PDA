<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友權益促進會管理系統</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #0d9488;
      --primary-dark: #0f766e;
      --primary-light: #5eead4;
      --secondary-color: #06b6d4;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --success-color: #10b981;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 2px 4px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      background-color: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.6;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      display: none;
    }

    .loading-overlay.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--gray-200);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 260px;
      background: white;
      box-shadow: var(--shadow-lg);
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 1000;
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      padding: 1.5rem;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
    }

    .sidebar-header h1 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .sidebar-header p {
      font-size: 0.875rem;
      opacity: 0.9;
    }

    .sidebar-nav {
      padding: 1rem 0;
    }

    .nav-section {
      margin-bottom: 1.5rem;
    }

    .nav-section-title {
      padding: 0.5rem 1.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--gray-500);
      letter-spacing: 0.05em;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 1.5rem;
      color: var(--gray-700);
      text-decoration: none;
      transition: all 0.2s;
      cursor: pointer;
      border-left: 3px solid transparent;
    }

    .nav-item:hover {
      background: var(--gray-50);
      color: var(--primary-color);
    }

    .nav-item.active {
      background: linear-gradient(90deg, rgba(94, 234, 212, 0.2), transparent);
      color: var(--primary-color);
      border-left-color: var(--primary-color);
      font-weight: 600;
    }

    .nav-item-icon {
      width: 20px;
      height: 20px;
      margin-right: 0.75rem;
      flex-shrink: 0;
    }

    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 2rem;
      min-height: 100vh;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-title {
      font-size: 1.875rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 0.5rem;
    }

    .page-subtitle {
      color: var(--gray-600);
      font-size: 1rem;
    }

    .card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: var(--shadow);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: var(--shadow);
      padding: 1.5rem;
      display: flex;
      align-items: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      flex-shrink: 0;
    }

    .stat-icon.primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
    }

    .stat-icon.success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .stat-icon.warning {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }

    .stat-icon.info {
      background: linear-gradient(135deg, #06b6d4, #0891b2);
      color: white;
    }

    .stat-content {
      flex: 1;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--gray-600);
      margin-bottom: 0.25rem;
    }

    .stat-value {
      font-size: 1.875rem;
      font-weight: 700;
      color: var(--gray-900);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.625rem 1.25rem;
      font-size: 0.875rem;
      font-weight: 500;
      border-radius: 0.375rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-dark);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--gray-300);
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #dc2626;
      box-shadow: var(--shadow-md);
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #059669;
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.8125rem;
    }

    .btn-icon {
      width: 16px;
      height: 16px;
      margin-right: 0.5rem;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 0.5rem;
      border: 1px solid var(--gray-200);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    thead {
      background: var(--gray-50);
    }

    th {
      padding: 0.75rem 1rem;
      text-align: left;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-700);
      border-bottom: 2px solid var(--gray-200);
      white-space: nowrap;
    }

    td {
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      color: var(--gray-900);
      border-bottom: 1px solid var(--gray-200);
    }

    tbody tr:hover {
      background: var(--gray-50);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.625rem;
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: 9999px;
      white-space: nowrap;
    }

    .badge-primary {
      background: rgba(13, 148, 136, 0.1);
      color: var(--primary-dark);
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.1);
      color: #059669;
    }

    .badge-warning {
      background: rgba(245, 158, 11, 0.1);
      color: #d97706;
    }

    .badge-danger {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
    }

    .badge-gray {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
    }

    .form-label.required::after {
      content: " *";
      color: var(--danger-color);
    }

    .form-control {
      width: 100%;
      padding: 0.625rem 0.875rem;
      font-size: 0.875rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.375rem;
      transition: all 0.2s;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
    }

    .form-control:disabled {
      background: var(--gray-100);
      cursor: not-allowed;
    }

    textarea.form-control {
      resize: vertical;
      min-height: 80px;
    }

    select.form-control {
      cursor: pointer;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 0.5rem;
      box-shadow: var(--shadow-xl);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      cursor: pointer;
      color: var(--gray-500);
      font-size: 1.5rem;
      line-height: 1;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: var(--gray-900);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    .alert {
      padding: 1rem 1.25rem;
      border-radius: 0.375rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
    }

    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      color: #059669;
      border-left: 4px solid #10b981;
    }

    .alert-danger {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border-left: 4px solid #ef4444;
    }

    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      color: #d97706;
      border-left: 4px solid #f59e0b;
    }

    .alert-info {
      background: rgba(6, 182, 212, 0.1);
      color: #0891b2;
      border-left: 4px solid #06b6d4;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--gray-500);
    }

    .empty-state-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      opacity: 0.5;
    }

    .empty-state-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
    }

    .empty-state-text {
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .toolbar-left,
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .search-box {
      position: relative;
      width: 300px;
      max-width: 100%;
    }

    .search-box input {
      width: 100%;
      padding-left: 2.5rem;
    }

    .search-icon {
      position: absolute;
      left: 0.875rem;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      color: var(--gray-400);
    }

    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .text-right {
      text-align: right;
    }

    .text-muted {
      color: var(--gray-500);
    }

    .text-sm {
      font-size: 0.875rem;
    }

    .text-xs {
      font-size: 0.75rem;
    }

    .text-success {
      color: var(--success-color);
    }

    .text-danger {
      color: var(--danger-color);
    }

    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mt-3 { margin-top: 1.5rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }
    .mb-3 { margin-bottom: 1.5rem; }
    .ml-1 { margin-left: 0.5rem; }
    .mr-1 { margin-right: 0.5rem; }

    .p-1 { padding: 0.5rem; }
    .p-2 { padding: 1rem; }
    .p-3 { padding: 1.5rem; }

    .flex {
      display: flex;
    }

    .flex-center {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .gap-1 { gap: 0.5rem; }
    .gap-2 { gap: 1rem; }
    .gap-3 { gap: 1.5rem; }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.active {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
        padding: 1rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .modal-content {
        margin: 0;
        max-height: 100vh;
        border-radius: 0;
      }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <div class="container">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h1>病友管理系統</h1>
        <p>帕金森病友權益促進會</p>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">主要功能</div>
          <a class="nav-item active" data-page="dashboard">
            <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
            儀表板
          </a>
          <a class="nav-item" data-page="members">
            <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
            會員管理
          </a>
          <a class="nav-item" data-page="events">
            <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            活動管理
          </a>
          <a class="nav-item" data-page="volunteers">
            <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
            志工管理
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">財務管理</div>
          <a class="nav-item" data-page="finance">
            <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            財務總覽
          </a>
          <a class="nav-item" data-page="donations">
            <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            捐款管理
          </a>
          <a class="nav-item" data-page="membership-fees">
            <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            會費管理
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">其他功能</div>
          <a class="nav-item" data-page="health">
            <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            健康記錄
          </a>
          <a class="nav-item" data-page="resources">
            <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
            資源媒合
          </a>
        </div>
      </nav>
    </aside>

    <main class="main-content" id="mainContent">
      <!-- 頁面內容將由 JavaScript 動態載入 -->
    </main>
  </div>

  <script>
    // ==================== 全域變數與設定 ====================
    
    // ⚠️ 重要：請將下方 URL 替換為您的 Google Apps Script 部署 URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbynbPYS9hLHGMlUKWA8xZpg8C2I9EIucdDUPAPRfLZ7i8B9IBSNqt878ILTqtYJIjLcCg/exec';
    
    let currentPage = 'dashboard';
    let currentData = {};

    // ==================== 初始化 ====================
    
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

    function initializeApp() {
      // 綁定導航事件
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const page = this.getAttribute('data-page');
          navigateTo(page);
        });
      });

      // 載入儀表板
      navigateTo('dashboard');
    }

    // ==================== 導航與頁面載入 ====================
    
    function navigateTo(page) {
      currentPage = page;

      // 更新側邊欄活動狀態
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-page') === page) {
          item.classList.add('active');
        }
      });

      // 載入頁面內容
      loadPage(page);
    }

    function loadPage(page) {
      const mainContent = document.getElementById('mainContent');

      switch(page) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'members':
          loadMembersPage();
          break;
        case 'events':
          loadEventsPage();
          break;
        case 'volunteers':
          loadVolunteersPage();
          break;
        case 'finance':
          loadFinancePage();
          break;
        case 'donations':
          loadDonationsPage();
          break;
        case 'membership-fees':
          loadMembershipFeesPage();
          break;
        case 'health':
          loadHealthPage();
          break;
        case 'resources':
          loadResourcesPage();
          break;
        default:
          mainContent.innerHTML = '<div class="empty-state"><h3>頁面不存在</h3></div>';
      }
    }

    // ==================== 工具函數 ====================
    
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }

    async function callAPI(action, data = {}) {
      showLoading();
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: action,
            data: JSON.stringify(data)
          })
        });

        const result = await response.json();
        hideLoading();
        return result;
      } catch (error) {
        hideLoading();
        console.error('API 呼叫錯誤:', error);
        showAlert('系統錯誤，請稍後再試', 'danger');
        return { success: false, message: error.message };
      }
    }

    function showAlert(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '9999';
      alertDiv.style.minWidth = '300px';
      alertDiv.style.animation = 'slideInRight 0.3s ease';

      document.body.appendChild(alertDiv);

      setTimeout(() => {
        alertDiv.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => alertDiv.remove(), 300);
      }, 3000);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('zh-TW', {
        style: 'currency',
        currency: 'TWD',
        minimumFractionDigits: 0
      }).format(amount);
    }

    function getTodayDate() {
      const today = new Date();
      return formatDate(today);
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function confirmAction(message) {
      return confirm(message);
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function getEventStatusBadge(status) {
      const badges = {
        '報名中': '<span class="badge badge-success">報名中</span>',
        '額滿': '<span class="badge badge-warning">額滿</span>',
        '已結束': '<span class="badge badge-gray">已結束</span>',
        '草稿': '<span class="badge badge-gray">草稿</span>',
        '已取消': '<span class="badge badge-danger">已取消</span>'
      };
      return badges[status] || '<span class="badge badge-gray">' + status + '</span>';
    }

    function getMemberStatusBadge(status) {
      const badges = {
        '正式會員': '<span class="badge badge-success">正式會員</span>',
        '試用會員': '<span class="badge badge-warning">試用會員</span>',
        '停權': '<span class="badge badge-danger">停權</span>'
      };
      return badges[status] || '<span class="badge badge-gray">' + status + '</span>';
    }

    function getVolunteerStatusBadge(status) {
      const badges = {
        '在職': '<span class="badge badge-success">在職</span>',
        '休假': '<span class="badge badge-warning">休假</span>',
        '離職': '<span class="badge badge-gray">離職</span>'
      };
      return badges[status] || '<span class="badge badge-gray">' + status + '</span>';
    }

    function getServiceStatusBadge(status) {
      const badges = {
        '已審核': '<span class="badge badge-success">已審核</span>',
        '待審核': '<span class="badge badge-warning">待審核</span>',
        '未通過': '<span class="badge badge-danger">未通過</span>'
      };
      return badges[status] || '<span class="badge badge-gray">' + status + '</span>';
    }

    function getResourceStatusBadge(status) {
      const badges = {
        '待處理': '<span class="badge badge-warning">待處理</span>',
        '處理中': '<span class="badge badge-primary">處理中</span>',
        '已完成': '<span class="badge badge-success">已完成</span>',
        '已取消': '<span class="badge badge-gray">已取消</span>'
      };
      return badges[status] || '<span class="badge badge-gray">' + status + '</span>';
    }

    function getUrgencyBadge(urgency) {
      const badges = {
        '緊急': '<span class="badge badge-danger">緊急</span>',
        '重要': '<span class="badge badge-warning">重要</span>',
        '一般': '<span class="badge badge-gray">一般</span>'
      };
      return badges[urgency] || '<span class="badge badge-gray">' + urgency + '</span>';
    }

    // ==================== 儀表板 ====================
    
    async function loadDashboard() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <div class="page-header">
          <h1 class="page-title">儀表板</h1>
          <p class="page-subtitle">系統總覽與統計資訊</p>
        </div>

        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <div class="stat-icon primary">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">總會員數</div>
              <div class="stat-value" id="totalMembers">-</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon success">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">正式會員</div>
              <div class="stat-value" id="activeMembers">-</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon warning">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">本月活動</div>
              <div class="stat-value" id="thisMonthEvents">-</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon info">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">志工服務時數</div>
              <div class="stat-value" id="volunteerHours">-</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">近期活動</h2>
            <button class="btn btn-primary btn-sm" onclick="navigateTo('events')">查看全部</button>
          </div>
          <div id="recentEventsContainer">
            <div class="text-center p-3">載入中...</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">待處理事項</h2>
          </div>
          <div id="pendingTasksContainer">
            <div class="text-center p-3">載入中...</div>
          </div>
        </div>
      `;

      // 載入統計資料
      await loadDashboardStats();
    }

    async function loadDashboardStats() {
      try {
        const stats = await callAPI('getDashboardStats');
        
        if (stats) {
          document.getElementById('totalMembers').textContent = stats.totalMembers || 0;
          document.getElementById('activeMembers').textContent = stats.activeMembers || 0;
          document.getElementById('thisMonthEvents').textContent = stats.thisMonthEvents || 0;
          document.getElementById('volunteerHours').textContent = (stats.volunteerHours || 0) + ' 小時';
        }

        // 載入近期活動
        const events = await callAPI('getEvents', { filters: { timeRange: 'upcoming' } });
        displayRecentEvents(events.slice(0, 5));

        // 載入待處理事項
        loadPendingTasks();

      } catch (error) {
        console.error('載入儀表板統計失敗:', error);
      }
    }

    function displayRecentEvents(events) {
      const container = document.getElementById('recentEventsContainer');
      
      if (!events || events.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>目前沒有近期活動</p></div>';
        return;
      }

      let html = '<div class="table-container"><table><thead><tr>';
      html += '<th>活動名稱</th><th>日期</th><th>地點</th><th>狀態</th><th>報名人數</th>';
      html += '</tr></thead><tbody>';

      events.forEach(event => {
        const statusBadge = getEventStatusBadge(event.status);
        html += `
          <tr>
            <td><strong>${event.name}</strong></td>
            <td>${event.date}</td>
            <td>${event.location}</td>
            <td>${statusBadge}</td>
            <td>${event.registered}/${event.capacity}</td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function loadPendingTasks() {
      const container = document.getElementById('pendingTasksContainer');
      
      container.innerHTML = `
        <div class="alert alert-info">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20" style="margin-right: 0.5rem;">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
          </svg>
          目前沒有待處理事項
        </div>
      `;
    }

    // ==================== 會員管理 ====================
    
    async function loadMembersPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <div class="page-header">
          <h1 class="page-title">會員管理</h1>
          <p class="page-subtitle">管理所有會員資料</p>
        </div>

        <div class="toolbar">
          <div class="toolbar-left">
            <div class="search-box">
              <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <input type="text" class="form-control" id="memberSearch" placeholder="搜尋會員姓名、電話...">
            </div>
            <select class="form-control" id="memberStatusFilter" style="width: 150px;">
              <option value="">全部狀態</option>
              <option value="正式會員">正式會員</option>
              <option value="試用會員">試用會員</option>
              <option value="停權">停權</option>
            </select>
          </div>
          <div class="toolbar-right">
            <button class="btn btn-primary" onclick="openAddMemberModal()">
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              新增會員
            </button>
          </div>
        </div>

        <div class="card">
          <div id="membersTableContainer">
            <div class="text-center p-3">載入中...</div>
          </div>
        </div>

        <!-- 新增/編輯會員模態框 -->
        <div class="modal" id="memberModal">
          <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
              <h3 class="modal-title" id="memberModalTitle">新增會員</h3>
              <button class="modal-close" onclick="closeModal('memberModal')">&times;</button>
            </div>
            <div class="modal-body">
              <form id="memberForm">
                <input type="hidden" id="memberId">
                
                <h4 style="margin-bottom: 1rem; color: var(--primary-color);">基本資料</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label required">姓名</label>
                    <input type="text" class="form-control" id="memberName" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">身分證字號</label>
                    <input type="text" class="form-control" id="memberIdNumber" maxlength="10">
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">出生日期</label>
                    <input type="date" class="form-control" id="memberBirthDate">
                  </div>
                  <div class="form-group">
                    <label class="form-label">性別</label>
                    <select class="form-control" id="memberGender">
                      <option value="">請選擇</option>
                      <option value="男">男</option>
                      <option value="女">女</option>
                      <option value="其他">其他</option>
                    </select>
                  </div>
                </div>

                <h4 style="margin: 1.5rem 0 1rem; color: var(--primary-color);">聯絡資訊</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">聯絡電話</label>
                    <input type="tel" class="form-control" id="memberPhone">
                  </div>
                  <div class="form-group">
                    <label class="form-label required">手機號碼</label>
                    <input type="tel" class="form-control" id="memberMobile" required>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">電子郵件</label>
                  <input type="email" class="form-control" id="memberEmail">
                </div>

                <div class="form-group">
                  <label class="form-label">通訊地址</label>
                  <input type="text" class="form-control" id="memberAddress">
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">居住縣市</label>
                    <input type="text" class="form-control" id="memberCity">
                  </div>
                  <div class="form-group">
                    <label class="form-label">居住鄉鎮</label>
                    <input type="text" class="form-control" id="memberDistrict">
                  </div>
                </div>

                <h4 style="margin: 1.5rem 0 1rem; color: var(--primary-color);">會籍資訊</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">會員類型</label>
                    <select class="form-control" id="memberType">
                      <option value="病友本人">病友本人</option>
                      <option value="家屬">家屬</option>
                      <option value="志工">志工</option>
                      <option value="贊助會員">贊助會員</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">會籍狀態</label>
                    <select class="form-control" id="memberStatus">
                      <option value="試用會員">試用會員</option>
                      <option value="正式會員">正式會員</option>
                      <option value="停權">停權</option>
                    </select>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">入會日期</label>
                  <input type="date" class="form-control" id="memberJoinDate">
                </div>

                <h4 style="margin: 1.5rem 0 1rem; color: var(--primary-color);">健康資訊</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">病程階段</label>
                    <select class="form-control" id="memberStage">
                      <option value="">請選擇</option>
                      <option value="早期">早期</option>
                      <option value="中期">中期</option>
                      <option value="晚期">晚期</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">診斷日期</label>
                    <input type="date" class="form-control" id="memberDiagnosisDate">
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">主治醫師</label>
                  <input type="text" class="form-control" id="memberDoctor">
                </div>

                <h4 style="margin: 1.5rem 0 1rem; color: var(--primary-color);">緊急聯絡人</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">緊急聯絡人</label>
                    <input type="text" class="form-control" id="memberEmergencyContact">
                  </div>
                  <div class="form-group">
                    <label class="form-label">緊急聯絡電話</label>
                    <input type="tel" class="form-control" id="memberEmergencyPhone">
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">關係</label>
                  <input type="text" class="form-control" id="memberRelationship" placeholder="例如：配偶、子女">
                </div>

                <div class="form-group">
                  <label class="form-label">特殊需求</label>
                  <textarea class="form-control" id="memberSpecialNeeds" rows="3"></textarea>
                </div>

                <div class="form-group">
                  <label class="form-label">備註</label>
                  <textarea class="form-control" id="memberNotes" rows="3"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('memberModal')">取消</button>
              <button class="btn btn-primary" onclick="saveMember()">儲存</button>
            </div>
          </div>
        </div>

        <!-- 會員詳情模態框 -->
        <div class="modal" id="memberDetailModal">
          <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
              <h3 class="modal-title">會員詳細資料</h3>
              <button class="modal-close" onclick="closeModal('memberDetailModal')">&times;</button>
            </div>
            <div class="modal-body" id="memberDetailContent">
              <!-- 內容由 JavaScript 動態生成 -->
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('memberDetailModal')">關閉</button>
            </div>
          </div>
        </div>
      `;

      // 綁定搜尋事件
      document.getElementById('memberSearch').addEventListener('input', debounce(loadMembersData, 500));
      document.getElementById('memberStatusFilter').addEventListener('change', loadMembersData);

      // 載入會員資料
      await loadMembersData();
    }

    async function loadMembersData() {
      const container = document.getElementById('membersTableContainer');
      const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
      const statusFilter = document.getElementById('memberStatusFilter').value;

      try {
        let members = await callAPI('getMembers');

        // 篩選
        if (searchTerm) {
          members = members.filter(m => 
            m.name.toLowerCase().includes(searchTerm) ||
            (m.phone && m.phone.includes(searchTerm)) ||
            (m.mobile && m.mobile.includes(searchTerm)) ||
            (m.id && m.id.toLowerCase().includes(searchTerm))
          );
        }

        if (statusFilter) {
          members = members.filter(m => m.status === statusFilter);
        }

        displayMembersTable(members);
      } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">載入會員資料失敗</div>';
      }
    }

    function displayMembersTable(members) {
      const container = document.getElementById('membersTableContainer');

      if (!members || members.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
            <h3 class="empty-state-title">沒有找到會員</h3>
            <p class="empty-state-text">請調整搜尋條件或新增第一位會員</p>
            <button class="btn btn-primary" onclick="openAddMemberModal()">新增會員</button>
          </div>
        `;
        return;
      }

      let html = '<div class="table-container"><table><thead><tr>';
      html += '<th>會員編號</th><th>姓名</th><th>性別</th><th>聯絡電話</th>';
      html += '<th>會員類型</th><th>會籍狀態</th><th>入會日期</th><th>操作</th>';
      html += '</tr></thead><tbody>';

      members.forEach(member => {
        const statusBadge = getMemberStatusBadge(member.status);
        html += `
          <tr>
            <td><code>${member.id}</code></td>
            <td><strong>${member.name}</strong></td>
            <td>${member.gender || '-'}</td>
            <td>${member.mobile || member.phone || '-'}</td>
            <td>${member.memberType || '-'}</td>
            <td>${statusBadge}</td>
            <td>${member.joinDate || '-'}</td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="viewMemberDetail('${member.id}')">查看</button>
              <button class="btn btn-sm btn-primary" onclick="editMember('${member.id}')">編輯</button>
              <button class="btn btn-sm btn-danger" onclick="deleteMember('${member.id}', '${member.name}')">刪除</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function openAddMemberModal() {
      document.getElementById('memberModalTitle').textContent = '新增會員';
      document.getElementById('memberForm').reset();
      document.getElementById('memberId').value = '';
      document.getElementById('memberJoinDate').value = getTodayDate();
      openModal('memberModal');
    }

    async function editMember(memberId) {
      const member = await callAPI('getMemberById', { memberId: memberId });
      
      if (!member) {
        showAlert('找不到會員資料', 'danger');
        return;
      }

      document.getElementById('memberModalTitle').textContent = '編輯會員';
      document.getElementById('memberId').value = member.id;
      document.getElementById('memberName').value = member.name || '';
      document.getElementById('memberIdNumber').value = member.idNumber || '';
      document.getElementById('memberBirthDate').value = member.birthDate || '';
      document.getElementById('memberGender').value = member.gender || '';
      document.getElementById('memberPhone').value = member.phone || '';
      document.getElementById('memberMobile').value = member.mobile || '';
      document.getElementById('memberEmail').value = member.email || '';
      document.getElementById('memberAddress').value = member.address || '';
      document.getElementById('memberCity').value = member.city || '';
      document.getElementById('memberDistrict').value = member.district || '';
      document.getElementById('memberType').value = member.memberType || '病友本人';
      document.getElementById('memberStatus').value = member.status || '試用會員';
      document.getElementById('memberJoinDate').value = member.joinDate || '';
      document.getElementById('memberStage').value = member.stage || '';
      document.getElementById('memberDiagnosisDate').value = member.diagnosisDate || '';
      document.getElementById('memberDoctor').value = member.doctor || '';
      document.getElementById('memberEmergencyContact').value = member.emergencyContact || '';
      document.getElementById('memberEmergencyPhone').value = member.emergencyPhone || '';
      document.getElementById('memberRelationship').value = member.relationship || '';
      document.getElementById('memberSpecialNeeds').value = member.specialNeeds || '';
      document.getElementById('memberNotes').value = member.notes || '';

      openModal('memberModal');
    }

    async function saveMember() {
      const memberId = document.getElementById('memberId').value;
      const memberData = {
        name: document.getElementById('memberName').value,
        idNumber: document.getElementById('memberIdNumber').value,
        birthDate: document.getElementById('memberBirthDate').value,
        gender: document.getElementById('memberGender').value,
        phone: document.getElementById('memberPhone').value,
        mobile: document.getElementById('memberMobile').value,
        email: document.getElementById('memberEmail').value,
        address: document.getElementById('memberAddress').value,
        city: document.getElementById('memberCity').value,
        district: document.getElementById('memberDistrict').value,
        memberType: document.getElementById('memberType').value,
        status: document.getElementById('memberStatus').value,
        joinDate: document.getElementById('memberJoinDate').value,
        stage: document.getElementById('memberStage').value,
        diagnosisDate: document.getElementById('memberDiagnosisDate').value,
        doctor: document.getElementById('memberDoctor').value,
        emergencyContact: document.getElementById('memberEmergencyContact').value,
        emergencyPhone: document.getElementById('memberEmergencyPhone').value,
        relationship: document.getElementById('memberRelationship').value,
        specialNeeds: document.getElementById('memberSpecialNeeds').value,
        notes: document.getElementById('memberNotes').value
      };

      // 驗證必填欄位
      if (!memberData.name || !memberData.mobile) {
        showAlert('請填寫必填欄位', 'warning');
        return;
      }

      let result;
      if (memberId) {
        memberData.memberId = memberId;
        result = await callAPI('updateMember', memberData);
      } else {
        result = await callAPI('addMember', memberData);
      }

      if (result.success) {
        showAlert(result.message, 'success');
        closeModal('memberModal');
        loadMembersData();
      } else {
        showAlert(result.message || '操作失敗', 'danger');
      }
    }

    async function viewMemberDetail(memberId) {
      const member = await callAPI('getMemberById', { memberId: memberId });
      
      if (!member) {
        showAlert('找不到會員資料', 'danger');
        return;
      }

      const content = document.getElementById('memberDetailContent');
      content.innerHTML = `
        <div style="display: grid; gap: 1.5rem;">
          <div>
            <h4 style="color: var(--primary-color); margin-bottom: 0.75rem;">基本資料</h4>
            <table style="width: 100%;">
              <tr><td style="padding: 0.5rem 0; width: 30%; color: var(--gray-600);">會員編號</td><td><code>${member.id}</code></td></tr>
              <tr><td style="padding: 0.5rem 0; color: var(--gray-600);">姓名</td><td><strong>${member.name}</strong></td></tr>
              <tr><td style="padding: 0.5rem 0; color: var(--gray-600);">身分證字號</td><td>${member.idNumber || '-'}</td></tr>
              <tr><td style="padding: 0.5rem 0; color: var(--gray-600);">出生日期</td><td>${member.birthDate || '-'}</td></tr>
              <tr><td style="padding: 0.5rem 0; color: var(--gray-600);">性別</td><td>${member.gender || '-'}</td></tr>
            </table>
          </div>

          <div>
            <h4 style="color: var(--primary-color); margin-bottom: 0.75rem;">聯絡資訊</h4>
            <table style="width: 100%;">
              <tr><td style="padding: 0.5rem 0; width: 30%; color: var(--gray-600);">聯絡電話</td><td>${member.phone || '-'}</td></tr>
              <tr><td style="padding: 0.5rem 0; color: var(--gray-600);">手機號碼</td><td>${member.mobile || '-'}</td></tr>
              <tr><td style="padding: 0.5rem 0; color: var(--gray-600);">電子郵件</td><td>${member.email || '-'}</td></tr>
              <tr><td style="padding: 0.5rem 0; color: var(--gray-600);">通訊地址</td><td>${member.address || '-'}</td></tr>
              <tr><td style="padding: 0.5rem 0; color: var(--gray-600);">居住地</td><td>${member.city || ''} ${member.district || ''}</td></tr>
            </table>
          </div>

          <div>
            <h4 style="color: var(--primary-color); margin-bottom: 0.75rem;">會籍資訊</h4>
            <table style="width: 100%;">
              <tr><td style="padding: 0.5rem 0; width: 30%; color: var(--gray-600);">會員類型</td><td>${member.memberType || '-'}</td></tr>
              <tr><td style="padding: 0.5rem 0; color: var(--gray-600);">會籍狀態</td><td>${getMemberStatusBadge(member.status)}</td></tr>
              <tr><td style="padding: 0.5rem 0; color: var(--gray-600);">入會日期</td><td>${member.joinDate || '-'}</td></tr>
            </table>
          </div>

          <div>
            <h4 style="color: var(--primary-color); margin-bottom: 0.75rem;">健康資訊</h4>
            <table style="width: 100%;">
              <tr><td style="padding: 0.5rem 0; width: 30%; color: var(--gray-600);">病程階段</td><td>${member.stage || '-'}</td></tr>
              <tr><td style="padding: 0.5rem 0; color: var(--gray-600);">診斷日期</td><td>${member.diagnosisDate || '-'}</td></tr>
              <tr><td style="padding: 0.5rem 0; color: var(--gray-600);">主治醫師</td><td>${member.doctor || '-'}</td></tr>
            </table>
          </div>

          <div>
            <h4 style="color: var(--primary-color); margin-bottom: 0.75rem;">緊急聯絡人</h4>
            <table style="width: 100%;">
              <tr><td style="padding: 0.5rem 0; width: 30%; color: var(--gray-600);">姓名</td><td>${member.emergencyContact || '-'}</td></tr>
              <tr><td style="padding: 0.5rem 0; color: var(--gray-600);">電話</td><td>${member.emergencyPhone || '-'}</td></tr>
              <tr><td style="padding: 0.5rem 0; color: var(--gray-600);">關係</td><td>${member.relationship || '-'}</td></tr>
            </table>
          </div>

          ${member.specialNeeds ? `
            <div>
              <h4 style="color: var(--primary-color); margin-bottom: 0.75rem;">特殊需求</h4>
              <p style="padding: 0.75rem; background: var(--gray-50); border-radius: 0.375rem;">${member.specialNeeds}</p>
            </div>
          ` : ''}

          ${member.notes ? `
            <div>
              <h4 style="color: var(--primary-color); margin-bottom: 0.75rem;">備註</h4>
              <p style="padding: 0.75rem; background: var(--gray-50); border-radius: 0.375rem;">${member.notes}</p>
            </div>
          ` : ''}
        </div>
      `;

      openModal('memberDetailModal');
    }

    async function deleteMember(memberId, memberName) {
      if (!confirmAction(`確定要刪除會員「${memberName}」嗎？此操作無法復原。`)) {
        return;
      }

      const result = await callAPI('deleteMember', { memberId: memberId });

      if (result.success) {
        showAlert(result.message, 'success');
        loadMembersData();
      } else {
        showAlert(result.message || '刪除失敗', 'danger');
      }
    }

    // ==================== 活動管理 ====================
    
    async function loadEventsPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <div class="page-header">
          <h1 class="page-title">活動管理</h1>
          <p class="page-subtitle">管理所有活動與報名資訊</p>
        </div>

        <div class="toolbar">
          <div class="toolbar-left">
            <div class="search-box">
              <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <input type="text" class="form-control" id="eventSearch" placeholder="搜尋活動名稱...">
            </div>
            <select class="form-control" id="eventTimeFilter" style="width: 150px;">
              <option value="">全部活動</option>
              <option value="upcoming">即將舉行</option>
              <option value="thisMonth">本月活動</option>
              <option value="past">已結束</option>
            </select>
            <select class="form-control" id="eventTypeFilter" style="width: 150px;">
              <option value="">全部類型</option>
              <option value="健康講座">健康講座</option>
              <option value="復健課程">復健課程</option>
              <option value="聯誼活動">聯誼活動</option>
              <option value="志工培訓">志工培訓</option>
              <option value="其他活動">其他活動</option>
            </select>
          </div>
          <div class="toolbar-right">
            <button class="btn btn-primary" onclick="openAddEventModal()">
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              新增活動
            </button>
          </div>
        </div>

        <div class="card">
          <div id="eventsTableContainer">
            <div class="text-center p-3">載入中...</div>
          </div>
        </div>

        <!-- 新增/編輯活動模態框 -->
        <div class="modal" id="eventModal">
          <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
              <h3 class="modal-title" id="eventModalTitle">新增活動</h3>
              <button class="modal-close" onclick="closeModal('eventModal')">&times;</button>
            </div>
            <div class="modal-body">
              <form id="eventForm">
                <input type="hidden" id="eventId">
                
                <div class="form-group">
                  <label class="form-label required">活動名稱</label>
                  <input type="text" class="form-control" id="eventName" required>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label required">活動日期</label>
                    <input type="date" class="form-control" id="eventDate" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label required">活動時間</label>
                    <input type="time" class="form-control" id="eventTime" required>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label required">活動地點</label>
                  <input type="text" class="form-control" id="eventLocation" required>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">活動類型</label>
                    <select class="form-control" id="eventType">
                      <option value="健康講座">健康講座</option>
                      <option value="復健課程">復健課程</option>
                      <option value="聯誼活動">聯誼活動</option>
                      <option value="志工培訓">志工培訓</option>
                      <option value="其他活動">其他活動</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label required">名額限制</label>
                    <input type="number" class="form-control" id="eventCapacity" min="1" required>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">活動說明</label>
                  <textarea class="form-control" id="eventDescription" rows="4"></textarea>
                </div>

                <div class="form-group">
                  <label class="form-label">無障礙設施</label>
                  <textarea class="form-control" id="eventAccessibility" rows="2" placeholder="例如：有無障礙電梯、無障礙廁所"></textarea>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">報名截止日</label>
                    <input type="date" class="form-control" id="eventRegistrationDeadline">
                  </div>
                  <div class="form-group">
                    <label class="form-label">活動狀態</label>
                    <select class="form-control" id="eventStatus">
                      <option value="草稿">草稿</option>
                      <option value="報名中">報名中</option>
                      <option value="額滿">額滿</option>
                      <option value="已結束">已結束</option>
                      <option value="已取消">已取消</option>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">負責人</label>
                    <input type="text" class="form-control" id="eventOrganizer">
                  </div>
                  <div class="form-group">
                    <label class="form-label">聯絡電話</label>
                    <input type="tel" class="form-control" id="eventPhone">
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">活動費用</label>
                  <input type="number" class="form-control" id="eventFee" min="0" value="0">
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('eventModal')">取消</button>
              <button class="btn btn-primary" onclick="saveEvent()">儲存</button>
            </div>
          </div>
        </div>

        <!-- 活動報名管理模態框 -->
        <div class="modal" id="eventRegistrationsModal">
          <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
              <h3 class="modal-title" id="registrationsModalTitle">活動報名管理</h3>
              <button class="modal-close" onclick="closeModal('eventRegistrationsModal')">&times;</button>
            </div>
            <div class="modal-body">
              <div class="toolbar mb-3">
                <div class="toolbar-left">
                  <button class="btn btn-primary btn-sm" onclick="openEventRegistrationModal()">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    新增報名
                  </button>
                </div>
                <div class="toolbar-right">
                  <span id="registrationStats" class="text-muted"></span>
                </div>
              </div>
              <div id="registrationsTableContainer">
                <div class="text-center p-3">載入中...</div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('eventRegistrationsModal')">關閉</button>
            </div>
          </div>
        </div>

        <!-- 新增報名模態框 -->
        <div class="modal" id="eventRegistrationModal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">新增活動報名</h3>
              <button class="modal-close" onclick="closeModal('eventRegistrationModal')">&times;</button>
            </div>
            <div class="modal-body">
              <form id="registrationForm">
                <input type="hidden" id="regEventId">
                
                <div class="form-group">
                  <label class="form-label required">選擇會員</label>
                  <select class="form-control" id="regMemberId" required>
                    <option value="">請選擇會員</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">備註</label>
                  <textarea class="form-control" id="regNotes" rows="3"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('eventRegistrationModal')">取消</button>
              <button class="btn btn-primary" onclick="saveEventRegistration()">確認報名</button>
            </div>
          </div>
        </div>
      `;

      // 綁定搜尋事件
      document.getElementById('eventSearch').addEventListener('input', debounce(loadEventsData, 500));
      document.getElementById('eventTimeFilter').addEventListener('change', loadEventsData);
      document.getElementById('eventTypeFilter').addEventListener('change', loadEventsData);

      // 載入活動資料
      await loadEventsData();
    }

    async function loadEventsData() {
      const container = document.getElementById('eventsTableContainer');
      const searchTerm = document.getElementById('eventSearch').value.toLowerCase();
      const timeFilter = document.getElementById('eventTimeFilter').value;
      const typeFilter = document.getElementById('eventTypeFilter').value;

      try {
        let events = await callAPI('getEvents', { 
          filters: { timeRange: timeFilter } 
        });

        // 篩選
        if (searchTerm) {
          events = events.filter(e => 
            e.name.toLowerCase().includes(searchTerm) ||
            (e.location && e.location.toLowerCase().includes(searchTerm))
          );
        }

        if (typeFilter) {
          events = events.filter(e => e.type === typeFilter);
        }

        displayEventsTable(events);
      } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">載入活動資料失敗</div>';
      }
    }

    function displayEventsTable(events) {
      const container = document.getElementById('eventsTableContainer');

      if (!events || events.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <h3 class="empty-state-title">沒有找到活動</h3>
            <p class="empty-state-text">請調整搜尋條件或新增第一個活動</p>
            <button class="btn btn-primary" onclick="openAddEventModal()">新增活動</button>
          </div>
        `;
        return;
      }

      let html = '<div class="table-container"><table><thead><tr>';
      html += '<th>活動名稱</th><th>日期時間</th><th>地點</th><th>類型</th>';
      html += '<th>報名人數</th><th>狀態</th><th>操作</th>';
      html += '</tr></thead><tbody>';

      events.forEach(event => {
        const statusBadge = getEventStatusBadge(event.status);
        const dateTime = `${event.date} ${event.time}`;
        const capacityClass = event.registered >= event.capacity ? 'text-danger' : '';
        
        html += `
          <tr>
            <td><strong>${event.name}</strong></td>
            <td>${dateTime}</td>
            <td>${event.location}</td>
            <td><span class="badge badge-primary">${event.type}</span></td>
            <td class="${capacityClass}"><strong>${event.registered}/${event.capacity}</strong></td>
            <td>${statusBadge}</td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="viewEventRegistrations('${event.id}', '${event.name}')">報名</button>
              <button class="btn btn-sm btn-primary" onclick="editEvent('${event.id}')">編輯</button>
              <button class="btn btn-sm btn-danger" onclick="deleteEvent('${event.id}', '${event.name}')">刪除</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function openAddEventModal() {
      document.getElementById('eventModalTitle').textContent = '新增活動';
      document.getElementById('eventForm').reset();
      document.getElementById('eventId').value = '';
      document.getElementById('eventDate').value = getTodayDate();
      document.getElementById('eventStatus').value = '草稿';
      openModal('eventModal');
    }

    async function editEvent(eventId) {
      const event = await callAPI('getEventById', { eventId: eventId });
      
      if (!event) {
        showAlert('找不到活動資料', 'danger');
        return;
      }

      document.getElementById('eventModalTitle').textContent = '編輯活動';
      document.getElementById('eventId').value = event.id;
      document.getElementById('eventName').value = event.name || '';
      document.getElementById('eventDate').value = event.date || '';
      document.getElementById('eventTime').value = event.time || '';
      document.getElementById('eventLocation').value = event.location || '';
      document.getElementById('eventType').value = event.type || '其他活動';
      document.getElementById('eventCapacity').value = event.capacity || 30;
      document.getElementById('eventDescription').value = event.description || '';
      document.getElementById('eventAccessibility').value = event.accessibility || '';
      document.getElementById('eventRegistrationDeadline').value = event.registrationDeadline || '';
      document.getElementById('eventStatus').value = event.status || '草稿';
      document.getElementById('eventOrganizer').value = event.organizer || '';
      document.getElementById('eventPhone').value = event.phone || '';
      document.getElementById('eventFee').value = event.fee || 0;

      openModal('eventModal');
    }

    async function saveEvent() {
      const eventId = document.getElementById('eventId').value;
      const eventData = {
        name: document.getElementById('eventName').value,
        date: document.getElementById('eventDate').value,
        time: document.getElementById('eventTime').value,
        location: document.getElementById('eventLocation').value,
        type: document.getElementById('eventType').value,
        capacity: parseInt(document.getElementById('eventCapacity').value),
        description: document.getElementById('eventDescription').value,
        accessibility: document.getElementById('eventAccessibility').value,
        registrationDeadline: document.getElementById('eventRegistrationDeadline').value,
        status: document.getElementById('eventStatus').value,
        organizer: document.getElementById('eventOrganizer').value,
        phone: document.getElementById('eventPhone').value,
        fee: parseFloat(document.getElementById('eventFee').value) || 0
      };

      // 驗證必填欄位
      if (!eventData.name || !eventData.date || !eventData.time || !eventData.location) {
        showAlert('請填寫必填欄位', 'warning');
        return;
      }

      let result;
      if (eventId) {
        eventData.eventId = eventId;
        result = await callAPI('updateEvent', eventData);
      } else {
        result = await callAPI('addEvent', eventData);
      }

      if (result.success) {
        showAlert(result.message, 'success');
        closeModal('eventModal');
        loadEventsData();
      } else {
        showAlert(result.message || '操作失敗', 'danger');
      }
    }

    async function deleteEvent(eventId, eventName) {
      if (!confirmAction(`確定要刪除活動「${eventName}」嗎？此操作無法復原。`)) {
        return;
      }

      const result = await callAPI('deleteEvent', { eventId: eventId });

      if (result.success) {
        showAlert(result.message, 'success');
        loadEventsData();
      } else {
        showAlert(result.message || '刪除失敗', 'danger');
      }
    }

    async function viewEventRegistrations(eventId, eventName) {
      currentData.currentEventId = eventId;
      document.getElementById('registrationsModalTitle').textContent = `活動報名管理 - ${eventName}`;
      
      openModal('eventRegistrationsModal');
      await loadEventRegistrations(eventId);
    }

    async function loadEventRegistrations(eventId) {
      const container = document.getElementById('registrationsTableContainer');
      
      try {
        const registrations = await callAPI('getEventRegistrations', { eventId: eventId });
        
        // 更新統計
        const activeCount = registrations.filter(r => r.status === '已報名').length;
        document.getElementById('registrationStats').textContent = `已報名：${activeCount} 人`;

        if (!registrations || registrations.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>目前沒有報名記錄</p>
              <button class="btn btn-primary btn-sm" onclick="openEventRegistrationModal()">新增報名</button>
            </div>
          `;
          return;
        }

        let html = '<div class="table-container"><table><thead><tr>';
        html += '<th>會員姓名</th><th>聯絡電話</th><th>報名時間</th><th>狀態</th><th>簽到時間</th><th>操作</th>';
        html += '</tr></thead><tbody>';

        registrations.forEach(reg => {
          const statusBadge = reg.status === '已報名' 
            ? '<span class="badge badge-success">已報名</span>'
            : '<span class="badge badge-gray">已取消</span>';
          
          const checkInStatus = reg.checkInTime 
            ? `<span class="badge badge-success">已簽到</span><br><small>${reg.checkInTime}</small>`
            : '<span class="badge badge-gray">未簽到</span>';

          html += `
            <tr>
              <td><strong>${reg.memberName}</strong></td>
              <td>${reg.memberPhone}</td>
              <td>${reg.regDate}</td>
              <td>${statusBadge}</td>
              <td>${checkInStatus}</td>
              <td>
                ${reg.status === '已報名' && !reg.checkInTime ? 
                  `<button class="btn btn-sm btn-success" onclick="checkInRegistration('${reg.regId}')">簽到</button>` : ''}
                ${reg.status === '已報名' ? 
                  `<button class="btn btn-sm btn-danger" onclick="cancelRegistration('${reg.regId}')">取消</button>` : ''}
              </td>
            </tr>
          `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;

      } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">載入報名資料失敗</div>';
      }
    }

    async function openEventRegistrationModal() {
      // 載入會員列表
      const members = await callAPI('getMembers');
      const select = document.getElementById('regMemberId');
      
      select.innerHTML = '<option value="">請選擇會員</option>';
      members.forEach(member => {
        if (member.status !== '停權') {
          select.innerHTML += `<option value="${member.id}">${member.name} (${member.mobile})</option>`;
        }
      });

      document.getElementById('regEventId').value = currentData.currentEventId;
      document.getElementById('registrationForm').reset();
      openModal('eventRegistrationModal');
    }

    async function saveEventRegistration() {
      const eventId = document.getElementById('regEventId').value;
      const memberId = document.getElementById('regMemberId').value;
      const notes = document.getElementById('regNotes').value;

      if (!memberId) {
        showAlert('請選擇會員', 'warning');
        return;
      }

      // 取得會員資料
      const member = await callAPI('getMemberById', { memberId: memberId });
      
      if (!member) {
        showAlert('找不到會員資料', 'danger');
        return;
      }

      const result = await callAPI('registerEvent', {
        eventId: eventId,
        memberId: memberId,
        memberName: member.name,
        memberPhone: member.mobile || member.phone,
        notes: notes
      });

      if (result.success) {
        showAlert(result.message, 'success');
        closeModal('eventRegistrationModal');
        loadEventRegistrations(eventId);
      } else {
        showAlert(result.message || '報名失敗', 'danger');
      }
    }

    async function cancelRegistration(regId) {
      if (!confirmAction('確定要取消此報名嗎？')) {
        return;
      }

      const result = await callAPI('cancelRegistration', { regId: regId });

      if (result.success) {
        showAlert(result.message, 'success');
        loadEventRegistrations(currentData.currentEventId);
      } else {
        showAlert(result.message || '取消失敗', 'danger');
      }
    }

    async function checkInRegistration(regId) {
      const result = await callAPI('checkInEvent', { regId: regId });

      if (result.success) {
        showAlert(result.message, 'success');
        loadEventRegistrations(currentData.currentEventId);
      } else {
        showAlert(result.message || '簽到失敗', 'danger');
      }
    }

    // ==================== 志工管理 ====================
    
    async function loadVolunteersPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <div class="page-header">
          <h1 class="page-title">志工管理</h1>
          <p class="page-subtitle">管理志工資料與服務記錄</p>
        </div>

        <div class="toolbar">
          <div class="toolbar-left">
            <div class="search-box">
              <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <input type="text" class="form-control" id="volunteerSearch" placeholder="搜尋志工姓名、電話...">
            </div>
            <select class="form-control" id="volunteerStatusFilter" style="width: 150px;">
              <option value="">全部狀態</option>
              <option value="在職">在職</option>
              <option value="休假">休假</option>
              <option value="離職">離職</option>
            </select>
          </div>
          <div class="toolbar-right">
            <button class="btn btn-primary" onclick="openAddVolunteerModal()">
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              新增志工
            </button>
          </div>
        </div>

        <div class="card">
          <div id="volunteersTableContainer">
            <div class="text-center p-3">載入中...</div>
          </div>
        </div>

        <!-- 新增/編輯志工模態框 -->
        <div class="modal" id="volunteerModal">
          <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
              <h3 class="modal-title" id="volunteerModalTitle">新增志工</h3>
              <button class="modal-close" onclick="closeModal('volunteerModal')">&times;</button>
            </div>
            <div class="modal-body">
              <form id="volunteerForm">
                <input type="hidden" id="volunteerId">
                
                <h4 style="margin-bottom: 1rem; color: var(--primary-color);">基本資料</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label required">姓名</label>
                    <input type="text" class="form-control" id="volunteerName" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">性別</label>
                    <select class="form-control" id="volunteerGender">
                      <option value="">請選擇</option>
                      <option value="男">男</option>
                      <option value="女">女</option>
                      <option value="其他">其他</option>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label required">聯絡電話</label>
                    <input type="tel" class="form-control" id="volunteerPhone" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">電子郵件</label>
                    <input type="email" class="form-control" id="volunteerEmail">
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">地址</label>
                  <input type="text" class="form-control" id="volunteerAddress">
                </div>

                <h4 style="margin: 1.5rem 0 1rem; color: var(--primary-color);">志工資訊</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">加入日期</label>
                    <input type="date" class="form-control" id="volunteerJoinDate">
                  </div>
                  <div class="form-group">
                    <label class="form-label">志工狀態</label>
                    <select class="form-control" id="volunteerStatus">
                      <option value="在職">在職</option>
                      <option value="休假">休假</option>
                      <option value="離職">離職</option>
                    </select>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">專長</label>
                  <input type="text" class="form-control" id="volunteerSkills" placeholder="例如：護理、復健、活動企劃">
                </div>

                <div class="form-group">
                  <label class="form-label">可服務時段</label>
                  <input type="text" class="form-control" id="volunteerAvailability" placeholder="例如：週一至週五 09:00-17:00">
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">緊急聯絡人</label>
                    <input type="text" class="form-control" id="volunteerEmergencyContact">
                  </div>
                  <div class="form-group">
                    <label class="form-label">緊急聯絡電話</label>
                    <input type="tel" class="form-control" id="volunteerEmergencyPhone">
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">備註</label>
                  <textarea class="form-control" id="volunteerNotes" rows="3"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('volunteerModal')">取消</button>
              <button class="btn btn-primary" onclick="saveVolunteer()">儲存</button>
            </div>
          </div>
        </div>

        <!-- 服務記錄管理模態框 -->
        <div class="modal" id="serviceRecordsModal">
          <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
              <h3 class="modal-title" id="serviceRecordsModalTitle">服務記錄管理</h3>
              <button class="modal-close" onclick="closeModal('serviceRecordsModal')">&times;</button>
            </div>
            <div class="modal-body">
              <div class="toolbar mb-3">
                <div class="toolbar-left">
                  <button class="btn btn-primary btn-sm" onclick="openAddServiceRecordModal()">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    新增記錄
                  </button>
                </div>
                <div class="toolbar-right">
                  <span id="serviceStats" class="text-muted"></span>
                </div>
              </div>
              <div id="serviceRecordsTableContainer">
                <div class="text-center p-3">載入中...</div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('serviceRecordsModal')">關閉</button>
            </div>
          </div>
        </div>

        <!-- 新增服務記錄模態框 -->
        <div class="modal" id="serviceRecordModal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title" id="serviceRecordModalTitle">新增服務記錄</h3>
              <button class="modal-close" onclick="closeModal('serviceRecordModal')">&times;</button>
            </div>
            <div class="modal-body">
              <form id="serviceRecordForm">
                <input type="hidden" id="serviceRecordId">
                <input type="hidden" id="serviceVolunteerId">
                
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label required">服務日期</label>
                    <input type="date" class="form-control" id="serviceDate" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label required">服務時數</label>
                    <input type="number" class="form-control" id="serviceHours" min="0" step="0.5" required>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">服務類型</label>
                  <select class="form-control" id="serviceType">
                    <option value="活動協助">活動協助</option>
                    <option value="居家訪視">居家訪視</option>
                    <option value="電話關懷">電話關懷</option>
                    <option value="行政支援">行政支援</option>
                    <option value="其他服務">其他服務</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label required">服務內容</label>
                  <textarea class="form-control" id="serviceDescription" rows="4" required></textarea>
                </div>

                <div class="form-group">
                  <label class="form-label">審核狀態</label>
                  <select class="form-control" id="serviceApprovalStatus">
                    <option value="待審核">待審核</option>
                    <option value="已審核">已審核</option>
                    <option value="未通過">未通過</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">備註</label>
                  <textarea class="form-control" id="serviceNotes" rows="2"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('serviceRecordModal')">取消</button>
              <button class="btn btn-primary" onclick="saveServiceRecord()">儲存</button>
            </div>
          </div>
        </div>
      `;

      // 綁定搜尋事件
      document.getElementById('volunteerSearch').addEventListener('input', debounce(loadVolunteersData, 500));
      document.getElementById('volunteerStatusFilter').addEventListener('change', loadVolunteersData);

      // 載入志工資料
      await loadVolunteersData();
    }

    async function loadVolunteersData() {
      const container = document.getElementById('volunteersTableContainer');
      const searchTerm = document.getElementById('volunteerSearch').value.toLowerCase();
      const statusFilter = document.getElementById('volunteerStatusFilter').value;

      try {
        let volunteers = await callAPI('getVolunteers');

        // 篩選
        if (searchTerm) {
          volunteers = volunteers.filter(v => 
            v.name.toLowerCase().includes(searchTerm) ||
            (v.phone && v.phone.includes(searchTerm)) ||
            (v.id && v.id.toLowerCase().includes(searchTerm))
          );
        }

        if (statusFilter) {
          volunteers = volunteers.filter(v => v.status === statusFilter);
        }

        displayVolunteersTable(volunteers);
      } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">載入志工資料失敗</div>';
      }
    }

    function displayVolunteersTable(volunteers) {
      const container = document.getElementById('volunteersTableContainer');

      if (!volunteers || volunteers.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
            <h3 class="empty-state-title">沒有找到志工</h3>
            <p class="empty-state-text">請調整搜尋條件或新增第一位志工</p>
            <button class="btn btn-primary" onclick="openAddVolunteerModal()">新增志工</button>
          </div>
        `;
        return;
      }

      let html = '<div class="table-container"><table><thead><tr>';
      html += '<th>志工編號</th><th>姓名</th><th>性別</th><th>聯絡電話</th>';
      html += '<th>專長</th><th>服務時數</th><th>狀態</th><th>操作</th>';
      html += '</tr></thead><tbody>';

      volunteers.forEach(volunteer => {
        const statusBadge = getVolunteerStatusBadge(volunteer.status);
        html += `
          <tr>
            <td><code>${volunteer.id}</code></td>
            <td><strong>${volunteer.name}</strong></td>
            <td>${volunteer.gender || '-'}</td>
            <td>${volunteer.phone || '-'}</td>
            <td>${volunteer.skills || '-'}</td>
            <td><strong>${volunteer.totalHours || 0}</strong> 小時</td>
            <td>${statusBadge}</td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="viewServiceRecords('${volunteer.id}', '${volunteer.name}')">記錄</button>
              <button class="btn btn-sm btn-primary" onclick="editVolunteer('${volunteer.id}')">編輯</button>
              <button class="btn btn-sm btn-danger" onclick="deleteVolunteer('${volunteer.id}', '${volunteer.name}')">刪除</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function openAddVolunteerModal() {
      document.getElementById('volunteerModalTitle').textContent = '新增志工';
      document.getElementById('volunteerForm').reset();
      document.getElementById('volunteerId').value = '';
      document.getElementById('volunteerJoinDate').value = getTodayDate();
      document.getElementById('volunteerStatus').value = '在職';
      openModal('volunteerModal');
    }

    async function editVolunteer(volunteerId) {
      const volunteer = await callAPI('getVolunteerById', { volunteerId: volunteerId });
      
      if (!volunteer) {
        showAlert('找不到志工資料', 'danger');
        return;
      }

      document.getElementById('volunteerModalTitle').textContent = '編輯志工';
      document.getElementById('volunteerId').value = volunteer.id;
      document.getElementById('volunteerName').value = volunteer.name || '';
      document.getElementById('volunteerGender').value = volunteer.gender || '';
      document.getElementById('volunteerPhone').value = volunteer.phone || '';
      document.getElementById('volunteerEmail').value = volunteer.email || '';
      document.getElementById('volunteerAddress').value = volunteer.address || '';
      document.getElementById('volunteerJoinDate').value = volunteer.joinDate || '';
      document.getElementById('volunteerStatus').value = volunteer.status || '在職';
      document.getElementById('volunteerSkills').value = volunteer.skills || '';
      document.getElementById('volunteerAvailability').value = volunteer.availability || '';
      document.getElementById('volunteerEmergencyContact').value = volunteer.emergencyContact || '';
      document.getElementById('volunteerEmergencyPhone').value = volunteer.emergencyPhone || '';
      document.getElementById('volunteerNotes').value = volunteer.notes || '';

      openModal('volunteerModal');
    }

    async function saveVolunteer() {
      const volunteerId = document.getElementById('volunteerId').value;
      const volunteerData = {
        name: document.getElementById('volunteerName').value,
        gender: document.getElementById('volunteerGender').value,
        phone: document.getElementById('volunteerPhone').value,
        email: document.getElementById('volunteerEmail').value,
        address: document.getElementById('volunteerAddress').value,
        joinDate: document.getElementById('volunteerJoinDate').value,
        status: document.getElementById('volunteerStatus').value,
        skills: document.getElementById('volunteerSkills').value,
        availability: document.getElementById('volunteerAvailability').value,
        emergencyContact: document.getElementById('volunteerEmergencyContact').value,
        emergencyPhone: document.getElementById('volunteerEmergencyPhone').value,
        notes: document.getElementById('volunteerNotes').value
      };

      // 驗證必填欄位
      if (!volunteerData.name || !volunteerData.phone) {
        showAlert('請填寫必填欄位', 'warning');
        return;
      }

      let result;
      if (volunteerId) {
        volunteerData.volunteerId = volunteerId;
        result = await callAPI('updateVolunteer', volunteerData);
      } else {
        result = await callAPI('addVolunteer', volunteerData);
      }

      if (result.success) {
        showAlert(result.message, 'success');
        closeModal('volunteerModal');
        loadVolunteersData();
      } else {
        showAlert(result.message || '操作失敗', 'danger');
      }
    }

    async function deleteVolunteer(volunteerId, volunteerName) {
      if (!confirmAction(`確定要刪除志工「${volunteerName}」嗎？此操作無法復原。`)) {
        return;
      }

      const result = await callAPI('deleteVolunteer', { volunteerId: volunteerId });

      if (result.success) {
        showAlert(result.message, 'success');
        loadVolunteersData();
      } else {
        showAlert(result.message || '刪除失敗', 'danger');
      }
    }

    async function viewServiceRecords(volunteerId, volunteerName) {
      currentData.currentVolunteerId = volunteerId;
      document.getElementById('serviceRecordsModalTitle').textContent = `服務記錄管理 - ${volunteerName}`;
      
      openModal('serviceRecordsModal');
      await loadServiceRecords(volunteerId);
    }

    async function loadServiceRecords(volunteerId) {
      const container = document.getElementById('serviceRecordsTableContainer');
      
      try {
        const records = await callAPI('getServiceRecords', { volunteerId: volunteerId });
        
        // 計算統計
        const approvedRecords = records.filter(r => r.approvalStatus === '已審核');
        const totalHours = approvedRecords.reduce((sum, r) => sum + parseFloat(r.hours || 0), 0);
        document.getElementById('serviceStats').textContent = `總服務時數：${totalHours} 小時`;

        if (!records || records.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>目前沒有服務記錄</p>
              <button class="btn btn-primary btn-sm" onclick="openAddServiceRecordModal()">新增記錄</button>
            </div>
          `;
          return;
        }

        let html = '<div class="table-container"><table><thead><tr>';
        html += '<th>服務日期</th><th>服務類型</th><th>服務內容</th><th>服務時數</th><th>審核狀態</th><th>操作</th>';
        html += '</tr></thead><tbody>';

        records.forEach(record => {
          const statusBadge = getServiceStatusBadge(record.approvalStatus);
          const description = record.description.length > 50 
            ? record.description.substring(0, 50) + '...'
            : record.description;

          html += `
            <tr>
              <td>${record.date}</td>
              <td><span class="badge badge-primary">${record.type}</span></td>
              <td>${description}</td>
              <td><strong>${record.hours}</strong> 小時</td>
              <td>${statusBadge}</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="editServiceRecord('${record.id}')">編輯</button>
                ${record.approvalStatus === '待審核' ? 
                  `<button class="btn btn-sm btn-success" onclick="approveServiceRecord('${record.id}')">審核</button>` : ''}
                <button class="btn btn-sm btn-danger" onclick="deleteServiceRecord('${record.id}')">刪除</button>
              </td>
            </tr>
          `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;

      } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">載入服務記錄失敗</div>';
      }
    }

    function openAddServiceRecordModal() {
      document.getElementById('serviceRecordModalTitle').textContent = '新增服務記錄';
      document.getElementById('serviceRecordForm').reset();
      document.getElementById('serviceRecordId').value = '';
      document.getElementById('serviceVolunteerId').value = currentData.currentVolunteerId;
      document.getElementById('serviceDate').value = getTodayDate();
      document.getElementById('serviceApprovalStatus').value = '待審核';
      openModal('serviceRecordModal');
    }

    async function editServiceRecord(recordId) {
      const record = await callAPI('getServiceRecordById', { recordId: recordId });
      
      if (!record) {
        showAlert('找不到服務記錄', 'danger');
        return;
      }

      document.getElementById('serviceRecordModalTitle').textContent = '編輯服務記錄';
      document.getElementById('serviceRecordId').value = record.id;
      document.getElementById('serviceVolunteerId').value = record.volunteerId;
      document.getElementById('serviceDate').value = record.date || '';
      document.getElementById('serviceHours').value = record.hours || '';
      document.getElementById('serviceType').value = record.type || '活動協助';
      document.getElementById('serviceDescription').value = record.description || '';
      document.getElementById('serviceApprovalStatus').value = record.approvalStatus || '待審核';
      document.getElementById('serviceNotes').value = record.notes || '';

      openModal('serviceRecordModal');
    }

    async function saveServiceRecord() {
      const recordId = document.getElementById('serviceRecordId').value;
      const recordData = {
        volunteerId: document.getElementById('serviceVolunteerId').value,
        date: document.getElementById('serviceDate').value,
        hours: parseFloat(document.getElementById('serviceHours').value),
        type: document.getElementById('serviceType').value,
        description: document.getElementById('serviceDescription').value,
        approvalStatus: document.getElementById('serviceApprovalStatus').value,
        notes: document.getElementById('serviceNotes').value
      };

      // 驗證必填欄位
      if (!recordData.date || !recordData.hours || !recordData.description) {
        showAlert('請填寫必填欄位', 'warning');
        return;
      }

      let result;
      if (recordId) {
        recordData.recordId = recordId;
        result = await callAPI('updateServiceRecord', recordData);
      } else {
        result = await callAPI('addServiceRecord', recordData);
      }

      if (result.success) {
        showAlert(result.message, 'success');
        closeModal('serviceRecordModal');
        loadServiceRecords(currentData.currentVolunteerId);
      } else {
        showAlert(result.message || '操作失敗', 'danger');
      }
    }

    async function approveServiceRecord(recordId) {
      if (!confirmAction('確定要審核通過此服務記錄嗎？')) {
        return;
      }

      const result = await callAPI('approveServiceRecord', { recordId: recordId });

      if (result.success) {
        showAlert(result.message, 'success');
        loadServiceRecords(currentData.currentVolunteerId);
      } else {
        showAlert(result.message || '審核失敗', 'danger');
      }
    }

    async function deleteServiceRecord(recordId) {
      if (!confirmAction('確定要刪除此服務記錄嗎？此操作無法復原。')) {
        return;
      }

      const result = await callAPI('deleteServiceRecord', { recordId: recordId });

      if (result.success) {
        showAlert(result.message, 'success');
        loadServiceRecords(currentData.currentVolunteerId);
      } else {
        showAlert(result.message || '刪除失敗', 'danger');
      }
    }

    // ==================== 財務管理 ====================
    
    async function loadFinancePage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <div class="page-header">
          <h1 class="page-title">財務總覽</h1>
          <p class="page-subtitle">收支統計與財務管理</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon success">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">本月收入</div>
              <div class="stat-value text-success" id="monthlyIncome">$0</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon danger">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">本月支出</div>
              <div class="stat-value text-danger" id="monthlyExpense">$0</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon primary">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">本月結餘</div>
              <div class="stat-value" id="monthlyBalance">$0</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon warning">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">本月捐款</div>
              <div class="stat-value" id="monthlyDonation">$0</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">收支管理</h2>
            <div class="flex gap-2">
              <button class="btn btn-success btn-sm" onclick="openAddTransactionModal('income')">
                <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                新增收入
              </button>
              <button class="btn btn-danger btn-sm" onclick="openAddTransactionModal('expense')">
                <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                </svg>
                新增支出
              </button>
            </div>
          </div>

          <div class="toolbar">
            <div class="toolbar-left">
              <select class="form-control" id="transactionTypeFilter" style="width: 150px;">
                <option value="">全部類型</option>
                <option value="income">收入</option>
                <option value="expense">支出</option>
              </select>
              <select class="form-control" id="transactionCategoryFilter" style="width: 150px;">
                <option value="">全部分類</option>
                <option value="捐款收入">捐款收入</option>
                <option value="會費收入">會費收入</option>
                <option value="活動收入">活動收入</option>
                <option value="人事費用">人事費用</option>
                <option value="活動費用">活動費用</option>
                <option value="行政費用">行政費用</option>
                <option value="其他">其他</option>
              </select>
              <input type="month" class="form-control" id="transactionMonthFilter" style="width: 150px;">
            </div>
          </div>

          <div id="transactionsTableContainer">
            <div class="text-center p-3">載入中...</div>
          </div>
        </div>

        <!-- 新增/編輯交易模態框 -->
        <div class="modal" id="transactionModal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title" id="transactionModalTitle">新增交易</h3>
              <button class="modal-close" onclick="closeModal('transactionModal')">&times;</button>
            </div>
            <div class="modal-body">
              <form id="transactionForm">
                <input type="hidden" id="transactionId">
                
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label required">交易類型</label>
                    <select class="form-control" id="transactionType" required onchange="updateTransactionCategories()">
                      <option value="income">收入</option>
                      <option value="expense">支出</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label required">交易日期</label>
                    <input type="date" class="form-control" id="transactionDate" required>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label required">分類</label>
                    <select class="form-control" id="transactionCategory" required>
                      <option value="">請選擇</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label required">金額</label>
                    <input type="number" class="form-control" id="transactionAmount" min="0" required>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label required">項目名稱</label>
                  <input type="text" class="form-control" id="transactionItem" required>
                </div>

                <div class="form-group">
                  <label class="form-label">說明</label>
                  <textarea class="form-control" id="transactionDescription" rows="3"></textarea>
                </div>

                <div class="form-group">
                  <label class="form-label">付款方式</label>
                  <select class="form-control" id="transactionPaymentMethod">
                    <option value="現金">現金</option>
                    <option value="轉帳">轉帳</option>
                    <option value="支票">支票</option>
                    <option value="信用卡">信用卡</option>
                    <option value="其他">其他</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">收據/發票號碼</label>
                  <input type="text" class="form-control" id="transactionReceiptNumber">
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('transactionModal')">取消</button>
              <button class="btn btn-primary" onclick="saveTransaction()">儲存</button>
            </div>
          </div>
        </div>
      `;

      // 設定當月
      const today = new Date();
      const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('transactionMonthFilter').value = currentMonth;

      // 綁定篩選事件
      document.getElementById('transactionTypeFilter').addEventListener('change', loadTransactionsData);
      document.getElementById('transactionCategoryFilter').addEventListener('change', loadTransactionsData);
      document.getElementById('transactionMonthFilter').addEventListener('change', loadTransactionsData);

      // 載入資料
      await loadFinanceStats();
      await loadTransactionsData();
    }

    async function loadFinanceStats() {
      try {
        const stats = await callAPI('getFinanceStats');
        
        if (stats) {
          document.getElementById('monthlyIncome').textContent = formatCurrency(stats.monthlyIncome || 0);
          document.getElementById('monthlyExpense').textContent = formatCurrency(stats.monthlyExpense || 0);
          document.getElementById('monthlyDonation').textContent = formatCurrency(stats.monthlyDonation || 0);
          
          const balance = (stats.monthlyIncome || 0) - (stats.monthlyExpense || 0);
          const balanceEl = document.getElementById('monthlyBalance');
          balanceEl.textContent = formatCurrency(balance);
          balanceEl.className = 'stat-value ' + (balance >= 0 ? 'text-success' : 'text-danger');
        }
      } catch (error) {
        console.error('載入財務統計失敗:', error);
      }
    }

    async function loadTransactionsData() {
      const container = document.getElementById('transactionsTableContainer');
      const typeFilter = document.getElementById('transactionTypeFilter').value;
      const categoryFilter = document.getElementById('transactionCategoryFilter').value;
      const monthFilter = document.getElementById('transactionMonthFilter').value;

      try {
        let transactions = await callAPI('getTransactions', {
          filters: {
            type: typeFilter,
            category: categoryFilter,
            month: monthFilter
          }
        });

        displayTransactionsTable(transactions);
      } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">載入交易記錄失敗</div>';
      }
    }

    function displayTransactionsTable(transactions) {
      const container = document.getElementById('transactionsTableContainer');

      if (!transactions || transactions.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
            </svg>
            <h3 class="empty-state-title">沒有找到交易記錄</h3>
            <p class="empty-state-text">請調整篩選條件或新增交易記錄</p>
          </div>
        `;
        return;
      }

      let html = '<div class="table-container"><table><thead><tr>';
      html += '<th>日期</th><th>類型</th><th>分類</th><th>項目</th><th>金額</th><th>付款方式</th><th>操作</th>';
      html += '</tr></thead><tbody>';

      transactions.forEach(trans => {
        const typeBadge = trans.type === 'income' 
          ? '<span class="badge badge-success">收入</span>'
          : '<span class="badge badge-danger">支出</span>';
        
        const amountClass = trans.type === 'income' ? 'text-success' : 'text-danger';
        const amountPrefix = trans.type === 'income' ? '+' : '-';

        html += `
          <tr>
            <td>${trans.date}</td>
            <td>${typeBadge}</td>
            <td><span class="badge badge-primary">${trans.category}</span></td>
            <td><strong>${trans.item}</strong></td>
            <td class="${amountClass}"><strong>${amountPrefix}${formatCurrency(trans.amount)}</strong></td>
            <td>${trans.paymentMethod || '-'}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="editTransaction('${trans.id}')">編輯</button>
              <button class="btn btn-sm btn-danger" onclick="deleteTransaction('${trans.id}')">刪除</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function openAddTransactionModal(type) {
      document.getElementById('transactionModalTitle').textContent = type === 'income' ? '新增收入' : '新增支出';
      document.getElementById('transactionForm').reset();
      document.getElementById('transactionId').value = '';
      document.getElementById('transactionType').value = type;
      document.getElementById('transactionDate').value = getTodayDate();
      updateTransactionCategories();
      openModal('transactionModal');
    }

    function updateTransactionCategories() {
      const type = document.getElementById('transactionType').value;
      const select = document.getElementById('transactionCategory');
      
      select.innerHTML = '<option value="">請選擇</option>';
      
      if (type === 'income') {
        select.innerHTML += `
          <option value="捐款收入">捐款收入</option>
          <option value="會費收入">會費收入</option>
          <option value="活動收入">活動收入</option>
          <option value="補助收入">補助收入</option>
          <option value="其他收入">其他收入</option>
        `;
      } else {
        select.innerHTML += `
          <option value="人事費用">人事費用</option>
          <option value="活動費用">活動費用</option>
          <option value="行政費用">行政費用</option>
          <option value="租金費用">租金費用</option>
          <option value="水電費用">水電費用</option>
          <option value="其他支出">其他支出</option>
        `;
      }
    }

    async function editTransaction(transId) {
      const trans = await callAPI('getTransactionById', { transId: transId });
      
      if (!trans) {
        showAlert('找不到交易記錄', 'danger');
        return;
      }

      document.getElementById('transactionModalTitle').textContent = '編輯交易';
      document.getElementById('transactionId').value = trans.id;
      document.getElementById('transactionType').value = trans.type;
      updateTransactionCategories();
      document.getElementById('transactionDate').value = trans.date || '';
      document.getElementById('transactionCategory').value = trans.category || '';
      document.getElementById('transactionAmount').value = trans.amount || '';
      document.getElementById('transactionItem').value = trans.item || '';
      document.getElementById('transactionDescription').value = trans.description || '';
      document.getElementById('transactionPaymentMethod').value = trans.paymentMethod || '現金';
      document.getElementById('transactionReceiptNumber').value = trans.receiptNumber || '';

      openModal('transactionModal');
    }

    async function saveTransaction() {
      const transId = document.getElementById('transactionId').value;
      const transData = {
        type: document.getElementById('transactionType').value,
        date: document.getElementById('transactionDate').value,
        category: document.getElementById('transactionCategory').value,
        amount: parseFloat(document.getElementById('transactionAmount').value),
        item: document.getElementById('transactionItem').value,
        description: document.getElementById('transactionDescription').value,
        paymentMethod: document.getElementById('transactionPaymentMethod').value,
        receiptNumber: document.getElementById('transactionReceiptNumber').value
      };

      // 驗證必填欄位
      if (!transData.date || !transData.category || !transData.amount || !transData.item) {
        showAlert('請填寫必填欄位', 'warning');
        return;
      }

      let result;
      if (transId) {
        transData.transId = transId;
        result = await callAPI('updateTransaction', transData);
      } else {
        result = await callAPI('addTransaction', transData);
      }

      if (result.success) {
        showAlert(result.message, 'success');
        closeModal('transactionModal');
        loadFinanceStats();
        loadTransactionsData();
      } else {
        showAlert(result.message || '操作失敗', 'danger');
      }
    }

    async function deleteTransaction(transId) {
      if (!confirmAction('確定要刪除此交易記錄嗎？此操作無法復原。')) {
        return;
      }

      const result = await callAPI('deleteTransaction', { transId: transId });

      if (result.success) {
        showAlert(result.message, 'success');
        loadFinanceStats();
        loadTransactionsData();
      } else {
        showAlert(result.message || '刪除失敗', 'danger');
      }
    }

    // ==================== 捐款管理 ====================
    
    async function loadDonationsPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <div class="page-header">
          <h1 class="page-title">捐款管理</h1>
          <p class="page-subtitle">管理所有捐款記錄</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon success">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">本月捐款</div>
              <div class="stat-value text-success" id="donationMonthly">$0</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon primary">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">今年捐款</div>
              <div class="stat-value" id="donationYearly">$0</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon warning">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">捐款人次</div>
              <div class="stat-value" id="donationCount">0</div>
            </div>
          </div>
        </div>

        <div class="toolbar">
          <div class="toolbar-left">
            <div class="search-box">
              <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <input type="text" class="form-control" id="donationSearch" placeholder="搜尋捐款人姓名...">
            </div>
            <input type="month" class="form-control" id="donationMonthFilter" style="width: 150px;">
          </div>
          <div class="toolbar-right">
            <button class="btn btn-primary" onclick="openAddDonationModal()">
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              新增捐款
            </button>
          </div>
        </div>

        <div class="card">
          <div id="donationsTableContainer">
            <div class="text-center p-3">載入中...</div>
          </div>
        </div>

        <!-- 新增/編輯捐款模態框 -->
        <div class="modal" id="donationModal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title" id="donationModalTitle">新增捐款</h3>
              <button class="modal-close" onclick="closeModal('donationModal')">&times;</button>
            </div>
            <div class="modal-body">
              <form id="donationForm">
                <input type="hidden" id="donationId">
                
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label required">捐款人姓名</label>
                    <input type="text" class="form-control" id="donationDonorName" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">聯絡電話</label>
                    <input type="tel" class="form-control" id="donationDonorPhone">
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label required">捐款日期</label>
                    <input type="date" class="form-control" id="donationDate" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label required">捐款金額</label>
                    <input type="number" class="form-control" id="donationAmount" min="0" required>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">捐款方式</label>
                  <select class="form-control" id="donationMethod">
                    <option value="現金">現金</option>
                    <option value="轉帳">轉帳</option>
                    <option value="支票">支票</option>
                    <option value="信用卡">信用卡</option>
                    <option value="其他">其他</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">捐款用途</label>
                  <select class="form-control" id="donationPurpose">
                    <option value="一般捐款">一般捐款</option>
                    <option value="指定活動">指定活動</option>
                    <option value="設備購置">設備購置</option>
                    <option value="其他">其他</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">收據號碼</label>
                  <input type="text" class="form-control" id="donationReceiptNumber">
                </div>

                <div class="form-group">
                  <label class="form-label">備註</label>
                  <textarea class="form-control" id="donationNotes" rows="3"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('donationModal')">取消</button>
              <button class="btn btn-primary" onclick="saveDonation()">儲存</button>
            </div>
          </div>
        </div>
      `;

      // 設定當月
      const today = new Date();
      const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('donationMonthFilter').value = currentMonth;

      // 綁定事件
      document.getElementById('donationSearch').addEventListener('input', debounce(loadDonationsData, 500));
      document.getElementById('donationMonthFilter').addEventListener('change', loadDonationsData);

      // 載入資料
      await loadDonationStats();
      await loadDonationsData();
    }

    async function loadDonationStats() {
      try {
        const stats = await callAPI('getDonationStats');
        
        if (stats) {
          document.getElementById('donationMonthly').textContent = formatCurrency(stats.monthlyTotal || 0);
          document.getElementById('donationYearly').textContent = formatCurrency(stats.yearlyTotal || 0);
          document.getElementById('donationCount').textContent = stats.count || 0;
        }
      } catch (error) {
        console.error('載入捐款統計失敗:', error);
      }
    }

    async function loadDonationsData() {
      const container = document.getElementById('donationsTableContainer');
      const searchTerm = document.getElementById('donationSearch').value.toLowerCase();
      const monthFilter = document.getElementById('donationMonthFilter').value;

      try {
        let donations = await callAPI('getDonations', {
          filters: { month: monthFilter }
        });

        // 搜尋篩選
        if (searchTerm) {
          donations = donations.filter(d => 
            d.donorName.toLowerCase().includes(searchTerm) ||
            (d.donorPhone && d.donorPhone.includes(searchTerm))
          );
        }

        displayDonationsTable(donations);
      } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">載入捐款記錄失敗</div>';
      }
    }

    function displayDonationsTable(donations) {
      const container = document.getElementById('donationsTableContainer');

      if (!donations || donations.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            <h3 class="empty-state-title">沒有找到捐款記錄</h3>
            <p class="empty-state-text">請調整搜尋條件或新增捐款記錄</p>
            <button class="btn btn-primary" onclick="openAddDonationModal()">新增捐款</button>
          </div>
        `;
        return;
      }

      let html = '<div class="table-container"><table><thead><tr>';
      html += '<th>捐款日期</th><th>捐款人</th><th>聯絡電話</th><th>金額</th><th>捐款方式</th><th>用途</th><th>收據號碼</th><th>操作</th>';
      html += '</tr></thead><tbody>';

      donations.forEach(donation => {
        html += `
          <tr>
            <td>${donation.date}</td>
            <td><strong>${donation.donorName}</strong></td>
            <td>${donation.donorPhone || '-'}</td>
            <td class="text-success"><strong>${formatCurrency(donation.amount)}</strong></td>
            <td>${donation.method}</td>
            <td><span class="badge badge-primary">${donation.purpose}</span></td>
            <td>${donation.receiptNumber || '-'}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="editDonation('${donation.id}')">編輯</button>
              <button class="btn btn-sm btn-danger" onclick="deleteDonation('${donation.id}')">刪除</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function openAddDonationModal() {
      document.getElementById('donationModalTitle').textContent = '新增捐款';
      document.getElementById('donationForm').reset();
      document.getElementById('donationId').value = '';
      document.getElementById('donationDate').value = getTodayDate();
      openModal('donationModal');
    }

    async function editDonation(donationId) {
      const donation = await callAPI('getDonationById', { donationId: donationId });
      
      if (!donation) {
        showAlert('找不到捐款記錄', 'danger');
        return;
      }

      document.getElementById('donationModalTitle').textContent = '編輯捐款';
      document.getElementById('donationId').value = donation.id;
      document.getElementById('donationDonorName').value = donation.donorName || '';
      document.getElementById('donationDonorPhone').value = donation.donorPhone || '';
      document.getElementById('donationDate').value = donation.date || '';
      document.getElementById('donationAmount').value = donation.amount || '';
      document.getElementById('donationMethod').value = donation.method || '現金';
      document.getElementById('donationPurpose').value = donation.purpose || '一般捐款';
      document.getElementById('donationReceiptNumber').value = donation.receiptNumber || '';
      document.getElementById('donationNotes').value = donation.notes || '';

      openModal('donationModal');
    }

    async function saveDonation() {
      const donationId = document.getElementById('donationId').value;
      const donationData = {
        donorName: document.getElementById('donationDonorName').value,
        donorPhone: document.getElementById('donationDonorPhone').value,
        date: document.getElementById('donationDate').value,
        amount: parseFloat(document.getElementById('donationAmount').value),
        method: document.getElementById('donationMethod').value,
        purpose: document.getElementById('donationPurpose').value,
        receiptNumber: document.getElementById('donationReceiptNumber').value,
        notes: document.getElementById('donationNotes').value
      };

      // 驗證必填欄位
      if (!donationData.donorName || !donationData.date || !donationData.amount) {
        showAlert('請填寫必填欄位', 'warning');
        return;
      }

      let result;
      if (donationId) {
        donationData.donationId = donationId;
        result = await callAPI('updateDonation', donationData);
      } else {
        result = await callAPI('addDonation', donationData);
      }

      if (result.success) {
        showAlert(result.message, 'success');
        closeModal('donationModal');
        loadDonationStats();
        loadDonationsData();
      } else {
        showAlert(result.message || '操作失敗', 'danger');
      }
    }

    async function deleteDonation(donationId) {
      if (!confirmAction('確定要刪除此捐款記錄嗎？此操作無法復原。')) {
        return;
      }

      const result = await callAPI('deleteDonation', { donationId: donationId });

      if (result.success) {
        showAlert(result.message, 'success');
        loadDonationStats();
        loadDonationsData();
      } else {
        showAlert(result.message || '刪除失敗', 'danger');
      }
    }


    // ==================== 會費管理 ====================
    
    async function loadMembershipFeesPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <div class="page-header">
          <h1 class="page-title">會費管理</h1>
          <p class="page-subtitle">管理會員繳費記錄</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon success">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">已繳費會員</div>
              <div class="stat-value text-success" id="paidMembersCount">0</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon warning">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">未繳費會員</div>
              <div class="stat-value text-warning" id="unpaidMembersCount">0</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon primary">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">本年度會費收入</div>
              <div class="stat-value" id="yearlyFeesIncome">$0</div>
            </div>
          </div>
        </div>

        <div class="toolbar">
          <div class="toolbar-left">
            <div class="search-box">
              <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <input type="text" class="form-control" id="feeSearch" placeholder="搜尋會員姓名...">
            </div>
            <select class="form-control" id="feeStatusFilter" style="width: 150px;">
              <option value="">全部狀態</option>
              <option value="已繳費">已繳費</option>
              <option value="未繳費">未繳費</option>
              <option value="逾期">逾期</option>
            </select>
            <select class="form-control" id="feeYearFilter" style="width: 120px;">
              <option value="">選擇年度</option>
            </select>
          </div>
          <div class="toolbar-right">
            <button class="btn btn-primary" onclick="openAddFeeModal()">
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              新增繳費記錄
            </button>
          </div>
        </div>

        <div class="card">
          <div id="feesTableContainer">
            <div class="text-center p-3">載入中...</div>
          </div>
        </div>

        <!-- 新增/編輯會費模態框 -->
        <div class="modal" id="feeModal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title" id="feeModalTitle">新增繳費記錄</h3>
              <button class="modal-close" onclick="closeModal('feeModal')">&times;</button>
            </div>
            <div class="modal-body">
              <form id="feeForm">
                <input type="hidden" id="feeId">
                
                <div class="form-group">
                  <label class="form-label required">選擇會員</label>
                  <select class="form-control" id="feeMemberId" required>
                    <option value="">請選擇會員</option>
                  </select>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label required">繳費年度</label>
                    <input type="number" class="form-control" id="feeYear" min="2020" max="2050" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label required">會費金額</label>
                    <input type="number" class="form-control" id="feeAmount" min="0" required>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label required">繳費日期</label>
                    <input type="date" class="form-control" id="feePaymentDate" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">繳費方式</label>
                    <select class="form-control" id="feePaymentMethod">
                      <option value="現金">現金</option>
                      <option value="轉帳">轉帳</option>
                      <option value="支票">支票</option>
                      <option value="信用卡">信用卡</option>
                    </select>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">收據號碼</label>
                  <input type="text" class="form-control" id="feeReceiptNumber">
                </div>

                <div class="form-group">
                  <label class="form-label">備註</label>
                  <textarea class="form-control" id="feeNotes" rows="2"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('feeModal')">取消</button>
              <button class="btn btn-primary" onclick="saveFee()">儲存</button>
            </div>
          </div>
        </div>
      `;

      // 初始化年度選項
      const currentYear = new Date().getFullYear();
      const yearSelect = document.getElementById('feeYearFilter');
      for (let year = currentYear; year >= currentYear - 5; year--) {
        yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
      }
      yearSelect.value = currentYear;

      // 綁定事件
      document.getElementById('feeSearch').addEventListener('input', debounce(loadFeesData, 500));
      document.getElementById('feeStatusFilter').addEventListener('change', loadFeesData);
      document.getElementById('feeYearFilter').addEventListener('change', loadFeesData);

      // 載入資料
      await loadFeeStats();
      await loadFeesData();
    }

    async function loadFeeStats() {
      try {
        const stats = await callAPI('getFeeStats');
        
        if (stats) {
          document.getElementById('paidMembersCount').textContent = stats.paidCount || 0;
          document.getElementById('unpaidMembersCount').textContent = stats.unpaidCount || 0;
          document.getElementById('yearlyFeesIncome').textContent = formatCurrency(stats.yearlyIncome || 0);
        }
      } catch (error) {
        console.error('載入會費統計失敗:', error);
      }
    }

    async function loadFeesData() {
      const container = document.getElementById('feesTableContainer');
      const searchTerm = document.getElementById('feeSearch').value.toLowerCase();
      const statusFilter = document.getElementById('feeStatusFilter').value;
      const yearFilter = document.getElementById('feeYearFilter').value;

      try {
        let fees = await callAPI('getMembershipFees', {
          filters: { 
            status: statusFilter,
            year: yearFilter 
          }
        });

        // 搜尋篩選
        if (searchTerm) {
          fees = fees.filter(f => 
            f.memberName.toLowerCase().includes(searchTerm)
          );
        }

        displayFeesTable(fees);
      } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">載入會費記錄失敗</div>';
      }
    }

    function displayFeesTable(fees) {
      const container = document.getElementById('feesTableContainer');

      if (!fees || fees.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            <h3 class="empty-state-title">沒有找到會費記錄</h3>
            <p class="empty-state-text">請調整搜尋條件或新增繳費記錄</p>
            <button class="btn btn-primary" onclick="openAddFeeModal()">新增繳費記錄</button>
          </div>
        `;
        return;
      }

      let html = '<div class="table-container"><table><thead><tr>';
      html += '<th>會員姓名</th><th>年度</th><th>金額</th><th>繳費日期</th><th>繳費方式</th><th>狀態</th><th>收據號碼</th><th>操作</th>';
      html += '</tr></thead><tbody>';

      fees.forEach(fee => {
        const statusBadge = fee.status === '已繳費' 
          ? '<span class="badge badge-success">已繳費</span>'
          : fee.status === '逾期'
          ? '<span class="badge badge-danger">逾期</span>'
          : '<span class="badge badge-warning">未繳費</span>';

        html += `
          <tr>
            <td><strong>${fee.memberName}</strong></td>
            <td>${fee.year}</td>
            <td class="text-success"><strong>${formatCurrency(fee.amount)}</strong></td>
            <td>${fee.paymentDate || '-'}</td>
            <td>${fee.paymentMethod || '-'}</td>
            <td>${statusBadge}</td>
            <td>${fee.receiptNumber || '-'}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="editFee('${fee.id}')">編輯</button>
              <button class="btn btn-sm btn-danger" onclick="deleteFee('${fee.id}')">刪除</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    async function openAddFeeModal() {
      // 載入會員列表
      const members = await callAPI('getMembers');
      const select = document.getElementById('feeMemberId');
      
      select.innerHTML = '<option value="">請選擇會員</option>';
      members.forEach(member => {
        if (member.status !== '停權') {
          select.innerHTML += `<option value="${member.id}">${member.name} (${member.id})</option>`;
        }
      });

      document.getElementById('feeModalTitle').textContent = '新增繳費記錄';
      document.getElementById('feeForm').reset();
      document.getElementById('feeId').value = '';
      document.getElementById('feeYear').value = new Date().getFullYear();
      document.getElementById('feeAmount').value = 1000; // 預設會費
      document.getElementById('feePaymentDate').value = getTodayDate();
      openModal('feeModal');
    }

    async function editFee(feeId) {
      const fee = await callAPI('getFeeById', { feeId: feeId });
      
      if (!fee) {
        showAlert('找不到會費記錄', 'danger');
        return;
      }

      // 載入會員列表
      const members = await callAPI('getMembers');
      const select = document.getElementById('feeMemberId');
      
      select.innerHTML = '<option value="">請選擇會員</option>';
      members.forEach(member => {
        select.innerHTML += `<option value="${member.id}" ${member.id === fee.memberId ? 'selected' : ''}>${member.name} (${member.id})</option>`;
      });

      document.getElementById('feeModalTitle').textContent = '編輯繳費記錄';
      document.getElementById('feeId').value = fee.id;
      document.getElementById('feeYear').value = fee.year || '';
      document.getElementById('feeAmount').value = fee.amount || '';
      document.getElementById('feePaymentDate').value = fee.paymentDate || '';
      document.getElementById('feePaymentMethod').value = fee.paymentMethod || '現金';
      document.getElementById('feeReceiptNumber').value = fee.receiptNumber || '';
      document.getElementById('feeNotes').value = fee.notes || '';

      openModal('feeModal');
    }

    async function saveFee() {
      const feeId = document.getElementById('feeId').value;
      const memberId = document.getElementById('feeMemberId').value;

      if (!memberId) {
        showAlert('請選擇會員', 'warning');
        return;
      }

      // 取得會員資料
      const member = await callAPI('getMemberById', { memberId: memberId });

      const feeData = {
        memberId: memberId,
        memberName: member.name,
        year: parseInt(document.getElementById('feeYear').value),
        amount: parseFloat(document.getElementById('feeAmount').value),
        paymentDate: document.getElementById('feePaymentDate').value,
        paymentMethod: document.getElementById('feePaymentMethod').value,
        receiptNumber: document.getElementById('feeReceiptNumber').value,
        notes: document.getElementById('feeNotes').value,
        status: '已繳費'
      };

      // 驗證必填欄位
      if (!feeData.year || !feeData.amount || !feeData.paymentDate) {
        showAlert('請填寫必填欄位', 'warning');
        return;
      }

      let result;
      if (feeId) {
        feeData.feeId = feeId;
        result = await callAPI('updateFee', feeData);
      } else {
        result = await callAPI('addFee', feeData);
      }

      if (result.success) {
        showAlert(result.message, 'success');
        closeModal('feeModal');
        loadFeeStats();
        loadFeesData();
      } else {
        showAlert(result.message || '操作失敗', 'danger');
      }
    }

    async function deleteFee(feeId) {
      if (!confirmAction('確定要刪除此繳費記錄嗎？此操作無法復原。')) {
        return;
      }

      const result = await callAPI('deleteFee', { feeId: feeId });

      if (result.success) {
        showAlert(result.message, 'success');
        loadFeeStats();
        loadFeesData();
      } else {
        showAlert(result.message || '刪除失敗', 'danger');
      }
    }

    // ==================== 健康記錄 ====================
    
    async function loadHealthPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <div class="page-header">
          <h1 class="page-title">健康記錄</h1>
          <p class="page-subtitle">管理會員健康追蹤記錄</p>
        </div>

        <div class="toolbar">
          <div class="toolbar-left">
            <div class="search-box">
              <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <input type="text" class="form-control" id="healthSearch" placeholder="搜尋會員姓名...">
            </div>
          </div>
          <div class="toolbar-right">
            <button class="btn btn-primary" onclick="openAddHealthRecordModal()">
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              新增健康記錄
            </button>
          </div>
        </div>

        <div class="card">
          <div id="healthRecordsTableContainer">
            <div class="text-center p-3">載入中...</div>
          </div>
        </div>

        <!-- 新增/編輯健康記錄模態框 -->
        <div class="modal" id="healthRecordModal">
          <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
              <h3 class="modal-title" id="healthRecordModalTitle">新增健康記錄</h3>
              <button class="modal-close" onclick="closeModal('healthRecordModal')">&times;</button>
            </div>
            <div class="modal-body">
              <form id="healthRecordForm">
                <input type="hidden" id="healthRecordId">
                
                <div class="form-group">
                  <label class="form-label required">選擇會員</label>
                  <select class="form-control" id="healthMemberId" required>
                    <option value="">請選擇會員</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label required">記錄日期</label>
                  <input type="date" class="form-control" id="healthRecordDate" required>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">血壓 (收縮壓/舒張壓)</label>
                    <input type="text" class="form-control" id="healthBloodPressure" placeholder="例如：120/80">
                  </div>
                  <div class="form-group">
                    <label class="form-label">心跳 (次/分)</label>
                    <input type="number" class="form-control" id="healthHeartRate" min="0">
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">體重 (公斤)</label>
                    <input type="number" class="form-control" id="healthWeight" step="0.1" min="0">
                  </div>
                  <div class="form-group">
                    <label class="form-label">血糖 (mg/dL)</label>
                    <input type="number" class="form-control" id="healthBloodSugar" min="0">
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">用藥記錄</label>
                  <textarea class="form-control" id="healthMedication" rows="3" placeholder="記錄目前服用的藥物"></textarea>
                </div>

                <div class="form-group">
                  <label class="form-label">症狀描述</label>
                  <textarea class="form-control" id="healthSymptoms" rows="3" placeholder="記錄當日症狀或身體狀況"></textarea>
                </div>

                <div class="form-group">
                  <label class="form-label">備註</label>
                  <textarea class="form-control" id="healthNotes" rows="2"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('healthRecordModal')">取消</button>
              <button class="btn btn-primary" onclick="saveHealthRecord()">儲存</button>
            </div>
          </div>
        </div>
      `;

      // 綁定事件
      document.getElementById('healthSearch').addEventListener('input', debounce(loadHealthRecordsData, 500));

      // 載入資料
      await loadHealthRecordsData();
    }

    async function loadHealthRecordsData() {
      const container = document.getElementById('healthRecordsTableContainer');
      const searchTerm = document.getElementById('healthSearch').value.toLowerCase();

      try {
        let records = await callAPI('getHealthRecords');

        // 搜尋篩選
        if (searchTerm) {
          records = records.filter(r => 
            r.memberName.toLowerCase().includes(searchTerm)
          );
        }

        displayHealthRecordsTable(records);
      } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">載入健康記錄失敗</div>';
      }
    }

    function displayHealthRecordsTable(records) {
      const container = document.getElementById('healthRecordsTableContainer');

      if (!records || records.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <h3 class="empty-state-title">沒有找到健康記錄</h3>
            <p class="empty-state-text">請新增第一筆健康記錄</p>
            <button class="btn btn-primary" onclick="openAddHealthRecordModal()">新增健康記錄</button>
          </div>
        `;
        return;
      }

      let html = '<div class="table-container"><table><thead><tr>';
      html += '<th>記錄日期</th><th>會員姓名</th><th>血壓</th><th>心跳</th><th>體重</th><th>血糖</th><th>操作</th>';
      html += '</tr></thead><tbody>';

      records.forEach(record => {
        html += `
          <tr>
            <td>${record.date}</td>
            <td><strong>${record.memberName}</strong></td>
            <td>${record.bloodPressure || '-'}</td>
            <td>${record.heartRate ? record.heartRate + ' bpm' : '-'}</td>
            <td>${record.weight ? record.weight + ' kg' : '-'}</td>
            <td>${record.bloodSugar ? record.bloodSugar + ' mg/dL' : '-'}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="editHealthRecord('${record.id}')">編輯</button>
              <button class="btn btn-sm btn-danger" onclick="deleteHealthRecord('${record.id}')">刪除</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    async function openAddHealthRecordModal() {
      // 載入會員列表
      const members = await callAPI('getMembers');
      const select = document.getElementById('healthMemberId');
      
      select.innerHTML = '<option value="">請選擇會員</option>';
      members.forEach(member => {
        if (member.status !== '停權' && member.memberType === '病友本人') {
          select.innerHTML += `<option value="${member.id}">${member.name} (${member.id})</option>`;
        }
      });

      document.getElementById('healthRecordModalTitle').textContent = '新增健康記錄';
      document.getElementById('healthRecordForm').reset();
      document.getElementById('healthRecordId').value = '';
      document.getElementById('healthRecordDate').value = getTodayDate();
      openModal('healthRecordModal');
    }

    async function editHealthRecord(recordId) {
      const record = await callAPI('getHealthRecordById', { recordId: recordId });
      
      if (!record) {
        showAlert('找不到健康記錄', 'danger');
        return;
      }

      // 載入會員列表
      const members = await callAPI('getMembers');
      const select = document.getElementById('healthMemberId');
      
      select.innerHTML = '<option value="">請選擇會員</option>';
      members.forEach(member => {
        select.innerHTML += `<option value="${member.id}" ${member.id === record.memberId ? 'selected' : ''}>${member.name} (${member.id})</option>`;
      });

      document.getElementById('healthRecordModalTitle').textContent = '編輯健康記錄';
      document.getElementById('healthRecordId').value = record.id;
      document.getElementById('healthRecordDate').value = record.date || '';
      document.getElementById('healthBloodPressure').value = record.bloodPressure || '';
      document.getElementById('healthHeartRate').value = record.heartRate || '';
      document.getElementById('healthWeight').value = record.weight || '';
      document.getElementById('healthBloodSugar').value = record.bloodSugar || '';
      document.getElementById('healthMedication').value = record.medication || '';
      document.getElementById('healthSymptoms').value = record.symptoms || '';
      document.getElementById('healthNotes').value = record.notes || '';

      openModal('healthRecordModal');
    }

    async function saveHealthRecord() {
      const recordId = document.getElementById('healthRecordId').value;
      const memberId = document.getElementById('healthMemberId').value;

      if (!memberId) {
        showAlert('請選擇會員', 'warning');
        return;
      }

      // 取得會員資料
      const member = await callAPI('getMemberById', { memberId: memberId });

      const recordData = {
        memberId: memberId,
        memberName: member.name,
        date: document.getElementById('healthRecordDate').value,
        bloodPressure: document.getElementById('healthBloodPressure').value,
        heartRate: document.getElementById('healthHeartRate').value,
        weight: document.getElementById('healthWeight').value,
        bloodSugar: document.getElementById('healthBloodSugar').value,
        medication: document.getElementById('healthMedication').value,
        symptoms: document.getElementById('healthSymptoms').value,
        notes: document.getElementById('healthNotes').value
      };

      // 驗證必填欄位
      if (!recordData.date) {
        showAlert('請填寫記錄日期', 'warning');
        return;
      }

      let result;
      if (recordId) {
        recordData.recordId = recordId;
        result = await callAPI('updateHealthRecord', recordData);
      } else {
        result = await callAPI('addHealthRecord', recordData);
      }

      if (result.success) {
        showAlert(result.message, 'success');
        closeModal('healthRecordModal');
        loadHealthRecordsData();
      } else {
        showAlert(result.message || '操作失敗', 'danger');
      }
    }

    async function deleteHealthRecord(recordId) {
      if (!confirmAction('確定要刪除此健康記錄嗎？此操作無法復原。')) {
        return;
      }

      const result = await callAPI('deleteHealthRecord', { recordId: recordId });

      if (result.success) {
        showAlert(result.message, 'success');
        loadHealthRecordsData();
      } else {
        showAlert(result.message || '刪除失敗', 'danger');
      }
    }

    // ==================== 資源媒合 ====================
    
    async function loadResourcesPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <div class="page-header">
          <h1 class="page-title">資源媒合</h1>
          <p class="page-subtitle">管理資源需求與媒合記錄</p>
        </div>

        <div class="toolbar">
          <div class="toolbar-left">
            <select class="form-control" id="resourceStatusFilter" style="width: 150px;">
              <option value="">全部狀態</option>
              <option value="待處理">待處理</option>
              <option value="處理中">處理中</option>
              <option value="已完成">已完成</option>
              <option value="已取消">已取消</option>
            </select>
            <select class="form-control" id="resourceUrgencyFilter" style="width: 150px;">
              <option value="">全部緊急度</option>
              <option value="緊急">緊急</option>
              <option value="重要">重要</option>
              <option value="一般">一般</option>
            </select>
          </div>
          <div class="toolbar-right">
            <button class="btn btn-primary" onclick="openAddResourceModal()">
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              新增資源需求
            </button>
          </div>
        </div>

        <div class="card">
          <div id="resourcesTableContainer">
            <div class="text-center p-3">載入中...</div>
          </div>
        </div>

        <!-- 新增/編輯資源需求模態框 -->
        <div class="modal" id="resourceModal">
          <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
              <h3 class="modal-title" id="resourceModalTitle">新增資源需求</h3>
              <button class="modal-close" onclick="closeModal('resourceModal')">&times;</button>
            </div>
            <div class="modal-body">
              <form id="resourceForm">
                <input type="hidden" id="resourceId">
                
                <div class="form-group">
                  <label class="form-label required">申請會員</label>
                  <select class="form-control" id="resourceMemberId" required>
                    <option value="">請選擇會員</option>
                  </select>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label required">申請日期</label>
                    <input type="date" class="form-control" id="resourceRequestDate" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label required">緊急程度</label>
                    <select class="form-control" id="resourceUrgency" required>
                      <option value="一般">一般</option>
                      <option value="重要">重要</option>
                      <option value="緊急">緊急</option>
                    </select>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label required">資源類型</label>
                  <select class="form-control" id="resourceType" required>
                    <option value="醫療資源">醫療資源</option>
                    <option value="輔具需求">輔具需求</option>
                    <option value="居家照護">居家照護</option>
                    <option value="交通協助">交通協助</option>
                    <option value="經濟援助">經濟援助</option>
                    <option value="其他">其他</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label required">需求說明</label>
                  <textarea class="form-control" id="resourceDescription" rows="4" required></textarea>
                </div>

                <div class="form-group">
                  <label class="form-label">處理狀態</label>
                  <select class="form-control" id="resourceStatus">
                    <option value="待處理">待處理</option>
                    <option value="處理中">處理中</option>
                    <option value="已完成">已完成</option>
                    <option value="已取消">已取消</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">負責人員</label>
                  <input type="text" class="form-control" id="resourceAssignedTo">
                </div>

                <div class="form-group">
                  <label class="form-label">處理記錄</label>
                  <textarea class="form-control" id="resourceProcessNotes" rows="3"></textarea>
                </div>

                <div class="form-group">
                  <label class="form-label">完成日期</label>
                  <input type="date" class="form-control" id="resourceCompletionDate">
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('resourceModal')">取消</button>
              <button class="btn btn-primary" onclick="saveResource()">儲存</button>
            </div>
          </div>
        </div>
      `;

      // 綁定事件
      document.getElementById('resourceStatusFilter').addEventListener('change', loadResourcesData);
      document.getElementById('resourceUrgencyFilter').addEventListener('change', loadResourcesData);

      // 載入資料
      await loadResourcesData();
    }

    async function loadResourcesData() {
      const container = document.getElementById('resourcesTableContainer');
      const statusFilter = document.getElementById('resourceStatusFilter').value;
      const urgencyFilter = document.getElementById('resourceUrgencyFilter').value;

      try {
        let resources = await callAPI('getResources', {
          filters: {
            status: statusFilter,
            urgency: urgencyFilter
          }
        });

        displayResourcesTable(resources);
      } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">載入資源需求失敗</div>';
      }
    }

    function displayResourcesTable(resources) {
      const container = document.getElementById('resourcesTableContainer');

      if (!resources || resources.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
            <h3 class="empty-state-title">沒有找到資源需求</h3>
            <p class="empty-state-text">請新增第一筆資源需求</p>
            <button class="btn btn-primary" onclick="openAddResourceModal()">新增資源需求</button>
          </div>
        `;
        return;
      }

      let html = '<div class="table-container"><table><thead><tr>';
      html += '<th>申請日期</th><th>會員姓名</th><th>資源類型</th><th>需求說明</th><th>緊急程度</th><th>狀態</th><th>負責人</th><th>操作</th>';
      html += '</tr></thead><tbody>';

      resources.forEach(resource => {
        const statusBadge = getResourceStatusBadge(resource.status);
        const urgencyBadge = getUrgencyBadge(resource.urgency);
        const description = resource.description.length > 30 
          ? resource.description.substring(0, 30) + '...'
          : resource.description;

        html += `
          <tr>
            <td>${resource.requestDate}</td>
            <td><strong>${resource.memberName}</strong></td>
            <td><span class="badge badge-primary">${resource.type}</span></td>
            <td>${description}</td>
            <td>${urgencyBadge}</td>
            <td>${statusBadge}</td>
            <td>${resource.assignedTo || '-'}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="editResource('${resource.id}')">編輯</button>
              <button class="btn btn-sm btn-danger" onclick="deleteResource('${resource.id}')">刪除</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    async function openAddResourceModal() {
      // 載入會員列表
      const members = await callAPI('getMembers');
      const select = document.getElementById('resourceMemberId');
      
      select.innerHTML = '<option value="">請選擇會員</option>';
      members.forEach(member => {
        if (member.status !== '停權') {
          select.innerHTML += `<option value="${member.id}">${member.name} (${member.id})</option>`;
        }
      });

      document.getElementById('resourceModalTitle').textContent = '新增資源需求';
      document.getElementById('resourceForm').reset();
      document.getElementById('resourceId').value = '';
      document.getElementById('resourceRequestDate').value = getTodayDate();
      document.getElementById('resourceStatus').value = '待處理';
      openModal('resourceModal');
    }

    async function editResource(resourceId) {
      const resource = await callAPI('getResourceById', { resourceId: resourceId });
      
      if (!resource) {
        showAlert('找不到資源需求記錄', 'danger');
        return;
      }

      // 載入會員列表
      const members = await callAPI('getMembers');
      const select = document.getElementById('resourceMemberId');
      
      select.innerHTML = '<option value="">請選擇會員</option>';
      members.forEach(member => {
        select.innerHTML += `<option value="${member.id}" ${member.id === resource.memberId ? 'selected' : ''}>${member.name} (${member.id})</option>`;
      });

      document.getElementById('resourceModalTitle').textContent = '編輯資源需求';
      document.getElementById('resourceId').value = resource.id;
      document.getElementById('resourceRequestDate').value = resource.requestDate || '';
      document.getElementById('resourceUrgency').value = resource.urgency || '一般';
      document.getElementById('resourceType').value = resource.type || '其他';
      document.getElementById('resourceDescription').value = resource.description || '';
      document.getElementById('resourceStatus').value = resource.status || '待處理';
      document.getElementById('resourceAssignedTo').value = resource.assignedTo || '';
      document.getElementById('resourceProcessNotes').value = resource.processNotes || '';
      document.getElementById('resourceCompletionDate').value = resource.completionDate || '';

      openModal('resourceModal');
    }

    async function saveResource() {
      const resourceId = document.getElementById('resourceId').value;
      const memberId = document.getElementById('resourceMemberId').value;

      if (!memberId) {
        showAlert('請選擇會員', 'warning');
        return;
      }

      // 取得會員資料
      const member = await callAPI('getMemberById', { memberId: memberId });

      const resourceData = {
        memberId: memberId,
        memberName: member.name,
        requestDate: document.getElementById('resourceRequestDate').value,
        urgency: document.getElementById('resourceUrgency').value,
        type: document.getElementById('resourceType').value,
        description: document.getElementById('resourceDescription').value,
        status: document.getElementById('resourceStatus').value,
        assignedTo: document.getElementById('resourceAssignedTo').value,
        processNotes: document.getElementById('resourceProcessNotes').value,
        completionDate: document.getElementById('resourceCompletionDate').value
      };

      // 驗證必填欄位
      if (!resourceData.requestDate || !resourceData.description) {
        showAlert('請填寫必填欄位', 'warning');
        return;
      }

      let result;
      if (resourceId) {
        resourceData.resourceId = resourceId;
        result = await callAPI('updateResource', resourceData);
      } else {
        result = await callAPI('addResource', resourceData);
      }

      if (result.success) {
        showAlert(result.message, 'success');
        closeModal('resourceModal');
        loadResourcesData();
      } else {
        showAlert(result.message || '操作失敗', 'danger');
      }
    }

    async function deleteResource(resourceId) {
      if (!confirmAction('確定要刪除此資源需求記錄嗎？此操作無法復原。')) {
        return;
      }

      const result = await callAPI('deleteResource', { resourceId: resourceId });

      if (result.success) {
        showAlert(result.message, 'success');
        loadResourcesData();
      } else {
        showAlert(result.message || '刪除失敗', 'danger');
      }
    }

    // ==================== 系統初始化完成 ====================
    
    console.log('帕金森病友權益促進會管理系統已載入完成');
    console.log('請確保已將 API_URL 設定為您的 Google Apps Script 部署 URL');
  </script>
</body>
</html>


