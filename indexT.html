<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BOGO åœ˜éšŠåˆ†æç³»çµ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 30px;
      text-align: center;
    }
    
    .header h1 {
      color: #667eea;
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .btn {
      padding: 12px 30px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .btn:hover {
      background: #5568d3;
    }
    
    .team-container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .team-header {
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      color: white;
      padding: 20px 30px;
      border-radius: 10px;
      margin-bottom: 25px;
      font-size: 1.8em;
      font-weight: bold;
    }
    
    .section-title {
      background: #8b5cf6;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 1.2em;
      font-weight: bold;
      margin: 25px 0 15px 0;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 25px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .data-table thead {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
    }
    
    .data-table th {
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 0.95em;
    }
    
    .data-table th:last-child,
    .data-table td:last-child {
      text-align: right;
    }
    
    .data-table tbody tr {
      border-bottom: 1px solid #f3f4f6;
      transition: background 0.2s;
    }
    
    .data-table tbody tr:hover {
      background: #faf5ff;
    }
    
    .data-table tbody tr:last-child {
      border-bottom: none;
    }
    
    .data-table td {
      padding: 12px;
      color: #374151;
    }
    
    .data-table .total-row {
      background: #fef3c7;
      font-weight: bold;
      color: #92400e;
    }
    
    .data-table .total-row td {
      padding: 15px 12px;
      border-top: 2px solid #f59e0b;
    }
    
    .data-table .subtotal-row {
      background: #f3f4f6;
      font-weight: 600;
    }
    
    .data-table .group-header-row {
      background: #fef3c7;
      font-weight: bold;
      color: #92400e;
    }
    
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 25px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .summary-table thead {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .summary-table th {
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
    }
    
    .summary-table tbody tr {
      border-bottom: 1px solid #f3f4f6;
    }
    
    .summary-table tbody tr:hover {
      background: #f0fdf4;
    }
    
    .summary-table td {
      padding: 12px;
      color: #374151;
    }
    
    .summary-table .rank-1 {
      background: #fef3c7;
      font-weight: bold;
    }
    
    .summary-table .rank-2 {
      background: #f3f4f6;
    }
    
    .summary-table .rank-3 {
      background: #fef2f2;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      padding: 20px;
      border-radius: 10px;
      border-left: 4px solid #8b5cf6;
      text-align: center;
    }
    
    .stat-card .label {
      color: #6b7280;
      font-size: 0.9em;
      margin-bottom: 8px;
    }
    
    .stat-card .value {
      color: #8b5cf6;
      font-size: 2em;
      font-weight: bold;
    }
    
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }
    
    .loading.show {
      display: flex;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    .loading-text {
      color: white;
      font-size: 1.2em;
      font-weight: 600;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .alert {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .alert-success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .alert-error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .filter-bar {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    select {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
    }
    
    .comparison-section {
      background: white;
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .comparison-title {
      color: #8b5cf6;
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f3f4f6;
    }
    
    @media print {
      body {
        background: white;
      }
      .header, .filter-bar {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">è¼‰å…¥ä¸­...</div>
  </div>
  
  <div class="container">
    <div class="header">
      <h1>ğŸ¯ BOGO åœ˜éšŠåˆ†æç³»çµ±</h1>
      <p>ä»¥åœ˜éšŠç‚ºä¸»è»¸çš„å®Œæ•´è¨‚è³¼èˆ‡æ¶è³¼åˆ†æ</p>
    </div>
    
    <!-- ç¯©é¸åˆ— -->
    <div class="filter-bar" id="filterBar" style="display: none;">
      <label style="font-weight: 600;">é¸æ“‡åœ˜éšŠï¼š</label>
      <select id="teamFilter" onchange="filterTeam()">
        <option value="all">å…¨éƒ¨åœ˜éšŠ</option>
      </select>
      <button class="btn" onclick="exportReport()">ğŸ“¥ åŒ¯å‡ºå ±å‘Š</button>
      <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
    </div>
    
    <!-- åœ˜éšŠæ¯”è¼ƒè¡¨æ ¼ -->
    <div class="comparison-section" id="comparisonSection" style="display: none;">
      <h3 class="comparison-title">ğŸ“Š åœ˜éšŠç¸¾æ•ˆæ¯”è¼ƒç¸½è¡¨</h3>
      <div id="comparisonContent"></div>
    </div>
    
    <!-- åˆ†æå…§å®¹ -->
    <div id="analysisContent"></div>
  </div>
  
  <script>
    // ç›´æ¥å¯«å…¥ Google Sheets Web App URL
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyu-D3U9KJJPM64RBRVMWPBiEzS8jDudCWh3QQ/exec';
    
    let allOrders = [];
    let allReports = [];
    let maintenanceData = [];
    let teamAnalysisData = {};
    
    // çµ„åˆ¥æ’åºå‡½æ•¸
    function sortGroupCode(a, b) {
      const order = ['1A', '1B', '2A', '2B', '3A', '3B', '4A', '4B', '5A', '5B'];
      const indexA = order.indexOf(a);
      const indexB = order.indexOf(b);
      
      if (indexA !== -1 && indexB !== -1) {
        return indexA - indexB;
      }
      if (indexA !== -1) return -1;
      if (indexB !== -1) return 1;
      return a.localeCompare(b);
    }
    
    // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
    function showLoading(show, text = 'è¼‰å…¥ä¸­...') {
      document.getElementById('loading').classList.toggle('show', show);
      document.getElementById('loadingText').textContent = text;
    }
    
    // é¡¯ç¤ºæç¤º
    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '10000';
      alertDiv.style.minWidth = '300px';
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }
    
    // è‡ªå‹•é€£æ¥ä¸¦åˆ†æ
    async function autoConnectAndAnalyze() {
      showLoading(true, 'æ­£åœ¨é€£æ¥è©¦ç®—è¡¨...');
      
      try {
        // æ¸¬è©¦é€£ç·š
        showLoading(true, 'æ¸¬è©¦é€£ç·šä¸­...');
        const testResponse = await fetch(WEB_APP_URL + '?action=test');
        const testResult = await testResponse.json();
        
        if (!testResult.success) {
          throw new Error('é€£ç·šæ¸¬è©¦å¤±æ•—ï¼š' + testResult.data);
        }
        
        // è¼‰å…¥è¨‚å–®è³‡æ–™
        showLoading(true, 'è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­...');
        const ordersResponse = await fetch(WEB_APP_URL + '?action=getOrders');
        const ordersResult = await ordersResponse.json();
        
        if (!ordersResult.success) {
          throw new Error('è¼‰å…¥è¨‚å–®å¤±æ•—ï¼š' + ordersResult.data);
        }
        allOrders = ordersResult.data;
        
        // è¼‰å…¥æ¶è³¼å›å ±
        showLoading(true, 'è¼‰å…¥æ¶è³¼å›å ±ä¸­...');
        const reportsResponse = await fetch(WEB_APP_URL + '?action=getReports');
        const reportsResult = await reportsResponse.json();
        
        if (!reportsResult.success) {
          throw new Error('è¼‰å…¥æ¶è³¼å›å ±å¤±æ•—ï¼š' + reportsResult.data);
        }
        allReports = reportsResult.data;
        
        // è¼‰å…¥ä¸Šç·šç¶­è­·è³‡æ–™
        showLoading(true, 'è¼‰å…¥ç¶­è­·è³‡æ–™ä¸­...');
        const maintenanceResponse = await fetch(WEB_APP_URL + '?action=getMaintenance');
        const maintenanceResult = await maintenanceResponse.json();
        
        if (maintenanceResult.success) {
          maintenanceData = maintenanceResult.data;
        }
        
        // é–‹å§‹åˆ†æ
        showLoading(true, 'åˆ†ææ•¸æ“šä¸­...');
        analyzeByTeam();
        
        showAlert(`âœ… åˆ†æå®Œæˆï¼è¨‚å–®ï¼š${allOrders.length} ç­†ï¼Œæ¶è³¼ï¼š${allReports.length} ç­†`, 'success');
        
        document.getElementById('filterBar').style.display = 'flex';
        document.getElementById('comparisonSection').style.display = 'block';
        
      } catch (error) {
        showAlert('âŒ ' + error.message, 'error');
        console.error(error);
      } finally {
        showLoading(false);
      }
    }
    
    // ä»¥åœ˜éšŠç‚ºä¸»è»¸åˆ†æ
    function analyzeByTeam() {
      teamAnalysisData = {};
      
      // å»ºç«‹è¨‚è³¼åå–®åˆ°åœ˜éšŠçš„æ˜ å°„
      const nameToTeamMap = {};
      maintenanceData.forEach(item => {
        if (item.è¨‚è³¼åå–® && item.åœ˜éšŠ) {
          nameToTeamMap[item.è¨‚è³¼åå–®] = item.åœ˜éšŠ;
        }
      });
      
      // å»ºç«‹æ¶è³¼è€…åˆ°åœ˜éšŠçš„æ˜ å°„
      allReports.forEach(report => {
        if (report.æ¶è³¼è€… && report.åœ˜éšŠ) {
          nameToTeamMap[report.æ¶è³¼è€…] = report.åœ˜éšŠ;
        }
      });
      
      // è™•ç†è¨‚å–®æ•¸æ“š
      allOrders.forEach(order => {
        const name = order.LINEåç¨±.split('(ä»£)')[0].trim();
        const team = order.åœ˜éšŠ || nameToTeamMap[name] || nameToTeamMap[order.LINEåç¨±] || 'æœªåˆ†é…';
        const groupCode = order.çµ„åˆ¥ä»£è™Ÿ || order.çµ„åˆ¥ || 'æœªåˆ†çµ„';
        
        if (!teamAnalysisData[team]) {
          teamAnalysisData[team] = {
            orders: {},
            reports: {},
            groupSummary: {},
            reportGroupSummary: {},
            totalOrderQty: 0,
            totalOrderAmount: 0,
            totalOrderPV: 0,
            totalReportQty: 0,
            totalReportAmount: 0,
            totalReportPV: 0
          };
        }
        
        if (!teamAnalysisData[team].orders[name]) {
          teamAnalysisData[team].orders[name] = {};
        }
        
        if (!teamAnalysisData[team].orders[name][groupCode]) {
          teamAnalysisData[team].orders[name][groupCode] = {
            products: {},
            totalQty: 0,
            totalAmount: 0,
            totalPV: 0
          };
        }
        
        const qty = parseInt(order.è¨‚è³¼æ•¸é‡) || 0;
        const price = parseInt(order.å–®åƒ¹) || 0;
        const pv = parseInt(order.PV) || 0;
        const amount = parseInt(order.åˆè¨ˆ) || (qty * price);
        const productName = order['ç”¢å“åç¨±( BOGOå°ˆç”¨ )'] || order.çµ„åˆ¥ä»£è™Ÿ;
        
        // åˆä½µç›¸åŒç”¢å“
        if (!teamAnalysisData[team].orders[name][groupCode].products[productName]) {
          teamAnalysisData[team].orders[name][groupCode].products[productName] = {
            productName: productName,
            qty: 0,
            price: price,
            pv: pv,
            amount: 0
          };
        }
        
        teamAnalysisData[team].orders[name][groupCode].products[productName].qty += qty;
        teamAnalysisData[team].orders[name][groupCode].products[productName].amount += amount;
        
        teamAnalysisData[team].orders[name][groupCode].totalQty += qty;
        teamAnalysisData[team].orders[name][groupCode].totalAmount += amount;
        teamAnalysisData[team].orders[name][groupCode].totalPV += pv * qty;
        
        // çµ„åˆ¥çµ±è¨ˆ
        if (!teamAnalysisData[team].groupSummary[groupCode]) {
          teamAnalysisData[team].groupSummary[groupCode] = {
            qty: 0,
            amount: 0,
            pv: 0
          };
        }
        teamAnalysisData[team].groupSummary[groupCode].qty += qty;
        teamAnalysisData[team].groupSummary[groupCode].amount += amount;
        teamAnalysisData[team].groupSummary[groupCode].pv += pv * qty;
        
        teamAnalysisData[team].totalOrderQty += qty;
        teamAnalysisData[team].totalOrderAmount += amount;
        teamAnalysisData[team].totalOrderPV += pv * qty;
      });
      
      // è™•ç†æ¶è³¼å›å ±æ•¸æ“š
      allReports.forEach(report => {
        const team = report.åœ˜éšŠ || 'æœªåˆ†é…';
        const buyer = report.æ¶è³¼è€…;
        const groupCode = report.çµ„åˆ¥ä»£è™Ÿ || 'æœªåˆ†çµ„';
        
        if (!teamAnalysisData[team]) {
          teamAnalysisData[team] = {
            orders: {},
            reports: {},
            groupSummary: {},
            reportGroupSummary: {},
            totalOrderQty: 0,
            totalOrderAmount: 0,
            totalOrderPV: 0,
            totalReportQty: 0,
            totalReportAmount: 0,
            totalReportPV: 0
          };
        }
        
        if (!teamAnalysisData[team].reports[buyer]) {
          teamAnalysisData[team].reports[buyer] = {};
        }
        
        if (!teamAnalysisData[team].reports[buyer][groupCode]) {
          teamAnalysisData[team].reports[buyer][groupCode] = {
            items: [],
            totalQty: 0,
            totalAmount: 0,
            totalPV: 0
          };
        }
        
        const qty = parseInt(report.æ¶è³¼çµ„æ•¸) || 0;
        const price = parseInt(report.å–®åƒ¹) || 0;
        const pv = parseInt(report.PVæ•¸) || 0;
        const amount = qty * price;
        
        teamAnalysisData[team].reports[buyer][groupCode].items.push({
          qty: qty,
          price: price,
          pv: pv,
          amount: amount,
          buySend: report['è²·/é€'] || '',
          account: report['æ¶è³¼å¸³è™Ÿ/å‚™è¨»'] || ''
        });
        
        teamAnalysisData[team].reports[buyer][groupCode].totalQty += qty;
        teamAnalysisData[team].reports[buyer][groupCode].totalAmount += amount;
        teamAnalysisData[team].reports[buyer][groupCode].totalPV += pv * qty;
        
        // æ¶è³¼çµ„åˆ¥çµ±è¨ˆ
        if (!teamAnalysisData[team].reportGroupSummary[groupCode]) {
          teamAnalysisData[team].reportGroupSummary[groupCode] = {
            qty: 0,
            amount: 0,
            pv: 0
          };
        }
        teamAnalysisData[team].reportGroupSummary[groupCode].qty += qty;
        teamAnalysisData[team].reportGroupSummary[groupCode].amount += amount;
        teamAnalysisData[team].reportGroupSummary[groupCode].pv += pv * qty;
        
        teamAnalysisData[team].totalReportQty += qty;
        teamAnalysisData[team].totalReportAmount += amount;
        teamAnalysisData[team].totalReportPV += pv * qty;
      });
      
      // æ›´æ–°åœ˜éšŠé¸æ“‡å™¨
      const teamFilter = document.getElementById('teamFilter');
      teamFilter.innerHTML = '<option value="all">å…¨éƒ¨åœ˜éšŠ</option>';
      Object.keys(teamAnalysisData).sort().forEach(team => {
        teamFilter.innerHTML += `<option value="${team}">${team}</option>`;
      });
      
      // é¡¯ç¤ºæ¯”è¼ƒè¡¨æ ¼
      displayComparisonTable();
      
      // é¡¯ç¤ºåˆ†æçµæœ
      displayTeamAnalysis();
    }
    
    // é¡¯ç¤ºåœ˜éšŠæ¯”è¼ƒè¡¨æ ¼ï¼ˆç´°åˆ†çµ„åˆ¥ï¼‰
    function displayComparisonTable() {
      const container = document.getElementById('comparisonContent');
      const teams = Object.keys(teamAnalysisData).sort();
      
      // æ”¶é›†æ‰€æœ‰çµ„åˆ¥
      const allGroups = new Set();
      teams.forEach(team => {
        Object.keys(teamAnalysisData[team].groupSummary).forEach(g => allGroups.add(g));
        Object.keys(teamAnalysisData[team].reportGroupSummary).forEach(g => allGroups.add(g));
      });
      
      const sortedGroups = Array.from(allGroups).sort(sortGroupCode);
      
      let html = `
        <table class="summary-table">
          <thead>
            <tr>
              <th rowspan="2">åœ˜éšŠ</th>
              <th colspan="${sortedGroups.length}">è¨‚è³¼æ•¸é‡ï¼ˆçµ„ï¼‰</th>
              <th rowspan="2">è¨‚è³¼ç¸½è¨ˆ</th>
              <th colspan="${sortedGroups.length}">æ¶è³¼æ•¸é‡ï¼ˆçµ„ï¼‰</th>
              <th rowspan="2">æ¶è³¼ç¸½è¨ˆ</th>
            </tr>
            <tr>
      `;
      
      // è¨‚è³¼çµ„åˆ¥æ¨™é¡Œ
      sortedGroups.forEach(group => {
        html += `<th>${group}</th>`;
      });
      
      // æ¶è³¼çµ„åˆ¥æ¨™é¡Œ
      sortedGroups.forEach(group => {
        html += `<th>${group}</th>`;
      });
      
      html += `
            </tr>
          </thead>
          <tbody>
      `;
      
      teams.forEach((team, index) => {
        const data = teamAnalysisData[team];
        const rowClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
        
        html += `
          <tr class="${rowClass}">
            <td><strong>${team}</strong></td>
        `;
        
        // è¨‚è³¼å„çµ„åˆ¥æ•¸é‡
        sortedGroups.forEach(group => {
          const qty = data.groupSummary[group]?.qty || 0;
          html += `<td>${qty > 0 ? qty : '-'}</td>`;
        });
        
        // è¨‚è³¼ç¸½è¨ˆ
        html += `<td><strong>${data.totalOrderQty}</strong></td>`;
        
        // æ¶è³¼å„çµ„åˆ¥æ•¸é‡
        sortedGroups.forEach(group => {
          const qty = data.reportGroupSummary[group]?.qty || 0;
          html += `<td>${qty > 0 ? qty : '-'}</td>`;
        });
        
        // æ¶è³¼ç¸½è¨ˆ
        html += `<td><strong>${data.totalReportQty}</strong></td>`;
        
        html += `</tr>`;
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      container.innerHTML = html;
    }
    
    // é¡¯ç¤ºåœ˜éšŠåˆ†æï¼ˆè¡¨æ ¼ç‰ˆï¼‰
    function displayTeamAnalysis(selectedTeam = 'all') {
      const container = document.getElementById('analysisContent');
      let html = '';
      
      const teamsToShow = selectedTeam === 'all' 
        ? Object.keys(teamAnalysisData).sort() 
        : [selectedTeam];
      
      teamsToShow.forEach(team => {
        const data = teamAnalysisData[team];
        
        html += `
          <div class="team-container">
            <div class="team-header">ğŸ¢ ${team}</div>
            
            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="label">è¨‚è³¼ç¸½æ•¸é‡</div>
                <div class="value">${data.totalOrderQty}</div>
              </div>
              <div class="stat-card">
                <div class="label">è¨‚è³¼ç¸½é‡‘é¡</div>
                <div class="value">$${(data.totalOrderAmount / 1000).toFixed(0)}K</div>
              </div>
              <div class="stat-card">
                <div class="label">è¨‚è³¼ç¸½ PV</div>
                <div class="value">${data.totalOrderPV.toLocaleString()}</div>
              </div>
              <div class="stat-card">
                <div class="label">æ¶è³¼ç¸½æ•¸é‡</div>
                <div class="value">${data.totalReportQty}</div>
              </div>
              <div class="stat-card">
                <div class="label">æ¶è³¼ç¸½é‡‘é¡</div>
                <div class="value">$${(data.totalReportAmount / 1000).toFixed(0)}K</div>
              </div>
              <div class="stat-card">
                <div class="label">æ¶è³¼ç¸½ PV</div>
                <div class="value">${data.totalReportPV.toLocaleString()}</div>
              </div>
            </div>
        `;
        
        // è¨‚è³¼çµ„åˆ¥çµ±è¨ˆè¡¨ï¼ˆæŒ‰é †åºæ’åˆ—ï¼‰
        if (Object.keys(data.groupSummary).length > 0) {
          html += `
            <div class="section-title">ğŸ“¦ è¨‚è³¼çµ„åˆ¥çµ±è¨ˆ</div>
            <table class="summary-table">
              <thead>
                <tr>
                  <th>çµ„åˆ¥ä»£è™Ÿ</th>
                  <th>æ•¸é‡</th>
                  <th>é‡‘é¡</th>
                  <th>PV</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          const sortedGroups = Object.keys(data.groupSummary).sort(sortGroupCode);
          sortedGroups.forEach((groupCode, index) => {
            const stats = data.groupSummary[groupCode];
            const rowClass = index === 0 ? 'rank-1' : '';
            html += `
              <tr class="${rowClass}">
                <td><strong>${groupCode}</strong></td>
                <td>${stats.qty} çµ„</td>
                <td>$${stats.amount.toLocaleString()}</td>
                <td>${stats.pv}</td>
              </tr>
            `;
          });
          
          html += `
              </tbody>
            </table>
          `;
        }
        
        // è¨‚è³¼è©³ç´°æ¸…å–®ï¼ˆæŒ‰çµ„åˆ¥æ’åºï¼‰
        html += `<div class="section-title">ğŸ“‹ è¨‚è³¼è©³ç´°æ¸…å–®</div>`;
        
        for (const [person, groups] of Object.entries(data.orders)) {
          html += `
            <h4 style="color: #6b21a8; margin: 20px 0 10px 0; padding: 10px; background: #faf5ff; border-radius: 8px;">
              ğŸ‘¤ ${person}
            </h4>
            <table class="data-table">
              <thead>
                <tr>
                  <th>çµ„åˆ¥ä»£è™Ÿ</th>
                  <th>ç”¢å“åç¨±</th>
                  <th>æ•¸é‡</th>
                  <th>å–®åƒ¹</th>
                  <th>PV</th>
                  <th>é‡‘é¡</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          let personTotal = { qty: 0, amount: 0, pv: 0 };
          
          // æŒ‰çµ„åˆ¥é †åºæ’åº
          const sortedGroupCodes = Object.keys(groups).sort(sortGroupCode);
          
          for (const groupCode of sortedGroupCodes) {
            const groupData = groups[groupCode];
            
            // çµ„åˆ¥æ¨™é¡Œè¡Œ
            html += `
              <tr class="group-header-row">
                <td colspan="6"><strong>ğŸ“¦ ${groupCode} - å°è¨ˆï¼š${groupData.totalQty} çµ„</strong></td>
              </tr>
            `;
            
            // æ¯å€‹ç”¢å“çš„æ˜ç´°ï¼ˆåˆä½µå¾Œï¼‰
            for (const [productName, product] of Object.entries(groupData.products)) {
              html += `
                <tr>
                  <td>${groupCode}</td>
                  <td>${product.productName}</td>
                  <td>${product.qty}</td>
                  <td>$${product.price.toLocaleString()}</td>
                  <td>${product.pv}</td>
                  <td>$${product.amount.toLocaleString()}</td>
                </tr>
              `;
            }
            
            // çµ„åˆ¥å°è¨ˆ
            html += `
              <tr class="subtotal-row">
                <td colspan="2"><strong>${groupCode} å°è¨ˆ</strong></td>
                <td><strong>${groupData.totalQty}</strong></td>
                <td>-</td>
                <td><strong>${groupData.totalPV}</strong></td>
                <td><strong>$${groupData.totalAmount.toLocaleString()}</strong></td>
              </tr>
            `;
            
            personTotal.qty += groupData.totalQty;
            personTotal.amount += groupData.totalAmount;
            personTotal.pv += groupData.totalPV;
          }
          
          // å€‹äººç¸½è¨ˆ
          html += `
              <tr class="total-row">
                <td colspan="2"><strong>${person} ç¸½è¨ˆ</strong></td>
                <td><strong>${personTotal.qty}</strong></td>
                <td>-</td>
                <td><strong>${personTotal.pv}</strong></td>
                <td><strong>$${personTotal.amount.toLocaleString()}</strong></td>
              </tr>
            </tbody>
          </table>
          `;
        }
        
        // æ¶è³¼çµ„åˆ¥çµ±è¨ˆè¡¨ï¼ˆæŒ‰é †åºæ’åˆ—ï¼‰
        if (Object.keys(data.reportGroupSummary).length > 0) {
          html += `
            <div class="section-title">ğŸ¯ æ¶è³¼çµ„åˆ¥çµ±è¨ˆ</div>
            <table class="summary-table">
              <thead>
                <tr>
                  <th>çµ„åˆ¥ä»£è™Ÿ</th>
                  <th>æ•¸é‡</th>
                  <th>é‡‘é¡</th>
                  <th>PV</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          const sortedReportGroups = Object.keys(data.reportGroupSummary).sort(sortGroupCode);
          sortedReportGroups.forEach((groupCode, index) => {
            const stats = data.reportGroupSummary[groupCode];
            const rowClass = index === 0 ? 'rank-1' : '';
            html += `
              <tr class="${rowClass}">
                <td><strong>${groupCode}</strong></td>
                <td>${stats.qty} çµ„</td>
                <td>$${stats.amount.toLocaleString()}</td>
                <td>${stats.pv}</td>
              </tr>
            `;
          });
          
          html += `
              </tbody>
            </table>
          `;
        }
        
        // æ¶è³¼è©³ç´°æ¸…å–®ï¼ˆæŒ‰çµ„åˆ¥æ’åºï¼‰
        html += `<div class="section-title">ğŸ¯ æ¶è³¼è©³ç´°æ¸…å–®</div>`;
        
        for (const [buyer, groups] of Object.entries(data.reports)) {
          html += `
            <h4 style="color: #6b21a8; margin: 20px 0 10px 0; padding: 10px; background: #faf5ff; border-radius: 8px;">
              ğŸ‘¤ ${buyer}
            </h4>
            <table class="data-table">
              <thead>
                <tr>
                  <th>çµ„åˆ¥ä»£è™Ÿ</th>
                  <th>è²·/é€</th>
                  <th>æ•¸é‡</th>
                  <th>å–®åƒ¹</th>
                  <th>PV</th>
                  <th>é‡‘é¡</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          let buyerTotal = { qty: 0, amount: 0, pv: 0 };
          
          // æŒ‰çµ„åˆ¥é †åºæ’åº
          const sortedGroupCodes = Object.keys(groups).sort(sortGroupCode);
          
          for (const groupCode of sortedGroupCodes) {
            const groupData = groups[groupCode];
            
            // çµ„åˆ¥æ¨™é¡Œè¡Œ
            html += `
              <tr class="group-header-row">
                <td colspan="6"><strong>ğŸ¯ ${groupCode} - å°è¨ˆï¼š${groupData.totalQty} çµ„</strong></td>
              </tr>
            `;
            
            // æ¯ç­†æ¶è³¼æ˜ç´°
            groupData.items.forEach(item => {
              html += `
                <tr>
                  <td>${groupCode}</td>
                  <td>${item.buySend}</td>
                  <td>${item.qty}</td>
                  <td>$${item.price.toLocaleString()}</td>
                  <td>${item.pv}</td>
                  <td>$${item.amount.toLocaleString()}</td>
                </tr>
              `;
            });
            
            // çµ„åˆ¥å°è¨ˆ
            html += `
              <tr class="subtotal-row">
                <td colspan="2"><strong>${groupCode} å°è¨ˆ</strong></td>
                <td><strong>${groupData.totalQty}</strong></td>
                <td>-</td>
                <td><strong>${groupData.totalPV}</strong></td>
                <td><strong>$${groupData.totalAmount.toLocaleString()}</strong></td>
              </tr>
            `;
            
            buyerTotal.qty += groupData.totalQty;
            buyerTotal.amount += groupData.totalAmount;
            buyerTotal.pv += groupData.totalPV;
          }
          
          // æ¶è³¼è€…ç¸½è¨ˆ
          html += `
              <tr class="total-row">
                <td colspan="2"><strong>${buyer} ç¸½è¨ˆ</strong></td>
                <td><strong>${buyerTotal.qty}</strong></td>
                <td>-</td>
                <td><strong>${buyerTotal.pv}</strong></td>
                <td><strong>$${buyerTotal.amount.toLocaleString()}</strong></td>
              </tr>
            </tbody>
          </table>
          `;
        }
        
        html += `</div>`;
      });
      
      container.innerHTML = html;
    }
    
    // ç¯©é¸åœ˜éšŠ
    function filterTeam() {
      const selectedTeam = document.getElementById('teamFilter').value;
      displayTeamAnalysis(selectedTeam);
    }
    
    // åŒ¯å‡ºå ±å‘Š
    function exportReport() {
      let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
      csvContent += "BOGO åœ˜éšŠåˆ†æå ±å‘Š\n\n";
      
      for (const [team, data] of Object.entries(teamAnalysisData)) {
        csvContent += `\nåœ˜éšŠï¼š${team}\n`;
        csvContent += `è¨‚è³¼ç¸½æ•¸é‡,${data.totalOrderQty}\n`;
        csvContent += `è¨‚è³¼ç¸½é‡‘é¡,$${data.totalOrderAmount}\n`;
        csvContent += `è¨‚è³¼ç¸½PV,${data.totalOrderPV}\n`;
        csvContent += `æ¶è³¼ç¸½æ•¸é‡,${data.totalReportQty}\n`;
        csvContent += `æ¶è³¼ç¸½é‡‘é¡,$${data.totalReportAmount}\n`;
        csvContent += `æ¶è³¼ç¸½PV,${data.totalReportPV}\n\n`;
        
        csvContent += "è¨‚è³¼çµ„åˆ¥çµ±è¨ˆ\n";
        csvContent += "çµ„åˆ¥ä»£è™Ÿ,æ•¸é‡,é‡‘é¡,PV\n";
        const sortedGroups = Object.keys(data.groupSummary).sort(sortGroupCode);
        for (const groupCode of sortedGroups) {
          const stats = data.groupSummary[groupCode];
          csvContent += `${groupCode},${stats.qty},${stats.amount},${stats.pv}\n`;
        }
        
        csvContent += "\næ¶è³¼çµ„åˆ¥çµ±è¨ˆ\n";
        csvContent += "çµ„åˆ¥ä»£è™Ÿ,æ•¸é‡,é‡‘é¡,PV\n";
        const sortedReportGroups = Object.keys(data.reportGroupSummary).sort(sortGroupCode);
        for (const groupCode of sortedReportGroups) {
          const stats = data.reportGroupSummary[groupCode];
          csvContent += `${groupCode},${stats.qty},${stats.amount},${stats.pv}\n`;
        }
        
        csvContent += "\n";
      }
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "BOGOåœ˜éšŠåˆ†æ_" + new Date().toISOString().split('T')[0] + ".csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showAlert('âœ… å ±å‘Šå·²åŒ¯å‡º', 'success');
    }
    
    // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œåˆ†æ
    window.addEventListener('DOMContentLoaded', () => {
      autoConnectAndAnalyze();
    });
  </script>
</body>
</html>
