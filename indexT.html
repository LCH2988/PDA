<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BOGO æ¶è³¼è¨‚å–®åˆ†æç³»çµ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 30px;
      text-align: center;
    }
    
    .header h1 {
      color: #667eea;
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .header p {
      color: #666;
      font-size: 1.1em;
    }
    
    .status-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      margin-top: 10px;
    }
    
    .status-connected {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-disconnected {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .stat-card h3 {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    
    .stat-card .value {
      font-size: 2.5em;
      font-weight: bold;
      color: #667eea;
    }
    
    .stat-card .label {
      color: #999;
      font-size: 0.9em;
      margin-top: 5px;
    }
    
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .content-grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 1200px) {
      .content-grid-3 {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    @media (max-width: 968px) {
      .content-grid, .content-grid-3 {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .card.full-width {
      grid-column: 1 / -1;
    }
    
    .card h2 {
      color: #667eea;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .table-container {
      overflow-x: auto;
      max-height: 500px;
      overflow-y: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
    }
    
    thead {
      position: sticky;
      top: 0;
      background: #667eea;
      color: white;
      z-index: 10;
    }
    
    th {
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
    }
    
    td {
      padding: 10px 8px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    tbody tr:hover {
      background: #f8f9ff;
    }
    
    .product-a {
      color: #10b981;
      font-weight: bold;
    }
    
    .product-b {
      color: #f59e0b;
      font-weight: bold;
    }
    
    .chart-bar {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .chart-label {
      width: 150px;
      font-size: 0.9em;
      color: #666;
      font-weight: 600;
    }
    
    .chart-bar-container {
      flex: 1;
      height: 30px;
      background: #f0f0f0;
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }
    
    .chart-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: white;
      font-weight: bold;
      font-size: 0.85em;
      transition: width 1s ease;
    }
    
    .chart-bar-fill.group-a {
      background: linear-gradient(90deg, #10b981, #059669);
    }
    
    .chart-bar-fill.group-b {
      background: linear-gradient(90deg, #f59e0b, #d97706);
    }
    
    .chart-bar-fill.team-color {
      background: linear-gradient(90deg, #8b5cf6, #6d28d9);
    }
    
    .filter-section {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .filter-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filter-group label {
      color: #666;
      font-weight: 600;
    }
    
    .filter-group select,
    .filter-group input {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      outline: none;
      transition: border-color 0.3s;
    }
    
    .filter-group select:focus,
    .filter-group input:focus {
      border-color: #667eea;
    }
    
    .btn {
      padding: 10px 25px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .btn:hover {
      background: #5568d3;
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #6b7280;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    .btn-success {
      background: #10b981;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .sync-info {
      background: #e0e7ff;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      color: #4338ca;
    }
    
    .sync-info strong {
      display: block;
      margin-bottom: 5px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }
    
    .badge-success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .badge-info {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .badge-purple {
      background: #e9d5ff;
      color: #6b21a8;
    }
    
    .badge-team {
      background: #f3e8ff;
      color: #7c3aed;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .loading-overlay.show {
      display: flex;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .alert {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .alert-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
    }
    
    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
    }
    
    .alert-info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #3b82f6;
    }
    
    .team-card {
      background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #8b5cf6;
    }
    
    .team-card h4 {
      color: #6b21a8;
      margin-bottom: 15px;
      font-size: 1.2em;
    }
    
    .team-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      font-size: 0.9em;
    }
    
    .team-stat-item {
      background: white;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }
    
    .team-stat-item .label {
      color: #666;
      font-size: 0.85em;
      margin-bottom: 5px;
    }
    
    .team-stat-item .value {
      color: #8b5cf6;
      font-weight: bold;
      font-size: 1.3em;
    }
    
    .tab-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      color: #6b7280;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    
    .tab:hover {
      color: #667eea;
    }
    
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .comparison-table {
      width: 100%;
      margin-top: 20px;
    }
    
    .comparison-table th {
      background: #8b5cf6;
    }
    
    .comparison-table .highlight-row {
      background: #fef3c7;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>
  
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>ğŸ¯ BOGO æ¶è³¼è¨‚å–®åˆ†æç³»çµ±</h1>
      <p id="headerSubtitle">å³æ™‚æ•¸æ“šåˆ†æå„€è¡¨æ¿</p>
      <span class="status-badge status-disconnected" id="statusBadge">â— æœªé€£æ¥</span>
    </div>
    
    <!-- Connection Setup -->
    <div class="card" style="margin-bottom: 30px;">
      <h2>ğŸ”— Google Sheets é€£æ¥è¨­å®š</h2>
      
      <div id="alertContainer"></div>
      
      <div class="filter-group">
        <label>Web App URLï¼š</label>
        <input type="text" id="webAppUrl" placeholder="è²¼ä¸Š Apps Script éƒ¨ç½²çš„ Web App URL" style="flex: 1; min-width: 400px;">
        <button class="btn btn-success" onclick="connectAndLoad()">ğŸ”Œ é€£æ¥ä¸¦è¼‰å…¥</button>
        <button class="btn" onclick="testConnection()">ğŸ” æ¸¬è©¦é€£ç·š</button>
        <button class="btn btn-secondary" onclick="refreshData()" id="refreshBtn" disabled>ğŸ”„ é‡æ–°æ•´ç†</button>
      </div>
      
      <div class="sync-info">
        <strong>ğŸ“Œ å¿«é€Ÿè¨­å®šæŒ‡å—ï¼š</strong>
        <ol style="text-align: left; margin-top: 10px; padding-left: 20px;">
          <li>åœ¨ Google Sheets é–‹å•Ÿï¼š<strong>æ“´å……åŠŸèƒ½ â†’ Apps Script</strong></li>
          <li>è²¼ä¸Šæä¾›çš„ Apps Script ç¨‹å¼ç¢¼ä¸¦å„²å­˜</li>
          <li>é»æ“Š <strong>éƒ¨ç½² â†’ æ–°å¢éƒ¨ç½²ä½œæ¥­ â†’ ç¶²é æ‡‰ç”¨ç¨‹å¼</strong></li>
          <li>è¨­å®šã€ŒåŸ·è¡Œèº«åˆ†ã€ç‚ºã€Œæˆ‘ã€ï¼Œã€Œå­˜å–æ¬Šã€ç‚ºã€Œä»»ä½•äººã€</li>
          <li>è¤‡è£½éƒ¨ç½² URL ä¸¦è²¼åˆ°ä¸Šæ–¹è¼¸å…¥æ¡†</li>
          <li>é»æ“Šã€Œé€£æ¥ä¸¦è¼‰å…¥ã€æŒ‰éˆ•</li>
        </ol>
      </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>ç¸½è¨‚å–®æ•¸</h3>
        <div class="value" id="totalOrders">0</div>
        <div class="label">ç­†è¨‚å–®</div>
      </div>
      <div class="stat-card">
        <h3>ç¸½éŠ·å”®é¡</h3>
        <div class="value" id="totalSales">$0</div>
        <div class="label">æ–°å°å¹£</div>
      </div>
      <div class="stat-card">
        <h3>ç¸½ PV æ•¸</h3>
        <div class="value" id="totalPV">0</div>
        <div class="label">ç©åˆ†</div>
      </div>
      <div class="stat-card">
        <h3>åƒèˆ‡åœ˜éšŠ</h3>
        <div class="value" id="totalTeams">0</div>
        <div class="label">å€‹åœ˜éšŠ</div>
      </div>
    </div>
    
    <!-- Team Analysis Section -->
    <div class="card full-width" style="margin-bottom: 30px;">
      <h2>ğŸ‘¥ åœ˜éšŠç¸¾æ•ˆåˆ†æï¼ˆæ¶è³¼å›å ±ç´€éŒ„ï¼‰</h2>
      
      <div class="tab-container">
        <button class="tab active" onclick="switchTab('team-overview')">ğŸ“Š åœ˜éšŠç¸½è¦½</button>
        <button class="tab" onclick="switchTab('team-comparison')">ğŸ“ˆ åœ˜éšŠæ¯”è¼ƒ</button>
        <button class="tab" onclick="switchTab('team-detail')">ğŸ“‹ è©³ç´°æ•¸æ“š</button>
      </div>
      
      <div id="tab-team-overview" class="tab-content active">
        <div id="teamOverview">
          <p style="color: #999; text-align: center; padding: 40px;">è¼‰å…¥æ•¸æ“šå¾Œé¡¯ç¤ºåœ˜éšŠåˆ†æ</p>
        </div>
      </div>
      
      <div id="tab-team-comparison" class="tab-content">
        <div id="teamComparison">
          <p style="color: #999; text-align: center; padding: 40px;">è¼‰å…¥æ•¸æ“šå¾Œé¡¯ç¤ºåœ˜éšŠæ¯”è¼ƒ</p>
        </div>
      </div>
      
      <div id="tab-team-detail" class="tab-content">
        <div class="table-container">
          <table class="comparison-table">
            <thead>
              <tr>
                <th>åœ˜éšŠ</th>
                <th>çµ„åˆ¥ä»£è™Ÿ</th>
                <th>æ¶è³¼çµ„æ•¸</th>
                <th>æ¶è³¼è€…</th>
                <th>å–®åƒ¹</th>
                <th>PVæ•¸</th>
                <th>è²·/é€</th>
                <th>ç¾¤çµ„ID</th>
              </tr>
            </thead>
            <tbody id="teamDetailTable">
              <tr>
                <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                  è¼‰å…¥æ•¸æ“šå¾Œé¡¯ç¤º
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Filter Section -->
    <div class="filter-section">
      <h2 style="color: #667eea; margin-bottom: 15px;">ğŸ” ç¯©é¸èˆ‡æœå°‹</h2>
      <div class="filter-group">
        <label>ç”¢å“é¡å‹ï¼š</label>
        <select id="productFilter">
          <option value="all">å…¨éƒ¨</option>
          <option value="1A">1A - é †æš¢æ¸…æ–°è¤‡æ–¹</option>
          <option value="1B">1B - å¤å·´é¦™è„‚</option>
        </select>
        
        <label>çµ„åˆ¥ï¼š</label>
        <select id="groupFilter">
          <option value="all">å…¨éƒ¨çµ„åˆ¥</option>
        </select>
        
        <label>åœ˜éšŠï¼š</label>
        <select id="teamFilter">
          <option value="all">å…¨éƒ¨åœ˜éšŠ</option>
        </select>
        
        <label>æœå°‹å§“åï¼š</label>
        <input type="text" id="nameSearch" placeholder="è¼¸å…¥å§“å...">
        
        <button class="btn" onclick="applyFilters()">å¥—ç”¨ç¯©é¸</button>
        <button class="btn btn-secondary" onclick="resetFilters()">é‡ç½®</button>
      </div>
    </div>
    
    <!-- Content Grid -->
    <div class="content-grid-3">
      <!-- Product Analysis -->
      <div class="card">
        <h2>ğŸ“¦ ç”¢å“éŠ·å”®åˆ†æ</h2>
        <div id="productChart">
          <p style="color: #999; text-align: center; padding: 40px;">è¼‰å…¥æ•¸æ“šå¾Œé¡¯ç¤º</p>
        </div>
      </div>
      
      <!-- Top Buyers -->
      <div class="card">
        <h2>ğŸ† æ¶è³¼æ’è¡Œæ¦œ TOP 10</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>æ’å</th>
                <th>å§“å</th>
                <th>æ•¸é‡</th>
                <th>é‡‘é¡</th>
              </tr>
            </thead>
            <tbody id="topBuyersTable">
              <tr>
                <td colspan="4" style="text-align: center; padding: 40px; color: #999;">
                  è¼‰å…¥æ•¸æ“šå¾Œé¡¯ç¤º
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Team Ranking -->
      <div class="card">
        <h2>ğŸ–ï¸ åœ˜éšŠæ’è¡Œæ¦œ</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>æ’å</th>
                <th>åœ˜éšŠ</th>
                <th>çµ„æ•¸</th>
                <th>PV</th>
              </tr>
            </thead>
            <tbody id="teamRankingTable">
              <tr>
                <td colspan="4" style="text-align: center; padding: 40px; color: #999;">
                  è¼‰å…¥æ•¸æ“šå¾Œé¡¯ç¤º
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Orders Table -->
    <div class="card">
      <h2>ğŸ“‹ è¨‚å–®æ˜ç´°åˆ—è¡¨ (<span id="orderCount">0</span> ç­†)</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ç·¨è™Ÿ</th>
              <th>LINEåç¨±</th>
              <th>ç”¢å“</th>
              <th>æ•¸é‡</th>
              <th>å–®åƒ¹</th>
              <th>PV</th>
              <th>åˆè¨ˆ</th>
              <th>çµ„åˆ¥</th>
              <th>åœ˜éšŠ</th>
              <th>æ™‚é–“</th>
            </tr>
          </thead>
          <tbody id="ordersTable">
            <tr>
              <td colspan="10" style="text-align: center; padding: 40px; color: #999;">
                è«‹å…ˆé€£æ¥ Google Sheets ä»¥è¼‰å…¥æ•¸æ“š
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <script>
    // å…¨åŸŸè®Šæ•¸
    let WEB_APP_URL = '';
    let allOrders = [];
    let allReports = [];
    let teamData = {};
    
    // åˆ‡æ›åˆ†é 
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');
    }
    
    // é¡¯ç¤º/éš±è—è¼‰å…¥å‹•ç•«
    function showLoading(show) {
      const overlay = document.getElementById('loadingOverlay');
      if (show) {
        overlay.classList.add('show');
      } else {
        overlay.classList.remove('show');
      }
    }
    
    // é¡¯ç¤ºæç¤ºè¨Šæ¯
    function showAlert(message, type = 'info') {
      const container = document.getElementById('alertContainer');
      const alertClass = `alert-${type}`;
      const alert = document.createElement('div');
      alert.className = `alert ${alertClass}`;
      alert.textContent = message;
      container.innerHTML = '';
      container.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }
    
    // æ›´æ–°é€£æ¥ç‹€æ…‹
    function updateStatus(connected) {
      const badge = document.getElementById('statusBadge');
      const refreshBtn = document.getElementById('refreshBtn');
      
      if (connected) {
        badge.className = 'status-badge status-connected';
        badge.textContent = 'â— å·²é€£æ¥';
        refreshBtn.disabled = false;
      } else {
        badge.className = 'status-badge status-disconnected';
        badge.textContent = 'â— æœªé€£æ¥';
        refreshBtn.disabled = true;
      }
    }
    
    // é€£æ¥ä¸¦è¼‰å…¥æ•¸æ“š
    async function connectAndLoad() {
      const url = document.getElementById('webAppUrl').value.trim();
      
      if (!url) {
        showAlert('è«‹è¼¸å…¥ Web App URL', 'error');
        return;
      }
      
      WEB_APP_URL = url;
      localStorage.setItem('webAppUrl', url);
      
      await loadOrders();
      await loadReports();
    }
    
    // æ¸¬è©¦é€£ç·š
    async function testConnection() {
      const url = document.getElementById('webAppUrl').value.trim();
      
      if (!url) {
        showAlert('è«‹è¼¸å…¥ Web App URL', 'error');
        return;
      }
      
      try {
        showLoading(true);
        
        const response = await fetch(url + '?action=test');
        const result = await response.json();
        
        if (result.success) {
          showAlert(`âœ… é€£ç·šæˆåŠŸï¼è©¦ç®—è¡¨ï¼š${result.data.spreadsheetName}ï¼Œå…± ${result.data.totalRows} åˆ—`, 'success');
          WEB_APP_URL = url;
          localStorage.setItem('webAppUrl', url);
          updateStatus(true);
        } else {
          showAlert('âŒ é€£ç·šå¤±æ•—ï¼š' + result.data, 'error');
          updateStatus(false);
        }
      } catch (error) {
        showAlert('âŒ é€£ç·šéŒ¯èª¤ï¼š' + error.message, 'error');
        updateStatus(false);
      } finally {
        showLoading(false);
      }
    }
    
    // è¼‰å…¥è¨‚å–®è³‡æ–™
    async function loadOrders() {
      if (!WEB_APP_URL) {
        showAlert('è«‹å…ˆè¨­å®š Web App URL', 'error');
        return;
      }
      
      try {
        showLoading(true);
        
        const response = await fetch(WEB_APP_URL + '?action=getOrders');
        const result = await response.json();
        
        if (result.success) {
          allOrders = result.data.map(order => ({
            id: order.id,
            name: order.LINEåç¨± || '',
            product: order.ç”¢å“ç·¨è™Ÿ || '',
            qty: parseInt(order.è¨‚è³¼æ•¸é‡) || 0,
            price: parseInt(order.å–®åƒ¹) || 0,
            pv: parseInt(order.PV) || 0,
            time: order.æ™‚é–“ || '',
            group: order.ç¾¤çµ„ID || '',
            groupName: order.çµ„åˆ¥ || '',
            total: parseInt(order.åˆè¨ˆè²»ç”¨) || 0,
            team: '' // å°‡å¾æ¶è³¼å›å ±ç´€éŒ„ä¸­åŒ¹é…
          }));
          
          updateGroupFilter(allOrders);
          updateStatus(true);
          
          showAlert(`âœ… æˆåŠŸè¼‰å…¥ ${allOrders.length} ç­†è¨‚å–®`, 'success');
        } else {
          showAlert('âŒ è¼‰å…¥å¤±æ•—ï¼š' + result.data, 'error');
          updateStatus(false);
        }
      } catch (error) {
        showAlert('âŒ é€£ç·šéŒ¯èª¤ï¼š' + error.message, 'error');
        updateStatus(false);
      } finally {
        showLoading(false);
      }
    }
    
    // è¼‰å…¥æ¶è³¼å›å ±ç´€éŒ„
    async function loadReports() {
      if (!WEB_APP_URL) {
        showAlert('è«‹å…ˆè¨­å®š Web App URL', 'error');
        return;
      }
      
      try {
        showLoading(true);
        
        const response = await fetch(WEB_APP_URL + '?action=getReports');
        const result = await response.json();
        
        if (result.success) {
          allReports = result.data.map(report => ({
            id: report.ç·¨è™Ÿ || '',
            groupCode: report.çµ„åˆ¥ä»£è™Ÿ || '',
            qty: parseInt(report.æ¶è³¼çµ„æ•¸) || 0,
            buyer: report.æ¶è³¼è€… || '',
            price: parseInt(report.å–®åƒ¹) || 0,
            pv: parseInt(report.PVæ•¸) || 0,
            buySend: report['è²·/é€'] || '',
            account: report['æ¶è³¼å¸³è™Ÿ/å‚™è¨»'] || '',
            team: report.åœ˜éšŠ || '',
            groupId: report.ç¾¤çµ„ID || ''
          }));
          
          // åŒ¹é…è¨‚å–®èˆ‡åœ˜éšŠ
          matchOrdersWithTeams();
          
          // æ›´æ–°æ‰€æœ‰è¦–åœ–
          updateTeamFilter(allReports);
          renderOrders(allOrders);
          updateStats(allOrders, allReports);
          updateProductChart(allOrders);
          updateTopBuyers(allOrders);
          updateTeamAnalysis(allReports);
          updateTeamRanking(allReports);
          
          showAlert(`âœ… æˆåŠŸè¼‰å…¥ ${allReports.length} ç­†æ¶è³¼å›å ±`, 'success');
          
          // æ›´æ–°æ¨™é¡Œ
          if (allOrders.length > 0 && allOrders[0].time) {
            const date = allOrders[0].time.split('_')[0];
            document.getElementById('headerSubtitle').textContent = `${date} æ¶è³¼æ´»å‹•æ•¸æ“š`;
          }
        } else {
          showAlert('âŒ è¼‰å…¥æ¶è³¼å›å ±å¤±æ•—ï¼š' + result.data, 'error');
        }
      } catch (error) {
        showAlert('âŒ é€£ç·šéŒ¯èª¤ï¼š' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }
    
    // åŒ¹é…è¨‚å–®èˆ‡åœ˜éšŠ
    function matchOrdersWithTeams() {
      // å»ºç«‹æ¶è³¼è€…åˆ°åœ˜éšŠçš„æ˜ å°„
      const buyerTeamMap = {};
      allReports.forEach(report => {
        if (report.buyer && report.team) {
          buyerTeamMap[report.buyer] = report.team;
        }
      });
      
      // ç‚ºè¨‚å–®æ·»åŠ åœ˜éšŠè³‡è¨Š
      allOrders.forEach(order => {
        const mainName = order.name.split('(ä»£)')[0].trim();
        order.team = buyerTeamMap[mainName] || buyerTeamMap[order.name] || 'æœªåˆ†é…';
      });
    }
    
    // æ›´æ–°åœ˜éšŠåˆ†æ
    function updateTeamAnalysis(reports) {
      teamData = {};
      
      reports.forEach(report => {
        const team = report.team || 'æœªåˆ†é…';
        
        if (!teamData[team]) {
          teamData[team] = {
            totalQty: 0,
            totalPV: 0,
            totalSales: 0,
            buyers: new Set(),
            groups: new Set(),
            groupDetails: {}
          };
        }
        
        teamData[team].totalQty += report.qty;
        teamData[team].totalPV += report.pv * report.qty;
        teamData[team].totalSales += report.price * report.qty;
        teamData[team].buyers.add(report.buyer);
        teamData[team].groups.add(report.groupCode);
        
        // è¨˜éŒ„æ¯å€‹çµ„åˆ¥çš„è©³ç´°è³‡è¨Š
        if (!teamData[team].groupDetails[report.groupCode]) {
          teamData[team].groupDetails[report.groupCode] = {
            qty: 0,
            pv: 0,
            sales: 0
          };
        }
        teamData[team].groupDetails[report.groupCode].qty += report.qty;
        teamData[team].groupDetails[report.groupCode].pv += report.pv * report.qty;
        teamData[team].groupDetails[report.groupCode].sales += report.price * report.qty;
      });
      
      updateTeamOverview();
      updateTeamComparison();
      updateTeamDetailTable(reports);
    }
    
    // æ›´æ–°åœ˜éšŠç¸½è¦½
    function updateTeamOverview() {
      let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">';
      
      const sortedTeams = Object.entries(teamData).sort((a, b) => b[1].totalQty - a[1].totalQty);
      
      sortedTeams.forEach(([team, data]) => {
        html += `
          <div class="team-card">
            <h4>ğŸ¢ ${team}</h4>
            <div class="team-stats">
              <div class="team-stat-item">
                <div class="label">æ¶è³¼çµ„æ•¸</div>
                <div class="value">${data.totalQty}</div>
              </div>
              <div class="team-stat-item">
                <div class="label">ç¸½ PV</div>
                <div class="value">${data.totalPV}</div>
              </div>
              <div class="team-stat-item">
                <div class="label">ç¸½é‡‘é¡</div>
                <div class="value">$${(data.totalSales/1000).toFixed(1)}K</div>
              </div>
              <div class="team-stat-item">
                <div class="label">åƒèˆ‡äººæ•¸</div>
                <div class="value">${data.buyers.size}</div>
              </div>
            </div>
            
            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid white;">
              <div style="font-size: 0.9em; color: #6b21a8; margin-bottom: 10px;">
                <strong>çµ„åˆ¥åˆ†ä½ˆï¼ˆ${data.groups.size} å€‹çµ„åˆ¥ï¼‰ï¼š</strong>
              </div>
        `;
        
        // é¡¯ç¤ºå‰5å€‹çµ„åˆ¥
        const topGroups = Object.entries(data.groupDetails)
          .sort((a, b) => b[1].qty - a[1].qty)
          .slice(0, 5);
        
        topGroups.forEach(([group, details]) => {
          html += `
            <div style="display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.85em;">
              <span style="color: #666;">${group}</span>
              <span style="color: #8b5cf6; font-weight: bold;">${details.qty} çµ„ | PV ${details.pv}</span>
            </div>
          `;
        });
        
        if (data.groups.size > 5) {
          html += `<div style="font-size: 0.8em; color: #999; margin-top: 5px;">...é‚„æœ‰ ${data.groups.size - 5} å€‹çµ„åˆ¥</div>`;
        }
        
        html += `
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      
      document.getElementById('teamOverview').innerHTML = html;
    }
    
    // æ›´æ–°åœ˜éšŠæ¯”è¼ƒ
    function updateTeamComparison() {
      const sortedTeams = Object.entries(teamData).sort((a, b) => b[1].totalQty - a[1].totalQty);
      const maxQty = sortedTeams[0] ? sortedTeams[0][1].totalQty : 1;
      
      let html = '<div style="padding: 20px;">';
      
      // æ¶è³¼çµ„æ•¸æ¯”è¼ƒ
      html += '<h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“Š æ¶è³¼çµ„æ•¸æ¯”è¼ƒ</h3>';
      sortedTeams.forEach(([team, data]) => {
        const percentage = (data.totalQty / maxQty * 100).toFixed(0);
        html += `
          <div class="chart-bar">
            <div class="chart-label">${team}</div>
            <div class="chart-bar-container">
              <div class="chart-bar-fill team-color" style="width: ${percentage}%;">${data.totalQty} çµ„</div>
            </div>
          </div>
        `;
      });
      
      // PV æ¯”è¼ƒ
      const maxPV = Math.max(...sortedTeams.map(t => t[1].totalPV));
      html += '<h3 style="color: #667eea; margin: 30px 0 15px;">ğŸ’ ç¸½ PV æ¯”è¼ƒ</h3>';
      sortedTeams.forEach(([team, data]) => {
        const percentage = (data.totalPV / maxPV * 100).toFixed(0);
        html += `
          <div class="chart-bar">
            <div class="chart-label">${team}</div>
            <div class="chart-bar-container">
              <div class="chart-bar-fill team-color" style="width: ${percentage}%;">${data.totalPV} PV</div>
            </div>
          </div>
        `;
      });
      
      // çµ±è¨ˆæ‘˜è¦è¡¨
      html += '<h3 style="color: #667eea; margin: 30px 0 15px;">ğŸ“‹ åœ˜éšŠç¸¾æ•ˆæ‘˜è¦</h3>';
      html += '<table style="width: 100%; font-size: 0.9em;">';
      html += `
        <thead style="background: #8b5cf6; color: white;">
          <tr>
            <th style="padding: 12px;">åœ˜éšŠ</th>
            <th style="padding: 12px; text-align: center;">æ¶è³¼çµ„æ•¸</th>
            <th style="padding: 12px; text-align: center;">ç¸½ PV</th>
            <th style="padding: 12px; text-align: center;">ç¸½é‡‘é¡</th>
            <th style="padding: 12px; text-align: center;">åƒèˆ‡äººæ•¸</th>
            <th style="padding: 12px; text-align: center;">çµ„åˆ¥æ•¸</th>
            <th style="padding: 12px; text-align: center;">å¹³å‡/äºº</th>
          </tr>
        </thead>
        <tbody>
      `;
      
      sortedTeams.forEach(([team, data], index) => {
        const avgPerPerson = (data.totalQty / data.buyers.size).toFixed(1);
        const rowClass = index < 3 ? 'highlight-row' : '';
        html += `
          <tr class="${rowClass}">
            <td style="padding: 10px;"><strong>${team}</strong></td>
            <td style="padding: 10px; text-align: center;">${data.totalQty}</td>
            <td style="padding: 10px; text-align: center;">${data.totalPV}</td>
            <td style="padding: 10px; text-align: center;">$${data.totalSales.toLocaleString()}</td>
            <td style="padding: 10px; text-align: center;">${data.buyers.size}</td>
            <td style="padding: 10px; text-align: center;">${data.groups.size}</td>
            <td style="padding: 10px; text-align: center;">${avgPerPerson}</td>
          </tr>
        `;
      });
      
      // ç¸½è¨ˆ
      const totalQty = sortedTeams.reduce((sum, t) => sum + t[1].totalQty, 0);
      const totalPV = sortedTeams.reduce((sum, t) => sum + t[1].totalPV, 0);
      const totalSales = sortedTeams.reduce((sum, t) => sum + t[1].totalSales, 0);
      const totalBuyers = new Set(sortedTeams.flatMap(t => Array.from(t[1].buyers))).size;
      
      html += `
        <tr style="background: #667eea; color: white; font-weight: bold;">
          <td style="padding: 10px;">ç¸½è¨ˆ</td>
          <td style="padding: 10px; text-align: center;">${totalQty}</td>
          <td style="padding: 10px; text-align: center;">${totalPV}</td>
          <td style="padding: 10px; text-align: center;">$${totalSales.toLocaleString()}</td>
          <td style="padding: 10px; text-align: center;">${totalBuyers}</td>
          <td style="padding: 10px; text-align: center;">-</td>
          <td style="padding: 10px; text-align: center;">-</td>
        </tr>
      `;
      
      html += '</tbody></table></div>';
      
      document.getElementById('teamComparison').innerHTML = html;
    }
    
    // æ›´æ–°åœ˜éšŠè©³ç´°è¡¨æ ¼
    function updateTeamDetailTable(reports) {
      const tbody = document.getElementById('teamDetailTable');
      tbody.innerHTML = '';
      
      reports.forEach(report => {
        tbody.innerHTML += `
          <tr>
            <td><span class="badge badge-team">${report.team}</span></td>
            <td>${report.groupCode}</td>
            <td><strong>${report.qty}</strong></td>
            <td>${report.buyer}</td>
            <td>$${report.price.toLocaleString()}</td>
            <td>${report.pv}</td>
            <td style="font-size: 0.85em;">${report.buySend}</td>
            <td style="font-size: 0.8em;">${report.groupId.substr(-6)}</td>
          </tr>
        `;
      });
    }
    
    // æ›´æ–°åœ˜éšŠæ’è¡Œæ¦œ
    function updateTeamRanking(reports) {
      const teamStats = {};
      
      reports.forEach(report => {
        const team = report.team || 'æœªåˆ†é…';
        if (!teamStats[team]) {
          teamStats[team] = { qty: 0, pv: 0 };
        }
        teamStats[team].qty += report.qty;
        teamStats[team].pv += report.pv * report.qty;
      });
      
      const sorted = Object.entries(teamStats)
        .sort((a, b) => b[1].qty - a[1].qty)
        .slice(0, 10);
      
      const tbody = document.getElementById('teamRankingTable');
      tbody.innerHTML = '';
      
      sorted.forEach(([team, stats], index) => {
        const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
        tbody.innerHTML += `
          <tr>
            <td><strong>${medal} ${index + 1}</strong></td>
            <td><span class="badge badge-team">${team}</span></td>
            <td>${stats.qty} çµ„</td>
            <td><strong>${stats.pv}</strong></td>
          </tr>
        `;
      });
    }
    
    // æ›´æ–°çµ„åˆ¥ç¯©é¸å™¨
    function updateGroupFilter(orders) {
      const groupFilter = document.getElementById('groupFilter');
      const groups = [...new Set(orders.map(o => o.groupName).filter(g => g))].sort();
      
      groupFilter.innerHTML = '<option value="all">å…¨éƒ¨çµ„åˆ¥</option>';
      groups.forEach(group => {
        groupFilter.innerHTML += `<option value="${group}">${group}</option>`;
      });
    }
    
    // æ›´æ–°åœ˜éšŠç¯©é¸å™¨
    function updateTeamFilter(reports) {
      const teamFilter = document.getElementById('teamFilter');
      const teams = [...new Set(reports.map(r => r.team).filter(t => t))].sort();
      
      teamFilter.innerHTML = '<option value="all">å…¨éƒ¨åœ˜éšŠ</option>';
      teams.forEach(team => {
        teamFilter.innerHTML += `<option value="${team}">${team}</option>`;
      });
    }
    
    // é‡æ–°æ•´ç†æ•¸æ“š
    async function refreshData() {
      await loadOrders();
      await loadReports();
    }
    
    // æ¸²æŸ“è¨‚å–®è¡¨æ ¼
    function renderOrders(orders) {
      const tbody = document.getElementById('ordersTable');
      tbody.innerHTML = '';
      
      if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #999;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</td></tr>';
        document.getElementById('orderCount').textContent = '0';
        return;
      }
      
      orders.forEach(order => {
        const productClass = order.product === '1A' ? 'product-a' : 'product-b';
        const badge = order.product === '1A' ? 'badge-success' : 'badge-warning';
        
        tbody.innerHTML += `
          <tr>
            <td>${order.id}</td>
            <td>${order.name}</td>
            <td><span class="badge ${badge}">${order.product}</span></td>
            <td class="${productClass}">${order.qty}</td>
            <td>$${order.price.toLocaleString()}</td>
            <td>${order.pv}</td>
            <td><strong>$${order.total.toLocaleString()}</strong></td>
            <td><span class="badge badge-info">${order.groupName || '-'}</span></td>
            <td><span class="badge badge-team">${order.team}</span></td>
            <td style="font-size: 0.85em;">${order.time}</td>
          </tr>
        `;
      });
      
      document.getElementById('orderCount').textContent = orders.length;
    }
    
    // æ›´æ–°çµ±è¨ˆæ•¸æ“š
    function updateStats(orders, reports) {
      const totalOrders = orders.length;
      const totalSales = orders.reduce((sum, order) => sum + order.total, 0);
      const totalPV = reports.reduce((sum, report) => sum + (report.pv * report.qty), 0);
      const uniqueTeams = new Set(reports.map(r => r.team).filter(t => t)).size;
      
      document.getElementById('totalOrders').textContent = totalOrders;
      document.getElementById('totalSales').textContent = '$' + totalSales.toLocaleString();
      document.getElementById('totalPV').textContent = totalPV.toLocaleString();
      document.getElementById('totalTeams').textContent = uniqueTeams;
    }
    
    // æ›´æ–°ç”¢å“åœ–è¡¨
    function updateProductChart(orders) {
      const productStats = {};
      
      orders.forEach(order => {
        if (!productStats[order.product]) {
          productStats[order.product] = { count: 0, sales: 0 };
        }
        productStats[order.product].count += order.qty;
        productStats[order.product].sales += order.total;
      });
      
      const total = Object.values(productStats).reduce((sum, p) => sum + p.count, 0);
      
      let html = '';
      for (const [product, stats] of Object.entries(productStats)) {
        const percentage = total > 0 ? (stats.count / total * 100).toFixed(0) : 0;
        const productName = product === '1A' ? '1A é †æš¢æ¸…æ–°è¤‡æ–¹' : '1B å¤å·´é¦™è„‚';
        const colorClass = product === '1A' ? 'group-a' : 'group-b';
        
        html += `
          <div class="chart-bar">
            <div class="chart-label">${productName}</div>
            <div class="chart-bar-container">
              <div class="chart-bar-fill ${colorClass}" style="width: ${percentage}%;">${stats.count} çµ„</div>
            </div>
          </div>
        `;
      }
      
      html += `
        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
          <p style="color: #666; margin-bottom: 10px;"><strong>ç”¢å“è©³æƒ…ï¼š</strong></p>
      `;
      
      for (const [product, stats] of Object.entries(productStats)) {
        const color = product === '1A' ? '#10b981' : '#f59e0b';
        const price = product === '1A' ? 1095 : 1445;
        const pv = product === '1A' ? 34 : 44;
        
        html += `<p style="color: ${color}; margin-bottom: 5px;">âœ“ ${product}ï¼šå–®åƒ¹ $${price.toLocaleString()} | PV ${pv} | éŠ·å”® $${stats.sales.toLocaleString()}</p>`;
      }
      
      html += '</div>';
      
      document.getElementById('productChart').innerHTML = html;
    }
    
    // æ›´æ–°æ’è¡Œæ¦œ
    function updateTopBuyers(orders) {
      const buyerStats = {};
      
      orders.forEach(order => {
        const mainName = order.name.split('(ä»£)')[0].trim();
        
        if (!buyerStats[mainName]) {
          buyerStats[mainName] = { qty: 0, sales: 0 };
        }
        buyerStats[mainName].qty += order.qty;
        buyerStats[mainName].sales += order.total;
      });
      
      const sorted = Object.entries(buyerStats)
        .sort((a, b) => b[1].sales - a[1].sales)
        .slice(0, 10);
      
      const tbody = document.getElementById('topBuyersTable');
      tbody.innerHTML = '';
      
      sorted.forEach(([name, stats], index) => {
        const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
        tbody.innerHTML += `
          <tr>
            <td><strong>${medal} ${index + 1}</strong></td>
            <td>${name}</td>
            <td>${stats.qty} çµ„</td>
            <td><strong>$${stats.sales.toLocaleString()}</strong></td>
          </tr>
        `;
      });
    }
    
    // å¥—ç”¨ç¯©é¸
    function applyFilters() {
      const productFilter = document.getElementById('productFilter').value;
      const groupFilter = document.getElementById('groupFilter').value;
      const teamFilter = document.getElementById('teamFilter').value;
      const nameSearch = document.getElementById('nameSearch').value.toLowerCase();
      
      let filtered = allOrders.filter(order => {
        const matchProduct = productFilter === 'all' || order.product === productFilter;
        const matchGroup = groupFilter === 'all' || order.groupName === groupFilter;
        const matchTeam = teamFilter === 'all' || order.team === teamFilter;
        const matchName = nameSearch === '' || order.name.toLowerCase().includes(nameSearch);
        
        return matchProduct && matchGroup && matchTeam && matchName;
      });
      
      renderOrders(filtered);
      updateProductChart(filtered);
      updateTopBuyers(filtered);
    }
    
    // é‡ç½®ç¯©é¸
    function resetFilters() {
      document.getElementById('productFilter').value = 'all';
      document.getElementById('groupFilter').value = 'all';
      document.getElementById('teamFilter').value = 'all';
      document.getElementById('nameSearch').value = '';
      
      if (allOrders.length > 0) {
        renderOrders(allOrders);
        updateProductChart(allOrders);
        updateTopBuyers(allOrders);
      }
    }
    
    // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¢å¾©è¨­å®š
    window.addEventListener('DOMContentLoaded', () => {
      const savedUrl = localStorage.getItem('webAppUrl');
      if (savedUrl) {
        document.getElementById('webAppUrl').value = savedUrl;
        WEB_APP_URL = savedUrl;
        
        // è‡ªå‹•è¼‰å…¥æ•¸æ“š
        connectAndLoad();
      }
    });
  </script>
</body>
</html>
