<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BOGO åœ˜éšŠåˆ†æç³»çµ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 30px;
      text-align: center;
    }
    
    .header h1 {
      color: #667eea;
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .card h2 {
      color: #667eea;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .btn {
      padding: 12px 30px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .btn:hover {
      background: #5568d3;
    }
    
    .btn-success {
      background: #10b981;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    input[type="text"] {
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      width: 100%;
      max-width: 700px;
    }
    
    .team-container {
      background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      border-left: 6px solid #8b5cf6;
    }
    
    .team-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 3px solid #e9d5ff;
    }
    
    .team-header h2 {
      color: #6b21a8;
      font-size: 1.8em;
      margin: 0;
      border: none;
      padding: 0;
    }
    
    .team-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
    }
    
    .team-stat-item {
      text-align: center;
      padding: 15px;
      background: #f9fafb;
      border-radius: 8px;
    }
    
    .team-stat-item .label {
      color: #6b7280;
      font-size: 0.85em;
      margin-bottom: 8px;
    }
    
    .team-stat-item .value {
      color: #8b5cf6;
      font-size: 1.8em;
      font-weight: bold;
    }
    
    .section-title {
      background: #8b5cf6;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 1.2em;
      font-weight: bold;
      margin: 25px 0 15px 0;
    }
    
    .group-summary {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .group-summary h4 {
      color: #8b5cf6;
      margin-bottom: 15px;
      font-size: 1.1em;
    }
    
    .group-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .group-item {
      background: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #8b5cf6;
    }
    
    .group-item .group-name {
      font-weight: bold;
      color: #374151;
      margin-bottom: 8px;
    }
    
    .group-item .group-stats {
      font-size: 0.9em;
      color: #6b7280;
      line-height: 1.6;
    }
    
    .person-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 4px solid #8b5cf6;
    }
    
    .person-name {
      font-size: 1.3em;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f3f4f6;
    }
    
    .order-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    
    .order-table th {
      background: #f3f4f6;
      padding: 12px 10px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .order-table td {
      padding: 12px 10px;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .order-table tbody tr:hover {
      background: #faf5ff;
    }
    
    .order-table .total-row {
      background: #fef3c7;
      font-weight: bold;
    }
    
    .person-total {
      background: #fef3c7;
      padding: 12px 15px;
      border-radius: 8px;
      font-weight: bold;
      text-align: right;
      margin-top: 10px;
    }
    
    .team-total {
      background: #8b5cf6;
      color: white;
      padding: 20px;
      border-radius: 10px;
      font-size: 1.2em;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 600;
    }
    
    .badge-1a {
      background: #d1fae5;
      color: #065f46;
    }
    
    .badge-1b {
      background: #fef3c7;
      color: #92400e;
    }
    
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }
    
    .loading.show {
      display: flex;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    .loading-text {
      color: white;
      font-size: 1.2em;
      font-weight: 600;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .alert {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .alert-success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .alert-error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .filter-bar {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    select {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
    }
    
    .comparison-chart {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .chart-bar {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .chart-label {
      width: 150px;
      font-weight: 600;
      color: #374151;
    }
    
    .chart-bar-container {
      flex: 1;
      height: 30px;
      background: #f3f4f6;
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }
    
    .chart-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #8b5cf6, #6d28d9);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: white;
      font-weight: bold;
      font-size: 0.9em;
      transition: width 1s ease;
    }
    
    @media print {
      body {
        background: white;
      }
      .header, .card:first-of-type, .filter-bar {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">è¼‰å…¥ä¸­...</div>
  </div>
  
  <div class="container">
    <div class="header">
      <h1>ğŸ¯ BOGO åœ˜éšŠåˆ†æç³»çµ±</h1>
      <p>ä»¥åœ˜éšŠç‚ºä¸»è»¸çš„å®Œæ•´è¨‚è³¼èˆ‡æ¶è³¼åˆ†æ</p>
    </div>
    
    <!-- é€£æ¥è¨­å®š -->
    <div class="card">
      <h2>ğŸ”— é€£æ¥ Google Sheets</h2>
      <div id="alertContainer"></div>
      
      <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px;">
        <input type="text" id="webAppUrl" placeholder="è²¼ä¸Š Apps Script Web App URL">
        <button class="btn btn-success" onclick="connectAndAnalyze()">ğŸš€ é–‹å§‹åˆ†æ</button>
      </div>
    </div>
    
    <!-- ç¯©é¸åˆ— -->
    <div class="filter-bar" id="filterBar" style="display: none;">
      <label style="font-weight: 600;">é¸æ“‡åœ˜éšŠï¼š</label>
      <select id="teamFilter" onchange="filterTeam()">
        <option value="all">å…¨éƒ¨åœ˜éšŠ</option>
      </select>
      <button class="btn" onclick="exportReport()">ğŸ“¥ åŒ¯å‡ºå ±å‘Š</button>
      <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
    </div>
    
    <!-- åœ˜éšŠæ¯”è¼ƒåœ–è¡¨ -->
    <div class="comparison-chart" id="comparisonChart" style="display: none;">
      <h3 style="color: #8b5cf6; margin-bottom: 20px;">ğŸ“Š åœ˜éšŠç¸¾æ•ˆæ¯”è¼ƒ</h3>
      <div id="chartContent"></div>
    </div>
    
    <!-- åˆ†æå…§å®¹ -->
    <div id="analysisContent"></div>
  </div>
  
  <script>
    let WEB_APP_URL = '';
    let allOrders = [];
    let allReports = [];
    let maintenanceData = [];
    let teamAnalysisData = {};
    
    // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
    function showLoading(show, text = 'è¼‰å…¥ä¸­...') {
      document.getElementById('loading').classList.toggle('show', show);
      document.getElementById('loadingText').textContent = text;
    }
    
    // é¡¯ç¤ºæç¤º
    function showAlert(message, type = 'success') {
      const container = document.getElementById('alertContainer');
      container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => container.innerHTML = '', 8000);
    }
    
    // é€£æ¥ä¸¦åˆ†æ
    async function connectAndAnalyze() {
      const url = document.getElementById('webAppUrl').value.trim();
      
      if (!url) {
        showAlert('è«‹è¼¸å…¥ Web App URL', 'error');
        return;
      }
      
      WEB_APP_URL = url;
      localStorage.setItem('webAppUrl', url);
      
      showLoading(true, 'æ­£åœ¨é€£æ¥è©¦ç®—è¡¨...');
      
      try {
        // æ¸¬è©¦é€£ç·š
        showLoading(true, 'æ¸¬è©¦é€£ç·šä¸­...');
        const testResponse = await fetch(WEB_APP_URL + '?action=test');
        const testResult = await testResponse.json();
        
        if (!testResult.success) {
          throw new Error('é€£ç·šæ¸¬è©¦å¤±æ•—ï¼š' + testResult.data);
        }
        
        // è¼‰å…¥è¨‚å–®è³‡æ–™
        showLoading(true, 'è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­...');
        const ordersResponse = await fetch(WEB_APP_URL + '?action=getOrders');
        const ordersResult = await ordersResponse.json();
        
        if (!ordersResult.success) {
          throw new Error('è¼‰å…¥è¨‚å–®å¤±æ•—ï¼š' + ordersResult.data);
        }
        allOrders = ordersResult.data;
        
        // è¼‰å…¥æ¶è³¼å›å ±
        showLoading(true, 'è¼‰å…¥æ¶è³¼å›å ±ä¸­...');
        const reportsResponse = await fetch(WEB_APP_URL + '?action=getReports');
        const reportsResult = await reportsResponse.json();
        
        if (!reportsResult.success) {
          throw new Error('è¼‰å…¥æ¶è³¼å›å ±å¤±æ•—ï¼š' + reportsResult.data);
        }
        allReports = reportsResult.data;
        
        // è¼‰å…¥ä¸Šç·šç¶­è­·è³‡æ–™
        showLoading(true, 'è¼‰å…¥ç¶­è­·è³‡æ–™ä¸­...');
        const maintenanceResponse = await fetch(WEB_APP_URL + '?action=getMaintenance');
        const maintenanceResult = await maintenanceResponse.json();
        
        if (maintenanceResult.success) {
          maintenanceData = maintenanceResult.data;
        }
        
        // é–‹å§‹åˆ†æ
        showLoading(true, 'åˆ†ææ•¸æ“šä¸­...');
        analyzeByTeam();
        
        showAlert(`âœ… åˆ†æå®Œæˆï¼è¨‚å–®ï¼š${allOrders.length} ç­†ï¼Œæ¶è³¼ï¼š${allReports.length} ç­†`, 'success');
        
        document.getElementById('filterBar').style.display = 'flex';
        document.getElementById('comparisonChart').style.display = 'block';
        
      } catch (error) {
        showAlert('âŒ ' + error.message, 'error');
        console.error(error);
      } finally {
        showLoading(false);
      }
    }
    
    // ä»¥åœ˜éšŠç‚ºä¸»è»¸åˆ†æ
    function analyzeByTeam() {
      teamAnalysisData = {};
      
      // å»ºç«‹è¨‚è³¼åå–®åˆ°åœ˜éšŠçš„æ˜ å°„
      const nameToTeamMap = {};
      maintenanceData.forEach(item => {
        if (item.è¨‚è³¼åå–® && item.åœ˜éšŠ) {
          nameToTeamMap[item.è¨‚è³¼åå–®] = item.åœ˜éšŠ;
        }
      });
      
      // å»ºç«‹æ¶è³¼è€…åˆ°åœ˜éšŠçš„æ˜ å°„
      allReports.forEach(report => {
        if (report.æ¶è³¼è€… && report.åœ˜éšŠ) {
          nameToTeamMap[report.æ¶è³¼è€…] = report.åœ˜éšŠ;
        }
      });
      
      // è™•ç†è¨‚å–®æ•¸æ“š
      allOrders.forEach(order => {
        const name = order.LINEåç¨±.split('(ä»£)')[0].trim();
        const team = order.åœ˜éšŠ || nameToTeamMap[name] || nameToTeamMap[order.LINEåç¨±] || 'æœªåˆ†é…';
        const groupCode = order.çµ„åˆ¥ä»£è™Ÿ || order.çµ„åˆ¥ || 'æœªåˆ†çµ„';
        
        if (!teamAnalysisData[team]) {
          teamAnalysisData[team] = {
            orders: {},
            reports: {},
            groupSummary: {},
            reportGroupSummary: {},
            totalOrderQty: 0,
            totalOrderAmount: 0,
            totalOrderPV: 0,
            totalReportQty: 0,
            totalReportAmount: 0,
            totalReportPV: 0
          };
        }
        
        if (!teamAnalysisData[team].orders[name]) {
          teamAnalysisData[team].orders[name] = {};
        }
        
        if (!teamAnalysisData[team].orders[name][groupCode]) {
          teamAnalysisData[team].orders[name][groupCode] = {
            items: [],
            totalQty: 0,
            totalAmount: 0,
            totalPV: 0
          };
        }
        
        const qty = parseInt(order.è¨‚è³¼æ•¸é‡) || 0;
        const price = parseInt(order.å–®åƒ¹) || 0;
        const pv = parseInt(order.PV) || 0;
        const amount = parseInt(order.åˆè¨ˆ) || (qty * price);
        
        teamAnalysisData[team].orders[name][groupCode].items.push({
          product: order.çµ„åˆ¥ä»£è™Ÿ,
          productName: order['ç”¢å“åç¨±( BOGOå°ˆç”¨ )'] || '',
          qty: qty,
          price: price,
          pv: pv,
          amount: amount,
          time: order['2022/11/17'] || ''
        });
        
        teamAnalysisData[team].orders[name][groupCode].totalQty += qty;
        teamAnalysisData[team].orders[name][groupCode].totalAmount += amount;
        teamAnalysisData[team].orders[name][groupCode].totalPV += pv * qty;
        
        // çµ„åˆ¥çµ±è¨ˆ
        if (!teamAnalysisData[team].groupSummary[groupCode]) {
          teamAnalysisData[team].groupSummary[groupCode] = {
            qty: 0,
            amount: 0,
            pv: 0
          };
        }
        teamAnalysisData[team].groupSummary[groupCode].qty += qty;
        teamAnalysisData[team].groupSummary[groupCode].amount += amount;
        teamAnalysisData[team].groupSummary[groupCode].pv += pv * qty;
        
        teamAnalysisData[team].totalOrderQty += qty;
        teamAnalysisData[team].totalOrderAmount += amount;
        teamAnalysisData[team].totalOrderPV += pv * qty;
      });
      
      // è™•ç†æ¶è³¼å›å ±æ•¸æ“š
      allReports.forEach(report => {
        const team = report.åœ˜éšŠ || 'æœªåˆ†é…';
        const buyer = report.æ¶è³¼è€…;
        const groupCode = report.çµ„åˆ¥ä»£è™Ÿ || 'æœªåˆ†çµ„';
        
        if (!teamAnalysisData[team]) {
          teamAnalysisData[team] = {
            orders: {},
            reports: {},
            groupSummary: {},
            reportGroupSummary: {},
            totalOrderQty: 0,
            totalOrderAmount: 0,
            totalOrderPV: 0,
            totalReportQty: 0,
            totalReportAmount: 0,
            totalReportPV: 0
          };
        }
        
        if (!teamAnalysisData[team].reports[buyer]) {
          teamAnalysisData[team].reports[buyer] = {};
        }
        
        if (!teamAnalysisData[team].reports[buyer][groupCode]) {
          teamAnalysisData[team].reports[buyer][groupCode] = {
            items: [],
            totalQty: 0,
            totalAmount: 0,
            totalPV: 0
          };
        }
        
        const qty = parseInt(report.æ¶è³¼çµ„æ•¸) || 0;
        const price = parseInt(report.å–®åƒ¹) || 0;
        const pv = parseInt(report.PVæ•¸) || 0;
        const amount = qty * price;
        
        teamAnalysisData[team].reports[buyer][groupCode].items.push({
          qty: qty,
          price: price,
          pv: pv,
          amount: amount,
          buySend: report['è²·/é€'] || '',
          account: report['æ¶è³¼å¸³è™Ÿ/å‚™è¨»'] || ''
        });
        
        teamAnalysisData[team].reports[buyer][groupCode].totalQty += qty;
        teamAnalysisData[team].reports[buyer][groupCode].totalAmount += amount;
        teamAnalysisData[team].reports[buyer][groupCode].totalPV += pv * qty;
        
        // æ¶è³¼çµ„åˆ¥çµ±è¨ˆ
        if (!teamAnalysisData[team].reportGroupSummary[groupCode]) {
          teamAnalysisData[team].reportGroupSummary[groupCode] = {
            qty: 0,
            amount: 0,
            pv: 0
          };
        }
        teamAnalysisData[team].reportGroupSummary[groupCode].qty += qty;
        teamAnalysisData[team].reportGroupSummary[groupCode].amount += amount;
        teamAnalysisData[team].reportGroupSummary[groupCode].pv += pv * qty;
        
        teamAnalysisData[team].totalReportQty += qty;
        teamAnalysisData[team].totalReportAmount += amount;
        teamAnalysisData[team].totalReportPV += pv * qty;
      });
      
      // æ›´æ–°åœ˜éšŠé¸æ“‡å™¨
      const teamFilter = document.getElementById('teamFilter');
      teamFilter.innerHTML = '<option value="all">å…¨éƒ¨åœ˜éšŠ</option>';
      Object.keys(teamAnalysisData).sort().forEach(team => {
        teamFilter.innerHTML += `<option value="${team}">${team}</option>`;
      });
      
      // é¡¯ç¤ºæ¯”è¼ƒåœ–è¡¨
      displayComparisonChart();
      
      // é¡¯ç¤ºåˆ†æçµæœ
      displayTeamAnalysis();
    }
    
    // é¡¯ç¤ºæ¯”è¼ƒåœ–è¡¨
    function displayComparisonChart() {
      const chartContent = document.getElementById('chartContent');
      
      const teams = Object.keys(teamAnalysisData).sort();
      const maxOrderQty = Math.max(...teams.map(t => teamAnalysisData[t].totalOrderQty));
      const maxReportQty = Math.max(...teams.map(t => teamAnalysisData[t].totalReportQty));
      
      let html = '<h4 style="color: #6b7280; margin-bottom: 15px;">è¨‚è³¼æ•¸é‡æ¯”è¼ƒ</h4>';
      teams.forEach(team => {
        const data = teamAnalysisData[team];
        const percentage = maxOrderQty > 0 ? (data.totalOrderQty / maxOrderQty * 100) : 0;
        
        html += `
          <div class="chart-bar">
            <div class="chart-label">${team}</div>
            <div class="chart-bar-container">
              <div class="chart-bar-fill" style="width: ${percentage}%;">${data.totalOrderQty} çµ„</div>
            </div>
          </div>
        `;
      });
      
      html += '<h4 style="color: #6b7280; margin: 25px 0 15px;">æ¶è³¼æ•¸é‡æ¯”è¼ƒ</h4>';
      teams.forEach(team => {
        const data = teamAnalysisData[team];
        const percentage = maxReportQty > 0 ? (data.totalReportQty / maxReportQty * 100) : 0;
        
        html += `
          <div class="chart-bar">
            <div class="chart-label">${team}</div>
            <div class="chart-bar-container">
              <div class="chart-bar-fill" style="width: ${percentage}%;">${data.totalReportQty} çµ„</div>
            </div>
          </div>
        `;
      });
      
      chartContent.innerHTML = html;
    }
    
    // é¡¯ç¤ºåœ˜éšŠåˆ†æ
    function displayTeamAnalysis(selectedTeam = 'all') {
      const container = document.getElementById('analysisContent');
      let html = '';
      
      const teamsToShow = selectedTeam === 'all' 
        ? Object.keys(teamAnalysisData).sort() 
        : [selectedTeam];
      
      teamsToShow.forEach(team => {
        const data = teamAnalysisData[team];
        
        html += `
          <div class="team-container">
            <div class="team-header">
              <h2>ğŸ¢ ${team}</h2>
            </div>
            
            <div class="team-stats">
              <div class="team-stat-item">
                <div class="label">è¨‚è³¼ç¸½æ•¸é‡</div>
                <div class="value">${data.totalOrderQty}</div>
              </div>
              <div class="team-stat-item">
                <div class="label">è¨‚è³¼ç¸½é‡‘é¡</div>
                <div class="value">$${data.totalOrderAmount.toLocaleString()}</div>
              </div>
              <div class="team-stat-item">
                <div class="label">è¨‚è³¼ç¸½ PV</div>
                <div class="value">${data.totalOrderPV.toLocaleString()}</div>
              </div>
              <div class="team-stat-item">
                <div class="label">æ¶è³¼ç¸½æ•¸é‡</div>
                <div class="value">${data.totalReportQty}</div>
              </div>
              <div class="team-stat-item">
                <div class="label">æ¶è³¼ç¸½é‡‘é¡</div>
                <div class="value">$${data.totalReportAmount.toLocaleString()}</div>
              </div>
              <div class="team-stat-item">
                <div class="label">æ¶è³¼ç¸½ PV</div>
                <div class="value">${data.totalReportPV.toLocaleString()}</div>
              </div>
            </div>
        `;
        
        // è¨‚è³¼çµ„åˆ¥çµ±è¨ˆ
        if (Object.keys(data.groupSummary).length > 0) {
          html += `
            <div class="group-summary">
              <h4>ğŸ“¦ è¨‚è³¼çµ„åˆ¥çµ±è¨ˆ</h4>
              <div class="group-grid">
          `;
          
          for (const [groupCode, stats] of Object.entries(data.groupSummary).sort((a, b) => b[1].qty - a[1].qty)) {
            html += `
              <div class="group-item">
                <div class="group-name">${groupCode}</div>
                <div class="group-stats">
                  æ•¸é‡ï¼š<strong>${stats.qty}</strong><br>
                  é‡‘é¡ï¼š<strong>$${stats.amount.toLocaleString()}</strong><br>
                  PVï¼š<strong>${stats.pv}</strong>
                </div>
              </div>
            `;
          }
          
          html += `
              </div>
            </div>
          `;
        }
        
        // æ¶è³¼çµ„åˆ¥çµ±è¨ˆ
        if (Object.keys(data.reportGroupSummary).length > 0) {
          html += `
            <div class="group-summary">
              <h4>ğŸ¯ æ¶è³¼çµ„åˆ¥çµ±è¨ˆ</h4>
              <div class="group-grid">
          `;
          
          for (const [groupCode, stats] of Object.entries(data.reportGroupSummary).sort((a, b) => b[1].qty - a[1].qty)) {
            html += `
              <div class="group-item">
                <div class="group-name">${groupCode}</div>
                <div class="group-stats">
                  æ•¸é‡ï¼š<strong>${stats.qty}</strong><br>
                  é‡‘é¡ï¼š<strong>$${stats.amount.toLocaleString()}</strong><br>
                  PVï¼š<strong>${stats.pv}</strong>
                </div>
              </div>
            `;
          }
          
          html += `
              </div>
            </div>
          `;
        }
        
        // è¨‚è³¼æ¸…å–®
        html += `<div class="section-title">ğŸ“‹ è¨‚è³¼è©³ç´°æ¸…å–®</div>`;
        
        for (const [person, groups] of Object.entries(data.orders)) {
          html += `
            <div class="person-card">
              <div class="person-name">ğŸ‘¤ ${person}</div>
              <table class="order-table">
                <thead>
                  <tr>
                    <th>çµ„åˆ¥ä»£è™Ÿ</th>
                    <th>ç”¢å“åç¨±</th>
                    <th>æ•¸é‡</th>
                    <th>å–®åƒ¹</th>
                    <th>PV</th>
                    <th>é‡‘é¡</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          let personTotal = { qty: 0, amount: 0, pv: 0 };
          
          for (const [groupCode, groupData] of Object.entries(groups)) {
            // åªé¡¯ç¤ºåˆè¨ˆè¡Œ
            html += `
              <tr class="total-row">
                <td><strong>${groupCode}</strong></td>
                <td colspan="2"><strong>å°è¨ˆï¼š${groupData.totalQty} çµ„</strong></td>
                <td>-</td>
                <td><strong>${groupData.totalPV}</strong></td>
                <td><strong>$${groupData.totalAmount.toLocaleString()}</strong></td>
              </tr>
            `;
            
            personTotal.qty += groupData.totalQty;
            personTotal.amount += groupData.totalAmount;
            personTotal.pv += groupData.totalPV;
          }
          
          html += `
                </tbody>
              </table>
              <div class="person-total">
                ${person} ç¸½è¨ˆï¼šæ•¸é‡ ${personTotal.qty} | é‡‘é¡ $${personTotal.amount.toLocaleString()} | PV ${personTotal.pv}
              </div>
            </div>
          `;
        }
        
        // æ¶è³¼æ¸…å–®
        html += `<div class="section-title">ğŸ¯ æ¶è³¼è©³ç´°æ¸…å–®</div>`;
        
        for (const [buyer, groups] of Object.entries(data.reports)) {
          html += `
            <div class="person-card">
              <div class="person-name">ğŸ‘¤ ${buyer}</div>
              <table class="order-table">
                <thead>
                  <tr>
                    <th>çµ„åˆ¥ä»£è™Ÿ</th>
                    <th>æ¶è³¼çµ„æ•¸</th>
                    <th>å–®åƒ¹</th>
                    <th>PV</th>
                    <th>é‡‘é¡</th>
                    <th>è²·/é€</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          let buyerTotal = { qty: 0, amount: 0, pv: 0 };
          
          for (const [groupCode, groupData] of Object.entries(groups)) {
            // åªé¡¯ç¤ºåˆè¨ˆè¡Œ
            html += `
              <tr class="total-row">
                <td><strong>${groupCode}</strong></td>
                <td><strong>${groupData.totalQty} çµ„</strong></td>
                <td>-</td>
                <td><strong>${groupData.totalPV}</strong></td>
                <td><strong>$${groupData.totalAmount.toLocaleString()}</strong></td>
                <td>${groupData.items[0]?.buySend || '-'}</td>
              </tr>
            `;
            
            buyerTotal.qty += groupData.totalQty;
            buyerTotal.amount += groupData.totalAmount;
            buyerTotal.pv += groupData.totalPV;
          }
          
          html += `
                </tbody>
              </table>
              <div class="person-total">
                ${buyer} ç¸½è¨ˆï¼šæ•¸é‡ ${buyerTotal.qty} | é‡‘é¡ $${buyerTotal.amount.toLocaleString()} | PV ${buyerTotal.pv}
              </div>
            </div>
          `;
        }
        
        // åœ˜éšŠç¸½è¨ˆ
        html += `
            <div class="team-total">
              ${team} ç¸½è¨ˆ | 
              è¨‚è³¼ï¼š${data.totalOrderQty} çµ„ / $${data.totalOrderAmount.toLocaleString()} / PV ${data.totalOrderPV} | 
              æ¶è³¼ï¼š${data.totalReportQty} çµ„ / $${data.totalReportAmount.toLocaleString()} / PV ${data.totalReportPV}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // ç¯©é¸åœ˜éšŠ
    function filterTeam() {
      const selectedTeam = document.getElementById('teamFilter').value;
      displayTeamAnalysis(selectedTeam);
    }
    
    // åŒ¯å‡ºå ±å‘Š
    function exportReport() {
      let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
      csvContent += "BOGO åœ˜éšŠåˆ†æå ±å‘Š\n\n";
      
      for (const [team, data] of Object.entries(teamAnalysisData)) {
        csvContent += `\nåœ˜éšŠï¼š${team}\n`;
        csvContent += `è¨‚è³¼ç¸½æ•¸é‡,${data.totalOrderQty}\n`;
        csvContent += `è¨‚è³¼ç¸½é‡‘é¡,$${data.totalOrderAmount}\n`;
        csvContent += `è¨‚è³¼ç¸½PV,${data.totalOrderPV}\n`;
        csvContent += `æ¶è³¼ç¸½æ•¸é‡,${data.totalReportQty}\n`;
        csvContent += `æ¶è³¼ç¸½é‡‘é¡,$${data.totalReportAmount}\n`;
        csvContent += `æ¶è³¼ç¸½PV,${data.totalReportPV}\n\n`;
        
        csvContent += "è¨‚è³¼çµ„åˆ¥çµ±è¨ˆ\n";
        csvContent += "çµ„åˆ¥ä»£è™Ÿ,æ•¸é‡,é‡‘é¡,PV\n";
        for (const [groupCode, stats] of Object.entries(data.groupSummary)) {
          csvContent += `${groupCode},${stats.qty},${stats.amount},${stats.pv}\n`;
        }
        
        csvContent += "\næ¶è³¼çµ„åˆ¥çµ±è¨ˆ\n";
        csvContent += "çµ„åˆ¥ä»£è™Ÿ,æ•¸é‡,é‡‘é¡,PV\n";
        for (const [groupCode, stats] of Object.entries(data.reportGroupSummary)) {
          csvContent += `${groupCode},${stats.qty},${stats.amount},${stats.pv}\n`;
        }
        
        csvContent += "\n";
      }
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "BOGOåœ˜éšŠåˆ†æ_" + new Date().toISOString().split('T')[0] + ".csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showAlert('âœ… å ±å‘Šå·²åŒ¯å‡º', 'success');
    }
    
    // é é¢è¼‰å…¥æ™‚æ¢å¾© URL
    window.addEventListener('DOMContentLoaded', () => {
      const savedUrl = localStorage.getItem('webAppUrl');
      if (savedUrl) {
        document.getElementById('webAppUrl').value = savedUrl;
      }
    });
  </script>
</body>
</html>
