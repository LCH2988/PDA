<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°ç£å¸•é‡‘æ£®ç—…å‹å”æœƒ - æœƒå“¡ç³»çµ±</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      
      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 20px;
      }
      
      .container {
          background: white;
          border-radius: 20px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          max-width: 450px;
          width: 100%;
          overflow: hidden;
      }
      
      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 30px;
          text-align: center;
      }
      
      .header h1 {
          font-size: 24px;
          margin-bottom: 5px;
      }
      
      .header p {
          font-size: 14px;
          opacity: 0.9;
      }
      
      .content {
          padding: 30px;
      }
      
      .tab-buttons {
          display: flex;
          gap: 10px;
          margin-bottom: 25px;
      }
      
      .tab-btn {
          flex: 1;
          padding: 12px;
          border: 2px solid #667eea;
          background: white;
          color: #667eea;
          border-radius: 10px;
          cursor: pointer;
          font-size: 16px;
          font-weight: bold;
          transition: all 0.3s;
      }
      
      .tab-btn.active {
          background: #667eea;
          color: white;
      }
      
      .tab-content {
          display: none;
      }
      
      .tab-content.active {
          display: block;
      }
      
      .form-group {
          margin-bottom: 20px;
      }
      
      .form-group label {
          display: block;
          margin-bottom: 8px;
          color: #333;
          font-weight: bold;
          font-size: 14px;
      }
      
      .form-group input {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e0e0e0;
          border-radius: 10px;
          font-size: 16px;
          transition: all 0.3s;
      }
      
      .form-group input:focus {
          outline: none;
          border-color: #667eea;
      }
      
      .btn {
          width: 100%;
          padding: 15px;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s;
          margin-top: 10px;
      }
      
      .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
      }
      
      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      }
      
      .btn-line {
          background: #06C755;
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
      }
      
      .btn-line:hover {
          background: #05b34c;
          transform: translateY(-2px);
      }
      
      .divider {
          text-align: center;
          margin: 25px 0;
          position: relative;
      }
      
      .divider::before {
          content: '';
          position: absolute;
          left: 0;
          top: 50%;
          width: 100%;
          height: 1px;
          background: #e0e0e0;
      }
      
      .divider span {
          background: white;
          padding: 0 15px;
          position: relative;
          color: #999;
          font-size: 14px;
      }
      
      .info-box {
          background: #f0f4ff;
          border-left: 4px solid #667eea;
          padding: 15px;
          border-radius: 5px;
          margin-bottom: 20px;
          font-size: 14px;
          color: #555;
      }
      
      .loading {
          display: none;
          text-align: center;
          padding: 20px;
      }
      
      .loading.active {
          display: block;
      }
      
      .spinner {
          border: 3px solid #f3f3f3;
          border-top: 3px solid #667eea;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
          margin: 0 auto;
      }
      
      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }
      
      .message {
          padding: 12px;
          border-radius: 8px;
          margin-bottom: 15px;
          display: none;
          font-size: 14px;
      }
      
      .message.success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }
      
      .message.error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }
      
      .message.active {
          display: block;
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>ğŸ—ï¸ å°ç£å¸•é‡‘æ£®ç—…å‹å”æœƒ</h1>
          <p>æœƒå“¡ç™»å…¥è¨»å†Šç³»çµ±</p>
      </div>
      
      <div class="content">
          <div id="loading" class="loading">
              <div class="spinner"></div>
              <p style="margin-top: 15px; color: #667eea;">è™•ç†ä¸­...</p>
          </div>
          
          <div id="mainContent">
              <div id="message" class="message"></div>
              
              <!-- LINE ç™»å…¥å€ -->
              <div id="lineLoginSection">
                  <button class="btn btn-line" onclick="liffLogin()">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                          <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                      </svg>
                      ä½¿ç”¨ LINE å¿«é€Ÿç™»å…¥
                  </button>
                  
                  <div class="divider">
                      <span>æˆ–</span>
                  </div>
              </div>
              
              <!-- æ‰‹å‹•ç™»å…¥/è¨»å†Š -->
              <div class="tab-buttons">
                  <button class="tab-btn active" onclick="switchTab('login')">ç™»å…¥</button>
                  <button class="tab-btn" onclick="switchTab('register')">è¨»å†Š</button>
              </div>
              
              <!-- ç™»å…¥è¡¨å–® -->
              <div id="loginTab" class="tab-content active">
                  <form onsubmit="handleLogin(event)">
                      <div class="form-group">
                          <label>é›»è©±è™Ÿç¢¼</label>
                          <input type="tel" id="loginPhone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼" required>
                      </div>
                      <div class="form-group">
                          <label>å¯†ç¢¼</label>
                          <input type="password" id="loginPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
                      </div>
                      <button type="submit" class="btn btn-primary">ç™»å…¥</button>
                  </form>
              </div>
              
              <!-- è¨»å†Šè¡¨å–® -->
              <div id="registerTab" class="tab-content">
                  <div class="info-box">
                      â„¹ï¸ å¦‚æœæ‚¨æ²’æœ‰ LINE å¸³è™Ÿï¼Œå¯ä»¥ä½¿ç”¨æ‰‹æ©Ÿè™Ÿç¢¼è¨»å†Š
                  </div>
                  <form onsubmit="handleRegister(event)">
                      <div class="form-group">
                          <label>çœŸå¯¦å§“å *</label>
                          <input type="text" id="registerName" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" required>
                      </div>
                      <div class="form-group">
                          <label>æ‰‹æ©Ÿè™Ÿç¢¼ *</label>
                          <input type="tel" id="registerPhone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼" required>
                      </div>
                      <div class="form-group">
                          <label>å¯†ç¢¼ *</label>
                          <input type="password" id="registerPassword" placeholder="è«‹è¨­å®šå¯†ç¢¼ï¼ˆè‡³å°‘6ä½ï¼‰" required minlength="6">
                      </div>
                      <div class="form-group">
                          <label>ç¢ºèªå¯†ç¢¼ *</label>
                          <input type="password" id="registerPasswordConfirm" placeholder="è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼" required>
                      </div>
                      <button type="submit" class="btn btn-primary">è¨»å†Š</button>
                  </form>
              </div>
          </div>
      </div>
  </div>

  <script>
      // ==================== è¨­å®šå€ ====================
      const LIFF_ID = '1656516134-VaGgmaPm'; // è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbzHPAAEOgKsghNwYmeaqIKo__QtDbo1Cxq_YTAnQX5hDnDavBksTY5rovMN5CLzrCYe7Q/exec'; // è«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS Web App URL
      
      let liffInitialized = false;
      
      // ==================== LIFF åˆå§‹åŒ– ====================
      window.onload = async function() {
          try {
              await liff.init({ liffId: LIFF_ID });
              liffInitialized = true;
              
              // æª¢æŸ¥æ˜¯å¦åœ¨ LINE ä¸­é–‹å•Ÿ
              if (liff.isInClient()) {
                  // å¦‚æœå·²ç™»å…¥ LINE
                  if (liff.isLoggedIn()) {
                      await handleLiffLogin();
                  }
              } else {
                  console.log('Not in LINE app');
              }
          } catch (error) {
              console.error('LIFF initialization failed', error);
              showMessage('LINE ç™»å…¥åŠŸèƒ½åˆå§‹åŒ–å¤±æ•—', 'error');
          }
      };
      
      // ==================== LINE ç™»å…¥è™•ç† ====================
      function liffLogin() {
          if (!liffInitialized) {
              showMessage('LINE ç™»å…¥åŠŸèƒ½å°šæœªæº–å‚™å¥½', 'error');
              return;
          }
          
          if (!liff.isLoggedIn()) {
              liff.login();
          } else {
              handleLiffLogin();
          }
      }
      
      // åœ¨ handleRegister å‡½æ•¸ä¸­åŠ å…¥æ‰‹æ©Ÿè™Ÿç¢¼é©—è­‰
async function handleRegister(event) {
    event.preventDefault();
    showLoading(true);
    
    const name = document.getElementById('registerName').value;
    const phone = document.getElementById('registerPhone').value;
    const password = document.getElementById('registerPassword').value;
    const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
    
    // âœ… æ–°å¢ï¼šæ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼é©—è­‰
    const phoneRegex = /^09\d{8}$/;
    if (!phoneRegex.test(phone)) {
        showMessage('è«‹è¼¸å…¥æ­£ç¢ºçš„å°ç£æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼ï¼ˆ09é–‹é ­ï¼Œå…±10ç¢¼ï¼‰', 'error');
        showLoading(false);
        return;
    }
    
    if (password !== passwordConfirm) {
        showMessage('å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´', 'error');
        showLoading(false);
        return;
    }
    
    try {
        const response = await fetch(GAS_URL, {
            method: 'POST',
            mode: 'no-cors', // âœ… åŠ å…¥ mode
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'manualRegister',
                name: name,
                phone: phone,
                password: password
            })
        });
        
        // âœ… æ”¹å–„éŒ¯èª¤è™•ç†
        if (response.type === 'opaque') {
            // no-cors æ¨¡å¼ä¸‹ç„¡æ³•è®€å–å›æ‡‰ï¼Œå‡è¨­æˆåŠŸ
            showMessage('è¨»å†ŠæˆåŠŸï¼è«‹ä½¿ç”¨é›»è©±è™Ÿç¢¼ç™»å…¥', 'success');
            setTimeout(() => {
                switchTab('login');
                document.getElementById('loginPhone').value = phone;
            }, 2000);
        } else {
            const result = await response.json();
            
            if (result.success) {
                showMessage('è¨»å†ŠæˆåŠŸï¼è«‹ä½¿ç”¨é›»è©±è™Ÿç¢¼ç™»å…¥', 'success');
                setTimeout(() => {
                    switchTab('login');
                    document.getElementById('loginPhone').value = phone;
                }, 2000);
            } else {
                showMessage(result.message || 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }
    } catch (error) {
        console.error('Registration error:', error);
        showMessage('è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
    } finally {
        showLoading(false);
    }
}

      
      // ==================== é¦–æ¬¡ LINE ç™»å…¥è¨»å†Š ====================
      function showFirstTimeRegistration(lineId, lineName) {
          const content = document.getElementById('mainContent');
          content.innerHTML = `
              <div class="info-box">
                  âœ¨ æ­¡è¿ä½¿ç”¨ LINE ç™»å…¥ï¼<br>
                  é¦–æ¬¡ç™»å…¥éœ€è¦å®Œæˆå¯¦ååˆ¶ç™»è¨˜
              </div>
              <form onsubmit="handleLineFirstRegister(event, '${lineId}', '${lineName}')">
                  <div class="form-group">
                      <label>LINE åç¨±</label>
                      <input type="text" value="${lineName}" disabled>
                  </div>
                  <div class="form-group">
                      <label>çœŸå¯¦å§“å *</label>
                      <input type="text" id="lineRegisterName" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" required>
                  </div>
                  <div class="form-group">
                      <label>æ‰‹æ©Ÿè™Ÿç¢¼ *</label>
                      <input type="tel" id="lineRegisterPhone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼" required>
                  </div>
                  <button type="submit" class="btn btn-primary">å®Œæˆè¨»å†Š</button>
              </form>
          `;
      }
      
      async function handleLineFirstRegister(event, lineId, lineName) {
          event.preventDefault();
          showLoading(true);
          
          const name = document.getElementById('lineRegisterName').value;
          const phone = document.getElementById('lineRegisterPhone').value;
          
          try {
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'registerLineUser',
                      lineId: lineId,
                      lineName: lineName,
                      name: name,
                      phone: phone
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showMessage('è¨»å†ŠæˆåŠŸï¼æ­¡è¿åŠ å…¥å¸•é‡‘æ£®ç—…å‹å”æœƒ', 'success');
                  setTimeout(() => {
                      location.reload();
                  }, 2000);
              } else {
                  showMessage(result.message || 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
              }
          } catch (error) {
              console.error('Registration error:', error);
              showMessage('è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
          } finally {
              showLoading(false);
          }
      }
      
      // ==================== æ‰‹å‹•ç™»å…¥ ====================
      async function handleLogin(event) {
          event.preventDefault();
          showLoading(true);
          
          const phone = document.getElementById('loginPhone').value;
          const password = document.getElementById('loginPassword').value;
          
          try {
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'manualLogin',
                      phone: phone,
                      password: password
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showMessage('ç™»å…¥æˆåŠŸï¼æ­¡è¿ ' + result.name, 'success');
                  setTimeout(() => {
                      alert('ç™»å…¥æˆåŠŸï¼æœƒå“¡è³‡æ–™ï¼š\nå§“åï¼š' + result.name + '\né›»è©±ï¼š' + phone);
                  }, 1000);
              } else {
                  showMessage(result.message || 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥é›»è©±å’Œå¯†ç¢¼', 'error');
              }
          } catch (error) {
              console.error('Login error:', error);
              showMessage('ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
          } finally {
              showLoading(false);
          }
      }
      
      // ==================== æ‰‹å‹•è¨»å†Š ====================
      // åœ¨ handleRegister å‡½æ•¸ä¸­åŠ å…¥æ‰‹æ©Ÿè™Ÿç¢¼é©—è­‰
async function handleRegister(event) {
    event.preventDefault();
    showLoading(true);
    
    const name = document.getElementById('registerName').value;
    const phone = document.getElementById('registerPhone').value;
    const password = document.getElementById('registerPassword').value;
    const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
    
    // âœ… æ–°å¢ï¼šæ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼é©—è­‰
    const phoneRegex = /^09\d{8}$/;
    if (!phoneRegex.test(phone)) {
        showMessage('è«‹è¼¸å…¥æ­£ç¢ºçš„å°ç£æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼ï¼ˆ09é–‹é ­ï¼Œå…±10ç¢¼ï¼‰', 'error');
        showLoading(false);
        return;
    }
    
    if (password !== passwordConfirm) {
        showMessage('å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´', 'error');
        showLoading(false);
        return;
    }
    
    try {
        const response = await fetch(GAS_URL, {
            method: 'POST',
            mode: 'no-cors', // âœ… åŠ å…¥ mode
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'manualRegister',
                name: name,
                phone: phone,
                password: password
            })
        });
        
        // âœ… æ”¹å–„éŒ¯èª¤è™•ç†
        if (response.type === 'opaque') {
            // no-cors æ¨¡å¼ä¸‹ç„¡æ³•è®€å–å›æ‡‰ï¼Œå‡è¨­æˆåŠŸ
            showMessage('è¨»å†ŠæˆåŠŸï¼è«‹ä½¿ç”¨é›»è©±è™Ÿç¢¼ç™»å…¥', 'success');
            setTimeout(() => {
                switchTab('login');
                document.getElementById('loginPhone').value = phone;
            }, 2000);
        } else {
            const result = await response.json();
            
            if (result.success) {
                showMessage('è¨»å†ŠæˆåŠŸï¼è«‹ä½¿ç”¨é›»è©±è™Ÿç¢¼ç™»å…¥', 'success');
                setTimeout(() => {
                    switchTab('login');
                    document.getElementById('loginPhone').value = phone;
                }, 2000);
            } else {
                showMessage(result.message || 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }
    } catch (error) {
        console.error('Registration error:', error);
        showMessage('è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
    } finally {
        showLoading(false);
    }
}
      
      // ==================== UI æ§åˆ¶å‡½æ•¸ ====================
      function switchTab(tab) {
          const loginTab = document.getElementById('loginTab');
          const registerTab = document.getElementById('registerTab');
          const tabButtons = document.querySelectorAll('.tab-btn');
          
          if (tab === 'login') {
              loginTab.classList.add('active');
              registerTab.classList.remove('active');
              tabButtons[0].classList.add('active');
              tabButtons[1].classList.remove('active');
          } else {
              loginTab.classList.remove('active');
              registerTab.classList.add('active');
              tabButtons[0].classList.remove('active');
              tabButtons[1].classList.add('active');
          }
      }
      
      function showLoading(show) {
          const loading = document.getElementById('loading');
          const mainContent = document.getElementById('mainContent');
          
          if (show) {
              loading.classList.add('active');
              mainContent.style.display = 'none';
          } else {
              loading.classList.remove('active');
              mainContent.style.display = 'block';
          }
      }
      
      function showMessage(text, type) {
          const message = document.getElementById('message');
          message.textContent = text;
          message.className = 'message ' + type + ' active';
          
          setTimeout(() => {
              message.classList.remove('active');
          }, 5000);
      }
  </script>
</body>
</html>
