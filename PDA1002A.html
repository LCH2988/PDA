<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>帕金森病友會管理系統</title>

  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    :root {
      --primary: #06c755;
      --primary-dark: #05b04b;
      --secondary: #00b900;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --border-radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding-bottom: 80px; }
    .app-container { max-width: 480px; margin: 0 auto; background: white; min-height: 100vh; box-shadow: 0 0 30px rgba(0,0,0,0.1); }

    .top-bar { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .top-bar h1 { font-size: 18px; font-weight: 600; margin: 0; }
    .user-info { display: flex; align-items: center; gap: 10px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid white; }
    .user-name { font-size: 14px; font-weight: 500; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-around; padding: 8px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; max-width: 480px; margin: 0 auto; }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px; color: #666; text-decoration: none; transition: all 0.3s; cursor: pointer; border: none; background: none; }
    .nav-item i { font-size: 22px; }
    .nav-item span { font-size: 11px; }
    .nav-item.active { color: var(--primary); }
    .nav-item:hover { color: var(--primary); background: rgba(6, 199, 85, 0.05); }

    .page-content { display: none; padding: 20px; animation: fadeIn 0.3s; }
    .page-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .card { border: none; border-radius: var(--border-radius); box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; overflow: hidden; }
    .card-header { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; font-weight: 600; padding: 15px 20px; border: none; }
    .card-body { padding: 20px; }

    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: white; border-radius: var(--border-radius); padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .stat-icon { font-size: 32px; margin-bottom: 10px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .stat-value { font-size: 28px; font-weight: 700; color: var(--dark); margin: 5px 0; }
    .stat-label { font-size: 13px; color: #666; }

    .activity-item { background: white; border-radius: var(--border-radius); padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; }
    .activity-item:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .activity-title { font-size: 16px; font-weight: 600; color: var(--dark); margin-bottom: 8px; }
    .activity-info { font-size: 14px; color: #666; margin-bottom: 10px; }
    .activity-meta { display: flex; flex-wrap: wrap; gap: 10px; font-size: 13px; color: #888; }
    .activity-meta span { display: flex; align-items: center; gap: 4px; }
    .activity-meta i { font-size: 14px; }

    .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
    .status-開放報名, .status-已報名, .status-已完成 { background: #d4edda; color: #155724; }
    .status-已額滿, .status-已取消 { background: #f8d7da; color: #721c24; }
    .status-已結束 { background: #e2e3e5; color: #383d41; }
    .status-審核中, .status-待付款 { background: #fff3cd; color: #856404; }
    .status-已核准, .status-已捐款 { background: #d4edda; color: #155724; }
    .status-已拒絕 { background: #f8d7da; color: #721c24; }

    .btn-gradient { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 10px rgba(6, 199, 85, 0.3); }
    .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(6, 199, 85, 0.4); color: white; }
    .btn-gradient:active { transform: translateY(0); }

    .form-floating > label { color: #666; }
    .form-control:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 0.2rem rgba(6, 199, 85, 0.25); }

    .empty-state { text-align: center; padding: 40px 20px; color: #999; }
    .empty-state i { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
    .empty-state p { font-size: 14px; margin: 0; }

    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    .loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }

    .admin-only { display: none; }

    .table-responsive { border-radius: var(--border-radius); overflow: hidden; }
    .table { margin-bottom: 0; }
    .table thead { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; }
    .table tbody tr:hover { background: rgba(6, 199, 85, 0.05); }

    @media (max-width: 480px) {
      .stats-grid { grid-template-columns: 1fr; }
      .activity-meta { flex-direction: column; gap: 5px; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="top-bar">
      <h1><i class="bi bi-heart-pulse me-2"></i>帕金森病友會</h1>
      <div class="user-info">
        <img id="userAvatar" class="user-avatar" src="https://placehold.co/36x36" alt="頭像" />
        <span id="userName" class="user-name">載入中...</span>
      </div>
    </div>

    <div id="page-home" class="page-content active">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon"><i class="bi bi-calendar-event"></i></div><div class="stat-value" id="statActivities">0</div><div class="stat-label">活動總數</div></div>
        <div class="stat-card"><div class="stat-icon"><i class="bi bi-check-circle"></i></div><div class="stat-value" id="statRegistrations">0</div><div class="stat-label">我的報名</div></div>
        <div class="stat-card"><div class="stat-icon"><i class="bi bi-clock-history"></i></div><div class="stat-value" id="statVolunteerHours">0</div><div class="stat-label">志工時數</div></div>
        <div class="stat-card"><div class="stat-icon"><i class="bi bi-heart"></i></div><div class="stat-value" id="statDonations">0</div><div class="stat-label">捐款金額</div></div>
      </div>
      <div class="card">
        <div class="card-header"><i class="bi bi-calendar-event me-2"></i>最新活動</div>
        <div class="card-body"><div id="recentActivities"><div class="empty-state"><i class="bi bi-calendar-x"></i><p>載入中...</p></div></div></div>
      </div>
    </div>

    <div id="page-activities" class="page-content">
      <div class="card">
        <div class="card-header"><i class="bi bi-calendar-plus me-2"></i>開放報名</div>
        <div class="card-body"><div id="activitiesList"><div class="empty-state"><i class="bi bi-calendar-x"></i><p>載入中...</p></div></div></div>
      </div>
      <div class="card">
        <div class="card-header"><i class="bi bi-list-check me-2"></i>我的報名</div>
        <div class="card-body"><div id="myRegistrationsList"><div class="empty-state"><i class="bi bi-calendar-x"></i><p>載入中...</p></div></div></div>
      </div>
    </div>

    <div id="page-volunteer" class="page-content">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon"><i class="bi bi-clock-history"></i></div><div class="stat-value" id="volTotalHours">0</div><div class="stat-label">累計時數</div></div>
        <div class="stat-card"><div class="stat-icon"><i class="bi bi-calendar-check"></i></div><div class="stat-value" id="volTotalActivities">0</div><div class="stat-label">服務次數</div></div>
      </div>
      <div class="card">
        <div class="card-header"><i class="bi bi-people me-2"></i>志工需求</div>
        <div class="card-body"><div id="volunteerNeedsList"><div class="empty-state"><i class="bi bi-people"></i><p>載入中...</p></div></div></div>
      </div>
      <div class="card">
        <div class="card-header"><i class="bi bi-journal-text me-2"></i>我的記錄</div>
        <div class="card-body"><div id="myVolunteerRecords"><div class="empty-state"><i class="bi bi-journal-x"></i><p>載入中...</p></div></div></div>
      </div>
    </div>

    <div id="page-finance" class="page-content">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon"><i class="bi bi-heart"></i></div><div class="stat-value" id="finTotalDonation">0</div><div class="stat-label">累計捐款</div></div>
        <div class="stat-card"><div class="stat-icon"><i class="bi bi-receipt"></i></div><div class="stat-value" id="finPendingExpenses">0</div><div class="stat-label">待審核支出</div></div>
      </div>
      <div class="d-grid gap-2 mb-3">
        <button class="btn btn-gradient" onclick="showDonationModal()"><i class="bi bi-heart-fill me-2"></i>我要捐款</button>
        <button class="btn btn-outline-primary" onclick="showNewExpenseModal()"><i class="bi bi-receipt me-2"></i>支出申請</button>
      </div>
      <div class="card">
        <div class="card-header"><i class="bi bi-heart me-2"></i>我的捐款</div>
        <div class="card-body"><div id="myDonationsList"><div class="empty-state"><i class="bi bi-heart"></i><p>載入中...</p></div></div></div>
      </div>
      <div class="card">
        <div class="card-header"><i class="bi bi-receipt me-2"></i>我的支出</div>
        <div class="card-body"><div id="myExpensesList"><div class="empty-state"><i class="bi bi-receipt"></i><p>載入中...</p></div></div></div>
      </div>
    </div>

    <div id="page-profile" class="page-content">
      <div class="card">
        <div class="card-header"><i class="bi bi-person me-2"></i>個人資料</div>
        <div class="card-body">
          <form id="profileForm">
            <div class="form-floating mb-3"><input type="text" class="form-control" name="realName" required /><label>真實姓名 *</label></div>
            <div class="form-floating mb-3">
              <select class="form-select" name="memberType" required>
                <option value="">請選擇</option>
                <option value="病友">病友</option>
                <option value="家屬">家屬</option>
                <option value="志工">志工</option>
              </select>
              <label>會員類型 *</label>
            </div>
            <div class="form-floating mb-3"><input type="tel" class="form-control" name="phone" /><label>聯絡電話</label></div>
            <div class="form-floating mb-3"><input type="email" class="form-control" name="email" /><label>電子郵件</label></div>
            <div class="form-floating mb-3"><input type="date" class="form-control" name="birthday" /><label>生日</label></div>
            <div class="form-floating mb-3"><input type="date" class="form-control" name="diagnosisDate" /><label>確診日期</label></div>
            <div class="form-floating mb-3"><textarea class="form-control" name="address" style="height:80px;"></textarea><label>地址</label></div>
            <div class="d-grid"><button type="submit" class="btn btn-gradient"><i class="bi bi-save me-2"></i>儲存變更</button></div>
          </form>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><i class="bi bi-file-earmark-text me-2"></i>我的收據</div>
        <div class="card-body"><div id="myReceiptsList"><div class="empty-state"><i class="bi bi-file-earmark-text"></i><p>載入中...</p></div></div></div>
      </div>
      <div class="card">
        <div class="card-header"><i class="bi bi-info-circle me-2"></i>會員資訊</div>
        <div class="card-body">
          <p><strong>會員類型：</strong><span id="userMemberType">-</span></p>
          <p><strong>LINE ID：</strong><span id="userLineId">-</span></p>
          <p class="mb-0"><strong>版本：</strong>v2.0.2</p>
        </div>
      </div>
    </div>

    <div id="page-admin" class="page-content admin-only">
      <div class="card">
        <div class="card-header"><i class="bi bi-gear me-2"></i>管理功能</div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button class="btn btn-outline-primary" onclick="showNewActivityModal()"><i class="bi bi-calendar-plus me-2"></i>新增活動</button>
            <button class="btn btn-outline-success" onclick="showNewVolunteerNeedModal()"><i class="bi bi-people me-2"></i>新增志工需求</button>
            <button class="btn btn-outline-secondary" onclick="showManualReceiptModal()"><i class="bi bi-file-earmark-plus me-2"></i>手動開立收據</button>
            <button class="btn btn-outline-primary" onclick="showSettingsModal()"><i class="bi bi-sliders me-2"></i>系統設定</button>
          </div>
        </div>
      </div>
      <div class="card mt-3">
        <div class="card-header"><i class="bi bi-graph-up-arrow me-2"></i>總覽</div>
        <div class="card-body"><div id="adminOverview"><div class="empty-state"><i class="bi bi-speedometer"></i><p>載入中...</p></div></div></div>
      </div>
      <div class="card mt-3">
        <div class="card-header"><i class="bi bi-receipt-cutoff me-2"></i>收據列表</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm">
              <thead><tr><th>日期</th><th>收據號</th><th>LINE ID</th><th>類型</th><th>金額</th><th>狀態</th><th>連結</th></tr></thead>
              <tbody id="adminReceiptsTableBody"><tr><td colspan="7" class="text-center text-muted">載入中...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div> <!-- /#page-admin -->
  </div> <!-- /.app-container -->

  <nav class="bottom-nav mx-auto">
    <button class="nav-item active" data-target="home"><i class="bi bi-house"></i><span>首頁</span></button>
    <button class="nav-item" data-target="activities"><i class="bi bi-calendar-event"></i><span>活動</span></button>
    <button class="nav-item" data-target="volunteer"><i class="bi bi-people"></i><span>志工</span></button>
    <button class="nav-item" data-target="finance"><i class="bi bi-cash-coin"></i><span>財務</span></button>
    <button class="nav-item" data-target="profile"><i class="bi bi-person"></i><span>個人</span></button>
    <button class="nav-item admin-only" data-target="admin"><i class="bi bi-gear"></i><span>管理</span></button>
  </nav>

  <div id="loading" class="loading-overlay" style="display:none;"><div class="loading-spinner"></div></div>
  <div class="toast-container" id="toastContainer"></div>

  <!-- 必要 Modal 容器由 JS 直接操作（各 modal 已內置於本檔） -->
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const APPCONFIG = {
      apiUrl: 'https://script.google.com/macros/s/AKfycbyd5oa7dQ4XSswjSyDEdecvWJGOElSWBUs1OG47-vTurQ969iwiI0ZmFI4LGpqOOqjv/exec', // 置換為你的 GAS Web App URL
      apiKey: 'AAbb8520258185202581',        // 與後端 CONFIG.API_KEY 一致
      liffId: '1656516134-VaGgmaPm'                 // 置換為你的 LIFF ID
    };

    let state = {
      profile: null,
      lineId: '',
      isAdmin: false,
      settings: { incomeCategories: [], expenseCategories: [] }
    };

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    function showLoading(show=true){ const el=$('#loading'); if(!el) return; el.style.display = show ? 'flex' : 'none'; }

    function toast(msg, type='info', delay=2500){
      const id = 't' + Date.now();
      const bg = type==='success'?'bg-success':type==='error'?'bg-danger':type==='warning'?'bg-warning text-dark':'bg-dark';
      const el = document.createElement('div');
      el.className = 'toast align-items-center text-white ' + bg;
      el.setAttribute('role','alert'); el.setAttribute('aria-live','assertive'); el.setAttribute('aria-atomic','true'); el.id = id;
      el.innerHTML = '<div class="d-flex"><div class="toast-body">'+msg+'</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>';
      $('#toastContainer').appendChild(el);
      const t = new bootstrap.Toast(el,{ delay }); t.show();
      el.addEventListener('hidden.bs.toast',()=> el.remove());
    }

    async function api(action, payload={}){
      const body = { ...payload, action, apiKey: APPCONFIG.apiKey, lineId: state.lineId || payload.lineId || '' };
      showLoading(true);
      try{
        const res = await fetch(APPCONFIG.apiUrl, { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        const data = await res.json();
        if(!data.success) throw new Error(data.message || 'API 錯誤');
        return data;
      }catch(e){
        console.error(e);
        toast(e.message || '連線失敗','error',3500);
        throw e;
      }finally{
        showLoading(false);
      }
    }

    function switchPage(target){
      $$('.page-content').forEach(p=>p.classList.remove('active'));
      $(`#page-${target}`).classList.add('active');
      $$('.bottom-nav .nav-item').forEach(n=>n.classList.remove('active'));
      $(`.bottom-nav .nav-item[data-target="${target}"]`).classList.add('active');

      if(target==='activities'){ loadActivities(); loadMyRegistrations(); }
      if(target==='volunteer'){ loadVolunteerData(); }
      if(target==='finance'){ loadFinance(); }
      if(target==='profile'){ loadReceipts(); }
      if(target==='admin'){ loadAdminOverview(); loadAdminReceipts(); }
    }

    function bindNav(){ $$('.bottom-nav .nav-item').forEach(btn=> btn.addEventListener('click', ()=> switchPage(btn.dataset.target))); }

    function fmtDate(d){
      try{ if(!d) return '-'; const dt = new Date(d); if(isNaN(dt.getTime())) return '-'; const y=dt.getFullYear(); const m=String(dt.getMonth()+1).padStart(2,'0'); const day=String(dt.getDate()).padStart(2,'0'); return y+'/'+m+'/'+day; }catch{ return '-'; }
    }
    function statusBadge(s){ return '<span class="status-badge status-'+(s||'')+'">'+(s||'-')+'</span>'; }

    async function initLIFF(){
      await liff.init({ liffId: APPCONFIG.liffId });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      const profile = await liff.getProfile();
      state.profile = profile;
      state.lineId = profile.userId;
      $('#userAvatar').src = profile.pictureUrl || 'https://placehold.co/36x36';
      $('#userName').textContent = profile.displayName || '用戶';
      $('#userLineId').textContent = state.lineId;

      // 確保已註冊
      await ensureRegistered();

      // 顯示 admin UI
      $$('.admin-only').forEach(el=> el.style.display = state.isAdmin ? '' : 'none');

      await Promise.all([loadDashboard(), loadSettings()]);
    }

    async function ensureRegistered(){
      try{
        const info = await api('getUserInfo',{ lineId: state.lineId });
        const u = info.data || {};
        state.isAdmin = !!u.isAdmin;
        $('#userMemberType').textContent = u.memberType || '-';
        const f = $('#profileForm');
        f.realName.value = u.realName || state.profile.displayName || '';
        f.memberType.value = u.memberType || '';
        f.phone.value = u.phone || '';
        f.email.value = u.email || '';
        if(u.birthday){ const d = new Date(u.birthday); if(!isNaN(d)) f.birthday.value = d.toISOString().slice(0,10); }
        if(u.diagnosisDate){ const d = new Date(u.diagnosisDate); if(!isNaN(d)) f.diagnosisDate.value = d.toISOString().slice(0,10); }
        f.address.value = u.address || '';
      }catch(e){
        if((e.message||'').includes('用戶未註冊')){
          await api('registerUser',{ lineId: state.lineId, lineName: state.profile.displayName, realName: state.profile.displayName, memberType: '病友' });
          toast('已完成首次註冊','success');
          state.isAdmin=false;
        }else{
          throw e;
        }
      }
    }

    async function loadDashboard(){
      const { data } = await api('getDashboardData',{ lineId: state.lineId });
      $('#statActivities').textContent = data.totalActivities || 0;
      $('#statRegistrations').textContent = data.myRegistrations || 0;
      $('#statVolunteerHours').textContent = data.myVolunteerHours || 0;
      $('#statDonations').textContent = (data.myDonationAmount || 0).toLocaleString();

      const wrap = $('#recentActivities');
      if(!data.recentActivity || !data.recentActivity.length){
        wrap.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>目前沒有活動</p></div>';
        return;
      }
      wrap.innerHTML = data.recentActivity.map(a=>`
        <div class="activity-item">
          <div class="activity-title">${a.title || '-'}</div>
          <div class="activity-info">${a.description || ''}</div>
          <div class="activity-meta">
            <span><i class="bi bi-calendar"></i>${fmtDate(a.date)}</span>
            <span>${statusBadge(a.status || '')}</span>
          </div>
        </div>
      `).join('');
    }

    async function loadSettings(){
      const { data } = await api('getSettings',{ lineId: state.lineId });
      state.settings.incomeCategories = data.incomeCategories || [];
      state.settings.expenseCategories = data.expenseCategories || [];
      if(state.isAdmin){
        state.settings.receiptTemplateDocId = data.receiptTemplateDocId || '';
        state.settings.emailReplyTemplate = data.emailReplyTemplate || '';
        state.settings.expenseVoucherTemplateDocId = data.expenseVoucherTemplateDocId || '';
        $('#receiptTemplateDocId')?.value = state.settings.receiptTemplateDocId || '';
        $('#expenseVoucherTemplateDocId')?.value = state.settings.expenseVoucherTemplateDocId || '';
        $('#emailReplyTemplate')?.value = state.settings.emailReplyTemplate || '';
        $('#incomeCategories')?.value = (state.settings.incomeCategories || []).join('\n');
        $('#expenseCategories')?.value = (state.settings.expenseCategories || []).join('\n');
      }
      const dc = $('#donationCategory'); const ec = $('#expenseCategory');
      if(dc){ dc.innerHTML = '<option value="">請選擇</option>' + (state.settings.incomeCategories||[]).map(c=>`<option value="${c}">${c}</option>`).join(''); }
      if(ec){ ec.innerHTML = '<option value="">請選擇</option>' + (state.settings.expenseCategories||[]).map(c=>`<option value="${c}">${c}</option>`).join(''); }
    }

    async function loadActivities(){
      const { data:list } = await api('getActivities',{});
      const wrap = $('#activitiesList');
      const open = (list||[]).filter(a=> a.status!=='已刪除' && a.status!=='已結束');
      if(!open.length){
        wrap.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>目前沒有開放報名的活動</p></div>';
        return;
      }
      wrap.innerHTML = open.map(a=>{
        const btn = a.status==='開放報名' ? '<button class="btn btn-sm btn-gradient" onclick=\'registerActivity(\"'+a.id+'\")\'><i class="bi bi-plus-circle me-1"></i>報名</button>' : '';
        return `
          <div class="activity-item">
            <div class="activity-title">${a.title||'-'}</div>
            <div class="activity-info">${a.description||''}</div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${fmtDate(a.date)}</span>
              <span><i class="bi bi-geo"></i>${a.location||'-'}</span>
              <span><i class="bi bi-people"></i>${a.currentCount||0}/${a.maxParticipants||0}</span>
              <span>${statusBadge(a.status||'')}</span>
            </div>
            <div class="mt-2">${btn}</div>
          </div>`;
      }).join('');
    }

    async function registerActivity(activityId){
      await api('registerActivity',{ lineId: state.lineId, activityId });
      toast('報名成功','success');
      await Promise.all([loadActivities(), loadMyRegistrations(), loadDashboard()]);
    }

    async function loadMyRegistrations(){
      const { data:list } = await api('getMyRegistrations',{ lineId: state.lineId });
      const wrap = $('#myRegistrationsList');
      if(!list || !list.length){
        wrap.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>尚無報名資料</p></div>';
        return;
      }
      wrap.innerHTML = list.map(r=>{
        const cancelBtn = (r.status==='已報名') ? '<button class="btn btn-sm btn-outline-danger" onclick=\'cancelRegistration(\"'+r.id+'\")\'><i class="bi bi-x-circle me-1"></i>取消</button>' : '';
        return `
          <div class="activity-item">
            <div class="activity-title">${r.activityTitle||'-'}</div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${fmtDate(r.registrationTime)}</span>
              <span>${statusBadge(r.status||'')}</span>
              <span>${statusBadge(r.paymentStatus||'')}</span>
            </div>
            <div class="mt-2">${cancelBtn}</div>
          </div>`;
      }).join('');
    }

    async function cancelRegistration(registrationId){
      await api('cancelRegistration',{ lineId: state.lineId, registrationId });
      toast('已取消','success');
      await Promise.all([loadActivities(), loadMyRegistrations(), loadDashboard()]);
    }

    async function loadVolunteerData(){
      const { data } = await api('getVolunteerData',{ lineId: state.lineId });
      $('#volTotalHours').textContent = data.stats?.totalHours || 0;
      $('#volTotalActivities').textContent = data.stats?.totalActivities || 0;

      const needsWrap = $('#volunteerNeedsList');
      if(!data.needs || !data.needs.length){
        needsWrap.innerHTML = '<div class="empty-state"><i class="bi bi-people"></i><p>目前沒有志工需求</p></div>';
      }else{
        needsWrap.innerHTML = data.needs.map(n=>{
          const canApply = n.status==='開放報名';
          return `
            <div class="activity-item">
              <div class="activity-title">${n.title||'-'}</div>
              <div class="activity-info">${n.description||''}</div>
              <div class="activity-meta">
                <span><i class="bi bi-calendar"></i>${fmtDate(n.date)}</span>
                <span><i class="bi bi-clock"></i>${n.time||'-'}</span>
                <span><i class="bi bi-people"></i>${n.currentCount||0}/${n.needCount||0}</span>
                <span>${statusBadge(n.status||'')}</span>
                <span><i class="bi bi-hourglass-split"></i>${n.hours||0} 小時</span>
              </div>
              <div class="mt-2">
                ${canApply? '<button class="btn btn-sm btn-gradient" onclick=\'applyVolunteer(\"'+n.id+'\")\'><i class="bi bi-plus-circle me-1"></i>報名</button>':''}
              </div>
            </div>`;
        }).join('');
      }

      const recWrap = $('#myVolunteerRecords');
      if(!data.records || !data.records.length){
        recWrap.innerHTML = '<div class="empty-state"><i class="bi bi-journal-x"></i><p>尚無志工紀錄</p></div>';
      }else{
        recWrap.innerHTML = data.records.map(r=>`
          <div class="activity-item">
            <div class="activity-title">${r.title||'-'}</div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${fmtDate(r.date)}</span>
              <span><i class="bi bi-hourglass-split"></i>${r.hours||0} 小時</span>
              <span>${statusBadge(r.status||'')}</span>
            </div>
            ${r.feedback? '<div class="mt-2 text-muted small">回饋：'+r.feedback+'</div>':''}
          </div>
        `).join('');
      }
    }

    async function applyVolunteer(needId){
      await api('applyVolunteer',{ lineId: state.lineId, needId });
      toast('志工報名成功','success');
      await loadVolunteerData();
    }

    function showDonationModal(){ new bootstrap.Modal($('#donationModal')).show(); }
    function showNewExpenseModal(){ new bootstrap.Modal($('#newExpenseModal')).show(); }
    function showNewActivityModal(){ new bootstrap.Modal($('#newActivityModal')).show(); }
    function showNewVolunteerNeedModal(){ new bootstrap.Modal($('#newVolunteerNeedModal')).show(); }
    function showManualReceiptModal(){ new bootstrap.Modal($('#manualReceiptModal')).show(); }
    function showSettingsModal(){ new bootstrap.Modal($('#settingsModal')).show(); }

    $('#donationForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = { lineId: state.lineId, category: fd.get('category'), amount: Number(fd.get('amount')), description: fd.get('description') || '', needReceipt: !!fd.get('needReceipt') };
      await api('createDonation', payload);
      toast('捐款已建立','success');
      bootstrap.Modal.getInstance($('#donationModal')).hide();
      await Promise.all([loadFinance(), loadDashboard(), loadReceipts()]);
    });

    $('#newExpenseForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = { lineId: state.lineId, category: fd.get('category'), amount: Number(fd.get('amount')), description: fd.get('description') || '' };
      await api('createExpense', payload);
      toast('支出申請已送出','success');
      bootstrap.Modal.getInstance($('#newExpenseModal')).hide();
      await loadFinance();
    });

    async function loadFinance(){
      const [{ data: donationsData }, { data: expensesData }] = await Promise.all([
        api('getFinanceData',{ lineId: state.lineId }).then(r=>({ data:r.data.donations||[] })),
        api('getFinanceData',{ lineId: state.lineId }).then(r=>({ data:r.data.expenses||[] }))
      ]);
      const donations = donationsData || [];
      const expenses = expensesData || [];

      const totalDonation = donations.reduce((s,r)=> s + (Number(r.amount)||0), 0);
      const pendingExpenses = expenses.filter(r=> r.status==='審核中').length;
      $('#finTotalDonation').textContent = totalDonation.toLocaleString();
      $('#finPendingExpenses').textContent = pendingExpenses;

      const dWrap = $('#myDonationsList');
      if(!donations.length){
        dWrap.innerHTML = '<div class="empty-state"><i class="bi bi-heart"></i><p>尚無捐款紀錄</p></div>';
      }else{
        dWrap.innerHTML = donations.map(r=>`
          <div class="activity-item">
            <div class="activity-title">${r.category||'-'} <span class="text-success">+${Number(r.amount||0).toLocaleString()}</span></div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${fmtDate(r.createdAt)}</span>
              <span>${statusBadge(r.status||'')}</span>
              ${r.receiptNumber? '<span><i class="bi bi-receipt"></i>#'+r.receiptNumber+'</span>':''}
            </div>
            ${r.description? '<div class="mt-2 text-muted small">'+r.description+'</div>':''}
          </div>`).join('');
      }

      const eWrap = $('#myExpensesList');
      if(!expenses.length){
        eWrap.innerHTML = '<div class="empty-state"><i class="bi bi-receipt"></i><p>尚無支出紀錄</p></div>';
      }else{
        eWrap.innerHTML = expenses.map(r=>`
          <div class="activity-item">
            <div class="activity-title">${r.category||'-'} <span class="text-danger">-${Number(r.amount||0).toLocaleString()}</span></div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${fmtDate(r.createdAt)}</span>
              <span>${statusBadge(r.status||'')}</span>
              ${r.paymentMethod? '<span><i class="bi bi-credit-card"></i>'+r.paymentMethod+'</span>':''}
            </div>
            ${r.description? '<div class="mt-2 text-muted small">'+r.description+'</div>':''}
          </div>`).join('');
      }
    }

    $('#profileForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = {
        lineId: state.lineId,
        realName: fd.get('realName'),
        memberType: fd.get('memberType'),
        phone: fd.get('phone'),
        email: fd.get('email'),
        birthday: fd.get('birthday') || '',
        diagnosisDate: fd.get('diagnosisDate') || '',
        address: fd.get('address') || ''
      };
      await api('updateProfile', payload);
      toast('個人資料已更新','success');
      await loadDashboard();
    });

    async function loadReceipts(){
      const { data:list } = await api('getMyReceipts',{ lineId: state.lineId });
      const wrap = $('#myReceiptsList');
      if(!list || !list.length){
        wrap.innerHTML = '<div class="empty-state"><i class="bi bi-file-earmark-text"></i><p>尚無收據</p></div>';
        return;
      }
      wrap.innerHTML = list.map(r=>`
        <div class="activity-item">
          <div class="activity-title">收據 #${r.receiptNumber||'-'} - ${Number(r.amount||0).toLocaleString()}</div>
          <div class="activity-meta">
            <span><i class="bi bi-calendar"></i>${fmtDate(r.issueDate)}</span>
            <span>${statusBadge(r.status||'')}</span>
            ${r.pdfUrl? '<a class="text-decoration-none" target="_blank" href="'+r.pdfUrl+'"><i class="bi bi-box-arrow-up-right"></i> 檢視</a>':''}
          </div>
        </div>`).join('');
    }

    async function loadAdminOverview(){
      // 以現有 API 彙整概覽（我的視角）
      const { data:fin } = await api('getFinanceData',{ lineId: state.lineId });
      const txIncome = (fin.donations||[]).reduce((s,r)=> s + (Number(r.amount)||0), 0);
      const txExpense = (fin.expenses||[]).reduce((s,r)=> s + (Number(r.amount)||0), 0);
      const balance = txIncome - txExpense;
      const receiptsCount = (await api('getMyReceipts',{ lineId: state.lineId })).data?.length || 0;

      const ov = $('#adminOverview');
      ov.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon"><i class="bi bi-wallet2"></i></div><div class="stat-value">${txIncome.toLocaleString()}</div><div class="stat-label">總收入（我的）</div></div>
          <div class="stat-card"><div class="stat-icon"><i class="bi bi-cart-dash"></i></div><div class="stat-value">${txExpense.toLocaleString()}</div><div class="stat-label">總支出（我的）</div></div>
          <div class="stat-card"><div class="stat-icon"><i class="bi bi-piggy-bank"></i></div><div class="stat-value">${balance.toLocaleString()}</div><div class="stat-label">當前餘額（我的）</div></div>
          <div class="stat-card"><div class="stat-icon"><i class="bi bi-receipt"></i></div><div class="stat-value">${receiptsCount}</div><div class="stat-label">收據數量</div></div>
        </div>
        <div class="mt-2 text-muted small">提示：若需全體資料總覽，請於後端新增 getAdminData 或各別的全域查詢 API。</div>
      `;
    }

    async function loadAdminReceipts(){
      const { data:list } = await api('getMyReceipts',{ lineId: state.lineId });
      const tb = $('#adminReceiptsTableBody');
      if(!list || !list.length){
        tb.innerHTML = '<tr><td colspan="7" class="text-center text-muted">尚無資料</td></tr>';
        return;
      }
      tb.innerHTML = list.map(r=>`
        <tr>
          <td>${fmtDate(r.issueDate)}</td>
          <td>${r.receiptNumber||'-'}</td>
          <td class="text-truncate" style="max-width:140px;">${r.lineId||'-'}</td>
          <td>${r.type||'-'}</td>
          <td>${Number(r.amount||0).toLocaleString()}</td>
          <td>${r.status||'-'}</td>
          <td>${r.pdfUrl? '<a href="'+r.pdfUrl+'" target="_blank">檢視</a>':'-'}</td>
        </tr>`).join('');
    }

    // 綁定底部導航
    document.addEventListener('DOMContentLoaded', async ()=>{
      bindNav();
      try{
        await initLIFF();
      }catch(e){
        console.error(e);
        toast('LIFF 初始化失敗: '+(e.message||''),'error',4000);
      }
    });
  </script>

  <!-- Modals -->
  <div class="modal fade" id="newActivityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="newActivityForm">
        <div class="modal-header"><h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>新增活動</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button></div>
        <div class="modal-body">
          <div class="form-floating mb-2"><input class="form-control" name="title" required><label>標題 *</label></div>
          <div class="form-floating mb-2"><textarea class="form-control" name="description" style="height:80px;"></textarea><label>描述</label></div>
          <div class="row g-2">
            <div class="col-6"><div class="form-floating mb-2"><input type="date" class="form-control" name="date" required><label>日期 *</label></div></div>
            <div class="col-6"><div class="form-floating mb-2"><input type="time" class="form-control" name="time"><label>時間</label></div></div>
          </div>
          <div class="form-floating mb-2"><input class="form-control" name="location"><label>地點</label></div>
          <div class="row g-2">
            <div class="col-6"><div class="form-floating mb-2"><input type="number" min="
