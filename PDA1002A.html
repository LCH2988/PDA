<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友會</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4a90e2;
      --secondary-color: #50c878;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --light-bg: #f8f9fa;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding-bottom: 80px;
    }
    
    .main-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px 15px;
    }
    
    .header-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .user-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      transition: transform 0.2s;
    }
    
    .stat-card:active {
      transform: scale(0.98);
    }
    
    .stat-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .stat-label {
      font-size: 14px;
      color: #6c757d;
    }
    
    .nav-tabs {
      background: white;
      border-radius: 15px;
      padding: 10px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      border: none;
    }
    
    .nav-tabs .nav-link {
      border: none;
      color: #6c757d;
      border-radius: 10px;
      padding: 10px 15px;
      transition: all 0.3s;
    }
    
    .nav-tabs .nav-link.active {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
    }
    
    .content-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .activity-card {
      border-left: 4px solid var(--primary-color);
      padding: 15px;
      margin-bottom: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      transition: all 0.3s;
    }
    
    .activity-card:hover {
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transform: translateX(5px);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-weight: 500;
    }
    
    .btn-outline-primary {
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      border-radius: 10px;
      padding: 8px 16px;
    }
    
    .badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 500;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .loading-spinner {
      text-align: center;
      color: white;
    }
    
    .loading-spinner .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      min-width: 300px;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6c757d;
    }
    
    .empty-state i {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.3;
    }
    
    .form-floating > label {
      color: #6c757d;
    }
    
    .modal-content {
      border-radius: 20px;
      border: none;
    }
    
    .modal-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border-radius: 20px 20px 0 0;
    }
    
    @media (max-width: 576px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="loading-spinner">
      <div class="spinner-border" role="status"></div>
      <div class="mt-3">載入中...</div>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer"></div>

  <div class="main-container">
    <!-- Header -->
    <div class="header-card">
      <div class="user-info">
        <div class="user-avatar">
          <i class="bi bi-person-circle"></i>
        </div>
        <div class="flex-grow-1">
          <h5 class="mb-0" id="userName">載入中...</h5>
          <small class="text-muted" id="userType">會員</small>
        </div>
        <button class="btn btn-sm btn-outline-primary" onclick="showProfileModal()">
          <i class="bi bi-gear"></i>
        </button>
      </div>
    </div>

    <!-- Dashboard Stats -->
    <div class="dashboard-grid" id="dashboardStats">
      <div class="stat-card">
        <div class="stat-icon text-primary"><i class="bi bi-calendar-event"></i></div>
        <div class="stat-value" id="statActivities">0</div>
        <div class="stat-label">可報名活動</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon text-success"><i class="bi bi-check-circle"></i></div>
        <div class="stat-value" id="statRegistrations">0</div>
        <div class="stat-label">我的報名</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon text-warning"><i class="bi bi-heart"></i></div>
        <div class="stat-value" id="statVolunteer">0</div>
        <div class="stat-label">志工時數</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon text-danger"><i class="bi bi-currency-dollar"></i></div>
        <div class="stat-value" id="statDonation">0</div>
        <div class="stat-label">捐款金額</div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#activities">
          <i class="bi bi-calendar-event me-1"></i>活動
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#volunteer">
          <i class="bi bi-heart me-1"></i>志工
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#finance">
          <i class="bi bi-wallet2 me-1"></i>財務
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#feedback">
          <i class="bi bi-chat-dots me-1"></i>回饋
        </a>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Activities Tab -->
      <div class="tab-pane fade show active" id="activities">
        <div class="content-card">
          <h5 class="mb-3">可報名活動</h5>
          <div id="activitiesList"></div>
        </div>
        
        <div class="content-card">
          <h5 class="mb-3">我的報名</h5>
          <div id="myRegistrationsList"></div>
        </div>
      </div>

      <!-- Volunteer Tab -->
      <div class="tab-pane fade" id="volunteer">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">志工服務</h5>
            <span class="badge bg-success">總時數: <span id="totalVolunteerHours">0</span>h</span>
          </div>
          <div id="volunteerNeedsList"></div>
        </div>
        
        <div class="content-card">
          <h5 class="mb-3">我的志工記錄</h5>
          <div id="myVolunteerRecords"></div>
        </div>
      </div>

      <!-- Finance Tab -->
      <div class="tab-pane fade" id="finance">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">我的捐款</h5>
            <button class="btn btn-sm btn-primary" onclick="showDonationModal()">
              <i class="bi bi-plus-circle me-1"></i>新增捐款
            </button>
          </div>
          <div id="myDonationsList"></div>
        </div>
        
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">我的支出申請</h5>
            <button class="btn btn-sm btn-primary" onclick="showExpenseModal()">
              <i class="bi bi-plus-circle me-1"></i>新增支出
            </button>
          </div>
          <div id="myExpensesList"></div>
        </div>
      </div>

      <!-- Feedback Tab -->
      <div class="tab-pane fade" id="feedback">
        <div class="content-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">活動回饋</h5>
            <button class="btn btn-sm btn-primary" onclick="showFeedbackModal()">
              <i class="bi bi-plus-circle me-1"></i>新增回饋
            </button>
          </div>
          <div id="myFeedbackList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal fade" id="profileModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">個人資料</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="profileForm">
            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="profileRealName" placeholder="姓名" required>
              <label>姓名</label>
            </div>
            <div class="form-floating mb-3">
              <input type="tel" class="form-control" id="profilePhone" placeholder="電話">
              <label>電話</label>
            </div>
            <div class="form-floating mb-3">
              <input type="email" class="form-control" id="profileEmail" placeholder="Email">
              <label>Email</label>
            </div>
            <div class="form-floating mb-3">
              <input type="date" class="form-control" id="profileBirthday" placeholder="生日">
              <label>生日</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" id="profileAddress" placeholder="地址" style="height:80px"></textarea>
              <label>地址</label>
            </div>
            <div class="form-floating mb-3">
              <select class="form-select" id="profileMemberType">
                <option value="病友">病友</option>
                <option value="家屬">家屬</option>
                <option value="志工">志工</option>
              </select>
              <label>會員類型</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="updateProfile()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Donation Modal -->
  <div class="modal fade" id="donationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增捐款</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="donationForm">
            <div class="form-floating mb-3">
              <select class="form-select" id="donationCategory" required>
                <option value="">請選擇</option>
                <option value="一般捐款">一般捐款</option>
                <option value="活動贊助">活動贊助</option>
                <option value="設備捐贈">設備捐贈</option>
                <option value="其他">其他</option>
              </select>
              <label>捐款類別</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="donationAmount" placeholder="金額" required min="1">
              <label>金額</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" id="donationDescription" placeholder="說明" style="height:80px"></textarea>
              <label>說明</label>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="donationNeedReceipt">
              <label class="form-check-label" for="donationNeedReceipt">需要收據</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitDonation()">送出</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Expense Modal -->
  <div class="modal fade" id="expenseModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增支出申請</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="expenseForm">
            <div class="form-floating mb-3">
              <select class="form-select" id="expenseCategory" required>
                <option value="">請選擇</option>
                <option value="活動費用">活動費用</option>
                <option value="辦公費用">辦公費用</option>
                <option value="交通費">交通費</option>
                <option value="其他">其他</option>
              </select>
              <label>支出類別</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="expenseAmount" placeholder="金額" required min="1">
              <label>金額</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" id="expenseDescription" placeholder="說明" style="height:80px" required></textarea>
              <label>說明</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitExpense()">送出</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">活動回饋</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="feedbackForm">
            <div class="form-floating mb-3">
              <select class="form-select" id="feedbackActivity" required>
                <option value="">請選擇活動</option>
              </select>
              <label>活動</label>
            </div>
            <div class="mb-3">
              <label class="form-label">評分</label>
              <div class="d-flex gap-2 justify-content-center">
                <button type="button" class="btn btn-outline-warning rating-btn" data-rating="1">⭐</button>
                <button type="button" class="btn btn-outline-warning rating-btn" data-rating="2">⭐⭐</button>
                <button type="button" class="btn btn-outline-warning rating-btn" data-rating="3">⭐⭐⭐</button>
                <button type="button" class="btn btn-outline-warning rating-btn" data-rating="4">⭐⭐⭐⭐</button>
                <button type="button" class="btn btn-outline-warning rating-btn" data-rating="5">⭐⭐⭐⭐⭐</button>
              </div>
              <input type="hidden" id="feedbackRating" required>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" id="feedbackComment" placeholder="意見" style="height:100px"></textarea>
              <label>意見與建議</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitFeedback()">送出</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ========== 設定 ==========
    const CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',
      API_BASE_URL: 'https://script.google.com/macros/s/AKfycbz2NzZFKtMXurue4rNaxIjq7YCf1_L-Y_1bocqfZpH-qsc0Vza34YhU9dCONhwTNcrvmQ/exec',
      API_KEY: 'AAbb8520258185202581'
    };

    let userProfile = null;
    let currentUser = null;

    // ========== 工具函數 ==========
    function showLoading(show = true) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function showNotification(message, type = 'success') {
      const container = document.getElementById('notificationContainer');
      const colors = {
        success: 'bg-success',
        error: 'bg-danger',
        warning: 'bg-warning',
        info: 'bg-info'
      };
      
      const notification = document.createElement('div');
      notification.className = `notification alert ${colors[type]} text-white alert-dismissible fade show`;
      notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
      `;
      
      container.appendChild(notification);
      setTimeout(() => notification.remove(), 5000);
    }

    async function callAPI(action, data = {}) {
      try {
        const payload = {
          action,
          apiKey: CONFIG.API_KEY,
          timestamp: Date.now(),
          lineId: userProfile?.userId,
          ...data
        };

        const response = await fetch(CONFIG.API_BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.message || '操作失敗');
        }
        return result.data;
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    // ========== LIFF 初始化 ==========
    async function initLIFF() {
      try {
        showLoading(true);
        await liff.init({ liffId: CONFIG.LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        userProfile = await liff.getProfile();
        await loadUserData();
        await loadDashboard();
        
        showLoading(false);
      } catch (error) {
        console.error('LIFF Init Error:', error);
        showNotification('初始化失敗: ' + error.message, 'error');
        showLoading(false);
      }
    }

    async function loadUserData() {
      try {
        currentUser = await callAPI('getUserInfo', { lineId: userProfile.userId });
        
        if (!currentUser) {
          // 未註冊，導向註冊流程
          if (confirm('您尚未註冊，是否立即註冊？')) {
            const realName = prompt('請輸入真實姓名：');
            const memberType = prompt('請選擇會員類型（病友/家屬/志工）：');
            
            if (realName && memberType) {
              await callAPI('registerUser', {
                lineId: userProfile.userId,
                lineName: userProfile.displayName,
                realName,
                memberType
              });
              
              currentUser = await callAPI('getUserInfo', { lineId: userProfile.userId });
              showNotification('註冊成功！', 'success');
            }
          }
        }

        // 更新頁面資訊
        document.getElementById('userName').textContent = currentUser?.realName || userProfile.displayName;
        document.getElementById('userType').textContent = currentUser?.memberType || '會員';
        
      } catch (error) {
        console.error('Load User Error:', error);
        showNotification('載入使用者資料失敗', 'error');
      }
    }

    async function loadDashboard() {
      try {
        const data = await callAPI('getDashboardData', { lineId: userProfile.userId });
        
        document.getElementById('statActivities').textContent = data.totalActivities || 0;
        document.getElementById('statRegistrations').textContent = data.myRegistrations || 0;
        document.getElementById('statVolunteer').textContent = data.myVolunteerHours || 0;
        document.getElementById('statDonation').textContent = data.myDonationAmount || 0;
        
        // 載入各分頁資料
        loadActivities();
        loadMyRegistrations();
      } catch (error) {
        console.error('Load Dashboard Error:', error);
      }
    }

    // ========== 活動管理 ==========
    async function loadActivities() {
      try {
        const activities = await callAPI('getActivities');
        const container = document.getElementById('activitiesList');
        
        if (!activities || activities.length === 0) {
          container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>目前沒有可報名的活動</p></div>';
          return;
        }

        container.innerHTML = activities.map(a => `
          <div class="activity-card">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="mb-0">${a.title}</h6>
              <span class="badge bg-primary">${a.status}</span>
            </div>
            <p class="text-muted small mb-2">${a.description || ''}</p>
            <div class="d-flex justify-content-between align-items-center">
              <div class="small text-muted">
                <i class="bi bi-calendar me-1"></i>${a.date}
                <i class="bi bi-geo-alt ms-2 me-1"></i>${a.location || '待定'}
              </div>
              <button class="btn btn-sm btn-primary" onclick="registerForActivity('${a.id}')">
                報名
              </button>
            </div>
            <div class="mt-2 small">
              <span class="badge bg-secondary">${a.currentCount}/${a.maxParticipants} 人</span>
              ${a.fee > 0 ? `<span class="badge bg-warning text-dark ms-1">費用: $${a.fee}</span>` : ''}
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Load Activities Error:', error);
      }
    }

    async function registerForActivity(activityId) {
      if (!confirm('確定要報名此活動嗎？')) return;
      
      try {
        showLoading(true);
        await callAPI('registerActivity', { activityId });
        showNotification('報名成功！', 'success');
        await loadDashboard();
      } catch (error) {
        showNotification(error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function loadMyRegistrations() {
      try {
        const registrations = await callAPI('getMyRegistrations');
        const container = document.getElementById('myRegistrationsList');
        
        if (!registrations || registrations.length === 0) {
          container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>尚無報名記錄</p></div>';
          return;
        }

        container.innerHTML = registrations.map(r => `
          <div class="activity-card">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="mb-0">${r.activityTitle}</h6>
              <span class="badge ${r.status === '已報名' ? 'bg-success' : 'bg-secondary'}">${r.status}</span>
            </div>
            <div class="small text-muted mb-2">
              報名時間: ${new Date(r.registrationTime).toLocaleString('zh-TW')}
            </div>
            ${r.status === '已報名' ? `
              <button class="btn btn-sm btn-outline-danger" onclick="cancelMyRegistration('${r.id}')">
                取消報名
              </button>
            ` : ''}
          </div>
        `).join('');
      } catch (error) {
        console.error('Load Registrations Error:', error);
      }
    }

    async function cancelMyRegistration(registrationId) {
      if (!confirm('確定要取消報名嗎？')) return;
      
      try {
        showLoading(true);
        await callAPI('cancelRegistration', { registrationId });
        showNotification('已取消報名', 'success');
        await loadDashboard();
      } catch (error) {
        showNotification(error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // ========== 志工服務 ==========
    document.querySelector('a[href="#volunteer"]').addEventListener('shown.bs.tab', loadVolunteerData);

    async function loadVolunteerData() {
      try {
        const data = await callAPI('getVolunteerData');
        
        document.getElementById('totalVolunteerHours').textContent = data.stats.totalHours || 0;
        
        const needsContainer = document.getElementById('volunteerNeedsList');
        if (!data.needs || data.needs.length === 0) {
          needsContainer.innerHTML = '<div class="empty-state"><i class="bi bi-heart"></i><p>目前沒有志工需求</p></div>';
        } else {
          needsContainer.innerHTML = data.needs.map(n => `
            <div class="activity-card">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="mb-0">${n.title}</h6>
                <span class="badge bg-warning text-dark">${n.hours}小時</span>
              </div>
              <p class="text-muted small mb-2">${n.description || ''}</p>
              <div class="d-flex justify-content-between align-items-center">
                <div class="small text-muted">
                  <i class="bi bi-calendar me-1"></i>${n.date}
                </div>
                <button class="btn btn-sm btn-primary" onclick="applyForVolunteer('${n.id}')">
                  報名
                </button>
              </div>
              <div class="mt-2 small">
                <span class="badge bg-secondary">${n.currentCount}/${n.needCount} 人</span>
              </div>
            </div>
          `).join('');
        }
        
        const recordsContainer = document.getElementById('myVolunteerRecords');
        if (!data.records || data.records.length === 0) {
          recordsContainer.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>尚無志工記錄</p></div>';
        } else {
          recordsContainer.innerHTML = data.records.map(r => `
            <div class="activity-card">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">${r.title}</h6>
                  <div class="small text-muted">${r.date}</div>
                </div>
                <div class="text-end">
                  <span class="badge ${r.status === '已完成' ? 'bg-success' : 'bg-warning'}">${r.status}</span>
                  <div class="small mt-1">${r.hours} 小時</div>
                </div>
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Load Volunteer Error:', error);
      }
    }

    async function applyForVolunteer(needId) {
      if (!confirm('確定要報名此志工服務嗎？')) return;
      
      try {
        showLoading(true);
        await callAPI('applyVolunteer', { needId });
        showNotification('志工報名成功！', 'success');
        await loadVolunteerData();
      } catch (error) {
        showNotification(error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // ========== 財務管理 ==========
    document.querySelector('a[href="#finance"]').addEventListener('shown.bs.tab', loadFinanceData);

    async function loadFinanceData() {
      try {
        const data = await callAPI('getFinanceData');
        
        const donationsContainer = document.getElementById('myDonationsList');
        if (!data.donations || data.donations.length === 0) {
          donationsContainer.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>尚無捐款記錄</p></div>';
        } else {
          donationsContainer.innerHTML = data.donations.map(d => `
            <div class="activity-card">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">${d.category}</h6>
                  <div class="small text-muted">${d.description || ''}</div>
                  <div class="small text-muted mt-1">${new Date(d.createdAt).toLocaleDateString('zh-TW')}</div>
                </div>
                <div class="text-end">
                  <div class="h5 text-success mb-1">$${d.amount}</div>
                  <span class="badge bg-success">${d.status}</span>
                </div>
              </div>
            </div>
          `).join('');
        }
        
        const expensesContainer = document.getElementById('myExpensesList');
        if (!data.expenses || data.expenses.length === 0) {
          expensesContainer.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>尚無支出記錄</p></div>';
        } else {
          expensesContainer.innerHTML = data.expenses.map(e => `
            <div class="activity-card">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">${e.category}</h6>
                  <div class="small text-muted">${e.description || ''}</div>
                  <div class="small text-muted mt-1">${new Date(e.createdAt).toLocaleDateString('zh-TW')}</div>
                </div>
                <div class="text-end">
                  <div class="h5 text-danger mb-1">$${e.amount}</div>
                  <span class="badge ${e.status === '已核准' ? 'bg-success' : e.status === '審核中' ? 'bg-warning' : 'bg-secondary'}">${e.status}</span>
                </div>
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Load Finance Error:', error);
      }
    }

    function showDonationModal() {
      document.getElementById('donationForm').reset();
      new bootstrap.Modal(document.getElementById('donationModal')).show();
    }

    async function submitDonation() {
      const form = document.getElementById('donationForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      try {
        showLoading(true);
        await callAPI('createDonation', {
          category: document.getElementById('donationCategory').value,
          amount: document.getElementById('donationAmount').value,
          description: document.getElementById('donationDescription').value,
          needReceipt: document.getElementById('donationNeedReceipt').checked
        });
        
        showNotification('捐款記錄已建立', 'success');
        bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
        await loadFinanceData();
      } catch (error) {
        showNotification(error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    function showExpenseModal() {
      document.getElementById('expenseForm').reset();
      new bootstrap.Modal(document.getElementById('expenseModal')).show();
    }

    async function submitExpense() {
      const form = document.getElementById('expenseForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      try {
        showLoading(true);
        await callAPI('createExpense', {
          category: document.getElementById('expenseCategory').value,
          amount: document.getElementById('expenseAmount').value,
          description: document.getElementById('expenseDescription').value
        });
        
        showNotification('支出申請已送出', 'success');
        bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
        await loadFinanceData();
      } catch (error) {
        showNotification(error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // ========== 回饋系統 ==========
    document.querySelector('a[href="#feedback"]').addEventListener('shown.bs.tab', loadFeedbackData);

    async function loadFeedbackData() {
      try {
        const feedbacks = await callAPI('getMyFeedback');
        const container = document.getElementById('myFeedbackList');
        
        if (!feedbacks || feedbacks.length === 0) {
          container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>尚無回饋記錄</p></div>';
        } else {
          container.innerHTML = feedbacks.map(f => `
            <div class="activity-card">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="mb-0">${f.activityTitle}</h6>
                <div>${'⭐'.repeat(f.rating)}</div>
              </div>
              <p class="text-muted small mb-1">${f.comment || '無意見'}</p>
              <div class="small text-muted">${new Date(f.createdAt).toLocaleDateString('zh-TW')}</div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Load Feedback Error:', error);
      }
    }

    async function showFeedbackModal() {
      try {
        const activities = await callAPI('getMyCompletedActivities');
        const select = document.getElementById('feedbackActivity');
        
        if (!activities || activities.length === 0) {
          showNotification('您目前沒有已完成的活動可以回饋', 'warning');
          return;
        }
        
        select.innerHTML = '<option value="">請選擇活動</option>' + 
          activities.map(a => `<option value="${a.id}">${a.title}</option>`).join('');
        
        document.getElementById('feedbackForm').reset();
        document.getElementById('feedbackRating').value = '';
        document.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('active', 'btn-warning'));
        
        new bootstrap.Modal(document.getElementById('feedbackModal')).show();
      } catch (error) {
        showNotification('載入活動失敗', 'error');
      }
    }

    // 評分按鈕
    document.querySelectorAll('.rating-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const rating = this.dataset.rating;
        document.getElementById('feedbackRating').value = rating;
        
        document.querySelectorAll('.rating-btn').forEach(b => {
          b.classList.remove('active', 'btn-warning');
          b.classList.add('btn-outline-warning');
        });
        
        for (let i = 1; i <= rating; i++) {
          const targetBtn = document.querySelector(`.rating-btn[data-rating="${i}"]`);
          targetBtn.classList.remove('btn-outline-warning');
          targetBtn.classList.add('btn-warning', 'active');
        }
      });
    });

    async function submitFeedback() {
      const form = document.getElementById('feedbackForm');
      const rating = document.getElementById('feedbackRating').value;
      
      if (!form.checkValidity() || !rating) {
        showNotification('請填寫完整資訊並選擇評分', 'warning');
        return;
      }

      try {
        showLoading(true);
        await callAPI('createFeedback', {
          activityId: document.getElementById('feedbackActivity').value,
          rating: parseInt(rating),
          comment: document.getElementById('feedbackComment').value
        });
        
        showNotification('感謝您的回饋！', 'success');
        bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
        await loadFeedbackData();
      } catch (error) {
        showNotification(error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // ========== 個人資料 ==========
    function showProfileModal() {
      if (!currentUser) return;
      
      document.getElementById('profileRealName').value = currentUser.realName || '';
      document.getElementById('profilePhone').value = currentUser.phone || '';
      document.getElementById('profileEmail').value = currentUser.email || '';
      document.getElementById('profileBirthday').value = currentUser.birthday || '';
      document.getElementById('profileAddress').value = currentUser.address || '';
      document.getElementById('profileMemberType').value = currentUser.memberType || '病友';
      
      new bootstrap.Modal(document.getElementById('profileModal')).show();
    }

    async function updateProfile() {
      const form = document.getElementById('profileForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      try {
        showLoading(true);
        await callAPI('updateProfile', {
          phone: document.getElementById('profilePhone').value,
          email: document.getElementById('profileEmail').value,
          birthday: document.getElementById('profileBirthday').value,
          address: document.getElementById('profileAddress').value,
          memberType: document.getElementById('profileMemberType').value
        });
        
        showNotification('個人資料已更新', 'success');
        bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
        await loadUserData();
      } catch (error) {
        showNotification(error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // ========== 初始化 ==========
    window.addEventListener('load', initLIFF);
  </script>
</body>
</html>
