<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</title>

<!-- LIFF SDK -->
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

<style>
:root {
  --primary: #06c755;
  --primary-dark: #05b04b;
  --secondary: #00b900;
  --danger: #dc3545;
  --warning: #ffc107;
  --info: #17a2b8;
  --light: #f8f9fa;
  --dark: #343a40;
  --border-radius: 12px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding-bottom: 80px;
}

.app-container {
  max-width: 480px;
  margin: 0 auto;
  background: white;
  min-height: 100vh;
  box-shadow: 0 0 30px rgba(0,0,0,0.1);
}

/* ==================== é ‚éƒ¨å°èˆª ==================== */
.top-bar {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.top-bar h1 {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid white;
}

.user-name {
  font-size: 14px;
  font-weight: 500;
}

/* ==================== åº•éƒ¨å°èˆª ==================== */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  border-top: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-around;
  padding: 8px 0;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
  z-index: 1000;
  max-width: 480px;
  margin: 0 auto;
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 8px;
  color: #666;
  text-decoration: none;
  transition: all 0.3s;
  cursor: pointer;
  border: none;
  background: none;
}

.nav-item i {
  font-size: 22px;
}

.nav-item span {
  font-size: 11px;
}

.nav-item.active {
  color: var(--primary);
}

.nav-item:hover {
  color: var(--primary);
  background: rgba(6, 199, 85, 0.05);
}

/* ==================== é é¢å…§å®¹ ==================== */
.page-content {
  display: none;
  padding: 20px;
  animation: fadeIn 0.3s;
}

.page-content.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ==================== å¡ç‰‡æ¨£å¼ ==================== */
.card {
  border: none;
  border-radius: var(--border-radius);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 20px;
  overflow: hidden;
}

.card-header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  font-weight: 600;
  padding: 15px 20px;
  border: none;
}

.card-body {
  padding: 20px;
}

/* ==================== çµ±è¨ˆå¡ç‰‡ ==================== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin-bottom: 20px;
}

.stat-card {
  background: white;
  border-radius: var(--border-radius);
  padding: 20px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: transform 0.3s, box-shadow 0.3s;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.stat-icon {
  font-size: 32px;
  margin-bottom: 10px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stat-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--dark);
  margin: 5px 0;
}

.stat-label {
  font-size: 13px;
  color: #666;
}

/* ==================== æ´»å‹•é …ç›® ==================== */
.activity-item {
  background: white;
  border-radius: var(--border-radius);
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: transform 0.3s, box-shadow 0.3s;
}

.activity-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.activity-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 8px;
}

.activity-info {
  font-size: 14px;
  color: #666;
  margin-bottom: 10px;
}

.activity-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  font-size: 13px;
  color: #888;
}

.activity-meta span {
  display: flex;
  align-items: center;
  gap: 4px;
}

.activity-meta i {
  font-size: 14px;
}

/* ==================== ç‹€æ…‹æ¨™ç±¤ ==================== */
.status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
}

.status-é–‹æ”¾å ±å, .status-å·²å ±å, .status-å·²å®Œæˆ {
  background: #d4edda;
  color: #155724;
}

.status-å·²é¡æ»¿, .status-å·²å–æ¶ˆ {
  background: #f8d7da;
  color: #721c24;
}

.status-å·²çµæŸ {
  background: #e2e3e5;
  color: #383d41;
}

.status-å¯©æ ¸ä¸­, .status-å¾…ä»˜æ¬¾ {
  background: #fff3cd;
  color: #856404;
}

.status-å·²æ ¸å‡†, .status-å·²ææ¬¾ {
  background: #d4edda;
  color: #155724;
}

.status-å·²æ‹’çµ• {
  background: #f8d7da;
  color: #721c24;
}

/* ==================== æŒ‰éˆ•æ¨£å¼ ==================== */
.btn-gradient {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 25px;
  font-weight: 600;
  transition: all 0.3s;
  box-shadow: 0 4px 10px rgba(6, 199, 85, 0.3);
}

.btn-gradient:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(6, 199, 85, 0.4);
  color: white;
}

.btn-gradient:active {
  transform: translateY(0);
}

/* ==================== è¡¨å–®æ¨£å¼ ==================== */
.form-floating > label {
  color: #666;
}

.form-control:focus,
.form-select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 0.2rem rgba(6, 199, 85, 0.25);
}

/* ==================== ç©ºç‹€æ…‹ ==================== */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #999;
}

.empty-state i {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0.5;
}

.empty-state p {
  font-size: 14px;
  margin: 0;
}

/* ==================== è¼‰å…¥å‹•ç•« ==================== */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ==================== Toast é€šçŸ¥ ==================== */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
}

/* ==================== ç®¡ç†å“¡å°ˆç”¨ ==================== */
.admin-only {
  display: none;
}

/* ==================== è¡¨æ ¼æ¨£å¼ ==================== */
.table-responsive {
  border-radius: var(--border-radius);
  overflow: hidden;
}

.table {
  margin-bottom: 0;
}

.table thead {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
}

.table tbody tr:hover {
  background: rgba(6, 199, 85, 0.05);
}

/* ==================== éŸ¿æ‡‰å¼è¨­è¨ˆ ==================== */
@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .activity-meta {
    flex-direction: column;
    gap: 5px;
  }
}
</style>
</head>
<body>

<div class="app-container">
  <!-- é ‚éƒ¨å°èˆª -->
  <div class="top-bar">
    <h1><i class="bi bi-heart-pulse me-2"></i>å¸•é‡‘æ£®ç—…å‹æœƒ</h1>
    <div class="user-info">
      <img id="userAvatar" class="user-avatar" src="https://via.placeholder.com/36" alt="é ­åƒ">
      <span id="userName" class="user-name">è¼‰å…¥ä¸­...</span>
    </div>
  </div>

  <!-- ==================== é¦–é  ==================== -->
  <div id="page-home" class="page-content active">
    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-calendar-event"></i></div>
        <div class="stat-value" id="statActivities">0</div>
        <div class="stat-label">æ´»å‹•ç¸½æ•¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
        <div class="stat-value" id="statRegistrations">0</div>
        <div class="stat-label">æˆ‘çš„å ±å</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
        <div class="stat-value" id="statVolunteerHours">0</div>
        <div class="stat-label">å¿—å·¥æ™‚æ•¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-heart"></i></div>
        <div class="stat-value" id="statDonations">0</div>
        <div class="stat-label">ææ¬¾é‡‘é¡</div>
      </div>
    </div>

    <!-- æœ€æ–°æ´»å‹• -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-calendar-event me-2"></i>æœ€æ–°æ´»å‹•
      </div>
      <div class="card-body">
        <div id="recentActivities">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== æ´»å‹•é é¢ ==================== -->
  <div id="page-activities" class="page-content">
    <!-- é–‹æ”¾å ±åæ´»å‹• -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-calendar-plus me-2"></i>é–‹æ”¾å ±å
      </div>
      <div class="card-body">
        <div id="activitiesList">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- æˆ‘çš„å ±å -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-list-check me-2"></i>æˆ‘çš„å ±å
      </div>
      <div class="card-body">
        <div id="myRegistrationsList">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== å¿—å·¥é é¢ ==================== -->
  <div id="page-volunteer" class="page-content">
    <!-- å¿—å·¥çµ±è¨ˆ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
        <div class="stat-value" id="volTotalHours">0</div>
        <div class="stat-label">ç´¯è¨ˆæ™‚æ•¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
        <div class="stat-value" id="volTotalActivities">0</div>
        <div class="stat-label">æœå‹™æ¬¡æ•¸</div>
      </div>
    </div>

    <!-- å¿—å·¥éœ€æ±‚ -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-people me-2"></i>å¿—å·¥éœ€æ±‚
      </div>
      <div class="card-body">
        <div id="volunteerNeedsList">
          <div class="empty-state">
            <i class="bi bi-people"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- æˆ‘çš„å¿—å·¥è¨˜éŒ„ -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-journal-text me-2"></i>æˆ‘çš„è¨˜éŒ„
      </div>
      <div class="card-body">
        <div id="myVolunteerRecords">
          <div class="empty-state">
            <i class="bi bi-journal-x"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== è²¡å‹™é é¢ ==================== -->
  <div id="page-finance" class="page-content">
    <!-- è²¡å‹™çµ±è¨ˆ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-heart"></i></div>
        <div class="stat-value" id="finTotalDonation">0</div>
        <div class="stat-label">ç´¯è¨ˆææ¬¾</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-receipt"></i></div>
        <div class="stat-value" id="finPendingExpenses">0</div>
        <div class="stat-label">å¾…å¯©æ ¸æ”¯å‡º</div>
      </div>
    </div>

    <!-- å¿«é€Ÿæ“ä½œ -->
    <div class="d-grid gap-2 mb-3">
      <button class="btn btn-gradient" onclick="showDonationModal()">
        <i class="bi bi-heart-fill me-2"></i>æˆ‘è¦ææ¬¾
      </button>
      <button class="btn btn-outline-primary" onclick="showNewExpenseModal()">
        <i class="bi bi-receipt me-2"></i>æ”¯å‡ºç”³è«‹
      </button>
    </div>

    <!-- æˆ‘çš„ææ¬¾è¨˜éŒ„ -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-heart me-2"></i>æˆ‘çš„ææ¬¾
      </div>
      <div class="card-body">
        <div id="myDonationsList">
          <div class="empty-state">
            <i class="bi bi-heart"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- æˆ‘çš„æ”¯å‡ºç”³è«‹ -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-receipt me-2"></i>æˆ‘çš„æ”¯å‡º
      </div>
      <div class="card-body">
        <div id="myExpensesList">
          <div class="empty-state">
            <i class="bi bi-receipt"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== å€‹äººé é¢ ==================== -->
  <div id="page-profile" class="page-content">
    <!-- å€‹äººè³‡æ–™ -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-person me-2"></i>å€‹äººè³‡æ–™
      </div>
      <div class="card-body">
        <form id="profileForm">
          <div class="form-floating mb-3">
            <input type="text" class="form-control" name="realName" required>
            <label>çœŸå¯¦å§“å *</label>
          </div>
          <div class="form-floating mb-3">
            <select class="form-select" name="memberType" required>
              <option value="">è«‹é¸æ“‡</option>
              <option value="ç—…å‹">ç—…å‹</option>
              <option value="å®¶å±¬">å®¶å±¬</option>
              <option value="å¿—å·¥">å¿—å·¥</option>
            </select>
            <label>æœƒå“¡é¡å‹ *</label>
          </div>
          <div class="form-floating mb-3">
            <input type="tel" class="form-control" name="phone">
            <label>è¯çµ¡é›»è©±</label>
          </div>
          <div class="form-floating mb-3">
            <input type="email" class="form-control" name="email">
            <label>é›»å­éƒµä»¶</label>
          </div>
          <div class="form-floating mb-3">
            <input type="date" class="form-control" name="birthday">
            <label>ç”Ÿæ—¥</label>
          </div>
          <div class="form-floating mb-3">
            <input type="date" class="form-control" name="diagnosisDate">
            <label>ç¢ºè¨ºæ—¥æœŸ</label>
          </div>
          <div class="form-floating mb-3">
            <textarea class="form-control" name="address" style="height:80px;"></textarea>
            <label>åœ°å€</label>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-gradient">
              <i class="bi bi-save me-2"></i>å„²å­˜è®Šæ›´
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- æˆ‘çš„æ”¶æ“š -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-file-earmark-text me-2"></i>æˆ‘çš„æ”¶æ“š
      </div>
      <div class="card-body">
        <div id="myReceiptsList">
          <div class="empty-state">
            <i class="bi bi-file-earmark-text"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- æœƒå“¡è³‡è¨Š -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-info-circle me-2"></i>æœƒå“¡è³‡è¨Š
      </div>
      <div class="card-body">
        <p><strong>æœƒå“¡é¡å‹ï¼š</strong><span id="userMemberType">-</span></p>
        <p><strong>LINE IDï¼š</strong><span id="userLineId">-</span></p>
        <p class="mb-0"><strong>ç‰ˆæœ¬ï¼š</strong>v2.0.0</p>
      </div>
    </div>
  </div>

  <!-- ==================== ç®¡ç†é é¢ ==================== -->
  <div id="page-admin" class="page-content admin-only">
    <!-- ç®¡ç†åŠŸèƒ½ -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-gear me-2"></i>ç®¡ç†åŠŸèƒ½
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <button class="btn btn-outline-primary" onclick="showNewActivityModal()">
            <i class="bi bi-calendar-plus me-2"></i>æ–°å¢æ´»å‹•
          </button>
          <button class="btn btn-outline-success" onclick="showNewVolunteerNeedModal()">
            <i class="bi bi-people me-2"></i>æ–°å¢å¿—å·¥éœ€æ±‚
          </button>
          <button class="btn btn-outline-info" onclick="exportMembers()">
            <i class="bi bi-download me-2"></i>åŒ¯å‡ºæœƒå“¡è³‡æ–™
          </button>
          <button class="btn btn-outline-warning" onclick="exportFinanceData()">
            <i class="bi bi-file-earmark-spreadsheet me-2"></i>åŒ¯å‡ºè²¡å‹™å ±è¡¨
          </button>
          <button class="btn btn-outline-secondary" onclick="backupSystem()">
            <i class="bi bi-cloud-upload me-2"></i>ç³»çµ±å‚™ä»½
          </button>
        </div>
      </div>
    </div>

    <!-- æœƒå“¡ç®¡ç† -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-people me-2"></i>æœƒå“¡ç®¡ç†
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover table-sm">
            <thead>
              <tr>
                <th>å§“å</th>
                <th>é¡å‹</th>
                <th>ç‹€æ…‹</th>
              </tr>
            </thead>
            <tbody id="memberList">
              <tr><td colspan="3" class="text-center">è¼‰å…¥ä¸­...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- æ´»å‹•ç®¡ç† -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-calendar-event me-2"></i>æ´»å‹•ç®¡ç†
      </div>
      <div class="card-body">
        <div id="adminActivityList">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- è²¡å‹™ç®¡ç† -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-cash-stack me-2"></i>è²¡å‹™ç®¡ç†
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>é¡å‹</th>
                <th>é‡‘é¡</th>
                <th>ç‹€æ…‹</th>
              </tr>
            </thead>
            <tbody id="transactionList">
              <tr><td colspan="4" class="text-center">è¼‰å…¥ä¸­...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨å°èˆª -->
  <div class="bottom-nav">
    <button class="nav-item active" onclick="switchPage('home', event)">
      <i class="bi bi-house-door-fill"></i>
      <span>é¦–é </span>
    </button>
    <button class="nav-item" onclick="switchPage('activities', event)">
      <i class="bi bi-calendar-event"></i>
      <span>æ´»å‹•</span>
    </button>
    <button class="nav-item" onclick="switchPage('volunteer', event)">
      <i class="bi bi-people"></i>
      <span>å¿—å·¥</span>
    </button>
    <button class="nav-item" onclick="switchPage('finance', event)">
      <i class="bi bi-wallet2"></i>
      <span>è²¡å‹™</span>
    </button>
    <button class="nav-item" onclick="switchPage('profile', event)">
      <i class="bi bi-person"></i>
      <span>æˆ‘çš„</span>
    </button>
    <button class="nav-item admin-only" onclick="switchPage('admin', event)">
      <i class="bi bi-gear"></i>
      <span>ç®¡ç†</span>
    </button>
  </div>
</div>

<!-- Toast å®¹å™¨ -->
<div id="toastContainer" class="toast-container"></div>

<!-- Modal å®¹å™¨ -->
<div id="modalContainer"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ==================== å…¨åŸŸè®Šæ•¸ ====================
const CONFIG = {
  LIFF_ID: '1656516134-VaGgmaPm',  // âš ï¸ è«‹æ›¿æ›æˆæ‚¨çš„ LIFF ID
  GAS_URL: 'https://script.google.com/macros/s/AKfycbyEeSCqlSIYwabIllpv_nyGebP_VsAsdGch79P6oefgd1HLfLvpFBPmUV60ESaeSfnR/exec',  // âš ï¸ è«‹æ›¿æ›æˆæ‚¨çš„ GAS URL
  API_KEY: 'AAbb8520258185202581'
};

let userProfile = null;
let isAdmin = false;
let cachedData = {};

// ==================== LIFF SDK è¼‰å…¥æª¢æŸ¥ ====================
function loadLiffSDK() {
  return new Promise((resolve, reject) => {
    console.log('ğŸ”„ æª¢æŸ¥ LIFF SDK...');
    
    let checkCount = 0;
    const maxChecks = 50;
    
    const checkLiff = () => {
      checkCount++;
      console.log(`ğŸ” æª¢æŸ¥ LIFF ç‰©ä»¶ (${checkCount}/${maxChecks})...`);
      
      if (typeof liff !== 'undefined') {
        console.log('âœ… LIFF SDK å¯ç”¨');
        resolve();
        return;
      }
      
      if (checkCount >= maxChecks) {
        console.error('âŒ LIFF SDK æœªè¼‰å…¥');
        reject(new Error('LIFF SDK æœªè¼‰å…¥ï¼Œè«‹ç¢ºèªåœ¨ LINE ä¸­é–‹å•Ÿ'));
        return;
      }
      
      setTimeout(checkLiff, 100);
    };
    
    checkLiff();
  });
}

// ==================== LIFF åˆå§‹åŒ– ====================
async function initLIFF() {
  console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ– LIFF...');
  
  try {
    await loadLiffSDK();
    
    console.log('ğŸ”§ åˆå§‹åŒ– LIFFï¼ŒID:', CONFIG.LIFF_ID);
    await liff.init({ liffId: CONFIG.LIFF_ID });
    console.log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ');
    
    if (!liff.isLoggedIn()) {
      console.log('âš ï¸ æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
      liff.login();
      return;
    }
    
    console.log('âœ… å·²ç™»å…¥');
    
    userProfile = await liff.getProfile();
    console.log('ğŸ‘¤ ä½¿ç”¨è€…è³‡æ–™:', userProfile);
    
    document.getElementById('userAvatar').src = userProfile.pictureUrl || 'https://via.placeholder.com/36';
    document.getElementById('userName').textContent = userProfile.displayName;
    document.getElementById('userLineId').textContent = userProfile.userId;
    
    await checkAdminStatus();
    await loadAllData();
    
    console.log('ğŸ‰ ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
    
  } catch (error) {
    console.error('âŒ LIFFåˆå§‹åŒ–å¤±æ•—:', error);
    showErrorPage(error);
  }
}

// ==================== éŒ¯èª¤é é¢ ====================
function showErrorPage(error) {
  document.querySelector('.app-container').innerHTML = `
    <div style="padding: 40px 20px; text-align: center;">
      <i class="bi bi-exclamation-triangle" style="font-size: 64px; color: #dc3545;"></i>
      <h3 style="margin-top: 20px;">ç³»çµ±åˆå§‹åŒ–å¤±æ•—</h3>
      <p style="color: #666; margin: 20px 0;">${error.message}</p>
      <button class="btn btn-gradient" onclick="location.reload()">
        <i class="bi bi-arrow-clockwise me-2"></i>é‡æ–°è¼‰å…¥
      </button>
    </div>`;
}

// ==================== API å‘¼å« ====================
async function callAPI(action, data = {}) {
  try {
    const payload = {
      apiKey: CONFIG.API_KEY,
      action: action,
      lineId: userProfile?.userId || '',
      ...data
    };
    
    console.log('ğŸ“¤ API è«‹æ±‚:', action, payload);
    
    const response = await fetch(CONFIG.GAS_URL, {
      method: 'POST',
      headers: { 
        'Content-Type': 'text/plain'
      },
      body: JSON.stringify(payload)
    });
    
    const result = await response.json();
    console.log('ğŸ“¥ API å›æ‡‰:', result);
    
    if (!result.success) {
      throw new Error(result.message || 'æ“ä½œå¤±æ•—');
    }
    
    return result;
  } catch (error) {
    console.error('âŒ API å‘¼å«å¤±æ•—:', error);
    throw error;
  }
}

// ==================== æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™ ====================
async function checkAdminStatus() {
  try {
    const response = await callAPI('getUserInfo', {});
    isAdmin = response.data?.isAdmin || false;
    
    if (isAdmin) {
      console.log('ğŸ‘‘ ç®¡ç†å“¡æ¬Šé™ç¢ºèª');
      document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = 'block';
      });
    }
  } catch (error) {
    console.error('æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™å¤±æ•—:', error);
  }
}

// ==================== è¼‰å…¥æ‰€æœ‰è³‡æ–™ ====================
async function loadAllData() {
  showLoading(true);
  try {
    await Promise.all([
      loadHomeData(),
      loadActivities(),
      loadVolunteerData(),
      loadFinanceData(),
      loadProfileData()
    ]);
    
    if (isAdmin) {
      await loadAdminData();
    }
  } catch (error) {
    console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
    showNotification('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== è¼‰å…¥é¦–é è³‡æ–™ ====================
async function loadHomeData() {
  try {
    const response = await callAPI('getDashboardData', {});
    const data = response.data;
    
    document.getElementById('statActivities').textContent = data.totalActivities || 0;
    document.getElementById('statRegistrations').textContent = data.myRegistrations || 0;
    document.getElementById('statVolunteerHours').textContent = data.myVolunteerHours || 0;
    document.getElementById('statDonations').textContent = formatCurrency(data.myDonationAmount || 0);
    
    renderRecentActivities(data.recentActivity || []);
  } catch (error) {
    console.error('è¼‰å…¥é¦–é è³‡æ–™å¤±æ•—:', error);
  }
}

function renderRecentActivities(activities) {
  const container = document.getElementById('recentActivities');
  
  if (activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>ç›®å‰æ²’æœ‰æ´»å‹•</p></div>';
    return;
  }
  
  container.innerHTML = activities.slice(0, 3).map(activity => `
    <div class="activity-item">
      <div class="activity-title">${activity.title}</div>
      <div class="activity-info">${activity.description || ''}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(activity.date)}</span>
        <span class="status-badge status-${activity.status}">${activity.status}</span>
      </div>
    </div>
  `).join('');
}

// ==================== è¼‰å…¥æ´»å‹•è³‡æ–™ ====================
async function loadActivities() {
  try {
    const response = await callAPI('getActivities', {});
    const activities = response.data || [];
    
    const openActivities = activities.filter(a => a.status === 'é–‹æ”¾å ±å');
    renderActivitiesList(openActivities);
    
    const regResponse = await callAPI('getMyRegistrations', {});
    renderMyRegistrations(regResponse.data || []);
  } catch (error) {
    console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', error);
  }
}

function renderActivitiesList(activities) {
  const container = document.getElementById('activitiesList');
  
  if (activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>ç›®å‰æ²’æœ‰é–‹æ”¾å ±åçš„æ´»å‹•</p></div>';
    return;
  }
  
  container.innerHTML = activities.map(activity => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${activity.title}</div>
        <span class="status-badge status-${activity.status}">${activity.status}</span>
      </div>
      <div class="activity-info">${activity.description || ''}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(activity.date)} ${activity.time || ''}</span>
        <span><i class="bi bi-geo-alt"></i>${activity.location || 'æœªæŒ‡å®š'}</span>
        <span><i class="bi bi-people"></i>${activity.currentCount || 0}/${activity.maxParticipants}</span>
        ${activity.fee ? `<span><i class="bi bi-cash"></i>$${formatCurrency(activity.fee)}</span>` : ''}
      </div>
      <button class="btn btn-sm btn-gradient mt-2" onclick="registerActivity('${activity.id}')">
        <i class="bi bi-check-circle me-1"></i>æˆ‘è¦å ±å
      </button>
    </div>
  `).join('');
}

function renderMyRegistrations(registrations) {
  const container = document.getElementById('myRegistrationsList');
  
  if (registrations.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>æ‚¨é‚„æ²’æœ‰å ±åä»»ä½•æ´»å‹•</p></div>';
    return;
  }
  
  container.innerHTML = registrations.map(reg => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${reg.activityTitle}</div>
        <span class="status-badge status-${reg.status}">${reg.status}</span>
      </div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(reg.registrationTime)}</span>
      </div>
      ${reg.status === 'å·²å ±å' ? `
        <button class="btn btn-sm btn-outline-danger mt-2" onclick="cancelRegistration('${reg.id}')">
          <i class="bi bi-x-circle me-1"></i>å–æ¶ˆå ±å
        </button>
      ` : ''}
    </div>
  `).join('');
}

async function registerActivity(activityId) {
  if (!confirm('ç¢ºå®šè¦å ±åæ­¤æ´»å‹•å—ï¼Ÿ')) return;
  
  try {
    showLoading(true);
    await callAPI('registerActivity', { activityId: activityId });
    showNotification('å ±åæˆåŠŸï¼', 'success');
    await loadActivities();
    await loadHomeData();
  } catch (error) {
    showNotification('å ±åå¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

async function cancelRegistration(registrationId) {
  if (!confirm('ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ')) return;
  
  try {
    showLoading(true);
    await callAPI('cancelRegistration', { registrationId: registrationId });
    showNotification('å·²å–æ¶ˆå ±å', 'success');
    await loadActivities();
    await loadHomeData();
  } catch (error) {
    showNotification('å–æ¶ˆå¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== è¼‰å…¥å¿—å·¥è³‡æ–™ ====================
async function loadVolunteerData() {
  try {
    const response = await callAPI('getVolunteerData', {});
    const data = response.data;
    
    document.getElementById('volTotalHours').textContent = data.stats?.totalHours || 0;
    document.getElementById('volTotalActivities').textContent = data.stats?.totalActivities || 0;
    
    renderVolunteerNeeds(data.needs || []);
    renderMyVolunteerRecords(data.records || []);
  } catch (error) {
    console.error('è¼‰å…¥å¿—å·¥è³‡æ–™å¤±æ•—:', error);
  }
}

function renderVolunteerNeeds(needs) {
  const container = document.getElementById('volunteerNeedsList');
  
  if (needs.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-people"></i><p>ç›®å‰æ²’æœ‰å¿—å·¥éœ€æ±‚</p></div>';
    return;
  }
  
  container.innerHTML = needs.map(need => `
    <div class="activity-item">
      <div class="activity-title">${need.title}</div>
      <div class="activity-info">${need.description || ''}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(need.date)} ${need.time || ''}</span>
        <span><i class="bi bi-people"></i>éœ€æ±‚ï¼š${need.needCount}äºº</span>
        <span><i class="bi bi-clock"></i>æ™‚æ•¸ï¼š${need.hours}å°æ™‚</span>
        <span><i class="bi bi-check-circle"></i>å·²å ±åï¼š${need.currentCount || 0}äºº</span>
      </div>
      <button class="btn btn-sm btn-gradient mt-2" onclick="applyVolunteer('${need.id}')">
        <i class="bi bi-hand-thumbs-up me-1"></i>æˆ‘è¦å ±å
      </button>
    </div>
  `).join('');
}

function renderMyVolunteerRecords(records) {
  const container = document.getElementById('myVolunteerRecords');
  
  if (records.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-journal-x"></i><p>æ‚¨é‚„æ²’æœ‰å¿—å·¥æœå‹™è¨˜éŒ„</p></div>';
    return;
  }
  
  container.innerHTML = records.map(record => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${record.title}</div>
        <span class="status-badge status-${record.status}">${record.status}</span>
      </div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(record.date)}</span>
        <span><i class="bi bi-clock"></i>${record.hours}å°æ™‚</span>
      </div>
    </div>
  `).join('');
}

async function applyVolunteer(needId) {
  if (!confirm('ç¢ºå®šè¦å ±åæ­¤å¿—å·¥æœå‹™å—ï¼Ÿ')) return;
  
  try {
    showLoading(true);
    await callAPI('applyVolunteer', { needId: needId });
    showNotification('å ±åæˆåŠŸï¼', 'success');
    await loadVolunteerData();
  } catch (error) {
    showNotification('å ±åå¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== è¼‰å…¥è²¡å‹™è³‡æ–™ ====================
async function loadFinanceData() {
  try {
    const response = await callAPI('getFinanceData', {});
    const data = response.data;
    
    document.getElementById('finTotalDonation').textContent = formatCurrency(data.stats?.totalDonation || 0);
    document.getElementById('finPendingExpenses').textContent = data.stats?.pendingExpenses || 0;
    
    renderMyDonations(data.donations || []);
    renderMyExpenses(data.expenses || []);
  } catch (error) {
    console.error('è¼‰å…¥è²¡å‹™è³‡æ–™å¤±æ•—:', error);
  }
}

function renderMyDonations(donations) {
  const container = document.getElementById('myDonationsList');
  
  if (donations.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-heart"></i><p>æ‚¨é‚„æ²’æœ‰ææ¬¾è¨˜éŒ„</p></div>';
    return;
  }
  
  container.innerHTML = donations.map(donation => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="activity-title">$${formatCurrency(donation.amount)}</div>
          <div class="activity-info">${donation.category || 'ä¸€èˆ¬ææ¬¾'}</div>
          <div class="activity-meta">
            <span><i class="bi bi-calendar"></i>${formatDate(donation.createdAt)}</span>
            <span class="status-badge status-${donation.status}">${donation.status}</span>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

function renderMyExpenses(expenses) {
  const container = document.getElementById('myExpensesList');
  
  if (expenses.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-receipt"></i><p>æ‚¨é‚„æ²’æœ‰æ”¯å‡ºç”³è«‹</p></div>';
    return;
  }
  
  container.innerHTML = expenses.map(expense => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">$${formatCurrency(expense.amount)}</div>
        <span class="status-badge status-${expense.status}">${expense.status}</span>
      </div>
      <div class="activity-info">${expense.description}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(expense.createdAt)}</span>
        <span><i class="bi bi-tag"></i>${expense.category}</span>
      </div>
    </div>
  `).join('');
}

// ==================== è¼‰å…¥å€‹äººè³‡æ–™ ====================
async function loadProfileData() {
  try {
    const response = await callAPI('getUserInfo', {});
    const profile = response.data;
    
    const form = document.getElementById('profileForm');
    if (form && profile) {
      form.elements.realName.value = profile.realName || '';
      form.elements.memberType.value = profile.memberType || '';
      form.elements.phone.value = profile.phone || '';
      form.elements.email.value = profile.email || '';
      form.elements.birthday.value = formatDateInput(profile.birthday);
      form.elements.diagnosisDate.value = formatDateInput(profile.diagnosisDate);
      form.elements.address.value = profile.address || '';
    }
    
    document.getElementById('userMemberType').textContent = profile.memberType || '-';
    
    const receiptResponse = await callAPI('getMyReceipts', {});
    renderMyReceipts(receiptResponse.data || []);
  } catch (error) {
    console.error('è¼‰å…¥å€‹äººè³‡æ–™å¤±æ•—:', error);
  }
}

function renderMyReceipts(receipts) {
  const container = document.getElementById('myReceiptsList');
  
  if (receipts.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-file-earmark-text"></i><p>æ‚¨é‚„æ²’æœ‰æ”¶æ“š</p></div>';
    return;
  }
  
  container.innerHTML = receipts.map(receipt => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="activity-title">${receipt.receiptNumber}</div>
          <div class="activity-meta">
            <span><i class="bi bi-cash"></i>é‡‘é¡ï¼š$${formatCurrency(receipt.amount)}</span>
            <span><i class="bi bi-calendar"></i>${formatDate(receipt.issueDate)}</span>
          </div>
        </div>
        ${receipt.pdfUrl ? `
          <button class="btn btn-sm btn-gradient" onclick="window.open('${receipt.pdfUrl}', '_blank')">
            <i class="bi bi-download"></i>ä¸‹è¼‰
          </button>
        ` : ''}
      </div>
    </div>
  `).join('');
}

// å„²å­˜å€‹äººè³‡æ–™
document.getElementById('profileForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const formData = new FormData(e.target);
  const data = {
    realName: formData.get('realName'),
    memberType: formData.get('memberType'),
    phone: formData.get('phone'),
    email: formData.get('email'),
    birthday: formData.get('birthday'),
    diagnosisDate: formData.get('diagnosisDate'),
    address: formData.get('address')
  };
  
  const btn = e.target.querySelector('button[type="submit"]');
  setButtonLoading(btn, true);
  
  try {
    await callAPI('updateProfile', data);
    showNotification('è³‡æ–™å·²æ›´æ–°', 'success');
    await loadProfileData();
  } catch (error) {
    showNotification('æ›´æ–°å¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    setButtonLoading(btn, false);
  }
});

// ==================== è¼‰å…¥ç®¡ç†è³‡æ–™ ====================
async function loadAdminData() {
  try {
    const response = await callAPI('getAdminData', {});
    cachedData.admin = response.data;
    
    renderMemberList(cachedData.admin.members || []);
    renderAdminActivityList(cachedData.admin.activities || []);
    renderTransactionList(cachedData.admin.transactions || []);
  } catch (error) {
    console.error('è¼‰å…¥ç®¡ç†è³‡æ–™å¤±æ•—:', error);
  }
}

function renderMemberList(members) {
  const tbody = document.getElementById('memberList');
  
  if (members.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" class="text-center">æ²’æœ‰æœƒå“¡è³‡æ–™</td></tr>';
    return;
  }
  
  tbody.innerHTML = members.slice(0, 20).map(member => `
    <tr>
      <td>${member.realName || member.lineName}</td>
      <td>${member.memberType || '-'}</td>
      <td><span class="status-badge status-${member.status}">${member.status}</span></td>
    </tr>
  `).join('');
}

function renderAdminActivityList(activities) {
  const container = document.getElementById('adminActivityList');
  
  if (activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>æ²’æœ‰æ´»å‹•</p></div>';
    return;
  }
  
  container.innerHTML = activities.slice(0, 10).map(activity => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${activity.title}</div>
        <span class="status-badge status-${activity.status}">${activity.status}</span>
      </div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(activity.date)}</span>
        <span><i class="bi bi-people"></i>${activity.currentCount || 0}/${activity.maxParticipants}</span>
      </div>
    </div>
  `).join('');
}

function renderTransactionList(transactions) {
  const tbody = document.getElementById('transactionList');
  
  if (transactions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="text-center">æ²’æœ‰äº¤æ˜“è¨˜éŒ„</td></tr>';
    return;
  }
  
  tbody.innerHTML = transactions.slice(0, 20).map(trans => `
    <tr>
      <td>${formatDate(trans.date)}</td>
      <td>${trans.type}</td>
      <td>$${formatCurrency(trans.amount)}</td>
      <td><span class="status-badge status-${trans.status}">${trans.status}</span></td>
    </tr>
  `).join('');
}

// ==================== Modal å‡½æ•¸ ====================
function showDonationModal() {
  const html = `
    <div class="modal fade" id="donationModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="donationForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>æˆ‘è¦ææ¬¾</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="number" class="form-control" name="amount" required min="1">
              <label>ææ¬¾é‡‘é¡ *</label>
            </div>
            <div class="form-floating mb-3">
              <select class="form-select" name="category">
                <option value="ä¸€èˆ¬ææ¬¾">ä¸€èˆ¬ææ¬¾</option>
                <option value="æ´»å‹•è´ŠåŠ©">æ´»å‹•è´ŠåŠ©</option>
              </select>
              <label>ææ¬¾é¡åˆ¥</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" style="height:80px;"></textarea>
              <label>èªªæ˜</label>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" name="needReceipt" id="needReceipt">
              <label class="form-check-label" for="needReceipt">éœ€è¦æ”¶æ“š</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-gradient">ç¢ºèªææ¬¾</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  showModal(html, async (formData) => {
    const data = {
      amount: formData.get('amount'),
      category: formData.get('category'),
      description: formData.get('description'),
      needReceipt: formData.get('needReceipt') === 'on'
    };
    
    await callAPI('createDonation', data);
    showNotification('ææ¬¾è¨˜éŒ„å·²æ–°å¢ï¼Œæ„Ÿè¬æ‚¨çš„æ”¯æŒï¼', 'success');
    await loadFinanceData();
    await loadHomeData();
  });
}

function showNewExpenseModal() {
  const html = `
    <div class="modal fade" id="expenseModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="expenseForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>æ”¯å‡ºç”³è«‹</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="number" class="form-control" name="amount" required min="1">
              <label>é‡‘é¡ *</label>
            </div>
            <div class="form-floating mb-3">
              <select class="form-select" name="category" required>
                <option value="">è«‹é¸æ“‡</option>
                <option value="æ´»å‹•è²»ç”¨">æ´»å‹•è²»ç”¨</option>
                <option value="è¡Œæ”¿æ”¯å‡º">è¡Œæ”¿æ”¯å‡º</option>
                <option value="è¨­å‚™æ”¯å‡º">è¨­å‚™æ”¯å‡º</option>
              </select>
              <label>é¡åˆ¥ *</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" required style="height:100px;"></textarea>
              <label>èªªæ˜ *</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-gradient">é€å‡ºç”³è«‹</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  showModal(html, async (formData) => {
    const data = {
      amount: formData.get('amount'),
      category: formData.get('category'),
      description: formData.get('description')
    };
    
    await callAPI('createExpense', data);
    showNotification('æ”¯å‡ºç”³è«‹å·²é€å‡º', 'success');
    await loadFinanceData();
  });
}

function showNewActivityModal() {
  const html = `
    <div class="modal fade" id="activityModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <form class="modal-content" id="activityForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>æ–°å¢æ´»å‹•</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="text" class="form-control" name="title" required>
              <label>æ´»å‹•åç¨± *</label>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="date" class="form-control" name="date" required>
                  <label>æ—¥æœŸ *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="time" class="form-control" name="time">
                  <label>æ™‚é–“</label>
                </div>
              </div>
            </div>
            <div class="form-floating mb-3">
              <input type="text" class="form-control" name="location">
              <label>åœ°é»</label>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="maxParticipants" required min="1">
                  <label>äººæ•¸ä¸Šé™ *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="fee" min="0" value="0">
                  <label>è²»ç”¨</label>
                </div>
              </div>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" style="height:100px;"></textarea>
              <label>æ´»å‹•èªªæ˜</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-gradient">æ–°å¢æ´»å‹•</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  showModal(html, async (formData) => {
    const data = {
      title: formData.get('title'),
      date: formData.get('date'),
      time: formData.get('time'),
      location: formData.get('location'),
      maxParticipants: formData.get('maxParticipants'),
      fee: formData.get('fee') || 0,
      description: formData.get('description')
    };
    
    await callAPI('createActivity', data);
    showNotification('æ´»å‹•å·²æ–°å¢', 'success');
    await loadAdminData();
    await loadActivities();
  });
}

function showNewVolunteerNeedModal() {
  const html = `
    <div class="modal fade" id="volunteerModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="volunteerForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-people me-2"></i>æ–°å¢å¿—å·¥éœ€æ±‚</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="text" class="form-control" name="title" required>
              <label>éœ€æ±‚åç¨± *</label>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="date" class="form-control" name="date" required>
                  <label>æ—¥æœŸ *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="time" class="form-control" name="time">
                  <label>æ™‚é–“</label>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="needCount" required min="1">
                  <label>éœ€æ±‚äººæ•¸ *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="hours" required min="0.5" step="0.5">
                  <label>æœå‹™æ™‚æ•¸ *</label>
                </div>
              </div>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" style="height:100px;"></textarea>
              <label>èªªæ˜</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-gradient">æ–°å¢éœ€æ±‚</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  showModal(html, async (formData) => {
    const data = {
      title: formData.get('title'),
      date: formData.get('date'),
      time: formData.get('time'),
      needCount: formData.get('needCount'),
      hours: formData.get('hours'),
      description: formData.get('description')
    };
    
    await callAPI('createVolunteerNeed', data);
    showNotification('å¿—å·¥éœ€æ±‚å·²æ–°å¢', 'success');
    await loadVolunteerData();
  });
}

// ==================== Modal é€šç”¨å‡½æ•¸ ====================
function showModal(html, onSubmit) {
  const container = document.getElementById('modalContainer');
  container.innerHTML = html;
  
  const modalEl = container.querySelector('.modal');
  const modal = new bootstrap.Modal(modalEl);
  
  const form = modalEl.querySelector('form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const btn = form.querySelector('button[type="submit"]');
    setButtonLoading(btn, true);
    
    try {
      const formData = new FormData(form);
      await onSubmit(formData);
      modal.hide();
    } catch (error) {
      showNotification('æ“ä½œå¤±æ•—ï¼š' + error.message, 'error');
    } finally {
      setButtonLoading(btn, false);
    }
  });
  
  modalEl.addEventListener('hidden.bs.modal', () => {
    container.innerHTML = '';
  });
  
  modal.show();
}

// ==================== ç®¡ç†åŠŸèƒ½ ====================
async function exportMembers() {
  try {
    showLoading(true);
    const response = await callAPI('exportMembers', {});
    if (response.data?.fileUrl) {
      window.open(response.data.fileUrl, '_blank');
      showNotification('æœƒå“¡è³‡æ–™å·²åŒ¯å‡º', 'success');
    }
  } catch (error) {
    showNotification('åŒ¯å‡ºå¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

async function exportFinanceData() {
  try {
    showLoading(true);
    const response = await callAPI('exportFinanceData', {});
    if (response.data?.donationUrl) {
      window.open(response.data.donationUrl, '_blank');
      setTimeout(() => {
        if (response.data?.expenseUrl) {
          window.open(response.data.expenseUrl, '_blank');
        }
      }, 500);
      showNotification('è²¡å‹™å ±è¡¨å·²åŒ¯å‡º', 'success');
    }
  } catch (error) {
    showNotification('åŒ¯å‡ºå¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

async function backupSystem() {
  if (!confirm('ç¢ºå®šè¦åŸ·è¡Œç³»çµ±å‚™ä»½å—ï¼Ÿ')) return;
  
  try {
    showLoading(true);
    await callAPI('backupSystem', {});
    showNotification('ç³»çµ±å‚™ä»½å®Œæˆ', 'success');
  } catch (error) {
    showNotification('å‚™ä»½å¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== é é¢åˆ‡æ› ====================
function switchPage(pageName, event) {
  document.querySelectorAll('.page-content').forEach(page => {
    page.classList.remove('active');
  });
  
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  document.getElementById(`page-${pageName}`).classList.add('active');
  
  if (event && event.currentTarget) {
    event.currentTarget.classList.add('active');
  }
}

// ==================== å·¥å…·å‡½æ•¸ ====================
function formatDate(dateString) {
  if (!dateString) return '-';
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
  } catch (e) {
    return '-';
  }
}

function formatDateInput(dateString) {
  if (!dateString) return '';
  try {
    const date = new Date(dateString);
    return date.toISOString().split('T')[0];
  } catch (e) {
    return '';
  }
}

function formatCurrency(amount) {
  return new Intl.NumberFormat('zh-TW').format(amount || 0);
}

function showLoading(show) {
  let overlay = document.querySelector('.loading-overlay');
  
  if (show) {
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.innerHTML = '<div class="loading-spinner"></div>';
      document.body.appendChild(overlay);
    }
  } else {
    if (overlay) {
      overlay.remove();
    }
  }
}

function setButtonLoading(button, loading) {
  if (loading) {
    button.disabled = true;
    button.dataset.originalText = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>è™•ç†ä¸­...';
  } else {
    button.disabled = false;
    button.innerHTML = button.dataset.originalText;
  }
}

function showNotification(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  
  const colors = {
    success: '#28a745',
    error: '#dc3545',
    warning: '#ffc107',
    info: '#17a2b8'
  };
  
  const icons = {
    success: 'check-circle-fill',
    error: 'x-circle-fill',
    warning: 'exclamation-triangle-fill',
    info: 'info-circle-fill'
  };
  
  const toast = document.createElement('div');
  toast.className = 'toast show';
  toast.style.cssText = `
    min-width: 250px;
    margin-bottom: 10px;
    background: white;
    border-left: 4px solid ${colors[type]};
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  `;
  
  toast.innerHTML = `
    <div class="toast-body d-flex align-items-center">
      <i class="bi bi-${icons[type]} me-2" style="color: ${colors[type]}; font-size: 20px;"></i>
      <span>${message}</span>
    </div>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ==================== é é¢è¼‰å…¥å®Œæˆ ====================
document.addEventListener('DOMContentLoaded', () => {
  console.log('ğŸ“„ é é¢ DOM è¼‰å…¥å®Œæˆ');
  console.log('ğŸŒ User Agent:', navigator.userAgent);
  console.log('ğŸ“ ç•¶å‰ URL:', window.location.href);
  
  initLIFF();
});

console.log('âœ… è…³æœ¬è¼‰å…¥å®Œæˆ');
</script>

</body>
</html>


