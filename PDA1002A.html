
<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>登入 - 帕金森協會管理系統</title>
    <style>
      body { font-family: system-ui, -apple-system, "Noto Sans TC", Arial, sans-serif; background:#f6f7fb; margin:0; }
      .container { max-width: 960px; margin: 0 auto; padding: 24px; }
      .card { background:#fff; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.06); padding:24px; }
      .grid { display:grid; gap:16px; }
      .grid-2 { grid-template-columns: 1fr 1fr; }
      h1 { margin: 0 0 12px; font-size: 22px; }
      label { font-size:14px; color:#333; display:block; margin-bottom:6px; }
      input, select, textarea { width:100%; padding:10px 12px; border:1px solid #d9dce3; border-radius:8px; font-size:14px; }
      button { padding:10px 14px; background:#2563eb; color:#fff; border:0; border-radius:8px; cursor:pointer; font-size:14px; }
      button.secondary { background:#6b7280; }
      button.ghost { background:#eef2ff; color:#1e40af; }
      .row { display:flex; gap:8px; align-items:center; }
      .muted { color:#6b7280; font-size:13px; }
      .divider { height:1px; background:#eef0f4; margin:16px 0; }
      .tabs { display:flex; gap:8px; margin-bottom:12px; }
      .tab { padding:8px 12px; border-radius:999px; background:#eef2ff; color:#1e40af; cursor:pointer; }
      .tab.active { background:#2563eb; color:#fff; }
      .alert { padding:10px 12px; border-radius:8px; background:#fef3c7; color:#92400e; font-size:14px; }
      .success { background:#dcfce7; color:#166534; }
      .error { background:#fee2e2; color:#991b1b; }
      .hidden { display:none; }
      .link { color:#2563eb; text-decoration:underline; cursor:pointer; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>帕金森協會管理系統 - 登入</h1>
        <div class="tabs">
          <div class="tab active" data-tab="login">登入</div>
          <div class="tab" data-tab="register">註冊</div>
        </div>

        <div id="alert" class="alert hidden"></div>

        <div id="loginPane">
          <div class="grid">
            <button id="btnLineLogin" class="ghost">使用 LINE 登入</button>
            <div class="divider"></div>
            <div class="grid grid-2">
              <div>
                <label>手機</label>
                <input id="loginPhone" type="tel" placeholder="請輸入手機號碼" />
              </div>
              <div>
                <label>密碼</label>
                <input id="loginPassword" type="password" placeholder="請輸入密碼" />
              </div>
            </div>
            <div class="row">
              <button id="btnManualLogin">登入</button>
              <span class="muted">沒有帳號？請切換到「註冊」分頁</span>
            </div>
          </div>
        </div>

        <div id="registerPane" class="hidden">
          <div class="grid">
            <div class="grid grid-2">
              <div>
                <label>姓名</label>
                <input id="regName" type="text" placeholder="真實姓名" />
              </div>
              <div>
                <label>手機</label>
                <input id="regPhone" type="tel" placeholder="手機號碼" />
              </div>
            </div>
            <div class="grid grid-2">
              <div>
                <label>密碼</label>
                <input id="regPassword" type="password" placeholder="設定密碼" />
              </div>
              <div>
                <label>確認密碼</label>
                <input id="regPassword2" type="password" placeholder="再次輸入密碼" />
              </div>
            </div>
            <div class="row">
              <button id="btnRegister">建立帳號</button>
              <span class="muted">註冊後可於會員中心補完資料</span>
            </div>
          </div>
        </div>

      </div>
      <div class="row" style="margin-top:12px;">
        <span class="muted">技術支援：PD System</span>
        <span class="muted">LIFF_ID: <?= LIFF_ID ?></span>
      </div>
    </div>

    <?!= HtmlService.createHtmlOutputFromFile('partials_utils').getContent(); ?>
    <?!= HtmlService.createHtmlOutputFromFile('partials_footer').getContent(); ?>

    <script>
      const API_URL = '<?= https://script.google.com/macros/s/AKfycbzx402jYJdGOyz3c6c_2p5fLKOOIhEBfzTKUkAmzwD2g5-myyE9UYUw-arRImb9xmQ0_Q/exec ?>';
      const LIFF_ID = '<?= 1656516134-VaGgmaPm ?>';

      // Tabs
      document.querySelectorAll('.tab').forEach(t => {
        t.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
          t.classList.add('active');
          const tab = t.dataset.tab;
          document.getElementById('loginPane').classList.toggle('hidden', tab!=='login');
          document.getElementById('registerPane').classList.toggle('hidden', tab!=='register');
        });
      });

      // Alerts
      function showAlert(msg, type='info') {
        const el = document.getElementById('alert');
        el.textContent = msg;
        el.classList.remove('hidden','success','error');
        if (type==='success') el.classList.add('success');
        if (type==='error') el.classList.add('error');
        if (type==='info') { /* default style */ }
        setTimeout(()=>{ el.classList.add('hidden'); }, 4000);
      }

      // LINE Login (簡易示例；你可整合 liff.init 後取得 profile)
      document.getElementById('btnLineLogin').addEventListener('click', async () => {
        try {
          // 假示例：若已整合 LIFF，應呼叫 liff.init({ liffId: LIFF_ID }) -> liff.getProfile()
          // 這裡先以假資料示範
          const fakeProfile = { userId: 'U_demo_123', displayName: 'LINE用戶' };
          const res = await callApi(API_URL, 'auth.lineLogin', { ...fakeProfile }, null);
          if (!res.success) return showAlert(res.error || 'LINE 登入失敗', 'error');

          if (res.needRegister) {
            // 導向會員頁面，讓使用者完成實名制
            saveToken(res.token || '');
            localStorage.setItem('lineId', res.lineId);
            localStorage.setItem('lineName', res.lineName);
            window.location.href = `${API_URL}?page=member`;
          } else {
            saveToken(res.token);
            window.location.href = `${API_URL}?page=member`;
          }
        } catch (e) {
          showAlert(e.message, 'error');
        }
      });

      // Manual Login
      document.getElementById('btnManualLogin').addEventListener('click', async () => {
        const phone = document.getElementById('loginPhone').value.trim();
        const password = document.getElementById('loginPassword').value;
        if (!phone || !password) return showAlert('請輸入手機與密碼', 'error');
        const res = await callApi(API_URL, 'auth.manualLogin', { phone, password });
        if (!res.success) return showAlert(res.error || '登入失敗', 'error');
        saveToken(res.token);
        window.location.href = `${API_URL}?page=member`;
      });

      // Register
      document.getElementById('btnRegister').addEventListener('click', async () => {
        const 姓名 = document.getElementById('regName').value.trim();
        const 電話 = document.getElementById('regPhone').value.trim();
        const 密碼 = document.getElementById('regPassword').value;
        const 密碼2 = document.getElementById('regPassword2').value;
        if (!姓名 || !電話 || !密碼) return showAlert('請完整填寫註冊欄位', 'error');
        if (密碼 !== 密碼2) return showAlert('兩次密碼不一致', 'error');
        const res = await callApi(API_URL, 'auth.manualRegister', { 姓名, 電話, 密碼 });
        if (!res.success) return showAlert(res.error || '註冊失敗', 'error');
        saveToken(res.token);
        showAlert('註冊成功，正在導向會員中心...', 'success');
        setTimeout(()=> window.location.href = `${API_URL}?page=member`, 800);
      });
    </script>
  </body>
</html>
