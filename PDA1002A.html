<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友權益促進會 - 會員系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .content {
      padding: 20px;
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    
    .menu-item {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      border-radius: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      font-size: 16px;
    }
    
    .menu-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    
    .menu-item .icon {
      font-size: 36px;
      margin-bottom: 10px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border 0.3s;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-secondary {
      background: #6c757d;
    }
    
    .btn-danger {
      background: #dc3545;
    }
    
    .card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }
    
    .card h3 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .card p {
      color: #666;
      margin: 5px 0;
      font-size: 14px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .info-row:last-child {
      border-bottom: none;
    }
    
    .info-label {
      font-weight: bold;
      color: #666;
    }
    
    .info-value {
      color: #333;
    }
    
    .back-btn {
      background: #6c757d;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
    }
    
    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    
    .alert {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .badge-success {
      background: #28a745;
      color: white;
    }
    
    .badge-warning {
      background: #ffc107;
      color: #333;
    }
    
    .badge-danger {
      background: #dc3545;
      color: white;
    }
    
    .user-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .user-info h2 {
      color: #667eea;
      margin-bottom: 5px;
    }
    
    .user-info p {
      color: #666;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🏥 帕金森病友權益促進會</h1>
      <p>會員服務系統</p>
    </div>
    
    <div class="content">
      <!-- 載入中頁面 -->
      <div id="loadingPage" class="page active">
        <div class="loading">系統初始化中</div>
      </div>
      
      <!-- 註冊頁面 -->
      <div id="registerPage" class="page">
        <h2 style="margin-bottom: 20px; color: #667eea;">會員註冊</h2>
        <div id="registerAlert"></div>
        <form id="registerForm">
          <div class="form-group">
            <label>姓名 *</label>
            <input type="text" id="regName" required>
          </div>
          <div class="form-group">
            <label>電話 *</label>
            <input type="tel" id="regPhone" required>
          </div>
          <div class="form-group">
            <label>電子郵件</label>
            <input type="email" id="regEmail">
          </div>
          <div class="form-group">
            <label>地址</label>
            <input type="text" id="regAddress">
          </div>
          <div class="form-group">
            <label>緊急聯絡人</label>
            <input type="text" id="regEmergencyContact">
          </div>
          <div class="form-group">
            <label>緊急聯絡電話</label>
            <input type="tel" id="regEmergencyPhone">
          </div>
          <button type="submit" class="btn">註冊</button>
        </form>
      </div>
      
      <!-- 主選單頁面 -->
      <div id="mainPage" class="page">
        <div class="user-info">
          <h2 id="userName">載入中...</h2>
          <p id="userType">會員類型</p>
        </div>
        
        <div class="menu-grid">
          <button class="menu-item" onclick="showPage('activitiesPage')">
            <div class="icon">📅</div>
            <div>活動報名</div>
          </button>
          <button class="menu-item" onclick="showPage('myActivitiesPage')">
            <div class="icon">📋</div>
            <div>我的活動</div>
          </button>
          <button class="menu-item" onclick="showPage('healthPage')">
            <div class="icon">💊</div>
            <div>健康紀錄</div>
          </button>
          <button class="menu-item" onclick="showPage('medicationPage')">
            <div class="icon">💉</div>
            <div>用藥歷程</div>
          </button>
          <button class="menu-item" onclick="showPage('donationPage')">
            <div class="icon">💝</div>
            <div>捐款紀錄</div>
          </button>
          <button class="menu-item" onclick="showPage('volunteerPage')">
            <div class="icon">🤝</div>
            <div>志工服務</div>
          </button>
          <button class="menu-item" onclick="showPage('profilePage')">
            <div class="icon">👤</div>
            <div>個人資料</div>
          </button>
          <button class="menu-item" onclick="liff.closeWindow()">
            <div class="icon">🚪</div>
            <div>離開系統</div>
          </button>
        </div>
      </div>
      
      <!-- 活動報名頁面 -->
      <div id="activitiesPage" class="page">
        <button class="back-btn" onclick="showPage('mainPage')">← 返回</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">活動報名</h2>
        <div id="activitiesList"></div>
      </div>
      
      <!-- 我的活動頁面 -->
      <div id="myActivitiesPage" class="page">
        <button class="back-btn" onclick="showPage('mainPage')">← 返回</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">我的活動</h2>
        <div id="myActivitiesList"></div>
      </div>
      
      <!-- 健康紀錄頁面 -->
      <div id="healthPage" class="page">
        <button class="back-btn" onclick="showPage('mainPage')">← 返回</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">健康紀錄</h2>
        <button class="btn" onclick="showPage('addHealthPage')">+ 新增紀錄</button>
        <div id="healthList" style="margin-top: 20px;"></div>
      </div>
      
      <!-- 新增健康紀錄頁面 -->
      <div id="addHealthPage" class="page">
        <button class="back-btn" onclick="showPage('healthPage')">← 返回</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">新增健康紀錄</h2>
        <form id="healthForm">
          <div class="form-group">
            <label>收縮壓 (mmHg)</label>
            <input type="number" id="healthSystolic">
          </div>
          <div class="form-group">
            <label>舒張壓 (mmHg)</label>
            <input type="number" id="healthDiastolic">
          </div>
          <div class="form-group">
            <label>心跳 (次/分)</label>
            <input type="number" id="healthHeartRate">
          </div>
          <div class="form-group">
            <label>體溫 (°C)</label>
            <input type="number" step="0.1" id="healthTemperature">
          </div>
          <div class="form-group">
            <label>症狀描述</label>
            <textarea id="healthSymptoms" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>備註</label>
            <textarea id="healthNote" rows="2"></textarea>
          </div>
          <button type="submit" class="btn">儲存</button>
        </form>
      </div>
      
      <!-- 用藥歷程頁面 -->
      <div id="medicationPage" class="page">
        <button class="back-btn" onclick="showPage('mainPage')">← 返回</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">用藥歷程</h2>
        <button class="btn" onclick="showPage('addMedicationPage')">+ 新增紀錄</button>
        <div id="medicationList" style="margin-top: 20px;"></div>
      </div>
      
      <!-- 新增用藥紀錄頁面 -->
      <div id="addMedicationPage" class="page">
        <button class="back-btn" onclick="showPage('medicationPage')">← 返回</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">新增用藥紀錄</h2>
        <form id="medicationForm">
          <div class="form-group">
            <label>藥品名稱 *</label>
            <input type="text" id="medName" required>
          </div>
          <div class="form-group">
            <label>劑量 *</label>
            <input type="text" id="medDosage" required>
          </div>
          <div class="form-group">
            <label>用藥時間 *</label>
            <input type="time" id="medTime" required>
          </div>
          <div class="form-group">
            <label>副作用</label>
            <textarea id="medSideEffects" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>備註</label>
            <textarea id="medNote" rows="2"></textarea>
          </div>
          <button type="submit" class="btn">儲存</button>
        </form>
      </div>
      
      <!-- 捐款紀錄頁面 -->
      <div id="donationPage" class="page">
        <button class="back-btn" onclick="showPage('mainPage')">← 返回</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">捐款紀錄</h2>
        <button class="btn" onclick="showPage('addDonationPage')">+ 新增捐款</button>
        <div id="donationList" style="margin-top: 20px;"></div>
      </div>
      
      <!-- 新增捐款頁面 -->
      <div id="addDonationPage" class="page">
        <button class="back-btn" onclick="showPage('donationPage')">← 返回</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">新增捐款</h2>
        <form id="donationForm">
          <div class="form-group">
            <label>捐款金額 *</label>
            <input type="number" id="donAmount" required>
          </div>
          <div class="form-group">
            <label>捐款方式 *</label>
            <select id="donMethod" required>
              <option value="">請選擇</option>
              <option value="現金">現金</option>
              <option value="匯款">匯款</option>
              <option value="信用卡">信用卡</option>
              <option value="支票">支票</option>
            </select>
          </div>
          <div class="form-group">
            <label>備註</label>
            <textarea id="donNote" rows="2"></textarea>
          </div>
          <button type="submit" class="btn">送出</button>
        </form>
      </div>
      
      <!-- 志工服務頁面 -->
      <div id="volunteerPage" class="page">
        <button class="back-btn" onclick="showPage('mainPage')">← 返回</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">志工服務</h2>
        <div id="volunteerList"></div>
      </div>
      
      <!-- 個人資料頁面 -->
      <div id="profilePage" class="page">
        <button class="back-btn" onclick="showPage('mainPage')">← 返回</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">個人資料</h2>
        <div id="profileInfo"></div>
        <button class="btn" onclick="showPage('editProfilePage')" style="margin-top: 20px;">編輯資料</button>
      </div>
      
      <!-- 編輯個人資料頁面 -->
      <div id="editProfilePage" class="page">
        <button class="back-btn" onclick="showPage('profilePage')">← 返回</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">編輯個人資料</h2>
        <form id="editProfileForm">
          <div class="form-group">
            <label>姓名</label>
            <input type="text" id="editName">
          </div>
          <div class="form-group">
            <label>電話</label>
            <input type="tel" id="editPhone">
          </div>
          <div class="form-group">
            <label>電子郵件</label>
            <input type="email" id="editEmail">
          </div>
          <div class="form-group">
            <label>地址</label>
            <input type="text" id="editAddress">
          </div>
          <div class="form-group">
            <label>緊急聯絡人</label>
            <input type="text" id="editEmergencyContact">
          </div>
          <div class="form-group">
            <label>緊急聯絡電話</label>
            <input type="tel" id="editEmergencyPhone">
          </div>
          <button type="submit" class="btn">儲存</button>
        </form>
      </div>
    </div>
  </div>
  
  <script>
    // ==================== 設定區 ====================
    const LIFF_ID = '1656516134-VaGgmaPm'; // 請替換為您的 LIFF ID
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwEbScN-r1UVwppUwbTwULuq6M1Vm2eko4EkCZpD_CCI8WkTInQk5O752ENwRTIchj70Q/exec'; // 請替換為您的 GAS Web App URL
    
    let currentUser = null;
    let lineProfile = null;
    
    // ==================== LIFF 初始化 ====================
    window.onload = function() {
      liff.init({
        liffId: LIFF_ID
      }).then(() => {
        if (liff.isLoggedIn()) {
          liff.getProfile().then(profile => {
            lineProfile = profile;
            checkMemberStatus();
          });
        } else {
          liff.login();
        }
      }).catch((err) => {
        alert('LIFF初始化失敗: ' + err);
      });
    };
    
    // ==================== 檢查會員狀態 ====================
    async function checkMemberStatus() {
      try {
        const response = await callAPI('login', {
          lineId: lineProfile.userId
        });
        
        if (response.success) {
          currentUser = response.member;
          showPage('mainPage');
          loadUserInfo();
        } else {
          showPage('registerPage');
        }
      } catch (error) {
        alert('系統錯誤: ' + error);
      }
    }
    
    // ==================== API 呼叫函數 ====================
    async function callAPI(action, params) {
      const response = await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: action,
          ...params
        })
      });
      return await response.json();
    }
    
    // ==================== 頁面切換 ====================
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
      
      // 載入對應頁面資料
      if (pageId === 'activitiesPage') loadActivities();
      if (pageId === 'myActivitiesPage') loadMyActivities();
      if (pageId === 'healthPage') loadHealthRecords();
      if (pageId === 'medicationPage') loadMedicationRecords();
      if (pageId === 'donationPage') loadDonations();
      if (pageId === 'volunteerPage') loadVolunteerRecords();
      if (pageId === 'profilePage') loadProfile();
      if (pageId === 'editProfilePage') loadEditProfile();
    }
    
    // ==================== 載入使用者資訊 ====================
    function loadUserInfo() {
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userType').textContent = currentUser.memberType;
    }
    
    // ==================== 會員註冊 ====================
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const data = {
        lineId: lineProfile.userId,
        name: document.getElementById('regName').value,
        phone: document.getElementById('regPhone').value,
        email: document.getElementById('regEmail').value,
        address: document.getElementById('regAddress').value,
        emergencyContact: document.getElementById('regEmergencyContact').value,
        emergencyPhone: document.getElementById('regEmergencyPhone').value
      };
      
      try {
        const response = await callAPI('register', data);
        
        if (response.success) {
          alert('註冊成功！');
          checkMemberStatus();
        } else {
          showAlert('registerAlert', response.message, 'error');
        }
      } catch (error) {
        showAlert('registerAlert', '註冊失敗: ' + error, 'error');
      }
    });
    
    // ==================== 載入活動列表 ====================
    async function loadActivities() {
      const listDiv = document.getElementById('activitiesList');
      listDiv.innerHTML = '<div class="loading">載入中</div>';
      
      try {
        const response = await callAPI('getActivities', {});
        
        if (response.success && response.activities.length > 0) {
          let html = '';
          response.activities.forEach(activity => {
            const isFull = activity.currentParticipants >= activity.maxParticipants;
            html += `
              <div class="card">
                <h3>${activity.name}</h3>
                <p>📅 日期：${formatDate(activity.date)}</p>
                <p>⏰ 時間：${activity.time}</p>
                <p>📍 地點：${activity.location}</p>
                <p>👥 人數：${activity.currentParticipants}/${activity.maxParticipants}</p>
                <p>📝 說明：${activity.description}</p>
                <button class="btn ${isFull ? 'btn-secondary' : ''}" 
                        onclick="registerForActivity('${activity.activityId}')"
                        ${isFull ? 'disabled' : ''}>
                  ${isFull ? '已額滿' : '立即報名'}
                </button>
              </div>
            `;
          });
          listDiv.innerHTML = html;
        } else {
          listDiv.innerHTML = '<p style="text-align: center; color: #999;">目前沒有活動</p>';
        }
      } catch (error) {
        listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">載入失敗</p>';
      }
    }
    
    // ==================== 報名活動 ====================
    async function registerForActivity(activityId) {
      if (!confirm('確定要報名此活動嗎？')) return;
      
      try {
        const response = await callAPI('registerActivity', {
          memberId: currentUser.memberId,
          activityId: activityId
        });
        
        if (response.success) {
          alert('報名成功！');
          loadActivities();
        } else {
          alert(response.message);
        }
      } catch (error) {
        alert('報名失敗: ' + error);
      }
    }
    
    // ==================== 載入我的活動 ====================
    async function loadMyActivities() {
      const listDiv = document.getElementById('myActivitiesList');
      listDiv.innerHTML = '<div class="loading">載入中</div>';
      
      try {
        const response = await callAPI('getMyActivities', {
          memberId: currentUser.memberId
        });
        
        if (response.success && response.activities.length > 0) {
          let html = '';
          response.activities.forEach(activity => {
            const statusClass = activity.status === '已報名' ? 'success' : 
                               activity.status === '已取消' ? 'danger' : 'warning';
            html += `
              <div class="card">
                <h3>${activity.name}</h3>
                <p>📅 日期：${formatDate(activity.date)}</p>
                <p>⏰ 時間：${activity.time}</p>
                <p>📍 地點：${activity.location}</p>
                <p>狀態：<span class="badge badge-${statusClass}">${activity.status}</span></p>
              </div>
            `;
          });
          listDiv.innerHTML = html;
        } else {
          listDiv.innerHTML = '<p style="text-align: center; color: #999;">尚未報名任何活動</p>';
        }
      } catch (error) {
        listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">載入失敗</p>';
      }
    }
    
    // ==================== 載入健康紀錄 ====================
    async function loadHealthRecords() {
      const listDiv = document.getElementById('healthList');
      listDiv.innerHTML = '<div class="loading">載入中</div>';
      
      try {
        const response = await callAPI('getHealthRecords', {
          memberId: currentUser.memberId
        });
        
        if (response.success && response.records.length > 0) {
          let html = '';
          response.records.forEach(record => {
            html += `
              <div class="card">
                <h3>📅 ${formatDate(record.date)}</h3>
                ${record.systolic ? `<p>🩺 血壓：${record.systolic}/${record.diastolic} mmHg</p>` : ''}
                ${record.heartRate ? `<p>💓 心跳：${record.heartRate} 次/分</p>` : ''}
                ${record.temperature ? `<p>🌡️ 體溫：${record.temperature} °C</p>` : ''}
                ${record.symptoms ? `<p>📝 症狀：${record.symptoms}</p>` : ''}
                ${record.note ? `<p>💬 備註：${record.note}</p>` : ''}
              </div>
            `;
          });
          listDiv.innerHTML = html;
        } else {
          listDiv.innerHTML = '<p style="text-align: center; color: #999;">尚無健康紀錄</p>';
        }
      } catch (error) {
        listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">載入失敗</p>';
        }
      }
      
      // ==================== 新增健康紀錄 ====================
      document.getElementById('healthForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const data = {
          memberId: currentUser.memberId,
          systolic: document.getElementById('healthSystolic').value,
          diastolic: document.getElementById('healthDiastolic').value,
          heartRate: document.getElementById('healthHeartRate').value,
          temperature: document.getElementById('healthTemperature').value,
          symptoms: document.getElementById('healthSymptoms').value,
          note: document.getElementById('healthNote').value
        };
        
        try {
          const response = await callAPI('addHealthRecord', data);
          
          if (response.success) {
            alert('健康紀錄已儲存！');
            this.reset();
            showPage('healthPage');
          } else {
            alert(response.message);
          }
        } catch (error) {
          alert('儲存失敗: ' + error);
        }
      });
      
      // ==================== 載入用藥紀錄 ====================
      async function loadMedicationRecords() {
        const listDiv = document.getElementById('medicationList');
        listDiv.innerHTML = '<div class="loading">載入中</div>';
        
        try {
          const response = await callAPI('getMedicationRecords', {
            memberId: currentUser.memberId
          });
          
          if (response.success && response.records.length > 0) {
            let html = '';
            response.records.forEach(record => {
              html += `
                <div class="card">
                  <h3>💊 ${record.medicationName}</h3>
                  <p>📅 日期：${formatDate(record.date)}</p>
                  <p>⏰ 時間：${record.time}</p>
                  <p>💉 劑量：${record.dosage}</p>
                  ${record.sideEffects ? `<p>⚠️ 副作用：${record.sideEffects}</p>` : ''}
                  ${record.note ? `<p>💬 備註：${record.note}</p>` : ''}
                </div>
              `;
            });
            listDiv.innerHTML = html;
          } else {
            listDiv.innerHTML = '<p style="text-align: center; color: #999;">尚無用藥紀錄</p>';
          }
        } catch (error) {
          listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">載入失敗</p>';
        }
      }
      
      // ==================== 新增用藥紀錄 ====================
      document.getElementById('medicationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const data = {
          memberId: currentUser.memberId,
          medicationName: document.getElementById('medName').value,
          dosage: document.getElementById('medDosage').value,
          time: document.getElementById('medTime').value,
          sideEffects: document.getElementById('medSideEffects').value,
          note: document.getElementById('medNote').value
        };
        
        try {
          const response = await callAPI('addMedicationRecord', data);
          
          if (response.success) {
            alert('用藥紀錄已儲存！');
            this.reset();
            showPage('medicationPage');
          } else {
            alert(response.message);
          }
        } catch (error) {
          alert('儲存失敗: ' + error);
        }
      });
      
      // ==================== 載入捐款紀錄 ====================
      async function loadDonations() {
        const listDiv = document.getElementById('donationList');
        listDiv.innerHTML = '<div class="loading">載入中</div>';
        
        try {
          const response = await callAPI('getDonations', {
            memberId: currentUser.memberId
          });
          
          if (response.success && response.donations.length > 0) {
            let html = '';
            let total = 0;
            response.donations.forEach(donation => {
              total += parseFloat(donation.amount);
              html += `
                <div class="card">
                  <h3>💝 NT$ ${donation.amount.toLocaleString()}</h3>
                  <p>📅 日期：${formatDate(donation.date)}</p>
                  <p>💳 方式：${donation.method}</p>
                  ${donation.note ? `<p>💬 備註：${donation.note}</p>` : ''}
                </div>
              `;
            });
            html = `<div class="alert alert-success">累計捐款：NT$ ${total.toLocaleString()}</div>` + html;
            listDiv.innerHTML = html;
          } else {
            listDiv.innerHTML = '<p style="text-align: center; color: #999;">尚無捐款紀錄</p>';
          }
        } catch (error) {
          listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">載入失敗</p>';
        }
      }
      
      // ==================== 新增捐款 ====================
      document.getElementById('donationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const data = {
          memberId: currentUser.memberId,
          amount: document.getElementById('donAmount').value,
          method: document.getElementById('donMethod').value,
          note: document.getElementById('donNote').value
        };
        
        try {
          const response = await callAPI('addDonation', data);
          
          if (response.success) {
            alert('捐款紀錄已新增，感謝您的支持！');
            this.reset();
            showPage('donationPage');
          } else {
            alert(response.message);
          }
        } catch (error) {
          alert('新增失敗: ' + error);
        }
      });
      
      // ==================== 載入志工紀錄 ====================
      async function loadVolunteerRecords() {
        const listDiv = document.getElementById('volunteerList');
        listDiv.innerHTML = '<div class="loading">載入中</div>';
        
        try {
          const response = await callAPI('getVolunteerRecords', {
            memberId: currentUser.memberId
          });
          
          if (response.success && response.records.length > 0) {
            let html = '';
            let totalHours = 0;
            response.records.forEach(record => {
              totalHours += parseFloat(record.hours);
              html += `
                <div class="card">
                  <h3>🤝 ${record.activityName}</h3>
                  <p>📅 日期：${formatDate(record.date)}</p>
                  <p>⏱️ 時數：${record.hours} 小時</p>
                  ${record.note ? `<p>💬 備註：${record.note}</p>` : ''}
                </div>
              `;
            });
            html = `<div class="alert alert-success">累計服務時數：${totalHours} 小時</div>` + html;
            listDiv.innerHTML = html;
          } else {
            listDiv.innerHTML = '<p style="text-align: center; color: #999;">尚無志工紀錄</p>';
          }
        } catch (error) {
          listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">載入失敗</p>';
        }
      }
      
      // ==================== 載入個人資料 ====================
      async function loadProfile() {
        const infoDiv = document.getElementById('profileInfo');
        infoDiv.innerHTML = `
          <div class="info-row">
            <span class="info-label">姓名</span>
            <span class="info-value">${currentUser.name}</span>
          </div>
          <div class="info-row">
            <span class="info-label">電話</span>
            <span class="info-value">${currentUser.phone}</span>
          </div>
          <div class="info-row">
            <span class="info-label">電子郵件</span>
            <span class="info-value">${currentUser.email || '未設定'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">地址</span>
            <span class="info-value">${currentUser.address || '未設定'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">會員類型</span>
            <span class="info-value">${currentUser.memberType}</span>
          </div>
          <div class="info-row">
            <span class="info-label">加入日期</span>
            <span class="info-value">${formatDate(currentUser.joinDate)}</span>
          </div>
          <div class="info-row">
            <span class="info-label">緊急聯絡人</span>
            <span class="info-value">${currentUser.emergencyContact || '未設定'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">緊急聯絡電話</span>
            <span class="info-value">${currentUser.emergencyPhone || '未設定'}</span>
          </div>
        `;
      }
      
      // ==================== 載入編輯資料表單 ====================
      function loadEditProfile() {
        document.getElementById('editName').value = currentUser.name;
        document.getElementById('editPhone').value = currentUser.phone;
        document.getElementById('editEmail').value = currentUser.email || '';
        document.getElementById('editAddress').value = currentUser.address || '';
        document.getElementById('editEmergencyContact').value = currentUser.emergencyContact || '';
        document.getElementById('editEmergencyPhone').value = currentUser.emergencyPhone || '';
      }
      
      // ==================== 更新個人資料 ====================
      document.getElementById('editProfileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const data = {
          memberId: currentUser.memberId,
          name: document.getElementById('editName').value,
          phone: document.getElementById('editPhone').value,
          email: document.getElementById('editEmail').value,
          address: document.getElementById('editAddress').value,
          emergencyContact: document.getElementById('editEmergencyContact').value,
          emergencyPhone: document.getElementById('editEmergencyPhone').value
        };
        
        try {
          const response = await callAPI('updateProfile', data);
          
          if (response.success) {
            alert('資料更新成功！');
            currentUser = { ...currentUser, ...data };
            showPage('profilePage');
          } else {
            alert(response.message);
          }
        } catch (error) {
          alert('更新失敗: ' + error);
        }
      });
      
      // ==================== 工具函數 ====================
      function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit' 
        });
      }
      
      function showAlert(elementId, message, type) {
        const alertDiv = document.getElementById(elementId);
        alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => {
          alertDiv.innerHTML = '';
        }, 3000);
      }
    </script>
  </body>
  </html>
