<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友協會 - 會員系統</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-box: border-box;
      }
      
      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 20px;
      }
      
      .container {
          background: white;
          border-radius: 20px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          max-width: 450px;
          width: 100%;
          overflow: hidden;
      }
      
      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 30px;
          text-align: center;
      }
      
      .header h1 {
          font-size: 24px;
          margin-bottom: 5px;
      }
      
      .header p {
          font-size: 14px;
          opacity: 0.9;
      }
      
      .content {
          padding: 30px;
      }
      
      .tab-buttons {
          display: flex;
          gap: 10px;
          margin-bottom: 25px;
      }
      
      .tab-btn {
          flex: 1;
          padding: 12px;
          border: 2px solid #667eea;
          background: white;
          color: #667eea;
          border-radius: 10px;
          cursor: pointer;
          font-size: 16px;
          font-weight: bold;
          transition: all 0.3s;
      }
      
      .tab-btn.active {
          background: #667eea;
          color: white;
      }
      
      .tab-content {
          display: none;
      }
      
      .tab-content.active {
          display: block;
      }
      
      .form-group {
          margin-bottom: 20px;
      }
      
      .form-group label {
          display: block;
          margin-bottom: 8px;
          color: #333;
          font-weight: bold;
          font-size: 14px;
      }
      
      .form-group input {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e0e0e0;
          border-radius: 10px;
          font-size: 16px;
          transition: all 0.3s;
      }
      
      .form-group input:focus {
          outline: none;
          border-color: #667eea;
      }
      
      .btn {
          width: 100%;
          padding: 15px;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s;
          margin-top: 10px;
      }
      
      .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
      }
      
      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      }
      
      .btn-line {
          background: #06C755;
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
      }
      
      .btn-line:hover {
          background: #05b34c;
          transform: translateY(-2px);
      }
      
      .btn-line:disabled {
          background: #ccc;
          cursor: not-allowed;
          transform: none;
      }
      
      .divider {
          text-align: center;
          margin: 25px 0;
          position: relative;
      }
      
      .divider::before {
          content: '';
          position: absolute;
          left: 0;
          top: 50%;
          width: 100%;
          height: 1px;
          background: #e0e0e0;
      }
      
      .divider span {
          background: white;
          padding: 0 15px;
          position: relative;
          color: #999;
          font-size: 14px;
      }
      
      .info-box {
          background: #f0f4ff;
          border-left: 4px solid #667eea;
          padding: 15px;
          border-radius: 5px;
          margin-bottom: 20px;
          font-size: 14px;
          color: #555;
      }
      
      .loading {
          display: none;
          text-align: center;
          padding: 20px;
      }
      
      .loading.active {
          display: block;
      }
      
      .spinner {
          border: 3px solid #f3f3f3;
          border-top: 3px solid #667eea;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
          margin: 0 auto;
      }
      
      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }
      
      .message {
          padding: 12px;
          border-radius: 8px;
          margin-bottom: 15px;
          display: none;
          font-size: 14px;
      }
      
      .message.success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }
      
      .message.error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }
      
      .message.active {
          display: block;
      }
      
      .debug-info {
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          border-radius: 5px;
          padding: 10px;
          margin-top: 15px;
          font-size: 12px;
          color: #6c757d;
          max-height: 150px;
          overflow-y: auto;
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>🎗️ 台灣帕金森病友協會</h1>
          <p>會員登入註冊系統</p>
      </div>
      
      <div class="content">
          <div id="loading" class="loading">
              <div class="spinner"></div>
              <p style="margin-top: 15px; color: #667eea;">處理中...</p>
          </div>
          
          <div id="mainContent">
              <div id="message" class="message"></div>
              
              <!-- LINE 登入區 -->
              <div id="lineLoginSection">
                  <button id="lineLoginBtn" class="btn btn-line" onclick="liffLogin()" disabled>
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                          <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                      </svg>
                      <span id="lineLoginText">初始化中...</span>
                  </button>
                  
                  <div class="divider">
                      <span>或</span>
                  </div>
              </div>
              
              <!-- 手動登入/註冊 -->
              <div class="tab-buttons">
                  <button class="tab-btn active" onclick="switchTab('login')">登入</button>
                  <button class="tab-btn" onclick="switchTab('register')">註冊</button>
              </div>
              
              <!-- 登入表單 -->
              <div id="loginTab" class="tab-content active">
                  <form onsubmit="handleLogin(event)">
                      <div class="form-group">
                          <label>電話號碼</label>
                          <input type="tel" id="loginPhone" placeholder="請輸入手機號碼" required>
                      </div>
                      <div class="form-group">
                          <label>密碼</label>
                          <input type="password" id="loginPassword" placeholder="請輸入密碼" required>
                      </div>
                      <button type="submit" class="btn btn-primary">登入</button>
                  </form>
              </div>
              
              <!-- 註冊表單 -->
              <div id="registerTab" class="tab-content">
                  <div class="info-box">
                      ℹ️ 如果您沒有 LINE 帳號，可以使用手機號碼註冊
                  </div>
                  <form onsubmit="handleRegister(event)">
                      <div class="form-group">
                          <label>真實姓名 *</label>
                          <input type="text" id="registerName" placeholder="請輸入真實姓名" required>
                      </div>
                      <div class="form-group">
                          <label>手機號碼 *</label>
                          <input type="tel" id="registerPhone" placeholder="請輸入手機號碼" required>
                      </div>
                      <div class="form-group">
                          <label>密碼 *</label>
                          <input type="password" id="registerPassword" placeholder="請設定密碼（至少6位）" required minlength="6">
                      </div>
                      <div class="form-group">
                          <label>確認密碼 *</label>
                          <input type="password" id="registerPasswordConfirm" placeholder="請再次輸入密碼" required>
                      </div>
                      <button type="submit" class="btn btn-primary">註冊</button>
                  </form>
              </div>
              
              <!-- Debug 資訊（開發時使用） -->
              <div id="debugInfo" class="debug-info" style="display: none;"></div>
          </div>
      </div>
  </div>

  <script>
      // ==================== 設定區 ====================
      const LIFF_ID = '2006634211-mPMGj3vZ'; // 您的 LIFF ID
      const GAS_URL = 'https://script.google.com/macros/s/AKfycby1MxHd60YY6tDG8NDnMN0QeLO0BrRhZ14UHr3z25ajAmDiKlWkUhnMY6UTR6sDvkj6_A/exec';
      
      let liffInitialized = false;
      let debugMode = true; // 開發時設為 true
      
      // Debug 日誌
      function debugLog(message, data = null) {
          if (debugMode) {
              console.log(message, data);
              const debugDiv = document.getElementById('debugInfo');
              if (debugDiv) {
                  debugDiv.style.display = 'block';
                  const time = new Date().toLocaleTimeString();
                  debugDiv.innerHTML += `<div>[${time}] ${message}</div>`;
                  if (data) {
                      debugDiv.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                  }
                  debugDiv.scrollTop = debugDiv.scrollHeight;
              }
          }
      }
      
      // ==================== LIFF 初始化 ====================
      window.onload = async function() {
          debugLog('頁面載入完成，開始初始化...');
          
          try {
              debugLog('開始初始化 LIFF...', { liffId: LIFF_ID });
              await liff.init({ liffId: LIFF_ID });
              liffInitialized = true;
              debugLog('LIFF 初始化成功');
              
              const lineLoginBtn = document.getElementById('lineLoginBtn');
              const lineLoginText = document.getElementById('lineLoginText');
              
              // 檢查是否在 LINE 中開啟
              if (liff.isInClient()) {
                  debugLog('在 LINE 應用程式中開啟');
                  lineLoginText.textContent = '使用 LINE 快速登入';
                  lineLoginBtn.disabled = false;
                  
                  // 如果已登入 LINE，自動處理
                  if (liff.isLoggedIn()) {
                      debugLog('已登入 LINE，自動執行登入流程');
                      await handleLiffLogin();
                  }
              } else {
                  debugLog('不在 LINE 應用程式中');
                  lineLoginText.textContent = '使用 LINE 登入';
                  lineLoginBtn.disabled = false;
              }
          } catch (error) {
              debugLog('LIFF 初始化失敗', error);
              console.error('LIFF initialization failed', error);
              
              const lineLoginBtn = document.getElementById('lineLoginBtn');
              const lineLoginText = document.getElementById('lineLoginText');
              lineLoginText.textContent = 'LINE 登入暫時無法使用';
              lineLoginBtn.disabled = true;
              
              showMessage('LINE 登入功能初始化失敗，請使用手動登入', 'error');
          }
      };
      
      // ==================== LINE 登入處理 ====================
      function liffLogin() {
          debugLog('執行 liffLogin()');
          
          if (!liffInitialized) {
              showMessage('LINE 登入功能尚未準備好', 'error');
              return;
          }
          
          if (!liff.isLoggedIn()) {
              debugLog('尚未登入，導向 LINE 登入頁面');
              liff.login();
          } else {
              debugLog('已登入，執行 handleLiffLogin');
              handleLiffLogin();
          }
      }
      
      async function handleLiffLogin() {
          debugLog('開始處理 LINE 登入...');
          showLoading(true);
          
          try {
              const profile = await liff.getProfile();
              const lineId = profile.userId;
              const lineName = profile.displayName;
              
              debugLog('取得 LINE 個人資料', { lineId, lineName });
              
              // 檢查是否為首次登入
              debugLog('發送 checkLineUser 請求到 GAS');
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  mode: 'cors',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'checkLineUser',
                      lineId: lineId
                  })
              });
              
              debugLog('收到 GAS 回應', { status: response.status });
              const result = await response.json();
              debugLog('解析回應資料', result);
              
              if (result.exists) {
                  // 已註冊，直接登入
                  showMessage('LINE 登入成功！歡迎回來 ' + result.name, 'success');
                  setTimeout(() => {
                      alert('登入成功！\n\n會員資料：\n姓名：' + result.name + '\nLINE ID：' + lineId);
                  }, 1000);
              } else {
                  // 首次登入，要求實名制登記
                  debugLog('首次登入，顯示註冊表單');
                  showFirstTimeRegistration(lineId, lineName);
              }
          } catch (error) {
              debugLog('LINE 登入錯誤', error);
              console.error('LINE login error:', error);
              showMessage('LINE 登入失敗：' + error.message, 'error');
          } finally {
              showLoading(false);
          }
      }
      
      // ==================== 首次 LINE 登入註冊 ====================
      function showFirstTimeRegistration(lineId, lineName) {
          const content = document.getElementById('mainContent');
          content.innerHTML = `
              <div class="info-box">
                  ✨ 歡迎使用 LINE 登入！<br>
                  首次登入需要完成實名制登記
              </div>
              <form onsubmit="handleLineFirstRegister(event, '${lineId}', '${lineName}')">
                  <div class="form-group">
                      <label>LINE 名稱</label>
                      <input type="text" value="${lineName}" disabled>
                  </div>
                  <div class="form-group">
                      <label>真實姓名 *</label>
                      <input type="text" id="lineRegisterName" placeholder="請輸入真實姓名" required>
                  </div>
                  <div class="form-group">
                      <label>手機號碼 *</label>
                      <input type="tel" id="lineRegisterPhone" placeholder="請輸入手機號碼" required>
                  </div>
                  <button type="submit" class="btn btn-primary">完成註冊</button>
              </form>
              <div id="debugInfo" class="debug-info" style="display: ${debugMode ? 'block' : 'none'};"></div>
          `;
      }
      
      async function handleLineFirstRegister(event, lineId, lineName) {
          event.preventDefault();
          debugLog('處理 LINE 首次註冊');
          showLoading(true);
          
          const name = document.getElementById('lineRegisterName').value;
          const phone = document.getElementById('lineRegisterPhone').value;
          
          try {
              debugLog('發送註冊請求', { lineId, lineName, name, phone });
              
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  mode: 'cors',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'registerLineUser',
                      lineId: lineId,
                      lineName: lineName,
                      name: name,
                      phone: phone
                  })
              });
              
              const result = await response.json();
              debugLog('註冊回應', result);
              
              if (result.success) {
                  showMessage('註冊成功！歡迎加入帕金森病友協會', 'success');
                  setTimeout(() => {
                      location.reload();
                  }, 2000);
              } else {
                  showMessage(result.message || '註冊失敗，請稍後再試', 'error');
              }
          } catch (error) {
              debugLog('註冊錯誤', error);
              console.error('Registration error:', error);
              showMessage('註冊失敗：' + error.message, 'error');
          } finally {
              showLoading(false);
          }
      }
      
      // ==================== 手動登入 ====================
      async function handleLogin(event) {
          event.preventDefault();
          debugLog('處理手動登入');
          showLoading(true);
          
          const phone = document.getElementById('loginPhone').value;
          const password = document.getElementById('loginPassword').value;
          
          try {
              debugLog('發送登入請求', { phone });
              
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  mode: 'cors',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'manualLogin',
                      phone: phone,
                      password: password
                  })
                });
                
                const result = await response.json();
                debugLog('登入回應', result);
                
                if (result.success) {
                    showMessage('登入成功！歡迎 ' + result.name, 'success');
                    setTimeout(() => {
                        alert('登入成功！\n\n會員資料：\n姓名：' + result.name + '\n電話：' + phone);
                    }, 1000);
                } else {
                    showMessage(result.message || '登入失敗，請檢查電話和密碼', 'error');
                }
            } catch (error) {
                debugLog('登入錯誤', error);
                console.error('Login error:', error);
                showMessage('登入失敗：' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ==================== 手動註冊 ====================
        async function handleRegister(event) {
            event.preventDefault();
            debugLog('處理手動註冊');
            showLoading(true);
            
            const name = document.getElementById('registerName').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            
            if (password !== passwordConfirm) {
                showMessage('兩次輸入的密碼不一致', 'error');
                showLoading(false);
                return;
            }
            
            try {
                debugLog('發送註冊請求', { name, phone });
                
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'manualRegister',
                        name: name,
                        phone: phone,
                        password: password
                    })
                });
                
                const result = await response.json();
                debugLog('註冊回應', result);
                
                if (result.success) {
                    showMessage('註冊成功！請使用電話號碼登入', 'success');
                    setTimeout(() => {
                        switchTab('login');
                        document.getElementById('loginPhone').value = phone;
                    }, 2000);
                } else {
                    showMessage(result.message || '註冊失敗，請稍後再試', 'error');
                }
            } catch (error) {
                debugLog('註冊錯誤', error);
                console.error('Registration error:', error);
                showMessage('註冊失敗：' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ==================== UI 控制函數 ====================
        function switchTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const tabButtons = document.querySelectorAll('.tab-btn');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                tabButtons[0].classList.add('active');
                tabButtons[1].classList.remove('active');
            } else {
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                tabButtons[0].classList.remove('active');
                tabButtons[1].classList.add('active');
            }
        }
        
        function showLoading(show) {
            const loading = document.getElementById('loading');
            const mainContent = document.getElementById('mainContent');
            
            if (show) {
                loading.classList.add('active');
                mainContent.style.display = 'none';
            } else {
                loading.classList.remove('active');
                mainContent.style.display = 'block';
            }
        }
        
        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = 'message ' + type + ' active';
            
            setTimeout(() => {
                message.classList.remove('active');
            }, 5000);
        }
    </script>
</body>
</html>
