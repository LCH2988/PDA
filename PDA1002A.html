<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</title>

<!-- ç›´æ¥è¼‰å…¥ LIFF SDK -->
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

<style>
:root {
  --primary: #06c755;
  --primary-dark: #05b04b;
  --secondary: #00b900;
  --danger: #dc3545;
  --warning: #ffc107;
  --info: #17a2b8;
  --light: #f8f9fa;
  --dark: #343a40;
  --border-radius: 12px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding-bottom: 80px;
}

.app-container {
  max-width: 480px;
  margin: 0 auto;
  background: white;
  min-height: 100vh;
  box-shadow: 0 0 30px rgba(0,0,0,0.1);
}

/* ==================== é ‚éƒ¨å°èˆª ==================== */
.top-bar {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.top-bar h1 {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid white;
}

.user-name {
  font-size: 14px;
  font-weight: 500;
}

/* ==================== åº•éƒ¨å°èˆª ==================== */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  border-top: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-around;
  padding: 8px 0;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
  z-index: 1000;
  max-width: 480px;
  margin: 0 auto;
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 8px;
  color: #666;
  text-decoration: none;
  transition: all 0.3s;
  cursor: pointer;
  border: none;
  background: none;
}

.nav-item i {
  font-size: 22px;
}

.nav-item span {
  font-size: 11px;
}

.nav-item.active {
  color: var(--primary);
}

.nav-item:hover {
  color: var(--primary);
  background: rgba(6, 199, 85, 0.05);
}

/* ==================== é é¢å…§å®¹ ==================== */
.page-content {
  display: none;
  padding: 20px;
  animation: fadeIn 0.3s;
}

.page-content.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ==================== å¡ç‰‡æ¨£å¼ ==================== */
.card {
  border: none;
  border-radius: var(--border-radius);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 20px;
  overflow: hidden;
}

.card-header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  font-weight: 600;
  padding: 15px 20px;
  border: none;
}

.card-body {
  padding: 20px;
}

/* ==================== çµ±è¨ˆå¡ç‰‡ ==================== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin-bottom: 20px;
}

.stat-card {
  background: white;
  border-radius: var(--border-radius);
  padding: 20px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: transform 0.3s, box-shadow 0.3s;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.stat-icon {
  font-size: 32px;
  margin-bottom: 10px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stat-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--dark);
  margin: 5px 0;
}

.stat-label {
  font-size: 13px;
  color: #666;
}

/* ==================== æ´»å‹•é …ç›® ==================== */
.activity-item {
  background: white;
  border-radius: var(--border-radius);
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: transform 0.3s, box-shadow 0.3s;
}

.activity-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.activity-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 8px;
}

.activity-info {
  font-size: 14px;
  color: #666;
  margin-bottom: 10px;
}

.activity-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  font-size: 13px;
  color: #888;
}

.activity-meta span {
  display: flex;
  align-items: center;
  gap: 4px;
}

.activity-meta i {
  font-size: 14px;
}

/* ==================== ç‹€æ…‹æ¨™ç±¤ ==================== */
.status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
}

.status-é–‹æ”¾å ±å {
  background: #d4edda;
  color: #155724;
}

.status-å·²å ±å {
  background: #cce5ff;
  color: #004085;
}

.status-å·²é¡æ»¿ {
  background: #f8d7da;
  color: #721c24;
}

.status-å·²çµæŸ {
  background: #e2e3e5;
  color: #383d41;
}

.status-å¾…å¯©æ ¸ {
  background: #fff3cd;
  color: #856404;
}

.status-å·²æ ¸å‡† {
  background: #d4edda;
  color: #155724;
}

.status-å·²æ‹’çµ• {
  background: #f8d7da;
  color: #721c24;
}

/* ==================== æŒ‰éˆ•æ¨£å¼ ==================== */
.btn-gradient {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 25px;
  font-weight: 600;
  transition: all 0.3s;
  box-shadow: 0 4px 10px rgba(6, 199, 85, 0.3);
}

.btn-gradient:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(6, 199, 85, 0.4);
  color: white;
}

.btn-gradient:active {
  transform: translateY(0);
}

.fab-button {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  border: none;
  font-size: 24px;
  box-shadow: 0 4px 12px rgba(6, 199, 85, 0.4);
  cursor: pointer;
  transition: all 0.3s;
  z-index: 999;
}

.fab-button:hover {
  transform: scale(1.1) rotate(90deg);
  box-shadow: 0 6px 16px rgba(6, 199, 85, 0.5);
}

/* ==================== è¡¨å–®æ¨£å¼ ==================== */
.form-floating > label {
  color: #666;
}

.form-control:focus,
.form-select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 0.2rem rgba(6, 199, 85, 0.25);
}

/* ==================== ç©ºç‹€æ…‹ ==================== */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #999;
}

.empty-state i {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0.5;
}

.empty-state p {
  font-size: 14px;
  margin: 0;
}

/* ==================== è¼‰å…¥å‹•ç•« ==================== */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ==================== Toast é€šçŸ¥ ==================== */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
}

/* ==================== ç®¡ç†å“¡å°ˆç”¨ ==================== */
.admin-only {
  display: none;
}

/* ==================== è¡¨æ ¼æ¨£å¼ ==================== */
.table-responsive {
  border-radius: var(--border-radius);
  overflow: hidden;
}

.table {
  margin-bottom: 0;
}

.table thead {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
}

.table tbody tr:hover {
  background: rgba(6, 199, 85, 0.05);
}

/* ==================== éŸ¿æ‡‰å¼è¨­è¨ˆ ==================== */
@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .activity-meta {
    flex-direction: column;
    gap: 5px;
  }
}
</style>
</head>
<body>

<div class="app-container">
  <!-- é ‚éƒ¨å°èˆª -->
  <div class="top-bar">
    <h1><i class="bi bi-heart-pulse me-2"></i>å¸•é‡‘æ£®ç—…å‹æœƒ</h1>
    <div class="user-info">
      <img id="userAvatar" class="user-avatar" src="https://via.placeholder.com/36" alt="é ­åƒ">
      <span id="userName" class="user-name">è¼‰å…¥ä¸­...</span>
    </div>
  </div>

  <!-- ==================== é¦–é  ==================== -->
  <div id="page-home" class="page-content active">
    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-calendar-event"></i></div>
        <div class="stat-value" id="statActivities">0</div>
        <div class="stat-label">æ´»å‹•ç¸½æ•¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
        <div class="stat-value" id="statRegistrations">0</div>
        <div class="stat-label">æˆ‘çš„å ±å</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
        <div class="stat-value" id="statVolunteerHours">0</div>
        <div class="stat-label">å¿—å·¥æ™‚æ•¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-heart"></i></div>
        <div class="stat-value" id="statDonations">0</div>
        <div class="stat-label">ææ¬¾é‡‘é¡</div>
      </div>
    </div>

    <!-- æœ€æ–°æ´»å‹• -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-calendar-event me-2"></i>æœ€æ–°æ´»å‹•
      </div>
      <div class="card-body">
        <div id="recentActivities">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== æ´»å‹•é é¢ ==================== -->
  <div id="page-activities" class="page-content">
    <!-- é–‹æ”¾å ±åæ´»å‹• -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-calendar-plus me-2"></i>é–‹æ”¾å ±å
      </div>
      <div class="card-body">
        <div id="activitiesList">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- æˆ‘çš„å ±å -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-list-check me-2"></i>æˆ‘çš„å ±å
      </div>
      <div class="card-body">
        <div id="myRegistrationsList">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== å¿—å·¥é é¢ ==================== -->
  <div id="page-volunteer" class="page-content">
    <!-- å¿—å·¥çµ±è¨ˆ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
        <div class="stat-value" id="volTotalHours">0</div>
        <div class="stat-label">ç´¯è¨ˆæ™‚æ•¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
        <div class="stat-value" id="volTotalActivities">0</div>
        <div class="stat-label">æœå‹™æ¬¡æ•¸</div>
      </div>
    </div>

    <!-- å¿—å·¥éœ€æ±‚ -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-people me-2"></i>å¿—å·¥éœ€æ±‚
      </div>
      <div class="card-body">
        <div id="volunteerNeedsList">
          <div class="empty-state">
            <i class="bi bi-people"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- æˆ‘çš„å¿—å·¥è¨˜éŒ„ -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-journal-text me-2"></i>æˆ‘çš„è¨˜éŒ„
      </div>
      <div class="card-body">
        <div id="myVolunteerRecords">
          <div class="empty-state">
            <i class="bi bi-journal-x"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== è²¡å‹™é é¢ ==================== -->
  <div id="page-finance" class="page-content">
    <!-- è²¡å‹™çµ±è¨ˆ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-heart"></i></div>
        <div class="stat-value" id="finTotalDonation">0</div>
        <div class="stat-label">ç´¯è¨ˆææ¬¾</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-receipt"></i></div>
        <div class="stat-value" id="finPendingExpenses">0</div>
        <div class="stat-label">å¾…å¯©æ ¸æ”¯å‡º</div>
      </div>
    </div>

    <!-- å¿«é€Ÿæ“ä½œ -->
    <div class="d-grid gap-2 mb-3">
      <button class="btn btn-gradient" onclick="showDonationModal()">
        <i class="bi bi-heart-fill me-2"></i>æˆ‘è¦ææ¬¾
      </button>
      <button class="btn btn-outline-primary" onclick="showNewExpenseModal()">
        <i class="bi bi-receipt me-2"></i>æ”¯å‡ºç”³è«‹
      </button>
    </div>

    <!-- æˆ‘çš„ææ¬¾è¨˜éŒ„ -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-heart me-2"></i>æˆ‘çš„ææ¬¾
      </div>
      <div class="card-body">
        <div id="myDonationsList">
          <div class="empty-state">
            <i class="bi bi-heart"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- æˆ‘çš„æ”¯å‡ºç”³è«‹ -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-receipt me-2"></i>æˆ‘çš„æ”¯å‡º
      </div>
      <div class="card-body">
        <div id="myExpensesList">
          <div class="empty-state">
            <i class="bi bi-receipt"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== å€‹äººé é¢ ==================== -->
  <div id="page-profile" class="page-content">
    <!-- å€‹äººè³‡æ–™ -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-person me-2"></i>å€‹äººè³‡æ–™
      </div>
      <div class="card-body">
        <form id="profileForm">
          <div class="form-floating mb-3">
            <input type="text" class="form-control" name="profileRealName" required>
            <label>çœŸå¯¦å§“å *</label>
          </div>
          <div class="form-floating mb-3">
            <select class="form-select" name="profileMemberType" required>
              <option value="">è«‹é¸æ“‡</option>
              <option value="ç—…å‹">ç—…å‹</option>
              <option value="å®¶å±¬">å®¶å±¬</option>
              <option value="å¿—å·¥">å¿—å·¥</option>
            </select>
            <label>æœƒå“¡é¡å‹ *</label>
          </div>
          <div class="form-floating mb-3">
            <input type="tel" class="form-control" name="profilePhone">
            <label>è¯çµ¡é›»è©±</label>
          </div>
          <div class="form-floating mb-3">
            <input type="email" class="form-control" name="profileEmail">
            <label>é›»å­éƒµä»¶</label>
          </div>
          <div class="form-floating mb-3">
            <input type="date" class="form-control" name="profileBirthday">
            <label>ç”Ÿæ—¥</label>
          </div>
          <div class="form-floating mb-3">
            <input type="date" class="form-control" name="profileDiagnosisDate">
            <label>ç¢ºè¨ºæ—¥æœŸ</label>
          </div>
          <div class="form-floating mb-3">
            <textarea class="form-control" name="profileAddress" style="height:80px;"></textarea>
            <label>åœ°å€</label>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-gradient">
              <i class="bi bi-save me-2"></i>å„²å­˜è®Šæ›´
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- æˆ‘çš„æ”¶æ“š -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-file-earmark-text me-2"></i>æˆ‘çš„æ”¶æ“š
      </div>
      <div class="card-body">
        <div id="myReceiptsList">
          <div class="empty-state">
            <i class="bi bi-file-earmark-text"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- æœƒå“¡è³‡è¨Š -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-info-circle me-2"></i>æœƒå“¡è³‡è¨Š
      </div>
      <div class="card-body">
        <p><strong>æœƒå“¡é¡å‹ï¼š</strong><span id="userMemberType">-</span></p>
        <p><strong>LINE IDï¼š</strong><span id="userLineId">-</span></p>
        <p class="mb-0"><strong>ç‰ˆæœ¬ï¼š</strong>v1.0.0</p>
      </div>
    </div>
  </div>

  <!-- ==================== ç®¡ç†é é¢ ==================== -->
  <div id="page-admin" class="page-content admin-only">
    <!-- ç®¡ç†åŠŸèƒ½ -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-gear me-2"></i>ç®¡ç†åŠŸèƒ½
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <button class="btn btn-outline-primary" onclick="showNewActivityModal()">
            <i class="bi bi-calendar-plus me-2"></i>æ–°å¢æ´»å‹•
          </button>
          <button class="btn btn-outline-success" onclick="showNewVolunteerNeedModal()">
            <i class="bi bi-people me-2"></i>æ–°å¢å¿—å·¥éœ€æ±‚
          </button>
          <button class="btn btn-outline-info" onclick="exportMembers()">
            <i class="bi bi-download me-2"></i>åŒ¯å‡ºæœƒå“¡è³‡æ–™
          </button>
          <button class="btn btn-outline-warning" onclick="exportFinanceData()">
            <i class="bi bi-file-earmark-spreadsheet me-2"></i>åŒ¯å‡ºè²¡å‹™å ±è¡¨
          </button>
          <button class="btn btn-outline-secondary" onclick="backupSystem()">
            <i class="bi bi-cloud-upload me-2"></i>ç³»çµ±å‚™ä»½
          </button>
        </div>
      </div>
    </div>

    <!-- æœƒå“¡ç®¡ç† -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-people me-2"></i>æœƒå“¡ç®¡ç†
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>å§“å</th>
                <th>é¡å‹</th>
                <th>ç‹€æ…‹</th>
                <th>åŠ å…¥æ—¥æœŸ</th>
                <th>ææ¬¾</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="memberList">
              <tr><td colspan="6" class="text-center">è¼‰å…¥ä¸­...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- æ´»å‹•ç®¡ç† -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-calendar-event me-2"></i>æ´»å‹•ç®¡ç†
      </div>
      <div class="card-body">
        <div id="adminActivityList">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- è²¡å‹™ç®¡ç† -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-cash-stack me-2"></i>è²¡å‹™ç®¡ç†
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>é¡å‹</th>
                <th>é‡‘é¡</th>
                <th>é¡åˆ¥</th>
                <th>èªªæ˜</th>
                <th>ç‹€æ…‹</th>
              </tr>
            </thead>
            <tbody id="transactionList">
              <tr><td colspan="6" class="text-center">è¼‰å…¥ä¸­...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- æ”¶æ“šç®¡ç† -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-file-earmark-text me-2"></i>æ”¶æ“šç®¡ç†
      </div>
      <div class="card-body">
        <div id="receiptList">
          <div class="empty-state">
            <i class="bi bi-file-earmark-text"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨å°èˆª -->
  <div class="bottom-nav">
    <button class="nav-item active" onclick="switchPage('home')">
      <i class="bi bi-house-door-fill"></i>
      <span>é¦–é </span>
    </button>
    <button class="nav-item" onclick="switchPage('activities')">
      <i class="bi bi-calendar-event"></i>
      <span>æ´»å‹•</span>
    </button>
    <button class="nav-item" onclick="switchPage('volunteer')">
      <i class="bi bi-people"></i>
      <span>å¿—å·¥</span>
    </button>
    <button class="nav-item" onclick="switchPage('finance')">
      <i class="bi bi-wallet2"></i>
      <span>è²¡å‹™</span>
    </button>
    <button class="nav-item" onclick="switchPage('profile')">
      <i class="bi bi-person"></i>
      <span>æˆ‘çš„</span>
    </button>
    <button class="nav-item admin-only" onclick="switchPage('admin')">
      <i class="bi bi-gear"></i>
      <span>ç®¡ç†</span>
    </button>
  </div>
</div>

<!-- Toast å®¹å™¨ -->
<div id="toastContainer" class="toast-container"></div>

<!-- Modal å®¹å™¨ -->
<div id="modalContainer"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ==================== å…¨åŸŸè®Šæ•¸ ====================
const LIFF_ID = '1656516134-VaGgmaPm';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbznG2VbFZ7mA5y5SdhHGme_inTsI_1p8BA0zW_UPyMcGX3dtNwRtLpm-eFSupLXkivx/exec';

let userProfile = null;
let isAdmin = false;
let cachedAdminData = null;

// ==================== LIFF SDK è¼‰å…¥æª¢æŸ¥ ====================
function loadLiffSDK() {
  return new Promise((resolve, reject) => {
    console.log('ğŸ”„ æª¢æŸ¥ LIFF SDK...');
    
    let checkCount = 0;
    const maxChecks = 50; // 5ç§’
    
    const checkLiff = () => {
      checkCount++;
      console.log(`ğŸ” æª¢æŸ¥ LIFF ç‰©ä»¶ (${checkCount}/${maxChecks})...`);
      
      if (typeof liff !== 'undefined') {
        console.log('âœ… LIFF SDK å¯ç”¨');
        resolve();
        return;
      }
      
      if (checkCount >= maxChecks) {
        console.error('âŒ LIFF SDK æœªè¼‰å…¥');
        reject(new Error('LIFF SDK æœªè¼‰å…¥ï¼Œè«‹ç¢ºèªåœ¨ LINE ä¸­é–‹å•Ÿ'));
        return;
      }
      
      setTimeout(checkLiff, 100);
    };
    
    checkLiff();
  });
}

// ==================== LIFF åˆå§‹åŒ– ====================
async function initLIFF() {
  console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ– LIFF...');
  
  try {
    // ç­‰å¾… LIFF SDK è¼‰å…¥
    await loadLiffSDK();
    
    // åˆå§‹åŒ– LIFF
    console.log('ğŸ”§ åˆå§‹åŒ– LIFFï¼ŒID:', LIFF_ID);
    await liff.init({ liffId: LIFF_ID });
    console.log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ');
    
    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    if (!liff.isLoggedIn()) {
      console.log('âš ï¸ æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
      liff.login();
      return;
    }
    
    console.log('âœ… å·²ç™»å…¥');
    
    // å–å¾—ä½¿ç”¨è€…è³‡æ–™
    userProfile = await liff.getProfile();
    console.log('ğŸ‘¤ ä½¿ç”¨è€…è³‡æ–™:', userProfile);
    
    // æ›´æ–° UI
    document.getElementById('userAvatar').src = userProfile.pictureUrl || 'https://via.placeholder.com/36';
    document.getElementById('userName').textContent = userProfile.displayName;
    document.getElementById('userLineId').textContent = userProfile.userId;
    
    // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
    await checkAdminStatus();
    
    // è¼‰å…¥è³‡æ–™
    await loadAllData();
    
    console.log('ğŸ‰ ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
    
  } catch (error) {
    console.error('âŒ LIFFåˆå§‹åŒ–å¤±æ•—:', error);
    showErrorPage(error);
  }
}

// ==================== éŒ¯èª¤é é¢ ====================
function showErrorPage(error) {
  document.querySelector('.app-container').innerHTML = `
    <div style="padding: 40px 20px; text-align: center;">
      <i class="bi bi-exclamation-triangle" style="font-size: 64px; color: #dc3545;"></i>
      <h3 style="margin-top: 20px;">ç³»çµ±åˆå§‹åŒ–å¤±æ•—</h3>
      <p style="color: #666; margin: 20px 0;">${error.message}</p>
      <button class="btn btn-gradient" onclick="location.reload()">
        <i class="bi bi-arrow-clockwise me-2"></i>é‡æ–°è¼‰å…¥
      </button>
      <button class="btn btn-outline-secondary mt-2" onclick="showDebugInfo()">
        <i class="bi bi-bug me-2"></i>é¡¯ç¤ºé™¤éŒ¯è³‡è¨Š
      </button>
    </div>`;
}

function showDebugInfo() {
  const info = `
é™¤éŒ¯è³‡è¨Šï¼š
- User Agent: ${navigator.userAgent}
- URL: ${window.location.href}
- LIFF å¯ç”¨: ${typeof liff !== 'undefined'}
- éŒ¯èª¤: ${error.message}
  `;
  alert(info);
}

// ==================== æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™ ====================
async function checkAdminStatus() {
  try {
    const response = await callAPI('checkAdmin', { lineId: userProfile.userId });
    isAdmin = response.data.isAdmin;
    
    if (isAdmin) {
      console.log('ğŸ‘‘ ç®¡ç†å“¡æ¬Šé™ç¢ºèª');
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
    }
  } catch (error) {
    console.error('æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™å¤±æ•—:', error);
  }
}

// ==================== API å‘¼å« ====================
async function callAPI(action, data = {}) {
  try {
    const response = await fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ action, ...data })
    });
    
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.message || 'æ“ä½œå¤±æ•—');
    }
    
    return result;
  } catch (error) {
    console.error('API å‘¼å«å¤±æ•—:', error);
    throw error;
  }
}

// ==================== è¼‰å…¥æ‰€æœ‰è³‡æ–™ ====================
async function loadAllData() {
  showLoading(true);
  try {
    await Promise.all([
      loadHomeData(),
      loadActivities(),
      loadVolunteerData(),
      loadFinanceData(),
      loadProfileData()
    ]);
    
    if (isAdmin) {
      await loadAdminData();
    }
  } catch (error) {
    console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
    showNotification('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== è¼‰å…¥é¦–é è³‡æ–™ ====================
async function loadHomeData() {
  try {
    const response = await callAPI('getHomeStats', { lineId: userProfile.userId });
    const stats = response.data;
    
    document.getElementById('statActivities').textContent = stats.totalActivities || 0;
    document.getElementById('statRegistrations').textContent = stats.myRegistrations || 0;
    document.getElementById('statVolunteerHours').textContent = stats.volunteerHours || 0;
    document.getElementById('statDonations').textContent = formatCurrency(stats.totalDonations || 0);
    
    // è¼‰å…¥æœ€æ–°æ´»å‹•
    const activitiesResponse = await callAPI('getRecentActivities', { lineId: userProfile.userId });
    renderRecentActivities(activitiesResponse.data.activities || []);
  } catch (error) {
    console.error('è¼‰å…¥é¦–é è³‡æ–™å¤±æ•—:', error);
  }
}

function renderRecentActivities(activities) {
  const container = document.getElementById('recentActivities');
  
  if (activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>ç›®å‰æ²’æœ‰æ´»å‹•</p></div>';
    return;
  }
  
  container.innerHTML = activities.slice(0, 3).map(activity => `
    <div class="activity-item">
      <div class="activity-title">${activity.title}</div>
      <div class="activity-info">${activity.description || ''}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(activity.date)}</span>
        <span><i class="bi bi-geo-alt"></i>${activity.location || 'æœªæŒ‡å®š'}</span>
        <span><i class="bi bi-people"></i>${activity.currentParticipants || 0}/${activity.maxParticipants}</span>
      </div>
      <button class="btn btn-sm btn-gradient mt-2" onclick="registerActivity('${activity.id}')">
        <i class="bi bi-check-circle me-1"></i>ç«‹å³å ±å
      </button>
    </div>
  `).join('');
}

// ==================== è¼‰å…¥æ´»å‹•è³‡æ–™ ====================
async function loadActivities() {
  try {
    const response = await callAPI('getActivities', { lineId: userProfile.userId });
    const activities = response.data.activities || [];
    
    // é–‹æ”¾å ±åçš„æ´»å‹•
    const openActivities = activities.filter(a => a.status === 'é–‹æ”¾å ±å');
    renderActivitiesList(openActivities);
    
    // æˆ‘çš„å ±å
    const myRegistrations = response.data.myRegistrations || [];
    renderMyRegistrations(myRegistrations);
  } catch (error) {
    console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', error);
  }
}

function renderActivitiesList(activities) {
  const container = document.getElementById('activitiesList');
  
  if (activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>ç›®å‰æ²’æœ‰é–‹æ”¾å ±åçš„æ´»å‹•</p></div>';
    return;
  }
  
  container.innerHTML = activities.map(activity => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${activity.title}</div>
        <span class="status-badge status-${activity.status}">${activity.status}</span>
      </div>
      <div class="activity-info">${activity.description || ''}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(activity.date)} ${activity.time || ''}</span>
        <span><i class="bi bi-geo-alt"></i>${activity.location || 'æœªæŒ‡å®š'}</span>
        <span><i class="bi bi-people"></i>${activity.currentParticipants || 0}/${activity.maxParticipants}</span>
        ${activity.fee ? `<span><i class="bi bi-cash"></i>$${formatCurrency(activity.fee)}</span>` : ''}
      </div>
      <button class="btn btn-sm btn-gradient mt-2" onclick="registerActivity('${activity.id}')">
        <i class="bi bi-check-circle me-1"></i>æˆ‘è¦å ±å
      </button>
    </div>
  `).join('');
}

function renderMyRegistrations(registrations) {
  const container = document.getElementById('myRegistrationsList');
  
  if (registrations.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>æ‚¨é‚„æ²’æœ‰å ±åä»»ä½•æ´»å‹•</p></div>';
    return;
  }
  
  container.innerHTML = registrations.map(reg => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${reg.activityTitle}</div>
        <span class="status-badge status-${reg.status}">${reg.status}</span>
      </div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(reg.activityDate)}</span>
        <span><i class="bi bi-clock"></i>å ±åæ™‚é–“ï¼š${formatDate(reg.registrationDate)}</span>
      </div>
      ${reg.status === 'å·²å ±å' ? `
        <button class="btn btn-sm btn-outline-danger mt-2" onclick="cancelRegistration('${reg.id}')">
          <i class="bi bi-x-circle me-1"></i>å–æ¶ˆå ±å
        </button>
      ` : ''}
    </div>
  `).join('');
}

async function registerActivity(activityId) {
  if (!confirm('ç¢ºå®šè¦å ±åæ­¤æ´»å‹•å—ï¼Ÿ')) return;
  
  try {
    showLoading(true);
    await callAPI('registerActivity', {
      lineId: userProfile.userId,
      activityId: activityId
    });
    showNotification('å ±åæˆåŠŸï¼', 'success');
    await loadActivities();
    await loadHomeData();
  } catch (error) {
    showNotification('å ±åå¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

async function cancelRegistration(registrationId) {
  if (!confirm('ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ')) return;
  
  try {
    showLoading(true);
    await callAPI('cancelRegistration', {
      lineId: userProfile.userId,
      registrationId: registrationId
    });
    showNotification('å·²å–æ¶ˆå ±å', 'success');
    await loadActivities();
    await loadHomeData();
  } catch (error) {
    showNotification('å–æ¶ˆå¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== è¼‰å…¥å¿—å·¥è³‡æ–™ ====================
async function loadVolunteerData() {
  try {
    const response = await callAPI('getVolunteerData', { lineId: userProfile.userId });
    const data = response.data;
    
    // æ›´æ–°çµ±è¨ˆ
    document.getElementById('volTotalHours').textContent = data.totalHours || 0;
    document.getElementById('volTotalActivities').textContent = data.totalActivities || 0;
    
    // å¿—å·¥éœ€æ±‚
    renderVolunteerNeeds(data.needs || []);
    
    // æˆ‘çš„è¨˜éŒ„
    renderMyVolunteerRecords(data.myRecords || []);
  } catch (error) {
    console.error('è¼‰å…¥å¿—å·¥è³‡æ–™å¤±æ•—:', error);
  }
}

function renderVolunteerNeeds(needs) {
  const container = document.getElementById('volunteerNeedsList');
  
  if (needs.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-people"></i><p>ç›®å‰æ²’æœ‰å¿—å·¥éœ€æ±‚</p></div>';
    return;
  }
  
  container.innerHTML = needs.map(need => `
    <div class="activity-item">
      <div class="activity-title">${need.title}</div>
      <div class="activity-info">${need.description || ''}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(need.date)} ${need.time || ''}</span>
        <span><i class="bi bi-people"></i>éœ€æ±‚ï¼š${need.needCount}äºº</span>
        <span><i class="bi bi-clock"></i>æ™‚æ•¸ï¼š${need.hours}å°æ™‚</span>
        <span><i class="bi bi-check-circle"></i>å·²å ±åï¼š${need.currentCount || 0}äºº</span>
      </div>
      <button class="btn btn-sm btn-gradient mt-2" onclick="applyVolunteer('${need.id}')">
        <i class="bi bi-hand-thumbs-up me-1"></i>æˆ‘è¦å ±å
      </button>
    </div>
  `).join('');
}

function renderMyVolunteerRecords(records) {
  const container = document.getElementById('myVolunteerRecords');
  
  if (records.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-journal-x"></i><p>æ‚¨é‚„æ²’æœ‰å¿—å·¥æœå‹™è¨˜éŒ„</p></div>';
    return;
  }
  
  container.innerHTML = records.map(record => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${record.title}</div>
        <span class="status-badge status-${record.status}">${record.status}</span>
      </div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(record.date)}</span>
        <span><i class="bi bi-clock"></i>${record.hours}å°æ™‚</span>
      </div>
    </div>
  `).join('');
}

async function applyVolunteer(needId) {
  if (!confirm('ç¢ºå®šè¦å ±åæ­¤å¿—å·¥æœå‹™å—ï¼Ÿ')) return;
  
  try {
    showLoading(true);
    await callAPI('applyVolunteer', {
      lineId: userProfile.userId,
      needId: needId
    });
    showNotification('å ±åæˆåŠŸï¼', 'success');
    await loadVolunteerData();
  } catch (error) {
    showNotification('å ±åå¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== è¼‰å…¥è²¡å‹™è³‡æ–™ ====================
async function loadFinanceData() {
  try {
    const response = await callAPI('getFinanceData', { lineId: userProfile.userId });
    const data = response.data;
    
    // æ›´æ–°çµ±è¨ˆ
    document.getElementById('finTotalDonation').textContent = formatCurrency(data.totalDonation || 0);
    document.getElementById('finPendingExpenses').textContent = data.pendingExpenses || 0;
    
    // æˆ‘çš„ææ¬¾
    renderMyDonations(data.myDonations || []);
    
    // æˆ‘çš„æ”¯å‡º
    renderMyExpenses(data.myExpenses || []);
  } catch (error) {
    console.error('è¼‰å…¥è²¡å‹™è³‡æ–™å¤±æ•—:', error);
  }
}

function renderMyDonations(donations) {
  const container = document.getElementById('myDonationsList');
  
  if (donations.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-heart"></i><p>æ‚¨é‚„æ²’æœ‰ææ¬¾è¨˜éŒ„</p></div>';
    return;
  }
  
  container.innerHTML = donations.map(donation => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="activity-title">ææ¬¾ $${formatCurrency(donation.amount)}</div>
          <div class="activity-info">${donation.purpose || 'ä¸€èˆ¬ææ¬¾'}</div>
          <div class="activity-meta">
            <span><i class="bi bi-calendar"></i>${formatDate(donation.date)}</span>
            <span><i class="bi bi-credit-card"></i>${donation.paymentMethod}</span>
          </div>
        </div>
        ${donation.receiptUrl ? `
          <button class="btn btn-sm btn-outline-primary" onclick="window.open('${donation.receiptUrl}', '_blank')">
            <i class="bi bi-file-earmark-pdf"></i>æ”¶æ“š
          </button>
        ` : ''}
      </div>
    </div>
  `).join('');
}

function renderMyExpenses(expenses) {
  const container = document.getElementById('myExpensesList');
  
  if (expenses.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-receipt"></i><p>æ‚¨é‚„æ²’æœ‰æ”¯å‡ºç”³è«‹</p></div>';
    return;
  }
  
  container.innerHTML = expenses.map(expense => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">$${formatCurrency(expense.amount)}</div>
        <span class="status-badge status-${expense.status}">${expense.status}</span>
      </div>
      <div class="activity-info">${expense.description}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(expense.date)}</span>
        <span><i class="bi bi-tag"></i>${expense.category}</span>
      </div>
    </div>
  `).join('');
}

// ==================== è¼‰å…¥å€‹äººè³‡æ–™ ====================
async function loadProfileData() {
  try {
    const response = await callAPI('getProfile', { lineId: userProfile.userId });
    const profile = response.data;
    
    // å¡«å……è¡¨å–®
    const form = document.getElementById('profileForm');
    form.elements.profileRealName.value = profile.realName || '';
    form.elements.profileMemberType.value = profile.memberType || '';
    form.elements.profilePhone.value = profile.phone || '';
    form.elements.profileEmail.value = profile.email || '';
    form.elements.profileBirthday.value = formatDateInput(profile.birthday);
    form.elements.profileDiagnosisDate.value = formatDateInput(profile.diagnosisDate);
    form.elements.profileAddress.value = profile.address || '';
    
    // æ›´æ–°æœƒå“¡è³‡è¨Š
    document.getElementById('userMemberType').textContent = profile.memberType || '-';
    
    // è¼‰å…¥æ”¶æ“š
    renderMyReceipts(profile.receipts || []);
  } catch (error) {
    console.error('è¼‰å…¥å€‹äººè³‡æ–™å¤±æ•—:', error);
  }
}

function renderMyReceipts(receipts) {
  const container = document.getElementById('myReceiptsList');
  
  if (receipts.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-file-earmark-text"></i><p>æ‚¨é‚„æ²’æœ‰æ”¶æ“š</p></div>';
    return;
  }
  
  container.innerHTML = receipts.map(receipt => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="activity-title">${receipt.year}å¹´åº¦æ”¶æ“š</div>
          <div class="activity-meta">
            <span><i class="bi bi-cash"></i>é‡‘é¡ï¼š$${formatCurrency(receipt.amount)}</span>
          </div>
        </div>
        <button class="btn btn-sm btn-gradient" onclick="window.open('${receipt.url}', '_blank')">
          <i class="bi bi-download"></i>ä¸‹è¼‰
        </button>
      </div>
    </div>
  `).join('');
}

// å„²å­˜å€‹äººè³‡æ–™
document.getElementById('profileForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const formData = new FormData(e.target);
  const data = {
    lineId: userProfile.userId,
    realName: formData.get('profileRealName'),
    memberType: formData.get('profileMemberType'),
    phone: formData.get('profilePhone'),
    email: formData.get('profileEmail'),
    birthday: formData.get('profileBirthday'),
    diagnosisDate: formData.get('profileDiagnosisDate'),
    address: formData.get('profileAddress')
  };
  
  const btn = e.target.querySelector('button[type="submit"]');
  setButtonLoading(btn, true);
  
  try {
    await callAPI('updateProfile', data);
    showNotification('è³‡æ–™å·²æ›´æ–°', 'success');
    await loadProfileData();
  } catch (error) {
    showNotification('æ›´æ–°å¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    setButtonLoading(btn, false);
  }
});

// ==================== è¼‰å…¥ç®¡ç†è³‡æ–™ ====================
async function loadAdminData() {
  try {
    const response = await callAPI('getAdminData', { lineId: userProfile.userId });
    cachedAdminData = response.data;
    
    // æœƒå“¡åˆ—è¡¨
    renderMemberList(cachedAdminData.members || []);
    
    // æ´»å‹•åˆ—è¡¨
    renderAdminActivityList(cachedAdminData.activities || []);
    
    // äº¤æ˜“åˆ—è¡¨
    renderTransactionList(cachedAdminData.transactions || []);
    
    // æ”¶æ“šåˆ—è¡¨
    renderReceiptList(cachedAdminData.receipts || []);
  } catch (error) {
    console.error('è¼‰å…¥ç®¡ç†è³‡æ–™å¤±æ•—:', error);
  }
}

function renderMemberList(members) {
  const tbody = document.getElementById('memberList');
  
  if (members.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">æ²’æœ‰æœƒå“¡è³‡æ–™</td></tr>';
    return;
  }
  
  tbody.innerHTML = members.map(member => `
    <tr>
      <td>${member.realName || member.lineName}</td>
      <td>${member.memberType || '-'}</td>
      <td><span class="status-badge status-${member.status}">${member.status}</span></td>
      <td>${formatDate(member.joinDate)}</td>
      <td>$${formatCurrency(member.totalDonation || 0)}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="viewMemberDetail('${member.lineId}')">
          <i class="bi bi-eye"></i>
        </button>
      </td>
    </tr>
  `).join('');
}

function renderAdminActivityList(activities) {
  const container = document.getElementById('adminActivityList');
  
  if (activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>æ²’æœ‰æ´»å‹•</p></div>';
    return;
  }
  
  container.innerHTML = activities.map(activity => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${activity.title}</div>
        <span class="status-badge status-${activity.status}">${activity.status}</span>
      </div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(activity.date)}</span>
        <span><i class="bi bi-people"></i>${activity.currentParticipants || 0}/${activity.maxParticipants}</span>
      </div>
      <div class="mt-2">
        <button class="btn btn-sm btn-outline-primary" onclick="editActivity('${activity.id}')">
          <i class="bi bi-pencil"></i>ç·¨è¼¯
        </button>
      </div>
    </div>
  `).join('');
}

function renderTransactionList(transactions) {
  const tbody = document.getElementById('transactionList');
  
  if (transactions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">æ²’æœ‰äº¤æ˜“è¨˜éŒ„</td></tr>';
    return;
  }
  
  tbody.innerHTML = transactions.slice(0, 20).map(trans => `
    <tr>
      <td>${formatDate(trans.date)}</td>
      <td>${trans.type}</td>
      <td>$${formatCurrency(trans.amount)}</td>
      <td>${trans.category || '-'}</td>
      <td>${trans.description || '-'}</td>
      <td><span class="status-badge status-${trans.status}">${trans.status}</span></td>
    </tr>
  `).join('');
}

function renderReceiptList(receipts) {
  const container = document.getElementById('receiptList');
  
  if (receipts.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-file-earmark-text"></i><p>æ²’æœ‰æ”¶æ“š</p></div>';
    return;
  }
  
  container.innerHTML = receipts.map(receipt => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="activity-title">${receipt.memberName} - ${receipt.year}å¹´åº¦</div>
          <div class="activity-meta">
            <span><i class="bi bi-cash"></i>$${formatCurrency(receipt.amount)}</span>
            <span><i class="bi bi-calendar"></i>${formatDate(receipt.issueDate)}</span>
          </div>
        </div>
        <button class="btn btn-sm btn-outline-primary" onclick="window.open('${receipt.url}', '_blank')">
          <i class="bi bi-eye"></i>æŸ¥çœ‹
        </button>
      </div>
    </div>
  `).join('');
}

// ==================== Modal å‡½æ•¸ ====================
function showDonationModal() {
  const html = `
    <div class="modal fade" id="donationModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="donationForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>æˆ‘è¦ææ¬¾</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="number" class="form-control" name="amount" required min="1">
              <label>ææ¬¾é‡‘é¡ *</label>
            </div>
            <div class="form-floating mb-3">
              <select class="form-select" name="purpose">
                <option value="ä¸€èˆ¬ææ¬¾">ä¸€èˆ¬ææ¬¾</option>
                <option value="æ´»å‹•è´ŠåŠ©">æ´»å‹•è´ŠåŠ©</option>
                <option value="è¨­å‚™è³¼ç½®">è¨­å‚™è³¼ç½®</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
              </select>
              <label>ææ¬¾ç”¨é€”</label>
            </div>
            <div class="form-floating mb-3">
              <select class="form-select" name="paymentMethod" required>
="">è«‹é¸æ“‡</option>
                <option value="ç¾é‡‘">ç¾é‡‘</option>
                <option value="è½‰å¸³">éŠ€è¡Œè½‰å¸³</option>
                <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
              </select>
              <label>ä»˜æ¬¾æ–¹å¼ *</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="note" style="height:80px;"></textarea>
              <label>å‚™è¨»</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-gradient">ç¢ºèªææ¬¾</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  showModal(html, async (formData) => {
    const data = {
      lineId: userProfile.userId,
      amount: formData.get('amount'),
      purpose: formData.get('purpose'),
      paymentMethod: formData.get('paymentMethod'),
      note: formData.get('note')
    };
    
    await callAPI('addDonation', data);
    showNotification('ææ¬¾è¨˜éŒ„å·²æ–°å¢ï¼Œæ„Ÿè¬æ‚¨çš„æ”¯æŒï¼', 'success');
    await loadFinanceData();
    await loadHomeData();
  });
}

function showNewExpenseModal() {
  const html = `
    <div class="modal fade" id="expenseModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="expenseForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>æ”¯å‡ºç”³è«‹</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="number" class="form-control" name="amount" required min="1">
              <label>é‡‘é¡ *</label>
            </div>
            <div class="form-floating mb-3">
              <select class="form-select" name="category" required>
                <option value="">è«‹é¸æ“‡</option>
                <option value="æ´»å‹•è²»ç”¨">æ´»å‹•è²»ç”¨</option>
                <option value="å ´åœ°ç§Ÿé‡‘">å ´åœ°ç§Ÿé‡‘</option>
                <option value="è¨­å‚™è³¼ç½®">è¨­å‚™è³¼ç½®</option>
                <option value="æ–‡å®£å°åˆ·">æ–‡å®£å°åˆ·</option>
                <option value="äº¤é€šè²»">äº¤é€šè²»</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
              </select>
              <label>é¡åˆ¥ *</label>
            </div>
            <div class="form-floating mb-3">
              <input type="date" class="form-control" name="date" required>
              <label>æ—¥æœŸ *</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" required style="height:100px;"></textarea>
              <label>èªªæ˜ *</label>
            </div>
            <div class="mb-3">
              <label class="form-label">ä¸Šå‚³æ†‘è­‰</label>
              <input type="file" class="form-control" name="receipt" accept="image/*,.pdf">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-gradient">é€å‡ºç”³è«‹</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  showModal(html, async (formData) => {
    const data = {
      lineId: userProfile.userId,
      amount: formData.get('amount'),
      category: formData.get('category'),
      date: formData.get('date'),
      description: formData.get('description')
    };
    
    // TODO: è™•ç†æª”æ¡ˆä¸Šå‚³
    
    await callAPI('addExpense', data);
    showNotification('æ”¯å‡ºç”³è«‹å·²é€å‡º', 'success');
    await loadFinanceData();
  });
}

function showNewActivityModal() {
  const html = `
    <div class="modal fade" id="activityModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <form class="modal-content" id="activityForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>æ–°å¢æ´»å‹•</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-12 mb-3">
                <div class="form-floating">
                  <input type="text" class="form-control" name="title" required>
                  <label>æ´»å‹•åç¨± *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="date" class="form-control" name="date" required>
                  <label>æ—¥æœŸ *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="time" class="form-control" name="time">
                  <label>æ™‚é–“</label>
                </div>
              </div>
              <div class="col-md-12 mb-3">
                <div class="form-floating">
                  <input type="text" class="form-control" name="location">
                  <label>åœ°é»</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="maxParticipants" required min="1">
                  <label>äººæ•¸ä¸Šé™ *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="fee" min="0">
                  <label>è²»ç”¨</label>
                </div>
              </div>
              <div class="col-md-12 mb-3">
                <div class="form-floating">
                  <textarea class="form-control" name="description" style="height:100px;"></textarea>
                  <label>æ´»å‹•èªªæ˜</label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-gradient">æ–°å¢æ´»å‹•</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  showModal(html, async (formData) => {
    const data = {
      lineId: userProfile.userId,
      title: formData.get('title'),
      date: formData.get('date'),
      time: formData.get('time'),
      location: formData.get('location'),
      maxParticipants: formData.get('maxParticipants'),
      fee: formData.get('fee') || 0,
      description: formData.get('description')
    };
    
    await callAPI('addActivity', data);
    showNotification('æ´»å‹•å·²æ–°å¢', 'success');
    await loadAdminData();
    await loadActivities();
  });
}

function showNewVolunteerNeedModal() {
  const html = `
    <div class="modal fade" id="volunteerModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="volunteerForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-people me-2"></i>æ–°å¢å¿—å·¥éœ€æ±‚</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="text" class="form-control" name="title" required>
              <label>éœ€æ±‚åç¨± *</label>
            </div>
            <div class="form-floating mb-3">
              <input type="date" class="form-control" name="date" required>
              <label>æ—¥æœŸ *</label>
            </div>
            <div class="form-floating mb-3">
              <input type="time" class="form-control" name="time">
              <label>æ™‚é–“</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" name="needCount" required min="1">
              <label>éœ€æ±‚äººæ•¸ *</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" name="hours" required min="0.5" step="0.5">
              <label>æœå‹™æ™‚æ•¸ *</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" style="height:100px;"></textarea>
              <label>èªªæ˜</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-gradient">æ–°å¢éœ€æ±‚</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  showModal(html, async (formData) => {
    const data = {
      lineId: userProfile.userId,
      title: formData.get('title'),
      date: formData.get('date'),
      time: formData.get('time'),
      needCount: formData.get('needCount'),
      hours: formData.get('hours'),
      description: formData.get('description')
    };
    
    await callAPI('addVolunteerNeed', data);
    showNotification('å¿—å·¥éœ€æ±‚å·²æ–°å¢', 'success');
    await loadVolunteerData();
  });
}

// ==================== Modal é€šç”¨å‡½æ•¸ ====================
function showModal(html, onSubmit) {
  const container = document.getElementById('modalContainer');
  container.innerHTML = html;
  
  const modalEl = container.querySelector('.modal');
  const modal = new bootstrap.Modal(modalEl);
  
  const form = modalEl.querySelector('form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const btn = form.querySelector('button[type="submit"]');
    setButtonLoading(btn, true);
    
    try {
      const formData = new FormData(form);
      await onSubmit(formData);
      modal.hide();
    } catch (error) {
      showNotification('æ“ä½œå¤±æ•—ï¼š' + error.message, 'error');
    } finally {
      setButtonLoading(btn, false);
    }
  });
  
  modalEl.addEventListener('hidden.bs.modal', () => {
    container.innerHTML = '';
  });
  
  modal.show();
}

// ==================== ç®¡ç†åŠŸèƒ½ ====================
async function exportMembers() {
  try {
    showLoading(true);
    const response = await callAPI('exportMembers', { lineId: userProfile.userId });
    window.open(response.data.url, '_blank');
    showNotification('æœƒå“¡è³‡æ–™å·²åŒ¯å‡º', 'success');
  } catch (error) {
    showNotification('åŒ¯å‡ºå¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

async function exportFinanceData() {
  try {
    showLoading(true);
    const response = await callAPI('exportFinance', { lineId: userProfile.userId });
    window.open(response.data.url, '_blank');
    showNotification('è²¡å‹™å ±è¡¨å·²åŒ¯å‡º', 'success');
  } catch (error) {
    showNotification('åŒ¯å‡ºå¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

async function backupSystem() {
  if (!confirm('ç¢ºå®šè¦åŸ·è¡Œç³»çµ±å‚™ä»½å—ï¼Ÿ')) return;
  
  try {
    showLoading(true);
    await callAPI('backupSystem', { lineId: userProfile.userId });
    showNotification('ç³»çµ±å‚™ä»½å®Œæˆ', 'success');
  } catch (error) {
    showNotification('å‚™ä»½å¤±æ•—ï¼š' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

function viewMemberDetail(lineId) {
  // TODO: é¡¯ç¤ºæœƒå“¡è©³ç´°è³‡æ–™
  showNotification('åŠŸèƒ½é–‹ç™¼ä¸­', 'info');
}

function editActivity(activityId) {
  // TODO: ç·¨è¼¯æ´»å‹•
  showNotification('åŠŸèƒ½é–‹ç™¼ä¸­', 'info');
}

// ==================== é é¢åˆ‡æ› ====================
function switchPage(pageName) {
  // éš±è—æ‰€æœ‰é é¢
  document.querySelectorAll('.page-content').forEach(page => {
    page.classList.remove('active');
  });
  
  // ç§»é™¤æ‰€æœ‰å°èˆªé …ç›®çš„ active ç‹€æ…‹
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // é¡¯ç¤ºç›®æ¨™é é¢
  document.getElementById(`page-${pageName}`).classList.add('active');
  
  // è¨­å®šå°æ‡‰å°èˆªé …ç›®ç‚º active
  event.currentTarget.classList.add('active');
}

// ==================== å·¥å…·å‡½æ•¸ ====================
function formatDate(dateString) {
  if (!dateString) return '-';
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
}

function formatDateInput(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toISOString().split('T')[0];
}

function formatCurrency(amount) {
  return new Intl.NumberFormat('zh-TW').format(amount);
}

function showLoading(show) {
  let overlay = document.querySelector('.loading-overlay');
  
  if (show) {
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.innerHTML = '<div class="loading-spinner"></div>';
      document.body.appendChild(overlay);
    }
  } else {
    if (overlay) {
      overlay.remove();
    }
  }
}

function setButtonLoading(button, loading) {
  if (loading) {
    button.disabled = true;
    button.dataset.originalText = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>è™•ç†ä¸­...';
  } else {
    button.disabled = false;
    button.innerHTML = button.dataset.originalText;
  }
}

function showNotification(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  
  const colors = {
    success: '#28a745',
    error: '#dc3545',
    warning: '#ffc107',
    info: '#17a2b8'
  };
  
  const icons = {
    success: 'check-circle-fill',
    error: 'x-circle-fill',
    warning: 'exclamation-triangle-fill',
    info: 'info-circle-fill'
  };
  
  const toast = document.createElement('div');
  toast.className = 'toast show';
  toast.style.cssText = `
    min-width: 250px;
    margin-bottom: 10px;
    background: white;
    border-left: 4px solid ${colors[type]};
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  `;
  
  toast.innerHTML = `
    <div class="toast-body d-flex align-items-center">
      <i class="bi bi-${icons[type]} me-2" style="color: ${colors[type]}; font-size: 20px;"></i>
      <span>${message}</span>
    </div>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ==================== é é¢è¼‰å…¥å®Œæˆ ====================
document.addEventListener('DOMContentLoaded', () => {
  console.log('ğŸ“„ é é¢ DOM è¼‰å…¥å®Œæˆ');
  console.log('ğŸŒ User Agent:', navigator.userAgent);
  console.log('ğŸ“ ç•¶å‰ URL:', window.location.href);
  
  // åˆå§‹åŒ– LIFF
  initLIFF();
});

// ==================== è…³æœ¬è¼‰å…¥å®Œæˆ ====================
console.log('âœ… è…³æœ¬è¼‰å…¥å®Œæˆ');
</script>

</body>
</html>


