<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>帕金森病友會管理系統</title>

<!-- 直接載入 LIFF SDK -->
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

<style>
:root {
  --primary: #06c755;
  --primary-dark: #05b04b;
  --secondary: #00b900;
  --danger: #dc3545;
  --warning: #ffc107;
  --info: #17a2b8;
  --light: #f8f9fa;
  --dark: #343a40;
  --border-radius: 12px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding-bottom: 80px;
}

.app-container {
  max-width: 480px;
  margin: 0 auto;
  background: white;
  min-height: 100vh;
  box-shadow: 0 0 30px rgba(0,0,0,0.1);
}

/* ==================== 頂部導航 ==================== */
.top-bar {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.top-bar h1 {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid white;
}

.user-name {
  font-size: 14px;
  font-weight: 500;
}

/* ==================== 底部導航 ==================== */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  border-top: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-around;
  padding: 8px 0;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
  z-index: 1000;
  max-width: 480px;
  margin: 0 auto;
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 8px;
  color: #666;
  text-decoration: none;
  transition: all 0.3s;
  cursor: pointer;
  border: none;
  background: none;
}

.nav-item i {
  font-size: 22px;
}

.nav-item span {
  font-size: 11px;
}

.nav-item.active {
  color: var(--primary);
}

.nav-item:hover {
  color: var(--primary);
  background: rgba(6, 199, 85, 0.05);
}

/* ==================== 頁面內容 ==================== */
.page-content {
  display: none;
  padding: 20px;
  animation: fadeIn 0.3s;
}

.page-content.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ==================== 卡片樣式 ==================== */
.card {
  border: none;
  border-radius: var(--border-radius);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 20px;
  overflow: hidden;
}

.card-header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  font-weight: 600;
  padding: 15px 20px;
  border: none;
}

.card-body {
  padding: 20px;
}

/* ==================== 統計卡片 ==================== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin-bottom: 20px;
}

.stat-card {
  background: white;
  border-radius: var(--border-radius);
  padding: 20px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: transform 0.3s, box-shadow 0.3s;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.stat-icon {
  font-size: 32px;
  margin-bottom: 10px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stat-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--dark);
  margin: 5px 0;
}

.stat-label {
  font-size: 13px;
  color: #666;
}

/* ==================== 活動項目 ==================== */
.activity-item {
  background: white;
  border-radius: var(--border-radius);
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: transform 0.3s, box-shadow 0.3s;
}

.activity-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.activity-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 8px;
}

.activity-info {
  font-size: 14px;
  color: #666;
  margin-bottom: 10px;
}

.activity-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  font-size: 13px;
  color: #888;
}

.activity-meta span {
  display: flex;
  align-items: center;
  gap: 4px;
}

.activity-meta i {
  font-size: 14px;
}

/* ==================== 狀態標籤 ==================== */
.status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
}

.status-開放報名 {
  background: #d4edda;
  color: #155724;
}

.status-已報名 {
  background: #cce5ff;
  color: #004085;
}

.status-已額滿 {
  background: #f8d7da;
  color: #721c24;
}

.status-已結束 {
  background: #e2e3e5;
  color: #383d41;
}

.status-待審核 {
  background: #fff3cd;
  color: #856404;
}

.status-已核准 {
  background: #d4edda;
  color: #155724;
}

.status-已拒絕 {
  background: #f8d7da;
  color: #721c24;
}

/* ==================== 按鈕樣式 ==================== */
.btn-gradient {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 25px;
  font-weight: 600;
  transition: all 0.3s;
  box-shadow: 0 4px 10px rgba(6, 199, 85, 0.3);
}

.btn-gradient:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(6, 199, 85, 0.4);
  color: white;
}

.btn-gradient:active {
  transform: translateY(0);
}

.fab-button {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  border: none;
  font-size: 24px;
  box-shadow: 0 4px 12px rgba(6, 199, 85, 0.4);
  cursor: pointer;
  transition: all 0.3s;
  z-index: 999;
}

.fab-button:hover {
  transform: scale(1.1) rotate(90deg);
  box-shadow: 0 6px 16px rgba(6, 199, 85, 0.5);
}

/* ==================== 表單樣式 ==================== */
.form-floating > label {
  color: #666;
}

.form-control:focus,
.form-select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 0.2rem rgba(6, 199, 85, 0.25);
}

/* ==================== 空狀態 ==================== */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #999;
}

.empty-state i {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0.5;
}

.empty-state p {
  font-size: 14px;
  margin: 0;
}

/* ==================== 載入動畫 ==================== */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ==================== Toast 通知 ==================== */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
}

/* ==================== 管理員專用 ==================== */
.admin-only {
  display: none;
}

/* ==================== 表格樣式 ==================== */
.table-responsive {
  border-radius: var(--border-radius);
  overflow: hidden;
}

.table {
  margin-bottom: 0;
}

.table thead {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
}

.table tbody tr:hover {
  background: rgba(6, 199, 85, 0.05);
}

/* ==================== 響應式設計 ==================== */
@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .activity-meta {
    flex-direction: column;
    gap: 5px;
  }
}
</style>
</head>
<body>

<div class="app-container">
  <!-- 頂部導航 -->
  <div class="top-bar">
    <h1><i class="bi bi-heart-pulse me-2"></i>帕金森病友會</h1>
    <div class="user-info">
      <img id="userAvatar" class="user-avatar" src="https://via.placeholder.com/36" alt="頭像">
      <span id="userName" class="user-name">載入中...</span>
    </div>
  </div>

  <!-- ==================== 首頁 ==================== -->
  <div id="page-home" class="page-content active">
    <!-- 統計卡片 -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-calendar-event"></i></div>
        <div class="stat-value" id="statActivities">0</div>
        <div class="stat-label">活動總數</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
        <div class="stat-value" id="statRegistrations">0</div>
        <div class="stat-label">我的報名</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
        <div class="stat-value" id="statVolunteerHours">0</div>
        <div class="stat-label">志工時數</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-heart"></i></div>
        <div class="stat-value" id="statDonations">0</div>
        <div class="stat-label">捐款金額</div>
      </div>
    </div>

    <!-- 最新活動 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-calendar-event me-2"></i>最新活動
      </div>
      <div class="card-body">
        <div id="recentActivities">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== 活動頁面 ==================== -->
  <div id="page-activities" class="page-content">
    <!-- 開放報名活動 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-calendar-plus me-2"></i>開放報名
      </div>
      <div class="card-body">
        <div id="activitiesList">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 我的報名 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-list-check me-2"></i>我的報名
      </div>
      <div class="card-body">
        <div id="myRegistrationsList">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== 志工頁面 ==================== -->
  <div id="page-volunteer" class="page-content">
    <!-- 志工統計 -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
        <div class="stat-value" id="volTotalHours">0</div>
        <div class="stat-label">累計時數</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
        <div class="stat-value" id="volTotalActivities">0</div>
        <div class="stat-label">服務次數</div>
      </div>
    </div>

    <!-- 志工需求 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-people me-2"></i>志工需求
      </div>
      <div class="card-body">
        <div id="volunteerNeedsList">
          <div class="empty-state">
            <i class="bi bi-people"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 我的志工記錄 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-journal-text me-2"></i>我的記錄
      </div>
      <div class="card-body">
        <div id="myVolunteerRecords">
          <div class="empty-state">
            <i class="bi bi-journal-x"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== 財務頁面 ==================== -->
  <div id="page-finance" class="page-content">
    <!-- 財務統計 -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-heart"></i></div>
        <div class="stat-value" id="finTotalDonation">0</div>
        <div class="stat-label">累計捐款</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-receipt"></i></div>
        <div class="stat-value" id="finPendingExpenses">0</div>
        <div class="stat-label">待審核支出</div>
      </div>
    </div>

    <!-- 快速操作 -->
    <div class="d-grid gap-2 mb-3">
      <button class="btn btn-gradient" onclick="showDonationModal()">
        <i class="bi bi-heart-fill me-2"></i>我要捐款
      </button>
      <button class="btn btn-outline-primary" onclick="showNewExpenseModal()">
        <i class="bi bi-receipt me-2"></i>支出申請
      </button>
    </div>

    <!-- 我的捐款記錄 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-heart me-2"></i>我的捐款
      </div>
      <div class="card-body">
        <div id="myDonationsList">
          <div class="empty-state">
            <i class="bi bi-heart"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 我的支出申請 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-receipt me-2"></i>我的支出
      </div>
      <div class="card-body">
        <div id="myExpensesList">
          <div class="empty-state">
            <i class="bi bi-receipt"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== 個人頁面 ==================== -->
  <div id="page-profile" class="page-content">
    <!-- 個人資料 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-person me-2"></i>個人資料
      </div>
      <div class="card-body">
        <form id="profileForm">
          <div class="form-floating mb-3">
            <input type="text" class="form-control" name="profileRealName" required>
            <label>真實姓名 *</label>
          </div>
          <div class="form-floating mb-3">
            <select class="form-select" name="profileMemberType" required>
              <option value="">請選擇</option>
              <option value="病友">病友</option>
              <option value="家屬">家屬</option>
              <option value="志工">志工</option>
            </select>
            <label>會員類型 *</label>
          </div>
          <div class="form-floating mb-3">
            <input type="tel" class="form-control" name="profilePhone">
            <label>聯絡電話</label>
          </div>
          <div class="form-floating mb-3">
            <input type="email" class="form-control" name="profileEmail">
            <label>電子郵件</label>
          </div>
          <div class="form-floating mb-3">
            <input type="date" class="form-control" name="profileBirthday">
            <label>生日</label>
          </div>
          <div class="form-floating mb-3">
            <input type="date" class="form-control" name="profileDiagnosisDate">
            <label>確診日期</label>
          </div>
          <div class="form-floating mb-3">
            <textarea class="form-control" name="profileAddress" style="height:80px;"></textarea>
            <label>地址</label>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-gradient">
              <i class="bi bi-save me-2"></i>儲存變更
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 我的收據 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-file-earmark-text me-2"></i>我的收據
      </div>
      <div class="card-body">
        <div id="myReceiptsList">
          <div class="empty-state">
            <i class="bi bi-file-earmark-text"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 會員資訊 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-info-circle me-2"></i>會員資訊
      </div>
      <div class="card-body">
        <p><strong>會員類型：</strong><span id="userMemberType">-</span></p>
        <p><strong>LINE ID：</strong><span id="userLineId">-</span></p>
        <p class="mb-0"><strong>版本：</strong>v1.0.0</p>
      </div>
    </div>
  </div>

  <!-- ==================== 管理頁面 ==================== -->
  <div id="page-admin" class="page-content admin-only">
    <!-- 管理功能 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-gear me-2"></i>管理功能
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <button class="btn btn-outline-primary" onclick="showNewActivityModal()">
            <i class="bi bi-calendar-plus me-2"></i>新增活動
          </button>
          <button class="btn btn-outline-success" onclick="showNewVolunteerNeedModal()">
            <i class="bi bi-people me-2"></i>新增志工需求
          </button>
          <button class="btn btn-outline-info" onclick="exportMembers()">
            <i class="bi bi-download me-2"></i>匯出會員資料
          </button>
          <button class="btn btn-outline-warning" onclick="exportFinanceData()">
            <i class="bi bi-file-earmark-spreadsheet me-2"></i>匯出財務報表
          </button>
          <button class="btn btn-outline-secondary" onclick="backupSystem()">
            <i class="bi bi-cloud-upload me-2"></i>系統備份
          </button>
        </div>
      </div>
    </div>

    <!-- 會員管理 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-people me-2"></i>會員管理
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>姓名</th>
                <th>類型</th>
                <th>狀態</th>
                <th>加入日期</th>
                <th>捐款</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="memberList">
              <tr><td colspan="6" class="text-center">載入中...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 活動管理 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-calendar-event me-2"></i>活動管理
      </div>
      <div class="card-body">
        <div id="adminActivityList">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 財務管理 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-cash-stack me-2"></i>財務管理
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>日期</th>
                <th>類型</th>
                <th>金額</th>
                <th>類別</th>
                <th>說明</th>
                <th>狀態</th>
              </tr>
            </thead>
            <tbody id="transactionList">
              <tr><td colspan="6" class="text-center">載入中...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 收據管理 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-file-earmark-text me-2"></i>收據管理
      </div>
      <div class="card-body">
        <div id="receiptList">
          <div class="empty-state">
            <i class="bi bi-file-earmark-text"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 底部導航 -->
  <div class="bottom-nav">
    <button class="nav-item active" onclick="switchPage('home')">
      <i class="bi bi-house-door-fill"></i>
      <span>首頁</span>
    </button>
    <button class="nav-item" onclick="switchPage('activities')">
      <i class="bi bi-calendar-event"></i>
      <span>活動</span>
    </button>
    <button class="nav-item" onclick="switchPage('volunteer')">
      <i class="bi bi-people"></i>
      <span>志工</span>
    </button>
    <button class="nav-item" onclick="switchPage('finance')">
      <i class="bi bi-wallet2"></i>
      <span>財務</span>
    </button>
    <button class="nav-item" onclick="switchPage('profile')">
      <i class="bi bi-person"></i>
      <span>我的</span>
    </button>
    <button class="nav-item admin-only" onclick="switchPage('admin')">
      <i class="bi bi-gear"></i>
      <span>管理</span>
    </button>
  </div>
</div>

<!-- Toast 容器 -->
<div id="toastContainer" class="toast-container"></div>

<!-- Modal 容器 -->
<div id="modalContainer"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ==================== 全域變數 ====================
const LIFF_ID = '1656516134-VaGgmaPm';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbznG2VbFZ7mA5y5SdhHGme_inTsI_1p8BA0zW_UPyMcGX3dtNwRtLpm-eFSupLXkivx/exec';

let userProfile = null;
let isAdmin = false;
let cachedAdminData = null;

// ==================== LIFF SDK 載入檢查 ====================
function loadLiffSDK() {
  return new Promise((resolve, reject) => {
    console.log('🔄 檢查 LIFF SDK...');
    
    let checkCount = 0;
    const maxChecks = 50; // 5秒
    
    const checkLiff = () => {
      checkCount++;
      console.log(`🔍 檢查 LIFF 物件 (${checkCount}/${maxChecks})...`);
      
      if (typeof liff !== 'undefined') {
        console.log('✅ LIFF SDK 可用');
        resolve();
        return;
      }
      
      if (checkCount >= maxChecks) {
        console.error('❌ LIFF SDK 未載入');
        reject(new Error('LIFF SDK 未載入，請確認在 LINE 中開啟'));
        return;
      }
      
      setTimeout(checkLiff, 100);
    };
    
    checkLiff();
  });
}

// ==================== LIFF 初始化 ====================
async function initLIFF() {
  console.log('🚀 開始初始化 LIFF...');
  
  try {
    // 等待 LIFF SDK 載入
    await loadLiffSDK();
    
    // 初始化 LIFF
    console.log('🔧 初始化 LIFF，ID:', LIFF_ID);
    await liff.init({ liffId: LIFF_ID });
    console.log('✅ LIFF 初始化成功');
    
    // 檢查登入狀態
    if (!liff.isLoggedIn()) {
      console.log('⚠️ 未登入，導向登入頁面');
      liff.login();
      return;
    }
    
    console.log('✅ 已登入');
    
    // 取得使用者資料
    userProfile = await liff.getProfile();
    console.log('👤 使用者資料:', userProfile);
    
    // 更新 UI
    document.getElementById('userAvatar').src = userProfile.pictureUrl || 'https://via.placeholder.com/36';
    document.getElementById('userName').textContent = userProfile.displayName;
    document.getElementById('userLineId').textContent = userProfile.userId;
    
    // 檢查管理員權限
    await checkAdminStatus();
    
    // 載入資料
    await loadAllData();
    
    console.log('🎉 系統初始化完成');
    
  } catch (error) {
    console.error('❌ LIFF初始化失敗:', error);
    showErrorPage(error);
  }
}

// ==================== 錯誤頁面 ====================
function showErrorPage(error) {
  document.querySelector('.app-container').innerHTML = `
    <div style="padding: 40px 20px; text-align: center;">
      <i class="bi bi-exclamation-triangle" style="font-size: 64px; color: #dc3545;"></i>
      <h3 style="margin-top: 20px;">系統初始化失敗</h3>
      <p style="color: #666; margin: 20px 0;">${error.message}</p>
      <button class="btn btn-gradient" onclick="location.reload()">
        <i class="bi bi-arrow-clockwise me-2"></i>重新載入
      </button>
      <button class="btn btn-outline-secondary mt-2" onclick="showDebugInfo()">
        <i class="bi bi-bug me-2"></i>顯示除錯資訊
      </button>
    </div>`;
}

function showDebugInfo() {
  const info = `
除錯資訊：
- User Agent: ${navigator.userAgent}
- URL: ${window.location.href}
- LIFF 可用: ${typeof liff !== 'undefined'}
- 錯誤: ${error.message}
  `;
  alert(info);
}

// ==================== 檢查管理員權限 ====================
async function checkAdminStatus() {
  try {
    const response = await callAPI('checkAdmin', { lineId: userProfile.userId });
    isAdmin = response.data.isAdmin;
    
    if (isAdmin) {
      console.log('👑 管理員權限確認');
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
    }
  } catch (error) {
    console.error('檢查管理員權限失敗:', error);
  }
}

// ==================== API 呼叫 ====================
async function callAPI(action, data = {}) {
  try {
    const response = await fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ action, ...data })
    });
    
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.message || '操作失敗');
    }
    
    return result;
  } catch (error) {
    console.error('API 呼叫失敗:', error);
    throw error;
  }
}

// ==================== 載入所有資料 ====================
async function loadAllData() {
  showLoading(true);
  try {
    await Promise.all([
      loadHomeData(),
      loadActivities(),
      loadVolunteerData(),
      loadFinanceData(),
      loadProfileData()
    ]);
    
    if (isAdmin) {
      await loadAdminData();
    }
  } catch (error) {
    console.error('載入資料失敗:', error);
    showNotification('載入資料失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== 載入首頁資料 ====================
async function loadHomeData() {
  try {
    const response = await callAPI('getHomeStats', { lineId: userProfile.userId });
    const stats = response.data;
    
    document.getElementById('statActivities').textContent = stats.totalActivities || 0;
    document.getElementById('statRegistrations').textContent = stats.myRegistrations || 0;
    document.getElementById('statVolunteerHours').textContent = stats.volunteerHours || 0;
    document.getElementById('statDonations').textContent = formatCurrency(stats.totalDonations || 0);
    
    // 載入最新活動
    const activitiesResponse = await callAPI('getRecentActivities', { lineId: userProfile.userId });
    renderRecentActivities(activitiesResponse.data.activities || []);
  } catch (error) {
    console.error('載入首頁資料失敗:', error);
  }
}

function renderRecentActivities(activities) {
  const container = document.getElementById('recentActivities');
  
  if (activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>目前沒有活動</p></div>';
    return;
  }
  
  container.innerHTML = activities.slice(0, 3).map(activity => `
    <div class="activity-item">
      <div class="activity-title">${activity.title}</div>
      <div class="activity-info">${activity.description || ''}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(activity.date)}</span>
        <span><i class="bi bi-geo-alt"></i>${activity.location || '未指定'}</span>
        <span><i class="bi bi-people"></i>${activity.currentParticipants || 0}/${activity.maxParticipants}</span>
      </div>
      <button class="btn btn-sm btn-gradient mt-2" onclick="registerActivity('${activity.id}')">
        <i class="bi bi-check-circle me-1"></i>立即報名
      </button>
    </div>
  `).join('');
}

// ==================== 載入活動資料 ====================
async function loadActivities() {
  try {
    const response = await callAPI('getActivities', { lineId: userProfile.userId });
    const activities = response.data.activities || [];
    
    // 開放報名的活動
    const openActivities = activities.filter(a => a.status === '開放報名');
    renderActivitiesList(openActivities);
    
    // 我的報名
    const myRegistrations = response.data.myRegistrations || [];
    renderMyRegistrations(myRegistrations);
  } catch (error) {
    console.error('載入活動失敗:', error);
  }
}

function renderActivitiesList(activities) {
  const container = document.getElementById('activitiesList');
  
  if (activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>目前沒有開放報名的活動</p></div>';
    return;
  }
  
  container.innerHTML = activities.map(activity => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${activity.title}</div>
        <span class="status-badge status-${activity.status}">${activity.status}</span>
      </div>
      <div class="activity-info">${activity.description || ''}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(activity.date)} ${activity.time || ''}</span>
        <span><i class="bi bi-geo-alt"></i>${activity.location || '未指定'}</span>
        <span><i class="bi bi-people"></i>${activity.currentParticipants || 0}/${activity.maxParticipants}</span>
        ${activity.fee ? `<span><i class="bi bi-cash"></i>$${formatCurrency(activity.fee)}</span>` : ''}
      </div>
      <button class="btn btn-sm btn-gradient mt-2" onclick="registerActivity('${activity.id}')">
        <i class="bi bi-check-circle me-1"></i>我要報名
      </button>
    </div>
  `).join('');
}

function renderMyRegistrations(registrations) {
  const container = document.getElementById('myRegistrationsList');
  
  if (registrations.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>您還沒有報名任何活動</p></div>';
    return;
  }
  
  container.innerHTML = registrations.map(reg => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${reg.activityTitle}</div>
        <span class="status-badge status-${reg.status}">${reg.status}</span>
      </div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(reg.activityDate)}</span>
        <span><i class="bi bi-clock"></i>報名時間：${formatDate(reg.registrationDate)}</span>
      </div>
      ${reg.status === '已報名' ? `
        <button class="btn btn-sm btn-outline-danger mt-2" onclick="cancelRegistration('${reg.id}')">
          <i class="bi bi-x-circle me-1"></i>取消報名
        </button>
      ` : ''}
    </div>
  `).join('');
}

async function registerActivity(activityId) {
  if (!confirm('確定要報名此活動嗎？')) return;
  
  try {
    showLoading(true);
    await callAPI('registerActivity', {
      lineId: userProfile.userId,
      activityId: activityId
    });
    showNotification('報名成功！', 'success');
    await loadActivities();
    await loadHomeData();
  } catch (error) {
    showNotification('報名失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

async function cancelRegistration(registrationId) {
  if (!confirm('確定要取消報名嗎？')) return;
  
  try {
    showLoading(true);
    await callAPI('cancelRegistration', {
      lineId: userProfile.userId,
      registrationId: registrationId
    });
    showNotification('已取消報名', 'success');
    await loadActivities();
    await loadHomeData();
  } catch (error) {
    showNotification('取消失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== 載入志工資料 ====================
async function loadVolunteerData() {
  try {
    const response = await callAPI('getVolunteerData', { lineId: userProfile.userId });
    const data = response.data;
    
    // 更新統計
    document.getElementById('volTotalHours').textContent = data.totalHours || 0;
    document.getElementById('volTotalActivities').textContent = data.totalActivities || 0;
    
    // 志工需求
    renderVolunteerNeeds(data.needs || []);
    
    // 我的記錄
    renderMyVolunteerRecords(data.myRecords || []);
  } catch (error) {
    console.error('載入志工資料失敗:', error);
  }
}

function renderVolunteerNeeds(needs) {
  const container = document.getElementById('volunteerNeedsList');
  
  if (needs.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-people"></i><p>目前沒有志工需求</p></div>';
    return;
  }
  
  container.innerHTML = needs.map(need => `
    <div class="activity-item">
      <div class="activity-title">${need.title}</div>
      <div class="activity-info">${need.description || ''}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(need.date)} ${need.time || ''}</span>
        <span><i class="bi bi-people"></i>需求：${need.needCount}人</span>
        <span><i class="bi bi-clock"></i>時數：${need.hours}小時</span>
        <span><i class="bi bi-check-circle"></i>已報名：${need.currentCount || 0}人</span>
      </div>
      <button class="btn btn-sm btn-gradient mt-2" onclick="applyVolunteer('${need.id}')">
        <i class="bi bi-hand-thumbs-up me-1"></i>我要報名
      </button>
    </div>
  `).join('');
}

function renderMyVolunteerRecords(records) {
  const container = document.getElementById('myVolunteerRecords');
  
  if (records.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-journal-x"></i><p>您還沒有志工服務記錄</p></div>';
    return;
  }
  
  container.innerHTML = records.map(record => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${record.title}</div>
        <span class="status-badge status-${record.status}">${record.status}</span>
      </div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(record.date)}</span>
        <span><i class="bi bi-clock"></i>${record.hours}小時</span>
      </div>
    </div>
  `).join('');
}

async function applyVolunteer(needId) {
  if (!confirm('確定要報名此志工服務嗎？')) return;
  
  try {
    showLoading(true);
    await callAPI('applyVolunteer', {
      lineId: userProfile.userId,
      needId: needId
    });
    showNotification('報名成功！', 'success');
    await loadVolunteerData();
  } catch (error) {
    showNotification('報名失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== 載入財務資料 ====================
async function loadFinanceData() {
  try {
    const response = await callAPI('getFinanceData', { lineId: userProfile.userId });
    const data = response.data;
    
    // 更新統計
    document.getElementById('finTotalDonation').textContent = formatCurrency(data.totalDonation || 0);
    document.getElementById('finPendingExpenses').textContent = data.pendingExpenses || 0;
    
    // 我的捐款
    renderMyDonations(data.myDonations || []);
    
    // 我的支出
    renderMyExpenses(data.myExpenses || []);
  } catch (error) {
    console.error('載入財務資料失敗:', error);
  }
}

function renderMyDonations(donations) {
  const container = document.getElementById('myDonationsList');
  
  if (donations.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-heart"></i><p>您還沒有捐款記錄</p></div>';
    return;
  }
  
  container.innerHTML = donations.map(donation => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="activity-title">捐款 $${formatCurrency(donation.amount)}</div>
          <div class="activity-info">${donation.purpose || '一般捐款'}</div>
          <div class="activity-meta">
            <span><i class="bi bi-calendar"></i>${formatDate(donation.date)}</span>
            <span><i class="bi bi-credit-card"></i>${donation.paymentMethod}</span>
          </div>
        </div>
        ${donation.receiptUrl ? `
          <button class="btn btn-sm btn-outline-primary" onclick="window.open('${donation.receiptUrl}', '_blank')">
            <i class="bi bi-file-earmark-pdf"></i>收據
          </button>
        ` : ''}
      </div>
    </div>
  `).join('');
}

function renderMyExpenses(expenses) {
  const container = document.getElementById('myExpensesList');
  
  if (expenses.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-receipt"></i><p>您還沒有支出申請</p></div>';
    return;
  }
  
  container.innerHTML = expenses.map(expense => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">$${formatCurrency(expense.amount)}</div>
        <span class="status-badge status-${expense.status}">${expense.status}</span>
      </div>
      <div class="activity-info">${expense.description}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(expense.date)}</span>
        <span><i class="bi bi-tag"></i>${expense.category}</span>
      </div>
    </div>
  `).join('');
}

// ==================== 載入個人資料 ====================
async function loadProfileData() {
  try {
    const response = await callAPI('getProfile', { lineId: userProfile.userId });
    const profile = response.data;
    
    // 填充表單
    const form = document.getElementById('profileForm');
    form.elements.profileRealName.value = profile.realName || '';
    form.elements.profileMemberType.value = profile.memberType || '';
    form.elements.profilePhone.value = profile.phone || '';
    form.elements.profileEmail.value = profile.email || '';
    form.elements.profileBirthday.value = formatDateInput(profile.birthday);
    form.elements.profileDiagnosisDate.value = formatDateInput(profile.diagnosisDate);
    form.elements.profileAddress.value = profile.address || '';
    
    // 更新會員資訊
    document.getElementById('userMemberType').textContent = profile.memberType || '-';
    
    // 載入收據
    renderMyReceipts(profile.receipts || []);
  } catch (error) {
    console.error('載入個人資料失敗:', error);
  }
}

function renderMyReceipts(receipts) {
  const container = document.getElementById('myReceiptsList');
  
  if (receipts.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-file-earmark-text"></i><p>您還沒有收據</p></div>';
    return;
  }
  
  container.innerHTML = receipts.map(receipt => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="activity-title">${receipt.year}年度收據</div>
          <div class="activity-meta">
            <span><i class="bi bi-cash"></i>金額：$${formatCurrency(receipt.amount)}</span>
          </div>
        </div>
        <button class="btn btn-sm btn-gradient" onclick="window.open('${receipt.url}', '_blank')">
          <i class="bi bi-download"></i>下載
        </button>
      </div>
    </div>
  `).join('');
}

// 儲存個人資料
document.getElementById('profileForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const formData = new FormData(e.target);
  const data = {
    lineId: userProfile.userId,
    realName: formData.get('profileRealName'),
    memberType: formData.get('profileMemberType'),
    phone: formData.get('profilePhone'),
    email: formData.get('profileEmail'),
    birthday: formData.get('profileBirthday'),
    diagnosisDate: formData.get('profileDiagnosisDate'),
    address: formData.get('profileAddress')
  };
  
  const btn = e.target.querySelector('button[type="submit"]');
  setButtonLoading(btn, true);
  
  try {
    await callAPI('updateProfile', data);
    showNotification('資料已更新', 'success');
    await loadProfileData();
  } catch (error) {
    showNotification('更新失敗：' + error.message, 'error');
  } finally {
    setButtonLoading(btn, false);
  }
});

// ==================== 載入管理資料 ====================
async function loadAdminData() {
  try {
    const response = await callAPI('getAdminData', { lineId: userProfile.userId });
    cachedAdminData = response.data;
    
    // 會員列表
    renderMemberList(cachedAdminData.members || []);
    
    // 活動列表
    renderAdminActivityList(cachedAdminData.activities || []);
    
    // 交易列表
    renderTransactionList(cachedAdminData.transactions || []);
    
    // 收據列表
    renderReceiptList(cachedAdminData.receipts || []);
  } catch (error) {
    console.error('載入管理資料失敗:', error);
  }
}

function renderMemberList(members) {
  const tbody = document.getElementById('memberList');
  
  if (members.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">沒有會員資料</td></tr>';
    return;
  }
  
  tbody.innerHTML = members.map(member => `
    <tr>
      <td>${member.realName || member.lineName}</td>
      <td>${member.memberType || '-'}</td>
      <td><span class="status-badge status-${member.status}">${member.status}</span></td>
      <td>${formatDate(member.joinDate)}</td>
      <td>$${formatCurrency(member.totalDonation || 0)}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="viewMemberDetail('${member.lineId}')">
          <i class="bi bi-eye"></i>
        </button>
      </td>
    </tr>
  `).join('');
}

function renderAdminActivityList(activities) {
  const container = document.getElementById('adminActivityList');
  
  if (activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>沒有活動</p></div>';
    return;
  }
  
  container.innerHTML = activities.map(activity => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${activity.title}</div>
        <span class="status-badge status-${activity.status}">${activity.status}</span>
      </div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(activity.date)}</span>
        <span><i class="bi bi-people"></i>${activity.currentParticipants || 0}/${activity.maxParticipants}</span>
      </div>
      <div class="mt-2">
        <button class="btn btn-sm btn-outline-primary" onclick="editActivity('${activity.id}')">
          <i class="bi bi-pencil"></i>編輯
        </button>
      </div>
    </div>
  `).join('');
}

function renderTransactionList(transactions) {
  const tbody = document.getElementById('transactionList');
  
  if (transactions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">沒有交易記錄</td></tr>';
    return;
  }
  
  tbody.innerHTML = transactions.slice(0, 20).map(trans => `
    <tr>
      <td>${formatDate(trans.date)}</td>
      <td>${trans.type}</td>
      <td>$${formatCurrency(trans.amount)}</td>
      <td>${trans.category || '-'}</td>
      <td>${trans.description || '-'}</td>
      <td><span class="status-badge status-${trans.status}">${trans.status}</span></td>
    </tr>
  `).join('');
}

function renderReceiptList(receipts) {
  const container = document.getElementById('receiptList');
  
  if (receipts.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-file-earmark-text"></i><p>沒有收據</p></div>';
    return;
  }
  
  container.innerHTML = receipts.map(receipt => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="activity-title">${receipt.memberName} - ${receipt.year}年度</div>
          <div class="activity-meta">
            <span><i class="bi bi-cash"></i>$${formatCurrency(receipt.amount)}</span>
            <span><i class="bi bi-calendar"></i>${formatDate(receipt.issueDate)}</span>
          </div>
        </div>
        <button class="btn btn-sm btn-outline-primary" onclick="window.open('${receipt.url}', '_blank')">
          <i class="bi bi-eye"></i>查看
        </button>
      </div>
    </div>
  `).join('');
}

// ==================== Modal 函數 ====================
function showDonationModal() {
  const html = `
    <div class="modal fade" id="donationModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="donationForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>我要捐款</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="number" class="form-control" name="amount" required min="1">
              <label>捐款金額 *</label>
            </div>
            <div class="form-floating mb-3">
              <select class="form-select" name="purpose">
                <option value="一般捐款">一般捐款</option>
                <option value="活動贊助">活動贊助</option>
                <option value="設備購置">設備購置</option>
                <option value="其他">其他</option>
              </select>
              <label>捐款用途</label>
            </div>
            <div class="form-floating mb-3">
              <select class="form-select" name="paymentMethod" required>
="">請選擇</option>
                <option value="現金">現金</option>
                <option value="轉帳">銀行轉帳</option>
                <option value="信用卡">信用卡</option>
              </select>
              <label>付款方式 *</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="note" style="height:80px;"></textarea>
              <label>備註</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-gradient">確認捐款</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  showModal(html, async (formData) => {
    const data = {
      lineId: userProfile.userId,
      amount: formData.get('amount'),
      purpose: formData.get('purpose'),
      paymentMethod: formData.get('paymentMethod'),
      note: formData.get('note')
    };
    
    await callAPI('addDonation', data);
    showNotification('捐款記錄已新增，感謝您的支持！', 'success');
    await loadFinanceData();
    await loadHomeData();
  });
}

function showNewExpenseModal() {
  const html = `
    <div class="modal fade" id="expenseModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="expenseForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>支出申請</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="number" class="form-control" name="amount" required min="1">
              <label>金額 *</label>
            </div>
            <div class="form-floating mb-3">
              <select class="form-select" name="category" required>
                <option value="">請選擇</option>
                <option value="活動費用">活動費用</option>
                <option value="場地租金">場地租金</option>
                <option value="設備購置">設備購置</option>
                <option value="文宣印刷">文宣印刷</option>
                <option value="交通費">交通費</option>
                <option value="其他">其他</option>
              </select>
              <label>類別 *</label>
            </div>
            <div class="form-floating mb-3">
              <input type="date" class="form-control" name="date" required>
              <label>日期 *</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" required style="height:100px;"></textarea>
              <label>說明 *</label>
            </div>
            <div class="mb-3">
              <label class="form-label">上傳憑證</label>
              <input type="file" class="form-control" name="receipt" accept="image/*,.pdf">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-gradient">送出申請</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  showModal(html, async (formData) => {
    const data = {
      lineId: userProfile.userId,
      amount: formData.get('amount'),
      category: formData.get('category'),
      date: formData.get('date'),
      description: formData.get('description')
    };
    
    // TODO: 處理檔案上傳
    
    await callAPI('addExpense', data);
    showNotification('支出申請已送出', 'success');
    await loadFinanceData();
  });
}

function showNewActivityModal() {
  const html = `
    <div class="modal fade" id="activityModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <form class="modal-content" id="activityForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>新增活動</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-12 mb-3">
                <div class="form-floating">
                  <input type="text" class="form-control" name="title" required>
                  <label>活動名稱 *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="date" class="form-control" name="date" required>
                  <label>日期 *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="time" class="form-control" name="time">
                  <label>時間</label>
                </div>
              </div>
              <div class="col-md-12 mb-3">
                <div class="form-floating">
                  <input type="text" class="form-control" name="location">
                  <label>地點</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="maxParticipants" required min="1">
                  <label>人數上限 *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="fee" min="0">
                  <label>費用</label>
                </div>
              </div>
              <div class="col-md-12 mb-3">
                <div class="form-floating">
                  <textarea class="form-control" name="description" style="height:100px;"></textarea>
                  <label>活動說明</label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-gradient">新增活動</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  showModal(html, async (formData) => {
    const data = {
      lineId: userProfile.userId,
      title: formData.get('title'),
      date: formData.get('date'),
      time: formData.get('time'),
      location: formData.get('location'),
      maxParticipants: formData.get('maxParticipants'),
      fee: formData.get('fee') || 0,
      description: formData.get('description')
    };
    
    await callAPI('addActivity', data);
    showNotification('活動已新增', 'success');
    await loadAdminData();
    await loadActivities();
  });
}

function showNewVolunteerNeedModal() {
  const html = `
    <div class="modal fade" id="volunteerModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="volunteerForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-people me-2"></i>新增志工需求</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="text" class="form-control" name="title" required>
              <label>需求名稱 *</label>
            </div>
            <div class="form-floating mb-3">
              <input type="date" class="form-control" name="date" required>
              <label>日期 *</label>
            </div>
            <div class="form-floating mb-3">
              <input type="time" class="form-control" name="time">
              <label>時間</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" name="needCount" required min="1">
              <label>需求人數 *</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" name="hours" required min="0.5" step="0.5">
              <label>服務時數 *</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" style="height:100px;"></textarea>
              <label>說明</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-gradient">新增需求</button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  showModal(html, async (formData) => {
    const data = {
      lineId: userProfile.userId,
      title: formData.get('title'),
      date: formData.get('date'),
      time: formData.get('time'),
      needCount: formData.get('needCount'),
      hours: formData.get('hours'),
      description: formData.get('description')
    };
    
    await callAPI('addVolunteerNeed', data);
    showNotification('志工需求已新增', 'success');
    await loadVolunteerData();
  });
}

// ==================== Modal 通用函數 ====================
function showModal(html, onSubmit) {
  const container = document.getElementById('modalContainer');
  container.innerHTML = html;
  
  const modalEl = container.querySelector('.modal');
  const modal = new bootstrap.Modal(modalEl);
  
  const form = modalEl.querySelector('form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const btn = form.querySelector('button[type="submit"]');
    setButtonLoading(btn, true);
    
    try {
      const formData = new FormData(form);
      await onSubmit(formData);
      modal.hide();
    } catch (error) {
      showNotification('操作失敗：' + error.message, 'error');
    } finally {
      setButtonLoading(btn, false);
    }
  });
  
  modalEl.addEventListener('hidden.bs.modal', () => {
    container.innerHTML = '';
  });
  
  modal.show();
}

// ==================== 管理功能 ====================
async function exportMembers() {
  try {
    showLoading(true);
    const response = await callAPI('exportMembers', { lineId: userProfile.userId });
    window.open(response.data.url, '_blank');
    showNotification('會員資料已匯出', 'success');
  } catch (error) {
    showNotification('匯出失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

async function exportFinanceData() {
  try {
    showLoading(true);
    const response = await callAPI('exportFinance', { lineId: userProfile.userId });
    window.open(response.data.url, '_blank');
    showNotification('財務報表已匯出', 'success');
  } catch (error) {
    showNotification('匯出失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

async function backupSystem() {
  if (!confirm('確定要執行系統備份嗎？')) return;
  
  try {
    showLoading(true);
    await callAPI('backupSystem', { lineId: userProfile.userId });
    showNotification('系統備份完成', 'success');
  } catch (error) {
    showNotification('備份失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

function viewMemberDetail(lineId) {
  // TODO: 顯示會員詳細資料
  showNotification('功能開發中', 'info');
}

function editActivity(activityId) {
  // TODO: 編輯活動
  showNotification('功能開發中', 'info');
}

// ==================== 頁面切換 ====================
function switchPage(pageName) {
  // 隱藏所有頁面
  document.querySelectorAll('.page-content').forEach(page => {
    page.classList.remove('active');
  });
  
  // 移除所有導航項目的 active 狀態
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // 顯示目標頁面
  document.getElementById(`page-${pageName}`).classList.add('active');
  
  // 設定對應導航項目為 active
  event.currentTarget.classList.add('active');
}

// ==================== 工具函數 ====================
function formatDate(dateString) {
  if (!dateString) return '-';
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
}

function formatDateInput(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toISOString().split('T')[0];
}

function formatCurrency(amount) {
  return new Intl.NumberFormat('zh-TW').format(amount);
}

function showLoading(show) {
  let overlay = document.querySelector('.loading-overlay');
  
  if (show) {
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.innerHTML = '<div class="loading-spinner"></div>';
      document.body.appendChild(overlay);
    }
  } else {
    if (overlay) {
      overlay.remove();
    }
  }
}

function setButtonLoading(button, loading) {
  if (loading) {
    button.disabled = true;
    button.dataset.originalText = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>處理中...';
  } else {
    button.disabled = false;
    button.innerHTML = button.dataset.originalText;
  }
}

function showNotification(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  
  const colors = {
    success: '#28a745',
    error: '#dc3545',
    warning: '#ffc107',
    info: '#17a2b8'
  };
  
  const icons = {
    success: 'check-circle-fill',
    error: 'x-circle-fill',
    warning: 'exclamation-triangle-fill',
    info: 'info-circle-fill'
  };
  
  const toast = document.createElement('div');
  toast.className = 'toast show';
  toast.style.cssText = `
    min-width: 250px;
    margin-bottom: 10px;
    background: white;
    border-left: 4px solid ${colors[type]};
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  `;
  
  toast.innerHTML = `
    <div class="toast-body d-flex align-items-center">
      <i class="bi bi-${icons[type]} me-2" style="color: ${colors[type]}; font-size: 20px;"></i>
      <span>${message}</span>
    </div>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ==================== 頁面載入完成 ====================
document.addEventListener('DOMContentLoaded', () => {
  console.log('📄 頁面 DOM 載入完成');
  console.log('🌐 User Agent:', navigator.userAgent);
  console.log('📍 當前 URL:', window.location.href);
  
  // 初始化 LIFF
  initLIFF();
});

// ==================== 腳本載入完成 ====================
console.log('✅ 腳本載入完成');
</script>

</body>
</html>


