<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ - æœƒå“¡ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .content {
      padding: 20px;
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    
    .menu-item {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      border-radius: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      font-size: 16px;
    }
    
    .menu-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    
    .menu-item .icon {
      font-size: 36px;
      margin-bottom: 10px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border 0.3s;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-secondary {
      background: #6c757d;
    }
    
    .btn-danger {
      background: #dc3545;
    }
    
    .card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }
    
    .card h3 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .card p {
      color: #666;
      margin: 5px 0;
      font-size: 14px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .info-row:last-child {
      border-bottom: none;
    }
    
    .info-label {
      font-weight: bold;
      color: #666;
    }
    
    .info-value {
      color: #333;
    }
    
    .back-btn {
      background: #6c757d;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
    }
    
    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    
    .alert {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .badge-success {
      background: #28a745;
      color: white;
    }
    
    .badge-warning {
      background: #ffc107;
      color: #333;
    }
    
    .badge-danger {
      background: #dc3545;
      color: white;
    }
    
    .user-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .user-info h2 {
      color: #667eea;
      margin-bottom: 5px;
    }
    
    .user-info p {
      color: #666;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¥ å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ</h1>
      <p>æœƒå“¡æœå‹™ç³»çµ±</p>
    </div>
    
    <div class="content">
      <!-- è¼‰å…¥ä¸­é é¢ -->
      <div id="loadingPage" class="page active">
        <div class="loading">ç³»çµ±åˆå§‹åŒ–ä¸­</div>
      </div>
      
      <!-- è¨»å†Šé é¢ -->
      <div id="registerPage" class="page">
        <h2 style="margin-bottom: 20px; color: #667eea;">æœƒå“¡è¨»å†Š</h2>
        <div id="registerAlert"></div>
        <form id="registerForm">
          <div class="form-group">
            <label>å§“å *</label>
            <input type="text" id="regName" required>
          </div>
          <div class="form-group">
            <label>é›»è©± *</label>
            <input type="tel" id="regPhone" required>
          </div>
          <div class="form-group">
            <label>é›»å­éƒµä»¶</label>
            <input type="email" id="regEmail">
          </div>
          <div class="form-group">
            <label>åœ°å€</label>
            <input type="text" id="regAddress">
          </div>
          <div class="form-group">
            <label>ç·Šæ€¥è¯çµ¡äºº</label>
            <input type="text" id="regEmergencyContact">
          </div>
          <div class="form-group">
            <label>ç·Šæ€¥è¯çµ¡é›»è©±</label>
            <input type="tel" id="regEmergencyPhone">
          </div>
          <button type="submit" class="btn">è¨»å†Š</button>
        </form>
      </div>
      
      <!-- ä¸»é¸å–®é é¢ -->
      <div id="mainPage" class="page">
        <div class="user-info">
          <h2 id="userName">è¼‰å…¥ä¸­...</h2>
          <p id="userType">æœƒå“¡é¡å‹</p>
        </div>
        
        <div class="menu-grid">
          <button class="menu-item" onclick="showPage('activitiesPage')">
            <div class="icon">ğŸ“…</div>
            <div>æ´»å‹•å ±å</div>
          </button>
          <button class="menu-item" onclick="showPage('myActivitiesPage')">
            <div class="icon">ğŸ“‹</div>
            <div>æˆ‘çš„æ´»å‹•</div>
          </button>
          <button class="menu-item" onclick="showPage('healthPage')">
            <div class="icon">ğŸ’Š</div>
            <div>å¥åº·ç´€éŒ„</div>
          </button>
          <button class="menu-item" onclick="showPage('medicationPage')">
            <div class="icon">ğŸ’‰</div>
            <div>ç”¨è—¥æ­·ç¨‹</div>
          </button>
          <button class="menu-item" onclick="showPage('donationPage')">
            <div class="icon">ğŸ’</div>
            <div>ææ¬¾ç´€éŒ„</div>
          </button>
          <button class="menu-item" onclick="showPage('volunteerPage')">
            <div class="icon">ğŸ¤</div>
            <div>å¿—å·¥æœå‹™</div>
          </button>
          <button class="menu-item" onclick="showPage('profilePage')">
            <div class="icon">ğŸ‘¤</div>
            <div>å€‹äººè³‡æ–™</div>
          </button>
          <button class="menu-item" onclick="liff.closeWindow()">
            <div class="icon">ğŸšª</div>
            <div>é›¢é–‹ç³»çµ±</div>
          </button>
        </div>
      </div>
      
      <!-- æ´»å‹•å ±åé é¢ -->
      <div id="activitiesPage" class="page">
        <button class="back-btn" onclick="showPage('mainPage')">â† è¿”å›</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">æ´»å‹•å ±å</h2>
        <div id="activitiesList"></div>
      </div>
      
      <!-- æˆ‘çš„æ´»å‹•é é¢ -->
      <div id="myActivitiesPage" class="page">
        <button class="back-btn" onclick="showPage('mainPage')">â† è¿”å›</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">æˆ‘çš„æ´»å‹•</h2>
        <div id="myActivitiesList"></div>
      </div>
      
      <!-- å¥åº·ç´€éŒ„é é¢ -->
      <div id="healthPage" class="page">
        <button class="back-btn" onclick="showPage('mainPage')">â† è¿”å›</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">å¥åº·ç´€éŒ„</h2>
        <button class="btn" onclick="showPage('addHealthPage')">+ æ–°å¢ç´€éŒ„</button>
        <div id="healthList" style="margin-top: 20px;"></div>
      </div>
      
      <!-- æ–°å¢å¥åº·ç´€éŒ„é é¢ -->
      <div id="addHealthPage" class="page">
        <button class="back-btn" onclick="showPage('healthPage')">â† è¿”å›</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">æ–°å¢å¥åº·ç´€éŒ„</h2>
        <form id="healthForm">
          <div class="form-group">
            <label>æ”¶ç¸®å£“ (mmHg)</label>
            <input type="number" id="healthSystolic">
          </div>
          <div class="form-group">
            <label>èˆ’å¼µå£“ (mmHg)</label>
            <input type="number" id="healthDiastolic">
          </div>
          <div class="form-group">
            <label>å¿ƒè·³ (æ¬¡/åˆ†)</label>
            <input type="number" id="healthHeartRate">
          </div>
          <div class="form-group">
            <label>é«”æº« (Â°C)</label>
            <input type="number" step="0.1" id="healthTemperature">
          </div>
          <div class="form-group">
            <label>ç—‡ç‹€æè¿°</label>
            <textarea id="healthSymptoms" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>å‚™è¨»</label>
            <textarea id="healthNote" rows="2"></textarea>
          </div>
          <button type="submit" class="btn">å„²å­˜</button>
        </form>
      </div>
      
      <!-- ç”¨è—¥æ­·ç¨‹é é¢ -->
      <div id="medicationPage" class="page">
        <button class="back-btn" onclick="showPage('mainPage')">â† è¿”å›</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">ç”¨è—¥æ­·ç¨‹</h2>
        <button class="btn" onclick="showPage('addMedicationPage')">+ æ–°å¢ç´€éŒ„</button>
        <div id="medicationList" style="margin-top: 20px;"></div>
      </div>
      
      <!-- æ–°å¢ç”¨è—¥ç´€éŒ„é é¢ -->
      <div id="addMedicationPage" class="page">
        <button class="back-btn" onclick="showPage('medicationPage')">â† è¿”å›</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">æ–°å¢ç”¨è—¥ç´€éŒ„</h2>
        <form id="medicationForm">
          <div class="form-group">
            <label>è—¥å“åç¨± *</label>
            <input type="text" id="medName" required>
          </div>
          <div class="form-group">
            <label>åŠ‘é‡ *</label>
            <input type="text" id="medDosage" required>
          </div>
          <div class="form-group">
            <label>ç”¨è—¥æ™‚é–“ *</label>
            <input type="time" id="medTime" required>
          </div>
          <div class="form-group">
            <label>å‰¯ä½œç”¨</label>
            <textarea id="medSideEffects" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>å‚™è¨»</label>
            <textarea id="medNote" rows="2"></textarea>
          </div>
          <button type="submit" class="btn">å„²å­˜</button>
        </form>
      </div>
      
      <!-- ææ¬¾ç´€éŒ„é é¢ -->
      <div id="donationPage" class="page">
        <button class="back-btn" onclick="showPage('mainPage')">â† è¿”å›</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">ææ¬¾ç´€éŒ„</h2>
        <button class="btn" onclick="showPage('addDonationPage')">+ æ–°å¢ææ¬¾</button>
        <div id="donationList" style="margin-top: 20px;"></div>
      </div>
      
      <!-- æ–°å¢ææ¬¾é é¢ -->
      <div id="addDonationPage" class="page">
        <button class="back-btn" onclick="showPage('donationPage')">â† è¿”å›</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">æ–°å¢ææ¬¾</h2>
        <form id="donationForm">
          <div class="form-group">
            <label>ææ¬¾é‡‘é¡ *</label>
            <input type="number" id="donAmount" required>
          </div>
          <div class="form-group">
            <label>ææ¬¾æ–¹å¼ *</label>
            <select id="donMethod" required>
              <option value="">è«‹é¸æ“‡</option>
              <option value="ç¾é‡‘">ç¾é‡‘</option>
              <option value="åŒ¯æ¬¾">åŒ¯æ¬¾</option>
              <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
              <option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
            </select>
          </div>
          <div class="form-group">
            <label>å‚™è¨»</label>
            <textarea id="donNote" rows="2"></textarea>
          </div>
          <button type="submit" class="btn">é€å‡º</button>
        </form>
      </div>
      
      <!-- å¿—å·¥æœå‹™é é¢ -->
      <div id="volunteerPage" class="page">
        <button class="back-btn" onclick="showPage('mainPage')">â† è¿”å›</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">å¿—å·¥æœå‹™</h2>
        <div id="volunteerList"></div>
      </div>
      
      <!-- å€‹äººè³‡æ–™é é¢ -->
      <div id="profilePage" class="page">
        <button class="back-btn" onclick="showPage('mainPage')">â† è¿”å›</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">å€‹äººè³‡æ–™</h2>
        <div id="profileInfo"></div>
        <button class="btn" onclick="showPage('editProfilePage')" style="margin-top: 20px;">ç·¨è¼¯è³‡æ–™</button>
      </div>
      
      <!-- ç·¨è¼¯å€‹äººè³‡æ–™é é¢ -->
      <div id="editProfilePage" class="page">
        <button class="back-btn" onclick="showPage('profilePage')">â† è¿”å›</button>
        <h2 style="margin-bottom: 20px; color: #667eea;">ç·¨è¼¯å€‹äººè³‡æ–™</h2>
        <form id="editProfileForm">
          <div class="form-group">
            <label>å§“å</label>
            <input type="text" id="editName">
          </div>
          <div class="form-group">
            <label>é›»è©±</label>
            <input type="tel" id="editPhone">
          </div>
          <div class="form-group">
            <label>é›»å­éƒµä»¶</label>
            <input type="email" id="editEmail">
          </div>
          <div class="form-group">
            <label>åœ°å€</label>
            <input type="text" id="editAddress">
          </div>
          <div class="form-group">
            <label>ç·Šæ€¥è¯çµ¡äºº</label>
            <input type="text" id="editEmergencyContact">
          </div>
          <div class="form-group">
            <label>ç·Šæ€¥è¯çµ¡é›»è©±</label>
            <input type="tel" id="editEmergencyPhone">
          </div>
          <button type="submit" class="btn">å„²å­˜</button>
        </form>
      </div>
    </div>
  </div>
  
  <script>
    // ==================== è¨­å®šå€ ====================
    const LIFF_ID = '1656516134-VaGgmaPm'; // è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwEbScN-r1UVwppUwbTwULuq6M1Vm2eko4EkCZpD_CCI8WkTInQk5O752ENwRTIchj70Q/exec'; // è«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS Web App URL
    
    let currentUser = null;
    let lineProfile = null;
    
    // ==================== LIFF åˆå§‹åŒ– ====================
    window.onload = function() {
      liff.init({
        liffId: LIFF_ID
      }).then(() => {
        if (liff.isLoggedIn()) {
          liff.getProfile().then(profile => {
            lineProfile = profile;
            checkMemberStatus();
          });
        } else {
          liff.login();
        }
      }).catch((err) => {
        alert('LIFFåˆå§‹åŒ–å¤±æ•—: ' + err);
      });
    };
    
    // ==================== æª¢æŸ¥æœƒå“¡ç‹€æ…‹ ====================
    async function checkMemberStatus() {
      try {
        const response = await callAPI('login', {
          lineId: lineProfile.userId
        });
        
        if (response.success) {
          currentUser = response.member;
          showPage('mainPage');
          loadUserInfo();
        } else {
          showPage('registerPage');
        }
      } catch (error) {
        alert('ç³»çµ±éŒ¯èª¤: ' + error);
      }
    }
    
    // ==================== API å‘¼å«å‡½æ•¸ ====================
    async function callAPI(action, params) {
      const response = await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: action,
          ...params
        })
      });
      return await response.json();
    }
    
    // ==================== é é¢åˆ‡æ› ====================
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
      
      // è¼‰å…¥å°æ‡‰é é¢è³‡æ–™
      if (pageId === 'activitiesPage') loadActivities();
      if (pageId === 'myActivitiesPage') loadMyActivities();
      if (pageId === 'healthPage') loadHealthRecords();
      if (pageId === 'medicationPage') loadMedicationRecords();
      if (pageId === 'donationPage') loadDonations();
      if (pageId === 'volunteerPage') loadVolunteerRecords();
      if (pageId === 'profilePage') loadProfile();
      if (pageId === 'editProfilePage') loadEditProfile();
    }
    
    // ==================== è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š ====================
    function loadUserInfo() {
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userType').textContent = currentUser.memberType;
    }
    
    // ==================== æœƒå“¡è¨»å†Š ====================
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const data = {
        lineId: lineProfile.userId,
        name: document.getElementById('regName').value,
        phone: document.getElementById('regPhone').value,
        email: document.getElementById('regEmail').value,
        address: document.getElementById('regAddress').value,
        emergencyContact: document.getElementById('regEmergencyContact').value,
        emergencyPhone: document.getElementById('regEmergencyPhone').value
      };
      
      try {
        const response = await callAPI('register', data);
        
        if (response.success) {
          alert('è¨»å†ŠæˆåŠŸï¼');
          checkMemberStatus();
        } else {
          showAlert('registerAlert', response.message, 'error');
        }
      } catch (error) {
        showAlert('registerAlert', 'è¨»å†Šå¤±æ•—: ' + error, 'error');
      }
    });
    
    // ==================== è¼‰å…¥æ´»å‹•åˆ—è¡¨ ====================
    async function loadActivities() {
      const listDiv = document.getElementById('activitiesList');
      listDiv.innerHTML = '<div class="loading">è¼‰å…¥ä¸­</div>';
      
      try {
        const response = await callAPI('getActivities', {});
        
        if (response.success && response.activities.length > 0) {
          let html = '';
          response.activities.forEach(activity => {
            const isFull = activity.currentParticipants >= activity.maxParticipants;
            html += `
              <div class="card">
                <h3>${activity.name}</h3>
                <p>ğŸ“… æ—¥æœŸï¼š${formatDate(activity.date)}</p>
                <p>â° æ™‚é–“ï¼š${activity.time}</p>
                <p>ğŸ“ åœ°é»ï¼š${activity.location}</p>
                <p>ğŸ‘¥ äººæ•¸ï¼š${activity.currentParticipants}/${activity.maxParticipants}</p>
                <p>ğŸ“ èªªæ˜ï¼š${activity.description}</p>
                <button class="btn ${isFull ? 'btn-secondary' : ''}" 
                        onclick="registerForActivity('${activity.activityId}')"
                        ${isFull ? 'disabled' : ''}>
                  ${isFull ? 'å·²é¡æ»¿' : 'ç«‹å³å ±å'}
                </button>
              </div>
            `;
          });
          listDiv.innerHTML = html;
        } else {
          listDiv.innerHTML = '<p style="text-align: center; color: #999;">ç›®å‰æ²’æœ‰æ´»å‹•</p>';
        }
      } catch (error) {
        listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">è¼‰å…¥å¤±æ•—</p>';
      }
    }
    
    // ==================== å ±åæ´»å‹• ====================
    async function registerForActivity(activityId) {
      if (!confirm('ç¢ºå®šè¦å ±åæ­¤æ´»å‹•å—ï¼Ÿ')) return;
      
      try {
        const response = await callAPI('registerActivity', {
          memberId: currentUser.memberId,
          activityId: activityId
        });
        
        if (response.success) {
          alert('å ±åæˆåŠŸï¼');
          loadActivities();
        } else {
          alert(response.message);
        }
      } catch (error) {
        alert('å ±åå¤±æ•—: ' + error);
      }
    }
    
    // ==================== è¼‰å…¥æˆ‘çš„æ´»å‹• ====================
    async function loadMyActivities() {
      const listDiv = document.getElementById('myActivitiesList');
      listDiv.innerHTML = '<div class="loading">è¼‰å…¥ä¸­</div>';
      
      try {
        const response = await callAPI('getMyActivities', {
          memberId: currentUser.memberId
        });
        
        if (response.success && response.activities.length > 0) {
          let html = '';
          response.activities.forEach(activity => {
            const statusClass = activity.status === 'å·²å ±å' ? 'success' : 
                               activity.status === 'å·²å–æ¶ˆ' ? 'danger' : 'warning';
            html += `
              <div class="card">
                <h3>${activity.name}</h3>
                <p>ğŸ“… æ—¥æœŸï¼š${formatDate(activity.date)}</p>
                <p>â° æ™‚é–“ï¼š${activity.time}</p>
                <p>ğŸ“ åœ°é»ï¼š${activity.location}</p>
                <p>ç‹€æ…‹ï¼š<span class="badge badge-${statusClass}">${activity.status}</span></p>
              </div>
            `;
          });
          listDiv.innerHTML = html;
        } else {
          listDiv.innerHTML = '<p style="text-align: center; color: #999;">å°šæœªå ±åä»»ä½•æ´»å‹•</p>';
        }
      } catch (error) {
        listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">è¼‰å…¥å¤±æ•—</p>';
      }
    }
    
    // ==================== è¼‰å…¥å¥åº·ç´€éŒ„ ====================
    async function loadHealthRecords() {
      const listDiv = document.getElementById('healthList');
      listDiv.innerHTML = '<div class="loading">è¼‰å…¥ä¸­</div>';
      
      try {
        const response = await callAPI('getHealthRecords', {
          memberId: currentUser.memberId
        });
        
        if (response.success && response.records.length > 0) {
          let html = '';
          response.records.forEach(record => {
            html += `
              <div class="card">
                <h3>ğŸ“… ${formatDate(record.date)}</h3>
                ${record.systolic ? `<p>ğŸ©º è¡€å£“ï¼š${record.systolic}/${record.diastolic} mmHg</p>` : ''}
                ${record.heartRate ? `<p>ğŸ’“ å¿ƒè·³ï¼š${record.heartRate} æ¬¡/åˆ†</p>` : ''}
                ${record.temperature ? `<p>ğŸŒ¡ï¸ é«”æº«ï¼š${record.temperature} Â°C</p>` : ''}
                ${record.symptoms ? `<p>ğŸ“ ç—‡ç‹€ï¼š${record.symptoms}</p>` : ''}
                ${record.note ? `<p>ğŸ’¬ å‚™è¨»ï¼š${record.note}</p>` : ''}
              </div>
            `;
          });
          listDiv.innerHTML = html;
        } else {
          listDiv.innerHTML = '<p style="text-align: center; color: #999;">å°šç„¡å¥åº·ç´€éŒ„</p>';
        }
      } catch (error) {
        listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">è¼‰å…¥å¤±æ•—</p>';
        }
      }
      
      // ==================== æ–°å¢å¥åº·ç´€éŒ„ ====================
      document.getElementById('healthForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const data = {
          memberId: currentUser.memberId,
          systolic: document.getElementById('healthSystolic').value,
          diastolic: document.getElementById('healthDiastolic').value,
          heartRate: document.getElementById('healthHeartRate').value,
          temperature: document.getElementById('healthTemperature').value,
          symptoms: document.getElementById('healthSymptoms').value,
          note: document.getElementById('healthNote').value
        };
        
        try {
          const response = await callAPI('addHealthRecord', data);
          
          if (response.success) {
            alert('å¥åº·ç´€éŒ„å·²å„²å­˜ï¼');
            this.reset();
            showPage('healthPage');
          } else {
            alert(response.message);
          }
        } catch (error) {
          alert('å„²å­˜å¤±æ•—: ' + error);
        }
      });
      
      // ==================== è¼‰å…¥ç”¨è—¥ç´€éŒ„ ====================
      async function loadMedicationRecords() {
        const listDiv = document.getElementById('medicationList');
        listDiv.innerHTML = '<div class="loading">è¼‰å…¥ä¸­</div>';
        
        try {
          const response = await callAPI('getMedicationRecords', {
            memberId: currentUser.memberId
          });
          
          if (response.success && response.records.length > 0) {
            let html = '';
            response.records.forEach(record => {
              html += `
                <div class="card">
                  <h3>ğŸ’Š ${record.medicationName}</h3>
                  <p>ğŸ“… æ—¥æœŸï¼š${formatDate(record.date)}</p>
                  <p>â° æ™‚é–“ï¼š${record.time}</p>
                  <p>ğŸ’‰ åŠ‘é‡ï¼š${record.dosage}</p>
                  ${record.sideEffects ? `<p>âš ï¸ å‰¯ä½œç”¨ï¼š${record.sideEffects}</p>` : ''}
                  ${record.note ? `<p>ğŸ’¬ å‚™è¨»ï¼š${record.note}</p>` : ''}
                </div>
              `;
            });
            listDiv.innerHTML = html;
          } else {
            listDiv.innerHTML = '<p style="text-align: center; color: #999;">å°šç„¡ç”¨è—¥ç´€éŒ„</p>';
          }
        } catch (error) {
          listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">è¼‰å…¥å¤±æ•—</p>';
        }
      }
      
      // ==================== æ–°å¢ç”¨è—¥ç´€éŒ„ ====================
      document.getElementById('medicationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const data = {
          memberId: currentUser.memberId,
          medicationName: document.getElementById('medName').value,
          dosage: document.getElementById('medDosage').value,
          time: document.getElementById('medTime').value,
          sideEffects: document.getElementById('medSideEffects').value,
          note: document.getElementById('medNote').value
        };
        
        try {
          const response = await callAPI('addMedicationRecord', data);
          
          if (response.success) {
            alert('ç”¨è—¥ç´€éŒ„å·²å„²å­˜ï¼');
            this.reset();
            showPage('medicationPage');
          } else {
            alert(response.message);
          }
        } catch (error) {
          alert('å„²å­˜å¤±æ•—: ' + error);
        }
      });
      
      // ==================== è¼‰å…¥ææ¬¾ç´€éŒ„ ====================
      async function loadDonations() {
        const listDiv = document.getElementById('donationList');
        listDiv.innerHTML = '<div class="loading">è¼‰å…¥ä¸­</div>';
        
        try {
          const response = await callAPI('getDonations', {
            memberId: currentUser.memberId
          });
          
          if (response.success && response.donations.length > 0) {
            let html = '';
            let total = 0;
            response.donations.forEach(donation => {
              total += parseFloat(donation.amount);
              html += `
                <div class="card">
                  <h3>ğŸ’ NT$ ${donation.amount.toLocaleString()}</h3>
                  <p>ğŸ“… æ—¥æœŸï¼š${formatDate(donation.date)}</p>
                  <p>ğŸ’³ æ–¹å¼ï¼š${donation.method}</p>
                  ${donation.note ? `<p>ğŸ’¬ å‚™è¨»ï¼š${donation.note}</p>` : ''}
                </div>
              `;
            });
            html = `<div class="alert alert-success">ç´¯è¨ˆææ¬¾ï¼šNT$ ${total.toLocaleString()}</div>` + html;
            listDiv.innerHTML = html;
          } else {
            listDiv.innerHTML = '<p style="text-align: center; color: #999;">å°šç„¡ææ¬¾ç´€éŒ„</p>';
          }
        } catch (error) {
          listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">è¼‰å…¥å¤±æ•—</p>';
        }
      }
      
      // ==================== æ–°å¢ææ¬¾ ====================
      document.getElementById('donationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const data = {
          memberId: currentUser.memberId,
          amount: document.getElementById('donAmount').value,
          method: document.getElementById('donMethod').value,
          note: document.getElementById('donNote').value
        };
        
        try {
          const response = await callAPI('addDonation', data);
          
          if (response.success) {
            alert('ææ¬¾ç´€éŒ„å·²æ–°å¢ï¼Œæ„Ÿè¬æ‚¨çš„æ”¯æŒï¼');
            this.reset();
            showPage('donationPage');
          } else {
            alert(response.message);
          }
        } catch (error) {
          alert('æ–°å¢å¤±æ•—: ' + error);
        }
      });
      
      // ==================== è¼‰å…¥å¿—å·¥ç´€éŒ„ ====================
      async function loadVolunteerRecords() {
        const listDiv = document.getElementById('volunteerList');
        listDiv.innerHTML = '<div class="loading">è¼‰å…¥ä¸­</div>';
        
        try {
          const response = await callAPI('getVolunteerRecords', {
            memberId: currentUser.memberId
          });
          
          if (response.success && response.records.length > 0) {
            let html = '';
            let totalHours = 0;
            response.records.forEach(record => {
              totalHours += parseFloat(record.hours);
              html += `
                <div class="card">
                  <h3>ğŸ¤ ${record.activityName}</h3>
                  <p>ğŸ“… æ—¥æœŸï¼š${formatDate(record.date)}</p>
                  <p>â±ï¸ æ™‚æ•¸ï¼š${record.hours} å°æ™‚</p>
                  ${record.note ? `<p>ğŸ’¬ å‚™è¨»ï¼š${record.note}</p>` : ''}
                </div>
              `;
            });
            html = `<div class="alert alert-success">ç´¯è¨ˆæœå‹™æ™‚æ•¸ï¼š${totalHours} å°æ™‚</div>` + html;
            listDiv.innerHTML = html;
          } else {
            listDiv.innerHTML = '<p style="text-align: center; color: #999;">å°šç„¡å¿—å·¥ç´€éŒ„</p>';
          }
        } catch (error) {
          listDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">è¼‰å…¥å¤±æ•—</p>';
        }
      }
      
      // ==================== è¼‰å…¥å€‹äººè³‡æ–™ ====================
      async function loadProfile() {
        const infoDiv = document.getElementById('profileInfo');
        infoDiv.innerHTML = `
          <div class="info-row">
            <span class="info-label">å§“å</span>
            <span class="info-value">${currentUser.name}</span>
          </div>
          <div class="info-row">
            <span class="info-label">é›»è©±</span>
            <span class="info-value">${currentUser.phone}</span>
          </div>
          <div class="info-row">
            <span class="info-label">é›»å­éƒµä»¶</span>
            <span class="info-value">${currentUser.email || 'æœªè¨­å®š'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">åœ°å€</span>
            <span class="info-value">${currentUser.address || 'æœªè¨­å®š'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">æœƒå“¡é¡å‹</span>
            <span class="info-value">${currentUser.memberType}</span>
          </div>
          <div class="info-row">
            <span class="info-label">åŠ å…¥æ—¥æœŸ</span>
            <span class="info-value">${formatDate(currentUser.joinDate)}</span>
          </div>
          <div class="info-row">
            <span class="info-label">ç·Šæ€¥è¯çµ¡äºº</span>
            <span class="info-value">${currentUser.emergencyContact || 'æœªè¨­å®š'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">ç·Šæ€¥è¯çµ¡é›»è©±</span>
            <span class="info-value">${currentUser.emergencyPhone || 'æœªè¨­å®š'}</span>
          </div>
        `;
      }
      
      // ==================== è¼‰å…¥ç·¨è¼¯è³‡æ–™è¡¨å–® ====================
      function loadEditProfile() {
        document.getElementById('editName').value = currentUser.name;
        document.getElementById('editPhone').value = currentUser.phone;
        document.getElementById('editEmail').value = currentUser.email || '';
        document.getElementById('editAddress').value = currentUser.address || '';
        document.getElementById('editEmergencyContact').value = currentUser.emergencyContact || '';
        document.getElementById('editEmergencyPhone').value = currentUser.emergencyPhone || '';
      }
      
      // ==================== æ›´æ–°å€‹äººè³‡æ–™ ====================
      document.getElementById('editProfileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const data = {
          memberId: currentUser.memberId,
          name: document.getElementById('editName').value,
          phone: document.getElementById('editPhone').value,
          email: document.getElementById('editEmail').value,
          address: document.getElementById('editAddress').value,
          emergencyContact: document.getElementById('editEmergencyContact').value,
          emergencyPhone: document.getElementById('editEmergencyPhone').value
        };
        
        try {
          const response = await callAPI('updateProfile', data);
          
          if (response.success) {
            alert('è³‡æ–™æ›´æ–°æˆåŠŸï¼');
            currentUser = { ...currentUser, ...data };
            showPage('profilePage');
          } else {
            alert(response.message);
          }
        } catch (error) {
          alert('æ›´æ–°å¤±æ•—: ' + error);
        }
      });
      
      // ==================== å·¥å…·å‡½æ•¸ ====================
      function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit' 
        });
      }
      
      function showAlert(elementId, message, type) {
        const alertDiv = document.getElementById(elementId);
        alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => {
          alertDiv.innerHTML = '';
        }, 3000);
      }
    </script>
  </body>
  </html>
