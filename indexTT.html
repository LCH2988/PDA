<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BOGOæ¶è³¼æ´»å‹•ç®¡ç†ç³»çµ±</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Microsoft JhengHei', Arial, sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
padding: 20px;
}

.container {
max-width: 1400px;
margin: 0 auto;
}

.header {
background: white;
border-radius: 15px;
padding: 30px;
margin-bottom: 20px;
box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.header h1 {
color: #667eea;
font-size: 32px;
margin-bottom: 10px;
}

.header p {
color: #666;
font-size: 14px;
}

.nav-tabs {
display: flex;
gap: 10px;
margin-bottom: 20px;
flex-wrap: wrap;
}

.nav-tab {
background: white;
border: none;
padding: 15px 25px;
border-radius: 10px;
cursor: pointer;
font-weight: bold;
font-size: 14px;
color: #666;
transition: all 0.3s;
box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.nav-tab:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.nav-tab.active {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
}

.content {
display: none;
background: white;
border-radius: 15px;
padding: 30px;
box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.content.active {
display: block;
}

.section-title {
font-size: 24px;
color: #667eea;
margin-bottom: 20px;
padding-bottom: 10px;
border-bottom: 3px solid #667eea;
}

.form-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 20px;
margin-bottom: 20px;
}

.form-group {
display: flex;
flex-direction: column;
}

.form-group label {
font-weight: bold;
color: #333;
margin-bottom: 8px;
font-size: 14px;
}

.form-control {
padding: 12px;
border: 2px solid #e0e0e0;
border-radius: 8px;
font-size: 14px;
transition: border 0.3s;
}

.form-control:focus {
outline: none;
border-color: #667eea;
}

.btn {
padding: 12px 24px;
border: none;
border-radius: 8px;
font-weight: bold;
cursor: pointer;
transition: all 0.3s;
font-size: 14px;
}

.btn-primary {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
}

.btn-primary:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
}

.btn-success {
background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
color: white;
}

.btn-success:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px rgba(17, 153, 142, 0.4);
}

.btn-danger {
background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
color: white;
}

.btn-info {
background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
color: white;
}

.btn-group {
display: flex;
gap: 10px;
flex-wrap: wrap;
}

.table-container {
overflow-x: auto;
margin-top: 20px;
border-radius: 10px;
box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

table {
width: 100%;
border-collapse: collapse;
background: white;
}

thead {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
}

th, td {
padding: 15px;
text-align: left;
border-bottom: 1px solid #e0e0e0;
}

th {
font-weight: bold;
font-size: 14px;
}

tbody tr:hover {
background: #f8f9ff;
}

.badge {
display: inline-block;
padding: 5px 12px;
border-radius: 20px;
font-size: 12px;
font-weight: bold;
}

.badge-success {
background: #d4edda;
color: #155724;
}

.badge-warning {
background: #fff3cd;
color: #856404;
}

.badge-danger {
background: #f8d7da;
color: #721c24;
}

.badge-info {
background: #d1ecf1;
color: #0c5460;
}

.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 20px;
margin-bottom: 30px;
}

.stat-card {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
padding: 25px;
border-radius: 15px;
box-shadow: 0 6px 12px rgba(0,0,0,0.15);
transition: transform 0.3s;
}

.stat-card:hover {
transform: translateY(-5px);
}

.stat-card h3 {
font-size: 14px;
opacity: 0.9;
margin-bottom: 10px;
}

.stat-card .number {
font-size: 32px;
font-weight: bold;
}

.member-selector {
border: 2px solid #e0e0e0;
border-radius: 10px;
padding: 20px;
margin-bottom: 20px;
}

.member-list {
max-height: 300px;
overflow-y: auto;
border: 1px solid #e0e0e0;
border-radius: 8px;
padding: 10px;
}

.member-item {
padding: 10px;
margin-bottom: 5px;
border-radius: 5px;
cursor: pointer;
transition: background 0.3s;
display: flex;
align-items: center;
gap: 10px;
}

.member-item:hover {
background: #f0f0f0;
}

.member-item.selected {
background: #e8f0fe;
border: 2px solid #667eea;
}

.member-item input[type="checkbox"],
.member-item input[type="radio"] {
width: 18px;
height: 18px;
cursor: pointer;
}

.alert {
padding: 15px 20px;
border-radius: 8px;
margin-bottom: 20px;
font-weight: bold;
}

.alert-success {
background: #d4edda;
color: #155724;
border: 1px solid #c3e6cb;
}

.alert-error {
background: #f8d7da;
color: #721c24;
border: 1px solid #f5c6cb;
}

.hidden {
display: none;
}

.loading-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.7);
display: flex;
align-items: center;
justify-content: center;
z-index: 9999;
}

.loading-spinner {
background: white;
padding: 30px;
border-radius: 15px;
text-align: center;
}

.spinner {
border: 4px solid #f3f3f3;
border-top: 4px solid #667eea;
border-radius: 50%;
width: 50px;
height: 50px;
animation: spin 1s linear infinite;
margin: 0 auto 15px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
.form-grid {
  grid-template-columns: 1fr;
}

.stats-grid {
  grid-template-columns: 1fr;
}
}
</style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay hidden">
<div class="loading-spinner">
  <div class="spinner"></div>
  <p>è¼‰å…¥ä¸­...</p>
</div>
</div>

<div class="container">
<div class="header">
<h1>ğŸ›’ BOGOæ¶è³¼æ´»å‹•ç®¡ç†ç³»çµ±</h1>
<p>Buy One Get One - çµ„ç¹”åœ˜éšŠæ¶è³¼ç®¡ç†å¹³å°ï¼ˆé›²ç«¯ç‰ˆï¼‰</p>
</div>

<div class="nav-tabs">
<button class="nav-tab active" onclick="switchTab('setup')">ğŸ“‹ æ¶è³¼è¨­å®š</button>
<button class="nav-tab" onclick="switchTab('execute')">ğŸš€ åŸ·è¡Œæ¶è³¼</button>
<button class="nav-tab" onclick="switchTab('report')">ğŸ“Š å›å ±ç‹€æ³</button>
<button class="nav-tab" onclick="switchTab('stats-product')">ğŸ“ˆ ç”¢å“çµ±è¨ˆ</button>
<button class="nav-tab" onclick="switchTab('stats-account')">ğŸ‘¤ å¸³è™Ÿçµ±è¨ˆ</button>
<button class="nav-tab" onclick="switchTab('stats-generation')">ğŸŒ³ ä»£æ•¸çµ±è¨ˆ</button>
<button class="nav-tab" onclick="switchTab('manage')">âš™ï¸ åŸºç¤ç®¡ç†</button>
</div>

<!-- æ¶è³¼è¨­å®š -->
<div id="setup" class="content active">
<h2 class="section-title">æ¶è³¼æ´»å‹•è¨­å®š</h2>

<div class="form-grid">
  <div class="form-group">
    <label>é¸æ“‡ç”¢å“</label>
    <select id="setupProduct" class="form-control">
      <option value="">è«‹é¸æ“‡ç”¢å“...</option>
    </select>
  </div>
  <div class="form-group">
    <label>é è³¼æ•¸é‡</label>
    <input type="number" id="setupQuantity" class="form-control" min="1" placeholder="è¼¸å…¥æ•¸é‡">
  </div>
  <div class="form-group">
    <label>æ¶è³¼æ—¥æœŸ</label>
    <input type="date" id="setupDate" class="form-control">
  </div>
</div>

<div class="member-selector">
  <h3 style="margin-bottom: 15px;">é¸æ“‡æ¶è³¼å¸³è™Ÿ</h3>
  <div class="btn-group" style="margin-bottom: 15px;">
    <button class="btn btn-info" onclick="selectAllAccounts()">å…¨é¸</button>
    <button class="btn btn-info" onclick="deselectAllAccounts()">å–æ¶ˆå…¨é¸</button>
    <button class="btn btn-info" onclick="selectByGeneration()">æŒ‰ä»£æ•¸é¸æ“‡</button>
  </div>
  <div class="member-list" id="accountList">
    <!-- å‹•æ…‹ç”Ÿæˆ -->
  </div>
</div>

<div class="member-selector">
  <h3 style="margin-bottom: 15px;">é¸æ“‡æ¶è³¼å“¡</h3>
  <div class="member-list" id="buyerList">
    <!-- å‹•æ…‹ç”Ÿæˆ -->
  </div>
</div>

<div class="btn-group">
  <button class="btn btn-success" onclick="saveSetup()">ğŸ’¾ å„²å­˜è¨­å®š</button>
  <button class="btn btn-primary" onclick="previewSetup()">ğŸ‘ï¸ é è¦½è¨­å®š</button>
</div>

<div id="setupAlert" class="hidden"></div>

<div class="table-container" style="margin-top: 30px;">
  <h3 style="margin-bottom: 15px;">ä»Šæ—¥æ¶è³¼è¨­å®šåˆ—è¡¨</h3>
  <table>
    <thead>
      <tr>
        <th>ç”¢å“ä»£è™Ÿ</th>
        <th>ç”¢å“åç¨±</th>
        <th>é è³¼æ•¸é‡</th>
        <th>æ¶è³¼å¸³è™Ÿæ•¸</th>
        <th>æ¶è³¼å“¡</th>
        <th>ç‹€æ…‹</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="setupListBody">
      <!-- å‹•æ…‹ç”Ÿæˆ -->
    </tbody>
  </table>
</div>
</div>

<!-- åŸ·è¡Œæ¶è³¼ -->
<div id="execute" class="content">
<h2 class="section-title">åŸ·è¡Œæ¶è³¼</h2>

<div class="stats-grid">
  <div class="stat-card">
    <h3>å¾…åŸ·è¡Œä»»å‹™</h3>
    <div class="number" id="pendingTasks">0</div>
  </div>
  <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
    <h3>åŸ·è¡Œä¸­ä»»å‹™</h3>
    <div class="number" id="executingTasks">0</div>
  </div>
  <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
    <h3>å·²å®Œæˆä»»å‹™</h3>
    <div class="number" id="completedTasks">0</div>
  </div>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>ä»»å‹™ID</th>
        <th>ç”¢å“è³‡è¨Š</th>
        <th>æ¶è³¼å¸³è™Ÿ</th>
        <th>æ•¸é‡</th>
        <th>æ¶è³¼å“¡</th>
        <th>ç‹€æ…‹</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="executeListBody">
      <!-- å‹•æ…‹ç”Ÿæˆ -->
    </tbody>
  </table>
</div>
</div>

<!-- å›å ±ç‹€æ³ -->
<div id="report" class="content">
<h2 class="section-title">æ¶è³¼å›å ±</h2>

<div class="form-grid">
  <div class="form-group">
    <label>é¸æ“‡ä»»å‹™</label>
    <select id="reportTask" class="form-control" onchange="loadTaskDetails()">
      <option value="">è«‹é¸æ“‡ä»»å‹™...</option>
    </select>
  </div>
</div>

<div id="taskDetails" class="hidden" style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
  <!-- ä»»å‹™è©³æƒ… -->
</div>

<div class="form-grid">
  <div class="form-group">
    <label>å¯¦éš›æ¶è³¼æ•¸é‡</label>
    <input type="number" id="reportQuantity" class="form-control" min="0" placeholder="è¼¸å…¥å¯¦éš›æ•¸é‡">
  </div>
  <div class="form-group">
    <label>å›å ±ç‹€æ…‹</label>
    <select id="reportStatus" class="form-control">
      <option value="completed">âœ… å®Œæˆ</option>
      <option value="partial">âš ï¸ éƒ¨åˆ†å®Œæˆ</option>
      <option value="failed">âŒ å¤±æ•—</option>
    </select>
  </div>
</div>

<div class="form-group">
  <label>å‚™è¨»èªªæ˜</label>
  <textarea id="reportNote" class="form-control" rows="4" placeholder="è¼¸å…¥å‚™è¨»..."></textarea>
</div>

<button class="btn btn-success" onclick="submitReport()">ğŸ“ æäº¤å›å ±</button>

<div id="reportAlert" class="hidden"></div>

<div class="table-container" style="margin-top: 30px;">
  <h3 style="margin-bottom: 15px;">å›å ±è¨˜éŒ„</h3>
  <table>
    <thead>
      <tr>
        <th>å›å ±æ™‚é–“</th>
        <th>ä»»å‹™ID</th>
        <th>ç”¢å“</th>
        <th>é è³¼/å¯¦éš›</th>
        <th>æ¶è³¼å“¡</th>
        <th>ç‹€æ…‹</th>
        <th>å‚™è¨»</th>
      </tr>
    </thead>
    <tbody id="reportListBody">
      <!-- å‹•æ…‹ç”Ÿæˆ -->
    </tbody>
  </table>
</div>
</div>

<!-- ç”¢å“çµ±è¨ˆ -->
<div id="stats-product" class="content">
<h2 class="section-title">ç”¢å“çµ±è¨ˆå ±è¡¨</h2>

<div class="form-grid">
  <div class="form-group">
    <label>é–‹å§‹æ—¥æœŸ</label>
    <input type="date" id="productStatsFrom" class="form-control">
  </div>
  <div class="form-group">
    <label>çµæŸæ—¥æœŸ</label>
    <input type="date" id="productStatsTo" class="form-control">
  </div>
  <div class="form-group" style="display: flex; align-items: flex-end;">
    <button class="btn btn-primary" onclick="loadProductStats()">ğŸ“Š ç”Ÿæˆå ±è¡¨</button>
  </div>
</div>

<div class="stats-grid">
  <div class="stat-card">
    <h3>ç¸½ç”¢å“æ•¸</h3>
    <div class="number" id="totalProducts">0</div>
  </div>
  <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
    <h3>ç¸½é è³¼æ•¸é‡</h3>
    <div class="number" id="totalPreOrder">0</div>
  </div>
  <div class="stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
    <h3>ç¸½æ¶è³¼æ•¸é‡</h3>
    <div class="number" id="totalActualOrder">0</div>
  </div>
  <div class="stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
    <h3>ç¸½é‡‘é¡</h3>
    <div class="number" id="totalAmount">$0</div>
  </div>
  <div class="stat-card" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
    <h3>ç¸½PVæ•¸</h3>
    <div class="number" id="totalPV">0</div>
  </div>
</div>

<div class="btn-group" style="margin-bottom: 20px;">
  <button class="btn btn-success" onclick="exportProductStats()">ğŸ“¥ åŒ¯å‡ºCSV</button>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>ç”¢å“ä»£è™Ÿ</th>
        <th>ç”¢å“åç¨±</th>
        <th>å–®åƒ¹</th>
        <th>PVæ•¸</th>
        <th>é è³¼æ•¸é‡</th>
        <th>æ¶è³¼æ•¸é‡</th>
        <th>åˆè¨ˆé‡‘é¡</th>
        <th>åˆè¨ˆPVæ•¸</th>
      </tr>
    </thead>
    <tbody id="productStatsBody">
      <!-- å‹•æ…‹ç”Ÿæˆ -->
    </tbody>
  </table>
</div>
</div>

<!-- å¸³è™Ÿçµ±è¨ˆ -->
<div id="stats-account" class="content">
<h2 class="section-title">æ¶è³¼å¸³è™Ÿçµ±è¨ˆå ±è¡¨</h2>

<div class="form-grid">
  <div class="form-group">
    <label>é–‹å§‹æ—¥æœŸ</label>
    <input type="date" id="accountStatsFrom" class="form-control">
  </div>
  <div class="form-group">
    <label>çµæŸæ—¥æœŸ</label>
    <input type="date" id="accountStatsTo" class="form-control">
  </div>
  <div class="form-group" style="display: flex; align-items: flex-end;">
    <button class="btn btn-primary" onclick="loadAccountStats()">ğŸ“Š ç”Ÿæˆå ±è¡¨</button>
  </div>
</div>

<div class="btn-group" style="margin-bottom: 20px;">
  <button class="btn btn-success" onclick="exportAccountStats()">ğŸ“¥ åŒ¯å‡ºCSV</button>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>æ¶è³¼å¸³è™Ÿ</th>
        <th>å§“å</th>
        <th>ä¸Šç·šID</th>
        <th>ä¸Šç·šåç¨±</th>
        <th>ä»£æ•¸</th>
        <th>ç”¢å“ä»£è™Ÿ</th>
        <th>ç”¢å“åç¨±</th>
        <th>åˆè¨ˆæ•¸é‡</th>
        <th>åˆè¨ˆPVæ•¸</th>
      </tr>
    </thead>
    <tbody id="accountStatsBody">
      <!-- å‹•æ…‹ç”Ÿæˆ -->
    </tbody>
  </table>
</div>
</div>

<!-- ä»£æ•¸çµ±è¨ˆ -->
<div id="stats-generation" class="content">
<h2 class="section-title">ä»£æ•¸çµ±è¨ˆå ±è¡¨</h2>

<div class="form-grid">
  <div class="form-group">
    <label>é–‹å§‹æ—¥æœŸ</label>
    <input type="date" id="generationStatsFrom" class="form-control">
  </div>
  <div class="form-group">
    <label>çµæŸæ—¥æœŸ</label>
    <input type="date" id="generationStatsTo" class="form-control">
  </div>
  <div class="form-group">
    <label>é¸æ“‡ä»£æ•¸</label>
    <select id="generationFilter" class="form-control">
      <option value="">å…¨éƒ¨ä»£æ•¸</option>
      <option value="1">ç¬¬1ä»£</option>
      <option value="2">ç¬¬2ä»£</option>
      <option value="3">ç¬¬3ä»£</option>
      <option value="4">ç¬¬4ä»£</option>
      <option value="5">ç¬¬5ä»£</option>
    </select>
  </div>
  <div class="form-group" style="display: flex; align-items: flex-end;">
    <button class="btn btn-primary" onclick="loadGenerationStats()">ğŸ“Š ç”Ÿæˆå ±è¡¨</button>
  </div>
</div>

<div class="btn-group" style="margin-bottom: 20px;">
  <button class="btn btn-success" onclick="exportGenerationStats()">ğŸ“¥ åŒ¯å‡ºCSV</button>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>ä»£æ•¸</th>
        <th>1ä»£åç¨±</th>
        <th>æ¶è³¼å¸³è™Ÿ</th>
        <th>å¸³è™Ÿåç¨±</th>
        <th>ç”¢å“ä»£è™Ÿ</th>
        <th>ç”¢å“åç¨±</th>
        <th>åˆè¨ˆæ•¸é‡</th>
        <th>åˆè¨ˆPVæ•¸</th>
      </tr>
    </thead>
    <tbody id="generationStatsBody">
      <!-- å‹•æ…‹ç”Ÿæˆ -->
    </tbody>
  </table>
</div>
</div>

<!-- åŸºç¤ç®¡ç† -->
<div id="manage" class="content">
<h2 class="section-title">åŸºç¤è³‡æ–™ç®¡ç†</h2>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px;">
  <!-- ç”¢å“ç®¡ç† -->
  <div>
    <h3 style="margin-bottom: 15px; color: #667eea;">ç”¢å“ç®¡ç†</h3>
    <div class="form-group">
      <label>ç”¢å“ä»£è™Ÿ</label>
      <input type="text" id="productCode" class="form-control" placeholder="ä¾‹ï¼šP001">
    </div>
    <div class="form-group">
      <label>ç”¢å“åç¨±</label>
      <input type="text" id="productName" class="form-control" placeholder="ç”¢å“åç¨±">
    </div>
    <div class="form-group">
      <label>å–®åƒ¹</label>
      <input type="number" id="productPrice" class="form-control" placeholder="0.00" step="0.01">
    </div>
    <div class="form-group">
      <label>PVæ•¸</label>
      <input type="number" id="productPV" class="form-control" placeholder="0">
    </div>
    <button class="btn btn-success" onclick="addProduct()">â• æ–°å¢ç”¢å“</button>
    
    <div class="table-container" style="margin-top: 20px;">
      <table>
        <thead>
          <tr>
            <th>ä»£è™Ÿ</th>
            <th>åç¨±</th>
            <th>å–®åƒ¹</th>
            <th>PV</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="productListBody">
          <!-- å‹•æ…‹ç”Ÿæˆ -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- çµ„ç¹”æˆå“¡ç®¡ç† -->
  <div>
    <h3 style="margin-bottom: 15px; color: #667eea;">çµ„ç¹”æˆå“¡ç®¡ç†</h3>
    <div class="form-group">
      <label>æˆå“¡ID</label>
      <input type="text" id="memberId" class="form-control" placeholder="ä¾‹ï¼šM001">
    </div>
    <div class="form-group">
      <label>å§“å</label>
      <input type="text" id="memberName" class="form-control" placeholder="å§“å">
    </div>
    <div class="form-group">
      <label>ä»£æ•¸</label>
      <input type="number" id="memberGeneration" class="form-control" placeholder="1" min="1">
    </div>
    <div class="form-group">
      <label>ä¸Šç·šID</label>
      <input type="text" id="memberParentId" class="form-control" placeholder="ä¸Šç·šIDï¼ˆç¬¬1ä»£å¯ç•™ç©ºï¼‰">
    </div>
    <button class="btn btn-success" onclick="addMember()">â• æ–°å¢æˆå“¡</button>
    
    <div class="table-container" style="margin-top: 20px;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>å§“å</th>
            <th>ä»£æ•¸</th>
            <th>ä¸Šç·š</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="memberListBody">
          <!-- å‹•æ…‹ç”Ÿæˆ -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- æ¶è³¼å“¡ç®¡ç† -->
  <div>
    <h3 style="margin-bottom: 15px; color: #667eea;">æ¶è³¼å“¡ç®¡ç†</h3>
    <div class="form-group">
      <label>æ¶è³¼å“¡ID</label>
      <input type="text" id="buyerId" class="form-control" placeholder="ä¾‹ï¼šB001">
    </div>
    <div class="form-group">
      <label>å§“å</label>
      <input type="text" id="buyerName" class="form-control" placeholder="å§“å">
    </div>
    <div class="form-group">
      <label>è¯çµ¡é›»è©±</label>
      <input type="text" id="buyerPhone" class="form-control" placeholder="é›»è©±">
    </div>
    <button class="btn btn-success" onclick="addBuyer()">â• æ–°å¢æ¶è³¼å“¡</button>
    
    <div class="table-container" style="margin-top: 20px;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>å§“å</th>
            <th>é›»è©±</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="buyerListBody">
          <!-- å‹•æ…‹ç”Ÿæˆ -->
        </tbody>
      </table>
    </div>
  </div>
</div>
</div>
</div>

<script>
// ============================================
// API è¨­å®š
// ============================================
// è«‹å°‡æ­¤ URL æ›¿æ›ç‚ºæ‚¨çš„ Google Apps Script Web App URL
const API_URL = 'https://script.google.com/macros/s/AKfycbz-bFclgxNGopga8Bnj3tUf4vClnjr_IoMavTf3_2hGyHa3ViBPW8nYvlCIzdoEmkYd/exec';

// è³‡æ–™å„²å­˜
let data = {
products: [],
members: [],
buyers: [],
setups: [],
tasks: [],
reports: []
};

// ============================================
// è¼‰å…¥èˆ‡é¡¯ç¤ºå‡½æ•¸
// ============================================

function showLoading() {
document.getElementById('loadingOverlay').classList.remove('hidden');
}

function hideLoading() {
document.getElementById('loadingOverlay').classList.add('hidden');
}

function showAlert(elementId, type, message) {
const alertDiv = document.getElementById(elementId);
alertDiv.className = type === 'success' ? 'alert alert-success' : 'alert alert-error';
alertDiv.textContent = message;
alertDiv.classList.remove('hidden');

setTimeout(() => {
  alertDiv.classList.add('hidden');
}, 3000);
}

// ============================================
// API å‘¼å«å‡½æ•¸
// ============================================

async function callAPI(action, params = {}) {
try {
  const url = new URL(API_URL);
  url.searchParams.append('action', action);
  
  Object.keys(params).forEach(key => {
    if (params[key] !== null && params[key] !== undefined) {
      url.searchParams.append(key, params[key]);
    }
  });
  
  const response = await fetch(url.toString());
  const result = await response.json();
  
  if (!result.success) {
    throw new Error(result.error || 'æœªçŸ¥éŒ¯èª¤');
  }
  
  return result;
} catch (error) {
  console.error('API å‘¼å«éŒ¯èª¤:', error);
  throw error;
}
}

async function callAPIPost(action, postData = {}) {
try {
  const response = await fetch(API_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      action: action,
      ...postData
    })
  });
  
  const result = await response.json();
  
  if (!result.success) {
    throw new Error(result.error || 'æœªçŸ¥éŒ¯èª¤');
  }
  
  return result;
} catch (error) {
  console.error('API POST å‘¼å«éŒ¯èª¤:', error);
  throw error;
}
}

// ============================================
// åˆå§‹åŒ–
// ============================================

async function init() {
showLoading();
try {
  await loadAllData();
  renderAll();
  setDefaultDates();
} catch (error) {
  alert('åˆå§‹åŒ–å¤±æ•—: ' + error.message);
} finally {
  hideLoading();
}
}

async function loadAllData() {
try {
  const result = await callAPI('getAllData');
  data = result.data;
} catch (error) {
  console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
  throw error;
}
}

function setDefaultDates() {
const today = new Date().toISOString().split('T')[0];
document.getElementById('setupDate').value = today;
document.getElementById('productStatsFrom').value = today;
document.getElementById('productStatsTo').value = today;
document.getElementById('accountStatsFrom').value = today;
document.getElementById('accountStatsTo').value = today;
document.getElementById('generationStatsFrom').value = today;
document.getElementById('generationStatsTo').value = today;
}

function renderAll() {
renderSetupPage();
renderExecutePage();
renderReportPage();
renderManagePage();
}

function switchTab(tabName) {
document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));

event.target.classList.add('active');
document.getElementById(tabName).classList.add('active');

if (tabName === 'setup') renderSetupPage();
if (tabName === 'execute') renderExecutePage();
if (tabName === 'report') renderReportPage();
if (tabName === 'manage') renderManagePage();
}

// ============================================
// æ¶è³¼è¨­å®š
// ============================================

function renderSetupPage() {
const productSelect = document.getElementById('setupProduct');
productSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç”¢å“...</option>';
data.products.forEach(p => {
  productSelect.innerHTML += `<option value="${p.code}">${p.name} (${p.code}) - $${p.price} | ${p.pv} PV</option>`;
});

const accountList = document.getElementById('accountList');
accountList.innerHTML = '';
data.members.forEach(m => {
  const parentName = m.parentId ? data.members.find(p => p.id === m.parentId)?.name || '' : '';
  accountList.innerHTML += `
    <div class="member-item" onclick="toggleMemberSelection(this, '${m.id}')">
      <input type="checkbox" data-member-id="${m.id}" onclick="event.stopPropagation()">
      <div>
        <strong>${m.name}</strong> (${m.id})
        <br><small>ç¬¬${m.generation}ä»£ ${parentName ? '| ä¸Šç·š: ' + parentName : ''}</small>
      </div>
    </div>
  `;
});

const buyerList = document.getElementById('buyerList');
buyerList.innerHTML = '';
data.buyers.forEach(b => {
  buyerList.innerHTML += `
    <div class="member-item" onclick="toggleBuyerSelection(this, '${b.id}')">
      <input type="radio" name="buyer" data-buyer-id="${b.id}" onclick="event.stopPropagation()">
      <div>
        <strong>${b.name}</strong> (${b.id})
        <br><small>${b.phone}</small>
      </div>
    </div>
  `;
});

renderSetupList();
}

function toggleMemberSelection(element, memberId) {
const checkbox = element.querySelector('input[type="checkbox"]');
checkbox.checked = !checkbox.checked;
element.classList.toggle('selected', checkbox.checked);
}

function toggleBuyerSelection(element, buyerId) {
document.querySelectorAll('#buyerList .member-item').forEach(item => {
  item.classList.remove('selected');
});
element.classList.add('selected');
element.querySelector('input[type="radio"]').checked = true;
}

function selectAllAccounts() {
document.querySelectorAll('#accountList .member-item').forEach(item => {
  item.classList.add('selected');
  item.querySelector('input[type="checkbox"]').checked = true;
});
}

function deselectAllAccounts() {
document.querySelectorAll('#accountList .member-item').forEach(item => {
  item.classList.remove('selected');
  item.querySelector('input[type="checkbox"]').checked = false;
});
}

function selectByGeneration() {
const gen = prompt('è«‹è¼¸å…¥è¦é¸æ“‡çš„ä»£æ•¸ (1-5):');
if (!gen) return;

document.querySelectorAll('#accountList .member-item').forEach(item => {
  const checkbox = item.querySelector('input[type="checkbox"]');
  const memberId = checkbox.dataset.memberId;
  const member = data.members.find(m => m.id === memberId);
  
  if (member && member.generation == gen) {
    item.classList.add('selected');
    checkbox.checked = true;
  }
});
}

async function saveSetup() {
const productCode = document.getElementById('setupProduct').value;
const quantity = parseInt(document.getElementById('setupQuantity').value);
const date = document.getElementById('setupDate').value;

if (!productCode || !quantity || !date) {
  showAlert('setupAlert', 'error', 'è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
  return;
}

const selectedAccounts = [];
document.querySelectorAll('#accountList input[type="checkbox"]:checked').forEach(cb => {
  selectedAccounts.push(cb.dataset.memberId);
});

if (selectedAccounts.length === 0) {
  showAlert('setupAlert', 'error', 'è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¶è³¼å¸³è™Ÿ');
  return;
}

const selectedBuyer = document.querySelector('#buyerList input[type="radio"]:checked');
if (!selectedBuyer) {
  showAlert('setupAlert', 'error', 'è«‹é¸æ“‡æ¶è³¼å“¡');
  return;
}

const setup = {
  id: 'S' + Date.now(),
  productCode,
  quantity,
  date,
  accounts: selectedAccounts,
  buyerId: selectedBuyer.dataset.buyerId,
  status: 'pending',
  createdAt: new Date().toISOString()
};

const tasks = selectedAccounts.map(accountId => ({
  id: 'T' + Date.now() + Math.random().toString(36).substr(2, 9),
  setupId: setup.id,
  productCode,
  accountId,
  buyerId: setup.buyerId,
  quantity: Math.ceil(quantity / selectedAccounts.length),
  status: 'pending',
  createdAt: new Date().toISOString()
}));

showLoading();
try {
  await callAPIPost('saveSetup', { setup });
  await callAPIPost('saveTasks', { tasks });
  
  data.setups.push(setup);
  data.tasks.push(...tasks);
  
  showAlert('setupAlert', 'success', 'æ¶è³¼è¨­å®šå·²å„²å­˜ï¼');
  renderSetupList();
  
  document.getElementById('setupProduct').value = '';
  document.getElementById('setupQuantity').value = '';
  deselectAllAccounts();
} catch (error) {
  showAlert('setupAlert', 'error', 'å„²å­˜å¤±æ•—: ' + error.message);
} finally {
  hideLoading();
}
}

function renderSetupList() {
const tbody = document.getElementById('setupListBody');
const todaySetups = data.setups.filter(s => s.date === new Date().toISOString().split('T')[0]);

if (todaySetups.length === 0) {
  tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">æš«ç„¡ä»Šæ—¥è¨­å®š</td></tr>';
  return;
}

tbody.innerHTML = '';
todaySetups.forEach(setup => {
  const product = data.products.find(p => p.code === setup.productCode);
  const buyer = data.buyers.find(b => b.id === setup.buyerId);
  
  const statusBadge = setup.status === 'pending' ? 'badge-warning' : 
                     setup.status === 'executing' ? 'badge-info' : 'badge-success';
  const statusText = setup.status === 'pending' ? 'å¾…åŸ·è¡Œ' : 
                    setup.status === 'executing' ? 'åŸ·è¡Œä¸­' : 'å·²å®Œæˆ';
  
  tbody.innerHTML += `
    <tr>
      <td>${setup.productCode}</td>
      <td>${product?.name || '-'}</td>
      <td>${setup.quantity}</td>
      <td>${setup.accounts.length}</td>
      <td>${buyer?.name || '-'}</td>
      <td><span class="badge ${statusBadge}">${statusText}</span></td>
      <td>
        <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteSetup('${setup.id}')">åˆªé™¤</button>
      </td>
    </tr>
  `;
});
}

async function deleteSetup(setupId) {
if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨­å®šå—ï¼Ÿ')) return;

showLoading();
try {
  await callAPIPost('deleteSetup', { id: setupId });
  
  data.setups = data.setups.filter(s => s.id !== setupId);
  data.tasks = data.tasks.filter(t => t.setupId !== setupId);
  
  renderSetupList();
} catch (error) {
  alert('åˆªé™¤å¤±æ•—: ' + error.message);
} finally {
  hideLoading();
}
}

function previewSetup() {
const productCode = document.getElementById('setupProduct').value;
const quantity = parseInt(document.getElementById('setupQuantity').value);

if (!productCode || !quantity) {
  alert('è«‹å…ˆé¸æ“‡ç”¢å“å’Œæ•¸é‡');
  return;
}

const selectedAccounts = [];
document.querySelectorAll('#accountList input[type="checkbox"]:checked').forEach(cb => {
  selectedAccounts.push(cb.dataset.memberId);
});

if (selectedAccounts.length === 0) {
  alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¶è³¼å¸³è™Ÿ');
  return;
}

const product = data.products.find(p => p.code === productCode);
const qtyPerAccount = Math.ceil(quantity / selectedAccounts.length);

let preview = `ç”¢å“: ${product.name}\nç¸½æ•¸é‡: ${quantity}\n`;
preview += `åˆ†é…çµ¦ ${selectedAccounts.length} å€‹å¸³è™Ÿï¼Œæ¯å€‹ç´„ ${qtyPerAccount} å€‹\n\n`;
preview += `ç¸½é‡‘é¡: $${(quantity * product.price).toLocaleString()}\n`;
preview += `ç¸½PV: ${quantity * product.pv}\n\n`;
preview += `å¸³è™Ÿåˆ—è¡¨:\n`;

selectedAccounts.forEach(id => {
  const member = data.members.find(m => m.id === id);
  preview += `- ${member.name} (${id})\n`;
});

alert(preview);
}

// ============================================
// åŸ·è¡Œæ¶è³¼
// ============================================

function renderExecutePage() {
const pending = data.tasks.filter(t => t.status === 'pending').length;
const executing = data.tasks.filter(t => t.status === 'executing').length;
const completed = data.tasks.filter(t => t.status === 'completed').length;

document.getElementById('pendingTasks').textContent = pending;
document.getElementById('executingTasks').textContent = executing;
document.getElementById('completedTasks').textContent = completed;

const tbody = document.getElementById('executeListBody');
tbody.innerHTML = '';

data.tasks.forEach(task => {
  const product = data.products.find(p => p.code === task.productCode);
  const account = data.members.find(m => m.id === task.accountId);
  const buyer = data.buyers.find(b => b.id === task.buyerId);
  
  const statusBadge = task.status === 'pending' ? 'badge-warning' : 
                     task.status === 'executing' ? 'badge-info' : 'badge-success';
  const statusText = task.status === 'pending' ? 'å¾…åŸ·è¡Œ' : 
                    task.status === 'executing' ? 'åŸ·è¡Œä¸­' : 'å·²å®Œæˆ';
  
  tbody.innerHTML += `
    <tr>
      <td>${task.id}</td>
      <td>${product?.name || '-'} (${task.productCode})</td>
      <td>${account?.name || '-'} (${task.accountId})</td>
      <td>${task.quantity}</td>
      <td>${buyer?.name || '-'}</td>
      <td><span class="badge ${statusBadge}">${statusText}</span></td>
      <td>
        ${task.status === 'pending' ? `<button class="btn btn-primary" style="padding: 5px 10px;" onclick="startTask('${task.id}')">é–‹å§‹</button>` : ''}
        ${task.status === 'executing' ? `<button class="btn btn-success" style="padding: 5px 10px;" onclick="completeTask('${task.id}')">å®Œæˆ</button>` : ''}
      </td>
    </tr>
  `;
});
}

async function startTask(taskId) {
showLoading();
try {
  await callAPIPost('updateTaskStatus', { taskId, status: 'executing' });
  
  const task = data.tasks.find(t => t.id === taskId);
  if (task) {
    task.status = 'executing';
    task.startedAt = new Date().toISOString();
  }
  
  renderExecutePage();
} catch (error) {
  alert('æ›´æ–°å¤±æ•—: ' + error.message);
} finally {
  hideLoading();
}
}

async function completeTask(taskId) {
showLoading();
try {
  await callAPIPost('updateTaskStatus', { taskId, status: 'completed' });
  
  const task = data.tasks.find(t => t.id === taskId);
  if (task) {
    task.status = 'completed';
    task.completedAt = new Date().toISOString();
  }
  
  renderExecutePage();
} catch (error) {
  alert('æ›´æ–°å¤±æ•—: ' + error.message);
} finally {
  hideLoading();
}
}

// ============================================
// å›å ±ç‹€æ³
// ============================================

function renderReportPage() {
const taskSelect = document.getElementById('reportTask');
taskSelect.innerHTML = '<option value="">è«‹é¸æ“‡ä»»å‹™...</option>';

data.tasks.filter(t => t.status !== 'pending').forEach(task => {
  const product = data.products.find(p => p.code === task.productCode);
  const account = data.members.find(m => m.id === task.accountId);
  taskSelect.innerHTML += `<option value="${task.id}">${task.id} - ${product?.name} - ${account?.name}</option>`;
});

renderReportList();
}

function loadTaskDetails() {
const taskId = document.getElementById('reportTask').value;
const detailsDiv = document.getElementById('taskDetails');

if (!taskId) {
  detailsDiv.classList.add('hidden');
  return;
}

const task = data.tasks.find(t => t.id === taskId);
const product = data.products.find(p => p.code === task.productCode);
const account = data.members.find(m => m.id === task.accountId);
const buyer = data.buyers.find(b => b.id === task.buyerId);

detailsDiv.innerHTML = `
  <h3 style="color: #667eea; margin-bottom: 15px;">ä»»å‹™è©³æƒ…</h3>
  <p><strong>ä»»å‹™ID:</strong> ${task.id}</p>
  <p><strong>ç”¢å“:</strong> ${product?.name} (${task.productCode})</p>
  <p><strong>æ¶è³¼å¸³è™Ÿ:</strong> ${account?.name} (${task.accountId})</p>
  <p><strong>æ¶è³¼å“¡:</strong> ${buyer?.name}</p>
  <p><strong>é å®šæ•¸é‡:</strong> ${task.quantity}</p>
  <p><strong>ç‹€æ…‹:</strong> ${task.status === 'executing' ? 'åŸ·è¡Œä¸­' : 'å·²å®Œæˆ'}</p>
`;
detailsDiv.classList.remove('hidden');
}

async function submitReport() {
const taskId = document.getElementById('reportTask').value;
const quantity = parseInt(document.getElementById('reportQuantity').value);
const status = document.getElementById('reportStatus').value;
const note = document.getElementById('reportNote').value;

if (!taskId || isNaN(quantity)) {
  showAlert('reportAlert', 'error', 'è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
  return;
}

const report = {
  id: 'R' + Date.now(),
  taskId,
  actualQuantity: quantity,
  status,
  note,
  createdAt: new Date().toISOString()
};

showLoading();
try {
  await callAPIPost('submitReport', { report });
  
  data.reports.push(report);
  
  const task = data.tasks.find(t => t.id === taskId);
  if (task) {
    task.actualQuantity = quantity;
    task.reportStatus = status;
    task.status = 'completed';
  }
  
  showAlert('reportAlert', 'success', 'å›å ±å·²æäº¤ï¼');
  
  document.getElementById('reportTask').value = '';
  document.getElementById('reportQuantity').value = '';
  document.getElementById('reportNote').value = '';
  document.getElementById('taskDetails').classList.add('hidden');
  
  renderReportList();
} catch (error) {
  showAlert('reportAlert', 'error', 'æäº¤å¤±æ•—: ' + error.message);
} finally {
  hideLoading();
}
}

function renderReportList() {
const tbody = document.getElementById('reportListBody');

if (data.reports.length === 0) {
  tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">æš«ç„¡å›å ±è¨˜éŒ„</td></tr>';
  return;
}

tbody.innerHTML = '';
data.reports.slice().reverse().forEach(report => {
  const task = data.tasks.find(t => t.id === report.taskId);
  const product = data.products.find(p => p.code === task?.productCode);
  const buyer = data.buyers.find(b => b.id === task?.buyerId);
  
  const statusBadge = report.status === 'completed' ? 'badge-success' : 
                     report.status === 'partial' ? 'badge-warning' : 'badge-danger';
  const statusText = report.status === 'completed' ? 'å®Œæˆ' : 
                    report.status === 'partial' ? 'éƒ¨åˆ†å®Œæˆ' : 'å¤±æ•—';
  
  tbody.innerHTML += `
    <tr>
      <td>${new Date(report.createdAt).toLocaleString()}</td>
      <td>${report.taskId}</td>
      <td>${product?.name || '-'}</td>
      <td>${task?.quantity || 0} / ${report.actualQuantity}</td>
      <td>${buyer?.name || '-'}</td>
      <td><span class="badge ${statusBadge}">${statusText}</span></td>
      <td>${report.note || '-'}</td>
    </tr>
  `;
});
}

// ============================================
// çµ±è¨ˆå ±è¡¨
// ============================================

async function loadProductStats() {
const from = document.getElementById('productStatsFrom').value;
const to = document.getElementById('productStatsTo').value;

showLoading();
try {
  const result = await callAPI('getProductStats', { dateFrom: from, dateTo: to });
  const statsArray = result.data;
  
  document.getElementById('totalProducts').textContent = statsArray.length;
  document.getElementById('totalPreOrder').textContent = statsArray.reduce((sum, s) => sum + s.preOrderQty, 0);
  document.getElementById('totalActualOrder').textContent = statsArray.reduce((sum, s) => sum + s.actualQty, 0);
  
  const totalAmount = statsArray.reduce((sum, s) => sum + (s.actualQty * s.price), 0);
  document.getElementById('totalAmount').textContent = '$' + totalAmount.toLocaleString();
  
  const totalPV = statsArray.reduce((sum, s) => sum + (s.actualQty * s.pv), 0);
  document.getElementById('totalPV').textContent = totalPV.toLocaleString();
  
  const tbody = document.getElementById('productStatsBody');
  tbody.innerHTML = '';
  
  statsArray.forEach(stat => {
    tbody.innerHTML += `
      <tr>
        <td>${stat.code}</td>
        <td>${stat.name}</td>
        <td>$${stat.price.toLocaleString()}</td>
        <td>${stat.pv}</td>
        <td>${stat.preOrderQty}</td>
        <td>${stat.actualQty}</td>
        <td><strong>$${(stat.actualQty * stat.price).toLocaleString()}</strong></td>
        <td><strong>${(stat.actualQty * stat.pv).toLocaleString()}</strong></td>
      </tr>
    `;
  });
} catch (error) {
  alert('è¼‰å…¥çµ±è¨ˆå¤±æ•—: ' + error.message);
} finally {
  hideLoading();
}
}

async function loadAccountStats() {
const from = document.getElementById('accountStatsFrom').value;
const to = document.getElementById('accountStatsTo').value;

showLoading();
try {
  const result = await callAPI('getAccountStats', { dateFrom: from, dateTo: to });
  const stats = result.data;
  
  const tbody = document.getElementById('accountStatsBody');
  tbody.innerHTML = '';
  
  stats.forEach(stat => {
    tbody.innerHTML += `
      <tr>
        <td>${stat.accountId}</td>
        <td>${stat.accountName}</td>
        <td>${stat.parentId}</td>
        <td>${stat.parentName}</td>
        <td>ç¬¬${stat.generation}ä»£</td>
        <td>${stat.productCode}</td>
        <td>${stat.productName}</td>
        <td>${stat.quantity}</td>
        <td><strong>${stat.totalPV.toLocaleString()}</strong></td>
      </tr>
    `;
  });
} catch (error) {
  alert('è¼‰å…¥çµ±è¨ˆå¤±æ•—: ' + error.message);
} finally {
  hideLoading();
}
}

async function loadGenerationStats() {
const from = document.getElementById('generationStatsFrom').value;
const to = document.getElementById('generationStatsTo').value;
const genFilter = document.getElementById('generationFilter').value;

showLoading();
try {
  const result = await callAPI('getGenerationStats', { 
    dateFrom: from, 
    dateTo: to,
    generation: genFilter
  });
  const stats = result.data;
  
  const tbody = document.getElementById('generationStatsBody');
  tbody.innerHTML = '';
  
  stats.forEach(stat => {
    tbody.innerHTML += `
      <tr>
        <td>ç¬¬${stat.generation}ä»£</td>
        <td>${stat.firstGenName}</td>
        <td>${stat.accountId}</td>
        <td>${stat.accountName}</td>
        <td>${stat.productCode}</td>
        <td>${stat.productName}</td>
        <td>${stat.quantity}</td>
        <td><strong>${stat.totalPV.toLocaleString()}</strong></td>
      </tr>
    `;
  });
} catch (error) {
  alert('è¼‰å…¥çµ±è¨ˆå¤±æ•—: ' + error.message);
} finally {
  hideLoading();
}
}

// ============================================
// åŒ¯å‡ºåŠŸèƒ½
// ============================================

function exportProductStats() {
const tbody = document.getElementById('productStatsBody');
const rows = tbody.querySelectorAll('tr');

let csv = 'ç”¢å“ä»£è™Ÿ,ç”¢å“åç¨±,å–®åƒ¹,PVæ•¸,é è³¼æ•¸é‡,æ¶è³¼æ•¸é‡,åˆè¨ˆé‡‘é¡,åˆè¨ˆPVæ•¸\n';

rows.forEach(row => {
  const cells = row.querySelectorAll('td');
  const rowData = Array.from(cells).map(cell => cell.textContent.replace(/,/g, '')).join(',');
  csv += rowData + '\n';
});

downloadCSV(csv, 'ç”¢å“çµ±è¨ˆå ±è¡¨.csv');
}

function exportAccountStats() {
const tbody = document.getElementById('accountStatsBody');
const rows = tbody.querySelectorAll('tr');

let csv = 'æ¶è³¼å¸³è™Ÿ,å§“å,ä¸Šç·šID,ä¸Šç·šåç¨±,ä»£æ•¸,ç”¢å“ä»£è™Ÿ,ç”¢å“åç¨±,åˆè¨ˆæ•¸é‡,åˆè¨ˆPVæ•¸\n';

rows.forEach(row => {
  const cells = row.querySelectorAll('td');
  const rowData = Array.from(cells).map(cell => cell.textContent.replace(/,/g, '')).join(',');
  csv += rowData + '\n';
});

downloadCSV(csv, 'å¸³è™Ÿçµ±è¨ˆå ±è¡¨.csv');
}

function exportGenerationStats() {
const tbody = document.getElementById('generationStatsBody');
const rows = tbody.querySelectorAll('tr');

let csv = 'ä»£æ•¸,1ä»£åç¨±,æ¶è³¼å¸³è™Ÿ,å¸³è™Ÿåç¨±,ç”¢å“ä»£è™Ÿ,ç”¢å“åç¨±,åˆè¨ˆæ•¸é‡,åˆè¨ˆPVæ•¸\n';

rows.forEach(row => {
  const cells = row.querySelectorAll('td');
  const rowData = Array.from(cells).map(cell => cell.textContent.replace(/,/g, '')).join(',');
  csv += rowData + '\n';
});

downloadCSV(csv, 'ä»£æ•¸çµ±è¨ˆå ±è¡¨.csv');
}

function downloadCSV(csv, filename) {
const BOM = '\uFEFF';
const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
const link = document.createElement('a');
const url = URL.createObjectURL(blob);

link.setAttribute('href', url);
link.setAttribute('download', filename);
link.style.visibility = 'hidden';

document.body.appendChild(link);
link.click();
document.body.removeChild(link);
}

// ============================================
// åŸºç¤ç®¡ç†
// ============================================

function renderManagePage() {
renderProductList();
renderMemberList();
  renderBuyerList();
}

// ============================================
// ç”¢å“ç®¡ç†
// ============================================

async function addProduct() {
  const code = document.getElementById('productCode').value.trim();
  const name = document.getElementById('productName').value.trim();
  const price = parseFloat(document.getElementById('productPrice').value);
  const pv = parseInt(document.getElementById('productPV').value);
  
  if (!code || !name || !price || !pv) {
    alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
    return;
  }
  
  if (data.products.find(p => p.code === code)) {
    alert('ç”¢å“ä»£è™Ÿå·²å­˜åœ¨');
    return;
  }
  
  const product = { code, name, price, pv };
  
  showLoading();
  try {
    await callAPIPost('addProduct', { product });
    
    data.products.push(product);
    
    document.getElementById('productCode').value = '';
    document.getElementById('productName').value = '';
    document.getElementById('productPrice').value = '';
    document.getElementById('productPV').value = '';
    
    renderProductList();
    alert('ç”¢å“å·²æ–°å¢');
  } catch (error) {
    alert('æ–°å¢å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

function renderProductList() {
  const tbody = document.getElementById('productListBody');
  tbody.innerHTML = '';
  
  data.products.forEach(p => {
    tbody.innerHTML += `
      <tr>
        <td>${p.code}</td>
        <td>${p.name}</td>
        <td>$${p.price}</td>
        <td>${p.pv}</td>
        <td>
          <button class="btn btn-danger" style="padding: 3px 8px; font-size: 12px;" onclick="deleteProduct('${p.code}')">åˆªé™¤</button>
        </td>
      </tr>
    `;
  });
}

async function deleteProduct(code) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç”¢å“å—ï¼Ÿ')) return;
  
  showLoading();
  try {
    await callAPIPost('deleteProduct', { code });
    
    data.products = data.products.filter(p => p.code !== code);
    renderProductList();
  } catch (error) {
    alert('åˆªé™¤å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

// ============================================
// çµ„ç¹”æˆå“¡ç®¡ç†
// ============================================

async function addMember() {
  const id = document.getElementById('memberId').value.trim();
  const name = document.getElementById('memberName').value.trim();
  const generation = parseInt(document.getElementById('memberGeneration').value);
  const parentId = document.getElementById('memberParentId').value.trim();
  
  if (!id || !name || !generation) {
    alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
    return;
  }
  
  if (data.members.find(m => m.id === id)) {
    alert('æˆå“¡IDå·²å­˜åœ¨');
    return;
  }
  
  if (generation > 1 && !parentId) {
    alert('ç¬¬2ä»£ä»¥ä¸Šå¿…é ˆå¡«å¯«ä¸Šç·šID');
    return;
  }
  
  if (parentId && !data.members.find(m => m.id === parentId)) {
    alert('ä¸Šç·šIDä¸å­˜åœ¨');
    return;
  }
  
  const member = { id, name, generation, parentId };
  
  showLoading();
  try {
    await callAPIPost('addMember', { member });
    
    data.members.push(member);
    
    document.getElementById('memberId').value = '';
    document.getElementById('memberName').value = '';
    document.getElementById('memberGeneration').value = '';
    document.getElementById('memberParentId').value = '';
    
    renderMemberList();
    alert('æˆå“¡å·²æ–°å¢');
  } catch (error) {
    alert('æ–°å¢å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

function renderMemberList() {
  const tbody = document.getElementById('memberListBody');
  tbody.innerHTML = '';
  
  data.members.forEach(m => {
    const parent = m.parentId ? data.members.find(p => p.id === m.parentId) : null;
    tbody.innerHTML += `
      <tr>
        <td>${m.id}</td>
        <td>${m.name}</td>
        <td>ç¬¬${m.generation}ä»£</td>
        <td>${parent?.name || '-'}</td>
        <td>
          <button class="btn btn-danger" style="padding: 3px 8px; font-size: 12px;" onclick="deleteMember('${m.id}')">åˆªé™¤</button>
        </td>
      </tr>
    `;
  });
}

async function deleteMember(id) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æˆå“¡å—ï¼Ÿ')) return;
  
  // æª¢æŸ¥æ˜¯å¦æœ‰ä¸‹ç·š
  const hasChildren = data.members.some(m => m.parentId === id);
  if (hasChildren) {
    alert('æ­¤æˆå“¡æœ‰ä¸‹ç·šï¼Œç„¡æ³•åˆªé™¤');
    return;
  }
  
  showLoading();
  try {
    await callAPIPost('deleteMember', { id });
    
    data.members = data.members.filter(m => m.id !== id);
    renderMemberList();
  } catch (error) {
    alert('åˆªé™¤å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

// ============================================
// æ¶è³¼å“¡ç®¡ç†
// ============================================

async function addBuyer() {
  const id = document.getElementById('buyerId').value.trim();
  const name = document.getElementById('buyerName').value.trim();
  const phone = document.getElementById('buyerPhone').value.trim();
  
  if (!id || !name || !phone) {
    alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
    return;
  }
  
  if (data.buyers.find(b => b.id === id)) {
    alert('æ¶è³¼å“¡IDå·²å­˜åœ¨');
    return;
  }
  
  const buyer = { id, name, phone };
  
  showLoading();
  try {
    await callAPIPost('addBuyer', { buyer });
    
    data.buyers.push(buyer);
    
    document.getElementById('buyerId').value = '';
    document.getElementById('buyerName').value = '';
    document.getElementById('buyerPhone').value = '';
    
    renderBuyerList();
    alert('æ¶è³¼å“¡å·²æ–°å¢');
  } catch (error) {
    alert('æ–°å¢å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

function renderBuyerList() {
  const tbody = document.getElementById('buyerListBody');
  tbody.innerHTML = '';
  
  data.buyers.forEach(b => {
    tbody.innerHTML += `
      <tr>
        <td>${b.id}</td>
        <td>${b.name}</td>
        <td>${b.phone}</td>
        <td>
          <button class="btn btn-danger" style="padding: 3px 8px; font-size: 12px;" onclick="deleteBuyer('${b.id}')">åˆªé™¤</button>
        </td>
      </tr>
    `;
  });
}

async function deleteBuyer(id) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ¶è³¼å“¡å—ï¼Ÿ')) return;
  
  showLoading();
  try {
    await callAPIPost('deleteBuyer', { id });
    
    data.buyers = data.buyers.filter(b => b.id !== id);
    renderBuyerList();
  } catch (error) {
    alert('åˆªé™¤å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

// ============================================
// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
// ============================================

window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
