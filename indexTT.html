<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BOGOæ¶è³¼æ´»å‹•ç®¡ç†ç³»çµ± v2.1</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Microsoft JhengHei', Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
}

.header {
  background: white;
  border-radius: 15px;
  padding: 30px;
  margin-bottom: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.header h1 {
  color: #667eea;
  font-size: 32px;
  margin-bottom: 10px;
}

.header p {
  color: #666;
  font-size: 14px;
}

.version-info {
  display: inline-block;
  background: #667eea;
  color: white;
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 12px;
  margin-left: 10px;
}

.nav-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.nav-tab {
  background: white;
  border: none;
  padding: 15px 25px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
  color: #666;
  transition: all 0.3s;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.nav-tab:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.nav-tab.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.content {
  display: none;
  background: white;
  border-radius: 15px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.content.active {
  display: block;
}

.section-title {
  font-size: 24px;
  color: #667eea;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 3px solid #667eea;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  font-weight: bold;
  color: #333;
  margin-bottom: 8px;
  font-size: 14px;
}

.form-control {
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 14px;
  transition: border 0.3s;
}

.form-control:focus {
  outline: none;
  border-color: #667eea;
}

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 14px;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
}

.btn-success {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  color: white;
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(17, 153, 142, 0.4);
}

.btn-danger {
  background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
  color: white;
}

.btn-info {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  color: white;
}

.btn-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.table-container {
  overflow-x: auto;
  margin-top: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

th, td {
  padding: 15px;
  text-align: left;
  border-bottom: 1px solid #e0e0e0;
}

th {
  font-weight: bold;
  font-size: 14px;
}

tbody tr:hover {
  background: #f8f9ff;
}

.badge {
  display: inline-block;
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
}

.badge-success {
  background: #d4edda;
  color: #155724;
}

.badge-warning {
  background: #fff3cd;
  color: #856404;
}

.badge-danger {
  background: #f8d7da;
  color: #721c24;
}

.badge-info {
  background: #d1ecf1;
  color: #0c5460;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
  transition: transform 0.3s;
}

.stat-card:hover {
  transform: translateY(-5px);
}

.stat-card h3 {
  font-size: 14px;
  opacity: 0.9;
  margin-bottom: 10px;
}

.stat-card .number {
  font-size: 32px;
  font-weight: bold;
}

.member-selector {
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
}

.member-list {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 10px;
}

.member-item {
  padding: 10px;
  margin-bottom: 5px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.3s;
  display: flex;
  align-items: center;
  gap: 10px;
}

.member-item:hover {
  background: #f0f0f0;
}

.member-item.selected {
  background: #e8f0fe;
  border: 2px solid #667eea;
}

.member-item input[type="checkbox"],
.member-item input[type="radio"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.alert {
  padding: 15px 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  font-weight: bold;
}

.alert-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.alert-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.hidden {
  display: none;
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.loading-spinner {
  background: white;
  padding: 30px;
  border-radius: 15px;
  text-align: center;
}

.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #667eea;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto 15px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.connection-status {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 10px 20px;
  border-radius: 25px;
  background: white;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  z-index: 1000;
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: #28a745;
  animation: pulse 2s infinite;
}

.status-dot.error {
  background: #dc3545;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

@media (max-width: 768px) {
  .form-grid {
    grid-template-columns: 1fr;
  }

  .stats-grid {
    grid-template-columns: 1fr;
  }

  .nav-tabs {
    overflow-x: auto;
  }
}
</style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay hidden">
<div class="loading-spinner">
  <div class="spinner"></div>
  <p>è¼‰å…¥ä¸­...</p>
</div>
</div>

<div class="connection-status" id="connectionStatus">
<div class="status-dot" id="statusDot"></div>
<span id="statusText">é€£ç·šæ­£å¸¸</span>
</div>

<div class="container">
<div class="header">
<h1>ğŸ›’ BOGOæ¶è³¼æ´»å‹•ç®¡ç†ç³»çµ± <span class="version-info">v2.1 ä¿®æ­£ç‰ˆ</span></h1>
<p>Buy One Get One - çµ„ç¹”åœ˜éšŠæ¶è³¼ç®¡ç†å¹³å°ï¼ˆé›²ç«¯ç‰ˆï¼‰| æœ€å¾Œæ›´æ–°: <span id="lastUpdateTime">-</span></p>
</div>

<div class="nav-tabs">
<button class="nav-tab active" onclick="switchTab('setup')">ğŸ“‹ æ¶è³¼è¨­å®š</button>
<button class="nav-tab" onclick="switchTab('execute')">ğŸš€ åŸ·è¡Œæ¶è³¼</button>
<button class="nav-tab" onclick="switchTab('report')">ğŸ“Š å›å ±ç‹€æ³</button>
<button class="nav-tab" onclick="switchTab('stats-product')">ğŸ“ˆ ç”¢å“çµ±è¨ˆ</button>
<button class="nav-tab" onclick="switchTab('stats-account')">ğŸ‘¤ å¸³è™Ÿçµ±è¨ˆ</button>
<button class="nav-tab" onclick="switchTab('stats-generation')">ğŸŒ³ ä»£æ•¸çµ±è¨ˆ</button>
<button class="nav-tab" onclick="switchTab('manage')">âš™ï¸ åŸºç¤ç®¡ç†</button>
</div>

<!-- æ¶è³¼è¨­å®š -->
<div id="setup" class="content active">
<h2 class="section-title">æ¶è³¼æ´»å‹•è¨­å®š</h2>

<div class="form-grid">
  <div class="form-group">
    <label>é¸æ“‡ç”¢å“ *</label>
    <select id="setupProduct" class="form-control">
      <option value="">è«‹é¸æ“‡ç”¢å“...</option>
    </select>
  </div>
  <div class="form-group">
    <label>é è³¼æ•¸é‡ *</label>
    <input type="number" id="setupQuantity" class="form-control" min="1" placeholder="è¼¸å…¥æ•¸é‡">
  </div>
  <div class="form-group">
    <label>æ¶è³¼æ—¥æœŸ *</label>
    <input type="date" id="setupDate" class="form-control">
  </div>
</div>

<div class="member-selector">
  <h3 style="margin-bottom: 15px;">é¸æ“‡æ¶è³¼å¸³è™Ÿ *</h3>
  <div class="btn-group" style="margin-bottom: 15px;">
    <button class="btn btn-info" onclick="selectAllAccounts()">å…¨é¸</button>
    <button class="btn btn-info" onclick="deselectAllAccounts()">å–æ¶ˆå…¨é¸</button>
    <button class="btn btn-info" onclick="selectByGeneration()">æŒ‰ä»£æ•¸é¸æ“‡</button>
  </div>
  <div class="member-list" id="accountList">
    <p style="text-align: center; color: #999;">è«‹å…ˆåœ¨åŸºç¤ç®¡ç†ä¸­æ–°å¢çµ„ç¹”æˆå“¡</p>
  </div>
</div>

<div class="member-selector">
  <h3 style="margin-bottom: 15px;">é¸æ“‡æ¶è³¼å“¡ *</h3>
  <div class="member-list" id="buyerList">
    <p style="text-align: center; color: #999;">è«‹å…ˆåœ¨åŸºç¤ç®¡ç†ä¸­æ–°å¢æ¶è³¼å“¡</p>
  </div>
</div>

<div class="btn-group">
  <button class="btn btn-success" onclick="saveSetup()">ğŸ’¾ å„²å­˜è¨­å®š</button>
  <button class="btn btn-primary" onclick="previewSetup()">ğŸ‘ï¸ é è¦½è¨­å®š</button>
</div>

<div id="setupAlert" class="hidden"></div>

<div class="table-container" style="margin-top: 30px;">
  <h3 style="margin-bottom: 15px;">ä»Šæ—¥æ¶è³¼è¨­å®šåˆ—è¡¨</h3>
  <table>
    <thead>
      <tr>
        <th>ç”¢å“ä»£è™Ÿ</th>
        <th>ç”¢å“åç¨±</th>
        <th>é è³¼æ•¸é‡</th>
        <th>æ¶è³¼å¸³è™Ÿæ•¸</th>
        <th>æ¶è³¼å“¡</th>
        <th>ç‹€æ…‹</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="setupListBody">
      <tr><td colspan="7" style="text-align: center; color: #999;">æš«ç„¡ä»Šæ—¥è¨­å®š</td></tr>
    </tbody>
  </table>
</div>
</div>

<!-- åŸ·è¡Œæ¶è³¼ -->
<div id="execute" class="content">
<h2 class="section-title">åŸ·è¡Œæ¶è³¼</h2>

<div class="stats-grid">
  <div class="stat-card">
    <h3>å¾…åŸ·è¡Œä»»å‹™</h3>
    <div class="number" id="pendingTasks">0</div>
  </div>
  <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
    <h3>åŸ·è¡Œä¸­ä»»å‹™</h3>
    <div class="number" id="executingTasks">0</div>
  </div>
  <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
    <h3>å·²å®Œæˆä»»å‹™</h3>
    <div class="number" id="completedTasks">0</div>
  </div>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>ä»»å‹™ID</th>
        <th>ç”¢å“è³‡è¨Š</th>
        <th>æ¶è³¼å¸³è™Ÿ</th>
        <th>æ•¸é‡</th>
        <th>æ¶è³¼å“¡</th>
        <th>ç‹€æ…‹</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="executeListBody">
      <tr><td colspan="7" style="text-align: center; color: #999;">æš«ç„¡ä»»å‹™</td></tr>
    </tbody>
  </table>
</div>
</div>

<!-- å›å ±ç‹€æ³ -->
<div id="report" class="content">
<h2 class="section-title">æ¶è³¼å›å ±</h2>

<div class="form-grid">
  <div class="form-group">
    <label>é¸æ“‡ä»»å‹™ *</label>
    <select id="reportTask" class="form-control" onchange="loadTaskDetails()">
      <option value="">è«‹é¸æ“‡ä»»å‹™...</option>
    </select>
  </div>
</div>

<div id="taskDetails" class="hidden" style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
</div>

<div class="form-grid">
  <div class="form-group">
    <label>å¯¦éš›æ¶è³¼æ•¸é‡ *</label>
    <input type="number" id="reportQuantity" class="form-control" min="0" placeholder="è¼¸å…¥å¯¦éš›æ•¸é‡">
  </div>
  <div class="form-group">
    <label>å›å ±ç‹€æ…‹ *</label>
    <select id="reportStatus" class="form-control">
      <option value="completed">âœ… å®Œæˆ</option>
      <option value="partial">âš ï¸ éƒ¨åˆ†å®Œæˆ</option>
      <option value="failed">âŒ å¤±æ•—</option>
    </select>
  </div>
</div>

<div class="form-group">
  <label>å‚™è¨»èªªæ˜</label>
  <textarea id="reportNote" class="form-control" rows="4" placeholder="è¼¸å…¥å‚™è¨»..."></textarea>
</div>

<button class="btn btn-success" onclick="submitReport()">ğŸ“ æäº¤å›å ±</button>

<div id="reportAlert" class="hidden"></div>

<div class="table-container" style="margin-top: 30px;">
  <h3 style="margin-bottom: 15px;">å›å ±è¨˜éŒ„</h3>
  <table>
    <thead>
      <tr>
        <th>å›å ±æ™‚é–“</th>
        <th>ä»»å‹™ID</th>
        <th>ç”¢å“</th>
        <th>é è³¼/å¯¦éš›</th>
        <th>æ¶è³¼å“¡</th>
        <th>ç‹€æ…‹</th>
        <th>å‚™è¨»</th>
      </tr>
    </thead>
    <tbody id="reportListBody">
      <tr><td colspan="7" style="text-align: center; color: #999;">æš«ç„¡å›å ±è¨˜éŒ„</td></tr>
    </tbody>
  </table>
</div>
</div>

<!-- ç”¢å“çµ±è¨ˆ -->
<div id="stats-product" class="content">
<h2 class="section-title">ç”¢å“çµ±è¨ˆå ±è¡¨</h2>

<div class="form-grid">
  <div class="form-group">
    <label>é–‹å§‹æ—¥æœŸ</label>
    <input type="date" id="productStatsFrom" class="form-control">
  </div>
  <div class="form-group">
    <label>çµæŸæ—¥æœŸ</label>
    <input type="date" id="productStatsTo" class="form-control">
  </div>
  <div class="form-group" style="display: flex; align-items: flex-end;">
    <button class="btn btn-primary" onclick="loadProductStats()">ğŸ“Š ç”Ÿæˆå ±è¡¨</button>
  </div>
</div>

<div class="stats-grid">
  <div class="stat-card">
    <h3>ç¸½ç”¢å“æ•¸</h3>
    <div class="number" id="totalProducts">0</div>
  </div>
  <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
    <h3>ç¸½é è³¼æ•¸é‡</h3>
    <div class="number" id="totalPreOrder">0</div>
  </div>
  <div class="stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
    <h3>ç¸½æ¶è³¼æ•¸é‡</h3>
    <div class="number" id="totalActualOrder">0</div>
  </div>
  <div class="stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
    <h3>ç¸½é‡‘é¡</h3>
    <div class="number" id="totalAmount">$0</div>
  </div>
  <div class="stat-card" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
    <h3>ç¸½PVæ•¸</h3>
    <div class="number" id="totalPV">0</div>
  </div>
</div>

<div class="btn-group" style="margin-bottom: 20px;">
  <button class="btn btn-success" onclick="exportProductStats()">ğŸ“¥ åŒ¯å‡ºCSV</button>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>ç”¢å“ä»£è™Ÿ</th>
        <th>ç”¢å“åç¨±</th>
        <th>å–®åƒ¹</th>
        <th>PVæ•¸</th>
        <th>é è³¼æ•¸é‡</th>
        <th>æ¶è³¼æ•¸é‡</th>
        <th>åˆè¨ˆé‡‘é¡</th>
        <th>åˆè¨ˆPVæ•¸</th>
      </tr>
    </thead>
    <tbody id="productStatsBody">
      <tr><td colspan="8" style="text-align: center; color: #999;">è«‹é¸æ“‡æ—¥æœŸç¯„åœä¸¦ç”Ÿæˆå ±è¡¨</td></tr>
    </tbody>
  </table>
</div>
</div>

<!-- å¸³è™Ÿçµ±è¨ˆ -->
<div id="stats-account" class="content">
<h2 class="section-title">æ¶è³¼å¸³è™Ÿçµ±è¨ˆå ±è¡¨</h2>

<div class="form-grid">
  <div class="form-group">
    <label>é–‹å§‹æ—¥æœŸ</label>
    <input type="date" id="accountStatsFrom" class="form-control">
  </div>
  <div class="form-group">
    <label>çµæŸæ—¥æœŸ</label>
    <input type="date" id="accountStatsTo" class="form-control">
  </div>
  <div class="form-group" style="display: flex; align-items: flex-end;">
    <button class="btn btn-primary" onclick="loadAccountStats()">ğŸ“Š ç”Ÿæˆå ±è¡¨</button>
  </div>
</div>

<div class="btn-group" style="margin-bottom: 20px;">
  <button class="btn btn-success" onclick="exportAccountStats()">ğŸ“¥ åŒ¯å‡ºCSV</button>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>æ¶è³¼å¸³è™Ÿ</th>
        <th>å§“å</th>
        <th>ä¸Šç·šID</th>
        <th>ä¸Šç·šåç¨±</th>
        <th>ä»£æ•¸</th>
        <th>ç”¢å“ä»£è™Ÿ</th>
        <th>ç”¢å“åç¨±</th>
        <th>åˆè¨ˆæ•¸é‡</th>
        <th>åˆè¨ˆPVæ•¸</th>
      </tr>
    </thead>
    <tbody id="accountStatsBody">
      <tr><td colspan="9" style="text-align: center; color: #999;">è«‹é¸æ“‡æ—¥æœŸç¯„åœä¸¦ç”Ÿæˆå ±è¡¨</td></tr>
    </tbody>
  </table>
</div>
</div>

<!-- ä»£æ•¸çµ±è¨ˆ -->
<div id="stats-generation" class="content">
<h2 class="section-title">ä»£æ•¸çµ±è¨ˆå ±è¡¨</h2>

<div class="form-grid">
  <div class="form-group">
    <label>é–‹å§‹æ—¥æœŸ</label>
    <input type="date" id="generationStatsFrom" class="form-control">
  </div>
  <div class="form-group">
    <label>çµæŸæ—¥æœŸ</label>
    <input type="date" id="generationStatsTo" class="form-control">
  </div>
  <div class="form-group">
    <label>é¸æ“‡ä»£æ•¸</label>
    <select id="generationFilter" class="form-control">
      <option value="">å…¨éƒ¨ä»£æ•¸</option>
      <option value="1">ç¬¬1ä»£</option>
      <option value="2">ç¬¬2ä»£</option>
      <option value="3">ç¬¬3ä»£</option>
      <option value="4">ç¬¬4ä»£</option>
      <option value="5">ç¬¬5ä»£</option>
    </select>
  </div>
  <div class="form-group" style="display: flex; align-items: flex-end;">
    <button class="btn btn-primary" onclick="loadGenerationStats()">ğŸ“Š ç”Ÿæˆå ±è¡¨</button>
  </div>
</div>

<div class="btn-group" style="margin-bottom: 20px;">
  <button class="btn btn-success" onclick="exportGenerationStats()">ğŸ“¥ åŒ¯å‡ºCSV</button>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>ä»£æ•¸</th>
        <th>1ä»£åç¨±</th>
        <th>æ¶è³¼å¸³è™Ÿ</th>
        <th>å¸³è™Ÿåç¨±</th>
        <th>ç”¢å“ä»£è™Ÿ</th>
        <th>ç”¢å“åç¨±</th>
        <th>åˆè¨ˆæ•¸é‡</th>
        <th>åˆè¨ˆPVæ•¸</th>
      </tr>
    </thead>
    <tbody id="generationStatsBody">
      <tr><td colspan="8" style="text-align: center; color: #999;">è«‹é¸æ“‡æ—¥æœŸç¯„åœä¸¦ç”Ÿæˆå ±è¡¨</td></tr>
    </tbody>
  </table>
</div>
</div>

<!-- åŸºç¤ç®¡ç† -->
<div id="manage" class="content">
<h2 class="section-title">åŸºç¤è³‡æ–™ç®¡ç†</h2>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px;">
  <!-- ç”¢å“ç®¡ç† -->
  <div>
    <h3 style="margin-bottom: 15px; color: #667eea;">ç”¢å“ç®¡ç†</h3>
    <div class="form-group">
      <label>ç”¢å“ä»£è™Ÿ *</label>
      <input type="text" id="productCode" class="form-control" placeholder="ä¾‹ï¼šP001">
    </div>
    <div class="form-group">
      <label>ç”¢å“åç¨± *</label>
      <input type="text" id="productName" class="form-control" placeholder="ç”¢å“åç¨±">
    </div>
    <div class="form-group">
      <label>å–®åƒ¹ *</label>
      <input type="number" id="productPrice" class="form-control" placeholder="0.00" step="0.01" min="0">
    </div>
    <div class="form-group">
      <label>PVæ•¸ *</label>
      <input type="number" id="productPV" class="form-control" placeholder="0" min="0">
    </div>
    <button class="btn btn-success" onclick="addProduct()">â• æ–°å¢ç”¢å“</button>
    
    <div class="table-container" style="margin-top: 20px;">
      <table>
        <thead>
          <tr>
            <th>ä»£è™Ÿ</th>
            <th>åç¨±</th>
            <th>å–®åƒ¹</th>
            <th>PV</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="productListBody">
          <tr><td colspan="5" style="text-align: center; color: #999;">æš«ç„¡ç”¢å“è³‡æ–™</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- çµ„ç¹”æˆå“¡ç®¡ç† -->
  <div>
    <h3 style="margin-bottom: 15px; color: #667eea;">çµ„ç¹”æˆå“¡ç®¡ç†</h3>
    <div class="form-group">
      <label>æˆå“¡ID *</label>
      <input type="text" id="memberId" class="form-control" placeholder="ä¾‹ï¼šM001">
    </div>
    <div class="form-group">
      <label>å§“å *</label>
      <input type="text" id="memberName" class="form-control" placeholder="å§“å">
    </div>
    <div class="form-group">
      <label>ä»£æ•¸ *</label>
      <input type="number" id="memberGeneration" class="form-control" placeholder="1" min="1" max="10">
    </div>
    <div class="form-group">
      <label>ä¸Šç·šID</label>
      <input type="text" id="memberParentId" class="form-control" placeholder="ä¸Šç·šIDï¼ˆç¬¬1ä»£å¯ç•™ç©ºï¼‰">
    </div>
    <button class="btn btn-success" onclick="addMember()">â• æ–°å¢æˆå“¡</button>
    
    <div class="table-container" style="margin-top: 20px;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>å§“å</th>
            <th>ä»£æ•¸</th>
            <th>ä¸Šç·š</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="memberListBody">
          <tr><td colspan="5" style="text-align: center; color: #999;">æš«ç„¡æˆå“¡è³‡æ–™</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- æ¶è³¼å“¡ç®¡ç† -->
  <div>
    <h3 style="margin-bottom: 15px; color: #667eea;">æ¶è³¼å“¡ç®¡ç†</h3>
    <div class="form-group">
      <label>æ¶è³¼å“¡ID *</label>
      <input type="text" id="buyerId" class="form-control" placeholder="ä¾‹ï¼šB001">
    </div>
    <div class="form-group">
      <label>å§“å *</label>
      <input type="text" id="buyerName" class="form-control" placeholder="å§“å">
    </div>
    <div class="form-group">
      <label>è¯çµ¡é›»è©± *</label>
      <input type="text" id="buyerPhone" class="form-control" placeholder="é›»è©±">
    </div>
    <button class="btn btn-success" onclick="addBuyer()">â• æ–°å¢æ¶è³¼å“¡</button>
    
    <div class="table-container" style="margin-top: 20px;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>å§“å</th>
            <th>é›»è©±</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="buyerListBody">
          <tr><td colspan="4" style="text-align: center; color: #999;">æš«ç„¡æ¶è³¼å“¡è³‡æ–™</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
</div>
</div>

<script>
// ============================================
// é…ç½®è¨­å®š
// ============================================
const CONFIG = {
  // âš ï¸ éƒ¨ç½²å¾Œè«‹å°‡æ­¤ URL æ›¿æ›ç‚ºæ‚¨çš„ Google Apps Script Web App URL
  API_URL: window.location.href.split('?')[0], // è‡ªå‹•ä½¿ç”¨ç•¶å‰ URL
  API_KEY: '', // å¯é¸çš„å®‰å…¨é‡‘é‘°
  CACHE_DURATION: 300000, // 5åˆ†é˜å¿«å–
  RETRY_ATTEMPTS: 3,
  RETRY_DELAY: 1000
};

// è³‡æ–™å„²å­˜
let appData = {
  products: [],
  members: [],
  buyers: [],
  setups: [],
  tasks: [],
  reports: [],
  lastUpdate: null
};

// ============================================
// å·¥å…·å‡½æ•¸
// ============================================

function showLoading() {
  document.getElementById('loadingOverlay').classList.remove('hidden');
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.add('hidden');
}

function showAlert(elementId, type, message) {
  const alertDiv = document.getElementById(elementId);
  alertDiv.className = type === 'success' ? 'alert alert-success' : 'alert alert-error';
  alertDiv.textContent = message;
  alertDiv.classList.remove('hidden');

  setTimeout(() => {
    alertDiv.classList.add('hidden');
  }, 5000);
}

function updateConnectionStatus(isConnected, message = '') {
  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  
  if (isConnected) {
    statusDot.classList.remove('error');
    statusText.textContent = message || 'é€£ç·šæ­£å¸¸';
  } else {
    statusDot.classList.add('error');
    statusText.textContent = message || 'é€£ç·šç•°å¸¸';
  }
}

function formatDate(date) {
  const d = new Date(date);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function formatDateTime(date) {
  const d = new Date(date);
  return d.toLocaleString('zh-TW', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function updateLastUpdateTime() {
  if (appData.lastUpdate) {
    document.getElementById('lastUpdateTime').textContent = formatDateTime(appData.lastUpdate);
  }
}

// ============================================
// API å‘¼å«å‡½æ•¸ï¼ˆå®Œæ•´ä¿®æ­£ç‰ˆ - ä½¿ç”¨ JSONPï¼‰
// ============================================

async function callAPI(action, params = {}, retryCount = 0) {
  try {
    console.log(`ğŸ”„ æ­£åœ¨å‘¼å« API: ${action}`, params);
    
    return await new Promise((resolve, reject) => {
      const callbackName = 'jsonpCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      const url = new URL(CONFIG.API_URL);
      url.searchParams.append('action', action);
      url.searchParams.append('callback', callbackName);
      
      if (CONFIG.API_KEY) {
        url.searchParams.append('apiKey', CONFIG.API_KEY);
      }
      
      Object.keys(params).forEach(key => {
        if (params[key] !== null && params[key] !== undefined) {
          url.searchParams.append(key, params[key]);
        }
      });
      
      console.log('ğŸ“¡ è«‹æ±‚ URL:', url.toString());
      
      const script = document.createElement('script');
      script.src = url.toString();
      
      const timeout = setTimeout(() => {
        cleanup();
        console.error('âŒ API è«‹æ±‚è¶…æ™‚');
        reject(new Error('è«‹æ±‚è¶…æ™‚ - è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š'));
      }, 30000); // 30ç§’è¶…æ™‚
      
      window[callbackName] = function(data) {
        cleanup();
        console.log('âœ… API å›æ‡‰:', data);
        if (data.success) {
          updateConnectionStatus(true);
          resolve(data);
        } else {
          console.error('âŒ API éŒ¯èª¤:', data.error);
          updateConnectionStatus(false, 'API éŒ¯èª¤');
          reject(new Error(data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      };
      
      script.onerror = function(e) {
        cleanup();
        console.error('âŒ è¼‰å…¥è…³æœ¬å¤±æ•—:', e);
        updateConnectionStatus(false, 'è¼‰å…¥å¤±æ•—');
        reject(new Error('ç„¡æ³•è¼‰å…¥ API è…³æœ¬'));
      };
      
      function cleanup() {
        clearTimeout(timeout);
        delete window[callbackName];
        if (script.parentNode) {
          script.parentNode.removeChild(script);
        }
      }
      
      document.head.appendChild(script);
    });
    
  } catch (error) {
    console.error('âŒ API å‘¼å«éŒ¯èª¤:', error);
    
    if (retryCount < CONFIG.RETRY_ATTEMPTS) {
      console.log(`ğŸ”„ é‡è©¦ç¬¬ ${retryCount + 1} æ¬¡...`);
      await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * (retryCount + 1)));
      return callAPI(action, params, retryCount + 1);
    }
    
    updateConnectionStatus(false, 'é€£ç·šå¤±æ•—');
    throw error;
  }
}

async function callAPIPost(action, postData = {}, retryCount = 0) {
  try {
    console.log(`ğŸ”„ æ­£åœ¨åŸ·è¡Œ POST: ${action}`, postData);
    
    const payload = {
      action: action,
      ...postData
    };
    
    if (CONFIG.API_KEY) {
      payload.apiKey = CONFIG.API_KEY;
    }
    
    const response = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
      redirect: 'follow'
    });
    
    const result = await response.json();
    console.log('âœ… POST å›æ‡‰:', result);
    
    if (result.success) {
      updateConnectionStatus(true);
      return result;
    } else {
      throw new Error(result.error || 'æ“ä½œå¤±æ•—');
    }
    
  } catch (error) {
    console.error('âŒ POST å‘¼å«éŒ¯èª¤:', error);
    
    if (retryCount < CONFIG.RETRY_ATTEMPTS) {
      console.log(`ğŸ”„ é‡è©¦ç¬¬ ${retryCount + 1} æ¬¡...`);
      await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * (retryCount + 1)));
      return callAPIPost(action, postData, retryCount + 1);
    }
    
    updateConnectionStatus(false, 'é€£ç·šå¤±æ•—');
    throw error;
  }
}

// ============================================
// åˆå§‹åŒ–
// ============================================

async function init() {
  showLoading();
  try {
    console.log('ğŸš€ ç³»çµ±åˆå§‹åŒ–ä¸­...');
    console.log('ğŸ“ API URL:', CONFIG.API_URL);
    
    await loadAllData();
    renderAll();
    setDefaultDates();
    updateLastUpdateTime();
    
    console.log('âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
    updateConnectionStatus(true, 'ç³»çµ±å°±ç·’');
    
  } catch (error) {
    console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
    updateConnectionStatus(false, 'åˆå§‹åŒ–å¤±æ•—');
    alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—: ' + error.message + '\n\nè«‹æª¢æŸ¥ï¼š\n1. Google Apps Script æ˜¯å¦å·²æ­£ç¢ºéƒ¨ç½²\n2. éƒ¨ç½²æ™‚ã€Œå…·æœ‰å­˜å–æ¬Šçš„ä½¿ç”¨è€…ã€æ˜¯å¦é¸æ“‡ã€Œä»»ä½•äººã€\n3. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸\n\nè«‹æŸ¥çœ‹ç€è¦½å™¨æ§åˆ¶å°ä»¥ç²å–æ›´å¤šè³‡è¨Šã€‚');
  } finally {
    hideLoading();
  }
}

async function loadAllData() {
  try {
    console.log('ğŸ“¦ è¼‰å…¥æ‰€æœ‰è³‡æ–™...');
    const result = await callAPI('getAllData');
    appData = {
      ...result.data,
      lastUpdate: new Date()
    };
    console.log('âœ… è³‡æ–™è¼‰å…¥å®Œæˆ:', appData);
  } catch (error) {
    console.error('âŒ è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
    throw error;
  }
}

function setDefaultDates() {
  const today = formatDate(new Date());
  document.getElementById('setupDate').value = today;
  document.getElementById('productStatsFrom').value = today;
  document.getElementById('productStatsTo').value = today;
  document.getElementById('accountStatsFrom').value = today;
  document.getElementById('accountStatsTo').value = today;
  document.getElementById('generationStatsFrom').value = today;
  document.getElementById('generationStatsTo').value = today;
}

function renderAll() {
  renderSetupPage();
  renderExecutePage();
  renderReportPage();
  renderManagePage();
}

function switchTab(tabName) {
  document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));

  event.target.classList.add('active');
  document.getElementById(tabName).classList.add('active');

  // åˆ‡æ›é ç±¤æ™‚é‡æ–°æ¸²æŸ“
  if (tabName === 'setup') renderSetupPage();
  if (tabName === 'execute') renderExecutePage();
  if (tabName === 'report') renderReportPage();
  if (tabName === 'manage') renderManagePage();
}

// ç”±æ–¼ä»£ç¢¼å¤ªé•·ï¼Œæˆ‘å°‡åœ¨ä¸‹ä¸€å€‹å›è¦†ç¹¼çºŒæä¾›å‰©é¤˜çš„ JavaScript ä»£ç¢¼...
// è«‹ç¹¼çºŒç­‰å¾…ä¸‹ä¸€éƒ¨åˆ†

// ============================================
// æ¶è³¼è¨­å®šé é¢
// ============================================

function renderSetupPage() {
  // æ¸²æŸ“ç”¢å“é¸å–®
  const productSelect = document.getElementById('setupProduct');
  productSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç”¢å“...</option>';
  appData.products.forEach(p => {
    productSelect.innerHTML += `<option value="${p.code}">${p.name} (${p.code}) - $${p.price} | ${p.pv} PV</option>`;
  });

  // æ¸²æŸ“æ¶è³¼å¸³è™Ÿåˆ—è¡¨
  const accountList = document.getElementById('accountList');
  if (appData.members.length === 0) {
    accountList.innerHTML = '<p style="text-align: center; color: #999;">è«‹å…ˆåœ¨åŸºç¤ç®¡ç†ä¸­æ–°å¢çµ„ç¹”æˆå“¡</p>';
  } else {
    accountList.innerHTML = '';
    appData.members.forEach(m => {
      const parentName = m.parentId ? appData.members.find(p => p.id === m.parentId)?.name || '' : '';
      accountList.innerHTML += `
        <div class="member-item" onclick="toggleMemberSelection(this, '${m.id}')">
          <input type="checkbox" data-member-id="${m.id}" onclick="event.stopPropagation(); toggleMemberSelection(this.parentElement, '${m.id}')">
          <div>
            <strong>${m.name}</strong> (${m.id})
            <br><small>ç¬¬${m.generation}ä»£ ${parentName ? '| ä¸Šç·š: ' + parentName : ''}</small>
          </div>
        </div>
      `;
    });
  }

  // æ¸²æŸ“æ¶è³¼å“¡åˆ—è¡¨
  const buyerList = document.getElementById('buyerList');
  if (appData.buyers.length === 0) {
    buyerList.innerHTML = '<p style="text-align: center; color: #999;">è«‹å…ˆåœ¨åŸºç¤ç®¡ç†ä¸­æ–°å¢æ¶è³¼å“¡</p>';
  } else {
    buyerList.innerHTML = '';
    appData.buyers.forEach(b => {
      buyerList.innerHTML += `
        <div class="member-item" onclick="toggleBuyerSelection(this, '${b.id}')">
          <input type="radio" name="buyer" data-buyer-id="${b.id}" onclick="event.stopPropagation(); toggleBuyerSelection(this.parentElement, '${b.id}')">
          <div>
            <strong>${b.name}</strong> (${b.id})
            <br><small>${b.phone}</small>
          </div>
        </div>
      `;
    });
  }

  renderSetupList();
}

function toggleMemberSelection(element, memberId) {
  const checkbox = element.querySelector('input[type="checkbox"]');
  checkbox.checked = !checkbox.checked;
  element.classList.toggle('selected', checkbox.checked);
}

function toggleBuyerSelection(element, buyerId) {
  document.querySelectorAll('#buyerList .member-item').forEach(item => {
    item.classList.remove('selected');
  });
  element.classList.add('selected');
  element.querySelector('input[type="radio"]').checked = true;
}

function selectAllAccounts() {
  document.querySelectorAll('#accountList .member-item').forEach(item => {
    item.classList.add('selected');
    item.querySelector('input[type="checkbox"]').checked = true;
  });
}

function deselectAllAccounts() {
  document.querySelectorAll('#accountList .member-item').forEach(item => {
    item.classList.remove('selected');
    item.querySelector('input[type="checkbox"]').checked = false;
  });
}

function selectByGeneration() {
  const gen = prompt('è«‹è¼¸å…¥è¦é¸æ“‡çš„ä»£æ•¸ (1-10):');
  if (!gen || isNaN(gen)) return;

  document.querySelectorAll('#accountList .member-item').forEach(item => {
    const checkbox = item.querySelector('input[type="checkbox"]');
    const memberId = checkbox.dataset.memberId;
    const member = appData.members.find(m => m.id === memberId);
    
    if (member && member.generation == gen) {
      item.classList.add('selected');
      checkbox.checked = true;
    }
  });
}

async function saveSetup() {
  const productCode = document.getElementById('setupProduct').value;
  const quantity = parseInt(document.getElementById('setupQuantity').value);
  const date = document.getElementById('setupDate').value;

  // é©—è­‰è¼¸å…¥
  if (!productCode || !quantity || !date) {
    showAlert('setupAlert', 'error', 'âŒ è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼ˆæ¨™è¨˜ * ç‚ºå¿…å¡«ï¼‰');
    return;
  }

  if (quantity <= 0) {
    showAlert('setupAlert', 'error', 'âŒ é è³¼æ•¸é‡å¿…é ˆå¤§æ–¼ 0');
    return;
  }

  const selectedAccounts = [];
  document.querySelectorAll('#accountList input[type="checkbox"]:checked').forEach(cb => {
    selectedAccounts.push(cb.dataset.memberId);
  });

  if (selectedAccounts.length === 0) {
    showAlert('setupAlert', 'error', 'âŒ è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¶è³¼å¸³è™Ÿ');
    return;
  }

  const selectedBuyer = document.querySelector('#buyerList input[type="radio"]:checked');
  if (!selectedBuyer) {
    showAlert('setupAlert', 'error', 'âŒ è«‹é¸æ“‡æ¶è³¼å“¡');
    return;
  }

  const setup = {
    id: 'S' + Date.now(),
    productCode,
    quantity,
    date,
    accounts: selectedAccounts,
    buyerId: selectedBuyer.dataset.buyerId,
    status: 'pending',
    createdAt: new Date().toISOString()
  };

  const qtyPerAccount = Math.ceil(quantity / selectedAccounts.length);
  const tasks = selectedAccounts.map((accountId, index) => ({
    id: 'T' + Date.now() + '_' + index,
    setupId: setup.id,
    productCode,
    accountId,
    buyerId: setup.buyerId,
    quantity: qtyPerAccount,
    actualQuantity: 0,
    status: 'pending',
    createdAt: new Date().toISOString()
  }));

  showLoading();
  try {
    await callAPIPost('saveSetup', { setup });
    await callAPIPost('saveTasks', { tasks });
    
    // é‡æ–°è¼‰å…¥è³‡æ–™ä»¥ç¢ºä¿åŒæ­¥
    await loadAllData();
    
    showAlert('setupAlert', 'success', 'âœ… æ¶è³¼è¨­å®šå·²å„²å­˜ï¼');
    renderSetupList();
    renderExecutePage();
    
    // æ¸…ç©ºè¡¨å–®
    document.getElementById('setupProduct').value = '';
    document.getElementById('setupQuantity').value = '';
    deselectAllAccounts();
    document.querySelectorAll('#buyerList .member-item').forEach(item => {
      item.classList.remove('selected');
    });
    document.querySelectorAll('#buyerList input[type="radio"]').forEach(radio => {
      radio.checked = false;
    });
    
  } catch (error) {
    showAlert('setupAlert', 'error', 'âŒ å„²å­˜å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

function renderSetupList() {
  const tbody = document.getElementById('setupListBody');
  const today = formatDate(new Date());
  const todaySetups = appData.setups.filter(s => s.date === today);

  if (todaySetups.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">æš«ç„¡ä»Šæ—¥è¨­å®š</td></tr>';
    return;
  }

  tbody.innerHTML = '';
  todaySetups.forEach(setup => {
    const product = appData.products.find(p => p.code === setup.productCode);
    const buyer = appData.buyers.find(b => b.id === setup.buyerId);
    
    const statusBadge = setup.status === 'pending' ? 'badge-warning' : 
                       setup.status === 'executing' ? 'badge-info' : 'badge-success';
    const statusText = setup.status === 'pending' ? 'å¾…åŸ·è¡Œ' : 
                      setup.status === 'executing' ? 'åŸ·è¡Œä¸­' : 'å·²å®Œæˆ';
    
    tbody.innerHTML += `
      <tr>
        <td>${setup.productCode}</td>
        <td>${product?.name || '-'}</td>
        <td>${setup.quantity}</td>
        <td>${setup.accounts.length}</td>
        <td>${buyer?.name || '-'}</td>
        <td><span class="badge ${statusBadge}">${statusText}</span></td>
        <td>
          <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteSetup('${setup.id}')">åˆªé™¤</button>
        </td>
      </tr>
    `;
  });
}

async function deleteSetup(setupId) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨­å®šå—ï¼Ÿç›¸é—œä»»å‹™ä¹Ÿæœƒä¸€ä½µåˆªé™¤ã€‚')) return;

  showLoading();
  try {
    await callAPIPost('deleteSetup', { id: setupId });
    await loadAllData();
    
    renderSetupList();
    renderExecutePage();
    showAlert('setupAlert', 'success', 'âœ… è¨­å®šå·²åˆªé™¤');
  } catch (error) {
    alert('åˆªé™¤å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

function previewSetup() {
  const productCode = document.getElementById('setupProduct').value;
  const quantity = parseInt(document.getElementById('setupQuantity').value);

  if (!productCode || !quantity) {
    alert('è«‹å…ˆé¸æ“‡ç”¢å“å’Œæ•¸é‡');
    return;
  }

  const selectedAccounts = [];
  document.querySelectorAll('#accountList input[type="checkbox"]:checked').forEach(cb => {
    selectedAccounts.push(cb.dataset.memberId);
  });

  if (selectedAccounts.length === 0) {
    alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¶è³¼å¸³è™Ÿ');
    return;
  }

  const product = appData.products.find(p => p.code === productCode);
  const qtyPerAccount = Math.ceil(quantity / selectedAccounts.length);

  let preview = `ğŸ“¦ ç”¢å“: ${product.name}\n`;
  preview += `ğŸ“Š ç¸½æ•¸é‡: ${quantity}\n`;
  preview += `ğŸ‘¥ åˆ†é…çµ¦ ${selectedAccounts.length} å€‹å¸³è™Ÿï¼Œæ¯å€‹ç´„ ${qtyPerAccount} å€‹\n\n`;
  preview += `ğŸ’° ç¸½é‡‘é¡: $${(quantity * product.price).toLocaleString()}\n`;
  preview += `â­ ç¸½PV: ${(quantity * product.pv).toLocaleString()}\n\n`;
  preview += `ğŸ“‹ å¸³è™Ÿåˆ—è¡¨:\n`;

  selectedAccounts.forEach(id => {
    const member = appData.members.find(m => m.id === id);
    preview += `  â€¢ ${member.name} (${id}) - ç¬¬${member.generation}ä»£\n`;
  });

  alert(preview);
}


// ============================================
// åŸ·è¡Œæ¶è³¼é é¢
// ============================================

function renderExecutePage() {
  const pending = appData.tasks.filter(t => t.status === 'pending').length;
  const executing = appData.tasks.filter(t => t.status === 'executing').length;
  const completed = appData.tasks.filter(t => t.status === 'completed').length;

  document.getElementById('pendingTasks').textContent = pending;
  document.getElementById('executingTasks').textContent = executing;
  document.getElementById('completedTasks').textContent = completed;

  const tbody = document.getElementById('executeListBody');
  
  if (appData.tasks.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">æš«ç„¡ä»»å‹™</td></tr>';
    return;
  }

  tbody.innerHTML = '';
  appData.tasks.forEach(task => {
    const product = appData.products.find(p => p.code === task.productCode);
    const account = appData.members.find(m => m.id === task.accountId);
    const buyer = appData.buyers.find(b => b.id === task.buyerId);
    
    const statusBadge = task.status === 'pending' ? 'badge-warning' : 
                       task.status === 'executing' ? 'badge-info' : 'badge-success';
    const statusText = task.status === 'pending' ? 'å¾…åŸ·è¡Œ' : 
                      task.status === 'executing' ? 'åŸ·è¡Œä¸­' : 'å·²å®Œæˆ';
    
    tbody.innerHTML += `
      <tr>
        <td style="font-size: 11px;">${task.id}</td>
        <td>${product?.name || '-'} (${task.productCode})</td>
        <td>${account?.name || '-'} (${task.accountId})</td>
        <td>${task.quantity}</td>
        <td>${buyer?.name || '-'}</td>
        <td><span class="badge ${statusBadge}">${statusText}</span></td>
        <td>
          ${task.status === 'pending' ? `<button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="startTask('${task.id}')">é–‹å§‹</button>` : ''}
          ${task.status === 'executing' ? `<button class="btn btn-success" style="padding: 5px 10px; font-size: 12px;" onclick="completeTask('${task.id}')">å®Œæˆ</button>` : ''}
          ${task.status === 'completed' ? '<span style="color: #28a745;">âœ“</span>' : ''}
        </td>
      </tr>
    `;
  });
}

async function startTask(taskId) {
  showLoading();
  try {
    await callAPIPost('updateTaskStatus', { taskId, status: 'executing' });
    await loadAllData();
    renderExecutePage();
    updateLastUpdateTime();
  } catch (error) {
    alert('æ›´æ–°å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function completeTask(taskId) {
  showLoading();
  try {
    await callAPIPost('updateTaskStatus', { taskId, status: 'completed' });
    await loadAllData();
    renderExecutePage();
    updateLastUpdateTime();
  } catch (error) {
    alert('æ›´æ–°å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

// ============================================
// å›å ±ç‹€æ³é é¢
// ============================================

function renderReportPage() {
  const taskSelect = document.getElementById('reportTask');
  taskSelect.innerHTML = '<option value="">è«‹é¸æ“‡ä»»å‹™...</option>';

  const reportableTasks = appData.tasks.filter(t => t.status !== 'pending');
  reportableTasks.forEach(task => {
    const product = appData.products.find(p => p.code === task.productCode);
    const account = appData.members.find(m => m.id === task.accountId);
    const statusIcon = task.status === 'completed' ? 'âœ“' : 'â–¶';
    taskSelect.innerHTML += `<option value="${task.id}">${statusIcon} ${task.id} - ${product?.name} - ${account?.name}</option>`;
  });

  renderReportList();
}

function loadTaskDetails() {
  const taskId = document.getElementById('reportTask').value;
  const detailsDiv = document.getElementById('taskDetails');

  if (!taskId) {
    detailsDiv.classList.add('hidden');
    return;
  }

  const task = appData.tasks.find(t => t.id === taskId);
  const product = appData.products.find(p => p.code === task.productCode);
  const account = appData.members.find(m => m.id === task.accountId);
  const buyer = appData.buyers.find(b => b.id === task.buyerId);

  detailsDiv.innerHTML = `
    <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“‹ ä»»å‹™è©³æƒ…</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
      <div><strong>ä»»å‹™ID:</strong><br>${task.id}</div>
      <div><strong>ç”¢å“:</strong><br>${product?.name} (${task.productCode})</div>
      <div><strong>æ¶è³¼å¸³è™Ÿ:</strong><br>${account?.name} (${task.accountId})</div>
      <div><strong>æ¶è³¼å“¡:</strong><br>${buyer?.name}</div>
      <div><strong>é å®šæ•¸é‡:</strong><br>${task.quantity}</div>
      <div><strong>ç‹€æ…‹:</strong><br>${task.status === 'executing' ? 'â³ åŸ·è¡Œä¸­' : 'âœ… å·²å®Œæˆ'}</div>
    </div>
  `;
  detailsDiv.classList.remove('hidden');
}

async function submitReport() {
  const taskId = document.getElementById('reportTask').value;
  const quantity = parseInt(document.getElementById('reportQuantity').value);
  const status = document.getElementById('reportStatus').value;
  const note = document.getElementById('reportNote').value;

  if (!taskId || isNaN(quantity)) {
    showAlert('reportAlert', 'error', 'âŒ è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
    return;
  }

  if (quantity < 0) {
    showAlert('reportAlert', 'error', 'âŒ å¯¦éš›æ•¸é‡ä¸èƒ½ç‚ºè² æ•¸');
    return;
  }

  const report = {
    id: 'R' + Date.now(),
    taskId,
    actualQuantity: quantity,
    status,
    note,
    createdAt: new Date().toISOString()
  };

  showLoading();
  try {
    await callAPIPost('submitReport', { report });
    await loadAllData();
    
    showAlert('reportAlert', 'success', 'âœ… å›å ±å·²æäº¤ï¼');
    
    document.getElementById('reportTask').value = '';
    document.getElementById('reportQuantity').value = '';
    document.getElementById('reportNote').value = '';
    document.getElementById('reportStatus').value = 'completed';
    document.getElementById('taskDetails').classList.add('hidden');
    
    renderReportList();
    renderExecutePage();
    updateLastUpdateTime();
  } catch (error) {
    showAlert('reportAlert', 'error', 'âŒ æäº¤å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

function renderReportList() {
  const tbody = document.getElementById('reportListBody');

  if (appData.reports.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">æš«ç„¡å›å ±è¨˜éŒ„</td></tr>';
    return;
  }

  tbody.innerHTML = '';
  appData.reports.slice().reverse().forEach(report => {
    const task = appData.tasks.find(t => t.id === report.taskId);
    const product = appData.products.find(p => p.code === task?.productCode);
    const buyer = appData.buyers.find(b => b.id === task?.buyerId);
    
    const statusBadge = report.status === 'completed' ? 'badge-success' : 
                       report.status === 'partial' ? 'badge-warning' : 'badge-danger';
    const statusText = report.status === 'completed' ? 'å®Œæˆ' : 
                      report.status === 'partial' ? 'éƒ¨åˆ†å®Œæˆ' : 'å¤±æ•—';
    
    tbody.innerHTML += `
      <tr>
        <td>${formatDateTime(report.createdAt)}</td>
        <td style="font-size: 11px;">${report.taskId}</td>
        <td>${product?.name || '-'}</td>
        <td>${task?.quantity || 0} / ${report.actualQuantity}</td>
        <td>${buyer?.name || '-'}</td>
        <td><span class="badge ${statusBadge}">${statusText}</span></td>
        <td>${report.note || '-'}</td>
      </tr>
    `;
  });
}

// ============================================
// çµ±è¨ˆå ±è¡¨é é¢
// ============================================

async function loadProductStats() {
  const from = document.getElementById('productStatsFrom').value;
  const to = document.getElementById('productStatsTo').value;

  if (!from || !to) {
    alert('è«‹é¸æ“‡æ—¥æœŸç¯„åœ');
    return;
  }

  showLoading();
  try {
    const result = await callAPI('getProductStats', { dateFrom: from, dateTo: to });
    const statsArray = result.data;
    
    document.getElementById('totalProducts').textContent = statsArray.length;
    document.getElementById('totalPreOrder').textContent = statsArray.reduce((sum, s) => sum + s.preOrderQty, 0);
    document.getElementById('totalActualOrder').textContent = statsArray.reduce((sum, s) => sum + s.actualQty, 0);
    
    const totalAmount = statsArray.reduce((sum, s) => sum + (s.actualQty * s.price), 0);
    document.getElementById('totalAmount').textContent = '$' + totalAmount.toLocaleString();
    
    const totalPV = statsArray.reduce((sum, s) => sum + (s.actualQty * s.pv), 0);
    document.getElementById('totalPV').textContent = totalPV.toLocaleString();
    
    const tbody = document.getElementById('productStatsBody');
    
    if (statsArray.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">æ­¤æœŸé–“ç„¡è³‡æ–™</td></tr>';
      return;
    }
    
    tbody.innerHTML = '';
    statsArray.forEach(stat => {
      tbody.innerHTML += `
        <tr>
          <td>${stat.code}</td>
          <td>${stat.name}</td>
          <td>$${stat.price.toLocaleString()}</td>
          <td>${stat.pv}</td>
          <td>${stat.preOrderQty}</td>
          <td>${stat.actualQty}</td>
          <td><strong>$${(stat.actualQty * stat.price).toLocaleString()}</strong></td>
          <td><strong>${(stat.actualQty * stat.pv).toLocaleString()}</strong></td>
        </tr>
      `;
    });
  } catch (error) {
    alert('è¼‰å…¥çµ±è¨ˆå¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function loadAccountStats() {
  const from = document.getElementById('accountStatsFrom').value;
  const to = document.getElementById('accountStatsTo').value;

  if (!from || !to) {
    alert('è«‹é¸æ“‡æ—¥æœŸç¯„åœ');
    return;
  }

  showLoading();
  try {
    const result = await callAPI('getAccountStats', { dateFrom: from, dateTo: to });
    const stats = result.data;
    
    const tbody = document.getElementById('accountStatsBody');
    
    if (stats.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #999;">æ­¤æœŸé–“ç„¡è³‡æ–™</td></tr>';
      return;
    }
    
    tbody.innerHTML = '';
    stats.forEach(stat => {
      tbody.innerHTML += `
        <tr>
          <td>${stat.accountId}</td>
          <td>${stat.accountName}</td>
          <td>${stat.parentId || '-'}</td>
          <td>${stat.parentName || '-'}</td>
          <td>ç¬¬${stat.generation}ä»£</td>
          <td>${stat.productCode}</td>
          <td>${stat.productName}</td>
          <td>${stat.quantity}</td>
          <td><strong>${stat.totalPV.toLocaleString()}</strong></td>
        </tr>
      `;
    });
  } catch (error) {
    alert('è¼‰å…¥çµ±è¨ˆå¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function loadGenerationStats() {
  const from = document.getElementById('generationStatsFrom').value;
  const to = document.getElementById('generationStatsTo').value;
  const genFilter = document.getElementById('generationFilter').value;

  if (!from || !to) {
    alert('è«‹é¸æ“‡æ—¥æœŸç¯„åœ');
    return;
  }

  showLoading();
  try {
    const result = await callAPI('getGenerationStats', { 
      dateFrom: from, 
      dateTo: to,
      generation: genFilter
    });
    const stats = result.data;
    
    const tbody = document.getElementById('generationStatsBody');
    
    if (stats.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">æ­¤æœŸé–“ç„¡è³‡æ–™</td></tr>';
      return;
    }
    
    tbody.innerHTML = '';
    stats.forEach(stat => {
      tbody.innerHTML += `
        <tr>
          <td>ç¬¬${stat.generation}ä»£</td>
          <td>${stat.firstGenName}</td>
          <td>${stat.accountId}</td>
          <td>${stat.accountName}</td>
          <td>${stat.productCode}</td>
          <td>${stat.productName}</td>
          <td>${stat.quantity}</td>
          <td><strong>${stat.totalPV.toLocaleString()}</strong></td>
        </tr>
      `;
    });
  } catch (error) {
    alert('è¼‰å…¥çµ±è¨ˆå¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

// ============================================
// åŒ¯å‡ºåŠŸèƒ½
// ============================================

function exportProductStats() {
  const tbody = document.getElementById('productStatsBody');
  const rows = tbody.querySelectorAll('tr');
  
  if (rows.length === 1 && rows[0].cells.length === 1) {
    alert('è«‹å…ˆç”Ÿæˆå ±è¡¨');
    return;
  }

  let csv = '\uFEFFç”¢å“ä»£è™Ÿ,ç”¢å“åç¨±,å–®åƒ¹,PVæ•¸,é è³¼æ•¸é‡,æ¶è³¼æ•¸é‡,åˆè¨ˆé‡‘é¡,åˆè¨ˆPVæ•¸\n';

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    const rowData = Array.from(cells).map(cell => {
      let text = cell.textContent.replace(/,/g, '');
      text = text.replace(/\$/g, '');
      return text;
    }).join(',');
    csv += rowData + '\n';
  });

  downloadCSV(csv, 'ç”¢å“çµ±è¨ˆå ±è¡¨_' + formatDate(new Date()) + '.csv');
}

function exportAccountStats() {
  const tbody = document.getElementById('accountStatsBody');
  const rows = tbody.querySelectorAll('tr');
  
  if (rows.length === 1 && rows[0].cells.length === 1) {
    alert('è«‹å…ˆç”Ÿæˆå ±è¡¨');
    return;
  }

  let csv = '\uFEFFæ¶è³¼å¸³è™Ÿ,å§“å,ä¸Šç·šID,ä¸Šç·šåç¨±,ä»£æ•¸,ç”¢å“ä»£è™Ÿ,ç”¢å“åç¨±,åˆè¨ˆæ•¸é‡,åˆè¨ˆPVæ•¸\n';

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    const rowData = Array.from(cells).map(cell => cell.textContent.replace(/,/g, '')).join(',');
    csv += rowData + '\n';
  });

  downloadCSV(csv, 'å¸³è™Ÿçµ±è¨ˆå ±è¡¨_' + formatDate(new Date()) + '.csv');
}

function exportGenerationStats() {
  const tbody = document.getElementById('generationStatsBody');
  const rows = tbody.querySelectorAll('tr');
  
  if (rows.length === 1 && rows[0].cells.length === 1) {
    alert('è«‹å…ˆç”Ÿæˆå ±è¡¨');
    return;
  }

  let csv = '\uFEFFä»£æ•¸,1ä»£åç¨±,æ¶è³¼å¸³è™Ÿ,å¸³è™Ÿåç¨±,ç”¢å“ä»£è™Ÿ,ç”¢å“åç¨±,åˆè¨ˆæ•¸é‡,åˆè¨ˆPVæ•¸\n';

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    const rowData = Array.from(cells).map(cell => cell.textContent.replace(/,/g, '')).join(',');
    csv += rowData + '\n';
  });

  downloadCSV(csv, 'ä»£æ•¸çµ±è¨ˆå ±è¡¨_' + formatDate(new Date()) + '.csv');
}

function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);

  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';

  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ============================================
// åŸºç¤ç®¡ç†é é¢
// ============================================

function renderManagePage() {
  renderProductList();
  renderMemberList();
  renderBuyerList();
}

// ============================================
// ç”¢å“ç®¡ç†
// ============================================

async function addProduct() {
  const code = document.getElementById('productCode').value.trim();
  const name = document.getElementById('productName').value.trim();
  const price = parseFloat(document.getElementById('productPrice').value);
  const pv = parseInt(document.getElementById('productPV').value);
  
  if (!code || !name || !price || !pv) {
    alert('âŒ è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼ˆæ¨™è¨˜ * ç‚ºå¿…å¡«ï¼‰');
    return;
  }
  
  if (price <= 0 || pv <= 0) {
    alert('âŒ å–®åƒ¹å’ŒPVæ•¸å¿…é ˆå¤§æ–¼ 0');
    return;
  }
  
  if (appData.products.find(p => p.code === code)) {
    alert('âŒ ç”¢å“ä»£è™Ÿå·²å­˜åœ¨');
    return;
  }
  
  const product = { code, name, price, pv };
  
  showLoading();
  try {
    await callAPIPost('addProduct', { product });
    await loadAllData();
    
    document.getElementById('productCode').value = '';
    document.getElementById('productName').value = '';
    document.getElementById('productPrice').value = '';
    document.getElementById('productPV').value = '';
    
    renderProductList();
    renderSetupPage();
    updateLastUpdateTime();
    alert('âœ… ç”¢å“å·²æ–°å¢');
  } catch (error) {
    alert('âŒ æ–°å¢å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

function renderProductList() {
  const tbody = document.getElementById('productListBody');
  
  if (appData.products.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">æš«ç„¡ç”¢å“è³‡æ–™</td></tr>';
    return;
  }
  
  tbody.innerHTML = '';
  appData.products.forEach(p => {
    tbody.innerHTML += `
      <tr>
        <td>${p.code}</td>
        <td>${p.name}</td>
        <td>$${p.price}</td>
        <td>${p.pv}</td>
        <td>
          <button class="btn btn-danger" style="padding: 3px 8px; font-size: 12px;" onclick="deleteProduct('${p.code}')">åˆªé™¤</button>
        </td>
      </tr>
    `;
  });
}

async function deleteProduct(code) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç”¢å“å—ï¼Ÿ')) return;
  
  showLoading();
  try {
    await callAPIPost('deleteProduct', { code });
    await loadAllData();
    
    renderProductList();
    renderSetupPage();
    updateLastUpdateTime();
  } catch (error) {
    alert('âŒ åˆªé™¤å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

// ============================================
// çµ„ç¹”æˆå“¡ç®¡ç†
// ============================================

async function addMember() {
  const id = document.getElementById('memberId').value.trim();
  const name = document.getElementById('memberName').value.trim();
  const generation = parseInt(document.getElementById('memberGeneration').value);
  const parentId = document.getElementById('memberParentId').value.trim();
  
  if (!id || !name || !generation) {
    alert('âŒ è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼ˆæ¨™è¨˜ * ç‚ºå¿…å¡«ï¼‰');
    return;
  }
  
  if (generation <= 0) {
    alert('âŒ ä»£æ•¸å¿…é ˆå¤§æ–¼ 0');
    return;
  }
  
  if (appData.members.find(m => m.id === id)) {
    alert('âŒ æˆå“¡IDå·²å­˜åœ¨');
    return;
  }
  
  if (generation > 1 && !parentId) {
    alert('âŒ ç¬¬2ä»£ä»¥ä¸Šå¿…é ˆå¡«å¯«ä¸Šç·šID');
    return;
  }
  
  if (parentId && !appData.members.find(m => m.id === parentId)) {
    alert('âŒ ä¸Šç·šIDä¸å­˜åœ¨');
    return;
  }
  
  const member = { id, name, generation, parentId };
  
  showLoading();
  try {
    await callAPIPost('addMember', { member });
    await loadAllData();
    
    document.getElementById('memberId').value = '';
    document.getElementById('memberName').value = '';
    document.getElementById('memberGeneration').value = '';
    document.getElementById('memberParentId').value = '';
    
    renderMemberList();
    renderSetupPage();
    updateLastUpdateTime();
    alert('âœ… æˆå“¡å·²æ–°å¢');
  } catch (error) {
    alert('âŒ æ–°å¢å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

function renderMemberList() {
  const tbody = document.getElementById('memberListBody');
  
  if (appData.members.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">æš«ç„¡æˆå“¡è³‡æ–™</td></tr>';
    return;
  }
  
  tbody.innerHTML = '';
  appData.members.forEach(m => {
    const parent = m.parentId ? appData.members.find(p => p.id === m.parentId) : null;
    tbody.innerHTML += `
      <tr>
        <td>${m.id}</td>
        <td>${m.name}</td>
        <td>ç¬¬${m.generation}ä»£</td>
        <td>${parent?.name || '-'}</td>
        <td>
          <button class="btn btn-danger" style="padding: 3px 8px; font-size: 12px;" onclick="deleteMember('${m.id}')">åˆªé™¤</button>
        </td>
      </tr>
    `;
  });
}

async function deleteMember(id) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æˆå“¡å—ï¼Ÿ')) return;
  
  // æª¢æŸ¥æ˜¯å¦æœ‰ä¸‹ç·š
  const hasChildren = appData.members.some(m => m.parentId === id);
  if (hasChildren) {
    alert('âŒ æ­¤æˆå“¡æœ‰ä¸‹ç·šï¼Œç„¡æ³•åˆªé™¤');
    return;
  }
  
  showLoading();
  try {
    await callAPIPost('deleteMember', { id });
    await loadAllData();
    
    renderMemberList();
    renderSetupPage();
    updateLastUpdateTime();
  } catch (error) {
    alert('âŒ åˆªé™¤å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

// ============================================
// æ¶è³¼å“¡ç®¡ç†
// ============================================

async function addBuyer() {
  const id = document.getElementById('buyerId').value.trim();
  const name = document.getElementById('buyerName').value.trim();
  const phone = document.getElementById('buyerPhone').value.trim();
  
  if (!id || !name || !phone) {
    alert('âŒ è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼ˆæ¨™è¨˜ * ç‚ºå¿…å¡«ï¼‰');
    return;
  }
  
  if (appData.buyers.find(b => b.id === id)) {
    alert('âŒ æ¶è³¼å“¡IDå·²å­˜åœ¨');
    return;
  }
  
  const buyer = { id, name, phone };
  
  showLoading();
  try {
    await callAPIPost('addBuyer', { buyer });
    await loadAllData();
    
    document.getElementById('buyerId').value = '';
    document.getElementById('buyerName').value = '';
    document.getElementById('buyerPhone').value = '';
    
    renderBuyerList();
    renderSetupPage();
    updateLastUpdateTime();
    alert('âœ… æ¶è³¼å“¡å·²æ–°å¢');
  } catch (error) {
    alert('âŒ æ–°å¢å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

function renderBuyerList() {
  const tbody = document.getElementById('buyerListBody');
  
  if (appData.buyers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">æš«ç„¡æ¶è³¼å“¡è³‡æ–™</td></tr>';
    return;
  }
  
  tbody.innerHTML = '';
  appData.buyers.forEach(b => {
    tbody.innerHTML += `
      <tr>
        <td>${b.id}</td>
        <td>${b.name}</td>
        <td>${b.phone}</td>
        <td>
          <button class="btn btn-danger" style="padding: 3px 8px; font-size: 12px;" onclick="deleteBuyer('${b.id}')">åˆªé™¤</button>
        </td>
      </tr>
    `;
  });
}

async function deleteBuyer(id) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ¶è³¼å“¡å—ï¼Ÿ')) return;
  
  showLoading();
  try {
    await callAPIPost('deleteBuyer', { id });
    await loadAllData();
    
    renderBuyerList();
    renderSetupPage();
    updateLastUpdateTime();
  } catch (error) {
    alert('âŒ åˆªé™¤å¤±æ•—: ' + error.message);
  } finally {
    hideLoading();
  }
}

// ============================================
// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
// ============================================

window.addEventListener('DOMContentLoaded', init);

// ============================================
// éŒ¯èª¤è™•ç†
// ============================================

window.addEventListener('error', function(e) {
  console.error('å…¨åŸŸéŒ¯èª¤:', e.error);
  updateConnectionStatus(false, 'ç™¼ç”ŸéŒ¯èª¤');
});

window.addEventListener('unhandledrejection', function(e) {
  console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', e.reason);
  updateConnectionStatus(false, 'Promise éŒ¯èª¤');
});

// ============================================
// å®šæœŸé‡æ–°è¼‰å…¥è³‡æ–™ï¼ˆå¯é¸ï¼‰
// ============================================

// æ¯5åˆ†é˜è‡ªå‹•é‡æ–°è¼‰å…¥è³‡æ–™
setInterval(async () => {
  try {
    console.log('ğŸ”„ è‡ªå‹•é‡æ–°è¼‰å…¥è³‡æ–™...');
    await loadAllData();
    renderAll();
    updateLastUpdateTime();
    console.log('âœ… è³‡æ–™å·²æ›´æ–°');
  } catch (error) {
    console.error('âŒ è‡ªå‹•é‡æ–°è¼‰å…¥å¤±æ•—:', error);
  }
}, 300000); // 5åˆ†é˜

// ============================================
// å¿«æ·éµæ”¯æ´ï¼ˆå¯é¸ï¼‰
// ============================================

document.addEventListener('keydown', function(e) {
  // Ctrl/Cmd + R: é‡æ–°è¼‰å…¥è³‡æ–™
  if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
    e.preventDefault();
    loadAllData().then(() => {
      renderAll();
      updateLastUpdateTime();
      alert('âœ… è³‡æ–™å·²é‡æ–°è¼‰å…¥');
    }).catch(error => {
      alert('âŒ é‡æ–°è¼‰å…¥å¤±æ•—: ' + error.message);
    });
  }
});

console.log('âœ… BOGO æ¶è³¼æ´»å‹•ç®¡ç†ç³»çµ± v2.1 å·²è¼‰å…¥');
console.log('ğŸ“š ä½¿ç”¨èªªæ˜ï¼š');
console.log('1. è«‹ç¢ºä¿å·²åœ¨ Google Apps Script ä¸­æ­£ç¢ºéƒ¨ç½²');
console.log('2. éƒ¨ç½²æ™‚é¸æ“‡ã€Œå…·æœ‰å­˜å–æ¬Šçš„ä½¿ç”¨è€…ã€ç‚ºã€Œä»»ä½•äººã€');
console.log('3. å¦‚é‡åˆ°å•é¡Œï¼Œè«‹æŸ¥çœ‹ç€è¦½å™¨æ§åˆ¶å°çš„éŒ¯èª¤è¨Šæ¯');
console.log('4. å¿«æ·éµï¼šCtrl/Cmd + R é‡æ–°è¼‰å…¥è³‡æ–™');
</script>
</body>
</html>

