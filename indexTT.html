<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>çµ„ç¹”æ¶æ§‹èˆ‡BOGOç®¡ç†ç³»çµ±</title>
<style>
/* åŸºæœ¬æ¨£å¼ */
body {
  font-family: 'Microsoft JhengHei', 'Segoe UI', 'Roboto', Arial, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f8f9fa;
  color: #333;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

h1 {
  color: #2c3e50;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  font-size: 2em;
}

h1 .logo {
  font-size: 1.5em;
  margin-right: 15px;
  color: #3498db;
}

/* å°èˆªæ¬„ */
.nav-tabs {
  display: flex;
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  margin-bottom: 20px;
  overflow-x: auto;
  -ms-overflow-style: none; /* IE and Edge */
  scrollbar-width: none; /* Firefox */
}
.nav-tabs::-webkit-scrollbar {
  display: none; /* Chrome, Safari, Opera */
}

.nav-tab {
  padding: 15px 20px;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.3s ease;
  font-weight: bold;
  display: flex;
  align-items: center;
  white-space: nowrap;
}

.nav-tab .icon {
  margin-right: 8px;
  font-size: 1.2em;
}

.nav-tab:hover {
  background-color: #f8f9fa;
  border-bottom-color: #ddd;
}

.nav-tab.active {
  border-bottom-color: #3498db;
  color: #3498db;
}

/* å…§å®¹å€åŸŸ */
.content {
  display: none;
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  padding: 20px;
  margin-bottom: 20px;
}

.content.active {
  display: block;
  animation: fadeIn 0.5s;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* æ§åˆ¶å€åŸŸ */
.controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 10px;
}

.search-box {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

/* æŒ‰éˆ•æ¨£å¼ */
.btn {
  padding: 8px 15px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  text-decoration: none;
}

.btn-sm {
  padding: 5px 10px;
  font-size: 0.9em;
}

.btn-primary { background-color: #3498db; color: white; }
.btn-primary:hover { background-color: #2980b9; }
.btn-success { background-color: #2ecc71; color: white; }
.btn-success:hover { background-color: #27ae60; }
.btn-warning { background-color: #f39c12; color: white; }
.btn-warning:hover { background-color: #e67e22; }
.btn-danger { background-color: #e74c3c; color: white; }
.btn-danger:hover { background-color: #c0392b; }
.btn-secondary { background-color: #95a5a6; color: white; }
.btn-secondary:hover { background-color: #7f8c8d; }
.btn-info { background-color: #17a2b8; color: white; }
.btn-info:hover { background-color: #138496; }

/* è¡¨å–®å…ƒç´  */
.form-control {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 5px;
  font-size: 14px;
  transition: border 0.3s ease, box-shadow 0.3s ease;
}

.form-control:focus {
  border-color: #3498db;
  outline: none;
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: #555;
}

/* è¡¨æ ¼æ¨£å¼ */
.table-container {
  overflow-x: auto;
  margin-bottom: 20px;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  border-spacing: 0;
}

.data-table th,
.data-table td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid #eee;
  white-space: nowrap;
}

.data-table th {
  background-color: #f8f9fa;
  font-weight: bold;
  color: #555;
  position: sticky;
  top: 0;
  z-index: 10;
}

.data-table tr:hover {
  background-color: #f8f9fa;
}

/* çµ„ç¹”æ¶æ§‹ç‰¹å®šæ¨£å¼ */
.member-row {
  transition: background-color 0.2s ease;
}

.member-info {
  display: flex;
  align-items: center;
}

.member-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background-color: #3498db;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  margin-right: 10px;
  flex-shrink: 0;
}

.member-details {
  display: flex;
  flex-direction: column;
}

.member-details h4 {
  margin: 0;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 5px;
}

.member-details small {
  color: #7f8c8d;
  font-size: 12px;
}

/* å±¤ç´šæ¨£å¼ */
.level-badge {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
  color: white;
}
.level-0 { background-color: #e74c3c; }
.level-1 { background-color: #3498db; }
.level-2 { background-color: #2ecc71; }
.level-3 { background-color: #f39c12; }
.level-default { background-color: #95a5a6; }

/* ç¸®æ’èˆ‡æ¨¹ç‹€ç·šæ¢ */
.indent-container {
  position: relative;
  display: flex;
  align-items: center;
}
.indent-0 { padding-left: 5px; }
.indent-1 { padding-left: 25px; }
.indent-2 { padding-left: 45px; }
.indent-3 { padding-left: 65px; }
.indent-4 { padding-left: 85px; }
.indent-5 { padding-left: 105px; }

.tree-line::before {
  content: '';
  position: absolute;
  left: 12px;
  top: -22px;
  width: 1px;
  height: 40px;
  background-color: #ccc;
}
.tree-line::after {
  content: '';
  position: absolute;
  left: 12px;
  top: 18px;
  width: 15px;
  height: 1px;
  background-color: #ccc;
}

/* æ”¶åˆæŒ‰éˆ• */
.toggle-btn {
  width: 20px;
  height: 20px;
  line-height: 20px;
  text-align: center;
  cursor: pointer;
  background: #f0f0f0;
  border-radius: 3px;
  margin-right: 8px;
  user-select: none;
  font-weight: bold;
  color: #777;
  flex-shrink: 0;
}
.toggle-btn:hover { background: #e0e0e0; }
.toggle-placeholder {
  width: 20px;
  height: 20px;
  margin-right: 8px;
  flex-shrink: 0;
}

/* ç‹€æ…‹æ¨£å¼ */
.status-badge {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
}
.status-active { background-color: #e8f8f5; color: #27ae60; }
.status-new { background-color: #ebf5fb; color: #3498db; }
.status-inactive { background-color: #f8f9fa; color: #95a5a6; }

/* PVæ¢æ¨£å¼ */
.pv-bar {
  width: 100px;
  height: 20px;
  background-color: #f0f0f0;
  border-radius: 10px;
  position: relative;
  overflow: hidden;
}
.pv-fill {
  height: 100%;
  background-color: #3498db;
  border-radius: 10px;
  transition: width 0.3s ease;
}
.pv-text {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  color: #333;
}

/* çµ±è¨ˆå¡ç‰‡ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}
.stat-card {
  background-color: #fff;
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.stat-number { font-size: 28px; font-weight: bold; margin-bottom: 10px; }
.stat-label { color: #7f8c8d; font-size: 14px; }
.stat-card.tasks .stat-number { color: #3498db; }
.stat-card.pv .stat-number { color: #2ecc71; }
.stat-card.amount .stat-number { color: #f39c12; }
.stat-card.products .stat-number { color: #9b59b6; }

/* ä»»å‹™é …ç›® */
.task-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 20px;
  max-height: 400px;
  overflow-y: auto;
}
.task-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  background-color: #f8f9fa;
  border-radius: 8px;
  border-left: 4px solid #3498db;
}
.task-info h5 { margin: 0 0 5px 0; font-size: 16px; }
.task-info small { color: #7f8c8d; }
.task-status {
  font-size: 12px;
  font-weight: bold;
  padding: 3px 8px;
  border-radius: 12px;
}
.task-pending { background-color: #ebf5fb; color: #3498db; }
.task-reported { background-color: #fef9e7; color: #f39c12; }
.task-completed { background-color: #e8f8f5; color: #27ae60; }

/* ç”¢å“è³‡è¨Š */
.product-info {
  background-color: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
}
.product-info h4 {
  margin-top: 0;
  color: #2c3e50;
  border-bottom: 1px solid #eee;
  padding-bottom: 10px;
  margin-bottom: 15px;
}
.product-info p { margin: 5px 0; }

/* ä»»å‹™æŒ‡æ´¾å€åŸŸæ¨£å¼ */
.task-assign-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 30px;
}

.task-form-panel {
  background-color: #f8f9fa;
  border-radius: 8px;
  padding: 20px;
  border: 2px solid #e9ecef;
}

.task-form-panel h3 {
  margin-top: 0;
  color: #2c3e50;
  border-bottom: 2px solid #3498db;
  padding-bottom: 10px;
}

.product-detail-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.product-detail-card h4 {
  margin: 0 0 15px 0;
  font-size: 1.3em;
}

.product-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin-top: 15px;
}

.product-stat-item {
  background: rgba(255,255,255,0.1);
  padding: 10px;
  border-radius: 8px;
  text-align: center;
}

.product-stat-item .number {
  font-size: 1.5em;
  font-weight: bold;
  display: block;
}

.product-stat-item .label {
  font-size: 0.9em;
  opacity: 0.8;
}

.task-batch-container {
  background-color: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-top: 20px;
  border: 1px solid #e9ecef;
}

.task-batch-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  background-color: #f8f9fa;
  border-radius: 8px;
  margin-bottom: 10px;
  border-left: 4px solid #3498db;
}

.task-batch-item .buyer-info {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 10px;
}

.task-batch-item .quantity-input {
  width: 80px;
}

.task-batch-item .remove-btn {
  background: #e74c3c;
  color: white;
  border: none;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* æ¨¡æ…‹æ¡† */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}
.modal:not(.hidden) {
  opacity: 1;
  visibility: visible;
}
.modal-content {
  background-color: #fff;
  border-radius: 8px;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  transform: scale(0.95);
  transition: transform 0.3s ease;
}
.modal:not(.hidden) .modal-content {
  transform: scale(1);
}
.modal-header {
  padding: 15px 20px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.modal-header h3 { margin: 0; color: #2c3e50; }
.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #7f8c8d;
}
.modal-body { padding: 20px; }
.modal-footer {
  padding: 15px 20px;
  border-top: 1px solid #eee;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

/* è¼‰å…¥ä¸­å’Œè¨Šæ¯æç¤º */
.loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20;
  border-radius: 8px;
}
.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #3498db;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.message-box {
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  font-weight: bold;
  display: none;
}
.error { background-color: #fdedec; color: #e74c3c; }
.success { background-color: #d4edda; color: #155724; }
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 2000;
}
.toast {
  background-color: #2ecc71;
  color: white;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 10px;
  font-weight: bold;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  animation: slideIn 0.5s, fadeOut 0.5s 4.5s forwards;
}
@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

.hidden { display: none !important; }

/* å­ç¯€é»é¡¯ç¤ºæ§åˆ¶ */
.child-row.hidden { display: none; }

/* BOGOåœ˜éšŠæ¨™è¨˜ */
.bogo-team-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  margin-right: 10px;
}
.bogo-team-member { background-color: #e8f8f5 !important; }

/* éŸ¿æ‡‰å¼æ¨£å¼ */
@media (max-width: 768px) {
  .controls {
    flex-direction: column;
    align-items: stretch;
  }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .task-assign-section { grid-template-columns: 1fr; }
}
@media (max-width: 576px) {
  .nav-tab { padding: 12px 10px; }
  .stats-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="container">
<h1><span class="logo">ğŸš€</span> çµ„ç¹”æ¶æ§‹èˆ‡BOGOç®¡ç†ç³»çµ±</h1>

<div class="nav-tabs">
  <div class="nav-tab active" onclick="switchTab('organization', this)">
    <span class="icon">ğŸ‘¥</span> çµ„ç¹”æ¶æ§‹
  </div>
  <div class="nav-tab" onclick="switchTab('bogo-products', this)">
    <span class="icon">ğŸ›ï¸</span> BOGOç”¢å“
  </div>
  <div class="nav-tab" onclick="switchTab('task-assign', this)">
    <span class="icon">ğŸ“</span> ä»»å‹™æŒ‡æ´¾
  </div>
  <div class="nav-tab" onclick="switchTab('task-report', this)">
    <span class="icon">ğŸ“Š</span> ä»»å‹™å›å ±
  </div>
  <div class="nav-tab" onclick="switchTab('statistics', this)">
    <span class="icon">ğŸ“ˆ</span> çµ±è¨ˆåˆ†æ
  </div>
</div>

<div id="organization" class="content active">
  <div class="controls">
    <div class="search-box">
      <input type="text" id="orgSearchInput" class="form-control" placeholder="æœå°‹å§“å/å¸³è™Ÿ/å¡è™Ÿ...">
      <button class="btn btn-primary" onclick="searchMembers()">ğŸ” æœå°‹</button>
      <button class="btn btn-secondary" onclick="filterMembers('bogo')">BOGOåœ˜éšŠ</button>
      <button class="btn btn-secondary" onclick="filterMembers('all')">é¡¯ç¤ºå…¨éƒ¨</button>
    </div>
    <div>
      <button class="btn btn-info" onclick="expandAll()">å…¨éƒ¨å±•é–‹</button>
      <button class="btn btn-info" onclick="collapseAll()">å…¨éƒ¨æ”¶åˆ</button>
      <button class="btn btn-success" onclick="saveBogoTeam()">ğŸ’¾ å„²å­˜BOGOåœ˜éšŠ</button>
    </div>
  </div>
  
  <div class="stats-grid">
    <div class="stat-card tasks"><div class="stat-number" id="totalMembers">0</div><div class="stat-label">ç¸½æˆå“¡æ•¸</div></div>
    <div class="stat-card pv"><div class="stat-number" id="totalPersonalPV">0</div><div class="stat-label">ç¸½å€‹äººPV</div></div>
    <div class="stat-card products"><div class="stat-number" id="totalBogoPV">0</div><div class="stat-label">ç¸½æ´»å‹•é…é¡PV</div></div>
    <div class="stat-card amount"><div class="stat-number" id="totalTeamPV">0</div><div class="stat-label">ç¸½åœ˜éšŠPV</div></div>
  </div>
  
  <div id="organizationMessageBox" class="message-box"></div>
  <div class="table-container" style="position: relative;">
    <div id="organizationLoading" class="loading-overlay hidden"><div class="spinner"></div></div>
    <table class="data-table">
      <thead>
        <tr>
          <th>å±¤ç´š</th>
          <th>æˆå“¡è³‡è¨Š</th>
          <th>å€‹äººPV</th>
          <th>åœ˜éšŠPV</th>
          <th>æ´»å‹•é…é¡PV</th>
          <th>å€‹äººç¸½PV</th>
          <th>ä¸‹ç·šäººæ•¸</th>
          <th>ç‹€æ…‹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="organizationTableBody"></tbody>
    </table>
  </div>
</div>

<div id="bogo-products" class="content">
  <div class="controls">
    <div class="search-box">
      <input type="text" id="productSearchInput" class="form-control" placeholder="æœå°‹ç”¢å“ä»£è™Ÿ/åç¨±...">
      <button class="btn btn-primary" onclick="searchProducts()">ğŸ” æœå°‹</button>
      <button class="btn btn-info" onclick="refreshProducts()">ğŸ”„ é‡æ–°æ•´ç†</button>
    </div>
    <div><button class="btn btn-success" onclick="showAddProductModal()">â• æ–°å¢ç”¢å“</button></div>
  </div>
  
  <div id="productsMessageBox" class="message-box"></div>
  <div class="table-container" style="position: relative;">
    <div id="productsLoading" class="loading-overlay hidden"><div class="spinner"></div></div>
    <table class="data-table">
      <thead>
        <tr>
          <th>ç”¢å“ä»£è™Ÿ</th>
          <th>ç”¢å“åç¨±</th>
          <th>å–®åƒ¹</th>
          <th>PVæ•¸</th>
          <th>æ¥å–®æ•¸é‡</th>
          <th>æ¶è³¼ç›®æ¨™</th>
          <th>å¯¦éš›æ¶è³¼</th>
          <th>å®Œæˆç‡</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="productsTableBody"></tbody>
    </table>
  </div>
</div>

<div id="task-assign" class="content">
  <div class="task-assign-section">
    <!-- å·¦å´ï¼šç”¢å“é¸æ“‡å’Œè©³ç´°è³‡è¨Š -->
    <div class="task-form-panel">
      <h3>ğŸ“¦ ç”¢å“é¸æ“‡</h3>
      <div class="form-group">
        <label for="productSelect">é¸æ“‡ç”¢å“:</label>
        <select id="productSelect" class="form-control" onchange="updateSelectedProductInfo()">
          <option value="">è«‹é¸æ“‡ç”¢å“...</option>
        </select>
      </div>
      
      <div id="selectedProductCard" class="product-detail-card hidden">
        <h4 id="productTitle">ç”¢å“åç¨±</h4>
        <div class="product-stats">
          <div class="product-stat-item">
            <span class="number" id="productPrice">$0</span>
            <span class="label">å–®åƒ¹</span>
          </div>
          <div class="product-stat-item">
            <span class="number" id="productPV">0</span>
            <span class="label">PVæ•¸</span>
          </div>
          <div class="product-stat-item">
            <span class="number" id="productAssigned">0</span>
            <span class="label">å·²åˆ†é…</span>
          </div>
          <div class="product-stat-item">
            <span class="number" id="productTarget">0</span>
            <span class="label">ç›®æ¨™æ•¸é‡</span>
          </div>
        </div>
      </div>
    </div>

    <!-- å³å´ï¼šæ¶è³¼å“¡é¸æ“‡å’Œæ‰¹é‡ä»»å‹™ -->
    <div class="task-form-panel">
      <h3>ğŸ‘¥ æ¶è³¼å“¡ç®¡ç†</h3>
      <div class="form-group">
        <label for="buyerSelect">é¸æ“‡æ¶è³¼å“¡:</label>
        <select id="buyerSelect" class="form-control">
          <option value="">è«‹é¸æ“‡æ¢è³¼å“¡...</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="batchQuantity">æ•¸é‡:</label>
        <input type="number" id="batchQuantity" class="form-control" min="1" placeholder="è¼¸å…¥æ•¸é‡" style="width: 120px;">
      </div>
      
      <button class="btn btn-primary" onclick="addToBatch()">â• åŠ å…¥æ‰¹æ¬¡</button>
      <button class="btn btn-success" onclick="submitBatchTasks()" id="submitBatchBtn" disabled>ğŸ“ æäº¤æ‰€æœ‰ä»»å‹™</button>
    </div>
  </div>

  <!-- æ‰¹æ¬¡ä»»å‹™åˆ—è¡¨ -->
  <div class="task-batch-container">
    <h3>ğŸ“‹ å¾…æäº¤ä»»å‹™åˆ—è¡¨</h3>
    <div id="batchTasksList"></div>
    <div id="batchSummary" class="hidden" style="margin-top: 15px; padding: 15px; background-color: #e8f4fd; border-radius: 8px;">
      <strong>æ‰¹æ¬¡æ‘˜è¦ï¼š</strong>
      <span id="batchCount">0</span> å€‹ä»»å‹™ï¼Œç¸½æ•¸é‡ï¼š<span id="batchTotalQty">0</span>
    </div>
  </div>

  <!-- ä»Šæ—¥ä»»å‹™åˆ—è¡¨ -->
  <h3 style="margin-top: 30px;">ğŸ“… ä»Šæ—¥å·²åˆ†é…ä»»å‹™</h3>
  <div id="taskListContainer" class="task-list"></div>
</div>

<div id="task-report" class="content">
  <div class="controls">
    <div class="search-box">
      <select id="buyerFilter" class="form-control" style="width: 200px;" onchange="filterTasks()">
        <option value="">å…¨éƒ¨è²·æ‰‹</option>
      </select>
      <select id="statusFilter" class="form-control" style="width: 150px;" onchange="filterTasks()">
        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
        <option value="å¾…åŸ·è¡Œ">å¾…åŸ·è¡Œ</option>
        <option value="å·²å›å ±">å·²å›å ±</option>
        <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
      </select>
      <button class="btn btn-info" onclick="refreshTasks()">ğŸ”„ é‡æ–°æ•´ç†</button>
    </div>
  </div>
  
  <div id="tasksMessageBox" class="message-box"></div>
  <div class="table-container" style="position: relative;">
    <div id="tasksLoading" class="loading-overlay hidden"><div class="spinner"></div></div>
    <table class="data-table">
      <thead>
        <tr>
          <th>ä»»å‹™ID</th>
          <th>ç”¢å“è³‡è¨Š</th>
          <th>è²·æ‰‹è³‡è¨Š</th>
          <th>åˆ†é…æ•¸é‡</th>
          <th>å¯¦éš›æ•¸é‡</th>
          <th>ç‹€æ…‹</th>
          <th>åˆ†é…æ™‚é–“</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tasksTableBody"></tbody>
    </table>
  </div>
</div>

<div id="statistics" class="content">
  <div class="controls">
    <div class="search-box">
      <select id="statsType" class="form-control" style="width: 200px;">
        <option value="member">æŒ‰æˆå“¡çµ±è¨ˆ</option>
        <option value="card">æŒ‰å¡è™Ÿçµ±è¨ˆ</option>
        <option value="product">æŒ‰ç”¢å“çµ±è¨ˆ</option>
      </select>
      <input type="date" id="dateFrom" class="form-control" style="width: 150px;">
      <input type="date" id="dateTo" class="form-control" style="width: 150px;">
    </div>
    <div>
      <button class="btn btn-primary" onclick="loadStatistics()">ğŸ“Š ç”Ÿæˆå ±è¡¨</button>
      <button class="btn btn-success" onclick="exportStatistics()">ğŸ“¥ åŒ¯å‡ºCSV</button>
    </div>
  </div>
  
  <div class="stats-grid">
    <div class="stat-card tasks"><div class="stat-number" id="statsTotalTasks">0</div><div class="stat-label">ç¸½å›å ±æ•¸é‡</div></div>
    <div class="stat-card pv"><div class="stat-number" id="statsTotalPV">0</div><div class="stat-label">ç¸½PVæ•¸</div></div>
    <div class="stat-card amount"><div class="stat-number" id="statsTotalAmount">$0</div><div class="stat-label">ç¸½é‡‘é¡</div></div>
    <div class="stat-card products"><div class="stat-number" id="statsCompletionRate">0%</div><div class="stat-label">å®Œæˆç‡</div></div>
  </div>
  
  <div id="statisticsMessageBox" class="message-box"></div>
  <div class="table-container" style="position: relative;">
    <div id="statisticsLoading" class="loading-overlay hidden"><div class="spinner"></div></div>
    <table class="data-table">
      <thead id="statisticsTableHead"></thead>
      <tbody id="statisticsTableBody"></tbody>
    </table>
  </div>
</div>
</div>

<!-- æ¨¡æ…‹æ¡† -->
<div id="addProductModal" class="modal hidden">
<div class="modal-content">
  <div class="modal-header"><h3>â• æ–°å¢BOGOç”¢å“</h3><button class="modal-close" onclick="closeModal('addProductModal')">&times;</button></div>
  <div class="modal-body">
    <div class="form-group"><label for="newProductCode">ç”¢å“ä»£è™Ÿï¼š</label>
    <input type="text" id="newProductCode" class="form-control" placeholder="ä¾‹ï¼šBOGO001">
  </div>
  <div class="form-group">
    <label for="newProductName">ç”¢å“åç¨±ï¼š</label>
    <input type="text" id="newProductName" class="form-control" placeholder="è¼¸å…¥ç”¢å“åç¨±">
  </div>
  <div class="form-group">
    <label for="newProductPrice">å–®åƒ¹ï¼š</label>
    <input type="number" id="newProductPrice" class="form-control" min="0" step="0.01" placeholder="0.00">
  </div>
  <div class="form-group">
    <label for="newProductPV">PVæ•¸ï¼š</label>
    <input type="number" id="newProductPV" class="form-control" min="0" placeholder="0">
  </div>
  <div class="form-group">
    <label for="newTargetQuantity">æ¶è³¼ç›®æ¨™æ•¸é‡ï¼š</label>
    <input type="number" id="newTargetQuantity" class="form-control" min="0" placeholder="0">
  </div>
</div>
<div class="modal-footer">
  <button class="btn btn-secondary" onclick="closeModal('addProductModal')">å–æ¶ˆ</button>
  <button class="btn btn-success" onclick="addNewProduct()">æ–°å¢</button>
</div>
</div>

<div id="reportTaskModal" class="modal hidden">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ“Š ä»»å‹™å›å ±</h3><button class="modal-close" onclick="closeModal('reportTaskModal')">&times;</button></div>
<div class="modal-body">
  <div id="reportTaskInfo" class="product-info"></div>
  <div class="form-group">
    <label for="actualQuantity">å¯¦éš›æ¶è³¼æ•¸é‡ï¼š</label>
    <input type="number" id="actualQuantity" class="form-control" min="0" placeholder="0">
  </div>
  <div class="form-group">
    <label for="reportNote">å›å ±å‚™è¨»ï¼š</label>
    <textarea id="reportNote" class="form-control" rows="3" placeholder="è¼¸å…¥å›å ±å‚™è¨»..."></textarea>
  </div>
</div>
<div class="modal-footer">
  <button class="btn btn-secondary" onclick="closeModal('reportTaskModal')">å–æ¶ˆ</button>
  <button class="btn btn-success" onclick="submitTaskReport()">æäº¤å›å ±</button>
</div>
</div>
</div>

<div id="memberDetailsModal" class="modal hidden">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ‘¤ æˆå“¡è©³ç´°è³‡æ–™</h3><button class="modal-close" onclick="closeModal('memberDetailsModal')">&times;</button></div>
<div class="modal-body">
  <div id="memberDetailsContent" class="product-info"></div>
</div>
<div class="modal-footer">
  <button class="btn btn-secondary" onclick="closeModal('memberDetailsModal')">é—œé–‰</button>
</div>
</div>
</div>

<div id="toast-container"></div>

<script>
// ========================================
// å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š
// ========================================
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxFmvFORINjz2ReLxfh_bvnLUx0L4KXcqqRcTKIISr24DL5duQeoqbimiLf_cZomqdhaQ/exec';

let currentData = {
members: [],
products: [],
tasks: [],
statistics: { data: [], summary: {} },
bogoTeamMembers: new Set()
};

let currentTaskId = null;
let activeTab = 'organization';
let batchTasks = []; // æ‰¹æ¬¡ä»»å‹™é™£åˆ—

// ========================================
// é é¢åˆå§‹åŒ–
// ========================================
document.addEventListener('DOMContentLoaded', function() {
initializePage();
setDefaultDateRange();
});

function initializePage() {
loadAllData();
}

function setDefaultDateRange() {
const today = new Date();
const lastMonth = new Date();
lastMonth.setMonth(today.getMonth() - 1);
document.getElementById('dateFrom').valueAsDate = lastMonth;
document.getElementById('dateTo').valueAsDate = today;
}

// ========================================
// æ ¸å¿ƒåŠŸèƒ½
// ========================================

function switchTab(tabId, element) {
activeTab = tabId;
document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
element.classList.add('active');

document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
document.getElementById(tabId).classList.add('active');

switch(tabId) {
  case 'organization': loadOrganizationData(); break;
  case 'bogo-products': loadProductsData(); break;
  case 'task-assign': loadTaskAssignData(); break;
  case 'task-report': loadTasksData(); break;
  case 'statistics': loadStatistics(); break;
}
}

async function loadAllData() {
await Promise.all([
  loadOrganizationData(),
  loadProductsData(),
  loadTasksData()
]);
loadTaskAssignData();
loadStatistics();
}

// ========================================
// API å‘¼å«å‡½æ•¸
// ========================================

async function callAPI(action, params = {}, method = 'GET') {
const url = new URL(GAS_WEB_APP_URL);
if (method === 'GET') {
  url.searchParams.append('action', action);
  Object.keys(params).forEach(key => {
    if (params[key] !== null && params[key] !== undefined) {
      url.searchParams.append(key, params[key]);
    }
  });
}

try {
  const options = method === 'POST' ? {
    method: 'POST',
    mode: 'no-cors',
    body: JSON.stringify({ action, ...params })
  } : {};

  const response = await fetch(url, options);

  if (method === 'POST') {
    return { success: true, message: 'è«‹æ±‚å·²ç™¼é€' };
  }

  if (!response.ok) throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}`);
  
  const data = await response.json();
  if (!data.success) throw new Error(data.error || 'API è¿”å›æœªçŸ¥éŒ¯èª¤');
  
  return data;

} catch (error) {
  console.error(`API å‘¼å«éŒ¯èª¤ (${action}):`, error);
  throw error;
}
}

// ========================================
// çµ„ç¹”æ¶æ§‹ (ä¿æŒåŸæœ‰åŠŸèƒ½)
// ========================================

async function loadOrganizationData() {
showLoading('organization');
try {
  const response = await callAPI('getAllMembers');
  currentData.members = response.data;
  currentData.bogoTeamMembers.clear();
  response.data.forEach(m => {
    if (m.isBOGOTeamMember) currentData.bogoTeamMembers.add(m['æˆå“¡ID'].toString());
  });
  renderOrganizationTree(response.data);
  updateOrganizationStats(response.stats);
  hideMessage('organization');
} catch (error) {
  showMessage('organization', `è¼‰å…¥çµ„ç¹”æ¶æ§‹è³‡æ–™å¤±æ•—: ${error.message}`, 'error');
} finally {
  hideLoading('organization');
}
}

function updateOrganizationStats(stats) {
if (!stats) return;
document.getElementById('totalMembers').textContent = stats.totalMembers || 0;
document.getElementById('totalPersonalPV').textContent = (stats.totalPersonalPV || 0).toLocaleString();
document.getElementById('totalBogoPV').textContent = (stats.totalBogoPV || 0).toLocaleString();
document.getElementById('totalTeamPV').textContent = (stats.totalTeamPV || 0).toLocaleString();
}

function renderOrganizationTree(members) {
const tbody = document.getElementById('organizationTableBody');
tbody.innerHTML = '';
if (!members || members.length === 0) {
  tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">æš«ç„¡è³‡æ–™</td></tr>';
  return;
}
const tree = buildTree(members);
tree.forEach(member => renderMemberAndChildren(member, tbody, 0));
}

function buildTree(members) {
const map = members.reduce((acc, member) => {
  acc[member['æˆå“¡ID']] = { ...member, children: [] };
  return acc;
}, {});
const tree = [];
members.forEach(member => {
  if (member['ä¸Šç´šID'] && map[member['ä¸Šç´šID']]) {
    map[member['ä¸Šç´šID']].children.push(map[member['æˆå“¡ID']]);
  } else {
    tree.push(map[member['æˆå“¡ID']]);
  }
});
return tree;
}

function renderMemberAndChildren(member, tbody, level, isHidden = false) {
const row = createMemberRow(member, level, isHidden);
tbody.appendChild(row);
if (member.children && member.children.length > 0) {
  member.children.forEach(child => renderMemberAndChildren(child, tbody, level + 1, true));
}
}

function createMemberRow(member, level, isHidden) {
const tr = document.createElement('tr');
tr.className = 'member-row';
if (level > 0) tr.classList.add('child-row');
if (isHidden) tr.classList.add('hidden');
tr.dataset.memberId = member['æˆå“¡ID'];
tr.dataset.parentId = member['ä¸Šç´šID'];

const personalPV = parseInt(member['å€‹äººPV']) || 0;
const teamPV = parseInt(member['åœ˜éšŠPV']) || 0;
const bogoPV = parseInt(member['BOGOé…é¡PV']) || 0;
const totalPV = parseInt(member['å€‹äººç¸½PV']) || 0;
const pvPercentage = Math.min((personalPV / 500) * 100, 100);

const levelClass = `level-${Math.min(level, 3)}`;
const indentClass = `indent-${Math.min(level, 5)}`;

const hasChildren = member.children && member.children.length > 0;
const toggleButton = hasChildren ? `<span class="toggle-btn" onclick="toggleChildren(this, '${member['æˆå“¡ID']}')">â–¶</span>` : `<span class="toggle-placeholder"></span>`;

const isBogoMember = currentData.bogoTeamMembers.has(member['æˆå“¡ID'].toString());
if (isBogoMember) tr.classList.add('bogo-team-member');

tr.innerHTML = `
  <td><span class="level-badge ${levelClass}">${level === 0 ? 'ä¸»è¾¦äºº' : `L${level}`}</span></td>
  <td>
    <div class="indent-container ${indentClass} ${level > 0 ? 'tree-line' : ''}">
      ${toggleButton}
      <div class="member-info">
        <div class="member-avatar">${member['é ­åƒç¸®å¯«'] || (member['å§“å'] ? member['å§“å'][0] : '?')}</div>
        <div class="member-details">
          <h4>${getLeaderIcon(level)} ${member['å§“å']} ${hasChildren ? `<small>(${member.children.length})</small>` : ''}</h4>
          <small>${member['å¸³è™Ÿ'] || 'N/A'}</small>
        </div>
      </div>
    </div>
  </td>
  <td>
    <div class="pv-bar"><div class="pv-fill" style="width: ${pvPercentage}%"></div><div class="pv-text">${personalPV}</div></div>
  </td>
  <td><strong>${teamPV.toLocaleString()}</strong></td>
  <td><strong>${bogoPV.toLocaleString()}</strong></td>
  <td><strong>${totalPV.toLocaleString()}</strong></td>
  <td>${member['ä¸‹ç·šäººæ•¸'] || 0}</td>
  <td><span class="status-badge status-${member['ç‹€æ…‹'] === 'æ´»èº' ? 'active' : 'new'}">${member['ç‹€æ…‹']}</span></td>
  <td>
    <input type="checkbox" class="bogo-team-checkbox" ${isBogoMember ? 'checked' : ''} onchange="toggleBogoTeamMember(event, '${member['æˆå“¡ID']}')" title="BOGOåœ˜éšŠæ¨™è¨˜">
    <button class="btn btn-info btn-sm" onclick="showMemberDetails('${member['æˆå“¡ID']}')" title="è©³ç´°è³‡æ–™">ğŸ‘¤</button>
  </td>
`;
return tr;
}

function toggleBogoTeamMember(event, memberId) {
const memberIdStr = memberId.toString();
if (event.target.checked) {
  currentData.bogoTeamMembers.add(memberIdStr);
  event.target.closest('tr').classList.add('bogo-team-member');
} else {
  currentData.bogoTeamMembers.delete(memberIdStr);
  event.target.closest('tr').classList.remove('bogo-team-member');
}
}

async function saveBogoTeam() {
showLoading('organization');
try {
  await callAPI('saveBogoTeam', { memberIds: Array.from(currentData.bogoTeamMembers) }, 'POST');
  showToast('BOGOåœ˜éšŠåå–®å·²å„²å­˜ï¼');
  setTimeout(loadOrganizationData, 1500);
} catch (error) {
  showMessage('organization', `å„²å­˜å¤±æ•—: ${error.message}`, 'error');
} finally {
  hideLoading('organization');
}
}

function showMemberDetails(memberId) {
const member = currentData.members.find(m => m['æˆå“¡ID'].toString() === memberId.toString());
if (!member) return;
const content = document.getElementById('memberDetailsContent');
content.innerHTML = `
  <h4>${member['å§“å']} (${member['å¸³è™Ÿ']})</h4>
  <p><strong>æˆå“¡ID:</strong> ${member['æˆå“¡ID']}</p>
  <p><strong>å¡è™Ÿ:</strong> ${member['å¡è™Ÿ'] || 'æœªè¨­å®š'}</p>
  <p><strong>å€‹äººPV:</strong> ${member['å€‹äººPV'] || 0}</p>
  <p><strong>æ´»å‹•é…é¡PV:</strong> ${member['BOGOé…é¡PV'] || 0}</p>
  <p><strong>å€‹äººç¸½PV:</strong> ${member['å€‹äººç¸½PV'] || 0}</p>
  <p><strong>åœ˜éšŠPV:</strong> ${member['åœ˜éšŠPV'] || 0}</p>
  <p><strong>åŠ å…¥æ—¥æœŸ:</strong> ${member['åŠ å…¥æ—¥æœŸ'] ? new Date(member['åŠ å…¥æ—¥æœŸ']).toLocaleDateString() : 'N/A'}</p>
`;
openModal('memberDetailsModal');
}

async function searchMembers() {
const keyword = document.getElementById('orgSearchInput').value.trim();
showLoading('organization');
try {
  const response = await callAPI('searchMembers', { keyword });
  renderOrganizationTree(response.data);
  hideMessage('organization');
} catch (error) {
  showMessage('organization', `æœå°‹å¤±æ•—: ${error.message}`, 'error');
} finally {
  hideLoading('organization');
}
}

async function filterMembers(filterType) {
showLoading('organization');
try {
  const response = await callAPI('filterMembers', { filter: filterType });
  renderOrganizationTree(response.data);
  hideMessage('organization');
} catch (error) {
  showMessage('organization', `ç¯©é¸å¤±æ•—: ${error.message}`, 'error');
} finally {
  hideLoading('organization');
}
}

// ========================================
// ç”¢å“ç®¡ç† (æ–°å¢é‡æ–°æ•´ç†åŠŸèƒ½)
// ========================================

async function loadProductsData() {
showLoading('products');
try {
  const response = await callAPI('getBogoProducts');
  currentData.products = response.data;
  displayProductsData(response.data);
  hideMessage('products');
} catch (error) {
  showMessage('products', `è¼‰å…¥ç”¢å“è³‡æ–™å¤±æ•—: ${error.message}`, 'error');
} finally {
  hideLoading('products');
}
}

async function refreshProducts() {
showToast('æ­£åœ¨é‡æ–°æ•´ç†ç”¢å“è³‡æ–™...');
await loadProductsData();
showToast('ç”¢å“è³‡æ–™å·²æ›´æ–°ï¼');
}

function displayProductsData(products) {
const tbody = document.getElementById('productsTableBody');
tbody.innerHTML = '';
if (!products || products.length === 0) {
  tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">æš«ç„¡è³‡æ–™</td></tr>';
  return;
}
tbody.innerHTML = products.map(p => {
  const actual = parseInt(p['å¯¦éš›æ¶è³¼æ•¸é‡']) || 0;
  const target = parseInt(p['æ¶è³¼ç›®æ¨™æ•¸é‡']) || 0;
  const rate = target > 0 ? Math.round((actual / target) * 100) : 0;
  return `
    <tr>
      <td><strong>${p['ç”¢å“ä»£è™Ÿ']}</strong></td>
      <td>${p['ç”¢å“åç¨±']}</td>
      <td>$${parseFloat(p['å–®åƒ¹']).toFixed(2)}</td>
      <td>${p['PVæ•¸']}</td>
      <td><strong style="color: #3498db;">${p['ç›®å‰æ¥å–®æ•¸é‡'] || 0}</strong></td>
      <td><input type="number" class="form-control" value="${target}" onchange="updateProductTarget('${p['ç”¢å“ä»£è™Ÿ']}', this.value)" style="width: 80px;"></td>
      <td><strong style="color: #2ecc71;">${actual}</strong></td>
      <td>
        <div class="pv-bar" style="width: 80px;">
          <div class="pv-fill" style="width: ${rate}%; background-color: #2ecc71;"></div>
          <div class="pv-text">${rate}%</div>
        </div>
      </td>
      <td><button class="btn btn-info btn-sm" onclick="viewProductTasks('${p['ç”¢å“ä»£è™Ÿ']}')" title="æŸ¥çœ‹ä»»å‹™">ğŸ“‹</button></td>
    </tr>
  `;
}).join('');
}

async function updateProductTarget(code, target) {
try {
  await callAPI('updateProductTarget', { productCode: code, targetQuantity: parseInt(target) || 0 }, 'POST');
  showToast('ç”¢å“ç›®æ¨™å·²æ›´æ–°ã€‚');
} catch (error) {
  showToast(`æ›´æ–°å¤±æ•—: ${error.message}`, 'error');
}
}

async function addNewProduct() {
const product = {
  code: document.getElementById('newProductCode').value.trim(),
  name: document.getElementById('newProductName').value.trim(),
  price: parseFloat(document.getElementById('newProductPrice').value) || 0,
  pv: parseInt(document.getElementById('newProductPV').value) || 0,
  targetQuantity: parseInt(document.getElementById('newTargetQuantity').value) || 0,
};
if (!product.code || !product.name || product.price <= 0 || product.pv <= 0) {
  alert('è«‹å¡«å¯«å®Œæ•´çš„ç”¢å“è³‡è¨Š'); return;
}
try {
  await callAPI('addBogoProduct', { productData: product }, 'POST');
  closeModal('addProductModal');
  showToast('ç”¢å“æ–°å¢æˆåŠŸï¼');
  setTimeout(loadProductsData, 1500);
} catch (error) {
  alert(`æ–°å¢å¤±æ•—: ${error.message}`);
}
}

function searchProducts() {
const keyword = document.getElementById('productSearchInput').value.toLowerCase().trim();
const filtered = currentData.products.filter(p => 
  p['ç”¢å“ä»£è™Ÿ'].toLowerCase().includes(keyword) ||
  p['ç”¢å“åç¨±'].toLowerCase().includes(keyword)
);
displayProductsData(filtered);
}

// ========================================
// ä»»å‹™ç®¡ç† (å…¨æ–°æ”¹é€²çš„æ‰¹æ¬¡åŠŸèƒ½)
// ========================================

async function loadTaskAssignData() {
updateProductSelector();
await loadBuyers();
await loadTodayTasks();
clearBatch();
}

async function loadTasksData() {
showLoading('tasks');
try {
  const response = await callAPI('getAllTasks');
  currentData.tasks = response.data;
  displayTasksData(response.data);
  updateBuyerFilter();
  hideMessage('tasks');
} catch (error) {
  showMessage('tasks', `è¼‰å…¥ä»»å‹™è³‡æ–™å¤±æ•—: ${error.message}`, 'error');
} finally {
  hideLoading('tasks');
}
}

async function refreshTasks() {
showToast('æ­£åœ¨é‡æ–°æ•´ç†ä»»å‹™è³‡æ–™...');
await loadTasksData();
if (activeTab === 'task-assign') {
  await loadTodayTasks();
  await loadProductsData(); // åŒæ­¥æ›´æ–°ç”¢å“æ•¸æ“š
}
showToast('ä»»å‹™è³‡æ–™å·²æ›´æ–°ï¼');
}

async function loadBuyers() {
try {
  const response = await callAPI('getBuyers');
  updateBuyerSelector(response.data);
} catch (error) {
  console.error('è¼‰å…¥è²·æ‰‹å¤±æ•—:', error);
}
}

function updateProductSelector() {
const select = document.getElementById('productSelect');
select.innerHTML = '<option value="">è«‹é¸æ“‡ç”¢å“...</option>';
currentData.products.forEach(p => {
  select.innerHTML += `<option value="${p['ç”¢å“ä»£è™Ÿ']}">${p['ç”¢å“åç¨±']} (${p['PVæ•¸']} PV)</option>`;
});
}

function updateBuyerSelector(buyers) {
const select = document.getElementById('buyerSelect');
select.innerHTML = '<option value="">è«‹é¸æ“‡æ¶è³¼å“¡...</option>';
buyers.forEach(b => {
  select.innerHTML += `<option value="${b['æˆå“¡ID']}">${b['å§“å']} (ç¸½PV: ${b['å€‹äººç¸½PV'] || 0})</option>`;
});
}

function updateSelectedProductInfo() {
const code = document.getElementById('productSelect').value;
const card = document.getElementById('selectedProductCard');
if (!code) { 
  card.classList.add('hidden'); 
  return; 
}

const p = currentData.products.find(prod => prod['ç”¢å“ä»£è™Ÿ'] === code);
if (!p) { 
  card.classList.add('hidden'); 
  return; 
}

document.getElementById('productTitle').textContent = p['ç”¢å“åç¨±'];
document.getElementById('productPrice').textContent = `$${p['å–®åƒ¹']}`;
document.getElementById('productPV').textContent = p['PVæ•¸'];
document.getElementById('productAssigned').textContent = p['ç›®å‰æ¥å–®æ•¸é‡'] || 0;
document.getElementById('productTarget').textContent = p['æ¶è³¼ç›®æ¨™æ•¸é‡'] || 0;

card.classList.remove('hidden');
}

// ========================================
// æ‰¹æ¬¡ä»»å‹™ç®¡ç†
// ========================================

function addToBatch() {
const productCode = document.getElementById('productSelect').value;
const buyerId = document.getElementById('buyerSelect').value;
const quantity = parseInt(document.getElementById('batchQuantity').value);

if (!productCode || !buyerId || !quantity || quantity <= 0) {
  alert('è«‹é¸æ“‡ç”¢å“ã€æ¶è³¼å“¡ä¸¦è¼¸å…¥æœ‰æ•ˆæ•¸é‡');
  return;
}

const product = currentData.products.find(p => p['ç”¢å“ä»£è™Ÿ'] === productCode);
  const buyer = currentData.members.find(m => m['æˆå“¡ID'].toString() === buyerId.toString());
  
  if (!product || !buyer) {
    alert('æ‰¾ä¸åˆ°ç”¢å“æˆ–æ¶è³¼å“¡è³‡è¨Š');
    return;
  }
  
  // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ä»»å‹™
  const existingIndex = batchTasks.findIndex(task => 
    task.productCode === productCode && task.buyerId === buyerId
  );
  
  if (existingIndex !== -1) {
    // å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°æ•¸é‡
    batchTasks[existingIndex].quantity = quantity;
    showToast('å·²æ›´æ–°è©²æ¶è³¼å“¡çš„ä»»å‹™æ•¸é‡');
  } else {
    // æ–°å¢åˆ°æ‰¹æ¬¡
    batchTasks.push({
      productCode,
      buyerId,
      quantity,
      productName: product['ç”¢å“åç¨±'],
      buyerName: buyer['å§“å'],
      buyerAccount: buyer['å¸³è™Ÿ']
    });
    showToast('å·²åŠ å…¥æ‰¹æ¬¡ä»»å‹™åˆ—è¡¨');
  }
  
  // æ¸…ç©ºè¼¸å…¥
  document.getElementById('buyerSelect').value = '';
  document.getElementById('batchQuantity').value = '';
  
  updateBatchDisplay();
}

function updateBatchDisplay() {
  const container = document.getElementById('batchTasksList');
  const summary = document.getElementById('batchSummary');
  const submitBtn = document.getElementById('submitBatchBtn');
  
  if (batchTasks.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">æš«ç„¡å¾…æäº¤ä»»å‹™</p>';
    summary.classList.add('hidden');
    submitBtn.disabled = true;
    return;
  }
  
  container.innerHTML = batchTasks.map((task, index) => `
    <div class="task-batch-item">
      <div class="buyer-info">
        <div class="member-avatar">${task.buyerName[0]}</div>
        <div>
          <strong>${task.buyerName}</strong>
          <small style="display: block; color: #777;">${task.buyerAccount}</small>
        </div>
      </div>
      <div>
        <strong>${task.productName}</strong>
      </div>
      <div>
        <input type="number" class="form-control quantity-input" value="${task.quantity}" 
               onchange="updateBatchQuantity(${index}, this.value)" min="1">
      </div>
      <button class="remove-btn" onclick="removeFromBatch(${index})" title="ç§»é™¤">Ã—</button>
    </div>
  `).join('');
  
  const totalQuantity = batchTasks.reduce((sum, task) => sum + task.quantity, 0);
  document.getElementById('batchCount').textContent = batchTasks.length;
  document.getElementById('batchTotalQty').textContent = totalQuantity;
  
  summary.classList.remove('hidden');
  submitBtn.disabled = false;
}

function updateBatchQuantity(index, newQuantity) {
  const quantity = parseInt(newQuantity);
  if (quantity > 0) {
    batchTasks[index].quantity = quantity;
    updateBatchDisplay();
  }
}

function removeFromBatch(index) {
  batchTasks.splice(index, 1);
  updateBatchDisplay();
  showToast('å·²å¾æ‰¹æ¬¡ä¸­ç§»é™¤ä»»å‹™');
}

function clearBatch() {
  batchTasks = [];
  updateBatchDisplay();
}

async function submitBatchTasks() {
  if (batchTasks.length === 0) {
    alert('æ²’æœ‰å¾…æäº¤çš„ä»»å‹™');
    return;
  }
  
  const confirmMsg = `ç¢ºå®šè¦æäº¤ ${batchTasks.length} å€‹ä»»å‹™å—ï¼Ÿ\nç¸½æ•¸é‡ï¼š${batchTasks.reduce((sum, task) => sum + task.quantity, 0)}`;
  if (!confirm(confirmMsg)) return;
  
  try {
    showToast('æ­£åœ¨æäº¤æ‰¹æ¬¡ä»»å‹™...');
    
    // é€ä¸€æäº¤ä»»å‹™
    for (const task of batchTasks) {
      await callAPI('assignTask', {
        taskData: {
          productCode: task.productCode,
          buyerId: task.buyerId,
          quantity: task.quantity,
          note: `æ‰¹æ¬¡ä»»å‹™ - ${new Date().toLocaleString()}`
        }
      }, 'POST');
    }
    
    showToast(`æˆåŠŸæäº¤ ${batchTasks.length} å€‹ä»»å‹™ï¼`);
    clearBatch();
    
    // é‡æ–°è¼‰å…¥ç›¸é—œè³‡æ–™
    setTimeout(async () => {
      await loadProductsData();
      await loadTodayTasks();
      if (activeTab === 'organization') await loadOrganizationData();
    }, 1500);
    
  } catch (error) {
    alert(`æ‰¹æ¬¡æäº¤å¤±æ•—: ${error.message}`);
  }
}

async function loadTodayTasks() {
  const container = document.getElementById('taskListContainer');
  try {
    const response = await callAPI('getTodayTasks');
    if (!response.data || response.data.length === 0) {
      container.innerHTML = '<p style="text-align:center; color:#777;">ä»Šæ—¥æš«ç„¡ä»»å‹™</p>';
      return;
    }
    container.innerHTML = response.data.map(t => `
      <div class="task-item">
        <div class="task-info">
          <h5>${t['ç”¢å“åç¨±']}</h5>
          <small>æ¶è³¼å“¡: ${t['è²·æ‰‹å§“å']} | æ•¸é‡: ${t['åˆ†é…æ•¸é‡']}</small>
        </div>
        <div class="task-status task-${t['ç‹€æ…‹'].replace('å¾…åŸ·è¡Œ', 'pending').replace('å·²å›å ±', 'reported').replace('å·²å®Œæˆ', 'completed')}">${t['ç‹€æ…‹']}</div>
      </div>
    `).join('');
  } catch (error) {
    container.innerHTML = `<p style="text-align:center; color:red;">è¼‰å…¥ä»Šæ—¥ä»»å‹™å¤±æ•—</p>`;
  }
}

function displayTasksData(tasks) {
  const tbody = document.getElementById('tasksTableBody');
  tbody.innerHTML = '';
  if (!tasks || tasks.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">æš«ç„¡è³‡æ–™</td></tr>';
    return;
  }
  tbody.innerHTML = tasks.map(t => `
    <tr>
      <td>${t['ä»»å‹™ID']}</td>
      <td><strong>${t['ç”¢å“åç¨±']}</strong><br><small>${t['ç”¢å“ä»£è™Ÿ']}</small></td>
      <td><div class="member-info"><div class="member-avatar">${t['è²·æ‰‹å§“å'] ? t['è²·æ‰‹å§“å'][0] : '?'}</div><div><h4>${t['è²·æ‰‹å§“å']}</h4><small>${t['è²·æ‰‹å¸³è™Ÿ']}</small></div></div></td>
      <td>${t['åˆ†é…æ•¸é‡']}</td>
      <td>${t['å¯¦éš›æ•¸é‡'] || 0}</td>
      <td><span class="task-status task-${t['ç‹€æ…‹'].replace('å¾…åŸ·è¡Œ', 'pending').replace('å·²å›å ±', 'reported').replace('å·²å®Œæˆ', 'completed')}">${t['ç‹€æ…‹']}</span></td>
      <td>${new Date(t['åˆ†é…æ™‚é–“']).toLocaleString()}</td>
      <td><button class="btn btn-info btn-sm" onclick="showReportModal('${t['ä»»å‹™ID']}')" title="å›å ±">ğŸ“Š</button></td>
    </tr>
  `).join('');
}

function showReportModal(taskId) {
  currentTaskId = taskId;
  const task = currentData.tasks.find(t => t['ä»»å‹™ID'] === taskId);
  if (!task) return;
  document.getElementById('reportTaskInfo').innerHTML = `
    <h4>ä»»å‹™è³‡è¨Š</h4>
    <p><strong>ç”¢å“:</strong> ${task['ç”¢å“åç¨±']}</p>
    <p><strong>æ¶è³¼å“¡:</strong> ${task['è²·æ‰‹å§“å']}</p>
    <p><strong>åˆ†é…æ•¸é‡:</strong> ${task['åˆ†é…æ•¸é‡']}</p>
  `;
  document.getElementById('actualQuantity').value = task['å¯¦éš›æ•¸é‡'] || '';
  document.getElementById('reportNote').value = task['å›å ±å‚™è¨»'] || '';
  openModal('reportTaskModal');
}

async function submitTaskReport() {
  const report = {
    taskId: currentTaskId,
    actualQuantity: parseInt(document.getElementById('actualQuantity').value),
    reportNote: document.getElementById('reportNote').value.trim(),
  };
  if (isNaN(report.actualQuantity) || report.actualQuantity < 0) {
    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å¯¦éš›æ•¸é‡'); return;
  }
  try {
    await callAPI('reportTask', report, 'POST');
    closeModal('reportTaskModal');
    showToast('ä»»å‹™å›å ±æˆåŠŸï¼');
    setTimeout(async () => {
      await loadTasksData();
      await loadProductsData();
      if (activeTab === 'organization') await loadOrganizationData();
    }, 1500);
  } catch (error) {
    alert(`å›å ±å¤±æ•—: ${error.message}`);
  }
}

function updateBuyerFilter() {
  const select = document.getElementById('buyerFilter');
  const buyers = [...new Map(currentData.tasks.map(t => [t['è²·æ‰‹ID'], t])).values()];
  select.innerHTML = '<option value="">å…¨éƒ¨è²·æ‰‹</option>';
  buyers.forEach(t => {
    select.innerHTML += `<option value="${t['è²·æ‰‹ID']}">${t['è²·æ‰‹å§“å']}</option>`;
  });
}

function filterTasks() {
  const buyerId = document.getElementById('buyerFilter').value;
  const status = document.getElementById('statusFilter').value;
  let filtered = currentData.tasks;
  if (buyerId) filtered = filtered.filter(t => t['è²·æ‰‹ID'] === buyerId);
  if (status) filtered = filtered.filter(t => t['ç‹€æ…‹'] === status);
  displayTasksData(filtered);
}

// ========================================
// çµ±è¨ˆåˆ†æ (ä¿æŒåŸæœ‰åŠŸèƒ½)
// ========================================

async function loadStatistics() {
  showLoading('statistics');
  try {
    const params = {
      type: document.getElementById('statsType').value,
      dateFrom: document.getElementById('dateFrom').value,
      dateTo: document.getElementById('dateTo').value,
    };
    const response = await callAPI('getStatistics', params);
    currentData.statistics = response;
    displayStatistics(response.data, params.type);
    updateStatisticsStats(response.summary);
    hideMessage('statistics');
  } catch (error) {
    showMessage('statistics', `è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—: ${error.message}`, 'error');
  } finally {
    hideLoading('statistics');
  }
}

function displayStatistics(data, type) {
  const thead = document.getElementById('statisticsTableHead');
  const tbody = document.getElementById('statisticsTableBody');
  thead.innerHTML = '';
  tbody.innerHTML = '';
  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">æš«ç„¡è³‡æ–™</td></tr>';
    return;
  }
  const headers = Object.keys(data[0]);
  thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
  tbody.innerHTML = data.map(row => `
    <tr>${headers.map(h => `<td>${row[h]}</td>`).join('')}</tr>
  `).join('');
}

function updateStatisticsStats(summary) {
  if (!summary) return;
  document.getElementById('statsTotalTasks').textContent = (summary.totalTasks || 0).toLocaleString();
  document.getElementById('statsTotalPV').textContent = (summary.totalPV || 0).toLocaleString();
  document.getElementById('statsTotalAmount').textContent = '$' + (summary.totalAmount || 0).toLocaleString();
  document.getElementById('statsCompletionRate').textContent = (summary.completionRate || 0) + '%';
}

function exportStatistics() {
  const data = currentData.statistics.data;
  if (!data || data.length === 0) { alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™'); return; }
  
  let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
  const headers = Object.keys(data[0]);
  csvContent += headers.join(",") + "\r\n";
  data.forEach(row => {
    const values = headers.map(h => `"${row[h]}"`);
    csvContent += values.join(",") + "\r\n";
  });

  const link = document.createElement("a");
  link.setAttribute("href", encodeURI(csvContent));
  link.setAttribute("download", `statistics_${new Date().toISOString().slice(0,10)}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ========================================
// UI è¼”åŠ©å‡½æ•¸
// ========================================

function showLoading(section) { document.getElementById(`${section}Loading`).classList.remove('hidden'); }
function hideLoading(section) { document.getElementById(`${section}Loading`).classList.add('hidden'); }
function showMessage(section, message, type = 'error') {
  const el = document.getElementById(`${section}MessageBox`);
  el.textContent = message;
  el.className = `message-box ${type}`;
  el.style.display = 'block';
}
function hideMessage(section) {
  document.getElementById(`${section}MessageBox`).style.display = 'none';
}

function showToast(message, type = 'success') {
  const toastContainer = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type === 'error' ? 'error' : ''}`;
  toast.textContent = message;
  toastContainer.appendChild(toast);
  setTimeout(() => toast.remove(), 5000);
}

function openModal(modalId) {
  document.getElementById(modalId).classList.remove('hidden');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.add('hidden');
}

function showAddProductModal() {
  document.getElementById('newProductCode').value = '';
  document.getElementById('newProductName').value = '';
  document.getElementById('newProductPrice').value = '';
  document.getElementById('newProductPV').value = '';
  document.getElementById('newTargetQuantity').value = '';
  openModal('addProductModal');
}

function toggleChildren(btn, memberId) {
  const isExpanding = btn.textContent === 'â–¶';
  btn.textContent = isExpanding ? 'â–¼' : 'â–¶';
  const childrenRows = document.querySelectorAll(`.child-row[data-parent-id='${memberId}']`);
  childrenRows.forEach(row => {
    row.classList.toggle('hidden', !isExpanding);
    if (!isExpanding) {
      const childId = row.dataset.memberId;
      const childBtn = row.querySelector('.toggle-btn');
      if (childBtn && childBtn.textContent === 'â–¼') {
        toggleChildren(childBtn, childId);
      }
    }
  });
}

function expandAll() {
  document.querySelectorAll('#organizationTableBody .toggle-btn').forEach(btn => {
    if (btn.textContent === 'â–¶') {
      btn.click();
    }
  });
}

function collapseAll() {
  document.querySelectorAll('#organizationTableBody .toggle-btn').forEach(btn => {
    if (btn.textContent === 'â–¼') {
      btn.click();
    }
  });
}

function getLeaderIcon(level) {
  if (level === 0) return 'ğŸ‘‘';
  if (level === 1) return 'â­';
  return '';
}

function viewProductTasks(productCode) {
  switchTab('task-report', document.querySelector('.nav-tab[onclick*="task-report"]'));
  let filtered = currentData.tasks.filter(t => t['ç”¢å“ä»£è™Ÿ'] === productCode);
  displayTasksData(filtered);
  document.getElementById('buyerFilter').value = '';
  document.getElementById('statusFilter').value = '';
  showToast(`æ­£åœ¨é¡¯ç¤ºç”¢å“ ${productCode} çš„ç›¸é—œä»»å‹™`);
}

</script>
</body>
</html>
