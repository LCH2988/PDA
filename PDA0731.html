<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣帕金森病友權益促進會 - 會計管理系統</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #f8f9fa;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }

        body {
            background-color: var(--secondary-color);
            font-family: 'Microsoft JhengHei', sans-serif;
        }

        .navbar-brand {
            font-weight: bold;
            color: var(--primary-color) !important;
        }

        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), #4a90e2);
            color: white;
            border-radius: 15px;
        }

        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #1e3d6f;
            border-color: #1e3d6f;
        }

        .table th {
            background-color: var(--secondary-color);
            font-weight: 600;
            border-top: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            color: white;
            font-size: 3rem;
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--secondary-color);
        }

        .action-buttons .btn {
            margin: 0 2px;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .sidebar {
            min-height: 100vh;
            background: linear-gradient(180deg, var(--primary-color), #1e3d6f);
        }

        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 0;
            transition: all 0.3s;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.1);
        }

        .main-content {
            padding: 20px;
        }

        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
            }
            .stat-card h3 {
                font-size: 1.8rem;
            }
            .action-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
            }
            .action-buttons .btn {
                flex: 1;
                min-width: 35px;
            }
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .voucher-preview img {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin: 5px;
        }

        .search-summary {
            background-color: #e3f2fd;
            border-left: 4px solid var(--primary-color);
            padding: 10px 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- 載入中覆蓋層 -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="text-center">
            <div class="loading-spinner">
                <i class="bi bi-arrow-clockwise spin"></i>
            </div>
            <div class="text-white mt-3">載入中...</div>
        </div>
    </div>

    <!-- 同步狀態指示器 -->
    <div id="syncStatus" class="sync-status">
        <span class="badge bg-success" id="syncIndicator">
            <i class="bi bi-cloud-check"></i> 已同步
        </span>
    </div>

    <!-- 導航列 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-heart-pulse me-2"></i>
                台灣帕金森病友權益促進會
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i> 系統
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showSystemSettings()">
                                <i class="bi bi-gear-fill"></i> 系統設定
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportAllData()">
                                <i class="bi bi-download"></i> 匯出資料
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="importAllData()">
                                <i class="bi bi-upload"></i> 匯入資料
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="showKeyboardShortcuts()">
                                <i class="bi bi-keyboard"></i> 快捷鍵
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="showSystemHelp()">
                                <i class="bi bi-question-circle"></i> 使用說明
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="showAboutSystem()">
                                <i class="bi bi-info-circle"></i> 關於系統
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- 側邊欄 -->
                <div class="col-md-2 sidebar text-white p-0">
                    <div class="p-3">
                        <h6 class="text-center mb-4">會計管理系統</h6>
                        <nav class="nav flex-column">
                            <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                                <i class="bi bi-speedometer2 me-2"></i>儀表板
                            </a>
                            <a class="nav-link" href="#" onclick="showSection('transactions')">
                                <i class="bi bi-receipt me-2"></i>交易記錄
                            </a>
                            <a class="nav-link" href="#" onclick="showSection('members')">
                                <i class="bi bi-people me-2"></i>會員管理
                            </a>
                            <a class="nav-link" href="#" onclick="showSection('analytics')">
                                <i class="bi bi-graph-up me-2"></i>統計分析
                            </a>
                            <a class="nav-link" href="#" onclick="showSection('reports')">
                                <i class="bi bi-file-earmark-text me-2"></i>報表
                            </a>
                        </nav>
                    </div>
                </div>

                <!-- 主要內容區 -->
                <div class="col-md-10 main-content">
                    <!-- 儀表板 -->
                    <div id="dashboardSection" class="content-section">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="bi bi-speedometer2"></i> 儀表板</h2>
                            <div>
                                <button class="btn btn-primary me-2" onclick="showTransactionModal()">
                                    <i class="bi bi-plus-circle"></i> 新增交易
                                </button>
                                <button class="btn btn-success" onclick="showMemberModal()">
                                    <i class="bi bi-person-plus"></i> 新增會員
                                </button>
                            </div>
                        </div>

                        <!-- 統計卡片 -->
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card stat-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-cash-coin display-4 mb-2"></i>
                                        <h3 id="totalIncome">$0</h3>
                                        <p class="mb-0">總收入</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stat-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-credit-card display-4 mb-2"></i>
                                        <h3 id="totalExpense">$0</h3>
                                        <p class="mb-0">總支出</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stat-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-people display-4 mb-2"></i>
                                        <h3 id="totalMembers">0</h3>
                                        <p class="mb-0">會員總數</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stat-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-exclamation-triangle display-4 mb-2"></i>
                                        <h3 id="overdueMembers">0</h3>
                                        <p class="mb-0">逾期會費</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 最近交易和會員 -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="bi bi-clock-history"></i> 最近交易</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="recentTransactions">
                                            <div class="text-center text-muted">
                                                <i class="bi bi-receipt display-4"></i>
                                                <p>尚無交易記錄</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="bi bi-person-plus"></i> 新加入會員</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="recentMembers">
                                            <div class="text-center text-muted">
                                                <i class="bi bi-people display-4"></i>
                                                <p>尚無會員資料</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 交易記錄區 -->
                    <div id="transactionsSection" class="content-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="bi bi-receipt"></i> 交易記錄</h2>
                            <div>
                                <button class="btn btn-outline-secondary me-2" onclick="performAdvancedSearch()">
                                    <i class="bi bi-search"></i> 進階搜尋
                                </button>
                                <button class="btn btn-primary" onclick="showTransactionModal()">
                                    <i class="bi bi-plus-circle"></i> 新增交易
                                </button>
                            </div>
                        </div>

                        <!-- 搜尋結果摘要 -->
                        <div id="searchSummary"></div>

                        <!-- 篩選區 -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-2">
                                        <select class="form-select" id="filterYear" onchange="displayTransactions()">
                                            <option value="">所有年份</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="filterMonth" onchange="displayTransactions()">
                                            <option value="">所有月份</option>
                                            <option value="1">1月</option>
                                            <option value="2">2月</option>
                                            <option value="3">3月</option>
                                            <option value="4">4月</option>
                                            <option value="5">5月</option>
                                            <option value="6">6月</option>
                                            <option value="7">7月</option>
                                            <option value="8">8月</option>
                                            <option value="9">9月</option>
                                            <option value="10">10月</option>
                                            <option value="11">11月</option>
                                            <option value="12">12月</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="filterType" onchange="displayTransactions()">
                                            <option value="">所有類型</option>
                                            <option value="收入">收入</option>
                                            <option value="支出">支出</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="searchKeyword" placeholder="搜尋交易記錄..." oninput="displayTransactions()">
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary" onclick="exportToExcel()">
                                            <i class="bi bi-download"></i> 匯出
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 交易記錄表格 -->
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span id="recordCount">0 筆記錄</span>
                                    <div>
                                        <select class="form-select d-inline-block w-auto me-2" id="batchAction">
                                            <option value="">批量操作</option>
                                            <option value="delete">刪除</option>
                                            <option value="export">匯出</option>
                                            <option value="print">列印收據</option>
                                        </select>
                                        <button class="btn btn-outline-primary btn-sm" onclick="performBatchAction()">
                                            <i class="bi bi-check2-square"></i> 執行
                                        </button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                                <th>日期</th>
                                                <th>類型</th>
                                                <th>類別</th>
                                                <th>金額</th>
                                                <th>對象</th>
                                                <th>說明</th>
                                                <th>憑證</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transactionTableBody">
                                            <tr>
                                                <td colspan="9" class="text-center py-4">
                                                    <i class="bi bi-receipt display-4 text-muted"></i>
                                                    <div class="mt-2">尚無交易記錄</div>
                                                    <button class="btn btn-primary mt-2" onclick="showTransactionModal()">
                                                        <i class="bi bi-plus-circle"></i> 新增第一筆交易
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- 分頁 -->
                                <nav>
                                    <ul class="pagination justify-content-center" id="pagination">
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>

                    <!-- 會員管理區 -->
                    <div id="membersSection" class="content-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="bi bi-people"></i> 會員管理</h2>
                            <button class="btn btn-success" onclick="showMemberModal()">
                                <i class="bi bi-person-plus"></i> 新增會員
                            </button>
                        </div>

                        <!-- 會員統計 -->
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 id="totalMembersCount">0</h4>
                                        <p class="text-muted mb-0">總會員數</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 id="activeMembersCount">0</h4>
                                        <p class="text-muted mb-0">正常會員</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 id="overdueMembersCount">0</h4>
                                        <p class="text-muted mb-0">逾期會費</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 id="newMembersCount">0</h4>
                                        <p class="text-muted mb-0">本月新增</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 篩選區 -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <select class="form-select" id="memberFilter" onchange="displayMembers()">
                                            <option value="">所有狀態</option>
                                            <option value="active">正常</option>
                                            <option value="inactive">停權</option>
                                            <option value="pending">待審核</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="memberSearch" placeholder="搜尋會員姓名、電話、電子郵件..." oninput="displayMembers()">
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-secondary me-2" onclick="exportMembersToExcel()">
                                            <i class="bi bi-download"></i> 匯出
                                        </button>
                                        <select class="form-select d-inline-block w-auto" id="memberBatchAction">
                                            <option value="">批量操作</option>
                                            <option value="export">匯出</option>
                                            <option value="sendEmail">發送郵件</option>
                                            <option value="updateStatus">更新狀態</option>
                                            <option value="delete">刪除</option>
                                        </select>
                                        <button class="btn btn-outline-primary btn-sm" onclick="performMemberBatchAction()">
                                            <i class="bi bi-check2-square"></i> 執行
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 會員列表 -->
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span id="memberRecordCount">0 筆記錄</span>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th><input type="checkbox" id="selectAllMembers" onchange="toggleSelectAllMembers()"></th>
                                                <th>會員資料</th>
                                                <th>聯絡方式</th>
                                                <th>年齡/性別</th>
                                                <th>加入日期</th>
                                                <th>狀態</th>
                                                <th>會費狀態</th>
                                                <th>標籤</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="memberTableBody">
                                            <tr>
                                                <td colspan="9" class="text-center py-4">
                                                    <i class="bi bi-people display-4 text-muted"></i>
                                                    <div class="mt-2">尚無會員資料</div>
                                                    <button class="btn btn-success mt-2" onclick="showMemberModal()">
                                                        <i class="bi bi-person-plus"></i> 新增第一位會員
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- 會員分頁 -->
                                <nav>
                                    <ul class="pagination justify-content-center" id="memberPagination">
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>

                    <!-- 統計分析區 -->
                    <div id="analyticsSection" class="content-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="bi bi-graph-up"></i> 統計分析</h2>
                            <div>
                                <select class="form-select d-inline-block w-auto me-2" id="analyticsYear" onchange="updateAnalytics()">
                                    <option value="">選擇年份</option>
                                </select>
                                <select class="form-select d-inline-block w-auto" id="analyticsMonth" onchange="updateAnalytics()">
                                    <option value="">所有月份</option>
                                    <option value="1">1月</option>
                                    <option value="2">2月</option>
                                    <option value="3">3月</option>
                                    <option value="4">4月</option>
                                    <option value="5">5月</option>
                                    <option value="6">6月</option>
                                    <option value="7">7月</option>
                                    <option value="8">8月</option>
                                    <option value="9">9月</option>
                                    <option value="10">10月</option>
                                    <option value="11">11月</option>
                                    <option value="12">12月</option>
                                </select>
                            </div>
                        </div>

                        <!-- 圖表區 -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>收支趨勢</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="trendChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>支出類別分析</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="categoryChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>月度收支對比</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="monthlyChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>會員成長趨勢</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="memberGrowthChart"></canvas>
                                        </div>
                                    </div>
                            </div>
                        </div>
                    </div>

                    <!-- 報表區 -->
                    <div id="reportsSection" class="content-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="bi bi-file-earmark-text"></i> 報表</h2>
                        </div>

                        <!-- 報表參數設定 -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="reportType" class="form-label">報表類型</label>
                                        <select class="form-select" id="reportType">
                                            <option value="financial">財務報表</option>
                                            <option value="member">會員報表</option>
                                            <option value="dues">會費報表</option>
                                            <option value="activity">活動報表</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="reportStartDate" class="form-label">開始日期</label>
                                        <input type="date" class="form-control" id="reportStartDate">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="reportEndDate" class="form-label">結束日期</label>
                                        <input type="date" class="form-control" id="reportEndDate">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div>
                                            <button class="btn btn-primary" onclick="generateReport()">
                                                <i class="bi bi-file-earmark-bar-graph"></i> 產生報表
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-file-earmark-bar-graph display-4 text-primary mb-3"></i>
                                        <h5>財務報表</h5>
                                        <p class="text-muted">生成詳細的收支報表</p>
                                        <button class="btn btn-primary" onclick="generateFinancialReport()">
                                            <i class="bi bi-download"></i> 生成報表
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-people-fill display-4 text-success mb-3"></i>
                                        <h5>會員報表</h5>
                                        <p class="text-muted">會員統計與分析報表</p>
                                        <button class="btn btn-success" onclick="generateMemberReport()">
                                            <i class="bi bi-download"></i> 生成報表
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-receipt-cutoff display-4 text-warning mb-3"></i>
                                        <h5>會費報表</h5>
                                        <p class="text-muted">會費收繳狀況報表</p>
                                        <button class="btn btn-warning" onclick="generateDuesReport()">
                                            <i class="bi bi-download"></i> 生成報表
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 交易記錄模態框 -->
        <div class="modal fade" id="transactionModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-receipt"></i>
                            <span id="transactionModalTitle">新增交易記錄</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="transactionForm">
                            <input type="hidden" id="transactionId">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="date" class="form-label">日期 *</label>
                                        <input type="date" class="form-control" id="date" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="type" class="form-label">類型 *</label>
                                        <select class="form-select" id="type" required onchange="updateCategoryOptions()">
                                            <option value="">請選擇</option>
                                            <option value="收入">收入</option>
                                            <option value="支出">支出</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="category" class="form-label">類別 *</label>
                                        <select class="form-select" id="category" required>
                                            <option value="">請選擇類型後選擇類別</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="amount" class="form-label">金額 *</label>
                                        <input type="number" class="form-control" id="amount" required min="0" step="1">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="counterparty" class="form-label">對象</label>
                                        <input type="text" class="form-control" id="counterparty" list="counterpartyList">
                                        <datalist id="counterpartyList"></datalist>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="account" class="form-label">帳戶</label>
                                        <select class="form-select" id="account">
                                            <option value="現金">現金</option>
                                            <option value="銀行">銀行</option>
                                            <option value="支票">支票</option>
                                            <option value="信用卡">信用卡</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">說明</label>
                                <textarea class="form-control" id="description" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="receiptNumber" class="form-label">收據編號</label>
                                <input type="text" class="form-control" id="receiptNumber" placeholder="自動生成">
                            </div>
                            <div class="mb-3">
                                <label for="voucherFiles" class="form-label">上傳憑證</label>
                                <input type="file" class="form-control" id="voucherFiles" multiple accept="image/*,application/pdf" onchange="handleVoucherUpload(event)">
                                <div class="form-text">支援圖片和PDF格式，可選擇多個檔案</div>
                                <div id="voucherPreview" class="mt-2 voucher-preview"></div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveTransaction()">
                            <i class="bi bi-save"></i> 儲存
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 會員模態框 -->
        <div class="modal fade" id="memberModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-person"></i>
                            <span id="memberModalTitle">新增會員</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="memberForm">
                            <input type="hidden" id="memberId">
                            <div class="row">
                                <div class="col-md-4">
                                    <h6><i class="bi bi-person-badge"></i> 基本資料</h6>
                                    <div class="mb-3">
                                        <label for="memberName" class="form-label">姓名 *</label>
                                        <input type="text" class="form-control" id="memberName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="memberPhone" class="form-label">電話 *</label>
                                        <input type="tel" class="form-control" id="memberPhone" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="memberEmail" class="form-label">電子郵件</label>
                                        <input type="email" class="form-control" id="memberEmail">
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label for="memberBirthDate" class="form-label">出生日期</label>
                                                <input type="date" class="form-control" id="memberBirthDate">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label for="memberGender" class="form-label">性別</label>
                                                <select class="form-select" id="memberGender">
                                                    <option value="">請選擇</option>
                                                    <option value="男">男</option>
                                                    <option value="女">女</option>
                                                    <option value="其他">其他</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="memberIdNumber" class="form-label">身分證字號</label>
                                        <input type="text" class="form-control" id="memberIdNumber" maxlength="10">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h6><i class="bi bi-geo-alt"></i> 聯絡資訊</h6>
                                    <div class="mb-3">
                                        <label for="memberAddress" class="form-label">地址</label>
                                        <textarea class="form-control" id="memberAddress" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="emergencyContact" class="form-label">緊急聯絡人</label>
                                        <input type="text" class="form-control" id="emergencyContact">
                                    </div>
                                    <div class="mb-3">
                                        <label for="emergencyPhone" class="form-label">緊急聯絡電話</label>
                                        <input type="tel" class="form-control" id="emergencyPhone">
                                    </div>
                                    <div class="mb-3">
                                        <label for="memberNotes" class="form-label">備註</label>
                                        <textarea class="form-control" id="memberNotes" rows="3"></textarea>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h6><i class="bi bi-card-checklist"></i> 會員資訊</h6>
                                    <div class="mb-3">
                                        <label for="memberJoinDate" class="form-label">加入日期 *</label>
                                        <input type="date" class="form-control" id="memberJoinDate" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="memberStatus" class="form-label">會員狀態</label>
                                        <select class="form-select" id="memberStatus">
                                            <option value="active">正常</option>
                                            <option value="inactive">停權</option>
                                            <option value="pending">待審核</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="memberType" class="form-label">會員類型</label>
                                        <select class="form-select" id="memberType">
                                            <option value="regular">一般會員</option>
                                            <option value="honorary">榮譽會員</option>
                                            <option value="life">終身會員</option>
                                            <option value="family">家屬會員</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="membershipFee" class="form-label">年費金額</label>
                                        <input type="number" class="form-control" id="membershipFee" value="1000" min="0">
                                    </div>
                                    <div class="mb-3">
                                        <label for="lastPaymentDate" class="form-label">最後繳費日期</label>
                                        <input type="date" class="form-control" id="lastPaymentDate">
                                    </div>
                                    <div class="mb-3">
                                        <label for="memberTags" class="form-label">標籤</label>
                                        <input type="text" class="form-control" id="memberTags" placeholder="用逗號分隔多個標籤">
                                        <div class="form-text">例如：病友,志工,理事</div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-success" onclick="saveMember()">
                            <i class="bi bi-save"></i> 儲存
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 會員詳情模態框 -->
        <div class="modal fade" id="memberDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-person-circle"></i> 會員詳情
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="memberDetailContent">
                        <!-- 會員詳情內容將動態載入 -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-primary" onclick="printMemberCard()">
                            <i class="bi bi-printer"></i> 列印會員卡
                        </button>
                        <button type="button" class="btn btn-primary" onclick="editMemberFromDetail()">
                            <i class="bi bi-pencil"></i> 編輯
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 進階搜尋模態框 -->
        <div class="modal fade" id="advancedSearchModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-search"></i> 進階搜尋
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="advancedSearchForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="searchStartDate" class="form-label">開始日期</label>
                                        <input type="date" class="form-control" id="searchStartDate">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="searchEndDate" class="form-label">結束日期</label>
                                        <input type="date" class="form-control" id="searchEndDate">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="searchType" class="form-label">交易類型</label>
                                        <select class="form-select" id="searchType">
                                            <option value="">所有類型</option>
                                            <option value="收入">收入</option>
                                            <option value="支出">支出</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="searchCategory" class="form-label">類別</label>
                                        <select class="form-select" id="searchCategory">
                                            <option value="">所有類別</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="searchMinAmount" class="form-label">最小金額</label>
                                        <input type="number" class="form-control" id="searchMinAmount" min="0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="searchMaxAmount" class="form-label">最大金額</label>
                                        <input type="number" class="form-control" id="searchMaxAmount" min="0">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="searchCounterparty" class="form-label">對象</label>
                                        <input type="text" class="form-control" id="searchCounterparty">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="searchAccount" class="form-label">帳戶</label>
                                        <select class="form-select" id="searchAccount">
                                            <option value="">所有帳戶</option>
                                            <option value="現金">現金</option>
                                            <option value="銀行">銀行</option>
                                            <option value="支票">支票</option>
                                            <option value="信用卡">信用卡</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="searchDescription" class="form-label">說明</label>
                                <input type="text" class="form-control" id="searchDescription" placeholder="搜尋說明內容">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearAdvancedSearch()">清除條件</button>
                        <button type="button" class="btn btn-primary" onclick="executeAdvancedSearch()">
                            <i class="bi bi-search"></i> 搜尋
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 報表模態框 -->
        <div class="modal fade" id="reportModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="reportModalTitle">報表</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="reportModalContent">
                        <!-- 報表內容將動態載入 -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-primary" onclick="printReport()">
                            <i class="bi bi-printer"></i> 列印
                        </button>
                        <button type="button" class="btn btn-primary" onclick="exportReport()">
                            <i class="bi bi-download"></i> 匯出
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系統設定模態框 -->
        <div class="modal fade" id="systemSettingsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-gear-fill"></i> 系統設定
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="bi bi-building"></i> 組織資訊</h6>
                                <div class="mb-3">
                                    <label for="orgName" class="form-label">組織名稱</label>
                                    <input type="text" class="form-control" id="orgName" value="台灣帕金森病友權益促進會">
                                </div>
                                <div class="mb-3">
                                    <label for="orgAddress" class="form-label">組織地址</label>
                                    <textarea class="form-control" id="orgAddress" rows="2"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="orgPhone" class="form-label">聯絡電話</label>
                                    <input type="tel" class="form-control" id="orgPhone">
                                </div>
                                <div class="mb-3">
                                    <label for="orgEmail" class="form-label">電子郵件</label>
                                    <input type="email" class="form-control" id="orgEmail">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-sliders"></i> 系統設定</h6>
                                <div class="mb-3">
                                    <label for="defaultMembershipFee" class="form-label">預設年費金額</label>
                                    <input type="number" class="form-control" id="defaultMembershipFee" value="1000" min="0">
                                </div>
                                <div class="mb-3">
                                    <label for="receiptPrefix" class="form-label">收據編號前綴</label>
                                    <input type="text" class="form-control" id="receiptPrefix" value="R" maxlength="5">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableAutoBackup">
                                        <label class="form-check-label" for="enableAutoBackup">
                                            啟用自動備份
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableNotifications">
                                        <label class="form-check-label" for="enableNotifications">
                                            啟用通知提醒
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveSystemSettings()">
                            <i class="bi bi-save"></i> 儲存設定
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast 容器 -->
        <div class="toast-container position-fixed top-0 end-0 p-3">
            <div id="successToast" class="toast" role="alert">
                <div class="toast-header">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    <strong class="me-auto">成功</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="successToastBody">
                    操作成功！
                </div>
            </div>
            
            <div id="errorToast" class="toast" role="alert">
                <div class="toast-header">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                    <strong class="me-auto">錯誤</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="errorToastBody">
                    操作失敗！
                </div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!-- SweetAlert2 -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <!-- SheetJS -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

        <script>

// 前端同步功能
// 添加到現有的 JavaScript 程式碼中

// Google Apps Script Web App URL（請替換為您的實際 URL）
const API_URL = 'https://script.google.com/macros/s/AKfycbyNGlEosUCBxgVHFxoZbPit4lc1Sp_mTjrJSz1murqB7boLYRSlvE0cd-RheFjvG_th/exec';

// 同步狀態
let syncStatus = {
  isOnline: navigator.onLine,
  lastSync: localStorage.getItem('lastSync'),
  pendingSync: false
};

// 初始化同步功能
function initializeSync() {
  // 監聽網路狀態變化
  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);
  
  // 檢查是否有待同步的資料
  checkPendingSync();
  
  // 設定定時同步（每5分鐘）
  setInterval(autoSync, 5 * 60 * 1000);
  
  // 頁面載入時執行一次同步
  if (syncStatus.isOnline) {
      syncFromCloud();
  }
}

// 網路連線恢復時的處理
function handleOnline() {
  syncStatus.isOnline = true;
  updateSyncIndicator('online');
  
  // 自動同步待處理的資料
  if (hasPendingChanges()) {
      syncToCloud();
  } else {
      syncFromCloud();
  }
}

// 網路斷線時的處理
function handleOffline() {
  syncStatus.isOnline = false;
  updateSyncIndicator('offline');
}

// 同步到雲端
async function syncToCloud() {
  if (!syncStatus.isOnline || syncStatus.pendingSync) {
      return;
  }
  
  syncStatus.pendingSync = true;
  updateSyncIndicator('syncing');
  
  try {
      // 同步交易記錄
      await syncTransactionsToCloud();
      
      // 同步會員資料
      await syncMembersToCloud();
      
      // 同步系統設定
      await syncSettingsToCloud();
      
      // 更新同步時間
      syncStatus.lastSync = new Date().toISOString();
      localStorage.setItem('lastSync', syncStatus.lastSync);
      
      // 清除待同步標記
      clearPendingSync();
      
      updateSyncIndicator('synced');
      showToast('success', '資料同步完成');
      
  } catch (error) {
      console.error('同步到雲端失敗:', error);
      updateSyncIndicator('error');
      showToast('error', '同步失敗: ' + error.message);
      
      // 標記為待同步
      markPendingSync();
  } finally {
      syncStatus.pendingSync = false;
  }
}

// 從雲端同步
async function syncFromCloud() {
  if (!syncStatus.isOnline || syncStatus.pendingSync) {
      return;
  }
  
  syncStatus.pendingSync = true;
  updateSyncIndicator('syncing');
  
  try {
      // 從雲端獲取資料
      const cloudData = await fetchCloudData();
      
      // 合併本地和雲端資料
      mergeCloudData(cloudData);
      
      // 更新同步時間
      syncStatus.lastSync = new Date().toISOString();
      localStorage.setItem('lastSync', syncStatus.lastSync);
      
      updateSyncIndicator('synced');
      
      // 更新顯示
      updateDashboard();
      displayTransactions();
      displayMembers();
      
  } catch (error) {
      console.error('從雲端同步失敗:', error);
      updateSyncIndicator('error');
      showToast('error', '同步失敗: ' + error.message);
  } finally {
      syncStatus.pendingSync = false;
  }
}

// 同步交易記錄到雲端
async function syncTransactionsToCloud() {
  const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
          'Content-Type': 'application/json',
      },
      body: JSON.stringify({
          action: 'syncTransactions',
          transactions: transactions
      })
  });
  
  const result = await response.json();
  
  if (!result.success) {
      throw new Error(result.error);
  }
  
  return result.data;
}

// 同步會員資料到雲端
async function syncMembersToCloud() {
  const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
          'Content-Type': 'application/json',
      },
      body: JSON.stringify({
          action: 'syncMembers',
          members: members
      })
  });
  
  const result = await response.json();
  
  if (!result.success) {
      throw new Error(result.error);
  }
  
  return result.data;
}

// 同步系統設定到雲端
async function syncSettingsToCloud() {
  const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
          'Content-Type': 'application/json',
      },
      body: JSON.stringify({
          action: 'syncSettings',
          settings: settings
      })
  });
  
  const result = await response.json();
  
  if (!result.success) {
      throw new Error(result.error);
  }
  
  return result.data;
}

// 從雲端獲取資料
async function fetchCloudData() {
  const [transactionsResponse, membersResponse, settingsResponse] = await Promise.all([
      fetch(`${API_URL}?action=getTransactions`),
      fetch(`${API_URL}?action=getMembers`),
      fetch(`${API_URL}?action=getSettings`)
  ]);
  
  const [transactionsResult, membersResult, settingsResult] = await Promise.all([
      transactionsResponse.json(),
      membersResponse.json(),
      settingsResponse.json()
  ]);
  
  return {
      transactions: transactionsResult.success ? transactionsResult.data : [],
      members: membersResult.success ? membersResult.data : [],
      settings: settingsResult.success ? settingsResult.data : {}
  };
}

// 合併雲端資料
function mergeCloudData(cloudData) {
  // 合併交易記錄
  if (cloudData.transactions) {
      const localIds = new Set(transactions.map(t => t.id));
      const cloudTransactions = cloudData.transactions.filter(t => !localIds.has(t.id));
      transactions.push(...cloudTransactions);
  }
  
  // 合併會員資料
  if (cloudData.members) {
      const localIds = new Set(members.map(m => m.id));
      const cloudMembers = cloudData.members.filter(m => !localIds.has(m.id));
      members.push(...cloudMembers);
  }
  
  // 合併系統設定
  if (cloudData.settings) {
      settings = { ...settings, ...cloudData.settings };
  }
  
  // 儲存到本地
  saveData();
  saveSettings();
}

// 自動同步
async function autoSync() {
  if (!syncStatus.isOnline) {
      return;
  }
  
  try {
      // 如果有本地變更，同步到雲端
      if (hasPendingChanges()) {
          await syncToCloud();
      } else {
          // 否則從雲端同步
          await syncFromCloud();
      }
  } catch (error) {
      console.error('自動同步失敗:', error);
  }
}

// 檢查是否有待同步的變更
function hasPendingChanges() {
  return localStorage.getItem('pendingSync') === 'true';
}

// 標記為待同步
function markPendingSync() {
  localStorage.setItem('pendingSync', 'true');
}

// 清除待同步標記
function clearPendingSync() {
  localStorage.removeItem('pendingSync');
}

// 檢查待同步狀態
function checkPendingSync() {
  if (hasPendingChanges() && syncStatus.isOnline) {
      setTimeout(() => {
          syncToCloud();
      }, 2000); // 延遲2秒後同步
  }
}

// 更新同步指示器
function updateSyncIndicator(status) {
  const indicator = document.getElementById('syncIndicator');
  if (!indicator) return;
  
  switch (status) {
      case 'syncing':
          indicator.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> 同步中';
          indicator.className = 'badge bg-warning';
          break;
      case 'synced':
          indicator.innerHTML = '<i class="bi bi-cloud-check"></i> 已同步';
          indicator.className = 'badge bg-success';
          break;
      case 'error':
          indicator.innerHTML = '<i class="bi bi-cloud-slash"></i> 同步失敗';
          indicator.className = 'badge bg-danger';
          break;
      case 'offline':
          indicator.innerHTML = '<i class="bi bi-wifi-off"></i> 離線';
          indicator.className = 'badge bg-secondary';
          break;
      case 'online':
          indicator.innerHTML = '<i class="bi bi-wifi"></i> 已連線';
          indicator.className = 'badge bg-info';
          break;
      default:
          indicator.innerHTML = '<i class="bi bi-cloud"></i> 未知';
          indicator.className = 'badge bg-secondary';
  }
}

// 手動同步
async function manualSync() {
  if (!syncStatus.isOnline) {
      showToast('error', '目前離線，無法同步');
      return;
  }
  
  try {
      await syncToCloud();
      showToast('success', '手動同步完成');
  } catch (error) {
      showToast('error', '手動同步失敗: ' + error.message);
  }
}

// 創建雲端備份
async function createCloudBackup() {
  if (!syncStatus.isOnline) {
      showToast('error', '目前離線，無法創建備份');
      return;
  }
  
  try {
      updateSyncIndicator('syncing');
      
      const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({
              action: 'backup'
          })
      });
      
      const result = await response.json();
      
      if (!result.success) {
          throw new Error(result.error);
      }
      
      updateSyncIndicator('synced');
      
      Swal.fire({
          title: '備份成功',
          html: `
              <p>備份已創建成功</p>
              <p><strong>備份名稱:</strong> ${result.data.backupName}</p>
              <p><strong>備份時間:</strong> ${new Date(result.data.timestamp).toLocaleString('zh-TW')}</p>
              <a href="${result.data.url}" target="_blank" class="btn btn-primary">
                  <i class="bi bi-box-arrow-up-right"></i> 開啟備份檔案
              </a>
          `,
          icon: 'success'
      });
      
  } catch (error) {
      updateSyncIndicator('error');
      showToast('error', '創建備份失敗: ' + error.message);
  }
}

// 匯出所有資料到雲端
async function exportAllData() {
  try {
      // 先同步到雲端
      await syncToCloud();
      
      // 然後創建備份
      await createCloudBackup();
      
  } catch (error) {
      showToast('error', '匯出失敗: ' + error.message);
  }
}

// 從雲端匯入資料
async function importAllData() {
  if (!syncStatus.isOnline) {
      showToast('error', '目前離線，無法匯入資料');
      return;
  }
  
  Swal.fire({
      title: '確認匯入',
      text: '這將會覆蓋本地所有資料，您確定要繼續嗎？',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: '確定匯入',
      cancelButtonText: '取消'
  }).then(async (result) => {
      if (result.isConfirmed) {
          try {
              // 從雲端獲取資料
              const cloudData = await fetchCloudData();
              
              // 直接替換本地資料
              transactions = cloudData.transactions || [];
              members = cloudData.members || [];
              settings = { ...settings, ...cloudData.settings };
              
              // 儲存到本地
              saveData();
              saveSettings();
              
              // 更新顯示
              updateDashboard();
              displayTransactions();
              displayMembers();
              
              showToast('success', '資料匯入完成');
              
          } catch (error) {
              showToast('error', '匯入失敗: ' + error.message);
          }
      }
  });
}

// 修改原有的 saveData 函數，添加同步標記
const originalSaveData = saveData;
saveData = function() {
  originalSaveData();
  
  // 標記為待同步
  markPendingSync();
  
  // 如果在線，延遲同步
  if (syncStatus.isOnline) {
      setTimeout(() => {
          syncToCloud();
      }, 1000);
  }
};

// 修改原有的 saveSettings 函數，添加同步標記
const originalSaveSettings = saveSettings;
saveSettings = function() {
  originalSaveSettings();
  
  // 標記為待同步
  markPendingSync();
  
  // 如果在線，延遲同步
  if (syncStatus.isOnline) {
      setTimeout(() => {
          syncToCloud();
      }, 1000);
  }
};

// 同步狀態監控
function startSyncMonitoring() {
  // 每30秒檢查一次同步狀態
  setInterval(() => {
      if (syncStatus.isOnline && !syncStatus.pendingSync) {
          // 檢查最後同步時間，如果超過10分鐘則自動同步
          const lastSync = new Date(syncStatus.lastSync || 0);
          const now = new Date();
          const diffMinutes = (now - lastSync) / (1000 * 60);
          
          if (diffMinutes > 10) {
              autoSync();
          }
      }
  }, 30000);
}

// 衝突解決
function resolveConflicts(localData, cloudData, type) {
  const conflicts = [];
  const resolved = [];
  
  if (type === 'transactions') {
      const localMap = new Map(localData.map(t => [t.id, t]));
      const cloudMap = new Map(cloudData.map(t => [t.id, t]));
      
      // 檢查衝突
      for (const [id, localItem] of localMap) {
          if (cloudMap.has(id)) {
              const cloudItem = cloudMap.get(id);
              if (localItem.updatedAt !== cloudItem.updatedAt) {
                  conflicts.push({
                      id,
                      local: localItem,
                      cloud: cloudItem,
                      type: 'transaction'
                  });
              }
          }
      }
  } else if (type === 'members') {
      const localMap = new Map(localData.map(m => [m.id, m]));
      const cloudMap = new Map(cloudData.map(m => [m.id, m]));
      
      // 檢查衝突
      for (const [id, localItem] of localMap) {
          if (cloudMap.has(id)) {
              const cloudItem = cloudMap.get(id);
              if (localItem.updatedAt !== cloudItem.updatedAt) {
                  conflicts.push({
                      id,
                      local: localItem,
                      cloud: cloudItem,
                      type: 'member'
                  });
              }
          }
      }
  }
  
  return conflicts;
}

// 顯示衝突解決對話框
async function showConflictResolution(conflicts) {
  if (conflicts.length === 0) return [];
  
  const resolutions = [];
  
  for (const conflict of conflicts) {
      const result = await Swal.fire({
          title: '資料衝突',
          html: `
              <div class="conflict-resolution">
                  <p>發現資料衝突，請選擇要保留的版本：</p>
                  <div class="row">
                      <div class="col-6">
                          <h6>本地版本</h6>
                          <div class="conflict-data">
                              <small>更新時間: ${new Date(conflict.local.updatedAt).toLocaleString('zh-TW')}</small>
                              <pre>${JSON.stringify(conflict.local, null, 2).substring(0, 200)}...</pre>
                          </div>
                      </div>
                      <div class="col-6">
                          <h6>雲端版本</h6>
                          <div class="conflict-data">
                              <small>更新時間: ${new Date(conflict.cloud.updatedAt).toLocaleString('zh-TW')}</small>
                              <pre>${JSON.stringify(conflict.cloud, null, 2).substring(0, 200)}...</pre>
                          </div>
                      </div>
                  </div>
              </div>
          `,
          showCancelButton: true,
          showDenyButton: true,
          confirmButtonText: '使用本地版本',
          denyButtonText: '使用雲端版本',
          cancelButtonText: '跳過此項',
          customClass: {
              popup: 'conflict-popup'
          }
      });
      
      if (result.isConfirmed) {
          resolutions.push({ id: conflict.id, choice: 'local', data: conflict.local });
      } else if (result.isDenied) {
          resolutions.push({ id: conflict.id, choice: 'cloud', data: conflict.cloud });
      }
  }
  
  return resolutions;
}

// 網路狀態檢測
async function checkNetworkStatus() {
  if (!navigator.onLine) {
      return false;
  }
  
  try {
      // 嘗試連接到 Google Apps Script
      const response = await fetch(`${API_URL}?action=health`, {
          method: 'GET',
          timeout: 5000
      });
      
      return response.ok;
  } catch (error) {
      return false;
  }
}

// 離線資料管理
class OfflineDataManager {
  constructor() {
      this.dbName = 'ParkinsonAccountingDB';
      this.version = 1;
      this.db = null;
  }
  
  async init() {
      return new Promise((resolve, reject) => {
          const request = indexedDB.open(this.dbName, this.version);
          
          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
              this.db = request.result;
              resolve();
          };
          
          request.onupgradeneeded = (event) => {
              const db = event.target.result;
              
              // 創建離線操作記錄表
              if (!db.objectStoreNames.contains('offlineOperations')) {
                  const store = db.createObjectStore('offlineOperations', {
                      keyPath: 'id',
                      autoIncrement: true
                  });
                  store.createIndex('timestamp', 'timestamp');
                  store.createIndex('type', 'type');
              }
              
              // 創建快照表
              if (!db.objectStoreNames.contains('snapshots')) {
                  const store = db.createObjectStore('snapshots', {
                      keyPath: 'id'
                  });
              }
          };
      });
  }
  
  async addOfflineOperation(operation) {
      const transaction = this.db.transaction(['offlineOperations'], 'readwrite');
      const store = transaction.objectStore('offlineOperations');
      
      const operationData = {
          ...operation,
          timestamp: new Date().toISOString()
      };
      
      return store.add(operationData);
  }
  
  async getOfflineOperations() {
      const transaction = this.db.transaction(['offlineOperations'], 'readonly');
      const store = transaction.objectStore('offlineOperations');
      
      return new Promise((resolve, reject) => {
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
      });
  }
  
  async clearOfflineOperations() {
      const transaction = this.db.transaction(['offlineOperations'], 'readwrite');
      const store = transaction.objectStore('offlineOperations');
      return store.clear();
  }
  
  async saveSnapshot(type, data) {
      const transaction = this.db.transaction(['snapshots'], 'readwrite');
      const store = transaction.objectStore('snapshots');
      
      const snapshot = {
          id: type,
          data: data,
          timestamp: new Date().toISOString()
      };
      
      return store.put(snapshot);
  }
  
  async getSnapshot(type) {
      const transaction = this.db.transaction(['snapshots'], 'readonly');
      const store = transaction.objectStore('snapshots');
      
      return new Promise((resolve, reject) => {
          const request = store.get(type);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
      });
  }
}

// 初始化離線資料管理器
const offlineManager = new OfflineDataManager();

// 離線操作處理
async function handleOfflineOperation(operation) {
  try {
      await offlineManager.addOfflineOperation(operation);
      showToast('info', '離線操作已記錄，將在連線後同步');
  } catch (error) {
      console.error('記錄離線操作失敗:', error);
  }
}

// 處理離線操作佇列
async function processOfflineOperations() {
  if (!syncStatus.isOnline) return;
  
  try {
      const operations = await offlineManager.getOfflineOperations();
      
      if (operations.length === 0) return;
      
      showToast('info', `正在處理 ${operations.length} 個離線操作...`);
      
      for (const operation of operations) {
          try {
              await executeOperation(operation);
          } catch (error) {
              console.error('執行離線操作失敗:', operation, error);
          }
      }
      
      // 清除已處理的操作
      await offlineManager.clearOfflineOperations();
      
      showToast('success', '離線操作處理完成');
      
  } catch (error) {
      console.error('處理離線操作失敗:', error);
  }
}

// 執行操作
async function executeOperation(operation) {
  switch (operation.type) {
      case 'addTransaction':
          // 重新執行添加交易操作
          break;
      case 'updateTransaction':
          // 重新執行更新交易操作
          break;
      case 'deleteTransaction':
          // 重新執行刪除交易操作
          break;
      case 'addMember':
          // 重新執行添加會員操作
          break;
      case 'updateMember':
          // 重新執行更新會員操作
          break;
      case 'deleteMember':
          // 重新執行刪除會員操作
          break;
      default:
          console.warn('未知的操作類型:', operation.type);
  }
}

// 同步進度顯示
function showSyncProgress(current, total, message) {
  const progressBar = document.getElementById('syncProgress');
  if (progressBar) {
      const percentage = Math.round((current / total) * 100);
      progressBar.style.width = percentage + '%';
      progressBar.textContent = `${message} (${current}/${total})`;
  }
}

// 同步統計
function updateSyncStats() {
  const stats = {
      totalTransactions: transactions.length,
      totalMembers: members.length,
      lastSyncTime: syncStatus.lastSync ? new Date(syncStatus.lastSync).toLocaleString('zh-TW') : '從未同步',
      networkStatus: syncStatus.isOnline ? '已連線' : '離線',
      pendingOperations: 0 // 這裡可以從 IndexedDB 獲取
  };
  
  // 更新統計顯示
  const statsElement = document.getElementById('syncStats');
  if (statsElement) {
      statsElement.innerHTML = `
          <div class="sync-stats">
              <div class="stat-item">
                  <span class="stat-label">交易記錄:</span>
                  <span class="stat-value">${stats.totalTransactions}</span>
              </div>
              <div class="stat-item">
                  <span class="stat-label">會員資料:</span>
                  <span class="stat-value">${stats.totalMembers}</span>
              </div>
              <div class="stat-item">
                  <span class="stat-label">最後同步:</span>
                  <span class="stat-value">${stats.lastSyncTime}</span>
              </div>
              <div class="stat-item">
                  <span class="stat-label">網路狀態:</span>
                  <span class="stat-value ${stats.networkStatus === '已連線' ? 'text-success' : 'text-danger'}">${stats.networkStatus}</span>
              </div>
          </div>
      `;
  }
}

// 錯誤重試機制
async function retryOperation(operation, maxRetries = 3, delay = 1000) {
  let lastError;
  
  for (let i = 0; i < maxRetries; i++) {
      try {
          return await operation();
      } catch (error) {
          lastError = error;
          
          if (i < maxRetries - 1) {
              // 等待後重試
              await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
          }
      }
  }
  
  throw lastError;
}

// 資料完整性檢查
function validateDataIntegrity() {
  const issues = [];
  
  // 檢查交易記錄
  transactions.forEach((transaction, index) => {
      if (!transaction.id) {
          issues.push(`交易記錄 ${index} 缺少 ID`);
      }
      if (!transaction.date) {
          issues.push(`交易記錄 ${transaction.id || index} 缺少日期`);
      }
      if (!transaction.amount || isNaN(transaction.amount)) {
          issues.push(`交易記錄 ${transaction.id || index} 金額無效`);
      }
  });
  
  // 檢查會員資料
  members.forEach((member, index) => {
      if (!member.id) {
          issues.push(`會員 ${index} 缺少 ID`);
      }
      if (!member.name) {
          issues.push(`會員 ${member.id || index} 缺少姓名`);
      }
      if (!member.phone) {
          issues.push(`會員 ${member.id || index} 缺少電話`);
      }
  });
  
  if (issues.length > 0) {
      console.warn('資料完整性檢查發現問題:', issues);
      return false;
  }
  
  return true;
}

// 初始化所有同步功能
async function initializeSyncSystem() {
  try {
      // 初始化離線資料管理器
      await offlineManager.init();
      
      // 初始化同步功能
      initializeSync();
      
      // 開始同步監控
      startSyncMonitoring();
      
      // 處理離線操作
      if (syncStatus.isOnline) {
          await processOfflineOperations();
      }
      
      // 更新同步統計
      updateSyncStats();
      
      console.log('同步系統初始化完成');
      
  } catch (error) {
      console.error('同步系統初始化失敗:', error);
      showToast('error', '同步系統初始化失敗');
  }
}

// 將同步功能綁定到全域
window.manualSync = manualSync;
window.createCloudBackup = createCloudBackup;
window.exportAllData = exportAllData;
window.importAllData = importAllData;
window.initializeSyncSystem = initializeSyncSystem;

// 在 DOMContentLoaded 事件中初始化同步系統
document.addEventListener('DOMContentLoaded', function() {
  // 原有的初始化代碼...
  
  // 初始化同步系統
  initializeSyncSystem();
});

        (function() {
            'use strict';

            // 全域變數
            let transactions = [];
            let members = [];
            let currentPage = 1;
            let itemsPerPage = 10;
            let currentMemberPage = 1;
            let memberItemsPerPage = 10;
            let charts = {};
            let settings = {
                organizationName: '台灣帕金森病友權益促進會',
                organizationAddress: '',
            organizationPhone: '',
            organizationEmail: '',
            defaultMembershipFee: 1000,
            receiptPrefix: 'R',
            enableAutoBackup: false,
            enableNotifications: true
        };

        // 收入和支出類別
        const categories = {
            收入: ['會費', '捐款', '活動收入', '政府補助', '利息收入', '其他收入'],
            支出: ['活動費用', '辦公費用', '交通費', '餐費', '場地費', '設備費', '印刷費', '郵電費', '保險費', '其他支出']
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
            loadData();
            updateDashboard();
            setupEventListeners();
            initializeCharts();
            setupKeyboardShortcuts();
        });

        // 系統初始化
        function initializeSystem() {
            // 設定今天的日期為預設值
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (input.id === 'date' || input.id === 'memberJoinDate') {
                    input.value = today;
                }
            });

            // 初始化年份選項
            const currentYear = new Date().getFullYear();
            const yearSelects = document.querySelectorAll('#filterYear, #analyticsYear');
            yearSelects.forEach(select => {
                for (let year = currentYear; year >= currentYear - 10; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year + '年';
                    select.appendChild(option);
                }
            });

            // 載入設定
            loadSettings();
        }

        // 載入資料
        function loadData() {
            const savedTransactions = localStorage.getItem('transactions');
            const savedMembers = localStorage.getItem('members');
            
            if (savedTransactions) {
                transactions = JSON.parse(savedTransactions);
            }
            
            if (savedMembers) {
                members = JSON.parse(savedMembers);
            }

            // 更新對象列表
            updateCounterpartyList();
        }

        // 儲存資料
        function saveData() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('members', JSON.stringify(members));
            updateSyncStatus();
        }

        // 載入設定
        function loadSettings() {
            const savedSettings = localStorage.getItem('systemSettings');
            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
            }
        }

        // 儲存設定
        function saveSettings() {
            localStorage.setItem('systemSettings', JSON.stringify(settings));
        }

        // 更新同步狀態
        function updateSyncStatus() {
            const indicator = document.getElementById('syncIndicator');
            indicator.innerHTML = '<i class="bi bi-cloud-upload"></i> 同步中';
            indicator.className = 'badge bg-warning';
            
            setTimeout(() => {
                indicator.innerHTML = '<i class="bi bi-cloud-check"></i> 已同步';
                indicator.className = 'badge bg-success';
            }, 1000);
        }

        // 設定事件監聽器
        function setupEventListeners() {
            // 表單提交事件
            document.getElementById('transactionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveTransaction();
            });

            document.getElementById('memberForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveMember();
            });

            // 檔案上傳事件
            document.getElementById('voucherFiles').addEventListener('change', handleVoucherUpload);
        }

        // 設定鍵盤快捷鍵
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey) {
                    switch(e.key) {
                        case 'n':
                            e.preventDefault();
                            showTransactionModal();
                            break;
                        case 'm':
                            e.preventDefault();
                            showMemberModal();
                            break;
                        case 's':
                            e.preventDefault();
                            if (document.getElementById('transactionModal').style.display !== 'none') {
                                saveTransaction();
                            } else if (document.getElementById('memberModal').style.display !== 'none') {
                                saveMember();
                            }
                            break;
                        case 'f':
                            e.preventDefault();
                            document.getElementById('searchKeyword').focus();
                            break;
                    }
                }
            });
        }

        // 顯示區段
        function showSection(sectionName) {
            // 隱藏所有區段
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });

            // 移除所有導航連結的active類別
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // 顯示選中的區段
            document.getElementById(sectionName + 'Section').style.display = 'block';

            // 添加active類別到對應的導航連結
            event.target.classList.add('active');

            // 根據區段執行特定操作
            switch(sectionName) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'transactions':
                    displayTransactions();
                    break;
                case 'members':
                    displayMembers();
                    break;
                case 'analytics':
                    updateAnalytics();
                    break;
                case 'reports':
                    // 報表區段的初始化
                    break;
            }
        }

        // 更新儀表板
        function updateDashboard() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;

            // 計算統計數據
            const totalIncome = transactions
                .filter(t => t.type === '收入')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const totalExpense = transactions
                .filter(t => t.type === '支出')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const totalMembers = members.length;

            const overdueMembers = members.filter(m => {
                if (!m.lastPaymentDate) return true;
                const lastPayment = new Date(m.lastPaymentDate);
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                return lastPayment < oneYearAgo;
            }).length;

            // 更新統計卡片
            document.getElementById('totalIncome').textContent = '$' + totalIncome.toLocaleString();
            document.getElementById('totalExpense').textContent = '$' + totalExpense.toLocaleString();
            document.getElementById('totalMembers').textContent = totalMembers.toLocaleString();
            document.getElementById('overdueMembers').textContent = overdueMembers.toLocaleString();

            // 更新最近交易
            updateRecentTransactions();

            // 更新最近會員
            updateRecentMembers();
        }

        // 更新最近交易
        function updateRecentTransactions() {
            const recentTransactions = transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            const container = document.getElementById('recentTransactions');
            
            if (recentTransactions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-receipt display-4"></i>
                        <p>尚無交易記錄</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recentTransactions.map(transaction => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                    <div>
                        <strong>${transaction.category}</strong>
                        <br>
                        <small class="text-muted">${transaction.date} | ${transaction.counterparty || '無'}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge ${transaction.type === '收入' ? 'bg-success' : 'bg-danger'}">
                            ${transaction.type === '收入' ? '+' : '-'}$${parseFloat(transaction.amount).toLocaleString()}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // 更新最近會員
        function updateRecentMembers() {
            const recentMembers = members
                .sort((a, b) => new Date(b.joinDate) - new Date(a.joinDate))
                .slice(0, 5);

            const container = document.getElementById('recentMembers');
            
            if (recentMembers.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-people display-4"></i>
                        <p>尚無會員資料</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recentMembers.map(member => `
                <div class="d-flex align-items-center mb-2 p-2 border-bottom">
                    <div class="member-avatar me-3">
                        <i class="bi bi-person"></i>
                    </div>
                    <div class="flex-grow-1">
                        <strong>${member.name}</strong>
                        <br>
                        <small class="text-muted">${member.joinDate} 加入</small>
                    </div>
                    <div>
                        <span class="badge ${getStatusBadgeClass(member.status)}">
                            ${getStatusText(member.status)}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // 顯示交易模態框
        function showTransactionModal(transactionId = null) {
            const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
            const form = document.getElementById('transactionForm');
            
            // 重置表單
            form.reset();
            document.getElementById('transactionId').value = '';
            document.getElementById('voucherPreview').innerHTML = '';
            
            if (transactionId) {
                // 編輯模式
                const transaction = transactions.find(t => t.id === transactionId);
                if (transaction) {
                    document.getElementById('transactionModalTitle').textContent = '編輯交易記錄';
                    document.getElementById('transactionId').value = transaction.id;
                    document.getElementById('date').value = transaction.date;
                    document.getElementById('type').value = transaction.type;
                    updateCategoryOptions();
                    document.getElementById('category').value = transaction.category;
                    document.getElementById('amount').value = transaction.amount;
                    document.getElementById('counterparty').value = transaction.counterparty || '';
                    document.getElementById('account').value = transaction.account || '現金';
                    document.getElementById('description').value = transaction.description || '';
                    document.getElementById('receiptNumber').value = transaction.receiptNumber || '';
                    
                    // 顯示現有憑證
                    if (transaction.vouchers && transaction.vouchers.length > 0) {
                        displayVoucherPreviews(transaction.vouchers);
                    }
                }
            } else {
                // 新增模式
                document.getElementById('transactionModalTitle').textContent = '新增交易記錄';
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                generateReceiptNumber();
            }
            
            modal.show();
        }

        // 更新類別選項
        function updateCategoryOptions() {
            const typeSelect = document.getElementById('type');
            const categorySelect = document.getElementById('category');
            const selectedType = typeSelect.value;
            
            categorySelect.innerHTML = '<option value="">請選擇類別</option>';
            
            if (selectedType && categories[selectedType]) {
                categories[selectedType].forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }
        }

        // 生成收據編號
        function generateReceiptNumber() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            
            // 計算今日已有的收據數量
            const todayTransactions = transactions.filter(t => t.date === today.toISOString().split('T')[0]);
            const sequence = String(todayTransactions.length + 1).padStart(3, '0');
            
            const receiptNumber = `${settings.receiptPrefix}${year}${month}${day}${sequence}`;
            document.getElementById('receiptNumber').value = receiptNumber;
        }

        // 處理憑證上傳
        function handleVoucherUpload(event) {
            const files = event.target.files;
            const previewContainer = document.getElementById('voucherPreview');
            
            previewContainer.innerHTML = '';
            
            Array.from(files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'voucher-preview-img';
                        img.onclick = () => showImagePreview(e.target.result);
                        previewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                } else if (file.type === 'application/pdf') {
                    const pdfIcon = document.createElement('div');
                    pdfIcon.className = 'voucher-preview-pdf';
                    pdfIcon.innerHTML = `
                        <i class="bi bi-file-earmark-pdf" style="font-size: 50px; color: #dc3545;"></i>
                        <div>${file.name}</div>
                    `;
                    previewContainer.appendChild(pdfIcon);
                }
            });
        }

        // 顯示圖片預覽
        function showImagePreview(src) {
            Swal.fire({
                imageUrl: src,
                imageAlt: '憑證預覽',
                showCloseButton: true,
                showConfirmButton: false,
                customClass: {
                    image: 'img-fluid'
                }
            });
        }

        // 儲存交易
        function saveTransaction() {
            const form = document.getElementById('transactionForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const transactionId = document.getElementById('transactionId').value;
            const isEdit = !!transactionId;
            
            const transactionData = {
                id: isEdit ? transactionId : generateId(),
                date: document.getElementById('date').value,
                type: document.getElementById('type').value,
                category: document.getElementById('category').value,
                amount: parseFloat(document.getElementById('amount').value),
                counterparty: document.getElementById('counterparty').value,
                account: document.getElementById('account').value,
                description: document.getElementById('description').value,
                receiptNumber: document.getElementById('receiptNumber').value,
                vouchers: [],
                createdAt: isEdit ? transactions.find(t => t.id === transactionId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // 處理憑證檔案
            const voucherFiles = document.getElementById('voucherFiles').files;
            if (voucherFiles.length > 0) {
                Array.from(voucherFiles).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        transactionData.vouchers.push({
                            name: file.name,
                            type: file.type,
                            data: e.target.result
                        });
                    };
                    reader.readAsDataURL(file);
                });
            }

            if (isEdit) {
                const index = transactions.findIndex(t => t.id === transactionId);
                transactions[index] = transactionData;
            } else {
                transactions.push(transactionData);
            }

            saveData();
            updateDashboard();
            displayTransactions();
            updateCounterpartyList();
            
            // 關閉模態框
            const modal = bootstrap.Modal.getInstance(document.getElementById('transactionModal'));
            modal.hide();
            
            showToast('success', isEdit ? '交易記錄已更新' : '交易記錄已新增');
        }

        // 刪除交易
        function deleteTransaction(transactionId) {
            Swal.fire({
                title: '確認刪除',
                text: '您確定要刪除這筆交易記錄嗎？',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '刪除',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    transactions = transactions.filter(t => t.id !== transactionId);
                    saveData();
                    updateDashboard();
                    displayTransactions();
                    showToast('success', '交易記錄已刪除');
                }
            });
        }

        // 顯示交易記錄
        function displayTransactions() {
            const tbody = document.getElementById('transactionTableBody');
            const recordCount = document.getElementById('recordCount');
            
            // 獲取篩選條件
            const filterYear = document.getElementById('filterYear').value;
            const filterMonth = document.getElementById('filterMonth').value;
            const filterType = document.getElementById('filterType').value;
            const searchKeyword = document.getElementById('searchKeyword').value.toLowerCase();

            // 篩選交易記錄
            let filteredTransactions = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                const matchYear = !filterYear || transactionDate.getFullYear().toString() === filterYear;
                const matchMonth = !filterMonth || (transactionDate.getMonth() + 1).toString() === filterMonth;
                const matchType = !filterType || transaction.type === filterType;
                const matchKeyword = !searchKeyword || 
                    transaction.category.toLowerCase().includes(searchKeyword) ||
                    transaction.description.toLowerCase().includes(searchKeyword) ||
                    (transaction.counterparty && transaction.counterparty.toLowerCase().includes(searchKeyword));
                
                return matchYear && matchMonth && matchType && matchKeyword;
            });

            // 排序（最新的在前）
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            // 分頁
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTransactions = filteredTransactions.slice(startIndex, endIndex);

            // 更新記錄數量
            recordCount.textContent = `${filteredTransactions.length} 筆記錄`;

            if (paginatedTransactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="bi bi-receipt display-4 text-muted"></i>
                            <div class="mt-2">找不到符合條件的交易記錄</div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = paginatedTransactions.map(transaction => `
                    <tr>
                        <td>
                            <input type="checkbox" class="transaction-checkbox" value="${transaction.id}">
                        </td>
                        <td>${transaction.date}</td>
                        <td>
                            <span class="badge ${transaction.type === '收入' ? 'bg-success' : 'bg-danger'}">
                                ${transaction.type}
                            </span>
                        </td>
                        <td>${transaction.category}</td>
                        <td class="text-end">
                            <strong class="${transaction.type === '收入' ? 'text-success' : 'text-danger'}">
                                ${transaction.type === '收入' ? '+' : '-'}$${parseFloat(transaction.amount).toLocaleString()}
                            </strong>
                        </td>
                        <td>${transaction.counterparty || '-'}</td>
                        <td>${transaction.description || '-'}</td>
                        <td>
                            ${transaction.vouchers && transaction.vouchers.length > 0 ? 
                                `<i class="bi bi-paperclip text-primary" title="有憑證"></i>` : 
                                '-'
                            }
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline-primary" onclick="showTransactionModal('${transaction.id}')" title="編輯">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="printReceipt('${transaction.id}')" title="列印收據">
                                    <i class="bi bi-printer"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction('${transaction.id}')" title="刪除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            // 更新分頁
            updatePagination(totalPages, currentPage, 'pagination');
        }

        // 更新分頁
        function updatePagination(totalPages, currentPageNum, paginationId) {
            const pagination = document.getElementById(paginationId);
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // 上一頁
            paginationHTML += `
                <li class="page-item ${currentPageNum === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPageNum - 1}, '${paginationId}')">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            `;

            // 頁碼
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPageNum - 2 && i <= currentPageNum + 2)) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPageNum ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i}, '${paginationId}')">${i}</a>
                        </li>
                    `;
                } else if (i === currentPageNum - 3 || i === currentPageNum + 3) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            // 下一頁
            paginationHTML += `
                <li class="page-item ${currentPageNum === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPageNum + 1}, '${paginationId}')">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;

            pagination.innerHTML = paginationHTML;
        }

        // 換頁
        function changePage(page, paginationId) {
            if (paginationId === 'pagination') {
                currentPage = page;
                displayTransactions();
            } else if (paginationId === 'memberPagination') {
                currentMemberPage = page;
                displayMembers();
            }
        }

        // 全選/取消全選
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.transaction-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        // 執行批量操作
        function performBatchAction() {
            const action = document.getElementById('batchAction').value;
            const selectedIds = Array.from(document.querySelectorAll('.transaction-checkbox:checked'))
                .map(checkbox => checkbox.value);

            if (!action) {
                showToast('error', '請選擇批量操作');
                return;
            }

            if (selectedIds.length === 0) {
                showToast('error', '請選擇要操作的記錄');
                return;
            }

            switch (action) {
                case 'delete':
                    batchDeleteTransactions(selectedIds);
                    break;
                case 'export':
                    batchExportTransactions(selectedIds);
                    break;
                case 'print':
                    batchPrintReceipts(selectedIds);
                    break;
            }
        }

        // 批量刪除交易
        function batchDeleteTransactions(ids) {
            Swal.fire({
                title: '確認批量刪除',
                text: `您確定要刪除選中的 ${ids.length} 筆交易記錄嗎？`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '刪除',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    transactions = transactions.filter(t => !ids.includes(t.id));
                    saveData();
                    updateDashboard();
                    displayTransactions();
                    showToast('success', `已刪除 ${ids.length} 筆交易記錄`);
                }
            });
        }

        // 生成唯一ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // 更新對象列表
        function updateCounterpartyList() {
            const counterparties = [...new Set(transactions
                .map(t => t.counterparty)
                .filter(c => c && c.trim() !== ''))];
            
            const datalist = document.getElementById('counterpartyList');
            datalist.innerHTML = counterparties.map(counterparty => 
                `<option value="${counterparty}"></option>`
            ).join('');
        }

        // 列印收據
        function printReceipt(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            const receiptWindow = window.open('', '_blank');
            receiptWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>收據 - ${transaction.receiptNumber}</title>
                    <style>
                        body { font-family: 'Microsoft JhengHei', sans-serif; margin: 20px; }
                        .receipt { max-width: 600px; margin: 0 auto; border: 2px solid #000; padding: 20px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .org-name { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
                        .receipt-title { font-size: 20px; font-weight: bold; }
                        .content { margin: 20px 0; }
                        .row { display: flex; justify-content: space-between; margin: 10px 0; }
                        .amount { font-size: 18px; font-weight: bold; text-align: center; margin: 20px 0; }
                        .footer { margin-top: 30px; text-align: right; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        <div class="header">
                            <div class="org-name">${settings.organizationName}</div>
                            <div class="receipt-title">收據</div>
                        </div>
                        <div class="content">
                            <div class="row">
                                <span>收據編號：</span>
                                <span>${transaction.receiptNumber}</span>
                            </div>
                            <div class="row">
                                <span>日期：</span>
                                <span>${transaction.date}</span>
                            </div>
                            <div class="row">
                                <span>收款對象：</span>
                                <span>${transaction.counterparty || '無'}</span>
                            </div>
                            <div class="row">
                                <span>收款項目：</span>
                                <span>${transaction.category}</span>
                            </div>
                            <div class="row">
                                <span>說明：</span>
                                <span>${transaction.description || '無'}</span>
                            </div>
                            <div class="amount">
                                收款金額：NT$ ${parseFloat(transaction.amount).toLocaleString()}
                            </div>
                        </div>
                        <div class="footer">
                            <div>開立日期：${new Date().toLocaleDateString('zh-TW')}</div>
                            <div style="margin-top: 20px;">
                                <div>開立人：_______________</div>
                                <div style="margin-top: 10px;">蓋章：</div>
                            </div>
                        </div>
                    </div>
                    <div class="no-print" style="text-align: center; margin-top: 20px;">
                        <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px;">列印收據</button>
                        <button onclick="window.close()" style="padding: 10px 20px; font-size: 16px; margin-left: 10px;">關閉</button>
                    </div>
                </body>
                </html>
            `);
            receiptWindow.document.close();
        }

        // 顯示會員模態框
        function showMemberModal(memberId = null) {
            const modal = new bootstrap.Modal(document.getElementById('memberModal'));
            const form = document.getElementById('memberForm');
            
            // 重置表單
            form.reset();
            document.getElementById('memberId').value = '';
            
            if (memberId) {
                // 編輯模式
                const member = members.find(m => m.id === memberId);
                if (member) {
                    document.getElementById('memberModalTitle').textContent = '編輯會員';
                    document.getElementById('memberId').value = member.id;
                    document.getElementById('memberName').value = member.name;
                    document.getElementById('memberPhone').value = member.phone;
                    document.getElementById('memberEmail').value = member.email || '';
                    document.getElementById('memberBirthDate').value = member.birthDate || '';
                    document.getElementById('memberGender').value = member.gender || '';
                    document.getElementById('memberIdNumber').value = member.idNumber || '';
                    document.getElementById('memberAddress').value = member.address || '';
                    document.getElementById('emergencyContact').value = member.emergencyContact || '';
                    document.getElementById('emergencyPhone').value = member.emergencyPhone || '';
                    document.getElementById('memberNotes').value = member.notes || '';
                    document.getElementById('memberJoinDate').value = member.joinDate;
                    document.getElementById('memberStatus').value = member.status;
                    document.getElementById('memberType').value = member.type || 'regular';
                    document.getElementById('membershipFee').value = member.membershipFee || settings.defaultMembershipFee;
                    document.getElementById('lastPaymentDate').value = member.lastPaymentDate || '';
                    document.getElementById('memberTags').value = member.tags ? member.tags.join(',') : '';
                }
            } else {
                // 新增模式
                document.getElementById('memberModalTitle').textContent = '新增會員';
                document.getElementById('memberJoinDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('membershipFee').value = settings.defaultMembershipFee;
                document.getElementById('memberStatus').value = 'active';
                document.getElementById('memberType').value = 'regular';
            }
            
            modal.show();
        }

        // 儲存會員
        function saveMember() {
            const form = document.getElementById('memberForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const memberId = document.getElementById('memberId').value;
            const isEdit = !!memberId;
            
            const memberData = {
                id: isEdit ? memberId : generateId(),
                name: document.getElementById('memberName').value,
                phone: document.getElementById('memberPhone').value,
                email: document.getElementById('memberEmail').value,
                birthDate: document.getElementById('memberBirthDate').value,
                gender: document.getElementById('memberGender').value,
                idNumber: document.getElementById('memberIdNumber').value,
                address: document.getElementById('memberAddress').value,
                emergencyContact: document.getElementById('emergencyContact').value,
                emergencyPhone: document.getElementById('emergencyPhone').value,
                notes: document.getElementById('memberNotes').value,
                joinDate: document.getElementById('memberJoinDate').value,
                status: document.getElementById('memberStatus').value,
                type: document.getElementById('memberType').value,
                membershipFee: parseFloat(document.getElementById('membershipFee').value),
                lastPaymentDate: document.getElementById('lastPaymentDate').value,
                tags: document.getElementById('memberTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                createdAt: isEdit ? members.find(m => m.id === memberId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (isEdit) {
                const index = members.findIndex(m => m.id === memberId);
                members[index] = memberData;
            } else {
                members.push(memberData);
            }

            saveData();
            updateDashboard();
            displayMembers();
            
            // 關閉模態框
            const modal = bootstrap.Modal.getInstance(document.getElementById('memberModal'));
            modal.hide();
            
            showToast('success', isEdit ? '會員資料已更新' : '會員已新增');
        }

        // 刪除會員
        function deleteMember(memberId) {
            Swal.fire({
                title: '確認刪除',
                text: '您確定要刪除這位會員嗎？',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '刪除',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    members = members.filter(m => m.id !== memberId);
                    saveData();
                    updateDashboard();
                    displayMembers();
                    showToast('success', '會員已刪除');
                }
            });
        }

        // 顯示會員列表
        function displayMembers() {
            const tbody = document.getElementById('memberTableBody');
            const recordCount = document.getElementById('memberRecordCount');
            
            // 獲取篩選條件
            const memberFilter = document.getElementById('memberFilter').value;
            const memberSearch = document.getElementById('memberSearch').value.toLowerCase();

            // 篩選會員
            let filteredMembers = members.filter(member => {
                const matchStatus = !memberFilter || member.status === memberFilter;
                const matchSearch = !memberSearch || 
                    member.name.toLowerCase().includes(memberSearch) ||
                    member.phone.includes(memberSearch) ||
                    (member.email && member.email.toLowerCase().includes(memberSearch));
                
                return matchStatus && matchSearch;
            });

            // 排序（最新加入的在前）
            filteredMembers.sort((a, b) => new Date(b.joinDate) - new Date(a.joinDate));

            // 分頁
            const totalPages = Math.ceil(filteredMembers.length / memberItemsPerPage);
            const startIndex = (currentMemberPage - 1) * memberItemsPerPage;
            const endIndex = startIndex + memberItemsPerPage;
            const paginatedMembers = filteredMembers.slice(startIndex, endIndex);

            // 更新統計
            updateMemberStats(filteredMembers);

            // 更新記錄數量
            recordCount.textContent = `${filteredMembers.length} 筆記錄`;

            if (paginatedMembers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="bi bi-people display-4 text-muted"></i>
                            <div class="mt-2">找不到符合條件的會員</div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = paginatedMembers.map(member => `
                    <tr>
                        <td>
                            <input type="checkbox" class="member-checkbox" value="${member.id}">
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="member-avatar me-3">
                                    <i class="bi bi-person"></i>
                                </div>
                                <div>
                                    <strong>${member.name}</strong>
                                    <br>
                                    <small class="text-muted">ID: ${member.id}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>
                                <i class="bi bi-telephone"></i> ${member.phone}
                            </div>
                            ${member.email ? `<div><i class="bi bi-envelope"></i> ${member.email}</div>` : ''}
                        </td>
                        <td>
                            ${member.birthDate ? calculateAge(member.birthDate) + '歲' : '-'}
                            ${member.gender ? ' / ' + member.gender : ''}
                        </td>
                        <td>${member.joinDate}</td>
                        <td>
                            <span class="badge ${getStatusBadgeClass(member.status)}">
                                ${getStatusText(member.status)}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${getDuesStatusBadgeClass(member)}">
                                ${getDuesStatusText(member)}
                            </span>
                        </td>
                        <td>
                            ${member.tags ? member.tags.map(tag => 
                                `<span class="badge bg-secondary me-1">${tag}</span>`
                            ).join('') : '-'}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline-info" onclick="showMemberDetail('${member.id}')" title="詳情">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="showMemberModal('${member.id}')" title="編輯">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="recordMembershipPayment('${member.id}')" title="繳費">
                                    <i class="bi bi-credit-card"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteMember('${member.id}')" title="刪除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            // 更新分頁
            updatePagination(totalPages, currentMemberPage, 'memberPagination');
        }

        // 更新會員統計
        function updateMemberStats(filteredMembers = members) {
            const totalMembers = filteredMembers.length;
            const activeMembers = filteredMembers.filter(m => m.status === 'active').length;
            const overdueMembers = filteredMembers.filter(m => isDuesOverdue(m)).length;
            
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            const newMembers = filteredMembers.filter(m => {
                const joinDate = new Date(m.joinDate);
                return joinDate.getMonth() + 1 === currentMonth && joinDate.getFullYear() === currentYear;
            }).length;

            document.getElementById('totalMembersCount').textContent = totalMembers;
            document.getElementById('activeMembersCount').textContent = activeMembers;
            document.getElementById('overdueMembersCount').textContent = overdueMembers;
            document.getElementById('newMembersCount').textContent = newMembers;
        }

        // 計算年齡
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        // 獲取狀態徽章樣式
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'active': return 'bg-success';
                case 'inactive': return 'bg-danger';
                case 'pending': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }

        // 獲取狀態文字
        function getStatusText(status) {
            switch (status) {
                case 'active': return '正常';
                case 'inactive': return '停權';
                case 'pending': return '待審核';
                default: return '未知';
            }
        }

        // 獲取會費狀態徽章樣式
        function getDuesStatusBadgeClass(member) {
            return isDuesOverdue(member) ? 'bg-danger' : 'bg-success';
        }

        // 獲取會費狀態文字
        function getDuesStatusText(member) {
            return isDuesOverdue(member) ? '逾期' : '正常';
        }

        // 檢查會費是否逾期
        function isDuesOverdue(member) {
            if (!member.lastPaymentDate) return true;
            
            const lastPayment = new Date(member.lastPaymentDate);
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            
            return lastPayment < oneYearAgo;
        }

        // 顯示會員詳情
        function showMemberDetail(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;

            const modal = new bootstrap.Modal(document.getElementById('memberDetailModal'));
            const content = document.getElementById('memberDetailContent');
            
            const memberTransactions = transactions.filter(t => 
                t.counterparty && t.counterparty.includes(member.name)
            );

            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-person-badge"></i> 基本資料</h6>
                        <table class="table table-sm">
                            <tr><td><strong>姓名：</strong></td><td>${member.name}</td></tr>
                            <tr><td><strong>電話：</strong></td><td>${member.phone}</td></tr>
                            <tr><td><strong>電子郵件：</strong></td><td>${member.email || '無'}</td></tr>
                            <tr><td><strong>出生日期：</strong></td><td>${member.birthDate || '無'}</td></tr>
                            <tr><td><strong>性別：</strong></td><td>${member.gender || '無'}</td></tr>
                            <tr><td><strong>身分證字號：</strong></td><td>${member.idNumber || '無'}</td></tr>
                            <tr><td><strong>地址：</strong></td><td>${member.address || '無'}</td></tr>
                            <tr><td><strong>緊急聯絡人：</strong></td><td>${member.emergencyContact || '無'}</td></tr>
                            <tr><td><strong>緊急聯絡電話：</strong></td><td>${member.emergencyPhone || '無'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-card-checklist"></i> 會員資訊</h6>
                        <table class="table table-sm">
                            <tr><td><strong>加入日期：</strong></td><td>${member.joinDate}</td></tr>
                            <tr><td><strong>會員狀態：</strong></td><td>
                                <span class="badge ${getStatusBadgeClass(member.status)}">
                                    ${getStatusText(member.status)}
                                </span>
                            </td></tr>
                            <tr><td><strong>會員類型：</strong></td><td>${getMemberTypeText(member.type)}</td></tr>
                            <tr><td><strong>年費金額：</strong></td><td>$${member.membershipFee?.toLocaleString() || '0'}</td></tr>
                            <tr><td><strong>最後繳費日期：</strong></td><td>${member.lastPaymentDate || '無'}</td></tr>
                            <tr><td><strong>會費狀態：</strong></td><td>
                                <span class="badge ${getDuesStatusBadgeClass(member)}">
                                    ${getDuesStatusText(member)}
                                </span>
                            </td></tr>
                            <tr><td><strong>標籤：</strong></td><td>
                                ${member.tags ? member.tags.map(tag => 
                                    `<span class="badge bg-secondary me-1">${tag}</span>`
                                ).join('') : '無'}
                            </td></tr>
                        </table>
                    </div>
                </div>
                
                ${member.notes ? `
                    <div class="mt-3">
                        <h6><i class="bi bi-sticky"></i> 備註</h6>
                        <div class="alert alert-info">${member.notes}</div>
                    </div>
                ` : ''}

                <div class="mt-3">
                    <h6><i class="bi bi-receipt"></i> 相關交易記錄</h6>
                    ${memberTransactions.length > 0 ? `
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>日期</th>
                                        <th>類型</th>
                                        <th>類別</th>
                                        <th>金額</th>
                                        <th>說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${memberTransactions.map(t => `
                                        <tr>
                                            <td>${t.date}</td>
                                            <td><span class="badge ${t.type === '收入' ? 'bg-success' : 'bg-danger'}">${t.type}</span></td>
                                            <td>${t.category}</td>
                                            <td class="${t.type === '收入' ? 'text-success' : 'text-danger'}">
                                                ${t.type === '收入' ? '+' : '-'}$${parseFloat(t.amount).toLocaleString()}
                                            </td>
                                            <td>${t.description || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : '<div class="text-muted">無相關交易記錄</div>'}
                </div>
            `;
            
            modal.show();
        }

        // 獲取會員類型文字
        function getMemberTypeText(type) {
            switch (type) {
                case 'regular': return '一般會員';
                case 'honorary': return '榮譽會員';
                case 'life': return '終身會員';
                case 'family': return '家屬會員';
                default: return '一般會員';
            }
        }

        // 記錄會費繳納
        function recordMembershipPayment(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;

            Swal.fire({
                title: '記錄會費繳納',
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <label class="form-label">會員：</label>
                            <input type="text" class="form-control" value="${member.name}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">繳費日期：</label>
                            <input type="date" class="form-control" id="paymentDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">繳費金額：</label>
                            <input type="number" class="form-control" id="paymentAmount" value="${member.membershipFee || settings.defaultMembershipFee}" min="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">繳費方式：</label>
                            <select class="form-select" id="paymentMethod">
                                <option value="現金">現金</option>
                                <option value="銀行轉帳">銀行轉帳</option>
                                <option value="支票">支票</option>
                                <option value="信用卡">信用卡</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">備註：</label>
                            <textarea class="form-control" id="paymentNote" rows="2"></textarea>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '記錄繳費',
                cancelButtonText: '取消',
                preConfirm: () => {
                    const date = document.getElementById('paymentDate').value;
                    const amount = parseFloat(document.getElementById('paymentAmount').value);
                    const method = document.getElementById('paymentMethod').value;
                    const note = document.getElementById('paymentNote').value;

                    if (!date || !amount || amount <= 0) {
                        Swal.showValidationMessage('請填寫完整的繳費資訊');
                        return false;
                    }

                    return { date, amount, method, note };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const { date, amount, method, note } = result.value;

                    // 更新會員最後繳費日期
                    const memberIndex = members.findIndex(m => m.id === memberId);
                    members[memberIndex].lastPaymentDate = date;

                    // 新增交易記錄
                    const transaction = {
                        id: generateId(),
                        date: date,
                        type: '收入',
                        category: '會費',
                        amount: amount,
                        counterparty: member.name,
                        account: method,
                        description: `${member.name} 會費繳納${note ? ' - ' + note : ''}`,
                        receiptNumber: generateReceiptNumber(),
                        vouchers: [],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };

                    transactions.push(transaction);
                    saveData();
                    updateDashboard();
                    displayMembers();
                    displayTransactions();

                    showToast('success', '會費繳納記錄已新增');
                }
            });
        }

        // 全選/取消全選會員
        function toggleSelectAllMembers() {
            const selectAll = document.getElementById('selectAllMembers');
            const checkboxes = document.querySelectorAll('.member-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        // 執行會員批量操作
        function performMemberBatchAction() {
            const action = document.getElementById('memberBatchAction').value;
            const selectedIds = Array.from(document.querySelectorAll('.member-checkbox:checked'))
                .map(checkbox => checkbox.value);

            if (!action) {
                showToast('error', '請選擇批量操作');
                return;
            }

            if (selectedIds.length === 0) {
                showToast('error', '請選擇要操作的會員');
                return;
            }

            switch (action) {
                case 'export':
                    batchExportMembers(selectedIds);
                    break;
                case 'sendEmail':
                    batchSendEmail(selectedIds);
                    break;
                case 'updateStatus':
                    batchUpdateMemberStatus(selectedIds);
                    break;
                case 'delete':
                    batchDeleteMembers(selectedIds);
                    break;
            }
        }

        // 批量刪除會員
        function batchDeleteMembers(ids) {
            Swal.fire({
                title: '確認批量刪除',
                text: `您確定要刪除選中的 ${ids.length} 位會員嗎？`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '刪除',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    members = members.filter(m => !ids.includes(m.id));
                    saveData();
                    updateDashboard();
                    displayMembers();
                    showToast('success', `已刪除 ${ids.length} 位會員`);
                }
            });
        }

        // 初始化圖表
        function initializeCharts() {
            // 收支趨勢圖
            const trendCtx = document.getElementById('trendChart');
            if (trendCtx) {
                charts.trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '收入',
                            data: [],
                            borderColor: '#198754',
                            backgroundColor: 'rgba(25, 135, 84, 0.1)',
                            tension: 0.4
                        }, {
                            label: '支出',
                            data: [],
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '月度收支趨勢'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 支出類別圓餅圖
            const categoryCtx = document.getElementById('categoryChart');
            if (categoryCtx) {
                charts.categoryChart = new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '支出類別分布'
                            },
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // 月度收支對比
            const monthlyCtx = document.getElementById('monthlyChart');
            if (monthlyCtx) {
                charts.monthlyChart = new Chart(monthlyCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '收入',
                            data: [],
                            backgroundColor: '#198754'
                        }, {
                            label: '支出',
                            data: [],
                            backgroundColor: '#dc3545'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '月度收支對比'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // 更新分析數據
        function updateAnalytics() {
            const year = document.getElementById('analyticsYear').value || new Date().getFullYear();
            
            // 更新圖表數據
            updateTrendChart(year);
            updateCategoryChart(year);
            updateMonthlyChart(year);
            
            // 更新統計摘要
            updateAnalyticsSummary(year);
        }

        // 更新趨勢圖
        function updateTrendChart(year) {
            const monthlyData = {};
            
            // 初始化12個月的數據
            for (let i = 1; i <= 12; i++) {
                monthlyData[i] = { income: 0, expense: 0 };
            }

            // 計算每月收支
            transactions.forEach(transaction => {
                const date = new Date(transaction.date);
                if (date.getFullYear() == year) {
                    const month = date.getMonth() + 1;
                    if (transaction.type === '收入') {
                        monthlyData[month].income += parseFloat(transaction.amount);
                    } else {
                        monthlyData[month].expense += parseFloat(transaction.amount);
                    }
                }
            });

            const labels = [];
            const incomeData = [];
            const expenseData = [];

            for (let i = 1; i <= 12; i++) {
                labels.push(i + '月');
                incomeData.push(monthlyData[i].income);
                expenseData.push(monthlyData[i].expense);
            }

            if (charts.trendChart) {
                charts.trendChart.data.labels = labels;
                charts.trendChart.data.datasets[0].data = incomeData;
                charts.trendChart.data.datasets[1].data = expenseData;
                charts.trendChart.update();
            }
        }

        // 更新類別圖
        function updateCategoryChart(year) {
            const categoryData = {};

            transactions.forEach(transaction => {
                const date = new Date(transaction.date);
                if (date.getFullYear() == year && transaction.type === '支出') {
                    if (!categoryData[transaction.category]) {
                        categoryData[transaction.category] = 0;
                    }
                    categoryData[transaction.category] += parseFloat(transaction.amount);
                }
            });

            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);

            if (charts.categoryChart) {
                charts.categoryChart.data.labels = labels;
                charts.categoryChart.data.datasets[0].data = data;
                charts.categoryChart.update();
            }
        }

        // 更新月度對比圖
        function updateMonthlyChart(year) {
            const currentMonth = new Date().getMonth() + 1;
            const monthlyData = {};

            // 只顯示到當前月份
            for (let i = 1; i <= currentMonth; i++) {
                monthlyData[i] = { income: 0, expense: 0 };
            }

            transactions.forEach(transaction => {
                const date = new Date(transaction.date);
                if (date.getFullYear() == year) {
                    const month = date.getMonth() + 1;
                    if (month <= currentMonth) {
                        if (transaction.type === '收入') {
                            monthlyData[month].income += parseFloat(transaction.amount);
                        } else {
                            monthlyData[month].expense += parseFloat(transaction.amount);
                        }
                    }
                }
            });

            const labels = [];
            const incomeData = [];
            const expenseData = [];

            for (let i = 1; i <= currentMonth; i++) {
                labels.push(i + '月');
                incomeData.push(monthlyData[i].income);
                expenseData.push(monthlyData[i].expense);
            }

            if (charts.monthlyChart) {
                charts.monthlyChart.data.labels = labels;
                charts.monthlyChart.data.datasets[0].data = incomeData;
                charts.monthlyChart.data.datasets[1].data = expenseData;
                charts.monthlyChart.update();
            }
        }

        // 更新分析摘要
        function updateAnalyticsSummary(year) {
            const yearTransactions = transactions.filter(t => 
                new Date(t.date).getFullYear() == year
            );

            const totalIncome = yearTransactions
                .filter(t => t.type === '收入')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const totalExpense = yearTransactions
                .filter(t => t.type === '支出')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const netIncome = totalIncome - totalExpense;

            document.getElementById('yearlyIncome').textContent = '$' + totalIncome.toLocaleString();
            document.getElementById('yearlyExpense').textContent = '$' + totalExpense.toLocaleString();
            document.getElementById('netIncome').textContent = '$' + netIncome.toLocaleString();
            document.getElementById('netIncome').className = netIncome >= 0 ? 'text-success' : 'text-danger';
        }

        // 顯示進階搜尋
        function showAdvancedSearch() {
            const modal = new bootstrap.Modal(document.getElementById('advancedSearchModal'));
            
            // 更新類別選項
            const searchCategory = document.getElementById('searchCategory');
            searchCategory.innerHTML = '<option value="">所有類別</option>';
            
            const allCategories = [...new Set([...categories.收入, ...categories.支出])];
            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                searchCategory.appendChild(option);
            });

            modal.show();
        }

        // 執行進階搜尋
        function executeAdvancedSearch() {
            // 實作進階搜尋邏輯
            const searchParams = {
                startDate: document.getElementById('searchStartDate').value,
                endDate: document.getElementById('searchEndDate').value,
                type: document.getElementById('searchType').value,
                category: document.getElementById('searchCategory').value,
                minAmount: parseFloat(document.getElementById('searchMinAmount').value) || 0,
                maxAmount: parseFloat(document.getElementById('searchMaxAmount').value) || Infinity,
                counterparty: document.getElementById('searchCounterparty').value,
                account: document.getElementById('searchAccount').value,
                description: document.getElementById('searchDescription').value
            };

            // 應用搜尋條件到交易顯示
            applyAdvancedSearchFilters(searchParams);
            
            // 關閉模態框
            const modal = bootstrap.Modal.getInstance(document.getElementById('advancedSearchModal'));
            modal.hide();
        }

        // 應用進階搜尋篩選
        function applyAdvancedSearchFilters(params) {
            // 這裡可以實作更複雜的篩選邏輯
            // 暫時使用現有的顯示函數
            displayTransactions();
        }

        // 清除進階搜尋條件
        function clearAdvancedSearch() {
            document.getElementById('advancedSearchForm').reset();
        }

        // 生成報表
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            switch (reportType) {
                case 'financial':
                    generateFinancialReport(startDate, endDate);
                    break;
                case 'member':
                    generateMemberReport();
                    break;
                case 'dues':
                    generateDuesReport();
                    break;
                case 'activity':
                    generateActivityReport(startDate, endDate);
                    break;
            }
        }

        // 生成財務報表
        function generateFinancialReport(startDate, endDate) {
            const modal = new bootstrap.Modal(document.getElementById('reportModal'));
            const title = document.getElementById('reportModalTitle');
            const content = document.getElementById('reportModalContent');

            title.textContent = '財務報表';

            let filteredTransactions = transactions;
            if (startDate && endDate) {
                filteredTransactions = transactions.filter(t => 
                    t.date >= startDate && t.date <= endDate
                );
            }

            const totalIncome = filteredTransactions
                .filter(t => t.type === '收入')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const totalExpense = filteredTransactions
                .filter(t => t.type === '支出')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const incomeByCategory = {};
            const expenseByCategory = {};

            filteredTransactions.forEach(t => {
                if (t.type === '收入') {
                    incomeByCategory[t.category] = (incomeByCategory[t.category] || 0) + parseFloat(t.amount);
                } else {
                    expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + parseFloat(t.amount);
                }
            });

            content.innerHTML = `
                <div class="report-header text-center mb-4">
                    <h3>${settings.organizationName}</h3>
                    <h4>財務報表</h4>
                    ${startDate && endDate ? `<p>期間：${startDate} 至 ${endDate}</p>` : ''}
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <h5>收入明細</h5>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>類別</th>
                                    <th class="text-end">金額</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(incomeByCategory).map(([category, amount]) => `
                                    <tr>
                                        <td>${category}</td>
                                        <td class="text-end">$${amount.toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                                <tr class="table-success">
                                    <th>收入總計</th>
                                    <th class="text-end">$${totalIncome.toLocaleString()}</th>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>支出明細</h5>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>類別</th>
                                    <th class="text-end">金額</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(expenseByCategory).map(([category, amount]) => `
                                    <tr>
                                        <td>${category}</td>
                                        <td class="text-end">$${amount.toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                                <tr class="table-danger">
                                    <th>支出總計</th>
                                    <th class="text-end">$${totalExpense.toLocaleString()}</th>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5>財務摘要</h5>
                                <div class="row">
                                    <div class="col-4">
                                        <div class="text-success">
                                            <h4>$${totalIncome.toLocaleString()}</h4>
                                            <p>總收入</p>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-danger">
                                            <h4>$${totalExpense.toLocaleString()}</h4>
                                            <p>總支出</p>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="${totalIncome - totalExpense >= 0 ? 'text-success' : 'text-danger'}">
                                            <h4>$${(totalIncome - totalExpense).toLocaleString()}</h4>
                                            <p>淨收入</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            modal.show();
        }

        // 生成會員報表
        function generateMemberReport() {
            const modal = new bootstrap.Modal(document.getElementById('reportModal'));
            const title = document.getElementById('reportModalTitle');
            const content = document.getElementById('reportModalContent');

            title.textContent = '會員報表';

            const totalMembers = members.length;
            const activeMembers = members.filter(m => m.status === 'active').length;
            const inactiveMembers = members.filter(m => m.status === 'inactive').length;
            const pendingMembers = members.filter(m => m.status === 'pending').length;
            const overdueMembers = members.filter(m => isDuesOverdue(m)).length;

            const membersByType = {};
            members.forEach(m => {
                const type = getMemberTypeText(m.type);
                membersByType[type] = (membersByType[type] || 0) + 1;
            });

            content.innerHTML = `
                <div class="report-header text-center mb-4">
                    <h3>${settings.organizationName}</h3>
                    <h4>會員統計報表</h4>
                    <p>統計日期：${new Date().toLocaleDateString('zh-TW')}</p>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <h5>會員狀態統計</h5>
                        <table class="table table-striped">
                            <tr>
                                <td>正常會員</td>
                                <td class="text-end"><span class="badge bg-success">${activeMembers}</span></td>
                            </tr>
                            <tr>
                                <td>停權會員</td>
                                <td class="text-end"><span class="badge bg-danger">${inactiveMembers}</span></td>
                            </tr>
                            <tr>
                                <td>待審核會員</td>
                                <td class="text-end"><span class="badge bg-warning">${pendingMembers}</span></td>
                            </tr>
                            <tr>
                                <td>會費逾期</td>
                                <td class="text-end"><span class="badge bg-danger">${overdueMembers}</span></td>
                            </tr>
                            <tr class="table-primary">
                                <th>會員總數</th>
                                <th class="text-end">${totalMembers}</th>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>會員類型統計</h5>
                        <table class="table table-striped">
                            ${Object.entries(membersByType).map(([type, count]) => `
                                <tr>
                                    <td>${type}</td>
                                    <td class="text-end">${count}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                </div>
            `;

            modal.show();
        }

        // 顯示Toast通知
        function showToast(type, message) {
            const toastElement = document.getElementById(type + 'Toast');
            const toastBody = document.getElementById(type + 'ToastBody');
            
            toastBody.textContent = message;
            
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }

        // 匯出資料
        function exportData() {
            const wb = XLSX.utils.book_new();
            
            // 匯出交易記錄
            const transactionData = transactions.map(t => ({
                '日期': t.date,
                '類型': t.type,
                '類別': t.category,
                '金額': t.amount,
                '對象': t.counterparty || '',
                '帳戶': t.account || '',
                '說明': t.description || '',
                '收據編號': t.receiptNumber || ''
            }));
            
            const transactionWS = XLSX.utils.json_to_sheet(transactionData);
            XLSX.utils.book_append_sheet(wb, transactionWS, '交易記錄');
            
            // 匯出會員資料
            const memberData = members.map(m => ({
                '姓名': m.name,
                '電話': m.phone,
                '電子郵件': m.email || '',
                '加入日期': m.joinDate,
                '會員狀態': getStatusText(m.status),
                '會員類型': getMemberTypeText(m.type),
                '最後繳費日期': m.lastPaymentDate || '',
                '年費金額': m.membershipFee || 0
            }));
            
            const memberWS = XLSX.utils.json_to_sheet(memberData);
            XLSX.utils.book_append_sheet(wb, memberWS, '會員資料');
            
            // 下載檔案
            const fileName = `${settings.organizationName}_資料備份_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast('success', '資料匯出完成');
        }

        // 匯入資料
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // 處理匯入的資料
                        // 這裡可以添加更詳細的匯入邏輯
                        
                        showToast('success', '資料匯入完成');
                    } catch (error) {
                        showToast('error', '匯入失敗：' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            
            input.click();
        }

        // 系統設定
        function showSystemSettings() {
            const modal = new bootstrap.Modal(document.getElementById('systemSettingsModal'));
            
            // 載入現有設定
            document.getElementById('orgName').value = settings.organizationName;
            document.getElementById('orgAddress').value = settings.organizationAddress;
            document.getElementById('orgPhone').value = settings.organizationPhone;
            document.getElementById('orgEmail').value = settings.organizationEmail;
            document.getElementById('defaultMembershipFee').value = settings.defaultMembershipFee;
            document.getElementById('receiptPrefix').value = settings.receiptPrefix;
            document.getElementById('enableAutoBackup').checked = settings.enableAutoBackup;
            document.getElementById('enableNotifications').checked = settings.enableNotifications;
            
            modal.show();
        }

        // 儲存系統設定
        function saveSystemSettings() {
            settings.organizationName = document.getElementById('orgName').value;
            settings.organizationAddress = document.getElementById('orgAddress').value;
            settings.organizationPhone = document.getElementById('orgPhone').value;
            settings.organizationEmail = document.getElementById('orgEmail').value;
            settings.defaultMembershipFee = parseFloat(document.getElementById('defaultMembershipFee').value);
            settings.receiptPrefix = document.getElementById('receiptPrefix').value;
            settings.enableAutoBackup = document.getElementById('enableAutoBackup').checked;
            settings.enableNotifications = document.getElementById('enableNotifications').checked;
            
            saveSettings();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('systemSettingsModal'));
            modal.hide();
            
            showToast('success', '系統設定已儲存');
        }

        // 將函數綁定到全域範圍
        window.showSection = showSection;
        window.showTransactionModal = showTransactionModal;
        window.updateCategoryOptions = updateCategoryOptions;
        window.handleVoucherUpload = handleVoucherUpload;
        window.saveTransaction = saveTransaction;
        window.deleteTransaction = deleteTransaction;
        window.showMemberModal = showMemberModal;
        window.saveMember = saveMember;
        window.deleteMember = deleteMember;
        window.showMemberDetail = showMemberDetail;
        window.recordMembershipPayment = recordMembershipPayment;
        window.toggleSelectAll = toggleSelectAll;
        window.toggleSelectAllMembers = toggleSelectAllMembers;
        window.performBatchAction = performBatchAction;
        window.performMemberBatchAction = performMemberBatchAction;
        window.changePage = changePage;
        window.showAdvancedSearch = showAdvancedSearch;
        window.executeAdvancedSearch = executeAdvancedSearch;
        window.clearAdvancedSearch = clearAdvancedSearch;
        window.generateReport = generateReport;
        window.generateFinancialReport = generateFinancialReport;
        window.generateMemberReport = generateMemberReport;
        window.printReceipt = printReceipt;
        window.exportData = exportData;
        window.importData = importData;
        window.showSystemSettings = showSystemSettings;
        window.saveSystemSettings = saveSystemSettings;
        window.updateAnalytics = updateAnalytics;

        })();
        </script>

        <style>
        .member-avatar {
            width: 40px;
            height: 40px;
            background: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #6c757d;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-buttons .btn {
            padding: 0.25rem 0.5rem;
        }

        .voucher-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .voucher-preview-img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .voucher-preview-pdf {
            width: 100px;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 10px;
            padding: 5px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            margin: 2px 0;
            transition: all 0.3s ease;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .content-section {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 12px;
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .stats-card .card-body {
            padding: 1.5rem;
        }

        .table th {
            background: #f8f9fa;
            border-top: none;
            font-weight: 600;
        }

        .badge {
            font-size: 0.75em;
        }

        .btn {
            border-radius: 8px;
            font-weight: 500;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .modal-content {
            border-radius: 12px;
            border: none;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .pagination .page-link {
            border-radius: 8px;
            margin: 0 2px;
            border: none;
            color: #667eea;
        }

        .pagination .page-item.active .page-link {
            background: #667eea;
            border-color: #667eea;
        }

        @media print {
            .sidebar, .no-print {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0 !important;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
        }
        </style>
    </body>
    </html>
                
