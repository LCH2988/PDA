<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NGO 會計系統</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Chart.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/Chart.min.css">
  
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css">
  
  <style>
    :root {
      --primary-color: #2c5aa0;
      --secondary-color: #f8f9fa;
      --accent-color: #ffc107;
      --success-color: #198754;
      --danger-color: #dc3545;
      --text-color: #333;
      --light-text: #6c757d;
    }
    
    body {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      color: var(--text-color);
      background-color: #f5f7fa;
    }
    
    .sidebar {
      background-color: var(--primary-color);
      color: white;
      min-height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      width: 250px;
      z-index: 1000;
      transition: all 0.3s;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    
    .sidebar.collapsed {
      width: 70px;
    }
    
    .sidebar .nav-link {
      color: rgba(255, 255, 255, 0.8);
      padding: 0.75rem 1rem;
      margin: 0.2rem 0;
      border-radius: 0.25rem;
      transition: all 0.3s;
    }
    
    .sidebar .nav-link:hover {
      color: white;
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .sidebar .nav-link.active {
      color: white;
      background-color: rgba(255, 255, 255, 0.2);
      font-weight: bold;
    }
    
    .sidebar .nav-link i {
      margin-right: 0.75rem;
      width: 20px;
      text-align: center;
    }
    
    .sidebar.collapsed .nav-link span {
      display: none;
    }
    
    .sidebar.collapsed .nav-link i {
      margin-right: 0;
      font-size: 1.2rem;
    }
    
    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sidebar-footer {
      padding: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      position: absolute;
      bottom: 0;
      width: 100%;
    }
    
    .main-content {
      margin-left: 250px;
      padding: 1rem;
      transition: all 0.3s;
    }
    
    .main-content.expanded {
      margin-left: 70px;
    }
    
    .card {
      border: none;
      border-radius: 0.5rem;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      margin-bottom: 1.5rem;
    }
    
    .card-header {
      background-color: white;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      font-weight: 600;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .btn-primary:hover {
      background-color: #224785;
      border-color: #224785;
    }
    
    .stat-card {
      border-left: 4px solid var(--primary-color);
      background-color: white;
      padding: 1rem;
      border-radius: 0.25rem;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      margin-bottom: 1rem;
    }
    
    .stat-card .stat-title {
      color: var(--light-text);
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
    }
    
    .stat-card .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
    }
    
    .stat-card .stat-change {
      font-size: 0.75rem;
    }
    
    .stat-card .stat-icon {
      float: right;
      font-size: 2rem;
      opacity: 0.3;
    }
    
    .stat-card.income {
      border-left-color: var(--success-color);
    }
    
    .stat-card.expense {
      border-left-color: var(--danger-color);
    }
    
    .stat-card.balance {
      border-left-color: var(--accent-color);
    }
    
    .table-responsive {
      overflow-x: auto;
    }
    
    /* 表單樣式 */
    .form-label {
      font-weight: 500;
    }
    
    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(44, 90, 160, 0.25);
    }
    
    /* 載入中動畫 */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .spinner {
      width: 3rem;
      height: 3rem;
    }
    
    /* 提示訊息 */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1100;
    }
    
    /* 列印樣式 */
    @media print {
      .sidebar, .navbar, .no-print {
        display: none !important;
      }
      
      .main-content {
        margin-left: 0 !important;
        padding: 0 !important;
      }
      
      .card {
        box-shadow: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- 載入中動畫 -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary spinner" role="status">
      <span class="visually-hidden">載入中...</span>
    </div>
  </div>
  
  <!-- 提示訊息容器 -->
  <div class="toast-container"></div>
  
  <!-- 側邊欄 -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h5 class="mb-0 text-white" id="orgName">NGO 會計系統</h5>
      <button class="btn btn-sm btn-outline-light mt-2" id="toggleSidebar">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    
    <ul class="nav flex-column mt-3">
      <li class="nav-item">
        <a class="nav-link active" href="#dashboard">
          <i class="fas fa-tachometer-alt"></i>
          <span>儀表板</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#transactions">
          <i class="fas fa-exchange-alt"></i>
          <span>交易記錄</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#receipts">
          <i class="fas fa-receipt"></i>
          <span>收據管理</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#vouchers">
          <i class="fas fa-file-invoice-dollar"></i>
          <span>支出憑證</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#members">
          <i class="fas fa-users"></i>
          <span>人員管理</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#reports">
          <i class="fas fa-chart-bar"></i>
          <span>財務報表</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#settings">
          <i class="fas fa-cog"></i>
          <span>系統設定</span>
        </a>
      </li>
    </ul>
    
    <div class="sidebar-footer">
      <div class="d-flex align-items-center">
        <i class="fas fa-user-circle me-2"></i>
        <span id="userInfo">管理員</span>
      </div>
      <div class="mt-2 small" id="systemVersion">版本: 1.0.0</div>
    </div>
  </div>
  
  <!-- 主要內容區 -->
  <div class="main-content" id="mainContent">
    <!-- 頂部導航 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 rounded shadow-sm">
      <div class="container-fluid">
        <ol class="breadcrumb m-0">
          <li class="breadcrumb-item active" id="currentPage">儀表板</li>
        </ol>
        <div class="d-flex">
          <button class="btn btn-outline-secondary btn-sm me-2" id="refreshBtn">
            <i class="fas fa-sync-alt"></i> 重新整理
          </button>
          <div class="dropdown">
            <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="addNewBtn" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-plus"></i> 新增
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="addNewBtn">
              <li><a class="dropdown-item" href="#transactions/new">新增交易</a></li>
              <li><a class="dropdown-item" href="#receipts/new">開立收據</a></li>
              <li><a class="dropdown-item" href="#vouchers/new">申請支出憑證</a></li>
              <li><a class="dropdown-item" href="#members/new">新增會員</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>
    
    <!-- 頁面內容區 -->
    <div id="pageContent">
      <!-- 內容將由 JavaScript 動態載入 -->
    </div>
  </div>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  
  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
  
  <!-- 主要 JavaScript -->
  <script>
    // 全域變數
    const API_URL = 'https://script.google.com/macros/s/AKfycbxHo5NJ7vw5txM2_KslwYfp4ulp43cTwtC-xGwzBSroGMD5HOGIQdHnAmPCJ1gVJwOI/exec';
    let systemSettings = {};
    let currentPage = 'dashboard';
    
    // 頁面載入完成後執行
    $(document).ready(function() {
      // 初始化系統
      initializeSystem();
      
      // 註冊事件處理
      registerEventHandlers();
      
      // 處理路由
      handleRouting();
      
      // 隱藏載入中動畫
      hideLoading();
    });
    
    // 初始化系統
    function initializeSystem() {
      // 取得系統設定
      apiRequest('getSystemSettings', {})
        .then(response => {
          if (response.success) {
            systemSettings = response.data;
            updateUIWithSettings();
          } else {
            showToast('錯誤', '無法載入系統設定: ' + response.error, 'danger');
          }
        })
        .catch(error => {
          console.error('載入系統設定失敗:', error);
          showToast('錯誤', '載入系統設定失敗，請檢查網路連線', 'danger');
        });
    }
    
    // 更新 UI 以反映系統設定
    function updateUIWithSettings() {
      // 更新組織名稱
      $('#orgName').text(systemSettings.organization_name || 'NGO 會計系統');
      
      // 更新系統版本
      $('#systemVersion').text('版本: ' + (systemSettings.system_version || '1.0.0'));
      
      // 更新頁面標題
      document.title = (systemSettings.organization_name || 'NGO') + ' 會計系統';
    }
    
    // 註冊事件處理
    function registerEventHandlers() {
      // 側邊欄切換
      $('#toggleSidebar').click(function() {
        $('#sidebar').toggleClass('collapsed');
        $('#mainContent').toggleClass('expanded');
      });
      
      // 導航連結點擊
      $('.sidebar .nav-link').click(function() {
        $('.sidebar .nav-link').removeClass('active');
        $(this).addClass('active');
        
        // 更新麵包屑
        $('#currentPage').text($(this).find('span').text());
      });
      
      // 重新整理按鈕
      $('#refreshBtn').click(function() {
        loadCurrentPage();
      });
      
      // 監聽 URL 變化
      $(window).on('hashchange', function() {
        handleRouting();
      });
    }
    
    // 處理路由
    function handleRouting() {
      const hash = window.location.hash || '#dashboard';
      const route = hash.split('/');
      
      currentPage = route[0].substring(1);
      
      // 更新活動導航項目
      $('.sidebar .nav-link').removeClass('active');
      $(`.sidebar .nav-link[href^="${route[0]}"]`).addClass('active');
      
      // 更新麵包屑
      $('#currentPage').text($(`.sidebar .nav-link[href^="${route[0]}"]`).find('span').text());
      
      // 載入頁面內容
      loadPage(currentPage, route);
    }
    
    // 載入當前頁面
    function loadCurrentPage() {
      const hash = window.location.hash || '#dashboard';
      const route = hash.split('/');
      
      loadPage(currentPage, route);
    }
    
    // 載入頁面
    function loadPage(page, route) {
      showLoading();
      
      switch (page) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'transactions':
          if (route[1] === 'new') {
            loadTransactionForm();
          } else if (route[1] === 'edit' && route[2]) {
            loadTransactionForm(route[2]);
          } else {
            loadTransactions();
          }
          break;
        case 'receipts':
          if (route[1] === 'new') {
            loadReceiptForm();
          } else if (route[1] === 'view' && route[2]) {
            loadReceiptDetails(route[2]);
          } else {
            loadReceipts();
          }
          break;
        case 'vouchers':
          if (route[1] === 'new') {
            loadVoucherForm();
          } else if (route[1] === 'view' && route[2]) {
            loadVoucherDetails(route[2]);
          } else {
            loadVouchers();
          }
          break;
        case 'members':
          if (route[1] === 'new') {
            loadMemberForm();
          } else if (route[1] === 'edit' && route[2]) {
            loadMemberForm(route[2]);
          } else {
            loadMembers();
          }
          break;
        case 'reports':
          loadReports();
          break;
        case 'settings':
          loadSettings();
          break;
        default:
          loadDashboard();
          break;
      }
    }
    
    // 載入儀表板
    function loadDashboard() {
      apiRequest('getDashboardData', {})
        .then(response => {
          if (response.success) {
            renderDashboard(response.data);
          } else {
            showToast('錯誤', '無法載入儀表板資料: ' + response.error, 'danger');
            $('#pageContent').html('<div class="alert alert-danger">載入儀表板資料失敗</div>');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('載入儀表板失敗:', error);
          showToast('錯誤', '載入儀表板失敗，請檢查網路連線', 'danger');
          $('#pageContent').html('<div class="alert alert-danger">載入儀表板失敗，請檢查網路連線</div>');
          hideLoading();
        });
    }
    
    // 渲染儀表板
    function renderDashboard(data) {
      const html = `
        <div class="row">
          <!-- 財務摘要 -->
          <div class="col-md-4">
            <div class="stat-card income">
              <div class="stat-title">本月收入</div>
              <div class="stat-value">NT$ ${formatNumber(data.summary.monthlyIncome)}</div>
              <div class="stat-icon"><i class="fas fa-arrow-down"></i></div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card expense">
              <div class="stat-title">本月支出</div>
              <div class="stat-value">NT$ ${formatNumber(data.summary.monthlyExpense)}</div>
              <div class="stat-icon"><i class="fas fa-arrow-up"></i></div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card balance">
              <div class="stat-title">本月餘額</div>
              <div class="stat-value">NT$ ${formatNumber(data.summary.monthlyBalance)}</div>
              <div class="stat-icon"><i class="fas fa-balance-scale"></i></div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="stat-card income">
              <div class="stat-title">本年度收入</div>
              <div class="stat-value">NT$ ${formatNumber(data.summary.yearlyIncome)}</div>
              <div class="stat-icon"><i class="fas fa-arrow-down"></i></div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card expense">
              <div class="stat-title">本年度支出</div>
              <div class="stat-value">NT$ ${formatNumber(data.summary.yearlyExpense)}</div>
              <div class="stat-icon"><i class="fas fa-arrow-up"></i></div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card balance">
              <div class="stat-title">本年度餘額</div>
              <div class="stat-value">NT$ ${formatNumber(data.summary.yearlyBalance)}</div>
              <div class="stat-icon"><i class="fas fa-balance-scale"></i></div>
            </div>
          </div>
          
          <!-- 圖表 -->
          <div class="col-md-8">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>月度收支趨勢</span>
                <div class="btn-group btn-group-sm">
                  <button type="button" class="btn btn-outline-secondary active" id="btnThisYear">本年度</button>
                  <button type="button" class="btn btn-outline-secondary" id="btnLastYear">去年</button>
                </div>
              </div>
              <div class="card-body">
                <canvas id="monthlyChart" height="300"></canvas>
              </div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>收入類別分佈</span>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="incomeChartDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    本年度
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="incomeChartDropdown">
                    <li><a class="dropdown-item" href="#">本年度</a></li>
                    <li><a class="dropdown-item" href="#">去年</a></li>
                    <li><a class="dropdown-item" href="#">全部</a></li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <canvas id="incomePieChart" height="260"></canvas>
              </div>
            </div>
          </div>
          
          <!-- 最近交易 -->
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                最近交易記錄
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>日期</th>
                        <th>名稱</th>
                        <th>類型</th>
                        <th>金額</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data.recentTransactions.map(t => `
                        <tr>
                          <td>${formatDate(t.date)}</td>
                          <td>${t.name}</td>
                          <td>
                            <span class="badge ${t.type === '收入' ? 'bg-success' : 'bg-danger'}">
                              ${t.type}
                            </span>
                          </td>
                          <td class="text-end">NT$ ${formatNumber(t.amount)}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
                <div class="text-center py-2">
                  <a href="#transactions" class="btn btn-sm btn-outline-primary">查看全部</a>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 最近收據 -->
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                最近收據記錄
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>收據編號</th>
                        <th>付款人</th>
                        <th>金額</th>
                        <th>狀態</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data.recentReceipts.map(r => `
                        <tr>
                          <td>${r.receiptNumber}</td>
                          <td>${r.payer}</td>
                          <td class="text-end">NT$ ${formatNumber(r.amount)}</td>
                          <td>
                            <span class="badge ${r.emailStatus === '已寄送' ? 'bg-success' : 'bg-warning text-dark'}">
                              ${r.emailStatus}
                            </span>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
                <div class="text-center py-2">
                  <a href="#receipts" class="btn btn-sm btn-outline-primary">查看全部</a>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 會員統計 -->
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                會員統計
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-6">
                    <div class="text-center mb-3">
                      <div class="fs-1 fw-bold text-primary">${data.memberStats.total}</div>
                      <div>總會員數</div>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="text-center mb-3">
                      <div class="fs-1 fw-bold text-success">${data.memberStats.active}</div>
                      <div>正式會員</div>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="text-center">
                      <div class="fs-1 fw-bold text-info">${data.memberStats.associate}</div>
                      <div>贊助會員</div>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="text-center">
                      <div class="fs-1 fw-bold text-warning">${data.memberStats.volunteer}</div>
                      <div>志工</div>
                    </div>
                  </div>
                </div>
                <div class="text-center mt-3">
                  <a href="#members" class="btn btn-sm btn-outline-primary">管理會員</a>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 收據統計 -->
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                收據統計
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-6">
                    <div class="text-center mb-3">
                      <div class="fs-1 fw-bold text-primary">${data.receiptStats.total}</div>
                      <div>總收據數</div>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="text-center mb-3">
                      <div class="fs-1 fw-bold text-success">${data.receiptStats.sent}</div>
                      <div>已寄送</div>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="text-center">
                      <div class="fs-1 fw-bold text-warning">${data.receiptStats.pending}</div>
                      <div>待寄送</div>
                    </div>
                  </div>
                </div>
                <div class="text-center mt-3">
                  <a href="#receipts" class="btn btn-sm btn-outline-primary">管理收據</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      $('#pageContent').html(html);
      
      // 初始化圖表
      initializeMonthlyChart(data.monthlyData);
      initializeIncomePieChart(data.incomeByCategory);
    }
    
    // 初始化月度收支圖表
    function initializeMonthlyChart(monthlyData) {
    // 初始化月度收支圖表（續）
      const months = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
      const incomeData = monthlyData.map(item => item.income);
      const expenseData = monthlyData.map(item => item.expense);
      
      const ctx = document.getElementById('monthlyChart').getContext('2d');
      const monthlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [
            {
              label: '收入',
              data: incomeData,
              backgroundColor: 'rgba(25, 135, 84, 0.6)',
              borderColor: 'rgba(25, 135, 84, 1)',
              borderWidth: 1
            },
            {
              label: '支出',
              data: expenseData,
              backgroundColor: 'rgba(220, 53, 69, 0.6)',
              borderColor: 'rgba(220, 53, 69, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': NT$ ' + formatNumber(context.raw);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'NT$ ' + formatNumber(value);
                }
              }
            }
          }
        }
      });
      
      // 年份切換按鈕事件
      $('#btnThisYear, #btnLastYear').click(function() {
        $('#btnThisYear, #btnLastYear').removeClass('active');
        $(this).addClass('active');
        
        // 在實際應用中，這裡應該重新請求對應年份的資料
        // 這裡僅作示範，實際上應該調用 API 取得不同年份的資料
        if ($(this).attr('id') === 'btnLastYear') {
          // 假設去年資料是今年的 80%
          monthlyChart.data.datasets[0].data = incomeData.map(v => v * 0.8);
          monthlyChart.data.datasets[1].data = expenseData.map(v => v * 0.8);
        } else {
          monthlyChart.data.datasets[0].data = incomeData;
          monthlyChart.data.datasets[1].data = expenseData;
        }
        
        monthlyChart.update();
      });
    }
    
    // 初始化收入類別圓餅圖
    function initializeIncomePieChart(incomeByCategory) {
      const labels = incomeByCategory.map(item => item.category);
      const data = incomeByCategory.map(item => item.amount);
      
      // 生成顏色
      const backgroundColors = [
        'rgba(25, 135, 84, 0.7)',
        'rgba(13, 110, 253, 0.7)',
        'rgba(255, 193, 7, 0.7)',
        'rgba(111, 66, 193, 0.7)',
        'rgba(23, 162, 184, 0.7)',
        'rgba(102, 16, 242, 0.7)',
        'rgba(253, 126, 20, 0.7)',
        'rgba(32, 201, 151, 0.7)'
      ];
      
      const ctx = document.getElementById('incomePieChart').getContext('2d');
      const incomePieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [
            {
              data: data,
              backgroundColor: backgroundColors.slice(0, data.length),
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 12
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return context.label + ': NT$ ' + formatNumber(value) + ' (' + percentage + '%)';
                }
              }
            }
          }
        }
      });
    }
    
    // 載入交易記錄
    function loadTransactions() {
      apiRequest('getTransactions', { page: 1, limit: 50 })
        .then(response => {
          if (response.success) {
            renderTransactions(response.data);
          } else {
            showToast('錯誤', '無法載入交易記錄: ' + response.error, 'danger');
            $('#pageContent').html('<div class="alert alert-danger">載入交易記錄失敗</div>');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('載入交易記錄失敗:', error);
          showToast('錯誤', '載入交易記錄失敗，請檢查網路連線', 'danger');
          $('#pageContent').html('<div class="alert alert-danger">載入交易記錄失敗，請檢查網路連線</div>');
          hideLoading();
        });
    }
    
    // 渲染交易記錄
    function renderTransactions(data) {
      const html = `
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>交易記錄</span>
            <a href="#transactions/new" class="btn btn-primary btn-sm">
              <i class="fas fa-plus"></i> 新增交易
            </a>
          </div>
          <div class="card-body">
            <!-- 篩選工具 -->
            <div class="row mb-3">
              <div class="col-md-3">
                <select class="form-select form-select-sm" id="typeFilter">
                  <option value="">所有類型</option>
                  <option value="收入">收入</option>
                  <option value="支出">支出</option>
                </select>
              </div>
              <div class="col-md-3">
                <input type="date" class="form-control form-control-sm" id="dateFromFilter" placeholder="起始日期">
              </div>
              <div class="col-md-3">
                <input type="date" class="form-control form-control-sm" id="dateToFilter" placeholder="結束日期">
              </div>
              <div class="col-md-3">
                <div class="input-group input-group-sm">
                  <input type="text" class="form-control" id="searchFilter" placeholder="搜尋...">
                  <button class="btn btn-outline-secondary" type="button" id="btnSearch">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- 交易表格 -->
            <div class="table-responsive">
              <table class="table table-hover table-striped" id="transactionsTable">
                <thead>
                  <tr>
                    <th>日期</th>
                    <th>名稱</th>
                    <th>類型</th>
                    <th>類別</th>
                    <th>收款人/付款人</th>
                    <th>金額</th>
                    <th>說明</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.transactions.map(t => `
                    <tr>
                      <td>${formatDate(t.日期)}</td>
                      <td>${t.名稱}</td>
                      <td>
                        <span class="badge ${t.類型 === '收入' ? 'bg-success' : 'bg-danger'}">
                          ${t.類型}
                        </span>
                      </td>
                      <td>${t.類別}</td>
                      <td>${t['收款人/付款人']}</td>
                      <td class="text-end">NT$ ${formatNumber(t.金額)}</td>
                      <td>${t.說明 || ''}</td>
                      <td>
                        <span class="badge ${t.狀態 === '已確認' ? 'bg-success' : t.狀態 === '待確認' ? 'bg-warning text-dark' : 'bg-danger'}">
                          ${t.狀態}
                        </span>
                      </td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <a href="#transactions/edit/${t.id}" class="btn btn-outline-primary">
                            <i class="fas fa-edit"></i>
                          </a>
                          <button type="button" class="btn btn-outline-danger" onclick="deleteTransactionConfirm(${t.id})">
                            <i class="fas fa-trash-alt"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <!-- 分頁 -->
            <nav aria-label="Page navigation" class="mt-3">
              <ul class="pagination justify-content-center">
                <li class="page-item ${data.pagination.page <= 1 ? 'disabled' : ''}">
                  <a class="page-link" href="#" onclick="changePage(${data.pagination.page - 1})">上一頁</a>
                </li>
                ${generatePaginationItems(data.pagination.page, data.pagination.totalPages)}
                <li class="page-item ${data.pagination.page >= data.pagination.totalPages ? 'disabled' : ''}">
                  <a class="page-link" href="#" onclick="changePage(${data.pagination.page + 1})">下一頁</a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      `;
      
      $('#pageContent').html(html);
      
      // 初始化 DataTables
      $('#transactionsTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/zh-HANT.json'
        },
        paging: false,
        searching: false,
        info: false
      });
      
      // 綁定篩選事件
      $('#btnSearch').click(function() {
        filterTransactions();
      });
      
      $('#typeFilter, #dateFromFilter, #dateToFilter').change(function() {
        filterTransactions();
      });
      
      $('#searchFilter').keypress(function(e) {
        if (e.which === 13) {
          filterTransactions();
        }
      });
    }
    
    // 篩選交易記錄
    function filterTransactions() {
      const type = $('#typeFilter').val();
      const dateFrom = $('#dateFromFilter').val();
      const dateTo = $('#dateToFilter').val();
      const search = $('#searchFilter').val();
      
      showLoading();
      
      apiRequest('getTransactions', { 
        page: 1, 
        limit: 50,
        type,
        dateFrom,
        dateTo,
        search
      })
        .then(response => {
          if (response.success) {
            renderTransactions(response.data);
          } else {
            showToast('錯誤', '篩選交易記錄失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('篩選交易記錄失敗:', error);
          showToast('錯誤', '篩選交易記錄失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 切換分頁
    function changePage(page) {
      const type = $('#typeFilter').val();
      const dateFrom = $('#dateFromFilter').val();
      const dateTo = $('#dateToFilter').val();
      const search = $('#searchFilter').val();
      
      showLoading();
      
      apiRequest('getTransactions', { 
        page, 
        limit: 50,
        type,
        dateFrom,
        dateTo,
        search
      })
        .then(response => {
          if (response.success) {
            renderTransactions(response.data);
          } else {
            showToast('錯誤', '載入交易記錄失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('載入交易記錄失敗:', error);
          showToast('錯誤', '載入交易記錄失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 生成分頁項目
    function generatePaginationItems(currentPage, totalPages) {
      let items = '';
      
      // 限制顯示的頁數
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      // 第一頁
      if (startPage > 1) {
        items += `
          <li class="page-item">
            <a class="page-link" href="#" onclick="changePage(1)">1</a>
          </li>
        `;
        
        if (startPage > 2) {
          items += `
            <li class="page-item disabled">
              <a class="page-link" href="#">...</a>
            </li>
          `;
        }
      }
      
      // 頁碼
      for (let i = startPage; i <= endPage; i++) {
        items += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
          </li>
        `;
      }
      
      // 最後一頁
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          items += `
            <li class="page-item disabled">
              <a class="page-link" href="#">...</a>
            </li>
          `;
        }
        
        items += `
          <li class="page-item">
            <a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a>
          </li>
        `;
      }
      
      return items;
    }
    
    // 載入交易表單
    function loadTransactionForm(id = null) {
      let formTitle = '新增交易';
      let formData = {
        date: formatDateForInput(new Date()),
        type: '收入',
        status: '已確認'
      };
      
      if (id) {
        formTitle = '編輯交易';
        showLoading();
        
        // 在實際應用中，應該從 API 獲取交易詳情
        // 這裡僅作示範
        setTimeout(() => {
          formData = {
            id: id,
            date: '2023-06-15',
            name: '會員費',
            type: '收入',
            category: '會費',
            payee: '王小明',
            amount: 1000,
            description: '2023年度會費',
            receiptNumber: 'R-20230615-001',
            status: '已確認'
          };
          
          renderTransactionForm(formTitle, formData);
          hideLoading();
        }, 500);
      } else {
        renderTransactionForm(formTitle, formData);
      }
    }
    
    // 渲染交易表單
    function renderTransactionForm(title, data) {
      const html = `
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">${title}</h5>
          </div>
          <div class="card-body">
            <form id="transactionForm">
              ${data.id ? `<input type="hidden" name="id" value="${data.id}">` : ''}
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="date" class="form-label">日期 <span class="text-danger">*</span></label>
                  <input type="date" class="form-control" id="date" name="date" required value="${data.date || ''}">
                </div>
                <div class="col-md-6">
                  <label for="type" class="form-label">類型 <span class="text-danger">*</span></label>
                  <select class="form-select" id="type" name="type" required>
                    <option value="收入" ${data.type === '收入' ? 'selected' : ''}>收入</option>
                    <option value="支出" ${data.type === '支出' ? 'selected' : ''}>支出</option>
                  </select>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="name" class="form-label">名稱 <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="name" name="name" required value="${data.name || ''}">
                </div>
                <div class="col-md-6">
                  <label for="category" class="form-label">類別 <span class="text-danger">*</span></label>
                  <select class="form-select" id="category" name="category" required>
                    <option value="" disabled selected>請選擇類別</option>
                    <optgroup label="收入類別" id="incomeCategories">
                      <option value="會費" ${data.category === '會費' ? 'selected' : ''}>會費</option>
                      <option value="捐款" ${data.category === '捐款' ? 'selected' : ''}>捐款</option>
                      <option value="活動收入" ${data.category === '活動收入' ? 'selected' : ''}>活動收入</option>
                      <option value="專案收入" ${data.category === '專案收入' ? 'selected' : ''}>專案收入</option>
                      <option value="利息收入" ${data.category === '利息收入' ? 'selected' : ''}>利息收入</option>
                      <option value="其他收入" ${data.category === '其他收入' ? 'selected' : ''}>其他收入</option>
                    </optgroup>
                    <optgroup label="支出類別" id="expenseCategories">
                      <option value="行政費用" ${data.category === '行政費用' ? 'selected' : ''}>行政費用</option>
                      <option value="活動費用" ${data.category === '活動費用' ? 'selected' : ''}>活動費用</option>
                      <option value="專案費用" ${data.category === '專案費用' ? 'selected' : ''}>專案費用</option>
                      <option value="人事費用" ${data.category === '人事費用' ? 'selected' : ''}>人事費用</option>
                      <option value="設備費用" ${data.category === '設備費用' ? 'selected' : ''}>設備費用</option>
                      <option value="其他費用" ${data.category === '其他費用' ? 'selected' : ''}>其他費用</option>
                    </optgroup>
                  </select>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="payee" class="form-label">收款人/付款人</label>
                  <input type="text" class="form-control" id="payee" name="payee" value="${data.payee || ''}">
                </div>
                <div class="col-md-6">
                  <label for="amount" class="form-label">金額 <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <span class="input-group-text">NT$</span>
                    <input type="number" class="form-control" id="amount" name="amount" min="0" step="1" required value="${data.amount || ''}">
                  </div>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="receiptNumber" class="form-label">收據編號</label>
                  <input type="text" class="form-control" id="receiptNumber" name="receiptNumber" value="${data.receiptNumber || ''}">
                </div>
                <div class="col-md-6">
                  <label for="status" class="form-label">狀態 <span class="text-danger">*</span></label>
                  <select class="form-select" id="status" name="status" required>
                    <option value="已確認" ${data.status === '已確認' ? 'selected' : ''}>已確認</option>
                    <option value="待確認" ${data.status === '待確認' ? 'selected' : ''}>待確認</option>
                    <option value="已取消" ${data.status === '已取消' ? 'selected' : ''}>已取消</option>
                  </select>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="description" class="form-label">說明</label>
                <textarea class="form-control" id="description" name="description" rows="3">${data.description || ''}</textarea>
              </div>
              
              <div class="d-flex justify-content-between">
                <a href="#transactions" class="btn btn-outline-secondary">取消</a>
                <button type="submit" class="btn btn-primary">儲存</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      $('#pageContent').html(html);
      
      // 根據類型顯示對應的類別
      $('#type').change(function() {
        const type = $(this).val();
        if (type === '收入') {
          $('#incomeCategories').show();
          $('#expenseCategories').hide();
        } else {
          $('#incomeCategories').hide();
          $('#expenseCategories').show();
        }
      }).trigger('change');
      
      // 表單提交處理
      $('#transactionForm').submit(function(e) {
        e.preventDefault();
        
        const formData = {
          id: $('input[name="id"]').val(),
          date: $('#date').val(),
          name: $('#name').val(),
          type: $('#type').val(),
          category: $('#category').val(),
          payee: $('#payee').val(),
          amount: parseFloat($('#amount').val()),
          receiptNumber: $('#receiptNumber').val(),
          description: $('#description').val(),
          status: $('#status').val()
        };
        
        showLoading();
        
        // 根據是否有 ID 決定是新增還是更新
        const action = formData.id ? 'updateTransaction' : 'addTransaction';
        
        apiRequest(action, { data: formData })
          .then(response => {
            if (response.success) {
              showToast('成功', '交易記錄已儲存', 'success');
              window.location.hash = '#transactions';
            } else {
              showToast('錯誤', '儲存交易記錄失敗: ' + response.error, 'danger');
            }
            hideLoading();
          })
          .catch(error => {
            console.error('儲存交易記錄失敗:', error);
            showToast('錯誤', '儲存交易記錄失敗，請檢查網路連線', 'danger');
            hideLoading();
          });
      });
    }
    
    // 確認刪除交易
    function deleteTransactionConfirm(id) {
      if (confirm('確定要刪除這筆交易記錄嗎？此操作無法復原。')) {
        deleteTransaction(id);
      }
    }
    
    // 刪除交易
    function deleteTransaction(id) {
      showLoading();
      
      apiRequest('deleteTransaction', { data: { id } })
        .then(response => {
          if (response.success) {
            showToast('成功', '交易記錄已刪除', 'success');
            loadTransactions();
          } else {
            showToast('錯誤', '刪除交易記錄失敗: ' + response.error, 'danger');
            hideLoading();
          }
        })
        .catch(error => {
          console.error('刪除交易記錄失敗:', error);
          showToast('錯誤', '刪除交易記錄失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 載入收據管理
    function loadReceipts() {
      apiRequest('getReceipts', { page: 1, limit: 50 })
        .then(response => {
          if (response.success) {
            renderReceipts(response.data);
          } else {
            showToast('錯誤', '無法載入收據記錄: ' + response.error, 'danger');
            $('#pageContent').html('<div class="alert alert-danger">載入收據記錄失敗</div>');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('載入收據記錄失敗:', error);
          showToast('錯誤', '載入收據記錄失敗，請檢查網路連線', 'danger');
          $('#pageContent').html('<div class="alert alert-danger">載入收據記錄失敗，請檢查網路連線</div>');
          hideLoading();
        });
    }
    
    // 渲染收據列表
    function renderReceipts(data) {
      const html = `
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>收據管理</span>
            <a href="#receipts/new" class="btn btn-primary btn-sm">
              <i class="fas fa-plus"></i> 開立收據
            </a>
          </div>
          <div class="card-body">
            <!-- 篩選工具 -->
            <div class="row mb-3">
              <div class="col-md-3">
                <select class="form-select form-select-sm" id="statusFilter">
                  <option value="">所有狀態</option>
                  <option value="已開立">已開立</option>
                  <option value="已作廢">已作廢</option>
                  <option value="草稿">草稿</option>
                </select>
              </div>
              <div class="col-md-3">
                <select class="form-select form-select-sm" id="categoryFilter">
                  <option value="">所有類別</option>
                  <option value="會費">會費</option>
                  <option value="捐款">捐款</option>
                  <option value="活動收入">活動收入</option>
                  <option value="專案收入">專案收入</option>
                  <option value="其他收入">其他收入</option>
                </select>
              </div>
              <div class="col-md-6">
                <div class="input-group input-group-sm">
                  <input type="text" class="form-control" id="searchFilter" placeholder="搜尋收據編號、付款人...">
                  <button class="btn btn-outline-secondary" type="button" id="btnSearch">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- 收據表格 -->
            <div class="table-responsive">
              <table class="table table-hover table-striped" id="receiptsTable">
                <thead>
                  <tr>
                    <th>收據編號</th>
                    <th>日期</th>
                    <th>付款人</th>
                    <th>收款項目</th>
                    <th>金額</th>
                    <th>狀態</th>
                    <th>郵件狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.receipts.map(r => `
                    <tr>
                      <td>${r.收據編號}</td>
                      <td>${formatDate(r.日期)}</td>
                      <td>${r.付款人}</td>
                      <td>${r.收款項目}</td>
                      <td class="text-end">NT$ ${formatNumber(r.金額)}</td>
                      <td>
                        <span class="badge ${r.狀態 === '已開立' ? 'bg-success' : r.狀態 === '草稿' ? 'bg-warning text-dark' : 'bg-danger'}">
                          ${r.狀態}
                        </span>
                      </td>
                      <td>
                        <span class="badge ${r.郵件狀態 === '已寄送' ? 'bg-success' : r.郵件狀態 === '不需寄送' ? 'bg-secondary' : r.郵件狀態 === '寄送失敗' ? 'bg-danger' : 'bg-warning text-dark'}">
                          ${r.郵件狀態}
                        </span>
                      </td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <a href="#receipts/view/${r.收據編號}" class="btn btn-outline-primary">
                            <i class="fas fa-eye"></i>
                          </a>
                          <button type="button" class="btn btn-outline-success" onclick="sendReceiptEmail('${r.收據編號}')">
                            <i class="fas fa-envelope"></i>
                          </button>
                          <button type="button" class="btn btn-outline-secondary" onclick="downloadReceipt('${r.收據編號}')">
                            <i class="fas fa-download"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <!-- 分頁 -->
            <nav aria-label="Page navigation" class="mt-3">
              <ul class="pagination justify-content-center">
                <li class="page-item ${data.pagination.page <= 1 ? 'disabled' : ''}">
                  <a class="page-link" href="#" onclick="changeReceiptsPage(${data.pagination.page - 1})">上一頁</a>
                </li>
                ${generatePaginationItems(data.pagination.page, data.pagination.totalPages)}
                <li class="page-item ${data.pagination.page >= data.pagination.totalPages ? 'disabled' : ''}">
                  <a class="page-link" href="#" onclick="changeReceiptsPage(${data.pagination.page + 1})">下一頁</a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      `;
      
      $('#pageContent').html(html);
      
      // 初始化 DataTables
      $('#receiptsTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/zh-HANT.json'
        },
        paging: false,
        searching: false,
        info: false
      });
      
      // 綁定篩選事件
      $('#btnSearch').click(function() {
        filterReceipts();
      });
      
      $('#statusFilter, #categoryFilter').change(function() {
        filterReceipts();
      });
      
      $('#searchFilter').keypress(function(e) {
        if (e.which === 13) {
          filterReceipts();
        }
      });
    }
    
    // 篩選收據
    function filterReceipts() {
      const status = $('#statusFilter').val();
      const category = $('#categoryFilter').val();
      const search = $('#searchFilter').val();
      
      showLoading();
      
      apiRequest('getReceipts', { 
        page: 1, 
        limit: 50,
        status,
        category,
        search
      })
        .then(response => {
          if (response.success) {
            renderReceipts(response.data);
          } else {
            showToast('錯誤', '篩選收據記錄失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('篩選收據記錄失敗:', error);
          showToast('錯誤', '篩選收據記錄失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 切換收據分頁
    function changeReceiptsPage(page) {
      const status = $('#statusFilter').val();
      const category = $('#categoryFilter').val();
      const search = $('#searchFilter').val();
      
      showLoading();
      
      apiRequest('getReceipts', { 
        page, 
        limit: 50,
        status,
        category,
        search
      })
        .then(response => {
          if (response.success) {
            renderReceipts(response.data);
          } else {
            showToast('錯誤', '載入收據記錄失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('載入收據記錄失敗:', error);
          showToast('錯誤', '載入收據記錄失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 發送收據電子郵件
    function sendReceiptEmail(receiptNumber) {
      showLoading();
      
      apiRequest('getReceiptDetails', { receiptNumber })
        .then(response => {
          if (response.success) {
            const receipt = response.data;
            
            if (!receipt.電子郵件) {
              showToast('警告', '此收據沒有電子郵件地址，無法寄送', 'warning');
              hideLoading();
              return;
            }
            
            // 確認是否發送
            if (confirm(`確定要發送收據至 ${receipt.電子郵件} 嗎？`)) {
              apiRequest('sendReceiptByEmail', { 
                receiptNumber,
                email: receipt.電子郵件,
                subject: `${systemSettings.organization_name || 'NGO'} 收據 ${receiptNumber}`
              })
                .then(sendResponse => {
                  if (sendResponse.success) {
                    showToast('成功', '收據已發送至指定郵箱', 'success');
                    loadReceipts();
                  } else {
                    showToast('錯誤', '發送收據失敗: ' + sendResponse.error, 'danger');
                    hideLoading();
                  }
                })
                .catch(error => {
                  console.error('發送收據失敗:', error);
                  showToast('錯誤', '發送收據失敗，請檢查網路連線', 'danger');
                  hideLoading();
                });
            } else {
              hideLoading();
            }
          } else {
            showToast('錯誤', '獲取收據詳情失敗: ' + response.error, 'danger');
            hideLoading();
          }
        })
        .catch(error => {
          console.error('獲取收據詳情失敗:', error);
          showToast('錯誤', '獲取收據詳情失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 下載收據 PDF
    function downloadReceipt(receiptNumber) {
      showLoading();
      
      apiRequest('getReceiptDetails', { receiptNumber })
        .then(response => {
          if (response.success && response.data.PDF文件ID) {
            // 在新視窗中開啟 Google Drive 檔案
            const fileId = response.data.PDF文件ID;
            window.open(`https://drive.google.com/file/d/${fileId}/view`, '_blank');
            hideLoading();
          } else {
            showToast('錯誤', '無法下載收據: PDF 檔案不存在', 'danger');
            hideLoading();
          }
        })
        .catch(error => {
          console.error('下載收據失敗:', error);
          showToast('錯誤', '下載收據失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 載入收據詳情
    function loadReceiptDetails(receiptNumber) {
      showLoading();
      
      apiRequest('getReceiptDetails', { receiptNumber })
        .then(response => {
          if (response.success) {
            renderReceiptDetails(response.data);
          } else {
            showToast('錯誤', '無法載入收據詳情: ' + response.error, 'danger');
            $('#pageContent').html('<div class="alert alert-danger">載入收據詳情失敗</div>');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('載入收據詳情失敗:', error);
          showToast('錯誤', '載入收據詳情失敗，請檢查網路連線', 'danger');
          $('#pageContent').html('<div class="alert alert-danger">載入收據詳情失敗，請檢查網路連線</div>');
          hideLoading();
        });
    }
    
    // 渲染收據詳情
    function renderReceiptDetails(receipt) {
      const html = `
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">收據詳情</h5>
            <div>
              <button type="button" class="btn btn-outline-success btn-sm me-2" onclick="sendReceiptEmail('${receipt.收據編號}')">
                <i class="fas fa-envelope"></i> 寄送收據
              </button>
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadReceipt('${receipt.收據編號}')">
                <i class="fas fa-download"></i> 下載 PDF
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="row mb-4">
              <div class="col-md-6">
                <h6 class="text-muted">基本資訊</h6>
                <table class="table table-sm">
                  <tr>
                    <th style="width: 35%">收據編號</th>
                    <td>${receipt.收據編號}</td>
                  </tr>
                  <tr>
                    <th>日期</th>
                    <td>${formatDate(receipt.日期)}</td>
                  </tr>
                  <tr>
                    <th>收款項目</th>
                    <td>${receipt.收款項目}</td>
                  </tr>
                  <tr>
                    <th>金額</th>
                    <td>NT$ ${formatNumber(receipt.金額)}</td>
                  </tr>
                  <tr>
                    <th>用途說明</th>
                    <td>${receipt.用途說明 || '-'}</td>
                  </tr>
                  <tr>
                    <th>收款人</th>
                    <td>${receipt.收款人}</td>
                  </tr>
                  <tr>
                    <th>狀態</th>
                    <td>
                      <span class="badge ${receipt.狀態 === '已開立' ? 'bg-success' : receipt.狀態 === '草稿' ? 'bg-warning text-dark' : 'bg-danger'}">
                        ${receipt.狀態}
                      </span>
                    </td>
                  </tr>
                </table>
              </div>
              <div class="col-md-6">
                <h6 class="text-muted">付款人資訊</h6>
                <table class="table table-sm">
                  <tr>
                    <th style="width: 35%">姓名</th>
                    <td>${receipt.付款人}</td>
                  </tr>
                  <tr>
                    <th>身分</th>
                    <td>${receipt.身分 || '-'}</td>
                  </tr>
                  <tr>
                    <th>聯絡電話</th>
                    <td>${receipt.聯絡電話 || '-'}</td>
                  </tr>
                  <tr>
                    <th>電子郵件</th>
                    <td>${receipt.電子郵件 || '-'}</td>
                  </tr>
                  <tr>
                    <th>郵件狀態</th>
                    <td>
                      <span class="badge ${receipt.郵件狀態 === '已寄送' ? 'bg-success' : receipt.郵件狀態 === '不需寄送' ? 'bg-secondary' : receipt.郵件狀態 === '寄送失敗' ? 'bg-danger' : 'bg-warning text-dark'}">
                        ${receipt.郵件狀態}
                      </span>
                    </td>
                  </tr>
                </table>
              </div>
            </div>
            
            <div class="d-flex justify-content-between">
              <a href="#receipts" class="btn btn-outline-secondary">返回列表</a>
              
              ${receipt.狀態 !== '已作廢' ? `
                <button type="button" class="btn btn-danger" onclick="voidReceiptConfirm('${receipt.收據編號}')">
                  <i class="fas fa-ban"></i> 作廢收據
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `;
      
      $('#pageContent').html(html);
    }
    
    // 確認作廢收據
    function voidReceiptConfirm(receiptNumber) {
      if (confirm('確定要作廢這張收據嗎？此操作無法復原。')) {
        voidReceipt(receiptNumber);
      }
    }
    
    // 作廢收據
    function voidReceipt(receiptNumber) {
      showLoading();
      
      // 在實際應用中，這裡應該調用 API 作廢收據
      // 這裡僅作示範
      setTimeout(() => {
        showToast('成功', '收據已作廢', 'success');
        loadReceiptDetails(receiptNumber);
      }, 1000);
    }
    
    // 載入收據表單
    function loadReceiptForm() {
      const formData = {
        date: formatDateForInput(new Date())
      };
      
      renderReceiptForm(formData);
    }
    
    // 渲染收據表單
    function renderReceiptForm(data) {
      const html = `
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">開立收據</h5>
          </div>
          <div class="card-body">
            <form id="receiptForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="date" class="form-label">日期 <span class="text-danger">*</span></label>
                  <input type="date" class="form-control" id="date" name="date" required value="${data.date || ''}">
                </div>
                <div class="col-md-6">
                  <label for="category" class="form-label">收款項目 <span class="text-danger">*</span></label>
                  <select class="form-select" id="category" name="category" required>
                    <option value="" disabled selected>請選擇收款項目</option>
                    <option value="會費">會費</option>
                    <option value="捐款">捐款</option>
                    <option value="活動收入">活動收入</option>
                    <option value="專案收入">專案收入</option>
                    <option value="利息收入">利息收入</option>
                    <option value="其他收入">其他收入</option>
                  </select>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="payer" class="form-label">付款人 <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="payer" name="payer" required value="${data.payer || ''}">
                    <button class="btn btn-outline-secondary" type="button" id="btnSelectMember">
                      <i class="fas fa-search"></i> 選擇會員
                    </button>
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="amount" class="form-label">金額 <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <span class="input-group-text">NT$</span>
                    <input type="number" class="form-control" id="amount" name="amount" min="0" step="1" required value="${data.amount || ''}">
                  </div>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="identity" class="form-label">身分</label>
                  <input type="text" class="form-control" id="identity" name="identity" value="${data.identity || ''}">
                </div>
                <div class="col-md-6">
                  <label for="phone" class="form-label">聯絡電話</label>
                  <input type="tel" class="form-control" id="phone" name="phone" value="${data.phone || ''}">
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="email" class="form-label">電子郵件</label>
                  <input type="email" class="form-control" id="email" name="email" value="${data.email || ''}">
                </div>
                <div class="col-md-6">
                  <label for="recipient" class="form-label">收款人</label>
                  <input type="text" class="form-control" id="recipient" name="recipient" value="${data.recipient || systemSettings.organization_name || ''}">
                </div>
              </div>
              
              <div class="mb-3">
                <label for="description" class="form-label">用途說明</label>
                <textarea class="form-control" id="description" name="description" rows="2">${data.description || ''}</textarea>
              </div>
              
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="addTransaction" name="addTransaction" checked>
                <label class="form-check-label" for="addTransaction">
                  同時新增交易記錄
                </label>
              </div>
              
              <div class="d-flex justify-content-between">
                <a href="#receipts" class="btn btn-outline-secondary">取消</a>
                <div>
                  <button type="button" class="btn btn-outline-primary me-2" id="btnPreview">
                    <i class="fas fa-eye"></i> 預覽
                  </button>
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> 儲存並產生收據
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      `;
      
      $('#pageContent').html(html);
      
      // 選擇會員按鈕點擊事件
      $('#btnSelectMember').click(function() {
        // 在實際應用中，這裡應該顯示會員選擇對話框
        // 這裡僅作示範
        alert('此功能將顯示會員選擇對話框，選擇後自動填入會員資料');
      });
      
      // 預覽按鈕點擊事件
      $('#btnPreview').click(function() {
        // 檢查必填欄位
        if (!$('#payer').val() || !$('#amount').val() || !$('#category').val()) {
          showToast('警告', '請填寫必填欄位再預覽', 'warning');
          return;
        }
        
        // 在實際應用中，這裡應該顯示收據預覽
        // 這裡僅作示範
        alert('此功能將顯示收據預覽');
      });
      
      // 表單提交處理
      $('#receiptForm').submit(function(e) {
        e.preventDefault();
        
        const formData = {
          date: $('#date').val(),
          payer: $('#payer').val(),
          identity: $('#identity').val(),
          phone: $('#phone').val(),
          email: $('#email').val(),
          category: $('#category').val(),
          amount: parseFloat($('#amount').val()),
          description: $('#description').val(),
          recipient: $('#recipient').val(),
          addTransaction: $('#addTransaction').is(':checked')
        };
        
        showLoading();
        
        apiRequest('generateReceipt', { data: formData })
          .then(response => {
            if (response.success) {
              showToast('成功', '收據已成功生成', 'success');
              window.location.hash = '#receipts/view/' + response.data.receiptNumber;
            } else {
              showToast('錯誤', '生成收據失敗: ' + response.error, 'danger');
              hideLoading();
            }
          })
          .catch(error => {
            console.error('生成收據失敗:', error);
            showToast('錯誤', '生成收據失敗，請檢查網路連線', 'danger');
            hideLoading();
          });
      });
    }
    
    // 載入支出憑證管理
    function loadVouchers() {
      apiRequest('getVouchers', { page: 1, limit: 50 })
        .then(response => {
          if (response.success) {
            renderVouchers(response.data);
          } else {
            showToast('錯誤', '無法載入支出憑證: ' + response.error, 'danger');
            $('#pageContent').html('<div class="alert alert-danger">載入支出憑證失敗</div>');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('載入支出憑證失敗:', error);
          showToast('錯誤', '載入支出憑證失敗，請檢查網路連線', 'danger');
          $('#pageContent').html('<div class="alert alert-danger">載入支出憑證失敗，請檢查網路連線</div>');
          hideLoading();
        });
    }
    
    // 渲染支出憑證列表
    function renderVouchers(data) {
      const html = `
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>支出憑證管理</span>
            <a href="#vouchers/new" class="btn btn-primary btn-sm">
              <i class="fas fa-plus"></i> 申請支出憑證
            </a>
          </div>
          <div class="card-body">
            <!-- 篩選工具 -->
            <div class="row mb-3">
              <div class="col-md-3">
                <select class="form-select form-select-sm" id="statusFilter">
                  <option value="">所有狀態</option>
                  <option value="待審核">待審核</option>
                  <option value="已核准">已核准</option>
                  <option value="已駁回">已駁回</option>
                  <option value="已付款">已付款</option>
                </select>
              </div>
              <div class="col-md-3">
                <select class="form-select form-select-sm" id="categoryFilter">
                  <option value="">所有類別</option>
                  <option value="行政費用">行政費用</option>
                  <option value="活動費用">活動費用</option>
                  <option value="專案費用">專案費用</option>
                  <option value="人事費用">人事費用</option>
                  <option value="設備費用">設備費用</option>
                  <option value="其他費用">其他費用</option>
                </select>
              </div>
              <div class="col-md-6">
                <div class="input-group input-group-sm">
                  <input type="text" class="form-control" id="searchFilter" placeholder="搜尋憑證編號、申請人...">
                  <button class="btn btn-outline-secondary" type="button" id="btnSearch">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- 支出憑證表格 -->
            <div class="table-responsive">
              <table class="table table-hover table-striped" id="vouchersTable">
                <thead>
                  <tr>
                    <th>憑證編號</th>
                    <th>日期</th>
                    <th>申請人</th>
                    <th>支出類別</th>
                    <th>金額</th>
                    <th>狀態</th>
                    <th>審核人</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.vouchers.map(v => `
                    <tr>
                      <td>${v.憑證編號}</td>
                      <td>${formatDate(v.日期)}</td>
                      <td>${v.申請人}</td>
                      <td>${v.支出類別}</td>
                      <td class="text-end">NT$ ${formatNumber(v.金額)}</td>
                      <td>
                        <span class="badge ${v.狀態 === '已核准' ? 'bg-success' : v.狀態 === '待審核' ? 'bg-warning text-dark' : v.狀態 === '已付款' ? 'bg-info' : 'bg-danger'}">
                          ${v.狀態}
                        </span>
                      </td>
                      <td>${v.審核人 || '-'}</td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <a href="#vouchers/view/${v.憑證編號}" class="btn btn-outline-primary">
                            <i class="fas fa-eye"></i>
                          </a>
                          <button type="button" class="btn btn-outline-secondary" onclick="downloadVoucher('${v.憑證編號}')">
                            <i class="fas fa-download"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <!-- 分頁 -->
            <nav aria-label="Page navigation" class="mt-3">
              <ul class="pagination justify-content-center">
                <li class="page-item ${data.pagination.page <= 1 ? 'disabled' : ''}">
                  <a class="page-link" href="#" onclick="changeVouchersPage(${data.pagination.page - 1})">上一頁</a>
                </li>
                ${generatePaginationItems(data.pagination.page, data.pagination.totalPages)}
                <li class="page-item ${data.pagination.page >= data.pagination.totalPages ? 'disabled' : ''}">
                  <a class="page-link" href="#" onclick="changeVouchersPage(${data.pagination.page + 1})">下一頁</a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      `;
      
      $('#pageContent').html(html);
      
      // 初始化 DataTables
      $('#vouchersTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/zh-HANT.json'
        },
        paging: false,
        searching: false,
        info: false
      });
      
      // 綁定篩選事件
      $('#btnSearch').click(function() {
        filterVouchers();
      });
      
      $('#statusFilter, #categoryFilter').change(function() {
        filterVouchers();
      });
      
      $('#searchFilter').keypress(function(e) {
        if (e.which === 13) {
          filterVouchers();
        }
      });
    }
    
    // 篩選支出憑證
    function filterVouchers() {
      const status = $('#statusFilter').val();
      const category = $('#categoryFilter').val();
      const search = $('#searchFilter').val();
      
      showLoading();
      
      apiRequest('getVouchers', { 
        page: 1, 
        limit: 50,
        status,
        category,
        search
      })
        .then(response => {
          if (response.success) {
            renderVouchers(response.data);
          } else {
            showToast('錯誤', '篩選支出憑證失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('篩選支出憑證失敗:', error);
          showToast('錯誤', '篩選支出憑證失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 切換支出憑證分頁
    function changeVouchersPage(page) {
      const status = $('#statusFilter').val();
      const category = $('#categoryFilter').val();
      const search = $('#searchFilter').val();
      
      showLoading();
      
      apiRequest('getVouchers', { 
        page, 
        limit: 50,
        status,
        category,
        search
      })
        .then(response => {
          if (response.success) {
            renderVouchers(response.data);
          } else {
            showToast('錯誤', '載入支出憑證失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('載入支出憑證失敗:', error);
          showToast('錯誤', '載入支出憑證失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 下載支出憑證 PDF
    function downloadVoucher(voucherNumber) {
      showLoading();
      
      apiRequest('getVoucherDetails', { voucherNumber })
        .then(response => {
          if (response.success && response.data.PDF文件ID) {
            // 在新視窗中開啟 Google Drive 檔案
            const fileId = response.data.PDF文件ID;
            window.open(`https://drive.google.com/file/d/${fileId}/view`, '_blank');
            hideLoading();
          } else {
            showToast('錯誤', '無法下載支出憑證: PDF 檔案不存在', 'danger');
            hideLoading();
          }
        })
        .catch(error => {
          console.error('下載支出憑證失敗:', error);
          showToast('錯誤', '下載支出憑證失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 載入支出憑證表單
    function loadVoucherForm() {
      const formData = {
        date: formatDateForInput(new Date()),
        status: '待審核',
        receiptCount: 1
      };
      
      renderVoucherForm(formData);
    }
    
    // 渲染支出憑證表單
    function renderVoucherForm(data) {
      const html = `
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">申請支出憑證</h5>
          </div>
          <div class="card-body">
            <form id="voucherForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="date" class="form-label">申請日期 <span class="text-danger">*</span></label>
                  <input type="date" class="form-control" id="date" name="date" required value="${data.date || ''}">
                </div>
                <div class="col-md-6">
                  <label for="applicant" class="form-label">申請人 <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="applicant" name="applicant" required value="${data.applicant || ''}">
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="department" class="form-label">部門</label>
                  <input type="text" class="form-control" id="department" name="department" value="${data.department || ''}">
                </div>
                <div class="col-md-6">
                  <label for="category" class="form-label">支出類別 <span class="text-danger">*</span></label>
                  <select class="form-select" id="category" name="category" required>
                    <option value="" disabled selected>請選擇支出類別</option>
                    <option value="行政費用" ${data.category === '行政費用' ? 'selected' : ''}>行政費用</option>
                    <option value="活動費用" ${data.category === '活動費用' ? 'selected' : ''}>活動費用</option>
                    <option value="專案費用" ${data.category === '專案費用' ? 'selected' : ''}>專案費用</option>
                    <option value="人事費用" ${data.category === '人事費用' ? 'selected' : ''}>人事費用</option>
                    <option value="設備費用" ${data.category === '設備費用' ? 'selected' : ''}>設備費用</option>
                    <option value="其他費用" ${data.category === '其他費用' ? 'selected' : ''}>其他費用</option>
                  </select>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="amount" class="form-label">金額 <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <span class="input-group-text">NT$</span>
                    <input type="number" class="form-control" id="amount" name="amount" min="0" step="1" required value="${data.amount || ''}">
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="receiptCount" class="form-label">收據張數 <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="receiptCount" name="receiptCount" min="1" step="1" required value="${data.receiptCount || 1}">
                </div>
              </div>
              
              <div class="mb-3">
                <label for="purpose" class="form-label">用途說明 <span class="text-danger">*</span></label>
                <textarea class="form-control" id="purpose" name="purpose" rows="3" required>${data.purpose || ''}</textarea>
              </div>
              
              <div class="mb-3">
                <label for="receiptUpload" class="form-label">上傳收據 <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="receiptUpload" name="receiptUpload" multiple>
                <div class="form-text">請上傳收據影本，支援 PDF、JPG、PNG 格式</div>
              </div>
              
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="addTransaction" name="addTransaction">
                <label class="form-check-label" for="addTransaction">
                  核准後自動新增交易記錄
                </label>
              </div>
              
              <div class="d-flex justify-content-between">
                <a href="#vouchers" class="btn btn-outline-secondary">取消</a>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> 提交申請
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      $('#pageContent').html(html);
      
      // 表單提交處理
      $('#voucherForm').submit(function(e) {
        e.preventDefault();
        
        // 檢查是否有上傳檔案
        if ($('#receiptUpload').get(0).files.length === 0) {
          showToast('警告', '請上傳收據影本', 'warning');
          return;
        }
        
        const formData = {
          date: $('#date').val(),
          applicant: $('#applicant').val(),
          department: $('#department').val(),
          category: $('#category').val(),
          amount: parseFloat($('#amount').val()),
          receiptCount: parseInt($('#receiptCount').val()),
          purpose: $('#purpose').val(),
          status: '待審核',
          addTransaction: $('#addTransaction').is(':checked')
        };
        
        showLoading();
        
        // 在實際應用中，這裡應該上傳檔案並提交表單
        // 這裡僅作示範
        setTimeout(() => {
          showToast('成功', '支出憑證申請已提交', 'success');
          window.location.hash = '#vouchers';
        }, 1500);
      });
    }
    
    // 載入人員管理
    function loadMembers() {
      apiRequest('getMembers', { page: 1, limit: 50 })
        .then(response => {
          if (response.success) {
            renderMembers(response.data);
          } else {
            showToast('錯誤', '無法載入人員資料: ' + response.error, 'danger');
            $('#pageContent').html('<div class="alert alert-danger">載入人員資料失敗</div>');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('載入人員資料失敗:', error);
          showToast('錯誤', '載入人員資料失敗，請檢查網路連線', 'danger');
          $('#pageContent').html('<div class="alert alert-danger">載入人員資料失敗，請檢查網路連線</div>');
          hideLoading();
        });
    }
    
    // 渲染人員列表
    function renderMembers(data) {
      const html = `
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>人員管理</span>
            <a href="#members/new" class="btn btn-primary btn-sm">
              <i class="fas fa-plus"></i> 新增人員
            </a>
          </div>
          <div class="card-body">
            <!-- 篩選工具 -->
            <div class="row mb-3">
              <div class="col-md-3">
                <select class="form-select form-select-sm" id="typeFilter">
                  <option value="">所有類型</option>
                  <option value="正式會員">正式會員</option>
                  <option value="贊助會員">贊助會員</option>
                  <option value="志工">志工</option>
                  <option value="職員">職員</option>
                </select>
              </div>
              <div class="col-md-3">
                <select class="form-select form-select-sm" id="statusFilter">
                  <option value="">所有狀態</option>
                  <option value="有效">有效</option>
                  <option value="停權">停權</option>
                  <option value="過期">過期</option>
                </select>
              </div>
              <div class="col-md-6">
                <div class="input-group input-group-sm">
                  <input type="text" class="form-control" id="searchFilter" placeholder="搜尋姓名、電話、電子郵件...">
                  <button class="btn btn-outline-secondary" type="button" id="btnSearch">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- 人員表格 -->
            <div class="table-responsive">
              <table class="table table-hover table-striped" id="membersTable">
                <thead>
                  <tr>
                    <th>編號</th>
                    <th>姓名</th>
                    <th>類型</th>
                    <th>電話</th>
                    <th>電子郵件</th>
                    <th>加入日期</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.members.map(m => `
                    <tr>
                      <td>${m.編號}</td>
                      <td>${m.姓名}</td>
                      <td>${m.類型}</td>
                      <td>${m.電話 || '-'}</td>
                      <td>${m.電子郵件 || '-'}</td>
                      <td>${formatDate(m.加入日期)}</td>
                      <td>
                        <span class="badge ${m.狀態 === '有效' ? 'bg-success' : m.狀態 === '停權' ? 'bg-danger' : 'bg-warning text-dark'}">
                          ${m.狀態}
                        </span>
                      </td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <a href="#members/edit/${m.id}" class="btn btn-outline-primary">
                            <i class="fas fa-edit"></i>
                          </a>
                          <button type="button" class="btn btn-outline-danger" onclick="deleteMemberConfirm(${m.id})">
                            <i class="fas fa-trash-alt"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <!-- 分頁 -->
            <nav aria-label="Page navigation" class="mt-3">
              <ul class="pagination justify-content-center">
                <li class="page-item ${data.pagination.page <= 1 ? 'disabled' : ''}">
                  <a class="page-link" href="#" onclick="changeMembersPage(${data.pagination.page - 1})">上一頁</a>
                </li>
                ${generatePaginationItems(data.pagination.page, data.pagination.totalPages)}
                <li class="page-item ${data.pagination.page >= data.pagination.totalPages ? 'disabled' : ''}">
                  <a class="page-link" href="#" onclick="changeMembersPage(${data.pagination.page + 1})">下一頁</a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      `;
      
      $('#pageContent').html(html);
      
      // 初始化 DataTables
      $('#membersTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/zh-HANT.json'
        },
        paging: false,
        searching: false,
        info: false
      });
      
      // 綁定篩選事件
      $('#btnSearch').click(function() {
        filterMembers();
      });
      
      $('#typeFilter, #statusFilter').change(function() {
        filterMembers();
      });
      
      $('#searchFilter').keypress(function(e) {
        if (e.which === 13) {
          filterMembers();
        }
      });
    }
    
    // 篩選人員
    function filterMembers() {
      const type = $('#typeFilter').val();
      const status = $('#statusFilter').val();
      const search = $('#searchFilter').val();
      
      showLoading();
      
      apiRequest('getMembers', { 
        page: 1, 
        limit: 50,
        type,
        status,
        search
      })
        .then(response => {
          if (response.success) {
            renderMembers(response.data);
          } else {
            showToast('錯誤', '篩選人員資料失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('篩選人員資料失敗:', error);
          showToast('錯誤', '篩選人員資料失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 切換人員分頁
    function changeMembersPage(page) {
      const type = $('#typeFilter').val();
      const status = $('#statusFilter').val();
      const search = $('#searchFilter').val();
      
      showLoading();
      
      apiRequest('getMembers', { 
        page, 
        limit: 50,
        type,
        status,
        search
      })
        .then(response => {
          if (response.success) {
            renderMembers(response.data);
          } else {
            showToast('錯誤', '載入人員資料失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('載入人員資料失敗:', error);
          showToast('錯誤', '載入人員資料失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 載入人員表單
    function loadMemberForm(id = null) {
      let formTitle = '新增人員';
      let formData = {
        joinDate: formatDateForInput(new Date()),
        type: '正式會員',
        status: '有效'
      };
      
      if (id) {
        formTitle = '編輯人員資料';
        showLoading();
        
        // 在實際應用中，應該從 API 獲取人員詳情
        // 這裡僅作示範
        setTimeout(() => {
          formData = {
            id: id,
            name: '王小明',
            type: '正式會員',
            phone: '0912-345-678',
            email: 'wang@example.com',
            address: '台北市中正區忠孝東路100號',
            joinDate: '2022-05-15',
            status: '有效',
            idNumber: 'A123456789',
            birthday: '1990-01-01',
            gender: '男',
            education: '大學',
            occupation: '工程師',
            skills: '程式設計、網頁開發',
            notes: '熱心參與活動'
          };
          
          renderMemberForm(formTitle, formData);
          hideLoading();
        }, 500);
      } else {
        renderMemberForm(formTitle, formData);
      }
    }
    
    // 渲染人員表單
    function renderMemberForm(title, data) {
      const html = `
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">${title}</h5>
          </div>
          <div class="card-body">
            <form id="memberForm">
              ${data.id ? `<input type="hidden" name="id" value="${data.id}">` : ''}
              
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="name" class="form-label">姓名 <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="name" name="name" required value="${data.name || ''}">
                </div>
                <div class="col-md-4">
                  <label for="type" class="form-label">類型 <span class="text-danger">*</span></label>
                  <select class="form-select" id="type" name="type" required>
                    <option value="正式會員" ${data.type === '正式會員' ? 'selected' : ''}>正式會員</option>
                    <option value="贊助會員" ${data.type === '贊助會員' ? 'selected' : ''}>贊助會員</option>
                    <option value="志工" ${data.type === '志工' ? 'selected' : ''}>志工</option>
                    <option value="職員" ${data.type === '職員' ? 'selected' : ''}>職員</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="status" class="form-label">狀態 <span class="text-danger">*</span></label>
                  <select class="form-select" id="status" name="status" required>
                    <option value="有效" ${data.status === '有效' ? 'selected' : ''}>有效</option>
                    <option value="停權" ${data.status === '停權' ? 'selected' : ''}>停權</option>
                    <option value="過期" ${data.status === '過期' ? 'selected' : ''}>過期</option>
                  </select>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="phone" class="form-label">電話</label>
                  <input type="tel" class="form-control" id="phone" name="phone" value="${data.phone || ''}">
                </div>
                <div class="col-md-4">
                  <label for="email" class="form-label">電子郵件</label>
                  <input type="email" class="form-control" id="email" name="email" value="${data.email || ''}">
                </div>
                <div class="col-md-4">
                  <label for="joinDate" class="form-label">加入日期 <span class="text-danger">*</span></label>
                  <input type="date" class="form-control" id="joinDate" name="joinDate" required value="${data.joinDate || ''}">
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="idNumber" class="form-label">身分證字號</label>
                  <input type="text" class="form-control" id="idNumber" name="idNumber" value="${data.idNumber || ''}">
                </div>
                <div class="col-md-4">
                  <label for="birthday" class="form-label">生日</label>
                  <input type="date" class="form-control" id="birthday" name="birthday" value="${data.birthday || ''}">
                </div>
                <div class="col-md-4">
                  <label for="gender" class="form-label">性別</label>
                  <select class="form-select" id="gender" name="gender">
                    <option value="" ${!data.gender ? 'selected' : ''}>請選擇</option>
                    <option value="男" ${data.gender === '男' ? 'selected' : ''}>男</option>
                    <option value="女" ${data.gender === '女' ? 'selected' : ''}>女</option>
                    <option value="其他" ${data.gender === '其他' ? 'selected' : ''}>其他</option>
                  </select>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="address" class="form-label">地址</label>
                <input type="text" class="form-control" id="address" name="address" value="${data.address || ''}">
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="education" class="form-label">學歷</label>
                  <input type="text" class="form-control" id="education" name="education" value="${data.education || ''}">
                </div>
                <div class="col-md-6">
                  <label for="occupation" class="form-label">職業</label>
                  <input type="text" class="form-control" id="occupation" name="occupation" value="${data.occupation || ''}">
                </div>
              </div>
              
              <div class="mb-3">
                <label for="skills" class="form-label">專長與技能</label>
                <input type="text" class="form-control" id="skills" name="skills" value="${data.skills || ''}">
              </div>
              
              <div class="mb-3">
                <label for="notes" class="form-label">備註</label>
                <textarea class="form-control" id="notes" name="notes" rows="3">${data.notes || ''}</textarea>
              </div>
              
              <div class="d-flex justify-content-between">
                <a href="#members" class="btn btn-outline-secondary">取消</a>
                <button type="submit" class="btn btn-primary">儲存</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      $('#pageContent').html(html);
      
      // 表單提交處理
      $('#memberForm').submit(function(e) {
        e.preventDefault();
        
        const formData = {
          id: $('input[name="id"]').val(),
          name: $('#name').val(),
          type: $('#type').val(),
          status: $('#status').val(),
          phone: $('#phone').val(),
          email: $('#email').val(),
          joinDate: $('#joinDate').val(),
          idNumber: $('#idNumber').val(),
          birthday: $('#birthday').val(),
          gender: $('#gender').val(),
          address: $('#address').val(),
          education: $('#education').val(),
          occupation: $('#occupation').val(),
          skills: $('#skills').val(),
          notes: $('#notes').val()
        };
        
        showLoading();
        
        // 根據是否有 ID 決定是新增還是更新
        const action = formData.id ? 'updateMember' : 'addMember';
        
        apiRequest(action, { data: formData })
          .then(response => {
            if (response.success) {
              showToast('成功', '人員資料已儲存', 'success');
              window.location.hash = '#members';
            } else {
              showToast('錯誤', '儲存人員資料失敗: ' + response.error, 'danger');
              hideLoading();
            }
          })
          .catch(error => {
            console.error('儲存人員資料失敗:', error);
            showToast('錯誤', '儲存人員資料失敗，請檢查網路連線', 'danger');
            hideLoading();
          });
      });
    }
    
    // 確認刪除人員
    function deleteMemberConfirm(id) {
      if (confirm('確定要刪除這筆人員資料嗎？此操作無法復原。')) {
        deleteMember(id);
      }
    }
    
    // 刪除人員
    function deleteMember(id) {
      showLoading();
      
      apiRequest('deleteMember', { data: { id } })
        .then(response => {
          if (response.success) {
            showToast('成功', '人員資料已刪除', 'success');
            loadMembers();
          } else {
            showToast('錯誤', '刪除人員資料失敗: ' + response.error, 'danger');
            hideLoading();
          }
        })
        .catch(error => {
          console.error('刪除人員資料失敗:', error);
          showToast('錯誤', '刪除人員資料失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 載入財務報表
    function loadReports() {
      const html = `
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">財務報表</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <div class="card mb-3">
                  <div class="card-header">收支報表</div>
                  <div class="card-body">
                    <p>查看指定期間內的收入與支出明細及統計。</p>
                    <form id="incomeExpenseReportForm">
                      <div class="mb-3">
                        <label for="ieReportDateFrom" class="form-label">起始日期</label>
                        <input type="date" class="form-control" id="ieReportDateFrom" required>
                      </div>
                      <div class="mb-3">
                        <label for="ieReportDateTo" class="form-label">結束日期</label>
                        <input type="date" class="form-control" id="ieReportDateTo" required>
                      </div>
                      <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-file-alt"></i> 產生報表
                      </button>
                    </form>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="card mb-3">
                  <div class="card-header">類別統計報表</div>
                  <div class="card-body">
                    <p>依類別統計收入與支出，並以圖表呈現。</p>
                    <form id="categoryReportForm">
                      <div class="mb-3">
                        <label for="categoryReportYear" class="form-label">年度</label>
                        <select class="form-select" id="categoryReportYear" required>
                          <option value="2025">2025</option>
                          <option value="2024">2024</option>
                          <option value="2023">2023</option>
                          <option value="2022">2022</option>
                          <option value="2021">2021</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="categoryReportType" class="form-label">報表類型</label>
                        <select class="form-select" id="categoryReportType" required>
                          <option value="all">收入與支出</option>
                          <option value="income">僅收入</option>
                          <option value="expense">僅支出</option>
                        </select>
                      </div>
                      <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-chart-pie"></i> 產生報表
                      </button>
                    </form>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="card mb-3">
                  <div class="card-header">會員繳費報表</div>
                  <div class="card-body">
                    <p>查看會員繳費情況統計與詳細記錄。</p>
                    <form id="membershipReportForm">
                      <div class="mb-3">
                        <label for="membershipReportYear" class="form-label">年度</label>
                        <select class="form-select" id="membershipReportYear" required>
                          <option value="2025">2025</option>
                          <option value="2024">2024</option>
                          <option value="2023">2023</option>
                          <option value="2022">2022</option>
                          <option value="2021">2021</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="membershipReportType" class="form-label">會員類型</label>
                        <select class="form-select" id="membershipReportType">
                          <option value="all">所有會員</option>
                          <option value="regular">正式會員</option>
                          <option value="sponsor">贊助會員</option>
                        </select>
                      </div>
                      <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-users"></i> 產生報表
                      </button>
                    </form>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="card mb-3">
                  <div class="card-header">捐款統計報表</div>
                  <div class="card-body">
                    <p>查看捐款來源、金額統計與詳細記錄。</p>
                    <form id="donationReportForm">
                      <div class="mb-3">
                        <label for="donationReportDateFrom" class="form-label">起始日期</label>
                        <input type="date" class="form-control" id="donationReportDateFrom" required>
                      </div>
                      <div class="mb-3">
                        <label for="donationReportDateTo" class="form-label">結束日期</label>
                        <input type="date" class="form-control" id="donationReportDateTo" required>
                      </div>
                      <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-hand-holding-heart"></i> 產生報表
                      </button>
                    </form>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="card mb-3">
                  <div class="card-header">收據發放報表</div>
                  <div class="card-body">
                    <p>查看收據發放統計與詳細記錄。</p>
                    <form id="receiptReportForm">
                      <div class="mb-3">
                        <label for="receiptReportDateFrom" class="form-label">起始日期</label>
                        <input type="date" class="form-control" id="receiptReportDateFrom" required>
                      </div>
                      <div class="mb-3">
                        <label for="receiptReportDateTo" class="form-label">結束日期</label>
                        <input type="date" class="form-control" id="receiptReportDateTo" required>
                      </div>
                      <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-receipt"></i> 產生報表
                      </button>
                    </form>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="card mb-3">
                  <div class="card-header">年度財務報表</div>
                  <div class="card-body">
                    <p>產生年度收支表、資產負債表等財務報表。</p>
                    <form id="annualReportForm">
                      <div class="mb-3">
                        <label for="annualReportYear" class="form-label">年度</label>
                        <select class="form-select" id="annualReportYear" required>
                          <option value="2025">2025</option>
                          <option value="2024">2024</option>
                          <option value="2023">2023</option>
                          <option value="2022">2022</option>
                          <option value="2021">2021</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="annualReportType" class="form-label">報表類型</label>
                        <select class="form-select" id="annualReportType" required>
                          <option value="income-expense">收支表</option>
                          <option value="balance">資產負債表</option>
                          <option value="all">全部報表</option>
                        </select>
                      </div>
                      <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-file-invoice-dollar"></i> 產生報表
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      $('#pageContent').html(html);
      
      // 設定預設日期
      const today = new Date();
      const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      
      $('#ieReportDateFrom, #donationReportDateFrom, #receiptReportDateFrom').val(formatDateForInput(firstDayOfMonth));
      $('#ieReportDateTo, #donationReportDateTo, #receiptReportDateTo').val(formatDateForInput(today));
      
      // 表單提交處理
      $('#incomeExpenseReportForm').submit(function(e) {
        e.preventDefault();
        generateIncomeExpenseReport();
      });
      
      $('#categoryReportForm').submit(function(e) {
        e.preventDefault();
        generateCategoryReport();
      });
      
      $('#membershipReportForm').submit(function(e) {
        e.preventDefault();
        generateMembershipReport();
      });
      
      $('#donationReportForm').submit(function(e) {
        e.preventDefault();
        generateDonationReport();
      });
      
      $('#receiptReportForm').submit(function(e) {
        e.preventDefault();
        generateReceiptReport();
      });
      
      $('#annualReportForm').submit(function(e) {
        e.preventDefault();
        generateAnnualReport();
      });
    }
    
    // 產生收支報表
    function generateIncomeExpenseReport() {
      const dateFrom = $('#ieReportDateFrom').val();
      const dateTo = $('#ieReportDateTo').val();
      
      showLoading();
      
      apiRequest('generateIncomeExpenseReport', { 
        dateFrom,
        dateTo
      })
        .then(response => {
          if (response.success) {
            // 在實際應用中，這裡應該顯示報表或提供下載連結
            // 這裡僅作示範
            showToast('成功', '收支報表已產生', 'success');
            
            // 假設 API 返回了報表的 PDF 文件 ID
            if (response.data && response.data.fileId) {
              window.open(`https://drive.google.com/file/d/${response.data.fileId}/view`, '_blank');
            }
          } else {
            showToast('錯誤', '產生收支報表失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('產生收支報表失敗:', error);
          showToast('錯誤', '產生收支報表失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 產生類別統計報表
    function generateCategoryReport() {
      const year = $('#categoryReportYear').val();
      const type = $('#categoryReportType').val();
      
      showLoading();
      
      apiRequest('generateCategoryReport', { 
        year,
        type
      })
        .then(response => {
          if (response.success) {
            // 在實際應用中，這裡應該顯示報表或提供下載連結
            // 這裡僅作示範
            showToast('成功', '類別統計報表已產生', 'success');
            
            if (response.data && response.data.fileId) {
              window.open(`https://drive.google.com/file/d/${response.data.fileId}/view`, '_blank');
            }
          } else {
            showToast('錯誤', '產生類別統計報表失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('產生類別統計報表失敗:', error);
          showToast('錯誤', '產生類別統計報表失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 產生會員繳費報表
    function generateMembershipReport() {
      const year = $('#membershipReportYear').val();
      const type = $('#membershipReportType').val();
      
      showLoading();
      
      apiRequest('generateMembershipReport', { 
        year,
        type
      })
        .then(response => {
          if (response.success) {
            // 在實際應用中，這裡應該顯示報表或提供下載連結
            // 這裡僅作示範
            showToast('成功', '會員繳費報表已產生', 'success');
            
            if (response.data && response.data.fileId) {
              window.open(`https://drive.google.com/file/d/${response.data.fileId}/view`, '_blank');
            }
          } else {
            showToast('錯誤', '產生會員繳費報表失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('產生會員繳費報表失敗:', error);
          showToast('錯誤', '產生會員繳費報表失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 產生捐款統計報表
    function generateDonationReport() {
      const dateFrom = $('#donationReportDateFrom').val();
      const dateTo = $('#donationReportDateTo').val();
      
      showLoading();
      
      apiRequest('generateDonationReport', { 
        dateFrom,
        dateTo
      })
        .then(response => {
          if (response.success) {
            // 在實際應用中，這裡應該顯示報表或提供下載連結
            // 這裡僅作示範
            showToast('成功', '捐款統計報表已產生', 'success');
            
            if (response.data && response.data.fileId) {
              window.open(`https://drive.google.com/file/d/${response.data.fileId}/view`, '_blank');
            }
          } else {
            showToast('錯誤', '產生捐款統計報表失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('產生捐款統計報表失敗:', error);
          showToast('錯誤', '產生捐款統計報表失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 產生收據發放報表
    function generateReceiptReport() {
      const dateFrom = $('#receiptReportDateFrom').val();
      const dateTo = $('#receiptReportDateTo').val();
      
      showLoading();
      
      apiRequest('generateReceiptReport', { 
        dateFrom,
        dateTo
      })
        .then(response => {
          if (response.success) {
            // 在實際應用中，這裡應該顯示報表或提供下載連結
            // 這裡僅作示範
            showToast('成功', '收據發放報表已產生', 'success');
            
            if (response.data && response.data.fileId) {
              window.open(`https://drive.google.com/file/d/${response.data.fileId}/view`, '_blank');
            }
          } else {
            showToast('錯誤', '產生收據發放報表失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('產生收據發放報表失敗:', error);
          showToast('錯誤', '產生收據發放報表失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 產生年度財務報表
    function generateAnnualReport() {
      const year = $('#annualReportYear').val();
      const type = $('#annualReportType').val();
      
      showLoading();
      
      apiRequest('generateAnnualReport', { 
        year,
        type
      })
        .then(response => {
          if (response.success) {
            // 在實際應用中，這裡應該顯示報表或提供下載連結
            // 這裡僅作示範
            showToast('成功', '年度財務報表已產生', 'success');
            
            if (response.data && response.data.fileId) {
              window.open(`https://drive.google.com/file/d/${response.data.fileId}/view`, '_blank');
            }
          } else {
            showToast('錯誤', '產生年度財務報表失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('產生年度財務報表失敗:', error);
          showToast('錯誤', '產生年度財務報表失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 載入系統設定
    function loadSettings() {
      apiRequest('getSystemSettings', {})
        .then(response => {
          if (response.success) {
            renderSettings(response.data);
          } else {
            showToast('錯誤', '無法載入系統設定: ' + response.error, 'danger');
            $('#pageContent').html('<div class="alert alert-danger">載入系統設定失敗</div>');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('載入系統設定失敗:', error);
          showToast('錯誤', '載入系統設定失敗，請檢查網路連線', 'danger');
          $('#pageContent').html('<div class="alert alert-danger">載入系統設定失敗，請檢查網路連線</div>');
          hideLoading();
        });
    }
    
    // 渲染系統設定
    function renderSettings(settings) {
      const html = `
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">系統設定</h5>
          </div>
          <div class="card-body">
            <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">
                  基本設定
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="receipt-tab" data-bs-toggle="tab" data-bs-target="#receipt" type="button" role="tab" aria-controls="receipt" aria-selected="false">
                  收據設定
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email" type="button" role="tab" aria-controls="email" aria-selected="false">
                  郵件設定
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="category-tab" data-bs-toggle="tab" data-bs-target="#category" type="button" role="tab" aria-controls="category" aria-selected="false">
                  類別管理
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup" type="button" role="tab" aria-controls="backup" aria-selected="false">
                  備份還原
                </button>
              </li>
            </ul>
            
            <div class="tab-content p-3" id="settingsTabContent">
              <!-- 基本設定 -->
              <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                <form id="generalSettingsForm">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="organizationName" class="form-label">組織名稱</label>
                      <input type="text" class="form-control" id="organizationName" name="organization_name" value="${settings.organization_name || ''}">
                    </div>
                    <div class="col-md-6">
                      <label for="organizationShortName" class="form-label">組織簡稱</label>
                      <input type="text" class="form-control" id="organizationShortName" name="organization_short_name" value="${settings.organization_short_name || ''}">
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="organizationPhone" class="form-label">聯絡電話</label>
                      <input type="tel" class="form-control" id="organizationPhone" name="organization_phone" value="${settings.organization_phone || ''}">
                    </div>
                    <div class="col-md-6">
                      <label for="organizationEmail" class="form-label">電子郵件</label>
                      <input type="email" class="form-control" id="organizationEmail" name="organization_email" value="${settings.organization_email || ''}">
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="organizationAddress" class="form-label">地址</label>
                    <input type="text" class="form-control" id="organizationAddress" name="organization_address" value="${settings.organization_address || ''}">
                  </div>
                  
                  <div class="mb-3">
                    <label for="organizationLogo" class="form-label">組織 Logo</label>
                    <input type="file" class="form-control" id="organizationLogo" name="organization_logo">
                    ${settings.organization_logo_url ? `
                      <div class="mt-2">
                        <img src="${settings.organization_logo_url}" alt="組織 Logo" style="max-height: 100px;" class="border p-1">
                      </div>
                    ` : ''}
                  </div>
                  
                  <div class="mb-3">
                    <label for="fiscalYear" class="form-label">會計年度起始月份</label>
                    <select class="form-select" id="fiscalYear" name="fiscal_year_start_month">
                      <option value="1" ${settings.fiscal_year_start_month == 1 ? 'selected' : ''}>1 月</option>
                      <option value="2" ${settings.fiscal_year_start_month == 2 ? 'selected' : ''}>2 月</option>
                      <option value="3" ${settings.fiscal_year_start_month == 3 ? 'selected' : ''}>3 月</option>
                      <option value="4" ${settings.fiscal_year_start_month == 4 ? 'selected' : ''}>4 月</option>
                      <option value="5" ${settings.fiscal_year_start_month == 5 ? 'selected' : ''}>5 月</option>
                      <option value="6" ${settings.fiscal_year_start_month == 6 ? 'selected' : ''}>6 月</option>
                      <option value="7" ${settings.fiscal_year_start_month == 7 ? 'selected' : ''}>7 月</option>
                      <option value="8" ${settings.fiscal_year_start_month == 8 ? 'selected' : ''}>8 月</option>
                      <option value="9" ${settings.fiscal_year_start_month == 9 ? 'selected' : ''}>9 月</option>
                      <option value="10" ${settings.fiscal_year_start_month == 10 ? 'selected' : ''}>10 月</option>
                      <option value="11" ${settings.fiscal_year_start_month == 11 ? 'selected' : ''}>11 月</option>
                      <option value="12" ${settings.fiscal_year_start_month == 12 ? 'selected' : ''}>12 月</option>
                    </select>
                  </div>
                  
                  <button type="submit" class="btn btn-primary">儲存基本設定</button>
                </form>
              </div>
              
              <!-- 收據設定 -->
              <div class="tab-pane fade" id="receipt" role="tabpanel" aria-labelledby="receipt-tab">
                <form id="receiptSettingsForm">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="receiptPrefix" class="form-label">收據編號前綴</label>
                      <input type="text" class="form-control" id="receiptPrefix" name="receipt_prefix" value="${settings.receipt_prefix || 'R'}">
                      <div class="form-text">例如: R-20230615-001 中的 "R"</div>
                    </div>
                    <div class="col-md-6">
                      <label for="receiptStartNumber" class="form-label">收據起始編號</label>
                      <input type="number" class="form-control" id="receiptStartNumber" name="receipt_start_number" min="1" value="${settings.receipt_start_number || 1}">
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="receiptTemplate" class="form-label">收據範本</label>
                    <select class="form-select" id="receiptTemplate" name="receipt_template">
                      <option value="default" ${settings.receipt_template === 'default' ? 'selected' : ''}>預設範本</option>
                      <option value="simple" ${settings.receipt_template === 'simple' ? 'selected' : ''}>簡易範本</option>
                      <option value="formal" ${settings.receipt_template === 'formal' ? 'selected' : ''}>正式範本</option>
                    </select>
                  </div>
                  
                  <div class="mb-3">
                    <label for="receiptFooter" class="form-label">收據頁尾文字</label>
                    <textarea class="form-control" id="receiptFooter" name="receipt_footer" rows="3">${settings.receipt_footer || ''}</textarea>
                  </div>
                  
                  <div class="mb-3">
                    <label for="receiptSignature" class="form-label">收據簽名圖片</label>
                    <input type="file" class="form-control" id="receiptSignature" name="receipt_signature">
                    ${settings.receipt_signature_url ? `
                      <div class="mt-2">
                        <img src="${settings.receipt_signature_url}" alt="收據簽名" style="max-height: 100px;" class="border p-1">
                      </div>
                    ` : ''}
                  </div>
                  
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="autoSendReceipt" name="auto_send_receipt" ${settings.auto_send_receipt ? 'checked' : ''}>
                    <label class="form-check-label" for="autoSendReceipt">
                      自動寄送收據電子郵件
                    </label>
                  </div>
                  
                  <button type="submit" class="btn btn-primary">儲存收據設定</button>
                </form>
              </div>
              
              <!-- 郵件設定 -->
              <div class="tab-pane fade" id="email" role="tabpanel" aria-labelledby="email-tab">
                <form id="emailSettingsForm">
                  <div class="mb-3">
                    <label for="emailSender" class="form-label">寄件人名稱</label>
                    <input type="text" class="form-control" id="emailSender" name="email_sender_name" value="${settings.email_sender_name || ''}">
                  </div>
                  
                  <div class="mb-3">
                    <label for="emailSubjectPrefix" class="form-label">郵件主旨前綴</label>
                    <input type="text" class="form-control" id="emailSubjectPrefix" name="email_subject_prefix" value="${settings.email_subject_prefix || ''}">
                    <div class="form-text">例如: [NGO會計系統]</div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="receiptEmailTemplate" class="form-label">收據郵件範本</label>
                    <textarea class="form-control" id="receiptEmailTemplate" name="receipt_email_template" rows="5">${settings.receipt_email_template || '親愛的 {{payer}}：\n\n感謝您的支持，您的收據（編號：{{receipt_number}}）已開立完成，請查收附件。\n\n{{organization_name}}'}</textarea>
                    <div class="form-text">可使用的變數: {{payer}}, {{receipt_number}}, {{date}}, {{amount}}, {{organization_name}}</div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="emailSignature" class="form-label">郵件簽名檔</label>
                    <textarea class="form-control" id="emailSignature" name="email_signature" rows="3">${settings.email_signature || ''}</textarea>
                  </div>
                  
                  <button type="submit" class="btn btn-primary">儲存郵件設定</button>
                </form>
              </div>
              
              <!-- 類別管理 -->
              <div class="tab-pane fade" id="category" role="tabpanel" aria-labelledby="category-tab">
                <div class="row">
                  <div class="col-md-6">
                    <h6>收入類別</h6>
                    <div class="mb-3">
                      <div class="input-group mb-2">
                        <input type="text" class="form-control" id="newIncomeCategory" placeholder="新增收入類別">
                        <button class="btn btn-outline-primary" type="button" id="addIncomeCategory">新增</button>
                      </div>
                      <div class="list-group" id="incomeCategoriesList">
                        ${(settings.income_categories || []).map(category => `
                          <div class="list-group-item d-flex justify-content-between align-items-center">
                            ${category}
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteCategory('income', '${category}')">
                              <i class="fas fa-times"></i>
                            </button>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <h6>支出類別</h6>
                    <div class="mb-3">
                      <div class="input-group mb-2">
                        <input type="text" class="form-control" id="newExpenseCategory" placeholder="新增支出類別">
                        <button class="btn btn-outline-primary" type="button" id="addExpenseCategory">新增</button>
                      </div>
                      <div class="list-group" id="expenseCategoriesList">
                        ${(settings.expense_categories || []).map(category => `
                          <div class="list-group-item d-flex justify-content-between align-items-center">
                            ${category}
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteCategory('expense', '${category}')">
                              <i class="fas fa-times"></i>
                            </button>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 備份還原 -->
              <div class="tab-pane fade" id="backup" role="tabpanel" aria-labelledby="backup-tab">
                <div class="row">
                  <div class="col-md-6">
                    <div class="card mb-3">
                      <div class="card-header">資料備份</div>
                      <div class="card-body">
                        <p>將系統所有資料備份為檔案，建議定期執行備份。</p>
                        <button type="button" class="btn btn-primary" id="btnBackup">
                          <i class="fas fa-download"></i> 立即備份
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="card mb-3">
                      <div class="card-header">資料還原</div>
                      <div class="card-body">
                        <p class="text-danger">警告：還原資料將會覆蓋目前的所有資料，請謹慎操作。</p>
                        <div class="mb-3">
                          <label for="restoreFile" class="form-label">選擇備份檔案</label>
                          <input type="file" class="form-control" id="restoreFile" accept=".json">
                        </div>
                        <button type="button" class="btn btn-danger" id="btnRestore" disabled>
                          <i class="fas fa-upload"></i> 還原資料
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="card">
                  <div class="card-header">自動備份設定</div>
                  <div class="card-body">
                    <form id="autoBackupForm">
                      <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="enableAutoBackup" name="enable_auto_backup" ${settings.enable_auto_backup ? 'checked' : ''}>
                        <label class="form-check-label" for="enableAutoBackup">
                          啟用自動備份
                        </label>
                      </div>
                      
                      <div class="mb-3">
                        <label for="backupFrequency" class="form-label">備份頻率</label>
                        <select class="form-select" id="backupFrequency" name="backup_frequency" ${!settings.enable_auto_backup ? 'disabled' : ''}>
                          <option value="daily" ${settings.backup_frequency === 'daily' ? 'selected' : ''}>每日</option>
                          <option value="weekly" ${settings.backup_frequency === 'weekly' ? 'selected' : ''}>每週</option>
                          <option value="monthly" ${settings.backup_frequency === 'monthly' ? 'selected' : ''}>每月</option>
                        </select>
                      </div>
                      
                      <div class="mb-3">
                        <label for="backupRetention" class="form-label">保留備份數量</label>
                        <input type="number" class="form-control" id="backupRetention" name="backup_retention" min="1" max="100" value="${settings.backup_retention || 10}" ${!settings.enable_auto_backup ? 'disabled' : ''}>
                        <div class="form-text">設定系統自動保留的備份數量，超過將自動刪除最舊的備份</div>
                      </div>
                      
                      <button type="submit" class="btn btn-primary">儲存備份設定</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      $('#pageContent').html(html);
      
      // 啟用 Bootstrap 標籤頁
      const tabEls = document.querySelectorAll('#settingsTabs button');
      tabEls.forEach(tabEl => {
        new bootstrap.Tab(tabEl);
      });
      
      // 基本設定表單提交
      $('#generalSettingsForm').submit(function(e) {
        e.preventDefault();
        saveGeneralSettings();
      });
      
      // 收據設定表單提交
      $('#receiptSettingsForm').submit(function(e) {
        e.preventDefault();
        saveReceiptSettings();
      });
      
      // 郵件設定表單提交
      $('#emailSettingsForm').submit(function(e) {
        e.preventDefault();
        saveEmailSettings();
      });
      
      // 自動備份設定表單提交
      $('#autoBackupForm').submit(function(e) {
        e.preventDefault();
        saveAutoBackupSettings();
      });
      
      // 啟用/禁用自動備份相關欄位
      $('#enableAutoBackup').change(function() {
        const isChecked = $(this).is(':checked');
        $('#backupFrequency, #backupRetention').prop('disabled', !isChecked);
      });
      
      // 新增收入類別
      $('#addIncomeCategory').click(function() {
        const category = $('#newIncomeCategory').val().trim();
        if (category) {
          addCategory('income', category);
        } else {
          showToast('警告', '請輸入類別名稱', 'warning');
        }
      });
      
      // 新增支出類別
      $('#addExpenseCategory').click(function() {
        const category = $('#newExpenseCategory').val().trim();
        if (category) {
          addCategory('expense', category);
        } else {
          showToast('警告', '請輸入類別名稱', 'warning');
        }
      });
      
      // 立即備份按鈕點擊事件
      $('#btnBackup').click(function() {
        backupData();
      });
      
      // 還原檔案選擇事件
      $('#restoreFile').change(function() {
        $('#btnRestore').prop('disabled', !$(this).val());
      });
      
      // 還原按鈕點擊事件
      $('#btnRestore').click(function() {
        restoreData();
      });
    }
    
    // 儲存基本設定
    function saveGeneralSettings() {
      const formData = {
        organization_name: $('#organizationName').val(),
        organization_short_name: $('#organizationShortName').val(),
        organization_phone: $('#organizationPhone').val(),
        organization_email: $('#organizationEmail').val(),
        organization_address: $('#organizationAddress').val(),
        fiscal_year_start_month: $('#fiscalYear').val()
      };
      
      // 處理 Logo 上傳
      const logoFile = $('#organizationLogo').get(0).files[0];
      
      showLoading();
      
      // 在實際應用中，這裡應該上傳 Logo 並提交表單
      // 這裡僅作示範
      setTimeout(() => {
        showToast('成功', '基本設定已儲存', 'success');
        hideLoading();
      }, 1000);
    }
    
    // 儲存收據設定
    function saveReceiptSettings() {
      const formData = {
        receipt_prefix: $('#receiptPrefix').val(),
        receipt_start_number: $('#receiptStartNumber').val(),
        receipt_template: $('#receiptTemplate').val(),
        receipt_footer: $('#receiptFooter').val(),
        auto_send_receipt: $('#autoSendReceipt').is(':checked')
      };
      
      // 處理簽名圖片上傳
      const signatureFile = $('#receiptSignature').get(0).files[0];
      
      showLoading();
      
      // 在實際應用中，這裡應該上傳簽名圖片並提交表單
      // 這裡僅作示範
      setTimeout(() => {
        showToast('成功', '收據設定已儲存', 'success');
        hideLoading();
      }, 1000);
    }
    
    // 儲存郵件設定
    function saveEmailSettings() {
      const formData = {
        email_sender_name: $('#emailSender').val(),
        email_subject_prefix: $('#emailSubjectPrefix').val(),
        receipt_email_template: $('#receiptEmailTemplate').val(),
        email_signature: $('#emailSignature').val()
      };
      
      showLoading();
      
      apiRequest('saveEmailSettings', { data: formData })
        .then(response => {
          if (response.success) {
            showToast('成功', '郵件設定已儲存', 'success');
          } else {
            showToast('錯誤', '儲存郵件設定失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('儲存郵件設定失敗:', error);
          showToast('錯誤', '儲存郵件設定失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 儲存自動備份設定
    function saveAutoBackupSettings() {
      const formData = {
        enable_auto_backup: $('#enableAutoBackup').is(':checked'),
        backup_frequency: $('#backupFrequency').val(),
        backup_retention: $('#backupRetention').val()
      };
      
      showLoading();
      
      apiRequest('saveAutoBackupSettings', { data: formData })
        .then(response => {
          if (response.success) {
            showToast('成功', '自動備份設定已儲存', 'success');
          } else {
            showToast('錯誤', '儲存自動備份設定失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('儲存自動備份設定失敗:', error);
          showToast('錯誤', '儲存自動備份設定失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 新增類別
    function addCategory(type, category) {
      showLoading();
      
      apiRequest('addCategory', { 
        type, 
        category 
      })
        .then(response => {
          if (response.success) {
            showToast('成功', '類別已新增', 'success');
            
            // 更新類別列表
            const listId = type === 'income' ? 'incomeCategoriesList' : 'expenseCategoriesList';
            const inputId = type === 'income' ? 'newIncomeCategory' : 'newExpenseCategory';
            
            const newItem = `
              <div class="list-group-item d-flex justify-content-between align-items-center">
                ${category}
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${type}', '${category}')">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            `;
            
            $(`#${listId}`).append(newItem);
            $(`#${inputId}`).val('');
          } else {
            showToast('錯誤', '新增類別失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('新增類別失敗:', error);
          showToast('錯誤', '新增類別失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 刪除類別
    function deleteCategory(type, category) {
      if (confirm(`確定要刪除「${category}」類別嗎？此操作可能會影響已使用此類別的交易記錄。`)) {
        showLoading();
        
        apiRequest('deleteCategory', { 
          type, 
          category 
        })
          .then(response => {
            if (response.success) {
              showToast('成功', '類別已刪除', 'success');
              
              // 更新類別列表
              const listId = type === 'income' ? 'incomeCategoriesList' : 'expenseCategoriesList';
              $(`#${listId} .list-group-item`).each(function() {
                if ($(this).text().trim() === category) {
                  $(this).remove();
                }
              });
            } else {
              showToast('錯誤', '刪除類別失敗: ' + response.error, 'danger');
            }
            hideLoading();
          })
          .catch(error => {
            console.error('刪除類別失敗:', error);
            showToast('錯誤', '刪除類別失敗，請檢查網路連線', 'danger');
            hideLoading();
          });
      }
    }
    
    // 備份資料
    function backupData() {
      showLoading();
      
      apiRequest('backupData', {})
        .then(response => {
          if (response.success) {
            showToast('成功', '資料備份已完成', 'success');
            
            // 提供下載連結
            if (response.data && response.data.fileUrl) {
              window.open(response.data.fileUrl, '_blank');
            }
          } else {
            showToast('錯誤', '資料備份失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('資料備份失敗:', error);
          showToast('錯誤', '資料備份失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 還原資料
    function restoreData() {
      const file = $('#restoreFile').get(0).files[0];
      if (!file) {
        showToast('警告', '請選擇備份檔案', 'warning');
        return;
      }
      
      if (confirm('警告：還原資料將會覆蓋目前的所有資料，確定要繼續嗎？')) {
        showLoading();
        
        // 在實際應用中，這裡應該上傳備份檔案並還原資料
        // 這裡僅作示範
        setTimeout(() => {
          showToast('成功', '資料已還原', 'success');
          hideLoading();
          
          // 重新載入頁面
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        }, 2000);
      }
    }
    
    // 載入使用者個人資料
    function loadProfile() {
      apiRequest('getUserProfile', {})
        .then(response => {
          if (response.success) {
            renderProfile(response.data);
          } else {
            showToast('錯誤', '無法載入使用者資料: ' + response.error, 'danger');
            $('#pageContent').html('<div class="alert alert-danger">載入使用者資料失敗</div>');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('載入使用者資料失敗:', error);
          showToast('錯誤', '載入使用者資料失敗，請檢查網路連線', 'danger');
          $('#pageContent').html('<div class="alert alert-danger">載入使用者資料失敗，請檢查網路連線</div>');
          hideLoading();
        });
    }
    
    // 渲染使用者個人資料
    function renderProfile(profile) {
      const html = `
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">個人資料</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3 text-center mb-4">
                <div class="avatar-container mb-3">
                  <img src="${profile.avatar_url || 'images/default-avatar.png'}" alt="頭像" class="rounded-circle img-thumbnail" style="width: 150px; height: 150px; object-fit: cover;">
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" id="btnChangeAvatar">
                  <i class="fas fa-camera"></i> 更換頭像
                </button>
                <input type="file" id="avatarUpload" style="display: none;" accept="image/*">
              </div>
              
              <div class="col-md-9">
                <form id="profileForm">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="displayName" class="form-label">顯示名稱</label>
                      <input type="text" class="form-control" id="displayName" name="display_name" value="${profile.display_name || ''}">
                    </div>
                    <div class="col-md-6">
                      <label for="email" class="form-label">電子郵件</label>
                      <input type="email" class="form-control" id="email" name="email" value="${profile.email || ''}" readonly>
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="phone" class="form-label">聯絡電話</label>
                      <input type="tel" class="form-control" id="phone" name="phone" value="${profile.phone || ''}">
                    </div>
                    <div class="col-md-6">
                      <label for="position" class="form-label">職位</label>
                      <input type="text" class="form-control" id="position" name="position" value="${profile.position || ''}">
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="bio" class="form-label">個人簡介</label>
                    <textarea class="form-control" id="bio" name="bio" rows="3">${profile.bio || ''}</textarea>
                  </div>
                  
                  <button type="submit" class="btn btn-primary">儲存個人資料</button>
                </form>
                
                <hr class="my-4">
                
                <h6>變更密碼</h6>
                <form id="passwordForm">
                  <div class="mb-3">
                    <label for="currentPassword" class="form-label">目前密碼</label>
                    <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                  </div>
                  
                  <div class="mb-3">
                    <label for="newPassword" class="form-label">新密碼</label>
                    <input type="password" class="form-control" id="newPassword" name="new_password" required>
                  </div>
                  
                  <div class="mb-3">
                    <label for="confirmPassword" class="form-label">確認新密碼</label>
                    <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
                  </div>
                  
                  <button type="submit" class="btn btn-warning">變更密碼</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      `;
      
      $('#pageContent').html(html);
      
      // 更換頭像按鈕點擊事件
      $('#btnChangeAvatar').click(function() {
        $('#avatarUpload').click();
      });
      
      // 頭像上傳事件
      $('#avatarUpload').change(function() {
        const file = $(this).get(0).files[0];
        if (file) {
          uploadAvatar(file);
        }
      });
      
      // 個人資料表單提交
      $('#profileForm').submit(function(e) {
        e.preventDefault();
        saveProfile();
      });
      
      // 密碼表單提交
      $('#passwordForm').submit(function(e) {
        e.preventDefault();
        changePassword();
      });
    }
    
    // 上傳頭像
    function uploadAvatar(file) {
      showLoading();
      
      // 在實際應用中，這裡應該上傳頭像檔案
      // 這裡僅作示範
      setTimeout(() => {
        showToast('成功', '頭像已更新', 'success');
        
        // 更新頭像預覽
        const reader = new FileReader();
        reader.onload = function(e) {
          $('.avatar-container img').attr('src', e.target.result);
        };
        reader.readAsDataURL(file);
        
        hideLoading();
      }, 1000);
    }
    
    // 儲存個人資料
    function saveProfile() {
      const formData = {
        display_name: $('#displayName').val(),
        phone: $('#phone').val(),
        position: $('#position').val(),
        bio: $('#bio').val()
      };
      
      showLoading();
      
      apiRequest('updateUserProfile', { data: formData })
        .then(response => {
          if (response.success) {
            showToast('成功', '個人資料已更新', 'success');
            
            // 更新頁面頂部的使用者名稱
            $('#navbarUserName').text(formData.display_name);
          } else {
            showToast('錯誤', '更新個人資料失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('更新個人資料失敗:', error);
          showToast('錯誤', '更新個人資料失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 變更密碼
    function changePassword() {
      const currentPassword = $('#currentPassword').val();
      const newPassword = $('#newPassword').val();
      const confirmPassword = $('#confirmPassword').val();
      
      // 檢查新密碼是否相符
      if (newPassword !== confirmPassword) {
        showToast('警告', '新密碼與確認密碼不相符', 'warning');
        return;
      }
      
      showLoading();
      
      apiRequest('changePassword', { 
        current_password: currentPassword,
        new_password: newPassword
      })
        .then(response => {
          if (response.success) {
            showToast('成功', '密碼已變更', 'success');
            
            // 清空表單
            $('#passwordForm').trigger('reset');
          } else {
            showToast('錯誤', '變更密碼失敗: ' + response.error, 'danger');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('變更密碼失敗:', error);
          showToast('錯誤', '變更密碼失敗，請檢查網路連線', 'danger');
          hideLoading();
        });
    }
    
    // 載入登入頁面
    function loadLogin() {
      // 隱藏側邊欄和頂部導航
      $('#sidebar, #topNav').hide();
      
      const html = `
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
              <div class="card shadow-lg border-0 rounded-lg mt-5">
                <div class="card-header bg-primary text-white text-center">
                  <h3 class="my-3">NGO 會計管理系統</h3>
                </div>
                <div class="card-body">
                  <form id="loginForm">
                    <div class="mb-3">
                      <label for="email" class="form-label">電子郵件</label>
                      <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                      <label for="password" class="form-label">密碼</label>
                      <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="form-check mb-3">
                      <input class="form-check-input" type="checkbox" id="rememberMe" name="remember_me">
                      <label class="form-check-label" for="rememberMe">記住我</label>
                    </div>
                    <div class="d-grid">
                      <button type="submit" class="btn btn-primary">登入</button>
                    </div>
                  </form>
                </div>
                <div class="card-footer text-center py-3">
                  <a href="#forgot-password" class="text-decoration-none">忘記密碼？</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      $('#content').html(html);
      
      // 登入表單提交
      $('#loginForm').submit(function(e) {
        e.preventDefault();
        
        const email = $('#email').val();
        const password = $('#password').val();
        const rememberMe = $('#rememberMe').is(':checked');
        
        showLoading();
        
        // 在實際應用中，這裡應該調用 API 進行身份驗證
        // 這裡僅作示範
        setTimeout(() => {
          // 假設登入成功
          if (email === 'admin@example.com' && password === 'password') {
            showToast('成功', '登入成功', 'success');
            
            // 儲存使用者資訊
            currentUser = {
              id: 1,
              email: email,
              display_name: '管理員',
              role: 'admin'
            };
            
            // 顯示側邊欄和頂部導航
            $('#sidebar, #topNav').show();
            
            // 導航到首頁
            window.location.hash = '#dashboard';
          } else {
            showToast('錯誤', '電子郵件或密碼錯誤', 'danger');
          }
          
          hideLoading();
        }, 1000);
      });
    }
    
    // 載入忘記密碼頁面
    function loadForgotPassword() {
      // 隱藏側邊欄和頂部導航
      $('#sidebar, #topNav').hide();
      
      const html = `
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
              <div class="card shadow-lg border-0 rounded-lg mt-5">
                <div class="card-header bg-primary text-white text-center">
                  <h3 class="my-3">重設密碼</h3>
                </div>
                <div class="card-body">
                  <div class="mb-3 text-center">
                    <p>請輸入您的電子郵件地址，我們將發送密碼重設連結給您。</p>
                  </div>
                  <form id="forgotPasswordForm">
                    <div class="mb-3">
                      <label for="email" class="form-label">電子郵件</label>
                      <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="d-grid">
                      <button type="submit" class="btn btn-primary">發送重設連結</button>
                    </div>
                  </form>
                </div>
                <div class="card-footer text-center py-3">
                  <a href="#login" class="text-decoration-none">返回登入</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      $('#content').html(html);
      
      // 忘記密碼表單提交
      $('#forgotPasswordForm').submit(function(e) {
        e.preventDefault();
        
        const email = $('#email').val();
        
        showLoading();
        
        // 在實際應用中，這裡應該調用 API 發送重設密碼郵件
        // 這裡僅作示範
        setTimeout(() => {
          showToast('成功', '密碼重設連結已發送至您的電子郵件', 'success');
          
          // 導航回登入頁面
          setTimeout(() => {
            window.location.hash = '#login';
          }, 2000);
          
          hideLoading();
        }, 1000);
      });
    }
    
    // 初始化應用程式
    function initApp() {
      // 檢查是否已登入
      if (!currentUser) {
        // 未登入，導向登入頁面
        window.location.hash = '#login';
      }
      
      // 設定路由處理
      $(window).on('hashchange', function() {
        routeChange();
      });
      
      // 初始路由處理
      routeChange();
      
      // 綁定登出按鈕點擊事件
      $('#btnLogout').click(function() {
        logout();
      });
    }
    
    // 登出
    function logout() {
      if (confirm('確定要登出嗎？')) {
        showLoading();
        
        // 在實際應用中，這裡應該調用 API 進行登出處理
        // 這裡僅作示範
        setTimeout(() => {
          // 清除使用者資訊
          currentUser = null;
          
          showToast('成功', '您已成功登出', 'success');
          
          // 導航到登入頁面
          window.location.hash = '#login';
          
          hideLoading();
        }, 1000);
      }
    }
    
    // 路由變更處理
    function routeChange() {
      const hash = window.location.hash || '#dashboard';
      
      // 登入相關路由特殊處理
      if (hash === '#login' || hash === '#forgot-password') {
        if (hash === '#login') {
          loadLogin();
        } else if (hash === '#forgot-password') {
          loadForgotPassword();
        }
        return;
      }
      
      // 檢查是否已登入
      if (!currentUser) {
        window.location.hash = '#login';
        return;
      }
      
      // 顯示側邊欄和頂部導航
      $('#sidebar, #topNav').show();
      
      // 設定活動選單項目
      $('.nav-link').removeClass('active');
      $(`.nav-link[href="${hash.split('/')[0]}"]`).addClass('active');
      
      showLoading();
      
      // 根據路由載入對應頁面
      if (hash === '#dashboard') {
        loadDashboard();
      } else if (hash === '#transactions') {
        loadTransactions();
      } else if (hash.startsWith('#transactions/new')) {
        loadTransactionForm();
      } else if (hash.startsWith('#transactions/edit/')) {
        const id = hash.split('/')[2];
        loadTransactionForm(id);
      } else if (hash === '#accounts') {
        loadAccounts();
      } else if (hash.startsWith('#accounts/new')) {
        loadAccountForm();
      } else if (hash.startsWith('#accounts/edit/')) {
        const id = hash.split('/')[2];
        loadAccountForm(id);
      } else if (hash === '#receipts') {
        loadReceipts();
      } else if (hash.startsWith('#receipts/new')) {
        loadReceiptForm();
      } else if (hash.startsWith('#receipts/view/')) {
        const receiptNumber = hash.split('/')[2];
        loadReceiptDetails(receiptNumber);
      } else if (hash === '#vouchers') {
        loadVouchers();
      } else if (hash.startsWith('#vouchers/new')) {
        loadVoucherForm();
      } else if (hash === '#members') {
        loadMembers();
      } else if (hash.startsWith('#members/new')) {
        loadMemberForm();
      } else if (hash.startsWith('#members/edit/')) {
        const id = hash.split('/')[2];
        loadMemberForm(id);
      } else if (hash === '#reports') {
        loadReports();
      } else if (hash === '#settings') {
        loadSettings();
      } else if (hash === '#profile') {
        loadProfile();
      } else {
        // 無效路由，導向首頁
        window.location.hash = '#dashboard';
      }
    }
    
    // 當文件準備就緒時初始化應用程式
    $(document).ready(function() {
      // 載入系統設定
      apiRequest('getSystemSettings', {})
        .then(response => {
          if (response.success) {
            systemSettings = response.data;
          }
          
          // 初始化應用程式
          initApp();
        })
        .catch(error => {
          console.error('載入系統設定失敗:', error);
          // 初始化應用程式
          initApp();
        });
    });
  </script>
</body>
</html>






