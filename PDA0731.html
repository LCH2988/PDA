<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會 - 會計管理系統</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <!-- SweetAlert2 -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <style>
      :root {
          --primary-color: #2c5aa0;
          --secondary-color: #f8f9fa;
          --success-color: #198754;
          --danger-color: #dc3545;
          --warning-color: #ffc107;
      }

      body {
          background-color: var(--secondary-color);
          font-family: 'Microsoft JhengHei', sans-serif;
      }

      .navbar-brand {
          font-weight: bold;
          color: var(--primary-color) !important;
      }

      .card {
          border: none;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          transition: transform 0.2s;
      }

      .card:hover {
          transform: translateY(-2px);
      }

      .stat-card {
          background: linear-gradient(135deg, var(--primary-color), #4a90e2);
          color: white;
          border-radius: 15px;
      }

      .stat-card h3 {
          font-size: 2.5rem;
          font-weight: bold;
      }

      .btn-primary {
          background-color: var(--primary-color);
          border-color: var(--primary-color);
      }

      .btn-primary:hover {
          background-color: #1e3d6f;
          border-color: #1e3d6f;
      }

      .table th {
          background-color: var(--secondary-color);
          font-weight: 600;
          border-top: none;
      }

      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }

      .loading-spinner {
          color: white;
          font-size: 3rem;
      }

      .sidebar {
          min-height: 100vh;
          background: linear-gradient(180deg, var(--primary-color), #1e3d6f);
      }

      .sidebar .nav-link {
          color: rgba(255,255,255,0.8);
          padding: 12px 20px;
          border-radius: 8px;
          margin: 4px 0;
          transition: all 0.3s;
      }

      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
          color: white;
          background-color: rgba(255,255,255,0.1);
      }

      .main-content {
          padding: 20px;
      }

      .spin {
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .api-status {
          position: fixed;
          bottom: 20px;
          right: 20px;
          z-index: 1000;
      }

      .connection-indicator {
          display: inline-flex;
          align-items: center;
          padding: 8px 12px;
          border-radius: 20px;
          font-size: 0.875rem;
          font-weight: 500;
      }

      .connection-indicator.connected {
          background-color: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .connection-indicator.disconnected {
          background-color: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .connection-indicator.syncing {
          background-color: #fff3cd;
          color: #856404;
          border: 1px solid #ffeaa7;
      }
  </style>
</head>
<body>
  <!-- 載入中覆蓋層 -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
      <div class="text-center">
          <div class="loading-spinner">
              <i class="bi bi-arrow-clockwise spin"></i>
          </div>
          <div class="text-white mt-3">載入中...</div>
      </div>
  </div>

  <!-- API 連接狀態指示器 -->
  <div id="apiStatus" class="api-status">
      <div class="connection-indicator disconnected" id="connectionIndicator">
          <i class="bi bi-wifi-off me-2"></i>
          <span id="connectionText">未連接</span>
      </div>
  </div>

  <!-- 導航列 -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
      <div class="container-fluid">
          <a class="navbar-brand" href="#">
              <i class="bi bi-heart-pulse me-2"></i>
              台灣帕金森病友權益促進會
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
              <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav ms-auto">
                  <li class="nav-item">
                      <button class="btn btn-outline-primary me-2" onclick="syncData()">
                          <i class="bi bi-arrow-clockwise"></i> 同步資料
                      </button>
                  </li>
                  <li class="nav-item dropdown">
                      <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                          <i class="bi bi-gear"></i> 系統
                      </a>
                      <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="#" onclick="showApiSettings()">
                              <i class="bi bi-cloud"></i> API 設定
                          </a></li>
                          <li><a class="dropdown-item" href="#" onclick="showSystemSettings()">
                              <i class="bi bi-gear-fill"></i> 系統設定
                          </a></li>
                          <li><hr class="dropdown-divider"></li>
                          <li><a class="dropdown-item" href="#" onclick="testConnection()">
                              <i class="bi bi-wifi"></i> 測試連接
                          </a></li>
                      </ul>
                  </li>
              </ul>
          </div>
      </div>
  </nav>

  <div class="container-fluid">
      <div class="row">
          <!-- 側邊欄 -->
          <div class="col-md-2 sidebar text-white p-0">
              <div class="p-3">
                  <h6 class="text-center mb-4">會計管理系統</h6>
                  <nav class="nav flex-column">
                      <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                          <i class="bi bi-speedometer2 me-2"></i>儀表板
                      </a>
                      <a class="nav-link" href="#" onclick="showSection('transactions')">
                          <i class="bi bi-receipt me-2"></i>交易記錄
                      </a>
                      <a class="nav-link" href="#" onclick="showSection('members')">
                          <i class="bi bi-people me-2"></i>會員管理
                      </a>
                      <a class="nav-link" href="#" onclick="showSection('analytics')">
                          <i class="bi bi-graph-up me-2"></i>統計分析
                      </a>
                      <a class="nav-link" href="#" onclick="showSection('reports')">
                          <i class="bi bi-file-earmark-text me-2"></i>報表
                      </a>
                  </nav>
              </div>
          </div>

          <!-- 主要內容區 -->
          <div class="col-md-10 main-content">
              <!-- 儀表板 -->
              <div id="dashboardSection" class="content-section">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                      <h2><i class="bi bi-speedometer2"></i> 儀表板</h2>
                      <div>
                          <button class="btn btn-primary me-2" onclick="showTransactionModal()">
                              <i class="bi bi-plus-circle"></i> 新增交易
                          </button>
                          <button class="btn btn-success" onclick="showMemberModal()">
                              <i class="bi bi-person-plus"></i> 新增會員
                          </button>
                      </div>
                  </div>

                  <!-- 統計卡片 -->
                  <div class="row mb-4">
                      <div class="col-md-3 mb-3">
                          <div class="card stat-card">
                              <div class="card-body text-center">
                                  <i class="bi bi-cash-coin display-4 mb-2"></i>
                                  <h3 id="totalIncome">$0</h3>
                                  <p class="mb-0">總收入</p>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-3 mb-3">
                          <div class="card stat-card">
                              <div class="card-body text-center">
                                  <i class="bi bi-credit-card display-4 mb-2"></i>
                                  <h3 id="totalExpense">$0</h3>
                                  <p class="mb-0">總支出</p>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-3 mb-3">
                          <div class="card stat-card">
                              <div class="card-body text-center">
                                  <i class="bi bi-people display-4 mb-2"></i>
                                  <h3 id="totalMembers">0</h3>
                                  <p class="mb-0">會員總數</p>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-3 mb-3">
                          <div class="card stat-card">
                              <div class="card-body text-center">
                                  <i class="bi bi-exclamation-triangle display-4 mb-2"></i>
                                  <h3 id="overdueMembers">0</h3>
                                  <p class="mb-0">逾期會費</p>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- 最近交易和會員 -->
                  <div class="row">
                      <div class="col-md-6">
                          <div class="card">
                              <div class="card-header">
                                  <h5><i class="bi bi-clock-history"></i> 最近交易</h5>
                              </div>
                              <div class="card-body">
                                  <div id="recentTransactions">
                                      <div class="text-center text-muted">
                                          <i class="bi bi-receipt display-4"></i>
                                          <p>尚無交易記錄</p>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="card">
                              <div class="card-header">
                                  <h5><i class="bi bi-person-plus"></i> 新加入會員</h5>
                              </div>
                              <div class="card-body">
                                  <div id="recentMembers">
                                      <div class="text-center text-muted">
                                          <i class="bi bi-people display-4"></i>
                                          <p>尚無會員資料</p>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 交易記錄區 -->
              <div id="transactionsSection" class="content-section" style="display: none;">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                      <h2><i class="bi bi-receipt"></i> 交易記錄</h2>
                      <div>
                          <button class="btn btn-primary" onclick="showTransactionModal()">
                              <i class="bi bi-plus-circle"></i> 新增交易
                          </button>
                      </div>
                  </div>

                  <!-- 交易記錄表格 -->
                  <div class="card">
                      <div class="card-body">
                          <div class="table-responsive">
                              <table class="table table-hover">
                                  <thead>
                                      <tr>
                                          <th>日期</th>
                                          <th>類型</th>
                                          <th>類別</th>
                                          <th>金額</th>
                                          <th>對象</th>
                                          <th>說明</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody id="transactionTableBody">
                                      <tr>
                                          <td colspan="7" class="text-center py-4">
                                              <i class="bi bi-receipt display-4 text-muted"></i>
                                              <div class="mt-2">尚無交易記錄</div>
                                          </td>
                                      </tr>
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 會員管理區 -->
              <div id="membersSection" class="content-section" style="display: none;">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                      <h2><i class="bi bi-people"></i> 會員管理</h2>
                      <button class="btn btn-success" onclick="showMemberModal()">
                          <i class="bi bi-person-plus"></i> 新增會員
                      </button>
                  </div>

                  <!-- 會員列表 -->
                  <div class="card">
                      <div class="card-body">
                          <div class="table-responsive">
                              <table class="table table-hover">
                                  <thead>
                                      <tr>
                                          <th>會員資料</th>
                                          <th>聯絡方式</th>
                                          <th>加入日期</th>
                                          <th>狀態</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody id="memberTableBody">
                                      <tr>
                                          <td colspan="5" class="text-center py-4">
                                              <i class="bi bi-people display-4 text-muted"></i>
                                              <div class="mt-2">尚無會員資料</div>
                                          </td>
                                      </tr>
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 其他區段（統計分析、報表）保持簡化版本 -->
              <div id="analyticsSection" class="content-section" style="display: none;">
                  <h2><i class="bi bi-graph-up"></i> 統計分析</h2>
                  <div class="alert alert-info">
                      <i class="bi bi-info-circle"></i> 統計分析功能開發中...
                  </div>
              </div>

              <div id="reportsSection" class="content-section" style="display: none;">
                  <h2><i class="bi bi-file-earmark-text"></i> 報表</h2>
                  <div class="alert alert-info">
                      <i class="bi bi-info-circle"></i> 報表功能開發中...
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- 交易記錄模態框 -->
  <div class="modal fade" id="transactionModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="bi bi-receipt"></i>
                      <span id="transactionModalTitle">新增交易記錄</span>
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="transactionForm">
                      <input type="hidden" id="transactionId">
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="date" class="form-label">日期 *</label>
                                  <input type="date" class="form-control" id="date" required>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="type" class="form-label">類型 *</label>
                                  <select class="form-select" id="type" required>
                                      <option value="">請選擇</option>
                                      <option value="收入">收入</option>
                                      <option value="支出">支出</option>
                                  </select>
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="category" class="form-label">類別 *</label>
                                  <select class="form-select" id="category" required>
                                      <option value="">請先選擇類型</option>
                                  </select>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="amount" class="form-label">金額 *</label>
                                  <input type="number" class="form-control" id="amount" required min="0" step="1">
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="counterparty" class="form-label">對象</label>
                                  <input type="text" class="form-control" id="counterparty">
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="account" class="form-label">帳戶</label>
                                  <select class="form-select" id="account">
                                      <option value="現金">現金</option>
                                      <option value="銀行">銀行</option>
                                      <option value="支票">支票</option>
                                      <option value="信用卡">信用卡</option>
                                  </select>
                              </div>
                          </div>
                      </div>
                      <div class="mb-3">
                          <label for="description" class="form-label">說明</label>
                          <textarea class="form-control" id="description" rows="3"></textarea>
                      </div>
                      <div class="mb-3">
                          <label for="receiptNumber" class="form-label">收據編號</label>
                          <input type="text" class="form-control" id="receiptNumber" placeholder="自動生成">
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="saveTransaction()">
                      <i class="bi bi-save"></i> 儲存
                  </button>
              </div>
          </div>
      </div>
  </div>

  <!-- 會員模態框 -->
  <div class="modal fade" id="memberModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="bi bi-person"></i>
                      <span id="memberModalTitle">新增會員</span>
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="memberForm">
                      <input type="hidden" id="memberId">
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="memberName" class="form-label">姓名 *</label>
                                  <input type="text" class="form-control" id="memberName" required>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="memberPhone" class="form-label">電話 *</label>
                                  <input type="tel" class="form-control" id="memberPhone" required>
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="memberEmail" class="form-label">電子郵件</label>
                                  <input type="email" class="form-control" id="memberEmail">
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="memberJoinDate" class="form-label">加入日期 *</label>
                                  <input type="date" class="form-control" id="memberJoinDate" required>
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="memberStatus" class="form-label">會員狀態</label>
                                  <select class="form-select" id="memberStatus">
                                      <option value="active">正常</option>
                                      <option value="inactive">停權</option>
                                      <option value="pending">待審核</option>
                                  </select>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="membershipFee" class="form-label">年費金額</label>
                                  <input type="number" class="form-control" id="membershipFee" value="1000" min="0">
                              </div>
                          </div>
                      </div>
                      <div class="mb-3">
                          <label for="memberAddress" class="form-label">地址</label>
                          <textarea class="form-control" id="memberAddress" rows="3"></textarea>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-success" onclick="saveMember()">
                      <i class="bi bi-save"></i> 儲存
                  </button>
              </div>
          </div>
      </div>
  </div>

  <!-- API 設定模態框 -->
  <div class="modal fade" id="apiSettingsModal" tabindex="-1">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="bi bi-cloud"></i> API 設定
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <div class="mb-3">
                      <label for="gasApiUrl" class="form-label">Google Apps Script Web App URL *</label>
                      <input type="url" class="form-control" id="gasApiUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
                      <div class="form-text">請輸入您的 Google Apps Script Web App 部署 URL</div>
                  </div>
                  <div class="mb-3">
                      <label for="spreadsheetId" class="form-label">Google 試算表 ID</label>
                      <input type="text" class="form-control" id="spreadsheetId" placeholder="試算表 ID">
                      <div class="form-text">可在試算表 URL 中找到 ID</div>
                  </div>
                  <div class="alert alert-info">
                      <i class="bi bi-info-circle"></i>
                      <strong>設定步驟：</strong>
                      <ol class="mb-0 mt-2">
                          <li>建立 Google Apps Script 專案</li>
                          <li>貼上提供的後端程式碼</li>
                          <li>部署為 Web App</li>
                          <li>將 Web App URL 貼到上方欄位</li>
                      </ol>
                  </div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="saveApiSettings()">
                      <i class="bi bi-save"></i> 儲存設定
                  </button>
              </div>
          </div>
      </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  (function() {
      'use strict';

      // 全域變數
      let transactions = [];
      let members = [];
      let settings = {
          organizationName: '台灣帕金森病友權益促進會',
          gasApiUrl: '',
          spreadsheetId: '',
          defaultMembershipFee: 1000,
          receiptPrefix: 'R'
      };

      // 收入和支出類別
      const categories = {
          收入: ['會費', '捐款', '活動收入', '政府補助', '利息收入', '其他收入'],
          支出: ['活動費用', '辦公費用', '交通費', '餐費', '場地費', '設備費', '印刷費', '郵電費', '保險費', '其他支出']
      };

      // 初始化
      document.addEventListener('DOMContentLoaded', function() {
          loadSettings();
          initializeSystem();
          if (settings.gasApiUrl) {
              loadDataFromAPI();
          }
          updateDashboard();
      });

      // 載入設定
      function loadSettings() {
          const savedSettings = localStorage.getItem('systemSettings');
          if (savedSettings) {
              settings = { ...settings, ...JSON.parse(savedSettings) };
          }
      }

      // 儲存設定
      function saveSettings() {
          localStorage.setItem('systemSettings', JSON.stringify(settings));
      }

      // 系統初始化
      function initializeSystem() {
          // 設定今天的日期為預設值
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('date').value = today;
          document.getElementById('memberJoinDate').value = today;

          // 設定類型變更事件
          document.getElementById('type').addEventListener('change', updateCategoryOptions);
      }

      // 修正後的 API 呼叫函數 - 使用 GET 請求避免 CORS 問題
      async function callGASAPI(action, data = {}) {
          if (!settings.gasApiUrl) {
              throw new Error('請先設定 Google Apps Script API URL');
          }

          updateConnectionStatus('syncing');

          try {
              // 使用 GET 請求和 URL 參數來避免 CORS 問題
              const params = new URLSearchParams({
                  action: action,
                  data: JSON.stringify(data)
              });
              
              const url = `${settings.gasApiUrl}?${params.toString()}`;
              
              const response = await fetch(url, {
                  method: 'GET',
                  mode: 'cors',
                  headers: {
                      'Accept': 'application/json',
                  }
              });

              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }

              const result = await response.json();
              
              if (result.success) {
                  updateConnectionStatus('connected');
                  return result;
              } else {
                  throw new Error(result.message || '未知錯誤');
              }
          } catch (error) {
              updateConnectionStatus('disconnected');
              console.error('API 呼叫失敗:', error);
              
              // 如果是 CORS 錯誤，嘗試使用 script tag 方法
              if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                  try {
                      return await callGASAPIWithScript(action, data);
                  } catch (scriptError) {
                      throw new Error('API 連接失敗，請檢查設定或網路連接');
                  }
              }
              
              throw error;
          }
      }

      // 使用 script tag 的方式呼叫 API（備用方法）
      function callGASAPIWithScript(action, data = {}) {
          return new Promise((resolve, reject) => {
              // 建立唯一的回調函數名稱
              const callbackName = 'gasCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
              
              // 建立全域回調函數
              window[callbackName] = function(result) {
                  // 清理
                  if (script.parentNode) {
                      document.head.removeChild(script);
                  }
                  delete window[callbackName];
                  
                  if (result && result.success) {
                      updateConnectionStatus('connected');
                      resolve(result);
                  } else {
                      updateConnectionStatus('disconnected');
                      reject(new Error(result ? result.message || '未知錯誤' : 'API 呼叫失敗'));
                  }
              };
              
              // 建立 script 標籤
              const script = document.createElement('script');
              const params = new URLSearchParams({
                  action: action,
                  data: JSON.stringify(data),
                  callback: callbackName
              });
              
              script.src = `${settings.gasApiUrl}?${params.toString()}`;
              script.onerror = function() {
                  // 清理
                  if (script.parentNode) {
                      document.head.removeChild(script);
                  }
                  delete window[callbackName];
                  updateConnectionStatus('disconnected');
                  reject(new Error('無法載入 API 腳本'));
              };
              
              // 設定超時
              setTimeout(() => {
                  if (window[callbackName]) {
                      if (script.parentNode) {
                          document.head.removeChild(script);
                      }
                      delete window[callbackName];
                      updateConnectionStatus('disconnected');
                      reject(new Error('API 呼叫超時'));
                  }
              }, 30000); // 30秒超時
              
              document.head.appendChild(script);
          });
      }

      // 更新連接狀態
      function updateConnectionStatus(status) {
          const indicator = document.getElementById('connectionIndicator');
          const text = document.getElementById('connectionText');
          const icon = indicator.querySelector('i');

          indicator.className = 'connection-indicator ' + status;
          
          switch (status) {
              case 'connected':
                  icon.className = 'bi bi-wifi me-2';
                  text.textContent = '已連接';
                  break;
              case 'disconnected':
                  icon.className = 'bi bi-wifi-off me-2';
                  text.textContent = '未連接';
                  break;
              case 'syncing':
                  icon.className = 'bi bi-arrow-clockwise spin me-2';
                  text.textContent = '同步中';
                  break;
          }
      }

      // 載入資料
      async function loadDataFromAPI() {
          try {
              showLoading();
              
              // 載入交易記錄
              try {
                  const transactionResult = await callGASAPI('getTransactions');
                  if (transactionResult.success) {
                      transactions = transactionResult.data || [];
                      console.log('成功載入', transactions.length, '筆交易記錄');
                  }
              } catch (error) {
                  console.warn('載入交易記錄失敗:', error);
              }

              // 載入會員資料
              try {
                  const memberResult = await callGASAPI('getMembers');
                  if (memberResult.success) {
                      members = memberResult.data || [];
                      console.log('成功載入', members.length, '筆會員資料');
                  }
              } catch (error) {
                  console.warn('載入會員資料失敗:', error);
              }

              // 載入系統設定
              try {
                  const settingsResult = await callGASAPI('getSettings');
                  if (settingsResult.success) {
                      settings = { ...settings, ...settingsResult.data };
                      console.log('成功載入系統設定');
                  }
              } catch (error) {
                  console.warn('載入系統設定失敗:', error);
              }

              // 更新介面
              updateDashboard();
              displayTransactions();
              displayMembers();
              
              showToast('success', `資料載入完成 - 交易: ${transactions.length} 筆, 會員: ${members.length} 人`);
              
          } catch (error) {
              console.error('載入資料失敗:', error);
              showToast('error', '載入資料失敗: ' + error.message);
              
              // 如果是初次使用，提供設定指引
              if (transactions.length === 0 && members.length === 0) {
                  setTimeout(() => {
                      Swal.fire({
                          title: '系統初始化',
                          text: '看起來這是第一次使用系統。請確認已在 Google Apps Script 中執行 initializeSpreadsheet 函數來建立必要的工作表。',
                          icon: 'info',
                          confirmButtonText: '我知道了'
                      });
                  }, 2000);
              }
              
          } finally {
              hideLoading();
          }
      }

      // 同步資料
      async function syncData() {
          await loadDataFromAPI();
      }

      // 測試連接
      async function testConnection() {
          try {
              showLoading();
              
              // 先嘗試簡單的測試請求
              const result = await callGASAPI('test');
              
              if (result.success) {
                  showToast('success', 'API 連接測試成功！');
                  
                  // 測試成功後嘗試載入基本資料
                  try {
                      await loadDataFromAPI();
                  } catch (loadError) {
                      console.warn('載入資料時發生警告:', loadError);
                      showToast('warning', '連接成功但載入資料時有問題，請檢查試算表設定');
                  }
              } else {
                  throw new Error(result.message || '測試失敗');
              }
              
          } catch (error) {
              console.error('連接測試失敗:', error);
              showToast('error', 'API 連接測試失敗: ' + error.message);
              
              // 提供故障排除建議
              setTimeout(() => {
                  Swal.fire({
                      title: '連接失敗',
                      html: `
                          <div class="text-start">
                              <p><strong>可能的原因：</strong></p>
                              <ul>
                                  <li>Google Apps Script Web App URL 不正確</li>
                                  <li>Web App 未正確部署</li>
                                  <li>Web App 權限設定錯誤</li>
                                  <li>試算表 ID 不正確</li>
                              </ul>
                              <p><strong>建議解決方案：</strong></p>
                              <ol>
                                  <li>重新檢查 Web App URL</li>
                                  <li>確認 Web App 部署時選擇「任何人」存取</li>
                                  <li>執行 initializeSpreadsheet 函數</li>
                                  <li>檢查 Google Apps Script 執行記錄</li>
                              </ol>
                          </div>
                      `,
                      icon: 'info',
                      confirmButtonText: '我知道了'
                  });
              }, 1000);
              
          } finally {
              hideLoading();
          }
      }

      // 顯示/隱藏載入中
      function showLoading() {
          document.getElementById('loadingOverlay').style.display = 'flex';
      }

      function hideLoading() {
          document.getElementById('loadingOverlay').style.display = 'none';
      }

      // 顯示區段
      function showSection(sectionName) {
          // 隱藏所有區段
          document.querySelectorAll('.content-section').forEach(section => {
              section.style.display = 'none';
          });

          // 移除所有導航連結的active類別
          document.querySelectorAll('.sidebar .nav-link').forEach(link => {
              link.classList.remove('active');
          });

          // 顯示選中的區段
          document.getElementById(sectionName + 'Section').style.display = 'block';

          // 添加active類別到對應的導航連結
          event.target.classList.add('active');

          // 根據區段執行特定操作
          switch(sectionName) {
              case 'dashboard':
                  updateDashboard();
                  break;
              case 'transactions':
                  displayTransactions();
                  break;
              case 'members':
                  displayMembers();
                  break;
          }
      }

      // 更新儀表板
      function updateDashboard() {
          // 計算統計數據
          const totalIncome = transactions
              .filter(t => t['類型'] === '收入')
              .reduce((sum, t) => sum + parseFloat(t['金額'] || 0), 0);

          const totalExpense = transactions
              .filter(t => t['類型'] === '支出')
              .reduce((sum, t) => sum + parseFloat(t['金額'] || 0), 0);

          const totalMembers = members.length;

          const overdueMembers = members.filter(m => {
              if (!m['最後繳費日期']) return true;
              const lastPayment = new Date(m['最後繳費日期']);
              const oneYearAgo = new Date();
              oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
              return lastPayment < oneYearAgo;
          }).length;

          // 更新統計卡片
          document.getElementById('totalIncome').textContent = '$' + totalIncome.toLocaleString();
          document.getElementById('totalExpense').textContent = '$' + totalExpense.toLocaleString();
          document.getElementById('totalMembers').textContent = totalMembers.toLocaleString();
          document.getElementById('overdueMembers').textContent = overdueMembers.toLocaleString();

          // 更新最近交易
          updateRecentTransactions();

          // 更新最近會員
          updateRecentMembers();
      }

      // 更新最近交易
      function updateRecentTransactions() {
          const recentTransactions = transactions
              .sort((a, b) => new Date(b['日期']) - new Date(a['日期']))
              .slice(0, 5);

          const container = document.getElementById('recentTransactions');
          
          if (recentTransactions.length === 0) {
              container.innerHTML = `
                  <div class="text-center text-muted">
                      <i class="bi bi-receipt display-4"></i>
                      <p>尚無交易記錄</p>
                  </div>
              `;
              return;
          }

          container.innerHTML = recentTransactions.map(transaction => `
              <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                  <div>
                      <strong>${transaction['類別']}</strong>
                      <br>
                      <small class="text-muted">${transaction['日期']} | ${transaction['對象'] || '無'}</small>
                  </div>
                  <div class="text-end">
                      <span class="badge ${transaction['類型'] === '收入' ? 'bg-success' : 'bg-danger'}">
                          ${transaction['類型'] === '收入' ? '+' : '-'}$${parseFloat(transaction['金額'] || 0).toLocaleString()}
                      </span>
                  </div>
              </div>
          `).join('');
      }

      // 更新最近會員
      function updateRecentMembers() {
          const recentMembers = members
              .sort((a, b) => new Date(b['加入日期']) - new Date(a['加入日期']))
              .slice(0, 5);

          const container = document.getElementById('recentMembers');
          
          if (recentMembers.length === 0) {
              container.innerHTML = `
                  <div class="text-center text-muted">
                      <i class="bi bi-people display-4"></i>
                      <p>尚無會員資料</p>
                  </div>
              `;
              return;
          }

          container.innerHTML = recentMembers.map(member => `
              <div class="d-flex align-items-center mb-2 p-2 border-bottom">
                  <div class="member-avatar me-3">
                      <i class="bi bi-person"></i>
                  </div>
                  <div class="flex-grow-1">
                      <strong>${member['姓名']}</strong>
                      <br>
                      <small class="text-muted">${member['加入日期']} 加入</small>
                  </div>
                  <div>
                      <span class="badge ${getStatusBadgeClass(member['狀態'])}">
                          ${getStatusText(member['狀態'])}
                      </span>
                  </div>
              </div>
          `).join('');
      }

      // 顯示交易記錄
      function displayTransactions() {
          const tbody = document.getElementById('transactionTableBody');
          
          if (transactions.length === 0) {
              tbody.innerHTML = `
                  <tr>
                      <td colspan="7" class="text-center py-4">
                          <i class="bi bi-receipt display-4 text-muted"></i>
                          <div class="mt-2">尚無交易記錄</div>
                          <button class="btn btn-primary mt-2" onclick="showTransactionModal()">
                              <i class="bi bi-plus-circle"></i> 新增第一筆交易
                          </button>
                      </td>
                  </tr>
              `;
              return;
          }

          // 排序（最新的在前）
          const sortedTransactions = transactions.sort((a, b) => new Date(b['日期']) - new Date(a['日期']));

          tbody.innerHTML = sortedTransactions.map(transaction => `
              <tr>
                  <td>${transaction['日期']}</td>
                  <td>
                      <span class="badge ${transaction['類型'] === '收入' ? 'bg-success' : 'bg-danger'}">
                          ${transaction['類型']}
                      </span>
                  </td>
                  <td>${transaction['類別']}</td>
                  <td class="text-end">
                      <strong class="${transaction['類型'] === '收入' ? 'text-success' : 'text-danger'}">
                          ${transaction['類型'] === '收入' ? '+' : '-'}$${parseFloat(transaction['金額'] || 0).toLocaleString()}
                      </strong>
                  </td>
                  <td>${transaction['對象'] || '-'}</td>
                  <td>${transaction['說明'] || '-'}</td>
                  <td>
                      <div class="btn-group">
                          <button class="btn btn-sm btn-outline-primary" onclick="editTransaction('${transaction['ID']}')" title="編輯">
                              <i class="bi bi-pencil"></i>
                          </button>
                          <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction('${transaction['ID']}')" title="刪除">
                              <i class="bi bi-trash"></i>
                          </button>
                      </div>
                  </td>
              </tr>
          `).join('');
      }

      // 顯示會員列表
      function displayMembers() {
          const tbody = document.getElementById('memberTableBody');
          
          if (members.length === 0) {
              tbody.innerHTML = `
                  <tr>
                      <td colspan="5" class="text-center py-4">
                          <i class="bi bi-people display-4 text-muted"></i>
                          <div class="mt-2">尚無會員資料</div>
                          <button class="btn btn-success mt-2" onclick="showMemberModal()">
                              <i class="bi bi-person-plus"></i> 新增第一位會員
                          </button>
                      </td>
                  </tr>
              `;
              return;
          }

          // 排序（最新加入的在前）
          const sortedMembers = members.sort((a, b) => new Date(b['加入日期']) - new Date(a['加入日期']));

          tbody.innerHTML = sortedMembers.map(member => `
              <tr>
                  <td>
                      <div class="d-flex align-items-center">
                          <div class="member-avatar me-3">
                              <i class="bi bi-person"></i>
                          </div>
                          <div>
                              <strong>${member['姓名']}</strong>
                              <br>
                              <small class="text-muted">ID: ${member['ID']}</small>
                          </div>
                      </div>
                  </td>
                  <td>
                      <div>
                          <i class="bi bi-telephone"></i> ${member['電話']}
                      </div>
                      ${member['電子郵件'] ? `<div><i class="bi bi-envelope"></i> ${member['電子郵件']}</div>` : ''}
                  </td>
                  <td>${member['加入日期']}</td>
                  <td>
                      <span class="badge ${getStatusBadgeClass(member['狀態'])}">
                          ${getStatusText(member['狀態'])}
                      </span>
                  </td>
                  <td>
                      <div class="btn-group">
                          <button class="btn btn-sm btn-outline-primary" onclick="editMember('${member['ID']}')" title="編輯">
                              <i class="bi bi-pencil"></i>
                          </button>
                          <button class="btn btn-sm btn-outline-danger" onclick="deleteMember('${member['ID']}')" title="刪除">
                              <i class="bi bi-trash"></i>
                          </button>
                      </div>
                  </td>
              </tr>
          `).join('');
      }

      // 顯示交易模態框
      function showTransactionModal(transactionId = null) {
          const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
          const form = document.getElementById('transactionForm');
          
          // 重置表單
          form.reset();
          document.getElementById('transactionId').value = '';
          
          if (transactionId) {
              // 編輯模式
              const transaction = transactions.find(t => t['ID'] === transactionId);
              if (transaction) {
                  document.getElementById('transactionModalTitle').textContent = '編輯交易記錄';
                  document.getElementById('transactionId').value = transaction['ID'];
                  document.getElementById('date').value = transaction['日期'];
                  document.getElementById('type').value = transaction['類型'];
                  updateCategoryOptions();
                  document.getElementById('category').value = transaction['類別'];
                  document.getElementById('amount').value = transaction['金額'];
                  document.getElementById('counterparty').value = transaction['對象'] || '';
                  document.getElementById('account').value = transaction['帳戶'] || '現金';
                  document.getElementById('description').value = transaction['說明'] || '';
                  document.getElementById('receiptNumber').value = transaction['收據編號'] || '';
              }
          } else {
              // 新增模式
              document.getElementById('transactionModalTitle').textContent = '新增交易記錄';
              document.getElementById('date').value = new Date().toISOString().split('T')[0];
              generateReceiptNumber();
          }
          
          modal.show();
      }

      // 顯示會員模態框
      function showMemberModal(memberId = null) {
          const modal = new bootstrap.Modal(document.getElementById('memberModal'));
          const form = document.getElementById('memberForm');
          
          // 重置表單
          form.reset();
          document.getElementById('memberId').value = '';
          
          if (memberId) {
              // 編輯模式
              const member = members.find(m => m['ID'] === memberId);
              if (member) {
                  document.getElementById('memberModalTitle').textContent = '編輯會員';
                  document.getElementById('memberId').value = member['ID'];
                  document.getElementById('memberName').value = member['姓名'];
                  document.getElementById('memberPhone').value = member['電話'];
                  document.getElementById('memberEmail').value = member['電子郵件'] || '';
                  document.getElementById('memberJoinDate').value = member['加入日期'];
                  document.getElementById('memberStatus').value = member['狀態'] || 'active';
                  document.getElementById('membershipFee').value = member['年費金額'] || settings.defaultMembershipFee;
                  document.getElementById('memberAddress').value = member['地址'] || '';
              }
          } else {
              // 新增模式
              document.getElementById('memberModalTitle').textContent = '新增會員';
              document.getElementById('memberJoinDate').value = new Date().toISOString().split('T')[0];
              document.getElementById('membershipFee').value = settings.defaultMembershipFee;
              document.getElementById('memberStatus').value = 'active';
          }
          
          modal.show();
      }

      // 更新類別選項
      function updateCategoryOptions() {
          const typeSelect = document.getElementById('type');
          const categorySelect = document.getElementById('category');
          const selectedType = typeSelect.value;
          
          categorySelect.innerHTML = '<option value="">請選擇類別</option>';
          
          if (selectedType && categories[selectedType]) {
              categories[selectedType].forEach(category => {
                  const option = document.createElement('option');
                  option.value = category;
                  option.textContent = category;
                  categorySelect.appendChild(option);
              });
          }
      }

      // 生成收據編號
      function generateReceiptNumber() {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          
          // 計算今日已有的收據數量
          const todayTransactions = transactions.filter(t => t['日期'] === today.toISOString().split('T')[0]);
          const sequence = String(todayTransactions.length + 1).padStart(3, '0');
          
          const receiptNumber = `${settings.receiptPrefix || 'R'}${year}${month}${day}${sequence}`;
          document.getElementById('receiptNumber').value = receiptNumber;
      }

      // 儲存交易
      async function saveTransaction() {
          const form = document.getElementById('transactionForm');
          
          if (!form.checkValidity()) {
              form.reportValidity();
              return;
          }

          const transactionId = document.getElementById('transactionId').value;
          const isEdit = !!transactionId;
          
          const transactionData = {
              'ID': isEdit ? transactionId : generateId(),
              '日期': document.getElementById('date').value,
              '類型': document.getElementById('type').value,
              '類別': document.getElementById('category').value,
              '金額': parseFloat(document.getElementById('amount').value),
              '對象': document.getElementById('counterparty').value,
              '帳戶': document.getElementById('account').value,
              '說明': document.getElementById('description').value,
              '收據編號': document.getElementById('receiptNumber').value,
              '憑證': '',
              '建立時間': isEdit ? (transactions.find(t => t['ID'] === transactionId)?.['建立時間'] || new Date().toISOString()) : new Date().toISOString(),
              '更新時間': new Date().toISOString()
          };

          try {
              showLoading();
              
              // 儲存到 Google Sheets
              await callGASAPI('saveTransaction', { transaction: transactionData });
              
              // 更新本地資料
              if (isEdit) {
                  const index = transactions.findIndex(t => t['ID'] === transactionId);
                  if (index !== -1) {
                      transactions[index] = transactionData;
                  }
              } else {
                  transactions.push(transactionData);
              }

              updateDashboard();
              displayTransactions();
              
              // 關閉模態框
              const modal = bootstrap.Modal.getInstance(document.getElementById('transactionModal'));
              modal.hide();
              
              showToast('success', isEdit ? '交易記錄已更新' : '交易記錄已新增');
          } catch (error) {
              showToast('error', '儲存失敗: ' + error.message);
          } finally {
              hideLoading();
          }
      }

      // 儲存會員
      async function saveMember() {
          const form = document.getElementById('memberForm');
          
          if (!form.checkValidity()) {
              form.reportValidity();
              return;
          }

          const memberId = document.getElementById('memberId').value;
          const isEdit = !!memberId;
          
          const memberData = {
              'ID': isEdit ? memberId : generateId(),
              '姓名': document.getElementById('memberName').value,
              '電話': document.getElementById('memberPhone').value,
              '電子郵件': document.getElementById('memberEmail').value,
              '出生日期': '',
              '性別': '',
              '身分證字號': '',
              '地址': document.getElementById('memberAddress').value,
              '緊急聯絡人': '',
              '緊急聯絡電話': '',
              '備註': '',
              '加入日期': document.getElementById('memberJoinDate').value,
              '狀態': document.getElementById('memberStatus').value,
              '會員類型': 'regular',
              '年費金額': parseFloat(document.getElementById('membershipFee').value),
              '最後繳費日期': '',
              '標籤': '',
              '建立時間': isEdit ? (members.find(m => m['ID'] === memberId)?.['建立時間'] || new Date().toISOString()) : new Date().toISOString()
          };

          try {
              showLoading();
              
              // 儲存到 Google Sheets
              await callGASAPI('saveMember', { member: memberData });
              
              // 更新本地資料
              if (isEdit) {
                  const index = members.findIndex(m => m['ID'] === memberId);
                  if (index !== -1) {
                      members[index] = memberData;
                  }
              } else {
                  members.push(memberData);
              }

              updateDashboard();
              displayMembers();
              
              // 關閉模態框
              const modal = bootstrap.Modal.getInstance(document.getElementById('memberModal'));
              modal.hide();
              
              showToast('success', isEdit ? '會員資料已更新' : '會員已新增');
          } catch (error) {
              showToast('error', '儲存失敗: ' + error.message);
          } finally {
              hideLoading();
          }
      }

      // 編輯交易
      function editTransaction(transactionId) {
          showTransactionModal(transactionId);
      }

      // 編輯會員
      function editMember(memberId) {
          showMemberModal(memberId);
      }

      // 刪除交易
      async function deleteTransaction(transactionId) {
          const result = await Swal.fire({
              title: '確認刪除',
              text: '您確定要刪除這筆交易記錄嗎？',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#dc3545',
              cancelButtonColor: '#6c757d',
              confirmButtonText: '刪除',
              cancelButtonText: '取消'
          });

          if (result.isConfirmed) {
              try {
                  showLoading();
                  
                  // 從 Google Sheets 刪除
                  await callGASAPI('deleteTransaction', { id: transactionId });
                  
                  // 從本地資料刪除
                  transactions = transactions.filter(t => t['ID'] !== transactionId);
                  
                  updateDashboard();
                  displayTransactions();
                  showToast('success', '交易記錄已刪除');
              } catch (error) {
                  showToast('error', '刪除失敗: ' + error.message);
              } finally {
                  hideLoading();
              }
          }
      }

      // 刪除會員
      async function deleteMember(memberId) {
          const result = await Swal.fire({
              title: '確認刪除',
              text: '您確定要刪除這位會員嗎？',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#dc3545',
              cancelButtonColor: '#6c757d',
              confirmButtonText: '刪除',
              cancelButtonText: '取消'
          });

          if (result.isConfirmed) {
              try {
                  showLoading();
                  
                  // 從 Google Sheets 刪除
                  await callGASAPI('deleteMember', { id: memberId });
                  
                  // 從本地資料刪除
                  members = members.filter(m => m['ID'] !== memberId);
                  
                  updateDashboard();
                  displayMembers();
                  showToast('success', '會員已刪除');
              } catch (error) {
                  showToast('error', '刪除失敗: ' + error.message);
              } finally {
                  hideLoading();
              }
          }
      }

      // 顯示 API 設定
      function showApiSettings() {
          const modal = new bootstrap.Modal(document.getElementById('apiSettingsModal'));
          
          // 載入現有設定
          document.getElementById('gasApiUrl').value = settings.gasApiUrl || '';
          document.getElementById('spreadsheetId').value = settings.spreadsheetId || '';
          
          modal.show();
      }

      // 改善的 API 設定儲存函數
      function saveApiSettings() {
          const gasApiUrl = document.getElementById('gasApiUrl').value.trim();
          const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
          
          if (!gasApiUrl) {
              showToast('error', '請輸入 Google Apps Script Web App URL');
              return;
          }
          
          // 驗證 URL 格式
          if (!gasApiUrl.includes('script.google.com/macros/s/') || !gasApiUrl.includes('/exec')) {
              showToast('error', 'URL 格式不正確，請確認是 Google Apps Script Web App URL');
              return;
          }
          
          settings.gasApiUrl = gasApiUrl;
          settings.spreadsheetId = spreadsheetId;
          
          saveSettings();
          
          const modal = bootstrap.Modal.getInstance(document.getElementById('apiSettingsModal'));
          modal.hide();
          
          showToast('success', 'API 設定已儲存');
          
          // 自動測試連接
          setTimeout(() => {
              testConnection();
          }, 1000);
      }

      // 系統設定相關函數
      function showSystemSettings() {
          Swal.fire({
              title: '系統設定',
              html: `
                  <div class="text-start">
                      <div class="mb-3">
                          <label class="form-label">組織名稱</label>
                          <input type="text" class="form-control" id="swal-orgName" value="${settings.organizationName || ''}">
                      </div>
                      <div class="mb-3">
                          <label class="form-label">預設年費金額</label>
                          <input type="number" class="form-control" id="swal-membershipFee" value="${settings.defaultMembershipFee || 1000}" min="0">
                      </div>
                      <div class="mb-3">
                          <label class="form-label">收據編號前綴</label>
                          <input type="text" class="form-control" id="swal-receiptPrefix" value="${settings.receiptPrefix || 'R'}" maxlength="5">
                      </div>
                  </div>
              `,
              showCancelButton: true,
              confirmButtonText: '儲存',
              cancelButtonText: '取消',
              preConfirm: () => {
                  return {
                      organizationName: document.getElementById('swal-orgName').value,
                      defaultMembershipFee: parseFloat(document.getElementById('swal-membershipFee').value),
                      receiptPrefix: document.getElementById('swal-receiptPrefix').value
                  };
              }
          }).then((result) => {
              if (result.isConfirmed) {
                  settings = { ...settings, ...result.value };
                  saveSettings();
                  showToast('success', '系統設定已儲存');
              }
          });
      }

      // 工具函數
      function generateId() {
          return Date.now().toString(36) + Math.random().toString(36).substr(2);
      }

      function getStatusBadgeClass(status) {
          switch (status) {
              case 'active': return 'bg-success';
              case 'inactive': return 'bg-danger';
              case 'pending': return 'bg-warning';
              default: return 'bg-secondary';
          }
      }

      function getStatusText(status) {
          switch (status) {
              case 'active': return '正常';
              case 'inactive': return '停權';
              case 'pending': return '待審核';
              default: return '未知';
          }
      }

      // 改善的錯誤處理
      function showToast(type, message) {
          const alertClass = type === 'success' ? 'alert-success' : 
                            type === 'warning' ? 'alert-warning' : 'alert-danger';
          const iconClass = type === 'success' ? 'bi-check-circle' : 
                           type === 'warning' ? 'bi-exclamation-triangle' : 'bi-exclamation-triangle';
          
          const toast = document.createElement('div');
          toast.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
          toast.style.cssText = 'top: 20px; right: 20px; z-index: 1055; min-width: 300px; max-width: 400px;';
          toast.innerHTML = `
              <i class="bi ${iconClass} me-2"></i>
              <span style="word-break: break-word;">${message}</span>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          
          document.body.appendChild(toast);
          
          // 自動移除
          setTimeout(() => {
              if (toast.parentNode) {
                  toast.parentNode.removeChild(toast);
              }
          }, type === 'error' ? 8000 : 5000); // 錯誤訊息顯示更久
      }

      // 匯出資料功能
      function exportData() {
          // 準備匯出資料
          const exportData = {
              transactions: transactions,
              members: members,
              settings: settings,
              exportDate: new Date().toISOString()
          };

          // 建立下載連結
          const dataStr = JSON.stringify(exportData, null, 2);
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          
          const link = document.createElement('a');
          link.href = URL.createObjectURL(dataBlob);
          link.download = `${settings.organizationName}_資料備份_${new Date().toISOString().split('T')[0]}.json`;
          link.click();
          
          showToast('success', '資料匯出完成');
      }

      // 匯入資料功能
      function importData() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          
          input.onchange = function(e) {
              const file = e.target.files[0];
              if (!file) return;
              
              const reader = new FileReader();
              reader.onload = function(e) {
                  try {
                      const importedData = JSON.parse(e.target.result);
                      
                      // 驗證資料格式
                      if (importedData.transactions && importedData.members) {
                          Swal.fire({
                              title: '確認匯入',
                              text: '這將會覆蓋現有的資料，您確定要繼續嗎？',
                              icon: 'warning',
                              showCancelButton: true,
                              confirmButtonColor: '#3085d6',
                              cancelButtonColor: '#d33',
                              confirmButtonText: '確認匯入',
                              cancelButtonText: '取消'
                          }).then((result) => {
                              if (result.isConfirmed) {
                                  transactions = importedData.transactions || [];
                                  members = importedData.members || [];
                                  if (importedData.settings) {
                                      settings = { ...settings, ...importedData.settings };
                                      saveSettings();
                                  }
                                  
                                  updateDashboard();
                                  displayTransactions();
                                  displayMembers();
                                  
                                  showToast('success', '資料匯入完成');
                              }
                          });
                      } else {
                          throw new Error('資料格式不正確');
                      }
                  } catch (error) {
                      showToast('error', '匯入失敗：' + error.message);
                  }
              };
              reader.readAsText(file);
          };
          
          input.click();
      }

      // 鍵盤快捷鍵
      document.addEventListener('keydown', function(e) {
          if (e.ctrlKey || e.metaKey) {
              switch(e.key) {
                  case 'n':
                      e.preventDefault();
                      showTransactionModal();
                      break;
                  case 'm':
                      e.preventDefault();
                      showMemberModal();
                      break;
                  case 's':
                      e.preventDefault();
                      if (document.getElementById('transactionModal').classList.contains('show')) {
                          saveTransaction();
                      } else if (document.getElementById('memberModal').classList.contains('show')) {
                          saveMember();
                      }
                      break;
                  case 'r':
                      e.preventDefault();
                      syncData();
                      break;
              }
          }
      });

      // 離線檢測
      window.addEventListener('online', function() {
          updateConnectionStatus('connected');
          showToast('success', '網路連接已恢復');
          if (settings.gasApiUrl) {
              syncData();
          }
      });

      window.addEventListener('offline', function() {
          updateConnectionStatus('disconnected');
          showToast('error', '網路連接中斷，將使用離線模式');
      });

      // 自動儲存功能（每5分鐘）
      setInterval(() => {
          if (settings.gasApiUrl && navigator.onLine) {
              console.log('自動同步中...');
              syncData().catch(error => {
                  console.error('自動同步失敗:', error);
              });
          }
      }, 5 * 60 * 1000); // 5分鐘

      // 頁面載入完成後的初始化
      window.addEventListener('load', function() {
          // 檢查網路狀態
          if (navigator.onLine) {
              updateConnectionStatus('connected');
          } else {
              updateConnectionStatus('disconnected');
          }

          // 顯示使用說明（首次使用）
          if (!localStorage.getItem('hasSeenWelcome')) {
              setTimeout(() => {
                  Swal.fire({
                      title: '歡迎使用會計管理系統',
                      html: `
                          <div class="text-start">
                              <p>這是一個專為非營利組織設計的會計管理系統。</p>
                              <h6>快速開始：</h6>
                              <ol>
                                  <li>點擊右上角的「系統」→「API 設定」</li>
                                  <li>設定您的 Google Apps Script Web App URL</li>
                                  <li>開始新增交易記錄和會員資料</li>
                              </ol>
                              <h6>鍵盤快捷鍵：</h6>
                              <ul>
                                  <li><kbd>Ctrl+N</kbd> 新增交易</li>
                                  <li><kbd>Ctrl+M</kbd> 新增會員</li>
                                  <li><kbd>Ctrl+R</kbd> 同步資料</li>
                                  <li><kbd>Ctrl+S</kbd> 儲存（在編輯時）</li>
                              </ul>
                          </div>
                      `,
                      icon: 'info',
                      confirmButtonText: '開始使用',
                      showCancelButton: true,
                      cancelButtonText: '稍後設定'
                  }).then((result) => {
                      if (result.isConfirmed) {
                          showApiSettings();
                      }
                  });
                  
                  localStorage.setItem('hasSeenWelcome', 'true');
              }, 1000);
          }
      });

      // 將函數綁定到全域範圍
      window.showSection = showSection;
      window.showTransactionModal = showTransactionModal;
      window.showMemberModal = showMemberModal;
      window.updateCategoryOptions = updateCategoryOptions;
      window.saveTransaction = saveTransaction;
      window.saveMember = saveMember;
      window.editTransaction = editTransaction;
      window.editMember = editMember;
      window.deleteTransaction = deleteTransaction;
      window.deleteMember = deleteMember;
      window.syncData = syncData;
      window.testConnection = testConnection;
      window.showApiSettings = showApiSettings;
      window.saveApiSettings = saveApiSettings;
      window.showSystemSettings = showSystemSettings;
      window.exportData = exportData;
      window.importData = importData;

  })();
</script>
</body>
</html>
