<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>éç‡Ÿåˆ©çµ„ç¹”è²¡å‹™ç®¡ç†ç³»çµ±</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', Arial, sans-serif;
          background-color: #f5f5f5;
          line-height: 1.6;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 20px;
      }

      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          border-radius: 10px;
          margin-bottom: 30px;
          text-align: center;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }

      .header h1 {
          font-size: 2.5em;
          margin-bottom: 10px;
      }

      .header p {
          font-size: 1.1em;
          opacity: 0.9;
      }

      .nav-tabs {
          display: flex;
          background: white;
          border-radius: 10px;
          overflow: hidden;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          margin-bottom: 30px;
          flex-wrap: wrap;
      }

      .nav-tab {
          flex: 1;
          padding: 15px 20px;
          background: white;
          border: none;
          cursor: pointer;
          font-size: 16px;
          font-weight: 500;
          color: #666;
          transition: all 0.3s ease;
          border-bottom: 3px solid transparent;
          min-width: 120px;
      }

      .nav-tab:hover {
          background: #f8f9fa;
          color: #333;
      }

      .nav-tab.active {
          background: #667eea;
          color: white;
          border-bottom-color: #5a6fd8;
      }

      .tab-content {
          display: none;
          background: white;
          padding: 30px;
          border-radius: 10px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .tab-content.active {
          display: block;
      }

      .form-section {
          margin-bottom: 40px;
      }

      .form-section h3 {
          color: #333;
          margin-bottom: 20px;
          padding-bottom: 10px;
          border-bottom: 2px solid #667eea;
          font-size: 1.3em;
      }

      .form-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 20px;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
          width: 100%;
          padding: 12px;
          border: 2px solid #e1e5e9;
          border-radius: 6px;
          font-size: 14px;
          transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
          padding: 12px 24px;
          border: none;
          border-radius: 6px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          margin-right: 10px;
          margin-bottom: 10px;
      }

      .btn-primary {
          background: #667eea;
          color: white;
      }

      .btn-primary:hover {
          background: #5a6fd8;
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
          background: #6c757d;
          color: white;
      }

      .btn-secondary:hover {
          background: #5a6268;
      }

      .btn-success {
          background: #28a745;
          color: white;
      }

      .btn-success:hover {
          background: #218838;
      }

      .btn-danger {
          background: #dc3545;
          color: white;
      }

      .btn-danger:hover {
          background: #c82333;
      }

      .alert {
          padding: 15px;
          margin: 20px 0;
          border-radius: 6px;
          font-weight: 500;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .alert-error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .alert-info {
          background: #d1ecf1;
          color: #0c5460;
          border: 1px solid #bee5eb;
      }

      .data-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
          background: white;
          border-radius: 6px;
          overflow: hidden;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .data-table th,
      .data-table td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #e1e5e9;
      }

      .data-table th {
          background: #f8f9fa;
          font-weight: 600;
          color: #333;
      }

      .data-table tr:hover {
          background: #f8f9fa;
      }

      .loading {
          display: none;
          text-align: center;
          padding: 20px;
          color: #666;
      }

      .loading.show {
          display: block;
      }

      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
      }

      .stat-card {
          background: white;
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          text-align: center;
          border-left: 4px solid #667eea;
      }

      .stat-card h4 {
          color: #666;
          font-size: 0.9em;
          margin-bottom: 10px;
          text-transform: uppercase;
          letter-spacing: 1px;
      }

      .stat-card .stat-value {
          font-size: 2em;
          font-weight: bold;
          color: #333;
      }

      .search-box {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
          flex-wrap: wrap;
      }

      .search-box input,
      .search-box select {
          flex: 1;
          min-width: 200px;
      }

      .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
      }

      .modal-content {
          background-color: white;
          margin: 5% auto;
          padding: 30px;
          border-radius: 10px;
          width: 90%;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
      }

      .close {
          color: #aaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
      }

      .close:hover {
          color: #000;
      }

      @media (max-width: 768px) {
          .container {
              padding: 10px;
          }
          
          .nav-tabs {
              flex-direction: column;
          }
          
          .nav-tab {
              flex: none;
          }
          
          .form-grid {
              grid-template-columns: 1fr;
          }
          
          .stats-grid {
              grid-template-columns: 1fr;
          }
      }

      .progress-bar {
          width: 100%;
          height: 20px;
          background-color: #e1e5e9;
          border-radius: 10px;
          overflow: hidden;
          margin: 10px 0;
      }

      .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, #667eea, #764ba2);
          width: 0%;
          transition: width 0.3s ease;
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>ğŸ’° è²¡å‹™ç®¡ç†ç³»çµ±</h1>
          <p>éç‡Ÿåˆ©çµ„ç¹”å°ˆç”¨è²¡å‹™ç®¡ç†è§£æ±ºæ–¹æ¡ˆ</p>
      </div>

      <div class="nav-tabs">
          <button class="nav-tab active" onclick="showTab('dashboard')">ğŸ“Š å„€è¡¨æ¿</button>
          <button class="nav-tab" onclick="showTab('members')">ğŸ‘¥ æœƒå“¡ç®¡ç†</button>
          <button class="nav-tab" onclick="showTab('income')">ğŸ’° æ”¶å…¥ç®¡ç†</button>
          <button class="nav-tab" onclick="showTab('expenses')">ğŸ’¸ æ”¯å‡ºç®¡ç†</button>
          <button class="nav-tab" onclick="showTab('receipts')">ğŸ§¾ é›»å­æ”¶æ“š</button>
          <button class="nav-tab" onclick="showTab('accounts')">ğŸ“‹ æœƒè¨ˆç§‘ç›®</button>
          <button class="nav-tab" onclick="showTab('banks')">ğŸ¦ éŠ€è¡Œå¸³æˆ¶</button>
          <button class="nav-tab" onclick="showTab('reports')">ğŸ“ˆ å ±è¡¨åˆ†æ</button>
          <button class="nav-tab" onclick="showTab('settings')">âš™ï¸ ç³»çµ±è¨­å®š</button>
      </div>

      <!-- å„€è¡¨æ¿ -->
      <div id="dashboard" class="tab-content active">
          <div class="stats-grid">
              <div class="stat-card">
                  <h4>ç¸½æœƒå“¡æ•¸</h4>
                  <div class="stat-value" id="totalMembers">-</div>
              </div>
              <div class="stat-card">
                  <h4>æœ¬æœˆæ”¶å…¥</h4>
                  <div class="stat-value" id="monthlyIncome">-</div>
              </div>
              <div class="stat-card">
                  <h4>æœ¬æœˆæ”¯å‡º</h4>
                  <div class="stat-value" id="monthlyExpenses">-</div>
              </div>
              <div class="stat-card">
                  <h4>å¸³æˆ¶é¤˜é¡</h4>
                  <div class="stat-value" id="totalBalance">-</div>
              </div>
          </div>
          
          <div class="form-section">
              <h3>ç³»çµ±ç‹€æ…‹</h3>
              <button class="btn btn-primary" onclick="refreshDashboard()">ğŸ”„ é‡æ–°æ•´ç†</button>
              <button class="btn btn-secondary" onclick="checkSystemHealth()">ğŸ¥ ç³»çµ±å¥åº·æª¢æŸ¥</button>
              <div id="systemStatus"></div>
          </div>
      </div>

      <!-- æœƒå“¡ç®¡ç† -->
      <div id="members" class="tab-content">
          <div class="form-section">
              <h3>æ–°å¢æœƒå“¡</h3>
              <form id="memberForm" class="form-grid">
                  <div class="form-group">
                      <label for="memberName">å§“å *</label>
                      <input type="text" id="memberName" required>
                  </div>
                  <div class="form-group">
                      <label for="memberPhone">é›»è©± *</label>
                      <input type="tel" id="memberPhone" required>
                  </div>
                  <div class="form-group">
                      <label for="memberEmail">é›»å­éƒµä»¶</label>
                      <input type="email" id="memberEmail">
                  </div>
                  <div class="form-group">
                      <label for="memberAddress">åœ°å€</label>
                      <textarea id="memberAddress" rows="3"></textarea>
                  </div>
                  <div class="form-group">
                      <label for="memberBirthday">ç”Ÿæ—¥</label>
                      <input type="date" id="memberBirthday">
                  </div>
                  <div class="form-group">
                      <label for="memberType">æœƒå“¡é¡å‹</label>
                      <select id="memberType">
                          <option value="ä¸€èˆ¬æœƒå“¡">ä¸€èˆ¬æœƒå“¡</option>
                          <option value="è´ŠåŠ©æœƒå“¡">è´ŠåŠ©æœƒå“¡</option>
                          <option value="æ¦®è­½æœƒå“¡">æ¦®è­½æœƒå“¡</option>
                      </select>
                  </div>
              </form>
              <button class="btn btn-primary" onclick="addMember()">â• æ–°å¢æœƒå“¡</button>
              <button class="btn btn-secondary" onclick="clearMemberForm()">ğŸ—‘ï¸ æ¸…é™¤è¡¨å–®</button>
          </div>

          <div class="form-section">
              <h3>æœƒå“¡åˆ—è¡¨</h3>
              <div class="search-box">
                  <input type="text" id="memberSearch" placeholder="æœå°‹æœƒå“¡å§“åã€é›»è©±æˆ–éƒµä»¶">
                  <select id="memberTypeFilter">
                      <option value="">æ‰€æœ‰é¡å‹</option>
                      <option value="ä¸€èˆ¬æœƒå“¡">ä¸€èˆ¬æœƒå“¡</option>
                      <option value="è´ŠåŠ©æœƒå“¡">è´ŠåŠ©æœƒå“¡</option>
                      <option value="æ¦®è­½æœƒå“¡">æ¦®è­½æœƒå“¡</option>
                  </select>
                  <button class="btn btn-primary" onclick="searchMembers()">ğŸ” æœå°‹</button>
                  <button class="btn btn-success" onclick="loadMembers()">ğŸ“‹ è¼‰å…¥å…¨éƒ¨</button>
              </div>
              <div class="loading" id="membersLoading">è¼‰å…¥ä¸­...</div>
              <div id="membersTable"></div>
          </div>
      </div>

      <!-- æ”¶å…¥ç®¡ç† -->
      <div id="income" class="tab-content">
          <div class="form-section">
              <h3>æ–°å¢æ”¶å…¥è¨˜éŒ„</h3>
              <form id="incomeForm" class="form-grid">
                  <div class="form-group">
                      <label for="incomeDate">æ—¥æœŸ *</label>
                      <input type="date" id="incomeDate" required>
                  </div>
                  <div class="form-group">
                      <label for="incomePayer">ä»˜æ¬¾äºº *</label>
                      <input type="text" id="incomePayer" required>
                  </div>
                  <div class="form-group">
                      <label for="incomeAmount">é‡‘é¡ *</label>
                      <input type="number" id="incomeAmount" min="0" step="0.01" required>
                  </div>
                  <div class="form-group">
                      <label for="incomePurpose">ç”¨é€” *</label>
                      <input type="text" id="incomePurpose" required>
                  </div>
                  <div class="form-group">
                      <label for="incomeMethod">ä»˜æ¬¾æ–¹å¼</label>
                      <select id="incomeMethod">
                          <option value="ç¾é‡‘">ç¾é‡‘</option>
                          <option value="è½‰å¸³">è½‰å¸³</option>
                          <option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
                          <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="incomeAccount">æœƒè¨ˆç§‘ç›®</label>
                      <select id="incomeAccount">
                          <option value="ææ¬¾æ”¶å…¥">ææ¬¾æ”¶å…¥</option>
                          <option value="æœƒè²»æ”¶å…¥">æœƒè²»æ”¶å…¥</option>
                          <option value="æ´»å‹•æ”¶å…¥">æ´»å‹•æ”¶å…¥</option>
                          <option value="å…¶ä»–æ”¶å…¥">å…¶ä»–æ”¶å…¥</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="incomeBank">éŠ€è¡Œå¸³æˆ¶</label>
                      <select id="incomeBank">
                          <option value="">è«‹é¸æ“‡éŠ€è¡Œå¸³æˆ¶</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="incomeNotes">å‚™è¨»</label>
                      <textarea id="incomeNotes" rows="2"></textarea>
                  </div>
              </form>
              <button class="btn btn-primary" onclick="addIncome()">â• æ–°å¢æ”¶å…¥</button>
              <button class="btn btn-secondary" onclick="clearIncomeForm()">ğŸ—‘ï¸ æ¸…é™¤è¡¨å–®</button>
          </div>

          <div class="form-section">
              <h3>æ”¶å…¥è¨˜éŒ„</h3>
              <div class="search-box">
                  <input type="date" id="incomeStartDate" placeholder="é–‹å§‹æ—¥æœŸ">
                  <input type="date" id="incomeEndDate" placeholder="çµæŸæ—¥æœŸ">
                  <input type="text" id="incomePayerSearch" placeholder="ä»˜æ¬¾äºº">
                  <select id="incomeMethodFilter">
                      <option value="">æ‰€æœ‰ä»˜æ¬¾æ–¹å¼</option>
                      <option value="ç¾é‡‘">ç¾é‡‘</option>
                      <option value="è½‰å¸³">è½‰å¸³</option>
                      <option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
                      <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                  </select>
                  <button class="btn btn-primary" onclick="searchIncome()">ğŸ” æœå°‹</button>
                  <button class="btn btn-success" onclick="loadIncome()">ğŸ“‹ è¼‰å…¥å…¨éƒ¨</button>
              </div>
              <div class="loading" id="incomeLoading">è¼‰å…¥ä¸­...</div>
              <div id="incomeTable"></div>
          </div>
      </div>

      <!-- æ”¯å‡ºç®¡ç† -->
      <div id="expenses" class="tab-content">
          <div class="form-section">
              <h3>æ–°å¢æ”¯å‡ºè¨˜éŒ„</h3>
              <form id="expenseForm" class="form-grid">
                  <div class="form-group">
                      <label for="expenseDate">æ—¥æœŸ *</label>
                      <input type="date" id="expenseDate" required>
                  </div>
                  <div class="form-group">
                      <label for="expenseVendor">æ”¶æ¬¾äºº/å» å•† *</label>
                      <input type="text" id="expenseVendor" required>
                  </div>
                  <div class="form-group">
                      <label for="expenseAmount">é‡‘é¡ *</label>
                      <input type="number" id="expenseAmount" min="0" step="0.01" required>
                  </div>
                  <div class="form-group">
                      <label for="expensePurpose">ç”¨é€” *</label>
                      <input type="text" id="expensePurpose" required>
                  </div>
                  <div class="form-group">
                      <label for="expenseMethod">ä»˜æ¬¾æ–¹å¼</label>
                      <select id="expenseMethod">
                          <option value="ç¾é‡‘">ç¾é‡‘</option>
                          <option value="è½‰å¸³">è½‰å¸³</option>
                          <option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
                          <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="expenseAccount">æœƒè¨ˆç§‘ç›®</label>
                      <select id="expenseAccount">
                          <option value="è¾¦å…¬è²»ç”¨">è¾¦å…¬è²»ç”¨</option>
                          <option value="æ´»å‹•è²»ç”¨">æ´»å‹•è²»ç”¨</option>
                          <option value="äººäº‹è²»ç”¨">äººäº‹è²»ç”¨</option>
                          <option value="å…¶ä»–è²»ç”¨">å…¶ä»–è²»ç”¨</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="expenseBank">éŠ€è¡Œå¸³æˆ¶</label>
                      <select id="expenseBank">
                          <option value="">è«‹é¸æ“‡éŠ€è¡Œå¸³æˆ¶</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="expenseNotes">å‚™è¨»</label>
                      <textarea id="expenseNotes" rows="2"></textarea>
                  </div>
              </form>
              <button class="btn btn-primary" onclick="addExpense()">â• æ–°å¢æ”¯å‡º</button>
              <button class="btn btn-secondary" onclick="clearExpenseForm()">ğŸ—‘ï¸ æ¸…é™¤è¡¨å–®</button>
          </div>

          <div class="form-section">
              <h3>æ”¯å‡ºè¨˜éŒ„</h3>
              <div class="search-box">
                  <input type="date" id="expenseStartDate" placeholder="é–‹å§‹æ—¥æœŸ">
                  <input type="date" id="expenseEndDate" placeholder="çµæŸæ—¥æœŸ">
                  <input type="text" id="expenseVendorSearch" placeholder="æ”¶æ¬¾äºº/å» å•†">
                  <select id="expenseMethodFilter">
                      <option value="">æ‰€æœ‰ä»˜æ¬¾æ–¹å¼</option>
                      <option value="ç¾é‡‘">ç¾é‡‘</option>
                      <option value="è½‰å¸³">è½‰å¸³</option>
                      <option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
                      <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                  </select>
                  <button class="btn btn-primary" onclick="searchExpenses()">ğŸ” æœå°‹</button>
                  <button class="btn btn-success" onclick="loadExpenses()">ğŸ“‹ è¼‰å…¥å…¨éƒ¨</button>
              </div>
              <div class="loading" id="expensesLoading">è¼‰å…¥ä¸­...</div>
              <div id="expensesTable"></div>
          </div>
      </div>

      <!-- é›»å­æ”¶æ“š -->
      <div id="receipts" class="tab-content">
          <div class="form-section">
              <h3>ç”Ÿæˆé›»å­æ”¶æ“š</h3>
              <form id="receiptForm" class="form-grid">
                  <div class="form-group">
                      <label for="receiptIncomeId">é¸æ“‡æ”¶å…¥è¨˜éŒ„ *</label>
                      <select id="receiptIncomeId" required>
                          <option value="">è«‹é¸æ“‡æ”¶å…¥è¨˜éŒ„</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="receiptNumber">æ”¶æ“šç·¨è™Ÿ *</label>
                      <input type="text" id="receiptNumber" required>
                  </div>
                  <div class="form-group">
                      <label for="receiptDate">é–‹ç«‹æ—¥æœŸ</label>
                      <input type="date" id="receiptDate">
                  </div>
              </form>
              <button class="btn btn-primary" onclick="generateReceipt()">ğŸ“„ ç”Ÿæˆæ”¶æ“š</button>
              <button class="btn btn-secondary" onclick="generateReceiptNumber()">ğŸ”¢ è‡ªå‹•ç·¨è™Ÿ</button>
          </div>

          <div class="form-section">
              <h3>æ”¶æ“šç®¡ç†</h3>
              <div class="search-box">
                  <input type="text" id="receiptSearch" placeholder="æœå°‹æ”¶æ“šç·¨è™Ÿæˆ–ä»˜æ¬¾äºº">
                  <select id="receiptStatusFilter">
                      <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                      <option value="æœªç™¼é€">æœªç™¼é€</option>
                      <option value="å·²ç™¼é€">å·²ç™¼é€</option>
                  </select>
                  <button class="btn btn-primary" onclick="searchReceipts()">ğŸ” æœå°‹</button>
                  <button class="btn btn-success" onclick="loadReceipts()">ğŸ“‹ è¼‰å…¥å…¨éƒ¨</button>
              </div>
              <div class="loading" id="receiptsLoading">è¼‰å…¥ä¸­...</div>
              <div id="receiptsTable"></div>
          </div>
      </div>

      <!-- æœƒè¨ˆç§‘ç›® -->
      <div id="accounts" class="tab-content">
          <div class="form-section">
              <h3>æ–°å¢æœƒè¨ˆç§‘ç›®</h3>
              <form id="accountForm" class="form-grid">
                  <div class="form-group">
                      <label for="accountCode">ç§‘ç›®ä»£ç¢¼ *</label>
                      <input type="text" id="accountCode" required>
                  </div>
                  <div class="form-group">
                      <label for="accountName">ç§‘ç›®åç¨± *</label>
                      <input type="text" id="accountName" required>
                  </div>
                  <div class="form-group">
                      <label for="accountType">ç§‘ç›®é¡å‹</label>
                      <select id="accountType">
                          <option value="æ”¶å…¥">æ”¶å…¥</option>
                          <option value="æ”¯å‡º">æ”¯å‡º</option>
                          <option value="è³‡ç”¢">è³‡ç”¢</option>
                          <option value="è² å‚µ">è² å‚µ</option>
                          <option value="æ¬Šç›Š">æ¬Šç›Š</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="accountParent">ä¸Šå±¤ç§‘ç›®</label>
                      <select id="accountParent">
                          <option value="">ç„¡ä¸Šå±¤ç§‘ç›®</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="accountDescription">èªªæ˜</label>
                      <textarea id="accountDescription" rows="2"></textarea>
                  </div>
              </form>
              <button class="btn btn-primary" onclick="addAccount()">â• æ–°å¢ç§‘ç›®</button>
              <button class="btn btn-secondary" onclick="clearAccountForm()">ğŸ—‘ï¸ æ¸…é™¤è¡¨å–®</button>
          </div>

          <div class="form-section">
              <h3>æœƒè¨ˆç§‘ç›®åˆ—è¡¨</h3>
              <div class="search-box">
                  <input type="text" id="accountSearch" placeholder="æœå°‹ç§‘ç›®ä»£ç¢¼æˆ–åç¨±">
                  <select id="accountTypeFilter">
                      <option value="">æ‰€æœ‰é¡å‹</option>
                      <option value="æ”¶å…¥">æ”¶å…¥</option>
                      <option value="æ”¯å‡º">æ”¯å‡º</option>
                      <option value="è³‡ç”¢">è³‡ç”¢</option>
                      <option value="è² å‚µ">è² å‚µ</option>
                      <option value="æ¬Šç›Š">æ¬Šç›Š</option>
                  </select>
                  <button class="btn btn-primary" onclick="searchAccounts()">ğŸ” æœå°‹</button>
                  <button class="btn btn-success" onclick="loadAccounts()">ğŸ“‹ è¼‰å…¥å…¨éƒ¨</button>
              </div>
              <div class="loading" id="accountsLoading">è¼‰å…¥ä¸­...</div>
              <div id="accountsTable"></div>
          </div>
      </div>

      <!-- éŠ€è¡Œå¸³æˆ¶ -->
      <div id="banks" class="tab-content">
          <div class="form-section">
              <h3>æ–°å¢éŠ€è¡Œå¸³æˆ¶</h3>
              <form id="bankForm" class="form-grid">
                  <div class="form-group">
                      <label for="bankAccountName">å¸³æˆ¶åç¨± *</label>
                      <input type="text" id="bankAccountName" required>
                  </div>
                  <div class="form-group">
                      <label for="bankName">éŠ€è¡Œåç¨± *</label>
                      <input type="text" id="bankName" required>
                  </div>
                  <div class="form-group">
                      <label for="bankBranch">åˆ†è¡Œåç¨±</label>
                      <input type="text" id="bankBranch">
                  </div>
                  <div class="form-group">
                      <label for="bankAccountNumber">å¸³è™Ÿ *</label>
                      <input type="text" id="bankAccountNumber" required>
                  </div>
                  <div class="form-group">
                      <label for="bankAccountType">å¸³æˆ¶é¡å‹</label>
                      <select id="bankAccountType">
                          <option value="æ´»æœŸå­˜æ¬¾">æ´»æœŸå­˜æ¬¾</option>
                          <option value="å®šæœŸå­˜æ¬¾">å®šæœŸå­˜æ¬¾</option>
                          <option value="æ”¯ç¥¨å­˜æ¬¾">æ”¯ç¥¨å­˜æ¬¾</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="bankBalance">ç›®å‰é¤˜é¡</label>
                      <input type="number" id="bankBalance" min="0" step="0.01" value="0">
                  </div>
                  <div class="form-group">
                      <label for="bankCurrency">å¹£åˆ¥</label>
                      <select id="bankCurrency">
                          <option value="TWD">å°å¹£ (TWD)</option>
                          <option value="USD">ç¾å…ƒ (USD)</option>
                          <option value="EUR">æ­å…ƒ (EUR)</option>
                          <option value="JPY">æ—¥åœ“ (JPY)</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="bankDescription">èªªæ˜</label>
                      <textarea id="bankDescription" rows="2"></textarea>
                  </div>
              </form>
              <button class="btn btn-primary" onclick="addBankAccount()">â• æ–°å¢å¸³æˆ¶</button>
              <button class="btn btn-secondary" onclick="clearBankForm()">ğŸ—‘ï¸ æ¸…é™¤è¡¨å–®</button>
          </div>

          <div class="form-section">
              <h3>éŠ€è¡Œå¸³æˆ¶åˆ—è¡¨</h3>
              <div class="search-box">
                  <input type="text" id="bankSearch" placeholder="æœå°‹å¸³æˆ¶åç¨±æˆ–éŠ€è¡Œ">
                  <select id="bankStatusFilter">
                      <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                      <option value="true">å•Ÿç”¨</option>
                      <option value="false">åœç”¨</option>
                  </select>
                  <button class="btn btn-primary" onclick="searchBankAccounts()">ğŸ” æœå°‹</button>
                  <button class="btn btn-success" onclick="loadBankAccounts()">ğŸ“‹ è¼‰å…¥å…¨éƒ¨</button>
              </div>
              <div class="loading" id="banksLoading">è¼‰å…¥ä¸­...</div>
              <div id="banksTable"></div>
          </div>
      </div>

      <!-- å ±è¡¨åˆ†æ -->
      <div id="reports" class="tab-content">
          <div class="form-section">
              <h3>è²¡å‹™å ±è¡¨</h3>
              <div class="form-grid">
                  <div class="form-group">
                      <label for="reportStartDate">é–‹å§‹æ—¥æœŸ</label>
                      <input type="date" id="reportStartDate">
                  </div>
                  <div class="form-group">
                      <label for="reportEndDate">çµæŸæ—¥æœŸ</label>
                      <input type="date" id="reportEndDate">
                  </div>
                  <div class="form-group">
                      <label for="reportType">å ±è¡¨é¡å‹</label>
                      <select id="reportType">
                          <option value="summary">è²¡å‹™æ‘˜è¦</option>
                          <option value="income">æ”¶å…¥æ˜ç´°</option>
                          <option value="expense">æ”¯å‡ºæ˜ç´°</option>
                          <option value="balance">è³‡ç”¢è² å‚µ</option>
                      </select>
                  </div>
              </div>
              <button class="btn btn-primary" onclick="generateReport()">ğŸ“Š ç”Ÿæˆå ±è¡¨</button>
              <button class="btn btn-success" onclick="exportReport()">ğŸ“¤ åŒ¯å‡ºå ±è¡¨</button>
          </div>

          <div class="form-section">
              <h3>å ±è¡¨çµæœ</h3>
              <div class="loading" id="reportsLoading">è¼‰å…¥ä¸­...</div>
              <div id="reportResults"></div>
          </div>
      </div>

      <!-- ç³»çµ±è¨­å®š -->
      <div id="settings" class="tab-content">
          <div class="form-section">
              <h3>çµ„ç¹”è³‡è¨Šè¨­å®š</h3>
              <form id="orgForm" class="form-grid">
                  <div class="form-group">
                      <label for="orgName">çµ„ç¹”åç¨±</label>
                      <input type="text" id="orgName">
                  </div>
                  <div class="form-group">
                      <label for="orgAddress">çµ„ç¹”åœ°å€</label>
                      <textarea id="orgAddress" rows="2"></textarea>
                  </div>
                  <div class="form-group">
                      <label for="orgPhone">è¯çµ¡é›»è©±</label>
                      <input type="tel" id="orgPhone">
                  </div>
                  <div class="form-group">
                      <label for="orgEmail">é›»å­éƒµä»¶</label>
                      <input type="email" id="orgEmail">
                  </div>
                  <div class="form-group">
                      <label for="orgTaxId">çµ±ä¸€ç·¨è™Ÿ</label>
                      <input type="text" id="orgTaxId">
                  </div>
              </form>
              <button class="btn btn-primary" onclick="saveOrgSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
              <button class="btn btn-secondary" onclick="loadOrgSettings()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
          </div>

          <div class="form-section">
              <h3>ç³»çµ±å·¥å…·</h3>
              <button class="btn btn-success" onclick="backupData()">ğŸ’¾ å‚™ä»½è³‡æ–™</button>
              <button class="btn btn-danger" onclick="confirmDataReset()">ğŸ—‘ï¸ é‡ç½®ç³»çµ±</button>
              <button class="btn btn-secondary" onclick="checkSystemHealth()">ğŸ¥ ç³»çµ±æª¢æŸ¥</button>
          </div>

          <div class="form-section">
              <h3>APIè¨­å®š</h3>
              <div class="form-group">
                  <label for="apiUrl">APIç¶²å€</label>
                  <input type="url" id="apiUrl" placeholder="è«‹è¼¸å…¥æ‚¨çš„Google Apps Script Web App URL">
                  <small>è«‹åœ¨Google Apps Scriptéƒ¨ç½²å¾Œï¼Œå°‡Web App URLè²¼åˆ°é€™è£¡</small>
              </div>
              <button class="btn btn-primary" onclick="saveApiUrl()">ğŸ’¾ å„²å­˜APIç¶²å€</button>
              <button class="btn btn-secondary" onclick="testApiConnection()">ğŸ”— æ¸¬è©¦é€£ç·š</button>
          </div>
      </div>

      <!-- çµæœé¡¯ç¤ºå€åŸŸ -->
      <div id="result"></div>
  </div>

  <!-- æ¨¡æ…‹è¦–çª— -->
  <div id="modal" class="modal">
      <div class="modal-content">
          <span class="close" onclick="closeModal()">&times;</span>
          <div id="modalContent"></div>
      </div>
  </div>

  <script>
      // å…¨åŸŸè®Šæ•¸
      let API_URL = localStorage.getItem('apiUrl') || '';
      let currentEditId = null;

      // åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function() {
          // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºé è¨­å€¼
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('incomeDate').value = today;
          document.getElementById('expenseDate').value = today;
          document.getElementById('receiptDate').value = today;
          
          // è¼‰å…¥APIç¶²å€
          if (API_URL) {
              document.getElementById('apiUrl').value = API_URL;
          }
          
          // åˆå§‹è¼‰å…¥å„€è¡¨æ¿
          refreshDashboard();
      });

      // é¡¯ç¤ºçµæœè¨Šæ¯
      function showResult(result, duration = 5000) {
          const resultDiv = document.getElementById('result');
          resultDiv.className = 'alert ' + (result.success ? 'alert-success' : 'alert-error');
          resultDiv.innerHTML = `
              <strong>${result.success ? 'âœ… æˆåŠŸ' : 'âŒ éŒ¯èª¤'}</strong><br>
              ${result.message}
              ${result.data ? `<br><small>è©³ç´°è³‡è¨Š: ${JSON.stringify(result.data)}</small>` : ''}
          `;
          resultDiv.scrollIntoView({ behavior: 'smooth' });
          
          // è‡ªå‹•éš±è—
          setTimeout(() => {
              resultDiv.innerHTML = '';
              resultDiv.className = '';
          }, duration);
      }

      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      function showLoading(elementId, show = true) {
          const element = document.getElementById(elementId);
          if (element) {
              element.classList.toggle('show', show);
          }
      }

      // APIå‘¼å«å‡½æ•¸
      async function callAPI(action, data = {}) {
          if (!API_URL) {
              showResult({
                  success: false,
                  message: 'è«‹å…ˆåœ¨ç³»çµ±è¨­å®šä¸­è¨­å®šAPIç¶²å€'
              });
              return null;
          }

          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: action,
                      data: data
                  })
              });

              if (!response.ok) {
                  throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
              }

              const result = await response.json();
              return result;
          } catch (error) {
              console.error('APIå‘¼å«éŒ¯èª¤:', error);
              showResult({
                  success: false,
                  message: `ç¶²è·¯éŒ¯èª¤: ${error.message}`
              });
              return null;
          }
      }

      // æ¨™ç±¤åˆ‡æ›
      function showTab(tabName) {
          // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
          const tabs = document.querySelectorAll('.tab-content');
          tabs.forEach(tab => tab.classList.remove('active'));

          // ç§»é™¤æ‰€æœ‰æ¨™ç±¤æŒ‰éˆ•çš„activeé¡åˆ¥
          const tabButtons = document.querySelectorAll('.nav-tab');
          tabButtons.forEach(button => button.classList.remove('active'));

          // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤
          document.getElementById(tabName).classList.add('active');
          event.target.classList.add('active');

          // è¼‰å…¥å°æ‡‰è³‡æ–™
          switch(tabName) {
              case 'dashboard':
                  refreshDashboard();
                  break;
              case 'members':
                  loadMembers();
                  break;
              case 'income':
                  loadIncome();
                  loadBankAccountsForSelect('incomeBank');
                  break;
              case 'expenses':
                  loadExpenses();
                  loadBankAccountsForSelect('expenseBank');
                  break;
              case 'receipts':
                  loadReceipts();
                  loadIncomeForReceipts();
                  break;
              case 'accounts':
                  loadAccounts();
                  break;
              case 'banks':
                  loadBankAccounts();
                  break;
              case 'settings':
                  loadOrgSettings();
                  break;
          }
      }

      // å„€è¡¨æ¿åŠŸèƒ½
      async function refreshDashboard() {
          showLoading('dashboardLoading', true);
          
          try {
              // è¼‰å…¥çµ±è¨ˆè³‡æ–™
              const [membersResult, incomeResult, expensesResult, bankResult] = await Promise.all([
                  callAPI('getMembersData'),
                  callAPI('getIncomeData'),
                  callAPI('getExpensesData'),
                  callAPI('getBankAccountsData')
              ]);

              // æ›´æ–°çµ±è¨ˆå¡ç‰‡
              if (membersResult && membersResult.success) {
                  document.getElementById('totalMembers').textContent = membersResult.data.length;
              }

              if (incomeResult && incomeResult.success) {
                  const currentMonth = new Date().getMonth();
                  const currentYear = new Date().getFullYear();
                  const monthlyIncome = incomeResult.data
                      .filter(item => {
                          const itemDate = new Date(item['æ—¥æœŸ']);
                          return itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear;
                      })
                      .reduce((sum, item) => sum + parseFloat(item['é‡‘é¡'] || 0), 0);
                  
                  document.getElementById('monthlyIncome').textContent = `$${monthlyIncome.toLocaleString()}`;
              }

              if (expensesResult && expensesResult.success) {
                  const currentMonth = new Date().getMonth();
                  const currentYear = new Date().getFullYear();
                  const monthlyExpenses = expensesResult.data
                      .filter(item => {
                          const itemDate = new Date(item['æ—¥æœŸ']);
                          return itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear;
                      })
                      .reduce((sum, item) => sum + parseFloat(item['é‡‘é¡'] || 0), 0);
                  
                  document.getElementById('monthlyExpenses').textContent = `$${monthlyExpenses.toLocaleString()}`;
              }

              if (bankResult && bankResult.success) {
                  const totalBalance = bankResult.data
                      .reduce((sum, account) => sum + parseFloat(account['ç›®å‰é¤˜é¡'] || 0), 0);
                  
                  document.getElementById('totalBalance').textContent = `$${totalBalance.toLocaleString()}`;
              }

          } catch (error) {
              console.error('è¼‰å…¥å„€è¡¨æ¿éŒ¯èª¤:', error);
          } finally {
              showLoading('dashboardLoading', false);
          }
      }

      async function checkSystemHealth() {
          const result = await callAPI('health');
          if (result) {
              document.getElementById('systemStatus').innerHTML = `
                  <div class="alert alert-${result.success ? 'success' : 'error'}">
                      <strong>ç³»çµ±ç‹€æ…‹:</strong> ${result.message}<br>
                      <strong>æ™‚é–“:</strong> ${result.timestamp || 'æœªçŸ¥'}<br>
                      <strong>ç‰ˆæœ¬:</strong> ${result.version || 'æœªçŸ¥'}
                  </div>
              `;
          }
      }

      // æœƒå“¡ç®¡ç†åŠŸèƒ½
      async function addMember() {
          const memberData = {
              'å§“å': document.getElementById('memberName').value,
              'é›»è©±': document.getElementById('memberPhone').value,
              'é›»å­éƒµä»¶': document.getElementById('memberEmail').value,
              'åœ°å€': document.getElementById('memberAddress').value,
              'ç”Ÿæ—¥': document.getElementById('memberBirthday').value,
              'æœƒå“¡é¡å‹': document.getElementById('memberType').value
          };

          const result = await callAPI('addMember', memberData);
          if (result) {
              showResult(result);
              if (result.success) {
                  clearMemberForm();
                  loadMembers();
              }
          }
      }

      function clearMemberForm() {
          document.getElementById('memberForm').reset();
      }

      async function loadMembers() {
          showLoading('membersLoading', true);
          const result = await callAPI('getMembersData');
          showLoading('membersLoading', false);
          
          if (result && result.success) {
              displayMembersTable(result.data);
          }
      }

      function displayMembersTable(members) {
          const tableHtml = `
              <table class="data-table">
                  <thead>
                      <tr>
                          <th>å§“å</th>
                          <th>é›»è©±</th>
                          <th>é›»å­éƒµä»¶</th>
                          <th>æœƒå“¡é¡å‹</th>
                          <th>åŠ å…¥æ—¥æœŸ</th>
                          <th>æ“ä½œ</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${members.map(member => `
                          <tr>
                              <td>${member['å§“å'] || ''}</td>
                              <td>${member['é›»è©±'] || ''}</td>
                              <td>${member['é›»å­éƒµä»¶'] || ''}</td>
                              <td>${member['æœƒå“¡é¡å‹'] || ''}</td>
                              <td>${formatDate(member['åŠ å…¥æ—¥æœŸ'])}</td>
                              <td>
                                  <button class="btn btn-secondary" onclick="editMember('${member['ID']}')">ç·¨è¼¯</button>
                                  <button class="btn btn-danger" onclick="deleteMember('${member['ID']}')">åˆªé™¤</button>
                              </td>
                          </tr>
                      `).join('')}
                  </tbody>
              </table>
          `;
          document.getElementById('membersTable').innerHTML = tableHtml;
      }

      async function searchMembers() {
          const searchTerm = document.getElementById('memberSearch').value;
          const typeFilter = document.getElementById('memberTypeFilter').value;
          
          showLoading('membersLoading', true);
          const result = await callAPI('getMembersData', {
              search: searchTerm,
              type: typeFilter
          });
          showLoading('membersLoading', false);
          
          if (result && result.success) {
              displayMembersTable(result.data);
          }
      }

      // æ”¶å…¥ç®¡ç†åŠŸèƒ½
      async function addIncome() {
          const incomeData = {
              'æ—¥æœŸ': document.getElementById('incomeDate').value,
              'ä»˜æ¬¾äºº': document.getElementById('incomePayer').value,
              'é‡‘é¡': parseFloat(document.getElementById('incomeAmount').value),
              'ç”¨é€”': document.getElementById('incomePurpose').value,
              'ä»˜æ¬¾æ–¹å¼': document.getElementById('incomeMethod').value,
              'æœƒè¨ˆç§‘ç›®': document.getElementById('incomeAccount').value,
              'éŠ€è¡Œå¸³æˆ¶': document.getElementById('incomeBank').value,
              'å‚™è¨»': document.getElementById('incomeNotes').value
          };

          const result = await callAPI('addIncome', incomeData);
          if (result) {
              showResult(result);
              if (result.success) {
                  clearIncomeForm();
                  loadIncome();
              }
          }
      }

      function clearIncomeForm() {
          document.getElementById('incomeForm').reset();
          document.getElementById('incomeDate').value = new Date().toISOString().split('T')[0];
      }

      async function loadIncome() {
          showLoading('incomeLoading', true);
          const result = await callAPI('getIncomeData');
          showLoading('incomeLoading', false);
          
          if (result && result.success) {
              displayIncomeTable(result.data);
          }
      }

      function displayIncomeTable(income) {
          const tableHtml = `
              <table class="data-table">
                  <thead>
                      <tr>
                          <th>æ—¥æœŸ</th>
                          <th>ä»˜æ¬¾äºº</th>
                          <th>é‡‘é¡</th>
                          <th>ç”¨é€”</th>
                          <th>ä»˜æ¬¾æ–¹å¼</th>
                          <th>æœƒè¨ˆç§‘ç›®</th>
                          <th>æ“ä½œ</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${income.map(item => `
                          <tr>
                              <td>${formatDate(item['æ—¥æœŸ'])}</td>
                              <td>${item['ä»˜æ¬¾äºº'] || ''}</td>
                              <td>$${parseFloat(item['é‡‘é¡'] || 0).toLocaleString()}</td>
                              <td>${item['ç”¨é€”'] || ''}</td>
                              <td>${item['ä»˜æ¬¾æ–¹å¼'] || ''}</td>
                              <td>${item['æœƒè¨ˆç§‘ç›®'] || ''}</td>
                              <td>
                                  <button class="btn btn-secondary" onclick="editIncome('${item['ID']}')">ç·¨è¼¯</button>
                                  <button class="btn btn-danger" onclick="deleteIncome('${item['ID']}')">åˆªé™¤</button>
                              </td>
                          </tr>
                      `).join('')}
                  </tbody>
              </table>
          `;
          document.getElementById('incomeTable').innerHTML = tableHtml;
      }

      async function searchIncome() {
          const startDate = document.getElementById('incomeStartDate').value;
          const endDate = document.getElementById('incomeEndDate').value;
          const payer = document.getElementById('incomePayerSearch').value;
          const method = document.getElementById('incomeMethodFilter').value;
          
          showLoading('incomeLoading', true);
          const result = await callAPI('getIncomeData', {
              startDate: startDate,
              endDate: endDate,
              payer: payer,
              method: method
          });
          showLoading('incomeLoading', false);
          
          if (result && result.success) {
              displayIncomeTable(result.data);
          }
      }

      // æ”¯å‡ºç®¡ç†åŠŸèƒ½
      async function addExpense() {
          const expenseData = {
              'æ—¥æœŸ': document.getElementById('expenseDate').value,
              'æ”¶æ¬¾äºº': document.getElementById('expenseVendor').value,
              'é‡‘é¡': parseFloat(document.getElementById('expenseAmount').value),
              'ç”¨é€”': document.getElementById('expensePurpose').value,
              'ä»˜æ¬¾æ–¹å¼': document.getElementById('expenseMethod').value,
              'æœƒè¨ˆç§‘ç›®': document.getElementById('expenseAccount').value,
              'éŠ€è¡Œå¸³æˆ¶': document.getElementById('expenseBank').value,
              'å‚™è¨»': document.getElementById('expenseNotes').value
          };

          const result = await callAPI('addExpense', expenseData);
          if (result) {
              showResult(result);
              if (result.success) {
                  clearExpenseForm();
                  loadExpenses();
              }
          }
      }

      function clearExpenseForm() {
          document.getElementById('expenseForm').reset();
          document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
      }

      async function loadExpenses() {
          showLoading('expensesLoading', true);
          const result = await callAPI('getExpensesData');
          showLoading('expensesLoading', false);
          
          if (result && result.success) {
              displayExpensesTable(result.data);
          }
      }

      function displayExpensesTable(expenses) {
          const tableHtml = `
              <table class="data-table">
                  <thead>
                      <tr>
                          <th>æ—¥æœŸ</th>
                          <th>æ”¶æ¬¾äºº</th>
                          <th>é‡‘é¡</th>
                          <th>ç”¨é€”</th>
                          <th>ä»˜æ¬¾æ–¹å¼</th>
                          <th>æœƒè¨ˆç§‘ç›®</th>
                          <th>æ“ä½œ</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${expenses.map(item => `
                          <tr>
                              <td>${formatDate(item['æ—¥æœŸ'])}</td>
                              <td>${item['æ”¶æ¬¾äºº'] || ''}</td>
                              <td>$${parseFloat(item['é‡‘é¡'] || 0).toLocaleString()}</td>
                              <td>${item['ç”¨é€”'] || ''}</td>
                              <td>${item['ä»˜æ¬¾æ–¹å¼'] || ''}</td>
                              <td>${item['æœƒè¨ˆç§‘ç›®'] || ''}</td>
                              <td>
                                  <button class="btn btn-secondary" onclick="editExpense('${item['ID']}')">ç·¨è¼¯</button>
                                  <button class="btn btn-danger" onclick="deleteExpense('${item['ID']}')">åˆªé™¤</button>
                              </td>
                          </tr>
                      `).join('')}
                  </tbody>
              </table>
          `;
          document.getElementById('expensesTable').innerHTML = tableHtml;
      }

      async function searchExpenses() {
          const startDate = document.getElementById('expenseStartDate').value;
          const endDate = document.getElementById('expenseEndDate').value;
          const vendor = document.getElementById('expenseVendorSearch').value;
          const method = document.getElementById('expenseMethodFilter').value;
          
          showLoading('expensesLoading', true);
          const result = await callAPI('getExpensesData', {
              startDate: startDate,
              endDate: endDate,
              vendor: vendor,
              method: method
          });
          showLoading('expensesLoading', false);
          
          if (result && result.success) {
              displayExpensesTable(result.data);
          }
      }

      // é›»å­æ”¶æ“šåŠŸèƒ½
      async function generateReceipt() {
          const receiptData = {
              'æ”¶å…¥ID': document.getElementById('receiptIncomeId').value,
              'æ”¶æ“šç·¨è™Ÿ': document.getElementById('receiptNumber').value,
              'é–‹ç«‹æ—¥æœŸ': document.getElementById('receiptDate').value
          };

          const result = await callAPI('generateReceipt', receiptData);
          if (result) {
              showResult(result);
              if (result.success) {
                  loadReceipts();
              }
          }
      }

      function generateReceiptNumber() {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const time = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
          
          const receiptNumber = `R${year}${month}${day}${time}`;
          document.getElementById('receiptNumber').value = receiptNumber;
      }

      async function loadReceipts() {
          showLoading('receiptsLoading', true);
          const result = await callAPI('getReceiptsData');
          showLoading('receiptsLoading', false);
          
          if (result && result.success) {
              displayReceiptsTable(result.data);
          }
      }

      function displayReceiptsTable(receipts) {
          const tableHtml = `
              <table class="data-table">
                  <thead>
                      <tr>
                          <th>æ”¶æ“šç·¨è™Ÿ</th>
                          <th>ä»˜æ¬¾äºº</th>
                          <th>é‡‘é¡</th>
                          <th>é–‹ç«‹æ—¥æœŸ</th>
                          <th>ç™¼é€ç‹€æ…‹</th>
                          <th>æ“ä½œ</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${receipts.map(receipt => `
                          <tr>
                              <td>${receipt['æ”¶æ“šç·¨è™Ÿ'] || ''}</td>
                              <td>${receipt['ä»˜æ¬¾äºº'] || ''}</td>
                              <td>$${parseFloat(receipt['é‡‘é¡'] || 0).toLocaleString()}</td>
                              <td>${formatDate(receipt['é–‹ç«‹æ—¥æœŸ'])}</td>
                              <td>
                                  <span class="badge ${receipt['ç™¼é€ç‹€æ…‹'] === 'å·²ç™¼é€' ? 'badge-success' : 'badge-warning'}">
                                      ${receipt['ç™¼é€ç‹€æ…‹'] || 'æœªç™¼é€'}
                                  </span>
                              </td>
                              <td>
                                  <button class="btn btn-primary" onclick="sendReceipt('${receipt['ID']}')">ç™¼é€</button>
                                  <button class="btn btn-secondary" onclick="downloadReceipt('${receipt['PDFæª”æ¡ˆID']}')">ä¸‹è¼‰</button>
                              </td>
                          </tr>
                      `).join('')}
                  </tbody>
              </table>
          `;
          document.getElementById('receiptsTable').innerHTML = tableHtml;
      }

      async function sendReceipt(receiptId) {
          const result = await callAPI('sendReceipt', { receiptId: receiptId });
          if (result) {
              showResult(result);
              if (result.success) {
                  loadReceipts();
              }
          }
      }

      async function loadIncomeForReceipts() {
          const result = await callAPI('getIncomeData');
          if (result && result.success) {
              const select = document.getElementById('receiptIncomeId');
              select.innerHTML = '<option value="">è«‹é¸æ“‡æ”¶å…¥è¨˜éŒ„</option>';
              
              result.data.forEach(income => {
                  const option = document.createElement('option');
                  option.value = income['ID'];
                  option.textContent = `${income['ä»˜æ¬¾äºº']} - $${parseFloat(income['é‡‘é¡']).toLocaleString()} (${formatDate(income['æ—¥æœŸ'])})`;
                  select.appendChild(option);
              });
          }
      }

      // æœƒè¨ˆç§‘ç›®åŠŸèƒ½
      async function addAccount() {
          const accountData = {
              'ç§‘ç›®ä»£ç¢¼': document.getElementById('accountCode').value,
              'ç§‘ç›®åç¨±': document.getElementById('accountName').value,
              'ç§‘ç›®é¡å‹': document.getElementById('accountType').value,
              'ä¸Šå±¤ç§‘ç›®': document.getElementById('accountParent').value,
              'èªªæ˜': document.getElementById('accountDescription').value
          };

          const result = await callAPI('addAccount', accountData);
          if (result) {
              showResult(result);
              if (result.success) {
                  clearAccountForm();
                  loadAccounts();
              }
          }
      }

      function clearAccountForm() {
          document.getElementById('accountForm').reset();
      }

      async function loadAccounts() {
          showLoading('accountsLoading', true);
          const result = await callAPI('getAccountsData');
          showLoading('accountsLoading', false);
          
          if (result && result.success) {
              displayAccountsTable(result.data);
          }
      }

      function displayAccountsTable(accounts) {
          const tableHtml = `
              <table class="data-table">
                  <thead>
                      <tr>
                          <th>ç§‘ç›®ä»£ç¢¼</th>
                          <th>ç§‘ç›®åç¨±</th>
                          <th>ç§‘ç›®é¡å‹</th>
                          <th>ä¸Šå±¤ç§‘ç›®</th>
                          <th>æ˜¯å¦å•Ÿç”¨</th>
                          <th>æ“ä½œ</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${accounts.map(account => `
                          <tr>
                              <td>${account['ç§‘ç›®ä»£ç¢¼'] || ''}</td>
                              <td>${account['ç§‘ç›®åç¨±'] || ''}</td>
                              <td>${account['ç§‘ç›®é¡å‹'] || ''}</td>
                              <td>${account['ä¸Šå±¤ç§‘ç›®'] || 'ç„¡'}</td>
                              <td>
                                  <span class="badge ${account['æ˜¯å¦å•Ÿç”¨'] ? 'badge-success' : 'badge-warning'}">
                                      ${account['æ˜¯å¦å•Ÿç”¨'] ? 'å•Ÿç”¨' : 'åœç”¨'}
                                  </span>
                              </td>
                              <td>
                                  <button class="btn btn-secondary" onclick="editAccount('${account['ID']}')">ç·¨è¼¯</button>
                                  <button class="btn btn-${account['æ˜¯å¦å•Ÿç”¨'] ? 'danger' : 'success'}" 
                                          onclick="toggleAccountStatus('${account['ID']}')">
                                      ${account['æ˜¯å¦å•Ÿç”¨'] ? 'åœç”¨' : 'å•Ÿç”¨'}
                                  </button>
                              </td>
                          </tr>
                      `).join('')}
                  </tbody>
              </table>
          `;
          document.getElementById('accountsTable').innerHTML = tableHtml;
      }

      async function searchAccounts() {
          const searchTerm = document.getElementById('accountSearch').value;
          const typeFilter = document.getElementById('accountTypeFilter').value;
          
          showLoading('accountsLoading', true);
          const result = await callAPI('getAccountsData', {
              search: searchTerm,
              type: typeFilter
          });
          showLoading('accountsLoading', false);
          
          if (result && result.success) {
              displayAccountsTable(result.data);
          }
      }

      // éŠ€è¡Œå¸³æˆ¶åŠŸèƒ½
      async function addBankAccount() {
          const bankData = {
              'å¸³æˆ¶åç¨±': document.getElementById('bankAccountName').value,
              'éŠ€è¡Œåç¨±': document.getElementById('bankName').value,
              'åˆ†è¡Œåç¨±': document.getElementById('bankBranch').value,
              'å¸³è™Ÿ': document.getElementById('bankAccountNumber').value,
              'å¸³æˆ¶é¡å‹': document.getElementById('bankAccountType').value,
              'ç›®å‰é¤˜é¡': parseFloat(document.getElementById('bankBalance').value) || 0,
              'å¹£åˆ¥': document.getElementById('bankCurrency').value,
              'èªªæ˜': document.getElementById('bankDescription').value
          };

          const result = await callAPI('addBankAccount', bankData);
          if (result) {
              showResult(result);
              if (result.success) {
                  clearBankForm();
                  loadBankAccounts();
              }
          }
      }

      function clearBankForm() {
          document.getElementById('bankForm').reset();
          document.getElementById('bankBalance').value = '0';
      }

      async function loadBankAccounts() {
          showLoading('banksLoading', true);
          const result = await callAPI('getBankAccountsData');
          showLoading('banksLoading', false);
          
          if (result && result.success) {
              displayBankAccountsTable(result.data);
          }
      }

      function displayBankAccountsTable(accounts) {
          const tableHtml = `
              <table class="data-table">
                  <thead>
                      <tr>
                          <th>å¸³æˆ¶åç¨±</th>
                          <th>éŠ€è¡Œ</th>
                          <th>å¸³è™Ÿ</th>
                          <th>é¡å‹</th>
                          <th>é¤˜é¡</th>
                          <th>å¹£åˆ¥</th>
                          <th>ç‹€æ…‹</th>
                          <th>æ“ä½œ</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${accounts.map(account => `
                          <tr>
                              <td>${account['å¸³æˆ¶åç¨±'] || ''}</td>
                              <td>${account['éŠ€è¡Œåç¨±'] || ''}</td>
                              <td>${account['å¸³è™Ÿ'] || ''}</td>
                              <td>${account['å¸³æˆ¶é¡å‹'] || ''}</td>
                              <td>$${parseFloat(account['ç›®å‰é¤˜é¡'] || 0).toLocaleString()}</td>
                              <td>${account['å¹£åˆ¥'] || 'TWD'}</td>
                              <td>
                                  <span class="badge ${account['æ˜¯å¦å•Ÿç”¨'] ? 'badge-success' : 'badge-warning'}">
                                      ${account['æ˜¯å¦å•Ÿç”¨'] ? 'å•Ÿç”¨' : 'åœç”¨'}
                                  </span>
                              </td>
                              <td>
                                  <button class="btn btn-secondary" onclick="editBankAccount('${account['ID']}')">ç·¨è¼¯</button>
                                  <button class="btn btn-primary" onclick="updateBalance('${account['ID']}')">æ›´æ–°é¤˜é¡</button>
                                  <button class="btn btn-${account['æ˜¯å¦å•Ÿç”¨'] ? 'danger' : 'success'}" 
                                          onclick="toggleBankStatus('${account['ID']}')">
                                      ${account['æ˜¯å¦å•Ÿç”¨'] ? 'åœç”¨' : 'å•Ÿç”¨'}
                                  </button>
                              </td>
                          </tr>
                      `).join('')}
                  </tbody>
              </table>
          `;
          document.getElementById('banksTable').innerHTML = tableHtml;
      }

      async function searchBankAccounts() {
          const searchTerm = document.getElementById('bankSearch').value;
          const statusFilter = document.getElementById('bankStatusFilter').value;
          
          showLoading('banksLoading', true);
          const result = await callAPI('getBankAccountsData', {
              search: searchTerm,
              enabled: statusFilter ? statusFilter === 'true' : undefined
          });
          showLoading('banksLoading', false);
          
          if (result && result.success) {
              displayBankAccountsTable(result.data);
          }
      }

      async function loadBankAccountsForSelect(selectId) {
          const result = await callAPI('getBankAccountsData', { enabled: true });
          if (result && result.success) {
              const select = document.getElementById(selectId);
              select.innerHTML = '<option value="">è«‹é¸æ“‡éŠ€è¡Œå¸³æˆ¶</option>';
              
              result.data.forEach(account => {
                  const option = document.createElement('option');
                  option.value = account['ID'];
                  option.textContent = `${account['å¸³æˆ¶åç¨±']} (${account['éŠ€è¡Œåç¨±']})`;
                  select.appendChild(option);
              });
          }
      }

      async function updateBalance(accountId) {
          const newBalance = prompt('è«‹è¼¸å…¥æ–°çš„é¤˜é¡:');
          if (newBalance !== null && !isNaN(parseFloat(newBalance))) {
              const result = await callAPI('updateAccountBalance', {
                  accountId: accountId,
                  newBalance: parseFloat(newBalance),
                  reason: 'æ‰‹å‹•æ›´æ–°',
                  recordTransaction: true
              });
              
              if (result) {
                  showResult(result);
                  if (result.success) {
                      loadBankAccounts();
                  }
              }
          }
      }

      async function toggleBankStatus(accountId) {
          const result = await callAPI('toggleBankAccountStatus', { accountId: accountId });
          if (result) {
              showResult(result);
              if (result.success) {
                  loadBankAccounts();
              }
          }
      }

      // å ±è¡¨åŠŸèƒ½
      async function generateReport() {
          const reportData = {
              startDate: document.getElementById('reportStartDate').value,
              endDate: document.getElementById('reportEndDate').value,
              type: document.getElementById('reportType').value
          };

          showLoading('reportsLoading', true);
          const result = await callAPI('generateReport', reportData);
          showLoading('reportsLoading', false);

          if (result && result.success) {
              displayReportResults(result.data);
          }
      }

      function displayReportResults(reportData) {
          let html = '';
          
          if (reportData.summary) {
              html += `
                  <div class="stats-grid">
                      <div class="stat-card">
                          <h4>ç¸½æ”¶å…¥</h4>
                          <div class="stat-value">$${reportData.summary.totalIncome.toLocaleString()}</div>
                      </div>
                      <div class="stat-card">
                          <h4>ç¸½æ”¯å‡º</h4>
                          <div class="stat-value">$${reportData.summary.totalExpenses.toLocaleString()}</div>
                      </div>
                      <div class="stat-card">
                          <h4>æ·¨æ”¶å…¥</h4>
                          <div class="stat-value">$${reportData.summary.netIncome.toLocaleString()}</div>
                      </div>
                  </div>
              `;
          }

          if (reportData.details && reportData.details.length > 0) {
              html += `
                  <table class="data-table">
                      <thead>
                          <tr>
                              ${Object.keys(reportData.details[0]).map(key => `<th>${key}</th>`).join('')}
                          </tr>
                      </thead>
                      <tbody>
                          ${reportData.details.map(row => `
                              <tr>
                                  ${Object.values(row).map(value => `<td>${value}</td>`).join('')}
                              </tr>
                          `).join('')}
                      </tbody>
                  </table>
              `;
          }

          document.getElementById('reportResults').innerHTML = html;
      }

      async function exportReport() {
          const reportData = {
              startDate: document.getElementById('reportStartDate').value,
              endDate: document.getElementById('reportEndDate').value,
              type: document.getElementById('reportType').value,
              export: true
          };

          const result = await callAPI('exportReport', reportData);
          if (result && result.success) {
              showResult({
                  success: true,
                  message: 'å ±è¡¨åŒ¯å‡ºæˆåŠŸï¼Œè«‹æª¢æŸ¥æ‚¨çš„Google Drive'
              });
          }
      }

      // ç³»çµ±è¨­å®šåŠŸèƒ½
      async function saveOrgSettings() {
          const orgData = {
              'çµ„ç¹”åç¨±': document.getElementById('orgName').value,
              'çµ„ç¹”åœ°å€': document.getElementById('orgAddress').value,
              'è¯çµ¡é›»è©±': document.getElementById('orgPhone').value,
              'é›»å­éƒµä»¶': document.getElementById('orgEmail').value,
              'çµ±ä¸€ç·¨è™Ÿ': document.getElementById('orgTaxId').value
          };

          const result = await callAPI('updateSettings', { organizationInfo: orgData });
          if (result) {
              showResult(result);
          }
      }

      async function loadOrgSettings() {
          const result = await callAPI('getSettings');
          if (result && result.success && result.data.organizationInfo) {
              const org = result.data.organizationInfo;
              document.getElementById('orgName').value = org['çµ„ç¹”åç¨±'] || '';
              document.getElementById('orgAddress').value = org['çµ„ç¹”åœ°å€'] || '';
              document.getElementById('orgPhone').value = org['è¯çµ¡é›»è©±'] || '';
              document.getElementById('orgEmail').value = org['é›»å­éƒµä»¶'] || '';
              document.getElementById('orgTaxId').value = org['çµ±ä¸€ç·¨è™Ÿ'] || '';
          }
      }

      function saveApiUrl() {
          const apiUrl = document.getElementById('apiUrl').value;
          if (apiUrl) {
              API_URL = apiUrl;
              localStorage.setItem('apiUrl', apiUrl);
              showResult({
                  success: true,
                  message: 'APIç¶²å€å·²å„²å­˜'
              });
          } else {
              showResult({
                  success: false,
                  message: 'è«‹è¼¸å…¥æœ‰æ•ˆçš„APIç¶²å€'
              });
          }
      }

      async function testApiConnection() {
          if (!API_URL) {
              showResult({
                  success: false,
                  message: 'è«‹å…ˆè¨­å®šAPIç¶²å€'
              });
              return;
          }

          const result = await callAPI('health');
          if (result) {
              showResult({
                  success: result.success,
                  message: result.success ? 'APIé€£ç·šæ¸¬è©¦æˆåŠŸ' : 'APIé€£ç·šæ¸¬è©¦å¤±æ•—'
              });
          }
      }

      async function backupData() {
          const result = await callAPI('backupData');
          if (result) {
              showResult(result);
          }
      }

      function confirmDataReset() {
          if (confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
              if (confirm('è«‹å†æ¬¡ç¢ºèªï¼šæ‚¨çœŸçš„è¦é‡ç½®æ•´å€‹ç³»çµ±å—ï¼Ÿ')) {
                  resetSystemData();
              }
          }
      }

      async function resetSystemData() {
          const result = await callAPI('resetSystem');
          if (result) {
              showResult(result);
              if (result.success) {
                  // é‡æ–°è¼‰å…¥é é¢
                  setTimeout(() => {
                      location.reload();
                  }, 2000);
              }
          }
      }

      // é€šç”¨ç·¨è¼¯å’Œåˆªé™¤åŠŸèƒ½
      async function editMember(memberId) {
          // å¯¦ä½œæœƒå“¡ç·¨è¼¯åŠŸèƒ½
          showModal('ç·¨è¼¯æœƒå“¡', 'ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­...');
      }

      async function deleteMember(memberId) {
          if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æœƒå“¡å—ï¼Ÿ')) {
              const result = await callAPI('deleteMember', { id: memberId });
              if (result) {
                  showResult(result);
                  if (result.success) {
                      loadMembers();
                  }
              }
          }
      }

      async function editIncome(incomeId) {
          showModal('ç·¨è¼¯æ”¶å…¥', 'ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­...');
      }

      async function deleteIncome(incomeId) {
          if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¶å…¥è¨˜éŒ„å—ï¼Ÿ')) {
              const result = await callAPI('deleteIncome', { id: incomeId });
              if (result) {
                  showResult(result);
                  if (result.success) {
                      loadIncome();
                  }
              }
          }
      }

      async function editExpense(expenseId) {
          showModal('ç·¨è¼¯æ”¯å‡º', 'ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­...');
      }

      async function deleteExpense(expenseId) {
          if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºè¨˜éŒ„å—ï¼Ÿ')) {
              const result = await callAPI('deleteExpense', { id: expenseId });
              if (result) {
                  showResult(result);
                  if (result.success) {
                      loadExpenses();
                  }
              }
          }
      }

      async function editAccount(accountId) {
          showModal('ç·¨è¼¯æœƒè¨ˆç§‘ç›®', 'ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­...');
      }

      async function toggleAccountStatus(accountId) {
          const result = await callAPI('toggleAccountStatus', { accountId: accountId });
          if (result) {
              showResult(result);
              if (result.success) {
                  loadAccounts();
              }
          }
      }

      async function editBankAccount(accountId) {
          showModal('ç·¨è¼¯éŠ€è¡Œå¸³æˆ¶', 'ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­...');
      }

      // æ¨¡æ…‹è¦–çª—åŠŸèƒ½
      function showModal(title, content) {
          document.getElementById('modalContent').innerHTML = `
              <h2>${title}</h2>
              <p>${content}</p>
          `;
          document.getElementById('modal').style.display = 'block';
      }

      function closeModal() {
          document.getElementById('modal').style.display = 'none';
      }

      // é»æ“Šæ¨¡æ…‹è¦–çª—å¤–éƒ¨é—œé–‰
      window.onclick = function(event) {
          const modal = document.getElementById('modal');
          if (event.target === modal) {
              closeModal();
          }
      }

      // å·¥å…·å‡½æ•¸
      function formatDate(dateString) {
          if (!dateString) return '';
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return dateString;
          return date.toLocaleDateString('zh-TW');
      }

      function formatCurrency(amount) {
          return new Intl.NumberFormat('zh-TW', {
              style: 'currency',
              currency: 'TWD'
          }).format(amount || 0);
      }

      // éµç›¤å¿«æ·éµ
      document.addEventListener('keydown', function(e) {
          // Ctrl + S å„²å­˜
          if (e.ctrlKey && e.key === 's') {
              e.preventDefault();
              // æ ¹æ“šç•¶å‰æ¨™ç±¤åŸ·è¡Œå°æ‡‰çš„å„²å­˜æ“ä½œ
              const activeTab = document.querySelector('.tab-content.active');
              if (activeTab) {
                  switch(activeTab.id) {
                      case 'members':
                          addMember();
                          break;
                      case 'income':
                          addIncome();
                          break;
                      case 'expenses':
                          addExpense();
                          break;
                      case 'accounts':
                          addAccount();
                          break;
                      case 'banks':
                          addBankAccount();
                          break;
                      case 'settings':
                          saveOrgSettings();
                          break;
                  }
              }
          }
          
          // Esc é—œé–‰æ¨¡æ…‹è¦–çª—
          if (e.key === 'Escape') {
              closeModal();
          }
      });

      // è‡ªå‹•å„²å­˜è‰ç¨¿åŠŸèƒ½
      function autoSaveDraft() {
          const forms = ['memberForm', 'incomeForm', 'expenseForm', 'accountForm', 'bankForm'];
          
          forms.forEach(formId => {
              const form = document.getElementById(formId);
              if (form) {
                  const inputs = form.querySelectorAll('input, select, textarea');
                  inputs.forEach(input => {
                      input.addEventListener('input', function() {
                          const draftKey = `draft_${formId}`;
                          const formData = new FormData(form);
                          const draftData = {};
                          
                          for (let [key, value] of formData.entries()) {
                              draftData[key] = value;
                          }
                          
                          localStorage.setItem(draftKey, JSON.stringify(draftData));
                      });
                  });
              }
          });
      }

      // è¼‰å…¥è‰ç¨¿
      function loadDrafts() {
          const forms = ['memberForm', 'incomeForm', 'expenseForm', 'accountForm', 'bankForm'];
          
          forms.forEach(formId => {
              const draftKey = `draft_${formId}`;
              const draftData = localStorage.getItem(draftKey);
              
              if (draftData) {
                  try {
                      const data = JSON.parse(draftData);
                      const form = document.getElementById(formId);
                      
                      if (form) {
                          Object.keys(data).forEach(key => {
                              const input = form.querySelector(`[name="${key}"]`);
                              if (input) {
                                  input.value = data[key];
                              }
                          });
                      }
                  } catch (error) {
                      console.error('è¼‰å…¥è‰ç¨¿éŒ¯èª¤:', error);
                  }
              }
          });
      }

      // æ¸…é™¤è‰ç¨¿
      function clearDraft(formId) {
          const draftKey = `draft_${formId}`;
          localStorage.removeItem(draftKey);
      }

      // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
      window.addEventListener('load', function() {
          autoSaveDraft();
          loadDrafts();
          
          // è¨­å®šæ—¥æœŸæ¬„ä½é è¨­å€¼ç‚ºä»Šå¤©
          const today = new Date().toISOString().split('T')[0];
          const dateInputs = document.querySelectorAll('input[type="date"]');
          dateInputs.forEach(input => {
              if (!input.value) {
                  input.value = today;
              }
          });
      });

      // éŸ¿æ‡‰å¼è¨­è¨ˆæ”¯æ´
      function handleResize() {
          const container = document.querySelector('.container');
          if (window.innerWidth < 768) {
              container.classList.add('mobile');
          } else {
              container.classList.remove('mobile');
          }
      }

      window.addEventListener('resize', handleResize);
      handleResize(); // åˆå§‹åŸ·è¡Œ

      // åˆ—å°åŠŸèƒ½
      function printReport() {
          const reportContent = document.getElementById('reportResults').innerHTML;
          if (reportContent) {
              const printWindow = window.open('', '_blank');
              printWindow.document.write(`
                  <html>
                      <head>
                          <title>è²¡å‹™å ±è¡¨</title>
                          <style>
                              body { font-family: Arial, sans-serif; }
                              table { width: 100%; border-collapse: collapse; }
                              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                              th { background-color: #f2f2f2; }
                              .stat-card { display: inline-block; margin: 10px; padding: 15px; border: 1px solid #ddd; }
                          </style>
                      </head>
                      <body>
                          <h1>è²¡å‹™å ±è¡¨</h1>
                          ${reportContent}
                      </body>
                  </html>
              `);
              printWindow.document.close();
              printWindow.print();
          }
      }

      // åŒ¯å‡ºCSVåŠŸèƒ½
      function exportToCSV(data, filename) {
          if (!data || data.length === 0) return;
          
          const headers = Object.keys(data[0]);
          const csvContent = [
              headers.join(','),
              ...data.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
          ].join('\n');
          
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          
          if (link.download !== undefined) {
              const url = URL.createObjectURL(blob);
              link.setAttribute('href', url);
              link.setAttribute('download', filename);
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
          }
      }

      // åˆå§‹åŒ–å®Œæˆæç¤º
      console.log('ğŸ’° éç‡Ÿåˆ©çµ„ç¹”è²¡å‹™ç®¡ç†ç³»çµ±å·²è¼‰å…¥å®Œæˆ');
      console.log('ğŸš€ è«‹åœ¨ç³»çµ±è¨­å®šä¸­è¨­å®šæ‚¨çš„Google Apps Script APIç¶²å€');
  </script>

  <!-- æ–°å¢CSSæ¨£å¼ -->
  <style>
      .badge {
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 12px;
          font-weight: bold;
          text-transform: uppercase;
      }

      .badge-success {
          background-color: #28a745;
          color: white;
      }

      .badge-warning {
          background-color: #ffc107;
          color: #212529;
      }

      .badge-danger {
          background-color: #dc3545;
          color: white;
      }

      .mobile .form-grid {
          grid-template-columns: 1fr;
      }

      .mobile .nav-tabs {
          overflow-x: auto;
          white-space: nowrap;
      }

      .mobile .nav-tab {
          min-width: 100px;
          font-size: 14px;
      }

      .mobile .data-table {
          font-size: 12px;
      }

      .mobile .data-table th,
      .mobile .data-table td {
          padding: 6px;
      }

      @media print {
          .nav-tabs,
          .btn,
          .search-box {
              display: none !important;
          }
          
          .tab-content {
              display: block !important;
          }
      }

      /* è¼‰å…¥å‹•ç•« */
      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .loading::before {
          content: '';
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid #667eea;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-right: 10px;
      }

      /* æˆåŠŸå‹•ç•« */
      @keyframes fadeInUp {
          from {
              opacity: 0;
              transform: translateY(30px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }

      .alert {
          animation: fadeInUp 0.5s ease-out;
      }

      /* æŒ‰éˆ•æ‡¸åœæ•ˆæœ */
      .btn {
          position: relative;
          overflow: hidden;
      }

      .btn::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
          transition: left 0.5s;
      }

      .btn:hover::before {
          left: 100%;
      }
  </style>
</body>
</html>
      
