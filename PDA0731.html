<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會 - 會計管理系統</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <!-- SweetAlert2 -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <style>
      :root {
          --primary-color: #2c5aa0;
          --secondary-color: #f8f9fa;
          --success-color: #198754;
          --danger-color: #dc3545;
          --warning-color: #ffc107;
      }

      body {
          background-color: var(--secondary-color);
          font-family: 'Microsoft JhengHei', sans-serif;
      }

      .navbar-brand {
          font-weight: bold;
          color: var(--primary-color) !important;
      }

      .card {
          border: none;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          transition: transform 0.2s;
          border-radius: 12px;
      }

      .card:hover {
          transform: translateY(-2px);
      }

      .stat-card {
          background: linear-gradient(135deg, var(--primary-color), #4a90e2);
          color: white;
          border-radius: 15px;
      }

      .stat-card h3 {
          font-size: 2.5rem;
          font-weight: bold;
      }

      .btn-primary {
          background-color: var(--primary-color);
          border-color: var(--primary-color);
          border-radius: 8px;
          font-weight: 500;
      }

      .btn-primary:hover {
          background-color: #1e3d6f;
          border-color: #1e3d6f;
      }

      .table th {
          background-color: var(--secondary-color);
          font-weight: 600;
          border-top: none;
      }

      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }

      .loading-spinner {
          color: white;
          font-size: 3rem;
      }

      .sync-status {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 1000;
      }

      .member-avatar {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          background-color: var(--secondary-color);
          font-size: 18px;
          color: #6c757d;
      }

      .action-buttons {
          display: flex;
          gap: 5px;
      }

      .action-buttons .btn {
          padding: 0.25rem 0.5rem;
      }

      .chart-container {
          position: relative;
          height: 400px;
      }

      .sidebar {
          min-height: 100vh;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .sidebar .nav-link {
          color: rgba(255,255,255,0.8);
          padding: 12px 20px;
          border-radius: 8px;
          margin: 4px 0;
          transition: all 0.3s ease;
      }

      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
          color: white;
          background-color: rgba(255,255,255,0.2);
          transform: translateX(5px);
      }

      .main-content {
          padding: 20px;
      }

      .content-section {
          animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .toast-container {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 1055;
      }

      .spin {
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .voucher-preview {
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
          margin-top: 10px;
      }

      .voucher-preview img {
          max-width: 100px;
          max-height: 100px;
          object-fit: cover;
          border-radius: 5px;
          margin: 5px;
          cursor: pointer;
          border: 1px solid #ddd;
      }

      .voucher-preview-pdf {
          width: 100px;
          height: 100px;
          border: 1px solid #ddd;
          border-radius: 4px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          text-align: center;
          font-size: 10px;
          padding: 5px;
      }

      .search-summary {
          background-color: #e3f2fd;
          border-left: 4px solid var(--primary-color);
          padding: 10px 15px;
          margin-bottom: 20px;
      }

      .form-control, .form-select {
          border-radius: 8px;
          border: 1px solid #e0e0e0;
      }

      .form-control:focus, .form-select:focus {
          border-color: #667eea;
          box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }

      .modal-content {
          border-radius: 12px;
          border: none;
      }

      .modal-header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border-radius: 12px 12px 0 0;
      }

      .pagination .page-link {
          border-radius: 8px;
          margin: 0 2px;
          border: none;
          color: #667eea;
      }

      .pagination .page-item.active .page-link {
          background: #667eea;
          border-color: #667eea;
      }

      /* 同步相關樣式 */
      .sync-stats {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          margin-bottom: 20px;
      }

      .stat-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 10px;
          background: #f8f9fa;
          border-radius: 8px;
      }

      .stat-label {
          font-weight: 500;
          color: #6c757d;
      }

      .stat-value {
          font-weight: bold;
          color: #495057;
      }

      .sync-history {
          max-height: 200px;
          overflow-y: auto;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          padding: 10px;
      }

      .sync-history-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 5px 0;
          border-bottom: 1px solid #f1f3f4;
      }

      .sync-history-item:last-child {
          border-bottom: none;
      }

      .conflict-resolution {
          text-align: left;
      }

      .conflict-data {
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          border-radius: 4px;
          padding: 10px;
          margin-top: 10px;
      }

      .conflict-data pre {
          font-size: 12px;
          margin: 0;
          white-space: pre-wrap;
          word-break: break-word;
      }

      .conflict-popup {
          max-width: 800px;
      }

      @media (max-width: 768px) {
          .sidebar {
              min-height: auto;
              position: fixed;
              z-index: 1000;
              transform: translateX(-100%);
              transition: transform 0.3s ease;
          }
          
          .sidebar.show {
              transform: translateX(0);
          }
          
          .main-content {
              margin-left: 0;
          }
          
          .stat-card h3 {
              font-size: 1.8rem;
          }
          
          .action-buttons {
              flex-direction: column;
          }
          
          .table-responsive {
              font-size: 0.875rem;
          }
          
          .sync-stats {
              grid-template-columns: 1fr;
          }
          
          .conflict-popup {
              max-width: 95vw;
          }
      }

      @media print {
          .sidebar, .no-print {
              display: none !important;
          }
          
          .main-content {
              margin-left: 0 !important;
          }
      }
  </style>
</head>
<body>
  <!-- 載入中覆蓋層 -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
      <div class="text-center">
          <div class="loading-spinner">
              <i class="bi bi-arrow-clockwise spin"></i>
          </div>
          <div class="text-white mt-3">載入中...</div>
      </div>
  </div>

  <!-- 同步狀態指示器 -->
  <div id="syncStatus" class="sync-status">
      <span class="badge bg-success" id="syncIndicator">
          <i class="bi bi-cloud-check"></i> 已同步
      </span>
  </div>

  <!-- 導航列 -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
      <div class="container-fluid">
          <a class="navbar-brand" href="#">
              <i class="bi bi-heart-pulse me-2"></i>
              台灣帕金森病友權益促進會
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
              <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav ms-auto">
                  <li class="nav-item">
                      <button class="btn btn-outline-primary me-2" onclick="manualSync()" title="手動同步">
                          <i class="bi bi-cloud-arrow-up-down"></i>
                      </button>
                  </li>
                  <li class="nav-item dropdown">
                      <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                          <i class="bi bi-gear"></i> 系統
                      </a>
                      <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="#" onclick="showSystemSettings()">
                              <i class="bi bi-gear-fill"></i> 系統設定
                          </a></li>
                          <li><a class="dropdown-item" href="#" onclick="showSyncSettings()">
                              <i class="bi bi-cloud-arrow-up-down"></i> 同步設定
                          </a></li>
                          <li><hr class="dropdown-divider"></li>
                          <li><a class="dropdown-item" href="#" onclick="createCloudBackup()">
                              <i class="bi bi-cloud-arrow-up"></i> 創建雲端備份
                          </a></li>
                          <li><a class="dropdown-item" href="#" onclick="exportAllData()">
                              <i class="bi bi-download"></i> 匯出資料
                          </a></li>
                          <li><a class="dropdown-item" href="#" onclick="importAllData()">
                              <i class="bi bi-upload"></i> 匯入資料
                          </a></li>
                          <li><hr class="dropdown-divider"></li>
                          <li><a class="dropdown-item" href="#" onclick="showSyncStatus()">
                              <i class="bi bi-info-circle"></i> 同步狀態
                          </a></li>
                          <li><a class="dropdown-item" href="#" onclick="showKeyboardShortcuts()">
                              <i class="bi bi-keyboard"></i> 快捷鍵
                          </a></li>
                          <li><a class="dropdown-item" href="#" onclick="showSystemHelp()">
                              <i class="bi bi-question-circle"></i> 使用說明
                          </a></li>
                          <li><a class="dropdown-item" href="#" onclick="showAboutSystem()">
                              <i class="bi bi-info-circle"></i> 關於系統
                          </a></li>
                      </ul>
                  </li>
              </ul>
          </div>
      </div>
  </nav>

  <div class="container-fluid">
      <div class="row">
          <!-- 側邊欄 -->
          <div class="col-md-2 sidebar text-white p-0">
              <div class="p-3">
                  <h6 class="text-center mb-4">會計管理系統</h6>
                  <nav class="nav flex-column">
                      <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                          <i class="bi bi-speedometer2 me-2"></i>儀表板
                      </a>
                      <a class="nav-link" href="#" onclick="showSection('transactions')">
                          <i class="bi bi-receipt me-2"></i>交易記錄
                      </a>
                      <a class="nav-link" href="#" onclick="showSection('members')">
                          <i class="bi bi-people me-2"></i>會員管理
                      </a>
                      <a class="nav-link" href="#" onclick="showSection('analytics')">
                          <i class="bi bi-graph-up me-2"></i>統計分析
                      </a>
                      <a class="nav-link" href="#" onclick="showSection('reports')">
                          <i class="bi bi-file-earmark-text me-2"></i>報表
                      </a>
                  </nav>
              </div>
          </div>

          <!-- 主要內容區 -->
          <div class="col-md-10 main-content">
              <!-- 儀表板 -->
              <div id="dashboardSection" class="content-section">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                      <h2><i class="bi bi-speedometer2"></i> 儀表板</h2>
                      <div>
                          <button class="btn btn-primary me-2" onclick="showTransactionModal()">
                              <i class="bi bi-plus-circle"></i> 新增交易
                          </button>
                          <button class="btn btn-success" onclick="showMemberModal()">
                              <i class="bi bi-person-plus"></i> 新增會員
                          </button>
                      </div>
                  </div>

                  <!-- 統計卡片 -->
                  <div class="row mb-4">
                      <div class="col-md-3 mb-3">
                          <div class="card stat-card">
                              <div class="card-body text-center">
                                  <i class="bi bi-cash-coin display-4 mb-2"></i>
                                  <h3 id="totalIncome">$0</h3>
                                  <p class="mb-0">總收入</p>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-3 mb-3">
                          <div class="card stat-card">
                              <div class="card-body text-center">
                                  <i class="bi bi-credit-card display-4 mb-2"></i>
                                  <h3 id="totalExpense">$0</h3>
                                  <p class="mb-0">總支出</p>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-3 mb-3">
                          <div class="card stat-card">
                              <div class="card-body text-center">
                                  <i class="bi bi-people display-4 mb-2"></i>
                                  <h3 id="totalMembers">0</h3>
                                  <p class="mb-0">會員總數</p>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-3 mb-3">
                          <div class="card stat-card">
                              <div class="card-body text-center">
                                  <i class="bi bi-exclamation-triangle display-4 mb-2"></i>
                                  <h3 id="overdueMembers">0</h3>
                                  <p class="mb-0">逾期會費</p>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- 最近交易和會員 -->
                  <div class="row">
                      <div class="col-md-6">
                          <div class="card">
                              <div class="card-header">
                                  <h5><i class="bi bi-clock-history"></i> 最近交易</h5>
                              </div>
                              <div class="card-body">
                                  <div id="recentTransactions">
                                      <div class="text-center text-muted">
                                          <i class="bi bi-receipt display-4"></i>
                                          <p>尚無交易記錄</p>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="card">
                              <div class="card-header">
                                  <h5><i class="bi bi-person-plus"></i> 新加入會員</h5>
                              </div>
                              <div class="card-body">
                                  <div id="recentMembers">
                                      <div class="text-center text-muted">
                                          <i class="bi bi-people display-4"></i>
                                          <p>尚無會員資料</p>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 交易記錄區 -->
              <div id="transactionsSection" class="content-section" style="display: none;">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                      <h2><i class="bi bi-receipt"></i> 交易記錄</h2>
                      <div>
                          <button class="btn btn-outline-secondary me-2" onclick="showAdvancedSearch()">
                              <i class="bi bi-search"></i> 進階搜尋
                          </button>
                          <button class="btn btn-primary" onclick="showTransactionModal()">
                              <i class="bi bi-plus-circle"></i> 新增交易
                          </button>
                      </div>
                  </div>

                  <!-- 搜尋結果摘要 -->
                  <div id="searchSummary"></div>

                  <!-- 篩選區 -->
                  <div class="card mb-4">
                      <div class="card-body">
                          <div class="row">
                              <div class="col-md-2">
                                  <select class="form-select" id="filterYear" onchange="displayTransactions()">
                                      <option value="">所有年份</option>
                                  </select>
                              </div>
                              <div class="col-md-2">
                                  <select class="form-select" id="filterMonth" onchange="displayTransactions()">
                                      <option value="">所有月份</option>
                                      <option value="1">1月</option>
                                      <option value="2">2月</option>
                                      <option value="3">3月</option>
                                      <option value="4">4月</option>
                                      <option value="5">5月</option>
                                      <option value="6">6月</option>
                                      <option value="7">7月</option>
                                      <option value="8">8月</option>
                                      <option value="9">9月</option>
                                      <option value="10">10月</option>
                                      <option value="11">11月</option>
                                      <option value="12">12月</option>
                                  </select>
                              </div>
                              <div class="col-md-2">
                                  <select class="form-select" id="filterType" onchange="displayTransactions()">
                                      <option value="">所有類型</option>
                                      <option value="收入">收入</option>
                                      <option value="支出">支出</option>
                                  </select>
                              </div>
                              <div class="col-md-4">
                                  <input type="text" class="form-control" id="searchKeyword" placeholder="搜尋交易記錄..." oninput="displayTransactions()">
                              </div>
                              <div class="col-md-2">
                                  <button class="btn btn-outline-secondary" onclick="exportTransactionsToExcel()">
                                      <i class="bi bi-download"></i> 匯出
                                  </button>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- 交易記錄表格 -->
                  <div class="card">
                      <div class="card-body">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                              <span id="recordCount">0 筆記錄</span>
                              <div>
                                  <select class="form-select d-inline-block w-auto me-2" id="batchAction">
                                      <option value="">批量操作</option>
                                      <option value="delete">刪除</option>
                                      <option value="export">匯出</option>
                                      <option value="print">列印收據</option>
                                  </select>
                                  <button class="btn btn-outline-primary btn-sm" onclick="performBatchAction()">
                                      <i class="bi bi-check2-square"></i> 執行
                                  </button>
                              </div>
                          </div>
                          <div class="table-responsive">
                              <table class="table table-hover">
                                  <thead>
                                      <tr>
                                          <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                          <th>日期</th>
                                          <th>類型</th>
                                          <th>類別</th>
                                          <th>金額</th>
                                          <th>對象</th>
                                          <th>說明</th>
                                          <th>憑證</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody id="transactionTableBody">
                                      <tr>
                                          <td colspan="9" class="text-center py-4">
                                              <i class="bi bi-receipt display-4 text-muted"></i>
                                              <div class="mt-2">尚無交易記錄</div>
                                              <button class="btn btn-primary mt-2" onclick="showTransactionModal()">
                                                  <i class="bi bi-plus-circle"></i> 新增第一筆交易
                                              </button>
                                          </td>
                                      </tr>
                                  </tbody>
                              </table>
                          </div>
                          <!-- 分頁 -->
                          <nav>
                              <ul class="pagination justify-content-center" id="pagination">
                              </ul>
                          </nav>
                      </div>
                  </div>
              </div>

              <!-- 會員管理區 -->
              <div id="membersSection" class="content-section" style="display: none;">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                      <h2><i class="bi bi-people"></i> 會員管理</h2>
                      <button class="btn btn-success" onclick="showMemberModal()">
                          <i class="bi bi-person-plus"></i> 新增會員
                      </button>
                  </div>

                  <!-- 會員統計 -->
                  <div class="row mb-4">
                      <div class="col-md-3 mb-3">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h4 id="totalMembersCount">0</h4>
                                  <p class="text-muted mb-0">總會員數</p>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-3 mb-3">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h4 id="activeMembersCount">0</h4>
                                  <p class="text-muted mb-0">正常會員</p>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-3 mb-3">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h4 id="overdueMembersCount">0</h4>
                                  <p class="text-muted mb-0">逾期會費</p>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-3 mb-3">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h4 id="newMembersCount">0</h4>
                                  <p class="text-muted mb-0">本月新增</p>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- 篩選區 -->
                  <div class="card mb-4">
                      <div class="card-body">
                          <div class="row">
                              <div class="col-md-3">
                                  <select class="form-select" id="memberFilter" onchange="displayMembers()">
                                      <option value="">所有狀態</option>
                                      <option value="active">正常</option>
                                      <option value="inactive">停權</option>
                                      <option value="pending">待審核</option>
                                  </select>
                              </div>
                              <div class="col-md-6">
                                  <input type="text" class="form-control" id="memberSearch" placeholder="搜尋會員姓名、電話、電子郵件..." oninput="displayMembers()">
                              </div>
                              <div class="col-md-3">
                                  <button class="btn btn-outline-secondary me-2" onclick="exportMembersToExcel()">
                                      <i class="bi bi-download"></i> 匯出
                                  </button>
                                  <select class="form-select d-inline-block w-auto" id="memberBatchAction">
                                      <option value="">批量操作</option>
                                      <option value="export">匯出</option>
                                      <option value="sendEmail">發送郵件</option>
                                      <option value="updateStatus">更新狀態</option>
                                      <option value="delete">刪除</option>
                                  </select>
                                  <button class="btn btn-outline-primary btn-sm" onclick="performMemberBatchAction()">
                                      <i class="bi bi-check2-square"></i> 執行
                                  </button>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- 會員列表 -->
                  <div class="card">
                      <div class="card-body">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                              <span id="memberRecordCount">0 筆記錄</span>
                          </div>
                          <div class="table-responsive">
                              <table class="table table-hover">
                                  <thead>
                                      <tr>
                                          <th><input type="checkbox" id="selectAllMembers" onchange="toggleSelectAllMembers()"></th>
                                          <th>會員資料</th>
                                          <th>聯絡方式</th>
                                          <th>年齡/性別</th>
                                          <th>加入日期</th>
                                          <th>狀態</th>
                                          <th>會費狀態</th>
                                          <th>標籤</th>
                                          <th>操作</th>
                                      </tr>
                                  </thead>
                                  <tbody id="memberTableBody">
                                      <tr>
                                          <td colspan="9" class="text-center py-4">
                                              <i class="bi bi-people display-4 text-muted"></i>
                                              <div class="mt-2">尚無會員資料</div>
                                              <button class="btn btn-success mt-2" onclick="showMemberModal()">
                                                  <i class="bi bi-person-plus"></i> 新增第一位會員
                                              </button>
                                          </td>
                                      </tr>
                                  </tbody>
                              </table>
                          </div>
                          <!-- 會員分頁 -->
                          <nav>
                              <ul class="pagination justify-content-center" id="memberPagination">
                              </ul>
                          </nav>
                      </div>
                  </div>
              </div>

              <!-- 統計分析區 -->
              <div id="analyticsSection" class="content-section" style="display: none;">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                      <h2><i class="bi bi-graph-up"></i> 統計分析</h2>
                      <div>
                          <select class="form-select d-inline-block w-auto me-2" id="analyticsYear" onchange="updateAnalytics()">
                              <option value="">選擇年份</option>
                          </select>
                          <select class="form-select d-inline-block w-auto" id="analyticsMonth" onchange="updateAnalytics()">
                              <option value="">所有月份</option>
                              <option value="1">1月</option>
                              <option value="2">2月</option>
                              <option value="3">3月</option>
                              <option value="4">4月</option>
                              <option value="5">5月</option>
                              <option value="6">6月</option>
                              <option value="7">7月</option>
                              <option value="8">8月</option>
                              <option value="9">9月</option>
                              <option value="10">10月</option>
                              <option value="11">11月</option>
                              <option value="12">12月</option>
                          </select>
                      </div>
                  </div>

                  <!-- 圖表區 -->
                  <div class="row mb-4">
                      <div class="col-md-6">
                          <div class="card">
                              <div class="card-header">
                                  <h5>收支趨勢</h5>
                              </div>
                              <div class="card-body">
                                  <div class="chart-container">
                                      <canvas id="trendChart"></canvas>
                                  </div>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="card">
                              <div class="card-header">
                                  <h5>支出類別分析</h5>
                              </div>
                              <div class="card-body">
                                  <div class="chart-container">
                                      <canvas id="categoryChart"></canvas>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-6">
                          <div class="card">
                              <div class="card-header">
                                  <h5>月度收支對比</h5>
                              </div>
                              <div class="card-body">
                                  <div class="chart-container">
                                      <canvas id="monthlyChart"></canvas>
                                  </div>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="card">
                              <div class="card-header">
                                  <h5>會員成長趨勢</h5>
                              </div>
                              <div class="card-body">
                                  <div class="chart-container">
                                      <canvas id="memberGrowthChart"></canvas>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 報表區 -->
              <div id="reportsSection" class="content-section" style="display: none;">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                      <h2><i class="bi bi-file-earmark-text"></i> 報表</h2>
                  </div>

                  <!-- 報表參數設定 -->
                  <div class="card mb-4">
                      <div class="card-body">
                          <div class="row">
                              <div class="col-md-3">
                                  <label for="reportType" class="form-label">報表類型</label>
                                  <select class="form-select" id="reportType">
                                      <option value="financial">財務報表</option>
                                      <option value="member">會員報表</option>
                                      <option value="dues">會費報表</option>
                                      <option value="activity">活動報表</option>
                                  </select>
                              </div>
                              <div class="col-md-3">
                                  <label for="reportStartDate" class="form-label">開始日期</label>
                                  <input type="date" class="form-control" id="reportStartDate">
                              </div>
                              <div class="col-md-3">
                                  <label for="reportEndDate" class="form-label">結束日期</label>
                                  <input type="date" class="form-control" id="reportEndDate">
                              </div>
                              <div class="col-md-3">
                                  <label class="form-label">&nbsp;</label>
                                  <div>
                                      <button class="btn btn-primary" onclick="generateReport()">
                                          <i class="bi bi-file-earmark-bar-graph"></i> 產生報表
                                      </button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-4 mb-3">
                          <div class="card">
                              <div class="card-body text-center">
                                  <i class="bi bi-file-earmark-bar-graph display-4 text-primary mb-3"></i>
                                  <h5>財務報表</h5>
                                  <p class="text-muted">生成詳細的收支報表</p>
                                  <button class="btn btn-primary" onclick="generateFinancialReport()">
                                      <i class="bi bi-download"></i> 生成報表
                                  </button>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-4 mb-3">
                          <div class="card">
                              <div class="card-body text-center">
                                  <i class="bi bi-people-fill display-4 text-success mb-3"></i>
                                  <h5>會員報表</h5>
                                  <p class="text-muted">會員統計與分析報表</p>
                                  <button class="btn btn-success" onclick="generateMemberReport()">
                                      <i class="bi bi-download"></i> 生成報表
                                  </button>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-4 mb-3">
                          <div class="card">
                              <div class="card-body text-center">
                                  <i class="bi bi-receipt-cutoff display-4 text-warning mb-3"></i>
                                  <h5>會費報表</h5>
                                  <p class="text-muted">會費收繳狀況報表</p>
                                  <button class="btn btn-warning" onclick="generateDuesReport()">
                                      <i class="bi bi-download"></i> 生成報表
                                  </button>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- 交易記錄模態框 -->
  <div class="modal fade" id="transactionModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="bi bi-receipt"></i>
                      <span id="transactionModalTitle">新增交易記錄</span>
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="transactionForm">
                      <input type="hidden" id="transactionId">
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="date" class="form-label">日期 *</label>
                                  <input type="date" class="form-control" id="date" required>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="type" class="form-label">類型 *</label>
                                  <select class="form-select" id="type" required onchange="updateCategoryOptions()">
                                      <option value="">請選擇</option>
                                      <option value="收入">收入</option>
                                      <option value="支出">支出</option>
                                  </select>
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="category" class="form-label">類別 *</label>
                                  <select class="form-select" id="category" required>
                                      <option value="">請選擇類型後選擇類別</option>
                                  </select>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="amount" class="form-label">金額 *</label>
                                  <input type="number" class="form-control" id="amount" required min="0" step="1">
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="counterparty" class="form-label">對象</label>
                                  <input type="text" class="form-control" id="counterparty" list="counterpartyList">
                                  <datalist id="counterpartyList"></datalist>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="account" class="form-label">帳戶</label>
                                  <select class="form-select" id="account">
                                      <option value="現金">現金</option>
                                      <option value="銀行">銀行</option>
                                      <option value="支票">支票</option>
                                      <option value="信用卡">信用卡</option>
                                  </select>
                              </div>
                          </div>
                      </div>
                      <div class="mb-3">
                          <label for="description" class="form-label">說明</label>
                          <textarea class="form-control" id="description" rows="3"></textarea>
                      </div>
                      <div class="mb-3">
                          <label for="receiptNumber" class="form-label">收據編號</label>
                          <input type="text" class="form-control" id="receiptNumber" placeholder="自動生成">
                      </div>
                      <div class="mb-3">
                          <label for="voucherFiles" class="form-label">上傳憑證</label>
                          <input type="file" class="form-control" id="voucherFiles" multiple accept="image/*,application/pdf" onchange="handleVoucherUpload(event)">
                          <div class="form-text">支援圖片和PDF格式，可選擇多個檔案</div>
                          <div id="voucherPreview" class="mt-2 voucher-preview"></div>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="saveTransaction()">
                      <i class="bi bi-save"></i> 儲存
                  </button>
              </div>
          </div>
      </div>
  </div>

  <!-- 會員模態框 -->
  <div class="modal fade" id="memberModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="bi bi-person"></i>
                      <span id="memberModalTitle">新增會員</span>
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="memberForm">
                      <input type="hidden" id="memberId">
                      <div class="row">
                          <div class="col-md-4">
                              <h6><i class="bi bi-person-badge"></i> 基本資料</h6>
                              <div class="mb-3">
                                  <label for="memberName" class="form-label">姓名 *</label>
                                  <input type="text" class="form-control" id="memberName" required>
                              </div>
                              <div class="mb-3">
                                  <label for="memberPhone" class="form-label">電話 *</label>
                                  <input type="tel" class="form-control" id="memberPhone" required>
                              </div>
                              <div class="mb-3">
                                  <label for="memberEmail" class="form-label">電子郵件</label>
                                  <input type="email" class="form-control" id="memberEmail">
                              </div>
                              <div class="row">
                                  <div class="col-6">
                                      <div class="mb-3">
                                          <label for="memberBirthDate" class="form-label">出生日期</label>
                                          <input type="date" class="form-control" id="memberBirthDate">
                                      </div>
                                  </div>
                                  <div class="col-6">
                                      <div class="mb-3">
                                          <label for="memberGender" class="form-label">性別</label>
                                          <select class="form-select" id="memberGender">
                                              <option value="">請選擇</option>
                                              <option value="男">男</option>
                                              <option value="女">女</option>
                                              <option value="其他">其他</option>
                                          </select>
                                      </div>
                                  </div>
                              </div>
                              <div class="mb-3">
                                  <label for="memberIdNumber" class="form-label">身分證字號</label>
                                  <input type="text" class="form-control" id="memberIdNumber" maxlength="10">
                              </div>
                          </div>
                          <div class="col-md-4">
                              <h6><i class="bi bi-geo-alt"></i> 聯絡資訊</h6>
                              <div class="mb-3">
                                  <label for="memberAddress" class="form-label">地址</label>
                                  <textarea class="form-control" id="memberAddress" rows="3"></textarea>
                              </div>
                              <div class="mb-3">
                                  <label for="emergencyContact" class="form-label">緊急聯絡人</label>
                                  <input type="text" class="form-control" id="emergencyContact">
                              </div>
                              <div class="mb-3">
                                  <label for="emergencyPhone" class="form-label">緊急聯絡電話</label>
                                  <input type="tel" class="form-control" id="emergencyPhone">
                              </div>
                              <div class="mb-3">
                                  <label for="memberNotes" class="form-label">備註</label>
                                  <textarea class="form-control" id="memberNotes" rows="3"></textarea>
                              </div>
                          </div>
                          <div class="col-md-4">
                              <h6><i class="bi bi-card-checklist"></i> 會員資訊</h6>
                              <div class="mb-3">
                                  <label for="memberJoinDate" class="form-label">加入日期 *</label>
                                  <input type="date" class="form-control" id="memberJoinDate" required>
                              </div>
                              <div class="mb-3">
                                  <label for="memberStatus" class="form-label">會員狀態</label>
                                  <select class="form-select" id="memberStatus">
                                      <option value="active">正常</option>
                                      <option value="inactive">停權</option>
                                      <option value="pending">待審核</option>
                                  </select>
                              </div>
                              <div class="mb-3">
                                  <label for="memberType" class="form-label">會員類型</label>
                                  <select class="form-select" id="memberType">
                                      <option value="regular">一般會員</option>
                                      <option value="honorary">榮譽會員</option>
                                      <option value="life">終身會員</option>
                                      <option value="family">家屬會員</option>
                                  </select>
                              </div>
                              <div class="mb-3">
                                  <label for="membershipFee" class="form-label">年費金額</label>
                                  <input type="number" class="form-control" id="membershipFee" value="1000" min="0">
                              </div>
                              <div class="mb-3">
                                  <label for="lastPaymentDate" class="form-label">最後繳費日期</label>
                                  <input type="date" class="form-control" id="lastPaymentDate">
                              </div>
                              <div class="mb-3">
                                  <label for="memberTags" class="form-label">標籤</label>
                                  <input type="text" class="form-control" id="memberTags" placeholder="用逗號分隔多個標籤">
                                  <div class="form-text">例如：病友,志工,理事</div>
                              </div>
                          </div>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-success" onclick="saveMember()">
                      <i class="bi bi-save"></i> 儲存
                  </button>
              </div>
          </div>
      </div>
  </div>

  <!-- 會員詳情模態框 -->
  <div class="modal fade" id="memberDetailModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="bi bi-person-circle"></i> 會員詳情
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="memberDetailContent">
                  <!-- 會員詳情內容將動態載入 -->
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-outline-primary" onclick="printMemberCard()">
                      <i class="bi bi-printer"></i> 列印會員卡
                  </button>
                  <button type="button" class="btn btn-primary" onclick="editMemberFromDetail()">
                      <i class="bi bi-pencil"></i> 編輯
                  </button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
              </div>
          </div>
      </div>
  </div>

  <!-- 進階搜尋模態框 -->
  <div class="modal fade" id="advancedSearchModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="bi bi-search"></i> 進階搜尋
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="advancedSearchForm">
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="searchStartDate" class="form-label">開始日期</label>
                                  <input type="date" class="form-control" id="searchStartDate">
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="searchEndDate" class="form-label">結束日期</label>
                                  <input type="date" class="form-control" id="searchEndDate">
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="searchType" class="form-label">交易類型</label>
                                  <select class="form-select" id="searchType">
                                      <option value="">所有類型</option>
                                      <option value="收入">收入</option>
                                      <option value="支出">支出</option>
                                  </select>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="searchCategory" class="form-label">類別</label>
                                  <select class="form-select" id="searchCategory">
                                      <option value="">所有類別</option>
                                  </select>
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="searchMinAmount" class="form-label">最小金額</label>
                                  <input type="number" class="form-control" id="searchMinAmount" min="0">
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="searchMaxAmount" class="form-label">最大金額</label>
                                  <input type="number" class="form-control" id="searchMaxAmount" min="0">
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="searchCounterparty" class="form-label">對象</label>
                                  <input type="text" class="form-control" id="searchCounterparty">
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="searchAccount" class="form-label">帳戶</label>
                                  <select class="form-select" id="searchAccount">
                                      <option value="">所有帳戶</option>
                                      <option value="現金">現金</option>
                                      <option value="銀行">銀行</option>
                                      <option value="支票">支票</option>
                                      <option value="信用卡">信用卡</option>
                                  </select>
                              </div>
                          </div>
                      </div>
                      <div class="mb-3">
                          <label for="searchDescription" class="form-label">說明</label>
                          <input type="text" class="form-control" id="searchDescription" placeholder="搜尋說明內容">
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-outline-secondary" onclick="clearAdvancedSearch()">清除條件</button>
                  <button type="button" class="btn btn-primary" onclick="executeAdvancedSearch()">
                      <i class="bi bi-search"></i> 搜尋
                  </button>
              </div>
          </div>
      </div>
  </div>

  <!-- 報表模態框 -->
  <div class="modal fade" id="reportModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="reportModalTitle">報表</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="reportModalContent">
                  <!-- 報表內容將動態載入 -->
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-outline-primary" onclick="printReport()">
                      <i class="bi bi-printer"></i> 列印
                  </button>
                  <button type="button" class="btn btn-primary" onclick="exportReport()">
                      <i class="bi bi-download"></i> 匯出
                  </button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
              </div>
          </div>
      </div>
  </div>

  <!-- 系統設定模態框 -->
  <div class="modal fade" id="systemSettingsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="bi bi-gear-fill"></i> 系統設定
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <div class="row">
                      <div class="col-md-6">
                          <h6><i class="bi bi-building"></i> 組織資訊</h6>
                          <div class="mb-3">
                              <label for="orgName" class="form-label">組織名稱</label>
                              <input type="text" class="form-control" id="orgName" value="台灣帕金森病友權益促進會">
                          </div>
                          <div class="mb-3">
                              <label for="orgAddress" class="form-label">組織地址</label>
                              <textarea class="form-control" id="orgAddress" rows="2"></textarea>
                          </div>
                          <div class="mb-3">
                              <label for="orgPhone" class="form-label">聯絡電話</label>
                              <input type="tel" class="form-control" id="orgPhone">
                          </div>
                          <div class="mb-3">
                              <label for="orgEmail" class="form-label">電子郵件</label>
                              <input type="email" class="form-control" id="orgEmail">
                          </div>
                      </div>
                      <div class="col-md-6">
                          <h6><i class="bi bi-sliders"></i> 系統設定</h6>
                          <div class="mb-3">
                              <label for="defaultMembershipFee" class="form-label">預設年費金額</label>
                              <input type="number" class="form-control" id="defaultMembershipFee" value="1000" min="0">
                          </div>
                          <div class="mb-3">
                              <label for="receiptPrefix" class="form-label">收據編號前綴</label>
                              <input type="text" class="form-control" id="receiptPrefix" value="R">
                          </div>
                          <div class="mb-3">
                              <label for="pageSize" class="form-label">每頁顯示筆數</label>
                              <select class="form-select" id="pageSize">
                                  <option value="10">10</option>
                                  <option value="20" selected>20</option>
                                  <option value="50">50</option>
                                  <option value="100">100</option>
                              </select>
                          </div>
                          <div class="mb-3">
                              <div class="form-check">
                                  <input class="form-check-input" type="checkbox" id="autoBackup" checked>
                                  <label class="form-check-label" for="autoBackup">
                                      啟用自動備份
                                  </label>
                              </div>
                          </div>
                          <div class="mb-3">
                              <div class="form-check">
                                  <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                  <label class="form-check-label" for="emailNotifications">
                                      啟用郵件通知
                                  </label>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="saveSystemSettings()">
                      <i class="bi bi-save"></i> 儲存設定
                  </button>
              </div>
          </div>
      </div>
  </div>

  <!-- 同步設定模態框 -->
  <div class="modal fade" id="syncSettingsModal" tabindex="-1">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="bi bi-cloud-arrow-up-down"></i> 同步設定
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="syncSettingsForm">
                      <div class="mb-3">
                          <label for="apiUrl" class="form-label">API URL</label>
                          <input type="url" class="form-control" id="apiUrl" placeholder="Google Apps Script Web App URL">
                          <div class="form-text">請輸入您的 Google Apps Script Web App URL</div>
                      </div>
                      <div class="mb-3">
                          <label for="syncInterval" class="form-label">自動同步間隔（分鐘）</label>
                          <select class="form-select" id="syncInterval">
                              <option value="1">1分鐘</option>
                              <option value="5" selected>5分鐘</option>
                              <option value="10">10分鐘</option>
                              <option value="30">30分鐘</option>
                              <option value="60">1小時</option>
                          </select>
                      </div>
                      <div class="mb-3">
                          <div class="form-check">
                              <input class="form-check-input" type="checkbox" id="autoSync" checked>
                              <label class="form-check-label" for="autoSync">
                                  啟用自動同步
                              </label>
                          </div>
                      </div>
                      <div class="mb-3">
                          <div class="form-check">
                              <input class="form-check-input" type="checkbox" id="offlineMode">
                              <label class="form-check-label" for="offlineMode">
                                  離線模式（僅使用本地儲存）
                              </label>
                          </div>
                      </div>
                      <div class="mb-3">
                          <div class="form-check">
                              <input class="form-check-input" type="checkbox" id="conflictResolution" checked>
                              <label class="form-check-label" for="conflictResolution">
                                  啟用衝突解決
                              </label>
                          </div>
                      </div>
                  </form>
                  
                  <hr>
                  
                  <div class="mb-3">
                      <h6>連線測試</h6>
                      <button class="btn btn-outline-primary" onclick="testConnection()">
                          <i class="bi bi-wifi"></i> 測試連線
                      </button>
                      <div id="connectionStatus" class="mt-2"></div>
                  </div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="button" class="btn btn-primary" onclick="saveSyncSettings()">
                      <i class="bi bi-save"></i> 儲存設定
                  </button>
              </div>
          </div>
      </div>
  </div>

  <!-- 同步狀態模態框 -->
  <div class="modal fade" id="syncStatusModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">
                      <i class="bi bi-info-circle"></i> 同步狀態
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <div id="syncStats"></div>
                  
                  <hr>
                  
                  <div class="mb-3">
                      <h6>同步進度</h6>
                      <div class="progress">
                          <div class="progress-bar" id="syncProgress" role="progressbar" style="width: 0%">
                              準備中...
                          </div>
                      </div>
                  </div>
                  
                  <div class="mb-3">
                      <h6>最近同步記錄</h6>
                      <div id="syncHistory" class="sync-history">
                          <!-- 同步記錄將動態載入 -->
                      </div>
                  </div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-outline-primary" onclick="manualSync()">
                      <i class="bi bi-arrow-clockwise"></i> 立即同步
                  </button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Toast 容器 -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
      <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header">
              <strong class="me-auto" id="toastTitle">通知</strong>
              <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
          </div>
          <div class="toast-body" id="toastBody">
              <!-- Toast 內容 -->
          </div>
      </div>
  </div>

  <!-- JavaScript 庫 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
      // 全域變數
      let transactions = [];
      let members = [];
      let settings = {
          orgName: '台灣帕金森病友權益促進會',
          orgAddress: '',
          orgPhone: '',
          orgEmail: '',
          defaultMembershipFee: 1000,
          receiptPrefix: 'R',
          pageSize: 20,
          autoBackup: true,
          emailNotifications: true,
          apiUrl: '',
          syncInterval: 5,
          autoSync: true,
          offlineMode: false,
          conflictResolution: true
      };

      // 分頁相關變數
      let currentPage = 1;
      let currentMemberPage = 1;
      let filteredTransactions = [];
      let filteredMembers = [];

      // 收入和支出類別
      const incomeCategories = [
          '會費收入', '捐款收入', '活動收入', '補助收入', '利息收入', '其他收入'
      ];

      const expenseCategories = [
          '辦公費用', '活動費用', '交通費用', '餐飲費用', '印刷費用', 
          '郵電費用', '租金費用', '保險費用', '醫療費用', '其他費用'
      ];

      // Google Apps Script Web App URL（請替換為您的實際 URL）
      const API_URL = 'https://script.google.com/macros/s/AKfycbwpvl1mnq7r66s0sunayMvKVQhc81ISUZ5jjjCXvl-YQj9t2_HotympYuntBKOE1-Z1/exec';

      // 同步狀態
      let syncStatus = {
          isOnline: navigator.onLine,
          lastSync: localStorage.getItem('lastSync'),
          pendingSync: false
      };

      // 頁面載入完成後初始化
      document.addEventListener('DOMContentLoaded', function() {
          loadData();
          loadSettings();
          initializeYearOptions();
          updateDashboard();
          displayTransactions();
          displayMembers();
          updateAnalytics();
          
          // 設定當前日期
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('date').value = today;
          document.getElementById('memberJoinDate').value = today;
          
          // 初始化同步系統
          initializeSyncSystem();
      });

      // ==================== 資料管理 ====================
      
      // 載入資料
      function loadData() {
          const savedTransactions = localStorage.getItem('transactions');
          const savedMembers = localStorage.getItem('members');
          
          if (savedTransactions) {
              transactions = JSON.parse(savedTransactions);
          }
          
          if (savedMembers) {
              members = JSON.parse(savedMembers);
          }
      }

      // 儲存資料
      function saveData() {
          localStorage.setItem('transactions', JSON.stringify(transactions));
          localStorage.setItem('members', JSON.stringify(members));
          
          // 標記為待同步
          markPendingSync();
          
          // 如果在線，延遲同步
          if (syncStatus.isOnline) {
              setTimeout(() => {
                  syncToCloud();
              }, 1000);
          }
      }

      // 載入設定
      function loadSettings() {
          const savedSettings = localStorage.getItem('settings');
          if (savedSettings) {
              settings = { ...settings, ...JSON.parse(savedSettings) };
          }
      }

      // 儲存設定
      function saveSettings() {
          localStorage.setItem('settings', JSON.stringify(settings));
          
          // 標記為待同步
          markPendingSync();
          
          // 如果在線，延遲同步
          if (syncStatus.isOnline) {
              setTimeout(() => {
                  syncToCloud();
              }, 1000);
          }
      }

      // ==================== 交易記錄管理 ====================
      
      // 顯示交易記錄模態框
      function showTransactionModal(id = null) {
          const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
          const form = document.getElementById('transactionForm');
          
          form.reset();
          document.getElementById('voucherPreview').innerHTML = '';
          
          if (id) {
              // 編輯模式
              const transaction = transactions.find(t => t.id === id);
              if (transaction) {
                  document.getElementById('transactionModalTitle').textContent = '編輯交易記錄';
                  document.getElementById('transactionId').value = transaction.id;
                  document.getElementById('date').value = transaction.date;
                  document.getElementById('type').value = transaction.type;
                  updateCategoryOptions();
                  document.getElementById('category').value = transaction.category;
                  document.getElementById('amount').value = transaction.amount;
                  document.getElementById('counterparty').value = transaction.counterparty || '';
                  document.getElementById('account').value = transaction.account || '現金';
                  document.getElementById('description').value = transaction.description || '';
                  document.getElementById('receiptNumber').value = transaction.receiptNumber || '';
                  
                  // 顯示現有憑證
                  if (transaction.vouchers && transaction.vouchers.length > 0) {
                      displayVoucherPreviews(transaction.vouchers);
                  }
              }
          } else {
              // 新增模式
              document.getElementById('transactionModalTitle').textContent = '新增交易記錄';
              document.getElementById('transactionId').value = '';
              const today = new Date().toISOString().split('T')[0];
              document.getElementById('date').value = today;
          }
          
          updateCounterpartyList();
          modal.show();
      }

      // 更新類別選項
      function updateCategoryOptions() {
          const type = document.getElementById('type').value;
          const categorySelect = document.getElementById('category');
          
          categorySelect.innerHTML = '<option value="">請選擇類別</option>';
          
          let categories = [];
          if (type === '收入') {
              categories = incomeCategories;
          } else if (type === '支出') {
              categories = expenseCategories;
          }
          
          categories.forEach(category => {
              const option = document.createElement('option');
              option.value = category;
              option.textContent = category;
              categorySelect.appendChild(option);
          });
      }

      // 更新對象清單
      function updateCounterpartyList() {
          const datalist = document.getElementById('counterpartyList');
          datalist.innerHTML = '';
          
          const counterparties = [...new Set(transactions
              .map(t => t.counterparty)
              .filter(c => c && c.trim() !== ''))];
          
          counterparties.forEach(counterparty => {
              const option = document.createElement('option');
              option.value = counterparty;
              datalist.appendChild(option);
          });
      }

      // 處理憑證上傳
      function handleVoucherUpload(event) {
          const files = event.target.files;
          const preview = document.getElementById('voucherPreview');
          
          Array.from(files).forEach(file => {
              if (file.type.startsWith('image/') || file.type === 'application/pdf') {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                      const voucherData = {
                          name: file.name,
                          type: file.type,
                          data: e.target.result,
                          size: file.size
                      };
                      
                      createVoucherPreview(voucherData, preview);
                  };
                  reader.readAsDataURL(file);
              }
          });
      }

      // 創建憑證預覽
      function createVoucherPreview(voucherData, container) {
          const div = document.createElement('div');
          div.className = 'voucher-item';
          div.style.position = 'relative';
          div.style.display = 'inline-block';
          div.style.margin = '5px';
          
          if (voucherData.type.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = voucherData.data;
              img.style.maxWidth = '100px';
              img.style.maxHeight = '100px';
              img.style.objectFit = 'cover';
              img.style.border = '1px solid #ddd';
              img.style.borderRadius = '4px';
              img.style.cursor = 'pointer';
              img.onclick = () => showImageModal(voucherData.data);
              div.appendChild(img);
          } else if (voucherData.type === 'application/pdf') {
              const pdfDiv = document.createElement('div');
              pdfDiv.className = 'voucher-preview-pdf';
              pdfDiv.innerHTML = `
                  <i class="bi bi-file-earmark-pdf" style="font-size: 24px; color: #dc3545;"></i>
                  <div style="margin-top: 5px; font-size: 10px;">${voucherData.name}</div>
              `;
              pdfDiv.onclick = () => window.open(voucherData.data, '_blank');
              div.appendChild(pdfDiv);
          }
          
          // 刪除按鈕
          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'btn btn-danger btn-sm';
          deleteBtn.style.position = 'absolute';
          deleteBtn.style.top = '-5px';
          deleteBtn.style.right = '-5px';
          deleteBtn.style.width = '20px';
          deleteBtn.style.height = '20px';
          deleteBtn.style.borderRadius = '50%';
          deleteBtn.style.padding = '0';
          deleteBtn.style.fontSize = '10px';
          deleteBtn.innerHTML = '×';
          deleteBtn.onclick = () => div.remove();
          
          div.appendChild(deleteBtn);
          container.appendChild(div);
      }

      // 顯示憑證預覽
      function displayVoucherPreviews(vouchers) {
          const preview = document.getElementById('voucherPreview');
          vouchers.forEach(voucher => {
              createVoucherPreview(voucher, preview);
          });
      }

      // 顯示圖片模態框
      function showImageModal(imageSrc) {
          Swal.fire({
              imageUrl: imageSrc,
              imageAlt: '憑證圖片',
              showCloseButton: true,
              showConfirmButton: false,
              width: 'auto',
              customClass: {
                  image: 'img-fluid'
              }
          });
      }

      // 儲存交易記錄
      function saveTransaction() {
          const form = document.getElementById('transactionForm');
          if (!form.checkValidity()) {
              form.reportValidity();
              return;
          }
          
          const id = document.getElementById('transactionId').value;
          const vouchers = getVouchersFromPreview();
          
          const transactionData = {
              id: id || generateId(),
              date: document.getElementById('date').value,
              type: document.getElementById('type').value,
              category: document.getElementById('category').value,
              amount: parseFloat(document.getElementById('amount').value),
              counterparty: document.getElementById('counterparty').value,
              account: document.getElementById('account').value,
              description: document.getElementById('description').value,
              receiptNumber: document.getElementById('receiptNumber').value || generateReceiptNumber(),
              vouchers: vouchers,
              createdAt: id ? transactions.find(t => t.id === id)?.createdAt || new Date().toISOString() : new Date().toISOString(),
              updatedAt: new Date().toISOString()
          };
          
          if (id) {
              // 更新現有記錄
              const index = transactions.findIndex(t => t.id === id);
              if (index !== -1) {
                  transactions[index] = transactionData;
              }
          } else {
              // 新增記錄
              transactions.unshift(transactionData);
          }
          
          saveData();
          updateDashboard();
          displayTransactions();
          
          const modal = bootstrap.Modal.getInstance(document.getElementById('transactionModal'));
          modal.hide();
          
          showToast('success', id ? '交易記錄已更新' : '交易記錄已新增');
      }

      // 從預覽中獲取憑證資料
      function getVouchersFromPreview() {
          const vouchers = [];
          const voucherItems = document.querySelectorAll('#voucherPreview .voucher-item');
          
          voucherItems.forEach(item => {
              const img = item.querySelector('img');
              const pdfDiv = item.querySelector('.voucher-preview-pdf');
              
              if (img) {
                  vouchers.push({
                      name: 'image_' + Date.now() + '.jpg',
                      type: 'image/jpeg',
                      data: img.src,
                      size: 0
                  });
              } else if (pdfDiv) {
                  const fileName = pdfDiv.querySelector('div').textContent;
                  vouchers.push({
                      name: fileName,
                      type: 'application/pdf',
                      data: '', // PDF 資料會在這裡
                      size: 0
                  });
              }
          });
          
          return vouchers;
      }

      // 生成收據編號
      function generateReceiptNumber() {
          const prefix = settings.receiptPrefix || 'R';
          const year = new Date().getFullYear();
          const month = String(new Date().getMonth() + 1).padStart(2, '0');
          const count = transactions.filter(t => 
              t.receiptNumber && t.receiptNumber.startsWith(`${prefix}${year}${month}`)
          ).length + 1;
          
          return `${prefix}${year}${month}${String(count).padStart(3, '0')}`;
      }

      // 刪除交易記錄
      function deleteTransaction(id) {
          Swal.fire({
              title: '確認刪除',
              text: '您確定要刪除這筆交易記錄嗎？',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#dc3545',
              cancelButtonColor: '#6c757d',
              confirmButtonText: '確定刪除',
              cancelButtonText: '取消'
          }).then((result) => {
              if (result.isConfirmed) {
                  transactions = transactions.filter(t => t.id !== id);
                  saveData();
                  updateDashboard();
                  displayTransactions();
                  showToast('success', '交易記錄已刪除');
              }
          });
      }

      // 顯示交易記錄
      function displayTransactions() {
          const tbody = document.getElementById('transactionTableBody');
          const pageSize = parseInt(settings.pageSize) || 20;
          
          // 應用篩選條件
          filteredTransactions = filterTransactions();
          
          // 更新記錄數量
          document.getElementById('recordCount').textContent = `${filteredTransactions.length} 筆記錄`;
          
          // 分頁處理
          const totalPages = Math.ceil(filteredTransactions.length / pageSize);
          const startIndex = (currentPage - 1) * pageSize;
          const endIndex = startIndex + pageSize;
          const pageTransactions = filteredTransactions.slice(startIndex, endIndex);
          
          if (pageTransactions.length === 0) {
              tbody.innerHTML = `
                  <tr>
                      <td colspan="9" class="text-center py-4">
                          <i class="bi bi-receipt display-4 text-muted"></i>
                          <div class="mt-2">沒有符合條件的交易記錄</div>
                      </td>
                  </tr>
              `;
          } else {
              tbody.innerHTML = pageTransactions.map(transaction => `
                  <tr>
                      <td><input type="checkbox" value="${transaction.id}"></td>
                      <td>${transaction.date}</td>
                      <td>
                          <span class="badge ${transaction.type === '收入' ? 'bg-success' : 'bg-danger'}">
                              ${transaction.type}
                          </span>
                      </td>
                      <td>${transaction.category}</td>
                      <td class="text-end">$${transaction.amount.toLocaleString()}</td>
                      <td>${transaction.counterparty || '-'}</td>
                      <td>${transaction.description || '-'}</td>
                      <td>
                          ${transaction.vouchers && transaction.vouchers.length > 0 
                              ? `<span class="badge bg-info">${transaction.vouchers.length} 個檔案</span>` 
                              : '-'}
                      </td>
                      <td>
                          <div class="action-buttons">
                              <button class="btn btn-sm btn-outline-primary" onclick="showTransactionModal('${transaction.id}')" title="編輯">
                                  <i class="bi bi-pencil"></i>
                              </button>
                              <button class="btn btn-sm btn-outline-info" onclick="viewTransactionDetail('${transaction.id}')" title="檢視">
                                  <i class="bi bi-eye"></i>
                              </button>
                              <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction('${transaction.id}')" title="刪除">
                                  <i class="bi bi-trash"></i>
                              </button>
                          </div>
                      </td>
                  </tr>
              `).join('');
          }
          
          // 更新分頁
          updatePagination(totalPages, currentPage, 'pagination');
      }

      // 篩選交易記錄
      function filterTransactions() {
          let filtered = [...transactions];
          
          // 年份篩選
          const filterYear = document.getElementById('filterYear').value;
          if (filterYear) {
              filtered = filtered.filter(t => new Date(t.date).getFullYear().toString() === filterYear);
          }
          
          // 月份篩選
          const filterMonth = document.getElementById('filterMonth').value;
          if (filterMonth) {
              filtered = filtered.filter(t => (new Date(t.date).getMonth() + 1).toString() === filterMonth);
          }
          
          // 類型篩選
          const filterType = document.getElementById('filterType').value;
          if (filterType) {
              filtered = filtered.filter(t => t.type === filterType);
          }
          
          // 關鍵字搜尋
          const searchKeyword = document.getElementById('searchKeyword').value.toLowerCase();
          if (searchKeyword) {
              filtered = filtered.filter(t => 
                  t.description.toLowerCase().includes(searchKeyword) ||
                  t.counterparty.toLowerCase().includes(searchKeyword) ||
                  t.category.toLowerCase().includes(searchKeyword) ||
                  t.receiptNumber.toLowerCase().includes(searchKeyword)
              );
          }
          
          // 按日期排序（最新的在前）
          filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
          
          return filtered;
      }

      // ==================== 會員管理 ====================
      
      // 顯示會員模態框
      function showMemberModal(id = null) {
          const modal = new bootstrap.Modal(document.getElementById('memberModal'));
          const form = document.getElementById('memberForm');
          
          form.reset();
          
          if (id) {
              // 編輯模式
              const member = members.find(m => m.id === id);
              if (member) {
                  document.getElementById('memberModalTitle').textContent = '編輯會員';
                  document.getElementById('memberId').value = member.id;
                  document.getElementById('memberName').value = member.name;
                  document.getElementById('memberPhone').value = member.phone;
                  document.getElementById('memberEmail').value = member.email || '';
                  document.getElementById('memberBirthDate').value = member.birthDate || '';
                  document.getElementById('memberGender').value = member.gender || '';
                  document.getElementById('memberIdNumber').value = member.idNumber || '';
                  document.getElementById('memberAddress').value = member.address || '';
                  document.getElementById('emergencyContact').value = member.emergencyContact || '';
                  document.getElementById('emergencyPhone').value = member.emergencyPhone || '';
                  document.getElementById('memberNotes').value = member.notes || '';
                  document.getElementById('memberJoinDate').value = member.joinDate;
                  document.getElementById('memberStatus').value = member.status;
                  document.getElementById('memberType').value = member.type || 'regular';
                  document.getElementById('membershipFee').value = member.membershipFee || settings.defaultMembershipFee;
                  document.getElementById('lastPaymentDate').value = member.lastPaymentDate || '';
                  document.getElementById('memberTags').value = member.tags ? member.tags.join(',') : '';
              }
          } else {
              // 新增模式
              document.getElementById('memberModalTitle').textContent = '新增會員';
              document.getElementById('memberId').value = '';
              const today = new Date().toISOString().split('T')[0];
              document.getElementById('memberJoinDate').value = today;
              document.getElementById('membershipFee').value = settings.defaultMembershipFee;
              document.getElementById('memberStatus').value = 'active';
              document.getElementById('memberType').value = 'regular';
          }
          
          modal.show();
      }

      // 儲存會員
      function saveMember() {
          const form = document.getElementById('memberForm');
          if (!form.checkValidity()) {
              form.reportValidity();
              return;
          }
          
          const id = document.getElementById('memberId').value;
          const tags = document.getElementById('memberTags').value
              .split(',')
              .map(tag => tag.trim())
              .filter(tag => tag !== '');
          
          const memberData = {
              id: id || generateId(),
              name: document.getElementById('memberName').value,
              phone: document.getElementById('memberPhone').value,
              email: document.getElementById('memberEmail').value,
              birthDate: document.getElementById('memberBirthDate').value,
              gender: document.getElementById('memberGender').value,
              idNumber: document.getElementById('memberIdNumber').value,
              address: document.getElementById('memberAddress').value,
              emergencyContact: document.getElementById('emergencyContact').value,
              emergencyPhone: document.getElementById('emergencyPhone').value,
              notes: document.getElementById('memberNotes').value,
              joinDate: document.getElementById('memberJoinDate').value,
              status: document.getElementById('memberStatus').value,
              type: document.getElementById('memberType').value,
              membershipFee: parseFloat(document.getElementById('membershipFee').value),
              lastPaymentDate: document.getElementById('lastPaymentDate').value,
              tags: tags,
              createdAt: id ? members.find(m => m.id === id)?.createdAt || new Date().toISOString() : new Date().toISOString(),
              updatedAt: new Date().toISOString()
          };
          
          if (id) {
              // 更新現有會員
              const index = members.findIndex(m => m.id === id);
              if (index !== -1) {
                  members[index] = memberData;
              }
          } else {
              // 新增會員
              members.unshift(memberData);
          }
          
          saveData();
          updateDashboard();
          displayMembers();
          
          const modal = bootstrap.Modal.getInstance(document.getElementById('memberModal'));
          modal.hide();
          
          showToast('success', id ? '會員資料已更新' : '會員已新增');
      }

      // 刪除會員
      function deleteMember(id) {
          Swal.fire({
              title: '確認刪除',
              text: '您確定要刪除這位會員嗎？',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#dc3545',
              cancelButtonColor: '#6c757d',
              confirmButtonText: '確定刪除',
              cancelButtonText: '取消'
          }).then((result) => {
              if (result.isConfirmed) {
                  members = members.filter(m => m.id !== id);
                  saveData();
                  updateDashboard();
                  displayMembers();
                  showToast('success', '會員已刪除');
              }
          });
      }

      // 顯示會員列表
      function displayMembers() {
          const tbody = document.getElementById('memberTableBody');
          const pageSize = parseInt(settings.pageSize) || 20;
          
          // 應用篩選條件
          filteredMembers = filterMembers();
          
          // 更新記錄數量
          document.getElementById('memberRecordCount').textContent = `${filteredMembers.length} 筆記錄`;
          
          // 分頁處理
          const totalPages = Math.ceil(filteredMembers.length / pageSize);
          const startIndex = (currentMemberPage - 1) * pageSize;
          const endIndex = startIndex + pageSize;
          const pageMembers = filteredMembers.slice(startIndex, endIndex);
          
          if (pageMembers.length === 0) {
              tbody.innerHTML = `
                  <tr>
                      <td colspan="9" class="text-center py-4">
                          <i class="bi bi-people display-4 text-muted"></i>
                          <div class="mt-2">沒有符合條件的會員資料</div>
                      </td>
                  </tr>
              `;
          } else {
              tbody.innerHTML = pageMembers.map(member => {
                  const age = member.birthDate ? calculateAge(member.birthDate) : '-';
                  const isOverdue = isPaymentOverdue(member);
                  
                  return `
                      <tr>
                          <td><input type="checkbox" value="${member.id}"></td>
                          <td>
                              <div class="d-flex align-items-center">
                                  <div class="member-avatar me-2">
                                      ${member.name.charAt(0)}
                                  </div>
                                  <div>
                                      <div class="fw-bold">${member.name}</div>
                                      <small class="text-muted">${member.type === 'regular' ? '一般會員' : 
                                          member.type === 'honorary' ? '榮譽會員' : 
                                          member.type === 'life' ? '終身會員' : '家屬會員'}</small>
                                  </div>
                              </div>
                          </td>
                          <td>
                              <div>${member.phone}</div>
                              ${member.email ? `<small class="text-muted">${member.email}</small>` : ''}
                          </td>
                          <td>
                              <div>${age}歲</div>
                              ${member.gender ? `<small class="text-muted">${member.gender}</small>` : ''}
                          </td>
                          <td>${member.joinDate}</td>
                          <td>
                              <span class="badge ${getStatusBadgeClass(member.status)}">
                                  ${getStatusText(member.status)}
                              </span>
                          </td>
                          <td>
                              <span class="badge ${isOverdue ? 'bg-danger' : 'bg-success'}">
                                  ${isOverdue ? '逾期' : '正常'}
                              </span>
                              ${member.lastPaymentDate ? `<br><small class="text-muted">最後繳費: ${member.lastPaymentDate}</small>` : ''}
                          </td>
                          <td>
                              ${member.tags && member.tags.length > 0 
                                  ? member.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')
                                  : '-'}
                          </td>
                          <td>
                              <div class="action-buttons">
                                  <button class="btn btn-sm btn-outline-primary" onclick="showMemberModal('${member.id}')" title="編輯">
                                      <i class="bi bi-pencil"></i>
                                  </button>
                                  <button class="btn btn-sm btn-outline-info" onclick="viewMemberDetail('${member.id}')" title="檢視">
                                      <i class="bi bi-eye"></i>
                                  </button>
                                  <button class="btn btn-sm btn-outline-success" onclick="recordMemberPayment('${member.id}')" title="記錄繳費">
                                      <i class="bi bi-cash"></i>
                                  </button>
                                  <button class="btn btn-sm btn-outline-danger" onclick="deleteMember('${member.id}')" title="刪除">
                                      <i class="bi bi-trash"></i>
                                  </button>
                              </div>
                          </td>
                      </tr>
                  `;
              }).join('');
          }
          
          // 更新分頁
          updatePagination(totalPages, currentMemberPage, 'memberPagination');
          
          // 更新會員統計
          updateMemberStats();
      }

      // 篩選會員
      function filterMembers() {
          let filtered = [...members];
          
          // 狀態篩選
          const memberFilter = document.getElementById('memberFilter').value;
          if (memberFilter) {
              filtered = filtered.filter(m => m.status === memberFilter);
          }
          
          // 關鍵字搜尋
          const memberSearch = document.getElementById('memberSearch').value.toLowerCase();
          if (memberSearch) {
              filtered = filtered.filter(m => 
                  m.name.toLowerCase().includes(memberSearch) ||
                  m.phone.includes(memberSearch) ||
                  (m.email && m.email.toLowerCase().includes(memberSearch)) ||
                  (m.tags && m.tags.some(tag => tag.toLowerCase().includes(memberSearch)))
              );
          }
          
          // 按加入日期排序（最新的在前）
          filtered.sort((a, b) => new Date(b.joinDate) - new Date(a.joinDate));
          
          return filtered;
      }

      // 計算年齡
      function calculateAge(birthDate) {
          const today = new Date();
          const birth = new Date(birthDate);
          let age = today.getFullYear() - birth.getFullYear();
          const monthDiff = today.getMonth() - birth.getMonth();
          
          if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
              age--;
          }
          
          return age;
      }

      // 檢查會費是否逾期
      function isPaymentOverdue(member) {
          if (!member.lastPaymentDate) return true;
          
          const lastPayment = new Date(member.lastPaymentDate);
          const oneYearLater = new Date(lastPayment);
          oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);
          
          return new Date() > oneYearLater;
      }

      // 獲取狀態徽章樣式
      function getStatusBadgeClass(status) {
          switch (status) {
              case 'active': return 'bg-success';
              case 'inactive': return 'bg-danger';
              case 'pending': return 'bg-warning';
              default: return 'bg-secondary';
          }
      }

      // 獲取狀態文字
      function getStatusText(status) {
          switch (status) {
              case 'active': return '正常';
              case 'inactive': return '停權';
              case 'pending': return '待審核';
              default: return '未知';
          }
      }

      // 更新會員統計
      function updateMemberStats() {
          const totalMembers = members.length;
          const activeMembers = members.filter(m => m.status === 'active').length;
          const overdueMembers = members.filter(m => isPaymentOverdue(m)).length;
          
          // 本月新增會員
          const thisMonth = new Date();
          const newMembers = members.filter(m => {
              const joinDate = new Date(m.joinDate);
              return joinDate.getFullYear() === thisMonth.getFullYear() && 
                     joinDate.getMonth() === thisMonth.getMonth();
          }).length;
          
          document.getElementById('totalMembersCount').textContent = totalMembers;
          document.getElementById('activeMembersCount').textContent = activeMembers;
          document.getElementById('overdueMembersCount').textContent = overdueMembers;
          document.getElementById('newMembersCount').textContent = newMembers;
      }

      // 檢視會員詳情
      function viewMemberDetail(id) {
          const member = members.find(m => m.id === id);
          if (!member) return;
          
          const age = member.birthDate ? calculateAge(member.birthDate) : '未提供';
          const isOverdue = isPaymentOverdue(member);
          
          const content = `
              <div class="row">
                  <div class="col-md-6">
                      <h6><i class="bi bi-person-badge"></i> 基本資料</h6>
                      <table class="table table-sm">
                          <tr><td><strong>姓名:</strong></td><td>${member.name}</td></tr>
                          <tr><td><strong>電話:</strong></td><td>${member.phone}</td></tr>
                          <tr><td><strong>電子郵件:</strong></td><td>${member.email || '未提供'}</td></tr>
                          <tr><td><strong>年齡/性別:</strong></td><td>${age}歲 / ${member.gender || '未提供'}</td></tr>
                          <tr><td><strong>身分證字號:</strong></td><td>${member.idNumber || '未提供'}</td></tr>
                          <tr><td><strong>地址:</strong></td><td>${member.address || '未提供'}</td></tr>
                      </table>
                  </div>
                  <div class="col-md-6">
                      <h6><i class="bi bi-card-checklist"></i> 會員資訊</h6>
                      <table class="table table-sm">
                          <tr><td><strong>加入日期:</strong></td><td>${member.joinDate}</td></tr>
                          <tr><td><strong>會員類型:</strong></td><td>${getMemberTypeText(member.type)}</td></tr>
                          <tr><td><strong>狀態:</strong></td><td>
                              <span class="badge ${getStatusBadgeClass(member.status)}">${getStatusText(member.status)}</span>
                          </td></tr>
                          <tr><td><strong>年費:</strong></td><td>$${member.membershipFee?.toLocaleString() || '0'}</td></tr>
                          <tr><td><strong>最後繳費:</strong></td><td>${member.lastPaymentDate || '未繳費'}</td></tr>
                          <tr><td><strong>會費狀態:</strong></td><td>
                              <span class="badge ${isOverdue ? 'bg-danger' : 'bg-success'}">${isOverdue ? '逾期' : '正常'}</span>
                          </td></tr>
                      </table>
                  </div>
              </div>
              
              ${member.emergencyContact ? `
              <div class="row mt-3">
                  <div class="col-12">
                      <h6><i class="bi bi-telephone"></i> 緊急聯絡人</h6>
                      <p><strong>${member.emergencyContact}</strong> - ${member.emergencyPhone || '無電話'}</p>
                  </div>
              </div>
              ` : ''}
              
              ${member.tags && member.tags.length > 0 ? `
              <div class="row mt-3">
                  <div class="col-12">
                      <h6><i class="bi bi-tags"></i> 標籤</h6>
                      <p>${member.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')}</p>
                  </div>
              </div>
              ` : ''}
              
              ${member.notes ? `
              <div class="row mt-3">
                  <div class="col-12">
                      <h6><i class="bi bi-journal-text"></i> 備註</h6>
                      <p>${member.notes}</p>
                  </div>
              </div>
              ` : ''}
          `;
          
          document.getElementById('memberDetailContent').innerHTML = content;
          
          // 儲存當前會員 ID 供編輯使用
          document.getElementById('memberDetailModal').setAttribute('data-member-id', id);
          
          const modal = new bootstrap.Modal(document.getElementById('memberDetailModal'));
          modal.show();
      }

      // 獲取會員類型文字
      function getMemberTypeText(type) {
          switch (type) {
              case 'regular': return '一般會員';
              case 'honorary': return '榮譽會員';
              case 'life': return '終身會員';
              case 'family': return '家屬會員';
              default: return '一般會員';
          }
      }

      // 從詳情頁面編輯會員
      function editMemberFromDetail() {
          const memberId = document.getElementById('memberDetailModal').getAttribute('data-member-id');
          const detailModal = bootstrap.Modal.getInstance(document.getElementById('memberDetailModal'));
          detailModal.hide();
          
          setTimeout(() => {
              showMemberModal(memberId);
          }, 300);
      }

      // 記錄會員繳費
      function recordMemberPayment(memberId) {
          const member = members.find(m => m.id === memberId);
          if (!member) return;
          
          Swal.fire({
              title: '記錄繳費',
              html: `
                  <div class="text-start">
                      <p><strong>會員:</strong> ${member.name}</p>
                      <p><strong>年費:</strong> $${member.membershipFee?.toLocaleString() || '1000'}</p>
                      <div class="mb-3">
                          <label for="paymentDate" class="form-label">繳費日期</label>
                          <input type="date" class="form-control" id="paymentDate" value="${new Date().toISOString().split('T')[0]}">
                      </div>
                      <div class="mb-3">
                          <label for="paymentAmount" class="form-label">繳費金額</label>
                          <input type="number" class="form-control" id="paymentAmount" value="${member.membershipFee || 1000}" min="0">
                      </div>
                      <div class="mb-3">
                          <label for="paymentNote" class="form-label">備註</label>
                          <input type="text" class="form-control" id="paymentNote" placeholder="例如：2024年度會費">
                      </div>
                  </div>
              `,
              showCancelButton: true,
              confirmButtonText: '記錄繳費',
              cancelButtonText: '取消',
              preConfirm: () => {
                  const paymentDate = document.getElementById('paymentDate').value;
                  const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
                  const paymentNote = document.getElementById('paymentNote').value;
                  
                  if (!paymentDate || paymentAmount <= 0) {
                      Swal.showValidationMessage('請填寫有效的繳費日期和金額');
                      return false;
                  }
                  
                  return { paymentDate, paymentAmount, paymentNote };
              }
          }).then((result) => {
              if (result.isConfirmed) {
                  const { paymentDate, paymentAmount, paymentNote } = result.value;
                  
                  // 更新會員最後繳費日期
                  const memberIndex = members.findIndex(m => m.id === memberId);
                  if (memberIndex !== -1) {
                      members[memberIndex].lastPaymentDate = paymentDate;
                      members[memberIndex].updatedAt = new Date().toISOString();
                  }
                  
                  // 新增收入交易記錄
                  const paymentTransaction = {
                      id: generateId(),
                      date: paymentDate,
                      type: '收入',
                      category: '會費收入',
                      amount: paymentAmount,
                      counterparty: member.name,
                      account: '現金',
                      description: paymentNote || `${member.name} - 會費`,
                      receiptNumber: generateReceiptNumber(),
                      vouchers: [],
                      createdAt: new Date().toISOString(),
                      updatedAt: new Date().toISOString()
                  };
                  
                  transactions.unshift(paymentTransaction);
                  
                  saveData();
                  updateDashboard();
                  displayMembers();
                  displayTransactions();
                  
                  showToast('success', '繳費記錄已新增');
              }
          });
      }

      // 列印會員卡
      function printMemberCard() {
          const memberId = document.getElementById('memberDetailModal').getAttribute('data-member-id');
          const member = members.find(m => m.id === memberId);
          if (!member) return;
          
          const printContent = `
              <div style="width: 85.6mm; height: 53.98mm; border: 1px solid #000; padding: 10px; font-family: Arial, sans-serif;">
                  <div style="text-align: center; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">
                      <h3 style="margin: 0; font-size: 14px;">${settings.orgName}</h3>
                      <p style="margin: 0; font-size: 10px;">會員卡</p>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                      <div>
                          <p style="margin: 2px 0; font-size: 12px;"><strong>姓名:</strong> ${member.name}</p>
                          <p style="margin: 2px 0; font-size: 12px;"><strong>會員編號:</strong> ${member.id}</p>
                          <p style="margin: 2px 0; font-size: 12px;"><strong>加入日期:</strong> ${member.joinDate}</p>
                          <p style="margin: 2px 0; font-size: 12px;"><strong>會員類型:</strong> ${getMemberTypeText(member.type)}</p>
                      </div>
                      <div style="width: 60px; height: 60px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                          ${member.name.charAt(0)}
                      </div>
                  </div>
              </div>
          `;
          
          const printWindow = window.open('', '_blank');
          printWindow.document.write(`
              <html>
                  <head>
                      <title>會員卡 - ${member.name}</title>
                      <style>
                          body { margin: 0; padding: 20px; }
                          @media print {
                              body { margin: 0; padding: 0; }
                          }
                      </style>
                  </head>
                  <body>
                      ${printContent}
                      <script>
                          window.onload = function() {
                              window.print();
                              window.close();
                          }
                      </script>
                  </body>
              </html>
          `);
      }

      // ==================== 儀表板更新 ====================
      
      // 更新儀表板
      function updateDashboard() {
          // 計算統計數據
          const totalIncome = transactions
              .filter(t => t.type === '收入')
              .reduce((sum, t) => sum + t.amount, 0);
          
          const totalExpense = transactions
              .filter(t => t.type === '支出')
              .reduce((sum, t) => sum + t.amount, 0);
          
          const totalMembers = members.length;
          const overdueMembers = members.filter(m => isPaymentOverdue(m)).length;
          
          // 更新統計卡片
          document.getElementById('totalIncome').textContent = `$${totalIncome.toLocaleString()}`;
          document.getElementById('totalExpense').textContent = `$${totalExpense.toLocaleString()}`;
          document.getElementById('totalMembers').textContent = totalMembers;
          document.getElementById('overdueMembers').textContent = overdueMembers;
          
          // 更新最近交易
          updateRecentTransactions();
          
          // 更新最近會員
          updateRecentMembers();
      }

      // 更新最近交易
      function updateRecentTransactions() {
          const recentTransactions = transactions
              .sort((a, b) => new Date(b.date) - new Date(a.date))
              .slice(0, 5);
          
          const container = document.getElementById('recentTransactions');
          
          if (recentTransactions.length === 0) {
              container.innerHTML = `
                  <div class="text-center text-muted">
                      <i class="bi bi-receipt display-4"></i>
                      <p>尚無交易記錄</p>
                  </div>
              `;
          } else {
              container.innerHTML = recentTransactions.map(transaction => `
                  <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                      <div>
                          <div class="fw-bold">${transaction.description || transaction.category}</div>
                          <small class="text-muted">${transaction.date} - ${transaction.counterparty || '無對象'}</small>
                      </div>
                      <div class="text-end">
                          <span class="fw-bold ${transaction.type === '收入' ? 'text-success' : 'text-danger'}">
                              ${transaction.type === '收入' ? '+' : '-'}$${transaction.amount.toLocaleString()}
                          </span>
                          <br>
                          <span class="badge ${transaction.type === '收入' ? 'bg-success' : 'bg-danger'} badge-sm">
                              ${transaction.type}
                          </span>
                      </div>
                  </div>
              `).join('');
          }
      }

      // 更新最近會員
      function updateRecentMembers() {
          const recentMembers = members
              .sort((a, b) => new Date(b.joinDate) - new Date(a.joinDate))
              .slice(0, 5);
          
          const container = document.getElementById('recentMembers');
          
          if (recentMembers.length === 0) {
              container.innerHTML = `
                  <div class="text-center text-muted">
                      <i class="bi bi-people display-4"></i>
                      <p>尚無會員資料</p>
                  </div>
              `;
          } else {
              container.innerHTML = recentMembers.map(member => {
                  const isOverdue = isPaymentOverdue(member);
                  return `
                      <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                          <div class="d-flex align-items-center">
                              <div class="member-avatar me-2">
                                  ${member.name.charAt(0)}
                              </div>
                              <div>
                                  <div class="fw-bold">${member.name}</div>
                                  <small class="text-muted">${member.phone}</small>
                              </div>
                          </div>
                          <div class="text-end">
                              <div class="mb-1">${member.joinDate}</div>
                              <span class="badge ${isOverdue ? 'bg-danger' : 'bg-success'}">
                                  ${isOverdue ? '逾期' : '正常'}
                              </span>
                          </div>
                      </div>
                  `;
              }).join('');
          }
      }

      // ==================== 工具函數 ====================
      
      // 生成唯一 ID
      function generateId() {
          return Date.now().toString(36) + Math.random().toString(36).substr(2);
      }

      // 顯示 Toast 通知
      function showToast(type, message) {
          const toast = document.getElementById('liveToast');
          const toastTitle = document.getElementById('toastTitle');
          const toastBody = document.getElementById('toastBody');
          
          // 設定標題和圖示
          switch (type) {
              case 'success':
                  toastTitle.innerHTML = '<i class="bi bi-check-circle text-success"></i> 成功';
                  break;
              case 'error':
                  toastTitle.innerHTML = '<i class="bi bi-exclamation-triangle text-danger"></i> 錯誤';
                  break;
              case 'warning':
                  toastTitle.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> 警告';
                  break;
              case 'info':
              default:
                  toastTitle.innerHTML = '<i class="bi bi-info-circle text-info"></i> 資訊';
                  break;
          }
          
          toastBody.textContent = message;
          
          const bsToast = new bootstrap.Toast(toast);
          bsToast.show();
      }

      // 更新分頁
      function updatePagination(totalPages, currentPageNum, paginationId) {
          const pagination = document.getElementById(paginationId);
          
          if (totalPages <= 1) {
              pagination.innerHTML = '';
              return;
          }
          
          let paginationHTML = '';
          
          // 上一頁
          paginationHTML += `
              <li class="page-item ${currentPageNum === 1 ? 'disabled' : ''}">
                  <a class="page-link" href="#" onclick="changePage(${currentPageNum - 1}, '${paginationId}')">上一頁</a>
              </li>
          `;
          
          // 頁碼
          const startPage = Math.max(1, currentPageNum - 2);
          const endPage = Math.min(totalPages, currentPageNum + 2);
          
          if (startPage > 1) {
              paginationHTML += `<li class="page-item">
                  <a class="page-link" href="#" onclick="changePage(1, '${paginationId}')">1</a>
              </li>`;
              if (startPage > 2) {
                  paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
              }
          }
          
          for (let i = startPage; i <= endPage; i++) {
              paginationHTML += `
                  <li class="page-item ${i === currentPageNum ? 'active' : ''}">
                      <a class="page-link" href="#" onclick="changePage(${i}, '${paginationId}')">${i}</a>
                  </li>
              `;
          }
          
          if (endPage < totalPages) {
              if (endPage < totalPages - 1) {
                  paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
              }
              paginationHTML += `
                  <li class="page-item">
                      <a class="page-link" href="#" onclick="changePage(${totalPages}, '${paginationId}')">${totalPages}</a>
                  </li>
              `;
          }
          
          // 下一頁
          paginationHTML += `
              <li class="page-item ${currentPageNum === totalPages ? 'disabled' : ''}">
                  <a class="page-link" href="#" onclick="changePage(${currentPageNum + 1}, '${paginationId}')">下一頁</a>
              </li>
          `;
          
          pagination.innerHTML = paginationHTML;
      }

      // 切換頁面
      function changePage(page, paginationId) {
          if (paginationId === 'pagination') {
              currentPage = page;
              displayTransactions();
          } else if (paginationId === 'memberPagination') {
              currentMemberPage = page;
              displayMembers();
          }
      }

      // 初始化年份選項
      function initializeYearOptions() {
          const currentYear = new Date().getFullYear();
          const yearSelects = ['filterYear', 'analyticsYear'];
          
          yearSelects.forEach(selectId => {
              const select = document.getElementById(selectId);
              if (select) {
                  for (let year = currentYear; year >= currentYear - 10; year--) {
                      const option = document.createElement('option');
                      option.value = year;
                      option.textContent = year + '年';
                      select.appendChild(option);
                  }
              }
          });
      }

      // ==================== 進階搜尋 ====================
      
      // 顯示進階搜尋
      function showAdvancedSearch() {
          // 填入所有類別選項
          const searchCategorySelect = document.getElementById('searchCategory');
          searchCategorySelect.innerHTML = '<option value="">所有類別</option>';
          
          [...incomeCategories, ...expenseCategories].forEach(category => {
              const option = document.createElement('option');
              option.value = category;
              option.textContent = category;
              searchCategorySelect.appendChild(option);
          });
          
          const modal = new bootstrap.Modal(document.getElementById('advancedSearchModal'));
          modal.show();
      }

      // 執行進階搜尋
      function executeAdvancedSearch() {
          const searchCriteria = {
              startDate: document.getElementById('searchStartDate').value,
              endDate: document.getElementById('searchEndDate').value,
              type: document.getElementById('searchType').value,
              category: document.getElementById('searchCategory').value,
              minAmount: parseFloat(document.getElementById('searchMinAmount').value) || 0,
              maxAmount: parseFloat(document.getElementById('searchMaxAmount').value) || Infinity,
              counterparty: document.getElementById('searchCounterparty').value.toLowerCase(),
              account: document.getElementById('searchAccount').value,
              description: document.getElementById('searchDescription').value.toLowerCase()
          };
          
          // 應用進階搜尋條件
          filteredTransactions = transactions.filter(transaction => {
              // 日期範圍
              const transactionDate = new Date(transaction.date);
              if (searchCriteria.startDate && transactionDate < new Date(searchCriteria.startDate)) return false;
              if (searchCriteria.endDate && transactionDate > new Date(searchCriteria.endDate)) return false;
              
              // 類型
              if (searchCriteria.type && transaction.type !== searchCriteria.type) return false;
              
              // 類別
              if (searchCriteria.category && transaction.category !== searchCriteria.category) return false;
              
              // 金額範圍
              if (transaction.amount < searchCriteria.minAmount || transaction.amount > searchCriteria.maxAmount) return false;
              
              // 對象
              if (searchCriteria.counterparty && !transaction.counterparty.toLowerCase().includes(searchCriteria.counterparty)) return false;
              
              // 帳戶
              if (searchCriteria.account && transaction.account !== searchCriteria.account) return false;
              
              // 說明
              if (searchCriteria.description && !transaction.description.toLowerCase().includes(searchCriteria.description)) return false;
              
              return true;
          });
          
          // 顯示搜尋結果摘要
          const summaryText = `搜尋結果: ${filteredTransactions.length} 筆記錄`;
          let criteriaText = [];
          
          if (searchCriteria.startDate) criteriaText.push(`開始日期: ${searchCriteria.startDate}`);
          if (searchCriteria.endDate) criteriaText.push(`結束日期: ${searchCriteria.endDate}`);
          if (searchCriteria.type) criteriaText.push(`類型: ${searchCriteria.type}`);
          if (searchCriteria.category) criteriaText.push(`類別: ${searchCriteria.category}`);
          if (searchCriteria.minAmount > 0) criteriaText.push(`最小金額: $${searchCriteria.minAmount.toLocaleString()}`);
          if (searchCriteria.maxAmount < Infinity) criteriaText.push(`最大金額: $${searchCriteria.maxAmount.toLocaleString()}`);
          if (searchCriteria.counterparty) criteriaText.push(`對象: ${searchCriteria.counterparty}`);
          if (searchCriteria.account) criteriaText.push(`帳戶: ${searchCriteria.account}`);
          if (searchCriteria.description) criteriaText.push(`說明: ${searchCriteria.description}`);
          
          document.getElementById('searchSummary').innerHTML = `
              <div class="search-summary">
                  <h6><i class="bi bi-search"></i> ${summaryText}</h6>
                  <p class="mb-0">搜尋條件: ${criteriaText.join(' | ')}</p>
                  <button class="btn btn-sm btn-outline-secondary mt-2" onclick="clearSearchResults()">
                      <i class="bi bi-x-circle"></i> 清除搜尋結果
                  </button>
              </div>
          `;
          
          currentPage = 1;
          displayTransactions();
          
          const modal = bootstrap.Modal.getInstance(document.getElementById('advancedSearchModal'));
          modal.hide();
      }

      // 清除進階搜尋條件
      function clearAdvancedSearch() {
          const form = document.getElementById('advancedSearchForm');
          form.reset();
      }

      // 清除搜尋結果
      function clearSearchResults() {
          document.getElementById('searchSummary').innerHTML = '';
          document.getElementById('filterYear').value = '';
          document.getElementById('filterMonth').value = '';
          document.getElementById('filterType').value = '';
          document.getElementById('searchKeyword').value = '';
          currentPage = 1;
          displayTransactions();
      }

      // ==================== 批量操作 ====================
      
      // 切換全選
      function toggleSelectAll() {
          const selectAll = document.getElementById('selectAll');
          const checkboxes = document.querySelectorAll('#transactionTableBody input[type="checkbox"]');
          
          checkboxes.forEach(checkbox => {
              checkbox.checked = selectAll.checked;
          });
      }

      // 切換會員全選
      function toggleSelectAllMembers() {
          const selectAll = document.getElementById('selectAllMembers');
          const checkboxes = document.querySelectorAll('#memberTableBody input[type="checkbox"]');
          
          checkboxes.forEach(checkbox => {
              checkbox.checked = selectAll.checked;
          });
      }

      // 執行批量操作
      function performBatchAction() {
          const action = document.getElementById('batchAction').value;
          const selectedIds = Array.from(document.querySelectorAll('#transactionTableBody input[type="checkbox"]:checked'))
              .map(checkbox => checkbox.value);
          
          if (!action) {
              showToast('warning', '請選擇要執行的操作');
              return;
          }
          
          if (selectedIds.length === 0) {
              showToast('warning', '請選擇要操作的項目');
              return;
          }
          
          switch (action) {
              case 'delete':
                  batchDeleteTransactions(selectedIds);
                  break;
              case 'export':
                  batchExportTransactions(selectedIds);
                  break;
              case 'print':
                  batchPrintReceipts(selectedIds);
                  break;
          }
      }

      // 批量刪除交易
      function batchDeleteTransactions(ids) {
          Swal.fire({
              title: '確認批量刪除',
              text: `您確定要刪除選中的 ${ids.length} 筆交易記錄嗎？`,
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#dc3545',
              cancelButtonColor: '#6c757d',
              confirmButtonText: '確定刪除',
              cancelButtonText: '取消'
          }).then((result) => {
              if (result.isConfirmed) {
                  transactions = transactions.filter(t => !ids.includes(t.id));
                  saveData();
                  updateDashboard();
                  displayTransactions();
                  showToast('success', `已刪除 ${ids.length} 筆交易記錄`);
                  
                  // 重置選擇
                  document.getElementById('selectAll').checked = false;
                  document.getElementById('batchAction').value = '';
              }
          });
      }

      // 批量匯出交易
      function batchExportTransactions(ids) {
          const selectedTransactions = transactions.filter(t => ids.includes(t.id));
          exportTransactionsData(selectedTransactions, `選中交易記錄_${new Date().toISOString().split('T')[0]}.xlsx`);
      }

      // 批量列印收據
      function batchPrintReceipts(ids) {
          const selectedTransactions = transactions.filter(t => ids.includes(t.id));
          
          let printContent = '';
          selectedTransactions.forEach(transaction => {
              printContent += generateReceiptHTML(transaction) + '<div style="page-break-after: always;"></div>';
          });
          
          const printWindow = window.open('', '_blank');
          printWindow.document.write(`
              <html>
                  <head>
                      <title>批量收據列印</title>
                      <style>
                          body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                          .receipt { width: 100%; max-width: 400px; margin-bottom: 40px; }
                          @media print {
                              body { margin: 0; padding: 0; }
                              .receipt { page-break-inside: avoid; }
                          }
                      </style>
                  </head>
                  <body>
                      ${printContent}
                      <script>
                          window.onload = function() {
                              window.print();
                              window.close();
                          }
                      </script>
                  </body>
              </html>
          `);
      }

      // 生成收據 HTML
      function generateReceiptHTML(transaction) {
          return `
              <div class="receipt">
                  <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
                      <h2 style="margin: 0;">${settings.orgName}</h2>
                      <p style="margin: 5px 0;">收據</p>
                  </div>
                  <div style="margin-bottom: 20px;">
                      <p><strong>收據編號:</strong> ${transaction.receiptNumber}</p>
                      <p><strong>日期:</strong> ${transaction.date}</p>
                      <p><strong>收款人:</strong> ${transaction.counterparty || '無'}</p>
                      <p><strong>金額:</strong> $${transaction.amount.toLocaleString()}</p>
                      <p><strong>用途:</strong> ${transaction.description || transaction.category}</p>
                  </div>
                  <div style="text-align: right; margin-top: 40px;">
                      <p>經手人: _______________</p>
                      <p>日期: ${new Date().toLocaleDateString()}</p>
                  </div>
              </div>
          `;
      }

      // ==================== 匯出功能 ====================
      
      // 匯出交易記錄到 Excel
      function exportTransactionsToExcel() {
          const dataToExport = filteredTransactions.length > 0 ? filteredTransactions : transactions;
          exportTransactionsData(dataToExport, `交易記錄_${new Date().toISOString().split('T')[0]}.xlsx`);
      }

      // 匯出交易資料
      function exportTransactionsData(data, filename) {
          const exportData = data.map(transaction => ({
              '日期': transaction.date,
              '類型': transaction.type,
              '類別': transaction.category,
              '金額': transaction.amount,
              '對象': transaction.counterparty || '',
              '帳戶': transaction.account || '',
              '說明': transaction.description || '',
              '收據編號': transaction.receiptNumber || '',
              '建立時間': transaction.createdAt,
              '更新時間': transaction.updatedAt
          }));
          
          const worksheet = XLSX.utils.json_to_sheet(exportData);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, '交易記錄');
          
          XLSX.writeFile(workbook, filename);
          showToast('success', '交易記錄已匯出');
      }

      // 匯出會員資料到 Excel
      function exportMembersToExcel() {
          const dataToExport = filteredMembers.length > 0 ? filteredMembers : members;
          
          const exportData = dataToExport.map(member => ({
              '姓名': member.name,
              '電話': member.phone,
              '電子郵件': member.email || '',
              '出生日期': member.birthDate || '',
              '性別': member.gender || '',
              '身分證字號': member.idNumber || '',
              '地址': member.address || '',
              '緊急聯絡人': member.emergencyContact || '',
              '緊急聯絡電話': member.emergencyPhone || '',
              '加入日期': member.joinDate,
              '會員狀態': getStatusText(member.status),
              '會員類型': getMemberTypeText(member.type),
              '年費金額': member.membershipFee || 0,
              '最後繳費日期': member.lastPaymentDate || '',
              '標籤': member.tags ? member.tags.join(',') : '',
              '備註': member.notes || '',
              '建立時間': member.createdAt,
              '更新時間': member.updatedAt
          }));
          
          const worksheet = XLSX.utils.json_to_sheet(exportData);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, '會員資料');
          
          XLSX.writeFile(workbook, `會員資料_${new Date().toISOString().split('T')[0]}.xlsx`);
          showToast('success', '會員資料已匯出');
      }

      // ==================== 統計分析 ====================
      
      // 更新統計分析
      function updateAnalytics() {
          const year = document.getElementById('analyticsYear')?.value;
          const month = document.getElementById('analyticsMonth')?.value;
          
          let analyticsData = [...transactions];
          
          // 篩選年份
          if (year) {
              analyticsData = analyticsData.filter(t => new Date(t.date).getFullYear().toString() === year);
          }
          
          // 篩選月份
          if (month) {
              analyticsData = analyticsData.filter(t => (new Date(t.date).getMonth() + 1).toString() === month);
          }
          
          // 更新圖表
          updateTrendChart(analyticsData);
          updateCategoryChart(analyticsData);
          updateMonthlyChart(analyticsData);
          updateMemberGrowthChart();
      }

      // 更新趨勢圖表
      function updateTrendChart(data) {
          const ctx = document.getElementById('trendChart');
          if (!ctx) return;
          
          // 按月份分組數據
          const monthlyData = {};
          data.forEach(transaction => {
              const date = new Date(transaction.date);
              const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
              
              if (!monthlyData[monthKey]) {
                  monthlyData[monthKey] = { income: 0, expense: 0 };
              }
              
              if (transaction.type === '收入') {
                  monthlyData[monthKey].income += transaction.amount;
              } else {
                  monthlyData[monthKey].expense += transaction.amount;
              }
          });
          
          const labels = Object.keys(monthlyData).sort();
          const incomeData = labels.map(label => monthlyData[label].income);
          const expenseData = labels.map(label => monthlyData[label].expense);
          
          new Chart(ctx, {
              type: 'line',
              data: {
                  labels: labels,
                  datasets: [{
                      label: '收入',
                      data: incomeData,
                      borderColor: 'rgb(75, 192, 192)',
                      backgroundColor: 'rgba(75, 192, 192, 0.2)',
                      tension: 0.1
                  }, {
                      label: '支出',
                      data: expenseData,
                      borderColor: 'rgb(255, 99, 132)',
                      backgroundColor: 'rgba(255, 99, 132, 0.2)',
                      tension: 0.1
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                      y: {
                          beginAtZero: true,
                          ticks: {
                              callback: function(value) {
                                  return '$' + value.toLocaleString();
                              }
                          }
                      }
                  }
              }
          });
      }

      // 更新類別圖表
      function updateCategoryChart(data) {
          const ctx = document.getElementById('categoryChart');
          if (!ctx) return;
          
          // 統計支出類別
          const categoryData = {};
          data.filter(t => t.type === '支出').forEach(transaction => {
              if (!categoryData[transaction.category]) {
                  categoryData[transaction.category] = 0;
              }
              categoryData[transaction.category] += transaction.amount;
          });
          
          const labels = Object.keys(categoryData);
          const amounts = Object.values(categoryData);
          
          new Chart(ctx, {
              type: 'doughnut',
              data: {
                  labels: labels,
                  datasets: [{
                      data: amounts,
                      backgroundColor: [
                          '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                          '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                          '#4BC0C0', '#FF6384'
                      ]
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: {
                          position: 'bottom'
                      },
                      tooltip: {
                          callbacks: {
                              label: function(context) {
                                  return context.label + ': $' + context.parsed.toLocaleString();
                              }
                          }
                      }
                  }
              }
          });
      }

      // 更新月度對比圖表
      function updateMonthlyChart(data) {
          const ctx = document.getElementById('monthlyChart');
          if (!ctx) return;
          
          // 按月份統計
          const monthlyStats = {};
          for (let i = 1; i <= 12; i++) {
              monthlyStats[i] = { income: 0, expense: 0 };
          }
          
          data.forEach(transaction => {
              const month = new Date(transaction.date).getMonth() + 1;
              if (transaction.type === '收入') {
                  monthlyStats[month].income += transaction.amount;
              } else {
                  monthlyStats[month].expense += transaction.amount;
              }
          });
          
          const labels = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
          const incomeData = Object.values(monthlyStats).map(stat => stat.income);
          const expenseData = Object.values(monthlyStats).map(stat => stat.expense);
          
          new Chart(ctx, {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{
                      label: '收入',
                      data: incomeData,
                      backgroundColor: 'rgba(75, 192, 192, 0.6)'
                  }, {
                      label: '支出',
                      data: expenseData,
                      backgroundColor: 'rgba(255, 99, 132, 0.6)'
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                      y: {
                          beginAtZero: true,
                          ticks: {
                              callback: function(value) {
                                  return '$' + value.toLocaleString();
                              }
                          }
                      }
                  }
              }
          });
      }

      // 更新會員成長圖表
      function updateMemberGrowthChart() {
          const ctx = document.getElementById('memberGrowthChart');
          if (!ctx) return;
          
          // 按月份統計會員成長
          const monthlyGrowth = {};
          members.forEach(member => {
              const date = new Date(member.joinDate);
              const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
              
              if (!monthlyGrowth[monthKey]) {
                  monthlyGrowth[monthKey] = 0;
              }
              monthlyGrowth[monthKey]++;
          });
          
          const labels = Object.keys(monthlyGrowth).sort();
          let cumulativeData = [];
          let cumulative = 0;
          
          labels.forEach(label => {
              cumulative += monthlyGrowth[label];
              cumulativeData.push(cumulative);
          });
          
          new Chart(ctx, {
              type: 'line',
              data: {
                  labels: labels,
                  datasets: [{
                      label: '累計會員數',
                      data: cumulativeData,
                      borderColor: 'rgb(54, 162, 235)',
                      backgroundColor: 'rgba(54, 162, 235, 0.2)',
                      fill: true,
                      tension: 0.1
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                      y: {
                          beginAtZero: true,
                          ticks: {
                              stepSize: 1
                          }
                      }
                  }
              }
          });
      }

      // ==================== 導航功能 ====================
      
      // 顯示指定區段
      function showSection(sectionName) {
          // 隱藏所有區段
          const sections = document.querySelectorAll('.content-section');
          sections.forEach(section => {
              section.style.display = 'none';
          });
          
          // 顯示指定區段
          const targetSection = document.getElementById(sectionName + 'Section');
          if (targetSection) {
              targetSection.style.display = 'block';
          }
          
          // 更新導航狀態
          const navLinks = document.querySelectorAll('.sidebar .nav-link');
          navLinks.forEach(link => {
              link.classList.remove('active');
          });
          
          const activeLink = document.querySelector(`.sidebar .nav-link[onclick="showSection('${sectionName}')"]`);
          if (activeLink) {
              activeLink.classList.add('active');
          }
          
          // 根據區段執行特定操作
          switch (sectionName) {
              case 'dashboard':
                  updateDashboard();
                  break;
              case 'transactions':
                  displayTransactions();
                  break;
              case 'members':
                  displayMembers();
                  break;
              case 'analytics':
                  updateAnalytics();
                  break;
          }
      }

      // ==================== 雲端同步系統 ====================
      
      // 初始化同步系統
      function initializeSyncSystem() {
          // 檢查網路狀態
          updateNetworkStatus();
          
          // 監聽網路狀態變化
          window.addEventListener('online', () => {
              syncStatus.isOnline = true;
              updateSyncIndicator();
              // 網路恢復時自動同步
              if (localStorage.getItem('pendingSync') === 'true') {
                  setTimeout(syncToCloud, 2000);
              }
          });
          
          window.addEventListener('offline', () => {
              syncStatus.isOnline = false;
              updateSyncIndicator();
          });
          
          // 載入同步設定
          loadSyncSettings();
          
          // 設定自動同步
          if (settings.autoSync && !settings.offlineMode) {
              setInterval(() => {
                  if (syncStatus.isOnline && localStorage.getItem('pendingSync') === 'true') {
                      syncToCloud();
                  }
              }, (settings.syncInterval || 5) * 60 * 1000); // 轉換為毫秒
          }
      }

      // 更新網路狀態
      function updateNetworkStatus() {
          syncStatus.isOnline = navigator.onLine;
          updateSyncIndicator();
      }

      // 更新同步指示器
      function updateSyncIndicator() {
          const indicator = document.getElementById('syncIndicator');
          const isPending = localStorage.getItem('pendingSync') === 'true';
          
          if (!syncStatus.isOnline) {
              indicator.className = 'badge bg-warning';
              indicator.innerHTML = '<i class="bi bi-wifi-off"></i> 離線';
          } else if (isPending) {
              indicator.className = 'badge bg-info';
              indicator.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> 同步中';
          } else {
              indicator.className = 'badge bg-success';
              indicator.innerHTML = '<i class="bi bi-cloud-check"></i> 已同步';
          }
      }

      // 標記為待同步
      function markPendingSync() {
          localStorage.setItem('pendingSync', 'true');
          updateSyncIndicator();
      }

      // 同步到雲端
      async function syncToCloud() {
          if (settings.offlineMode || !settings.apiUrl) {
              return;
          }
          
          if (!syncStatus.isOnline) {
              showToast('warning', '網路連線中斷，無法同步');
              return;
          }
          
          try {
              syncStatus.pendingSync = true;
              updateSyncIndicator();
              
              const syncData = {
                  transactions: transactions,
                  members: members,
                  settings: settings,
                  lastSync: new Date().toISOString()
              };
              
              const response = await fetch(settings.apiUrl, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'sync',
                      data: syncData
                  })
              });
              
              if (response.ok) {
                  const result = await response.json();
                  
                  if (result.success) {
                      // 處理衝突
                      if (result.conflicts && result.conflicts.length > 0) {
                          handleSyncConflicts(result.conflicts);
                      } else {
                          // 同步成功
                          localStorage.setItem('lastSync', new Date().toISOString());
                          localStorage.removeItem('pendingSync');
                          syncStatus.lastSync = new Date().toISOString();
                          syncStatus.pendingSync = false;
                          updateSyncIndicator();
                          
                          // 記錄同步歷史
                          addSyncHistory('success', '同步成功');
                      }
                  } else {
                      throw new Error(result.message || '同步失敗');
                  }
              } else {
                  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
          } catch (error) {
              console.error('同步錯誤:', error);
              syncStatus.pendingSync = false;
              updateSyncIndicator();
              addSyncHistory('error', `同步失敗: ${error.message}`);
              
              // 如果不是網路錯誤，顯示錯誤訊息
              if (!error.message.includes('Failed to fetch')) {
                  showToast('error', `同步失敗: ${error.message}`);
              }
          }
      }

      // 處理同步衝突
      function handleSyncConflicts(conflicts) {
          if (!settings.conflictResolution) {
              showToast('warning', '發現資料衝突，請檢查同步設定');
              return;
          }
          
          Swal.fire({
              title: '資料衝突',
              text: `發現 ${conflicts.length} 個資料衝突，需要手動處理`,
              icon: 'warning',
              showCancelButton: true,
              confirmButtonText: '查看衝突',
              cancelButtonText: '稍後處理'
          }).then((result) => {
              if (result.isConfirmed) {
                  showConflictResolutionModal(conflicts);
              }
          });
      }

      // 顯示衝突解決模態框
      function showConflictResolutionModal(conflicts) {
          // 這裡可以實作衝突解決介面
          console.log('需要解決的衝突:', conflicts);
      }

      // 添加同步歷史記錄
      function addSyncHistory(status, message) {
          const history = JSON.parse(localStorage.getItem('syncHistory') || '[]');
          history.unshift({
              timestamp: new Date().toISOString(),
              status: status,
              message: message
          });
          
          // 只保留最近 50 筆記錄
          if (history.length > 50) {
              history.splice(50);
          }
          
          localStorage.setItem('syncHistory', JSON.stringify(history));
      }

      // 載入同步設定
      function loadSyncSettings() {
          const syncSettings = localStorage.getItem('syncSettings');
          if (syncSettings) {
              const parsed = JSON.parse(syncSettings);
              Object.assign(settings, parsed);
          }
      }

      // 手動同步
      function manualSync() {
          if (settings.offlineMode) {
              showToast('info', '目前為離線模式，無法同步');
              return;
          }
          
          if (!settings.apiUrl) {
              showToast('warning', '請先設定 API URL');
              return;
          }
          
          syncToCloud();
      }

      // 測試連線
      async function testConnection() {
          const apiUrl = document.getElementById('apiUrl').value;
          const statusDiv = document.getElementById('connectionStatus');
          
          if (!apiUrl) {
              statusDiv.innerHTML = '<div class="alert alert-warning">請輸入 API URL</div>';
              return;
          }
          
          statusDiv.innerHTML = '<div class="alert alert-info">測試連線中...</div>';
          
          try {
              const response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'test'
                  })
              });
              
              if (response.ok) {
                  statusDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> 連線成功</div>';
              } else {
                  statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> 連線失敗</div>';
              }
          } catch (error) {
              statusDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> 連線錯誤: ${error.message}</div>`;
          }
      }

      // 儲存同步設定
      function saveSyncSettings() {
          const syncSettings = {
              apiUrl: document.getElementById('apiUrl').value,
              syncInterval: parseInt(document.getElementById('syncInterval').value),
              autoSync: document.getElementById('autoSync').checked,
              offlineMode: document.getElementById('offlineMode').checked,
              conflictResolution: document.getElementById('conflictResolution').checked
          };
          
          Object.assign(settings, syncSettings);
          saveSettings();
          
          const modal = bootstrap.Modal.getInstance(document.getElementById('syncSettingsModal'));
          modal.hide();
          
          showToast('success', '同步設定已儲存');
      }

      // 顯示同步狀態
      function showSyncStatus() {
          updateSyncStats();
          const modal = new bootstrap.Modal(document.getElementById('syncStatusModal'));
          modal.show();
      }

      // 更新同步統計
      function updateSyncStats() {
          const lastSync = localStorage.getItem('lastSync');
          const pendingSync = localStorage.getItem('pendingSync') === 'true';
          const history = JSON.parse(localStorage.getItem('syncHistory') || '[]');
          
          const statsHTML = `
              <div class="row">
                  <div class="col-md-6">
                      <div class="card">
                          <div class="card-body text-center">
                              <i class="bi bi-clock-history display-4 text-primary"></i>
                              <h5 class="mt-2">最後同步</h5>
                              <p class="text-muted">${lastSync ? new Date(lastSync).toLocaleString() : '從未同步'}</p>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-6">
                      <div class="card">
                          <div class="card-body text-center">
                              <i class="bi bi-arrow-clockwise display-4 ${pendingSync ? 'text-warning' : 'text-success'}"></i>
                              <h5 class="mt-2">同步狀態</h5>
                              <p class="text-muted">${pendingSync ? '待同步' : '已同步'}</p>
                          </div>
                      </div>
                  </div>
              </div>
          `;
          
          document.getElementById('syncStats').innerHTML = statsHTML;
          
          // 更新同步歷史
          const historyHTML = history.slice(0, 10).map(record => `
              <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                  <div>
                      <i class="bi bi-${record.status === 'success' ? 'check-circle text-success' : 'x-circle text-danger'}"></i>
                      ${record.message}
                  </div>
                  <small class="text-muted">${new Date(record.timestamp).toLocaleString()}</small>
              </div>
          `).join('');
          
          document.getElementById('syncHistory').innerHTML = historyHTML || '<p class="text-muted">暫無同步記錄</p>';
      }

      // ==================== 系統設定 ====================
      
      // 顯示系統設定
      function showSystemSettings() {
          // 載入當前設定
          document.getElementById('orgName').value = settings.orgName || '';
          document.getElementById('orgAddress').value = settings.orgAddress || '';
          document.getElementById('orgPhone').value = settings.orgPhone || '';
          document.getElementById('orgEmail').value = settings.orgEmail || '';
          document.getElementById('defaultMembershipFee').value = settings.defaultMembershipFee || 1000;
          document.getElementById('receiptPrefix').value = settings.receiptPrefix || 'R';
          document.getElementById('pageSize').value = settings.pageSize || 20;
          document.getElementById('autoBackup').checked = settings.autoBackup !== false;
          document.getElementById('emailNotifications').checked = settings.emailNotifications !== false;
          
          const modal = new bootstrap.Modal(document.getElementById('systemSettingsModal'));
          modal.show();
      }

      // 儲存系統設定
      function saveSystemSettings() {
          settings.orgName = document.getElementById('orgName').value;
          settings.orgAddress = document.getElementById('orgAddress').value;
          settings.orgPhone = document.getElementById('orgPhone').value;
          settings.orgEmail = document.getElementById('orgEmail').value;
          settings.defaultMembershipFee = parseFloat(document.getElementById('defaultMembershipFee').value);
          settings.receiptPrefix = document.getElementById('receiptPrefix').value;
          settings.pageSize = parseInt(document.getElementById('pageSize').value);
          settings.autoBackup = document.getElementById('autoBackup').checked;
          settings.emailNotifications = document.getElementById('emailNotifications').checked;
          
          saveSettings();
          
          const modal = bootstrap.Modal.getInstance(document.getElementById('systemSettingsModal'));
          modal.hide();
          
          showToast('success', '系統設定已儲存');
          
          // 重新載入頁面以應用新設定
          setTimeout(() => {
              displayTransactions();
              displayMembers();
          }, 500);
      }

      // 顯示同步設定
      function showSyncSettings() {
          // 載入當前同步設定
          document.getElementById('apiUrl').value = settings.apiUrl || '';
          document.getElementById('syncInterval').value = settings.syncInterval || 5;
          document.getElementById('autoSync').checked = settings.autoSync !== false;
          document.getElementById('offlineMode').checked = settings.offlineMode === true;
          document.getElementById('conflictResolution').checked = settings.conflictResolution !== false;
          
          const modal = new bootstrap.Modal(document.getElementById('syncSettingsModal'));
          modal.show();
      }

      // ==================== 報表功能 ====================
      
      // 生成報表
      function generateReport() {
          const reportType = document.getElementById('reportType').value;
          const startDate = document.getElementById('reportStartDate').value;
          const endDate = document.getElementById('reportEndDate').value;
          
          if (!startDate || !endDate) {
              showToast('warning', '請選擇報表日期範圍');
              return;
          }
          
          switch (reportType) {
              case 'financial':
                  generateFinancialReport(startDate, endDate);
                  break;
              case 'member':
                  generateMemberReport(startDate, endDate);
                  break;
              case 'dues':
                  generateDuesReport(startDate, endDate);
                  break;
              case 'activity':
                  generateActivityReport(startDate, endDate);
                  break;
          }
      }

      // 生成財務報表
      function generateFinancialReport(startDate = null, endDate = null) {
          let reportData = [...transactions];
          
          if (startDate && endDate) {
              reportData = reportData.filter(t => {
                  const transactionDate = new Date(t.date);
                  return transactionDate >= new Date(startDate) && transactionDate <= new Date(endDate);
              });
          }
          
          const totalIncome = reportData.filter(t => t.type === '收入').reduce((sum, t) => sum + t.amount, 0);
          const totalExpense = reportData.filter(t => t.type === '支出').reduce((sum, t) => sum + t.amount, 0);
          const netIncome = totalIncome - totalExpense;
          
          // 按類別統計
          const incomeByCategory = {};
          const expenseByCategory = {};
          
          reportData.forEach(t => {
              if (t.type === '收入') {
                  incomeByCategory[t.category] = (incomeByCategory[t.category] || 0) + t.amount;
              } else {
                  expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + t.amount;
              }
          });
          
          const reportContent = `
              <div class="report-content">
                  <div class="report-header text-center mb-4">
                      <h3>${settings.orgName}</h3>
                      <h4>財務報表</h4>
                      <p>報表期間: ${startDate || '全部'} ~ ${endDate || '全部'}</p>
                      <p>產生時間: ${new Date().toLocaleString()}</p>
                  </div>
                  
                  <div class="row mb-4">
                      <div class="col-md-4">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h5 class="text-success">總收入</h5>
                                  <h3>$${totalIncome.toLocaleString()}</h3>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h5 class="text-danger">總支出</h5>
                                  <h3>$${totalExpense.toLocaleString()}</h3>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h5 class="${netIncome >= 0 ? 'text-success' : 'text-danger'}">淨收入</h5>
                                  <h3>$${netIncome.toLocaleString()}</h3>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <div class="row">
                      <div class="col-md-6">
                          <h5>收入明細</h5>
                          <table class="table table-sm">
                              <thead>
                                  <tr>
                                      <th>類別</th>
                                      <th class="text-end">金額</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${Object.entries(incomeByCategory).map(([category, amount]) => `
                                      <tr>
                                          <td>${category}</td>
                                          <td class="text-end">$${amount.toLocaleString()}</td>
                                      </tr>
                                  `).join('')}
                                  <tr class="table-success">
                                      <th>小計</th>
                                      <th class="text-end">$${totalIncome.toLocaleString()}</th>
                                  </tr>
                              </tbody>
                          </table>
                      </div>
                      <div class="col-md-6">
                          <h5>支出明細</h5>
                          <table class="table table-sm">
                              <thead>
                                  <tr>
                                      <th>類別</th>
                                      <th class="text-end">金額</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${Object.entries(expenseByCategory).map(([category, amount]) => `
                                      <tr>
                                          <td>${category}</td>
                                          <td class="text-end">$${amount.toLocaleString()}</td>
                                      </tr>
                                  `).join('')}
                                  <tr class="table-danger">
                                      <th>小計</th>
                                      <th class="text-end">$${totalExpense.toLocaleString()}</th>
                                  </tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          `;
          
          showReportModal('財務報表', reportContent);
      }

      // 生成會員報表
      function generateMemberReport() {
          const totalMembers = members.length;
          const activeMembers = members.filter(m => m.status === 'active').length;
          const inactiveMembers = members.filter(m => m.status === 'inactive').length;
          const pendingMembers = members.filter(m => m.status === 'pending').length;
          const overdueMembers = members.filter(m => isPaymentOverdue(m)).length;
          
          // 按類型統計
          const membersByType = {};
          members.forEach(m => {
              const type = getMemberTypeText(m.type);
              membersByType[type] = (membersByType[type] || 0) + 1;
          });
          
          // 按月份統計新增會員
          const membersByMonth = {};
          members.forEach(m => {
              const date = new Date(m.joinDate);
              const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
              membersByMonth[monthKey] = (membersByMonth[monthKey] || 0) + 1;
          });
          
          const reportContent = `
              <div class="report-content">
                  <div class="report-header text-center mb-4">
                      <h3>${settings.orgName}</h3>
                      <h4>會員統計報表</h4>
                      <p>產生時間: ${new Date().toLocaleString()}</p>
                  </div>
                  
                  <div class="row mb-4">
                      <div class="col-md-3">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h5>總會員數</h5>
                                  <h3 class="text-primary">${totalMembers}</h3>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-3">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h5>正常會員</h5>
                                  <h3 class="text-success">${activeMembers}</h3>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-3">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h5>停權會員</h5>
                                  <h3 class="text-danger">${inactiveMembers}</h3>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-3">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h5>逾期繳費</h5>
                                  <h3 class="text-warning">${overdueMembers}</h3>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <div class="row">
                      <div class="col-md-6">
                          <h5>會員類型分布</h5>
                          <table class="table table-sm">
                              <thead>
                                  <tr>
                                      <th>類型</th>
                                      <th class="text-end">人數</th>
                                      <th class="text-end">比例</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${Object.entries(membersByType).map(([type, count]) => `
                                      <tr>
                                          <td>${type}</td>
                                          <td class="text-end">${count}</td>
                                          <td class="text-end">${((count / totalMembers) * 100).toFixed(1)}%</td>
                                      </tr>
                                  `).join('')}
                              </tbody>
                          </table>
                      </div>
                      <div class="col-md-6">
                          <h5>月度新增會員</h5>
                          <table class="table table-sm">
                              <thead>
                                  <tr>
                                      <th>月份</th>
                                      <th class="text-end">新增人數</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${Object.entries(membersByMonth)
                                      .sort(([a], [b]) => b.localeCompare(a))
                                      .slice(0, 12)
                                      .map(([month, count]) => `
                                      <tr>
                                          <td>${month}</td>
                                          <td class="text-end">${count}</td>
                                      </tr>
                                  `).join('')}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          `;
          
          showReportModal('會員統計報表', reportContent);
      }

      // 生成會費報表
      function generateDuesReport() {
          const currentYear = new Date().getFullYear();
          const totalDues = members.reduce((sum, m) => sum + (m.membershipFee || 0), 0);
          const paidDues = members.filter(m => !isPaymentOverdue(m)).reduce((sum, m) => sum + (m.membershipFee || 0), 0);
          const overdueDues = totalDues - paidDues;
          
          const reportContent = `
              <div class="report-content">
                  <div class="report-header text-center mb-4">
                      <h3>${settings.orgName}</h3>
                      <h4>會費收繳報表</h4>
                      <p>統計年度: ${currentYear}</p>
                      <p>產生時間: ${new Date().toLocaleString()}</p>
                  </div>
                  
                  <div class="row mb-4">
                      <div class="col-md-4">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h5>應收會費</h5>
                                  <h3 class="text-info">$${totalDues.toLocaleString()}</h3>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h5>已收會費</h5>
                                  <h3 class="text-success">$${paidDues.toLocaleString()}</h3>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h5>逾期會費</h5>
                                  <h3 class="text-danger">$${overdueDues.toLocaleString()}</h3>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <div class="mb-4">
                      <h5>逾期會員名單</h5>
                      <table class="table table-sm">
                          <thead>
                              <tr>
                                  <th>姓名</th>
                                  <th>電話</th>
                                  <th>最後繳費日期</th>
                                  <th class="text-end">應繳金額</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${members.filter(m => isPaymentOverdue(m)).map(member => `
                                  <tr>
                                      <td>${member.name}</td>
                                      <td>${member.phone}</td>
                                      <td>${member.lastPaymentDate || '從未繳費'}</td>
                                      <td class="text-end">$${(member.membershipFee || 0).toLocaleString()}</td>
                                  </tr>
                              `).join('')}
                          </tbody>
                      </table>
                  </div>
              </div>
          `;
          
          showReportModal('會費收繳報表', reportContent);
      }

      // 生成活動報表
      function generateActivityReport() {
          // 統計活動相關的收支
          const activityTransactions = transactions.filter(t => 
              t.category === '活動收入' || t.category === '活動費用'
          );
          
          const activityIncome = activityTransactions
              .filter(t => t.type === '收入')
              .reduce((sum, t) => sum + t.amount, 0);
          
          const activityExpense = activityTransactions
              .filter(t => t.type === '支出')
              .reduce((sum, t) => sum + t.amount, 0);
          
          const reportContent = `
              <div class="report-content">
                  <div class="report-header text-center mb-4">
                      <h3>${settings.orgName}</h3>
                      <h4>活動收支報表</h4>
                      <p>產生時間: ${new Date().toLocaleString()}</p>
                  </div>
                  
                  <div class="row mb-4">
                      <div class="col-md-4">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h5>活動收入</h5>
                                  <h3 class="text-success">$${activityIncome.toLocaleString()}</h3>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h5>活動支出</h5>
                                  <h3 class="text-danger">$${activityExpense.toLocaleString()}</h3>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="card text-center">
                              <div class="card-body">
                                  <h5>活動淨收入</h5>
                                  <h3 class="${(activityIncome - activityExpense) >= 0 ? 'text-success' : 'text-danger'}">
                                      $${(activityIncome - activityExpense).toLocaleString()}
                                  </h3>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <div class="mb-4">
                      <h5>活動交易明細</h5>
                      <table class="table table-sm">
                          <thead>
                              <tr>
                                  <th>日期</th>
                                  <th>類型</th>
                                  <th>說明</th>
                                  <th class="text-end">金額</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${activityTransactions.map(t => `
                                  <tr>
                                      <td>${t.date}</td>
                                      <td><span class="badge ${t.type === '收入' ? 'bg-success' : 'bg-danger'}">${t.type}</span></td>
                                      <td>${t.description || t.category}</td>
                                      <td class="text-end">$${t.amount.toLocaleString()}</td>
                                  </tr>
                              `).join('')}
                          </tbody>
                      </table>
                  </div>
              </div>
          `;
          
          showReportModal('活動收支報表', reportContent);
      }

      // 顯示報表模態框
      function showReportModal(title, content) {
          document.getElementById('reportModalTitle').textContent = title;
          document.getElementById('reportModalContent').innerHTML = content;
          
          const modal = new bootstrap.Modal(document.getElementById('reportModal'));
          modal.show();
      }

      // 列印報表
      function printReport() {
          const content = document.getElementById('reportModalContent').innerHTML;
          const printWindow = window.open('', '_blank');
          printWindow.document.write(`
              <html>
                  <head>
                      <title>報表列印</title>
                      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                      <style>
                          body { font-family: Arial, sans-serif; }
                          @media print {
                              .no-print { display: none; }
                          }
                      </style>
                  </head>
                  <body>
                      <div class="container">
                          ${content}
                      </div>
                      <script>
                          window.onload = function() {
                              window.print();
                              window.close();
                          }
                      </script>
                  </body>
              </html>
          `);
      }

      // 匯出報表
      function exportReport() {
          const title = document.getElementById('reportModalTitle').textContent;
          const content = document.getElementById('reportModalContent');
          
          // 提取表格資料並匯出為 Excel
          const tables = content.querySelectorAll('table');
          const workbook = XLSX.utils.book_new();
          
          tables.forEach((table, index) => {
              const worksheet = XLSX.utils.table_to_sheet(table);
              XLSX.utils.book_append_sheet(workbook, worksheet, `表格${index + 1}`);
          });
          
          const filename = `${title}_${new Date().toISOString().split('T')[0]}.xlsx`;
          XLSX.writeFile(workbook, filename);
          showToast('success', '報表已匯出');
      }

      // ==================== 備份與還原 ====================
      
      // 備份資料
      function backupData() {
          const backupData = {
              version: '1.0',
              timestamp: new Date().toISOString(),
              transactions: transactions,
              members: members,
              settings: settings
          };
          
          const dataStr = JSON.stringify(backupData, null, 2);
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          
          const link = document.createElement('a');
          link.href = URL.createObjectURL(dataBlob);
          link.download = `帕金森會計系統備份_${new Date().toISOString().split('T')[0]}.json`;
          link.click();
          
          showToast('success', '資料備份已下載');
      }

      // 還原資料
      function restoreData() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = function(event) {
              const file = event.target.files[0];
              if (!file) return;
              
              const reader = new FileReader();
              reader.onload = function(e) {
                  try {
                      const backupData = JSON.parse(e.target.result);
                      
                      // 驗證備份資料格式
                      if (!backupData.version || !backupData.transactions || !backupData.members) {
                          throw new Error('備份檔案格式不正確');
                      }
                      
                      Swal.fire({
                          title: '確認還原',
                          text: '還原資料將覆蓋現有資料，確定要繼續嗎？',
                          icon: 'warning',
                          showCancelButton: true,
                          confirmButtonColor: '#dc3545',
                          cancelButtonColor: '#6c757d',
                          confirmButtonText: '確定還原',
                          cancelButtonText: '取消'
                      }).then((result) => {
                          if (result.isConfirmed) {
                              // 還原資料
                              transactions = backupData.transactions || [];
                              members = backupData.members || [];
                              if (backupData.settings) {
                                  settings = { ...settings, ...backupData.settings };
                              }
                              
                              saveData();
                              saveSettings();
                              
                              // 重新載入介面
                              updateDashboard();
                              displayTransactions();
                              displayMembers();
                              
                              showToast('success', '資料還原完成');
                          }
                      });
                      
                  } catch (error) {
                      showToast('error', '備份檔案讀取失敗：' + error.message);
                  }
              };
              reader.readAsText(file);
          };
          input.click();
      }

      // 清空所有資料
      function clearAllData() {
          Swal.fire({
              title: '危險操作',
              text: '這將清空所有交易記錄和會員資料，且無法復原！',
              icon: 'error',
              showCancelButton: true,
              confirmButtonColor: '#dc3545',
              cancelButtonColor: '#6c757d',
              confirmButtonText: '確定清空',
              cancelButtonText: '取消',
              input: 'text',
              inputPlaceholder: '請輸入 "CLEAR" 確認清空',
              inputValidator: (value) => {
                  if (value !== 'CLEAR') {
                      return '請輸入正確的確認文字';
                  }
              }
          }).then((result) => {
              if (result.isConfirmed) {
                  transactions = [];
                  members = [];
                  localStorage.clear();
                  
                  updateDashboard();
                  displayTransactions();
                  displayMembers();
                  
                  showToast('success', '所有資料已清空');
              }
          });
      }

      // ==================== 檢視交易詳情 ====================
      
      // 檢視交易詳情
      function viewTransactionDetail(id) {
          const transaction = transactions.find(t => t.id === id);
          if (!transaction) return;
          
          const content = `
              <div class="row">
                  <div class="col-md-6">
                      <h6><i class="bi bi-receipt"></i> 交易資訊</h6>
                      <table class="table table-sm">
                          <tr><td><strong>日期:</strong></td><td>${transaction.date}</td></tr>
                          <tr><td><strong>類型:</strong></td><td>
                              <span class="badge ${transaction.type === '收入' ? 'bg-success' : 'bg-danger'}">
                                  ${transaction.type}
                              </span>
                          </td></tr>
                          <tr><td><strong>類別:</strong></td><td>${transaction.category}</td></tr>
                          <tr><td><strong>金額:</strong></td><td class="fw-bold">$${transaction.amount.toLocaleString()}</td></tr>
                          <tr><td><strong>對象:</strong></td><td>${transaction.counterparty || '無'}</td></tr>
                          <tr><td><strong>帳戶:</strong></td><td>${transaction.account || '現金'}</td></tr>
                          <tr><td><strong>收據編號:</strong></td><td>${transaction.receiptNumber || '無'}</td></tr>
                      </table>
                  </div>
                  <div class="col-md-6">
                      <h6><i class="bi bi-info-circle"></i> 其他資訊</h6>
                      <table class="table table-sm">
                          <tr><td><strong>說明:</strong></td><td>${transaction.description || '無'}</td></tr>
                          <tr><td><strong>建立時間:</strong></td><td>${new Date(transaction.createdAt).toLocaleString()}</td></tr>
                          <tr><td><strong>更新時間:</strong></td><td>${new Date(transaction.updatedAt).toLocaleString()}</td></tr>
                          <tr><td><strong>憑證數量:</strong></td><td>${transaction.vouchers ? transaction.vouchers.length : 0} 個檔案</td></tr>
                      </table>
                  </div>
              </div>
              
              ${transaction.vouchers && transaction.vouchers.length > 0 ? `
              <div class="row mt-3">
                  <div class="col-12">
                      <h6><i class="bi bi-paperclip"></i> 憑證附件</h6>
                      <div class="voucher-gallery">
                          ${transaction.vouchers.map((voucher, index) => `
                              <div class="voucher-thumbnail" onclick="viewVoucher('${transaction.id}', ${index})">
                                  ${voucher.type.startsWith('image/') 
                                      ? `<img src="${voucher.data}" alt="${voucher.name}">`
                                      : `<div class="pdf-thumbnail"><i class="bi bi-file-earmark-pdf"></i><br>${voucher.name}</div>`
                                  }
                              </div>
                          `).join('')}
                      </div>
                  </div>
              </div>
              ` : ''}
          `;
          
          document.getElementById('transactionDetailContent').innerHTML = content;
          document.getElementById('transactionDetailModal').setAttribute('data-transaction-id', id);
          
          const modal = new bootstrap.Modal(document.getElementById('transactionDetailModal'));
          modal.show();
      }

      // 從詳情頁面編輯交易
      function editTransactionFromDetail() {
          const transactionId = document.getElementById('transactionDetailModal').getAttribute('data-transaction-id');
          const detailModal = bootstrap.Modal.getInstance(document.getElementById('transactionDetailModal'));
          detailModal.hide();
          
          setTimeout(() => {
              showTransactionModal(transactionId);
          }, 300);
      }

      // 檢視憑證
      function viewVoucher(transactionId, voucherIndex) {
          const transaction = transactions.find(t => t.id === transactionId);
          if (!transaction || !transaction.vouchers || !transaction.vouchers[voucherIndex]) return;
          
          const voucher = transaction.vouchers[voucherIndex];
          
          if (voucher.type.startsWith('image/')) {
              Swal.fire({
                  imageUrl: voucher.data,
                  imageAlt: voucher.name,
                  showCloseButton: true,
                  showConfirmButton: false,
                  width: 'auto',
                  customClass: {
                      image: 'img-fluid'
                  }
              });
          } else if (voucher.type === 'application/pdf') {
              window.open(voucher.data, '_blank');
          }
      }

      // ==================== 鍵盤快捷鍵 ====================
      
      // 初始化鍵盤快捷鍵
      document.addEventListener('keydown', function(event) {
          // Ctrl/Cmd + 快捷鍵
          if (event.ctrlKey || event.metaKey) {
              switch (event.key) {
                  case 'n': // 新增交易
                      event.preventDefault();
                      showTransactionModal();
                      break;
                  case 'm': // 新增會員
                      event.preventDefault();
                      showMemberModal();
                      break;
                  case 's': // 儲存 (在模態框中)
                      if (document.querySelector('.modal.show')) {
                          event.preventDefault();
                          const activeModal = document.querySelector('.modal.show');
                          const saveButton = activeModal.querySelector('button[onclick*="save"]');
                          if (saveButton) saveButton.click();
                      }
                      break;
                  case 'f': // 搜尋
                      event.preventDefault();
                      const searchInput = document.getElementById('searchKeyword') || document.getElementById('memberSearch');
                      if (searchInput) searchInput.focus();
                      break;
                  case 'b': // 備份
                      event.preventDefault();
                      backupData();
                      break;
              }
          }
          
          // ESC 鍵關閉模態框
          if (event.key === 'Escape') {
              const activeModal = document.querySelector('.modal.show');
              if (activeModal) {
                  const modal = bootstrap.Modal.getInstance(activeModal);
                  if (modal) modal.hide();
              }
          }
      });

      // ==================== 初始化完成提示 ====================
      
      // 頁面載入完成後顯示歡迎訊息
      window.addEventListener('load', function() {
          setTimeout(() => {
              if (transactions.length === 0 && members.length === 0) {
                  Swal.fire({
                      title: '歡迎使用帕金森會計管理系統',
                      html: `
                          <div class="text-start">
                              <p>這是一個專為台灣帕金森病友權益促進會設計的會計管理系統。</p>
                              <p><strong>主要功能：</strong></p>
                              <ul>
                                  <li>交易記錄管理</li>
                                  <li>會員資料管理</li>
                                  <li>財務統計分析</li>
                                  <li>報表生成與列印</li>
                                  <li>資料備份與還原</li>
                                  <li>雲端同步功能</li>
                              </ul>
                              <p><strong>快捷鍵：</strong></p>
                              <ul>
                                  <li>Ctrl+N：新增交易</li>
                                  <li>Ctrl+M：新增會員</li>
                                  <li>Ctrl+F：搜尋</li>
                                  <li>Ctrl+B：備份資料</li>
                              </ul>
                              <p>建議先在「系統設定」中設定組織資訊。</p>
                          </div>
                      `,
                      icon: 'info',
                      confirmButtonText: '開始使用',
                      showCancelButton: true,
                      cancelButtonText: '系統設定'
                  }).then((result) => {
                      if (result.dismiss === Swal.DismissReason.cancel) {
                          showSystemSettings();
                      }
                  });
              }
          }, 1000);
      });

      // ==================== 自動儲存功能 ====================
      
      // 定期自動備份到本地儲存
      if (settings.autoBackup) {
          setInterval(() => {
              if (transactions.length > 0 || members.length > 0) {
                  const autoBackupData = {
                      version: '1.0',
                      timestamp: new Date().toISOString(),
                      transactions: transactions,
                      members: members,
                      settings: settings,
                      type: 'auto'
                  };
                  
                  localStorage.setItem('autoBackup', JSON.stringify(autoBackupData));
                  console.log('自動備份完成:', new Date().toLocaleString());
              }
          }, 5 * 60 * 1000); // 每 5 分鐘自動備份
      }

      // ==================== 錯誤處理 ====================
      
      // 全域錯誤處理
      window.addEventListener('error', function(event) {
          console.error('系統錯誤:', event.error);
          showToast('error', '系統發生錯誤，請重新整理頁面');
      });

      // 未處理的 Promise 錯誤
      window.addEventListener('unhandledrejection', function(event) {
          console.error('Promise 錯誤:', event.reason);
          showToast('error', '操作失敗，請稍後再試');
      });

      // ==================== 版本資訊 ====================
      
      // 顯示版本資訊
      function showVersionInfo() {
          Swal.fire({
              title: '系統資訊',
              html: `
                  <div class="text-start">
                      <h6>台灣帕金森病友權益促進會會計管理系統</h6>
                      <p><strong>版本：</strong>1.0.0</p>
                      <p><strong>更新日期：</strong>2024年12月</p>
                      <p><strong>開發者：</strong>AI Assistant</p>
                      <p><strong>技術支援：</strong>
                          <ul>
                              <li>Bootstrap 5.3.0</li>
                              <li>Chart.js 4.3.0</li>
                              <li>SheetJS (XLSX)</li>
                              <li>SweetAlert2</li>
                          </ul>
                      </p>
                      <p><strong>瀏覽器支援：</strong>Chrome, Firefox, Safari, Edge</p>
                      <hr>
                      <p class="text-muted small">
                          本系統使用瀏覽器本地儲存，建議定期備份資料。
                          如需技術支援，請聯繫系統管理員。
                      </p>
                  </div>
              `,
              icon: 'info',
              confirmButtonText: '確定'
          });
      }

      // 在頁面底部添加版本資訊連結
      document.addEventListener('DOMContentLoaded', function() {
          const footer = document.createElement('div');
          footer.className = 'text-center text-muted py-3 border-top mt-5';
          footer.innerHTML = `
              <small>
                  台灣帕金森病友權益促進會會計管理系統 v1.0.0 | 
                  <a href="#" onclick="showVersionInfo()" class="text-decoration-none">系統資訊</a> | 
                  <a href="#" onclick="backupData()" class="text-decoration-none">備份資料</a>
              </small>
          `;
          document.body.appendChild(footer);
      });

      console.log('台灣帕金森病友權益促進會會計管理系統已載入完成');
  </script>
</body>
</html>
              
              
