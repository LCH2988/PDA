<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>帕金森病友會整合系統</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root {
      --primary: #06c755;
      --primary-dark: #05b04b;
      --secondary: #00b900;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --border-radius: 12px;
      --purple-1: #667eea;
      --purple-2: #764ba2;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans TC',sans-serif; background: linear-gradient(135deg, var(--purple-1) 0%, var(--purple-2) 100%); min-height:100vh; }
    .hidden { display:none !important; }

    /* 頂層容器與頁面切換 */
    .root-container { max-width: 1200px; margin: 0 auto; }
    .view { display:none; }
    .view.active { display:block; }

    /* ====== 行動端 LIFF 病友會 App 風格 ====== */
    .app-container {
      max-width: 480px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      padding-bottom: 80px;
      box-shadow: 0 0 30px rgba(0,0,0,0.1);
    }
    .top-bar {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white; padding: 15px 20px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 10px rgba(0,0,0,0.1);
    }
    .top-bar h1{ font-size:18px; font-weight:600; margin:0; }
    .user-info{ display:flex; align-items:center; gap:10px; }
    .user-avatar{ width:36px; height:36px; border-radius:50%; border:2px solid #fff; }
    .user-name{ font-size:14px; font-weight:500; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; right:0; background:white; border-top:1px solid #e0e0e0; display:flex; justify-content:space-around; padding: 8px 0; box-shadow:0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; max-width:480px; margin:0 auto; }
    .nav-item{ flex:1; display:flex; flex-direction:column; align-items:center; gap:4px; padding:8px; color:#666; cursor:pointer; border:none; background:none; transition:all 0.3s; }
    .nav-item i{ font-size:22px; }
    .nav-item span{ font-size:11px; }
    .nav-item.active, .nav-item:hover{ color: var(--primary); background: rgba(6, 199, 85, 0.05); }

    .page-content { display:none; padding:20px; animation: fadeIn 0.3s; }
    .page-content.active { display:block; }
    @keyframes fadeIn { from{ opacity:0; transform: translateY(10px); } to{ opacity:1; transform: translateY(0); } }

    .card{ border:none; border-radius:var(--border-radius); box-shadow:0 2px 8px rgba(0,0,0,0.08); margin-bottom:20px; overflow:hidden; background:#fff; }
    .card-header{ background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color:white; font-weight:600; padding:15px 20px; border:none; }
    .card-body{ padding:20px; }

    .stats-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:15px; margin-bottom:20px; }
    .stat-card{ background:white; border-radius:var(--border-radius); padding:20px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s;}
    .stat-card:hover{ transform: translateY(-5px); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
    .stat-icon{ font-size:32px; margin-bottom:10px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; }
    .stat-value{ font-size:28px; font-weight:700; color:var(--dark); margin:5px 0; }
    .stat-label{ font-size:13px; color:#666; }

    .activity-item{ background:white; border-radius:var(--border-radius); padding:15px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; }
    .activity-item:hover{ transform: translateY(-3px); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
    .activity-title{ font-size:16px; font-weight:600; color:var(--dark); margin-bottom:8px; }
    .activity-info{ font-size:14px; color:#666; margin-bottom:10px; }
    .activity-meta{ display:flex; flex-wrap:wrap; gap:10px; font-size:13px; color:#888; }
    .activity-meta span{ display:flex; align-items:center; gap:4px; }
    .status-badge{ display:inline-block; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:500; }
    .status-開放報名,.status-已報名,.status-已完成,.status-已捐款,.status-已核准{ background:#d4edda; color:#155724; }
    .status-已額滿,.status-已取消,.status-已拒絕{ background:#f8d7da; color:#721c24; }
    .status-已結束{ background:#e2e3e5; color:#383d41; }
    .status-審核中,.status-待付款{ background:#fff3cd; color:#856404; }

    .btn-gradient{ background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color:white; border:none; padding:12px 24px; border-radius:25px; font-weight:600; transition:all 0.3s; box-shadow:0 4px 10px rgba(6,199,85,0.3); }
    .btn-gradient:hover{ transform: translateY(-2px); box-shadow:0 6px 15px rgba(6,199,85,0.4); color:white; }
    .btn-outline-primary{ border:2px solid var(--primary); color: var(--primary); }
    .btn-outline-primary:hover{ background: var(--primary); color:white; }

    .empty-state{ text-align:center; padding:40px 20px; color:#999; }
    .empty-state i{ font-size:48px; margin-bottom:15px; opacity:0.5; }
    .loading-overlay{ position:fixed; inset:0; background: rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:9999; }
    .loading-overlay.show{ display:flex; }
    .loading-spinner{ width:50px; height:50px; border:4px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to{ transform: rotate(360deg);} }
    .toast-container{ position: fixed; top:20px; right:20px; z-index:9999; }

    .admin-only{ display:none; }
    .table-responsive{ border-radius: var(--border-radius); overflow:hidden; }
    .table thead{ background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color:white; }
    .table tbody tr:hover{ background: rgba(6,199,85,0.05); }

    @media (max-width:480px){
      .stats-grid{ grid-template-columns:1fr; }
      .activity-meta{ flex-direction:column; gap:5px; }
    }

    /* ====== 登入/註冊入口頁（合併第二段風格） ====== */
    .auth-container {
      background:white; border-radius:20px; padding:40px; max-width:420px; width:100%;
      box-shadow:0 20px 60px rgba(0,0,0,0.3); margin: 40px auto;
    }
    .auth-logo { text-align:center; margin-bottom: 20px; }
    .auth-logo h1{ color: var(--purple-1); font-size: 28px; margin-bottom: 10px; }
    .auth-tabs{ display:flex; margin-bottom:20px; border-bottom: 2px solid #f0f0f0; }
    .auth-tab{ flex:1; padding:12px; text-align:center; cursor:pointer; color:#999; font-weight:500; transition:.2s; }
    .auth-tab.active{ color: var(--purple-1); border-bottom: 3px solid var(--purple-1); margin-bottom: -2px; }
    .auth-pane{ display:none; }
    .auth-pane.active{ display:block; }

    /* ====== 管理後台（合併第三段風格） ====== */
    .admin-root { display:flex; min-height:100vh; background:#f5f7fa; }
    .sidebar { width:250px; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color:white; position:sticky; top:0; height:100vh; overflow-y:auto; transition:.3s; }
    .sidebar.collapsed{ width:60px; }
    .sidebar-header{ padding:20px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:space-between; }
    .sidebar-title{ font-size:18px; font-weight:600; }
    .toggle-btn{ background:none; border:none; color:white; font-size:20px; cursor:pointer; padding:5px; }
    .sidebar-menu{ padding: 20px 0; }
    .menu-item{ display:flex; align-items:center; padding:15px 20px; color: rgba(255,255,255,0.85); cursor:pointer; transition:.2s; }
    .menu-item:hover, .menu-item.active{ background: rgba(255,255,255,0.1); color:#fff; }
    .menu-item .icon{ margin-right: 15px; width: 20px; text-align:center; }
    .main-admin{ flex:1; }
    .top-bar-admin{ background:white; padding: 12px 20px; box-shadow:0 2px 4px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:5; }
    .content-admin{ padding:20px; }
    .admin-section{ display:none; }
    .admin-section.active{ display:block; }
    .badge{ padding: 4px 12px; border-radius: 12px; font-size:12px; }
    .badge-success{ background:#d4edda; color:#155724; }
    .badge-warning{ background:#fff3cd; color:#856404; }
    .badge-danger{ background:#f8d7da; color:#721c24; }
    .badge-info{ background:#d1ecf1; color:#0c5460; }
    .badge-secondary{ background:#e2e3e5; color:#383d41; }

    /* ====== 會員中心（合併第四段風格） ====== */
    .member-center { background:#f5f7fa; min-height:100vh; }
    .member-header{ background: linear-gradient(135deg, var(--purple-1) 0%, var(--purple-2) 100%); color:white; padding:16px; position:sticky; top:0; z-index:2; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    .member-user{ display:flex; align-items:center; gap:12px; }
    .member-avatar{ width:48px; height:48px; border-radius:50%; background:white; color: var(--purple-1); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:20px;}
    .member-content{ padding:16px; max-width: 900px; margin:0 auto; }
    .member-section{ display:none; }
    .member-section.active{ display:block; }

    /* 通用 Modal 容器 */
    #modalContainer .modal .modal-dialog { max-width: 720px; }
  </style>
</head>
<body>

  <div class="root-container">

    <!-- ========== Router 視圖：未登入（登入/註冊入口 + API 設定 + 測試） ========== -->
    <div id="view-auth" class="view">
      <div class="auth-container">
        <div class="auth-logo">
          <h1>🌟 帕金森協會</h1>
          <p>統一登入入口</p>
        </div>

        <div class="mb-3 p-3 rounded" style="background:#fff3cd;border:2px solid #ffc107;">
          <div class="mb-2 fw-bold" style="color:#856404;">⚙️ API 設定（可更新為你自己的 Google Apps Script URL）</div>
          <input type="text" id="global-api-url" class="form-control form-control-sm mb-2" placeholder="貼上 Google Apps Script 部署網址">
          <button class="btn btn-warning w-100 btn-sm" onclick="APP.Config.updateAPIUrl()">更新 API 網址</button>
          <div class="form-text">目前：<span id="current-api-url" class="text-muted"></span></div>
        </div>

        <div class="auth-tabs">
          <div class="auth-tab active" data-pane="pane-login">登入</div>
          <div class="auth-tab" data-pane="pane-register">註冊</div>
        </div>

        <div id="auth-alert" class="alert d-none"></div>
        <div id="auth-loading" class="text-center d-none">
          <div class="spinner-border text-primary"></div>
          <div class="small text-muted mt-2">處理中...</div>
        </div>

        <div id="pane-login" class="auth-pane active">
          <form onsubmit="APP.Auth.handleEmailLogin(event)">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" id="login-email" class="form-control" required placeholder="example@email.com"/>
            </div>
            <div class="mb-3">
              <label class="form-label">密碼</label>
              <input type="password" id="login-password" class="form-control" required placeholder="請輸入密碼"/>
            </div>
            <button type="submit" class="btn btn-primary w-100">登入</button>
          </form>
          <div class="text-center my-3 text-muted">或</div>
          <button class="btn btn-success w-100" onclick="APP.Auth.handleLineLogin()">
            <i class="bi bi-line"></i> 使用 LINE 快速登入
          </button>

          <div class="mt-3 d-flex gap-2">
            <button class="btn btn-secondary flex-fill btn-sm" onclick="APP.Auth.testAPIConnection()">測試 API 連線</button>
            <button class="btn btn-outline-secondary flex-fill btn-sm" onclick="APP.Auth.clearDebug()">清除除錯</button>
          </div>
          <div class="mt-3 small text-muted" id="auth-debug"></div>
        </div>

        <div id="pane-register" class="auth-pane">
          <form onsubmit="APP.Auth.handleRegister(event)">
            <div class="mb-3">
              <label class="form-label">姓名 *</label>
              <input type="text" id="reg-name" class="form-control" required placeholder="請輸入真實姓名"/>
            </div>
            <div class="mb-3">
              <label class="form-label">性別 *</label>
              <select id="reg-gender" class="form-select" required>
                <option value="">請選擇</option>
                <option>男</option>
                <option>女</option>
                <option>其他</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">生日 *</label>
              <input type="date" id="reg-birthday" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">手機 *</label>
              <input type="tel" id="reg-phone" class="form-control" required placeholder="0912-345-678"/>
            </div>
            <div class="mb-3">
              <label class="form-label">Email *</label>
              <input type="email" id="reg-email" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">密碼 *</label>
              <input type="password" id="reg-password" class="form-control" required minlength="8" placeholder="至少 8 個字元"/>
            </div>
            <div class="mb-3">
              <label class="form-label">確認密碼 *</label>
              <input type="password" id="reg-password-confirm" class="form-control" required minlength="8"/>
            </div>
            <button type="submit" class="btn btn-primary w-100">註冊</button>
          </form>
        </div>
      </div>
    </div>

    <!-- ========== Router 視圖：行動端病友會 LIFF App（第一段） + 會員中心（第四段） ========== -->
    <div id="view-member" class="view">
      <div class="row g-3" style="margin: 0;">
        <!-- 左側：行動端 LIFF App -->
        <div class="col-12 col-lg-5 d-flex">
          <div class="app-container w-100">
            <div class="top-bar">
              <h1><i class="bi bi-heart-pulse me-2"></i>帕金森病友會</h1>
              <div class="user-info">
                <img id="appUserAvatar" class="user-avatar" src="https://via.placeholder.com/36" alt="頭像" />
                <span id="appUserName" class="user-name">載入中...</span>
              </div>
            </div>

            <!-- App 頁面內容 -->
            <div id="app-page-home" class="page-content active">
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-calendar-event"></i></div>
                  <div class="stat-value" id="statActivities">0</div>
                  <div class="stat-label">活動總數</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                  <div class="stat-value" id="statRegistrations">0</div>
                  <div class="stat-label">我的報名</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
                  <div class="stat-value" id="statVolunteerHours">0</div>
                  <div class="stat-label">志工時數</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-heart"></i></div>
                  <div class="stat-value" id="statDonations">$0</div>
                  <div class="stat-label">捐款金額</div>
                </div>
              </div>

              <div class="card">
                <div class="card-header"><i class="bi bi-calendar-event me-2"></i>最新活動</div>
                <div class="card-body" id="recentActivities">
                  <div class="empty-state">
                    <i class="bi bi-calendar-x"></i>
                    <p>載入中...</p>
                  </div>
                </div>
              </div>
            </div>

            <div id="app-page-activities" class="page-content">
              <div class="card">
                <div class="card-header"><i class="bi bi-calendar-plus me-2"></i>開放報名</div>
                <div class="card-body" id="activitiesList">
                  <div class="empty-state"><i class="bi bi-calendar-x"></i><p>載入中...</p></div>
                </div>
              </div>
              <div class="card">
                <div class="card-header"><i class="bi bi-list-check me-2"></i>我的報名</div>
                <div class="card-body" id="myRegistrationsList">
                  <div class="empty-state"><i class="bi bi-calendar-x"></i><p>載入中...</p></div>
                </div>
              </div>
            </div>

            <div id="app-page-volunteer" class="page-content">
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
                  <div class="stat-value" id="volTotalHours">0</div>
                  <div class="stat-label">累計時數</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
                  <div class="stat-value" id="volTotalActivities">0</div>
                  <div class="stat-label">服務次數</div>
                </div>
              </div>
              <div class="card">
                <div class="card-header"><i class="bi bi-people me-2"></i>志工需求</div>
                <div class="card-body" id="volunteerNeedsList">
                  <div class="empty-state"><i class="bi bi-people"></i><p>載入中...</p></div>
                </div>
              </div>
              <div class="card">
                <div class="card-header"><i class="bi bi-journal-text me-2"></i>我的記錄</div>
                <div class="card-body" id="myVolunteerRecords">
                  <div class="empty-state"><i class="bi bi-journal-x"></i><p>載入中...</p></div>
                </div>
              </div>
            </div>

            <div id="app-page-finance" class="page-content">
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-heart"></i></div>
                  <div class="stat-value" id="finTotalDonation">$0</div>
                  <div class="stat-label">累計捐款</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-receipt"></i></div>
                  <div class="stat-value" id="finPendingExpenses">0</div>
                  <div class="stat-label">待審核支出</div>
                </div>
              </div>

              <div class="d-grid gap-2 mb-3">
                <button class="btn btn-gradient" onclick="APP.AppView.showDonationModal()">
                  <i class="bi bi-heart-fill me-2"></i>我要捐款
                </button>
                <button class="btn btn-outline-primary" onclick="APP.AppView.showNewExpenseModal()">
                  <i class="bi bi-receipt me-2"></i>支出申請
                </button>
              </div>

              <div class="card">
                <div class="card-header"><i class="bi bi-heart me-2"></i>我的捐款</div>
                <div class="card-body" id="myDonationsList">
                  <div class="empty-state"><i class="bi bi-heart"></i><p>載入中...</p></div>
                </div>
              </div>

              <div class="card">
                <div class="card-header"><i class="bi bi-receipt me-2"></i>我的支出</div>
                <div class="card-body" id="myExpensesList">
                  <div class="empty-state"><i class="bi bi-receipt"></i><p>載入中...</p></div>
                </div>
              </div>
            </div>

            <div id="app-page-profile" class="page-content">
              <div class="card">
                <div class="card-header"><i class="bi bi-person me-2"></i>個人資料</div>
                <div class="card-body">
                  <form id="profileForm">
                    <div class="form-floating mb-3">
                      <input type="text" class="form-control" name="realName" required>
                      <label>真實姓名 *</label>
                    </div>
                    <div class="form-floating mb-3">
                      <select class="form-select" name="memberType" required>
                        <option value="">請選擇</option>
                        <option value="病友">病友</option>
                        <option value="家屬">家屬</option>
                        <option value="志工">志工</option>
                      </select>
                      <label>會員類型 *</label>
                    </div>
                    <div class="form-floating mb-3">
                      <input type="tel" class="form-control" name="phone">
                      <label>聯絡電話</label>
                    </div>
                    <div class="form-floating mb-3">
                      <input type="email" class="form-control" name="email">
                      <label>電子郵件</label>
                    </div>
                    <div class="form-floating mb-3">
                      <input type="date" class="form-control" name="birthday">
                      <label>生日</label>
                    </div>
                    <div class="form-floating mb-3">
                      <input type="date" class="form-control" name="diagnosisDate">
                      <label>確診日期</label>
                    </div>
                    <div class="form-floating mb-3">
                      <textarea class="form-control" name="address" style="height:80px;"></textarea>
                      <label>地址</label>
                    </div>
                    <div class="d-grid">
                      <button type="submit" class="btn btn-gradient">
                        <i class="bi bi-save me-2"></i>儲存變更
                      </button>
                    </div>
                  </form>
                </div>
              </div>

              <div class="card">
                <div class="card-header"><i class="bi bi-file-earmark-text me-2"></i>我的收據</div>
                <div class="card-body" id="myReceiptsList">
                  <div class="empty-state">
                    <i class="bi bi-file-earmark-text"></i>
                    <p>載入中...</p>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card-header"><i class="bi bi-info-circle me-2"></i>會員資訊</div>
                <div class="card-body">
                  <p><strong>會員類型：</strong><span id="appUserMemberType">-</span></p>
                  <p><strong>LINE ID：</strong><span id="appUserLineId">-</span></p>
                  <p class="mb-0"><strong>版本：</strong>v2.1.0（整合版）</p>
                </div>
              </div>
            </div>

            <div id="app-page-admin" class="page-content admin-only">
              <div class="card">
                <div class="card-header"><i class="bi bi-gear me-2"></i>管理功能入口</div>
                <div class="card-body">
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="APP.Router.goAdmin()">進入管理後台</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="bottom-nav">
              <button class="nav-item active" data-app-page="home">
                <i class="bi bi-house-door-fill"></i>
                <span>首頁</span>
              </button>
              <button class="nav-item" data-app-page="activities">
                <i class="bi bi-calendar-event"></i>
                <span>活動</span>
              </button>
              <button class="nav-item" data-app-page="volunteer">
                <i class="bi bi-people"></i>
                <span>志工</span>
              </button>
              <button class="nav-item" data-app-page="finance">
                <i class="bi bi-wallet2"></i>
                <span>財務</span>
              </button>
              <button class="nav-item" data-app-page="profile">
                <i class="bi bi-person"></i>
                <span>我的</span>
              </button>
              <button class="nav-item admin-only" data-app-page="admin">
                <i class="bi bi-gear"></i>
                <span>管理</span>
              </button>
            </div>
          </div>
        </div>

        <!-- 右側：會員中心 -->
        <div class="col-12 col-lg-7 d-flex">
          <div class="member-center w-100">
            <div class="member-header">
              <div class="member-user">
                <div class="member-avatar" id="mc-avatar">A</div>
                <div>
                  <div id="mc-name" style="font-weight:600;">載入中...</div>
                  <div id="mc-no" class="small">會員編號：---</div>
                </div>
              </div>
            </div>

            <div class="member-content">
              <!-- 會員中心首頁 -->
              <div id="mc-home" class="member-section active">
                <div class="row g-2">
                  <div class="col-6 col-md-3">
                    <div class="card text-center p-3">
                      <div class="fw-bold">症狀</div>
                      <button class="btn btn-sm btn-primary mt-2" onclick="APP.Member.show('symptom')">開啟</button>
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="card text-center p-3">
                      <div class="fw-bold">用藥</div>
                      <button class="btn btn-sm btn-primary mt-2" onclick="APP.Member.show('medication')">開啟</button>
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="card text-center p-3">
                      <div class="fw-bold">運動</div>
                      <button class="btn btn-sm btn-primary mt-2" onclick="APP.Member.show('exercise')">開啟</button>
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="card text-center p-3">
                      <div class="fw-bold">情緒</div>
                      <button class="btn btn-sm btn-primary mt-2" onclick="APP.Member.show('mood')">開啟</button>
                    </div>
                  </div>
                </div>

                <div class="card mt-3">
                  <div class="card-header d-flex justify-content-between">
                    <div class="fw-bold">📋 今日提醒</div>
                    <button class="btn btn-sm btn-outline-primary" onclick="APP.Member.show('medication')">去用藥</button>
                  </div>
                  <div class="card-body" id="mc-today-reminders">
                    <div class="text-center text-muted py-4">
                      <div class="spinner-border text-primary"></div>
                      <div class="small mt-2">載入中...</div>
                    </div>
                  </div>
                </div>

                <div class="card mt-3">
                  <div class="card-header d-flex justify-content-between">
                    <div class="fw-bold">📅 近期活動</div>
                    <button class="btn btn-sm btn-outline-primary" onclick="APP.Member.show('events')">查看全部</button>
                  </div>
                  <div class="card-body" id="mc-upcoming-events">
                    <div class="text-center text-muted py-4">
                      <div class="spinner-border text-primary"></div>
                      <div class="small mt-2">載入中...</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 症狀 -->
              <div id="mc-symptom" class="member-section">
                <div class="card">
                  <div class="card-header"><div class="fw-bold">新增症狀記錄</div></div>
                  <div class="card-body">
                    <form onsubmit="APP.Member.addSymptom(event)">
                      <div class="mb-3">
                        <label class="form-label">顫抖程度 (0-10)</label>
                        <input type="range" id="mc-tremor" min="0" max="10" value="5" class="form-range"/>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">僵硬程度 (0-10)</label>
                        <input type="range" id="mc-rigidity" min="0" max="10" value="5" class="form-range"/>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">動作遲緩 (0-10)</label>
                        <input type="range" id="mc-brady" min="0" max="10" value="5" class="form-range"/>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">平衡問題 (0-10)</label>
                        <input type="range" id="mc-balance" min="0" max="10" value="5" class="form-range"/>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">備註</label>
                        <textarea id="mc-symptom-notes" class="form-control" rows="3"></textarea>
                      </div>
                      <button class="btn btn-primary w-100">儲存記錄</button>
                    </form>
                  </div>
                </div>
                <div class="card mt-3">
                  <div class="card-header"><div class="fw-bold">歷史記錄</div></div>
                  <div class="card-body" id="mc-symptom-history">
                    <div class="text-center text-muted py-4">尚無記錄</div>
                  </div>
                </div>
              </div>

              <!-- 用藥 -->
              <div id="mc-medication" class="member-section">
                <div class="card">
                  <div class="card-header d-flex justify-content-between">
                    <div class="fw-bold">我的用藥</div>
                    <button class="btn btn-sm btn-primary" onclick="APP.Member.openAddMedication()">+ 新增</button>
                  </div>
                  <div class="card-body" id="mc-medication-list">
                    <div class="text-center text-muted py-4">
                      <div class="spinner-border text-primary"></div>
                      <div class="small mt-2">載入中...</div>
                    </div>
                  </div>
                </div>
                <div class="card mt-3">
                  <div class="card-header"><div class="fw-bold">今日用藥記錄</div></div>
                  <div class="card-body" id="mc-medication-today">
                    <div class="text-center text-muted py-4">尚無資料或功能開發中</div>
                  </div>
                </div>
              </div>

              <!-- 運動 -->
              <div id="mc-exercise" class="member-section">
                <div class="card">
                  <div class="card-header"><div class="fw-bold">新增運動記錄</div></div>
                  <div class="card-body">
                    <form onsubmit="APP.Member.addExercise(event)">
                      <div class="mb-3">
                        <label class="form-label">運動類型 *</label>
                        <select id="mc-ex-type" class="form-select" required>
                          <option value="">請選擇</option>
                          <option>散步</option><option>太極</option><option>瑜珈</option><option>游泳</option><option>騎腳踏車</option><option>復健運動</option><option>其他</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">運動時間（分鐘）*</label>
                        <input type="number" id="mc-ex-duration" class="form-control" required min="1"/>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">運動強度 *</label>
                        <select id="mc-ex-intensity" class="form-select" required>
                          <option value="">請選擇</option>
                          <option>輕度</option><option>中度</option><option>高強度</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">身體狀況 *</label>
                        <select id="mc-ex-condition" class="form-select" required>
                          <option value="">請選擇</option>
                          <option>良好</option><option>普通</option><option>疲累</option><option>不適</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">備註</label>
                        <textarea id="mc-ex-notes" class="form-control" rows="3"></textarea>
                      </div>
                      <button class="btn btn-primary w-100">儲存記錄</button>
                    </form>
                  </div>
                </div>
              </div>

              <!-- 睡眠 -->
              <div id="mc-sleep" class="member-section">
                <div class="card">
                  <div class="card-header"><div class="fw-bold">新增睡眠記錄</div></div>
                  <div class="card-body">
                    <form onsubmit="APP.Member.addSleep(event)">
                      <div class="mb-3">
                        <label class="form-label">就寢時間 *</label>
                        <input type="time" id="mc-sleep-bed" class="form-control" required />
                      </div>
                      <div class="mb-3">
                        <label class="form-label">起床時間 *</label>
                        <input type="time" id="mc-sleep-wake" class="form-control" required />
                      </div>
                      <div class="mb-3">
                        <label class="form-label">睡眠品質 *</label>
                        <select id="mc-sleep-quality" class="form-select" required>
                          <option value="">請選擇</option>
                          <option>很好</option><option>好</option><option>普通</option><option>差</option><option>很差</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">夜間醒來次數</label>
                        <input type="number" id="mc-sleep-wakecount" class="form-control" min="0" value="0" />
                      </div>
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="mc-sleep-dream"/>
                        <label class="form-check-label" for="mc-sleep-dream">有做夢</label>
                      </div>
                      <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="mc-sleep-nightmare"/>
                        <label class="form-check-label" for="mc-sleep-nightmare">有惡夢</label>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">備註</label>
                        <textarea id="mc-sleep-notes" class="form-control" rows="3"></textarea>
                      </div>
                      <button class="btn btn-primary w-100">儲存記錄</button>
                    </form>
                  </div>
                </div>
              </div>

              <!-- 情緒 -->
              <div id="mc-mood" class="member-section">
                <div class="card">
                  <div class="card-header"><div class="fw-bold">今天的心情</div></div>
                  <div class="card-body">
                    <form onsubmit="APP.Member.addMood(event)">
                      <div class="mb-3">
                        <div class="d-flex justify-content-between">
                          <button type="button" class="btn btn-outline-secondary" onclick="APP.Member.selectMood(1)">😢</button>
                          <button type="button" class="btn btn-outline-secondary" onclick="APP.Member.selectMood(3)">😕</button>
                          <button type="button" class="btn btn-outline-secondary" onclick="APP.Member.selectMood(5)">😐</button>
                          <button type="button" class="btn btn-outline-secondary" onclick="APP.Member.selectMood(7)">🙂</button>
                          <button type="button" class="btn btn-outline-secondary" onclick="APP.Member.selectMood(10)">😄</button>
                        </div>
                        <input type="hidden" id="mc-mood-score" value="5"/>
                      </div>
                      <div class="mb-3">
                        <div class="mb-2 small text-muted">心情標籤（點選切換）</div>
                        <div id="mc-mood-tags" class="d-flex flex-wrap gap-2">
                          <span class="badge bg-secondary" data-tag="開心" onclick="APP.Member.toggleTag(this)">開心</span>
                          <span class="badge bg-secondary" data-tag="焦慮" onclick="APP.Member.toggleTag(this)">焦慮</span>
                          <span class="badge bg-secondary" data-tag="疲累" onclick="APP.Member.toggleTag(this)">疲累</span>
                          <span class="badge bg-secondary" data-tag="平靜" onclick="APP.Member.toggleTag(this)">平靜</span>
                          <span class="badge bg-secondary" data-tag="沮喪" onclick="APP.Member.toggleTag(this)">沮喪</span>
                          <span class="badge bg-secondary" data-tag="充滿活力" onclick="APP.Member.toggleTag(this)">充滿活力</span>
                        </div>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">心情日記</label>
                        <textarea id="mc-mood-content" class="form-control" rows="4" placeholder="寫下今天的心情..."></textarea>
                      </div>
                      <button class="btn btn-primary w-100">儲存日記</button>
                    </form>
                  </div>
                </div>
              </div>

              <!-- 活動 -->
              <div id="mc-events" class="member-section">
                <div class="card">
                  <div class="card-header"><div class="fw-bold">可報名活動</div></div>
                  <div class="card-body" id="mc-events-list">
                    <div class="text-center text-muted py-4">
                      <div class="spinner-border text-primary"></div>
                      <div class="small mt-2">載入中...</div>
                    </div>
                  </div>
                </div>
                <div class="card mt-3">
                  <div class="card-header"><div class="fw-bold">我的報名</div></div>
                  <div class="card-body" id="mc-my-events">
                    <div class="text-center text-muted py-4">
                      <div class="spinner-border text-primary"></div>
                      <div class="small mt-2">載入中...</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 個人 -->
              <div id="mc-profile" class="member-section">
                <div class="card">
                  <div class="card-header d-flex justify-content-between">
                    <div class="fw-bold">個人資料</div>
                    <button class="btn btn-sm btn-outline-primary" onclick="APP.Member.loadProfile()">重新載入</button>
                  </div>
                  <div class="card-body" id="mc-profile-info">
                    <div class="text-center text-muted py-4">
                      <div class="spinner-border text-primary"></div>
                      <div class="small mt-2">載入中...</div>
                    </div>
                  </div>
                </div>
                <div class="card mt-3">
                  <div class="card-header"><div class="fw-bold">捐款記錄</div></div>
                  <div class="card-body" id="mc-donation-history">
                    <div class="text-center text-muted py-4">尚無捐款記錄</div>
                  </div>
                </div>

                <div class="d-grid gap-2 mt-2">
                  <button class="btn btn-danger" onclick="APP.Auth.logout()">登出</button>
                  <button id="btn-enter-admin" class="btn btn-outline-secondary admin-only" onclick="APP.Router.goAdmin()">進入管理後台</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ========== Router 視圖：管理後台（第三段） ========== -->
    <div id="view-admin" class="view">
      <div class="admin-root">
        <div class="sidebar" id="admin-sidebar">
          <div class="sidebar-header">
            <div class="sidebar-title">🌟 管理後台</div>
            <button class="toggle-btn" onclick="APP.Admin.toggleSidebar()">☰</button>
          </div>
          <nav class="sidebar-menu" id="admin-menu">
            <div class="menu-item active" data-admin-section="dashboard"><span class="icon">📊</span><span>總覽</span></div>
            <div class="menu-item" data-admin-section="members"><span class="icon">👥</span><span>會員管理</span></div>
            <div class="menu-item" data-admin-section="events"><span class="icon">🎯</span><span>活動管理</span></div>
            <div class="menu-item" data-admin-section="health"><span class="icon">📋</span><span>健康記錄</span></div>
            <div class="menu-item" data-admin-section="donations"><span class="icon">💰</span><span>捐款管理</span></div>
            <div class="menu-item" data-admin-section="reports"><span class="icon">📈</span><span>統計報表</span></div>
            <div class="menu-item" data-admin-section="settings"><span class="icon">⚙️</span><span>系統設定</span></div>
          </nav>
        </div>
        <div class="main-admin">
          <div class="top-bar-admin">
            <h5 class="m-0" id="admin-page-title">系統總覽</h5>
            <div class="d-flex align-items-center gap-2">
              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:36px;height:36px;" id="admin-avatar">A</div>
              <span id="admin-name">管理員</span>
              <button class="btn btn-sm btn-danger ms-2" onclick="APP.Admin.logout()">登出</button>
            </div>
          </div>
          <div class="content-admin">
            <div id="admin-alert" class="alert d-none"></div>
            <div id="admin-loading" class="text-center d-none"><div class="spinner-border text-primary"></div><div class="small text-muted mt-2">載入中...</div></div>

            <!-- 總覽 -->
            <div class="admin-section active" id="admin-dashboard">
              <div class="row g-3">
                <div class="col-12 col-sm-6 col-lg-3">
                  <div class="card p-3 text-center">
                    <div class="fs-4">👥</div>
                    <div class="fs-3 fw-bold" id="adm-total-members">-</div>
                    <div class="text-muted small">總會員數</div>
                  </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                  <div class="card p-3 text-center">
                    <div class="fs-4">✅</div>
                    <div class="fs-3 fw-bold" id="adm-active-members">-</div>
                    <div class="text-muted small">活躍會員</div>
                  </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                  <div class="card p-3 text-center">
                    <div class="fs-4">🎯</div>
                    <div class="fs-3 fw-bold" id="adm-total-events">-</div>
                    <div class="text-muted small">總活動數</div>
                  </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                  <div class="card p-3 text-center">
                    <div class="fs-4">💰</div>
                    <div class="fs-6 fw-bold" id="adm-total-donations">-</div>
                    <div class="text-muted small">總捐款金額</div>
                  </div>
                </div>
              </div>
              <div class="card mt-3">
                <div class="card-header fw-bold">🔔 最新動態</div>
                <div class="card-body" id="adm-recent-activities">
                  <div class="text-center text-muted py-4">
                    <div class="spinner-border text-primary"></div>
                    <div class="small mt-2">載入最新動態...</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 會員管理 -->
            <div class="admin-section" id="admin-members">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div class="fw-bold">👥 會員管理</div>
                  <button class="btn btn-primary btn-sm" onclick="APP.Admin.showAddMember()">新增會員</button>
                </div>
                <div class="card-body">
                  <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-6">
                      <label class="form-label">搜尋</label>
                      <input class="form-control" id="adm-member-search" placeholder="姓名 / Email / 電話"/>
                    </div>
                    <div class="col-6 col-md-3">
                      <label class="form-label">狀態</label>
                      <select class="form-select" id="adm-member-status">
                        <option value="">所有狀態</option>
                        <option>已審核</option><option>待審核</option><option>已停用</option>
                      </select>
                    </div>
                    <div class="col-6 col-md-3 d-flex gap-2">
                      <button class="btn btn-primary w-100" onclick="APP.Admin.loadMembers(1)">搜尋</button>
                      <button class="btn btn-warning w-100" onclick="APP.Admin.exportMembers()">匯出</button>
                    </div>
                  </div>
                  <div class="table-responsive mt-3">
                    <table class="table table-hover table-sm">
                      <thead><tr><th>會員編號</th><th>姓名</th><th>Email</th><th>電話</th><th>註冊日期</th><th>狀態</th><th>操作</th></tr></thead>
                      <tbody id="adm-members-body"><tr><td colspan="7" class="text-center py-4 text-muted">載入中...</td></tr></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-center gap-2 mt-3" id="adm-members-pagination"></div>
                </div>
              </div>
            </div>

            <!-- 活動管理 -->
            <div class="admin-section" id="admin-events">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div class="fw-bold">🎯 活動管理</div>
                  <button class="btn btn-primary btn-sm" onclick="APP.Admin.showAddEvent()">新增活動</button>
                </div>
                <div class="card-body">
                  <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-6">
                      <label class="form-label">搜尋</label>
                      <input class="form-control" id="adm-event-search" placeholder="活動名稱"/>
                    </div>
                    <div class="col-6 col-md-3">
                      <label class="form-label">狀態</label>
                      <select class="form-select" id="adm-event-status">
                        <option value="">所有狀態</option>
                        <option>報名中</option><option>已額滿</option><option>已結束</option><option>已取消</option>
                      </select>
                    </div>
                    <div class="col-6 col-md-3">
                      <button class="btn btn-primary w-100" onclick="APP.Admin.loadEvents(1)">搜尋</button>
                    </div>
                  </div>
                  <div class="table-responsive mt-3">
                    <table class="table table-hover table-sm">
                      <thead><tr><th>活動名稱</th><th>日期時間</th><th>地點</th><th>報名人數</th><th>狀態</th><th>操作</th></tr></thead>
                      <tbody id="adm-events-body"><tr><td colspan="6" class="text-center py-4 text-muted">載入中...</td></tr></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-center gap-2 mt-3" id="adm-events-pagination"></div>
                </div>
              </div>
            </div>

            <!-- 健康記錄 -->
            <div class="admin-section" id="admin-health">
              <div class="card">
                <div class="card-header"><div class="fw-bold">📋 健康記錄管理</div></div>
                <div class="card-body">
                  <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-4">
                      <label class="form-label">會員姓名</label>
                      <input class="form-control" id="adm-health-search" placeholder="搜尋姓名"/>
                    </div>
                    <div class="col-6 col-md-3">
                      <label class="form-label">起</label>
                      <input type="date" class="form-control" id="adm-health-from"/>
                    </div>
                    <div class="col-6 col-md-3">
                      <label class="form-label">迄</label>
                      <input type="date" class="form-control" id="adm-health-to"/>
                    </div>
                    <div class="col-12 col-md-2 d-flex gap-2">
                      <button class="btn btn-primary w-100" onclick="APP.Admin.loadHealth(1)">搜尋</button>
                      <button class="btn btn-warning w-100" onclick="APP.Admin.exportHealth()">匯出</button>
                    </div>
                  </div>
                  <div class="table-responsive mt-3">
                    <table class="table table-hover table-sm">
                      <thead><tr><th>會員姓名</th><th>記錄日期</th><th>震顫</th><th>僵硬</th><th>動作遲緩</th><th>平衡</th><th>備註</th><th>操作</th></tr></thead>
                      <tbody id="adm-health-body"><tr><td colspan="8" class="text-center py-4 text-muted">載入中...</td></tr></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-center gap-2 mt-3" id="adm-health-pagination"></div>
                </div>
              </div>
            </div>

            <!-- 捐款管理 -->
            <div class="admin-section" id="admin-donations">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div class="fw-bold">💰 捐款管理</div>
                  <button class="btn btn-primary btn-sm" onclick="APP.Admin.showAddDonation()">新增捐款記錄</button>
                </div>
                <div class="card-body">
                  <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-4">
                      <label class="form-label">捐款人</label>
                      <input class="form-control" id="adm-donation-search" placeholder="捐款人姓名"/>
                    </div>
                    <div class="col-6 col-md-3">
                      <label class="form-label">類型</label>
                      <select class="form-select" id="adm-donation-type">
                        <option value="">所有類型</option>
                        <option>一般捐款</option><option>定期捐款</option><option>指定用途</option>
                      </select>
                    </div>
                    <div class="col-6 col-md-2">
                      <label class="form-label">起</label>
                      <input type="date" class="form-control" id="adm-donation-from"/>
                    </div>
                    <div class="col-6 col-md-2">
                      <label class="form-label">迄</label>
                      <input type="date" class="form-control" id="adm-donation-to"/>
                    </div>
                    <div class="col-12 col-md-1">
                      <button class="btn btn-primary w-100" onclick="APP.Admin.loadDonations(1)">搜尋</button>
                    </div>
                  </div>

                  <div class="table-responsive mt-3">
                    <table class="table table-hover table-sm">
                      <thead><tr><th>捐款人</th><th>金額</th><th>類型</th><th>日期</th><th>付款方式</th><th>狀態</th><th>操作</th></tr></thead>
                      <tbody id="adm-donations-body"><tr><td colspan="7" class="text-center py-4 text-muted">載入中...</td></tr></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-center gap-2 mt-3" id="adm-donations-pagination"></div>
                </div>
              </div>
            </div>

            <!-- 統計報表 -->
            <div class="admin-section" id="admin-reports">
              <div class="card">
                <div class="card-header d-flex justify-content-between">
                  <div class="fw-bold">📈 統計報表</div>
                  <button class="btn btn-warning btn-sm" onclick="APP.Admin.exportAllReports()">匯出全部報表</button>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-6 col-md-3">
                      <div class="card p-3 text-center">
                        <div class="fs-4">📊</div>
                        <div class="fs-3 fw-bold" id="adm-report-new-members">-</div>
                        <div class="text-muted small">本月新增會員</div>
                      </div>
                    </div>
                    <div class="col-6 col-md-3">
                      <div class="card p-3 text-center">
                        <div class="fs-4">🎯</div>
                        <div class="fs-3 fw-bold" id="adm-report-events">-</div>
                        <div class="text-muted small">本月活動數</div>
                      </div>
                    </div>
                    <div class="col-6 col-md-3">
                      <div class="card p-3 text-center">
                        <div class="fs-4">💰</div>
                        <div class="fs-6 fw-bold" id="adm-report-donations">-</div>
                        <div class="text-muted small">本月捐款總額</div>
                      </div>
                    </div>
                    <div class="col-6 col-md-3">
                      <div class="card p-3 text-center">
                        <div class="fs-4">📝</div>
                        <div class="fs-3 fw-bold" id="adm-report-health">-</div>
                        <div class="text-muted small">本月健康記錄</div>
                      </div>
                    </div>
                  </div>
                  <div class="card mt-3">
                    <div class="card-header fw-bold">年度趨勢（示意）</div>
                    <div class="card-body text-center text-muted">圖表庫未引入，日後可整合</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 系統設定 -->
            <div class="admin-section" id="admin-settings">
              <div class="card">
                <div class="card-header"><div class="fw-bold">⚙️ 系統設定</div></div>
                <div class="card-body">
                  <div class="row g-2">
                    <div class="col-12 col-md-6">
                      <label class="form-label">API 網址</label>
                      <input id="adm-api-url" class="form-control" placeholder="https://..."/>
                    </div>
                    <div class="col-6 col-md-3">
                      <label class="form-label">每頁筆數</label>
                      <select id="adm-page-size" class="form-select">
                        <option>10</option><option selected>20</option><option>50</option><option>100</option>
                      </select>
                    </div>
                    <div class="col-6 col-md-3">
                      <label class="form-label">自動備份(小時)</label>
                      <input id="adm-backup-interval" type="number" class="form-control" value="24" min="1" max="168"/>
                    </div>
                    <div class="col-12">
                      <label class="form-label">系統公告</label>
                      <textarea id="adm-announcement" class="form-control" rows="3"></textarea>
                    </div>
                  </div>
                  <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-primary" onclick="APP.Admin.saveSettings()">儲存設定</button>
                    <button class="btn btn-warning" onclick="APP.Admin.exportData()">匯出資料</button>
                    <button class="btn btn-success" onclick="APP.Admin.backupData()">立即備份</button>
                    <button class="btn btn-danger" onclick="APP.Admin.clearCache()">清除快取</button>
                  </div>

                  <div class="card mt-3">
                    <div class="card-header fw-bold">🔐 管理員帳號</div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-hover table-sm">
                          <thead><tr><th>管理員名稱</th><th>Email</th><th>權限</th><th>最後登入</th><th>狀態</th><th>操作</th></tr></thead>
                          <tbody id="adm-admins-body">
                            <tr>
                              <td>系統管理員</td>
                              <td>admin@parkinson.org.tw</td>
                              <td><span class="badge badge-danger">超級管理員</span></td>
                              <td>2024-01-15 14:30</td>
                              <td><span class="badge badge-success">已啟用</span></td>
                              <td><button class="btn btn-sm btn-warning" onclick="alert('編輯功能可擴充')">編輯</button></td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      <button class="btn btn-primary btn-sm mt-2" onclick="APP.Admin.showAddAdmin()">新增管理員</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Toast 容器/Modal 容器/Loading -->
  <div id="toastContainer" class="toast-container"></div>
  <div id="modalContainer"></div>
  <div id="globalLoading" class="loading-overlay"><div class="loading-spinner"></div></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // ========== 全域 App 命名空間 ==========
  const APP = {
    State: {
      // 多組 LIFF ID/ API URL 可配置
      LIFF_IDS: {
        app: '1656516134-VaGgmaPm',        // 第一段 LIFF
        auth: '1656516134-X9oq92g9',       // 第二段 LIFF（登入入口）
        member: '1656516134-k8rMQwnQ'      // 第四段 LIFF（會員中心）
      },
      API: {
        primary: localStorage.getItem('API_URL') || 'https://script.google.com/macros/s/AKfycbxvAmIgI8H0qAectv4RfEXbiIRl72WQD7r2yPDuC2qwhNd5icwPeziYnFGmiEfqZBrrbw/exec', // 第一段(POST JSON)
        alt: localStorage.getItem('admin_API_URL') || 'https://script.google.com/macros/s/AKfycbxvAmIgI8H0qAectv4RfEXbiIRl72WQD7r2yPDuC2qwhNd5icwPeziYnFGmiEfqZBrrbw/exec' // 其他頁(多為GET)
      },
      API_KEY: 'AAbb8520258185202581',
      userProfile: null,     // LIFF profile
      memberInfo: null,      // 後端會員資料（登入成功後）
      isAdmin: false,
      routerView: 'auth',    // auth | member | admin
      appUser: { lineId: '', name: '', picture: '' },
      pageSize: 20
    },

    // ========== 共用工具 ==========
    Util: {
      showLoading(show) {
        document.getElementById('globalLoading').classList.toggle('show', !!show);
      },
      toast(message, type='info') {
        const container = document.getElementById('toastContainer');
        const colors = { success: '#28a745', error: '#dc3545', warning: '#ffc107', info: '#17a2b8' };
        const icons = { success: 'check-circle-fill', error: 'x-circle-fill', warning: 'exclamation-triangle-fill', info: 'info-circle-fill' };
        const toast = document.createElement('div');
        toast.className = 'toast show';
        toast.style.cssText = `min-width:250px;margin-bottom:10px;background:white;border-left:4px solid ${colors[type]};box-shadow:0 4px 12px rgba(0,0,0,0.15);`;
        toast.innerHTML = `
          <div class="toast-body d-flex align-items-center">
            <i class="bi bi-${icons[type]} me-2" style="color:${colors[type]};font-size:18px;"></i>
            <div class="flex-grow-1" style="font-size:14px;">${message}</div>
            <button type="button" class="btn-close ms-2" aria-label="Close"></button>
          </div>`;
        toast.querySelector('.btn-close').onclick = () => toast.remove();
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      },
      modal(html, onSubmit) {
        const container = document.getElementById('modalContainer');
        container.innerHTML = html;
        const modalEl = container.querySelector('.modal');
        const formEl = container.querySelector('form');
        const bsModal = new bootstrap.Modal(modalEl);
        if (formEl && typeof onSubmit === 'function') {
          formEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = formEl.querySelector('button[type="submit"]');
            APP.Util.setBtnLoading(btn, true);
            try {
              const fd = new FormData(formEl);
              await onSubmit(fd);
              bsModal.hide();
            } catch (err) {
              APP.Util.toast(err.message || '操作失敗', 'error');
            } finally {
              APP.Util.setBtnLoading(btn, false);
            }
          });
        }
        modalEl.addEventListener('hidden.bs.modal', () => container.innerHTML = '', { once: true });
        bsModal.show();
      },
      setBtnLoading(button, loading) {
        if (!button) return;
        if (loading) {
          button.disabled = true;
          button.dataset.originalText = button.innerHTML;
          button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>處理中...';
        } else {
          button.disabled = false;
          if (button.dataset.originalText) button.innerHTML = button.dataset.originalText;
        }
      },
      formatDate(dateInput) {
        if (!dateInput) return '-';
        try {
          let d;
          if (dateInput instanceof Date) d = dateInput;
          else if (typeof dateInput === 'number') d = new Date(dateInput);
          else if (typeof dateInput === 'string') {
            const p = Date.parse(dateInput); d = isNaN(p) ? new Date(dateInput) : new Date(p);
          } else return '-';
          if (isNaN(d.getTime())) return '-';
          return d.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
        } catch { return '-'; }
      },
      formatDateInput(dateString) {
        if (!dateString) return '';
        try {
          const d = (dateString instanceof Date) ? dateString : new Date(dateString);
          if (isNaN(d.getTime())) return '';
          return d.toISOString().split('T')[0];
        } catch { return ''; }
      },
      currency(n) { return new Intl.NumberFormat('zh-TW').format(Number(n || 0)); },
      getStatusClass(status) {
        const map = {
          '已審核': 'success', '待審核': 'warning', '已停用': 'danger', '報名中': 'info',
          '已額滿': 'warning', '已結束': 'secondary', '已取消': 'danger', '已完成': 'success',
          '處理中': 'warning', '已啟用': 'success'
        };
        return map[status] || 'secondary';
      }
    },

    // ========== 配置 ==========
    Config: {
      updateAPIUrl() {
        const v = document.getElementById('global-api-url').value.trim();
        if (!v) { APP.Util.toast('請輸入有效 URL', 'error'); return; }
        APP.State.API.primary = v;
        APP.State.API.alt = v;
        localStorage.setItem('API_URL', v);
        localStorage.setItem('admin_API_URL', v);
        document.getElementById('current-api-url').textContent = v;
        APP.Util.toast('API 網址已更新', 'success');
      }
    },

    // ========== 路由 ==========
    Router: {
      go(view) {
        APP.State.routerView = view;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + view).classList.add('active');
        if (view === 'member') {
          APP.AppView.initApp();     // LIFF App 初始化資料
          APP.Member.initMember();   // 會員中心初始化
        } else if (view === 'admin') {
          APP.Admin.initAdmin();
        }
      },
      goAdmin() {
        if (!APP.State.isAdmin) { APP.Util.toast('您沒有管理員權限', 'error'); return; }
        APP.Router.go('admin');
      }
    },

    // ========== LIFF ==========
    LIFF: {
      inited: false,
      async initAny() {
        if (APP.LIFF.inited) return;
        try {
          // 任一 LIFF ID 先初始化
          const anyId = APP.State.LIFF_IDS.app || APP.State.LIFF_IDS.auth || APP.State.LIFF_IDS.member;
          if (anyId) {
            await liff.init({ liffId: anyId });
            APP.LIFF.inited = true;
          }
        } catch (e) { /* ignore */ }
      },
      async ensureLogged() {
        try {
          await APP.LIFF.initAny();
          if (!liff.isLoggedIn()) liff.login();
        } catch (e) { /* ignore */ }
      },
      async profile() {
        try {
          await APP.LIFF.initAny();
          if (!liff.isLoggedIn()) return null;
          return await liff.getProfile();
        } catch (e) { return null; }
      }
    },

    // ========== API ==========
    API: {
      // 第一段：POST JSON 統一（行動端 App）
      async post(action, data = {}) {
        const payload = {
          apiKey: APP.State.API_KEY,
          action,
          lineId: APP.State.userProfile?.userId || APP.State.appUser?.lineId || '',
          ...data
        };
        const res = await fetch(APP.State.API.primary, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(payload)
        });
        const result = await res.json().catch(() => ({}));
        if (!result.success) throw new Error(result.message || '操作失敗');
        return result;
      },
      // 第二/三/四段：GET URLSearchParams（後台/會員中心/登入）
      async get(params) {
        const url = new URL(APP.State.API.alt);
        Object.keys(params).forEach(k => {
          const v = params[k];
          url.searchParams.append(k, typeof v === 'object' ? JSON.stringify(v) : v);
        });
        const res = await fetch(url.toString(), { method: 'GET', redirect: 'follow', mode: 'cors' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        return JSON.parse(text);
      },
      async postJson(data) {
        const res = await fetch(APP.State.API.alt, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        return await res.json();
      }
    },

    // ========== 未登入入口（登入/註冊） ==========
    Auth: {
      debug(message) {
        const el = document.getElementById('auth-debug');
        const ts = new Date().toLocaleTimeString();
        el.innerHTML += '[' + ts + '] ' + message + '<br/>';
        el.scrollTop = 999999;
      },
      setAlert(msg, type = 'info') {
        const el = document.getElementById('auth-alert');
        el.className = 'alert alert-' + (type === 'error' ? 'danger' : type);
        el.textContent = msg;
        el.classList.remove('d-none');
        setTimeout(() => el.classList.add('d-none'), 5000);
      },
      setLoading(on) {
        document.getElementById('auth-loading').classList.toggle('d-none', !on);
      },
      async init() {
        // Tab 切換
        document.querySelectorAll('.auth-tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            document.querySelectorAll('.auth-pane').forEach(p => p.classList.remove('active'));
            document.getElementById(tab.dataset.pane).classList.add('active');
          });
        });
        document.getElementById('current-api-url').textContent = APP.State.API.primary;

        // 如果已登入（localStorage），導向適當頁
        const stored = localStorage.getItem('memberInfo');
        if (stored) {
          APP.State.memberInfo = JSON.parse(stored);
          APP.State.isAdmin = !!APP.State.memberInfo?.isAdmin;
          APP.Router.go('member');
          return;
        }

        // 初始化 LIFF（登入時可用）
        try {
          await APP.LIFF.initAny();
          if (liff.isLoggedIn()) {
            const profile = await liff.getProfile();
            APP.Auth.debug('已登入 LINE: ' + profile.displayName);
          }
        } catch (err) {
          APP.Auth.debug('LIFF 初始化失敗: ' + err.message);
        }
      },
      async testAPIConnection() {
        APP.Auth.setLoading(true);
        try {
          APP.Auth.debug('開始測試 API...');
          const result = await APP.API.get({ action: 'test' });
          APP.Auth.setLoading(false);
          if (result?.success) {
            APP.Auth.setAlert('API 連線成功！', 'success');
            APP.Auth.debug('測試成功: ' + JSON.stringify(result));
          } else {
            APP.Auth.setAlert('API 回應異常', 'warning');
          }
        } catch (e) {
          APP.Auth.setLoading(false);
          APP.Auth.setAlert('API 連線失敗：' + e.message, 'error');
        }
      },
      clearDebug() {
        document.getElementById('auth-debug').innerHTML = '';
        APP.Auth.debug('已清除除錯記錄');
      },
      async handleEmailLogin(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        APP.Auth.setLoading(true);
        try {
          const result = await APP.API.get({ action: 'login', email, password });
          APP.Auth.setLoading(false);
          if (result?.success) {
            APP.State.memberInfo = result.data;
            APP.State.isAdmin = !!result.data?.isAdmin;
            localStorage.setItem('memberInfo', JSON.stringify(result.data));
            APP.Auth.setAlert('登入成功！', 'success');
            setTimeout(() => APP.Router.go('member'), 800);
          } else {
            APP.Auth.setAlert(result?.message || '登入失敗', 'error');
          }
        } catch (e2) {
          APP.Auth.setLoading(false);
          APP.Auth.setAlert('系統錯誤：' + e2.message, 'error');
        }
      },
      async handleLineLogin() {
        APP.Auth.debug('開始 LINE 登入');
        try {
          await APP.LIFF.ensureLogged();
          const profile = await liff.getProfile();
          APP.Auth.debug('LINE 使用者：' + profile.displayName);
          APP.Auth.setLoading(true);
          const result = await APP.API.get({
            action: 'lineLogin',
            lineUserId: profile.userId,
            displayName: profile.displayName,
            pictureUrl: profile.pictureUrl || ''
          });
          APP.Auth.setLoading(false);
          if (result?.success) {
            APP.State.memberInfo = result.data;
            APP.State.isAdmin = !!result.data?.isAdmin;
            localStorage.setItem('memberInfo', JSON.stringify(result.data));
            APP.Auth.setAlert('登入成功！', 'success');
            setTimeout(() => APP.Router.go('member'), 800);
          } else {
            APP.Auth.setAlert(result?.message || 'LINE 登入失敗', 'error');
          }
        } catch (e) {
          APP.Auth.setLoading(false);
          APP.Auth.setAlert('LINE 登入失敗：' + e.message, 'error');
        }
      },
      async handleRegister(e) {
        e.preventDefault();
        const pwd = document.getElementById('reg-password').value;
        const pwd2 = document.getElementById('reg-password-confirm').value;
        if (pwd !== pwd2) { APP.Auth.setAlert('兩次密碼不一致', 'error'); return; }
        APP.Auth.setLoading(true);
        try {
          let lineUserId = '';
          try {
            await APP.LIFF.initAny();
            if (liff.isLoggedIn()) {
              const p = await liff.getProfile();
              lineUserId = p.userId;
            }
          } catch {}
          const result = await APP.API.get({
            action: 'register',
            name: document.getElementById('reg-name').value,
            gender: document.getElementById('reg-gender').value,
            birthday: document.getElementById('reg-birthday').value,
            phone: document.getElementById('reg-phone').value,
            email: document.getElementById('reg-email').value,
            password: pwd,
            lineUserId
          });
          APP.Auth.setLoading(false);
          if (result?.success) {
            APP.Auth.setAlert('註冊成功！請等待管理員審核', 'success');
            document.querySelector('.auth-tab[data-pane="pane-login"]').click();
          } else {
            APP.Auth.setAlert(result?.message || '註冊失敗', 'error');
          }
        } catch (e2) {
          APP.Auth.setLoading(false);
          APP.Auth.setAlert('系統錯誤：' + e2.message, 'error');
        }
      },
      logout() {
        // 通用登出（會員中心也用）
        localStorage.removeItem('memberInfo');
        try { if (liff.isLoggedIn()) liff.logout(); } catch (e) {}
        APP.State.memberInfo = null;
        APP.State.isAdmin = false;
        APP.Router.go('auth');
      }
    },

    // ========== 行動端 LIFF App（第一段） ==========
    AppView: {
      async initApp() {
        // 初始化 LIFF Profile 顯示
        try {
          const prof = await APP.LIFF.profile();
          APP.State.userProfile = prof;
          document.getElementById('appUserAvatar').src = prof?.pictureUrl || 'https://via.placeholder.com/36';
          document.getElementById('appUserName').textContent = prof?.displayName || '已登入';
          document.getElementById('appUserLineId').textContent = prof?.userId || '-';
        } catch {}
        // 權限（管理員）
        const isAdmin = !!APP.State.memberInfo?.isAdmin;
        APP.State.isAdmin = isAdmin;
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'block' : 'none');
        // 綁定底部導航
        document.querySelectorAll('.bottom-nav .nav-item').forEach(btn => {
          btn.onclick = () => {
            document.querySelectorAll('.bottom-nav .nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const page = btn.getAttribute('data-app-page');
            APP.AppView.switchPage(page);
          };
        });

        // 綁定個人資料表單提交
        const pf = document.getElementById('profileForm');
        if (pf && !pf.dataset.bind) {
          pf.addEventListener('submit', APP.AppView.submitProfile);
          pf.dataset.bind = '1';
        }

        // 載入資料
        APP.AppView.loadAll();
      },
      switchPage(page) {
        document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
        const el = document.getElementById('app-page-' + page);
        if (el) { el.classList.add('active'); window.scrollTo({ top: 0, behavior: 'smooth' }); }
      },
      async loadAll() {
        APP.Util.showLoading(true);
        try {
          await Promise.all([
            APP.AppView.loadHomeData(),
            APP.AppView.loadActivities(),
            APP.AppView.loadVolunteer(),
            APP.AppView.loadFinance(),
            APP.AppView.loadProfile()
          ]);
        } catch (e) { APP.Util.toast('資料載入失敗：' + e.message, 'error'); }
        finally { APP.Util.showLoading(false); }
      },
      async loadHomeData() {
        try {
          const res = await APP.API.post('getDashboardData', {});
          const d = res.data || {};
          document.getElementById('statActivities').textContent = d.totalActivities || 0;
          document.getElementById('statRegistrations').textContent = d.myRegistrations || 0;
          document.getElementById('statVolunteerHours').textContent = d.myVolunteerHours || 0;
          document.getElementById('statDonations').textContent = '$' + APP.Util.currency(d.myDonationAmount || 0);
          APP.AppView.renderRecentActivities(d.recentActivity || []);
        } catch {}
      },
      renderRecentActivities(list) {
        const c = document.getElementById('recentActivities');
        if (!list.length) {
          c.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>目前沒有活動</p></div>'; return;
        }
        c.innerHTML = list.slice(0, 3).map(a => `
          <div class="activity-item">
            <div class="activity-title">${a.title}</div>
            <div class="activity-info">${a.description || ''}</div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(a.date)}</span>
              <span class="status-badge status-${a.status}">${a.status}</span>
            </div>
          </div>`).join('');
      },
      async loadActivities() {
        try {
          const res = await APP.API.post('getActivities', {});
          const list = res.data || [];
          const open = list.filter(a => a.status === '開放報名' || a.status === '報名中');
          APP.AppView.renderActivities(open);
          const reg = await APP.API.post('getMyRegistrations', {});
          APP.AppView.renderMyRegistrations(reg.data || []);
        } catch {}
      },
      renderActivities(activities) {
        const c = document.getElementById('activitiesList');
        if (!activities.length) {
          c.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>目前沒有開放報名的活動</p></div>'; return;
        }
        c.innerHTML = activities.map(a => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="activity-title">${a.title}</div>
              <span class="status-badge status-${a.status}">${a.status}</span>
            </div>
            <div class="activity-info">${a.description || ''}</div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(a.date)} ${a.time || ''}</span>
              <span><i class="bi bi-geo-alt"></i>${a.location || '未指定'}</span>
              <span><i class="bi bi-people"></i>${a.currentCount || 0}/${a.maxParticipants}</span>
              ${a.fee ? `<span><i class="bi bi-cash"></i>$${APP.Util.currency(a.fee)}</span>` : ''}
            </div>
            <button class="btn btn-sm btn-gradient mt-2" onclick="APP.AppView.registerActivity('${a.id}')"><i class="bi bi-check-circle me-1"></i>我要報名</button>
          </div>`).join('');
      },
      renderMyRegistrations(regs) {
        const c = document.getElementById('myRegistrationsList');
        if (!regs.length) {
          c.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>您還沒有報名任何活動</p></div>'; return;
        }
        c.innerHTML = regs.map(r => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="activity-title">${r.activityTitle}</div>
              <span class="status-badge status-${r.status}">${r.status}</span>
            </div>
            <div class="activity-meta"><span><i class="bi bi-calendar"></i>${APP.Util.formatDate(r.registrationTime)}</span></div>
            ${r.status === '已報名' ? `<button class="btn btn-sm btn-outline-danger mt-2" onclick="APP.AppView.cancelRegistration('${r.id}')"><i class="bi bi-x-circle me-1"></i>取消報名</button>` : ''}
          </div>`).join('');
      },
      async registerActivity(activityId) {
        if (!confirm('確定要報名此活動嗎？')) return;
        try {
          APP.Util.showLoading(true);
          await APP.API.post('registerActivity', { activityId });
          APP.Util.toast('報名成功！', 'success');
          await APP.AppView.loadActivities();
          await APP.AppView.loadHomeData();
        } catch (e) { APP.Util.toast('報名失敗：' + e.message, 'error'); }
        finally { APP.Util.showLoading(false); }
      },
      async cancelRegistration(regId) {
        if (!confirm('確定要取消報名嗎？')) return;
        try {
          APP.Util.showLoading(true);
          await APP.API.post('cancelRegistration', { registrationId: regId });
          APP.Util.toast('已取消報名', 'success');
          await APP.AppView.loadActivities();
          await APP.AppView.loadHomeData();
        } catch (e) { APP.Util.toast('取消失敗：' + e.message, 'error'); }
        finally { APP.Util.showLoading(false); }
      },
      async loadVolunteer() {
        try {
          const res = await APP.API.post('getVolunteerData', {});
          const d = res.data || {};
          document.getElementById('volTotalHours').textContent = d.stats?.totalHours || 0;
          document.getElementById('volTotalActivities').textContent = d.stats?.totalActivities || 0;
          APP.AppView.renderVolunteerNeeds(d.needs || []);
          APP.AppView.renderVolunteerRecords(d.records || []);
        } catch {}
      },
      renderVolunteerNeeds(needs) {
        const c = document.getElementById('volunteerNeedsList');
        if (!needs.length) { c.innerHTML = '<div class="empty-state"><i class="bi bi-people"></i><p>目前沒有志工需求</p></div>'; return; }
        c.innerHTML = needs.map(n => `
          <div class="activity-item">
            <div class="activity-title">${n.title}</div>
            <div class="activity-info">${n.description || ''}</div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(n.date)} ${n.time || ''}</span>
              <span><i class="bi bi-people"></i>需求：${n.needCount}人</span>
              <span><i class="bi bi-clock"></i>時數：${n.hours}小時</span>
              <span><i class="bi bi-check-circle"></i>已報名：${n.currentCount || 0}人</span>
            </div>
            <button class="btn btn-sm btn-gradient mt-2" onclick="APP.AppView.applyVolunteer('${n.id}')"><i class="bi bi-hand-thumbs-up me-1"></i>我要報名</button>
          </div>`).join('');
      },
      renderVolunteerRecords(records) {
        const c = document.getElementById('myVolunteerRecords');
        if (!records.length) { c.innerHTML = '<div class="empty-state"><i class="bi bi-journal-x"></i><p>您還沒有志工服務記錄</p></div>'; return; }
        c.innerHTML = records.map(r => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="activity-title">${r.title}</div>
              <span class="status-badge status-${r.status}">${r.status}</span>
            </div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(r.date)}</span>
              <span><i class="bi bi-clock"></i>${r.hours}小時</span>
            </div>
          </div>`).join('');
      },
      async applyVolunteer(needId) {
        if (!confirm('確定要報名此志工服務嗎？')) return;
        try {
          APP.Util.showLoading(true);
          await APP.API.post('applyVolunteer', { needId });
          APP.Util.toast('報名成功！', 'success');
          await APP.AppView.loadVolunteer();
        } catch (e) { APP.Util.toast('報名失敗：' + e.message, 'error'); }
        finally { APP.Util.showLoading(false); }
      },
      async loadFinance() {
        try {
          const res = await APP.API.post('getFinanceData', {});
          const d = res.data || {};
          document.getElementById('finTotalDonation').textContent = '$' + APP.Util.currency(d.stats?.totalDonation || 0);
          document.getElementById('finPendingExpenses').textContent = d.stats?.pendingExpenses || 0;
          APP.AppView.renderMyDonations(d.donations || []);
          APP.AppView.renderMyExpenses(d.expenses || []);
        } catch {}
      },
      renderMyDonations(ds) {
        const c = document.getElementById('myDonationsList');
        if (!ds.length) { c.innerHTML = '<div class="empty-state"><i class="bi bi-heart"></i><p>您還沒有捐款記錄</p></div>'; return; }
        c.innerHTML = ds.map(d => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="activity-title">$${APP.Util.currency(d.amount)}</div>
                <div class="activity-info">${d.category || '一般捐款'}</div>
                <div class="activity-meta">
                  <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(d.createdAt)}</span>
                  <span class="status-badge status-${d.status}">${d.status}</span>
                </div>
              </div>
            </div>
          </div>`).join('');
      },
      renderMyExpenses(xs) {
        const c = document.getElementById('myExpensesList');
        if (!xs.length) { c.innerHTML = '<div class="empty-state"><i class="bi bi-receipt"></i><p>您還沒有支出申請</p></div>'; return; }
        c.innerHTML = xs.map(x => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="activity-title">$${APP.Util.currency(x.amount)}</div>
              <span class="status-badge status-${x.status}">${x.status}</span>
            </div>
            <div class="activity-info">${x.description || ''}</div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(x.createdAt)}</span>
              <span><i class="bi bi-tag"></i>${x.category}</span>
            </div>
          </div>`).join('');
      },
      async loadProfile() {
        try {
          const res = await APP.API.post('getUserInfo', {});
          const p = res.data || {};
          const form = document.getElementById('profileForm');
          if (form) {
            form.elements.realName.value = p.realName || '';
            form.elements.memberType.value = p.memberType || '';
            form.elements.phone.value = p.phone || '';
            form.elements.email.value = p.email || '';
            form.elements.birthday.value = APP.Util.formatDateInput(p.birthday);
            form.elements.diagnosisDate.value = APP.Util.formatDateInput(p.diagnosisDate);
            form.elements.address.value = p.address || '';
          }
          document.getElementById('appUserMemberType').textContent = p.memberType || '-';

          const rec = await APP.API.post('getMyReceipts', {});
          APP.AppView.renderMyReceipts(rec.data || []);
        } catch {}
      },
      renderMyReceipts(list) {
        const c = document.getElementById('myReceiptsList');
        if (!list.length) { c.innerHTML = '<div class="empty-state"><i class="bi bi-file-earmark-text"></i><p>您還沒有收據</p></div>'; return; }
        c.innerHTML = list.map(r => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="activity-title">${r.receiptNumber}</div>
                <div class="activity-meta">
                  <span><i class="bi bi-cash"></i>金額：$${APP.Util.currency(r.amount)}</span>
                  <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(r.issueDate)}</span>
                </div>
              </div>
              ${r.pdfUrl ? `<button class="btn btn-sm btn-gradient" onclick="window.open('${r.pdfUrl}','_blank')"><i class="bi bi-download"></i>下載</button>` : ''}
            </div>
          </div>`).join('');
      },
      async submitProfile(e) {
        e.preventDefault();
        const f = e.target;
        const data = {
          realName: f.realName.value, memberType: f.memberType.value, phone: f.phone.value,
          email: f.email.value, birthday: f.birthday.value, diagnosisDate: f.diagnosisDate.value, address: f.address.value
        };
        const btn = f.querySelector('button[type="submit"]');
        APP.Util.setBtnLoading(btn, true);
        try {
          await APP.API.post('updateProfile', data);
          APP.Util.toast('資料已更新', 'success');
          await APP.AppView.loadProfile();
        } catch (e2) { APP.Util.toast('更新失敗：' + e2.message, 'error'); }
        finally { APP.Util.setBtnLoading(btn, false); }
      },

      // Modal
      showDonationModal() {
        const html = `
          <div class="modal fade" id="donationModal" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>我要捐款</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="form-floating mb-3">
                    <input type="number" class="form-control" name="amount" required min="1" />
                    <label>捐款金額 *</label>
                  </div>
                  <div class="form-floating mb-3">
                    <select class="form-select" name="category">
                      <option>一般捐款</option><option>活動贊助</option>
                    </select>
                    <label>捐款類別</label>
                  </div>
                  <div class="form-floating mb-3">
                    <textarea class="form-control" name="description" style="height:80px;"></textarea>
                    <label>說明</label>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" name="needReceipt" id="needReceipt">
                    <label class="form-check-label" for="needReceipt">需要收據</label>
                  </div>
                  <div class="alert alert-info small">若您的電子郵件未填寫，收據將僅產生 PDF 供下載，不會寄送 Email。</div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="submit" class="btn btn-gradient">確認捐款</button>
                </div>
              </form>
            </div>
          </div>`;
        APP.Util.modal(html, async (fd) => {
          const data = {
            amount: fd.get('amount'), category: fd.get('category'), description: fd.get('description'),
            needReceipt: fd.get('needReceipt') === 'on'
          };
          const res = await APP.API.post('createDonation', data);
          APP.Util.toast('捐款記錄已新增，感謝您的支持！', 'success');
          if (res?.data?.pdfUrl) APP.Util.toast('已產生收據 PDF，請至「我的收據」下載', 'info');
          await APP.AppView.loadFinance();
          await APP.AppView.loadHomeData();
        });
      },
      showNewExpenseModal() {
        const html = `
          <div class="modal fade" id="expenseModal" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>支出申請</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="form-floating mb-3">
                    <input type="number" class="form-control" name="amount" required min="1"/>
                    <label>金額 *</label>
                  </div>
                  <div class="form-floating mb-3">
                    <select class="form-select" name="category" required>
                      <option value="">請選擇</option>
                      <option>活動費用</option><option>行政支出</option><option>設備支出</option>
                    </select>
                    <label>類別 *</label>
                  </div>
                  <div class="form-floating mb-3">
                    <textarea class="form-control" name="description" required style="height:100px;"></textarea>
                    <label>說明 *</label>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="submit" class="btn btn-gradient">送出申請</button>
                </div>
              </form>
            </div>
          </div>`;
        APP.Util.modal(html, async(fd)=>{
          const data = { amount: fd.get('amount'), category: fd.get('category'), description: fd.get('description') };
          await APP.API.post('createExpense', data);
          APP.Util.toast('支出申請已送出','success');
          await APP.AppView.loadFinance();
        });
      }
    },

    // ========== 會員中心（第四段） ==========
    Member: {
      selectedMood: 5,
      selectedTags: [],
      async initMember() {
        // 初次載入使用 memberInfo
        const info = APP.State.memberInfo;
        if (info) {
          document.getElementById('mc-name').textContent = info.name || '-';
          document.getElementById('mc-no').textContent = '會員編號：' + (info.memberNo || '---');
          document.getElementById('mc-avatar').textContent = (info.name||'A').charAt(0);
        }
        // 載入首頁資料
        APP.Member.loadTodayReminders();
        APP.Member.loadUpcomingEvents();
      },
      show(section){
        document.querySelectorAll('.member-section').forEach(s=> s.classList.remove('active'));
        switch(section){
          case 'home': document.getElementById('mc-home').classList.add('active'); APP.Member.loadTodayReminders(); APP.Member.loadUpcomingEvents(); break;
          case 'symptom': document.getElementById('mc-symptom').classList.add('active'); APP.Member.loadSymptomHistory(); break;
          case 'medication': document.getElementById('mc-medication').classList.add('active'); APP.Member.loadMedications(); break;
          case 'exercise': document.getElementById('mc-exercise').classList.add('active'); break;
          case 'sleep': document.getElementById('mc-sleep').classList.add('active'); break;
          case 'mood': document.getElementById('mc-mood').classList.add('active'); break;
          case 'events': document.getElementById('mc-events').classList.add('active'); APP.Member.loadEvents(); APP.Member.loadMyEvents(); break;
          case 'profile': document.getElementById('mc-profile').classList.add('active'); APP.Member.loadProfile(); APP.Member.loadDonationHistory(); break;
          default: document.getElementById('mc-home').classList.add('active');
        }
      },
      async loadTodayReminders(){
        const c = document.getElementById('mc-today-reminders');
        try{
          const res = await APP.API.postJson({ action:'getMedications', memberId: APP.State.memberInfo?.memberId });
          const arr = res.data || [];
          if (!arr.length) { c.innerHTML = '<div class="text-center text-muted py-4">今天沒有提醒事項</div>'; return; }
          let html = '';
          arr.forEach(m=>{
            let times = [];
            try{ times = JSON.parse(m.frequency || '[]'); }catch{}
            times.forEach(t=>{
              html += `
                <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                  <div>
                    <div class="fw-bold">💊 ${m.medicineName}</div>
                    <div class="small text-muted">${t} - ${m.dosage||''}</div>
                  </div>
                  <button class="btn btn-sm btn-primary" onclick="APP.Member.logMedication('${m.medicationId}','${t}')">已服用</button>
                </div>
              `;
            });
          });
          c.innerHTML = html;
        } catch(e){
          c.innerHTML = '<div class="text-center text-danger py-4">載入失敗</div>';
        }
      },
      async loadUpcomingEvents(){
        const c = document.getElementById('mc-upcoming-events');
        try{
          const today = new Date().toISOString().split('T')[0];
          const res = await APP.API.postJson({ action:'getEvents', status:'報名中', startDate: today });
          const arr = res.data || [];
          if (!arr.length) { c.innerHTML = '<div class="text-center text-muted py-4">目前沒有活動</div>'; return; }
          c.innerHTML = arr.slice(0,3).map(ev=> `
            <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
              <div>
                <div class="fw-bold">${ev.eventName}</div>
                <div class="small text-muted">📅 ${ev.eventDate} ${ev.startTime}　📍 ${ev.location}</div>
              </div>
              <span class="badge bg-info">${ev.registrationCount}/${ev.maxParticipants}</span>
            </div>
          `).join('');
        } catch(e){ c.innerHTML = '<div class="text-center text-danger py-4">載入失敗</div>'; }
      },
      async addSymptom(e){
        e.preventDefault();
        try{
          const res = await APP.API.postJson({
            action:'addDailySymptom',
            memberId: APP.State.memberInfo?.memberId,
            recordDate: new Date().toISOString().split('T')[0],
            tremorLevel: document.getElementById('mc-tremor').value,
            rigidityLevel: document.getElementById('mc-rigidity').value,
            bradykinesiaLevel: document.getElementById('mc-brady').value,
            balanceLevel: document.getElementById('mc-balance').value,
            notes: document.getElementById('mc-symptom-notes').value
          });
          if (res?.success) {
            APP.Util.toast('記錄成功','success');
            e.target.reset();
            APP.Member.loadSymptomHistory();
          } else { APP.Util.toast(res?.message || '新增失敗','error'); }
        } catch { APP.Util.toast('系統錯誤','error'); }
      },
      async loadSymptomHistory(){
        const c = document.getElementById('mc-symptom-history');
        try{
          const end = new Date().toISOString().split('T')[0];
          const start = new Date(Date.now()-30*24*60*60*1000).toISOString().split('T')[0];
          const res = await APP.API.postJson({ action:'getDailySymptoms', memberId: APP.State.memberInfo?.memberId, startDate: start, endDate: end });
          const arr = res.data || [];
          if (!arr.length) { c.innerHTML = '<div class="text-center text-muted py-4">尚無記錄</div>'; return; }
          c.innerHTML = arr.map(s=> `
            <div class="border rounded p-2 mb-2">
              <div class="fw-bold">${s.recordDate}</div>
              <div class="small text-muted">顫抖:${s.tremorLevel} | 僵硬:${s.rigidityLevel} | 遲緩:${s.bradykinesiaLevel} | 平衡:${s.balanceLevel}</div>
            </div>
          `).join('');
        } catch{ c.innerHTML = '<div class="text-center text-danger py-4">載入失敗</div>'; }
      },
      openAddMedication(){
        const html = `
          <div class="modal fade" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header">
                  <div class="modal-title">新增用藥</div>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label class="form-label">藥物名稱 *</label>
                    <input class="form-control" name="name" required/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">劑量</label>
                    <input class="form-control" name="dosage"/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label mb-2">服用時間（至少一個）</label><br/>
                    ${['08:00','12:00','18:00','22:00'].map(t=>`
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="times" value="${t}" id="t-${t}">
                        <label class="form-check-label" for="t-${t}">${t}</label>
                      </div>`).join('')}
                  </div>
                  <div class="mb-3">
                    <label class="form-label">開始日期</label>
                    <input type="date" class="form-control" name="startdate" value="${new Date().toISOString().split('T')[0]}"/>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" name="reminder" id="reminder" checked/>
                    <label class="form-check-label" for="reminder">啟用提醒</label>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">提前提醒（分鐘）</label>
                    <input type="number" class="form-control" name="advance" value="10" min="0"/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">備註</label>
                    <textarea class="form-control" name="notes" rows="3"></textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">取消</button>
                  <button class="btn btn-primary" type="submit">新增用藥</button>
                </div>
              </form>
            </div>
          </div>`;
        APP.Util.modal(html, async(fd)=>{
          const times = fd.getAll('times');
          if (!times.length) throw new Error('請至少選擇一個服藥時間');
          const res = await APP.API.postJson({
            action:'addMedication',
            memberId: APP.State.memberInfo?.memberId,
            medicineName: fd.get('name'),
            dosage: fd.get('dosage'),
            frequency: JSON.stringify(times),
            startDate: fd.get('startdate') || new Date().toISOString().split('T')[0],
            reminderEnabled: fd.get('reminder')==='on',
            reminderMinutes: fd.get('advance') || 10,
            notes: fd.get('notes')
          });
          if (res?.success) {
            APP.Util.toast('新增成功','success');
            APP.Member.loadMedications();
          } else throw new Error(res?.message || '新增失敗');
        });
      },
      async loadMedications(){
        const c = document.getElementById('mc-medication-list');
        try{
          const res = await APP.API.postJson({ action:'getMedications', memberId: APP.State.memberInfo?.memberId });
          const arr = res.data || [];
          if (!arr.length) { c.innerHTML = '<div class="text-center text-muted py-4">尚未新增用藥</div>'; return; }
          c.innerHTML = arr.map(m=>{
            let times=[]; try{ times = JSON.parse(m.frequency||'[]'); }catch{}
            return `
            <div class="border rounded p-2 mb-2">
              <div class="fw-bold">${m.medicineName}</div>
              <div class="small text-muted">${m.dosage||''} | ${times.join(', ')}</div>
            </div>`;
          }).join('');
        } catch{ c.innerHTML = '<div class="text-center text-danger py-4">載入失敗</div>'; }
      },
      async logMedication(id, time){
        try {
          const res = await APP.API.postJson({
            action:'logMedication',
            medicationId: id, memberId: APP.State.memberInfo?.memberId,
            scheduledTime: time, status:'已服用'
          });
          if (res?.success) { APP.Util.toast('已記錄服藥','success'); APP.Member.loadTodayReminders(); }
          else APP.Util.toast(res?.message || '記錄失敗','error');
        } catch { APP.Util.toast('系統錯誤','error'); }
      },
      async addExercise(e){
        e.preventDefault();
        try {
          const res = await APP.API.postJson({
            action:'addExerciseLog', memberId: APP.State.memberInfo?.memberId,
            exerciseDate: new Date().toISOString().split('T')[0],
            exerciseType: document.getElementById('mc-ex-type').value,
            duration: document.getElementById('mc-ex-duration').value,
            intensity: document.getElementById('mc-ex-intensity').value,
            bodyCondition: document.getElementById('mc-ex-condition').value,
            notes: document.getElementById('mc-ex-notes').value
          });
          if (res?.success) { APP.Util.toast('記錄成功','success'); e.target.reset(); }
          else APP.Util.toast(res?.message || '記錄失敗','error');
        } catch { APP.Util.toast('系統錯誤','error'); }
      },
      async addSleep(e){
        e.preventDefault();
        const bed = document.getElementById('mc-sleep-bed').value;
        const wake = document.getElementById('mc-sleep-wake').value;
        let bd = new Date('2000-01-01 ' + bed), wk = new Date('2000-01-01 ' + wake);
        if (wk < bd) wk.setDate(wk.getDate()+1);
        const dur = ((wk - bd)/(1000*60*60)).toFixed(1);
        try{
          const res = await APP.API.postJson({
            action:'addSleepLog', memberId: APP.State.memberInfo?.memberId,
            sleepDate: new Date().toISOString().split('T')[0],
            bedtime: bed, wakeTime: wake, duration: dur,
            quality: document.getElementById('mc-sleep-quality').value,
            wakeCount: document.getElementById('mc-sleep-wakecount').value,
            hasDream: document.getElementById('mc-sleep-dream').checked,
            hasNightmare: document.getElementById('mc-sleep-nightmare').checked,
            notes: document.getElementById('mc-sleep-notes').value
          });
          if (res?.success) { APP.Util.toast('記錄成功','success'); e.target.reset(); }
          else APP.Util.toast(res?.message || '記錄失敗','error');
        } catch { APP.Util.toast('系統錯誤','error'); }
      },
      selectMood(score){
        APP.Member.selectedMood = score;
        document.getElementById('mc-mood-score').value = score;
      },
      toggleTag(el){
        const tag = el.dataset.tag;
        const idx = APP.Member.selectedTags.indexOf(tag);
        if (idx>=0) { APP.Member.selectedTags.splice(idx,1); el.classList.remove('bg-primary'); el.classList.add('bg-secondary'); }
        else { APP.Member.selectedTags.push(tag); el.classList.remove('bg-secondary'); el.classList.add('bg-primary'); }
      },
      async addMood(e){
        e.preventDefault();
        try{
          const res = await APP.API.postJson({
            action:'addMoodDiary', memberId: APP.State.memberInfo?.memberId,
            diaryDate: new Date().toISOString().split('T')[0],
            moodScore: document.getElementById('mc-mood-score').value,
            moodTags: APP.Member.selectedTags.join(','),
            content: document.getElementById('mc-mood-content').value
          });
          if (res?.success) {
            APP.Util.toast('記錄成功','success');
            e.target.reset();
            APP.Member.selectedTags = [];
            document.querySelectorAll('#mc-mood-tags .badge').forEach(b=> { b.classList.add('bg-secondary'); b.classList.remove('bg-primary'); });
          } else APP.Util.toast(res?.message || '記錄失敗','error');
        } catch{ APP.Util.toast('系統錯誤','error'); }
      },
      async loadEvents(){
        const c = document.getElementById('mc-events-list');
        try{
          const today = new Date().toISOString().split('T')[0];
          const res = await APP.API.postJson({ action:'getEvents', status:'報名中', startDate: today });
          const arr = res.data || [];
          if (!arr.length) { c.innerHTML = '<div class="text-center text-muted py-4">目前沒有活動</div>'; return; }
          c.innerHTML = arr.map(ev=>{
            const full = Number(ev.registrationCount)>=Number(ev.maxParticipants);
            return `
              <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                <div>
                  <div class="fw-bold">${ev.eventName}</div>
                  <div class="small text-muted">📅 ${ev.eventDate} ${ev.startTime}　📍 ${ev.location}</div>
                  <div class="small">👥 ${ev.registrationCount}/${ev.maxParticipants}</div>
                </div>
                <span class="badge ${full? 'bg-danger':'bg-info'}">${full? '已額滿':'報名中'}</span>
              </div>`;
          }).join('');
        } catch{ c.innerHTML = '<div class="text-center text-danger py-4">載入失敗</div>'; }
      },
      async loadMyEvents(){
        const c = document.getElementById('mc-my-events');
        try{
          const res = await APP.API.postJson({ action:'getMyEvents', memberId: APP.State.memberInfo?.memberId });
          const arr = res.data || [];
          if (!arr.length) { c.innerHTML = '<div class="text-center text-muted py-4">尚未報名活動</div>'; return; }
          c.innerHTML = arr.map(ev=>{
            let badge = 'bg-info';
            if (ev.registrationStatus==='已確認') badge='bg-success';
            else if (ev.registrationStatus==='候補') badge='bg-warning';
            else if (ev.registrationStatus==='已取消') badge='bg-danger';
            return `
              <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                <div>
                  <div class="fw-bold">${ev.eventName}</div>
                  <div class="small text-muted">📅 ${ev.eventDate} ${ev.startTime}　📍 ${ev.location}</div>
                </div>
                <span class="badge ${badge}">${ev.registrationStatus}</span>
              </div>`;
          }).join('');
        } catch{ c.innerHTML = '<div class="text-center text-danger py-4">載入失敗</div>'; }
      },
      async loadProfile(){
        const c = document.getElementById('mc-profile-info');
        try{
          const res = await APP.API.postJson({ action:'getMemberInfo', memberId: APP.State.memberInfo?.memberId });
          const d = res.data || {};
          c.innerHTML = `
            <div class="row g-3">
              <div class="col-12 col-md-6"><div class="small text-muted">姓名</div><div class="fw-bold">${d.name||'-'}</div></div>
              <div class="col-12 col-md-6"><div class="small text-muted">會員編號</div><div class="fw-bold">${d.memberNo||'-'}</div></div>
              <div class="col-12 col-md-6"><div class="small text-muted">Email</div><div class="fw-bold">${d.email||'-'}</div></div>
              <div class="col-12 col-md-6"><div class="small text-muted">手機</div><div class="fw-bold">${d.phone||'-'}</div></div>
              <div class="col-12"><div class="small text-muted">地址</div><div class="fw-bold">${d.address||'未填寫'}</div></div>
            </div>`;
        } catch{ c.innerHTML = '<div class="text-center text-danger py-4">載入失敗</div>'; }
      },
      async loadDonationHistory(){
        const c = document.getElementById('mc-donation-history');
        try{
          const res = await APP.API.postJson({ action:'getDonations', memberId: APP.State.memberInfo?.memberId });
          const data = res.data || {};
          const list = data.donations || [];
          if (!list.length) { c.innerHTML = '<div class="text-center text-muted py-3">尚無捐款記錄</div>'; return; }
          let html = `
            <div class="p-2 rounded mb-2" style="background:#f8f9fa;">
              <div class="small text-muted">累計捐款</div>
              <div class="fs-4 fw-bold text-primary">NT$ ${APP.Util.currency(data.totalAmount||0)}</div>
            </div>`;
          html += list.map(d=> `
            <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
              <div>
                <div class="fw-bold">NT$ ${APP.Util.currency(d.amount)}</div>
                <div class="small text-muted">${d.donationDate} | ${d.purpose||''}</div>
              </div>
              ${d.receiptIssued? '<span class="badge bg-success">已開立收據</span>':''}
            </div>`).join('');
          c.innerHTML = html;
        } catch { c.innerHTML = '<div class="text-center text-danger py-4">載入失敗</div>'; }
      }
    },

    // ========== 管理後台（第三段） ==========
    Admin: {
      binded: false,
      async initAdmin(){
        // 權限檢查
        if (!APP.State.isAdmin) { APP.Util.toast('沒有權限','error'); APP.Router.go('member'); return; }

        if (!APP.Admin.binded) {
          // 側邊選單切換
          document.querySelectorAll('#admin-menu .menu-item').forEach(mi=>{
            mi.addEventListener('click', (e)=>{
              document.querySelectorAll('#admin-menu .menu-item').forEach(m=> m.classList.remove('active'));
              mi.classList.add('active');
              const section = mi.getAttribute('data-admin-section');
              APP.Admin.showSection(section);
            });
          });
          APP.Admin.binded = true;
        }
        // 初始化資料
        APP.Admin.loadDashboard();
        APP.Admin.loadSettings();
        const admin = APP.State.memberInfo || { name:'管理員' };
        document.getElementById('admin-name').textContent = admin.name || '管理員';
        document.getElementById('admin-avatar').textContent = (admin.name || 'A').charAt(0);
      },
      toggleSidebar(){ document.getElementById('admin-sidebar').classList.toggle('collapsed'); },
      showSection(sec){
        document.querySelectorAll('.admin-section').forEach(s=> s.classList.remove('active'));
        document.getElementById('admin-'+sec).classList.add('active');
        const titles = { dashboard:'系統總覽', members:'會員管理', events:'活動管理', health:'健康記錄', donations:'捐款管理', reports:'統計報表', settings:'系統設定' };
        document.getElementById('admin-page-title').textContent = titles[sec] || '系統總覽';
        // 載入對應資料
        switch(sec){
          case 'dashboard': APP.Admin.loadDashboard(); break;
          case 'members': APP.Admin.loadMembers(1); break;
          case 'events': APP.Admin.loadEvents(1); break;
          case 'health': APP.Admin.loadHealth(1); break;
          case 'donations': APP.Admin.loadDonations(1); break;
          case 'reports': APP.Admin.loadReports(); break;
          case 'settings': APP.Admin.loadSettings(); break;
        }
      },
      setLoading(on){ document.getElementById('admin-loading').classList.toggle('d-none', !on); },
      setAlert(msg, type='info'){
        const al = document.getElementById('admin-alert');
        al.className = 'alert alert-' + (type==='error'? 'danger': type);
        al.textContent = msg;
        al.classList.remove('d-none');
        setTimeout(()=> al.classList.add('d-none'), 5000);
      },
      async loadDashboard(){
        APP.Admin.setLoading(true);
        try{
          const [m,e,d,a] = await Promise.all([
            APP.API.get({ action:'getStats', type:'members' }),
            APP.API.get({ action:'getStats', type:'events' }),
            APP.API.get({ action:'getStats', type:'donations' }),
            APP.API.get({ action:'getRecentActivities' })
          ]);
          if (m?.success) { document.getElementById('adm-total-members').textContent = m.data.total || 0; document.getElementById('adm-active-members').textContent = m.data.active || 0; }
          if (e?.success) { document.getElementById('adm-total-events').textContent = e.data.total || 0; }
          if (d?.success) { document.getElementById('adm-total-donations').textContent = 'NT$ ' + APP.Util.currency(d.data.total || 0); }
          const actC = document.getElementById('adm-recent-activities');
          if (a?.success && a.data?.length) {
            actC.innerHTML = a.data.map(x=> `
              <div class="border-bottom py-2 d-flex justify-content-between">
                <div><strong>${x.type}</strong><div class="small text-muted">${x.description}</div></div>
                <small class="text-muted">${x.timestamp}</small>
              </div>`).join('');
          } else { actC.innerHTML = '<div class="text-center text-muted py-4">暫無動態記錄</div>'; }
        } catch { APP.Admin.setAlert('載入總覽失敗','error'); }
        finally{ APP.Admin.setLoading(false); }
      },
      // 會員
      async loadMembers(page=1){
        APP.Admin.setLoading(true);
        try{
          const search = document.getElementById('adm-member-search').value || '';
          const status = document.getElementById('adm-member-status').value || '';
          const r = await APP.API.get({ action:'getMembers', page, pageSize: APP.State.pageSize, search, status });
          const body = document.getElementById('adm-members-body');
          if (r?.success && r.data?.length) {
            body.innerHTML = r.data.map(m=> `
              <tr>
                <td>${m.memberNo||'-'}</td><td>${m.name||'-'}</td><td>${m.email||'-'}</td>
                <td>${m.phone||'-'}</td><td>${m.registerDate||'-'}</td>
                <td><span class="badge badge-${APP.Util.getStatusClass(m.status)}">${m.status||'-'}</span></td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="APP.Admin.viewMember('${m.memberId}')">查看</button>
                  <button class="btn btn-sm btn-warning" onclick="APP.Admin.editMember('${m.memberId}')">編輯</button>
                  <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteMember('${m.memberId}')">刪除</button>
                </td>
              </tr>`).join('');
            APP.Admin.pagination('members', r.totalPages || 1, page);
          } else {
            body.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">沒有資料</td></tr>';
            APP.Admin.pagination('members', 1, 1);
          }
        } catch { APP.Admin.setAlert('載入會員失敗','error'); }
        finally{ APP.Admin.setLoading(false); }
      },
      pagination(key, totalPages, currentPage){
        const id = 'adm-' + key + '-pagination';
        const el = document.getElementById(id);
        if (!el) return;
        let html = '';
        const fnMap = { members:'loadMembers', events:'loadEvents', health:'loadHealth', donations:'loadDonations' };
        const fn = 'APP.Admin.' + (fnMap[key] || 'loadMembers');
        html += `<button class="btn btn-sm btn-outline-secondary" ${currentPage<=1?'disabled':''} onclick="${fn}(${currentPage-1})">上一頁</button>`;
        const sp = Math.max(1, currentPage-2), ep = Math.min(totalPages, currentPage+2);
        for(let i=sp;i<=ep;i++){
          html += `<button class="btn btn-sm ${i===currentPage?'btn-primary':'btn-outline-secondary'}" onclick="${fn}(${i})">${i}</button>`;
        }
        html += `<button class="btn btn-sm btn-outline-secondary" ${currentPage>=totalPages?'disabled':''} onclick="${fn}(${currentPage+1})">下一頁</button>`;
        el.innerHTML = html;
      },
      showAddMember(){
        const html = `
          <div class="modal fade" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header"><div class="modal-title">新增會員</div><button class="btn-close" type="button" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                  <div class="row g-2">
                    <div class="col-12 col-md-6"><label class="form-label">姓名 *</label><input name="name" class="form-control" required/></div>
                    <div class="col-12 col-md-6"><label class="form-label">會員編號</label><input name="memberNo" class="form-control" placeholder="系統自動產生"/></div>
                    <div class="col-12 col-md-6"><label class="form-label">Email *</label><input name="email" type="email" class="form-control" required/></div>
                    <div class="col-12 col-md-6"><label class="form-label">電話</label><input name="phone" class="form-control"/></div>
                    <div class="col-12 col-md-6"><label class="form-label">性別</label><select name="gender" class="form-select"><option value="">請選擇</option><option>男</option><option>女</option><option>其他</option></select></div>
                    <div class="col-12 col-md-6"><label class="form-label">生日</label><input type="date" name="birthday" class="form-control"/></div>
                    <div class="col-12"><label class="form-label">地址</label><textarea name="address" class="form-control" rows="2"></textarea></div>
                    <div class="col-12"><label class="form-label">備註</label><textarea name="notes" class="form-control" rows="2"></textarea></div>
                  </div>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" type="button" data-bs-dismiss="modal">取消</button><button class="btn btn-primary" type="submit">新增會員</button></div>
              </form>
            </div>
          </div>`;
        APP.Util.modal(html, async(fd)=>{
          const res = await APP.API.get({
            action:'addMember',
            name: fd.get('name'),
            memberNo: fd.get('memberNo'),
            email: fd.get('email'),
            phone: fd.get('phone'),
            gender: fd.get('gender'),
            birthday: fd.get('birthday'),
            address: fd.get('address'),
            notes: fd.get('notes')
          });
          if (res?.success) { APP.Util.toast('新增成功','success'); APP.Admin.loadMembers(1); }
          else throw new Error(res?.message || '新增失敗');
        });
      },
      viewMember(id){ APP.Util.toast('查看功能可擴充','info'); },
      editMember(id){ APP.Util.toast('編輯功能可擴充','info'); },
      async deleteMember(id){
        if (!confirm('確定要刪除此會員？')) return;
        const r = await APP.API.get({ action:'deleteMember', memberId: id });
        if (r?.success){ APP.Util.toast('刪除成功','success'); APP.Admin.loadMembers(1); }
        else APP.Util.toast(r?.message || '刪除失敗','error');
      },

      // 活動
      async loadEvents(page=1){
        APP.Admin.setLoading(true);
        try{
          const search = document.getElementById('adm-event-search').value || '';
          const status = document.getElementById('adm-event-status').value || '';
          const r = await APP.API.get({ action:'getEvents', page, pageSize: APP.State.pageSize, search, status });
          const body = document.getElementById('adm-events-body');
          if (r?.success && r.data?.length) {
            body.innerHTML = r.data.map(ev=> `
              <tr>
                <td>${ev.eventName}</td>
                <td>${ev.eventDate||''} ${ev.startTime||''}</td>
                <td>${ev.location||''}</td>
                <td>${ev.registrationCount}/${ev.maxParticipants}</td>
                <td><span class="badge badge-${APP.Util.getStatusClass(ev.status)}">${ev.status||''}</span></td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="APP.Admin.viewEvent('${ev.eventId}')">查看</button>
                  <button class="btn btn-sm btn-warning" onclick="APP.Admin.editEvent('${ev.eventId}')">編輯</button>
                  <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteEvent('${ev.eventId}')">刪除</button>
                </td>
              </tr>`).join('');
            APP.Admin.pagination('events', r.totalPages || 1, page);
          } else {
            body.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">沒有資料</td></tr>';
            APP.Admin.pagination('events', 1, 1);
          }
        } catch { APP.Admin.setAlert('載入活動失敗','error'); }
        finally{ APP.Admin.setLoading(false); }
      },
      showAddEvent(){
        const html = `
          <div class="modal fade" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header"><div class="modal-title">新增活動</div><button class="btn-close" type="button" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                  <div class="row g-2">
                    <div class="col-12"><label class="form-label">活動名稱 *</label><input name="name" class="form-control" required/></div>
                    <div class="col-6"><label class="form-label">活動日期 *</label><input type="date" name="date" class="form-control" required/></div>
                    <div class="col-6"><label class="form-label">開始時間 *</label>                    <input type="time" name="start" class="form-control" required/></div>
                  <div class="col-6"><label class="form-label">結束時間 *</label><input type="time" name="end" class="form-control" required/></div>
                  <div class="col-6"><label class="form-label">報名上限</label><input type="number" name="max" class="form-control" min="1" value="30"/></div>
                  <div class="col-12"><label class="form-label">活動地點 *</label><input name="location" class="form-control" required/></div>
                  <div class="col-12"><label class="form-label">活動描述</label><textarea name="desc" class="form-control" rows="3"></textarea></div>
                  <div class="col-12"><label class="form-label">報名費用 (元)</label><input type="number" name="fee" class="form-control" min="0" value="0"/></div>
                </div>
              </div>
              <div class="modal-footer"><button class="btn btn-secondary" type="button" data-bs-dismiss="modal">取消</button><button class="btn btn-primary" type="submit">新增活動</button></div>
            </form>
          </div>
        </div>`;
        APP.Util.modal(html, async(fd)=>{
          const r = await APP.API.get({
            action:'addEvent',
            eventName: fd.get('name'),
            eventType: '其他',
            eventDate: fd.get('date'),
            startTime: fd.get('start'),
            endTime: fd.get('end'),
            location: fd.get('location'),
            description: fd.get('desc'),
            maxParticipants: fd.get('max'),
            fee: fd.get('fee') || 0
          });
          if (r?.success) { APP.Util.toast('新增成功','success'); APP.Admin.loadEvents(1); }
          else throw new Error(r?.message || '新增失敗');
        });
      },
      viewEvent(id){ APP.Util.toast('查看功能可擴充','info'); },
      editEvent(id){ APP.Util.toast('編輯功能可擴充','info'); },
      async deleteEvent(id){
        if (!confirm('確定刪除此活動？')) return;
        const r = await APP.API.get({ action:'deleteEvent', eventId: id });
        if (r?.success){ APP.Util.toast('刪除成功','success'); APP.Admin.loadEvents(1); }
        else APP.Util.toast(r?.message || '刪除失敗','error');
      },

      // 健康
      async loadHealth(page=1){
        APP.Admin.setLoading(true);
        try{
          const search = document.getElementById('adm-health-search').value || '';
          const dateFrom = document.getElementById('adm-health-from').value || '';
          const dateTo = document.getElementById('adm-health-to').value || '';
          const r = await APP.API.get({ action:'getAllHealthRecords', page, pageSize: APP.State.pageSize, search, dateFrom, dateTo });
          const body = document.getElementById('adm-health-body');
          if (r?.success && r.data?.length) {
            body.innerHTML = r.data.map(rec=> `
              <tr>
                <td>${rec.memberName}</td>
                <td>${rec.recordDate}</td>
                <td>${rec.tremorLevel}</td><td>${rec.rigidityLevel}</td><td>${rec.bradykinesiaLevel}</td><td>${rec.balanceLevel}</td>
                <td>${rec.notes||'-'}</td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="APP.Admin.viewHealthRecord('${rec.recordId}')">查看</button>
                  <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteHealthRecord('${rec.recordId}')">刪除</button>
                </td>
              </tr>`).join('');
            APP.Admin.pagination('health', r.totalPages || 1, page);
          } else {
            body.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">沒有資料</td></tr>';
            APP.Admin.pagination('health', 1, 1);
          }
        } catch { APP.Admin.setAlert('載入健康記錄失敗','error'); }
        finally { APP.Admin.setLoading(false); }
      },
      viewHealthRecord(id){ APP.Util.toast('查看功能可擴充','info'); },
      async deleteHealthRecord(id){
        if (!confirm('確定刪除此健康記錄？')) return;
        const r = await APP.API.get({ action:'deleteHealthRecord', recordId: id });
        if (r?.success) { APP.Util.toast('刪除成功','success'); APP.Admin.loadHealth(1); }
        else APP.Util.toast(r?.message || '刪除失敗','error');
      },
      async exportHealth(){
        try{
          APP.Admin.setLoading(true);
          const r = await APP.API.get({ action:'exportHealthData' });
          if (r?.success) {
            const blob = new Blob([r.data], { type:'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = '健康記錄_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            APP.Admin.setAlert('健康記錄匯出成功！','success');
          } else APP.Admin.setAlert('匯出失敗：' + (r?.message||''),'error');
        } catch(e){ APP.Admin.setAlert('匯出失敗：' + e.message,'error'); }
        finally { APP.Admin.setLoading(false); }
      },

      // 捐款
      async loadDonations(page=1){
        APP.Admin.setLoading(true);
        try{
          const search = document.getElementById('adm-donation-search').value || '';
          const type = document.getElementById('adm-donation-type').value || '';
          const dateFrom = document.getElementById('adm-donation-from').value || '';
          const dateTo = document.getElementById('adm-donation-to').value || '';
          const r = await APP.API.get({ action:'getDonations', page, pageSize: APP.State.pageSize, search, type, dateFrom, dateTo });
          const body = document.getElementById('adm-donations-body');
          if (r?.success && r.data?.length) {
            body.innerHTML = r.data.map(d=> `
              <tr>
                <td>${d.donorName}</td>
                <td>NT$ ${APP.Util.currency(d.amount)}</td>
                <td>${d.donationType}</td>
                <td>${d.donationDate}</td>
                <td>${d.paymentMethod}</td>
                <td><span class="badge badge-${APP.Util.getStatusClass(d.status)}">${d.status}</span></td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="APP.Admin.viewDonation('${d.donationId}')">查看</button>
                  <button class="btn btn-sm btn-warning" onclick="APP.Admin.editDonation('${d.donationId}')">編輯</button>
                  <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteDonation('${d.donationId}')">刪除</button>
                </td>
              </tr>`).join('');
            APP.Admin.pagination('donations', r.totalPages || 1, page);
          } else {
            body.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">沒有資料</td></tr>';
            APP.Admin.pagination('donations', 1, 1);
          }
        } catch { APP.Admin.setAlert('載入捐款失敗','error'); }
        finally { APP.Admin.setLoading(false); }
      },
      showAddDonation(){
        const html = `
          <div class="modal fade" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header"><div class="modal-title">新增捐款記錄</div><button class="btn-close" type="button" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                  <div class="row g-2">
                    <div class="col-12 col-md-6"><label class="form-label">捐款人姓名 *</label><input name="name" class="form-control" required/></div>
                    <div class="col-12 col-md-6"><label class="form-label">金額 *</label><input type="number" name="amount" class="form-control" min="1" required/></div>
                    <div class="col-12 col-md-6"><label class="form-label">類型</label><select name="type" class="form-select"><option>一般捐款</option><option>定期捐款</option><option>指定用途</option></select></div>
                    <div class="col-12 col-md-6"><label class="form-label">捐款日期 *</label><input type="date" name="date" class="form-control" required/></div>
                    <div class="col-12 col-md-6"><label class="form-label">付款方式</label><select name="pay" class="form-select"><option>銀行轉帳</option><option>信用卡</option><option>現金</option><option>支票</option></select></div>
                    <div class="col-12 col-md-6"><label class="form-label">電話</label><input name="phone" class="form-control"/></div>
                    <div class="col-12"><label class="form-label">用途說明</label><textarea name="purpose" class="form-control" rows="2"></textarea></div>
                  </div>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" type="button" data-bs-dismiss="modal">取消</button><button class="btn btn-primary" type="submit">新增記錄</button></div>
              </form>
            </div>
          </div>`;
        APP.Util.modal(html, async(fd)=>{
          const r = await APP.API.get({
            action:'addDonation',
            donorName: fd.get('name'),
            amount: fd.get('amount'),
            donationType: fd.get('type'),
            donationDate: fd.get('date'),
            paymentMethod: fd.get('pay'),
            phone: fd.get('phone'),
            purpose: fd.get('purpose')
          });
          if (r?.success) { APP.Util.toast('新增成功','success'); APP.Admin.loadDonations(1); }
          else throw new Error(r?.message || '新增失敗');
        });
      },
      viewDonation(id){ APP.Util.toast('查看功能可擴充','info'); },
      editDonation(id){ APP.Util.toast('編輯功能可擴充','info'); },
      async deleteDonation(id){
        if (!confirm('確定刪除此捐款記錄？')) return;
        const r = await APP.API.get({ action:'deleteDonation', donationId:id });
        if (r?.success){ APP.Util.toast('刪除成功','success'); APP.Admin.loadDonations(1); }
        else APP.Util.toast(r?.message || '刪除失敗','error');
      },
      async exportMembers(){
        try{
          APP.Admin.setLoading(true);
          const r = await APP.API.get({ action:'exportMembers' });
          if (r?.success) {
            const blob = new Blob([r.data], { type:'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = '會員資料_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            APP.Admin.setAlert('會員資料匯出成功！','success');
          } else APP.Admin.setAlert('匯出失敗：' + (r?.message||''),'error');
        } catch(e){ APP.Admin.setAlert('匯出失敗：' + e.message,'error'); }
        finally{ APP.Admin.setLoading(false); }
      },
      async exportAllReports(){
        try{
          APP.Admin.setLoading(true);
          const r = await APP.API.get({ action:'exportAllReports' });
          if (r?.success) {
            const blob = new Blob([r.data], { type:'application/zip' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = '統計報表_' + new Date().toISOString().split('T')[0] + '.zip';
            a.click();
            APP.Admin.setAlert('統計報表匯出成功！','success');
          } else APP.Admin.setAlert('匯出失敗：' + (r?.message||''),'error');
        } catch(e){ APP.Admin.setAlert('匯出失敗：' + e.message,'error'); }
        finally{ APP.Admin.setLoading(false); }
      },

      // 設定
      loadSettings(){
        document.getElementById('adm-api-url').value = localStorage.getItem('admin_API_URL') || APP.State.API.alt;
        document.getElementById('adm-page-size').value = localStorage.getItem('admin_page_size') || '20';
        document.getElementById('adm-backup-interval').value = localStorage.getItem('admin_backup_interval') || '24';
        document.getElementById('adm-announcement').value = localStorage.getItem('admin_system_announcement') || '';
      },
      saveSettings(){
        const apiUrl = document.getElementById('adm-api-url').value.trim();
        const pageSize = document.getElementById('adm-page-size').value;
        const backup = document.getElementById('adm-backup-interval').value;
        const ann = document.getElementById('adm-announcement').value;
        if (apiUrl) {
          localStorage.setItem('admin_API_URL', apiUrl);
          localStorage.setItem('API_URL', apiUrl);
          APP.State.API.alt = apiUrl;
          APP.State.API.primary = apiUrl;
        }
        localStorage.setItem('admin_page_size', pageSize);
        localStorage.setItem('admin_backup_interval', backup);
        localStorage.setItem('admin_system_announcement', ann);
        APP.State.pageSize = parseInt(pageSize || '20', 10);
        APP.Admin.setAlert('設定已儲存','success');
      },
      async exportData(){
        try{
          APP.Admin.setLoading(true);
          const r = await APP.API.get({ action:'exportAllData' });
          if (r?.success) {
            const blob = new Blob([r.data], { type:'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = '系統資料備份_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            APP.Admin.setAlert('資料匯出成功！','success');
          } else APP.Admin.setAlert('匯出失敗：' + (r?.message||''),'error');
        } catch(e){ APP.Admin.setAlert('匯出失敗：' + e.message,'error'); }
        finally{ APP.Admin.setLoading(false); }
      },
      async backupData(){
        try{
          APP.Admin.setLoading(true);
          const r = await APP.API.get({ action:'backupData' });
          if (r?.success) APP.Admin.setAlert('資料備份成功！','success');
          else APP.Admin.setAlert('備份失敗：' + (r?.message||''),'error');
        } catch(e){ APP.Admin.setAlert('備份失敗：' + e.message,'error'); }
        finally{ APP.Admin.setLoading(false); }
      },
      clearCache(){
        if (!confirm('確定清除快取？')) return;
        const adminInfo = localStorage.getItem('adminInfo');
        localStorage.clear();
        if (adminInfo) localStorage.setItem('adminInfo', adminInfo);
        APP.Admin.setAlert('快取清除成功！','success');
        APP.Admin.loadSettings();
      },
      showAddAdmin(){
        const html = `
          <div class="modal fade" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header"><div class="modal-title">新增管理員</div><button class="btn-close" type="button" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                  <div class="row g-2">
                    <div class="col-12 col-md-6"><label class="form-label">管理員姓名 *</label><input name="name" class="form-control" required/></div>
                    <div class="col-12 col-md-6"><label class="form-label">Email *</label><input name="email" type="email" class="form-control" required/></div>
                    <div class="col-12 col-md-6"><label class="form-label">密碼 *</label><input name="pwd" type="password" class="form-control" required minlength="6"/></div>
                    <div class="col-12 col-md-6"><label class="form-label">確認密碼 *</label><input name="pwd2" type="password" class="form-control" required minlength="6"/></div>
                    <div class="col-12 col-md-6"><label class="form-label">權限等級</label><select name="role" class="form-select"><option>一般管理員</option><option>高級管理員</option></select></div>
                    <div class="col-12 col-md-6"><label class="form-label">聯絡電話</label><input name="phone" class="form-control"/></div>
                  </div>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" type="button" data-bs-dismiss="modal">取消</button><button class="btn btn-primary" type="submit">新增管理員</button></div>
              </form>
            </div>
          </div>`;
        APP.Util.modal(html, async(fd)=>{
          if (fd.get('pwd') !== fd.get('pwd2')) throw new Error('密碼與確認密碼不符');
          const r = await APP.API.get({
            action:'addAdmin', name: fd.get('name'), email: fd.get('email'),
            password: fd.get('pwd'), role: fd.get('role'), phone: fd.get('phone')
          });
          if (r?.success) APP.Util.toast('管理員新增成功','success');
          else throw new Error(r?.message || '新增失敗');
        });
      },
      logout(){
        APP.Util.toast('已登出管理後台','success');
        APP.Router.go('member');
      }
    }
  };

  // ========== 啟動 ==========
  window.addEventListener('DOMContentLoaded', async ()=>{
    // Router 初始化：若已有登入
    const stored = localStorage.getItem('memberInfo');
    if (stored) {
      APP.State.memberInfo = JSON.parse(stored);
      APP.State.isAdmin = !!APP.State.memberInfo?.isAdmin;
      APP.Router.go('member');
    } else {
      APP.Router.go('auth');
    }
    // 初始化 Auth
    APP.Auth.init();
  });

</script>
</body>
</html>
