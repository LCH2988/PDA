<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>å¸•é‡‘æ£®ç—…å‹æœƒæ•´åˆç³»çµ±</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root {
      --primary: #06c755;
      --primary-dark: #05b04b;
      --secondary: #00b900;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --border-radius: 12px;
      --purple-1: #667eea;
      --purple-2: #764ba2;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans TC',sans-serif; background: linear-gradient(135deg, var(--purple-1) 0%, var(--purple-2) 100%); min-height:100vh; }
    .hidden { display:none !important; }

    /* é ‚å±¤å®¹å™¨èˆ‡é é¢åˆ‡æ› */
    .root-container { max-width: 1200px; margin: 0 auto; }
    .view { display:none; }
    .view.active { display:block; }

    /* ====== è¡Œå‹•ç«¯ LIFF ç—…å‹æœƒ App é¢¨æ ¼ ====== */
    .app-container {
      max-width: 480px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      padding-bottom: 80px;
      box-shadow: 0 0 30px rgba(0,0,0,0.1);
    }
    .top-bar {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white; padding: 15px 20px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 10px rgba(0,0,0,0.1);
    }
    .top-bar h1{ font-size:18px; font-weight:600; margin:0; }
    .user-info{ display:flex; align-items:center; gap:10px; }
    .user-avatar{ width:36px; height:36px; border-radius:50%; border:2px solid #fff; }
    .user-name{ font-size:14px; font-weight:500; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; right:0; background:white; border-top:1px solid #e0e0e0; display:flex; justify-content:space-around; padding: 8px 0; box-shadow:0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; max-width:480px; margin:0 auto; }
    .nav-item{ flex:1; display:flex; flex-direction:column; align-items:center; gap:4px; padding:8px; color:#666; cursor:pointer; border:none; background:none; transition:all 0.3s; }
    .nav-item i{ font-size:22px; }
    .nav-item span{ font-size:11px; }
    .nav-item.active, .nav-item:hover{ color: var(--primary); background: rgba(6, 199, 85, 0.05); }

    .page-content { display:none; padding:20px; animation: fadeIn 0.3s; }
    .page-content.active { display:block; }
    @keyframes fadeIn { from{ opacity:0; transform: translateY(10px); } to{ opacity:1; transform: translateY(0); } }

    .card{ border:none; border-radius:var(--border-radius); box-shadow:0 2px 8px rgba(0,0,0,0.08); margin-bottom:20px; overflow:hidden; background:#fff; }
    .card-header{ background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color:white; font-weight:600; padding:15px 20px; border:none; }
    .card-body{ padding:20px; }

    .stats-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:15px; margin-bottom:20px; }
    .stat-card{ background:white; border-radius:var(--border-radius); padding:20px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s;}
    .stat-card:hover{ transform: translateY(-5px); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
    .stat-icon{ font-size:32px; margin-bottom:10px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; }
    .stat-value{ font-size:28px; font-weight:700; color:var(--dark); margin:5px 0; }
    .stat-label{ font-size:13px; color:#666; }

    .activity-item{ background:white; border-radius:var(--border-radius); padding:15px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; }
    .activity-item:hover{ transform: translateY(-3px); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
    .activity-title{ font-size:16px; font-weight:600; color:var(--dark); margin-bottom:8px; }
    .activity-info{ font-size:14px; color:#666; margin-bottom:10px; }
    .activity-meta{ display:flex; flex-wrap:wrap; gap:10px; font-size:13px; color:#888; }
    .activity-meta span{ display:flex; align-items:center; gap:4px; }
    .status-badge{ display:inline-block; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:500; }
    .status-é–‹æ”¾å ±å,.status-å·²å ±å,.status-å·²å®Œæˆ,.status-å·²ææ¬¾,.status-å·²æ ¸å‡†{ background:#d4edda; color:#155724; }
    .status-å·²é¡æ»¿,.status-å·²å–æ¶ˆ,.status-å·²æ‹’çµ•{ background:#f8d7da; color:#721c24; }
    .status-å·²çµæŸ{ background:#e2e3e5; color:#383d41; }
    .status-å¯©æ ¸ä¸­,.status-å¾…ä»˜æ¬¾{ background:#fff3cd; color:#856404; }

    .btn-gradient{ background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color:white; border:none; padding:12px 24px; border-radius:25px; font-weight:600; transition:all 0.3s; box-shadow:0 4px 10px rgba(6,199,85,0.3); }
    .btn-gradient:hover{ transform: translateY(-2px); box-shadow:0 6px 15px rgba(6,199,85,0.4); color:white; }
    .btn-outline-primary{ border:2px solid var(--primary); color: var(--primary); }
    .btn-outline-primary:hover{ background: var(--primary); color:white; }

    .empty-state{ text-align:center; padding:40px 20px; color:#999; }
    .empty-state i{ font-size:48px; margin-bottom:15px; opacity:0.5; }
    .loading-overlay{ position:fixed; inset:0; background: rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:9999; }
    .loading-overlay.show{ display:flex; }
    .loading-spinner{ width:50px; height:50px; border:4px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to{ transform: rotate(360deg);} }
    .toast-container{ position: fixed; top:20px; right:20px; z-index:9999; }

    .admin-only{ display:none; }
    .table-responsive{ border-radius: var(--border-radius); overflow:hidden; }
    .table thead{ background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color:white; }
    .table tbody tr:hover{ background: rgba(6,199,85,0.05); }

    @media (max-width:480px){
      .stats-grid{ grid-template-columns:1fr; }
      .activity-meta{ flex-direction:column; gap:5px; }
    }

    /* ====== ç™»å…¥/è¨»å†Šå…¥å£é ï¼ˆåˆä½µç¬¬äºŒæ®µé¢¨æ ¼ï¼‰ ====== */
    .auth-container {
      background:white; border-radius:20px; padding:40px; max-width:420px; width:100%;
      box-shadow:0 20px 60px rgba(0,0,0,0.3); margin: 40px auto;
    }
    .auth-logo { text-align:center; margin-bottom: 20px; }
    .auth-logo h1{ color: var(--purple-1); font-size: 28px; margin-bottom: 10px; }
    .auth-tabs{ display:flex; margin-bottom:20px; border-bottom: 2px solid #f0f0f0; }
    .auth-tab{ flex:1; padding:12px; text-align:center; cursor:pointer; color:#999; font-weight:500; transition:.2s; }
    .auth-tab.active{ color: var(--purple-1); border-bottom: 3px solid var(--purple-1); margin-bottom: -2px; }
    .auth-pane{ display:none; }
    .auth-pane.active{ display:block; }

    /* ====== ç®¡ç†å¾Œå°ï¼ˆåˆä½µç¬¬ä¸‰æ®µé¢¨æ ¼ï¼‰ ====== */
    .admin-root { display:flex; min-height:100vh; background:#f5f7fa; }
    .sidebar { width:250px; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color:white; position:sticky; top:0; height:100vh; overflow-y:auto; transition:.3s; }
    .sidebar.collapsed{ width:60px; }
    .sidebar-header{ padding:20px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:space-between; }
    .sidebar-title{ font-size:18px; font-weight:600; }
    .toggle-btn{ background:none; border:none; color:white; font-size:20px; cursor:pointer; padding:5px; }
    .sidebar-menu{ padding: 20px 0; }
    .menu-item{ display:flex; align-items:center; padding:15px 20px; color: rgba(255,255,255,0.85); cursor:pointer; transition:.2s; }
    .menu-item:hover, .menu-item.active{ background: rgba(255,255,255,0.1); color:#fff; }
    .menu-item .icon{ margin-right: 15px; width: 20px; text-align:center; }
    .main-admin{ flex:1; }
    .top-bar-admin{ background:white; padding: 12px 20px; box-shadow:0 2px 4px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:5; }
    .content-admin{ padding:20px; }
    .admin-section{ display:none; }
    .admin-section.active{ display:block; }
    .badge{ padding: 4px 12px; border-radius: 12px; font-size:12px; }
    .badge-success{ background:#d4edda; color:#155724; }
    .badge-warning{ background:#fff3cd; color:#856404; }
    .badge-danger{ background:#f8d7da; color:#721c24; }
    .badge-info{ background:#d1ecf1; color:#0c5460; }
    .badge-secondary{ background:#e2e3e5; color:#383d41; }

    /* ====== æœƒå“¡ä¸­å¿ƒï¼ˆåˆä½µç¬¬å››æ®µé¢¨æ ¼ï¼‰ ====== */
    .member-center { background:#f5f7fa; min-height:100vh; }
    .member-header{ background: linear-gradient(135deg, var(--purple-1) 0%, var(--purple-2) 100%); color:white; padding:16px; position:sticky; top:0; z-index:2; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    .member-user{ display:flex; align-items:center; gap:12px; }
    .member-avatar{ width:48px; height:48px; border-radius:50%; background:white; color: var(--purple-1); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:20px;}
    .member-content{ padding:16px; max-width: 900px; margin:0 auto; }
    .member-section{ display:none; }
    .member-section.active{ display:block; }

    /* é€šç”¨ Modal å®¹å™¨ */
    #modalContainer .modal .modal-dialog { max-width: 720px; }
  </style>
</head>
<body>

  <div class="root-container">

    <!-- ========== Router è¦–åœ–ï¼šæœªç™»å…¥ï¼ˆç™»å…¥/è¨»å†Šå…¥å£ + API è¨­å®š + æ¸¬è©¦ï¼‰ ========== -->
    <div id="view-auth" class="view">
      <div class="auth-container">
        <div class="auth-logo">
          <h1>ğŸŒŸ å¸•é‡‘æ£®å”æœƒ</h1>
          <p>çµ±ä¸€ç™»å…¥å…¥å£</p>
        </div>

        <div class="mb-3 p-3 rounded" style="background:#fff3cd;border:2px solid #ffc107;">
          <div class="mb-2 fw-bold" style="color:#856404;">âš™ï¸ API è¨­å®šï¼ˆå¯æ›´æ–°ç‚ºä½ è‡ªå·±çš„ Google Apps Script URLï¼‰</div>
          <input type="text" id="global-api-url" class="form-control form-control-sm mb-2" placeholder="è²¼ä¸Š Google Apps Script éƒ¨ç½²ç¶²å€">
          <button class="btn btn-warning w-100 btn-sm" onclick="APP.Config.updateAPIUrl()">æ›´æ–° API ç¶²å€</button>
          <div class="form-text">ç›®å‰ï¼š<span id="current-api-url" class="text-muted"></span></div>
        </div>

        <div class="auth-tabs">
          <div class="auth-tab active" data-pane="pane-login">ç™»å…¥</div>
          <div class="auth-tab" data-pane="pane-register">è¨»å†Š</div>
        </div>

        <div id="auth-alert" class="alert d-none"></div>
        <div id="auth-loading" class="text-center d-none">
          <div class="spinner-border text-primary"></div>
          <div class="small text-muted mt-2">è™•ç†ä¸­...</div>
        </div>

        <div id="pane-login" class="auth-pane active">
          <form onsubmit="APP.Auth.handleEmailLogin(event)">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" id="login-email" class="form-control" required placeholder="example@email.com"/>
            </div>
            <div class="mb-3">
              <label class="form-label">å¯†ç¢¼</label>
              <input type="password" id="login-password" class="form-control" required placeholder="è«‹è¼¸å…¥å¯†ç¢¼"/>
            </div>
            <button type="submit" class="btn btn-primary w-100">ç™»å…¥</button>
          </form>
          <div class="text-center my-3 text-muted">æˆ–</div>
          <button class="btn btn-success w-100" onclick="APP.Auth.handleLineLogin()">
            <i class="bi bi-line"></i> ä½¿ç”¨ LINE å¿«é€Ÿç™»å…¥
          </button>

          <div class="mt-3 d-flex gap-2">
            <button class="btn btn-secondary flex-fill btn-sm" onclick="APP.Auth.testAPIConnection()">æ¸¬è©¦ API é€£ç·š</button>
            <button class="btn btn-outline-secondary flex-fill btn-sm" onclick="APP.Auth.clearDebug()">æ¸…é™¤é™¤éŒ¯</button>
          </div>
          <div class="mt-3 small text-muted" id="auth-debug"></div>
        </div>

        <div id="pane-register" class="auth-pane">
          <form onsubmit="APP.Auth.handleRegister(event)">
            <div class="mb-3">
              <label class="form-label">å§“å *</label>
              <input type="text" id="reg-name" class="form-control" required placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å"/>
            </div>
            <div class="mb-3">
              <label class="form-label">æ€§åˆ¥ *</label>
              <select id="reg-gender" class="form-select" required>
                <option value="">è«‹é¸æ“‡</option>
                <option>ç”·</option>
                <option>å¥³</option>
                <option>å…¶ä»–</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">ç”Ÿæ—¥ *</label>
              <input type="date" id="reg-birthday" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">æ‰‹æ©Ÿ *</label>
              <input type="tel" id="reg-phone" class="form-control" required placeholder="0912-345-678"/>
            </div>
            <div class="mb-3">
              <label class="form-label">Email *</label>
              <input type="email" id="reg-email" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">å¯†ç¢¼ *</label>
              <input type="password" id="reg-password" class="form-control" required minlength="8" placeholder="è‡³å°‘ 8 å€‹å­—å…ƒ"/>
            </div>
            <div class="mb-3">
              <label class="form-label">ç¢ºèªå¯†ç¢¼ *</label>
              <input type="password" id="reg-password-confirm" class="form-control" required minlength="8"/>
            </div>
            <button type="submit" class="btn btn-primary w-100">è¨»å†Š</button>
          </form>
        </div>
      </div>
    </div>

    <!-- ========== Router è¦–åœ–ï¼šè¡Œå‹•ç«¯ç—…å‹æœƒ LIFF Appï¼ˆç¬¬ä¸€æ®µï¼‰ + æœƒå“¡ä¸­å¿ƒï¼ˆç¬¬å››æ®µï¼‰ ========== -->
    <div id="view-member" class="view">
      <div class="row g-3" style="margin: 0;">
        <!-- å·¦å´ï¼šè¡Œå‹•ç«¯ LIFF App -->
        <div class="col-12 col-lg-5 d-flex">
          <div class="app-container w-100">
            <div class="top-bar">
              <h1><i class="bi bi-heart-pulse me-2"></i>å¸•é‡‘æ£®ç—…å‹æœƒ</h1>
              <div class="user-info">
                <img id="appUserAvatar" class="user-avatar" src="https://via.placeholder.com/36" alt="é ­åƒ" />
                <span id="appUserName" class="user-name">è¼‰å…¥ä¸­...</span>
              </div>
            </div>

            <!-- App é é¢å…§å®¹ -->
            <div id="app-page-home" class="page-content active">
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-calendar-event"></i></div>
                  <div class="stat-value" id="statActivities">0</div>
                  <div class="stat-label">æ´»å‹•ç¸½æ•¸</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                  <div class="stat-value" id="statRegistrations">0</div>
                  <div class="stat-label">æˆ‘çš„å ±å</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
                  <div class="stat-value" id="statVolunteerHours">0</div>
                  <div class="stat-label">å¿—å·¥æ™‚æ•¸</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-heart"></i></div>
                  <div class="stat-value" id="statDonations">$0</div>
                  <div class="stat-label">ææ¬¾é‡‘é¡</div>
                </div>
              </div>

              <div class="card">
                <div class="card-header"><i class="bi bi-calendar-event me-2"></i>æœ€æ–°æ´»å‹•</div>
                <div class="card-body" id="recentActivities">
                  <div class="empty-state">
                    <i class="bi bi-calendar-x"></i>
                    <p>è¼‰å…¥ä¸­...</p>
                  </div>
                </div>
              </div>
            </div>

            <div id="app-page-activities" class="page-content">
              <div class="card">
                <div class="card-header"><i class="bi bi-calendar-plus me-2"></i>é–‹æ”¾å ±å</div>
                <div class="card-body" id="activitiesList">
                  <div class="empty-state"><i class="bi bi-calendar-x"></i><p>è¼‰å…¥ä¸­...</p></div>
                </div>
              </div>
              <div class="card">
                <div class="card-header"><i class="bi bi-list-check me-2"></i>æˆ‘çš„å ±å</div>
                <div class="card-body" id="myRegistrationsList">
                  <div class="empty-state"><i class="bi bi-calendar-x"></i><p>è¼‰å…¥ä¸­...</p></div>
                </div>
              </div>
            </div>

            <div id="app-page-volunteer" class="page-content">
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
                  <div class="stat-value" id="volTotalHours">0</div>
                  <div class="stat-label">ç´¯è¨ˆæ™‚æ•¸</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
                  <div class="stat-value" id="volTotalActivities">0</div>
                  <div class="stat-label">æœå‹™æ¬¡æ•¸</div>
                </div>
              </div>
              <div class="card">
                <div class="card-header"><i class="bi bi-people me-2"></i>å¿—å·¥éœ€æ±‚</div>
                <div class="card-body" id="volunteerNeedsList">
                  <div class="empty-state"><i class="bi bi-people"></i><p>è¼‰å…¥ä¸­...</p></div>
                </div>
              </div>
              <div class="card">
                <div class="card-header"><i class="bi bi-journal-text me-2"></i>æˆ‘çš„è¨˜éŒ„</div>
                <div class="card-body" id="myVolunteerRecords">
                  <div class="empty-state"><i class="bi bi-journal-x"></i><p>è¼‰å…¥ä¸­...</p></div>
                </div>
              </div>
            </div>

            <div id="app-page-finance" class="page-content">
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-heart"></i></div>
                  <div class="stat-value" id="finTotalDonation">$0</div>
                  <div class="stat-label">ç´¯è¨ˆææ¬¾</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon"><i class="bi bi-receipt"></i></div>
                  <div class="stat-value" id="finPendingExpenses">0</div>
                  <div class="stat-label">å¾…å¯©æ ¸æ”¯å‡º</div>
                </div>
              </div>

              <div class="d-grid gap-2 mb-3">
                <button class="btn btn-gradient" onclick="APP.AppView.showDonationModal()">
                  <i class="bi bi-heart-fill me-2"></i>æˆ‘è¦ææ¬¾
                </button>
                <button class="btn btn-outline-primary" onclick="APP.AppView.showNewExpenseModal()">
                  <i class="bi bi-receipt me-2"></i>æ”¯å‡ºç”³è«‹
                </button>
              </div>

              <div class="card">
                <div class="card-header"><i class="bi bi-heart me-2"></i>æˆ‘çš„ææ¬¾</div>
                <div class="card-body" id="myDonationsList">
                  <div class="empty-state"><i class="bi bi-heart"></i><p>è¼‰å…¥ä¸­...</p></div>
                </div>
              </div>

              <div class="card">
                <div class="card-header"><i class="bi bi-receipt me-2"></i>æˆ‘çš„æ”¯å‡º</div>
                <div class="card-body" id="myExpensesList">
                  <div class="empty-state"><i class="bi bi-receipt"></i><p>è¼‰å…¥ä¸­...</p></div>
                </div>
              </div>
            </div>

            <div id="app-page-profile" class="page-content">
              <div class="card">
                <div class="card-header"><i class="bi bi-person me-2"></i>å€‹äººè³‡æ–™</div>
                <div class="card-body">
                  <form id="profileForm">
                    <div class="form-floating mb-3">
                      <input type="text" class="form-control" name="realName" required>
                      <label>çœŸå¯¦å§“å *</label>
                    </div>
                    <div class="form-floating mb-3">
                      <select class="form-select" name="memberType" required>
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="ç—…å‹">ç—…å‹</option>
                        <option value="å®¶å±¬">å®¶å±¬</option>
                        <option value="å¿—å·¥">å¿—å·¥</option>
                      </select>
                      <label>æœƒå“¡é¡å‹ *</label>
                    </div>
                    <div class="form-floating mb-3">
                      <input type="tel" class="form-control" name="phone">
                      <label>è¯çµ¡é›»è©±</label>
                    </div>
                    <div class="form-floating mb-3">
                      <input type="email" class="form-control" name="email">
                      <label>é›»å­éƒµä»¶</label>
                    </div>
                    <div class="form-floating mb-3">
                      <input type="date" class="form-control" name="birthday">
                      <label>ç”Ÿæ—¥</label>
                    </div>
                    <div class="form-floating mb-3">
                      <input type="date" class="form-control" name="diagnosisDate">
                      <label>ç¢ºè¨ºæ—¥æœŸ</label>
                    </div>
                    <div class="form-floating mb-3">
                      <textarea class="form-control" name="address" style="height:80px;"></textarea>
                      <label>åœ°å€</label>
                    </div>
                    <div class="d-grid">
                      <button type="submit" class="btn btn-gradient">
                        <i class="bi bi-save me-2"></i>å„²å­˜è®Šæ›´
                      </button>
                    </div>
                  </form>
                </div>
              </div>

              <div class="card">
                <div class="card-header"><i class="bi bi-file-earmark-text me-2"></i>æˆ‘çš„æ”¶æ“š</div>
                <div class="card-body" id="myReceiptsList">
                  <div class="empty-state">
                    <i class="bi bi-file-earmark-text"></i>
                    <p>è¼‰å…¥ä¸­...</p>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card-header"><i class="bi bi-info-circle me-2"></i>æœƒå“¡è³‡è¨Š</div>
                <div class="card-body">
                  <p><strong>æœƒå“¡é¡å‹ï¼š</strong><span id="appUserMemberType">-</span></p>
                  <p><strong>LINE IDï¼š</strong><span id="appUserLineId">-</span></p>
                  <p class="mb-0"><strong>ç‰ˆæœ¬ï¼š</strong>v2.1.0ï¼ˆæ•´åˆç‰ˆï¼‰</p>
                </div>
              </div>
            </div>

            <div id="app-page-admin" class="page-content admin-only">
              <div class="card">
                <div class="card-header"><i class="bi bi-gear me-2"></i>ç®¡ç†åŠŸèƒ½å…¥å£</div>
                <div class="card-body">
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="APP.Router.goAdmin()">é€²å…¥ç®¡ç†å¾Œå°</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="bottom-nav">
              <button class="nav-item active" data-app-page="home">
                <i class="bi bi-house-door-fill"></i>
                <span>é¦–é </span>
              </button>
              <button class="nav-item" data-app-page="activities">
                <i class="bi bi-calendar-event"></i>
                <span>æ´»å‹•</span>
              </button>
              <button class="nav-item" data-app-page="volunteer">
                <i class="bi bi-people"></i>
                <span>å¿—å·¥</span>
              </button>
              <button class="nav-item" data-app-page="finance">
                <i class="bi bi-wallet2"></i>
                <span>è²¡å‹™</span>
              </button>
              <button class="nav-item" data-app-page="profile">
                <i class="bi bi-person"></i>
                <span>æˆ‘çš„</span>
              </button>
              <button class="nav-item admin-only" data-app-page="admin">
                <i class="bi bi-gear"></i>
                <span>ç®¡ç†</span>
              </button>
            </div>
          </div>
        </div>

        <!-- å³å´ï¼šæœƒå“¡ä¸­å¿ƒ -->
        <div class="col-12 col-lg-7 d-flex">
          <div class="member-center w-100">
            <div class="member-header">
              <div class="member-user">
                <div class="member-avatar" id="mc-avatar">A</div>
                <div>
                  <div id="mc-name" style="font-weight:600;">è¼‰å…¥ä¸­...</div>
                  <div id="mc-no" class="small">æœƒå“¡ç·¨è™Ÿï¼š---</div>
                </div>
              </div>
            </div>

            <div class="member-content">
              <!-- æœƒå“¡ä¸­å¿ƒé¦–é  -->
              <div id="mc-home" class="member-section active">
                <div class="row g-2">
                  <div class="col-6 col-md-3">
                    <div class="card text-center p-3">
                      <div class="fw-bold">ç—‡ç‹€</div>
                      <button class="btn btn-sm btn-primary mt-2" onclick="APP.Member.show('symptom')">é–‹å•Ÿ</button>
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="card text-center p-3">
                      <div class="fw-bold">ç”¨è—¥</div>
                      <button class="btn btn-sm btn-primary mt-2" onclick="APP.Member.show('medication')">é–‹å•Ÿ</button>
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="card text-center p-3">
                      <div class="fw-bold">é‹å‹•</div>
                      <button class="btn btn-sm btn-primary mt-2" onclick="APP.Member.show('exercise')">é–‹å•Ÿ</button>
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="card text-center p-3">
                      <div class="fw-bold">æƒ…ç·’</div>
                      <button class="btn btn-sm btn-primary mt-2" onclick="APP.Member.show('mood')">é–‹å•Ÿ</button>
                    </div>
                  </div>
                </div>

                <div class="card mt-3">
                  <div class="card-header d-flex justify-content-between">
                    <div class="fw-bold">ğŸ“‹ ä»Šæ—¥æé†’</div>
                    <button class="btn btn-sm btn-outline-primary" onclick="APP.Member.show('medication')">å»ç”¨è—¥</button>
                  </div>
                  <div class="card-body" id="mc-today-reminders">
                    <div class="text-center text-muted py-4">
                      <div class="spinner-border text-primary"></div>
                      <div class="small mt-2">è¼‰å…¥ä¸­...</div>
                    </div>
                  </div>
                </div>

                <div class="card mt-3">
                  <div class="card-header d-flex justify-content-between">
                    <div class="fw-bold">ğŸ“… è¿‘æœŸæ´»å‹•</div>
                    <button class="btn btn-sm btn-outline-primary" onclick="APP.Member.show('events')">æŸ¥çœ‹å…¨éƒ¨</button>
                  </div>
                  <div class="card-body" id="mc-upcoming-events">
                    <div class="text-center text-muted py-4">
                      <div class="spinner-border text-primary"></div>
                      <div class="small mt-2">è¼‰å…¥ä¸­...</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ç—‡ç‹€ -->
              <div id="mc-symptom" class="member-section">
                <div class="card">
                  <div class="card-header"><div class="fw-bold">æ–°å¢ç—‡ç‹€è¨˜éŒ„</div></div>
                  <div class="card-body">
                    <form onsubmit="APP.Member.addSymptom(event)">
                      <div class="mb-3">
                        <label class="form-label">é¡«æŠ–ç¨‹åº¦ (0-10)</label>
                        <input type="range" id="mc-tremor" min="0" max="10" value="5" class="form-range"/>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">åƒµç¡¬ç¨‹åº¦ (0-10)</label>
                        <input type="range" id="mc-rigidity" min="0" max="10" value="5" class="form-range"/>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">å‹•ä½œé²ç·© (0-10)</label>
                        <input type="range" id="mc-brady" min="0" max="10" value="5" class="form-range"/>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">å¹³è¡¡å•é¡Œ (0-10)</label>
                        <input type="range" id="mc-balance" min="0" max="10" value="5" class="form-range"/>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">å‚™è¨»</label>
                        <textarea id="mc-symptom-notes" class="form-control" rows="3"></textarea>
                      </div>
                      <button class="btn btn-primary w-100">å„²å­˜è¨˜éŒ„</button>
                    </form>
                  </div>
                </div>
                <div class="card mt-3">
                  <div class="card-header"><div class="fw-bold">æ­·å²è¨˜éŒ„</div></div>
                  <div class="card-body" id="mc-symptom-history">
                    <div class="text-center text-muted py-4">å°šç„¡è¨˜éŒ„</div>
                  </div>
                </div>
              </div>

              <!-- ç”¨è—¥ -->
              <div id="mc-medication" class="member-section">
                <div class="card">
                  <div class="card-header d-flex justify-content-between">
                    <div class="fw-bold">æˆ‘çš„ç”¨è—¥</div>
                    <button class="btn btn-sm btn-primary" onclick="APP.Member.openAddMedication()">+ æ–°å¢</button>
                  </div>
                  <div class="card-body" id="mc-medication-list">
                    <div class="text-center text-muted py-4">
                      <div class="spinner-border text-primary"></div>
                      <div class="small mt-2">è¼‰å…¥ä¸­...</div>
                    </div>
                  </div>
                </div>
                <div class="card mt-3">
                  <div class="card-header"><div class="fw-bold">ä»Šæ—¥ç”¨è—¥è¨˜éŒ„</div></div>
                  <div class="card-body" id="mc-medication-today">
                    <div class="text-center text-muted py-4">å°šç„¡è³‡æ–™æˆ–åŠŸèƒ½é–‹ç™¼ä¸­</div>
                  </div>
                </div>
              </div>

              <!-- é‹å‹• -->
              <div id="mc-exercise" class="member-section">
                <div class="card">
                  <div class="card-header"><div class="fw-bold">æ–°å¢é‹å‹•è¨˜éŒ„</div></div>
                  <div class="card-body">
                    <form onsubmit="APP.Member.addExercise(event)">
                      <div class="mb-3">
                        <label class="form-label">é‹å‹•é¡å‹ *</label>
                        <select id="mc-ex-type" class="form-select" required>
                          <option value="">è«‹é¸æ“‡</option>
                          <option>æ•£æ­¥</option><option>å¤ªæ¥µ</option><option>ç‘œçˆ</option><option>æ¸¸æ³³</option><option>é¨è…³è¸è»Š</option><option>å¾©å¥é‹å‹•</option><option>å…¶ä»–</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">é‹å‹•æ™‚é–“ï¼ˆåˆ†é˜ï¼‰*</label>
                        <input type="number" id="mc-ex-duration" class="form-control" required min="1"/>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">é‹å‹•å¼·åº¦ *</label>
                        <select id="mc-ex-intensity" class="form-select" required>
                          <option value="">è«‹é¸æ“‡</option>
                          <option>è¼•åº¦</option><option>ä¸­åº¦</option><option>é«˜å¼·åº¦</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">èº«é«”ç‹€æ³ *</label>
                        <select id="mc-ex-condition" class="form-select" required>
                          <option value="">è«‹é¸æ“‡</option>
                          <option>è‰¯å¥½</option><option>æ™®é€š</option><option>ç–²ç´¯</option><option>ä¸é©</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">å‚™è¨»</label>
                        <textarea id="mc-ex-notes" class="form-control" rows="3"></textarea>
                      </div>
                      <button class="btn btn-primary w-100">å„²å­˜è¨˜éŒ„</button>
                    </form>
                  </div>
                </div>
              </div>

              <!-- ç¡çœ  -->
              <div id="mc-sleep" class="member-section">
                <div class="card">
                  <div class="card-header"><div class="fw-bold">æ–°å¢ç¡çœ è¨˜éŒ„</div></div>
                  <div class="card-body">
                    <form onsubmit="APP.Member.addSleep(event)">
                      <div class="mb-3">
                        <label class="form-label">å°±å¯¢æ™‚é–“ *</label>
                        <input type="time" id="mc-sleep-bed" class="form-control" required />
                      </div>
                      <div class="mb-3">
                        <label class="form-label">èµ·åºŠæ™‚é–“ *</label>
                        <input type="time" id="mc-sleep-wake" class="form-control" required />
                      </div>
                      <div class="mb-3">
                        <label class="form-label">ç¡çœ å“è³ª *</label>
                        <select id="mc-sleep-quality" class="form-select" required>
                          <option value="">è«‹é¸æ“‡</option>
                          <option>å¾ˆå¥½</option><option>å¥½</option><option>æ™®é€š</option><option>å·®</option><option>å¾ˆå·®</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">å¤œé–“é†’ä¾†æ¬¡æ•¸</label>
                        <input type="number" id="mc-sleep-wakecount" class="form-control" min="0" value="0" />
                      </div>
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="mc-sleep-dream"/>
                        <label class="form-check-label" for="mc-sleep-dream">æœ‰åšå¤¢</label>
                      </div>
                      <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="mc-sleep-nightmare"/>
                        <label class="form-check-label" for="mc-sleep-nightmare">æœ‰æƒ¡å¤¢</label>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">å‚™è¨»</label>
                        <textarea id="mc-sleep-notes" class="form-control" rows="3"></textarea>
                      </div>
                      <button class="btn btn-primary w-100">å„²å­˜è¨˜éŒ„</button>
                    </form>
                  </div>
                </div>
              </div>

              <!-- æƒ…ç·’ -->
              <div id="mc-mood" class="member-section">
                <div class="card">
                  <div class="card-header"><div class="fw-bold">ä»Šå¤©çš„å¿ƒæƒ…</div></div>
                  <div class="card-body">
                    <form onsubmit="APP.Member.addMood(event)">
                      <div class="mb-3">
                        <div class="d-flex justify-content-between">
                          <button type="button" class="btn btn-outline-secondary" onclick="APP.Member.selectMood(1)">ğŸ˜¢</button>
                          <button type="button" class="btn btn-outline-secondary" onclick="APP.Member.selectMood(3)">ğŸ˜•</button>
                          <button type="button" class="btn btn-outline-secondary" onclick="APP.Member.selectMood(5)">ğŸ˜</button>
                          <button type="button" class="btn btn-outline-secondary" onclick="APP.Member.selectMood(7)">ğŸ™‚</button>
                          <button type="button" class="btn btn-outline-secondary" onclick="APP.Member.selectMood(10)">ğŸ˜„</button>
                        </div>
                        <input type="hidden" id="mc-mood-score" value="5"/>
                      </div>
                      <div class="mb-3">
                        <div class="mb-2 small text-muted">å¿ƒæƒ…æ¨™ç±¤ï¼ˆé»é¸åˆ‡æ›ï¼‰</div>
                        <div id="mc-mood-tags" class="d-flex flex-wrap gap-2">
                          <span class="badge bg-secondary" data-tag="é–‹å¿ƒ" onclick="APP.Member.toggleTag(this)">é–‹å¿ƒ</span>
                          <span class="badge bg-secondary" data-tag="ç„¦æ…®" onclick="APP.Member.toggleTag(this)">ç„¦æ…®</span>
                          <span class="badge bg-secondary" data-tag="ç–²ç´¯" onclick="APP.Member.toggleTag(this)">ç–²ç´¯</span>
                          <span class="badge bg-secondary" data-tag="å¹³éœ" onclick="APP.Member.toggleTag(this)">å¹³éœ</span>
                          <span class="badge bg-secondary" data-tag="æ²®å–ª" onclick="APP.Member.toggleTag(this)">æ²®å–ª</span>
                          <span class="badge bg-secondary" data-tag="å……æ»¿æ´»åŠ›" onclick="APP.Member.toggleTag(this)">å……æ»¿æ´»åŠ›</span>
                        </div>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">å¿ƒæƒ…æ—¥è¨˜</label>
                        <textarea id="mc-mood-content" class="form-control" rows="4" placeholder="å¯«ä¸‹ä»Šå¤©çš„å¿ƒæƒ…..."></textarea>
                      </div>
                      <button class="btn btn-primary w-100">å„²å­˜æ—¥è¨˜</button>
                    </form>
                  </div>
                </div>
              </div>

              <!-- æ´»å‹• -->
              <div id="mc-events" class="member-section">
                <div class="card">
                  <div class="card-header"><div class="fw-bold">å¯å ±åæ´»å‹•</div></div>
                  <div class="card-body" id="mc-events-list">
                    <div class="text-center text-muted py-4">
                      <div class="spinner-border text-primary"></div>
                      <div class="small mt-2">è¼‰å…¥ä¸­...</div>
                    </div>
                  </div>
                </div>
                <div class="card mt-3">
                  <div class="card-header"><div class="fw-bold">æˆ‘çš„å ±å</div></div>
                  <div class="card-body" id="mc-my-events">
                    <div class="text-center text-muted py-4">
                      <div class="spinner-border text-primary"></div>
                      <div class="small mt-2">è¼‰å…¥ä¸­...</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- å€‹äºº -->
              <div id="mc-profile" class="member-section">
                <div class="card">
                  <div class="card-header d-flex justify-content-between">
                    <div class="fw-bold">å€‹äººè³‡æ–™</div>
                    <button class="btn btn-sm btn-outline-primary" onclick="APP.Member.loadProfile()">é‡æ–°è¼‰å…¥</button>
                  </div>
                  <div class="card-body" id="mc-profile-info">
                    <div class="text-center text-muted py-4">
                      <div class="spinner-border text-primary"></div>
                      <div class="small mt-2">è¼‰å…¥ä¸­...</div>
                    </div>
                  </div>
                </div>
                <div class="card mt-3">
                  <div class="card-header"><div class="fw-bold">ææ¬¾è¨˜éŒ„</div></div>
                  <div class="card-body" id="mc-donation-history">
                    <div class="text-center text-muted py-4">å°šç„¡ææ¬¾è¨˜éŒ„</div>
                  </div>
                </div>

                <div class="d-grid gap-2 mt-2">
                  <button class="btn btn-danger" onclick="APP.Auth.logout()">ç™»å‡º</button>
                  <button id="btn-enter-admin" class="btn btn-outline-secondary admin-only" onclick="APP.Router.goAdmin()">é€²å…¥ç®¡ç†å¾Œå°</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ========== Router è¦–åœ–ï¼šç®¡ç†å¾Œå°ï¼ˆç¬¬ä¸‰æ®µï¼‰ ========== -->
    <div id="view-admin" class="view">
      <div class="admin-root">
        <div class="sidebar" id="admin-sidebar">
          <div class="sidebar-header">
            <div class="sidebar-title">ğŸŒŸ ç®¡ç†å¾Œå°</div>
            <button class="toggle-btn" onclick="APP.Admin.toggleSidebar()">â˜°</button>
          </div>
          <nav class="sidebar-menu" id="admin-menu">
            <div class="menu-item active" data-admin-section="dashboard"><span class="icon">ğŸ“Š</span><span>ç¸½è¦½</span></div>
            <div class="menu-item" data-admin-section="members"><span class="icon">ğŸ‘¥</span><span>æœƒå“¡ç®¡ç†</span></div>
            <div class="menu-item" data-admin-section="events"><span class="icon">ğŸ¯</span><span>æ´»å‹•ç®¡ç†</span></div>
            <div class="menu-item" data-admin-section="health"><span class="icon">ğŸ“‹</span><span>å¥åº·è¨˜éŒ„</span></div>
            <div class="menu-item" data-admin-section="donations"><span class="icon">ğŸ’°</span><span>ææ¬¾ç®¡ç†</span></div>
            <div class="menu-item" data-admin-section="reports"><span class="icon">ğŸ“ˆ</span><span>çµ±è¨ˆå ±è¡¨</span></div>
            <div class="menu-item" data-admin-section="settings"><span class="icon">âš™ï¸</span><span>ç³»çµ±è¨­å®š</span></div>
          </nav>
        </div>
        <div class="main-admin">
          <div class="top-bar-admin">
            <h5 class="m-0" id="admin-page-title">ç³»çµ±ç¸½è¦½</h5>
            <div class="d-flex align-items-center gap-2">
              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:36px;height:36px;" id="admin-avatar">A</div>
              <span id="admin-name">ç®¡ç†å“¡</span>
              <button class="btn btn-sm btn-danger ms-2" onclick="APP.Admin.logout()">ç™»å‡º</button>
            </div>
          </div>
          <div class="content-admin">
            <div id="admin-alert" class="alert d-none"></div>
            <div id="admin-loading" class="text-center d-none"><div class="spinner-border text-primary"></div><div class="small text-muted mt-2">è¼‰å…¥ä¸­...</div></div>

            <!-- ç¸½è¦½ -->
            <div class="admin-section active" id="admin-dashboard">
              <div class="row g-3">
                <div class="col-12 col-sm-6 col-lg-3">
                  <div class="card p-3 text-center">
                    <div class="fs-4">ğŸ‘¥</div>
                    <div class="fs-3 fw-bold" id="adm-total-members">-</div>
                    <div class="text-muted small">ç¸½æœƒå“¡æ•¸</div>
                  </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                  <div class="card p-3 text-center">
                    <div class="fs-4">âœ…</div>
                    <div class="fs-3 fw-bold" id="adm-active-members">-</div>
                    <div class="text-muted small">æ´»èºæœƒå“¡</div>
                  </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                  <div class="card p-3 text-center">
                    <div class="fs-4">ğŸ¯</div>
                    <div class="fs-3 fw-bold" id="adm-total-events">-</div>
                    <div class="text-muted small">ç¸½æ´»å‹•æ•¸</div>
                  </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                  <div class="card p-3 text-center">
                    <div class="fs-4">ğŸ’°</div>
                    <div class="fs-6 fw-bold" id="adm-total-donations">-</div>
                    <div class="text-muted small">ç¸½ææ¬¾é‡‘é¡</div>
                  </div>
                </div>
              </div>
              <div class="card mt-3">
                <div class="card-header fw-bold">ğŸ”” æœ€æ–°å‹•æ…‹</div>
                <div class="card-body" id="adm-recent-activities">
                  <div class="text-center text-muted py-4">
                    <div class="spinner-border text-primary"></div>
                    <div class="small mt-2">è¼‰å…¥æœ€æ–°å‹•æ…‹...</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- æœƒå“¡ç®¡ç† -->
            <div class="admin-section" id="admin-members">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div class="fw-bold">ğŸ‘¥ æœƒå“¡ç®¡ç†</div>
                  <button class="btn btn-primary btn-sm" onclick="APP.Admin.showAddMember()">æ–°å¢æœƒå“¡</button>
                </div>
                <div class="card-body">
                  <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-6">
                      <label class="form-label">æœå°‹</label>
                      <input class="form-control" id="adm-member-search" placeholder="å§“å / Email / é›»è©±"/>
                    </div>
                    <div class="col-6 col-md-3">
                      <label class="form-label">ç‹€æ…‹</label>
                      <select class="form-select" id="adm-member-status">
                        <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                        <option>å·²å¯©æ ¸</option><option>å¾…å¯©æ ¸</option><option>å·²åœç”¨</option>
                      </select>
                    </div>
                    <div class="col-6 col-md-3 d-flex gap-2">
                      <button class="btn btn-primary w-100" onclick="APP.Admin.loadMembers(1)">æœå°‹</button>
                      <button class="btn btn-warning w-100" onclick="APP.Admin.exportMembers()">åŒ¯å‡º</button>
                    </div>
                  </div>
                  <div class="table-responsive mt-3">
                    <table class="table table-hover table-sm">
                      <thead><tr><th>æœƒå“¡ç·¨è™Ÿ</th><th>å§“å</th><th>Email</th><th>é›»è©±</th><th>è¨»å†Šæ—¥æœŸ</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
                      <tbody id="adm-members-body"><tr><td colspan="7" class="text-center py-4 text-muted">è¼‰å…¥ä¸­...</td></tr></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-center gap-2 mt-3" id="adm-members-pagination"></div>
                </div>
              </div>
            </div>

            <!-- æ´»å‹•ç®¡ç† -->
            <div class="admin-section" id="admin-events">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div class="fw-bold">ğŸ¯ æ´»å‹•ç®¡ç†</div>
                  <button class="btn btn-primary btn-sm" onclick="APP.Admin.showAddEvent()">æ–°å¢æ´»å‹•</button>
                </div>
                <div class="card-body">
                  <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-6">
                      <label class="form-label">æœå°‹</label>
                      <input class="form-control" id="adm-event-search" placeholder="æ´»å‹•åç¨±"/>
                    </div>
                    <div class="col-6 col-md-3">
                      <label class="form-label">ç‹€æ…‹</label>
                      <select class="form-select" id="adm-event-status">
                        <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                        <option>å ±åä¸­</option><option>å·²é¡æ»¿</option><option>å·²çµæŸ</option><option>å·²å–æ¶ˆ</option>
                      </select>
                    </div>
                    <div class="col-6 col-md-3">
                      <button class="btn btn-primary w-100" onclick="APP.Admin.loadEvents(1)">æœå°‹</button>
                    </div>
                  </div>
                  <div class="table-responsive mt-3">
                    <table class="table table-hover table-sm">
                      <thead><tr><th>æ´»å‹•åç¨±</th><th>æ—¥æœŸæ™‚é–“</th><th>åœ°é»</th><th>å ±åäººæ•¸</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
                      <tbody id="adm-events-body"><tr><td colspan="6" class="text-center py-4 text-muted">è¼‰å…¥ä¸­...</td></tr></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-center gap-2 mt-3" id="adm-events-pagination"></div>
                </div>
              </div>
            </div>

            <!-- å¥åº·è¨˜éŒ„ -->
            <div class="admin-section" id="admin-health">
              <div class="card">
                <div class="card-header"><div class="fw-bold">ğŸ“‹ å¥åº·è¨˜éŒ„ç®¡ç†</div></div>
                <div class="card-body">
                  <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-4">
                      <label class="form-label">æœƒå“¡å§“å</label>
                      <input class="form-control" id="adm-health-search" placeholder="æœå°‹å§“å"/>
                    </div>
                    <div class="col-6 col-md-3">
                      <label class="form-label">èµ·</label>
                      <input type="date" class="form-control" id="adm-health-from"/>
                    </div>
                    <div class="col-6 col-md-3">
                      <label class="form-label">è¿„</label>
                      <input type="date" class="form-control" id="adm-health-to"/>
                    </div>
                    <div class="col-12 col-md-2 d-flex gap-2">
                      <button class="btn btn-primary w-100" onclick="APP.Admin.loadHealth(1)">æœå°‹</button>
                      <button class="btn btn-warning w-100" onclick="APP.Admin.exportHealth()">åŒ¯å‡º</button>
                    </div>
                  </div>
                  <div class="table-responsive mt-3">
                    <table class="table table-hover table-sm">
                      <thead><tr><th>æœƒå“¡å§“å</th><th>è¨˜éŒ„æ—¥æœŸ</th><th>éœ‡é¡«</th><th>åƒµç¡¬</th><th>å‹•ä½œé²ç·©</th><th>å¹³è¡¡</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr></thead>
                      <tbody id="adm-health-body"><tr><td colspan="8" class="text-center py-4 text-muted">è¼‰å…¥ä¸­...</td></tr></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-center gap-2 mt-3" id="adm-health-pagination"></div>
                </div>
              </div>
            </div>

            <!-- ææ¬¾ç®¡ç† -->
            <div class="admin-section" id="admin-donations">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div class="fw-bold">ğŸ’° ææ¬¾ç®¡ç†</div>
                  <button class="btn btn-primary btn-sm" onclick="APP.Admin.showAddDonation()">æ–°å¢ææ¬¾è¨˜éŒ„</button>
                </div>
                <div class="card-body">
                  <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-4">
                      <label class="form-label">ææ¬¾äºº</label>
                      <input class="form-control" id="adm-donation-search" placeholder="ææ¬¾äººå§“å"/>
                    </div>
                    <div class="col-6 col-md-3">
                      <label class="form-label">é¡å‹</label>
                      <select class="form-select" id="adm-donation-type">
                        <option value="">æ‰€æœ‰é¡å‹</option>
                        <option>ä¸€èˆ¬ææ¬¾</option><option>å®šæœŸææ¬¾</option><option>æŒ‡å®šç”¨é€”</option>
                      </select>
                    </div>
                    <div class="col-6 col-md-2">
                      <label class="form-label">èµ·</label>
                      <input type="date" class="form-control" id="adm-donation-from"/>
                    </div>
                    <div class="col-6 col-md-2">
                      <label class="form-label">è¿„</label>
                      <input type="date" class="form-control" id="adm-donation-to"/>
                    </div>
                    <div class="col-12 col-md-1">
                      <button class="btn btn-primary w-100" onclick="APP.Admin.loadDonations(1)">æœå°‹</button>
                    </div>
                  </div>

                  <div class="table-responsive mt-3">
                    <table class="table table-hover table-sm">
                      <thead><tr><th>ææ¬¾äºº</th><th>é‡‘é¡</th><th>é¡å‹</th><th>æ—¥æœŸ</th><th>ä»˜æ¬¾æ–¹å¼</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
                      <tbody id="adm-donations-body"><tr><td colspan="7" class="text-center py-4 text-muted">è¼‰å…¥ä¸­...</td></tr></tbody>
                    </table>
                  </div>
                  <div class="d-flex justify-content-center gap-2 mt-3" id="adm-donations-pagination"></div>
                </div>
              </div>
            </div>

            <!-- çµ±è¨ˆå ±è¡¨ -->
            <div class="admin-section" id="admin-reports">
              <div class="card">
                <div class="card-header d-flex justify-content-between">
                  <div class="fw-bold">ğŸ“ˆ çµ±è¨ˆå ±è¡¨</div>
                  <button class="btn btn-warning btn-sm" onclick="APP.Admin.exportAllReports()">åŒ¯å‡ºå…¨éƒ¨å ±è¡¨</button>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-6 col-md-3">
                      <div class="card p-3 text-center">
                        <div class="fs-4">ğŸ“Š</div>
                        <div class="fs-3 fw-bold" id="adm-report-new-members">-</div>
                        <div class="text-muted small">æœ¬æœˆæ–°å¢æœƒå“¡</div>
                      </div>
                    </div>
                    <div class="col-6 col-md-3">
                      <div class="card p-3 text-center">
                        <div class="fs-4">ğŸ¯</div>
                        <div class="fs-3 fw-bold" id="adm-report-events">-</div>
                        <div class="text-muted small">æœ¬æœˆæ´»å‹•æ•¸</div>
                      </div>
                    </div>
                    <div class="col-6 col-md-3">
                      <div class="card p-3 text-center">
                        <div class="fs-4">ğŸ’°</div>
                        <div class="fs-6 fw-bold" id="adm-report-donations">-</div>
                        <div class="text-muted small">æœ¬æœˆææ¬¾ç¸½é¡</div>
                      </div>
                    </div>
                    <div class="col-6 col-md-3">
                      <div class="card p-3 text-center">
                        <div class="fs-4">ğŸ“</div>
                        <div class="fs-3 fw-bold" id="adm-report-health">-</div>
                        <div class="text-muted small">æœ¬æœˆå¥åº·è¨˜éŒ„</div>
                      </div>
                    </div>
                  </div>
                  <div class="card mt-3">
                    <div class="card-header fw-bold">å¹´åº¦è¶¨å‹¢ï¼ˆç¤ºæ„ï¼‰</div>
                    <div class="card-body text-center text-muted">åœ–è¡¨åº«æœªå¼•å…¥ï¼Œæ—¥å¾Œå¯æ•´åˆ</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ç³»çµ±è¨­å®š -->
            <div class="admin-section" id="admin-settings">
              <div class="card">
                <div class="card-header"><div class="fw-bold">âš™ï¸ ç³»çµ±è¨­å®š</div></div>
                <div class="card-body">
                  <div class="row g-2">
                    <div class="col-12 col-md-6">
                      <label class="form-label">API ç¶²å€</label>
                      <input id="adm-api-url" class="form-control" placeholder="https://..."/>
                    </div>
                    <div class="col-6 col-md-3">
                      <label class="form-label">æ¯é ç­†æ•¸</label>
                      <select id="adm-page-size" class="form-select">
                        <option>10</option><option selected>20</option><option>50</option><option>100</option>
                      </select>
                    </div>
                    <div class="col-6 col-md-3">
                      <label class="form-label">è‡ªå‹•å‚™ä»½(å°æ™‚)</label>
                      <input id="adm-backup-interval" type="number" class="form-control" value="24" min="1" max="168"/>
                    </div>
                    <div class="col-12">
                      <label class="form-label">ç³»çµ±å…¬å‘Š</label>
                      <textarea id="adm-announcement" class="form-control" rows="3"></textarea>
                    </div>
                  </div>
                  <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-primary" onclick="APP.Admin.saveSettings()">å„²å­˜è¨­å®š</button>
                    <button class="btn btn-warning" onclick="APP.Admin.exportData()">åŒ¯å‡ºè³‡æ–™</button>
                    <button class="btn btn-success" onclick="APP.Admin.backupData()">ç«‹å³å‚™ä»½</button>
                    <button class="btn btn-danger" onclick="APP.Admin.clearCache()">æ¸…é™¤å¿«å–</button>
                  </div>

                  <div class="card mt-3">
                    <div class="card-header fw-bold">ğŸ” ç®¡ç†å“¡å¸³è™Ÿ</div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-hover table-sm">
                          <thead><tr><th>ç®¡ç†å“¡åç¨±</th><th>Email</th><th>æ¬Šé™</th><th>æœ€å¾Œç™»å…¥</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
                          <tbody id="adm-admins-body">
                            <tr>
                              <td>ç³»çµ±ç®¡ç†å“¡</td>
                              <td>admin@parkinson.org.tw</td>
                              <td><span class="badge badge-danger">è¶…ç´šç®¡ç†å“¡</span></td>
                              <td>2024-01-15 14:30</td>
                              <td><span class="badge badge-success">å·²å•Ÿç”¨</span></td>
                              <td><button class="btn btn-sm btn-warning" onclick="alert('ç·¨è¼¯åŠŸèƒ½å¯æ“´å……')">ç·¨è¼¯</button></td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      <button class="btn btn-primary btn-sm mt-2" onclick="APP.Admin.showAddAdmin()">æ–°å¢ç®¡ç†å“¡</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Toast å®¹å™¨/Modal å®¹å™¨/Loading -->
  <div id="toastContainer" class="toast-container"></div>
  <div id="modalContainer"></div>
  <div id="globalLoading" class="loading-overlay"><div class="loading-spinner"></div></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // ========== å…¨åŸŸ App å‘½åç©ºé–“ ==========
  const APP = {
    State: {
      // å¤šçµ„ LIFF ID/ API URL å¯é…ç½®
      LIFF_IDS: {
        app: '1656516134-VaGgmaPm',        // ç¬¬ä¸€æ®µ LIFF
        auth: '1656516134-X9oq92g9',       // ç¬¬äºŒæ®µ LIFFï¼ˆç™»å…¥å…¥å£ï¼‰
        member: '1656516134-k8rMQwnQ'      // ç¬¬å››æ®µ LIFFï¼ˆæœƒå“¡ä¸­å¿ƒï¼‰
      },
      API: {
        primary: localStorage.getItem('API_URL') || 'https://script.google.com/macros/s/AKfycbxvAmIgI8H0qAectv4RfEXbiIRl72WQD7r2yPDuC2qwhNd5icwPeziYnFGmiEfqZBrrbw/exec', // ç¬¬ä¸€æ®µ(POST JSON)
        alt: localStorage.getItem('admin_API_URL') || 'https://script.google.com/macros/s/AKfycbxvAmIgI8H0qAectv4RfEXbiIRl72WQD7r2yPDuC2qwhNd5icwPeziYnFGmiEfqZBrrbw/exec' // å…¶ä»–é (å¤šç‚ºGET)
      },
      API_KEY: 'AAbb8520258185202581',
      userProfile: null,     // LIFF profile
      memberInfo: null,      // å¾Œç«¯æœƒå“¡è³‡æ–™ï¼ˆç™»å…¥æˆåŠŸå¾Œï¼‰
      isAdmin: false,
      routerView: 'auth',    // auth | member | admin
      appUser: { lineId: '', name: '', picture: '' },
      pageSize: 20
    },

    // ========== å…±ç”¨å·¥å…· ==========
    Util: {
      showLoading(show) {
        document.getElementById('globalLoading').classList.toggle('show', !!show);
      },
      toast(message, type='info') {
        const container = document.getElementById('toastContainer');
        const colors = { success: '#28a745', error: '#dc3545', warning: '#ffc107', info: '#17a2b8' };
        const icons = { success: 'check-circle-fill', error: 'x-circle-fill', warning: 'exclamation-triangle-fill', info: 'info-circle-fill' };
        const toast = document.createElement('div');
        toast.className = 'toast show';
        toast.style.cssText = `min-width:250px;margin-bottom:10px;background:white;border-left:4px solid ${colors[type]};box-shadow:0 4px 12px rgba(0,0,0,0.15);`;
        toast.innerHTML = `
          <div class="toast-body d-flex align-items-center">
            <i class="bi bi-${icons[type]} me-2" style="color:${colors[type]};font-size:18px;"></i>
            <div class="flex-grow-1" style="font-size:14px;">${message}</div>
            <button type="button" class="btn-close ms-2" aria-label="Close"></button>
          </div>`;
        toast.querySelector('.btn-close').onclick = () => toast.remove();
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      },
      modal(html, onSubmit) {
        const container = document.getElementById('modalContainer');
        container.innerHTML = html;
        const modalEl = container.querySelector('.modal');
        const formEl = container.querySelector('form');
        const bsModal = new bootstrap.Modal(modalEl);
        if (formEl && typeof onSubmit === 'function') {
          formEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = formEl.querySelector('button[type="submit"]');
            APP.Util.setBtnLoading(btn, true);
            try {
              const fd = new FormData(formEl);
              await onSubmit(fd);
              bsModal.hide();
            } catch (err) {
              APP.Util.toast(err.message || 'æ“ä½œå¤±æ•—', 'error');
            } finally {
              APP.Util.setBtnLoading(btn, false);
            }
          });
        }
        modalEl.addEventListener('hidden.bs.modal', () => container.innerHTML = '', { once: true });
        bsModal.show();
      },
      setBtnLoading(button, loading) {
        if (!button) return;
        if (loading) {
          button.disabled = true;
          button.dataset.originalText = button.innerHTML;
          button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>è™•ç†ä¸­...';
        } else {
          button.disabled = false;
          if (button.dataset.originalText) button.innerHTML = button.dataset.originalText;
        }
      },
      formatDate(dateInput) {
        if (!dateInput) return '-';
        try {
          let d;
          if (dateInput instanceof Date) d = dateInput;
          else if (typeof dateInput === 'number') d = new Date(dateInput);
          else if (typeof dateInput === 'string') {
            const p = Date.parse(dateInput); d = isNaN(p) ? new Date(dateInput) : new Date(p);
          } else return '-';
          if (isNaN(d.getTime())) return '-';
          return d.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
        } catch { return '-'; }
      },
      formatDateInput(dateString) {
        if (!dateString) return '';
        try {
          const d = (dateString instanceof Date) ? dateString : new Date(dateString);
          if (isNaN(d.getTime())) return '';
          return d.toISOString().split('T')[0];
        } catch { return ''; }
      },
      currency(n) { return new Intl.NumberFormat('zh-TW').format(Number(n || 0)); },
      getStatusClass(status) {
        const map = {
          'å·²å¯©æ ¸': 'success', 'å¾…å¯©æ ¸': 'warning', 'å·²åœç”¨': 'danger', 'å ±åä¸­': 'info',
          'å·²é¡æ»¿': 'warning', 'å·²çµæŸ': 'secondary', 'å·²å–æ¶ˆ': 'danger', 'å·²å®Œæˆ': 'success',
          'è™•ç†ä¸­': 'warning', 'å·²å•Ÿç”¨': 'success'
        };
        return map[status] || 'secondary';
      }
    },

    // ========== é…ç½® ==========
    Config: {
      updateAPIUrl() {
        const v = document.getElementById('global-api-url').value.trim();
        if (!v) { APP.Util.toast('è«‹è¼¸å…¥æœ‰æ•ˆ URL', 'error'); return; }
        APP.State.API.primary = v;
        APP.State.API.alt = v;
        localStorage.setItem('API_URL', v);
        localStorage.setItem('admin_API_URL', v);
        document.getElementById('current-api-url').textContent = v;
        APP.Util.toast('API ç¶²å€å·²æ›´æ–°', 'success');
      }
    },

    // ========== è·¯ç”± ==========
    Router: {
      go(view) {
        APP.State.routerView = view;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + view).classList.add('active');
        if (view === 'member') {
          APP.AppView.initApp();     // LIFF App åˆå§‹åŒ–è³‡æ–™
          APP.Member.initMember();   // æœƒå“¡ä¸­å¿ƒåˆå§‹åŒ–
        } else if (view === 'admin') {
          APP.Admin.initAdmin();
        }
      },
      goAdmin() {
        if (!APP.State.isAdmin) { APP.Util.toast('æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™', 'error'); return; }
        APP.Router.go('admin');
      }
    },

    // ========== LIFF ==========
    LIFF: {
      inited: false,
      async initAny() {
        if (APP.LIFF.inited) return;
        try {
          // ä»»ä¸€ LIFF ID å…ˆåˆå§‹åŒ–
          const anyId = APP.State.LIFF_IDS.app || APP.State.LIFF_IDS.auth || APP.State.LIFF_IDS.member;
          if (anyId) {
            await liff.init({ liffId: anyId });
            APP.LIFF.inited = true;
          }
        } catch (e) { /* ignore */ }
      },
      async ensureLogged() {
        try {
          await APP.LIFF.initAny();
          if (!liff.isLoggedIn()) liff.login();
        } catch (e) { /* ignore */ }
      },
      async profile() {
        try {
          await APP.LIFF.initAny();
          if (!liff.isLoggedIn()) return null;
          return await liff.getProfile();
        } catch (e) { return null; }
      }
    },

    // ========== API ==========
    API: {
      // ç¬¬ä¸€æ®µï¼šPOST JSON çµ±ä¸€ï¼ˆè¡Œå‹•ç«¯ Appï¼‰
      async post(action, data = {}) {
        const payload = {
          apiKey: APP.State.API_KEY,
          action,
          lineId: APP.State.userProfile?.userId || APP.State.appUser?.lineId || '',
          ...data
        };
        const res = await fetch(APP.State.API.primary, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(payload)
        });
        const result = await res.json().catch(() => ({}));
        if (!result.success) throw new Error(result.message || 'æ“ä½œå¤±æ•—');
        return result;
      },
      // ç¬¬äºŒ/ä¸‰/å››æ®µï¼šGET URLSearchParamsï¼ˆå¾Œå°/æœƒå“¡ä¸­å¿ƒ/ç™»å…¥ï¼‰
      async get(params) {
        const url = new URL(APP.State.API.alt);
        Object.keys(params).forEach(k => {
          const v = params[k];
          url.searchParams.append(k, typeof v === 'object' ? JSON.stringify(v) : v);
        });
        const res = await fetch(url.toString(), { method: 'GET', redirect: 'follow', mode: 'cors' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        return JSON.parse(text);
      },
      async postJson(data) {
        const res = await fetch(APP.State.API.alt, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        return await res.json();
      }
    },

    // ========== æœªç™»å…¥å…¥å£ï¼ˆç™»å…¥/è¨»å†Šï¼‰ ==========
    Auth: {
      debug(message) {
        const el = document.getElementById('auth-debug');
        const ts = new Date().toLocaleTimeString();
        el.innerHTML += '[' + ts + '] ' + message + '<br/>';
        el.scrollTop = 999999;
      },
      setAlert(msg, type = 'info') {
        const el = document.getElementById('auth-alert');
        el.className = 'alert alert-' + (type === 'error' ? 'danger' : type);
        el.textContent = msg;
        el.classList.remove('d-none');
        setTimeout(() => el.classList.add('d-none'), 5000);
      },
      setLoading(on) {
        document.getElementById('auth-loading').classList.toggle('d-none', !on);
      },
      async init() {
        // Tab åˆ‡æ›
        document.querySelectorAll('.auth-tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            document.querySelectorAll('.auth-pane').forEach(p => p.classList.remove('active'));
            document.getElementById(tab.dataset.pane).classList.add('active');
          });
        });
        document.getElementById('current-api-url').textContent = APP.State.API.primary;

        // å¦‚æœå·²ç™»å…¥ï¼ˆlocalStorageï¼‰ï¼Œå°å‘é©ç•¶é 
        const stored = localStorage.getItem('memberInfo');
        if (stored) {
          APP.State.memberInfo = JSON.parse(stored);
          APP.State.isAdmin = !!APP.State.memberInfo?.isAdmin;
          APP.Router.go('member');
          return;
        }

        // åˆå§‹åŒ– LIFFï¼ˆç™»å…¥æ™‚å¯ç”¨ï¼‰
        try {
          await APP.LIFF.initAny();
          if (liff.isLoggedIn()) {
            const profile = await liff.getProfile();
            APP.Auth.debug('å·²ç™»å…¥ LINE: ' + profile.displayName);
          }
        } catch (err) {
          APP.Auth.debug('LIFF åˆå§‹åŒ–å¤±æ•—: ' + err.message);
        }
      },
      async testAPIConnection() {
        APP.Auth.setLoading(true);
        try {
          APP.Auth.debug('é–‹å§‹æ¸¬è©¦ API...');
          const result = await APP.API.get({ action: 'test' });
          APP.Auth.setLoading(false);
          if (result?.success) {
            APP.Auth.setAlert('API é€£ç·šæˆåŠŸï¼', 'success');
            APP.Auth.debug('æ¸¬è©¦æˆåŠŸ: ' + JSON.stringify(result));
          } else {
            APP.Auth.setAlert('API å›æ‡‰ç•°å¸¸', 'warning');
          }
        } catch (e) {
          APP.Auth.setLoading(false);
          APP.Auth.setAlert('API é€£ç·šå¤±æ•—ï¼š' + e.message, 'error');
        }
      },
      clearDebug() {
        document.getElementById('auth-debug').innerHTML = '';
        APP.Auth.debug('å·²æ¸…é™¤é™¤éŒ¯è¨˜éŒ„');
      },
      async handleEmailLogin(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        APP.Auth.setLoading(true);
        try {
          const result = await APP.API.get({ action: 'login', email, password });
          APP.Auth.setLoading(false);
          if (result?.success) {
            APP.State.memberInfo = result.data;
            APP.State.isAdmin = !!result.data?.isAdmin;
            localStorage.setItem('memberInfo', JSON.stringify(result.data));
            APP.Auth.setAlert('ç™»å…¥æˆåŠŸï¼', 'success');
            setTimeout(() => APP.Router.go('member'), 800);
          } else {
            APP.Auth.setAlert(result?.message || 'ç™»å…¥å¤±æ•—', 'error');
          }
        } catch (e2) {
          APP.Auth.setLoading(false);
          APP.Auth.setAlert('ç³»çµ±éŒ¯èª¤ï¼š' + e2.message, 'error');
        }
      },
      async handleLineLogin() {
        APP.Auth.debug('é–‹å§‹ LINE ç™»å…¥');
        try {
          await APP.LIFF.ensureLogged();
          const profile = await liff.getProfile();
          APP.Auth.debug('LINE ä½¿ç”¨è€…ï¼š' + profile.displayName);
          APP.Auth.setLoading(true);
          const result = await APP.API.get({
            action: 'lineLogin',
            lineUserId: profile.userId,
            displayName: profile.displayName,
            pictureUrl: profile.pictureUrl || ''
          });
          APP.Auth.setLoading(false);
          if (result?.success) {
            APP.State.memberInfo = result.data;
            APP.State.isAdmin = !!result.data?.isAdmin;
            localStorage.setItem('memberInfo', JSON.stringify(result.data));
            APP.Auth.setAlert('ç™»å…¥æˆåŠŸï¼', 'success');
            setTimeout(() => APP.Router.go('member'), 800);
          } else {
            APP.Auth.setAlert(result?.message || 'LINE ç™»å…¥å¤±æ•—', 'error');
          }
        } catch (e) {
          APP.Auth.setLoading(false);
          APP.Auth.setAlert('LINE ç™»å…¥å¤±æ•—ï¼š' + e.message, 'error');
        }
      },
      async handleRegister(e) {
        e.preventDefault();
        const pwd = document.getElementById('reg-password').value;
        const pwd2 = document.getElementById('reg-password-confirm').value;
        if (pwd !== pwd2) { APP.Auth.setAlert('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´', 'error'); return; }
        APP.Auth.setLoading(true);
        try {
          let lineUserId = '';
          try {
            await APP.LIFF.initAny();
            if (liff.isLoggedIn()) {
              const p = await liff.getProfile();
              lineUserId = p.userId;
            }
          } catch {}
          const result = await APP.API.get({
            action: 'register',
            name: document.getElementById('reg-name').value,
            gender: document.getElementById('reg-gender').value,
            birthday: document.getElementById('reg-birthday').value,
            phone: document.getElementById('reg-phone').value,
            email: document.getElementById('reg-email').value,
            password: pwd,
            lineUserId
          });
          APP.Auth.setLoading(false);
          if (result?.success) {
            APP.Auth.setAlert('è¨»å†ŠæˆåŠŸï¼è«‹ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸', 'success');
            document.querySelector('.auth-tab[data-pane="pane-login"]').click();
          } else {
            APP.Auth.setAlert(result?.message || 'è¨»å†Šå¤±æ•—', 'error');
          }
        } catch (e2) {
          APP.Auth.setLoading(false);
          APP.Auth.setAlert('ç³»çµ±éŒ¯èª¤ï¼š' + e2.message, 'error');
        }
      },
      logout() {
        // é€šç”¨ç™»å‡ºï¼ˆæœƒå“¡ä¸­å¿ƒä¹Ÿç”¨ï¼‰
        localStorage.removeItem('memberInfo');
        try { if (liff.isLoggedIn()) liff.logout(); } catch (e) {}
        APP.State.memberInfo = null;
        APP.State.isAdmin = false;
        APP.Router.go('auth');
      }
    },

    // ========== è¡Œå‹•ç«¯ LIFF Appï¼ˆç¬¬ä¸€æ®µï¼‰ ==========
    AppView: {
      async initApp() {
        // åˆå§‹åŒ– LIFF Profile é¡¯ç¤º
        try {
          const prof = await APP.LIFF.profile();
          APP.State.userProfile = prof;
          document.getElementById('appUserAvatar').src = prof?.pictureUrl || 'https://via.placeholder.com/36';
          document.getElementById('appUserName').textContent = prof?.displayName || 'å·²ç™»å…¥';
          document.getElementById('appUserLineId').textContent = prof?.userId || '-';
        } catch {}
        // æ¬Šé™ï¼ˆç®¡ç†å“¡ï¼‰
        const isAdmin = !!APP.State.memberInfo?.isAdmin;
        APP.State.isAdmin = isAdmin;
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'block' : 'none');
        // ç¶å®šåº•éƒ¨å°èˆª
        document.querySelectorAll('.bottom-nav .nav-item').forEach(btn => {
          btn.onclick = () => {
            document.querySelectorAll('.bottom-nav .nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const page = btn.getAttribute('data-app-page');
            APP.AppView.switchPage(page);
          };
        });

        // ç¶å®šå€‹äººè³‡æ–™è¡¨å–®æäº¤
        const pf = document.getElementById('profileForm');
        if (pf && !pf.dataset.bind) {
          pf.addEventListener('submit', APP.AppView.submitProfile);
          pf.dataset.bind = '1';
        }

        // è¼‰å…¥è³‡æ–™
        APP.AppView.loadAll();
      },
      switchPage(page) {
        document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
        const el = document.getElementById('app-page-' + page);
        if (el) { el.classList.add('active'); window.scrollTo({ top: 0, behavior: 'smooth' }); }
      },
      async loadAll() {
        APP.Util.showLoading(true);
        try {
          await Promise.all([
            APP.AppView.loadHomeData(),
            APP.AppView.loadActivities(),
            APP.AppView.loadVolunteer(),
            APP.AppView.loadFinance(),
            APP.AppView.loadProfile()
          ]);
        } catch (e) { APP.Util.toast('è³‡æ–™è¼‰å…¥å¤±æ•—ï¼š' + e.message, 'error'); }
        finally { APP.Util.showLoading(false); }
      },
      async loadHomeData() {
        try {
          const res = await APP.API.post('getDashboardData', {});
          const d = res.data || {};
          document.getElementById('statActivities').textContent = d.totalActivities || 0;
          document.getElementById('statRegistrations').textContent = d.myRegistrations || 0;
          document.getElementById('statVolunteerHours').textContent = d.myVolunteerHours || 0;
          document.getElementById('statDonations').textContent = '$' + APP.Util.currency(d.myDonationAmount || 0);
          APP.AppView.renderRecentActivities(d.recentActivity || []);
        } catch {}
      },
      renderRecentActivities(list) {
        const c = document.getElementById('recentActivities');
        if (!list.length) {
          c.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>ç›®å‰æ²’æœ‰æ´»å‹•</p></div>'; return;
        }
        c.innerHTML = list.slice(0, 3).map(a => `
          <div class="activity-item">
            <div class="activity-title">${a.title}</div>
            <div class="activity-info">${a.description || ''}</div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(a.date)}</span>
              <span class="status-badge status-${a.status}">${a.status}</span>
            </div>
          </div>`).join('');
      },
      async loadActivities() {
        try {
          const res = await APP.API.post('getActivities', {});
          const list = res.data || [];
          const open = list.filter(a => a.status === 'é–‹æ”¾å ±å' || a.status === 'å ±åä¸­');
          APP.AppView.renderActivities(open);
          const reg = await APP.API.post('getMyRegistrations', {});
          APP.AppView.renderMyRegistrations(reg.data || []);
        } catch {}
      },
      renderActivities(activities) {
        const c = document.getElementById('activitiesList');
        if (!activities.length) {
          c.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>ç›®å‰æ²’æœ‰é–‹æ”¾å ±åçš„æ´»å‹•</p></div>'; return;
        }
        c.innerHTML = activities.map(a => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="activity-title">${a.title}</div>
              <span class="status-badge status-${a.status}">${a.status}</span>
            </div>
            <div class="activity-info">${a.description || ''}</div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(a.date)} ${a.time || ''}</span>
              <span><i class="bi bi-geo-alt"></i>${a.location || 'æœªæŒ‡å®š'}</span>
              <span><i class="bi bi-people"></i>${a.currentCount || 0}/${a.maxParticipants}</span>
              ${a.fee ? `<span><i class="bi bi-cash"></i>$${APP.Util.currency(a.fee)}</span>` : ''}
            </div>
            <button class="btn btn-sm btn-gradient mt-2" onclick="APP.AppView.registerActivity('${a.id}')"><i class="bi bi-check-circle me-1"></i>æˆ‘è¦å ±å</button>
          </div>`).join('');
      },
      renderMyRegistrations(regs) {
        const c = document.getElementById('myRegistrationsList');
        if (!regs.length) {
          c.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>æ‚¨é‚„æ²’æœ‰å ±åä»»ä½•æ´»å‹•</p></div>'; return;
        }
        c.innerHTML = regs.map(r => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="activity-title">${r.activityTitle}</div>
              <span class="status-badge status-${r.status}">${r.status}</span>
            </div>
            <div class="activity-meta"><span><i class="bi bi-calendar"></i>${APP.Util.formatDate(r.registrationTime)}</span></div>
            ${r.status === 'å·²å ±å' ? `<button class="btn btn-sm btn-outline-danger mt-2" onclick="APP.AppView.cancelRegistration('${r.id}')"><i class="bi bi-x-circle me-1"></i>å–æ¶ˆå ±å</button>` : ''}
          </div>`).join('');
      },
      async registerActivity(activityId) {
        if (!confirm('ç¢ºå®šè¦å ±åæ­¤æ´»å‹•å—ï¼Ÿ')) return;
        try {
          APP.Util.showLoading(true);
          await APP.API.post('registerActivity', { activityId });
          APP.Util.toast('å ±åæˆåŠŸï¼', 'success');
          await APP.AppView.loadActivities();
          await APP.AppView.loadHomeData();
        } catch (e) { APP.Util.toast('å ±åå¤±æ•—ï¼š' + e.message, 'error'); }
        finally { APP.Util.showLoading(false); }
      },
      async cancelRegistration(regId) {
        if (!confirm('ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ')) return;
        try {
          APP.Util.showLoading(true);
          await APP.API.post('cancelRegistration', { registrationId: regId });
          APP.Util.toast('å·²å–æ¶ˆå ±å', 'success');
          await APP.AppView.loadActivities();
          await APP.AppView.loadHomeData();
        } catch (e) { APP.Util.toast('å–æ¶ˆå¤±æ•—ï¼š' + e.message, 'error'); }
        finally { APP.Util.showLoading(false); }
      },
      async loadVolunteer() {
        try {
          const res = await APP.API.post('getVolunteerData', {});
          const d = res.data || {};
          document.getElementById('volTotalHours').textContent = d.stats?.totalHours || 0;
          document.getElementById('volTotalActivities').textContent = d.stats?.totalActivities || 0;
          APP.AppView.renderVolunteerNeeds(d.needs || []);
          APP.AppView.renderVolunteerRecords(d.records || []);
        } catch {}
      },
      renderVolunteerNeeds(needs) {
        const c = document.getElementById('volunteerNeedsList');
        if (!needs.length) { c.innerHTML = '<div class="empty-state"><i class="bi bi-people"></i><p>ç›®å‰æ²’æœ‰å¿—å·¥éœ€æ±‚</p></div>'; return; }
        c.innerHTML = needs.map(n => `
          <div class="activity-item">
            <div class="activity-title">${n.title}</div>
            <div class="activity-info">${n.description || ''}</div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(n.date)} ${n.time || ''}</span>
              <span><i class="bi bi-people"></i>éœ€æ±‚ï¼š${n.needCount}äºº</span>
              <span><i class="bi bi-clock"></i>æ™‚æ•¸ï¼š${n.hours}å°æ™‚</span>
              <span><i class="bi bi-check-circle"></i>å·²å ±åï¼š${n.currentCount || 0}äºº</span>
            </div>
            <button class="btn btn-sm btn-gradient mt-2" onclick="APP.AppView.applyVolunteer('${n.id}')"><i class="bi bi-hand-thumbs-up me-1"></i>æˆ‘è¦å ±å</button>
          </div>`).join('');
      },
      renderVolunteerRecords(records) {
        const c = document.getElementById('myVolunteerRecords');
        if (!records.length) { c.innerHTML = '<div class="empty-state"><i class="bi bi-journal-x"></i><p>æ‚¨é‚„æ²’æœ‰å¿—å·¥æœå‹™è¨˜éŒ„</p></div>'; return; }
        c.innerHTML = records.map(r => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="activity-title">${r.title}</div>
              <span class="status-badge status-${r.status}">${r.status}</span>
            </div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(r.date)}</span>
              <span><i class="bi bi-clock"></i>${r.hours}å°æ™‚</span>
            </div>
          </div>`).join('');
      },
      async applyVolunteer(needId) {
        if (!confirm('ç¢ºå®šè¦å ±åæ­¤å¿—å·¥æœå‹™å—ï¼Ÿ')) return;
        try {
          APP.Util.showLoading(true);
          await APP.API.post('applyVolunteer', { needId });
          APP.Util.toast('å ±åæˆåŠŸï¼', 'success');
          await APP.AppView.loadVolunteer();
        } catch (e) { APP.Util.toast('å ±åå¤±æ•—ï¼š' + e.message, 'error'); }
        finally { APP.Util.showLoading(false); }
      },
      async loadFinance() {
        try {
          const res = await APP.API.post('getFinanceData', {});
          const d = res.data || {};
          document.getElementById('finTotalDonation').textContent = '$' + APP.Util.currency(d.stats?.totalDonation || 0);
          document.getElementById('finPendingExpenses').textContent = d.stats?.pendingExpenses || 0;
          APP.AppView.renderMyDonations(d.donations || []);
          APP.AppView.renderMyExpenses(d.expenses || []);
        } catch {}
      },
      renderMyDonations(ds) {
        const c = document.getElementById('myDonationsList');
        if (!ds.length) { c.innerHTML = '<div class="empty-state"><i class="bi bi-heart"></i><p>æ‚¨é‚„æ²’æœ‰ææ¬¾è¨˜éŒ„</p></div>'; return; }
        c.innerHTML = ds.map(d => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="activity-title">$${APP.Util.currency(d.amount)}</div>
                <div class="activity-info">${d.category || 'ä¸€èˆ¬ææ¬¾'}</div>
                <div class="activity-meta">
                  <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(d.createdAt)}</span>
                  <span class="status-badge status-${d.status}">${d.status}</span>
                </div>
              </div>
            </div>
          </div>`).join('');
      },
      renderMyExpenses(xs) {
        const c = document.getElementById('myExpensesList');
        if (!xs.length) { c.innerHTML = '<div class="empty-state"><i class="bi bi-receipt"></i><p>æ‚¨é‚„æ²’æœ‰æ”¯å‡ºç”³è«‹</p></div>'; return; }
        c.innerHTML = xs.map(x => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="activity-title">$${APP.Util.currency(x.amount)}</div>
              <span class="status-badge status-${x.status}">${x.status}</span>
            </div>
            <div class="activity-info">${x.description || ''}</div>
            <div class="activity-meta">
              <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(x.createdAt)}</span>
              <span><i class="bi bi-tag"></i>${x.category}</span>
            </div>
          </div>`).join('');
      },
      async loadProfile() {
        try {
          const res = await APP.API.post('getUserInfo', {});
          const p = res.data || {};
          const form = document.getElementById('profileForm');
          if (form) {
            form.elements.realName.value = p.realName || '';
            form.elements.memberType.value = p.memberType || '';
            form.elements.phone.value = p.phone || '';
            form.elements.email.value = p.email || '';
            form.elements.birthday.value = APP.Util.formatDateInput(p.birthday);
            form.elements.diagnosisDate.value = APP.Util.formatDateInput(p.diagnosisDate);
            form.elements.address.value = p.address || '';
          }
          document.getElementById('appUserMemberType').textContent = p.memberType || '-';

          const rec = await APP.API.post('getMyReceipts', {});
          APP.AppView.renderMyReceipts(rec.data || []);
        } catch {}
      },
      renderMyReceipts(list) {
        const c = document.getElementById('myReceiptsList');
        if (!list.length) { c.innerHTML = '<div class="empty-state"><i class="bi bi-file-earmark-text"></i><p>æ‚¨é‚„æ²’æœ‰æ”¶æ“š</p></div>'; return; }
        c.innerHTML = list.map(r => `
          <div class="activity-item">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="activity-title">${r.receiptNumber}</div>
                <div class="activity-meta">
                  <span><i class="bi bi-cash"></i>é‡‘é¡ï¼š$${APP.Util.currency(r.amount)}</span>
                  <span><i class="bi bi-calendar"></i>${APP.Util.formatDate(r.issueDate)}</span>
                </div>
              </div>
              ${r.pdfUrl ? `<button class="btn btn-sm btn-gradient" onclick="window.open('${r.pdfUrl}','_blank')"><i class="bi bi-download"></i>ä¸‹è¼‰</button>` : ''}
            </div>
          </div>`).join('');
      },
      async submitProfile(e) {
        e.preventDefault();
        const f = e.target;
        const data = {
          realName: f.realName.value, memberType: f.memberType.value, phone: f.phone.value,
          email: f.email.value, birthday: f.birthday.value, diagnosisDate: f.diagnosisDate.value, address: f.address.value
        };
        const btn = f.querySelector('button[type="submit"]');
        APP.Util.setBtnLoading(btn, true);
        try {
          await APP.API.post('updateProfile', data);
          APP.Util.toast('è³‡æ–™å·²æ›´æ–°', 'success');
          await APP.AppView.loadProfile();
        } catch (e2) { APP.Util.toast('æ›´æ–°å¤±æ•—ï¼š' + e2.message, 'error'); }
        finally { APP.Util.setBtnLoading(btn, false); }
      },

      // Modal
      showDonationModal() {
        const html = `
          <div class="modal fade" id="donationModal" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>æˆ‘è¦ææ¬¾</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="form-floating mb-3">
                    <input type="number" class="form-control" name="amount" required min="1" />
                    <label>ææ¬¾é‡‘é¡ *</label>
                  </div>
                  <div class="form-floating mb-3">
                    <select class="form-select" name="category">
                      <option>ä¸€èˆ¬ææ¬¾</option><option>æ´»å‹•è´ŠåŠ©</option>
                    </select>
                    <label>ææ¬¾é¡åˆ¥</label>
                  </div>
                  <div class="form-floating mb-3">
                    <textarea class="form-control" name="description" style="height:80px;"></textarea>
                    <label>èªªæ˜</label>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" name="needReceipt" id="needReceipt">
                    <label class="form-check-label" for="needReceipt">éœ€è¦æ”¶æ“š</label>
                  </div>
                  <div class="alert alert-info small">è‹¥æ‚¨çš„é›»å­éƒµä»¶æœªå¡«å¯«ï¼Œæ”¶æ“šå°‡åƒ…ç”¢ç”Ÿ PDF ä¾›ä¸‹è¼‰ï¼Œä¸æœƒå¯„é€ Emailã€‚</div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                  <button type="submit" class="btn btn-gradient">ç¢ºèªææ¬¾</button>
                </div>
              </form>
            </div>
          </div>`;
        APP.Util.modal(html, async (fd) => {
          const data = {
            amount: fd.get('amount'), category: fd.get('category'), description: fd.get('description'),
            needReceipt: fd.get('needReceipt') === 'on'
          };
          const res = await APP.API.post('createDonation', data);
          APP.Util.toast('ææ¬¾è¨˜éŒ„å·²æ–°å¢ï¼Œæ„Ÿè¬æ‚¨çš„æ”¯æŒï¼', 'success');
          if (res?.data?.pdfUrl) APP.Util.toast('å·²ç”¢ç”Ÿæ”¶æ“š PDFï¼Œè«‹è‡³ã€Œæˆ‘çš„æ”¶æ“šã€ä¸‹è¼‰', 'info');
          await APP.AppView.loadFinance();
          await APP.AppView.loadHomeData();
        });
      },
      showNewExpenseModal() {
        const html = `
          <div class="modal fade" id="expenseModal" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>æ”¯å‡ºç”³è«‹</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="form-floating mb-3">
                    <input type="number" class="form-control" name="amount" required min="1"/>
                    <label>é‡‘é¡ *</label>
                  </div>
                  <div class="form-floating mb-3">
                    <select class="form-select" name="category" required>
                      <option value="">è«‹é¸æ“‡</option>
                      <option>æ´»å‹•è²»ç”¨</option><option>è¡Œæ”¿æ”¯å‡º</option><option>è¨­å‚™æ”¯å‡º</option>
                    </select>
                    <label>é¡åˆ¥ *</label>
                  </div>
                  <div class="form-floating mb-3">
                    <textarea class="form-control" name="description" required style="height:100px;"></textarea>
                    <label>èªªæ˜ *</label>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                  <button type="submit" class="btn btn-gradient">é€å‡ºç”³è«‹</button>
                </div>
              </form>
            </div>
          </div>`;
        APP.Util.modal(html, async(fd)=>{
          const data = { amount: fd.get('amount'), category: fd.get('category'), description: fd.get('description') };
          await APP.API.post('createExpense', data);
          APP.Util.toast('æ”¯å‡ºç”³è«‹å·²é€å‡º','success');
          await APP.AppView.loadFinance();
        });
      }
    },

    // ========== æœƒå“¡ä¸­å¿ƒï¼ˆç¬¬å››æ®µï¼‰ ==========
    Member: {
      selectedMood: 5,
      selectedTags: [],
      async initMember() {
        // åˆæ¬¡è¼‰å…¥ä½¿ç”¨ memberInfo
        const info = APP.State.memberInfo;
        if (info) {
          document.getElementById('mc-name').textContent = info.name || '-';
          document.getElementById('mc-no').textContent = 'æœƒå“¡ç·¨è™Ÿï¼š' + (info.memberNo || '---');
          document.getElementById('mc-avatar').textContent = (info.name||'A').charAt(0);
        }
        // è¼‰å…¥é¦–é è³‡æ–™
        APP.Member.loadTodayReminders();
        APP.Member.loadUpcomingEvents();
      },
      show(section){
        document.querySelectorAll('.member-section').forEach(s=> s.classList.remove('active'));
        switch(section){
          case 'home': document.getElementById('mc-home').classList.add('active'); APP.Member.loadTodayReminders(); APP.Member.loadUpcomingEvents(); break;
          case 'symptom': document.getElementById('mc-symptom').classList.add('active'); APP.Member.loadSymptomHistory(); break;
          case 'medication': document.getElementById('mc-medication').classList.add('active'); APP.Member.loadMedications(); break;
          case 'exercise': document.getElementById('mc-exercise').classList.add('active'); break;
          case 'sleep': document.getElementById('mc-sleep').classList.add('active'); break;
          case 'mood': document.getElementById('mc-mood').classList.add('active'); break;
          case 'events': document.getElementById('mc-events').classList.add('active'); APP.Member.loadEvents(); APP.Member.loadMyEvents(); break;
          case 'profile': document.getElementById('mc-profile').classList.add('active'); APP.Member.loadProfile(); APP.Member.loadDonationHistory(); break;
          default: document.getElementById('mc-home').classList.add('active');
        }
      },
      async loadTodayReminders(){
        const c = document.getElementById('mc-today-reminders');
        try{
          const res = await APP.API.postJson({ action:'getMedications', memberId: APP.State.memberInfo?.memberId });
          const arr = res.data || [];
          if (!arr.length) { c.innerHTML = '<div class="text-center text-muted py-4">ä»Šå¤©æ²’æœ‰æé†’äº‹é …</div>'; return; }
          let html = '';
          arr.forEach(m=>{
            let times = [];
            try{ times = JSON.parse(m.frequency || '[]'); }catch{}
            times.forEach(t=>{
              html += `
                <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                  <div>
                    <div class="fw-bold">ğŸ’Š ${m.medicineName}</div>
                    <div class="small text-muted">${t} - ${m.dosage||''}</div>
                  </div>
                  <button class="btn btn-sm btn-primary" onclick="APP.Member.logMedication('${m.medicationId}','${t}')">å·²æœç”¨</button>
                </div>
              `;
            });
          });
          c.innerHTML = html;
        } catch(e){
          c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
        }
      },
      async loadUpcomingEvents(){
        const c = document.getElementById('mc-upcoming-events');
        try{
          const today = new Date().toISOString().split('T')[0];
          const res = await APP.API.postJson({ action:'getEvents', status:'å ±åä¸­', startDate: today });
          const arr = res.data || [];
          if (!arr.length) { c.innerHTML = '<div class="text-center text-muted py-4">ç›®å‰æ²’æœ‰æ´»å‹•</div>'; return; }
          c.innerHTML = arr.slice(0,3).map(ev=> `
            <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
              <div>
                <div class="fw-bold">${ev.eventName}</div>
                <div class="small text-muted">ğŸ“… ${ev.eventDate} ${ev.startTime}ã€€ğŸ“ ${ev.location}</div>
              </div>
              <span class="badge bg-info">${ev.registrationCount}/${ev.maxParticipants}</span>
            </div>
          `).join('');
        } catch(e){ c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>'; }
      },
      async addSymptom(e){
        e.preventDefault();
        try{
          const res = await APP.API.postJson({
            action:'addDailySymptom',
            memberId: APP.State.memberInfo?.memberId,
            recordDate: new Date().toISOString().split('T')[0],
            tremorLevel: document.getElementById('mc-tremor').value,
            rigidityLevel: document.getElementById('mc-rigidity').value,
            bradykinesiaLevel: document.getElementById('mc-brady').value,
            balanceLevel: document.getElementById('mc-balance').value,
            notes: document.getElementById('mc-symptom-notes').value
          });
          if (res?.success) {
            APP.Util.toast('è¨˜éŒ„æˆåŠŸ','success');
            e.target.reset();
            APP.Member.loadSymptomHistory();
          } else { APP.Util.toast(res?.message || 'æ–°å¢å¤±æ•—','error'); }
        } catch { APP.Util.toast('ç³»çµ±éŒ¯èª¤','error'); }
      },
      async loadSymptomHistory(){
        const c = document.getElementById('mc-symptom-history');
        try{
          const end = new Date().toISOString().split('T')[0];
          const start = new Date(Date.now()-30*24*60*60*1000).toISOString().split('T')[0];
          const res = await APP.API.postJson({ action:'getDailySymptoms', memberId: APP.State.memberInfo?.memberId, startDate: start, endDate: end });
          const arr = res.data || [];
          if (!arr.length) { c.innerHTML = '<div class="text-center text-muted py-4">å°šç„¡è¨˜éŒ„</div>'; return; }
          c.innerHTML = arr.map(s=> `
            <div class="border rounded p-2 mb-2">
              <div class="fw-bold">${s.recordDate}</div>
              <div class="small text-muted">é¡«æŠ–:${s.tremorLevel} | åƒµç¡¬:${s.rigidityLevel} | é²ç·©:${s.bradykinesiaLevel} | å¹³è¡¡:${s.balanceLevel}</div>
            </div>
          `).join('');
        } catch{ c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>'; }
      },
      openAddMedication(){
        const html = `
          <div class="modal fade" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header">
                  <div class="modal-title">æ–°å¢ç”¨è—¥</div>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label class="form-label">è—¥ç‰©åç¨± *</label>
                    <input class="form-control" name="name" required/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">åŠ‘é‡</label>
                    <input class="form-control" name="dosage"/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label mb-2">æœç”¨æ™‚é–“ï¼ˆè‡³å°‘ä¸€å€‹ï¼‰</label><br/>
                    ${['08:00','12:00','18:00','22:00'].map(t=>`
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="times" value="${t}" id="t-${t}">
                        <label class="form-check-label" for="t-${t}">${t}</label>
                      </div>`).join('')}
                  </div>
                  <div class="mb-3">
                    <label class="form-label">é–‹å§‹æ—¥æœŸ</label>
                    <input type="date" class="form-control" name="startdate" value="${new Date().toISOString().split('T')[0]}"/>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" name="reminder" id="reminder" checked/>
                    <label class="form-check-label" for="reminder">å•Ÿç”¨æé†’</label>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">æå‰æé†’ï¼ˆåˆ†é˜ï¼‰</label>
                    <input type="number" class="form-control" name="advance" value="10" min="0"/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">å‚™è¨»</label>
                    <textarea class="form-control" name="notes" rows="3"></textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
                  <button class="btn btn-primary" type="submit">æ–°å¢ç”¨è—¥</button>
                </div>
              </form>
            </div>
          </div>`;
        APP.Util.modal(html, async(fd)=>{
          const times = fd.getAll('times');
          if (!times.length) throw new Error('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æœè—¥æ™‚é–“');
          const res = await APP.API.postJson({
            action:'addMedication',
            memberId: APP.State.memberInfo?.memberId,
            medicineName: fd.get('name'),
            dosage: fd.get('dosage'),
            frequency: JSON.stringify(times),
            startDate: fd.get('startdate') || new Date().toISOString().split('T')[0],
            reminderEnabled: fd.get('reminder')==='on',
            reminderMinutes: fd.get('advance') || 10,
            notes: fd.get('notes')
          });
          if (res?.success) {
            APP.Util.toast('æ–°å¢æˆåŠŸ','success');
            APP.Member.loadMedications();
          } else throw new Error(res?.message || 'æ–°å¢å¤±æ•—');
        });
      },
      async loadMedications(){
        const c = document.getElementById('mc-medication-list');
        try{
          const res = await APP.API.postJson({ action:'getMedications', memberId: APP.State.memberInfo?.memberId });
          const arr = res.data || [];
          if (!arr.length) { c.innerHTML = '<div class="text-center text-muted py-4">å°šæœªæ–°å¢ç”¨è—¥</div>'; return; }
          c.innerHTML = arr.map(m=>{
            let times=[]; try{ times = JSON.parse(m.frequency||'[]'); }catch{}
            return `
            <div class="border rounded p-2 mb-2">
              <div class="fw-bold">${m.medicineName}</div>
              <div class="small text-muted">${m.dosage||''} | ${times.join(', ')}</div>
            </div>`;
          }).join('');
        } catch{ c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>'; }
      },
      async logMedication(id, time){
        try {
          const res = await APP.API.postJson({
            action:'logMedication',
            medicationId: id, memberId: APP.State.memberInfo?.memberId,
            scheduledTime: time, status:'å·²æœç”¨'
          });
          if (res?.success) { APP.Util.toast('å·²è¨˜éŒ„æœè—¥','success'); APP.Member.loadTodayReminders(); }
          else APP.Util.toast(res?.message || 'è¨˜éŒ„å¤±æ•—','error');
        } catch { APP.Util.toast('ç³»çµ±éŒ¯èª¤','error'); }
      },
      async addExercise(e){
        e.preventDefault();
        try {
          const res = await APP.API.postJson({
            action:'addExerciseLog', memberId: APP.State.memberInfo?.memberId,
            exerciseDate: new Date().toISOString().split('T')[0],
            exerciseType: document.getElementById('mc-ex-type').value,
            duration: document.getElementById('mc-ex-duration').value,
            intensity: document.getElementById('mc-ex-intensity').value,
            bodyCondition: document.getElementById('mc-ex-condition').value,
            notes: document.getElementById('mc-ex-notes').value
          });
          if (res?.success) { APP.Util.toast('è¨˜éŒ„æˆåŠŸ','success'); e.target.reset(); }
          else APP.Util.toast(res?.message || 'è¨˜éŒ„å¤±æ•—','error');
        } catch { APP.Util.toast('ç³»çµ±éŒ¯èª¤','error'); }
      },
      async addSleep(e){
        e.preventDefault();
        const bed = document.getElementById('mc-sleep-bed').value;
        const wake = document.getElementById('mc-sleep-wake').value;
        let bd = new Date('2000-01-01 ' + bed), wk = new Date('2000-01-01 ' + wake);
        if (wk < bd) wk.setDate(wk.getDate()+1);
        const dur = ((wk - bd)/(1000*60*60)).toFixed(1);
        try{
          const res = await APP.API.postJson({
            action:'addSleepLog', memberId: APP.State.memberInfo?.memberId,
            sleepDate: new Date().toISOString().split('T')[0],
            bedtime: bed, wakeTime: wake, duration: dur,
            quality: document.getElementById('mc-sleep-quality').value,
            wakeCount: document.getElementById('mc-sleep-wakecount').value,
            hasDream: document.getElementById('mc-sleep-dream').checked,
            hasNightmare: document.getElementById('mc-sleep-nightmare').checked,
            notes: document.getElementById('mc-sleep-notes').value
          });
          if (res?.success) { APP.Util.toast('è¨˜éŒ„æˆåŠŸ','success'); e.target.reset(); }
          else APP.Util.toast(res?.message || 'è¨˜éŒ„å¤±æ•—','error');
        } catch { APP.Util.toast('ç³»çµ±éŒ¯èª¤','error'); }
      },
      selectMood(score){
        APP.Member.selectedMood = score;
        document.getElementById('mc-mood-score').value = score;
      },
      toggleTag(el){
        const tag = el.dataset.tag;
        const idx = APP.Member.selectedTags.indexOf(tag);
        if (idx>=0) { APP.Member.selectedTags.splice(idx,1); el.classList.remove('bg-primary'); el.classList.add('bg-secondary'); }
        else { APP.Member.selectedTags.push(tag); el.classList.remove('bg-secondary'); el.classList.add('bg-primary'); }
      },
      async addMood(e){
        e.preventDefault();
        try{
          const res = await APP.API.postJson({
            action:'addMoodDiary', memberId: APP.State.memberInfo?.memberId,
            diaryDate: new Date().toISOString().split('T')[0],
            moodScore: document.getElementById('mc-mood-score').value,
            moodTags: APP.Member.selectedTags.join(','),
            content: document.getElementById('mc-mood-content').value
          });
          if (res?.success) {
            APP.Util.toast('è¨˜éŒ„æˆåŠŸ','success');
            e.target.reset();
            APP.Member.selectedTags = [];
            document.querySelectorAll('#mc-mood-tags .badge').forEach(b=> { b.classList.add('bg-secondary'); b.classList.remove('bg-primary'); });
          } else APP.Util.toast(res?.message || 'è¨˜éŒ„å¤±æ•—','error');
        } catch{ APP.Util.toast('ç³»çµ±éŒ¯èª¤','error'); }
      },
      async loadEvents(){
        const c = document.getElementById('mc-events-list');
        try{
          const today = new Date().toISOString().split('T')[0];
          const res = await APP.API.postJson({ action:'getEvents', status:'å ±åä¸­', startDate: today });
          const arr = res.data || [];
          if (!arr.length) { c.innerHTML = '<div class="text-center text-muted py-4">ç›®å‰æ²’æœ‰æ´»å‹•</div>'; return; }
          c.innerHTML = arr.map(ev=>{
            const full = Number(ev.registrationCount)>=Number(ev.maxParticipants);
            return `
              <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                <div>
                  <div class="fw-bold">${ev.eventName}</div>
                  <div class="small text-muted">ğŸ“… ${ev.eventDate} ${ev.startTime}ã€€ğŸ“ ${ev.location}</div>
                  <div class="small">ğŸ‘¥ ${ev.registrationCount}/${ev.maxParticipants}</div>
                </div>
                <span class="badge ${full? 'bg-danger':'bg-info'}">${full? 'å·²é¡æ»¿':'å ±åä¸­'}</span>
              </div>`;
          }).join('');
        } catch{ c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>'; }
      },
      async loadMyEvents(){
        const c = document.getElementById('mc-my-events');
        try{
          const res = await APP.API.postJson({ action:'getMyEvents', memberId: APP.State.memberInfo?.memberId });
          const arr = res.data || [];
          if (!arr.length) { c.innerHTML = '<div class="text-center text-muted py-4">å°šæœªå ±åæ´»å‹•</div>'; return; }
          c.innerHTML = arr.map(ev=>{
            let badge = 'bg-info';
            if (ev.registrationStatus==='å·²ç¢ºèª') badge='bg-success';
            else if (ev.registrationStatus==='å€™è£œ') badge='bg-warning';
            else if (ev.registrationStatus==='å·²å–æ¶ˆ') badge='bg-danger';
            return `
              <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                <div>
                  <div class="fw-bold">${ev.eventName}</div>
                  <div class="small text-muted">ğŸ“… ${ev.eventDate} ${ev.startTime}ã€€ğŸ“ ${ev.location}</div>
                </div>
                <span class="badge ${badge}">${ev.registrationStatus}</span>
              </div>`;
          }).join('');
        } catch{ c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>'; }
      },
      async loadProfile(){
        const c = document.getElementById('mc-profile-info');
        try{
          const res = await APP.API.postJson({ action:'getMemberInfo', memberId: APP.State.memberInfo?.memberId });
          const d = res.data || {};
          c.innerHTML = `
            <div class="row g-3">
              <div class="col-12 col-md-6"><div class="small text-muted">å§“å</div><div class="fw-bold">${d.name||'-'}</div></div>
              <div class="col-12 col-md-6"><div class="small text-muted">æœƒå“¡ç·¨è™Ÿ</div><div class="fw-bold">${d.memberNo||'-'}</div></div>
              <div class="col-12 col-md-6"><div class="small text-muted">Email</div><div class="fw-bold">${d.email||'-'}</div></div>
              <div class="col-12 col-md-6"><div class="small text-muted">æ‰‹æ©Ÿ</div><div class="fw-bold">${d.phone||'-'}</div></div>
              <div class="col-12"><div class="small text-muted">åœ°å€</div><div class="fw-bold">${d.address||'æœªå¡«å¯«'}</div></div>
            </div>`;
        } catch{ c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>'; }
      },
      async loadDonationHistory(){
        const c = document.getElementById('mc-donation-history');
        try{
          const res = await APP.API.postJson({ action:'getDonations', memberId: APP.State.memberInfo?.memberId });
          const data = res.data || {};
          const list = data.donations || [];
          if (!list.length) { c.innerHTML = '<div class="text-center text-muted py-3">å°šç„¡ææ¬¾è¨˜éŒ„</div>'; return; }
          let html = `
            <div class="p-2 rounded mb-2" style="background:#f8f9fa;">
              <div class="small text-muted">ç´¯è¨ˆææ¬¾</div>
              <div class="fs-4 fw-bold text-primary">NT$ ${APP.Util.currency(data.totalAmount||0)}</div>
            </div>`;
          html += list.map(d=> `
            <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
              <div>
                <div class="fw-bold">NT$ ${APP.Util.currency(d.amount)}</div>
                <div class="small text-muted">${d.donationDate} | ${d.purpose||''}</div>
              </div>
              ${d.receiptIssued? '<span class="badge bg-success">å·²é–‹ç«‹æ”¶æ“š</span>':''}
            </div>`).join('');
          c.innerHTML = html;
        } catch { c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>'; }
      }
    },

    // ========== ç®¡ç†å¾Œå°ï¼ˆç¬¬ä¸‰æ®µï¼‰ ==========
    Admin: {
      binded: false,
      async initAdmin(){
        // æ¬Šé™æª¢æŸ¥
        if (!APP.State.isAdmin) { APP.Util.toast('æ²’æœ‰æ¬Šé™','error'); APP.Router.go('member'); return; }

        if (!APP.Admin.binded) {
          // å´é‚Šé¸å–®åˆ‡æ›
          document.querySelectorAll('#admin-menu .menu-item').forEach(mi=>{
            mi.addEventListener('click', (e)=>{
              document.querySelectorAll('#admin-menu .menu-item').forEach(m=> m.classList.remove('active'));
              mi.classList.add('active');
              const section = mi.getAttribute('data-admin-section');
              APP.Admin.showSection(section);
            });
          });
          APP.Admin.binded = true;
        }
        // åˆå§‹åŒ–è³‡æ–™
        APP.Admin.loadDashboard();
        APP.Admin.loadSettings();
        const admin = APP.State.memberInfo || { name:'ç®¡ç†å“¡' };
        document.getElementById('admin-name').textContent = admin.name || 'ç®¡ç†å“¡';
        document.getElementById('admin-avatar').textContent = (admin.name || 'A').charAt(0);
      },
      toggleSidebar(){ document.getElementById('admin-sidebar').classList.toggle('collapsed'); },
      showSection(sec){
        document.querySelectorAll('.admin-section').forEach(s=> s.classList.remove('active'));
        document.getElementById('admin-'+sec).classList.add('active');
        const titles = { dashboard:'ç³»çµ±ç¸½è¦½', members:'æœƒå“¡ç®¡ç†', events:'æ´»å‹•ç®¡ç†', health:'å¥åº·è¨˜éŒ„', donations:'ææ¬¾ç®¡ç†', reports:'çµ±è¨ˆå ±è¡¨', settings:'ç³»çµ±è¨­å®š' };
        document.getElementById('admin-page-title').textContent = titles[sec] || 'ç³»çµ±ç¸½è¦½';
        // è¼‰å…¥å°æ‡‰è³‡æ–™
        switch(sec){
          case 'dashboard': APP.Admin.loadDashboard(); break;
          case 'members': APP.Admin.loadMembers(1); break;
          case 'events': APP.Admin.loadEvents(1); break;
          case 'health': APP.Admin.loadHealth(1); break;
          case 'donations': APP.Admin.loadDonations(1); break;
          case 'reports': APP.Admin.loadReports(); break;
          case 'settings': APP.Admin.loadSettings(); break;
        }
      },
      setLoading(on){ document.getElementById('admin-loading').classList.toggle('d-none', !on); },
      setAlert(msg, type='info'){
        const al = document.getElementById('admin-alert');
        al.className = 'alert alert-' + (type==='error'? 'danger': type);
        al.textContent = msg;
        al.classList.remove('d-none');
        setTimeout(()=> al.classList.add('d-none'), 5000);
      },
      async loadDashboard(){
        APP.Admin.setLoading(true);
        try{
          const [m,e,d,a] = await Promise.all([
            APP.API.get({ action:'getStats', type:'members' }),
            APP.API.get({ action:'getStats', type:'events' }),
            APP.API.get({ action:'getStats', type:'donations' }),
            APP.API.get({ action:'getRecentActivities' })
          ]);
          if (m?.success) { document.getElementById('adm-total-members').textContent = m.data.total || 0; document.getElementById('adm-active-members').textContent = m.data.active || 0; }
          if (e?.success) { document.getElementById('adm-total-events').textContent = e.data.total || 0; }
          if (d?.success) { document.getElementById('adm-total-donations').textContent = 'NT$ ' + APP.Util.currency(d.data.total || 0); }
          const actC = document.getElementById('adm-recent-activities');
          if (a?.success && a.data?.length) {
            actC.innerHTML = a.data.map(x=> `
              <div class="border-bottom py-2 d-flex justify-content-between">
                <div><strong>${x.type}</strong><div class="small text-muted">${x.description}</div></div>
                <small class="text-muted">${x.timestamp}</small>
              </div>`).join('');
          } else { actC.innerHTML = '<div class="text-center text-muted py-4">æš«ç„¡å‹•æ…‹è¨˜éŒ„</div>'; }
        } catch { APP.Admin.setAlert('è¼‰å…¥ç¸½è¦½å¤±æ•—','error'); }
        finally{ APP.Admin.setLoading(false); }
      },
      // æœƒå“¡
      async loadMembers(page=1){
        APP.Admin.setLoading(true);
        try{
          const search = document.getElementById('adm-member-search').value || '';
          const status = document.getElementById('adm-member-status').value || '';
          const r = await APP.API.get({ action:'getMembers', page, pageSize: APP.State.pageSize, search, status });
          const body = document.getElementById('adm-members-body');
          if (r?.success && r.data?.length) {
            body.innerHTML = r.data.map(m=> `
              <tr>
                <td>${m.memberNo||'-'}</td><td>${m.name||'-'}</td><td>${m.email||'-'}</td>
                <td>${m.phone||'-'}</td><td>${m.registerDate||'-'}</td>
                <td><span class="badge badge-${APP.Util.getStatusClass(m.status)}">${m.status||'-'}</span></td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="APP.Admin.viewMember('${m.memberId}')">æŸ¥çœ‹</button>
                  <button class="btn btn-sm btn-warning" onclick="APP.Admin.editMember('${m.memberId}')">ç·¨è¼¯</button>
                  <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteMember('${m.memberId}')">åˆªé™¤</button>
                </td>
              </tr>`).join('');
            APP.Admin.pagination('members', r.totalPages || 1, page);
          } else {
            body.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">æ²’æœ‰è³‡æ–™</td></tr>';
            APP.Admin.pagination('members', 1, 1);
          }
        } catch { APP.Admin.setAlert('è¼‰å…¥æœƒå“¡å¤±æ•—','error'); }
        finally{ APP.Admin.setLoading(false); }
      },
      pagination(key, totalPages, currentPage){
        const id = 'adm-' + key + '-pagination';
        const el = document.getElementById(id);
        if (!el) return;
        let html = '';
        const fnMap = { members:'loadMembers', events:'loadEvents', health:'loadHealth', donations:'loadDonations' };
        const fn = 'APP.Admin.' + (fnMap[key] || 'loadMembers');
        html += `<button class="btn btn-sm btn-outline-secondary" ${currentPage<=1?'disabled':''} onclick="${fn}(${currentPage-1})">ä¸Šä¸€é </button>`;
        const sp = Math.max(1, currentPage-2), ep = Math.min(totalPages, currentPage+2);
        for(let i=sp;i<=ep;i++){
          html += `<button class="btn btn-sm ${i===currentPage?'btn-primary':'btn-outline-secondary'}" onclick="${fn}(${i})">${i}</button>`;
        }
        html += `<button class="btn btn-sm btn-outline-secondary" ${currentPage>=totalPages?'disabled':''} onclick="${fn}(${currentPage+1})">ä¸‹ä¸€é </button>`;
        el.innerHTML = html;
      },
      showAddMember(){
        const html = `
          <div class="modal fade" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header"><div class="modal-title">æ–°å¢æœƒå“¡</div><button class="btn-close" type="button" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                  <div class="row g-2">
                    <div class="col-12 col-md-6"><label class="form-label">å§“å *</label><input name="name" class="form-control" required/></div>
                    <div class="col-12 col-md-6"><label class="form-label">æœƒå“¡ç·¨è™Ÿ</label><input name="memberNo" class="form-control" placeholder="ç³»çµ±è‡ªå‹•ç”¢ç”Ÿ"/></div>
                    <div class="col-12 col-md-6"><label class="form-label">Email *</label><input name="email" type="email" class="form-control" required/></div>
                    <div class="col-12 col-md-6"><label class="form-label">é›»è©±</label><input name="phone" class="form-control"/></div>
                    <div class="col-12 col-md-6"><label class="form-label">æ€§åˆ¥</label><select name="gender" class="form-select"><option value="">è«‹é¸æ“‡</option><option>ç”·</option><option>å¥³</option><option>å…¶ä»–</option></select></div>
                    <div class="col-12 col-md-6"><label class="form-label">ç”Ÿæ—¥</label><input type="date" name="birthday" class="form-control"/></div>
                    <div class="col-12"><label class="form-label">åœ°å€</label><textarea name="address" class="form-control" rows="2"></textarea></div>
                    <div class="col-12"><label class="form-label">å‚™è¨»</label><textarea name="notes" class="form-control" rows="2"></textarea></div>
                  </div>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button><button class="btn btn-primary" type="submit">æ–°å¢æœƒå“¡</button></div>
              </form>
            </div>
          </div>`;
        APP.Util.modal(html, async(fd)=>{
          const res = await APP.API.get({
            action:'addMember',
            name: fd.get('name'),
            memberNo: fd.get('memberNo'),
            email: fd.get('email'),
            phone: fd.get('phone'),
            gender: fd.get('gender'),
            birthday: fd.get('birthday'),
            address: fd.get('address'),
            notes: fd.get('notes')
          });
          if (res?.success) { APP.Util.toast('æ–°å¢æˆåŠŸ','success'); APP.Admin.loadMembers(1); }
          else throw new Error(res?.message || 'æ–°å¢å¤±æ•—');
        });
      },
      viewMember(id){ APP.Util.toast('æŸ¥çœ‹åŠŸèƒ½å¯æ“´å……','info'); },
      editMember(id){ APP.Util.toast('ç·¨è¼¯åŠŸèƒ½å¯æ“´å……','info'); },
      async deleteMember(id){
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æœƒå“¡ï¼Ÿ')) return;
        const r = await APP.API.get({ action:'deleteMember', memberId: id });
        if (r?.success){ APP.Util.toast('åˆªé™¤æˆåŠŸ','success'); APP.Admin.loadMembers(1); }
        else APP.Util.toast(r?.message || 'åˆªé™¤å¤±æ•—','error');
      },

      // æ´»å‹•
      async loadEvents(page=1){
        APP.Admin.setLoading(true);
        try{
          const search = document.getElementById('adm-event-search').value || '';
          const status = document.getElementById('adm-event-status').value || '';
          const r = await APP.API.get({ action:'getEvents', page, pageSize: APP.State.pageSize, search, status });
          const body = document.getElementById('adm-events-body');
          if (r?.success && r.data?.length) {
            body.innerHTML = r.data.map(ev=> `
              <tr>
                <td>${ev.eventName}</td>
                <td>${ev.eventDate||''} ${ev.startTime||''}</td>
                <td>${ev.location||''}</td>
                <td>${ev.registrationCount}/${ev.maxParticipants}</td>
                <td><span class="badge badge-${APP.Util.getStatusClass(ev.status)}">${ev.status||''}</span></td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="APP.Admin.viewEvent('${ev.eventId}')">æŸ¥çœ‹</button>
                  <button class="btn btn-sm btn-warning" onclick="APP.Admin.editEvent('${ev.eventId}')">ç·¨è¼¯</button>
                  <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteEvent('${ev.eventId}')">åˆªé™¤</button>
                </td>
              </tr>`).join('');
            APP.Admin.pagination('events', r.totalPages || 1, page);
          } else {
            body.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">æ²’æœ‰è³‡æ–™</td></tr>';
            APP.Admin.pagination('events', 1, 1);
          }
        } catch { APP.Admin.setAlert('è¼‰å…¥æ´»å‹•å¤±æ•—','error'); }
        finally{ APP.Admin.setLoading(false); }
      },
      showAddEvent(){
        const html = `
          <div class="modal fade" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header"><div class="modal-title">æ–°å¢æ´»å‹•</div><button class="btn-close" type="button" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                  <div class="row g-2">
                    <div class="col-12"><label class="form-label">æ´»å‹•åç¨± *</label><input name="name" class="form-control" required/></div>
                    <div class="col-6"><label class="form-label">æ´»å‹•æ—¥æœŸ *</label><input type="date" name="date" class="form-control" required/></div>
                    <div class="col-6"><label class="form-label">é–‹å§‹æ™‚é–“ *</label>                    <input type="time" name="start" class="form-control" required/></div>
                  <div class="col-6"><label class="form-label">çµæŸæ™‚é–“ *</label><input type="time" name="end" class="form-control" required/></div>
                  <div class="col-6"><label class="form-label">å ±åä¸Šé™</label><input type="number" name="max" class="form-control" min="1" value="30"/></div>
                  <div class="col-12"><label class="form-label">æ´»å‹•åœ°é» *</label><input name="location" class="form-control" required/></div>
                  <div class="col-12"><label class="form-label">æ´»å‹•æè¿°</label><textarea name="desc" class="form-control" rows="3"></textarea></div>
                  <div class="col-12"><label class="form-label">å ±åè²»ç”¨ (å…ƒ)</label><input type="number" name="fee" class="form-control" min="0" value="0"/></div>
                </div>
              </div>
              <div class="modal-footer"><button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button><button class="btn btn-primary" type="submit">æ–°å¢æ´»å‹•</button></div>
            </form>
          </div>
        </div>`;
        APP.Util.modal(html, async(fd)=>{
          const r = await APP.API.get({
            action:'addEvent',
            eventName: fd.get('name'),
            eventType: 'å…¶ä»–',
            eventDate: fd.get('date'),
            startTime: fd.get('start'),
            endTime: fd.get('end'),
            location: fd.get('location'),
            description: fd.get('desc'),
            maxParticipants: fd.get('max'),
            fee: fd.get('fee') || 0
          });
          if (r?.success) { APP.Util.toast('æ–°å¢æˆåŠŸ','success'); APP.Admin.loadEvents(1); }
          else throw new Error(r?.message || 'æ–°å¢å¤±æ•—');
        });
      },
      viewEvent(id){ APP.Util.toast('æŸ¥çœ‹åŠŸèƒ½å¯æ“´å……','info'); },
      editEvent(id){ APP.Util.toast('ç·¨è¼¯åŠŸèƒ½å¯æ“´å……','info'); },
      async deleteEvent(id){
        if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ´»å‹•ï¼Ÿ')) return;
        const r = await APP.API.get({ action:'deleteEvent', eventId: id });
        if (r?.success){ APP.Util.toast('åˆªé™¤æˆåŠŸ','success'); APP.Admin.loadEvents(1); }
        else APP.Util.toast(r?.message || 'åˆªé™¤å¤±æ•—','error');
      },

      // å¥åº·
      async loadHealth(page=1){
        APP.Admin.setLoading(true);
        try{
          const search = document.getElementById('adm-health-search').value || '';
          const dateFrom = document.getElementById('adm-health-from').value || '';
          const dateTo = document.getElementById('adm-health-to').value || '';
          const r = await APP.API.get({ action:'getAllHealthRecords', page, pageSize: APP.State.pageSize, search, dateFrom, dateTo });
          const body = document.getElementById('adm-health-body');
          if (r?.success && r.data?.length) {
            body.innerHTML = r.data.map(rec=> `
              <tr>
                <td>${rec.memberName}</td>
                <td>${rec.recordDate}</td>
                <td>${rec.tremorLevel}</td><td>${rec.rigidityLevel}</td><td>${rec.bradykinesiaLevel}</td><td>${rec.balanceLevel}</td>
                <td>${rec.notes||'-'}</td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="APP.Admin.viewHealthRecord('${rec.recordId}')">æŸ¥çœ‹</button>
                  <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteHealthRecord('${rec.recordId}')">åˆªé™¤</button>
                </td>
              </tr>`).join('');
            APP.Admin.pagination('health', r.totalPages || 1, page);
          } else {
            body.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">æ²’æœ‰è³‡æ–™</td></tr>';
            APP.Admin.pagination('health', 1, 1);
          }
        } catch { APP.Admin.setAlert('è¼‰å…¥å¥åº·è¨˜éŒ„å¤±æ•—','error'); }
        finally { APP.Admin.setLoading(false); }
      },
      viewHealthRecord(id){ APP.Util.toast('æŸ¥çœ‹åŠŸèƒ½å¯æ“´å……','info'); },
      async deleteHealthRecord(id){
        if (!confirm('ç¢ºå®šåˆªé™¤æ­¤å¥åº·è¨˜éŒ„ï¼Ÿ')) return;
        const r = await APP.API.get({ action:'deleteHealthRecord', recordId: id });
        if (r?.success) { APP.Util.toast('åˆªé™¤æˆåŠŸ','success'); APP.Admin.loadHealth(1); }
        else APP.Util.toast(r?.message || 'åˆªé™¤å¤±æ•—','error');
      },
      async exportHealth(){
        try{
          APP.Admin.setLoading(true);
          const r = await APP.API.get({ action:'exportHealthData' });
          if (r?.success) {
            const blob = new Blob([r.data], { type:'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'å¥åº·è¨˜éŒ„_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            APP.Admin.setAlert('å¥åº·è¨˜éŒ„åŒ¯å‡ºæˆåŠŸï¼','success');
          } else APP.Admin.setAlert('åŒ¯å‡ºå¤±æ•—ï¼š' + (r?.message||''),'error');
        } catch(e){ APP.Admin.setAlert('åŒ¯å‡ºå¤±æ•—ï¼š' + e.message,'error'); }
        finally { APP.Admin.setLoading(false); }
      },

      // ææ¬¾
      async loadDonations(page=1){
        APP.Admin.setLoading(true);
        try{
          const search = document.getElementById('adm-donation-search').value || '';
          const type = document.getElementById('adm-donation-type').value || '';
          const dateFrom = document.getElementById('adm-donation-from').value || '';
          const dateTo = document.getElementById('adm-donation-to').value || '';
          const r = await APP.API.get({ action:'getDonations', page, pageSize: APP.State.pageSize, search, type, dateFrom, dateTo });
          const body = document.getElementById('adm-donations-body');
          if (r?.success && r.data?.length) {
            body.innerHTML = r.data.map(d=> `
              <tr>
                <td>${d.donorName}</td>
                <td>NT$ ${APP.Util.currency(d.amount)}</td>
                <td>${d.donationType}</td>
                <td>${d.donationDate}</td>
                <td>${d.paymentMethod}</td>
                <td><span class="badge badge-${APP.Util.getStatusClass(d.status)}">${d.status}</span></td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="APP.Admin.viewDonation('${d.donationId}')">æŸ¥çœ‹</button>
                  <button class="btn btn-sm btn-warning" onclick="APP.Admin.editDonation('${d.donationId}')">ç·¨è¼¯</button>
                  <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteDonation('${d.donationId}')">åˆªé™¤</button>
                </td>
              </tr>`).join('');
            APP.Admin.pagination('donations', r.totalPages || 1, page);
          } else {
            body.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">æ²’æœ‰è³‡æ–™</td></tr>';
            APP.Admin.pagination('donations', 1, 1);
          }
        } catch { APP.Admin.setAlert('è¼‰å…¥ææ¬¾å¤±æ•—','error'); }
        finally { APP.Admin.setLoading(false); }
      },
      showAddDonation(){
        const html = `
          <div class="modal fade" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header"><div class="modal-title">æ–°å¢ææ¬¾è¨˜éŒ„</div><button class="btn-close" type="button" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                  <div class="row g-2">
                    <div class="col-12 col-md-6"><label class="form-label">ææ¬¾äººå§“å *</label><input name="name" class="form-control" required/></div>
                    <div class="col-12 col-md-6"><label class="form-label">é‡‘é¡ *</label><input type="number" name="amount" class="form-control" min="1" required/></div>
                    <div class="col-12 col-md-6"><label class="form-label">é¡å‹</label><select name="type" class="form-select"><option>ä¸€èˆ¬ææ¬¾</option><option>å®šæœŸææ¬¾</option><option>æŒ‡å®šç”¨é€”</option></select></div>
                    <div class="col-12 col-md-6"><label class="form-label">ææ¬¾æ—¥æœŸ *</label><input type="date" name="date" class="form-control" required/></div>
                    <div class="col-12 col-md-6"><label class="form-label">ä»˜æ¬¾æ–¹å¼</label><select name="pay" class="form-select"><option>éŠ€è¡Œè½‰å¸³</option><option>ä¿¡ç”¨å¡</option><option>ç¾é‡‘</option><option>æ”¯ç¥¨</option></select></div>
                    <div class="col-12 col-md-6"><label class="form-label">é›»è©±</label><input name="phone" class="form-control"/></div>
                    <div class="col-12"><label class="form-label">ç”¨é€”èªªæ˜</label><textarea name="purpose" class="form-control" rows="2"></textarea></div>
                  </div>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button><button class="btn btn-primary" type="submit">æ–°å¢è¨˜éŒ„</button></div>
              </form>
            </div>
          </div>`;
        APP.Util.modal(html, async(fd)=>{
          const r = await APP.API.get({
            action:'addDonation',
            donorName: fd.get('name'),
            amount: fd.get('amount'),
            donationType: fd.get('type'),
            donationDate: fd.get('date'),
            paymentMethod: fd.get('pay'),
            phone: fd.get('phone'),
            purpose: fd.get('purpose')
          });
          if (r?.success) { APP.Util.toast('æ–°å¢æˆåŠŸ','success'); APP.Admin.loadDonations(1); }
          else throw new Error(r?.message || 'æ–°å¢å¤±æ•—');
        });
      },
      viewDonation(id){ APP.Util.toast('æŸ¥çœ‹åŠŸèƒ½å¯æ“´å……','info'); },
      editDonation(id){ APP.Util.toast('ç·¨è¼¯åŠŸèƒ½å¯æ“´å……','info'); },
      async deleteDonation(id){
        if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ææ¬¾è¨˜éŒ„ï¼Ÿ')) return;
        const r = await APP.API.get({ action:'deleteDonation', donationId:id });
        if (r?.success){ APP.Util.toast('åˆªé™¤æˆåŠŸ','success'); APP.Admin.loadDonations(1); }
        else APP.Util.toast(r?.message || 'åˆªé™¤å¤±æ•—','error');
      },
      async exportMembers(){
        try{
          APP.Admin.setLoading(true);
          const r = await APP.API.get({ action:'exportMembers' });
          if (r?.success) {
            const blob = new Blob([r.data], { type:'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'æœƒå“¡è³‡æ–™_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            APP.Admin.setAlert('æœƒå“¡è³‡æ–™åŒ¯å‡ºæˆåŠŸï¼','success');
          } else APP.Admin.setAlert('åŒ¯å‡ºå¤±æ•—ï¼š' + (r?.message||''),'error');
        } catch(e){ APP.Admin.setAlert('åŒ¯å‡ºå¤±æ•—ï¼š' + e.message,'error'); }
        finally{ APP.Admin.setLoading(false); }
      },
      async exportAllReports(){
        try{
          APP.Admin.setLoading(true);
          const r = await APP.API.get({ action:'exportAllReports' });
          if (r?.success) {
            const blob = new Blob([r.data], { type:'application/zip' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'çµ±è¨ˆå ±è¡¨_' + new Date().toISOString().split('T')[0] + '.zip';
            a.click();
            APP.Admin.setAlert('çµ±è¨ˆå ±è¡¨åŒ¯å‡ºæˆåŠŸï¼','success');
          } else APP.Admin.setAlert('åŒ¯å‡ºå¤±æ•—ï¼š' + (r?.message||''),'error');
        } catch(e){ APP.Admin.setAlert('åŒ¯å‡ºå¤±æ•—ï¼š' + e.message,'error'); }
        finally{ APP.Admin.setLoading(false); }
      },

      // è¨­å®š
      loadSettings(){
        document.getElementById('adm-api-url').value = localStorage.getItem('admin_API_URL') || APP.State.API.alt;
        document.getElementById('adm-page-size').value = localStorage.getItem('admin_page_size') || '20';
        document.getElementById('adm-backup-interval').value = localStorage.getItem('admin_backup_interval') || '24';
        document.getElementById('adm-announcement').value = localStorage.getItem('admin_system_announcement') || '';
      },
      saveSettings(){
        const apiUrl = document.getElementById('adm-api-url').value.trim();
        const pageSize = document.getElementById('adm-page-size').value;
        const backup = document.getElementById('adm-backup-interval').value;
        const ann = document.getElementById('adm-announcement').value;
        if (apiUrl) {
          localStorage.setItem('admin_API_URL', apiUrl);
          localStorage.setItem('API_URL', apiUrl);
          APP.State.API.alt = apiUrl;
          APP.State.API.primary = apiUrl;
        }
        localStorage.setItem('admin_page_size', pageSize);
        localStorage.setItem('admin_backup_interval', backup);
        localStorage.setItem('admin_system_announcement', ann);
        APP.State.pageSize = parseInt(pageSize || '20', 10);
        APP.Admin.setAlert('è¨­å®šå·²å„²å­˜','success');
      },
      async exportData(){
        try{
          APP.Admin.setLoading(true);
          const r = await APP.API.get({ action:'exportAllData' });
          if (r?.success) {
            const blob = new Blob([r.data], { type:'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ç³»çµ±è³‡æ–™å‚™ä»½_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            APP.Admin.setAlert('è³‡æ–™åŒ¯å‡ºæˆåŠŸï¼','success');
          } else APP.Admin.setAlert('åŒ¯å‡ºå¤±æ•—ï¼š' + (r?.message||''),'error');
        } catch(e){ APP.Admin.setAlert('åŒ¯å‡ºå¤±æ•—ï¼š' + e.message,'error'); }
        finally{ APP.Admin.setLoading(false); }
      },
      async backupData(){
        try{
          APP.Admin.setLoading(true);
          const r = await APP.API.get({ action:'backupData' });
          if (r?.success) APP.Admin.setAlert('è³‡æ–™å‚™ä»½æˆåŠŸï¼','success');
          else APP.Admin.setAlert('å‚™ä»½å¤±æ•—ï¼š' + (r?.message||''),'error');
        } catch(e){ APP.Admin.setAlert('å‚™ä»½å¤±æ•—ï¼š' + e.message,'error'); }
        finally{ APP.Admin.setLoading(false); }
      },
      clearCache(){
        if (!confirm('ç¢ºå®šæ¸…é™¤å¿«å–ï¼Ÿ')) return;
        const adminInfo = localStorage.getItem('adminInfo');
        localStorage.clear();
        if (adminInfo) localStorage.setItem('adminInfo', adminInfo);
        APP.Admin.setAlert('å¿«å–æ¸…é™¤æˆåŠŸï¼','success');
        APP.Admin.loadSettings();
      },
      showAddAdmin(){
        const html = `
          <div class="modal fade" tabindex="-1">
            <div class="modal-dialog">
              <form class="modal-content">
                <div class="modal-header"><div class="modal-title">æ–°å¢ç®¡ç†å“¡</div><button class="btn-close" type="button" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                  <div class="row g-2">
                    <div class="col-12 col-md-6"><label class="form-label">ç®¡ç†å“¡å§“å *</label><input name="name" class="form-control" required/></div>
                    <div class="col-12 col-md-6"><label class="form-label">Email *</label><input name="email" type="email" class="form-control" required/></div>
                    <div class="col-12 col-md-6"><label class="form-label">å¯†ç¢¼ *</label><input name="pwd" type="password" class="form-control" required minlength="6"/></div>
                    <div class="col-12 col-md-6"><label class="form-label">ç¢ºèªå¯†ç¢¼ *</label><input name="pwd2" type="password" class="form-control" required minlength="6"/></div>
                    <div class="col-12 col-md-6"><label class="form-label">æ¬Šé™ç­‰ç´š</label><select name="role" class="form-select"><option>ä¸€èˆ¬ç®¡ç†å“¡</option><option>é«˜ç´šç®¡ç†å“¡</option></select></div>
                    <div class="col-12 col-md-6"><label class="form-label">è¯çµ¡é›»è©±</label><input name="phone" class="form-control"/></div>
                  </div>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button><button class="btn btn-primary" type="submit">æ–°å¢ç®¡ç†å“¡</button></div>
              </form>
            </div>
          </div>`;
        APP.Util.modal(html, async(fd)=>{
          if (fd.get('pwd') !== fd.get('pwd2')) throw new Error('å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦');
          const r = await APP.API.get({
            action:'addAdmin', name: fd.get('name'), email: fd.get('email'),
            password: fd.get('pwd'), role: fd.get('role'), phone: fd.get('phone')
          });
          if (r?.success) APP.Util.toast('ç®¡ç†å“¡æ–°å¢æˆåŠŸ','success');
          else throw new Error(r?.message || 'æ–°å¢å¤±æ•—');
        });
      },
      logout(){
        APP.Util.toast('å·²ç™»å‡ºç®¡ç†å¾Œå°','success');
        APP.Router.go('member');
      }
    }
  };

  // ========== å•Ÿå‹• ==========
  window.addEventListener('DOMContentLoaded', async ()=>{
    // Router åˆå§‹åŒ–ï¼šè‹¥å·²æœ‰ç™»å…¥
    const stored = localStorage.getItem('memberInfo');
    if (stored) {
      APP.State.memberInfo = JSON.parse(stored);
      APP.State.isAdmin = !!APP.State.memberInfo?.isAdmin;
      APP.Router.go('member');
    } else {
      APP.Router.go('auth');
    }
    // åˆå§‹åŒ– Auth
    APP.Auth.init();
  });

</script>
</body>
</html>
