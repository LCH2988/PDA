<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森人員管理系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 20px;
      }

      .container {
          background: white;
          border-radius: 20px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          max-width: 450px;
          width: 100%;
          overflow: hidden;
      }

      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 30px;
          text-align: center;
      }

      .header h1 {
          font-size: 24px;
          margin-bottom: 10px;
      }

      .header p {
          font-size: 14px;
          opacity: 0.9;
      }

      .content {
          padding: 30px;
      }

      .page {
          display: none;
      }

      .page.active {
          display: block;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          color: #333;
          font-weight: 600;
          font-size: 14px;
      }

      .form-group input, .form-group textarea {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e0e0e0;
          border-radius: 10px;
          font-size: 14px;
          transition: border-color 0.3s;
          font-family: inherit;
      }

      .form-group textarea {
          min-height: 100px;
          resize: vertical;
      }

      .form-group input:focus, .form-group textarea:focus {
          outline: none;
          border-color: #667eea;
      }

      .btn {
          width: 100%;
          padding: 14px;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          margin-bottom: 10px;
      }

      .btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
      }

      .btn-line {
          background: #06C755;
          color: white;
      }

      .btn-line:hover:not(:disabled) {
          background: #05b34c;
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(6, 199, 85, 0.3);
      }

      .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
      }

      .btn-primary:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
          background: white;
          color: #667eea;
          border: 2px solid #667eea;
      }

      .btn-secondary:hover {
          background: #f5f7ff;
      }

      .divider {
          text-align: center;
          margin: 25px 0;
          position: relative;
      }

      .divider::before {
          content: '';
          position: absolute;
          left: 0;
          top: 50%;
          width: 100%;
          height: 1px;
          background: #e0e0e0;
      }

      .divider span {
          background: white;
          padding: 0 15px;
          position: relative;
          color: #999;
          font-size: 14px;
      }

      .link-text {
          text-align: center;
          margin-top: 15px;
          color: #667eea;
          cursor: pointer;
          font-size: 14px;
      }

      .link-text:hover {
          text-decoration: underline;
      }

      .user-info {
          background: #f5f7ff;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
      }

      .user-info p {
          margin: 5px 0;
          color: #333;
          font-size: 14px;
      }

      .dashboard {
          display: grid;
          gap: 15px;
      }

      .dashboard-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          border-radius: 10px;
          cursor: pointer;
          transition: transform 0.3s;
      }

      .dashboard-card:hover {
          transform: translateY(-5px);
      }

      .dashboard-card h3 {
          font-size: 18px;
          margin-bottom: 5px;
      }

      .dashboard-card p {
          font-size: 14px;
          opacity: 0.9;
      }

      .success-message {
          background: #d4edda;
          color: #155724;
          padding: 12px;
          border-radius: 10px;
          margin-bottom: 15px;
          text-align: center;
          animation: slideDown 0.3s ease;
      }

      .error-message {
          background: #f8d7da;
          color: #721c24;
          padding: 12px;
          border-radius: 10px;
          margin-bottom: 15px;
          text-align: center;
          animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
          from {
              opacity: 0;
              transform: translateY(-10px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }

      .loading {
          text-align: center;
          padding: 20px;
          color: #667eea;
      }

      .activity-item {
          background: #f9f9f9;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 15px;
          border-left: 4px solid #667eea;
      }

      .activity-item h4 {
          color: #333;
          margin-bottom: 8px;
      }

      .activity-item p {
          color: #666;
          font-size: 14px;
          margin: 5px 0;
      }

      .activity-item .date {
          color: #999;
          font-size: 12px;
          margin-top: 10px;
      }

      .back-btn {
          background: #f0f0f0;
          color: #333;
          padding: 10px 20px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          margin-bottom: 20px;
          font-size: 14px;
      }

      .back-btn:hover {
          background: #e0e0e0;
      }

      .config-warning {
          background: #fff3cd;
          color: #856404;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
          border-left: 4px solid #ffc107;
      }

      .config-warning strong {
          display: block;
          margin-bottom: 5px;
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>🌟 帕金森人員管理系統</h1>
          <p>關懷與支持的社群平台</p>
      </div>

      <div class="content">
          <!-- 登入頁面 -->
          <div id="loginPage" class="page active">
              <h2 style="margin-bottom: 20px; color: #333;">歡迎登入</h2>
              
              <div id="configWarning" class="config-warning" style="display: none;">
                  <strong>⚠️ 尚未設定 API</strong>
                  請在程式碼中設定您的 Google Apps Script URL
              </div>
              
              <button class="btn btn-line" onclick="lineLogin()" id="lineLoginBtn">
                  <span style="font-size: 20px;">📱</span> 使用 LINE 登入
              </button>

              <div class="divider">
                  <span>或</span>
              </div>

              <div class="form-group">
                  <label>電話號碼</label>
                  <input type="tel" id="loginPhone" placeholder="請輸入電話號碼">
              </div>

              <div class="form-group">
                  <label>密碼</label>
                  <input type="password" id="loginPassword" placeholder="請輸入密碼" onkeypress="if(event.key==='Enter') normalLogin()">
              </div>

              <button class="btn btn-primary" onclick="normalLogin()" id="loginBtn">登入</button>

              <div class="link-text" onclick="showPage('registerPage')">
                  還沒有帳號？立即註冊
              </div>
          </div>

          <!-- LINE 首次登入 - 實名制 -->
          <div id="lineRegisterPage" class="page">
              <h2 style="margin-bottom: 20px; color: #333;">完成註冊</h2>
              
              <div class="user-info">
                  <p><strong>LINE ID:</strong> <span id="displayLineId">-</span></p>
                  <p><strong>LINE 名稱:</strong> <span id="displayLineName">-</span></p>
              </div>

              <div class="form-group">
                  <label>真實姓名 *</label>
                  <input type="text" id="realName" placeholder="請輸入您的真實姓名">
              </div>

              <button class="btn btn-primary" onclick="completeLineRegister()" id="lineRegBtn">完成註冊</button>
          </div>

          <!-- 一般註冊頁面 -->
          <div id="registerPage" class="page">
              <h2 style="margin-bottom: 20px; color: #333;">註冊帳號</h2>

              <div class="form-group">
                  <label>真實姓名 *</label>
                  <input type="text" id="regName" placeholder="請輸入您的真實姓名">
              </div>

              <div class="form-group">
                  <label>電話號碼 *</label>
                  <input type="tel" id="regPhone" placeholder="請輸入電話號碼">
              </div>

              <div class="form-group">
                  <label>密碼 *</label>
                  <input type="password" id="regPassword" placeholder="請設定密碼（至少6位）">
              </div>

              <div class="form-group">
                  <label>確認密碼 *</label>
                  <input type="password" id="regPasswordConfirm" placeholder="請再次輸入密碼">
              </div>

              <button class="btn btn-primary" onclick="register()" id="registerBtn">註冊</button>
              <button class="btn btn-secondary" onclick="showPage('loginPage')">返回登入</button>
          </div>

          <!-- 主頁面 -->
          <div id="dashboardPage" class="page">
              <div class="user-info">
                  <p><strong>歡迎回來！</strong></p>
                  <p><strong>姓名:</strong> <span id="userName">-</span></p>
                  <p><strong>帳號類型:</strong> <span id="userType">-</span></p>
              </div>

              <div class="dashboard">
                  <div class="dashboard-card" onclick="showActivities()">
                      <h3>📢 活動公告</h3>
                      <p>查看最新活動與重要通知</p>
                  </div>

                  <div class="dashboard-card" onclick="showVolunteerPage()">
                      <h3>🤝 志工團隊登記</h3>
                      <p>加入志工行列，貢獻您的力量</p>
                  </div>

                  <div class="dashboard-card" onclick="showProfile()">
                      <h3>👤 個人資料</h3>
                      <p>管理您的個人資訊</p>
                  </div>
              </div>

              <button class="btn btn-secondary" onclick="logout()" style="margin-top: 20px;">登出</button>
          </div>

          <!-- 活動公告頁面 -->
          <div id="activitiesPage" class="page">
              <button class="back-btn" onclick="showPage('dashboardPage')">← 返回</button>
              <h2 style="margin-bottom: 20px; color: #333;">📢 活動公告</h2>
              <div id="activitiesList">
                  <div class="loading">載入中...</div>
              </div>
          </div>

          <!-- 志工登記頁面 -->
          <div id="volunteerPage" class="page">
              <button class="back-btn" onclick="showPage('dashboardPage')">← 返回</button>
              <h2 style="margin-bottom: 20px; color: #333;">🤝 志工團隊登記</h2>
              
              <div class="form-group">
                  <label>活動名稱 *</label>
                  <input type="text" id="volunteerActivity" placeholder="請輸入要參加的活動名稱">
              </div>

              <div class="form-group">
                  <label>備註</label>
                  <textarea id="volunteerNote" placeholder="其他說明（選填）"></textarea>
              </div>

              <button class="btn btn-primary" onclick="submitVolunteer()" id="volunteerBtn">提交登記</button>
          </div>

          <!-- 個人資料頁面 -->
          <div id="profilePage" class="page">
              <button class="back-btn" onclick="showPage('dashboardPage')">← 返回</button>
              <h2 style="margin-bottom: 20px; color: #333;">👤 個人資料</h2>
              
              <div class="user-info">
                  <p><strong>姓名:</strong> <span id="profileName">-</span></p>
                  <p><strong>電話:</strong> <span id="profilePhone">-</span></p>
                  <p><strong>LINE ID:</strong> <span id="profileLineId">-</span></p>
                  <p><strong>帳號類型:</strong> <span id="profileType">-</span></p>
                  <p><strong>註冊時間:</strong> <span id="profileCreated">-</span></p>
              </div>
          </div>
      </div>
  </div>

  <script>
      // ========== 🔧 配置區（請在此設定您的 API URL）==========
      const API_URL = 'https://script.google.com/macros/s/AKfycbx19Qknr2V07NPULBRJrEMjKZlMc3wXYZXtaCzx5AsCnnN6YPcXBS2yY_MRiEr_kCrL/exec'; // ⚠️ 請替換為您的 Apps Script URL
      const LIFF_ID = '1656516134-VaGgmaPm'; // 如果使用 LINE 登入，請填入 LIFF ID
      
      // ========== 全域變數 ==========
      let currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
      let lineUserData = null;

      // ========== 檢查 API 配置 ==========
      window.onload = function() {
          if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
              document.getElementById('configWarning').style.display = 'block';
          }
          
          if (currentUser) {
              showDashboard();
          }
      };

      // ========== API 呼叫函數 ==========
      async function callAPI(action, data = {}) {
          if (API_URL === 'https://script.google.com/macros/s/AKfycbxy6dh8yQUnA_eQ1a0NmIi_NPR7XbosVQ1DL0tjeBDUQRn79OE0lGLyqgJKQPjs63P4QA/exec') {
              return { success: false, message: '請先設定 API URL' };
          }

          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  mode: 'no-cors',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: action,
                      data: data
                  })
              });
              
              // 因為 no-cors 模式，我們無法直接讀取回應
              // 需要使用 redirect 模式或改用 JSONP
              // 這裡我們改用不同的方法
              const result = await fetchWithTimeout(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'text/plain',
                  },
                  body: JSON.stringify({
                      action: action,
                      data: data
                  })
              });
              
              return result;
          } catch (error) {
              console.error('API 呼叫錯誤:', error);
              return { success: false, message: '網路連線錯誤，請稍後再試' };
          }
      }

      async function fetchWithTimeout(url, options, timeout = 10000) {
          try {
              const response = await fetch(url, options);
              const text = await response.text();
              return JSON.parse(text);
          } catch (error) {
              throw error;
          }
      }

      // ========== 頁面切換 ==========
      function showPage(pageId) {
          document.querySelectorAll('.page').forEach(page => {
              page.classList.remove('active');
          });
          document.getElementById(pageId).classList.add('active');
      }

      // ========== 訊息顯示 ==========
      function showMessage(message, type = 'success') {
          // 移除舊訊息
          const oldMessages = document.querySelectorAll('.success-message, .error-message');
          oldMessages.forEach(msg => msg.remove());

          const messageDiv = document.createElement('div');
          messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
          messageDiv.textContent = message;
          
          const content = document.querySelector('.content');
          const firstPage = content.querySelector('.page.active');
          firstPage.insertBefore(messageDiv, firstPage.firstChild);
          
          setTimeout(() => messageDiv.remove(), 3000);
      }

      // ========== LINE 登入 ==========
      async function lineLogin() {
          const btn = document.getElementById('lineLoginBtn');
          
          if (!LIFF_ID) {
              showMessage('LINE 登入功能尚未設定', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = '處理中...';
          
          try {
              await liff.init({ liffId: LIFF_ID });
              
              if (!liff.isLoggedIn()) {
                  liff.login();
                  return;
              }
              
              const profile = await liff.getProfile();
              lineUserData = {
                  lineId: profile.userId,
                  lineName: profile.displayName
              };

              const result = await callAPI('checkLineUser', { lineId: lineUserData.lineId });
              
              if (result.success && result.exists) {
                  currentUser = result.user;
                  sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                  showMessage('登入成功！');
                  showDashboard();
              } else {
                  document.getElementById('displayLineId').textContent = lineUserData.lineId;
                  document.getElementById('displayLineName').textContent = lineUserData.lineName;
                  showPage('lineRegisterPage');
              }
          } catch (error) {
              console.error('LINE 登入錯誤:', error);
              showMessage('LINE 登入失敗，請稍後再試', 'error');
          } finally {
              btn.disabled = false;
              btn.innerHTML = '<span style="font-size: 20px;">📱</span> 使用 LINE 登入';
          }
      }

      // ========== 完成 LINE 註冊 ==========
      async function completeLineRegister() {
          const realName = document.getElementById('realName').value.trim();
          const btn = document.getElementById('lineRegBtn');

          if (!realName) {
              showMessage('請輸入真實姓名', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = '處理中...';

          const result = await callAPI('lineRegister', {
              name: realName,
              lineId: lineUserData.lineId,
              lineName: lineUserData.lineName
          });

          if (result.success) {
              currentUser = result.user;
              sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
              showMessage('註冊成功！歡迎加入');
              showDashboard();
          } else {
              showMessage(result.message, 'error');
              btn.disabled = false;
              btn.textContent = '完成註冊';
          }
      }

      // ========== 一般註冊 ==========
      async function register() {
          const name = document.getElementById('regName').value.trim();
          const phone = document.getElementById('regPhone').value.trim();
          const password = document.getElementById('regPassword').value;
          const passwordConfirm = document.getElementById('regPasswordConfirm').value;
          const btn = document.getElementById('registerBtn');

          if (!name || !phone || !password) {
              showMessage('請填寫所有必填欄位', 'error');
              return;
          }

          if (password.length < 6) {
              showMessage('密碼至少需要6位', 'error');
              return;
          }

          if (password !== passwordConfirm) {
              showMessage('兩次密碼輸入不一致', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = '處理中...';

          const result = await callAPI('register', {
              name: name,
              phone: phone,
              password: password
          });

          if (result.success) {
              showMessage('註冊成功！請登入');
              showPage('loginPage');
              // 清空表單
              document.getElementById('regName').value = '';
              document.getElementById('regPhone').value = '';
              document.getElementById('regPassword').value = '';
              document.getElementById('regPasswordConfirm').value = '';
          } else {
              showMessage(result.message, 'error');
          }

          btn.disabled = false;
          btn.textContent = '註冊';
      }

      // ========== 一般登入 ==========
      async function normalLogin() {
          const phone = document.getElementById('loginPhone').value.trim();
          const password = document.getElementById('loginPassword').value;
          const btn = document.getElementById('loginBtn');

          if (!phone || !password) {
              showMessage('請輸入電話號碼和密碼', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = '處理中...';

          const result = await callAPI('login', {
              phone: phone,
              password: password
          });

          if (result.success) {
              currentUser = result.user;
              sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
              showMessage('登入成功！');
              showDashboard();
          } else {
              showMessage(result.message, 'error');
          }

          btn.disabled = false;
          btn.textContent = '登入';
      }

      // ========== 顯示主頁面 ==========
      function showDashboard() {
          document.getElementById('userName').textContent = currentUser.name;
          document.getElementById('userType').textContent = currentUser.type;
          showPage('dashboardPage');
      }

      // ========== 顯示活動公告 ==========
      async function showActivities() {
          showPage('activitiesPage');
          
          const listDiv = document.getElementById('activitiesList');
          listDiv.innerHTML = '<div class="loading">載入中...</div>';
          
          const result = await callAPI('getActivities');
          
          if (result.success) {
              if (result.activities.length === 0) {
                  listDiv.innerHTML = '<p style="text-align: center; color: #999;">目前沒有活動公告</p>';
              } else {
                  listDiv.innerHTML = result.activities.map(activity => `
                      <div class="activity-item">
                          <h4>${activity.title}</h4>
                          <p>${activity.content}</p>
                          <p class="date">📅 ${activity.date}</p>
                      </div>
                  `).join('');
              }
          } else {
              listDiv.innerHTML = '<p style="text-align: center; color: #f00;">載入失敗，請稍後再試</p>';
          }
      }

      // ========== 顯示志工登記頁面 ==========
      function showVolunteerPage() {
          showPage('volunteerPage');
          document.getElementById('volunteerActivity').value = '';
          document.getElementById('volunteerNote').value = '';
      }

      // ========== 提交志工登記 ==========
      async function submitVolunteer() {
          const activity = document.getElementById('volunteerActivity').value.trim();
          const btn = document.getElementById('volunteerBtn');

          if (!activity) {
              showMessage('請輸入活動名稱', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = '處理中...';

          const result = await callAPI('registerVolunteer', {
              userId: currentUser.id,
              userName: currentUser.name,
              activity: activity
          });

          if (result.success) {
              showMessage('志工登記成功！');
              showPage('dashboardPage');
          } else {
              showMessage(result.message, 'error');
          }

          btn.disabled = false;
          btn.textContent = '提交登記';
      }

      // ========== 顯示個人資料 ==========
      function showProfile() {
          document.getElementById('profileName').textContent = currentUser.name || '-';
          document.getElementById('profilePhone').textContent = currentUser.phone || '-';
          document.getElementById('profileLineId').textContent = currentUser.lineId || '-';
          document.getElementById('profileType').textContent = currentUser.type || '-';
          document.getElementById('profileCreated').textContent = currentUser.createdAt ? 
              new Date(currentUser.createdAt).toLocaleString('zh-TW') : '-';
          showPage('profilePage');
      }

      // ========== 登出 ==========
      function logout() {
          if (confirm('確定要登出嗎？')) {
              currentUser = null;
              sessionStorage.removeItem('currentUser');
              showMessage('已登出');
              showPage('loginPage');
          }
      }
  </script>
</body>
</html>
