<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森人員管理系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 20px;
      }

      .container {
          background: white;
          border-radius: 20px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          max-width: 600px;
          width: 100%;
          overflow: hidden;
          max-height: 90vh;
          display: flex;
          flex-direction: column;
      }

      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 30px;
          text-align: center;
          flex-shrink: 0;
      }

      .header h1 {
          font-size: 24px;
          margin-bottom: 10px;
      }

      .header p {
          font-size: 14px;
          opacity: 0.9;
      }

      .content {
          padding: 30px;
          overflow-y: auto;
          flex: 1;
      }

      .page {
          display: none;
      }

      .page.active {
          display: block;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          color: #333;
          font-weight: 600;
          font-size: 14px;
      }

      .form-group label .required {
          color: #e74c3c;
      }

      .form-group input, .form-group textarea, .form-group select {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e0e0e0;
          border-radius: 10px;
          font-size: 14px;
          transition: border-color 0.3s;
          font-family: inherit;
      }

      .form-group textarea {
          min-height: 100px;
          resize: vertical;
      }

      .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
          outline: none;
          border-color: #667eea;
      }

      .form-group select {
          cursor: pointer;
      }

      .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
      }

      .btn {
          width: 100%;
          padding: 14px;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          margin-bottom: 10px;
      }

      .btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
      }

      .btn-line {
          background: #06C755;
          color: white;
      }

      .btn-line:hover:not(:disabled) {
          background: #05b34c;
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(6, 199, 85, 0.3);
      }

      .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
      }

      .btn-primary:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
          background: white;
          color: #667eea;
          border: 2px solid #667eea;
      }

      .btn-secondary:hover {
          background: #f5f7ff;
      }

      .divider {
          text-align: center;
          margin: 25px 0;
          position: relative;
      }

      .divider::before {
          content: '';
          position: absolute;
          left: 0;
          top: 50%;
          width: 100%;
          height: 1px;
          background: #e0e0e0;
      }

      .divider span {
          background: white;
          padding: 0 15px;
          position: relative;
          color: #999;
          font-size: 14px;
      }

      .link-text {
          text-align: center;
          margin-top: 15px;
          color: #667eea;
          cursor: pointer;
          font-size: 14px;
      }

      .link-text:hover {
          text-decoration: underline;
      }

      .user-info {
          background: #f5f7ff;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
      }

      .user-info p {
          margin: 5px 0;
          color: #333;
          font-size: 14px;
      }

      .dashboard {
          display: grid;
          gap: 15px;
      }

      .dashboard-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          border-radius: 10px;
          cursor: pointer;
          transition: transform 0.3s;
      }

      .dashboard-card:hover {
          transform: translateY(-5px);
      }

      .dashboard-card h3 {
          font-size: 18px;
          margin-bottom: 5px;
      }

      .dashboard-card p {
          font-size: 14px;
          opacity: 0.9;
      }

      .success-message {
          background: #d4edda;
          color: #155724;
          padding: 12px;
          border-radius: 10px;
          margin-bottom: 15px;
          text-align: center;
          animation: slideDown 0.3s ease;
      }

      .error-message {
          background: #f8d7da;
          color: #721c24;
          padding: 12px;
          border-radius: 10px;
          margin-bottom: 15px;
          text-align: center;
          animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
          from {
              opacity: 0;
              transform: translateY(-10px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }

      .loading {
          text-align: center;
          padding: 20px;
          color: #667eea;
      }

      .activity-item {
          background: #f9f9f9;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 15px;
          border-left: 4px solid #667eea;
      }

      .activity-item h4 {
          color: #333;
          margin-bottom: 8px;
      }

      .activity-item p {
          color: #666;
          font-size: 14px;
          margin: 5px 0;
      }

      .activity-item .date {
          color: #999;
          font-size: 12px;
          margin-top: 10px;
      }

      .back-btn {
          background: #f0f0f0;
          color: #333;
          padding: 10px 20px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          margin-bottom: 20px;
          font-size: 14px;
      }

      .back-btn:hover {
          background: #e0e0e0;
      }

      .section-title {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 12px 15px;
          border-radius: 10px;
          margin: 25px 0 15px 0;
          font-size: 16px;
          font-weight: 600;
      }

      .section-title:first-child {
          margin-top: 0;
      }

      .info-card {
          background: #f9f9f9;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 15px;
      }

      .info-card h4 {
          color: #667eea;
          margin-bottom: 10px;
          font-size: 16px;
      }

      .info-row {
          display: flex;
          justify-content: space-between;
          padding: 8px 0;
          border-bottom: 1px solid #e0e0e0;
      }

      .info-row:last-child {
          border-bottom: none;
      }

      .info-label {
          color: #666;
          font-size: 14px;
      }

      .info-value {
          color: #333;
          font-weight: 600;
          font-size: 14px;
      }

      .donation-item {
          background: white;
          border: 2px solid #e0e0e0;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 15px;
      }

      .donation-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
      }

      .donation-amount {
          font-size: 20px;
          font-weight: 700;
          color: #667eea;
      }

      .donation-date {
          color: #999;
          font-size: 12px;
      }

      .receipt-link {
          display: inline-block;
          background: #667eea;
          color: white;
          padding: 8px 15px;
          border-radius: 5px;
          text-decoration: none;
          font-size: 12px;
          margin-top: 10px;
      }

      .receipt-link:hover {
          background: #5568d3;
      }

      .tabs {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
          border-bottom: 2px solid #e0e0e0;
      }

      .tab {
          padding: 10px 20px;
          cursor: pointer;
          border: none;
          background: none;
          color: #666;
          font-size: 14px;
          font-weight: 600;
          position: relative;
          transition: color 0.3s;
      }

      .tab.active {
          color: #667eea;
      }

      .tab.active::after {
          content: '';
          position: absolute;
          bottom: -2px;
          left: 0;
          right: 0;
          height: 2px;
          background: #667eea;
      }

      .tab-content {
          display: none;
      }

      .tab-content.active {
          display: block;
      }

      .config-warning {
          background: #fff3cd;
          color: #856404;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
          border-left: 4px solid #ffc107;
      }

      .config-warning strong {
          display: block;
          margin-bottom: 5px;
      }

      @media (max-width: 600px) {
          .form-row {
              grid-template-columns: 1fr;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>🌟 帕金森人員管理系統</h1>
          <p>關懷與支持的社群平台</p>
      </div>

      <div class="content">
          <!-- 登入頁面 -->
          <div id="loginPage" class="page active">
              <h2 style="margin-bottom: 20px; color: #333;">歡迎登入</h2>
              
              <div id="configWarning" class="config-warning" style="display: none;">
                  <strong>⚠️ 尚未設定 API</strong>
                  請在程式碼中設定您的 Google Apps Script URL
              </div>
              
              <button class="btn btn-line" onclick="lineLogin()" id="lineLoginBtn">
                  <span style="font-size: 20px;">📱</span> 使用 LINE 登入
              </button>

              <div class="divider">
                  <span>或</span>
              </div>

              <div class="form-group">
                  <label>電話號碼</label>
                  <input type="tel" id="loginPhone" placeholder="請輸入電話號碼">
              </div>

              <div class="form-group">
                  <label>密碼</label>
                  <input type="password" id="loginPassword" placeholder="請輸入密碼" onkeypress="if(event.key==='Enter') normalLogin()">
              </div>

              <button class="btn btn-primary" onclick="normalLogin()" id="loginBtn">登入</button>

              <div class="link-text" onclick="showPage('registerPage')">
                  還沒有帳號？立即註冊
              </div>
          </div>

          <!-- LINE 首次登入 - 實名制 -->
          <div id="lineRegisterPage" class="page">
              <h2 style="margin-bottom: 20px; color: #333;">完成註冊</h2>
              
              <div class="user-info">
                  <p><strong>LINE ID:</strong> <span id="displayLineId">-</span></p>
                  <p><strong>LINE 名稱:</strong> <span id="displayLineName">-</span></p>
              </div>

              <div class="form-group">
                  <label>真實姓名 <span class="required">*</span></label>
                  <input type="text" id="realName" placeholder="請輸入您的真實姓名">
              </div>

              <button class="btn btn-primary" onclick="completeLineRegister()" id="lineRegBtn">完成註冊</button>
          </div>

          <!-- 一般註冊頁面 -->
          <div id="registerPage" class="page">
              <h2 style="margin-bottom: 20px; color: #333;">註冊帳號</h2>

              <div class="form-group">
                  <label>真實姓名 <span class="required">*</span></label>
                  <input type="text" id="regName" placeholder="請輸入您的真實姓名">
              </div>

              <div class="form-group">
                  <label>電話號碼 <span class="required">*</span></label>
                  <input type="tel" id="regPhone" placeholder="請輸入電話號碼">
              </div>

              <div class="form-group">
                  <label>密碼 <span class="required">*</span></label>
                  <input type="password" id="regPassword" placeholder="請設定密碼（至少6位）">
              </div>

              <div class="form-group">
                  <label>確認密碼 <span class="required">*</span></label>
                  <input type="password" id="regPasswordConfirm" placeholder="請再次輸入密碼">
              </div>

              <button class="btn btn-primary" onclick="register()" id="registerBtn">註冊</button>
              <button class="btn btn-secondary" onclick="showPage('loginPage')">返回登入</button>
          </div>

          <!-- 主頁面 -->
          <div id="dashboardPage" class="page">
              <div class="user-info">
                  <p><strong>歡迎回來！</strong></p>
                  <p><strong>姓名:</strong> <span id="userName">-</span></p>
                  <p><strong>帳號類型:</strong> <span id="userType">-</span></p>
              </div>

              <div class="dashboard">
                  <div class="dashboard-card" onclick="showActivities()">
                      <h3>📢 活動公告</h3>
                      <p>查看最新活動與重要通知</p>
                  </div>

                  <div class="dashboard-card" onclick="showVolunteerPage()">
                      <h3>🤝 志工團隊登記</h3>
                      <p>加入志工行列，貢獻您的力量</p>
                  </div>

                  <div class="dashboard-card" onclick="showProfilePage()">
                      <h3>👤 個人資料維護</h3>
                      <p>管理您的完整個人資訊</p>
                  </div>
              </div>

              <button class="btn btn-secondary" onclick="logout()" style="margin-top: 20px;">登出</button>
          </div>

          <!-- 活動公告頁面 -->
          <div id="activitiesPage" class="page">
              <button class="back-btn" onclick="showPage('dashboardPage')">← 返回</button>
              <h2 style="margin-bottom: 20px; color: #333;">📢 活動公告</h2>
              <div id="activitiesList">
                  <div class="loading">載入中...</div>
              </div>
          </div>

          <!-- 志工登記頁面 -->
          <div id="volunteerPage" class="page">
              <button class="back-btn" onclick="showPage('dashboardPage')">← 返回</button>
              <h2 style="margin-bottom: 20px; color: #333;">🤝 志工團隊登記</h2>
              
              <div class="form-group">
                  <label>活動名稱 <span class="required">*</span></label>
                  <input type="text" id="volunteerActivity" placeholder="請輸入要參加的活動名稱">
              </div>

              <div class="form-group">
                  <label>備註</label>
                  <textarea id="volunteerNote" placeholder="其他說明（選填）"></textarea>
              </div>

              <button class="btn btn-primary" onclick="submitVolunteer()" id="volunteerBtn">提交登記</button>
          </div>

          <!-- 個人資料維護頁面 -->
          <div id="profilePage" class="page">
              <button class="back-btn" onclick="showPage('dashboardPage')">← 返回</button>
              <h2 style="margin-bottom: 20px; color: #333;">👤 個人資料維護</h2>

              <div class="tabs">
                  <button class="tab active" onclick="switchTab('basicTab')">基本資料</button>
                  <button class="tab" onclick="switchTab('memberTab')">會員資料</button>
                  <button class="tab" onclick="switchTab('patientTab')">帕友資料</button>
                  <button class="tab" onclick="switchTab('donationTab')">捐款記錄</button>
              </div>

              <!-- 基本資料 Tab -->
              <div id="basicTab" class="tab-content active">
                  <div class="form-group">
                      <label>會員類別 <span class="required">*</span></label>
                      <select id="profileUserType">
                          <option value="一般群眾">一般群眾</option>
                          <option value="病友">病友</option>
                          <option value="家屬">家屬</option>
                          <option value="醫師">醫師</option>
                      </select>
                  </div>

                  <div class="form-group">
                      <label>姓名 <span class="required">*</span></label>
                      <input type="text" id="profileName" placeholder="請輸入姓名">
                  </div>

                  <div class="form-row">
                      <div class="form-group">
                          <label>性別</label>
                          <select id="profileGender">
                              <option value="">請選擇</option>
                              <option value="男">男</option>
                              <option value="女">女</option>
                              <option value="其他">其他</option>
                          </select>
                      </div>

                      <div class="form-group">
                          <label>生日</label>
                          <input type="date" id="profileBirthday">
                      </div>
                  </div>

                  <div class="form-group">
                      <label>電話號碼</label>
                      <input type="tel" id="profilePhone" placeholder="請輸入電話號碼" readonly>
                  </div>

                  <div class="form-group">
                      <label>電子信箱</label>
                      <input type="email" id="profileEmail" placeholder="請輸入電子信箱">
                  </div>

                  <div class="form-group">
                      <label>身分證號</label>
                      <input type="text" id="profileIdNumber" placeholder="請輸入身分證號" maxlength="10">
                  </div>

                  <div class="form-group">
                      <label>居住地區</label>
                      <input type="text" id="profileAddress" placeholder="請輸入居住地區">
                  </div>

                  <button class="btn btn-primary" onclick="saveBasicInfo()">儲存基本資料</button>
              </div>

              <!-- 會員資料 Tab -->
              <div id="memberTab" class="tab-content">
                  <div class="form-group">
                      <label>會員資格到期日</label>
                      <input type="date" id="membershipExpiry">
                  </div>

                  <div class="form-group">
                      <label>上次繳費日期</label>
                      <input type="date" id="lastPaymentDate">
                  </div>

                  <div class="form-group">
                      <label>下次繳費日期</label>
                      <input type="date" id="nextPaymentDate">
                  </div>

                  <button class="btn btn-primary" onclick="saveMemberInfo()">儲存會員資料</button>
              </div>

              <!-- 帕友資料 Tab -->
              <div id="patientTab" class="tab-content">
                  <div class="form-group">
                      <label>病齡（年）</label>
                      <input type="number" id="diseaseYears" placeholder="請輸入病齡" min="0">
                  </div>

                  <div class="form-group">
                      <label>就診醫院</label>
                      <input type="text" id="hospital" placeholder="請輸入就診醫院">
                  </div>

                  <div class="form-group">
                      <label>主治醫師</label>
                      <input type="text" id="doctor" placeholder="請輸入主治醫師姓名">
                  </div>

                  <div class="form-group">
                      <label>對主治醫師的評語</label>
                      <textarea id="doctorReview" placeholder="請分享您對主治醫師的評價與建議"></textarea>
                  </div>

                  <div class="form-group">
                      <label>帕病最困擾您的問題是？</label>
                      <textarea id="mainProblem" placeholder="請描述您目前最困擾的症狀或問題"></textarea>
                  </div>

                  <div class="form-group">
                      <label>希望協會協助您的事項</label>
                      <textarea id="needHelp" placeholder="請告訴我們您需要什麼樣的協助"></textarea>
                  </div>

                  <button class="btn btn-primary" onclick="savePatientInfo()">儲存帕友資料</button>
              </div>

              <!-- 捐款記錄 Tab -->
              <div id="donationTab" class="tab-content">
                  <button class="btn btn-secondary" onclick="showAddDonation()" style="margin-bottom: 20px;">+ 新增捐款記錄</button>
                  
                  <div id="donationsList">
                      <div class="loading">載入中...</div>
                  </div>
              </div>
          </div>

          <!-- 新增捐款記錄頁面 -->
          <div id="addDonationPage" class="page">
              <button class="back-btn" onclick="backToProfile()">← 返回</button>
              <h2 style="margin-bottom: 20px; color: #333;">新增捐款記錄</h2>

              <div class="form-group">
                  <label>捐款金額 <span class="required">*</span></label>
                  <input type="number" id="donationAmount" placeholder="請輸入捐款金額" min="0">
              </div>

              <div class="form-group">
                  <label>捐款日期 <span class="required">*</span></label>
                  <input type="date" id="donationDate">
              </div>

              <div class="form-group">
                  <label>收據連結</label>
                  <input type="url" id="receiptUrl" placeholder="請輸入收據連結（選填）">
              </div>

              <div class="form-group">
                  <label>備註</label>
                  <textarea id="donationNote" placeholder="其他說明（選填）"></textarea>
              </div>

              <button class="btn btn-primary" onclick="submitDonation()" id="donationBtn">新增捐款記錄</button>
          </div>
      </div>
  </div>

  <script>
      // ========== 🔧 配置區 ==========
      const API_URL = 'https://script.google.com/macros/s/AKfycbyulr3oowOoMbQJpkOnnXP2PY1w02ltsNJ2Gy_SfoafBR70HRf0rkwwKwKu_u7qWyaM8g/exec';
      const LIFF_ID = '1656516134-VaGgmaPm';
      
      // ========== 全域變數 ==========
      let currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
      let lineUserData = null;
      let currentProfile = null;

      // ========== 初始化 ==========
      window.onload = function() {
          if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
              document.getElementById('configWarning').style.display = 'block';
          }
          
          if (currentUser) {
              showDashboard();
          }
      };

      // ========== API 呼叫 ==========
      async function callAPI(action, data = {}) {
          if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
              return { success: false, message: '請先設定 API URL' };
          }

          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'text/plain',
                  },
                  body: JSON.stringify({
                      action: action,
                      data: data
                  })
              });
              
              const text = await response.text();
              return JSON.parse(text);
          } catch (error) {
              console.error('API 呼叫錯誤:', error);
              return { success: false, message: '網路連線錯誤，請稍後再試' };
          }
      }

      // ========== 頁面切換 ==========
      function showPage(pageId) {
          document.querySelectorAll('.page').forEach(page => {
              page.classList.remove('active');
          });
          document.getElementById(pageId).classList.add('active');
      }

      function switchTab(tabId) {
          document.querySelectorAll('.tab').forEach(tab => {
              tab.classList.remove('active');
          });
          document.querySelectorAll('.tab-content').forEach(content => {
              content.classList.remove('active');
          });
          
          event.target.classList.add('active');
          document.getElementById(tabId).classList.add('active');

          if (tabId === 'donationTab') {
              loadDonations();
          }
      }

      // ========== 訊息顯示 ==========
      function showMessage(message, type = 'success') {
          const oldMessages = document.querySelectorAll('.success-message, .error-message');
          oldMessages.forEach(msg => msg.remove());

          const messageDiv = document.createElement('div');
          messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
          messageDiv.textContent = message;
          
          const content = document.querySelector('.content');
          const firstPage = content.querySelector('.page.active');
          firstPage.insertBefore(messageDiv, firstPage.firstChild);
          
          setTimeout(() => messageDiv.remove(), 3000);
      }

      // ========== LINE 登入 ==========
      async function lineLogin() {
          const btn = document.getElementById('lineLoginBtn');
          
          if (!LIFF_ID) {
              showMessage('LINE 登入功能尚未設定', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = '處理中...';
          
          try {
              await liff.init({ liffId: LIFF_ID });
              
              if (!liff.isLoggedIn()) {
                  liff.login();
                  return;
              }
              
              const profile = await liff.getProfile();
              lineUserData = {
                  lineId: profile.userId,
                  lineName: profile.displayName
              };

              const result = await callAPI('checkLineUser', { lineId: lineUserData.lineId });
              
              if (result.success && result.exists) {
                  currentUser = result.user;
                  sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                  showMessage('登入成功！');
                  showDashboard();
              } else {
                  document.getElementById('displayLineId').textContent = lineUserData.lineId;
                  document.getElementById('displayLineName').textContent = lineUserData.lineName;
                  showPage('lineRegisterPage');
              }
          } catch (error) {
              console.error('LINE 登入錯誤:', error);
              showMessage('LINE 登入失敗，請稍後再試', 'error');
          } finally {
              btn.disabled = false;
              btn.innerHTML = '<span style="font-size: 20px;">📱</span> 使用 LINE 登入';
          }
      }

      // ========== 完成 LINE 註冊 ==========
      async function completeLineRegister() {
          const realName = document.getElementById('realName').value.trim();
          const btn = document.getElementById('lineRegBtn');

          if (!realName) {
              showMessage('請輸入真實姓名', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = '處理中...';

          const result = await callAPI('lineRegister', {
              name: realName,
              lineId: lineUserData.lineId,
              lineName: lineUserData.lineName
          });

          if (result.success) {
              currentUser = result.user;
              sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
              showMessage('註冊成功！歡迎加入');
              showDashboard();
          } else {
              showMessage(result.message, 'error');
              btn.disabled = false;
              btn.textContent = '完成註冊';
          }
      }

      // ========== 一般註冊 ==========
      async function register() {
          const name = document.getElementById('regName').value.trim();
          const phone = document.getElementById('regPhone').value.trim();
          const password = document.getElementById('regPassword').value;
          const passwordConfirm = document.getElementById('regPasswordConfirm').value;
          const btn = document.getElementById('registerBtn');

          if (!name || !phone || !password) {
              showMessage('請填寫所有必填欄位', 'error');
              return;
          }

          if (password.length < 6) {
              showMessage('密碼至少需要6位', 'error');
              return;
          }

          if (password !== passwordConfirm) {
              showMessage('兩次密碼輸入不一致', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = '處理中...';

          const result = await callAPI('register', {
              name: name,
              phone: phone,
              password: password
          });

          if (result.success) {
              showMessage('註冊成功！請登入');
              showPage('loginPage');
              document.getElementById('regName').value = '';
              document.getElementById('regPhone').value = '';
              document.getElementById('regPassword').value = '';
              document.getElementById('regPasswordConfirm').value = '';
          } else {
              showMessage(result.message, 'error');
          }

          btn.disabled = false;
          btn.textContent = '註冊';
      }

      // ========== 一般登入 ==========
      async function normalLogin() {
          const phone = document.getElementById('loginPhone').value.trim();
          const password = document.getElementById('loginPassword').value;
          const btn = document.getElementById('loginBtn');

          if (!phone || !password) {
              showMessage('請輸入電話號碼和密碼', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = '處理中...';

          const result = await callAPI('login', {
              phone: phone,
              password: password
          });

          if (result.success) {
              currentUser = result.user;
              sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
              showMessage('登入成功！');
              showDashboard();
          } else {
              showMessage(result.message, 'error');
          }

          btn.disabled = false;
          btn.textContent = '登入';
      }

      // ========== 顯示主頁面 ==========
      function showDashboard() {
          document.getElementById('userName').textContent = currentUser.name;
          document.getElementById('userType').textContent = currentUser.type;
          showPage('dashboardPage');
      }

      // ========== 顯示活動公告 ==========
      async function showActivities() {
          showPage('activitiesPage');
          
          const listDiv = document.getElementById('activitiesList');
          listDiv.innerHTML = '<div class="loading">載入中...</div>';
          
          const result = await callAPI('getActivities');
          
          if (result.success) {
              if (result.activities.length === 0) {
                  listDiv.innerHTML = '<p style="text-align: center; color: #999;">目前沒有活動公告</p>';
              } else {
                  listDiv.innerHTML = result.activities.map(activity => `
                      <div class="activity-item">
                          <h4>${activity.title}</h4>
                          <p>${activity.content}</p>
                          <p class="date">📅 ${activity.date}</p>
                      </div>
                  `).join('');
              }
          } else {
              listDiv.innerHTML = '<p style="text-align: center; color: #f00;">載入失敗，請稍後再試</p>';
          }
      }

      // ========== 志工登記 ==========
      function showVolunteerPage() {
          showPage('volunteerPage');
          document.getElementById('volunteerActivity').value = '';
          document.getElementById('volunteerNote').value = '';
      }

      async function submitVolunteer() {
          const activity = document.getElementById('volunteerActivity').value.trim();
          const btn = document.getElementById('volunteerBtn');

          if (!activity) {
              showMessage('請輸入活動名稱', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = '處理中...';

          const result = await callAPI('registerVolunteer', {
              userId: currentUser.id,
              userName: currentUser.name,
              activity: activity
          });

          if (result.success) {
              showMessage('志工登記成功！');
              showPage('dashboardPage');
          } else {
              showMessage(result.message, 'error');
          }

          btn.disabled = false;
          btn.textContent = '提交登記';
      }

      // ========== 個人資料維護 ==========
      async function showProfilePage() {
          showPage('profilePage');
          switchTab('basicTab');
          await loadProfile();
      }

      async function loadProfile() {
          const result = await callAPI('getUserProfile', { userId: currentUser.id });
          
          if (result.success) {
              currentProfile = result.profile;
              
              // 填充基本資料
              const basic = currentProfile.basic;
              document.getElementById('profileUserType').value = basic.type || '一般群眾';
              document.getElementById('profileName').value = basic.name || '';
              document.getElementById('profileGender').value = basic.gender || '';
              document.getElementById('profileBirthday').value = basic.birthday || '';
              document.getElementById('profilePhone').value = basic.phone || '';
              document.getElementById('profileEmail').value = basic.email || '';
              document.getElementById('profileIdNumber').value = basic.idNumber || '';
              document.getElementById('profileAddress').value = basic.address || '';
              
              // 填充會員資料
              if (currentProfile.member) {
                  const member = currentProfile.member;
                  document.getElementById('membershipExpiry').value = member.membershipExpiry || '';
                  document.getElementById('lastPaymentDate').value = member.lastPaymentDate || '';
                  document.getElementById('nextPaymentDate').value = member.nextPaymentDate || '';
              }
              
              // 填充帕友資料
              if (currentProfile.patient) {
                  const patient = currentProfile.patient;
                  document.getElementById('diseaseYears').value = patient.diseaseYears || '';
                  document.getElementById('hospital').value = patient.hospital || '';
                  document.getElementById('doctor').value = patient.doctor || '';
                  document.getElementById('doctorReview').value = patient.doctorReview || '';
                  document.getElementById('mainProblem').value = patient.mainProblem || '';
                  document.getElementById('needHelp').value = patient.needHelp || '';
              }
          }
      }

      async function saveBasicInfo() {
          const data = {
              userId: currentUser.id,
              name: document.getElementById('profileName').value.trim(),
              type: document.getElementById('profileUserType').value,
              gender: document.getElementById('profileGender').value,
              birthday: document.getElementById('profileBirthday').value,
              email: document.getElementById('profileEmail').value.trim(),
              idNumber: document.getElementById('profileIdNumber').value.trim(),
              address: document.getElementById('profileAddress').value.trim()
          };

          if (!data.name) {
              showMessage('請輸入姓名', 'error');
              return;
          }

          const result = await callAPI('updateUserProfile', data);
          
          if (result.success) {
              showMessage('基本資料儲存成功！');
              currentUser.name = data.name;
              currentUser.type = data.type;
              sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
          } else {
              showMessage(result.message, 'error');
          }
      }

      async function saveMemberInfo() {
          const data = {
              userId: currentUser.id,
              membershipExpiry: document.getElementById('membershipExpiry').value,
              lastPaymentDate: document.getElementById('lastPaymentDate').value,
              nextPaymentDate: document.getElementById('nextPaymentDate').value
          };

          const result = await callAPI('updateMemberInfo', data);
          
          if (result.success) {
                showMessage('會員資料儲存成功！');
            } else {
                showMessage(result.message, 'error');
            }
        }

        async function savePatientInfo() {
            const data = {
                userId: currentUser.id,
                diseaseYears: document.getElementById('diseaseYears').value,
                hospital: document.getElementById('hospital').value.trim(),
                doctor: document.getElementById('doctor').value.trim(),
                doctorReview: document.getElementById('doctorReview').value.trim(),
                mainProblem: document.getElementById('mainProblem').value.trim(),
                needHelp: document.getElementById('needHelp').value.trim()
            };

            const result = await callAPI('updatePatientInfo', data);
            
            if (result.success) {
                showMessage('帕友資料儲存成功！');
            } else {
                showMessage(result.message, 'error');
            }
        }

        // ========== 捐款記錄管理 ==========
        async function loadDonations() {
            const listDiv = document.getElementById('donationsList');
            listDiv.innerHTML = '<div class="loading">載入中...</div>';
            
            const result = await callAPI('getDonations', { userId: currentUser.id });
            
            if (result.success) {
                if (result.donations.length === 0) {
                    listDiv.innerHTML = '<p style="text-align: center; color: #999;">目前沒有捐款記錄</p>';
                } else {
                    listDiv.innerHTML = result.donations.map(donation => `
                        <div class="donation-item">
                            <div class="donation-header">
                                <div class="donation-amount">NT$ ${Number(donation.amount).toLocaleString()}</div>
                                <div class="donation-date">${donation.date}</div>
                            </div>
                            ${donation.note ? `<p style="color: #666; font-size: 14px; margin-top: 5px;">${donation.note}</p>` : ''}
                            ${donation.receiptUrl ? `<a href="${donation.receiptUrl}" target="_blank" class="receipt-link">📄 查看收據</a>` : ''}
                        </div>
                    `).join('');
                }
            } else {
                listDiv.innerHTML = '<p style="text-align: center; color: #f00;">載入失敗，請稍後再試</p>';
            }
        }

        function showAddDonation() {
            showPage('addDonationPage');
            document.getElementById('donationAmount').value = '';
            document.getElementById('donationDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('receiptUrl').value = '';
            document.getElementById('donationNote').value = '';
        }

        async function submitDonation() {
            const amount = document.getElementById('donationAmount').value;
            const date = document.getElementById('donationDate').value;
            const receiptUrl = document.getElementById('receiptUrl').value.trim();
            const note = document.getElementById('donationNote').value.trim();
            const btn = document.getElementById('donationBtn');

            if (!amount || !date) {
                showMessage('請填寫捐款金額和日期', 'error');
                return;
            }

            if (Number(amount) <= 0) {
                showMessage('捐款金額必須大於 0', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = '處理中...';

            const result = await callAPI('addDonation', {
                userId: currentUser.id,
                userName: currentUser.name,
                amount: amount,
                date: date,
                receiptUrl: receiptUrl,
                note: note
            });

            if (result.success) {
                showMessage('捐款記錄新增成功！');
                backToProfile();
            } else {
                showMessage(result.message, 'error');
            }

            btn.disabled = false;
            btn.textContent = '新增捐款記錄';
        }

        function backToProfile() {
            showPage('profilePage');
            switchTab('donationTab');
            loadDonations();
        }

        // ========== 登出 ==========
        function logout() {
            if (confirm('確定要登出嗎？')) {
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                showMessage('已登出');
                showPage('loginPage');
            }
        }
    </script>
</body>
</html>
