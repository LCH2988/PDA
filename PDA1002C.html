<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸•é‡‘æ£®äººå“¡ç®¡ç†ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 20px;
      }

      .container {
          background: white;
          border-radius: 20px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          max-width: 600px;
          width: 100%;
          overflow: hidden;
          max-height: 90vh;
          display: flex;
          flex-direction: column;
      }

      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 30px;
          text-align: center;
          flex-shrink: 0;
      }

      .header h1 {
          font-size: 24px;
          margin-bottom: 10px;
      }

      .header p {
          font-size: 14px;
          opacity: 0.9;
      }

      .content {
          padding: 30px;
          overflow-y: auto;
          flex: 1;
      }

      .page {
          display: none;
      }

      .page.active {
          display: block;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          color: #333;
          font-weight: 600;
          font-size: 14px;
      }

      .form-group label .required {
          color: #e74c3c;
      }

      .form-group input, .form-group textarea, .form-group select {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e0e0e0;
          border-radius: 10px;
          font-size: 14px;
          transition: border-color 0.3s;
          font-family: inherit;
      }

      .form-group textarea {
          min-height: 100px;
          resize: vertical;
      }

      .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
          outline: none;
          border-color: #667eea;
      }

      .form-group select {
          cursor: pointer;
      }

      .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
      }

      .btn {
          width: 100%;
          padding: 14px;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          margin-bottom: 10px;
      }

      .btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
      }

      .btn-line {
          background: #06C755;
          color: white;
      }

      .btn-line:hover:not(:disabled) {
          background: #05b34c;
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(6, 199, 85, 0.3);
      }

      .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
      }

      .btn-primary:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
          background: white;
          color: #667eea;
          border: 2px solid #667eea;
      }

      .btn-secondary:hover {
          background: #f5f7ff;
      }

      .divider {
          text-align: center;
          margin: 25px 0;
          position: relative;
      }

      .divider::before {
          content: '';
          position: absolute;
          left: 0;
          top: 50%;
          width: 100%;
          height: 1px;
          background: #e0e0e0;
      }

      .divider span {
          background: white;
          padding: 0 15px;
          position: relative;
          color: #999;
          font-size: 14px;
      }

      .link-text {
          text-align: center;
          margin-top: 15px;
          color: #667eea;
          cursor: pointer;
          font-size: 14px;
      }

      .link-text:hover {
          text-decoration: underline;
      }

      .user-info {
          background: #f5f7ff;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
      }

      .user-info p {
          margin: 5px 0;
          color: #333;
          font-size: 14px;
      }

      .dashboard {
          display: grid;
          gap: 15px;
      }

      .dashboard-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          border-radius: 10px;
          cursor: pointer;
          transition: transform 0.3s;
      }

      .dashboard-card:hover {
          transform: translateY(-5px);
      }

      .dashboard-card h3 {
          font-size: 18px;
          margin-bottom: 5px;
      }

      .dashboard-card p {
          font-size: 14px;
          opacity: 0.9;
      }

      .success-message {
          background: #d4edda;
          color: #155724;
          padding: 12px;
          border-radius: 10px;
          margin-bottom: 15px;
          text-align: center;
          animation: slideDown 0.3s ease;
      }

      .error-message {
          background: #f8d7da;
          color: #721c24;
          padding: 12px;
          border-radius: 10px;
          margin-bottom: 15px;
          text-align: center;
          animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
          from {
              opacity: 0;
              transform: translateY(-10px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }

      .loading {
          text-align: center;
          padding: 20px;
          color: #667eea;
      }

      .activity-item {
          background: #f9f9f9;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 15px;
          border-left: 4px solid #667eea;
      }

      .activity-item h4 {
          color: #333;
          margin-bottom: 8px;
      }

      .activity-item p {
          color: #666;
          font-size: 14px;
          margin: 5px 0;
      }

      .activity-item .date {
          color: #999;
          font-size: 12px;
          margin-top: 10px;
      }

      .back-btn {
          background: #f0f0f0;
          color: #333;
          padding: 10px 20px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          margin-bottom: 20px;
          font-size: 14px;
      }

      .back-btn:hover {
          background: #e0e0e0;
      }

      .section-title {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 12px 15px;
          border-radius: 10px;
          margin: 25px 0 15px 0;
          font-size: 16px;
          font-weight: 600;
      }

      .section-title:first-child {
          margin-top: 0;
      }

      .info-card {
          background: #f9f9f9;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 15px;
      }

      .info-card h4 {
          color: #667eea;
          margin-bottom: 10px;
          font-size: 16px;
      }

      .info-row {
          display: flex;
          justify-content: space-between;
          padding: 8px 0;
          border-bottom: 1px solid #e0e0e0;
      }

      .info-row:last-child {
          border-bottom: none;
      }

      .info-label {
          color: #666;
          font-size: 14px;
      }

      .info-value {
          color: #333;
          font-weight: 600;
          font-size: 14px;
      }

      .donation-item {
          background: white;
          border: 2px solid #e0e0e0;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 15px;
      }

      .donation-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
      }

      .donation-amount {
          font-size: 20px;
          font-weight: 700;
          color: #667eea;
      }

      .donation-date {
          color: #999;
          font-size: 12px;
      }

      .receipt-link {
          display: inline-block;
          background: #667eea;
          color: white;
          padding: 8px 15px;
          border-radius: 5px;
          text-decoration: none;
          font-size: 12px;
          margin-top: 10px;
      }

      .receipt-link:hover {
          background: #5568d3;
      }

      .tabs {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
          border-bottom: 2px solid #e0e0e0;
      }

      .tab {
          padding: 10px 20px;
          cursor: pointer;
          border: none;
          background: none;
          color: #666;
          font-size: 14px;
          font-weight: 600;
          position: relative;
          transition: color 0.3s;
      }

      .tab.active {
          color: #667eea;
      }

      .tab.active::after {
          content: '';
          position: absolute;
          bottom: -2px;
          left: 0;
          right: 0;
          height: 2px;
          background: #667eea;
      }

      .tab-content {
          display: none;
      }

      .tab-content.active {
          display: block;
      }

      .config-warning {
          background: #fff3cd;
          color: #856404;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
          border-left: 4px solid #ffc107;
      }

      .config-warning strong {
          display: block;
          margin-bottom: 5px;
      }

      @media (max-width: 600px) {
          .form-row {
              grid-template-columns: 1fr;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>ğŸŒŸ å¸•é‡‘æ£®äººå“¡ç®¡ç†ç³»çµ±</h1>
          <p>é—œæ‡·èˆ‡æ”¯æŒçš„ç¤¾ç¾¤å¹³å°</p>
      </div>

      <div class="content">
          <!-- ç™»å…¥é é¢ -->
          <div id="loginPage" class="page active">
              <h2 style="margin-bottom: 20px; color: #333;">æ­¡è¿ç™»å…¥</h2>
              
              <div id="configWarning" class="config-warning" style="display: none;">
                  <strong>âš ï¸ å°šæœªè¨­å®š API</strong>
                  è«‹åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®šæ‚¨çš„ Google Apps Script URL
              </div>
              
              <button class="btn btn-line" onclick="lineLogin()" id="lineLoginBtn">
                  <span style="font-size: 20px;">ğŸ“±</span> ä½¿ç”¨ LINE ç™»å…¥
              </button>

              <div class="divider">
                  <span>æˆ–</span>
              </div>

              <div class="form-group">
                  <label>é›»è©±è™Ÿç¢¼</label>
                  <input type="tel" id="loginPhone" placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼">
              </div>

              <div class="form-group">
                  <label>å¯†ç¢¼</label>
                  <input type="password" id="loginPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" onkeypress="if(event.key==='Enter') normalLogin()">
              </div>

              <button class="btn btn-primary" onclick="normalLogin()" id="loginBtn">ç™»å…¥</button>

              <div class="link-text" onclick="showPage('registerPage')">
                  é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿç«‹å³è¨»å†Š
              </div>
          </div>

          <!-- LINE é¦–æ¬¡ç™»å…¥ - å¯¦ååˆ¶ -->
          <div id="lineRegisterPage" class="page">
              <h2 style="margin-bottom: 20px; color: #333;">å®Œæˆè¨»å†Š</h2>
              
              <div class="user-info">
                  <p><strong>LINE ID:</strong> <span id="displayLineId">-</span></p>
                  <p><strong>LINE åç¨±:</strong> <span id="displayLineName">-</span></p>
              </div>

              <div class="form-group">
                  <label>çœŸå¯¦å§“å <span class="required">*</span></label>
                  <input type="text" id="realName" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å">
              </div>

              <button class="btn btn-primary" onclick="completeLineRegister()" id="lineRegBtn">å®Œæˆè¨»å†Š</button>
          </div>

          <!-- ä¸€èˆ¬è¨»å†Šé é¢ -->
          <div id="registerPage" class="page">
              <h2 style="margin-bottom: 20px; color: #333;">è¨»å†Šå¸³è™Ÿ</h2>

              <div class="form-group">
                  <label>çœŸå¯¦å§“å <span class="required">*</span></label>
                  <input type="text" id="regName" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å">
              </div>

              <div class="form-group">
                  <label>é›»è©±è™Ÿç¢¼ <span class="required">*</span></label>
                  <input type="tel" id="regPhone" placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼">
              </div>

              <div class="form-group">
                  <label>å¯†ç¢¼ <span class="required">*</span></label>
                  <input type="password" id="regPassword" placeholder="è«‹è¨­å®šå¯†ç¢¼ï¼ˆè‡³å°‘6ä½ï¼‰">
              </div>

              <div class="form-group">
                  <label>ç¢ºèªå¯†ç¢¼ <span class="required">*</span></label>
                  <input type="password" id="regPasswordConfirm" placeholder="è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼">
              </div>

              <button class="btn btn-primary" onclick="register()" id="registerBtn">è¨»å†Š</button>
              <button class="btn btn-secondary" onclick="showPage('loginPage')">è¿”å›ç™»å…¥</button>
          </div>

          <!-- ä¸»é é¢ -->
          <div id="dashboardPage" class="page">
              <div class="user-info">
                  <p><strong>æ­¡è¿å›ä¾†ï¼</strong></p>
                  <p><strong>å§“å:</strong> <span id="userName">-</span></p>
                  <p><strong>å¸³è™Ÿé¡å‹:</strong> <span id="userType">-</span></p>
              </div>

              <div class="dashboard">
                  <div class="dashboard-card" onclick="showActivities()">
                      <h3>ğŸ“¢ æ´»å‹•å…¬å‘Š</h3>
                      <p>æŸ¥çœ‹æœ€æ–°æ´»å‹•èˆ‡é‡è¦é€šçŸ¥</p>
                  </div>

                  <div class="dashboard-card" onclick="showVolunteerPage()">
                      <h3>ğŸ¤ å¿—å·¥åœ˜éšŠç™»è¨˜</h3>
                      <p>åŠ å…¥å¿—å·¥è¡Œåˆ—ï¼Œè²¢ç»æ‚¨çš„åŠ›é‡</p>
                  </div>

                  <div class="dashboard-card" onclick="showProfilePage()">
                      <h3>ğŸ‘¤ å€‹äººè³‡æ–™ç¶­è­·</h3>
                      <p>ç®¡ç†æ‚¨çš„å®Œæ•´å€‹äººè³‡è¨Š</p>
                  </div>
              </div>

              <button class="btn btn-secondary" onclick="logout()" style="margin-top: 20px;">ç™»å‡º</button>
          </div>

          <!-- æ´»å‹•å…¬å‘Šé é¢ -->
          <div id="activitiesPage" class="page">
              <button class="back-btn" onclick="showPage('dashboardPage')">â† è¿”å›</button>
              <h2 style="margin-bottom: 20px; color: #333;">ğŸ“¢ æ´»å‹•å…¬å‘Š</h2>
              <div id="activitiesList">
                  <div class="loading">è¼‰å…¥ä¸­...</div>
              </div>
          </div>

          <!-- å¿—å·¥ç™»è¨˜é é¢ -->
          <div id="volunteerPage" class="page">
              <button class="back-btn" onclick="showPage('dashboardPage')">â† è¿”å›</button>
              <h2 style="margin-bottom: 20px; color: #333;">ğŸ¤ å¿—å·¥åœ˜éšŠç™»è¨˜</h2>
              
              <div class="form-group">
                  <label>æ´»å‹•åç¨± <span class="required">*</span></label>
                  <input type="text" id="volunteerActivity" placeholder="è«‹è¼¸å…¥è¦åƒåŠ çš„æ´»å‹•åç¨±">
              </div>

              <div class="form-group">
                  <label>å‚™è¨»</label>
                  <textarea id="volunteerNote" placeholder="å…¶ä»–èªªæ˜ï¼ˆé¸å¡«ï¼‰"></textarea>
              </div>

              <button class="btn btn-primary" onclick="submitVolunteer()" id="volunteerBtn">æäº¤ç™»è¨˜</button>
          </div>

          <!-- å€‹äººè³‡æ–™ç¶­è­·é é¢ -->
          <div id="profilePage" class="page">
              <button class="back-btn" onclick="showPage('dashboardPage')">â† è¿”å›</button>
              <h2 style="margin-bottom: 20px; color: #333;">ğŸ‘¤ å€‹äººè³‡æ–™ç¶­è­·</h2>

              <div class="tabs">
                  <button class="tab active" onclick="switchTab('basicTab')">åŸºæœ¬è³‡æ–™</button>
                  <button class="tab" onclick="switchTab('memberTab')">æœƒå“¡è³‡æ–™</button>
                  <button class="tab" onclick="switchTab('patientTab')">å¸•å‹è³‡æ–™</button>
                  <button class="tab" onclick="switchTab('donationTab')">ææ¬¾è¨˜éŒ„</button>
              </div>

              <!-- åŸºæœ¬è³‡æ–™ Tab -->
              <div id="basicTab" class="tab-content active">
                  <div class="form-group">
                      <label>æœƒå“¡é¡åˆ¥ <span class="required">*</span></label>
                      <select id="profileUserType">
                          <option value="ä¸€èˆ¬ç¾¤çœ¾">ä¸€èˆ¬ç¾¤çœ¾</option>
                          <option value="ç—…å‹">ç—…å‹</option>
                          <option value="å®¶å±¬">å®¶å±¬</option>
                          <option value="é†«å¸«">é†«å¸«</option>
                      </select>
                  </div>

                  <div class="form-group">
                      <label>å§“å <span class="required">*</span></label>
                      <input type="text" id="profileName" placeholder="è«‹è¼¸å…¥å§“å">
                  </div>

                  <div class="form-row">
                      <div class="form-group">
                          <label>æ€§åˆ¥</label>
                          <select id="profileGender">
                              <option value="">è«‹é¸æ“‡</option>
                              <option value="ç”·">ç”·</option>
                              <option value="å¥³">å¥³</option>
                              <option value="å…¶ä»–">å…¶ä»–</option>
                          </select>
                      </div>

                      <div class="form-group">
                          <label>ç”Ÿæ—¥</label>
                          <input type="date" id="profileBirthday">
                      </div>
                  </div>

                  <div class="form-group">
                      <label>é›»è©±è™Ÿç¢¼</label>
                      <input type="tel" id="profilePhone" placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼" readonly>
                  </div>

                  <div class="form-group">
                      <label>é›»å­ä¿¡ç®±</label>
                      <input type="email" id="profileEmail" placeholder="è«‹è¼¸å…¥é›»å­ä¿¡ç®±">
                  </div>

                  <div class="form-group">
                      <label>èº«åˆ†è­‰è™Ÿ</label>
                      <input type="text" id="profileIdNumber" placeholder="è«‹è¼¸å…¥èº«åˆ†è­‰è™Ÿ" maxlength="10">
                  </div>

                  <div class="form-group">
                      <label>å±…ä½åœ°å€</label>
                      <input type="text" id="profileAddress" placeholder="è«‹è¼¸å…¥å±…ä½åœ°å€">
                  </div>

                  <button class="btn btn-primary" onclick="saveBasicInfo()">å„²å­˜åŸºæœ¬è³‡æ–™</button>
              </div>

              <!-- æœƒå“¡è³‡æ–™ Tab -->
              <div id="memberTab" class="tab-content">
                  <div class="form-group">
                      <label>æœƒå“¡è³‡æ ¼åˆ°æœŸæ—¥</label>
                      <input type="date" id="membershipExpiry">
                  </div>

                  <div class="form-group">
                      <label>ä¸Šæ¬¡ç¹³è²»æ—¥æœŸ</label>
                      <input type="date" id="lastPaymentDate">
                  </div>

                  <div class="form-group">
                      <label>ä¸‹æ¬¡ç¹³è²»æ—¥æœŸ</label>
                      <input type="date" id="nextPaymentDate">
                  </div>

                  <button class="btn btn-primary" onclick="saveMemberInfo()">å„²å­˜æœƒå“¡è³‡æ–™</button>
              </div>

              <!-- å¸•å‹è³‡æ–™ Tab -->
              <div id="patientTab" class="tab-content">
                  <div class="form-group">
                      <label>ç—…é½¡ï¼ˆå¹´ï¼‰</label>
                      <input type="number" id="diseaseYears" placeholder="è«‹è¼¸å…¥ç—…é½¡" min="0">
                  </div>

                  <div class="form-group">
                      <label>å°±è¨ºé†«é™¢</label>
                      <input type="text" id="hospital" placeholder="è«‹è¼¸å…¥å°±è¨ºé†«é™¢">
                  </div>

                  <div class="form-group">
                      <label>ä¸»æ²»é†«å¸«</label>
                      <input type="text" id="doctor" placeholder="è«‹è¼¸å…¥ä¸»æ²»é†«å¸«å§“å">
                  </div>

                  <div class="form-group">
                      <label>å°ä¸»æ²»é†«å¸«çš„è©•èª</label>
                      <textarea id="doctorReview" placeholder="è«‹åˆ†äº«æ‚¨å°ä¸»æ²»é†«å¸«çš„è©•åƒ¹èˆ‡å»ºè­°"></textarea>
                  </div>

                  <div class="form-group">
                      <label>å¸•ç—…æœ€å›°æ“¾æ‚¨çš„å•é¡Œæ˜¯ï¼Ÿ</label>
                      <textarea id="mainProblem" placeholder="è«‹æè¿°æ‚¨ç›®å‰æœ€å›°æ“¾çš„ç—‡ç‹€æˆ–å•é¡Œ"></textarea>
                  </div>

                  <div class="form-group">
                      <label>å¸Œæœ›å”æœƒå”åŠ©æ‚¨çš„äº‹é …</label>
                      <textarea id="needHelp" placeholder="è«‹å‘Šè¨´æˆ‘å€‘æ‚¨éœ€è¦ä»€éº¼æ¨£çš„å”åŠ©"></textarea>
                  </div>

                  <button class="btn btn-primary" onclick="savePatientInfo()">å„²å­˜å¸•å‹è³‡æ–™</button>
              </div>

              <!-- ææ¬¾è¨˜éŒ„ Tab -->
              <div id="donationTab" class="tab-content">
                  <button class="btn btn-secondary" onclick="showAddDonation()" style="margin-bottom: 20px;">+ æ–°å¢ææ¬¾è¨˜éŒ„</button>
                  
                  <div id="donationsList">
                      <div class="loading">è¼‰å…¥ä¸­...</div>
                  </div>
              </div>
          </div>

          <!-- æ–°å¢ææ¬¾è¨˜éŒ„é é¢ -->
          <div id="addDonationPage" class="page">
              <button class="back-btn" onclick="backToProfile()">â† è¿”å›</button>
              <h2 style="margin-bottom: 20px; color: #333;">æ–°å¢ææ¬¾è¨˜éŒ„</h2>

              <div class="form-group">
                  <label>ææ¬¾é‡‘é¡ <span class="required">*</span></label>
                  <input type="number" id="donationAmount" placeholder="è«‹è¼¸å…¥ææ¬¾é‡‘é¡" min="0">
              </div>

              <div class="form-group">
                  <label>ææ¬¾æ—¥æœŸ <span class="required">*</span></label>
                  <input type="date" id="donationDate">
              </div>

              <div class="form-group">
                  <label>æ”¶æ“šé€£çµ</label>
                  <input type="url" id="receiptUrl" placeholder="è«‹è¼¸å…¥æ”¶æ“šé€£çµï¼ˆé¸å¡«ï¼‰">
              </div>

              <div class="form-group">
                  <label>å‚™è¨»</label>
                  <textarea id="donationNote" placeholder="å…¶ä»–èªªæ˜ï¼ˆé¸å¡«ï¼‰"></textarea>
              </div>

              <button class="btn btn-primary" onclick="submitDonation()" id="donationBtn">æ–°å¢ææ¬¾è¨˜éŒ„</button>
          </div>
      </div>
  </div>

  <script>
      // ========== ğŸ”§ é…ç½®å€ ==========
      const API_URL = 'https://script.google.com/macros/s/AKfycbyulr3oowOoMbQJpkOnnXP2PY1w02ltsNJ2Gy_SfoafBR70HRf0rkwwKwKu_u7qWyaM8g/exec';
      const LIFF_ID = '1656516134-VaGgmaPm';
      
      // ========== å…¨åŸŸè®Šæ•¸ ==========
      let currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
      let lineUserData = null;
      let currentProfile = null;

      // ========== åˆå§‹åŒ– ==========
      window.onload = function() {
          if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
              document.getElementById('configWarning').style.display = 'block';
          }
          
          if (currentUser) {
              showDashboard();
          }
      };

      // ========== API å‘¼å« ==========
      async function callAPI(action, data = {}) {
          if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
              return { success: false, message: 'è«‹å…ˆè¨­å®š API URL' };
          }

          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'text/plain',
                  },
                  body: JSON.stringify({
                      action: action,
                      data: data
                  })
              });
              
              const text = await response.text();
              return JSON.parse(text);
          } catch (error) {
              console.error('API å‘¼å«éŒ¯èª¤:', error);
              return { success: false, message: 'ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦' };
          }
      }

      // ========== é é¢åˆ‡æ› ==========
      function showPage(pageId) {
          document.querySelectorAll('.page').forEach(page => {
              page.classList.remove('active');
          });
          document.getElementById(pageId).classList.add('active');
      }

      function switchTab(tabId) {
          document.querySelectorAll('.tab').forEach(tab => {
              tab.classList.remove('active');
          });
          document.querySelectorAll('.tab-content').forEach(content => {
              content.classList.remove('active');
          });
          
          event.target.classList.add('active');
          document.getElementById(tabId).classList.add('active');

          if (tabId === 'donationTab') {
              loadDonations();
          }
      }

      // ========== è¨Šæ¯é¡¯ç¤º ==========
      function showMessage(message, type = 'success') {
          const oldMessages = document.querySelectorAll('.success-message, .error-message');
          oldMessages.forEach(msg => msg.remove());

          const messageDiv = document.createElement('div');
          messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
          messageDiv.textContent = message;
          
          const content = document.querySelector('.content');
          const firstPage = content.querySelector('.page.active');
          firstPage.insertBefore(messageDiv, firstPage.firstChild);
          
          setTimeout(() => messageDiv.remove(), 3000);
      }

      // ========== LINE ç™»å…¥ ==========
      async function lineLogin() {
          const btn = document.getElementById('lineLoginBtn');
          
          if (!LIFF_ID) {
              showMessage('LINE ç™»å…¥åŠŸèƒ½å°šæœªè¨­å®š', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = 'è™•ç†ä¸­...';
          
          try {
              await liff.init({ liffId: LIFF_ID });
              
              if (!liff.isLoggedIn()) {
                  liff.login();
                  return;
              }
              
              const profile = await liff.getProfile();
              lineUserData = {
                  lineId: profile.userId,
                  lineName: profile.displayName
              };

              const result = await callAPI('checkLineUser', { lineId: lineUserData.lineId });
              
              if (result.success && result.exists) {
                  currentUser = result.user;
                  sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                  showMessage('ç™»å…¥æˆåŠŸï¼');
                  showDashboard();
              } else {
                  document.getElementById('displayLineId').textContent = lineUserData.lineId;
                  document.getElementById('displayLineName').textContent = lineUserData.lineName;
                  showPage('lineRegisterPage');
              }
          } catch (error) {
              console.error('LINE ç™»å…¥éŒ¯èª¤:', error);
              showMessage('LINE ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
          } finally {
              btn.disabled = false;
              btn.innerHTML = '<span style="font-size: 20px;">ğŸ“±</span> ä½¿ç”¨ LINE ç™»å…¥';
          }
      }

      // ========== å®Œæˆ LINE è¨»å†Š ==========
      async function completeLineRegister() {
          const realName = document.getElementById('realName').value.trim();
          const btn = document.getElementById('lineRegBtn');

          if (!realName) {
              showMessage('è«‹è¼¸å…¥çœŸå¯¦å§“å', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = 'è™•ç†ä¸­...';

          const result = await callAPI('lineRegister', {
              name: realName,
              lineId: lineUserData.lineId,
              lineName: lineUserData.lineName
          });

          if (result.success) {
              currentUser = result.user;
              sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
              showMessage('è¨»å†ŠæˆåŠŸï¼æ­¡è¿åŠ å…¥');
              showDashboard();
          } else {
              showMessage(result.message, 'error');
              btn.disabled = false;
              btn.textContent = 'å®Œæˆè¨»å†Š';
          }
      }

      // ========== ä¸€èˆ¬è¨»å†Š ==========
      async function register() {
          const name = document.getElementById('regName').value.trim();
          const phone = document.getElementById('regPhone').value.trim();
          const password = document.getElementById('regPassword').value;
          const passwordConfirm = document.getElementById('regPasswordConfirm').value;
          const btn = document.getElementById('registerBtn');

          if (!name || !phone || !password) {
              showMessage('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
              return;
          }

          if (password.length < 6) {
              showMessage('å¯†ç¢¼è‡³å°‘éœ€è¦6ä½', 'error');
              return;
          }

          if (password !== passwordConfirm) {
              showMessage('å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = 'è™•ç†ä¸­...';

          const result = await callAPI('register', {
              name: name,
              phone: phone,
              password: password
          });

          if (result.success) {
              showMessage('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥');
              showPage('loginPage');
              document.getElementById('regName').value = '';
              document.getElementById('regPhone').value = '';
              document.getElementById('regPassword').value = '';
              document.getElementById('regPasswordConfirm').value = '';
          } else {
              showMessage(result.message, 'error');
          }

          btn.disabled = false;
          btn.textContent = 'è¨»å†Š';
      }

      // ========== ä¸€èˆ¬ç™»å…¥ ==========
      async function normalLogin() {
          const phone = document.getElementById('loginPhone').value.trim();
          const password = document.getElementById('loginPassword').value;
          const btn = document.getElementById('loginBtn');

          if (!phone || !password) {
              showMessage('è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼å’Œå¯†ç¢¼', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = 'è™•ç†ä¸­...';

          const result = await callAPI('login', {
              phone: phone,
              password: password
          });

          if (result.success) {
              currentUser = result.user;
              sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
              showMessage('ç™»å…¥æˆåŠŸï¼');
              showDashboard();
          } else {
              showMessage(result.message, 'error');
          }

          btn.disabled = false;
          btn.textContent = 'ç™»å…¥';
      }

      // ========== é¡¯ç¤ºä¸»é é¢ ==========
      function showDashboard() {
          document.getElementById('userName').textContent = currentUser.name;
          document.getElementById('userType').textContent = currentUser.type;
          showPage('dashboardPage');
      }

      // ========== é¡¯ç¤ºæ´»å‹•å…¬å‘Š ==========
      async function showActivities() {
          showPage('activitiesPage');
          
          const listDiv = document.getElementById('activitiesList');
          listDiv.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
          
          const result = await callAPI('getActivities');
          
          if (result.success) {
              if (result.activities.length === 0) {
                  listDiv.innerHTML = '<p style="text-align: center; color: #999;">ç›®å‰æ²’æœ‰æ´»å‹•å…¬å‘Š</p>';
              } else {
                  listDiv.innerHTML = result.activities.map(activity => `
                      <div class="activity-item">
                          <h4>${activity.title}</h4>
                          <p>${activity.content}</p>
                          <p class="date">ğŸ“… ${activity.date}</p>
                      </div>
                  `).join('');
              }
          } else {
              listDiv.innerHTML = '<p style="text-align: center; color: #f00;">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
          }
      }

      // ========== å¿—å·¥ç™»è¨˜ ==========
      function showVolunteerPage() {
          showPage('volunteerPage');
          document.getElementById('volunteerActivity').value = '';
          document.getElementById('volunteerNote').value = '';
      }

      async function submitVolunteer() {
          const activity = document.getElementById('volunteerActivity').value.trim();
          const btn = document.getElementById('volunteerBtn');

          if (!activity) {
              showMessage('è«‹è¼¸å…¥æ´»å‹•åç¨±', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = 'è™•ç†ä¸­...';

          const result = await callAPI('registerVolunteer', {
              userId: currentUser.id,
              userName: currentUser.name,
              activity: activity
          });

          if (result.success) {
              showMessage('å¿—å·¥ç™»è¨˜æˆåŠŸï¼');
              showPage('dashboardPage');
          } else {
              showMessage(result.message, 'error');
          }

          btn.disabled = false;
          btn.textContent = 'æäº¤ç™»è¨˜';
      }

      // ========== å€‹äººè³‡æ–™ç¶­è­· ==========
      async function showProfilePage() {
          showPage('profilePage');
          switchTab('basicTab');
          await loadProfile();
      }

      async function loadProfile() {
          const result = await callAPI('getUserProfile', { userId: currentUser.id });
          
          if (result.success) {
              currentProfile = result.profile;
              
              // å¡«å……åŸºæœ¬è³‡æ–™
              const basic = currentProfile.basic;
              document.getElementById('profileUserType').value = basic.type || 'ä¸€èˆ¬ç¾¤çœ¾';
              document.getElementById('profileName').value = basic.name || '';
              document.getElementById('profileGender').value = basic.gender || '';
              document.getElementById('profileBirthday').value = basic.birthday || '';
              document.getElementById('profilePhone').value = basic.phone || '';
              document.getElementById('profileEmail').value = basic.email || '';
              document.getElementById('profileIdNumber').value = basic.idNumber || '';
              document.getElementById('profileAddress').value = basic.address || '';
              
              // å¡«å……æœƒå“¡è³‡æ–™
              if (currentProfile.member) {
                  const member = currentProfile.member;
                  document.getElementById('membershipExpiry').value = member.membershipExpiry || '';
                  document.getElementById('lastPaymentDate').value = member.lastPaymentDate || '';
                  document.getElementById('nextPaymentDate').value = member.nextPaymentDate || '';
              }
              
              // å¡«å……å¸•å‹è³‡æ–™
              if (currentProfile.patient) {
                  const patient = currentProfile.patient;
                  document.getElementById('diseaseYears').value = patient.diseaseYears || '';
                  document.getElementById('hospital').value = patient.hospital || '';
                  document.getElementById('doctor').value = patient.doctor || '';
                  document.getElementById('doctorReview').value = patient.doctorReview || '';
                  document.getElementById('mainProblem').value = patient.mainProblem || '';
                  document.getElementById('needHelp').value = patient.needHelp || '';
              }
          }
      }

      async function saveBasicInfo() {
          const data = {
              userId: currentUser.id,
              name: document.getElementById('profileName').value.trim(),
              type: document.getElementById('profileUserType').value,
              gender: document.getElementById('profileGender').value,
              birthday: document.getElementById('profileBirthday').value,
              email: document.getElementById('profileEmail').value.trim(),
              idNumber: document.getElementById('profileIdNumber').value.trim(),
              address: document.getElementById('profileAddress').value.trim()
          };

          if (!data.name) {
              showMessage('è«‹è¼¸å…¥å§“å', 'error');
              return;
          }

          const result = await callAPI('updateUserProfile', data);
          
          if (result.success) {
              showMessage('åŸºæœ¬è³‡æ–™å„²å­˜æˆåŠŸï¼');
              currentUser.name = data.name;
              currentUser.type = data.type;
              sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
          } else {
              showMessage(result.message, 'error');
          }
      }

      async function saveMemberInfo() {
          const data = {
              userId: currentUser.id,
              membershipExpiry: document.getElementById('membershipExpiry').value,
              lastPaymentDate: document.getElementById('lastPaymentDate').value,
              nextPaymentDate: document.getElementById('nextPaymentDate').value
          };

          const result = await callAPI('updateMemberInfo', data);
          
          if (result.success) {
                showMessage('æœƒå“¡è³‡æ–™å„²å­˜æˆåŠŸï¼');
            } else {
                showMessage(result.message, 'error');
            }
        }

        async function savePatientInfo() {
            const data = {
                userId: currentUser.id,
                diseaseYears: document.getElementById('diseaseYears').value,
                hospital: document.getElementById('hospital').value.trim(),
                doctor: document.getElementById('doctor').value.trim(),
                doctorReview: document.getElementById('doctorReview').value.trim(),
                mainProblem: document.getElementById('mainProblem').value.trim(),
                needHelp: document.getElementById('needHelp').value.trim()
            };

            const result = await callAPI('updatePatientInfo', data);
            
            if (result.success) {
                showMessage('å¸•å‹è³‡æ–™å„²å­˜æˆåŠŸï¼');
            } else {
                showMessage(result.message, 'error');
            }
        }

        // ========== ææ¬¾è¨˜éŒ„ç®¡ç† ==========
        async function loadDonations() {
            const listDiv = document.getElementById('donationsList');
            listDiv.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            const result = await callAPI('getDonations', { userId: currentUser.id });
            
            if (result.success) {
                if (result.donations.length === 0) {
                    listDiv.innerHTML = '<p style="text-align: center; color: #999;">ç›®å‰æ²’æœ‰ææ¬¾è¨˜éŒ„</p>';
                } else {
                    listDiv.innerHTML = result.donations.map(donation => `
                        <div class="donation-item">
                            <div class="donation-header">
                                <div class="donation-amount">NT$ ${Number(donation.amount).toLocaleString()}</div>
                                <div class="donation-date">${donation.date}</div>
                            </div>
                            ${donation.note ? `<p style="color: #666; font-size: 14px; margin-top: 5px;">${donation.note}</p>` : ''}
                            ${donation.receiptUrl ? `<a href="${donation.receiptUrl}" target="_blank" class="receipt-link">ğŸ“„ æŸ¥çœ‹æ”¶æ“š</a>` : ''}
                        </div>
                    `).join('');
                }
            } else {
                listDiv.innerHTML = '<p style="text-align: center; color: #f00;">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
            }
        }

        function showAddDonation() {
            showPage('addDonationPage');
            document.getElementById('donationAmount').value = '';
            document.getElementById('donationDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('receiptUrl').value = '';
            document.getElementById('donationNote').value = '';
        }

        async function submitDonation() {
            const amount = document.getElementById('donationAmount').value;
            const date = document.getElementById('donationDate').value;
            const receiptUrl = document.getElementById('receiptUrl').value.trim();
            const note = document.getElementById('donationNote').value.trim();
            const btn = document.getElementById('donationBtn');

            if (!amount || !date) {
                showMessage('è«‹å¡«å¯«ææ¬¾é‡‘é¡å’Œæ—¥æœŸ', 'error');
                return;
            }

            if (Number(amount) <= 0) {
                showMessage('ææ¬¾é‡‘é¡å¿…é ˆå¤§æ–¼ 0', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'è™•ç†ä¸­...';

            const result = await callAPI('addDonation', {
                userId: currentUser.id,
                userName: currentUser.name,
                amount: amount,
                date: date,
                receiptUrl: receiptUrl,
                note: note
            });

            if (result.success) {
                showMessage('ææ¬¾è¨˜éŒ„æ–°å¢æˆåŠŸï¼');
                backToProfile();
            } else {
                showMessage(result.message, 'error');
            }

            btn.disabled = false;
            btn.textContent = 'æ–°å¢ææ¬¾è¨˜éŒ„';
        }

        function backToProfile() {
            showPage('profilePage');
            switchTab('donationTab');
            loadDonations();
        }

        // ========== ç™»å‡º ==========
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                showMessage('å·²ç™»å‡º');
                showPage('loginPage');
            }
        }
    </script>
</body>
</html>
