<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£å¸•é‡‘æ£®ä¹‹å‹å”æœƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .page {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .user-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 10px 20px;
            width: auto;
        }

        .btn-outline {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        .btn-line {
            background: #06C755;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-line:hover {
            background: #05b34a;
            box-shadow: 0 5px 20px rgba(6, 199, 85, 0.4);
        }

        .link-btn {
            text-align: center;
            margin-top: 15px;
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
        }

        .link-btn:hover {
            color: #764ba2;
        }

        .message {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
        }

        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .nav-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }

        .nav-card .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .nav-card .title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .activity-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .activity-item h4 {
            color: #333;
            margin-bottom: 8px;
        }

        .activity-item p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .activity-item .date {
            color: #999;
            font-size: 12px;
            margin-top: 8px;
        }

        .profile-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .profile-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #666;
        }

        .info-value {
            color: #333;
        }

        .donation-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
        }

        .donation-amount {
            font-size: 20px;
            font-weight: bold;
            color: #27ae60;
        }

        .donation-date {
            color: #999;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .admin-entrance {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 15px;
            border: 2px dashed #667eea;
        }

        .admin-entrance button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .admin-entrance button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .divider {
            text-align: center;
            margin: 30px 0 20px 0;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .divider p {
            color: #999;
            margin-bottom: 15px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .page {
                padding: 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            .stats-grid, .nav-grid {
                grid-template-columns: 1fr;
            }

            .user-info {
                flex-direction: column;
            }
        }
    </style>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div class="container">
        <!-- ç™»å…¥é é¢ -->
        <div id="loginPage" class="page active">
            <div class="header">
                <h1>ğŸ¥ å°ç£å¸•é‡‘æ£®ä¹‹å‹å”æœƒ</h1>
                <p style="color: #666;">æ­¡è¿å›ä¾†</p>
            </div>

            <div id="loginMessage"></div>

            <form id="loginForm" onsubmit="event.preventDefault(); loginUser();">
                <div class="form-group">
                    <label>é›»è©±è™Ÿç¢¼</label>
                    <input type="tel" id="loginPhone" placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼" required>
                </div>

                <div class="form-group">
                    <label>å¯†ç¢¼</label>
                    <input type="password" id="loginPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
                </div>

                <button type="submit" class="btn">ç™»å…¥</button>
            </form>

            <div class="link-btn" onclick="showPage('registerPage')">
                é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿç«‹å³è¨»å†Š
            </div>

            <div class="divider">
                <p>æˆ–ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ç™»å…¥</p>
                <button onclick="lineLogin()" class="btn btn-line">
                    <span style="font-size: 20px;">ğŸ’¬</span>
                    ä½¿ç”¨ LINE ç™»å…¥
                </button>
            </div>
        </div>

        <!-- è¨»å†Šé é¢ -->
        <div id="registerPage" class="page">
            <div class="header">
                <h1>ğŸ“ è¨»å†Šæ–°å¸³è™Ÿ</h1>
            </div>

            <div id="registerMessage"></div>

            <form id="registerForm" onsubmit="event.preventDefault(); registerUser();">
                <div class="form-group">
                    <label>å§“å <span style="color: red;">*</span></label>
                    <input type="text" id="registerName" placeholder="è«‹è¼¸å…¥å§“å" required>
                </div>

                <div class="form-group">
                    <label>é›»è©±è™Ÿç¢¼ <span style="color: red;">*</span></label>
                    <input type="tel" id="registerPhone" placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼" required>
                </div>

                <div class="form-group">
                    <label>å¯†ç¢¼ <span style="color: red;">*</span></label>
                    <input type="password" id="registerPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼ï¼ˆè‡³å°‘6ä½ï¼‰" required minlength="6">
                </div>

                <div class="form-group">
                    <label>ç¢ºèªå¯†ç¢¼ <span style="color: red;">*</span></label>
                    <input type="password" id="registerPasswordConfirm" placeholder="è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼" required>
                </div>

                <button type="submit" class="btn">è¨»å†Š</button>
            </form>

            <div class="link-btn" onclick="showPage('loginPage')">
                å·²æœ‰å¸³è™Ÿï¼Ÿç«‹å³ç™»å…¥
            </div>
        </div>

        <!-- é¦–é  -->
        <div id="homePage" class="page">
            <div class="header">
                <h1>ğŸ¥ å°ç£å¸•é‡‘æ£®ä¹‹å‹å”æœƒ</h1>
                <div class="user-info">
                    <span id="userName">è¼‰å…¥ä¸­...</span>
                    <button class="btn-secondary" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>

            <!-- ç®¡ç†å“¡å…¥å£ -->
            <div id="adminEntrance" class="admin-entrance" style="display: none;">
                <p style="margin-bottom: 10px; color: #667eea; font-weight: 600;">ğŸ‘‘ æ‚¨æœ‰ç®¡ç†å“¡æ¬Šé™</p>
                <button onclick="window.location.href='admin.html'">
                    ğŸ”§ é€²å…¥ç®¡ç†å¾Œå°
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>æœƒå“¡èº«ä»½</h3>
                    <div class="number" id="userType">ä¸€èˆ¬ç¾¤çœ¾</div>
                </div>
                <div class="stat-card">
                    <h3>ç´¯è¨ˆææ¬¾</h3>
                    <div class="number" id="totalDonation">NT$ 0</div>
                </div>
            </div>

            <div class="nav-grid">
                <div class="nav-card" onclick="showPage('profilePage')">
                    <div class="icon">ğŸ‘¤</div>
                    <div class="title">å€‹äººè³‡æ–™</div>
                </div>
                <div class="nav-card" onclick="showPage('donationPage')">
                    <div class="icon">ğŸ’°</div>
                    <div class="title">ææ¬¾è¨˜éŒ„</div>
                </div>
                <div class="nav-card" onclick="showPage('activitiesPage')">
                    <div class="icon">ğŸ“…</div>
                    <div class="title">æœ€æ–°æ´»å‹•</div>
                </div>
                <div class="nav-card" onclick="showPage('volunteerPage')">
                    <div class="icon">ğŸ™‹</div>
                    <div class="title">å¿—å·¥ç™»è¨˜</div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“¢ æœ€æ–°æ¶ˆæ¯</h3>
                <div id="homeActivities">
                    <div class="empty-state">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- å€‹äººè³‡æ–™é é¢ -->
        <div id="profilePage" class="page">
            <div class="header">
                <h1>ğŸ‘¤ å€‹äººè³‡æ–™</h1>
                <button class="btn-secondary" onclick="showPage('homePage')">è¿”å›é¦–é </button>
            </div>

            <div id="profileMessage"></div>

            <!-- åŸºæœ¬è³‡æ–™ -->
            <div class="profile-section">
                <h3>åŸºæœ¬è³‡æ–™</h3>
                <form id="basicInfoForm" onsubmit="event.preventDefault(); updateBasicInfo();">
                    <div class="form-group">
                        <label>å§“å</label>
                        <input type="text" id="profileName" required>
                    </div>
                    <div class="form-group">
                        <label>é›»è©±</label>
                        <input type="tel" id="profilePhone" readonly style="background: #f0f0f0;">
                    </div>
                    <div class="form-group">
                        <label>èº«ä»½é¡åˆ¥</label>
                        <select id="profileType">
                            <option value="ä¸€èˆ¬ç¾¤çœ¾">ä¸€èˆ¬ç¾¤çœ¾</option>
                            <option value="ç—…å‹">ç—…å‹</option>
                            <option value="å®¶å±¬">å®¶å±¬</option>
                            <option value="é†«å¸«">é†«å¸«</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="profileEmail">
                    </div>
                    <div class="form-group">
                        <label>æ€§åˆ¥</label>
                        <select id="profileGender">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç”Ÿæ—¥</label>
                        <input type="date" id="profileBirthday">
                    </div>
                    <div class="form-group">
                        <label>èº«ä»½è­‰å­—è™Ÿ</label>
                        <input type="text" id="profileIdNumber" maxlength="10">
                    </div>
                    <div class="form-group">
                        <label>åœ°å€</label>
                        <textarea id="profileAddress" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn">å„²å­˜åŸºæœ¬è³‡æ–™</button>
                </form>
            </div>

            <!-- æœƒå“¡è³‡æ–™ -->
            <div class="profile-section">
                <h3>æœƒå“¡è³‡æ–™</h3>
                <form id="memberInfoForm" onsubmit="event.preventDefault(); updateMemberInfo();">
                    <div class="form-group">
                        <label>æœƒå“¡åˆ°æœŸæ—¥</label>
                        <input type="date" id="membershipExpiry">
                    </div>
                    <div class="form-group">
                        <label>ä¸Šæ¬¡ç¹³è²»æ—¥æœŸ</label>
                        <input type="date" id="lastPaymentDate">
                    </div>
                    <div class="form-group">
                        <label>ä¸‹æ¬¡ç¹³è²»æ—¥æœŸ</label>
                        <input type="date" id="nextPaymentDate">
                    </div>
                    <button type="submit" class="btn">å„²å­˜æœƒå“¡è³‡æ–™</button>
                </form>
            </div>

            <!-- å¸•å‹è³‡æ–™ -->
            <div class="profile-section" id="patientInfoSection" style="display: none;">
                <h3>å¸•å‹è³‡æ–™</h3>
                <form id="patientInfoForm" onsubmit="event.preventDefault(); updatePatientInfo();">
                    <div class="form-group">
                        <label>ç½¹ç—…å¹´æ•¸</label>
                        <input type="number" id="diseaseYears" min="0" placeholder="ä¾‹å¦‚ï¼š5">
                    </div>
                    <div class="form-group">
                        <label>å°±è¨ºé†«é™¢</label>
                        <input type="text" id="hospital" placeholder="ä¾‹å¦‚ï¼šå°å¤§é†«é™¢">
                    </div>
                    <div class="form-group">
                        <label>ä¸»æ²»é†«å¸«</label>
                        <input type="text" id="doctor" placeholder="ä¾‹å¦‚ï¼šç‹é†«å¸«">
                    </div>
                    <div class="form-group">
                        <label>é†«å¸«å›è¨ºæ™‚é–“</label>
                        <input type="text" id="doctorReview" placeholder="ä¾‹å¦‚ï¼šæ¯æœˆç¬¬ä¸€é€±">
                    </div>
                    <div class="form-group">
                        <label>ä¸»è¦å›°æ“¾</label>
                        <textarea id="mainProblem" rows="3" placeholder="è«‹æè¿°æ‚¨ç›®å‰é‡åˆ°çš„ä¸»è¦å•é¡Œ"></textarea>
                    </div>
                    <div class="form-group">
                        <label>éœ€è¦å”åŠ©</label>
                        <textarea id="needHelp" rows="3" placeholder="è«‹æè¿°æ‚¨éœ€è¦çš„å”åŠ©"></textarea>
                    </div>
                    <button type="submit" class="btn">å„²å­˜å¸•å‹è³‡æ–™</button>
                </form>
            </div>
        </div>

        <!-- ææ¬¾è¨˜éŒ„é é¢ -->
        <div id="donationPage" class="page">
            <div class="header">
                <h1>ğŸ’° ææ¬¾è¨˜éŒ„</h1>
                <button class="btn-secondary" onclick="showPage('homePage')">è¿”å›é¦–é </button>
            </div>

            <div class="card">
                <h3>æ–°å¢ææ¬¾</h3>
                <form id="donationForm" onsubmit="event.preventDefault(); addDonation();">
                    <div class="form-group">
                        <label>ææ¬¾é‡‘é¡ <span style="color: red;">*</span></label>
                        <input type="number" id="donationAmount" placeholder="è«‹è¼¸å…¥é‡‘é¡" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>ææ¬¾æ—¥æœŸ <span style="color: red;">*</span></label>
                        <input type="date" id="donationDate" required>
                    </div>
                    <div class="form-group">
                        <label>æ”¶æ“šé€£çµ</label>
                        <input type="url" id="donationReceipt" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨»</label>
                        <textarea id="donationNote" rows="2" placeholder="å…¶ä»–èªªæ˜"></textarea>
                    </div>
                    <button type="submit" class="btn">æ–°å¢ææ¬¾è¨˜éŒ„</button>
                </form>
            </div>

            <div class="card">
                <h3>æˆ‘çš„ææ¬¾è¨˜éŒ„</h3>
                <div id="donationList">
                    <div class="empty-state">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- æœ€æ–°æ´»å‹•é é¢ -->
        <div id="activitiesPage" class="page">
            <div class="header">
                <h1>ğŸ“… æœ€æ–°æ´»å‹•</h1>
                <button class="btn-secondary" onclick="showPage('homePage')">è¿”å›é¦–é </button>
            </div>

            <div id="activitiesList">
                <div class="empty-state">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <!-- å¿—å·¥ç™»è¨˜é é¢ -->
        <div id="volunteerPage" class="page">
            <div class="header">
                <h1>ğŸ™‹ å¿—å·¥ç™»è¨˜</h1>
                <button class="btn-secondary" onclick="showPage('homePage')">è¿”å›é¦–é </button>
            </div>

            <div class="card">
                <h3>å¿—å·¥ç™»è¨˜è¡¨</h3>
                <form id="volunteerForm" onsubmit="event.preventDefault(); registerVolunteer();">
                    <div class="form-group">
                        <label>æ´»å‹•åç¨± <span style="color: red;">*</span></label>
                        <input type="text" id="volunteerActivity" placeholder="è«‹è¼¸å…¥æ´»å‹•åç¨±" required>
                    </div>
                    <div class="form-group">
                        <label>æ‚¨çš„å§“å</label>
                        <input type="text" id="volunteerName" readonly style="background: #f0f0f0;">
                    </div>
                    <button type="submit" class="btn">æäº¤ç™»è¨˜</button>
                </form>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 10px;">
                <p style="color: #856404; font-size: 14px;">
                    ğŸ’¡ æç¤ºï¼šå¿—å·¥ç™»è¨˜å¾Œï¼Œæˆ‘å€‘æœƒç›¡å¿«èˆ‡æ‚¨è¯ç¹«ç¢ºèªç›¸é—œäº‹å®œã€‚
                </p>
            </div>
        </div>
    </div>

    <script>
        // ==================== é…ç½® ====================
        const API_URL = 'https://script.google.com/macros/s/AKfycby6SNF8aNbxSdsLWumSlXj5n4Z1FNl_N8px3X_jGBhcdeX8iJk9Fz6gzBTkwbRnN3xA8Q/exec'; // è«‹æ›¿æ›æˆæ‚¨çš„ API URL
        const LIFF_ID = '1656516134-VaGgmaPm'; // è«‹æ›¿æ›æˆæ‚¨çš„ LIFF ID
        let currentUser = JSON.parse(sessionStorage.getItem('currentUser'));

        // ==================== åˆå§‹åŒ– ====================
        window.onload = function() {
            initializeLiff();
        };

        // ==================== LIFF åˆå§‹åŒ– ====================
        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (liff.isLoggedIn()) {
                    // å·²ç¶“é€é LINE ç™»å…¥
                    const profile = await liff.getProfile();
                    await handleLineLogin(profile);
                } else {
                    // æª¢æŸ¥æ˜¯å¦æœ‰ä¸€èˆ¬ç™»å…¥çš„ session
                    if (currentUser) {
                        showPage('homePage');
                        loadUserData();
                        checkAdminAccess();
                    } else {
                        showPage('loginPage');
                    }
                }
            } catch (error) {
                console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                // LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œä½¿ç”¨ä¸€èˆ¬ç™»å…¥
                if (currentUser) {
                    showPage('homePage');
                    loadUserData();
                    checkAdminAccess();
                } else {
                    showPage('loginPage');
                }
            }
        }

        // ==================== LINE ç™»å…¥è™•ç† ====================
        async function handleLineLogin(profile) {
            const lineId = profile.userId;
            const displayName = profile.displayName;
            const pictureUrl = profile.pictureUrl;

            // å‘¼å«å¾Œç«¯ API æª¢æŸ¥æˆ–å»ºç«‹ç”¨æˆ¶
            const result = await callAPI('lineLogin', {
                lineId: lineId,
                displayName: displayName,
                pictureUrl: pictureUrl
            });

            if (result.success) {
                currentUser = result.user;
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
                const adminCheck = await callAPI('checkAdmin', { userId: currentUser.id });
                
                if (adminCheck.success && adminCheck.isAdmin) {
                    if (confirm('æ‚¨æœ‰ç®¡ç†å“¡æ¬Šé™ï¼Œæ˜¯å¦è¦é€²å…¥ç®¡ç†å¾Œå°ï¼Ÿ\n\né»é¸ã€Œç¢ºå®šã€é€²å…¥ç®¡ç†å¾Œå°\né»é¸ã€Œå–æ¶ˆã€ä½¿ç”¨ä¸€èˆ¬åŠŸèƒ½')) {
                        window.location.href = 'admin.html';
                        return;
                    }
                }
                
                showPage('homePage');
                loadUserData();
                checkAdminAccess();
            } else {
                alert('LINE ç™»å…¥å¤±æ•—ï¼š' + result.message);
                liff.logout();
                showPage('loginPage');
            }
        }

        function lineLogin() {
            if (!liff.isLoggedIn()) {
                liff.login();
            }
        }

        // ==================== API å‘¼å« ====================
        async function callAPI(action, data = {}) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: action, data: data })
                });
                const text = await response.text();
                return JSON.parse(text);
            } catch (error) {
                console.error('API éŒ¯èª¤:', error);
                return { success: false, message: 'ç¶²è·¯é€£ç·šéŒ¯èª¤' };
            }
        }

        // ==================== é é¢åˆ‡æ› ====================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            // è¼‰å…¥å°æ‡‰é é¢è³‡æ–™
            if (pageId === 'homePage') {
                loadUserData();
                loadActivities();
            } else if (pageId === 'profilePage') {
                loadProfile();
            } else if (pageId === 'donationPage') {
                loadDonations();
                document.getElementById('donationDate').value = new Date().toISOString().split('T')[0];
            } else if (pageId === 'activitiesPage') {
                loadActivities();
            } else if (pageId === 'volunteerPage') {
                document.getElementById('volunteerName').value = currentUser.name;
            }
        }

        // ==================== è¨Šæ¯é¡¯ç¤º ====================
        function showMessage(message, type = 'info', elementId = 'loginMessage') {
            const messageDiv = document.getElementById(elementId);
            messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        }

        // ==================== ç™»å…¥è¨»å†Š ====================
        async function loginUser() {
            const phone = document.getElementById('loginPhone').value;
            const password = document.getElementById('loginPassword').value;

            if (!phone || !password) {
                showMessage('è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼å’Œå¯†ç¢¼', 'error');
                return;
            }

            showMessage('ç™»å…¥ä¸­...', 'info');

            const result = await callAPI('login', { phone: phone, password: password });

            if (result.success) {
                currentUser = result.user;
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
                const adminCheck = await callAPI('checkAdmin', { userId: currentUser.id });
                
                if (adminCheck.success && adminCheck.isAdmin) {
                    if (confirm('æ‚¨æœ‰ç®¡ç†å“¡æ¬Šé™ï¼Œæ˜¯å¦è¦é€²å…¥ç®¡ç†å¾Œå°ï¼Ÿ\n\né»é¸ã€Œç¢ºå®šã€é€²å…¥ç®¡ç†å¾Œå°\né»é¸ã€Œå–æ¶ˆã€ä½¿ç”¨ä¸€èˆ¬åŠŸèƒ½')) {
                        window.location.href = 'admin.html';
                        return;
                    }
                }
                
                showMessage('ç™»å…¥æˆåŠŸï¼', 'success');
                setTimeout(() => {
                    showPage('homePage');
                }, 1000);
            } else {
                showMessage(result.message, 'error');
            }
        }

        async function registerUser() {
            const name = document.getElementById('registerName').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            if (!name || !phone || !password) {
                showMessage('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error', 'registerMessage');
                return;
            }

            if (password !== passwordConfirm) {
                showMessage('å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´', 'error', 'registerMessage');
                return;
            }

            if (password.length < 6) {
                showMessage('å¯†ç¢¼è‡³å°‘éœ€è¦6ä½', 'error', 'registerMessage');
                return;
            }

            showMessage('è¨»å†Šä¸­...', 'info', 'registerMessage');

            const result = await callAPI('register', {
                name: name,
                phone: phone,
                password: password
            });

            if (result.success) {
                showMessage('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥', 'success', 'registerMessage');
                setTimeout(() => {
                    showPage('loginPage');
                }, 1500);
            } else {
                showMessage(result.message, 'error', 'registerMessage');
            }
        }

        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                sessionStorage.removeItem('currentUser');
                currentUser = null;
                
                // å¦‚æœæ˜¯é€é LINE ç™»å…¥ï¼Œä¹Ÿè¦ç™»å‡º LIFF
                if (liff.isLoggedIn()) {
                    liff.logout();
                }
                
                showPage('loginPage');
            }
        }

        // ==================== ç®¡ç†å“¡æª¢æŸ¥ ====================
        async function checkAdminAccess() {
            if (!currentUser) return;
            
            const adminCheck = await callAPI('checkAdmin', { userId: currentUser.id });
            
            if (adminCheck.success && adminCheck.isAdmin) {
                const adminEntrance = document.getElementById('adminEntrance');
                if (adminEntrance) {
                    adminEntrance.style.display = 'block';
                }
            }
        }

        // ==================== è¼‰å…¥ç”¨æˆ¶è³‡æ–™ ====================
        async function loadUserData() {
            if (!currentUser) return;

            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userType').textContent = currentUser.type || 'ä¸€èˆ¬ç¾¤çœ¾';

            // è¼‰å…¥ææ¬¾ç¸½é¡
            const donationResult = await callAPI('getDonations', { userId: currentUser.id });
            if (donationResult.success) {
                const total = donationResult.donations.reduce((sum, d) => sum + Number(d.amount), 0);
                document.getElementById('totalDonation').textContent = `NT$ ${total.toLocaleString()}`;
            }

            // è¼‰å…¥é¦–é æ´»å‹•
            const activitiesResult = await callAPI('getActivities');
            if (activitiesResult.success && activitiesResult.activities.length > 0) {
                const homeActivities = document.getElementById('homeActivities');
                const latestActivities = activitiesResult.activities.slice(0, 3);
                homeActivities.innerHTML = latestActivities.map(activity => `
                    <div class="activity-item">
                        <h4>${activity.title}</h4>
                        <p>${activity.content}</p>
                        <div class="date">ğŸ“… ${activity.date}</div>
                    </div>
                `).join('');
            } else {
                document.getElementById('homeActivities').innerHTML = '<div class="empty-state">ç›®å‰æ²’æœ‰æ´»å‹•</div>';
            }
        }

        // ==================== å€‹äººè³‡æ–™ ====================
        async function loadProfile() {
            if (!currentUser) return;

            const result = await callAPI('getUserProfile', { userId: currentUser.id });

            if (result.success) {
                const profile = result.profile;

                // åŸºæœ¬è³‡æ–™
                if (profile.basic) {
                    document.getElementById('profileName').value = profile.basic.name || '';
                    document.getElementById('profilePhone').value = profile.basic.phone || profile.basic.lineId || '';
                    document.getElementById('profileType').value = profile.basic.type || 'ä¸€èˆ¬ç¾¤çœ¾';
                    document.getElementById('profileEmail').value = profile.basic.email || '';
                    document.getElementById('profileGender').value = profile.basic.gender || '';
                    document.getElementById('profileBirthday').value = profile.basic.birthday || '';
                    document.getElementById('profileIdNumber').value = profile.basic.idNumber || '';
                    document.getElementById('profileAddress').value = profile.basic.address || '';

                    // é¡¯ç¤º/éš±è—å¸•å‹è³‡æ–™å€å¡Š
                    if (profile.basic.type === 'ç—…å‹') {
                        document.getElementById('patientInfoSection').style.display = 'block';
                    } else {
                        document.getElementById('patientInfoSection').style.display = 'none';
                    }
                }

                // æœƒå“¡è³‡æ–™
                if (profile.member) {
                    document.getElementById('membershipExpiry').value = profile.member.membershipExpiry || '';
                    document.getElementById('lastPaymentDate').value = profile.member.lastPaymentDate || '';
                    document.getElementById('nextPaymentDate').value = profile.member.nextPaymentDate || '';
                }

                // å¸•å‹è³‡æ–™
                if (profile.patient) {
                    document.getElementById('diseaseYears').value = profile.patient.diseaseYears || '';
                    document.getElementById('hospital').value = profile.patient.hospital || '';
                    document.getElementById('doctor').value = profile.patient.doctor || '';
                    document.getElementById('doctorReview').value = profile.patient.doctorReview || '';
                    document.getElementById('mainProblem').value = profile.patient.mainProblem || '';
                    document.getElementById('needHelp').value = profile.patient.needHelp || '';
                }
            }
        }

        async function updateBasicInfo() {
            const data = {
                userId: currentUser.id,
                name: document.getElementById('profileName').value,
                type: document.getElementById('profileType').value,
                email: document.getElementById('profileEmail').value,
                gender: document.getElementById('profileGender').value,
                birthday: document.getElementById('profileBirthday').value,
                idNumber: document.getElementById('profileIdNumber').value,
                address: document.getElementById('profileAddress').value
            };

            const result = await callAPI('updateUserProfile', data);

            if (result.success) {
                showMessage(result.message, 'success', 'profileMessage');
                currentUser.name = data.name;
                currentUser.type = data.type;
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // æ›´æ–°é¡¯ç¤º
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userType').textContent = currentUser.type;

                // é¡¯ç¤º/éš±è—å¸•å‹è³‡æ–™å€å¡Š
                if (data.type === 'ç—…å‹') {
                    document.getElementById('patientInfoSection').style.display = 'block';
                } else {
                    document.getElementById('patientInfoSection').style.display = 'none';
                }
            } else {
                showMessage(result.message, 'error', 'profileMessage');
            }
        }

        async function updateMemberInfo() {
            const data = {
                userId: currentUser.id,
                membershipExpiry: document.getElementById('membershipExpiry').value,
                lastPaymentDate: document.getElementById('lastPaymentDate').value,
                nextPaymentDate: document.getElementById('nextPaymentDate').value
            };

            const result = await callAPI('updateMemberInfo', data);

            if (result.success) {
                showMessage(result.message, 'success', 'profileMessage');
            } else {
                showMessage(result.message, 'error', 'profileMessage');
            }
        }

        async function updatePatientInfo() {
            const data = {
                userId: currentUser.id,
                diseaseYears: document.getElementById('diseaseYears').value,
                hospital: document.getElementById('hospital').value,
                doctor: document.getElementById('doctor').value,
                doctorReview: document.getElementById('doctorReview').value,
                mainProblem: document.getElementById('mainProblem').value,
                needHelp: document.getElementById('needHelp').value
            };

            const result = await callAPI('updatePatientInfo', data);

            if (result.success) {
                showMessage(result.message, 'success', 'profileMessage');
            } else {
                showMessage(result.message, 'error', 'profileMessage');
            }
        }

        // ==================== ææ¬¾è¨˜éŒ„ ====================
        async function addDonation() {
            const data = {
                userId: currentUser.id,
                userName: currentUser.name,
                amount: document.getElementById('donationAmount').value,
                date: document.getElementById('donationDate').value,
                receiptUrl: document.getElementById('donationReceipt').value,
                note: document.getElementById('donationNote').value
            };

            const result = await callAPI('addDonation', data);

            if (result.success) {
                alert('ææ¬¾è¨˜éŒ„æ–°å¢æˆåŠŸï¼');
                document.getElementById('donationForm').reset();
                document.getElementById('donationDate').value = new Date().toISOString().split('T')[0];
                loadDonations();
                loadUserData();
            } else {
                alert(result.message);
            }
        }

        async function loadDonations() {
            const result = await callAPI('getDonations', { userId: currentUser.id });

            const container = document.getElementById('donationList');

            if (result.success && result.donations.length > 0) {
                container.innerHTML = result.donations.map(donation => `
                    <div class="donation-item">
                        <div>
                            <div class="donation-amount">NT$ ${Number(donation.amount).toLocaleString()}</div>
                            <div class="donation-date">ğŸ“… ${donation.date}</div>
                            ${donation.note ? `<div style="color: #666; font-size: 14px; margin-top: 5px;">${donation.note}</div>` : ''}
                        </div>
                        ${donation.receiptUrl ? `<a href="${donation.receiptUrl}" target="_blank" class="btn-outline" style="padding: 8px 15px; text-decoration: none;">æŸ¥çœ‹æ”¶æ“š</a>` : ''}
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="empty-state">å°šç„¡ææ¬¾è¨˜éŒ„</div>';
            }
        }

        // ==================== æœ€æ–°æ´»å‹• ====================
        async function loadActivities() {
            const result = await callAPI('getActivities');

            const container = document.getElementById('activitiesList');

            if (result.success && result.activities.length > 0) {
                container.innerHTML = result.activities.map(activity => `
                    <div class="activity-item">
                        <h4>${activity.title}</h4>
                        <p>${activity.content}</p>
                        <div class="date">ğŸ“… ${activity.date}</div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="empty-state">ç›®å‰æ²’æœ‰æ´»å‹•</div>';
            }
        }

        // ==================== å¿—å·¥ç™»è¨˜ ====================
        async function registerVolunteer() {
            const data = {
                userId: currentUser.id,
                userName: currentUser.name,
                activity: document.getElementById('volunteerActivity').value
            };

            const result = await callAPI('registerVolunteer', data);

            if (result.success) {
                alert('å¿—å·¥ç™»è¨˜æˆåŠŸï¼æˆ‘å€‘æœƒç›¡å¿«èˆ‡æ‚¨è¯ç¹«ã€‚');
                document.getElementById('volunteerForm').reset();
                document.getElementById('volunteerName').value = currentUser.name;
            } else {
                alert(result.message);
            }
        }
    </script>
</body>
</html>
