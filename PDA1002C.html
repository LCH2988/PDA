<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âè∞ÁÅ£Â∏ïÈáëÊ£Æ‰πãÂèãÂçîÊúÉ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .page {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .user-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 10px 20px;
            width: auto;
        }

        .btn-outline {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        .btn-line {
            background: #06C755;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-line:hover {
            background: #05b34a;
            box-shadow: 0 5px 20px rgba(6, 199, 85, 0.4);
        }

        .link-btn {
            text-align: center;
            margin-top: 15px;
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
        }

        .link-btn:hover {
            color: #764ba2;
        }

        .message {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
        }

        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .nav-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }

        .nav-card .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .nav-card .title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .activity-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .activity-item h4 {
            color: #333;
            margin-bottom: 8px;
        }

        .activity-item p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .activity-item .date {
            color: #999;
            font-size: 12px;
            margin-top: 8px;
        }

        .profile-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .profile-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #666;
        }

        .info-value {
            color: #333;
        }

        .donation-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
        }

        .donation-amount {
            font-size: 20px;
            font-weight: bold;
            color: #27ae60;
        }

        .donation-date {
            color: #999;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .admin-entrance {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 15px;
            border: 2px dashed #667eea;
        }

        .admin-entrance button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .admin-entrance button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .divider {
            text-align: center;
            margin: 30px 0 20px 0;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .divider p {
            color: #999;
            margin-bottom: 15px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .page {
                padding: 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            .stats-grid, .nav-grid {
                grid-template-columns: 1fr;
            }

            .user-info {
                flex-direction: column;
            }
        }
    </style>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div class="container">
        <!-- ÁôªÂÖ•È†ÅÈù¢ -->
        <div id="loginPage" class="page active">
            <div class="header">
                <h1>üè• Âè∞ÁÅ£Â∏ïÈáëÊ£Æ‰πãÂèãÂçîÊúÉ</h1>
                <p style="color: #666;">Ê≠°ËøéÂõû‰æÜ</p>
            </div>

            <div id="loginMessage"></div>

            <form id="loginForm" onsubmit="event.preventDefault(); loginUser();">
                <div class="form-group">
                    <label>ÈõªË©±ËôüÁ¢º</label>
                    <input type="tel" id="loginPhone" placeholder="Ë´ãËº∏ÂÖ•ÈõªË©±ËôüÁ¢º" required>
                </div>

                <div class="form-group">
                    <label>ÂØÜÁ¢º</label>
                    <input type="password" id="loginPassword" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º" required>
                </div>

                <button type="submit" class="btn">ÁôªÂÖ•</button>
            </form>

            <div class="link-btn" onclick="showPage('registerPage')">
                ÈÇÑÊ≤íÊúâÂ∏≥ËôüÔºüÁ´ãÂç≥Ë®ªÂÜä
            </div>

            <div class="divider">
                <p>Êàñ‰ΩøÁî®‰ª•‰∏ãÊñπÂºèÁôªÂÖ•</p>
                <button onclick="lineLogin()" class="btn btn-line">
                    <span style="font-size: 20px;">üí¨</span>
                    ‰ΩøÁî® LINE ÁôªÂÖ•
                </button>
            </div>
        </div>

        <!-- Ë®ªÂÜäÈ†ÅÈù¢ -->
        <div id="registerPage" class="page">
            <div class="header">
                <h1>üìù Ë®ªÂÜäÊñ∞Â∏≥Ëôü</h1>
            </div>

            <div id="registerMessage"></div>

            <form id="registerForm" onsubmit="event.preventDefault(); registerUser();">
                <div class="form-group">
                    <label>ÂßìÂêç <span style="color: red;">*</span></label>
                    <input type="text" id="registerName" placeholder="Ë´ãËº∏ÂÖ•ÂßìÂêç" required>
                </div>

                <div class="form-group">
                    <label>ÈõªË©±ËôüÁ¢º <span style="color: red;">*</span></label>
                    <input type="tel" id="registerPhone" placeholder="Ë´ãËº∏ÂÖ•ÈõªË©±ËôüÁ¢º" required>
                </div>

                <div class="form-group">
                    <label>ÂØÜÁ¢º <span style="color: red;">*</span></label>
                    <input type="password" id="registerPassword" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢ºÔºàËá≥Â∞ë6‰ΩçÔºâ" required minlength="6">
                </div>

                <div class="form-group">
                    <label>Á¢∫Ë™çÂØÜÁ¢º <span style="color: red;">*</span></label>
                    <input type="password" id="registerPasswordConfirm" placeholder="Ë´ãÂÜçÊ¨°Ëº∏ÂÖ•ÂØÜÁ¢º" required>
                </div>

                <button type="submit" class="btn">Ë®ªÂÜä</button>
            </form>

            <div class="link-btn" onclick="showPage('loginPage')">
                Â∑≤ÊúâÂ∏≥ËôüÔºüÁ´ãÂç≥ÁôªÂÖ•
            </div>
        </div>

        <!-- È¶ñÈ†Å -->
        <div id="homePage" class="page">
            <div class="header">
                <h1>üè• Âè∞ÁÅ£Â∏ïÈáëÊ£Æ‰πãÂèãÂçîÊúÉ</h1>
                <div class="user-info">
                    <span id="userName">ËºâÂÖ•‰∏≠...</span>
                    <button class="btn-secondary" onclick="logout()">ÁôªÂá∫</button>
                </div>
            </div>

            <!-- ÁÆ°ÁêÜÂì°ÂÖ•Âè£ -->
            <div id="adminEntrance" class="admin-entrance" style="display: none;">
                <p style="margin-bottom: 10px; color: #667eea; font-weight: 600;">üëë ÊÇ®ÊúâÁÆ°ÁêÜÂì°Ê¨äÈôê</p>
                <button onclick="window.location.href='admin.html'">
                    üîß ÈÄ≤ÂÖ•ÁÆ°ÁêÜÂæåÂè∞
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ÊúÉÂì°Ë∫´‰ªΩ</h3>
                    <div class="number" id="userType">‰∏ÄËà¨Áæ§Áúæ</div>
                </div>
                <div class="stat-card">
                    <h3>Á¥ØË®àÊçêÊ¨æ</h3>
                    <div class="number" id="totalDonation">NT$ 0</div>
                </div>
            </div>

            <div class="nav-grid">
                <div class="nav-card" onclick="showPage('profilePage')">
                    <div class="icon">üë§</div>
                    <div class="title">ÂÄã‰∫∫Ë≥áÊñô</div>
                </div>
                <div class="nav-card" onclick="showPage('donationPage')">
                    <div class="icon">üí∞</div>
                    <div class="title">ÊçêÊ¨æË®òÈåÑ</div>
                </div>
                <div class="nav-card" onclick="showPage('activitiesPage')">
                    <div class="icon">üìÖ</div>
                    <div class="title">ÊúÄÊñ∞Ê¥ªÂãï</div>
                </div>
                <div class="nav-card" onclick="showPage('volunteerPage')">
                    <div class="icon">üôã</div>
                    <div class="title">ÂøóÂ∑•ÁôªË®ò</div>
                </div>
            </div>

            <div class="card">
                <h3>üì¢ ÊúÄÊñ∞Ê∂àÊÅØ</h3>
                <div id="homeActivities">
                    <div class="empty-state">ËºâÂÖ•‰∏≠...</div>
                </div>
            </div>
        </div>

        <!-- ÂÄã‰∫∫Ë≥áÊñôÈ†ÅÈù¢ -->
        <div id="profilePage" class="page">
            <div class="header">
                <h1>üë§ ÂÄã‰∫∫Ë≥áÊñô</h1>
                <button class="btn-secondary" onclick="showPage('homePage')">ËøîÂõûÈ¶ñÈ†Å</button>
            </div>

            <div id="profileMessage"></div>

            <!-- Âü∫Êú¨Ë≥áÊñô -->
            <div class="profile-section">
                <h3>Âü∫Êú¨Ë≥áÊñô</h3>
                <form id="basicInfoForm" onsubmit="event.preventDefault(); updateBasicInfo();">
                    <div class="form-group">
                        <label>ÂßìÂêç</label>
                        <input type="text" id="profileName" required>
                    </div>
                    <div class="form-group">
                        <label>ÈõªË©±</label>
                        <input type="tel" id="profilePhone" readonly style="background: #f0f0f0;">
                    </div>
                    <div class="form-group">
                        <label>Ë∫´‰ªΩÈ°ûÂà•</label>
                        <select id="profileType">
                            <option value="‰∏ÄËà¨Áæ§Áúæ">‰∏ÄËà¨Áæ§Áúæ</option>
                            <option value="ÁóÖÂèã">ÁóÖÂèã</option>
                            <option value="ÂÆ∂Â±¨">ÂÆ∂Â±¨</option>
                            <option value="ÈÜ´Â∏´">ÈÜ´Â∏´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="profileEmail">
                    </div>
                    <div class="form-group">
                        <label>ÊÄßÂà•</label>
                        <select id="profileGender">
                            <option value="">Ë´ãÈÅ∏Êìá</option>
                            <option value="Áî∑">Áî∑</option>
                            <option value="Â•≥">Â•≥</option>
                            <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ÁîüÊó•</label>
                        <input type="date" id="profileBirthday">
                    </div>
                    <div class="form-group">
                        <label>Ë∫´‰ªΩË≠âÂ≠óËôü</label>
                        <input type="text" id="profileIdNumber" maxlength="10">
                    </div>
                    <div class="form-group">
                        <label>Âú∞ÂùÄ</label>
                        <textarea id="profileAddress" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn">ÂÑ≤Â≠òÂü∫Êú¨Ë≥áÊñô</button>
                </form>
            </div>

            <!-- ÊúÉÂì°Ë≥áÊñô -->
            <div class="profile-section">
                <h3>ÊúÉÂì°Ë≥áÊñô</h3>
                <form id="memberInfoForm" onsubmit="event.preventDefault(); updateMemberInfo();">
                    <div class="form-group">
                        <label>ÊúÉÂì°Âà∞ÊúüÊó•</label>
                        <input type="date" id="membershipExpiry">
                    </div>
                    <div class="form-group">
                        <label>‰∏äÊ¨°Áπ≥Ë≤ªÊó•Êúü</label>
                        <input type="date" id="lastPaymentDate">
                    </div>
                    <div class="form-group">
                        <label>‰∏ãÊ¨°Áπ≥Ë≤ªÊó•Êúü</label>
                        <input type="date" id="nextPaymentDate">
                    </div>
                    <button type="submit" class="btn">ÂÑ≤Â≠òÊúÉÂì°Ë≥áÊñô</button>
                </form>
            </div>

            <!-- Â∏ïÂèãË≥áÊñô -->
            <div class="profile-section" id="patientInfoSection" style="display: none;">
                <h3>Â∏ïÂèãË≥áÊñô</h3>
                <form id="patientInfoForm" onsubmit="event.preventDefault(); updatePatientInfo();">
                    <div class="form-group">
                        <label>ÁΩπÁóÖÂπ¥Êï∏</label>
                        <input type="number" id="diseaseYears" min="0" placeholder="‰æãÂ¶ÇÔºö5">
                    </div>
                    <div class="form-group">
                        <label>Â∞±Ë®∫ÈÜ´Èô¢</label>
                        <input type="text" id="hospital" placeholder="‰æãÂ¶ÇÔºöÂè∞Â§ßÈÜ´Èô¢">
                    </div>
                    <div class="form-group">
                        <label>‰∏ªÊ≤ªÈÜ´Â∏´</label>
                        <input type="text" id="doctor" placeholder="‰æãÂ¶ÇÔºöÁéãÈÜ´Â∏´">
                    </div>
                    <div class="form-group">
                        <label>ÈÜ´Â∏´ÂõûË®∫ÊôÇÈñì</label>
                        <input type="text" id="doctorReview" placeholder="‰æãÂ¶ÇÔºöÊØèÊúàÁ¨¨‰∏ÄÈÄ±">
                    </div>
                    <div class="form-group">
                        <label>‰∏ªË¶ÅÂõ∞Êìæ</label>
                        <textarea id="mainProblem" rows="3" placeholder="Ë´ãÊèèËø∞ÊÇ®ÁõÆÂâçÈÅáÂà∞ÁöÑ‰∏ªË¶ÅÂïèÈ°å"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ÈúÄË¶ÅÂçîÂä©</label>
                        <textarea id="needHelp" rows="3" placeholder="Ë´ãÊèèËø∞ÊÇ®ÈúÄË¶ÅÁöÑÂçîÂä©"></textarea>
                    </div>
                    <button type="submit" class="btn">ÂÑ≤Â≠òÂ∏ïÂèãË≥áÊñô</button>
                </form>
            </div>
        </div>

        <!-- ÊçêÊ¨æË®òÈåÑÈ†ÅÈù¢ -->
        <div id="donationPage" class="page">
            <div class="header">
                <h1>üí∞ ÊçêÊ¨æË®òÈåÑ</h1>
                <button class="btn-secondary" onclick="showPage('homePage')">ËøîÂõûÈ¶ñÈ†Å</button>
            </div>

            <div class="card">
                <h3>Êñ∞Â¢ûÊçêÊ¨æ</h3>
                <form id="donationForm" onsubmit="event.preventDefault(); addDonation();">
                    <div class="form-group">
                        <label>ÊçêÊ¨æÈáëÈ°ç <span style="color: red;">*</span></label>
                        <input type="number" id="donationAmount" placeholder="Ë´ãËº∏ÂÖ•ÈáëÈ°ç" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>ÊçêÊ¨æÊó•Êúü <span style="color: red;">*</span></label>
                        <input type="date" id="donationDate" required>
                    </div>
                    <div class="form-group">
                        <label>Êî∂ÊìöÈÄ£Áµê</label>
                        <input type="url" id="donationReceipt" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>ÂÇôË®ª</label>
                        <textarea id="donationNote" rows="2" placeholder="ÂÖ∂‰ªñË™™Êòé"></textarea>
                    </div>
                    <button type="submit" class="btn">Êñ∞Â¢ûÊçêÊ¨æË®òÈåÑ</button>
                </form>
            </div>

            <div class="card">
                <h3>ÊàëÁöÑÊçêÊ¨æË®òÈåÑ</h3>
                <div id="donationList">
                    <div class="empty-state">ËºâÂÖ•‰∏≠...</div>
                </div>
            </div>
        </div>

        <!-- ÊúÄÊñ∞Ê¥ªÂãïÈ†ÅÈù¢ -->
        <div id="activitiesPage" class="page">
            <div class="header">
                <h1>üìÖ ÊúÄÊñ∞Ê¥ªÂãï</h1>
                <button class="btn-secondary" onclick="showPage('homePage')">ËøîÂõûÈ¶ñÈ†Å</button>
            </div>

            <div id="activitiesList">
                <div class="empty-state">ËºâÂÖ•‰∏≠...</div>
            </div>
        </div>

        <!-- ÂøóÂ∑•ÁôªË®òÈ†ÅÈù¢ -->
        <div id="volunteerPage" class="page">
            <div class="header">
                <h1>üôã ÂøóÂ∑•ÁôªË®ò</h1>
                <button class="btn-secondary" onclick="showPage('homePage')">ËøîÂõûÈ¶ñÈ†Å</button>
            </div>

            <div class="card">
                <h3>ÂøóÂ∑•ÁôªË®òË°®</h3>
                <form id="volunteerForm" onsubmit="event.preventDefault(); registerVolunteer();">
                    <div class="form-group">
                        <label>Ê¥ªÂãïÂêçÁ®± <span style="color: red;">*</span></label>
                        <input type="text" id="volunteerActivity" placeholder="Ë´ãËº∏ÂÖ•Ê¥ªÂãïÂêçÁ®±" required>
                    </div>
                    <div class="form-group">
                        <label>ÊÇ®ÁöÑÂßìÂêç</label>
                        <input type="text" id="volunteerName" readonly style="background: #f0f0f0;">
                    </div>
                    <button type="submit" class="btn">Êèê‰∫§ÁôªË®ò</button>
                </form>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 10px;">
                <p style="color: #856404; font-size: 14px;">
                    üí° ÊèêÁ§∫ÔºöÂøóÂ∑•ÁôªË®òÂæåÔºåÊàëÂÄëÊúÉÁõ°Âø´ËàáÊÇ®ËÅØÁπ´Á¢∫Ë™çÁõ∏Èóú‰∫ãÂÆú„ÄÇ
                </p>
            </div>
        </div>
    </div>

    <script>
        // ==================== ÈÖçÁΩÆ ====================
        const API_URL = 'https://script.google.com/macros/s/AKfycby6SNF8aNbxSdsLWumSlXj5n4Z1FNl_N8px3X_jGBhcdeX8iJk9Fz6gzBTkwbRnN3xA8Q/exec'; // Ë´ãÊõøÊèõÊàêÊÇ®ÁöÑ API URL
        const LIFF_ID = '1656516134-VaGgmaPm'; // Ë´ãÊõøÊèõÊàêÊÇ®ÁöÑ LIFF ID
        let currentUser = JSON.parse(sessionStorage.getItem('currentUser'));

        // ==================== ÂàùÂßãÂåñ ====================
        window.onload = function() {
            initializeLiff();
        };

        // ==================== LIFF ÂàùÂßãÂåñ ====================
        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (liff.isLoggedIn()) {
                    // Â∑≤Á∂ìÈÄèÈÅé LINE ÁôªÂÖ•
                    const profile = await liff.getProfile();
                    await handleLineLogin(profile);
                } else {
                    // Ê™¢Êü•ÊòØÂê¶Êúâ‰∏ÄËà¨ÁôªÂÖ•ÁöÑ session
                    if (currentUser) {
                        showPage('homePage');
                        loadUserData();
                        checkAdminAccess();
                    } else {
                        showPage('loginPage');
                    }
                }
            } catch (error) {
                console.error('LIFF ÂàùÂßãÂåñÂ§±Êïó:', error);
                // LIFF ÂàùÂßãÂåñÂ§±ÊïóÔºå‰ΩøÁî®‰∏ÄËà¨ÁôªÂÖ•
                if (currentUser) {
                    showPage('homePage');
                    loadUserData();
                    checkAdminAccess();
                } else {
                    showPage('loginPage');
                }
            }
        }

        // ==================== LINE ÁôªÂÖ•ËôïÁêÜ ====================
        async function handleLineLogin(profile) {
            const lineId = profile.userId;
            const displayName = profile.displayName;
            const pictureUrl = profile.pictureUrl;

            // ÂëºÂè´ÂæåÁ´Ø API Ê™¢Êü•ÊàñÂª∫Á´ãÁî®Êà∂
            const result = await callAPI('lineLogin', {
                lineId: lineId,
                displayName: displayName,
                pictureUrl: pictureUrl
            });

            if (result.success) {
                currentUser = result.user;
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÁÆ°ÁêÜÂì°
                const adminCheck = await callAPI('checkAdmin', { userId: currentUser.id });
                
                if (adminCheck.success && adminCheck.isAdmin) {
                    if (confirm('ÊÇ®ÊúâÁÆ°ÁêÜÂì°Ê¨äÈôêÔºåÊòØÂê¶Ë¶ÅÈÄ≤ÂÖ•ÁÆ°ÁêÜÂæåÂè∞Ôºü\n\nÈªûÈÅ∏„ÄåÁ¢∫ÂÆö„ÄçÈÄ≤ÂÖ•ÁÆ°ÁêÜÂæåÂè∞\nÈªûÈÅ∏„ÄåÂèñÊ∂à„Äç‰ΩøÁî®‰∏ÄËà¨ÂäüËÉΩ')) {
                        window.location.href = 'admin.html';
                        return;
                    }
                }
                
                showPage('homePage');
                loadUserData();
                checkAdminAccess();
            } else {
                alert('LINE ÁôªÂÖ•Â§±ÊïóÔºö' + result.message);
                liff.logout();
                showPage('loginPage');
            }
        }

        function lineLogin() {
            if (!liff.isLoggedIn()) {
                liff.login();
            }
        }

        // ==================== API ÂëºÂè´ ====================
        async function callAPI(action, data = {}) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: action, data: data })
                });
                const text = await response.text();
                return JSON.parse(text);
            } catch (error) {
                console.error('API ÈåØË™§:', error);
                return { success: false, message: 'Á∂≤Ë∑ØÈÄ£Á∑öÈåØË™§' };
            }
        }

        // ==================== È†ÅÈù¢ÂàáÊèõ ====================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            // ËºâÂÖ•Â∞çÊáâÈ†ÅÈù¢Ë≥áÊñô
            if (pageId === 'homePage') {
                loadUserData();
                loadActivities();
            } else if (pageId === 'profilePage') {
                loadProfile();
            } else if (pageId === 'donationPage') {
                loadDonations();
                document.getElementById('donationDate').value = new Date().toISOString().split('T')[0];
            } else if (pageId === 'activitiesPage') {
                loadActivities();
            } else if (pageId === 'volunteerPage') {
                document.getElementById('volunteerName').value = currentUser.name;
            }
        }

        // ==================== Ë®äÊÅØÈ°ØÁ§∫ ====================
        function showMessage(message, type = 'info', elementId = 'loginMessage') {
            const messageDiv = document.getElementById(elementId);
            messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        }

        // ==================== ÁôªÂÖ•Ë®ªÂÜä ====================
        async function loginUser() {
            const phone = document.getElementById('loginPhone').value;
            const password = document.getElementById('loginPassword').value;

            if (!phone || !password) {
                showMessage('Ë´ãËº∏ÂÖ•ÈõªË©±ËôüÁ¢ºÂíåÂØÜÁ¢º', 'error');
                return;
            }

            showMessage('ÁôªÂÖ•‰∏≠...', 'info');

            const result = await callAPI('login', { phone: phone, password: password });

            if (result.success) {
                currentUser = result.user;
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÁÆ°ÁêÜÂì°
                const adminCheck = await callAPI('checkAdmin', { userId: currentUser.id });
                
                if (adminCheck.success && adminCheck.isAdmin) {
                    if (confirm('ÊÇ®ÊúâÁÆ°ÁêÜÂì°Ê¨äÈôêÔºåÊòØÂê¶Ë¶ÅÈÄ≤ÂÖ•ÁÆ°ÁêÜÂæåÂè∞Ôºü\n\nÈªûÈÅ∏„ÄåÁ¢∫ÂÆö„ÄçÈÄ≤ÂÖ•ÁÆ°ÁêÜÂæåÂè∞\nÈªûÈÅ∏„ÄåÂèñÊ∂à„Äç‰ΩøÁî®‰∏ÄËà¨ÂäüËÉΩ')) {
                        window.location.href = 'admin.html';
                        return;
                    }
                }
                
                showMessage('ÁôªÂÖ•ÊàêÂäüÔºÅ', 'success');
                setTimeout(() => {
                    showPage('homePage');
                }, 1000);
            } else {
                showMessage(result.message, 'error');
            }
        }

        async function registerUser() {
            const name = document.getElementById('registerName').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            if (!name || !phone || !password) {
                showMessage('Ë´ãÂ°´ÂØ´ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰Ωç', 'error', 'registerMessage');
                return;
            }

            if (password !== passwordConfirm) {
                showMessage('ÂÖ©Ê¨°ÂØÜÁ¢ºËº∏ÂÖ•‰∏ç‰∏ÄËá¥', 'error', 'registerMessage');
                return;
            }

            if (password.length < 6) {
                showMessage('ÂØÜÁ¢ºËá≥Â∞ëÈúÄË¶Å6‰Ωç', 'error', 'registerMessage');
                return;
            }

            showMessage('Ë®ªÂÜä‰∏≠...', 'info', 'registerMessage');

            const result = await callAPI('register', {
                name: name,
                phone: phone,
                password: password
            });

            if (result.success) {
                showMessage('Ë®ªÂÜäÊàêÂäüÔºÅË´ãÁôªÂÖ•', 'success', 'registerMessage');
                setTimeout(() => {
                    showPage('loginPage');
                }, 1500);
            } else {
                showMessage(result.message, 'error', 'registerMessage');
            }
        }

        function logout() {
            if (confirm('Á¢∫ÂÆöË¶ÅÁôªÂá∫ÂóéÔºü')) {
                sessionStorage.removeItem('currentUser');
                currentUser = null;
                
                // Â¶ÇÊûúÊòØÈÄèÈÅé LINE ÁôªÂÖ•Ôºå‰πüË¶ÅÁôªÂá∫ LIFF
                if (liff.isLoggedIn()) {
                    liff.logout();
                }
                
                showPage('loginPage');
            }
        }

        // ==================== ÁÆ°ÁêÜÂì°Ê™¢Êü• ====================
        async function checkAdminAccess() {
            if (!currentUser) return;
            
            const adminCheck = await callAPI('checkAdmin', { userId: currentUser.id });
            
            if (adminCheck.success && adminCheck.isAdmin) {
                const adminEntrance = document.getElementById('adminEntrance');
                if (adminEntrance) {
                    adminEntrance.style.display = 'block';
                }
            }
        }

        // ==================== ËºâÂÖ•Áî®Êà∂Ë≥áÊñô ====================
        async function loadUserData() {
            if (!currentUser) return;

            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userType').textContent = currentUser.type || '‰∏ÄËà¨Áæ§Áúæ';

            // ËºâÂÖ•ÊçêÊ¨æÁ∏ΩÈ°ç
            const donationResult = await callAPI('getDonations', { userId: currentUser.id });
            if (donationResult.success) {
                const total = donationResult.donations.reduce((sum, d) => sum + Number(d.amount), 0);
                document.getElementById('totalDonation').textContent = `NT$ ${total.toLocaleString()}`;
            }

            // ËºâÂÖ•È¶ñÈ†ÅÊ¥ªÂãï
            const activitiesResult = await callAPI('getActivities');
            if (activitiesResult.success && activitiesResult.activities.length > 0) {
                const homeActivities = document.getElementById('homeActivities');
                const latestActivities = activitiesResult.activities.slice(0, 3);
                homeActivities.innerHTML = latestActivities.map(activity => `
                    <div class="activity-item">
                        <h4>${activity.title}</h4>
                        <p>${activity.content}</p>
                        <div class="date">üìÖ ${activity.date}</div>
                    </div>
                `).join('');
            } else {
                document.getElementById('homeActivities').innerHTML = '<div class="empty-state">ÁõÆÂâçÊ≤íÊúâÊ¥ªÂãï</div>';
            }
        }

        // ==================== ÂÄã‰∫∫Ë≥áÊñô ====================
        async function loadProfile() {
            if (!currentUser) return;

            const result = await callAPI('getUserProfile', { userId: currentUser.id });

            if (result.success) {
                const profile = result.profile;

                // Âü∫Êú¨Ë≥áÊñô
                if (profile.basic) {
                    document.getElementById('profileName').value = profile.basic.name || '';
                    document.getElementById('profilePhone').value = profile.basic.phone || profile.basic.lineId || '';
                    document.getElementById('profileType').value = profile.basic.type || '‰∏ÄËà¨Áæ§Áúæ';
                    document.getElementById('profileEmail').value = profile.basic.email || '';
                    document.getElementById('profileGender').value = profile.basic.gender || '';
                    document.getElementById('profileBirthday').value = profile.basic.birthday || '';
                    document.getElementById('profileIdNumber').value = profile.basic.idNumber || '';
                    document.getElementById('profileAddress').value = profile.basic.address || '';

                    // È°ØÁ§∫/Èö±ËóèÂ∏ïÂèãË≥áÊñôÂçÄÂ°ä
                    if (profile.basic.type === 'ÁóÖÂèã') {
                        document.getElementById('patientInfoSection').style.display = 'block';
                    } else {
                        document.getElementById('patientInfoSection').style.display = 'none';
                    }
                }

                // ÊúÉÂì°Ë≥áÊñô
                if (profile.member) {
                    document.getElementById('membershipExpiry').value = profile.member.membershipExpiry || '';
                    document.getElementById('lastPaymentDate').value = profile.member.lastPaymentDate || '';
                    document.getElementById('nextPaymentDate').value = profile.member.nextPaymentDate || '';
                }

                // Â∏ïÂèãË≥áÊñô
                if (profile.patient) {
                    document.getElementById('diseaseYears').value = profile.patient.diseaseYears || '';
                    document.getElementById('hospital').value = profile.patient.hospital || '';
                    document.getElementById('doctor').value = profile.patient.doctor || '';
                    document.getElementById('doctorReview').value = profile.patient.doctorReview || '';
                    document.getElementById('mainProblem').value = profile.patient.mainProblem || '';
                    document.getElementById('needHelp').value = profile.patient.needHelp || '';
                }
            }
        }

        async function updateBasicInfo() {
            const data = {
                userId: currentUser.id,
                name: document.getElementById('profileName').value,
                type: document.getElementById('profileType').value,
                email: document.getElementById('profileEmail').value,
                gender: document.getElementById('profileGender').value,
                birthday: document.getElementById('profileBirthday').value,
                idNumber: document.getElementById('profileIdNumber').value,
                address: document.getElementById('profileAddress').value
            };

            const result = await callAPI('updateUserProfile', data);

            if (result.success) {
                showMessage(result.message, 'success', 'profileMessage');
                currentUser.name = data.name;
                currentUser.type = data.type;
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Êõ¥Êñ∞È°ØÁ§∫
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userType').textContent = currentUser.type;

                // È°ØÁ§∫/Èö±ËóèÂ∏ïÂèãË≥áÊñôÂçÄÂ°ä
                if (data.type === 'ÁóÖÂèã') {
                    document.getElementById('patientInfoSection').style.display = 'block';
                } else {
                    document.getElementById('patientInfoSection').style.display = 'none';
                }
            } else {
                showMessage(result.message, 'error', 'profileMessage');
            }
        }

        async function updateMemberInfo() {
            const data = {
                userId: currentUser.id,
                membershipExpiry: document.getElementById('membershipExpiry').value,
                lastPaymentDate: document.getElementById('lastPaymentDate').value,
                nextPaymentDate: document.getElementById('nextPaymentDate').value
            };

            const result = await callAPI('updateMemberInfo', data);

            if (result.success) {
                showMessage(result.message, 'success', 'profileMessage');
            } else {
                showMessage(result.message, 'error', 'profileMessage');
            }
        }

        async function updatePatientInfo() {
            const data = {
                userId: currentUser.id,
                diseaseYears: document.getElementById('diseaseYears').value,
                hospital: document.getElementById('hospital').value,
                doctor: document.getElementById('doctor').value,
                doctorReview: document.getElementById('doctorReview').value,
                mainProblem: document.getElementById('mainProblem').value,
                needHelp: document.getElementById('needHelp').value
            };

            const result = await callAPI('updatePatientInfo', data);

            if (result.success) {
                showMessage(result.message, 'success', 'profileMessage');
            } else {
                showMessage(result.message, 'error', 'profileMessage');
            }
        }

        // ==================== ÊçêÊ¨æË®òÈåÑ ====================
        async function addDonation() {
            const data = {
                userId: currentUser.id,
                userName: currentUser.name,
                amount: document.getElementById('donationAmount').value,
                date: document.getElementById('donationDate').value,
                receiptUrl: document.getElementById('donationReceipt').value,
                note: document.getElementById('donationNote').value
            };

            const result = await callAPI('addDonation', data);

            if (result.success) {
                alert('ÊçêÊ¨æË®òÈåÑÊñ∞Â¢ûÊàêÂäüÔºÅ');
                document.getElementById('donationForm').reset();
                document.getElementById('donationDate').value = new Date().toISOString().split('T')[0];
                loadDonations();
                loadUserData();
            } else {
                alert(result.message);
            }
        }

        async function loadDonations() {
            const result = await callAPI('getDonations', { userId: currentUser.id });

            const container = document.getElementById('donationList');

            if (result.success && result.donations.length > 0) {
                container.innerHTML = result.donations.map(donation => `
                    <div class="donation-item">
                        <div>
                            <div class="donation-amount">NT$ ${Number(donation.amount).toLocaleString()}</div>
                            <div class="donation-date">üìÖ ${donation.date}</div>
                            ${donation.note ? `<div style="color: #666; font-size: 14px; margin-top: 5px;">${donation.note}</div>` : ''}
                        </div>
                        ${donation.receiptUrl ? `<a href="${donation.receiptUrl}" target="_blank" class="btn-outline" style="padding: 8px 15px; text-decoration: none;">Êü•ÁúãÊî∂Êìö</a>` : ''}
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="empty-state">Â∞öÁÑ°ÊçêÊ¨æË®òÈåÑ</div>';
            }
        }

        // ==================== ÊúÄÊñ∞Ê¥ªÂãï ====================
        async function loadActivities() {
            const result = await callAPI('getActivities');

            const container = document.getElementById('activitiesList');

            if (result.success && result.activities.length > 0) {
                container.innerHTML = result.activities.map(activity => `
                    <div class="activity-item">
                        <h4>${activity.title}</h4>
                        <p>${activity.content}</p>
                        <div class="date">üìÖ ${activity.date}</div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="empty-state">ÁõÆÂâçÊ≤íÊúâÊ¥ªÂãï</div>';
            }
        }

        // ==================== ÂøóÂ∑•ÁôªË®ò ====================
        async function registerVolunteer() {
            const data = {
                userId: currentUser.id,
                userName: currentUser.name,
                activity: document.getElementById('volunteerActivity').value
            };

            const result = await callAPI('registerVolunteer', data);

            if (result.success) {
                alert('ÂøóÂ∑•ÁôªË®òÊàêÂäüÔºÅÊàëÂÄëÊúÉÁõ°Âø´ËàáÊÇ®ËÅØÁπ´„ÄÇ');
                document.getElementById('volunteerForm').reset();
                document.getElementById('volunteerName').value = currentUser.name;
            } else {
                alert(result.message);
            }
        }
    </script>
</body>
</html>
