# =========================================
# 前端：index.html (LIFF)
# 請使用實際部署後的 GAS Web App URL 取代 API_BASE_URL
# =========================================
<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>三鐵飛翔好運動協會 - 活動系統</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
body {
  background: linear-gradient(135deg,#06C755,#00B900);
  font-family: 'Microsoft JhengHei', sans-serif;
  min-height: 100vh;
  padding-top: 60px;
}
.navbar { background: rgba(255,255,255,0.95)!important; backdrop-filter: blur(10px); }
.hero-section {
  background: linear-gradient(rgba(0,0,0,.4),rgba(0,0,0,.4)),
              linear-gradient(135deg,#06C755,#00B900);
  color:#fff; padding:60px 0; text-align:center; border-radius:15px; margin-bottom:30px;
}
.activity-card { background:#fff; border-radius:15px; overflow:hidden; box-shadow:0 5px 15px rgba(0,0,0,.1); margin-bottom:20px; cursor:pointer; transition:.3s; }
.activity-card:hover { transform:translateY(-3px); box-shadow:0 10px 25px rgba(0,0,0,.15); }
.activity-image { height:150px; background:linear-gradient(45deg,#06C755,#00B900); color:#fff; display:flex; align-items:center; justify-content:center; font-size:2.5rem; }
.sport-badge { padding:6px 12px; border-radius:20px; font-size:.8rem; font-weight:500; }
.sport-badge.登山組 { background:#8b5a3c; color:#fff; }
.sport-badge.單車組 { background:#059669; color:#fff; }
.sport-badge.跑步組 { background:#dc2626; color:#fff; }
.sport-badge.水上組 { background:#0ea5e9; color:#fff; }
.payment-status { padding:4px 8px; border-radius:12px; font-size:.75rem; font-weight:bold; }
.payment-status.paid { background:#dcfce7; color:#166534; }
.payment-status.unpaid { background:#fee2e2; color:#991b1b; }
.user-profile { background:rgba(255,255,255,0.1); color:#fff; padding:15px; border-radius:10px; display:flex; align-items:center; }
.user-avatar { width:50px; height:50px; border-radius:50%; margin-right:15px; }
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top">
  <div class="container">
    <a class="navbar-brand fw-bold text-success" href="#" onclick="showHome()">三鐵飛翔好運動協會</a>
    <div class="ms-auto">
      <span id="currentUserName" class="fw-bold text-success"></span>
    </div>
  </div>
</nav>

<div class="container">
  <div id="homeSection">
    <div class="hero-section">
      <h1 class="display-5 fw-bold">挑戰極限，飛翔夢想</h1>
      <p class="lead">一站式活動報名與管理</p>
      <div class="d-flex justify-content-center gap-3 flex-wrap">
        <button class="btn btn-light btn-lg" onclick="showActivities()">查看活動</button>
        <button class="btn btn-outline-light btn-lg" onclick="showMyRegistrations()">我的報名</button>
        <button class="btn btn-outline-light btn-lg" onclick="showProfile()">會員資料</button>
      </div>
    </div>
    <div id="userProfile" class="user-profile d-none">
      <img id="userAvatar" class="user-avatar" src="">
      <div>
        <h6 class="mb-1">歡迎，<span id="displayName"></span></h6>
        <small id="memberInfo"></small>
      </div>
    </div>
    <h4 class="text-white mt-4">最新活動</h4>
    <div class="row" id="latestActivities">
      <div class="col-12 text-center text-white">載入中...</div>
    </div>
  </div>

  <div id="activitiesSection" class="d-none">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="text-white">活動查詢</h3>
      <button class="btn btn-outline-light" onclick="showHome()">返回</button>
    </div>
    <div class="card mb-3">
      <div class="card-body row g-2">
        <div class="col-md-4">
          <input id="activitySearch" onkeyup="searchActivities()" class="form-control" placeholder="搜尋活動名稱或地點">
        </div>
        <div class="col-md-4">
          <select id="sportFilter" class="form-select" onchange="filterActivities()">
            <option value="">所有類別</option>
            <option value="登山組">登山組</option>
            <option value="單車組">單車組</option>
            <option value="跑步組">跑步組</option>
            <option value="水上組">水上組</option>
          </select>
        </div>
        <div class="col-md-4">
          <select id="statusFilter" class="form-select" onchange="filterActivities()">
            <option value="">全部狀態</option>
            <option value="報名中">報名中</option>
            <option value="已額滿">已額滿</option>
            <option value="已結束">已結束</option>
          </select>
        </div>
      </div>
    </div>
    <div class="row" id="activitiesGrid"></div>
  </div>

  <div id="myRegistrationsSection" class="d-none">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="text-white">我的報名</h3>
      <button class="btn btn-outline-light" onclick="showHome()">返回</button>
    </div>
    <div id="registrationsContent" class="mb-5 text-white">載入中...</div>
  </div>

  <div id="profileSection" class="d-none">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="text-white">會員資料</h3>
      <button class="btn btn-outline-light" onclick="showHome()">返回</button>
    </div>
    <div class="card">
      <div class="card-body">
        <form>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">姓名 *</label>
              <input id="memberName" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">電話 *</label>
              <input id="memberPhone" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">電子郵件</label>
              <input id="memberEmail" class="form-control" type="email">
            </div>
            <div class="col-md-6">
              <label class="form-label">生日</label>
              <input id="memberBirthDate" class="form-control" type="date">
            </div>
            <div class="col-md-6">
              <label class="form-label">性別</label>
              <select id="memberGender" class="form-select">
                <option value="">請選擇</option><option>男</option><option>女</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">會員編號</label>
              <input id="memberNumber" class="form-control" readonly>
            </div>
            <div class="col-12">
              <label class="form-label">地址</label>
              <input id="memberAddress" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">緊急聯絡人</label>
              <input id="emergencyContact" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">緊急聯絡人電話</label>
              <input id="emergencyPhone" class="form-control">
            </div>
          </div>
          <div class="text-end mt-3">
            <button type="button" class="btn btn-success" onclick="saveProfile()">儲存</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- 活動詳情 Modal -->
<div class="modal fade" id="activityDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="activityDetailTitle"></h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="activityDetailBody">載入中...</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
        <button class="btn btn-success" id="registerActivityBtn" onclick="registerForActivity()">立即報名</button>
      </div>
    </div>
  </div>
</div>

<!-- 繳費 Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">活動繳費</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <label class="form-label">活動</label>
        <input id="paymentActivityName" class="form-control mb-2" readonly>
        <label class="form-label">金額</label>
        <input id="paymentAmount" class="form-control mb-2" readonly>
        <label class="form-label">繳費方式 *</label>
        <select id="paymentMethod" class="form-select">
          <option value="">請選擇</option>
          <option>LINE Pay</option>
          <option>信用卡</option>
          <option>銀行轉帳</option>
          <option>現金</option>
        </select>
        <input type="hidden" id="paymentRegistrationId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button class="btn btn-success" onclick="processPayment()">確認繳費</button>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwugaFQ7oW8Gbj1k-CmXP8ESGBS57EvC_0oJNJLg4hQ4Hq2TFEoixh4vo72AlUKDi13/exec';
const LIFF_ID = '1656516134-VaGgmaPm';

let liffProfile = null;
let currentUser = null;
let activities = [];
let registrations = [];
let currentActivityId = null;

document.addEventListener('DOMContentLoaded', initLiff);

async function initLiff() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    liffProfile = await liff.getProfile();
    document.getElementById('currentUserName').textContent = liffProfile.displayName;
    await loadUserData();
    updateUserUI();
    loadLatestActivities();
    const urlParams = new URLSearchParams(location.search);
    const page = urlParams.get('page');
    if (page === 'activities') showActivities();
    else if (page === 'registrations') showMyRegistrations();
    else if (page === 'profile') showProfile();
  } catch (err) {
    toast('error','LIFF 初始化失敗');
    console.error(err);
  }
}

async function loadUserData() {
  try {
    const res = await fetch(`${API_BASE_URL}?path=user&lineUserId=${encodeURIComponent(liffProfile.userId)}`);
    const data = await res.json();
    if (!data.error) currentUser = data;
    else currentUser = {
      lineUserId: liffProfile.userId,
      displayName: liffProfile.displayName,
      pictureUrl: liffProfile.pictureUrl
    };
  } catch(e) {
    console.error(e);
  }
}

function updateUserUI() {
  if (liffProfile.pictureUrl) {
    document.getElementById('userAvatar').src = liffProfile.pictureUrl;
    document.getElementById('userProfile').classList.remove('d-none');
  }
  document.getElementById('displayName').textContent = liffProfile.displayName;
  if (currentUser && currentUser.memberInfo && currentUser.memberInfo.memberNumber) {
    document.getElementById('memberInfo').textContent = '會員編號：' + currentUser.memberInfo.memberNumber;
  } else {
    document.getElementById('memberInfo').textContent = '尚未完成會員資料';
  }
}

async function loadLatestActivities() {
  const container = document.getElementById('latestActivities');
  container.innerHTML = '<div class="col-12 text-center text-white">載入中...</div>';
  try {
    const res = await fetch(`${API_BASE_URL}?path=activities&limit=3&status=${encodeURIComponent('報名中')}`);
    const data = await res.json();
    if (data.activities && data.activities.length) {
      container.innerHTML = data.activities.map(a => renderActivityCard(a,true)).join('');
    } else {
      container.innerHTML = '<div class="col-12 text-center text-white">目前無活動</div>';
    }
  } catch (e) {
    container.innerHTML = '<div class="col-12 text-white">載入失敗</div>';
  }
}

function renderActivityCard(a, colMode) {
  return `
    <div class="${colMode ? 'col-md-4' : 'col-md-6 col-lg-4'}">
      <div class="activity-card" onclick="showActivityDetail('${a.id}')">
        <div class="activity-image"><i class="bi ${getSportIcon(a.sport)}"></i></div>
        <div class="card-body">
          <h6 class="card-title">${a.name}</h6>
          <p class="text-muted small">${(a.description||'').slice(0,50)}${a.description && a.description.length>50?'...':''}</p>
          <div class="d-flex justify-content-between align-items-center mb-1">
            <small><i class="bi bi-calendar"></i> ${formatDate(a.date)}</small>
            <small class="text-primary fw-bold">$${a.fee}</small>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="sport-badge ${a.sport}">${a.sport}</span>
            <small><i class="bi bi-people"></i> ${a.registrationCount||0}/${a.maxParticipants}</small>
          </div>
        </div>
      </div>
    </div>
  `;
}

async function showActivities() {
  hideAll();
  document.getElementById('activitiesSection').classList.remove('d-none');
  await loadActivities();
}

async function loadActivities() {
  const grid = document.getElementById('activitiesGrid');
  grid.innerHTML = '<div class="col-12 text-center text-white">載入中...</div>';
  try {
    const res = await fetch(`${API_BASE_URL}?path=activities`);
    const data = await res.json();
    activities = data.activities || [];
    displayActivities(activities);
  } catch(e) {
    grid.innerHTML = '<div class="col-12 text-white">載入失敗</div>';
  }
}

function displayActivities(arr) {
  const grid = document.getElementById('activitiesGrid');
  if (!arr.length) {
    grid.innerHTML = '<div class="col-12 text-center text-white">沒有符合條件的活動</div>';
    return;
  }
  grid.innerHTML = arr.map(a=>renderActivityCard(a,false)).join('');
}

function searchActivities() {
  const kw = document.getElementById('activitySearch').value.toLowerCase();
  const filtered = activities.filter(a => a.name.toLowerCase().includes(kw) || (a.location||'').toLowerCase().includes(kw));
  displayActivities(filtered);
}

function filterActivities() {
  const sport = document.getElementById('sportFilter').value;
  const status = document.getElementById('statusFilter').value;
  let filtered = activities;
  if (sport) filtered = filtered.filter(a=>a.sport===sport);
  if (status) filtered = filtered.filter(a=>a.status===status);
  displayActivities(filtered);
}

async function showActivityDetail(id) {
  currentActivityId = id;
  document.getElementById('activityDetailTitle').textContent = '載入中...';
  document.getElementById('activityDetailBody').innerHTML = '載入中...';
  const modal = new bootstrap.Modal(document.getElementById('activityDetailModal'));
  modal.show();
  try {
    const res = await fetch(`${API_BASE_URL}?path=activity&id=${encodeURIComponent(id)}`);
    const a = await res.json();
    if (a.error) {
      document.getElementById('activityDetailBody').textContent = a.error;
      return;
    }
    document.getElementById('activityDetailTitle').textContent = a.name;
    const canRegister = a.status === '報名中' && new Date(a.registrationDeadline) > new Date() && (a.registrationCount||0) < a.maxParticipants;
    document.getElementById('registerActivityBtn').style.display = canRegister ? 'inline-block' : 'none';
    document.getElementById('activityDetailBody').innerHTML = `
      <div class="row">
        <div class="col-md-8">
          <table class="table table-sm">
            <tr><th>日期</th><td>${formatDate(a.date)}</td></tr>
            <tr><th>報名截止</th><td>${formatDate(a.registrationDeadline)}</td></tr>
            <tr><th>類別</th><td><span class="sport-badge ${a.sport}">${a.sport}</span></td></tr>
            <tr><th>地點</th><td>${a.location||'待定'}</td></tr>
            <tr><th>集合時間</th><td>${a.meetingTime||'待定'}</td></tr>
            <tr><th>集合地點</th><td>${a.meetingPlace||'待定'}</td></tr>
            <tr><th>費用</th><td class="text-primary fw-bold">$${a.fee}</td></tr>
            <tr><th>人數</th><td>${a.registrationCount||0}/${a.maxParticipants}</td></tr>
          </table>
          ${a.description ? `<p>${a.description}</p>`:''}
        </div>
        <div class="col-md-4">
          <div class="card bg-light">
            <div class="card-body text-center">
              <h6>報名狀況</h6>
              <div class="progress mb-2">
                <div class="progress-bar bg-success" style="width:${((a.registrationCount||0)/a.maxParticipants)*100}%"></div>
              </div>
              <small>${a.registrationCount||0} / ${a.maxParticipants} 人</small>
            </div>
          </div>
        </div>
      </div>
    `;
  } catch (e) {
    document.getElementById('activityDetailBody').textContent = '載入失敗';
  }
}

async function registerForActivity() {
  if (!currentUser || !currentUser.memberInfo || !currentUser.memberInfo.name) {
    toast('warning','請先完成會員資料');
    showProfile();
    bootstrap.Modal.getInstance(document.getElementById('activityDetailModal')).hide();
    return;
  }
  if (!currentActivityId) return;
  const confirm = await Swal.fire({ title:'確認報名?', icon:'question', showCancelButton:true, confirmButtonText:'確認' });
  if (!confirm.isConfirmed) return;
  try {
    const res = await fetch(`${API_BASE_URL}?path=register`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        activityId: currentActivityId,
        lineUserId: liffProfile.userId,
        memberName: currentUser.memberInfo.name
      })
    });
    const data = await res.json();
    if (data.success) {
      toast('success','報名成功');
      bootstrap.Modal.getInstance(document.getElementById('activityDetailModal')).hide();
    } else {
      toast('error', data.error || '報名失敗');
    }
  } catch(e) {
    toast('error','報名失敗');
  }
}

async function showMyRegistrations() {
  hideAll();
  document.getElementById('myRegistrationsSection').classList.remove('d-none');
  loadMyRegistrations();
}

async function loadMyRegistrations() {
  const container = document.getElementById('registrationsContent');
  container.textContent = '載入中...';
  try {
    const res = await fetch(`${API_BASE_URL}?path=registrations&lineUserId=${encodeURIComponent(liffProfile.userId)}`);
    const data = await res.json();
    if (data.error) {
      container.textContent = data.error;
      return;
    }
    registrations = data.registrations || [];
    if (!registrations.length) {
      container.innerHTML = `<div class="card"><div class="card-body text-center">
        <i class="bi bi-calendar-x display-4 text-muted"></i>
        <p class="mt-2 text-muted">尚無報名</p>
        <button class="btn btn-success" onclick="showActivities()">前往活動</button>
      </div></div>`;
      return;
    }
    container.innerHTML = registrations.map(r=>{
      const a = r.activity;
      return `
        <div class="card mb-3">
          <div class="card-body row">
            <div class="col-md-8">
              <h6 class="mb-1">${a.name} ${a.isMajorEvent?' <span class="badge bg-warning text-dark">重點</span>':''}</h6>
              <small class="text-muted">
                <i class="bi bi-calendar"></i> ${formatDate(a.date)} |
                地點：${a.location||'待定'}<br>
                報名日期：${formatDate(r.registrationDate)} | 費用：<span class="text-primary fw-bold">$${a.fee}</span>
              </small>
            </div>
            <div class="col-md-4 text-end">
              <div class="payment-status ${r.paymentStatus}">${r.paymentStatus==='paid'?'已繳費':'未繳費'}</div>
              <div class="btn-group btn-group-sm mt-2">
                ${r.paymentStatus==='unpaid'
                  ? `<button class="btn btn-outline-success" onclick="openPayment('${r.id}','${a.name}',${a.fee})">繳費</button>`
                  : ''
                }
                <button class="btn btn-outline-primary" onclick="showActivityDetail('${a.id}')">詳情</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  } catch(e) {
    container.textContent = '載入失敗';
  }
}

function openPayment(regId, name, fee) {
  document.getElementById('paymentRegistrationId').value = regId;
  document.getElementById('paymentActivityName').value = name;
  document.getElementById('paymentAmount').value = '$'+fee;
  document.getElementById('paymentMethod').value = '';
  new bootstrap.Modal(document.getElementById('paymentModal')).show();
}

async function processPayment() {
  const regId = document.getElementById('paymentRegistrationId').value;
  const method = document.getElementById('paymentMethod').value;
  if (!method) {
    toast('warning','請選擇繳費方式');
    return;
  }
  try {
    const res = await fetch(`${API_BASE_URL}?path=payment`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        registrationId: regId,
        paymentMethod: method,
        lineUserId: liffProfile.userId
      })
    });
    const data = await res.json();
    if (data.success) {
      toast('success','繳費完成');
      bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
      loadMyRegistrations();
    } else {
      toast('error', data.error || '繳費失敗');
    }
  } catch(e) {
    toast('error','繳費失敗');
  }
}

function showProfile() {
  hideAll();
  document.getElementById('profileSection').classList.remove('d-none');
  loadProfileForm();
}

function loadProfileForm() {
  if (!currentUser || !currentUser.memberInfo) return;
  const i = currentUser.memberInfo;
  setVal('memberName', i.name);
  setVal('memberPhone', i.phone);
  setVal('memberEmail', i.email);
  setVal('memberBirthDate', i.birthDate ? i.birthDate.split('T')[0] : '');
  setVal('memberGender', i.gender);
  setVal('memberAddress', i.address);
  setVal('emergencyContact', i.emergencyContact);
  setVal('emergencyPhone', i.emergencyPhone);
  setVal('memberNumber', i.memberNumber||'系統自動產生');
}

async function saveProfile() {
  const memberInfo = {
    name: getVal('memberName'),
    phone: getVal('memberPhone'),
    email: getVal('memberEmail'),
    birthDate: getVal('memberBirthDate'),
    gender: getVal('memberGender'),
    address: getVal('memberAddress'),
    emergencyContact: getVal('emergencyContact'),
    emergencyPhone: getVal('emergencyPhone')
  };
  if (!memberInfo.name || !memberInfo.phone) {
    toast('warning','姓名與電話必填');
    return;
  }
  try {
    const res = await fetch(`${API_BASE_URL}?path=user`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        lineUserId: liffProfile.userId,
        memberInfo
      })
    });
    const data = await res.json();
    if (!data.error) {
      currentUser = data;
      updateUserUI();
      toast('success','已儲存');
    } else {
      toast('error', data.error || '更新失敗');
    }
  } catch(e) {
    toast('error','儲存失敗');
  }
}

function hideAll() {
  ['homeSection','activitiesSection','myRegistrationsSection','profileSection']
    .forEach(id=>document.getElementById(id).classList.add('d-none'));
}

function showHome() {
  hideAll();
  document.getElementById('homeSection').classList.remove('d-none');
}

function getSportIcon(sport) {
  return {
    '登山組':'bi-mountain',
    '單車組':'bi-bicycle',
    '跑步組':'bi-person-walking',
    '水上組':'bi-water'
  }[sport] || 'bi-flag';
}

function formatDate(d) {
  const date = new Date(d);
  if (isNaN(date)) return d;
  return date.toLocaleDateString('zh-TW');
}

function toast(type,msg) {
  Swal.fire({ toast:true, position:'top-end', icon:type, title:msg, showConfirmButton:false, timer:2500 });
}

function setVal(id,val){ document.getElementById(id).value = val || ''; }
function getVal(id){ return document.getElementById(id).value.trim(); }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
