<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>三鐵飛翔好運動協會</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  body {
    background: linear-gradient(135deg, #06C755 0%, #00B900 100%);
    min-height: 100vh;
    font-family: 'Microsoft JhengHei', sans-serif;
  }
  
  .main-container {
    padding: 20px;
    max-width: 100%;
  }
  
  .card {
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }
  
  .btn-line {
    background: #06C755;
    border-color: #06C755;
    color: white;
  }
  
  .btn-line:hover {
    background: #00B900;
    border-color: #00B900;
    color: white;
  }
  
  .loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
  }
</style>
</head>
<body>
<div class="container main-container">
  <div id="loadingSection" class="text-center">
    <div class="loading">
      <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">載入中...</span>
      </div>
    </div>
  </div>

  <div id="mainContent" style="display: none;">
    <div class="card">
      <div class="card-body text-center">
        <h2 class="text-primary mb-3">三鐵飛翔好運動協會</h2>
        <p class="text-muted">挑戰極限，飛翔夢想</p>
        
        <div class="row mt-4">
          <div class="col-6">
            <button class="btn btn-line w-100" onclick="showActivities()">
              <i class="bi bi-calendar-event"></i><br>活動查詢
            </button>
          </div>
          <div class="col-6">
            <button class="btn btn-outline-primary w-100" onclick="showRegistrations()">
              <i class="bi bi-person-check"></i><br>我的報名
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="activitiesSection" style="display: none;">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">活動列表</h5>
          <button class="btn btn-sm btn-outline-secondary" onclick="showMain()">
            <i class="bi bi-arrow-left"></i> 返回
          </button>
        </div>
        <div class="card-body" id="activitiesContent">
          <div class="loading">
            <div class="spinner-border" role="status"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="registrationsSection" style="display: none;">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">我的報名</h5>
          <button class="btn btn-sm btn-outline-secondary" onclick="showMain()">
            <i class="bi bi-arrow-left"></i> 返回
          </button>
        </div>
        <div class="card-body" id="registrationsContent">
          <div class="loading">
            <div class="spinner-border" role="status"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let liffProfile = null;
  const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwBXeYH8oS7YVM1vUQhfGGLO2lRy4XBkTpvThLXZGU8mSYTcfh40pv_0aRY7sGOZmFT/exec'; // 請替換為實際的 GAS Web App URL

  // LIFF 初始化
  document.addEventListener('DOMContentLoaded', function() {
    initializeLiff();
  });

  async function initializeLiff() {
    try {
      await liff.init({ liffId: '1656516134-VaGgmaPm' }); // 請替換為實際的 LIFF ID
      
      if (liff.isLoggedIn()) {
        liffProfile = await liff.getProfile();
        document.getElementById('loadingSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
      } else {
        liff.login();
      }
    } catch (error) {
      console.error('LIFF initialization failed', error);
      showToast('error', 'LINE 登入失敗');
    }
  }

  function showMain() {
    hideAllSections();
    // 主畫面預設顯示
  }

  async function showActivities() {
    hideAllSections();
    document.getElementById('activitiesSection').style.display = 'block';
    
    try {
      const response = await fetch(`${API_BASE_URL}?path=activities&status=報名中`);
      const data = await response.json();
      
      const content = document.getElementById('activitiesContent');
      
      if (data.activities && data.activities.length > 0) {
        content.innerHTML = data.activities.map(activity => `
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="card-title">${activity.name}</h6>
                  <p class="card-text small text-muted">${activity.description || ''}</p>
                  <div class="d-flex gap-3 small text-muted">
                    <span><i class="bi bi-calendar"></i> ${formatDate(activity.date)}</span>
                    <span><i class="bi bi-geo-alt"></i> ${activity.location}</span>
                  </div>
                </div>
                <div class="text-end">
                  <div class="badge bg-primary">${activity.sport}</div>
                  <div class="fw-bold text-success mt-1">$${activity.fee}</div>
                </div>
              </div>
              <div class="d-flex justify-content-between align-items-center mt-3">
                <small class="text-muted">
                  <i class="bi bi-people"></i> ${activity.registrationCount || 0}/${activity.maxParticipants}
                </small>
                <button class="btn btn-line btn-sm" onclick="registerActivity('${activity.id}')">
                  立即報名
                </button>
              </div>
            </div>
          </div>
        `).join('');
      } else {
        content.innerHTML = `
          <div class="text-center py-4">
            <i class="bi bi-calendar-x display-4 text-muted"></i>
            <p class="text-muted mt-2">目前沒有開放報名的活動</p>
          </div>
        `;
      }
    } catch (error) {
      console.error('載入活動失敗', error);
      document.getElementById('activitiesContent').innerHTML = `
        <div class="alert alert-warning">載入活動失敗，請稍後再試</div>
      `;
    }
  }

  async function showRegistrations() {
    hideAllSections();
    document.getElementById('registrationsSection').style.display = 'block';
    
    try {
      const response = await fetch(`${API_BASE_URL}?path=registrations&lineUserId=${liffProfile.userId}`);
      const data = await response.json();
      
      const content = document.getElementById('registrationsContent');
      
      if (data && data.length > 0) {
        content.innerHTML = data.map(reg => `
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="card-title">${reg.activityId.name}</h6>
                  <div class="d-flex gap-3 small text-muted">
                    <span><i class="bi bi-calendar"></i> ${formatDate(reg.activityId.date)}</span>
                    <span><i class="bi bi-geo-alt"></i> ${reg.activityId.location}</span>
                  </div>
                  <div class="mt-2">
                    <span class="badge ${reg.paymentStatus === 'paid' ? 'bg-success' : 'bg-warning'}">
                      ${reg.paymentStatus === 'paid' ? '已繳費' : '未繳費'}
                    </span>
                  </div>
                </div>
                <div class="text-end">
                  <div class="fw-bold text-success">$${reg.activityId.fee}</div>
                  ${reg.paymentStatus === 'unpaid' ? `
                    <button class="btn btn-warning btn-sm mt-2" onclick="payActivity('${reg.id}', '${reg.activityId.name}', ${reg.activityId.fee})">
                      立即繳費
                    </button>
                  ` : ''}
                </div>
              </div>
            </div>
          </div>
        `).join('');
      } else {
        content.innerHTML = `
          <div class="text-center py-4">
            <i class="bi bi-person-x display-4 text-muted"></i>
            <p class="text-muted mt-2">您還沒有報名任何活動</p>
            <button class="btn btn-line" onclick="showActivities()">
              瀏覽活動
            </button>
          </div>
        `;
      }
    } catch (error) {
      console.error('載入報名記錄失敗', error);
      document.getElementById('registrationsContent').innerHTML = `
        <div class="alert alert-warning">載入報名記錄失敗，請稍後再試</div>
      `;
    }
  }

  async function registerActivity(activityId) {
    try {
      // 先檢查用戶資料
      const userResponse = await fetch(`${API_BASE_URL}?path=user&lineUserId=${liffProfile.userId}`);
      const userData = await userResponse.json();
      
      if (!userData.memberInfo || !userData.memberInfo.name) {
        const result = await Swal.fire({
          title: '需要完成會員資料',
          text: '請先填寫您的基本資料才能報名活動',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: '立即填寫',
          cancelButtonText: '取消'
        });
        
        if (result.isConfirmed) {
          showUserProfile();
        }
        return;
      }

      const result = await Swal.fire({
        title: '確認報名',
        text: '確定要報名此活動嗎？',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: '確認報名',
        cancelButtonText: '取消'
      });

      if (result.isConfirmed) {
        const response = await fetch(`${API_BASE_URL}?path=register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            activityId: activityId,
            lineUserId: liffProfile.userId,
            memberName: userData.memberInfo.name
          })
        });

        const data = await response.json();
        
        if (data.success) {
          showToast('success', '報名成功！');
          showRegistrations(); // 重新載入報名列表
        } else {
          showToast('error', data.error || '報名失敗');
        }
      }
    } catch (error) {
      console.error('報名失敗', error);
      showToast('error', '報名失敗，請稍後再試');
    }
  }

  async function payActivity(registrationId, activityName, amount) {
    const { value: paymentMethod } = await Swal.fire({
      title: '選擇繳費方式',
      html: `
        <div class="mb-3">
          <strong>活動：</strong>${activityName}<br>
          <strong>金額：</strong>$${amount}
        </div>
      `,
      input: 'select',
      inputOptions: {
        'LINE Pay': 'LINE Pay',
        '信用卡': '信用卡',
        '銀行轉帳': '銀行轉帳',
        '現金': '現金'
      },
      inputPlaceholder: '請選擇繳費方式',
      showCancelButton: true,
      confirmButtonText: '確認繳費',
      cancelButtonText: '取消'
    });

    if (paymentMethod) {
      try {
        const response = await fetch(`${API_BASE_URL}?path=payment`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            registrationId: registrationId,
            paymentMethod: paymentMethod,
            lineUserId: liffProfile.userId
          })
        });

        const data = await response.json();
        
        if (data.success) {
          showToast('success', '繳費完成！');
          showRegistrations(); // 重新載入報名列表
        } else {
          showToast('error', data.error || '繳費失敗');
        }
      } catch (error) {
        console.error('繳費失敗', error);
        showToast('error', '繳費失敗，請稍後再試');
      }
    }
  }

  function hideAllSections() {
    document.getElementById('activitiesSection').style.display = 'none';
    document.getElementById('registrationsSection').style.display = 'none';
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
  }

  function showToast(type, message) {
    const Toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });

    Toast.fire({
      icon: type,
      title: message
    });
  }
</script>
</body>
</html>
