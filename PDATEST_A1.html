<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友會管理系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
      :root {
          --primary-color: #2c5aa0;
          --success-color: #28a745;
          --danger-color: #dc3545;
      }
      
      body {
          font-family: 'Microsoft JhengHei', sans-serif;
          background-color: #f8f9fa;
      }
      
      .navbar-brand {
          color: var(--primary-color) !important;
          font-weight: bold;
      }
      
      .card {
          border: none;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          border-radius: 12px;
      }
      
      .btn-primary {
          background-color: var(--primary-color);
          border-color: var(--primary-color);
      }
      
      .stat-card {
          background: linear-gradient(135deg, var(--primary-color), #4a90e2);
          color: white;
          border-radius: 15px;
      }
      
      .loading {
          display: none;
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          z-index: 9999;
      }
      
      .member-avatar {
          width: 50px;
          height: 50px;
          border-radius: 50%;
          background: var(--primary-color);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 20px;
      }
  </style>
</head>
<body>
  <div class="loading">
      <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">載入中...</span>
      </div>
  </div>

  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
      <div class="container">
          <a class="navbar-brand" href="#">
              <i class="bi bi-heart-pulse me-2"></i>
              帕金森病友會管理系統
          </a>
          <div class="d-flex">
              <span class="navbar-text" id="userInfo">載入中...</span>
          </div>
      </div>
  </nav>

  <div class="container mt-4">
      <!-- 會員資料卡片 -->
      <div class="row mb-4">
          <div class="col-12">
              <div class="card">
                  <div class="card-body">
                      <div class="row align-items-center">
                          <div class="col-auto">
                              <div class="member-avatar" id="memberAvatar">
                                  <i class="bi bi-person"></i>
                              </div>
                          </div>
                          <div class="col">
                              <h5 class="card-title mb-1" id="memberName">載入中...</h5>
                              <p class="card-text text-muted mb-0" id="memberInfo">載入會員資料中...</p>
                          </div>
                          <div class="col-auto">
                              <span class="badge bg-success" id="memberStatus">正常</span>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- 功能選單 -->
      <div class="row mb-4">
          <div class="col-6 col-md-3 mb-3">
              <div class="card h-100" onclick="showMemberDetail()">
                  <div class="card-body text-center">
                      <i class="bi bi-person-circle display-4 text-primary mb-2"></i>
                      <h6>會員資料</h6>
                  </div>
              </div>
          </div>
          <div class="col-6 col-md-3 mb-3">
              <div class="card h-100" onclick="showPaymentHistory()">
                  <div class="card-body text-center">
                      <i class="bi bi-credit-card display-4 text-success mb-2"></i>
                      <h6>繳費記錄</h6>
                  </div>
              </div>
          </div>
          <div class="col-6 col-md-3 mb-3">
              <div class="card h-100" onclick="showPaymentForm()">
                  <div class="card-body text-center">
                      <i class="bi bi-cash-coin display-4 text-warning mb-2"></i>
                      <h6>線上繳費</h6>
                  </div>
              </div>
          </div>
          <div class="col-6 col-md-3 mb-3" id="adminMenu" style="display: none;">
              <div class="card h-100" onclick="showAdminPanel()">
                  <div class="card-body text-center">
                      <i class="bi bi-gear display-4 text-danger mb-2"></i>
                      <h6>管理功能</h6>
                  </div>
              </div>
          </div>
      </div>

      <!-- 內容區域 -->
      <div id="contentArea">
          <!-- 預設顯示最近活動 -->
          <div class="card">
              <div class="card-header">
                  <h6><i class="bi bi-clock-history"></i> 最近活動</h6>
              </div>
              <div class="card-body" id="recentActivities">
                  <div class="text-center text-muted">
                      <i class="bi bi-hourglass-split display-4"></i>
                      <p class="mt-2">載入中...</p>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- 會員詳情模態框 -->
  <div class="modal fade" id="memberDetailModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">會員詳細資料</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="memberDetailContent">
                  <!-- 會員詳情內容 -->
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-primary" onclick="editMemberInfo()">
                      <i class="bi bi-pencil"></i> 編輯資料
                  </button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
              </div>
          </div>
      </div>
  </div>

  <!-- 繳費表單模態框 -->
  <div class="modal fade" id="paymentModal" tabindex="-1">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">線上繳費</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <form id="paymentForm">
                      <div class="mb-3">
                          <label for="paymentAmount" class="form-label">繳費金額</label>
                          <input type="number" class="form-control" id="paymentAmount" value="1000" min="1" required>
                      </div>
                      <div class="mb-3">
                          <label for="paymentMethod" class="form-label">繳費方式</label>
                          <select class="form-select" id="paymentMethod" required>
                              <option value="">請選擇</option>
                              <option value="銀行轉帳">銀行轉帳</option>
                              <option value="信用卡">信用卡</option>
                              <option value="現金">現金</option>
                          </select>
                      </div>
                      <div class="mb-3">
                          <label for="paymentNote" class="form-label">備註</label>
                          <textarea class="form-control" id="paymentNote" rows="3"></textarea>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-success" onclick="submitPayment()">
                      <i class="bi bi-credit-card"></i> 確認繳費
                  </button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              </div>
          </div>
      </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
      let liffId = '1656516134-VaGgmaPm'; // 替換為實際的 LIFF ID
      let gasUrl = 'https://script.google.com/macros/s/AKfycbyMO2KLhbUynWxuhII6gN0k6iLnUVvvub_5t2lO4KLgg0NOU-MSZq2O2rjj5SVwGjWrLQ/exec'; // 替換為 GAS Web App URL
      let currentUser = null;
      let memberData = null;

      // LIFF 初始化
      document.addEventListener('DOMContentLoaded', function() {
          initializeLiff();
      });

      async function initializeLiff() {
          try {
              await liff.init({ liffId: liffId });
              
              if (liff.isLoggedIn()) {
                  await loadUserProfile();
                  await loadMemberData();
              } else {
                  liff.login();
              }
          } catch (error) {
              console.error('LIFF初始化失敗:', error);
              showError('系統初始化失敗，請重新整理頁面');
          }
      }

      async function loadUserProfile() {
          try {
              const profile = await liff.getProfile();
              currentUser = profile;
              
              document.getElementById('userInfo').textContent = profile.displayName;
              document.getElementById('memberAvatar').innerHTML = 
                  profile.displayName.charAt(0).toUpperCase();
              
          } catch (error) {
              console.error('載入用戶資料失敗:', error);
          }
      }

      async function loadMemberData() {
          showLoading(true);
          
          try {
              const response = await fetch(`${gasUrl}?action=getMember&lineId=${currentUser.userId}`);
              const result = await response.json();
              
              if (result.success) {
                  memberData = result.data;
                  displayMemberInfo();
                  loadRecentActivities();
              } else {
                  showError('找不到會員資料，請聯繫管理員');
              }
          } catch (error) {console.error('載入會員資料失敗:', error);
              showError('載入會員資料失敗');
          } finally {
              showLoading(false);
          }
      }

      function displayMemberInfo() {
          if (!memberData) return;
          
          document.getElementById('memberName').textContent = memberData.name;
          document.getElementById('memberInfo').textContent = 
              `會員編號: ${memberData.id} | 加入日期: ${formatDate(memberData.joinDate)}`;
          
          const statusElement = document.getElementById('memberStatus');
          const statusMap = {
              'active': { text: '正常', class: 'bg-success' },
              'inactive': { text: '停權', class: 'bg-danger' },
              'pending': { text: '待審核', class: 'bg-warning' }
          };
          
          const status = statusMap[memberData.status] || { text: '未知', class: 'bg-secondary' };
          statusElement.textContent = status.text;
          statusElement.className = `badge ${status.class}`;
          
          // 檢查是否為管理員
          if (memberData.isAdmin) {
              document.getElementById('adminMenu').style.display = 'block';
          }
      }

      async function loadRecentActivities() {
          try {
              const response = await fetch(`${gasUrl}?action=getRecentActivities&memberId=${memberData.id}`);
              const result = await response.json();
              
              if (result.success && result.data.length > 0) {
                  displayRecentActivities(result.data);
              } else {
                  document.getElementById('recentActivities').innerHTML = `
                      <div class="text-center text-muted">
                          <i class="bi bi-inbox display-4"></i>
                          <p class="mt-2">暫無最近活動</p>
                      </div>
                  `;
              }
          } catch (error) {
              console.error('載入最近活動失敗:', error);
          }
      }

      function displayRecentActivities(activities) {
          const html = activities.map(activity => `
              <div class="d-flex align-items-center mb-3">
                  <div class="flex-shrink-0">
                      <i class="bi ${getActivityIcon(activity.type)} text-primary"></i>
                  </div>
                  <div class="flex-grow-1 ms-3">
                      <h6 class="mb-0">${activity.title}</h6>
                      <small class="text-muted">${activity.description}</small>
                  </div>
                  <div class="flex-shrink-0">
                      <small class="text-muted">${formatDate(activity.date)}</small>
                  </div>
              </div>
          `).join('');
          
          document.getElementById('recentActivities').innerHTML = html;
      }

      function getActivityIcon(type) {
          const iconMap = {
              'payment': 'bi-credit-card',
              'registration': 'bi-person-plus',
              'update': 'bi-pencil-square',
              'notification': 'bi-bell'
          };
          return iconMap[type] || 'bi-circle';
      }

      function showMemberDetail() {
          if (!memberData) return;
          
          const content = `
              <div class="row">
                  <div class="col-md-6">
                      <h6>基本資料</h6>
                      <table class="table table-borderless">
                          <tr><td>姓名:</td><td>${memberData.name}</td></tr>
                          <tr><td>電話:</td><td>${memberData.phone}</td></tr>
                          <tr><td>電子郵件:</td><td>${memberData.email || '未提供'}</td></tr>
                          <tr><td>性別:</td><td>${memberData.gender || '未提供'}</td></tr>
                          <tr><td>出生日期:</td><td>${memberData.birthDate || '未提供'}</td></tr>
                      </table>
                  </div>
                  <div class="col-md-6">
                      <h6>會員資訊</h6>
                      <table class="table table-borderless">
                          <tr><td>會員編號:</td><td>${memberData.id}</td></tr>
                          <tr><td>會員類型:</td><td>${getMemberTypeText(memberData.type)}</td></tr>
                          <tr><td>加入日期:</td><td>${formatDate(memberData.joinDate)}</td></tr>
                          <tr><td>年費金額:</td><td>NT$ ${memberData.membershipFee?.toLocaleString()}</td></tr>
                          <tr><td>最後繳費:</td><td>${memberData.lastPaymentDate ? formatDate(memberData.lastPaymentDate) : '尚未繳費'}</td></tr>
                      </table>
                  </div>
              </div>
              ${memberData.address ? `
              <div class="row mt-3">
                  <div class="col-12">
                      <h6>聯絡資訊</h6>
                      <p><strong>地址:</strong> ${memberData.address}</p>
                      ${memberData.emergencyContact ? `
                      <p><strong>緊急聯絡人:</strong> ${memberData.emergencyContact} (${memberData.emergencyPhone})</p>
                      ` : ''}
                  </div>
              </div>
              ` : ''}
          `;
          
          document.getElementById('memberDetailContent').innerHTML = content;
          new bootstrap.Modal(document.getElementById('memberDetailModal')).show();
      }

      async function showPaymentHistory() {
          showLoading(true);
          
          try {
              const response = await fetch(`${gasUrl}?action=getPaymentHistory&memberId=${memberData.id}`);
              const result = await response.json();
              
              if (result.success) {
                  displayPaymentHistory(result.data);
              } else {
                  showError('載入繳費記錄失敗');
              }
          } catch (error) {
              console.error('載入繳費記錄失敗:', error);
              showError('載入繳費記錄失敗');
          } finally {
              showLoading(false);
          }
      }

      function displayPaymentHistory(payments) {
          let html = `
              <div class="card">
                  <div class="card-header">
                      <h6><i class="bi bi-credit-card"></i> 繳費記錄</h6>
                  </div>
                  <div class="card-body">
          `;
          
          if (payments.length === 0) {
              html += `
                  <div class="text-center text-muted">
                      <i class="bi bi-inbox display-4"></i>
                      <p class="mt-2">暫無繳費記錄</p>
                  </div>
              `;
          } else {
              html += `<div class="table-responsive">
                  <table class="table">
                      <thead>
                          <tr>
                              <th>日期</th>
                              <th>金額</th>
                              <th>方式</th>
                              <th>收據編號</th>
                              <th>狀態</th>
                          </tr>
                      </thead>
                      <tbody>
              `;
              
              payments.forEach(payment => {
                  html += `
                      <tr>
                          <td>${formatDate(payment.date)}</td>
                          <td>NT$ ${payment.amount.toLocaleString()}</td>
                          <td>${payment.account}</td>
                          <td>${payment.receiptNumber}</td>
                          <td><span class="badge bg-success">已完成</span></td>
                      </tr>
                  `;
              });
              
              html += `</tbody></table></div>`;
          }
          
          html += `</div></div>`;
          document.getElementById('contentArea').innerHTML = html;
      }

      function showPaymentForm() {
          document.getElementById('paymentAmount').value = memberData.membershipFee || 1000;
          new bootstrap.Modal(document.getElementById('paymentModal')).show();
      }

      async function submitPayment() {
          const amount = document.getElementById('paymentAmount').value;
          const method = document.getElementById('paymentMethod').value;
          const note = document.getElementById('paymentNote').value;
          
          if (!amount || !method) {
              showError('請填寫完整資訊');
              return;
          }
          
          showLoading(true);
          
          try {
              const response = await fetch(gasUrl, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'submitPayment',
                      memberId: memberData.id,
                      amount: parseFloat(amount),
                      method: method,
                      note: note
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                  showSuccess('繳費申請已送出，請等待確認');
                  loadMemberData(); // 重新載入會員資料
              } else {
                  showError(result.message || '繳費申請失敗');
              }
          } catch (error) {
              console.error('繳費申請失敗:', error);
              showError('繳費申請失敗');
          } finally {
              showLoading(false);
          }
      }

      // 工具函數
      function formatDate(date) {
          if (!date) return '';
          const d = new Date(date);
          return d.toLocaleDateString('zh-TW');
      }

      function getMemberTypeText(type) {
          const typeMap = {
              'regular': '一般會員',
              'honorary': '榮譽會員',
              'life': '終身會員',
              'family': '家屬會員'
          };
          return typeMap[type] || type;
      }

      function showLoading(show) {
          document.querySelector('.loading').style.display = show ? 'block' : 'none';
      }

      function showError(message) {
          // 可以使用 Toast 或 Alert 顯示錯誤訊息
          alert('錯誤: ' + message);
      }

      function showSuccess(message) {
          // 可以使用 Toast 或 Alert 顯示成功訊息
          alert('成功: ' + message);
      }

      function editMemberInfo() {
          // 實作編輯會員資料功能
          alert('編輯功能開發中...');
      }

      function showAdminPanel() {
          // 實作管理員面板
          alert('管理功能開發中...');
      }
  </script>
</body>
</html>
              
