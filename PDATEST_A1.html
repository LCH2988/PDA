<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <title>NPO 管理系統 (Google Sheet 同步版)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { background:#f8f9fb; }
    header { background:#244a74; color:#fff; padding:12px 18px; }
    header h1 { font-size:1.25rem; margin:0; }
    .nav-tabs .nav-link.active { font-weight:600; }
    .section { display:none; padding:16px 12px; }
    .section.active { display:block; }
    footer { font-size:.75rem; color:#666; padding:12px; text-align:center; }
    .data-table thead th { background:#eef2f6; position:sticky; top:0; z-index:2; }
    .toolbar { gap:.5rem; flex-wrap:wrap; }
    .tag-pill { background:#e3eefc; border-radius:12px; padding:2px 8px; font-size:.7rem; margin-right:4px; }
    .sync-status { font-size:.7rem; padding:4px 8px; border-radius:12px; background:#e9f2ff; color:#1d508c; display:inline-flex; align-items:center; gap:4px; }
    .sync-busy { cursor:progress; }
    .sync-busy .btn, .sync-busy input, .sync-busy select, .sync-busy textarea { pointer-events:none !important; opacity:.55; }
    #toastContainer { position:fixed; top:12px; right:12px; z-index:3000; display:flex; flex-direction:column; gap:8px; }
    .app-badge { background:#fff; border:1px solid #d0d7e2; border-radius:8px; padding:12px; }
    .small-label { font-size:.7rem; text-transform:uppercase; color:#6c757d; letter-spacing:.5px; }
    .pointer { cursor:pointer; }
    .table-sm td, .table-sm th { padding:.35rem .5rem; }
    .mono { font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.8rem; }
    .divider { height:1px; background:linear-gradient(90deg,#d8e1eb,#f8f9fb); margin:12px 0; }
    .blink {
      animation:blink 1.2s linear infinite;
    }
    @keyframes blink {
      0%,49% { opacity:1; }
      50%,100% { opacity:.15; }
    }
    .pill { padding:2px 6px; font-size:.65rem; border-radius:6px; background:#eef4fa; }
    .filter-bar { background:#fff; padding:8px 10px; border:1px solid #d4dde7; border-radius:8px; margin-bottom:10px; }
    .scroll-y { max-height:480px; overflow:auto; }
    .shadow-inset { box-shadow:inset 0 0 0 1px #d8e1ec; background:#fff; }
    .fw-600 { font-weight:600; }
    .modal-fullscreen-sm-down .modal-body { padding:1rem .85rem; }
    .badge-success-soft { background:#d8f8e4; color:#0f6c3b; }
    .badge-danger-soft { background:#fde0e0; color:#b93030; }
    .badge-secondary-soft { background:#e2e5ea; color:#555; }
    .cursor-help { cursor:help; }
    .hover-row:hover { background:#f4f8fc; }
    .link-like { text-decoration:underline; cursor:pointer; }
    .text-fade { color:#8a97a4; }
    .wide-form-group > label { font-weight:500; }
    .v-mid { vertical-align:middle; }
    .r-8 { border-radius:8px; }
    .bg-soft { background:linear-gradient(135deg,#f3f8fc,#f9fbfd); }
    .btn-outline-dashed { border:1px dashed #5c6f82; }
    .btn-outline-dashed:hover { background:#eef4fa; }
    .opacity-0 { opacity:0; }
    .opacity-50 { opacity:.5; }
    .opacity-70 { opacity:.7; }
    .fs-12 { font-size:.75rem; }
    .fs-13 { font-size:.8125rem; }
    .fs-14 { font-size:.875rem; }
    .fs-24 { font-size:1.4rem; }
  </style>
</head>
<body>
  <header class="d-flex align-items-center justify-content-between">
    <h1 class="d-flex align-items-center gap-2">
      <i class="bi bi-diagram-3-fill"></i> NPO 管理系統
    </h1>
    <div class="d-flex align-items-center gap-3">
      <div id="syncStatusArea"></div>
      <button class="btn btn-sm btn-light" onclick="Modals.openSettings()">
        <i class="bi bi-gear"></i> 系統設定
      </button>
    </div>
  </header>

  <ul class="nav nav-tabs px-3 pt-2" id="mainTabs">
    <li class="nav-item"><button class="nav-link active" data-target="dashboardSection">儀表板</button></li>
    <li class="nav-item"><button class="nav-link" data-target="transactionsSection">收支</button></li>
    <li class="nav-item"><button class="nav-link" data-target="membersSection">會員</button></li>
    <li class="nav-item"><button class="nav-link" data-target="accountsSection">帳戶</button></li>
    <li class="nav-item"><button class="nav-link" data-target="activitiesSection">活動</button></li>
    <li class="nav-item"><button class="nav-link" data-target="announcementsSection">公告</button></li>
    <li class="nav-item"><button class="nav-link" data-target="formsSection">表單</button></li>
    <li class="nav-item"><button class="nav-link" data-target="backupSection">備份/同步</button></li>
  </ul>

  <!-- 儀表板 -->
  <section id="dashboardSection" class="section active">
    <div class="row g-3">
      <div class="col-md-3">
        <div class="app-badge">
          <div class="small-label">會員數</div>
          <div class="fs-24 fw-600" id="dashMembersCount">0</div>
          <div class="text-fade fs-12" id="dashMembersExtra"></div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="app-badge">
          <div class="small-label">今年收入</div>
          <div class="fs-24 fw-600 text-success" id="dashIncome">0</div>
          <div class="text-fade fs-12" id="dashIncomeCount"></div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="app-badge">
          <div class="small-label">今年支出</div>
          <div class="fs-24 fw-600 text-danger" id="dashExpense">0</div>
          <div class="text-fade fs-12" id="dashExpenseCount"></div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="app-badge">
          <div class="small-label">帳戶總餘額(非即時計算)</div>
          <div class="fs-24 fw-600" id="dashAccountBalance">0</div>
          <div class="text-fade fs-12">僅取 currentBalance 欄位</div>
        </div>
      </div>
    </div>
    <div class="divider"></div>
    <div class="row g-3">
      <div class="col-12">
        <h6 class="fw-600 mb-2"><i class="bi bi-graph-up"></i> 最近 10 筆交易</h6>
        <div class="table-responsive shadow-inset r-8" style="max-height:320px;overflow:auto;">
          <table class="table table-sm table-hover mb-0" id="dashRecentTxTable">
            <thead>
              <tr>
                <th>日期</th><th>類型</th><th>科目</th><th class="text-end">金額</th><th>對象</th><th>帳戶</th><th>備註</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- 收支 -->
  <section id="transactionsSection" class="section">
    <div class="d-flex toolbar mb-2">
      <button class="btn btn-primary btn-sm" onclick="Transactions.openNew()"><i class="bi bi-plus-circle"></i> 新增交易</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="Transactions.renderTable()"><i class="bi bi-arrow-clockwise"></i> 重載</button>
      <div class="ms-auto d-flex gap-2">
        <input class="form-control form-control-sm" style="width:160px;" placeholder="搜尋文字" id="txSearch"
               oninput="Transactions.renderTable()"/>
        <select class="form-select form-select-sm" style="width:120px;" id="txTypeFilter" onchange="Transactions.renderTable()">
          <option value="">全部類型</option>
          <option value="收入">收入</option>
          <option value="支出">支出</option>
        </select>
      </div>
    </div>
    <div class="table-responsive shadow-inset r-8 scroll-y" style="max-height:520px;">
      <table class="table table-sm table-striped mb-0" id="transactionsTable">
        <thead>
          <tr>
            <th>日期</th><th>類型</th><th>科目</th><th class="text-end">金額</th><th>對象</th><th>帳戶</th><th>收據</th><th>傳票</th><th>更新</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- 會員 -->
  <section id="membersSection" class="section">
    <div class="d-flex toolbar mb-2">
      <button class="btn btn-primary btn-sm" onclick="Members.openNew()"><i class="bi bi-person-plus"></i> 新增會員</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="Members.renderTable()"><i class="bi bi-arrow-clockwise"></i> 重載</button>
      <input class="form-control form-control-sm ms-auto" style="width:200px;" placeholder="搜尋" id="memberSearch"
             oninput="Members.renderTable()"/>
    </div>
    <div class="table-responsive shadow-inset r-8 scroll-y" style="max-height:520px;">
      <table class="table table-sm table-hover mb-0" id="membersTable">
        <thead>
          <tr><th>姓名</th><th>身分</th><th>電話</th><th>Email</th><th>狀態</th><th>入會</th><th>標籤</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- 帳戶 -->
  <section id="accountsSection" class="section">
    <div class="d-flex toolbar mb-2">
      <button class="btn btn-primary btn-sm" onclick="Accounts.openNew()"><i class="bi bi-wallet2"></i> 新增帳戶</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="Accounts.renderTable()"><i class="bi bi-arrow-clockwise"></i> 重載</button>
    </div>
    <div class="table-responsive shadow-inset r-8" style="max-height:520px;overflow:auto;">
      <table class="table table-sm mb-0" id="accountsTable">
        <thead><tr><th>名稱</th><th>描述</th><th class="text-end">初始</th><th class="text-end">目前</th><th>啟用</th><th>更新</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- 活動 -->
  <section id="activitiesSection" class="section">
    <div class="d-flex toolbar mb-2">
      <button class="btn btn-primary btn-sm" onclick="Activities.openNew()"><i class="bi bi-calendar-plus"></i> 新增活動</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="Activities.renderGrid()"><i class="bi bi-arrow-clockwise"></i> 重載</button>
      <input class="form-control form-control-sm ms-auto" style="width:200px;" placeholder="搜尋" id="activitySearch"
             oninput="Activities.renderGrid()"/>
    </div>
    <div id="activitiesGrid" class="row g-3"></div>
  </section>

  <!-- 公告 -->
  <section id="announcementsSection" class="section">
    <div class="d-flex toolbar mb-2">
      <button class="btn btn-primary btn-sm" onclick="Announcements.openNew()"><i class="bi bi-megaphone"></i> 新增公告</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="Announcements.render()"><i class="bi bi-arrow-clockwise"></i> 重載</button>
    </div>
    <div id="announcementsList" class="row g-3"></div>
  </section>

  <!-- 表單 -->
  <section id="formsSection" class="section">
    <div class="d-flex toolbar mb-2">
      <button class="btn btn-primary btn-sm" onclick="Forms.openNew()"><i class="bi bi-ui-radios"></i> 新增表單</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="Forms.render()"><i class="bi bi-arrow-clockwise"></i> 重載</button>
      <input class="form-control form-control-sm ms-auto" style="width:200px;" id="formsSearch" placeholder="搜尋" oninput="Forms.render()"/>
    </div>
    <div id="formsList" class="row g-3"></div>
  </section>

  <!-- 備份 / 同步 -->
  <section id="backupSection" class="section">
    <div class="row g-4">
      <div class="col-md-4">
        <div class="app-badge h-100 d-flex flex-column">
          <h6 class="fw-600 mb-2"><i class="bi bi-cloud-check"></i> 雲端同步</h6>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="syncEnabledSwitch" onchange="SyncSettings.toggleSync(this.checked)"/>
            <label class="form-check-label" for="syncEnabledSwitch">啟用 Google Sheet 同步</label>
          </div>
          <div class="mb-2">
            <button class="btn btn-sm btn-outline-primary" onclick="GoogleSync.fetchLatest(true)"><i class="bi bi-cloud-download"></i> 下載伺服器</button>
            <button class="btn btn-sm btn-outline-success" onclick="GoogleSync.sync()"><i class="bi bi-cloud-upload"></i> 上傳同步</button>
          </div>
          <div class="small text-fade" id="syncInfoText">尚未同步</div>
          <div class="mt-auto">
            <button class="btn btn-sm btn-outline-secondary" onclick="GoogleSync.backup('manual')"><i class="bi bi-save"></i> 建立備份</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="GoogleSync.showBackups()"><i class="bi bi-clock-history"></i> 備份清單</button>
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="app-badge h-100">
          <h6 class="fw-600 mb-3"><i class="bi bi-file-earmark-code"></i> 即時 JSON 檢視 (本機)</h6>
          <pre class="mono small" style="max-height:400px;overflow:auto;background:#101828;color:#e7eef7;border-radius:8px;padding:8px;"
               id="jsonPreview"></pre>
          <div class="text-end">
            <button class="btn btn-sm btn-outline-secondary" onclick="Preview.refresh()"><i class="bi bi-arrow-clockwise"></i> 重載</button>
            <button class="btn btn-sm btn-outline-danger" onclick="Modals.confirmClearLocal()"><i class="bi bi-trash"></i> 清空本機</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <!-- Modals (簡化版動態建立) -->
  <div class="modal fade" id="genericModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="genericModalTitle" class="modal-title"></h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
          <div class="modal-body" id="genericModalBody"></div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            <button class="btn btn-primary d-none" id="genericModalSaveBtn">儲存</button>
          </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-gear"></i> 系統設定</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label class="form-label small mb-1">組織名稱</label>
          <input class="form-control form-control-sm mb-2" id="settingOrgName"/>
          <label class="form-label small mb-1">預設會費</label>
          <input class="form-control form-control-sm mb-2" id="settingDefaultFee" type="number"/>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="settingEnableSync">
            <label class="form-check-label" for="settingEnableSync">啟用雲端同步</label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
          <button class="btn btn-primary" onclick="Settings.save()"><i class="bi bi-save"></i> 儲存</button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <span class="text-fade">&copy; 2025 NPO System — Google Sheet 同步示範前端（範例模板，可自行擴充）</span>
  </footer>

  <script>
    /**********************
     * 基本工具
     **********************/
    const Util = {
      uuid(){
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
          const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);
          return v.toString(16);
        });
      },
      fmtMoney(num){
        if(isNaN(num)||num===null) return '0';
        return new Intl.NumberFormat('zh-Hant',{minimumFractionDigits:0}).format(Number(num));
      },
      today(){
        return new Date().toISOString().slice(0,10);
      },
      showToast(type,msg,timeout=2600){
        const wrap=document.getElementById('toastContainer');
          const el=document.createElement('div');
          const colors={
            success:'#0e6f3b',
            error:'#b93030',
            info:'#244a74',
            warn:'#8a5b00'
          };
          const color=colors[type]||colors.info;
          el.className='shadow r-8 text-white px-3 py-2 small';
          el.style.background=color;
          el.innerHTML='<i class="bi bi-info-circle"></i> '+msg;
          wrap.appendChild(el);
          setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),400); }, timeout);
      },
      confirm(title,html,cb){
        Swal.fire({icon:'warning',title,html,showCancelButton:true,confirmButtonText:'確認'})
          .then(r=> r.isConfirmed && cb && cb());
      },
      modal(id){
        return bootstrap.Modal.getOrCreateInstance(document.getElementById(id));
      }
    };

    /**********************
     * 資料存儲
     **********************/
    const Store = {
      key: 'NPO_APP_DATA_V1',
      data: {
        transactions: [],
        members: [],
        accounts: [],
        activities: [],
        registrations: [],
        announcements: [],
        forms: [],
        settings: {
          organizationName: '台灣帕金森病友權益促進會',
          defaultMembershipFee: 1000,
          googleSyncEnabled: true
        }
      },
      load(){
        try{
          const raw=localStorage.getItem(this.key);
          if(raw){
            const obj=JSON.parse(raw);
            // 合併（防止未來欄位遺失）
            this.data = Object.assign(this.data, obj);
            // 深度合併 settings
            this.data.settings = Object.assign({
              organizationName: '',
              defaultMembershipFee: 1000,
              googleSyncEnabled: true
            }, obj.settings||{});
          }
        }catch(e){
          console.warn('Load error',e);
        }
      },
      save(){
        try{
          localStorage.setItem(this.key, JSON.stringify(this.data));
          Preview.refresh();
          Dashboard.refresh();
        }catch(e){
          Util.showToast('error','儲存失敗:'+e);
        }
        if(this.data.settings.googleSyncEnabled){
          scheduleAutoSync();
        }
      },
      clear(){
        localStorage.removeItem(this.key);
        this.data.transactions=[];
        this.data.members=[];
        this.data.accounts=[];
        this.data.activities=[];
        this.data.registrations=[];
        this.data.announcements=[];
        this.data.forms=[];
        this.save();
      }
    };

    /**********************
     * 自動同步 Debounce
     **********************/
    let _syncDebounceTimer=null;
    function scheduleAutoSync(){
      if(!Store.data.settings.googleSyncEnabled) return;
      clearTimeout(_syncDebounceTimer);
      _syncDebounceTimer = setTimeout(()=>GoogleSync.sync(), 1200);
    }

    /**********************
     * 同步指示器 (簡化)
     **********************/
    const SyncIndicator = {
      setStatus(html){
        document.getElementById('syncStatusArea').innerHTML=html;
      },
      online(){
        this.setStatus('<span class="sync-status"><i class="bi bi-cloud-check-fill text-success"></i> 線上</span>');
      },
      offline(){
        this.setStatus('<span class="sync-status"><i class="bi bi-cloud-slash-fill text-danger"></i> 離線</span>');
      }
    };

    /**********************
     * Google Sync (與 GAS 後端整合)
     **********************/
    const REMOTE_SYNC = {
      BASE_URL: 'https://script.google.com/macros/s/AKfycbzGVR6-T9VO4uSIgjUmTT5vDtVZmyHAEfw_a-6x_oOmD4QlqXwbkX8yIvETiylmyE7M/exec', // TODO: 替換你的部署 URL (+ ?token=xxx)
      ENABLED: true,
      AUTO_PULL_ON_LOAD: true
    };

    const GoogleSync = {
      syncing:false,
      lastServerVersion: null,
      _setBusy(on){ document.body.classList.toggle('sync-busy',!!on); },
      _updateStatus(){
        const t=document.getElementById('syncInfoText');
        if(!t) return;
        if(!Store.data.settings.googleSyncEnabled){
          t.innerHTML='同步未啟用';
          return;
        }
        if(this.syncing){
          t.innerHTML='<i class="bi bi-arrow-repeat spinner-border spinner-border-sm"></i> 同步中...';
        } else {
          t.innerHTML='伺服器版本: '+(this.lastServerVersion==null?'-':this.lastServerVersion);
        }
      },
      _refreshAllUI(){
        Dashboard.refresh();
        Transactions.renderTable();
        Members.renderTable();
        Accounts.renderTable();
        Activities.renderGrid();
        Announcements.render();
        Forms.render();
        Preview.refresh();
      },
      async fetchLatest(showToast){
        if(!Store.data.settings.googleSyncEnabled) return;
        try{
          this.syncing=true; this._updateStatus();
          const res=await fetch(REMOTE_SYNC.BASE_URL+'?action=fetch');
          const js=await res.json();
          if(js.ok){
            const server=js.data;
            const localCount = Store.data.transactions.length + Store.data.members.length +
              Store.data.accounts.length + Store.data.activities.length +
              Store.data.announcements.length + Store.data.forms.length;
            if(server.version===0 && localCount>0){
              Util.showToast('info','伺服器為空，初次上傳…');
              this.lastServerVersion=0;
              await this.sync();
              return;
            }
            this.lastServerVersion = server.version;
            Object.entries(server.collections).forEach(([k,v])=>{
              if(k in Store.data) Store.data[k]=v;
            });
            if(server.collections.settings){
              Store.data.settings = Object.assign(Store.data.settings, server.collections.settings);
            }
            Store.save();
            this._refreshAllUI();
            if(showToast) Util.showToast('success','載入伺服器完成 (v'+server.version+')');
            SyncIndicator.online();
          } else {
            Util.showToast('error','抓取失敗:'+(js.error||''));
            SyncIndicator.offline();
          }
        }catch(e){
          Util.showToast('error','fetch 錯誤:'+e);
          SyncIndicator.offline();
        }finally{
          this.syncing=false; this._updateStatus();
        }
      },
      async sync(){
        if(!Store.data.settings.googleSyncEnabled) return;
        if(this.syncing) return;
        this.syncing=true; this._setBusy(true); this._updateStatus();
        try{
          const payload={
            action:'save',
            version:this.lastServerVersion || 0,
            data:{
              transactions:Store.data.transactions,
              members:Store.data.members,
              accounts:Store.data.accounts,
              activities:Store.data.activities,
              registrations:Store.data.registrations,
              announcements:Store.data.announcements,
              forms:Store.data.forms,
              settings:Store.data.settings
            }
          };
          const res=await fetch(REMOTE_SYNC.BASE_URL,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          const js=await res.json();
          if(js.ok){
            this.lastServerVersion=js.savedVersion;
            Util.showToast('success','同步完成 (v'+js.savedVersion+')');
            SyncIndicator.online();
          } else if(js.conflict){
            Util.showToast('error','版本衝突，回退伺服器版本');
            if(js.serverData){
              Object.entries(js.serverData.collections).forEach(([k,v])=>{
                if(k in Store.data) Store.data[k]=v;
              });
              if(js.serverData.collections.settings){
                Store.data.settings = Object.assign(Store.data.settings, js.serverData.collections.settings);
              }
              this.lastServerVersion = js.serverData.version;
              Store.save();
              this._refreshAllUI();
              Swal.fire({icon:'warning',title:'版本衝突',html:'伺服器較新，已覆蓋本機。',confirmButtonText:'了解'});
            }
          } else {
            Util.showToast('error','同步錯誤:'+(js.error||''));
            SyncIndicator.offline();
          }
        }catch(e){
          Util.showToast('error','同步失敗:'+e);
          SyncIndicator.offline();
        }finally{
          this.syncing=false; this._setBusy(false); this._updateStatus();
        }
      },
      async backup(note=''){
        try{
          const res=await fetch(REMOTE_SYNC.BASE_URL,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({action:'backup',note})
          });
          const js=await res.json();
          if(js.ok) Util.showToast('success','備份完成'); else Util.showToast('error','備份失敗');
        }catch(e){
          Util.showToast('error','備份錯誤:'+e);
        }
      },
      async showBackups(){
        try{
          const res=await fetch(REMOTE_SYNC.BASE_URL+'?action=listBackups');
          const js=await res.json();
          if(!js.ok) return Swal.fire('備份','取得失敗','error');
          const list=js.backups||[];
          if(!list.length) return Swal.fire('備份','尚無備份','info');
          const html='<div style="max-height:420px;overflow:auto;text-align:left;">'
            + list.map(b=>`
              <div class="border rounded p-2 mb-2 small">
                <div><strong>${b.name}</strong></div>
                <div>建立：${new Date(b.created).toLocaleString()}</div>
                <div>大小：${(b.size/1024).toFixed(1)} KB</div>
                <div class="mt-1 d-flex gap-2">
                  <button class="btn btn-sm btn-outline-primary" onclick="GoogleSync.confirmRestore('${b.id}')">還原</button>
                  <a class="btn btn-sm btn-outline-secondary" target="_blank" href="${b.url}">檢視</a>
                </div>
              </div>`).join('')
            + '</div>';
          Swal.fire({title:'備份列表',html,width:560,showConfirmButton:false});
        }catch(e){
          Util.showToast('error','備份列表錯誤:'+e);
        }
      },
      confirmRestore(id){
        Swal.fire({
          icon:'warning', title:'還原確認',
          html:'此操作將覆蓋伺服器與本機資料為備份版本。確定？',
          showCancelButton:true,
          confirmButtonText:'還原'
        }).then(r=>{
          if(r.isConfirmed) this.restore(id);
        });
      },
      async restore(id){
        try{
          const res=await fetch(REMOTE_SYNC.BASE_URL,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({action:'restore', id})
          });
          const js=await res.json();
          if(js.ok){
            Util.showToast('success','還原完成 (v'+js.restoredVersion+')');
            await this.fetchLatest(true);
          } else {
            Util.showToast('error','還原失敗:'+(js.error||''));
          }
        }catch(e){
          Util.showToast('error','還原錯誤:'+e);
        }
      }
    };

    /**********************
     * 儀表板
     **********************/
    const Dashboard = {
      refresh(){
        const t = Store.data.transactions;
        const year = new Date().getFullYear();
          const inTx=t.filter(x=>x.type==='收入' && x.date && x.date.startsWith(year+''));
          const outTx=t.filter(x=>x.type==='支出' && x.date && x.date.startsWith(year+''));
          const sumIn=inTx.reduce((a,b)=>a+Number(b.amount||0),0);
          const sumOut=outTx.reduce((a,b)=>a+Number(b.amount||0),0);
          document.getElementById('dashMembersCount').textContent = Store.data.members.length;
          document.getElementById('dashIncome').textContent = Util.fmtMoney(sumIn);
          document.getElementById('dashIncomeCount').textContent = inTx.length+' 筆';
          document.getElementById('dashExpense').textContent = Util.fmtMoney(sumOut);
          document.getElementById('dashExpenseCount').textContent = outTx.length+' 筆';
          const balance = Store.data.accounts.reduce((a,b)=>a+Number(b.currentBalance||0),0);
          document.getElementById('dashAccountBalance').textContent = Util.fmtMoney(balance);
          // Recent 10
          const body=document.querySelector('#dashRecentTxTable tbody');
          const sorted=[...t].sort((a,b)=> (b.date||'').localeCompare(a.date||'' ) ).slice(0,10);
          body.innerHTML=sorted.map(x=>`
            <tr>
              <td>${x.date||''}</td>
              <td>${x.type||''}</td>
              <td>${x.category||''}</td>
              <td class="text-end ${x.type==='支出'?'text-danger':'text-success'}">${Util.fmtMoney(x.amount||0)}</td>
              <td>${x.counterparty||''}</td>
              <td>${x.account||''}</td>
              <td>${x.receiptNumber||''}</td>
              <td>${x.voucherNumber||''}</td>
            </tr>`).join('');
      }
    };

    /**********************
     * 交易
     **********************/
    const Transactions = {
      openNew(){
        const id=Util.uuid();
        const today=Util.today();
        Modals.open('新增交易', `
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label small mb-1">日期</label>
              <input type="date" class="form-control form-control-sm" id="txDate" value="${today}">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">類型</label>
              <select class="form-select form-select-sm" id="txType">
                <option value="收入">收入</option>
                <option value="支出">支出</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">科目</label>
              <input class="form-control form-control-sm" id="txCategory" placeholder="例如：會費">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">金額</label>
              <input type="number" class="form-control form-control-sm" id="txAmount">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">對象</label>
              <input class="form-control form-control-sm" id="txCounterparty">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">帳戶</label>
              <input class="form-control form-control-sm" id="txAccount" value="現金">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">收據號</label>
              <input class="form-control form-control-sm" id="txReceipt">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">傳票號</label>
              <input class="form-control form-control-sm" id="txVoucher">
            </div>
            <div class="col-12">
              <label class="form-label small mb-1">備註</label>
              <textarea class="form-control form-control-sm" id="txDesc"></textarea>
            </div>
          </div>
        `, ()=>{
          const rec={
            id,
            date: document.getElementById('txDate').value,
            type: document.getElementById('txType').value,
            category: document.getElementById('txCategory').value.trim(),
            amount: Number(document.getElementById('txAmount').value||0),
            counterparty: document.getElementById('txCounterparty').value.trim(),
            account: document.getElementById('txAccount').value.trim(),
            description: document.getElementById('txDesc').value.trim(),
            receiptNumber: document.getElementById('txReceipt').value.trim(),
            voucherNumber: document.getElementById('txVoucher').value.trim(),
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            vouchers:[]
          };
          Store.data.transactions.push(rec);
          Store.save();
          this.renderTable();
          Util.showToast('success','已新增交易');
        });
      },
      edit(id){
        const tx=Store.data.transactions.find(x=>x.id===id);
        if(!tx) return;
        Modals.open('編輯交易', `
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label small mb-1">日期</label>
              <input type="date" class="form-control form-control-sm" id="txDate" value="${tx.date||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">類型</label>
              <select class="form-select form-select-sm" id="txType">
                <option value="收入" ${tx.type==='收入'?'selected':''}>收入</option>
                <option value="支出" ${tx.type==='支出'?'selected':''}>支出</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">科目</label>
              <input class="form-control form-control-sm" id="txCategory" value="${tx.category||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">金額</label>
              <input type="number" class="form-control form-control-sm" id="txAmount" value="${tx.amount||0}">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">對象</label>
              <input class="form-control form-control-sm" id="txCounterparty" value="${tx.counterparty||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">帳戶</label>
              <input class="form-control form-control-sm" id="txAccount" value="${tx.account||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">收據號</label>
              <input class="form-control form-control-sm" id="txReceipt" value="${tx.receiptNumber||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">傳票號</label>
              <input class="form-control form-control-sm" id="txVoucher" value="${tx.voucherNumber||''}">
            </div>
            <div class="col-12">
              <label class="form-label small mb-1">備註</label>
              <textarea class="form-control form-control-sm" id="txDesc">${tx.description||''}</textarea>
            </div>
          </div>
        `, ()=>{
          tx.date=document.getElementById('txDate').value;
          tx.type=document.getElementById('txType').value;
          tx.category=document.getElementById('txCategory').value.trim();
          tx.amount=Number(document.getElementById('txAmount').value||0);
          tx.counterparty=document.getElementById('txCounterparty').value.trim();
          tx.account=document.getElementById('txAccount').value.trim();
          tx.receiptNumber=document.getElementById('txReceipt').value.trim();
          tx.voucherNumber=document.getElementById('txVoucher').value.trim();
          tx.description=document.getElementById('txDesc').value.trim();
          tx.updatedAt=new Date().toISOString();
          Store.save();
          this.renderTable();
          Util.showToast('success','已更新');
        });
      },
      remove(id){
        Util.confirm('刪除確認','確定刪除此交易？',()=>{
          const i=Store.data.transactions.findIndex(x=>x.id===id);
          if(i>=0){
            Store.data.transactions.splice(i,1);
            Store.save();
            this.renderTable();
            Util.showToast('success','已刪除');
          }
        });
      },
      renderTable(){
        const tbody=document.querySelector('#transactionsTable tbody');
        const search=document.getElementById('txSearch').value.trim().toLowerCase();
        const typeFilter=document.getElementById('txTypeFilter').value;
        const list=[...Store.data.transactions].sort((a,b)=> (b.date||'').localeCompare(a.date||''));
        const filtered=list.filter(x=>{
          if(typeFilter && x.type!==typeFilter) return false;
          if(search){
            const s=(x.date||'')+(x.type||'')+(x.category||'')+(x.counterparty||'')+(x.account||'')+(x.description||'');
            if(!s.toLowerCase().includes(search)) return false;
          }
          return true;
        });
        tbody.innerHTML=filtered.map(x=>`
          <tr class="hover-row">
            <td>${x.date||''}</td>
            <td>${x.type}</td>
            <td>${x.category||''}</td>
            <td class="text-end ${x.type==='支出'?'text-danger':'text-success'}">${Util.fmtMoney(x.amount||0)}</td>
            <td>${x.counterparty||''}</td>
            <td>${x.account||''}</td>
            <td>${x.receiptNumber||''}</td>
            <td>${x.voucherNumber||''}</td>
            <td><span class="text-fade" title="${x.updatedAt||''}">${(x.updatedAt||'').slice(5,16).replace('T',' ')}</span></td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="Transactions.edit('${x.id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-outline-danger" onclick="Transactions.remove('${x.id}')"><i class="bi bi-trash"></i></button>
              </div>
            </td>
          </tr>
        `).join('');
      }
    };

    /**********************
     * 會員
     **********************/
    const Members = {
      openNew(){
        const id=Util.uuid();
        const today=Util.today();
        Modals.open('新增會員', `
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label small mb-1">姓名</label>
              <input class="form-control form-control-sm" id="memName">
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">電話</label>
              <input class="form-control form-control-sm" id="memPhone">
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">Email</label>
              <input class="form-control form-control-sm" id="memEmail">
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">狀態</label>
              <select class="form-select form-select-sm" id="memStatus">
                <option value="正常">正常</option>
                <option value="停權">停權</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">入會日期</label>
              <input type="date" class="form-control form-control-sm" id="memJoinDate" value="${today}">
            </div>
            <div class="col-12">
              <label class="form-label small mb-1">標籤 (逗號分隔)</label>
              <input class="form-control form-control-sm" id="memTags" placeholder="例: 理監事,志工">
            </div>
          </div>
        `, ()=>{
          const tags = document.getElementById('memTags').value.split(',').map(s=>s.trim()).filter(Boolean);
          Store.data.members.push({
            id,
            name: document.getElementById('memName').value.trim(),
            phone: document.getElementById('memPhone').value.trim(),
            email: document.getElementById('memEmail').value.trim(),
            status: document.getElementById('memStatus').value,
            joinDate: document.getElementById('memJoinDate').value,
            tags,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          });
          Store.save();
          this.renderTable();
          Util.showToast('success','已新增會員');
        });
      },
      edit(id){
        const m=Store.data.members.find(x=>x.id===id);
        if(!m) return;
        Modals.open('編輯會員', `
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label small mb-1">姓名</label>
              <input class="form-control form-control-sm" id="memName" value="${m.name||''}">
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">電話</label>
              <input class="form-control form-control-sm" id="memPhone" value="${m.phone||''}">
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">Email</label>
              <input class="form-control form-control-sm" id="memEmail" value="${m.email||''}">
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">狀態</label>
              <select class="form-select form-select-sm" id="memStatus">
                <option value="正常" ${m.status==='正常'?'selected':''}>正常</option>
                <option value="停權" ${m.status==='停權'?'selected':''}>停權</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">入會日期</label>
              <input type="date" class="form-control form-control-sm" id="memJoinDate" value="${m.joinDate||''}">
            </div>
            <div class="col-12">
              <label class="form-label small mb-1">標籤 (逗號分隔)</label>
              <input class="form-control form-control-sm" id="memTags" value="${(m.tags||[]).join(', ')}">
            </div>
          </div>
        `, ()=>{
          m.name=document.getElementById('memName').value.trim();
          m.phone=document.getElementById('memPhone').value.trim();
          m.email=document.getElementById('memEmail').value.trim();
          m.status=document.getElementById('memStatus').value;
          m.joinDate=document.getElementById('memJoinDate').value;
          m.tags=document.getElementById('memTags').value.split(',').map(s=>s.trim()).filter(Boolean);
          m.updatedAt=new Date().toISOString();
          Store.save();
          this.renderTable();
          Util.showToast('success','已更新會員');
        });
      },
      remove(id){
        Util.confirm('刪除確認','確定刪除此會員？',()=>{
          const i=Store.data.members.findIndex(x=>x.id===id);
          if(i>=0){
            Store.data.members.splice(i,1);
            Store.save();
            this.renderTable();
            Util.showToast('success','已刪除');
          }
        });
      },
      renderTable(){
        const tbody=document.querySelector('#membersTable tbody');
        const search=document.getElementById('memberSearch').value.trim().toLowerCase();
        const list=[...Store.data.members].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
        const filtered=list.filter(x=>{
          if(!search) return true;
          return (x.name||'').toLowerCase().includes(search) ||
                 (x.phone||'').toLowerCase().includes(search) ||
                 (x.email||'').toLowerCase().includes(search);
        });
        tbody.innerHTML=filtered.map(m=>`
          <tr class="hover-row">
            <td>${m.name||''}</td>
            <td>${(m.type||'會員')}</td>
            <td>${m.phone||''}</td>
            <td>${m.email||''}</td>
            <td>${m.status||''}</td>
            <td>${m.joinDate||''}</td>
            <td>${(m.tags||[]).map(t=>'<span class="tag-pill">'+t+'</span>').join('')}</td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="Members.edit('${m.id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-outline-danger" onclick="Members.remove('${m.id}')"><i class="bi bi-trash"></i></button>
              </div>
            </td>
          </tr>
        `).join('');
      }
    };

    /**********************
     * 帳戶
     **********************/
    const Accounts = {
      openNew(){
        const id=Util.uuid();
        Modals.open('新增帳戶', `
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label small mb-1">名稱</label>
              <input class="form-control form-control-sm" id="accName">
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">初始餘額</label>
              <input type="number" class="form-control form-control-sm" id="accInit" value="0">
            </div>
            <div class="col-12">
              <label class="form-label small mb-1">描述</label>
              <input class="form-control form-control-sm" id="accDesc">
            </div>
          </div>
        `, ()=>{
          Store.data.accounts.push({
            id, name: document.getElementById('accName').value.trim(),
            description: document.getElementById('accDesc').value.trim(),
            initialBalance: Number(document.getElementById('accInit').value||0),
            currentBalance: Number(document.getElementById('accInit').value||0),
            active:true,
            createdAt:new Date().toISOString(),
            updatedAt:new Date().toISOString()
          });
          Store.save();
          this.renderTable();
          Util.showToast('success','已新增帳戶');
        });
      },
      edit(id){
        const a=Store.data.accounts.find(x=>x.id===id);
        if(!a) return;
        Modals.open('編輯帳戶', `
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label small mb-1">名稱</label>
              <input class="form-control form-control-sm" id="accName" value="${a.name||''}">
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">目前餘額</label>
              <input type="number" class="form-control form-control-sm" id="accCurrent" value="${a.currentBalance||0}">
            </div>
            <div class="col-12">
              <label class="form-label small mb-1">描述</label>
              <input class="form-control form-control-sm" id="accDesc" value="${a.description||''}">
            </div>
            <div class="col-12 form-check mt-1">
              <input type="checkbox" class="form-check-input" id="accActive" ${a.active?'checked':''}>
              <label class="form-check-label small" for="accActive">啟用</label>
            </div>
          </div>
        `, ()=>{
          a.name=document.getElementById('accName').value.trim();
          a.currentBalance=Number(document.getElementById('accCurrent').value||0);
          a.description=document.getElementById('accDesc').value.trim();
          a.active=document.getElementById('accActive').checked;
          a.updatedAt=new Date().toISOString();
          Store.save();
          this.renderTable();
          Util.showToast('success','已更新帳戶');
        });
      },
      remove(id){
        Util.confirm('刪除確認','確定刪除此帳戶？',()=>{
          const i=Store.data.accounts.findIndex(x=>x.id===id);
          if(i>=0){
            Store.data.accounts.splice(i,1);
            Store.save();
            this.renderTable();
            Util.showToast('success','已刪除');
          }
        });
      },
      renderTable(){
        const tbody=document.querySelector('#accountsTable tbody');
        const list=[...Store.data.accounts].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
        tbody.innerHTML=list.map(a=>`
          <tr class="hover-row">
            <td>${a.name||''}</td>
            <td>${a.description||''}</td>
            <td class="text-end">${Util.fmtMoney(a.initialBalance||0)}</td>
            <td class="text-end">${Util.fmtMoney(a.currentBalance||0)}</td>
            <td>${a.active?'<span class="badge bg-success">啟用</span>':'<span class="badge bg-secondary">停用</span>'}</td>
            <td><span class="text-fade" title="${a.updatedAt||''}">${(a.updatedAt||'').slice(5,16).replace('T',' ')}</span></td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="Accounts.edit('${a.id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-outline-danger" onclick="Accounts.remove('${a.id}')"><i class="bi bi-trash"></i></button>
              </div>
            </td>
          </tr>
        `).join('');
      }
    };

    /**********************
     * 活動
     **********************/
    const Activities = {
      openNew(){
        const id=Util.uuid();
        const today=Util.today();
        Modals.open('新增活動', `
          <div class="row g-2">
            <div class="col-md-8">
              <label class="form-label small mb-1">活動名稱</label>
              <input class="form-control form-control-sm" id="actName">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">日期</label>
              <input type="date" class="form-control form-control-sm" id="actDate" value="${today}">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">類型</label>
              <input class="form-control form-control-sm" id="actType" placeholder="講座/聚會">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">狀態</label>
              <select class="form-select form-select-sm" id="actStatus">
                <option value="草稿">草稿</option>
                <option value="開放中">開放中</option>
                <option value="結束">結束</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">費用</label>
              <input type="number" class="form-control form-control-sm" id="actFee" value="0">
            </div>
            <div class="col-12">
              <label class="form-label small mb-1">說明</label>
              <textarea class="form-control form-control-sm" id="actDesc"></textarea>
            </div>
          </div>
        `, ()=>{
          Store.data.activities.push({
            id,
            name: document.getElementById('actName').value.trim(),
            date: document.getElementById('actDate').value,
            type: document.getElementById('actType').value.trim(),
            status: document.getElementById('actStatus').value,
            fee: Number(document.getElementById('actFee').value||0),
            description: document.getElementById('actDesc').value.trim(),
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          });
          Store.save();
          this.renderGrid();
          Util.showToast('success','已新增活動');
        });
      },
      edit(id){
        const a=Store.data.activities.find(x=>x.id===id);
        if(!a) return;
        Modals.open('編輯活動', `
          <div class="row g-2">
            <div class="col-md-8">
              <label class="form-label small mb-1">活動名稱</label>
              <input class="form-control form-control-sm" id="actName" value="${a.name||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">日期</label>
              <input type="date" class="form-control form-control-sm" id="actDate" value="${a.date||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">類型</label>
              <input class="form-control form-control-sm" id="actType" value="${a.type||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">狀態</label>
              <select class="form-select form-select-sm" id="actStatus">
                <option value="草稿" ${a.status==='草稿'?'selected':''}>草稿</option>
                <option value="開放中" ${a.status==='開放中'?'selected':''}>開放中</option>
                <option value="結束" ${a.status==='結束'?'selected':''}>結束</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">費用</label>
              <input type="number" class="form-control form-control-sm" id="actFee" value="${a.fee||0}">
            </div>
            <div class="col-12">
              <label class="form-label small mb-1">說明</label>
              <textarea class="form-control form-control-sm" id="actDesc">${a.description||''}</textarea>
            </div>
          </div>
        `, ()=>{
          a.name=document.getElementById('actName').value.trim();
          a.date=document.getElementById('actDate').value;
          a.type=document.getElementById('actType').value.trim();
          a.status=document.getElementById('actStatus').value;
          a.fee=Number(document.getElementById('actFee').value||0);
          a.description=document.getElementById('actDesc').value.trim();
          a.updatedAt=new Date().toISOString();
          Store.save();
          this.renderGrid();
          Util.showToast('success','已更新活動');
        });
      },
      remove(id){
        Util.confirm('刪除確認','確定刪除此活動？',()=>{
          const i=Store.data.activities.findIndex(x=>x.id===id);
          if(i>=0){
            Store.data.activities.splice(i,1);
            Store.save();
            this.renderGrid();
            Util.showToast('success','已刪除');
          }
        });
      },
      renderGrid(){
        const wrap=document.getElementById('activitiesGrid');
        const search=document.getElementById('activitySearch').value.trim().toLowerCase();
        const list=[...Store.data.activities].sort((a,b)=> (a.date||'').localeCompare(b.date||''));
        const filtered=list.filter(a=>{
          if(!search) return true;
          return (a.name||'').toLowerCase().includes(search) ||
                 (a.type||'').toLowerCase().includes(search) ||
                 (a.description||'').toLowerCase().includes(search);
        });
        wrap.innerHTML=filtered.map(a=>`
          <div class="col-md-4">
            <div class="border rounded p-2 h-100 d-flex flex-column">
              <div class="d-flex justify-content-between">
                <strong>${a.name||''}</strong>
                <span class="badge ${a.status==='開放中'?'bg-success':'bg-secondary'}">${a.status||''}</span>
              </div>
              <div class="small text-fade mt-1"><i class="bi bi-calendar-event"></i> ${a.date||''}</div>
              <div class="small mt-2 flex-grow-1">${(a.description||'').slice(0,120)}</div>
              <div class="mt-2 d-flex justify-content-between align-items-center">
                <span class="small text-fade">費用：${Util.fmtMoney(a.fee||0)}</span>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-secondary" onclick="Activities.edit('${a.id}')"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-outline-danger" onclick="Activities.remove('${a.id}')"><i class="bi bi-trash"></i></button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }
    };

    /**********************
     * 公告
     **********************/
    const Announcements = {
      openNew(){
        const id=Util.uuid();
        Modals.open('新增公告', `
          <div class="row g-2">
            <div class="col-md-8">
              <label class="form-label small mb-1">標題</label>
              <input class="form-control form-control-sm" id="annTitle">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">狀態</label>
              <select class="form-select form-select-sm" id="annStatus">
                <option value="草稿">草稿</option>
                <option value="發布">發布</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label small mb-1">內容</label>
              <textarea class="form-control form-control-sm" id="annContent"></textarea>
            </div>
          </div>
        `, ()=>{
          Store.data.announcements.push({
            id,
            title: document.getElementById('annTitle').value.trim(),
            status: document.getElementById('annStatus').value,
            content: document.getElementById('annContent').value.trim(),
            publishDate: Util.today(),
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            pinned:false
          });
          Store.save();
          this.render();
          Util.showToast('success','已新增公告');
        });
      },
      edit(id){
        const a=Store.data.announcements.find(x=>x.id===id);
        if(!a) return;
        Modals.open('編輯公告', `
          <div class="row g-2">
            <div class="col-md-8">
              <label class="form-label small mb-1">標題</label>
              <input class="form-control form-control-sm" id="annTitle" value="${a.title||''}">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">狀態</label>
              <select class="form-select form-select-sm" id="annStatus">
                <option value="草稿" ${a.status==='草稿'?'selected':''}>草稿</option>
                <option value="發布" ${a.status==='發布'?'selected':''}>發布</option>
              </select>
            </div>
            <div class="col-12 form-check">
              <input type="checkbox" class="form-check-input" id="annPinned" ${a.pinned?'checked':''}>
              <label class="form-check-label small" for="annPinned">置頂</label>
            </div>
            <div class="col-12">
              <label class="form-label small mb-1">內容</label>
              <textarea class="form-control form-control-sm" id="annContent">${a.content||''}</textarea>
            </div>
          </div>
        `, ()=>{
          a.title=document.getElementById('annTitle').value.trim();
          a.status=document.getElementById('annStatus').value;
          a.content=document.getElementById('annContent').value.trim();
          a.pinned=document.getElementById('annPinned').checked;
          a.updatedAt=new Date().toISOString();
          Store.save();
          this.render();
          Util.showToast('success','已更新公告');
        });
      },
      remove(id){
        Util.confirm('刪除確認','確定刪除此公告？',()=>{
          const i=Store.data.announcements.findIndex(x=>x.id===id);
          if(i>=0){
            Store.data.announcements.splice(i,1);
            Store.save();
            this.render();
            Util.showToast('success','已刪除');
          }
        });
      },
      render(){
        const list=document.getElementById('announcementsList');
        const arr=[...Store.data.announcements].sort((a,b)=>{
          if(a.pinned && !b.pinned) return -1;
          if(!a.pinned && b.pinned) return 1;
          return (b.publishDate||'').localeCompare(a.publishDate||'');
        });
        list.innerHTML=arr.map(a=>`
          <div class="col-md-4">
            <div class="border rounded p-2 h-100 d-flex flex-column">
              <div class="d-flex justify-content-between">
                <strong>${a.title||''}</strong>
                <div>
                  ${a.pinned?'<span class="badge bg-warning text-dark">置頂</span>':''}
                  <span class="badge ${a.status==='發布'?'bg-success':'bg-secondary'}">${a.status}</span>
                </div>
              </div>
              <div class="small text-fade mt-1">${a.publishDate||''}</div>
              <div class="small mt-2 flex-grow-1">${(a.content||'').slice(0,120)}</div>
              <div class="mt-2 text-end">
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-secondary" onclick="Announcements.edit('${a.id}')"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-outline-danger" onclick="Announcements.remove('${a.id}')"><i class="bi bi-trash"></i></button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }
    };

    /**********************
     * 表單
     **********************/
    const Forms = {
      openNew(){
        const id=Util.uuid();
        Modals.open('新增表單', `
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label small mb-1">名稱</label>
              <input class="form-control form-control-sm" id="formName">
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">分類</label>
              <input class="form-control form-control-sm" id="formCategory">
            </div>
            <div class="col-12">
              <label class="form-label small mb-1">URL</label>
              <input class="form-control form-control-sm" id="formUrl" placeholder="https://...">
            </div>
            <div class="col-12">
              <label class="form-label small mb-1">描述</label>
              <textarea class="form-control form-control-sm" id="formDesc"></textarea>
            </div>
          </div>
        `, ()=>{
          Store.data.forms.push({
            id,
            name: document.getElementById('formName').value.trim(),
            category: document.getElementById('formCategory').value.trim(),
            url: document.getElementById('formUrl').value.trim(),
            description: document.getElementById('formDesc').value.trim(),
            keywords: [],
            active:true,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          });
          Store.save();
          this.render();
          Util.showToast('success','已新增表單');
        });
      },
      edit(id){
        const f=Store.data.forms.find(x=>x.id===id);
        if(!f) return;
        Modals.open('編輯表單', `
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label small mb-1">名稱</label>
              <input class="form-control form-control-sm" id="formName" value="${f.name||''}">
            </div>
            <div class="col-md-6">
              <label class="form-label small mb-1">分類</label>
              <input class="form-control form-control-sm" id="formCategory" value="${f.category||''}">
            </div>
            <div class="col-12">
              <label class="form-label small mb-1">URL</label>
              <input class="form-control form-control-sm" id="formUrl" value="${f.url||''}">
            </div>
            <div class="col-12">
              <label class="form-label small mb-1">描述</label>
              <textarea class="form-control form-control-sm" id="formDesc">${f.description||''}</textarea>
            </div>
            <div class="col-12 form-check">
              <input type="checkbox" class="form-check-input" id="formActive" ${f.active?'checked':''}>
              <label class="form-check-label small" for="formActive">啟用</label>
            </div>
          </div>
        `, ()=>{
          f.name=document.getElementById('formName').value.trim();
          f.category=document.getElementById('formCategory').value.trim();
          f.url=document.getElementById('formUrl').value.trim();
          f.description=document.getElementById('formDesc').value.trim();
          f.active=document.getElementById('formActive').checked;
          f.updatedAt=new Date().toISOString();
          Store.save();
          this.render();
          Util.showToast('success','已更新表單');
        });
      },
      remove(id){
        Util.confirm('刪除確認','確定刪除此表單？',()=>{
          const i=Store.data.forms.findIndex(x=>x.id===id);
          if(i>=0){
            Store.data.forms.splice(i,1);
            Store.save();
            this.render();
            Util.showToast('success','已刪除');
          }
        });
      },
      render(){
        const wrap=document.getElementById('formsList');
        const search=document.getElementById('formsSearch').value.trim().toLowerCase();
        const arr=[...Store.data.forms].sort((a,b)=>(a.name||'').localeCompare(b.name||''));
        const filtered=arr.filter(f=>{
          if(!search) return true;
          return (f.name||'').toLowerCase().includes(search) ||
                 (f.category||'').toLowerCase().includes(search) ||
                 (f.description||'').toLowerCase().includes(search);
        });
        wrap.innerHTML=filtered.map(f=>`
          <div class="col-md-4">
            <div class="border rounded p-2 h-100 d-flex flex-column">
              <div class="d-flex justify-content-between">
                <strong>${f.name||''}</strong>
                ${f.active?'<span class="badge bg-success">啟用</span>':'<span class="badge bg-secondary">停用</span>'}
              </div>
              <div class="small text-fade mt-1">${f.category||''}</div>
              <div class="small mt-2 flex-grow-1">${(f.description||'').slice(0,120)}</div>
              <div class="mt-2 d-flex justify-content-between align-items-center">
                <a href="${f.url||'#'}" target="_blank" class="small text-primary">${f.url?'<i class="bi bi-box-arrow-up-right"></i> 開啟':''}</a>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-secondary" onclick="Forms.edit('${f.id}')"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-outline-danger" onclick="Forms.remove('${f.id}')"><i class="bi bi-trash"></i></button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }
    };

    /**********************
     * 預覽
     **********************/
    const Preview = {
      refresh(){
        const pre=document.getElementById('jsonPreview');
        pre.textContent=JSON.stringify(Store.data,null,2);
      }
    };

    /**********************
     * 設定
     **********************/
    const Settings = {
      open(){
        document.getElementById('settingOrgName').value = Store.data.settings.organizationName||'';
        document.getElementById('settingDefaultFee').value = Store.data.settings.defaultMembershipFee||1000;
        document.getElementById('settingEnableSync').checked = !!Store.data.settings.googleSyncEnabled;
        Util.modal('settingsModal').show();
      },
      save(){
        Store.data.settings.organizationName=document.getElementById('settingOrgName').value.trim();
        Store.data.settings.defaultMembershipFee=Number(document.getElementById('settingDefaultFee').value||0);
        Store.data.settings.googleSyncEnabled=document.getElementById('settingEnableSync').checked;
        Store.save();
        Util.showToast('success','設定已儲存');
        GoogleSync._updateStatus();
        Util.modal('settingsModal').hide();
        if(Store.data.settings.googleSyncEnabled){
          GoogleSync.fetchLatest(true);
        }
      }
    };

    const SyncSettings = {
      toggleSync(on){
        Store.data.settings.googleSyncEnabled=on;
        Store.save();
        GoogleSync._updateStatus();
        if(on){
          GoogleSync.fetchLatest(true);
        }
      }
    };

    /**********************
     * Modals Helper
     **********************/
    const Modals = {
      open(title, html, onSave){
        const modalEl=document.getElementById('genericModal');
        document.getElementById('genericModalTitle').innerHTML=title;
        document.getElementById('genericModalBody').innerHTML=html;
        const saveBtn=document.getElementById('genericModalSaveBtn');
        if(onSave){
          saveBtn.classList.remove('d-none');
          saveBtn.onclick=()=>{
            onSave();
            bootstrap.Modal.getOrCreateInstance(modalEl).hide();
          };
        } else {
          saveBtn.classList.add('d-none');
          saveBtn.onclick=null;
        }
        bootstrap.Modal.getOrCreateInstance(modalEl).show();
      },
      close(){
        bootstrap.Modal.getOrCreateInstance(document.getElementById('genericModal')).hide();
      },
      openSettings(){
        Settings.open();
      },
      confirmClearLocal(){
        Util.confirm('清空確認','確定刪除本機所有資料？<br>（不會影響伺服器）',()=>{
          Store.clear();
          Dashboard.refresh();
          Transactions.renderTable();
          Members.renderTable();
          Accounts.renderTable();
          Activities.renderGrid();
          Announcements.render();
          Forms.render();
          Preview.refresh();
          Util.showToast('success','本機已清空');
        });
      }
    };

    /**********************
     * 事件 / 導航
     **********************/
    function initTabs(){
      document.querySelectorAll('#mainTabs .nav-link').forEach(btn=>{
        btn.addEventListener('click',()=>{
          document.querySelectorAll('#mainTabs .nav-link').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const target=btn.getAttribute('data-target');
          document.querySelectorAll('.section').forEach(sec=>{
            sec.classList.toggle('active', sec.id===target);
          });
          if(target==='backupSection') Preview.refresh();
        });
      });
    }

    /**********************
     * 初始化
     **********************/
    function initDemoSeedIfEmpty(){
      if(Store.data.transactions.length===0){
        // Demo seed
        const now=new Date();
        for(let i=0;i<5;i++){
          Store.data.transactions.push({
            id:Util.uuid(),
            date:new Date(now.getTime()-i*86400000).toISOString().slice(0,10),
            type:i%2===0?'收入':'支出',
            category:i%2===0?'會費':'活動費用',
            amount:i%2===0?2000: -1500,
            counterparty:'Demo '+(i+1),
            account:'現金',
            description:'初始化示例 '+(i+1),
            receiptNumber:'R000'+i,
            voucherNumber:'V000'+i,
            createdAt:new Date().toISOString(),
            updatedAt:new Date().toISOString(),
            vouchers:[]
          });
        }
        Store.data.members.push({
          id:Util.uuid(), name:'王小明', phone:'0912xxx000', email:'demo@example.com',
          status:'正常', joinDate:Util.today(), tags:['理事'], createdAt:new Date().toISOString(), updatedAt:new Date().toISOString()
        });
        Store.data.accounts.push({
          id:Util.uuid(), name:'現金', description:'一般現金帳戶', initialBalance:0, currentBalance:5000,
          active:true, createdAt:new Date().toISOString(), updatedAt:new Date().toISOString()
        });
        Store.data.activities.push({
          id:Util.uuid(), name:'健康講座', date:Util.today(), type:'講座', status:'開放中',
          fee:0, description:'關於疾病照護與交流', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString()
        });
        Store.data.forms.push({
          id:Util.uuid(), name:'活動報名表', category:'活動', url:'https://example.com/form',
          description:'示例表單', keywords:['活動'], active:true, createdAt:new Date().toISOString(), updatedAt:new Date().toISOString()
        });
        Store.save();
      }
    }

    function init(){
      Store.load();
      initDemoSeedIfEmpty();
      initTabs();
      // 初始渲染
      Dashboard.refresh();
      Transactions.renderTable();
      Members.renderTable();
      Accounts.renderTable();
      Activities.renderGrid();
      Announcements.render();
      Forms.render();
      Preview.refresh();
      document.getElementById('syncEnabledSwitch').checked = !!Store.data.settings.googleSyncEnabled;
      GoogleSync._updateStatus();
      if(Store.data.settings.googleSyncEnabled && REMOTE_SYNC.AUTO_PULL_ON_LOAD){
        GoogleSync.fetchLatest(false);
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
