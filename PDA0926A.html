
<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>帕金森病友會管理系統</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes,maximum-scale=3.0">
<link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AOAgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AOAgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/////wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AOAgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AP///wDgICD/4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AP///wD///8A4CAg/+AgIP/gICD/4CAg/+AgIP/gICD/4CAg/+AgIP////8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:rgba(76,175,80,0.3)}
  :root{--primary-color:#4CAF50;--primary-dark:#45a049;--secondary-color:#2196F3;--danger-color:#f44336;--warning-color:#ff9800;--success-color:#4CAF50;--info-color:#2196F3;--light-bg:#f8f9fa;--white:#ffffff;--text-primary:#212529;--text-secondary:#6c757d;--border-color:#dee2e6;--shadow:0 2px 10px rgba(0,0,0,0.1);--shadow-hover:0 4px 20px rgba(0,0,0,0.15)}
  body{font-family:'Microsoft JhengHei','PingFang TC','Helvetica Neue',Arial,sans-serif;font-size:18px;line-height:1.6;color:var(--text-primary);background:linear-gradient(135deg,#e3f2fd 0%,#f3e5f5 100%);min-height:100vh;padding:0;margin:0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  .app-container{max-width:100%;min-height:100vh;background:var(--white);position:relative;overflow-x:hidden;padding-top:env(safe-area-inset-top)}
  .app-header{background:linear-gradient(135deg,var(--primary-color) 0%,var(--primary-dark) 100%);color:#fff;padding:20px 15px 15px;position:sticky;top:0;z-index:1000;box-shadow:var(--shadow)}
  .app-header h1{font-size:24px;font-weight:700;margin:0 0 8px;text-align:center}
  .app-header .subtitle{font-size:16px;text-align:center;opacity:.9;margin:0}
  .user-info{background:rgba(255,255,255,0.15);border-radius:15px;padding:12px 15px;margin-top:15px;display:flex;align-items:center;gap:12px}
  .user-avatar{width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:600;color:#fff;border:2px solid rgba(255,255,255,0.3)}
  .user-details{flex:1}
  .user-name{font-size:18px;font-weight:600;margin:0;color:#fff}
  .user-role{font-size:14px;opacity:.8;margin:0;color:#fff}
  .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--white);border-top:1px solid var(--border-color);padding:8px 0 calc(8px + env(safe-area-inset-bottom));z-index:1000;box-shadow:0 -2px 10px rgba(0,0,0,0.1)}
  .nav-items{display:flex;justify-content:space-around;align-items:center;max-width:100%;margin:0 auto}
  .nav-item{display:flex;flex-direction:column;align-items:center;padding:8px 4px;text-decoration:none;color:var(--text-secondary);transition:all .3s ease;border-radius:12px;min-width:60px;cursor:pointer;border:none;background:none}
  .nav-item.active{color:var(--primary-color);background:rgba(76,175,80,0.1)}
  .nav-item i{font-size:24px;margin-bottom:4px}
  .nav-item span{font-size:12px;font-weight:500;text-align:center;line-height:1.2}
  .main-content{padding:20px 15px 100px;min-height:calc(100vh - 180px)}
  .content-section{display:none}
  .content-section.active{display:block}
  .card{background:var(--white);border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:var(--shadow);border:none}
  .card-title{font-size:20px;font-weight:700;color:var(--text-primary);margin:0 0 15px;display:flex;align-items:center;gap:10px}
  .card-text{font-size:16px;color:var(--text-secondary);margin:0 0 15px;line-height:1.5}
  .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:25px}
  .stat-card{background:linear-gradient(135deg,var(--primary-color),var(--primary-dark));color:#fff;padding:20px;border-radius:16px;text-align:center;box-shadow:var(--shadow)}
  .stat-card.secondary{background:linear-gradient(135deg,var(--secondary-color),#1976D2)}
  .stat-card.warning{background:linear-gradient(135deg,var(--warning-color),#f57c00)}
  .stat-card.danger{background:linear-gradient(135deg,var(--danger-color),#d32f2f)}
  .stat-number{font-size:28px;font-weight:700;margin:0 0 5px}
  .stat-label{font-size:14px;opacity:.9;margin:0}
  .btn{font-size:18px;font-weight:600;padding:15px 25px;border-radius:12px;border:none;cursor:pointer;transition:all .3s ease;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:8px;min-height:50px;touch-action:manipulation}
  .btn-primary{background:linear-gradient(135deg,var(--primary-color),var(--primary-dark));color:#fff}
  .btn-primary:hover,.btn-primary:active{background:linear-gradient(135deg,var(--primary-dark),#3d8b40);transform:translateY(-2px);box-shadow:var(--shadow-hover)}
  .btn-secondary{background:#6c757d;color:#fff}
  .btn-success{background:linear-gradient(135deg,var(--success-color),var(--primary-dark));color:#fff}
  .btn-danger{background:linear-gradient(135deg,var(--danger-color),#d32f2f);color:#fff}
  .btn-warning{background:linear-gradient(135deg,var(--warning-color),#f57c00);color:#fff}
  .btn-outline-primary{background:transparent;color:var(--primary-color);border:2px solid var(--primary-color)}
  .btn-block{width:100%;margin-bottom:15px}
  .form-group{margin-bottom:20px}
  .form-label{font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:8px;display:block}
  .form-control,.form-select{font-size:18px;padding:15px;border:2px solid var(--border-color);border-radius:12px;background:var(--white);color:var(--text-primary);width:100%;transition:border-color .3s ease;min-height:50px}
  .form-control:focus,.form-select:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(76,175,80,0.1)}
  textarea.form-control{min-height:120px;resize:vertical}
  .activity-item{background:var(--white);border-radius:16px;padding:20px;margin-bottom:15px;box-shadow:var(--shadow);border-left:4px solid var(--primary-color);transition:all .3s ease}
  .activity-item:active{transform:scale(0.98)}
  .activity-title{font-size:18px;font-weight:700;color:var(--text-primary);margin:0 0 10px}
  .activity-meta{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:10px;font-size:14px;color:var(--text-secondary)}
  .activity-meta span{display:flex;align-items:center;gap:5px}
  .activity-description{font-size:16px;color:var(--text-secondary);margin-bottom:15px;line-height:1.5}
  .status-badge{display:inline-block;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
  .status-開放報名,.status-active{background:#d4edda;color:#155724}
  .status-已報名{background:#d1ecf1;color:#0c5460}
  .status-已取消,.status-已拒絕{background:#f8d7da;color:#721c24}
  .status-已完成{background:#e2e3ff;color:#383d41}
  .status-報名截止,.status-待審核{background:#fff3cd;color:#856404}
  .notification{position:fixed;top:20px;left:15px;right:15px;background:var(--white);padding:15px 20px;border-radius:12px;box-shadow:var(--shadow-hover);z-index:2000;transform:translateY(-100px);opacity:0;transition:all .4s ease}
  .notification.show{transform:translateY(0);opacity:1}
  .notification.success{border-left:4px solid var(--success-color);background:#d4edda;color:#155724}
  .notification.error{border-left:4px solid var(--danger-color);background:#f8d7da;color:#721c24}
  .notification.warning{border-left:4px solid var(--warning-color);background:#fff3cd;color:#856404}
  .loading{text-align:center;padding:40px 20px;color:var(--text-secondary)}
  .spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .modal-content{border-radius:20px;border:none;box-shadow:var(--shadow-hover)}
  .modal-header{border-bottom:1px solid var(--border-color);padding:20px}
  .modal-title{font-size:20px;font-weight:700}
  .modal-body{padding:20px}
  .modal-footer{border-top:1px solid var(--border-color);padding:20px;gap:10px}
  .quick-actions{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:25px}
  .quick-action-btn{background:var(--white);border:2px solid var(--border-color);border-radius:16px;padding:20px;text-align:center;text-decoration:none;color:var(--text-primary);transition:all .3s ease;cursor:pointer;min-height:100px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px}
  .quick-action-btn:hover,.quick-action-btn:active{border-color:var(--primary-color);color:var(--primary-color);background:rgba(76,175,80,0.05);transform:translateY(-2px)}
  .quick-action-btn i{font-size:32px}
  .quick-action-btn span{font-size:14px;font-weight:600}
  @media (max-width:576px){.stats-grid{grid-template-columns:1fr}.activity-meta{flex-direction:column;gap:8px}.quick-actions{grid-template-columns:1fr}}
  @media (prefers-reduced-motion:reduce){*{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}}
  @media (prefers-contrast:high){.card{border:2px solid var(--text-primary)}.btn{border:2px solid currentColor}}
  .admin-only{display:none}
  .empty-state{text-align:center;padding:40px 20px;color:var(--text-secondary)}
  .empty-state i{font-size:48px;margin-bottom:15px;opacity:.5}
  .empty-state h5{font-size:18px;margin-bottom:10px}
  .empty-state p{font-size:16px;margin:0}
  .amount{font-weight:700;font-size:18px}
  .amount.positive{color:var(--success-color)}
  .amount.negative{color:var(--danger-color)}
  .rating{color:#ffc107;font-size:18px;margin:5px 0}
  .bottom-nav{padding-bottom:calc(8px + env(safe-area-inset-bottom))}
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">
    <h1><i class="bi bi-hospital"></i> 帕金森病友會</h1>
    <p class="subtitle">關懷、支持、共同成長</p>
    <div id="userInfo" class="user-info" style="display:none;">
      <div class="user-avatar" id="userAvatar">?</div>
      <div class="user-details">
        <div class="user-name" id="userName">載入中...</div>
        <div class="user-role" id="userRole">會員</div>
      </div>
      <button class="btn btn-sm" onclick="refreshData()" style="background:rgba(255,255,255,0.2);color:white;padding:8px 12px;font-size:14px;">
        <i class="bi bi-arrow-clockwise"></i>
      </button>
    </div>
  </div>

  <div id="notificationContainer"></div>

  <div class="main-content">
    <div class="content-section active" id="home">
      <div class="card">
        <div class="card-title">
          <i class="bi bi-house-heart"></i>
          歡迎回來
        </div>
        <div class="card-text">
          歡迎使用帕金森病友會管理系統！這裡是您的個人化控制中心。
        </div>
      </div>

      <div class="quick-actions">
        <div class="quick-action-btn" onclick="switchTab('profile')">
          <i class="bi bi-person-check"></i>
          <span>個人資料</span>
        </div>
        <div class="quick-action-btn" onclick="switchTab('activities')">
          <i class="bi bi-calendar-plus"></i>
          <span>活動報名</span>
        </div>
        <div class="quick-action-btn" onclick="showDonationModal()">
          <i class="bi bi-heart-fill"></i>
          <span>愛心捐款</span>
        </div>
        <div class="quick-action-btn" onclick="switchTab('volunteer')">
          <i class="bi bi-hand-thumbs-up"></i>
          <span>志工服務</span>
        </div>
      </div>

      <div class="stats-grid" id="homeStats">
        <div class="stat-card">
          <div class="stat-number" id="totalActivities">0</div>
          <div class="stat-label">可報名活動</div>
        </div>
        <div class="stat-card secondary">
          <div class="stat-number" id="myRegistrations">0</div>
          <div class="stat-label">我的報名</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-number" id="volunteerHours">0</div>
          <div class="stat-label">志工時數</div>
        </div>
        <div class="stat-card danger">
          <div class="stat-number" id="donationAmount">0</div>
          <div class="stat-label">捐款金額</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <i class="bi bi-clock-history"></i>
          最近活動
        </div>
        <div id="recentActivity">
          <div class="loading">
            <div class="spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="content-section" id="profile">
      <div class="card">
        <div class="card-title">
          <i class="bi bi-person"></i>
          個人資料
        </div>
        <div class="card-text">
          管理您的個人資料，確保資訊正確完整。
        </div>
      </div>

      <div id="registrationSection" class="card">
        <div class="card-title" style="color: var(--info-color);">
          <i class="bi bi-person-plus"></i>
          完成註冊
        </div>
        <div class="card-text">
          請先完成註冊以使用完整功能。
        </div>
        <form id="registrationForm">
          <div class="form-group">
            <label class="form-label" for="realName">真實姓名 *</label>
            <input type="text" class="form-control" id="realName" name="realName" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="memberType">會員類別 *</label>
            <select class="form-select" id="memberType" name="memberType" required>
              <option value="">請選擇</option>
              <option value="病友">病友</option>
              <option value="家屬">家屬</option>
              <option value="志工">志工</option>
              <option value="醫護">醫護人員</option>
              <option value="支持者">支持者</option>
            </select>
          </div>
          <button class="btn btn-primary btn-block" type="submit">
            <i class="bi bi-check-circle"></i>
            完成註冊
          </button>
        </form>
      </div>

      <div id="profileSection" class="card" style="display:none;">
        <form id="profileForm">
          <div class="form-group">
            <label class="form-label" for="profileRealName">真實姓名</label>
            <input type="text" class="form-control" id="profileRealName" name="profileRealName" readonly>
          </div>
          <div class="form-group">
            <label class="form-label" for="phone">聯絡電話</label>
            <input type="tel" class="form-control" id="phone" name="phone">
          </div>
          <div class="form-group">
            <label class="form-label" for="email">電子郵件</label>
            <input type="email" class="form-control" id="email" name="email">
          </div>
          <div class="form-group">
            <label class="form-label" for="birthday">生日</label>
            <input type="date" class="form-control" id="birthday" name="birthday">
          </div>
          <div class="form-group">
            <label class="form-label" for="profileMemberType">會員類別</label>
            <select class="form-select" id="profileMemberType" name="memberType">
              <option value="病友">病友</option>
              <option value="家屬">家屬</option>
              <option value="志工">志工</option>
              <option value="醫護">醫護人員</option>
              <option value="支持者">支持者</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="address">通訊地址</label>
            <textarea class="form-control" id="address" name="address"></textarea>
          </div>
          <button class="btn btn-primary btn-block" type="submit">
            <i class="bi bi-save"></i>
            更新資料
          </button>
        </form>
      </div>
    </div>

    <div class="content-section" id="activities">
      <div class="card">
        <div class="card-title">
          <i class="bi bi-calendar-event"></i>
          活動管理
        </div>
        <div class="card-text">
          參與我們精心安排的各種活動，與病友們一起學習成長。
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <i class="bi bi-search"></i>
          搜尋活動
        </div>
        <div class="form-group">
          <label class="form-label" for="activityStatusFilter">狀態篩選</label>
          <select class="form-select" id="activityStatusFilter">
            <option value="">全部狀態</option>
            <option value="開放報名">開放報名</option>
            <option value="報名截止">報名截止</option>
            <option value="進行中">進行中</option>
            <option value="已結束">已結束</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="activityDateFilter">日期篩選</label>
          <input type="date" class="form-control" id="activityDateFilter">
        </div>
        <button class="btn btn-primary btn-block" onclick="filterActivities()">
          <i class="bi bi-search"></i>
          搜尋活動
        </button>
      </div>

      <div id="activitiesList">
        <div class="loading">
          <div class="spinner"></div>
          <p>載入活動中...</p>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <i class="bi bi-clipboard-check"></i>
          我的報名記錄
        </div>
        <div id="myRegistrations">
          <div class="loading">
            <div class="spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="content-section" id="volunteer">
      <div class="card">
        <div class="card-title">
          <i class="bi bi-heart"></i>
          志工服務
        </div>
        <div class="card-text">
          加入我們的志工行列，用愛心和行動幫助更多需要的人。
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="myVolunteerHours">0</div>
          <div class="stat-label">服務時數</div>
        </div>
        <div class="stat-card secondary">
          <div class="stat-number" id="volunteerActivities">0</div>
          <div class="stat-label">參與次數</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-number" id="volunteerRank">-</div>
          <div class="stat-label">志工排名</div>
        </div>
        <div class="stat-card danger">
          <div class="stat-number" id="availableNeeds">0</div>
          <div class="stat-label">可報名需求</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <i class="bi bi-exclamation-circle"></i>
          志工需求
        </div>
      <div id="volunteerNeeds">
          <div class="loading">
            <div class="spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <i class="bi bi-journal-text"></i>
          我的志工記錄
        </div>
        <div id="myVolunteerRecords">
          <div class="loading">
            <div class="spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="content-section" id="finance">
      <div class="card">
        <div class="card-title">
          <i class="bi bi-cash-coin"></i>
        財務管理
        </div>
        <div class="card-text">
          您的每一份愛心都將用於支持病友會的各項服務和活動。
        </div>
      </div>

      <div class="quick-actions">
        <div class="quick-action-btn" onclick="showDonationModal()">
          <i class="bi bi-heart-fill"></i>
          <span>愛心捐款</span>
        </div>
        <div class="quick-action-btn" onclick="showExpenseModal()">
          <i class="bi bi-receipt"></i>
          <span>支出申請</span>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="myDonationAmount">NT$ 0</div>
          <div class="stat-label">捐款總額</div>
        </div>
        <div class="stat-card secondary">
          <div class="stat-number" id="myDonationCount">0</div>
          <div class="stat-label">捐款次數</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-number" id="myExpenseAmount">NT$ 0</div>
          <div class="stat-label">支出申請額</div>
        </div>
        <div class="stat-card danger">
          <div class="stat-number" id="pendingExpenses">0</div>
          <div class="stat-label">待審核</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <i class="bi bi-heart-fill"></i>
          我的捐款記錄
        </div>
        <div id="donationHistory">
          <div class="loading">
            <div class="spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <i class="bi bi-receipt"></i>
          我的支出申請
        </div>
        <div id="expenseHistory">
          <div class="loading">
            <div class="spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="content-section" id="feedback">
      <div class="card">
        <div class="card-title">
          <i class="bi bi-chat-dots"></i>
          活動回饋
        </div>
        <div class="card-text">
          分享您的活動體驗，幫助我們提供更好的服務。
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <i class="bi bi-plus-circle"></i>
          新增回饋
        </div>
        <form id="feedbackForm">
          <div class="form-group">
            <label class="form-label" for="feedbackActivity">選擇活動 *</label>
            <select class="form-select" id="feedbackActivity" name="feedbackActivity" required>
              <option value="">請選擇活動</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="feedbackRating">評分 *</label>
            <select class="form-select" id="feedbackRating" name="feedbackRating" required>
              <option value="">請選擇評分</option>
              <option value="5">⭐⭐⭐⭐⭐ 非常滿意</option>
              <option value="4">⭐⭐⭐⭐ 滿意</option>
              <option value="3">⭐⭐⭐ 普通</option>
              <option value="2">⭐⭐ 不滿意</option>
              <option value="1">⭐ 非常不滿意</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="feedbackComment">意見與建議 *</label>
            <textarea class="form-control" id="feedbackComment" name="feedbackComment" required placeholder="請分享您的想法..."></textarea>
          </div>
          <button class="btn btn-primary btn-block" type="submit">
            <i class="bi bi-send"></i>
            提交回饋
          </button>
        </form>
      </div>

      <div class="card">
        <div class="card-title">
          <i class="bi bi-chat-left-text"></i>
          我的回饋記錄
        </div>
        <div id="myFeedback">
          <div class="loading">
            <div class="spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="bottom-nav">
    <div class="nav-items">
      <button class="nav-item active" data-tab="home" onclick="switchTab('home')">
        <i class="bi bi-house"></i>
        <span>首頁</span>
      </button>
      <button class="nav-item" data-tab="activities" onclick="switchTab('activities')">
        <i class="bi bi-calendar-event"></i>
        <span>活動</span>
      </button>
      <button class="nav-item" data-tab="volunteer" onclick="switchTab('volunteer')">
        <i class="bi bi-heart"></i>
        <span>志工</span>
      </button>
      <button class="nav-item" data-tab="finance" onclick="switchTab('finance')">
        <i class="bi bi-cash-coin"></i>
        <span>財務</span>
      </button>
      <button class="nav-item" data-tab="profile" onclick="switchTab('profile')">
        <i class="bi bi-person"></i>
        <span>個人</span>
      </button>
    </div>
  </div>

  <div id="modalContainer"></div>
</div>

<script>
  const CONFIG = {
    LIFF_ID: '1656516134-k8rMQwnQ',
    API_BASE_URL: 'https://script.google.com/macros/s/AKfycbwXtuht4jBDbt9TFiRSLfexODoT9DaIkxBHsNg1RHTSyxuBnumQ8gf3eKHUgh29bCKu/exec',
    API_KEY: 'AAbb8520258185202581'
  };

  let userProfile = null;
  let currentUser = null;
  let isAdmin = false;
  let allActivities = [];
  let currentTab = 'home';

  const isValidDate = (d) => d && Object.prototype.toString.call(d) === '[object Date]' && !isNaN(d.getTime());

  const toDateObj = (v) => {
    if (!v) return null;
    if (v instanceof Date) return isValidDate(v) ? v : null;
    const d = new Date(v);
    return isValidDate(d) ? d : null;
  };

  const formatDate = (d) => {
    const dt = toDateObj(d);
    return dt ? dt.toLocaleDateString('zh-TW') : '-';
  };

  const formatDateTime = (d) => {
    const dt = toDateObj(d);
    return dt ? dt.toLocaleString('zh-TW') : '-';
  };

  const formatCurrency = (n) =>
    new Intl.NumberFormat('zh-TW',{style:'currency',currency:'TWD',minimumFractionDigits:0}).format(Number(n)||0);

  function showNotification(msg, type = 'success', ms = 3000) {
    const wrap = document.getElementById('notificationContainer');
    const el = document.createElement('div');
    el.className = `notification ${type}`;
    el.innerHTML = `
      <div class="d-flex justify-content-between align-items-start">
        <span style="font-size: 16px; font-weight: 500;">${msg}</span>
        <button style="background:none;border:none;font-size:20px;line-height:1;margin-left:10px;" onclick="this.closest('.notification').remove()">&times;</button>
      </div>`;
    wrap.appendChild(el);
    requestAnimationFrame(() => el.classList.add('show'));
    setTimeout(() => {
      el.classList.remove('show');
      setTimeout(() => el.remove(), 350);
    }, ms);
  }

  function setButtonLoading(btn, loading = true) {
    if (!btn) return;
    if (loading) {
      if (!btn.dataset.originalText) btn.dataset.originalText = btn.innerHTML;
      btn.innerHTML = '<i class="bi bi-arrow-repeat" style="animation: spin 1s linear infinite;"></i> 處理中...';
      btn.disabled = true;
    } else {
      btn.disabled = false;
      if (btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText;
    }
  }

  async function callAPI(action, data = {}, retries = 2) {
    const payload = {
      action,
      apiKey: CONFIG.API_KEY,
      timestamp: Date.now(),
      data
    };
    // 為符合既有 GAS 路由，採用扁平化 fallback
    const fallbackPayload = { action, ...data };

    let lastErr;
    for (let i = 0; i <= retries; i++) {
      try {
        const res = await fetch(CONFIG.API_BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(fallbackPayload)
        });
        const text = await res.text();
        let json;
        try { 
          json = JSON.parse(text); 
        } catch(e) { 
          throw new Error('回應非 JSON: ' + text.slice(0, 200)); 
        }
        if (json.success === false) throw new Error(json.message || 'API 錯誤');
        return json;
      } catch (err) {
        lastErr = err;
        await new Promise(r => setTimeout(r, 400 * (i + 1)));
      }
    }
    throw lastErr;
  }

  function setActiveNav(tabName){
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    const target = document.querySelector(`.nav-item[data-tab="${tabName}"]`);
    if (target) target.classList.add('active');
  }

  function switchTab(tabName) {
    document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
    const el = document.getElementById(tabName);
    if (el) el.classList.add('active');
    setActiveNav(tabName);
    currentTab = tabName;
    switch(tabName) {
      case 'home':
        loadHomeDashboard();
        break;
      case 'activities':
        loadActivities();
        loadMyRegistrations();
        break;
      case 'volunteer':
        loadVolunteerData();
        break;
      case 'finance':
        loadFinanceData();
        break;
      case 'feedback':
        loadFeedbackData();
        break;
    }
  }

  async function initializeLiff() {
    try {
      await liff.init({ liffId: CONFIG.LIFF_ID });
      if (!liff.isLoggedIn()) { 
        liff.login(); 
        return; 
      }
      userProfile = await liff.getProfile();
      const userInfo = document.getElementById('userInfo');
      userInfo.style.display = 'flex';
      document.getElementById('userName').textContent = userProfile.displayName || '會員';
      document.getElementById('userAvatar').textContent = (userProfile.displayName || '?').charAt(0);

      await loadUserData();
      await loadHomeDashboard();
      showNotification('系統初始化完成', 'success');
    } catch (err) {
      console.error(err);
      showNotification('系統初始化失敗', 'error');
    }
  }

  async function loadUserData() {
    try {
      const r = await callAPI('getUserInfo', { lineId: userProfile.userId });
      if (r.success && r.data) {
        currentUser = r.data;
        isAdmin = !!currentUser.isAdmin;
        updateUserUI();
      } else {
        showRegistrationForm();
      }
    } catch {
      showRegistrationForm();
    }
  }

  function updateUserUI() {
    if (!currentUser) return;
    document.getElementById('userName').textContent = 
      currentUser.realName || currentUser.lineName || userProfile.displayName || '會員';
    document.getElementById('userRole').textContent = currentUser.memberType || '會員';
    document.getElementById('userAvatar').textContent = 
      (currentUser.realName || currentUser.lineName || userProfile.displayName || '?').charAt(0);
    document.querySelectorAll('.admin-only').forEach(el => 
      el.style.display = isAdmin ? 'block' : 'none');
    updateProfileSection();
  }

  function showRegistrationForm() {
    document.getElementById('registrationSection').style.display = 'block';
    document.getElementById('profileSection').style.display = 'none';
  }

  function updateProfileSection() {
    if (!currentUser) return;
    document.getElementById('registrationSection').style.display = 'none';
    document.getElementById('profileSection').style.display = 'block';
    document.getElementById('profileRealName').value = currentUser.realName || '';
    document.getElementById('phone').value = currentUser.phone || '';
    document.getElementById('email').value = currentUser.email || '';
    document.getElementById('birthday').value = currentUser.birthday || '';
    document.getElementById('profileMemberType').value = currentUser.memberType || '病友';
    document.getElementById('address').value = currentUser.address || '';
  }

  document.getElementById('registrationForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const btn = e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn, true);
    try {
      await callAPI('registerUser', {
        lineId: userProfile.userId,
        lineName: userProfile.displayName,
        realName: fd.get('realName'),
        memberType: fd.get('memberType')
      });
      showNotification('註冊成功！', 'success');
      await loadUserData();
    } catch (err) {
      showNotification('註冊失敗：' + err.message, 'error');
    } finally { setButtonLoading(btn, false); }
  });

  document.getElementById('profileForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const btn = e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn, true);
    try {
      await callAPI('updateProfile', {
        lineId: userProfile.userId,
        phone: fd.get('phone'),
        email: fd.get('email'),
        birthday: fd.get('birthday'),
        memberType: fd.get('memberType'),
        address: fd.get('address')
      });
      showNotification('資料更新成功！', 'success');
      await loadUserData();
    } catch (err) {
      showNotification('更新失敗：' + err.message, 'error');
    } finally { setButtonLoading(btn, false); }
  });

  async function loadHomeDashboard() {
    try {
      // 取活動/報名概況
      const dash = await callAPI('getDashboardData', { lineId: userProfile?.userId });
      const d = dash.data || {};
      const activities = Array.isArray(d.activities) ? d.activities : [];
      const myRegs = Array.isArray(d.myRegistrations) ? d.myRegistrations : [];

      const openCount = activities.filter(a => a.status !== '已刪除' && a.status !== '已結束' && a.status !== '報名截止' ? true : a.status === '開放報名').length;
      document.getElementById('totalActivities').textContent = openCount;
      document.getElementById('myRegistrations').textContent = myRegs.length;

      // 取志工與捐款統計（使用各自 API）
      let myVolunteerHours = 0;
      try {
        const v = await callAPI('getVolunteerData', { lineId: userProfile?.userId });
        myVolunteerHours = v?.data?.stats?.totalHours || 0;
      } catch {}

      let myDonationAmount = 0;
      try {
        const f = await callAPI('getFinanceData', { lineId: userProfile?.userId });
        myDonationAmount = f?.data?.stats?.totalDonation || 0;
      } catch {}

      document.getElementById('volunteerHours').textContent = myVolunteerHours;
      document.getElementById('donationAmount').textContent = String(formatCurrency(myDonationAmount)).replace('NT$', '');

      // 最近活動（取前 5 筆未刪除活動，按日期排序）
      const recent = activities
        .filter(a => a.status !== '已刪除')
        .sort((a,b) => {
          const da = toDateObj(a.date)?.getTime() || 0;
          const db = toDateObj(b.date)?.getTime() || 0;
          return db - da;
        })
        .slice(0,5);
      renderRecentActivity(recent);
    } catch (err) {
      console.error(err);
      showNotification('載入儀表板失敗', 'error');
    }
  }

  function renderRecentActivity(list) {
    const container = document.getElementById('recentActivity');
    if (!list.length) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-calendar-x"></i>
          <h5>暫無最近活動</h5>
          <p>快去報名參加活動吧！</p>
        </div>`;
      return;
    }
    container.innerHTML = list.map(activity => `
      <div class="activity-item">
        <div class="activity-title">${activity.title || ''}</div>
        <div class="activity-meta">
          <span><i class="bi bi-calendar"></i> ${formatDate(activity.date)}</span>
        </div>
        <div class="activity-description">${activity.description || ''}</div>
        <span class="status-badge status-${(activity.status || '').trim()}">${activity.status || ''}</span>
      </div>
    `).join('');
  }

  async function loadActivities() {
    try {
      const r = await callAPI('getActivities');
      allActivities = r.data || [];
      renderActivities(allActivities);
    } catch (err) {
      document.getElementById('activitiesList').innerHTML = `
        <div class="empty-state">
          <i class="bi bi-exclamation-triangle"></i>
          <h5>載入失敗</h5>
          <p>${err.message}</p>
        </div>`;
    }
  }

  function renderActivities(list) {
    const container = document.getElementById('activitiesList');
    if (!list.length) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-calendar-x"></i>
          <h5>目前沒有活動</h5>
          <p>請稍後再來看看</p>
        </div>`;
      return;
    }
    container.innerHTML = list.map(activity => `
      <div class="activity-item">
        <div class="activity-title">${activity.title}</div>
        <div class="activity-meta">
          <span><i class="bi bi-calendar"></i> ${formatDate(activity.date)}</span>
          <span><i class="bi bi-clock"></i> ${activity.time || '-'}</span>
          <span><i class="bi bi-geo-alt"></i> ${activity.location || '-'}</span>
          <span><i class="bi bi-people"></i> ${activity.currentCount || 0}/${activity.maxParticipants || 0}</span>
        </div>
        <div class="activity-description">${activity.description || ''}</div>
        <div class="d-flex justify-content-between align-items-center mt-3">
          <span class="status-badge status-${activity.status}">${activity.status}</span>
          <div>
            <span class="amount positive">${formatCurrency(activity.fee || 0)}</span>
            ${activity.status === '開放報名' ? 
              `<button class="btn btn-primary btn-sm ms-2" onclick="registerActivity('${activity.id}')">
                <i class="bi bi-plus-circle"></i> 報名
              </button>` : ''}
          </div>
        </div>
      </div>
    `).join('');
  }

  function filterActivities() {
    const status = document.getElementById('activityStatusFilter').value.trim();
    const date = document.getElementById('activityDateFilter').value.trim();
    let filteredList = [...allActivities];
    if (status) filteredList = filteredList.filter(a => a.status === status);
    if (date) filteredList = filteredList.filter(a => (a.date || '').toString().startsWith(date));
    renderActivities(filteredList);
  }

  async function registerActivity(id) {
    if (!currentUser) { 
      showNotification('請先完成註冊', 'warning'); 
      return; 
    }
    try {
      await callAPI('registerActivity', { 
        lineId: userProfile.userId, 
        activityId: id 
      });
      showNotification('報名成功！', 'success');
      await loadActivities();
      await loadMyRegistrations();
    } catch (err) {
      showNotification('報名失敗：' + err.message, 'error');
    }
  }

  async function loadMyRegistrations() {
    if (!currentUser) return;
    try {
      const r = await callAPI('getMyRegistrations', { lineId: userProfile.userId });
      renderMyRegistrations(r.data || []);
    } catch (err) {
      document.getElementById('myRegistrations').innerHTML = `
        <div class="empty-state">
          <i class="bi bi-exclamation-triangle"></i>
          <h5>載入失敗</h5>
          <p>${err.message}</p>
        </div>`;
    }
  }

  function renderMyRegistrations(list) {
    const container = document.getElementById('myRegistrations');
    if (!list.length) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-clipboard-x"></i>
          <h5>尚無報名記錄</h5>
          <p>快去報名參加活動吧！</p>
        </div>`;
      return;
    }
    container.innerHTML = list.map(reg => `
      <div class="activity-item">
        <div class="activity-title">${reg.activityTitle}</div>
        <div class="activity-meta">
          <span><i class="bi bi-calendar"></i> 報名時間：${formatDateTime(reg.registrationTime)}</span>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <span class="status-badge status-${reg.status}">${reg.status}</span>
          ${reg.status === '已報名' ? 
            `<button class="btn btn-danger btn-sm" onclick="cancelRegistration('${reg.id}')">
                <i class="bi bi-x-circle"></i> 取消報名
              </button>` : ''}
          </div>
        </div>
      `).join('');
    }

  async function cancelRegistration(regId) {
    if (!confirm('確定要取消這筆報名嗎？')) return;
    try {
      await callAPI('cancelRegistration', { regId, lineId: userProfile.userId });
      showNotification('已取消報名', 'success');
      await loadActivities();
      await loadMyRegistrations();
      await loadHomeDashboard();
    } catch (err) {
      showNotification('取消失敗：' + err.message, 'error');
    }
  }

  // 志工區塊
  async function loadVolunteerData() {
    if (!userProfile?.userId) return;
    try {
      const r = await callAPI('getVolunteerData', { lineId: userProfile.userId });
      const d = r.data || {};
      const stats = d.stats || {};
      const needs = Array.isArray(d.needs) ? d.needs : [];
      const myRecords = Array.isArray(d.myRecords) ? d.myRecords : [];

      document.getElementById('myVolunteerHours').textContent = stats.totalHours || 0;
      document.getElementById('volunteerActivities').textContent = stats.participations || 0;
      document.getElementById('volunteerRank').textContent = stats.rank ?? '-';
      document.getElementById('availableNeeds').textContent = needs.filter(n => n.status === '開放報名').length;

      renderVolunteerNeeds(needs);
      renderMyVolunteerRecords(myRecords);
    } catch (err) {
      document.getElementById('volunteerNeeds').innerHTML = `
        <div class="empty-state">
          <i class="bi bi-exclamation-triangle"></i>
          <h5>志工需求載入失敗</h5>
          <p>${err.message}</p>
        </div>`;
      document.getElementById('myVolunteerRecords').innerHTML = `
        <div class="empty-state">
          <i class="bi bi-exclamation-triangle"></i>
          <h5>志工記錄載入失敗</h5>
          <p>${err.message}</p>
        </div>`;
    }
  }

  function renderVolunteerNeeds(list) {
    const container = document.getElementById('volunteerNeeds');
    if (!Array.isArray(list) || !list.length) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-clipboard-x"></i>
          <h5>目前沒有志工需求</h5>
          <p>稍後再看看或主動聯繫主辦單位</p>
        </div>`;
      return;
    }
    container.innerHTML = list.map(item => `
      <div class="activity-item">
        <div class="activity-title">${item.title || '志工需求'}</div>
        <div class="activity-meta">
          <span><i class="bi bi-calendar"></i> ${formatDate(item.date)}</span>
          <span><i class="bi bi-clock"></i> ${item.time || '-'}</span>
          <span><i class="bi bi-geo-alt"></i> ${item.location || '-'}</span>
          <span><i class="bi bi-people"></i> ${item.current || 0}/${item.quota || 0}</span>
        </div>
        <div class="activity-description">${item.description || ''}</div>
        <div class="d-flex justify-content-between align-items-center mt-3">
          <span class="status-badge status-${item.status || ''}">${item.status || ''}</span>
          ${item.status === '開放報名' ? `
            <button class="btn btn-success btn-sm" onclick="applyVolunteer('${item.id}')">
              <i class="bi bi-hand-thumbs-up"></i> 參與
            </button>` : ''}
        </div>
      </div>
    `).join('');
  }

  async function applyVolunteer(needId) {
    if (!currentUser) {
      showNotification('請先完成註冊', 'warning');
      return;
    }
    try {
      await callAPI('applyVolunteer', { lineId: userProfile.userId, needId });
      showNotification('志工報名成功！', 'success');
      await loadVolunteerData();
    } catch (err) {
      showNotification('志工報名失敗：' + err.message, 'error');
    }
  }

  function renderMyVolunteerRecords(list) {
    const container = document.getElementById('myVolunteerRecords');
    if (!Array.isArray(list) || !list.length) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-journal-x"></i>
          <h5>尚無志工服務記錄</h5>
          <p>試著參加一項志工服務吧</p>
        </div>`;
      return;
    }
    container.innerHTML = list.map(rec => `
      <div class="activity-item">
        <div class="activity-title">${rec.title || '志工服務'}</div>
        <div class="activity-meta">
          <span><i class="bi bi-calendar"></i> ${formatDate(rec.date)}</span>
          <span><i class="bi bi-clock-history"></i> ${rec.hours || 0} 小時</span>
        </div>
        <div class="activity-description">${rec.remark || ''}</div>
        <span class="status-badge status-${rec.status || ''}">${rec.status || ''}</span>
      </div>
    `).join('');
  }

  // 財務區塊
  async function loadFinanceData() {
    if (!userProfile?.userId) return;
    try {
      const r = await callAPI('getFinanceData', { lineId: userProfile.userId });
      const d = r.data || {};
      const stats = d.stats || {};
      const donations = Array.isArray(d.donations) ? d.donations : [];
      const expenses = Array.isArray(d.expenses) ? d.expenses : [];

      document.getElementById('myDonationAmount').textContent = 'NT$ ' + (formatCurrency(stats.totalDonation || 0).replace('NT$', '').trim());
      document.getElementById('myDonationCount').textContent = stats.donationCount || 0;
      document.getElementById('myExpenseAmount').textContent = 'NT$ ' + (formatCurrency(stats.totalExpense || 0).replace('NT$', '').trim());
      document.getElementById('pendingExpenses').textContent = stats.pendingExpenseCount || 0;

      renderDonationHistory(donations);
      renderExpenseHistory(expenses);
    } catch (err) {
      document.getElementById('donationHistory').innerHTML = `
        <div class="empty-state">
          <i class="bi bi-exclamation-triangle"></i>
          <h5>捐款資料載入失敗</h5>
          <p>${err.message}</p>
        </div>`;
      document.getElementById('expenseHistory').innerHTML = `
        <div class="empty-state">
          <i class="bi bi-exclamation-triangle"></i>
          <h5>支出資料載入失敗</h5>
          <p>${err.message}</p>
        </div>`;
    }
  }

  function renderDonationHistory(list) {
    const container = document.getElementById('donationHistory');
    if (!Array.isArray(list) || !list.length) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-heart"></i>
          <h5>尚無捐款紀錄</h5>
          <p>您的小小支持，能帶來大大改變</p>
        </div>`;
      return;
    }
    container.innerHTML = list.map(d => `
      <div class="activity-item">
        <div class="activity-title">捐款 ${formatCurrency(d.amount || 0)}</div>
        <div class="activity-meta">
          <span><i class="bi bi-calendar"></i> ${formatDateTime(d.time)}</span>
          <span><i class="bi bi-receipt"></i> 收據：${d.needReceipt ? '是' : '否'}</span>
        </div>
        <div class="activity-description">${d.note || ''}</div>
        <span class="status-badge status-${d.status || ''}">${d.status || ''}</span>
      </div>
    `).join('');
  }

  function renderExpenseHistory(list) {
    const container = document.getElementById('expenseHistory');
    if (!Array.isArray(list) || !list.length) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-receipt"></i>
          <h5>尚無支出申請</h5>
          <p>有需要報銷的費用嗎？點上方「支出申請」</p>
        </div>`;
      return;
    }
    container.innerHTML = list.map(e => `
      <div class="activity-item">
        <div class="activity-title">支出申請 ${formatCurrency(e.amount || 0)}</div>
        <div class="activity-meta">
          <span><i class="bi bi-calendar"></i> ${formatDateTime(e.time)}</span>
          <span><i class="bi bi-file-earmark-text"></i> 類別：${e.category || '-'}</span>
        </div>
        <div class="activity-description">${e.description || ''}</div>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <span class="status-badge status-${e.status || ''}">${e.status || ''}</span>
          ${e.status === '待審核' ? `
            <button class="btn btn-warning btn-sm" onclick="cancelExpense('${e.id}')">
              <i class="bi bi-x-circle"></i> 撤回
            </button>` : ''}
        </div>
      </div>
    `).join('');
  }

  async function cancelExpense(expenseId) {
    if (!confirm('確定撤回這筆支出申請嗎？')) return;
    try {
      await callAPI('cancelExpense', { lineId: userProfile.userId, expenseId });
      showNotification('已撤回支出申請', 'success');
      await loadFinanceData();
    } catch (err) {
      showNotification('撤回失敗：' + err.message, 'error');
    }
  }

  // 回饋區塊
  async function loadFeedbackData() {
    if (!userProfile?.userId) return;
    try {
      const r = await callAPI('getFeedbackData', { lineId: userProfile.userId });
      const d = r.data || {};
      const myFeedback = Array.isArray(d.myFeedback) ? d.myFeedback : [];
      const activities = Array.isArray(d.activities) ? d.activities : [];

      // 填活動選單
      const sel = document.getElementById('feedbackActivity');
      sel.innerHTML = '<option value="">請選擇活動</option>' + activities
        .map(a => `<option value="${a.id}">${a.title}</option>`).join('');

      renderMyFeedback(myFeedback);
    } catch (err) {
      document.getElementById('myFeedback').innerHTML = `
        <div class="empty-state">
          <i class="bi bi-exclamation-triangle"></i>
          <h5>回饋資料載入失敗</h5>
          <p>${err.message}</p>
        </div>`;
    }
  }

  function renderMyFeedback(list) {
    const container = document.getElementById('myFeedback');
    if (!Array.isArray(list) || !list.length) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-chat-left-text"></i>
          <h5>尚無回饋記錄</h5>
          <p>分享您的活動體驗，幫助我們進步</p>
        </div>`;
      return;
    }
    container.innerHTML = list.map(f => `
      <div class="activity-item">
        <div class="activity-title">${f.activityTitle || '活動回饋'}</div>
        <div class="rating">${'⭐'.repeat(Number(f.rating || 0))}</div>
        <div class="activity-description">${f.comment || ''}</div>
        <div class="activity-meta">
          <span><i class="bi bi-clock"></i> ${formatDateTime(f.time)}</span>
          <span class="status-badge status-${f.status || ''}">${f.status || ''}</span>
        </div>
      </div>
    `).join('');
  }

  // 回饋提交
  document.getElementById('feedbackForm').addEventListener('submit', async e => {
    e.preventDefault();
    if (!currentUser) {
      showNotification('請先完成註冊', 'warning');
      return;
    }
    const fd = new FormData(e.target);
    const btn = e.target.querySelector('button[type="submit"]');
    setButtonLoading(btn, true);
    try {
      await callAPI('submitFeedback', {
        lineId: userProfile.userId,
        activityId: fd.get('feedbackActivity'),
        rating: Number(fd.get('feedbackRating') || 0),
        comment: fd.get('feedbackComment') || ''
      });
      showNotification('回饋已提交，感謝您的意見！', 'success');
      e.target.reset();
      await loadFeedbackData();
    } catch (err) {
      showNotification('提交失敗：' + err.message, 'error');
    } finally { setButtonLoading(btn, false); }
  });

  // Modal 產生器
  function renderModal(html) {
    const container = document.getElementById('modalContainer');
    container.innerHTML = `
      <div class="modal fade" id="commonModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            ${html}
          </div>
        </div>
      </div>`;
    const modalEl = document.getElementById('commonModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
    modalEl.addEventListener('hidden.bs.modal', () => container.innerHTML = '');
    return modal;
  }

  // 捐款 Modal
  function showDonationModal() {
    if (!currentUser) {
      showNotification('請先完成註冊', 'warning');
      return;
    }
    const html = `
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-heart-fill"></i> 愛心捐款</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="donationForm">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" for="donationAmount">捐款金額 *</label>
            <input type="number" min="1" class="form-control" id="donationAmount" name="amount" required placeholder="例如：500">
          </div>
          <div class="form-group">
            <label class="form-label" for="donationNote">備註</label>
            <textarea class="form-control" id="donationNote" name="note" placeholder="可填寫用途、祝福等"></textarea>
          </div>
          <div class="form-group form-check" style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" class="form-check-input" id="needReceipt" name="needReceipt">
            <label class="form-check-label" for="needReceipt">需要收據</label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">關閉</button>
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-check2-circle"></i> 確認捐款
          </button>
        </div>
      </form>`;
    const modal = renderModal(html);

    document.getElementById('donationForm').addEventListener('submit', async e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn, true);
      try {
        await callAPI('createDonation', {
          lineId: userProfile.userId,
          amount: Number(fd.get('amount') || 0),
          note: fd.get('note') || '',
          needReceipt: !!fd.get('needReceipt')
        });
        showNotification('感謝您的愛心捐款！', 'success');
        modal.hide();
        if (currentTab === 'finance') await loadFinanceData();
        await loadHomeDashboard();
      } catch (err) {
        showNotification('捐款失敗：' + err.message, 'error');
      } finally { setButtonLoading(btn, false); }
    });
  }

  // 支出申請 Modal
  function showExpenseModal() {
    if (!currentUser) {
      showNotification('請先完成註冊', 'warning');
      return;
    }
    const html = `
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-receipt"></i> 支出申請</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="expenseForm">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" for="expenseCategory">費用類別 *</label>
            <select class="form-select" id="expenseCategory" name="category" required>
              <option value="">請選擇</option>
              <option value="活動費用">活動費用</option>
              <option value="物資採購">物資採購</option>
              <option value="交通補助">交通補助</option>
              <option value="行政雜支">行政雜支</option>
              <option value="其他">其他</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="expenseAmount">金額 *</label>
            <input type="number" min="1" class="form-control" id="expenseAmount" name="amount" required placeholder="例如：300">
          </div>
          <div class="form-group">
            <label class="form-label" for="expenseDesc">說明 *</label>
            <textarea class="form-control" id="expenseDesc" name="description" required placeholder="請描述用途與細節"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label" for="expenseDate">支出日期</label>
            <input type="date" class="form-control" id="expenseDate" name="date">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">關閉</button>
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-send-check"></i> 送出申請
          </button>
        </div>
      </form>`;
    const modal = renderModal(html);

    document.getElementById('expenseForm').addEventListener('submit', async e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button[type="submit"]');
      setButtonLoading(btn, true);
      try {
        await callAPI('createExpense', {
          lineId: userProfile.userId,
          category: fd.get('category'),
          amount: Number(fd.get('amount') || 0),
          description: fd.get('description') || '',
          date: fd.get('date') || ''
        });
        showNotification('已送出支出申請，待審核', 'success');
        modal.hide();
        if (currentTab === 'finance') await loadFinanceData();
      } catch (err) {
        showNotification('申請失敗：' + err.message, 'error');
      } finally { setButtonLoading(btn, false); }
    });
  }

  // 首頁刷新
  async function refreshData() {
    try {
      showNotification('刷新中...', 'warning', 1500);
      await Promise.allSettled([
        loadUserData(),
        loadHomeDashboard(),
        currentTab === 'activities' ? loadActivities() : Promise.resolve(),
        currentTab === 'activities' ? loadMyRegistrations() : Promise.resolve(),
        currentTab === 'volunteer' ? loadVolunteerData() : Promise.resolve(),
        currentTab === 'finance' ? loadFinanceData() : Promise.resolve(),
        currentTab === 'feedback' ? loadFeedbackData() : Promise.resolve()
      ]);
      showNotification('已更新最新資料', 'success');
    } catch (err) {
      showNotification('刷新失敗：' + err.message, 'error');
    }
  }

  // 頁面初始化
  document.addEventListener('DOMContentLoaded', () => {
    initializeLiff();
  });
</script>
</body>
</html>
