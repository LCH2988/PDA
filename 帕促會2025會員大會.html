<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£å¸•é‡‘æ£®ä¹‹å‹å”æœƒ - 2025å¹´æœƒæš¨é¤æ•˜å ±åç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #667eea;
            --primary-dark: #5568d3;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-light: #f9fafb;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.95;
        }
        
        .tabs {
            display: flex;
            background: #f9fafb;
            border-bottom: 2px solid var(--border-color);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.3s;
            border: none;
            background: transparent;
            font-size: 16px;
        }
        
        .tab.active {
            color: var(--primary-color);
            background: white;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .content {
            padding: 30px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
            font-size: 15px;
        }
        
        .required {
            color: var(--danger-color);
            margin-left: 4px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .radio-group {
            display: grid;
            gap: 12px;
        }
        
        .radio-option {
            position: relative;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .radio-option:hover {
            border-color: var(--primary-color);
            background: #f9fafb;
        }
        
        .radio-option.checked {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }
        
        .radio-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f3f4f6;
        }
        
        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }
        
        .radio-label {
            display: block;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }
        
        .radio-desc {
            font-size: 13px;
            color: var(--text-light);
        }
        
        .fee-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }
        
        .fee-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .fee-amount {
            font-size: 36px;
            font-weight: 700;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow);
        }
        
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .registration-list {
            display: grid;
            gap: 15px;
        }
        
        .registration-card {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .registration-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .card-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .card-id {
            font-size: 14px;
            color: var(--text-light);
        }
        
        .card-body {
            display: grid;
            gap: 10px;
        }
        
        .card-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .card-label {
            color: var(--text-light);
        }
        
        .card-value {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            animation: slideIn 0.3s;
            max-width: 300px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }
        
        .toast.success { background: var(--success-color); }
        .toast.error { background: var(--danger-color); }
        .toast.warning { background: var(--warning-color); }
        
        .custom-donation-group {
            margin-top: 10px;
            display: none;
        }
        
        .custom-donation-group.show {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        .transfer-code-group {
            margin-top: 10px;
            display: none;
        }
        
        .transfer-code-group.show {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        .info-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .info-box p {
            margin: 5px 0;
            font-size: 14px;
            color: #1e40af;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .content {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .fee-amount {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- æ¨™é¡Œå€ -->
    <div class="header">
        <h1>ğŸ‰ å°ç£å¸•é‡‘æ£®ä¹‹å‹å”æœƒ</h1>
        <p>2025å¹´æœƒæš¨é¤æ•˜å ±åç³»çµ±</p>
    </div>
    
    <!-- åˆ†é æ¨™ç±¤ -->
    <div class="tabs">
        <button class="tab active" onclick="switchPage('form')">ğŸ“ æˆ‘è¦å ±å</button>
        <button class="tab" onclick="switchPage('list')">ğŸ“‹ å ±ååå–®</button>
        <button class="tab" onclick="switchPage('stats')">ğŸ“Š çµ±è¨ˆè³‡æ–™</button>
    </div>
    
    <!-- å…§å®¹å€ -->
    <div class="content">
        
        <!-- ==================== å ±åè¡¨å–®é  ==================== -->
        <div id="formPage" class="page active">
            <form id="registrationForm">
                
                <!-- åŸºæœ¬è³‡æ–™ -->
                <div class="form-group">
                    <label class="form-label">å§“å<span class="required">*</span></label>
                    <input type="text" name="name" class="form-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">è¯çµ¡é›»è©±<span class="required">*</span></label>
                    <input type="tel" name="phone" class="form-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">é›»å­éƒµä»¶</label>
                    <input type="email" name="email" class="form-input" placeholder="é¸å¡«ï¼Œæ–¹ä¾¿æˆ‘å€‘å¯„é€é€šçŸ¥">
                </div>
                
                <!-- å ±åé¡å‹ -->
                <div class="form-group">
                    <label class="form-label">å ±åé¡å‹<span class="required">*</span></label>
                    <div class="radio-group" id="typeOptions">
                        <label class="radio-option">
                            <input type="radio" name="type" value="member" data-fee="1000" required>
                            <span class="radio-label">èˆŠæœƒå“¡</span>
                            <span class="radio-desc">2026å¹´æœƒè²» $1,000ï¼ˆå…é¤è²»ï¼‰</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="type" value="member-caregiver" data-fee="1500" required>
                            <span class="radio-label">èˆŠæœƒå“¡ + ç…§é¡§é™ªä¼´è€…</span>
                            <span class="radio-desc">2026å¹´æœƒè²» $1,000 + ç…§é¡§é™ªä¼´è€… $500</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="type" value="new-member" data-fee="1500" required>
                            <span class="radio-label">æ–°æœƒå“¡</span>
                            <span class="radio-desc">2026å¹´æœƒè²» $1,000 + é¤è²»å„ªæƒ åƒ¹ $500</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="type" value="non-member" data-fee="1000" required>
                            <span class="radio-label">éæœƒå“¡</span>
                            <span class="radio-desc">éæœƒå“¡ $1,000</span>
                        </label>
                    </div>
                </div>
                
                <!-- æ˜¯å¦ç”¨é¤ -->
                <div class="form-group">
                    <label class="form-label">æ˜¯å¦åƒåŠ ç”¨é¤<span class="required">*</span></label>
                    <div class="radio-group" id="attendMealOptions">
                        <label class="radio-option">
                            <input type="radio" name="attendMeal" value="yes" required>
                            <span class="radio-label">âœ… åƒåŠ ç”¨é¤</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="attendMeal" value="no" required>
                            <span class="radio-label">âŒ ä¸åƒåŠ ç”¨é¤</span>
                        </label>
                    </div>
                </div>
                
                <!-- é£²é£Ÿç¿’æ…£ -->
                <div class="form-group">
                    <label class="form-label">é£²é£Ÿç¿’æ…£<span class="required">*</span></label>
                    <div class="radio-group" id="dietOptions">
                        <label class="radio-option">
                            <input type="radio" name="diet" value="meat" required>
                            <span class="radio-label">ğŸ– è‘·é£Ÿ</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="diet" value="vegetarian" required>
                            <span class="radio-label">ğŸ¥— ç´ é£Ÿ</span>
                        </label>
                    </div>
                </div>
                
                <!-- ææ¬¾ -->
                <div class="form-group">
                    <label class="form-label">é¡å¤–ææ¬¾ï¼ˆé¸å¡«ï¼‰</label>
                    <div class="radio-group" id="donationOptions">
                        <label class="radio-option">
                            <input type="radio" name="donation" value="0" checked>
                            <span class="radio-label">ä¸ææ¬¾</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="donation" value="500">
                            <span class="radio-label">ææ¬¾ $500</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="donation" value="1000">
                            <span class="radio-label">ææ¬¾ $1,000</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="donation" value="custom">
                            <span class="radio-label">è‡ªè¨‚é‡‘é¡</span>
                        </label>
                    </div>
                    <div id="customDonationGroup" class="custom-donation-group">
                        <input type="number" name="customDonation" class="form-input" placeholder="è«‹è¼¸å…¥ææ¬¾é‡‘é¡" min="1">
                    </div>
                </div>
                
                <!-- ç¹³è²»æ–¹å¼ -->
                <div class="form-group">
                    <label class="form-label">ç¹³è²»æ–¹å¼<span class="required">*</span></label>
                    <div class="radio-group" id="paymentOptions">
                        <label class="radio-option">
                            <input type="radio" name="payment" value="transfer" required>
                            <span class="radio-label">ğŸ’³ è½‰å¸³</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="payment" value="cash" required>
                            <span class="radio-label">ğŸ’µ ç¾é‡‘</span>
                        </label>
                    </div>
                    <div id="transferCodeGroup" class="transfer-code-group">
                        <label class="form-label">è½‰å¸³å¾Œ5ç¢¼<span class="required">*</span></label>
                        <input type="text" name="transferCode" id="transferCodeInput" class="form-input" placeholder="è«‹è¼¸å…¥è½‰å¸³å¸³è™Ÿå¾Œ5ç¢¼" maxlength="5">
                        <div class="info-box">
                            <p><strong>è½‰å¸³è³‡è¨Šï¼š</strong></p>
                            <p>éŠ€è¡Œï¼šä¸­åœ‹ä¿¡è¨—éŠ€è¡Œ</p>
                            <p>å¸³è™Ÿï¼š123-456-789012</p>
                            <p>æˆ¶åï¼šå°ç£å¸•é‡‘æ£®ä¹‹å‹å”æœƒ</p>
                        </div>
                    </div>
                </div>
                
                <!-- å‚™è¨» -->
                <div class="form-group">
                    <label class="form-label">å‚™è¨»</label>
                    <textarea name="notes" class="form-input" rows="3" placeholder="æœ‰ä»»ä½•éœ€è¦å‚™è¨»çš„äº‹é …ï¼Œè«‹åœ¨æ­¤å¡«å¯«"></textarea>
                </div>
                
                <!-- è²»ç”¨é¡¯ç¤º -->
                <div class="fee-display">
                    <div class="fee-label">æ‡‰ç¹³ç¸½é¡</div>
                    <div class="fee-amount" id="totalFee">$0</div>
                </div>
                
                <!-- æäº¤æŒ‰éˆ• -->
                <button type="submit" class="submit-btn" id="submitBtn">ç¢ºèªå ±å</button>
                
            </form>
        </div>
        
        <!-- ==================== å ±ååå–®é  ==================== -->
        <div id="listPage" class="page">
            <div id="registrationList" class="registration-list">
                <p style="text-align: center; color: var(--text-light);">è¼‰å…¥ä¸­...</p>
            </div>
        </div>
        
        <!-- ==================== çµ±è¨ˆè³‡æ–™é  ==================== -->
        <div id="statsPage" class="page">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-label">ç¸½å ±åäººæ•¸</div>
                    <div class="stat-value" id="statTotalCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç”¨é¤äººæ•¸</div>
                    <div class="stat-value" id="statMealCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">è‘·é£Ÿ</div>
                    <div class="stat-value" id="statMeatCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç´ é£Ÿ</div>
                    <div class="stat-value" id="statVegetarianCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">èˆŠæœƒå“¡</div>
                    <div class="stat-value" id="statMemberCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">é™ªä¼´è€…</div>
                    <div class="stat-value" id="statMemberCaregiverCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ–°æœƒå“¡</div>
                    <div class="stat-value" id="statNewMemberCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">éæœƒå“¡</div>
                    <div class="stat-value" id="statNonMemberCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç¸½æ”¶å…¥</div>
                    <div class="stat-value" id="statTotalAmount">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç¸½ææ¬¾</div>
                    <div class="stat-value" id="statTotalDonation">$0</div>
                </div>
            </div>
        </div>
        
    </div>
</div>

<script>
    // ==================== å…¨åŸŸè®Šæ•¸ ====================
    
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbx7_za4KZB_fy7cXWkRI1Bh5bfmg08-C2CDridIEApBwuObIeossM_BBv_741tacXOw/exec';
    
    let registrations = [];
    let currentPage = 'form';
    let isSubmitting = false;
    
    // ==================== DOM å…ƒç´  ====================
    
    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('submitBtn');
    const totalFeeDisplay = document.getElementById('totalFee');
    
    const typeOptions = document.querySelectorAll('input[name="type"]');
    const attendMealRadios = document.querySelectorAll('input[name="attendMeal"]');
    const dietRadios = document.querySelectorAll('input[name="diet"]');
    const donationRadios = document.querySelectorAll('input[name="donation"]');
    const paymentRadios = document.querySelectorAll('input[name="payment"]');
    
    const customDonationGroup = document.getElementById('customDonationGroup');
    const customDonationInput = document.querySelector('input[name="customDonation"]');
    const transferCodeGroup = document.getElementById('transferCodeGroup');
    const transferCodeInput = document.getElementById('transferCodeInput');
    
    const typeOptionElements = document.querySelectorAll('#typeOptions .radio-option');
    const attendMealOptions = document.querySelectorAll('#attendMealOptions .radio-option');
    const dietOptions = document.querySelectorAll('#dietOptions .radio-option');
    const donationOptions = document.querySelectorAll('#donationOptions .radio-option');
    const paymentOptions = document.querySelectorAll('#paymentOptions .radio-option');
    
    // ==================== åˆ†é åˆ‡æ› ====================
    
    function switchPage(pageName) {
        currentPage = pageName;
        
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        
        if (pageName === 'form') {
            document.querySelector('.tab:nth-child(1)').classList.add('active');
            document.getElementById('formPage').classList.add('active');
        } else if (pageName === 'list') {
            document.querySelector('.tab:nth-child(2)').classList.add('active');
            document.getElementById('listPage').classList.add('active');
            loadRegistrations();
        } else if (pageName === 'stats') {
            document.querySelector('.tab:nth-child(3)').classList.add('active');
            document.getElementById('statsPage').classList.add('active');
            loadRegistrations();
        }
    }
    
    // ==================== Toast æç¤º ====================
    
    function showToast(type, message) {
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
            existingToast.remove();
        }
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
    
    // ==================== å–®é¸æ¡†æ¨£å¼æ§åˆ¶ ====================
    
    function setupRadioStyles(radioElements, optionElements) {
        radioElements.forEach((radio, index) => {
            radio.addEventListener('change', function() {
                optionElements.forEach(opt => opt.classList.remove('checked'));
                if (this.checked) {
                    optionElements[index].classList.add('checked');
                }
            });
        });
    }
    
    setupRadioStyles(typeOptions, typeOptionElements);
    setupRadioStyles(attendMealRadios, attendMealOptions);
    setupRadioStyles(dietRadios, dietOptions);
    setupRadioStyles(donationRadios, donationOptions);
    setupRadioStyles(paymentRadios, paymentOptions);
    
    // ==================== æ˜¯å¦ç”¨é¤æ§åˆ¶é£²é£Ÿç¿’æ…£ ====================
    
    attendMealRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'no') {
                // ä¸ç”¨é¤ï¼šç¦ç”¨é£²é£Ÿç¿’æ…£é¸é …
                dietOptions.forEach(opt => opt.classList.add('disabled'));
                dietRadios.forEach(r => {
                    r.checked = false;
                    r.required = false;
                });
            } else {
                // åƒåŠ ç”¨é¤ï¼šå•Ÿç”¨é£²é£Ÿç¿’æ…£é¸é …
                dietOptions.forEach(opt => opt.classList.remove('disabled'));
                dietRadios.forEach(r => r.required = true);
            }
            updateFee();
        });
    });
    
    // ==================== ææ¬¾é‡‘é¡æ§åˆ¶ ====================
    
    donationRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDonationGroup.classList.add('show');
                customDonationInput.required = true;
            } else {
                customDonationGroup.classList.remove('show');
                customDonationInput.required = false;
                customDonationInput.value = '';
            }
            updateFee();
        });
    });
    
    customDonationInput.addEventListener('input', updateFee);
    
    // ==================== ç¹³è²»æ–¹å¼æ§åˆ¶ ====================
    
    paymentRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'transfer') {
                transferCodeGroup.classList.add('show');
                transferCodeInput.required = true;
            } else {
                transferCodeGroup.classList.remove('show');
                transferCodeInput.required = false;
                transferCodeInput.value = '';
            }
        });
    });
    
    // ==================== è²»ç”¨è¨ˆç®— ====================
    
    typeOptions.forEach(radio => {
        radio.addEventListener('change', updateFee);
    });
    
    function updateFee() {
        const selectedType = document.querySelector('input[name="type"]:checked');
        const selectedDonation = document.querySelector('input[name="donation"]:checked');
        
        if (!selectedType) {
            totalFeeDisplay.textContent = '$0';
            return;
        }
        
        let baseFee = parseInt(selectedType.dataset.fee);
        let donationAmount = 0;
        
        if (selectedDonation) {
            if (selectedDonation.value === 'custom') {
                donationAmount = parseInt(customDonationInput.value) || 0;
            } else {
                donationAmount = parseInt(selectedDonation.value);
            }
        }
        
        const totalFee = baseFee + donationAmount;
        totalFeeDisplay.textContent = '$' + totalFee.toLocaleString();
    }
    
    // ==================== Google Sheets è³‡æ–™è¼‰å…¥ ====================
    
    async function loadFromGoogleSheets() {
        try {
            const response = await fetch(GAS_API_URL + '?action=getAll&callback=handleData&_=' + Date.now());
            const text = await response.text();
            
            const jsonText = text.replace(/^handleData\(/, '').replace(/\)$/, '');
            const result = JSON.parse(jsonText);
            
            if (result.success) {
                return result.data || [];
            } else {
                throw new Error(result.message || 'è¼‰å…¥å¤±æ•—');
            }
        } catch (error) {
            console.error('âŒ è¼‰å…¥è³‡æ–™éŒ¯èª¤:', error);
            showToast('error', 'è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            return [];
        }
    }
    
    // ==================== æ›´æ–°å ±ååå–® ====================
    
    function updateRegistrationList() {
        const listContainer = document.getElementById('registrationList');
        
        if (registrations.length === 0) {
            listContainer.innerHTML = '<p style="text-align: center; color: var(--text-light);">ç›®å‰å°šç„¡å ±åè³‡æ–™</p>';
            return;
        }
        
        listContainer.innerHTML = registrations.map(reg => {
            const attendMealText = reg.attendMeal === 'yes' ? 'âœ… åƒåŠ ç”¨é¤' : 'âŒ ä¸åƒåŠ ç”¨é¤';
            const dietText = reg.diet === 'vegetarian' ? 'ğŸ¥— ç´ é£Ÿ' : (reg.diet === 'meat' ? 'ğŸ– è‘·é£Ÿ' : '-');
            const mealInfo = reg.attendMeal === 'yes' ? `${attendMealText} (${dietText})` : attendMealText;
            
            return `
                <div class="registration-card">
                    <div class="card-header">
                        <div class="card-name">${reg.name}</div>
                        <div class="card-id">#${reg.id}</div>
                    </div>
                    <div class="card-body">
                        <div class="card-row">
                            <span class="card-label">å ±åæ™‚é–“</span>
                            <span class="card-value">${reg.timestamp}</span>
                        </div>
                        <div class="card-row">
                            <span class="card-label">è¯çµ¡é›»è©±</span>
                            <span class="card-value">${reg.phone}</span>
                        </div>
                        <div class="card-row">
                            <span class="card-label">å ±åé¡å‹</span>
                            <span class="card-value">${reg.typeLabel}</span>
                        </div>
                        <div class="card-row">
                            <span class="card-label">ç”¨é¤è³‡è¨Š</span>
                            <span class="card-value">${mealInfo}</span>
                        </div>
                        <div class="card-row">
                            <span class="card-label">ç¹³è²»æ–¹å¼</span>
                            <span class="card-value">${reg.payment === 'transfer' ? 'ğŸ’³ è½‰å¸³' : 'ğŸ’µ ç¾é‡‘'}</span>
                        </div>
                        <div class="card-row">
                            <span class="card-label">æ‡‰ç¹³ç¸½é¡</span>
                            <span class="card-value" style="color: var(--primary-color); font-size: 18px;">$${reg.totalFee.toLocaleString()}</span>
                        </div>
                        ${reg.notes ? `
                        <div class="card-row">
                            <span class="card-label">å‚™è¨»</span>
                            <span class="card-value">${reg.notes}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // ==================== æ›´æ–°çµ±è¨ˆè³‡æ–™ ====================
    
    function updateStatistics() {
        let stats = {
            totalCount: 0,
            mealCount: 0,
            memberCount: 0,
            memberCaregiverCount: 0,
            newMemberCount: 0,
            nonMemberCount: 0,
            meatCount: 0,
            vegetarianCount: 0,
            transferCount: 0,
            cashCount: 0,
            totalAmount: 0,
            totalDonation: 0
        };
        
        registrations.forEach(reg => {
            stats.totalCount++;
            
            // çµ±è¨ˆå ±åé¡å‹
            if (reg.typeLabel === 'èˆŠæœƒå“¡') {
                stats.memberCount++;
            } else if (reg.typeLabel.includes('é™ªä¼´è€…') || reg.typeLabel.includes('ç…§é¡§')) {
                stats.memberCaregiverCount++;
            } else if (reg.typeLabel === 'æ–°æœƒå“¡') {
                stats.newMemberCount++;
            } else if (reg.typeLabel === 'éæœƒå“¡') {
                stats.nonMemberCount++;
            }
            
            // çµ±è¨ˆç”¨é¤äººæ•¸
            if (reg.attendMeal === 'yes') {
                if (reg.typeLabel.includes('é™ªä¼´è€…') || reg.typeLabel.includes('ç…§é¡§')) {
                    // é™ªä¼´è€… = 2äººç”¨é¤
                    stats.mealCount += 2;
                    
                    if (reg.diet === 'vegetarian') {
                        stats.vegetarianCount += 2;
                    } else {
                        stats.meatCount += 2;
                    }
                } else {
                    // å…¶ä»– = 1äººç”¨é¤
                    stats.mealCount += 1;
                    
                    if (reg.diet === 'vegetarian') {
                        stats.vegetarianCount += 1;
                    } else {
                        stats.meatCount += 1;
                    }
                }
            }
            
            // çµ±è¨ˆç¹³è²»æ–¹å¼
            if (reg.payment === 'transfer') {
                stats.transferCount++;
            } else {
                stats.cashCount++;
            }
            
            // çµ±è¨ˆé‡‘é¡
            stats.totalAmount += reg.totalFee || 0;
            stats.totalDonation += reg.donationAmount || 0;
        });
        
        console.log('ğŸ“Š çµ±è¨ˆçµæœ:', stats);
        
        // æ›´æ–°é¡¯ç¤º
        document.getElementById('statTotalCount').textContent = stats.totalCount;
        document.getElementById('statMealCount').textContent = stats.mealCount;
        document.getElementById('statMeatCount').textContent = stats.meatCount;
        document.getElementById('statVegetarianCount').textContent = stats.vegetarianCount;
        document.getElementById('statMemberCount').textContent = stats.memberCount;
        document.getElementById('statMemberCaregiverCount').textContent = stats.memberCaregiverCount;
        document.getElementById('statNewMemberCount').textContent = stats.newMemberCount;
        document.getElementById('statNonMemberCount').textContent = stats.nonMemberCount;
        document.getElementById('statTotalAmount').textContent = '$' + stats.totalAmount.toLocaleString();
        document.getElementById('statTotalDonation').textContent = '$' + stats.totalDonation.toLocaleString();
    }
    
    // ==================== è¡¨å–®æäº¤ ====================
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (isSubmitting) {
            return;
        }
        
        isSubmitting = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'é€å‡ºä¸­...';
        
        const formData = new FormData(form);
        
        const typeRadio = document.querySelector('input[name="type"]:checked');
        const attendMealRadio = document.querySelector('input[name="attendMeal"]:checked');
        const dietRadio = document.querySelector('input[name="diet"]:checked');
        const donationRadio = document.querySelector('input[name="donation"]:checked');
        const paymentRadio = document.querySelector('input[name="payment"]:checked');
        
        const baseFee = parseInt(typeRadio.dataset.fee);
        let donationAmount = 0;
        
        if (donationRadio.value === 'custom') {
            donationAmount = parseInt(customDonationInput.value) || 0;
        } else {
            donationAmount = parseInt(donationRadio.value);
        }
        
        const totalFee = baseFee + donationAmount;
        
        const registration = {
            action: 'add',
            name: formData.get('name'),
            phone: formData.get('phone'),
            email: formData.get('email') || '',
            type: typeRadio.value,
            typeLabel: typeRadio.parentElement.querySelector('.radio-label').textContent.split('\n')[0],
            attendMeal: attendMealRadio.value,
            diet: dietRadio ? dietRadio.value : 'none',
            payment: paymentRadio.value,
            transferCode: paymentRadio.value === 'transfer' ? formData.get('transferCode') : '',
            baseFee: baseFee,
            donationAmount: donationAmount,
            totalFee: totalFee,
            notes: formData.get('notes') || ''
            };
    try {
        const response = await fetch(GAS_API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(registration)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('success', 'âœ… å ±åæˆåŠŸï¼');
            form.reset();
            totalFeeDisplay.textContent = '$0';
            customDonationGroup.classList.remove('show');
            transferCodeGroup.classList.remove('show');
            
            // æ¸…é™¤æ‰€æœ‰é¸é …çš„ checked æ¨£å¼
            document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('checked'));
            
            // é‡æ–°è¼‰å…¥è³‡æ–™
            await loadRegistrations();
            
            // åˆ‡æ›åˆ°å ±ååå–®é 
            setTimeout(() => {
                switchPage('list');
            }, 1500);
            
        } else {
            showToast('error', 'âŒ å ±åå¤±æ•—ï¼š' + result.message);
        }
        
    } catch (error) {
        console.error('âŒ æäº¤éŒ¯èª¤:', error);
        showToast('error', 'âŒ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
        isSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'ç¢ºèªå ±å';
    }
});

// ==================== è¼‰å…¥å ±åè³‡æ–™ ====================

async function loadRegistrations() {
    try {
        registrations = await loadFromGoogleSheets();
        console.log('âœ… è¼‰å…¥è³‡æ–™:', registrations.length, 'ç­†');
        
        if (currentPage === 'list') {
            updateRegistrationList();
        } else if (currentPage === 'stats') {
            updateStatistics();
        }
        
    } catch (error) {
        console.error('âŒ è¼‰å…¥å¤±æ•—:', error);
        showToast('error', 'è¼‰å…¥è³‡æ–™å¤±æ•—');
    }
}

// ==================== é é¢è¼‰å…¥æ™‚åˆå§‹åŒ– ====================

window.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ ç³»çµ±åˆå§‹åŒ–...');
    updateFee();
    
    // é è¨­é£²é£Ÿç¿’æ…£ç‚ºå¿…å¡«
    dietRadios.forEach(r => r.required = true);
});

// ==================== JSONP å›èª¿å‡½æ•¸ ====================

window.handleData = function(data) {
    console.log('ğŸ“¦ æ¥æ”¶åˆ°è³‡æ–™:', data);
};
</script> 
</body> 
</html>

