<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#667eea">
  <title>å¸•ä¿ƒæœƒ2025æœƒå“¡å¤§æœƒå ±å</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          -webkit-tap-highlight-color: transparent;
      }
      
      :root {
          --primary-color: #667eea;
          --secondary-color: #764ba2;
          --success-color: #4caf50;
          --error-color: #f44336;
          --text-dark: #333;
          --text-light: #666;
          --bg-light: #f8f9ff;
          --border-color: #e0e0e0;
      }
      
      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', 'Segoe UI', 'Arial', sans-serif;
          background: #f5f5f5;
          color: var(--text-dark);
          overflow-x: hidden;
          -webkit-font-smoothing: antialiased;
      }
      
      /* é ‚éƒ¨å°èˆªæ¬„ */
      .app-header {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          height: 56px;
          background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
          color: white;
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 0 16px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          z-index: 1000;
      }
      
      .app-title {
          font-size: 18px;
          font-weight: bold;
      }
      
      .nav-tabs {
          display: flex;
          gap: 8px;
      }
      
      .nav-tab {
          padding: 6px 12px;
          border-radius: 20px;
          background: rgba(255,255,255,0.2);
          font-size: 14px;
          cursor: pointer;
          transition: all 0.3s;
      }
      
      .nav-tab.active {
          background: white;
          color: var(--primary-color);
      }
      
      /* ä¸»è¦å…§å®¹å€ */
      .app-content {
          margin-top: 56px;
          padding-bottom: 20px;
          min-height: calc(100vh - 56px);
      }
      
      /* é é¢åˆ‡æ› */
      .page {
          display: none;
          animation: fadeIn 0.3s ease-in-out;
      }
      
      .page.active {
          display: block;
      }
      
      @keyframes fadeIn {
          from {
              opacity: 0;
              transform: translateY(10px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }
      
      /* æ´»å‹•è³‡è¨Šé é¢ */
      .event-banner {
          background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
          color: white;
          padding: 30px 20px;
          text-align: center;
      }
      
      .event-banner h1 {
          font-size: 28px;
          margin-bottom: 8px;
      }
      
      .event-banner .subtitle {
          font-size: 16px;
          opacity: 0.9;
      }
      
      .event-date {
          background: white;
          margin: -20px 16px 0;
          padding: 20px;
          border-radius: 12px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          text-align: center;
      }
      
      .event-date .year {
          color: var(--text-light);
          font-size: 14px;
          margin-bottom: 4px;
      }
      
      .event-date .date {
          color: var(--primary-color);
          font-size: 32px;
          font-weight: bold;
      }
      
      .info-card {
          background: white;
          margin: 16px;
          padding: 20px;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      }
      
      .info-card-title {
          font-size: 18px;
          font-weight: bold;
          color: var(--primary-color);
          margin-bottom: 16px;
          display: flex;
          align-items: center;
          gap: 8px;
      }
      
      .info-item {
          padding: 12px 0;
          border-bottom: 1px solid var(--border-color);
      }
      
      .info-item:last-child {
          border-bottom: none;
      }
      
      .info-label {
          font-size: 14px;
          color: var(--text-light);
          margin-bottom: 4px;
      }
      
      .info-value {
          font-size: 16px;
          font-weight: 600;
          color: var(--text-dark);
      }
      
      .fee-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 0;
          border-bottom: 1px solid var(--border-color);
      }
      
      .fee-item:last-child {
          border-bottom: none;
      }
      
      .fee-label {
          font-size: 15px;
          color: var(--text-dark);
      }
      
      .fee-amount {
          font-size: 16px;
          font-weight: bold;
          color: var(--primary-color);
      }
      
      .bank-info {
          background: var(--bg-light);
          padding: 16px;
          border-radius: 8px;
          margin-top: 12px;
      }
      
      .bank-row {
          display: flex;
          margin-bottom: 10px;
      }
      
      .bank-row:last-child {
          margin-bottom: 0;
      }
      
      .bank-label {
          width: 80px;
          color: var(--text-light);
          font-size: 14px;
      }
      
      .bank-value {
          flex: 1;
          font-weight: 600;
          font-size: 14px;
      }
      
      .account-number {
          color: var(--primary-color);
          font-size: 18px;
          letter-spacing: 1px;
      }
      
      .link-button {
          display: block;
          background: var(--bg-light);
          color: var(--primary-color);
          padding: 12px;
          border-radius: 8px;
          text-align: center;
          text-decoration: none;
          font-weight: 600;
          margin-top: 12px;
      }
      
      /* å ±åè¡¨å–®é é¢ */
      .form-container {
          padding: 16px;
      }
      
      .form-card {
          background: white;
          padding: 20px;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          margin-bottom: 16px;
      }
      
      .form-group {
          margin-bottom: 20px;
      }
      
      .form-group label {
          display: block;
          font-size: 15px;
          font-weight: 600;
          color: var(--text-dark);
          margin-bottom: 8px;
      }
      
      .required {
          color: var(--error-color);
      }
      
      .form-control {
          width: 100%;
          padding: 14px;
          font-size: 16px;
          border: 2px solid var(--border-color);
          border-radius: 8px;
          font-family: inherit;
          transition: border-color 0.3s;
          background: white;
      }
      
      .form-control:focus {
          outline: none;
          border-color: var(--primary-color);
      }
      
      textarea.form-control {
          resize: vertical;
          min-height: 100px;
      }
      
      .radio-group {
          display: flex;
          flex-direction: column;
          gap: 10px;
      }
      
      .radio-option {
          position: relative;
          display: flex;
          align-items: center;
          padding: 16px;
          background: var(--bg-light);
          border: 2px solid transparent;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.3s;
      }
      
      .radio-option:active {
          transform: scale(0.98);
      }
      
      .radio-option input[type="radio"] {
          position: absolute;
          opacity: 0;
      }
      
      .radio-option input[type="radio"]:checked + .radio-label {
          font-weight: 600;
      }
      
      .radio-option input[type="radio"]:checked ~ .radio-check {
          background: var(--primary-color);
          border-color: var(--primary-color);
      }
      
      .radio-option input[type="radio"]:checked ~ .radio-check::after {
          opacity: 1;
          transform: scale(1);
      }
      
      .radio-option.checked {
          background: white;
          border-color: var(--primary-color);
      }
      
      .radio-label {
          flex: 1;
          font-size: 15px;
          color: var(--text-dark);
          padding-left: 12px;
      }
      
      .radio-check {
          width: 22px;
          height: 22px;
          border: 2px solid var(--border-color);
          border-radius: 50%;
          position: relative;
          transition: all 0.3s;
      }
      
      .radio-check::after {
          content: '';
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%) scale(0);
          width: 10px;
          height: 10px;
          background: white;
          border-radius: 50%;
          opacity: 0;
          transition: all 0.3s;
      }
      
      .fee-display {
          background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
          color: white;
          padding: 24px;
          border-radius: 12px;
          text-align: center;
          margin: 20px 0;
      }
      
      .fee-display .label {
          font-size: 14px;
          opacity: 0.9;
          margin-bottom: 8px;
      }
      
      .fee-display .amount {
          font-size: 40px;
          font-weight: bold;
      }
      
      .submit-btn {
          width: 100%;
          padding: 16px;
          font-size: 18px;
          font-weight: bold;
          color: white;
          background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
          border: none;
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.3s;
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }
      
      .submit-btn:active {
          transform: scale(0.98);
      }
      
      .submit-btn:disabled {
          opacity: 0.6;
          transform: none;
      }
      
      /* çµ±è¨ˆé é¢ */
      .stats-container {
          padding: 16px;
      }
      
      .stats-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
          margin-bottom: 16px;
      }
      
      .stat-card {
          background: white;
          padding: 20px;
          border-radius: 12px;
          text-align: center;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      }
      
      .stat-icon {
          font-size: 32px;
          margin-bottom: 8px;
      }
      
      .stat-label {
          font-size: 13px;
          color: var(--text-light);
          margin-bottom: 8px;
      }
      
      .stat-number {
          font-size: 32px;
          font-weight: bold;
          color: var(--primary-color);
      }
      
      .registration-list {
          background: white;
          border-radius: 12px;
          padding: 16px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      }
      
      .list-title {
          font-size: 18px;
          font-weight: bold;
          color: var(--text-dark);
          margin-bottom: 16px;
      }
      
      .registration-item {
          background: var(--bg-light);
          padding: 16px;
          border-radius: 8px;
          margin-bottom: 12px;
          border-left: 4px solid var(--primary-color);
      }
      
      .registration-item:last-child {
          margin-bottom: 0;
      }
      
      .item-name {
          font-size: 17px;
          font-weight: bold;
          color: var(--text-dark);
          margin-bottom: 8px;
      }
      
      .item-details {
          font-size: 14px;
          color: var(--text-light);
          line-height: 1.6;
      }
      
      .item-fee {
          font-size: 16px;
          font-weight: bold;
          color: var(--primary-color);
          margin-top: 8px;
      }
      
      .empty-state {
          text-align: center;
          padding: 60px 20px;
          color: var(--text-light);
      }
      
      .empty-icon {
          font-size: 64px;
          margin-bottom: 16px;
          opacity: 0.5;
      }
      
      /* è¨Šæ¯æç¤º */
      .toast {
          position: fixed;
          top: 70px;
          left: 16px;
          right: 16px;
          padding: 16px;
          border-radius: 8px;
          color: white;
          font-weight: 600;
          text-align: center;
          z-index: 2000;
          transform: translateY(-100px);
          opacity: 0;
          transition: all 0.3s;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }
      
      .toast.show {
          transform: translateY(0);
          opacity: 1;
      }
      
      .toast.success {
          background: var(--success-color);
      }
      
      .toast.error {
          background: var(--error-color);
      }
      
      /* è¼‰å…¥å‹•ç•« */
      .loading-spinner {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid rgba(255,255,255,.3);
          border-radius: 50%;
          border-top-color: #fff;
          animation: spin 0.8s linear infinite;
          margin-right: 8px;
          vertical-align: middle;
      }
      
      @keyframes spin {
          to { transform: rotate(360deg); }
      }
      
      /* ä¸‹æ‹‰åˆ·æ–°æç¤º */
      .pull-refresh {
          position: fixed;
          top: 56px;
          left: 0;
          right: 0;
          height: 50px;
          display: flex;
          align-items: center;
          justify-content: center;
          background: white;
          color: var(--primary-color);
          font-size: 14px;
          transform: translateY(-100%);
          transition: transform 0.3s;
          z-index: 999;
      }
      
      .pull-refresh.show {
          transform: translateY(0);
      }
      
      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (min-width: 768px) {
          .app-content {
              max-width: 600px;
              margin-left: auto;
              margin-right: auto;
          }
          
          .app-header {
              max-width: 600px;
              left: 50%;
              transform: translateX(-50%);
          }
      }
      
      /* å¹³æ¿å’Œæ¡Œé¢å„ªåŒ– */
      @media (min-width: 1024px) {
          .app-content {
              max-width: 800px;
          }
          
          .app-header {
              max-width: 800px;
          }
          
          .stats-grid {
              grid-template-columns: repeat(4, 1fr);
          }
      }
  </style>
</head>
<body>
  <!-- é ‚éƒ¨å°èˆªæ¬„ -->
  <header class="app-header">
      <div class="app-title">ğŸ‰ æœƒå“¡å¤§æœƒå ±å</div>
      <div class="nav-tabs">
          <div class="nav-tab active" data-page="info">æ´»å‹•</div>
          <div class="nav-tab" data-page="form">å ±å</div>
          <div class="nav-tab" data-page="stats">çµ±è¨ˆ</div>
      </div>
  </header>

  <!-- ä¸‹æ‹‰åˆ·æ–°æç¤º -->
  <div class="pull-refresh" id="pullRefresh">
      <div class="loading-spinner"></div>
      <span>æ­£åœ¨æ›´æ–°...</span>
  </div>

  <!-- è¨Šæ¯æç¤º -->
  <div class="toast" id="toast"></div>

  <!-- ä¸»è¦å…§å®¹å€ -->
  <main class="app-content">
      <!-- æ´»å‹•è³‡è¨Šé é¢ -->
      <div class="page active" id="infoPage">
          <div class="event-banner">
              <h1>ç¬¬å››å±†ç¬¬ä¸€æ¬¡æœƒå“¡å¤§æœƒ</h1>
              <div class="subtitle">å°ç£å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ</div>
          </div>

          <div class="event-date">
              <div class="year">2025å¹´</div>
              <div class="date">12æœˆ20æ—¥ï¼ˆå…­ï¼‰</div>
          </div>

          <div class="info-card">
              <div class="info-card-title">ğŸ“ æ´»å‹•åœ°é»</div>
              <div class="info-item">
                  <div class="info-label">å ´åœ°åç¨±</div>
                  <div class="info-value">æœæš®è‰¯è¾°</div>
              </div>
              <div class="info-item">
                  <div class="info-label">åœ°å€</div>
                  <div class="info-value">å°ä¸­å¸‚å—å±¯å€æ–‡å¿ƒå—è·¯99è™Ÿ</div>
              </div>
              <div class="info-item">
                  <div class="info-label">äº¤é€šè³‡è¨Š</div>
                  <div class="info-value">ğŸš‡ æ·é‹è±æ¨‚å…¬åœ’ç«™</div>
              </div>
              <div class="info-item">
                  <div class="info-label">è¯çµ¡é›»è©±</div>
                  <div class="info-value">ğŸ“ (04) 3600-6000</div>
              </div>
              <a href="https://www.yourhomewedding.com/archive/images/editor/faq/10dd58e528ba79f1.jpg" target="_blank" class="link-button">
                  ğŸš— æŸ¥çœ‹åœè»Šå ´ä½ç½®åœ–
              </a>
          </div>

          <div class="info-card">
              <div class="info-card-title">ğŸ’° è²»ç”¨èªªæ˜</div>
              <div class="fee-item">
                  <div class="fee-label">æœƒå“¡ç”¨é¤</div>
                  <div class="fee-amount">1,000å…ƒ</div>
              </div>
              <div class="fee-item">
                  <div class="fee-label">æœƒå“¡ä¸ç”¨é¤</div>
                  <div class="fee-amount">1,000å…ƒ</div>
              </div>
              <div class="fee-item">
                  <div class="fee-label">ç…§é¡§é™ªä¼´è€…ï¼ˆé™1ä½ï¼‰</div>
                  <div class="fee-amount">500å…ƒ</div>
              </div>
              <div class="fee-item">
                  <div class="fee-label">æ”œä¼´è²»ç”¨ï¼ˆç¬¬2ä½èµ·ï¼‰</div>
                  <div class="fee-amount">700å…ƒ/äºº</div>
              </div>
              <div class="fee-item">
                  <div class="fee-label">æ–°æœƒå“¡</div>
                  <div class="fee-amount">1,000å…ƒ</div>
              </div>
          </div>

          <div class="info-card">
              <div class="info-card-title">ğŸ¦ åŒ¯æ¬¾è³‡è¨Š</div>
              <div class="bank-info">
                  <div class="bank-row">
                      <div class="bank-label">æˆ¶å</div>
                      <div class="bank-value">ç¤¾åœ˜æ³•äººå°ç£å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ</div>
                  </div>
                  <div class="bank-row">
                      <div class="bank-label">éŠ€è¡Œ</div>
                      <div class="bank-value">ç¬¬ä¸€éŠ€è¡Œä¸‰é‡åŸ”åˆ†è¡Œ</div>
                  </div>
                  <div class="bank-row">
                      <div class="bank-label">éŠ€è¡Œä»£è™Ÿ</div>
                      <div class="bank-value">007</div>
                  </div>
                  <div class="bank-row">
                      <div class="bank-label">å¸³è™Ÿ</div>
                      <div class="bank-value account-number">211-1015-0402</div>
                  </div>
              </div>
          </div>
      </div>

      <!-- å ±åè¡¨å–®é é¢ -->
      <div class="page" id="formPage">
          <div class="form-container">
              <form id="registrationForm">
                  <div class="form-card">
                      <div class="form-group">
                          <label for="name">å§“å <span class="required">*</span></label>
                          <input type="text" id="name" name="name" class="form-control" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required>
                      </div>

                      <div class="form-group">
                          <label for="phone">è¯çµ¡é›»è©± <span class="required">*</span></label>
                          <input type="tel" id="phone" name="phone" class="form-control" placeholder="0912-345-678" required>
                      </div>

                      <div class="form-group">
                          <label for="email">é›»å­éƒµä»¶</label>
                          <input type="email" id="email" name="email" class="form-control" placeholder="example@email.com">
                      </div>
                  </div>

                  <div class="form-card">
                      <div class="form-group">
                          <label>å ±åé¡å‹ <span class="required">*</span></label>
                          <div class="radio-group">
                              <label class="radio-option">
                                  <input type="radio" name="type" value="member-meal" data-fee="1000" required>
                                  <div class="radio-check"></div>
                                  <span class="radio-label">æœƒå“¡ç”¨é¤<br><small>æœƒè²»1,000å…ƒï¼ˆé¤è²»å…ï¼‰</small></span>
                              </label>
                              <label class="radio-option">
                                  <input type="radio" name="type" value="member-no-meal" data-fee="1000">
                                  <div class="radio-check"></div>
                                  <span class="radio-label">æœƒå“¡ä¸ç”¨é¤<br><small>æœƒè²»1,000å…ƒ</small></span>
                              </label>
                              <label class="radio-option">
                                  <input type="radio" name="type" value="caregiver" data-fee="500">
                                  <div class="radio-check"></div>
                                  <span class="radio-label">ç…§é¡§é™ªä¼´è€…<br><small>å„ªæƒ 500å…ƒï¼ˆé™1ä½ï¼‰</small></span>
                              </label>
                              <label class="radio-option">
                                  <input type="radio" name="type" value="companion" data-fee="700">
                                  <div class="radio-check"></div>
                                  <span class="radio-label">æ”œä¼´è²»ç”¨<br><small>ç¬¬2ä½é–‹å§‹æ¯äºº700å…ƒ</small></span>
                              </label>
                              <label class="radio-option">
                                  <input type="radio" name="type" value="new-member" data-fee="1000">
                                  <div class="radio-check"></div>
                                  <span class="radio-label">æ–°æœƒå“¡<br><small>æœƒè²»1,000å…ƒ</small></span>
                              </label>
                          </div>
                      </div>

                      <div class="form-group">
                          <label for="companions">åŒè¡Œäººæ•¸ï¼ˆä¸å«æœ¬äººï¼‰</label>
                          <input type="number" id="companions" name="companions" class="form-control" min="0" max="10" value="0">
                      </div>

                      <div class="form-group">
                          <label for="notes">å‚™è¨»</label>
                          <textarea id="notes" name="notes" class="form-control" placeholder="ç‰¹æ®Šéœ€æ±‚æˆ–å…¶ä»–èªªæ˜"></textarea>
                      </div>
                  </div>

                  <div class="fee-display">
                      <div class="label">æ‡‰ç¹³è²»ç”¨</div>
                      <div class="amount" id="totalFee">NT$ 0</div>
                  </div>

                  <button type="submit" class="submit-btn" id="submitBtn">
                      ç¢ºèªå ±å
                  </button>
              </form>
          </div>
      </div>

      <!-- çµ±è¨ˆé é¢ -->
      <div class="page" id="statsPage">
          <div class="stats-container">
              <div class="stats-grid">
                  <div class="stat-card">
                      <div class="stat-icon">ğŸ‘¥</div>
                      <div class="stat-label">ç¸½å ±åäººæ•¸</div>
                      <div class="stat-number" id="totalCount">0</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-icon">ğŸ½ï¸</div>
                      <div class="stat-label">ç”¨é¤äººæ•¸</div>
                      <div class="stat-number" id="mealCount">0</div>
                  </div>
              </div>

              <div class="registration-list">
                  <div class="list-title">ğŸ“‹ æœ€æ–°å ±å</div>
                  <div id="registrationList">
                      <div class="empty-state">
                          <div class="empty-icon">ğŸ“</div>
                          <div>å°šç„¡å ±åè³‡æ–™</div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </main>

  <script>
      // ==================== è¨­å®šå€ ====================
      const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxjEaklhKK1XMNJo-DI94b2NbIjdAGMmhOF4vgOhgp3gKRMEDZmFW2ahfkXG704DJJX7Q/exec';
      
      // ==================== å…¨åŸŸè®Šæ•¸ ====================
      let registrations = [];
      let isSubmitting = false;
      let jsonpCounter = 0;
      let currentPage = 'info';
      
      // ==================== é é¢åˆ‡æ› ====================
      const navTabs = document.querySelectorAll('.nav-tab');
      const pages = document.querySelectorAll('.page');
      
      navTabs.forEach(tab => {
          tab.addEventListener('click', () => {
              const targetPage = tab.dataset.page;
              switchPage(targetPage);
          });
      });
      
      function switchPage(pageName) {
          currentPage = pageName;
          
          // æ›´æ–°å°èˆªæ¨™ç±¤
          navTabs.forEach(tab => {
              tab.classList.toggle('active', tab.dataset.page === pageName);
          });
          
          // æ›´æ–°é é¢é¡¯ç¤º
          pages.forEach(page => {
              page.classList.toggle('active', page.id === pageName + 'Page');
          });
          
          // è¼‰å…¥çµ±è¨ˆé é¢æ™‚æ›´æ–°è³‡æ–™
          if (pageName === 'stats') {
              loadRegistrations();
          }
      }
      
      // ==================== API å‡½æ•¸ ====================
      function jsonpRequest(url, callback) {
          const callbackName = 'jsonpCallback' + (jsonpCounter++);
          const script = document.createElement('script');
          
          window[callbackName] = function(data) {
              callback(data);
              document.head.removeChild(script);
              delete window[callbackName];
          };
          
          script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
          document.head.appendChild(script);
      }
      
      function loadFromGoogleSheets() {
          return new Promise((resolve) => {
              jsonpRequest(GAS_API_URL + '?action=getAll', (result) => {
                  if (result.success) {
                      console.log('è¼‰å…¥è³‡æ–™æˆåŠŸ:', result.data.length, 'ç­†');
                      resolve(result.data);
                  } else {
                      console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', result.message);
                      resolve([]);
                  }
              });
          });
      }
      
      // ==================== UI æ›´æ–°å‡½æ•¸ ====================
      function updateFee() {
          const typeRadios = document.querySelectorAll('input[name="type"]');
          const companions = parseInt(document.getElementById('companions').value) || 0;
          let baseFee = 0;
          
          typeRadios.forEach(radio => {
              if (radio.checked) {
                  baseFee = parseInt(radio.dataset.fee);
              }
          });
          
          const companionFee = companions * 700;
          const totalFee = baseFee + companionFee;
          
          document.getElementById('totalFee').textContent = `NT$ ${totalFee.toLocaleString()}`;
      }
      
      function updateRegistrationList() {
          const listContainer = document.getElementById('registrationList');
          
          if (registrations.length === 0) {
              listContainer.innerHTML = `
                  <div class="empty-state">
                      <div class="empty-icon">ğŸ“</div>
                      <div>å°šç„¡å ±åè³‡æ–™</div>
                  </div>
              `;
              document.getElementById('totalCount').textContent = '0';
              document.getElementById('mealCount').textContent = '0';
              return;
          }
          
          let totalPeople = 0;
          let mealCount = 0;
          
          registrations.forEach(reg => {
              totalPeople += 1 + (parseInt(reg.companions) || 0);
              const typeLabel = reg.typeLabel || '';
              if (typeLabel.includes('ç”¨é¤') || typeLabel.includes('é™ªä¼´') || typeLabel.includes('æ”œä¼´')) {
                  mealCount += 1 + (parseInt(reg.companions) || 0);
              }
          });
          
          document.getElementById('totalCount').textContent = totalPeople;
          document.getElementById('mealCount').textContent = mealCount;
          
          const sortedRegs = [...registrations].reverse();
          listContainer.innerHTML = sortedRegs.slice(0, 20).map(reg => `
              <div class="registration-item">
                  <div class="item-name">${reg.name}</div>
                  <div class="item-details">
                      ${reg.typeLabel}<br>
                      ğŸ“ ${reg.phone}
                      ${reg.companions > 0 ? `<br>ğŸ‘¥ åŒè¡Œ ${reg.companions} äºº` : ''}
                      ${reg.notes ? `<br>ğŸ“ ${reg.notes}` : ''}
                  </div>
                  <div class="item-fee">æ‡‰ç¹³: NT$ ${parseInt(reg.totalFee).toLocaleString()}</div>
              </div>
          `).join('');
      }
      
      function showToast(type, message) {
          const toast = document.getElementById('toast');
          toast.textContent = message;
          toast.className = `toast ${type} show`;
          
          setTimeout(() => {
              toast.classList.remove('show');
          }, 3000);
      }
      
      // ==================== è¡¨å–®è™•ç† ====================
      const radioOptions = document.querySelectorAll('.radio-option');
      radioOptions.forEach(option => {
          option.addEventListener('click', function() {
              radioOptions.forEach(opt => opt.classList.remove('checked'));
              this.classList.add('checked');
              const radio = this.querySelector('input[type="radio"]');
              radio.checked = true;
              updateFee();
          });
      });
      
      document.getElementById('companions').addEventListener('input', updateFee);
      
      document.getElementById('registrationForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          if (isSubmitting) return;
          
          isSubmitting = true;
          const submitBtn = document.getElementById('submitBtn');
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span class="loading-spinner"></span>é€å‡ºä¸­...';
          
          const formData = new FormData(e.target);
          const typeRadio = document.querySelector('input[name="type"]:checked');
          const companions = parseInt(formData.get('companions')) || 0;
          const baseFee = parseInt(typeRadio.dataset.fee);
          const totalFee = baseFee + (companions * 700);
          
          const registration = {
              action: 'add',
              name: formData.get('name'),
              phone: formData.get('phone'),
              email: formData.get('email') || '',
              type: typeRadio.value,
              typeLabel: typeRadio.parentElement.querySelector('.radio-label').textContent.split('\n')[0],
              companions: companions,
              totalFee: totalFee,
              notes: formData.get('notes') || ''
          };
          
          try {
              await fetch(GAS_API_URL, {
                  method: 'POST',
                  body: JSON.stringify(registration)
              });
              
              showToast('success', 'âœ… å ±åæˆåŠŸï¼æ„Ÿè¬æ‚¨çš„åƒèˆ‡');
              
              e.target.reset();
              radioOptions.forEach(opt => opt.classList.remove('checked'));
              updateFee();
              
              setTimeout(() => {
                  loadRegistrations();
              }, 2000);
              
          } catch (error) {
              showToast('success', 'âœ… å ±åè³‡æ–™å·²é€å‡ºï¼');
              
              e.target.reset();
              radioOptions.forEach(opt => opt.classList.remove('checked'));
              updateFee();
              
              setTimeout(() => {
                  loadRegistrations();
              }, 3000);
          }
          
          isSubmitting = false;
          submitBtn.disabled = false;
          submitBtn.textContent = 'ç¢ºèªå ±å';
      });
      
      // ==================== åˆå§‹åŒ– ====================
      async function loadRegistrations() {
          try {
              const data = await loadFromGoogleSheets();
              registrations = data;
              updateRegistrationList();
          } catch (error) {
              console.error('è¼‰å…¥å ±åè³‡æ–™å¤±æ•—:', error);
          }
      }
      
      // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
      window.addEventListener('DOMContentLoaded', function() {
          updateFee();
          loadRegistrations();
          
          // æ¯30ç§’è‡ªå‹•æ›´æ–°ä¸€æ¬¡è³‡æ–™
          setInterval(() => {
              if (currentPage === 'stats') {
                  loadRegistrations();
              }
          }, 30000);
      });
      
      // é˜²æ­¢é›™æ“Šç¸®æ”¾
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(event) {
          const now = Date.now();
          if (now - lastTouchEnd <= 300) {
              event.preventDefault();
          }
          lastTouchEnd = now;
      }, false);
  </script>
</body>
</html>
