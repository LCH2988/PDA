<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理後台 - 台灣帕金森病友會</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <style>
    :root {
      --primary-color: #00B900;
      --secondary-color: #06C755;
      --sidebar-width: 250px;
      --header-height: 60px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
      background: #f5f6fa;
      overflow-x: hidden;
    }

    /* 載入畫面 */
    #loadingScreen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(255,255,255,0.3);
      border-top: 5px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 側邊欄 */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 20px 0;
      z-index: 1000;
      overflow-y: auto;
      transition: transform 0.3s;
    }

    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      margin-bottom: 20px;
    }

    .sidebar-title {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .sidebar-subtitle {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
    }

    .sidebar-menu-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      color: white;
      text-decoration: none;
    }

    .sidebar-menu-item:hover {
      background: rgba(255,255,255,0.1);
      padding-left: 25px;
    }

    .sidebar-menu-item.active {
      background: rgba(255,255,255,0.2);
      border-left: 4px solid white;
    }

    .sidebar-menu-item i {
      margin-right: 10px;
      font-size: 1.2rem;
      width: 25px;
    }

    /* 主內容區 */
    .main-content {
      margin-left: var(--sidebar-width);
      min-height: 100vh;
      padding: 20px;
    }

    /* 頂部欄 */
    .top-bar {
      background: white;
      padding: 15px 25px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: #2c3e50;
      margin: 0;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid var(--primary-color);
    }

    /* 統計卡片 */
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      transition: transform 0.3s, box-shadow 0.3s;
      height: 100%;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .stat-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .stat-card-title {
      font-size: 0.9rem;
      color: #7f8c8d;
      font-weight: 500;
    }

    .stat-card-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .stat-card-value {
      font-size: 2.2rem;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .stat-card-change {
      font-size: 0.85rem;
      color: #27ae60;
    }

    .stat-card-change.negative {
      color: #e74c3c;
    }

    /* 卡片 */
    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 25px;
    }

    .card-header {
      background: white;
      border-bottom: 2px solid #f0f0f0;
      padding: 20px 25px;
      font-weight: bold;
      font-size: 1.1rem;
      color: #2c3e50;
      border-radius: 15px 15px 0 0 !important;
    }

    .card-body {
      padding: 25px;
    }

    /* 表格 */
    .table-container {
      overflow-x: auto;
    }

    .table {
      margin-bottom: 0;
    }

    .table thead th {
      background: #f8f9fa;
      border-bottom: 2px solid #dee2e6;
      font-weight: 600;
      color: #495057;
      white-space: nowrap;
    }

    .table tbody tr {
      transition: background 0.3s;
    }

    .table tbody tr:hover {
      background: #f8f9fa;
    }

    /* 按鈕 */
    .btn {
      border-radius: 10px;
      padding: 10px 20px;
      font-weight: 500;
      transition: all 0.3s;
      border: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,185,0,0.3);
    }

    .btn-sm {
      padding: 6px 15px;
      font-size: 0.9rem;
    }

    /* Badge */
    .badge {
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.85rem;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }

    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .badge-secondary {
      background: #e2e3e5;
      color: #383d41;
    }

    /* 表單 */
    .form-label {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    .form-control, .form-select {
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      padding: 12px 15px;
      transition: all 0.3s;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(0,185,0,0.15);
    }

    /* Modal */
    .modal-content {
      border-radius: 20px;
      border: none;
    }

    .modal-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border-radius: 20px 20px 0 0;
      padding: 20px 25px;
    }

    .modal-header .btn-close {
      filter: brightness(0) invert(1);
    }

    .modal-body {
      padding: 25px;
    }

    /* 頁面切換 */
    .page-section {
      display: none;
      animation: fadeIn 0.3s;
    }

    .page-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* 空狀態 */
    .empty-state {
      text-align: center;
      padding: 50px 20px;
      color: #999;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 15px;
      opacity: 0.3;
    }

    /* 響應式 */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.show {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .mobile-menu-btn {
        display: block !important;
      }
    }

    .mobile-menu-btn {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border: none;
      font-size: 1.5rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      z-index: 999;
    }

    /* 圖表容器 */
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <!-- 載入畫面 -->
  <div id="loadingScreen">
    <div class="spinner"></div>
    <p class="mt-3">載入中...</p>
  </div>

  <!-- 主應用程式 -->
  <div id="appContainer" style="display:none;">
    <!-- 側邊欄 -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">
          <i class="bi bi-heart-pulse"></i> 管理後台
        </div>
        <div class="sidebar-subtitle">台灣帕金森病友會</div>
      </div>
      <ul class="sidebar-menu">
        <li class="sidebar-menu-item active" onclick="switchPage('dashboard')">
          <i class="bi bi-speedometer2"></i>
          <span>儀表板</span>
        </li>
        <li class="sidebar-menu-item" onclick="switchPage('members')">
          <i class="bi bi-people"></i>
          <span>會員管理</span>
        </li>
        <li class="sidebar-menu-item" onclick="switchPage('activities')">
          <i class="bi bi-calendar-event"></i>
          <span>活動管理</span>
        </li>
        <li class="sidebar-menu-item" onclick="switchPage('registrations')">
          <i class="bi bi-list-check"></i>
          <span>報名管理</span>
        </li>
        <li class="sidebar-menu-item" onclick="switchPage('volunteers')">
          <i class="bi bi-heart"></i>
          <span>志工管理</span>
        </li>
        <li class="sidebar-menu-item" onclick="switchPage('finance')">
          <i class="bi bi-cash-stack"></i>
          <span>財務管理</span>
        </li>
        <li class="sidebar-menu-item" onclick="switchPage('statistics')">
          <i class="bi bi-graph-up"></i>
          <span>統計報表</span>
        </li>
        <li class="sidebar-menu-item" onclick="switchPage('settings')">
          <i class="bi bi-gear"></i>
          <span>系統設定</span>
        </li>
      </ul>
    </div>

    <!-- 主內容區 -->
    <div class="main-content">
      <!-- 頂部欄 -->
      <div class="top-bar">
        <h1 class="page-title" id="pageTitle">儀表板</h1>
        <div class="user-info">
          <span id="adminName">管理員</span>
          <img src="https://via.placeholder.com/40" alt="頭像" class="user-avatar" id="adminAvatar">
        </div>
      </div>

      <!-- 儀表板 -->
      <div id="dashboardPage" class="page-section active">
        <div class="row g-4 mb-4">
          <div class="col-md-3 col-sm-6">
            <div class="stat-card">
              <div class="stat-card-header">
                <div>
                  <div class="stat-card-title">總會員數</div>
                  <div class="stat-card-value" id="statTotalMembers">0</div>
                  <div class="stat-card-change">
                    <i class="bi bi-arrow-up"></i> 本月新增 <span id="statNewMembers">0</span>
                  </div>
                </div>
                <div class="stat-card-icon" style="background: #e3f2fd; color: #2196f3;">
                  <i class="bi bi-people"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6">
            <div class="stat-card">
              <div class="stat-card-header">
                <div>
                  <div class="stat-card-title">活動數量</div>
                  <div class="stat-card-value" id="statTotalActivities">0</div>
                  <div class="stat-card-change">
                    <i class="bi bi-calendar-check"></i> 進行中 <span id="statActiveActivities">0</span>
                  </div>
                </div>
                <div class="stat-card-icon" style="background: #f3e5f5; color: #9c27b0;">
                  <i class="bi bi-calendar-event"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6">
            <div class="stat-card">
              <div class="stat-card-header">
                <div>
                  <div class="stat-card-title">志工時數</div>
                  <div class="stat-card-value" id="statVolunteerHours">0</div>
                  <div class="stat-card-change">
                    <i class="bi bi-clock-history"></i> 累計服務時數
                  </div>
                </div>
                <div class="stat-card-icon" style="background: #e8f5e9; color: #4caf50;">
                  <i class="bi bi-heart"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6">
            <div class="stat-card">
              <div class="stat-card-header">
                <div>
                  <div class="stat-card-title">財務餘額</div>
                  <div class="stat-card-value" id="statBalance">$0</div>
                  <div class="stat-card-change">
                    <i class="bi bi-cash"></i> 本月收支
                  </div>
                </div>
                <div class="stat-card-icon" style="background: #fff3e0; color: #ff9800;">
                  <i class="bi bi-cash-stack"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-4">
          <div class="col-lg-8">
            <div class="card">
              <div class="card-header">
                <i class="bi bi-graph-up"></i> 會員成長趨勢
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="memberGrowthChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card">
              <div class="card-header">
                <i class="bi bi-pie-chart"></i> 會員類型分布
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="memberTypeChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-4 mt-2">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <i class="bi bi-calendar-check"></i> 近期活動
              </div>
              <div class="card-body">
                <div id="recentActivitiesContainer">
                  <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p>載入中...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 會員管理 -->
      <div id="membersPage" class="page-section">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-people"></i> 會員列表</span>
            <div>
              <input type="text" class="form-control form-control-sm d-inline-block" style="width: 250px;" 
                     id="memberSearch" placeholder="搜尋會員...">
            </div>
          </div>
          <div class="card-body">
            <div class="table-container">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>會員編號</th>
                    <th>姓名</th>
                    <th>類型</th>
                    <th>電話</th>
                    <th>Email</th>
                    <th>加入日期</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="membersTableBody">
                  <tr>
                    <td colspan="7" class="text-center text-muted">載入中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 活動管理 -->
      <div id="activitiesPage" class="page-section">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-calendar-event"></i> 活動列表</span>
            <button class="btn btn-primary btn-sm" onclick="showAddActivityModal()">
              <i class="bi bi-plus-circle"></i> 新增活動
            </button>
          </div>
          <div class="card-body">
            <div class="table-container">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>活動編號</th>
                    <th>活動名稱</th>
                    <th>類型</th>
                    <th>日期</th>
                    <th>地點</th>
                    <th>報名人數</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="activitiesTableBody">
                  <tr>
                    <td colspan="8" class="text-center text-muted">載入中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 報名管理 -->
      <div id="registrationsPage" class="page-section">
        <div class="card">
          <div class="card-header">
            <i class="bi bi-list-check"></i> 報名記錄
          </div>
          <div class="card-body">
            <div class="table-container">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>報名編號</th>
                    <th>會員姓名</th>
                    <th>活動名稱</th>
                    <th>報名時間</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="registrationsTableBody">
                  <tr>
                    <td colspan="6" class="text-center text-muted">載入中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 志工管理 -->
      <div id="volunteersPage" class="page-section">
        <div class="card">
          <div class="card-header">
            <i class="bi bi-heart"></i> 志工服務記錄
          </div>
          <div class="card-body">
            <div class="table-container">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>記錄編號</th>
                    <th>志工姓名</th>
                    <th>服務日期</th>
                    <th>服務時數</th>
                    <th>服務項目</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="volunteersTableBody">
                  <tr>
                    <td colspan="7" class="text-center text-muted">載入中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 財務管理 -->
      <div id="financePage" class="page-section">
        <div class="row g-4 mb-4">
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-card-title">總收入</div>
              <div class="stat-card-value text-success" id="finTotalIncome">$0</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-card-title">總支出</div>
              <div class="stat-card-value text-danger" id="finTotalExpense">$0</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-card-title">餘額</div>
              <div class="stat-card-value text-primary" id="finBalance">$0</div>
            </div>
          </div>
        </div>

        <div class="row g-4">
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-arrow-down-circle"></i> 捐款記錄</span>
                <button class="btn btn-primary btn-sm" onclick="showAddDonationModal()">
                  <i class="bi bi-plus-circle"></i> 新增捐款
                </button>
              </div>
              <div class="card-body">
                <div class="table-container">
                  <table class="table table-hover table-sm">
                    <thead>
                      <tr>
                        <th>捐款人</th>
                        <th>金額</th>
                        <th>日期</th>
                        <th>方式</th>
                      </tr>
                    </thead>
                    <tbody id="donationsTableBody">
                      <tr>
                        <td colspan="4" class="text-center text-muted">載入中...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-arrow-up-circle"></i> 支出記錄</span>
                <button class="btn btn-primary btn-sm" onclick="showAddExpenseModal()">
                  <i class="bi bi-plus-circle"></i> 新增支出
                </button>
              </div>
              <div class="card-body">
                <div class="table-container">
                  <table class="table table-hover table-sm">
                    <thead>
                      <tr>
                        <th>項目</th>
                        <th>金額</th>
                        <th>日期</th>
                        <th>狀態</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="expensesTableBody">
                      <tr>
                        <td colspan="5" class="text-center text-muted">載入中...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 統計報表 -->
      <div id="statisticsPage" class="page-section">
        <div class="row g-4">
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <i class="bi bi-bar-chart"></i> 活動類型統計
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="activityTypeChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <i class="bi bi-graph-up"></i> 志工服務統計
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="volunteerStatsChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 系統設定 -->
      <div id="settingsPage" class="page-section">
        <div class="card">
          <div class="card-header">
            <i class="bi bi-gear"></i> 系統設定
          </div>
          <div class="card-body">
            <form id="settingsForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">組織名稱</label>
                  <input type="text" class="form-control" id="setOrgName" value="台灣帕金森病友會">
                </div>
                <div class="col-md-6">
                  <label class="form-label">聯絡電話</label>
                  <input type="tel" class="form-control" id="setPhone">
                </div>
                <div class="col-md-6">
                  <label class="form-label">聯絡Email</label>
                  <input type="email" class="form-control" id="setEmail">
                </div>
                <div class="col-md-6">
                  <label class="form-label">組織地址</label>
                  <input type="text" class="form-control" id="setAddress">
                </div>
                <div class="col-12">
                  <label class="form-label">LINE Notify Token</label>
                  <input type="text" class="form-control" id="setLineNotifyToken" placeholder="用於發送通知">
                </div>
                <div class="col-12">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> 儲存設定
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <div class="card mt-4">
          <div class="card-header">
            <i class="bi bi-shield-check"></i> 管理員帳號
          </div>
          <div class="card-body">
            <div class="table-container">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>姓名</th>
                    <th>LINE ID</th>
                    <th>權限</th>
                    <th>加入日期</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="adminsTableBody">
                  <tr>
                    <td colspan="5" class="text-center text-muted">載入中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button class="btn btn-primary mt-3" onclick="showAddAdminModal()">
              <i class="bi bi-plus-circle"></i> 新增管理員
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 手機選單按鈕 -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
      <i class="bi bi-list"></i>
    </button>
  </div>

  <!-- 新增活動 Modal -->
  <div class="modal fade" id="addActivityModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 新增活動</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addActivityForm">
            <div class="row g-3">
              <div class="col-md-8">
                <label class="form-label">活動名稱 *</label>
                <input type="text" class="form-control" id="actTitle" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">活動類型 *</label>
                <select class="form-select" id="actType" required>
                  <option value="">請選擇</option>
                  <option value="健康講座">健康講座</option>
                  <option value="復健課程">復健課程</option>
                  <option value="社交活動">社交活動</option>
                  <option value="志工培訓">志工培訓</option>
                  <option value="戶外活動">戶外活動</option>
                  <option value="其他">其他</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">活動日期 *</label>
                <input type="date" class="form-control" id="actDate" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">活動時間</label>
                <input type="time" class="form-control" id="actTime">
              </div>
              <div class="col-md-8">
                <label class="form-label">活動地點</label>
                <input type="text" class="form-control" id="actLocation">
              </div>
              <div class="col-md-4">
                <label class="form-label">活動費用</label>
                <input type="number" class="form-control" id="actFee" value="0" min="0">
              </div>
              <div class="col-md-6">
                <label class="form-label">人數上限</label>
                <input type="number" class="form-control" id="actMaxParticipants" min="0" placeholder="0 = 不限">
              </div>
              <div class="col-md-6">
                <label class="form-label">報名截止日期</label>
                <input type="date" class="form-control" id="actDeadline">
              </div>
              <div class="col-12">
                <label class="form-label">活動說明</label>
                <textarea class="form-control" id="actDescription" rows="4"></textarea>
              </div>
              <div class="col-12">
                <label class="form-label">備註</label>
                <textarea class="form-control" id="actNote" rows="2"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">活動狀態</label>
                <select class="form-select" id="actStatus">
                  <option value="報名中">報名中</option>
                  <option value="已額滿">已額滿</option>
                  <option value="已結束">已結束</option>
                  <option value="已取消">已取消</option>
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitActivity()">
            <i class="bi bi-check-circle"></i> 新增
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 編輯活動 Modal -->
  <div class="modal fade" id="editActivityModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil"></i> 編輯活動</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editActivityForm">
            <input type="hidden" id="editActId">
            <div class="row g-3">
              <div class="col-md-8">
                <label class="form-label">活動名稱 *</label>
                <input type="text" class="form-control" id="editActTitle" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">活動類型 *</label>
                <select class="form-select" id="editActType" required>
                  <option value="健康講座">健康講座</option>
                  <option value="復健課程">復健課程</option>
                  <option value="社交活動">社交活動</option>
                  <option value="志工培訓">志工培訓</option>
                  <option value="戶外活動">戶外活動</option>
                  <option value="其他">其他</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">活動日期 *</label>
                <input type="date" class="form-control" id="editActDate" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">活動時間</label>
                <input type="time" class="form-control" id="editActTime">
              </div>
              <div class="col-md-8">
                <label class="form-label">活動地點</label>
                <input type="text" class="form-control" id="editActLocation">
              </div>
              <div class="col-md-4">
                <label class="form-label">活動費用</label>
                <input type="number" class="form-control" id="editActFee" min="0">
              </div>
              <div class="col-md-6">
                <label class="form-label">人數上限</label>
                <input type="number" class="form-control" id="editActMaxParticipants" min="0">
              </div>
              <div class="col-md-6">
                <label class="form-label">報名截止日期</label>
                <input type="date" class="form-control" id="editActDeadline">
              </div>
              <div class="col-12">
                <label class="form-label">活動說明</label>
                <textarea class="form-control" id="editActDescription" rows="4"></textarea>
              </div>
              <div class="col-12">
                <label class="form-label">備註</label>
                <textarea class="form-control" id="editActNote" rows="2"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">活動狀態</label>
                <select class="form-select" id="editActStatus">
                  <option value="報名中">報名中</option>
                  <option value="已額滿">已額滿</option>
                  <option value="已結束">已結束</option>
                  <option value="已取消">已取消</option>
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="updateActivity()">
            <i class="bi bi-check-circle"></i> 更新
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 會員詳情 Modal -->
  <div class="modal fade" id="memberDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-person-circle"></i> 會員詳情</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="memberDetailContent">
          <p class="text-muted">載入中...</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 新增捐款 Modal -->
  <div class="modal fade" id="addDonationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 新增捐款</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addDonationForm">
            <div class="mb-3">
              <label class="form-label">捐款人 *</label>
              <input type="text" class="form-control" id="donDonor" required>
            </div>
            <div class="mb-3">
              <label class="form-label">捐款金額 *</label>
              <input type="number" class="form-control" id="donAmount" min="1" required>
            </div>
            <div class="mb-3">
              <label class="form-label">捐款日期 *</label>
              <input type="date" class="form-control" id="donDate" required>
            </div>
            <div class="mb-3">
              <label class="form-label">捐款方式</label>
              <select class="form-select" id="donMethod">
                <option value="現金">現金</option>
                <option value="轉帳">轉帳</option>
                <option value="支票">支票</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">備註</label>
              <textarea class="form-control" id="donNote" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitDonation()">
            <i class="bi bi-check-circle"></i> 新增
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 新增支出 Modal -->
  <div class="modal fade" id="addExpenseModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 新增支出</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addExpenseForm">
            <div class="mb-3">
              <label class="form-label">支出項目 *</label>
              <input type="text" class="form-control" id="expItem" required>
            </div>
            <div class="mb-3">
              <label class="form-label">支出金額 *</label>
              <input type="number" class="form-control" id="expAmount" min="1" required>
            </div>
            <div class="mb-3">
              <label class="form-label">支出日期 *</label>
              <input type="date" class="form-control" id="expDate" required>
            </div>
            <div class="mb-3">
              <label class="form-label">支出類別</label>
              <select class="form-select" id="expCategory">
                <option value="活動費用">活動費用</option>
                <option value="場地租金">場地租金</option>
                <option value="行政費用">行政費用</option>
                <option value="設備購置">設備購置</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">備註</label>
              <textarea class="form-control" id="expNote" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitExpense()">
            <i class="bi bi-check-circle"></i> 新增
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 新增管理員 Modal -->
  <div class="modal fade" id="addAdminModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 新增管理員</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addAdminForm">
            <div class="mb-3">
              <label class="form-label">LINE User ID *</label>
              <input type="text" class="form-control" id="adminLineUserId" required>
              <small class="text-muted">請輸入要設為管理員的 LINE User ID</small>
            </div>
            <div class="mb-3">
              <label class="form-label">姓名 *</label>
              <input type="text" class="form-control" id="adminName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">權限</label>
              <select class="form-select" id="adminRole">
                <option value="管理員">管理員</option>
                <option value="超級管理員">超級管理員</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitAdmin()">
            <i class="bi bi-check-circle"></i> 新增
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==================== 配置 ====================
    const CONFIG = {
      API_URL: 'https://script.google.com/macros/s/AKfycbwVc7nAnCSwrwUDv9hHEMWmhmHFhLGdWR9LSi06kKLqu65-gNrBSc0YbB8QHECHhtjUKg/exec' // 請替換為您的 GAS Web App URL
    };

    // ==================== 全域變數 ====================
    let allMembers = [];
    let allActivities = [];
    let allRegistrations = [];
    let allVolunteers = [];
    let currentEditActivityId = null;

    // ==================== 初始化 ====================
    window.addEventListener('load', () => {
      initializeAdmin();
    });

    async function initializeAdmin() {
      try {
        // 載入儀表板資料
        await loadDashboard();
        hideLoading();
      } catch (error) {
        console.error('初始化失敗:', error);
        hideLoading();
        showAlert('系統初始化失敗', 'danger');
      }
    }

    // ==================== 儀表板 ====================
    async function loadDashboard() {
      try {
        const response = await apiCall('getAdminDashboard', {});
        
        if (response.success) {
          const data = response.data;
          
          // 更新統計數據
          document.getElementById('statTotalMembers').textContent = data.totalMembers || 0;
          document.getElementById('statNewMembers').textContent = data.newMembers || 0;
          document.getElementById('statTotalActivities').textContent = data.totalActivities || 0;
          document.getElementById('statActiveActivities').textContent = data.activeActivities || 0;
          document.getElementById('statVolunteerHours').textContent = data.volunteerHours || 0;
          document.getElementById('statBalance').textContent = '$' + (data.balance || 0).toLocaleString();
          
          // 顯示近期活動
          displayRecentActivities(data.recentActivities || []);
          
          // 繪製圖表
          drawMemberGrowthChart(data.memberGrowth || []);
          drawMemberTypeChart(data.memberTypes || {});
        }
      } catch (error) {
        console.error('載入儀表板失敗:', error);
      }
    }

    function displayRecentActivities(activities) {
      const container = document.getElementById('recentActivitiesContainer');
      
      if (!activities || activities.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有近期活動</p></div>';
        return;
      }

      container.innerHTML = `
        <div class="table-container">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>活動名稱</th>
                <th>類型</th>
                <th>日期</th>
                <th>報名人數</th>
                <th>狀態</th>
              </tr>
            </thead>
            <tbody>
              ${activities.map(act => `
                <tr>
                  <td>${act.title}</td>
                  <td>${act.type}</td>
                  <td>${formatDate(act.date)}</td>
                  <td>${act.currentParticipants}/${act.maxParticipants || '不限'}</td>
                  <td><span class="badge badge-${getStatusClass(act.status)}">${act.status}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function drawMemberGrowthChart(data) {
      const ctx = document.getElementById('memberGrowthChart');
      if (!ctx) return;
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => d.month) || ['1月', '2月', '3月', '4月', '5月', '6月'],
          datasets: [{
            label: '會員數',
            data: data.map(d => d.count) || [10, 15, 22, 28, 35, 42],
            borderColor: '#00B900',
            backgroundColor: 'rgba(0, 185, 0, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function drawMemberTypeChart(data) {
      const ctx = document.getElementById('memberTypeChart');
      if (!ctx) return;
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(data).length > 0 ? Object.keys(data) : ['病友', '家屬', '志工', '其他'],
          datasets: [{
            data: Object.keys(data).length > 0 ? Object.values(data) : [45, 30, 15, 10],
            backgroundColor: ['#00B900', '#06C755', '#4CAF50', '#8BC34A']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // ==================== 會員管理 ====================
    async function loadMembers() {
      try {
        const response = await apiCall('getAllMembers', {});
        
        if (response.success) {
          allMembers = response.data || [];
          displayMembers(allMembers);
        }
      } catch (error) {
        console.error('載入會員失敗:', error);
        document.getElementById('membersTableBody').innerHTML = 
          '<tr><td colspan="7" class="text-center text-danger">載入失敗</td></tr>';
      }
    }

    function displayMembers(members) {
      const tbody = document.getElementById('membersTableBody');
      
      if (!members || members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">沒有會員資料</td></tr>';
        return;
      }

      tbody.innerHTML = members.map(member => `
        <tr>
          <td>${member.id || '-'}</td>
          <td>${member.realName || member.lineDisplayName || '-'}</td>
          <td><span class="badge badge-info">${member.memberType || '一般會員'}</span></td>
          <td>${member.phone || '-'}</td>
          <td>${member.email || '-'}</td>
          <td>${formatDate(member.joinDate)}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="showMemberDetail('${member.lineUserId}')">
              <i class="bi bi-eye"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    // 搜尋會員
    document.getElementById('memberSearch').addEventListener('input', (e) => {
      const keyword = e.target.value.toLowerCase();
      const filtered = allMembers.filter(member => 
        (member.realName && member.realName.toLowerCase().includes(keyword)) ||
        (member.lineDisplayName && member.lineDisplayName.toLowerCase().includes(keyword)) ||
        (member.phone && member.phone.includes(keyword)) ||
        (member.email && member.email.toLowerCase().includes(keyword))
      );
      displayMembers(filtered);
    });

    async function showMemberDetail(lineUserId) {
      try {
        const response = await apiCall('getMemberProfile', { lineUserId });
        
        if (response.success) {
          const member = response.data;
          const modal = new bootstrap.Modal(document.getElementById('memberDetailModal'));
          
          document.getElementById('memberDetailContent').innerHTML = `
            <div class="row g-3">
              <div class="col-md-6">
                <strong>會員編號：</strong> ${member.id || '-'}
              </div>
              <div class="col-md-6">
                <strong>真實姓名：</strong> ${member.realName || '-'}
              </div>
              <div class="col-md-6">
                <strong>LINE 名稱：</strong> ${member.lineDisplayName || '-'}
              </div>
              <div class="col-md-6">
                <strong>會員類型：</strong> ${member.memberType || '-'}
              </div>
              <div class="col-md-6">
                <strong>性別：</strong> ${member.gender || '-'}
              </div>
              <div class="col-md-6">
                <strong>生日：</strong> ${formatDate(member.birthday) || '-'}
              </div>
              <div class="col-md-6">
                <strong>電話：</strong> ${member.phone || '-'}
              </div>
              <div class="col-md-6">
                <strong>Email：</strong> ${member.email || '-'}
              </div>
              <div class="col-12">
                <strong>地址：</strong> ${member.address || '-'}
              </div>
              <div class="col-12">
                <strong>疾病狀態：</strong> ${member.diseaseStatus || '-'}
              </div>
              <div class="col-md-6">
                <strong>確診日期：</strong> ${formatDate(member.diagnosisDate) || '-'}
              </div>
              <div class="col-md-6">
                <strong>加入日期：</strong> ${formatDateTime(member.joinDate)}
              </div>
              <div class="col-md-6">
                <strong>緊急聯絡人：</strong> ${member.emergencyContact || '-'}
              </div>
              <div class="col-md-6">
                <strong>緊急聯絡電話：</strong> ${member.emergencyPhone || '-'}
              </div>
            </div>
          `;
          
          modal.show();
        }
      } catch (error) {
        console.error('載入會員詳情失敗:', error);
        showAlert('載入失敗', 'danger');
      }
    }

    // ==================== 活動管理 ====================
    async function loadActivities() {
      try {
        const response = await apiCall('getAllActivities', {});
        
        if (response.success) {
          allActivities = response.data || [];
          displayActivitiesTable(allActivities);
        }
      } catch (error) {
        console.error('載入活動失敗:', error);
        document.getElementById('activitiesTableBody').innerHTML = 
          '<tr><td colspan="8" class="text-center text-danger">載入失敗</td></tr>';
      }
    }

    function displayActivitiesTable(activities) {
      const tbody = document.getElementById('activitiesTableBody');
      
      if (!activities || activities.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">沒有活動資料</td></tr>';
        return;
      }

      tbody.innerHTML = activities.map(act => `
        <tr>
          <td>${act.id || '-'}</td>
          <td>${act.title}</td>
          <td><span class="badge badge-info">${act.type}</span></td>
          <td>${formatDate(act.date)}</td>
          <td>${act.location || '-'}</td>
          <td>${act.currentParticipants || 0}/${act.maxParticipants || '不限'}</td>
          <td><span class="badge badge-${getStatusClass(act.status)}">${act.status}</span></td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="editActivity('${act.id}')">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteActivity('${act.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    function showAddActivityModal() {
      const modal = new bootstrap.Modal(document.getElementById('addActivityModal'));
      document.getElementById('addActivityForm').reset();
      modal.show();
    }

    async function submitActivity() {
      const form = document.getElementById('addActivityForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const activityData = {
        title: document.getElementById('actTitle').value,
        type: document.getElementById('actType').value,
        date: document.getElementById('actDate').value,
        time: document.getElementById('actTime').value,
        location: document.getElementById('actLocation').value,
        fee: parseFloat(document.getElementById('actFee').value) || 0,
        maxParticipants: parseInt(document.getElementById('actMaxParticipants').value) || 0,
        registrationDeadline: document.getElementById('actDeadline').value,
        description: document.getElementById('actDescription').value,
        note: document.getElementById('actNote').value,
        status: document.getElementById('actStatus').value,
        currentParticipants: 0
      };

      try {
        const response = await apiCall('addActivity', { activityData });
        
        if (response.success) {
          showAlert('活動新增成功', 'success');
          bootstrap.Modal.getInstance(document.getElementById('addActivityModal')).hide();
          loadActivities();
          loadDashboard();
        } else {
          showAlert('新增失敗：' + response.message, 'danger');
        }
      } catch (error) {
        console.error('新增活動失敗:', error);
        showAlert('新增失敗', 'danger');
      }
    }

    async function editActivity(activityId) {
      try {
        const response = await apiCall('getActivityById', activityId);
        
        if (response.success) {
          const activity = response.data;
          currentEditActivityId = activityId;
          
          document.getElementById('editActId').value = activityId;
          document.getElementById('editActTitle').value = activity.title;
          document.getElementById('editActType').value = activity.type;
          document.getElementById('editActDate').value = activity.date;
          document.getElementById('editActTime').value = activity.time || '';
          document.getElementById('editActLocation').value = activity.location || '';
          document.getElementById('editActFee').value = activity.fee || 0;
          document.getElementById('editActMaxParticipants').value = activity.maxParticipants || 0;
          document.getElementById('editActDeadline').value = activity.registrationDeadline || '';
          document.getElementById('editActDescription').value = activity.description || '';
          document.getElementById('editActNote').value = activity.note || '';
          document.getElementById('editActStatus').value = activity.status;
          
          const modal = new bootstrap.Modal(document.getElementById('editActivityModal'));
          modal.show();
        }
      } catch (error) {
        console.error('載入活動失敗:', error);
        showAlert('載入失敗', 'danger');
      }
    }

    async function updateActivity() {
      const form = document.getElementById('editActivityForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const activityData = {
        title: document.getElementById('editActTitle').value,
        type: document.getElementById('editActType').value,
        date: document.getElementById('editActDate').value,
        time: document.getElementById('editActTime').value,
        location: document.getElementById('editActLocation').value,
        fee: parseFloat(document.getElementById('editActFee').value) || 0,
        maxParticipants: parseInt(document.getElementById('editActMaxParticipants').value) || 0,
        registrationDeadline: document.getElementById('editActDeadline').value,
        description: document.getElementById('editActDescription').value,
        note: document.getElementById('editActNote').value,
        status: document.getElementById('editActStatus').value
      };

      try {
        const response = await apiCall('updateActivity', {
          activityId: currentEditActivityId,
          activityData
        });
        
        if (response.success) {
          showAlert('活動更新成功', 'success');
          bootstrap.Modal.getInstance(document.getElementById('editActivityModal')).hide();
          loadActivities();
          loadDashboard();
        } else {
          showAlert('更新失敗：' + response.message, 'danger');
        }
      } catch (error) {
        console.error('更新活動失敗:', error);
        showAlert('更新失敗', 'danger');
      }
    }

    async function deleteActivity(activityId) {
      if (!confirm('確定要刪除此活動嗎？此操作無法復原。')) return;
      
      try {
        const response = await apiCall('deleteActivity', { activityId });
        
        if (response.success) {
          showAlert('活動已刪除', 'success');
          loadActivities();
          loadDashboard();
        } else {
          showAlert('刪除失敗：' + response.message, 'danger');
        }
      } catch (error) {
        console.error('刪除活動失敗:', error);
        showAlert('刪除失敗', 'danger');
      }
    }

    // ==================== 報名管理 ====================
    async function loadRegistrations() {
      try {
        const response = await apiCall('getAllRegistrations', {});
        
        if (response.success) {
          allRegistrations = response.data || [];
          displayRegistrations(allRegistrations);
        }
      } catch (error) {
        console.error('載入報名記錄失敗:', error);
        document.getElementById('registrationsTableBody').innerHTML = 
          '<tr><td colspan="6" class="text-center text-danger">載入失敗</td></tr>';
      }
    }

    function displayRegistrations(registrations) {
      const tbody = document.getElementById('registrationsTableBody');
      
      if (!registrations || registrations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">沒有報名記錄</td></tr>';
        return;
      }

      tbody.innerHTML = registrations.map(reg => `
        <tr>
          <td>${reg.id || '-'}</td>
          <td>${reg.memberName || '-'}</td>
          <td>${reg.activityTitle || '-'}</td>
          <td>${formatDateTime(reg.registeredAt)}</td>
          <td><span class="badge badge-${reg.status === '已報名' ? 'success' : 'secondary'}">${reg.status}</span></td>
          <td>
            ${reg.status === '已報名' ? `
              <button class="btn btn-sm btn-danger" onclick="cancelRegistrationAdmin('${reg.id}')">
                <i class="bi bi-x-circle"></i> 取消
              </button>
            ` : '-'}
          </td>
        </tr>
      `).join('');
    }

    async function cancelRegistrationAdmin(registrationId) {
      if (!confirm('確定要取消此報名嗎？')) return;
      
      try {
        const response = await apiCall('cancelRegistrationAdmin', { registrationId });
        
        if (response.success) {
          showAlert('已取消報名', 'success');
          loadRegistrations();
          loadDashboard();
        } else {
          showAlert('取消失敗：' + response.message, 'danger');
        }
      } catch (error) {
        console.error('取消報名失敗:', error);
        showAlert('取消失敗', 'danger');
      }
    }

    // ==================== 志工管理 ====================
    async function loadVolunteers() {
      try {
        const response = await apiCall('getAllVolunteerRecords', {});
        
        if (response.success) {
          allVolunteers = response.data || [];
          displayVolunteers(allVolunteers);
        }
      } catch (error) {
        console.error('載入志工記錄失敗:', error);
        document.getElementById('volunteersTableBody').innerHTML = 
          '<tr><td colspan="7" class="text-center text-danger">載入失敗</td></tr>';
      }
    }

    function displayVolunteers(volunteers) {
      const tbody = document.getElementById('volunteersTableBody');
      
      if (!volunteers || volunteers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">沒有志工記錄</td></tr>';
        return;
      }

      tbody.innerHTML = volunteers.map(vol => `
        <tr>
          <td>${vol.id || '-'}</td>
          <td>${vol.memberName || '-'}</td>
          <td>${formatDate(vol.date)}</td>
          <td>${vol.hours} 小時</td>
          <td>${vol.activity || '-'}</td>
          <td><span class="badge badge-${getVolunteerStatusClass(vol.status)}">${vol.status}</span></td>
          <td>
            ${vol.status === '待審核' ? `
              <button class="btn btn-sm btn-success" onclick="approveVolunteer('${vol.id}')">
                <i class="bi bi-check"></i> 核准
              </button>
              <button class="btn btn-sm btn-danger" onclick="rejectVolunteer('${vol.id}')">
                <i class="bi bi-x"></i> 拒絕
              </button>
            ` : '-'}
          </td>
        </tr>
      `).join('');
    }

    async function approveVolunteer(recordId) {
      try {
        const response = await apiCall('approveVolunteerRecord', { recordId });
        
        if (response.success) {
          showAlert('已核准志工記錄', 'success');
          loadVolunteers();
          loadDashboard();
        } else {
          showAlert('核准失敗：' + response.message, 'danger');
        }
      } catch (error) {
        console.error('核准失敗:', error);
        showAlert('核准失敗', 'danger');
      }
    }

    async function rejectVolunteer(recordId) {
      if (!confirm('確定要拒絕此志工記錄嗎？')) return;
      
      try {
        const response = await apiCall('rejectVolunteerRecord', { recordId });
        
        if (response.success) {
          showAlert('已拒絕志工記錄', 'success');
          loadVolunteers();
        } else {
          showAlert('拒絕失敗：' + response.message, 'danger');
        }
      } catch (error) {
        console.error('拒絕失敗:', error);
        showAlert('拒絕失敗', 'danger');
      }
    }

    // ==================== 財務管理 ====================
    async function loadFinance() {
      try {
        const response = await apiCall('getFinanceData', {});
        
        if (response.success) {
          const data = response.data;
          
          document.getElementById('finTotalIncome').textContent = '$' + (data.totalIncome || 0).toLocaleString();
          document.getElementById('finTotalExpense').textContent = '$' + (data.totalExpense || 0).toLocaleString();
          document.getElementById('finBalance').textContent = '$' + (data.balance || 0).toLocaleString();
          
          displayDonations(data.donations || []);
          displayExpenses(data.expenses || []);
        }
      } catch (error) {
        console.error('載入財務資料失敗:', error);
      }
    }

    function displayDonations(donations) {
      const tbody = document.getElementById('donationsTableBody');
      
      if (!donations || donations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">沒有捐款記錄</td></tr>';
        return;
      }

      tbody.innerHTML = donations.map(don => `
        <tr>
          <td>${don.donor}</td>
          <td class="text-success">$${don.amount.toLocaleString()}</td>
          <td>${formatDate(don.date)}</td>
          <td><span class="badge badge-info">${don.method}</span></td>
        </tr>
      `).join('');
    }

    function displayExpenses(expenses) {
      const tbody = document.getElementById('expensesTableBody');
      
      if (!expenses || expenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">沒有支出記錄</td></tr>';
        return;
      }

      tbody.innerHTML = expenses.map(exp => `
        <tr>
          <td>${exp.item}</td>
          <td class="text-danger">$${exp.amount.toLocaleString()}</td>
          <td>${formatDate(exp.date)}</td>
          <td><span class="badge badge-${exp.status === '已核銷' ? 'success' : 'warning'}">${exp.status}</span></td>
          <td>
            ${exp.status === '待核銷' ? `
              <button class="btn btn-sm btn-success" onclick="approveExpense('${exp.id}')">
                <i class="bi bi-check"></i>
              </button>
            ` : '-'}
          </td>
        </tr>
      `).join('');
    }

    function showAddDonationModal() {
      const modal = new bootstrap.Modal(document.getElementById('addDonationModal'));
      document.getElementById('addDonationForm').reset();
      // 設定今天日期
      document.getElementById('donDate').valueAsDate = new Date();
      modal.show();
    }

    async function submitDonation() {
      const form = document.getElementById('addDonationForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const donationData = {
        donor: document.getElementById('donDonor').value,
        amount: parseFloat(document.getElementById('donAmount').value),
        date: document.getElementById('donDate').value,
        method: document.getElementById('donMethod').value,
        note: document.getElementById('donNote').value
      };

      try {
        const response = await apiCall('addDonation', { donationData });
        
        if (response.success) {
          showAlert('捐款記錄已新增', 'success');
          bootstrap.Modal.getInstance(document.getElementById('addDonationModal')).hide();
          loadFinance();
          loadDashboard();
        } else {
          showAlert('新增失敗：' + response.message, 'danger');
        }
      } catch (error) {
        console.error('新增捐款失敗:', error);
        showAlert('新增失敗', 'danger');
      }
    }

    function showAddExpenseModal() {
      const modal = new bootstrap.Modal(document.getElementById('addExpenseModal'));
      document.getElementById('addExpenseForm').reset();
      document.getElementById('expDate').valueAsDate = new Date();
      modal.show();
    }

    async function submitExpense() {
      const form = document.getElementById('addExpenseForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const expenseData = {
        item: document.getElementById('expItem').value,
        amount: parseFloat(document.getElementById('expAmount').value),
        date: document.getElementById('expDate').value,
        category: document.getElementById('expCategory').value,
        note: document.getElementById('expNote').value,
        status: '已核銷'
      };

      try {
        const response = await apiCall('addExpense', { expenseData });
        
        if (response.success) {
          showAlert('支出記錄已新增', 'success');
          bootstrap.Modal.getInstance(document.getElementById('addExpenseModal')).hide();
          loadFinance();
          loadDashboard();
        } else {
          showAlert('新增失敗：' + response.message, 'danger');
        }
      } catch (error) {
        console.error('新增支出失敗:', error);
        showAlert('新增失敗', 'danger');
      }
    }

    async function approveExpense(expenseId) {
      try {
        const response = await apiCall('approveExpense', { expenseId });
        
        if (response.success) {
          showAlert('已核銷', 'success');
          loadFinance();
        } else {
          showAlert('核銷失敗：' + response.message, 'danger');
        }
      } catch (error) {
        console.error('核銷失敗:', error);
        showAlert('核銷失敗', 'danger');
      }
    }

    // ==================== 統計報表 ====================
    async function loadStatistics() {
      try {
        const response = await apiCall('getStatistics', {});
        
        if (response.success) {
          const data = response.data;
          
          drawActivityTypeChart(data.activityTypes || {});
          drawVolunteerStatsChart(data.volunteerStats || []);
        }
      } catch (error) {
        console.error('載入統計資料失敗:', error);
      }
    }

    function drawActivityTypeChart(data) {
      const ctx = document.getElementById('activityTypeChart');
      if (!ctx) return;
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(data).length > 0 ? Object.keys(data) : ['健康講座', '復健課程', '社交活動', '志工培訓'],
          datasets: [{
            label: '活動數量',
            data: Object.keys(data).length > 0 ? Object.values(data) : [8, 5, 12, 3],
            backgroundColor: ['#00B900', '#06C755', '#4CAF50', '#8BC34A']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function drawVolunteerStatsChart(data) {
      const ctx = document.getElementById('volunteerStatsChart');
      if (!ctx) return;
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => d.month) || ['1月', '2月', '3月', '4月', '5月', '6月'],
          datasets: [{
            label: '服務時數',
            data: data.map(d => d.hours) || [20, 35, 28, 42, 38, 50],
            borderColor: '#00B900',
            backgroundColor: 'rgba(0, 185, 0, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // ==================== 系統設定 ====================
    async function loadSettings() {
      try {
        const response = await apiCall('getSettings', {});
        
        if (response.success) {
          const settings = response.data;
          
          document.getElementById('setOrgName').value = settings.orgName || '台灣帕金森病友會';
          document.getElementById('setPhone').value = settings.phone || '';
          document.getElementById('setEmail').value = settings.email || '';
          document.getElementById('setAddress').value = settings.address || '';
          document.getElementById('setLineNotifyToken').value = settings.lineNotifyToken || '';
        }
        
        await loadAdmins();
      } catch (error) {
        console.error('載入設定失敗:', error);
      }
    }

    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const settings = {
        orgName: document.getElementById('setOrgName').value,
        phone: document.getElementById('setPhone').value,
        email: document.getElementById('setEmail').value,
        address: document.getElementById('setAddress').value,
        lineNotifyToken: document.getElementById('setLineNotifyToken').value
      };

      try {
        const response = await apiCall('updateSettings', { settings });
        
        if (response.success) {
          showAlert('設定已儲存', 'success');
        } else {
          showAlert('儲存失敗：' + response.message, 'danger');
        }
      } catch (error) {
        console.error('儲存設定失敗:', error);
        showAlert('儲存失敗', 'danger');
      }
    });

    async function loadAdmins() {
      try {
        const response = await apiCall('getAdmins', {});
        
        if (response.success) {
          displayAdmins(response.data || []);
        }
      } catch (error) {
        console.error('載入管理員失敗:', error);
      }
    }

    function displayAdmins(admins) {
      const tbody = document.getElementById('adminsTableBody');
      
      if (!admins || admins.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">沒有管理員</td></tr>';
        return;
      }

      tbody.innerHTML = admins.map(admin => `
        <tr>
          <td>${admin.name}</td>
          <td>${admin.lineUserId}</td>
          <td><span class="badge badge-warning">${admin.role}</span></td>
          <td>${formatDate(admin.createdAt)}</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="deleteAdmin('${admin.lineUserId}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    function showAddAdminModal() {
      const modal = new bootstrap.Modal(document.getElementById('addAdminModal'));
      document.getElementById('addAdminForm').reset();
      modal.show();
    }

    async function submitAdmin() {
      const form = document.getElementById('addAdminForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const adminData = {
        lineUserId: document.getElementById('adminLineUserId').value,
        name: document.getElementById('adminName').value,
        role: document.getElementById('adminRole').value
      };

      try {
        const response = await apiCall('addAdmin', { adminData });
        
        if (response.success) {
          showAlert('管理員已新增', 'success');
          bootstrap.Modal.getInstance(document.getElementById('addAdminModal')).hide();
          loadAdmins();
        } else {
          showAlert('新增失敗：' + response.message, 'danger');
        }
      } catch (error) {
        console.error('新增管理員失敗:', error);
        showAlert('新增失敗', 'danger');
      }
    }

    async function deleteAdmin(lineUserId) {
      if (!confirm('確定要刪除此管理員嗎？')) return;
      
      try {
        const response = await apiCall('deleteAdmin', { lineUserId });
        
        if (response.success) {
          showAlert('管理員已刪除', 'success');
          loadAdmins();
        } else {
          showAlert('刪除失敗：' + response.message, 'danger');
        }
      } catch (error) {
        console.error('刪除管理員失敗:', error);
        showAlert('刪除失敗', 'danger');
      }
    }

    // ==================== 頁面切換 ====================
    function switchPage(page) {
      // 隱藏所有頁面
      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // 移除所有選單項目的 active 狀態
      document.querySelectorAll('.sidebar-menu-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // 設置當前選單項目為 active
      event.currentTarget.classList.add('active');
      
      // 頁面標題對應
      const pageTitles = {
        'dashboard': '儀表板',
        'members': '會員管理',
        'activities': '活動管理',
        'registrations': '報名管理',
        'volunteers': '志工管理',
        'finance': '財務管理',
        'statistics': '統計報表',
        'settings': '系統設定'
      };
      
      document.getElementById('pageTitle').textContent = pageTitles[page] || '管理後台';
      
      // 顯示對應頁面
      const pageMap = {
        'dashboard': 'dashboardPage',
        'members': 'membersPage',
        'activities': 'activitiesPage',
        'registrations': 'registrationsPage',
        'volunteers': 'volunteersPage',
        'finance': 'financePage',
        'statistics': 'statisticsPage',
        'settings': 'settingsPage'
      };
      
      const pageId = pageMap[page];
      if (pageId) {
        document.getElementById(pageId).classList.add('active');
        
        // 載入對應頁面的資料
        switch(page) {
          case 'dashboard':
            loadDashboard();
            break;
          case 'members':
            loadMembers();
            break;
          case 'activities':
            loadActivities();
            break;
          case 'registrations':
            loadRegistrations();
            break;
          case 'volunteers':
            loadVolunteers();
            break;
          case 'finance':
            loadFinance();
            break;
          case 'statistics':
            loadStatistics();
            break;
          case 'settings':
            loadSettings();
            break;
        }
      }
    }

    // ==================== API 呼叫 ====================
    async function apiCall(action, data) {
      const response = await fetch(CONFIG.API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          action: action,
          ...data
        })
      });
      
      return await response.json();
    }

    // ==================== 工具函數 ====================
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
    }

    function formatDateTime(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function getStatusClass(status) {
      const statusMap = {
        '報名中': 'success',
        '已額滿': 'warning',
        '已結束': 'secondary',
        '已取消': 'danger'
      };
      return statusMap[status] || 'info';
    }

    function getVolunteerStatusClass(status) {
      const statusMap = {
        '待審核': 'warning',
        '已審核': 'success',
        '已拒絕': 'danger'
      };
      return statusMap[status] || 'secondary';
    }

    function showAlert(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
      alertDiv.style.zIndex = '9999';
      alertDiv.style.minWidth = '300px';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    }

    function hideLoading() {
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('appContainer').style.display = 'block';
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('show');
    }
  </script>
</body>
</html>


