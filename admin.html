<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å“¡å¾Œå° - å°ç£å¸•é‡‘æ£®ä¹‹å‹å”æœƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #f5f7fa;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar h2 {
            margin-bottom: 30px;
            font-size: 20px;
            text-align: center;
        }

        .menu-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.2);
        }

        .menu-item.active {
            background: rgba(255,255,255,0.3);
        }

        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 30px;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            color: #333;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h4 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .action-btns {
            display: flex;
            gap: 5px;
        }

        .action-btns button {
            padding: 5px 10px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar input, .filter-bar select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .budget-item, .expense-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .item-amount {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .item-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .vote-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .vote-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .vote-count {
            font-size: 14px;
            color: #666;
        }

        .vote-count.approve {
            color: #27ae60;
        }

        .vote-count.reject {
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }

            .main-content {
                margin-left: 200px;
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            table th, table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- å´é‚Šæ¬„ -->
        <div class="sidebar">
            <h2>ğŸ”§ ç®¡ç†å“¡å¾Œå°</h2>
            <div class="menu-item active" onclick="showSection('dashboard')">ğŸ“Š å„€è¡¨æ¿</div>
            <div class="menu-item" onclick="showSection('users')">ğŸ‘¥ äººå“¡ç®¡ç†</div>
            <div class="menu-item" onclick="showSection('transactions')">ğŸ’° æ”¶æ”¯æ—¥è¨˜å¸³</div>
            <div class="menu-item" onclick="showSection('budgets')">ğŸ“‹ é ç®—ç·¨åˆ—</div>
            <div class="menu-item" onclick="showSection('expenses')">ğŸ’³ ç†äº‹é•·äº¤éš›è²»</div>
            <div class="menu-item" onclick="showSection('directors')">ğŸ‘” ç†ç›£äº‹ç®¡ç†</div>
            <div class="menu-item" onclick="showSection('reports')">ğŸ“Š è²¡å‹™å ±è¡¨</div>
        </div>

        <!-- ä¸»è¦å…§å®¹ -->
        <div class="main-content">
            <div class="header">
                <h1>ç®¡ç†å“¡å¾Œå°</h1>
                <div>
                    <span id="adminName" style="margin-right: 15px; color: #667eea; font-weight: 600;"></span>
                    <button class="logout-btn" onclick="adminLogout()">ç™»å‡º</button>
                </div>
            </div>

            <!-- å„€è¡¨æ¿ -->
            <div id="dashboard" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>ç¸½æœƒå“¡æ•¸</h4>
                        <div class="number" id="totalUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>å¾…å¯©æŸ¥äº¤æ˜“</h4>
                        <div class="number" id="pendingTransactions">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>å¾…å¯©æŸ¥é ç®—</h4>
                        <div class="number" id="pendingBudgets">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>å¾…å¯©æŸ¥äº¤éš›è²»</h4>
                        <div class="number" id="pendingExpenses">0</div>
                    </div>
                </div>

                <div class="card">
                    <h3>å¿«é€Ÿæ“ä½œ</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="showSection('transactions'); openAddTransactionModal()">æ–°å¢æ”¶æ”¯</button>
                        <button class="btn btn-primary" onclick="showSection('budgets'); openAddBudgetModal()">æ–°å¢é ç®—</button>
                        <button class="btn btn-primary" onclick="showSection('expenses'); openAddExpenseModal()">æ–°å¢äº¤éš›è²»</button>
                        <button class="btn btn-primary" onclick="showSection('directors'); openAddDirectorModal()">æ–°å¢ç†ç›£äº‹</button>
                    </div>
                </div>
            </div>

            <!-- äººå“¡ç®¡ç† -->
            <div id="users" class="content-section">
                <div class="card">
                    <h3>ğŸ‘¥ äººå“¡ç®¡ç†</h3>
                    <div class="filter-bar">
                        <input type="text" id="userSearch" placeholder="æœå°‹å§“åæˆ–é›»è©±" onkeyup="filterUsers()">
                        <select id="userTypeFilter" onchange="filterUsers()">
                            <option value="">å…¨éƒ¨é¡åˆ¥</option>
                            <option value="ä¸€èˆ¬ç¾¤çœ¾">ä¸€èˆ¬ç¾¤çœ¾</option>
                            <option value="ç—…å‹">ç—…å‹</option>
                            <option value="å®¶å±¬">å®¶å±¬</option>
                            <option value="é†«å¸«">é†«å¸«</option>
                        </select>
                    </div>
                    <div id="usersTableContainer">
                        <div class="loading">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- æ”¶æ”¯æ—¥è¨˜å¸³ -->
            <div id="transactions" class="content-section">
                <div class="card">
                    <h3>ğŸ’° æ”¶æ”¯æ—¥è¨˜å¸³</h3>
                    <button class="btn btn-primary" onclick="openAddTransactionModal()" style="margin-bottom: 15px;">+ æ–°å¢æ”¶æ”¯</button>
                    
                    <div class="filter-bar">
                        <input type="date" id="transStartDate" onchange="filterTransactions()">
                        <input type="date" id="transEndDate" onchange="filterTransactions()">
                        <select id="transTypeFilter" onchange="filterTransactions()">
                            <option value="">å…¨éƒ¨é¡å‹</option>
                            <option value="æ”¶å…¥">æ”¶å…¥</option>
                            <option value="æ”¯å‡º">æ”¯å‡º</option>
                        </select>
                        <select id="transStatusFilter" onchange="filterTransactions()">
                            <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                            <option value="å¾…å¯©æŸ¥">å¾…å¯©æŸ¥</option>
                            <option value="å·²å…¥å¸³">å·²å…¥å¸³</option>
                            <option value="æ”¯å‡ºæ ¸å‡†">æ”¯å‡ºæ ¸å‡†</option>
                            <option value="å·²æ”¯å‡º">å·²æ”¯å‡º</option>
                        </select>
                    </div>

                    <div id="transactionsTableContainer">
                        <div class="loading">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- é ç®—ç·¨åˆ— -->
            <div id="budgets" class="content-section">
                <div class="card">
                    <h3>ğŸ“‹ é ç®—ç·¨åˆ—</h3>
                    <button class="btn btn-primary" onclick="openAddBudgetModal()" style="margin-bottom: 15px;">+ æ–°å¢é ç®—é …ç›®</button>
                    
                    <div id="budgetsContainer">
                        <div class="loading">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ç†äº‹é•·äº¤éš›è²» -->
            <div id="expenses" class="content-section">
                <div class="card">
                    <h3>ğŸ’³ ç†äº‹é•·äº¤éš›è²»</h3>
                    <button class="btn btn-primary" onclick="openAddExpenseModal()" style="margin-bottom: 15px;">+ æ–°å¢äº¤éš›è²»</button>
                    
                    <div id="expensesContainer">
                        <div class="loading">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ç†ç›£äº‹ç®¡ç† -->
            <div id="directors" class="content-section">
                <div class="card">
                    <h3>ğŸ‘” ç†ç›£äº‹åå–®</h3>
                    <button class="btn btn-primary" onclick="openAddDirectorModal()" style="margin-bottom: 15px;">+ æ–°å¢ç†ç›£äº‹</button>
                    
                    <div id="directorsContainer">
                        <div class="loading">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- è²¡å‹™å ±è¡¨ -->
            <div id="reports" class="content-section">
                <div class="card">
                    <h3>ğŸ“Š è²¡å‹™å ±è¡¨</h3>
                    
                    <div class="filter-bar">
                        <label style="padding: 8px;">èµ·å§‹æ—¥æœŸï¼š</label>
                        <input type="date" id="reportStartDate">
                        <label style="padding: 8px;">çµæŸæ—¥æœŸï¼š</label>
                        <input type="date" id="reportEndDate">
                        <button class="btn btn-primary" onclick="loadFinancialReport()">ç”¢ç”Ÿå ±è¡¨</button>
                        <button class="btn btn-success" onclick="exportReport()">åŒ¯å‡º Excel</button>
                    </div>

                    <div id="reportSummary" style="margin-top: 20px;"></div>
                    <div id="reportDetails" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: ç·¨è¼¯ç”¨æˆ¶ -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç·¨è¼¯ç”¨æˆ¶è³‡æ–™</h3>
                <button class="close-btn" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <form id="editUserForm" onsubmit="event.preventDefault(); updateUser();">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>å§“å</label>
                    <input type="text" id="editUserName" required>
                </div>
                <div class="form-group">
                    <label>é›»è©±</label>
                    <input type="tel" id="editUserPhone" required>
                </div>
                <div class="form-group">
                    <label>èº«ä»½é¡åˆ¥</label>
                    <select id="editUserType">
                        <option value="ä¸€èˆ¬ç¾¤çœ¾">ä¸€èˆ¬ç¾¤çœ¾</option>
                        <option value="ç—…å‹">ç—…å‹</option>
                        <option value="å®¶å±¬">å®¶å±¬</option>
                        <option value="é†«å¸«">é†«å¸«</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="editUserEmail">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">å„²å­˜</button>
            </form>
        </div>
    </div>

    <!-- Modal: æ–°å¢æ”¶æ”¯ -->
    <div id="addTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–°å¢æ”¶æ”¯è¨˜éŒ„</h3>
                <button class="close-btn" onclick="closeModal('addTransactionModal')">&times;</button>
            </div>
            <form id="addTransactionForm" onsubmit="event.preventDefault(); addTransaction();">
                <div class="form-group">
                    <label>æ—¥æœŸ <span style="color: red;">*</span></label>
                    <input type="date" id="transDate" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>é¡å‹ <span style="color: red;">*</span></label>
                        <select id="transType" required>
                            <option value="æ”¶å…¥">æ”¶å…¥</option>
                            <option value="æ”¯å‡º">æ”¯å‡º</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é¡åˆ¥ <span style="color: red;">*</span></label>
                        <select id="transCategory" required>
                            <option value="æœƒè²»">æœƒè²»</option>
                            <option value="ææ¬¾">ææ¬¾</option>
                            <option value="è£œåŠ©">è£œåŠ©</option>
                            <option value="æ´»å‹•è²»ç”¨">æ´»å‹•è²»ç”¨</option>
                            <option value="è¡Œæ”¿è²»ç”¨">è¡Œæ”¿è²»ç”¨</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>é …ç›®åç¨± <span style="color: red;">*</span></label>
                    <input type="text" id="transName" placeholder="ä¾‹å¦‚ï¼šæœƒå“¡å¹´è²»" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>é‡‘é¡ <span style="color: red;">*</span></label>
                        <input type="number" id="transAmount" min="1" placeholder="è«‹è¼¸å…¥é‡‘é¡" required>
                    </div>
                    <div class="form-group">
                        <label>å¸³æˆ¶</label>
                        <input type="text" id="transAccount" placeholder="ä¾‹å¦‚ï¼šç¾é‡‘ã€éŠ€è¡Œ">
                    </div>
                </div>
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <textarea id="transNote" rows="3" placeholder="å…¶ä»–èªªæ˜"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">æ–°å¢</button>
            </form>
        </div>
    </div>

    <!-- Modal: ç·¨è¼¯æ”¶æ”¯ -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç·¨è¼¯æ”¶æ”¯è¨˜éŒ„</h3>
                <button class="close-btn" onclick="closeModal('editTransactionModal')">&times;</button>
            </div>
            <form id="editTransactionForm" onsubmit="event.preventDefault(); updateTransaction();">
                <input type="hidden" id="editTransId">
                <div class="form-group">
                    <label>æ—¥æœŸ</label>
                    <input type="date" id="editTransDate" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>é¡å‹</label>
                        <select id="editTransType" required>
                            <option value="æ”¶å…¥">æ”¶å…¥</option>
                            <option value="æ”¯å‡º">æ”¯å‡º</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é¡åˆ¥</label>
                        <select id="editTransCategory" required>
                            <option value="æœƒè²»">æœƒè²»</option>
                            <option value="ææ¬¾">ææ¬¾</option>
                            <option value="è£œåŠ©">è£œåŠ©</option>
                            <option value="æ´»å‹•è²»ç”¨">æ´»å‹•è²»ç”¨</option>
                            <option value="è¡Œæ”¿è²»ç”¨">è¡Œæ”¿è²»ç”¨</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>é …ç›®åç¨±</label>
                    <input type="text" id="editTransName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>é‡‘é¡</label>
                        <input type="number" id="editTransAmount" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>å¸³æˆ¶</label>
                        <input type="text" id="editTransAccount">
                    </div>
                </div>
                <div class="form-group">
                    <label>ç‹€æ…‹</label>
                    <select id="editTransStatus">
                        <option value="å¾…å¯©æŸ¥">å¾…å¯©æŸ¥</option>
                        <option value="å·²å…¥å¸³">å·²å…¥å¸³</option>
                        <option value="æ”¯å‡ºæ ¸å‡†">æ”¯å‡ºæ ¸å‡†</option>
                        <option value="å·²æ”¯å‡º">å·²æ”¯å‡º</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <textarea id="editTransNote" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">æ›´æ–°</button>
            </form>
        </div>
    </div>

    <!-- Modal: æ–°å¢é ç®— -->
    <div id="addBudgetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–°å¢é ç®—é …ç›®</h3>
                <button class="close-btn" onclick="closeModal('addBudgetModal')">&times;</button>
            </div>
            <form id="addBudgetForm" onsubmit="event.preventDefault(); addBudget();">
                <div class="form-group">
                    <label>é …ç›®åç¨± <span style="color: red;">*</span></label>
                    <input type="text" id="budgetItemName" placeholder="ä¾‹å¦‚ï¼šå¹´åº¦æ´»å‹•ç¶“è²»" required>
                </div>
                <div class="form-group">
                    <label>é ç®—é‡‘é¡ <span style="color: red;">*</span></label>
                    <input type="number" id="budgetAmount" min="1" placeholder="è«‹è¼¸å…¥é‡‘é¡" required>
                </div>
                <div class="form-group">
                    <label>èªªæ˜</label>
                    <textarea id="budgetDescription" rows="4" placeholder="è«‹æè¿°é ç®—ç”¨é€”"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">æäº¤å¯©æŸ¥</button>
            </form>
        </div>
    </div>

    <!-- Modal: æ–°å¢äº¤éš›è²» -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–°å¢ç†äº‹é•·äº¤éš›è²»</h3>
                <button class="close-btn" onclick="closeModal('addExpenseModal')">&times;</button>
            </div>
            <form id="addExpenseForm" onsubmit="event.preventDefault(); addExpense();">
                <div class="form-group">
                    <label>æ—¥æœŸ <span style="color: red;">*</span></label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div class="form-group">
                    <label>é‡‘é¡ <span style="color: red;">*</span></label>
                    <input type="number" id="expenseAmount" min="1" placeholder="è«‹è¼¸å…¥é‡‘é¡" required>
                </div>
                <div class="form-group">
                    <label>ç”¨é€”èªªæ˜ <span style="color: red;">*</span></label>
                    <textarea id="expensePurpose" rows="4" placeholder="è«‹è©³ç´°èªªæ˜äº¤éš›è²»ç”¨é€”" required></textarea>
                </div>
                <div style="padding: 10px; background: #fff3cd; border-radius: 8px; margin-bottom: 15px;">
                    <p style="color: #856404; font-size: 13px; margin: 0;">
                        ğŸ’¡ æç¤ºï¼šå–®ç­†é‡‘é¡ â‰¥ NT$10,000 éœ€ç¶“ç†ç›£äº‹éåŠæ•¸åŒæ„
                    </p>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">æäº¤</button>
            </form>
        </div>
    </div>

    <!-- Modal: æ–°å¢ç†ç›£äº‹ -->
    <div id="addDirectorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–°å¢ç†ç›£äº‹</h3>
                <button class="close-btn" onclick="closeModal('addDirectorModal')">&times;</button>
            </div>
            <form id="addDirectorForm" onsubmit="event.preventDefault(); addDirector();">
                <div class="form-group">
                    <label>é¸æ“‡ç”¨æˆ¶ <span style="color: red;">*</span></label>
                    <select id="directorUserId" required>
                        <option value="">è«‹é¸æ“‡...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è·ä½ <span style="color: red;">*</span></label>
                    <select id="directorRole" required>
                        <option value="ç†äº‹">ç†äº‹</option>
                        <option value="å¸¸å‹™ç†äº‹">å¸¸å‹™ç†äº‹</option>
                        <option value="ç†äº‹é•·">ç†äº‹é•·</option>
                        <option value="ç›£äº‹">ç›£äº‹</option>
                        <option value="å¸¸å‹™ç›£äº‹">å¸¸å‹™ç›£äº‹</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">æ–°å¢</button>
            </form>
        </div>
    </div>

    <!-- Modal: é ç®—æŠ•ç¥¨ -->
    <div id="budgetVoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>é ç®—å¯©æŸ¥æŠ•ç¥¨</h3>
                <button class="close-btn" onclick="closeModal('budgetVoteModal')">&times;</button>
            </div>
            <div id="budgetVoteContent"></div>
            <form id="budgetVoteForm" onsubmit="event.preventDefault(); submitBudgetVote();">
                <input type="hidden" id="voteBudgetId">
                <div class="form-group">
                    <label>æ‚¨çš„æ±ºå®š <span style="color: red;">*</span></label>
                    <select id="budgetDecision" required>
                        <option value="">è«‹é¸æ“‡...</option>
                        <option value="åŒæ„">åŒæ„</option>
                        <option value="ä¸åŒæ„">ä¸åŒæ„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ„è¦‹</label>
                    <textarea id="budgetComment" rows="3" placeholder="è«‹è¼¸å…¥æ‚¨çš„æ„è¦‹ï¼ˆé¸å¡«ï¼‰"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">æäº¤æŠ•ç¥¨</button>
            </form>
        </div>
    </div>

    <!-- Modal: äº¤éš›è²»æŠ•ç¥¨ -->
    <div id="expenseVoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>äº¤éš›è²»å¯©æŸ¥æŠ•ç¥¨</h3>
                <button class="close-btn" onclick="closeModal('expenseVoteModal')">&times;</button>
            </div>
            <div id="expenseVoteContent"></div>
            <form id="expenseVoteForm" onsubmit="event.preventDefault(); submitExpenseVote();">
                <input type="hidden" id="voteExpenseId">
                <div class="form-group">
                    <label>æ‚¨çš„æ±ºå®š <span style="color: red;">*</span></label>
                    <select id="expenseDecision" required>
                        <option value="">è«‹é¸æ“‡...</option>
                        <option value="åŒæ„">åŒæ„</option>
                        <option value="ä¸åŒæ„">ä¸åŒæ„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ„è¦‹</label>
                    <textarea id="expenseComment" rows="3" placeholder="è«‹è¼¸å…¥æ‚¨çš„æ„è¦‹ï¼ˆé¸å¡«ï¼‰"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">æäº¤æŠ•ç¥¨</button>
            </form>
        </div>
    </div>

    <script>
        // ========== é…ç½® ==========
        const API_URL = 'https://script.google.com/macros/s/AKfycby6SNF8aNbxSdsLWumSlXj5n4Z1FNl_N8px3X_jGBhcdeX8iJk9Fz6gzBTkwbRnN3xA8Q/exec'; // è«‹æ›¿æ›æˆæ‚¨çš„å¯¦éš› URL
        let currentAdmin = JSON.parse(sessionStorage.getItem('currentUser'));
        let allUsers = [];
        let allTransactions = [];
        let allBudgets = [];
        let allExpenses = [];
        let allDirectors = [];

        // ========== åˆå§‹åŒ– ==========
        window.onload = function() {
            if (!currentAdmin) {
                alert('è«‹å…ˆç™»å…¥');
                window.location.href = 'index.html';
                return;
            }

            checkAdminPermission();
        };

        async function checkAdminPermission() {
            const result = await callAPI('checkAdmin', { userId: currentAdmin.id });
            
            if (!result.success || !result.isAdmin) {
                alert('æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™');
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('adminName').textContent = `ğŸ‘‹ ${currentAdmin.name}`;
            loadDashboard();
        }

        // ========== API å‘¼å« ==========
        async function callAPI(action, data = {}) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: action, data: data })
                });
                const text = await response.text();
                return JSON.parse(text);
            } catch (error) {
                console.error('API éŒ¯èª¤:', error);
                return { success: false, message: 'ç¶²è·¯é€£ç·šéŒ¯èª¤' };
            }
        }

        // ========== é é¢åˆ‡æ› ==========
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            switch(sectionId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'budgets':
                    loadBudgets();
                    break;
                case 'expenses':
                    loadExpenses();
                    break;
                case 'directors':
                    loadDirectors();
                    break;
                case 'reports':
                    const today = new Date();
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                    document.getElementById('reportStartDate').value = firstDay.toISOString().split('T')[0];
                    document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
                    break;
            }
        }

        // ========== Modal æ§åˆ¶ ==========
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ========== å„€è¡¨æ¿ ==========
        async function loadDashboard() {
            const usersResult = await callAPI('getAllUsers');
            const transResult = await callAPI('getTransactions', {});
            const budgetsResult = await callAPI('getBudgets');
            const expensesResult = await callAPI('getExpenses');

            if (usersResult.success) {
                document.getElementById('totalUsers').textContent = usersResult.users.length;
            }

            if (transResult.success) {
                const pending = transResult.transactions.filter(t => t.status === 'å¾…å¯©æŸ¥').length;
                document.getElementById('pendingTransactions').textContent = pending;
            }

            if (budgetsResult.success) {
                const pending = budgetsResult.budgets.filter(b => b.status === 'å¾…å¯©æŸ¥').length;
                document.getElementById('pendingBudgets').textContent = pending;
            }

            if (expensesResult.success) {
                const pending = expensesResult.expenses.filter(e => e.status === 'å¾…å¯©æŸ¥').length;
                document.getElementById('pendingExpenses').textContent = pending;
            }
        }

        // ========== äººå“¡ç®¡ç† ==========
        async function loadUsers() {
            const result = await callAPI('getAllUsers');
            
            if (result.success) {
                allUsers = result.users;
                renderUsers(allUsers);
            } else {
                document.getElementById('usersTableContainer').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        function renderUsers(users) {
            if (users.length === 0) {
                document.getElementById('usersTableContainer').innerHTML = '<div class="empty-state">æ²’æœ‰ç”¨æˆ¶è³‡æ–™</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>å§“å</th>
                            <th>é›»è©±</th>
                            <th>é¡åˆ¥</th>
                            <th>Email</th>
                            <th>è¨»å†Šæ—¥æœŸ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.phone || '-'}</td>
                        <td>${user.type}</td>
                        <td>${user.email || '-'}</td>
                        <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString('zh-TW') : '-'}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-primary" onclick='openEditUserModal(${JSON.stringify(user)})'>ç·¨è¼¯</button>
                                <button class="btn btn-danger" onclick="deleteUser('${user.id}', '${user.name}')">åˆªé™¤</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('usersTableContainer').innerHTML = html;
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const typeFilter = document.getElementById('userTypeFilter').value;

            let filtered = allUsers.filter(user => {
                const matchSearch = user.name.toLowerCase().includes(searchTerm) || 
                                  (user.phone && user.phone.includes(searchTerm));
                const matchType = !typeFilter || user.type === typeFilter;
                return matchSearch && matchType;
            });

            renderUsers(filtered);
        }

        function openEditUserModal(user) {
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserPhone').value = user.phone || '';
            document.getElementById('editUserType').value = user.type;
            document.getElementById('editUserEmail').value = user.email || '';
            openModal('editUserModal');
        }

        async function updateUser() {
            const data = {
                userId: document.getElementById('editUserId').value,
                name: document.getElementById('editUserName').value,
                phone: document.getElementById('editUserPhone').value,
                type: document.getElementById('editUserType').value,
                email: document.getElementById('editUserEmail').value
            };

            const result = await callAPI('updateUserAdmin', data);

            if (result.success) {
                alert('æ›´æ–°æˆåŠŸ');
                closeModal('editUserModal');
                loadUsers();
            } else {
                alert(result.message);
            }
        }

        async function deleteUser(userId, userName) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç”¨æˆ¶ã€Œ${userName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                return;
            }

            const result = await callAPI('deleteUser', { userId: userId });

            if (result.success) {
                alert('åˆªé™¤æˆåŠŸ');
                loadUsers();
            } else {
                alert(result.message);
            }
        }

        // ========== æ”¶æ”¯æ—¥è¨˜å¸³ ==========
        async function loadTransactions() {
            const result = await callAPI('getTransactions', {});
            
            if (result.success) {
                allTransactions = result.transactions;
                renderTransactions(allTransactions);
            } else {
                document.getElementById('transactionsTableContainer').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        function renderTransactions(transactions) {
            if (transactions.length === 0) {
                document.getElementById('transactionsTableContainer').innerHTML = '<div class="empty-state">æ²’æœ‰äº¤æ˜“è¨˜éŒ„</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>é¡å‹</th>
                            <th>é¡åˆ¥</th>
                            <th>é …ç›®</th>
                            <th>é‡‘é¡</th>
                            <th>å¸³æˆ¶</th>
                            <th>ç‹€æ…‹</th>
                            <th>å–®æ“š</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            transactions.forEach(trans => {
                const statusClass = trans.status === 'å¾…å¯©æŸ¥' ? 'status-pending' : 
                                  trans.status === 'å·²å…¥å¸³' || trans.status === 'æ”¯å‡ºæ ¸å‡†' ? 'status-approved' : 
                                  'status-completed';
                const amountColor = trans.type === 'æ”¶å…¥' ? '#27ae60' : '#e74c3c';
                
                html += `
                    <tr>
                        <td>${trans.date}</td>
                        <td>${trans.type === 'æ”¶å…¥' ? 'ğŸ’°' : 'ğŸ’¸'} ${trans.type}</td>
                        <td>${trans.category}</td>
                        <td>${trans.name}</td>
                        <td style="color: ${amountColor}; font-weight: 600;">NT$ ${Number(trans.amount).toLocaleString()}</td>
                        <td>${trans.account || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${trans.status}</span></td>
                        <td>${trans.receiptPdf ? `<a href="${trans.receiptPdf}" target="_blank" class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;">æŸ¥çœ‹</a>` : '-'}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-warning" onclick='openEditTransactionModal(${JSON.stringify(trans)})'>ç·¨è¼¯</button>
                                <button class="btn btn-danger" onclick="deleteTransaction('${trans.id}')">åˆªé™¤</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('transactionsTableContainer').innerHTML = html;
        }

        function filterTransactions() {
            const startDate = document.getElementById('transStartDate').value;
            const endDate = document.getElementById('transEndDate').value;
            const typeFilter = document.getElementById('transTypeFilter').value;
            const statusFilter = document.getElementById('transStatusFilter').value;

            let filtered = allTransactions.filter(trans => {
                const matchDate = (!startDate || trans.date >= startDate) && (!endDate || trans.date <= endDate);
                const matchType = !typeFilter || trans.type === typeFilter;
                const matchStatus = !statusFilter || trans.status === statusFilter;
                return matchDate && matchType && matchStatus;
            });

            renderTransactions(filtered);
        }

        function openAddTransactionModal() {
            document.getElementById('addTransactionForm').reset();
            document.getElementById('transDate').value = new Date().toISOString().split('T')[0];
            openModal('addTransactionModal');
        }

        async function addTransaction() {
            const data = {
                date: document.getElementById('transDate').value,
                type: document.getElementById('transType').value,
                category: document.getElementById('transCategory').value,
                name: document.getElementById('transName').value,
                amount: document.getElementById('transAmount').value,
                account: document.getElementById('transAccount').value,
                note: document.getElementById('transNote').value,
                createdBy: currentAdmin.name
            };

            const result = await callAPI('addTransaction', data);

            if (result.success) {
                alert(result.message);
                closeModal('addTransactionModal');
                loadTransactions();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        function openEditTransactionModal(trans) {
            document.getElementById('editTransId').value = trans.id;
            document.getElementById('editTransDate').value = trans.date;
            document.getElementById('editTransType').value = trans.type;
            document.getElementById('editTransCategory').value = trans.category;
            document.getElementById('editTransName').value = trans.name;
            document.getElementById('editTransAmount').value = trans.amount;
            document.getElementById('editTransAccount').value = trans.account || '';
            document.getElementById('editTransStatus').value = trans.status;
            document.getElementById('editTransNote').value = trans.note || '';
            openModal('editTransactionModal');
        }

        async function updateTransaction() {
            const data = {
                id: document.getElementById('editTransId').value,
                date: document.getElementById('editTransDate').value,
                type: document.getElementById('editTransType').value,
                category: document.getElementById('editTransCategory').value,
                name: document.getElementById('editTransName').value,
                amount: document.getElementById('editTransAmount').value,
                account: document.getElementById('editTransAccount').value,
                status: document.getElementById('editTransStatus').value,
                note: document.getElementById('editTransNote').value
            };

            const result = await callAPI('updateTransaction', data);

            if (result.success) {
                alert('æ›´æ–°æˆåŠŸ');
                closeModal('editTransactionModal');
                loadTransactions();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        async function deleteTransaction(transId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤äº¤æ˜“è¨˜éŒ„å—ï¼Ÿ')) {
                return;
            }

            const result = await callAPI('deleteTransaction', { id: transId });

            if (result.success) {
                alert('åˆªé™¤æˆåŠŸ');
                loadTransactions();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        // ========== é ç®—ç·¨åˆ— ==========
        async function loadBudgets() {
            const result = await callAPI('getBudgets');
            
            if (result.success) {
                allBudgets = result.budgets;
                renderBudgets(allBudgets);
            } else {
                document.getElementById('budgetsContainer').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        function renderBudgets(budgets) {
            if (budgets.length === 0) {
                document.getElementById('budgetsContainer').innerHTML = '<div class="empty-state">æ²’æœ‰é ç®—é …ç›®</div>';
                return;
            }

            let html = '';

            budgets.forEach(budget => {
                const statusClass = budget.status === 'å¾…å¯©æŸ¥' ? 'status-pending' : 
                                  budget.status === 'å·²æ ¸å‡†' ? 'status-approved' : 
                                  'status-rejected';
                
                html += `
                    <div class="budget-item">
                        <div class="item-header">
                            <div>
                                <div class="item-title">${budget.itemName}</div>
                                <div class="item-info">ææ¡ˆäººï¼š${budget.createdBy} | ${new Date(budget.createdAt).toLocaleDateString('zh-TW')}</div>
                            </div>
                            <div class="item-amount">NT$ ${Number(budget.amount).toLocaleString()}</div>
                        </div>
                        <div class="item-info">${budget.description || 'ç„¡èªªæ˜'}</div>
                        <div class="vote-section">
                            <div class="vote-stats">
                                <span class="vote-count approve">âœ“ åŒæ„ï¼š${budget.approvedCount}</span>
                                <span class="vote-count reject">âœ— ä¸åŒæ„ï¼š${budget.rejectedCount}</span>
                                <span class="status-badge ${statusClass}">${budget.status}</span>
                            </div>
                            ${budget.status === 'å¾…å¯©æŸ¥' ? `<button class="btn btn-primary" onclick='openBudgetVoteModal(${JSON.stringify(budget)})'>æŠ•ç¥¨</button>` : ''}
                        </div>
                    </div>
                `;
            });

            document.getElementById('budgetsContainer').innerHTML = html;
        }

        function openAddBudgetModal() {
            document.getElementById('addBudgetForm').reset();
            openModal('addBudgetModal');
        }

        async function addBudget() {
            const data = {
                itemName: document.getElementById('budgetItemName').value,
                amount: document.getElementById('budgetAmount').value,
                description: document.getElementById('budgetDescription').value,
                createdBy: currentAdmin.name
            };

            const result = await callAPI('addBudget', data);

            if (result.success) {
                alert('é ç®—é …ç›®å·²æäº¤å¯©æŸ¥');
                closeModal('addBudgetModal');
                loadBudgets();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        function openBudgetVoteModal(budget) {
            document.getElementById('voteBudgetId').value = budget.id;
            document.getElementById('budgetVoteContent').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px;">${budget.itemName}</h4>
                    <p style="color: #667eea; font-size: 20px; font-weight: bold; margin-bottom: 10px;">NT$ ${Number(budget.amount).toLocaleString()}</p>
                    <p style="color: #666;">${budget.description || 'ç„¡èªªæ˜'}</p>
                </div>
            `;
            openModal('budgetVoteModal');
        }

        async function submitBudgetVote() {
            const data = {
                budgetId: document.getElementById('voteBudgetId').value,
                userId: currentAdmin.id,
                userName: currentAdmin.name,
                decision: document.getElementById('budgetDecision').value,
                comment: document.getElementById('budgetComment').value
            };

            const result = await callAPI('approveBudget', data);

            if (result.success) {
                alert('æŠ•ç¥¨æˆåŠŸ');
                closeModal('budgetVoteModal');
                document.getElementById('budgetVoteForm').reset();
                loadBudgets();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        // ========== ç†äº‹é•·äº¤éš›è²» ==========
        async function loadExpenses() {
            const result = await callAPI('getExpenses');
            
            if (result.success) {
                allExpenses = result.expenses;
                renderExpenses(allExpenses);
            } else {
                document.getElementById('expensesContainer').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        function renderExpenses(expenses) {
            if (expenses.length === 0) {
                document.getElementById('expensesContainer').innerHTML = '<div class="empty-state">æ²’æœ‰äº¤éš›è²»è¨˜éŒ„</div>';
                return;
            }

            let html = '';

            expenses.forEach(expense => {
                const statusClass = expense.status === 'å¾…å¯©æŸ¥' ? 'status-pending' : 
                                  expense.status === 'å·²æ ¸å‡†' ? 'status-approved' : 
                                  'status-rejected';
                const needVote = Number(expense.amount) >= 10000;
                
                html += `
                    <div class="expense-item">
                        <div class="item-header">
                            <div>
                                <div class="item-title">${expense.purpose}</div>
                                <div class="item-info">ç”³è«‹äººï¼š${expense.createdBy} | ${expense.date}</div>
                            </div>
                            <div class="item-amount">NT$ ${Number(expense.amount).toLocaleString()}</div>
                        </div>
                        ${needVote ? `
                        <div class="vote-section">
                            <div class="vote-stats">
                                <span class="vote-count approve">âœ“ åŒæ„ï¼š${expense.approvedCount}</span>
                                <span class="vote-count reject">âœ— ä¸åŒæ„ï¼š${expense.rejectedCount}</span>
                                <span class="status-badge ${statusClass}">${expense.status}</span>
                            </div>
                            ${expense.status === 'å¾…å¯©æŸ¥' ? `<button class="btn btn-primary" onclick='openExpenseVoteModal(${JSON.stringify(expense)})'>æŠ•ç¥¨</button>` : ''}
                        </div>
                        ` : `
                        <div class="vote-section">
                            <span class="status-badge ${statusClass}">${expense.status}</span>
                            <span style="color: #666; font-size: 13px; margin-left: 10px;">é‡‘é¡æœªé” NT$10,000ï¼Œç„¡éœ€æŠ•ç¥¨</span>
                        </div>
                        `}
                    </div>
                `;
            });

            document.getElementById('expensesContainer').innerHTML = html;
        }

        function openAddExpenseModal() {
            document.getElementById('addExpenseForm').reset();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            openModal('addExpenseModal');
        }

        async function addExpense() {
            const data = {
                date: document.getElementById('expenseDate').value,
                amount: document.getElementById('expenseAmount').value,
                purpose: document.getElementById('expensePurpose').value,
                createdBy: currentAdmin.name
            };

            const result = await callAPI('addExpense', data);

            if (result.success) {
                alert(result.message);
                closeModal('addExpenseModal');
                loadExpenses();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        function openExpenseVoteModal(expense) {
            document.getElementById('voteExpenseId').value = expense.id;
            document.getElementById('expenseVoteContent').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px;">${expense.purpose}</h4>
                    <p style="color: #667eea; font-size: 20px; font-weight: bold; margin-bottom: 10px;">NT$ ${Number(expense.amount).toLocaleString()}</p>
                    <p style="color: #666;">æ—¥æœŸï¼š${expense.date}</p>
                    <p style="color: #666;">ç”³è«‹äººï¼š${expense.createdBy}</p>
                </div>
            `;
            openModal('expenseVoteModal');
        }

        async function submitExpenseVote() {
            const data = {
                expenseId: document.getElementById('voteExpenseId').value,
                userId: currentAdmin.id,
                userName: currentAdmin.name,
                decision: document.getElementById('expenseDecision').value,
                comment: document.getElementById('expenseComment').value
            };

            const result = await callAPI('approveExpense', data);

            if (result.success) {
                alert('æŠ•ç¥¨æˆåŠŸ');
                closeModal('expenseVoteModal');
                document.getElementById('expenseVoteForm').reset();
                loadExpenses();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        // ========== ç†ç›£äº‹ç®¡ç† ==========
        async function loadDirectors() {
            const result = await callAPI('getDirectors');
            
            if (result.success) {
                allDirectors = result.directors;
                renderDirectors(allDirectors);
            } else {
                document.getElementById('directorsContainer').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        function renderDirectors(directors) {
            if (directors.length === 0) {
                document.getElementById('directorsContainer').innerHTML = '<div class="empty-state">æ²’æœ‰ç†ç›£äº‹è³‡æ–™</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>å§“å</th>
                            <th>è·ä½</th>
                            <th>åŠ å…¥æ—¥æœŸ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            directors.forEach(director => {
                html += `
                    <tr>
                        <td>${director.userName}</td>
                        <td><strong>${director.role}</strong></td>
                        <td>${new Date(director.createdAt).toLocaleDateString('zh-TW')}</td>
                        <td>
                            <button class="btn btn-danger" onclick="removeDirector('${director.id}', '${director.userName}')">ç§»é™¤</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('directorsContainer').innerHTML = html;
        }

        async function openAddDirectorModal() {
            // è¼‰å…¥æ‰€æœ‰ç”¨æˆ¶åˆ°ä¸‹æ‹‰é¸å–®
            const result = await callAPI('getAllUsers');
            
            if (result.success) {
                let options = '<option value="">è«‹é¸æ“‡...</option>';
                result.users.forEach(user => {
                    options += `<option value="${user.id}">${user.name} (${user.phone || user.lineId})</option>`;
                });
                document.getElementById('directorUserId').innerHTML = options;
            }
            
            document.getElementById('addDirectorForm').reset();
            openModal('addDirectorModal');
        }

        async function addDirector() {
            const userId = document.getElementById('directorUserId').value;
            const role = document.getElementById('directorRole').value;
            
            // æ‰¾åˆ°é¸ä¸­çš„ç”¨æˆ¶åç¨±
            const selectedOption = document.querySelector('#directorUserId option:checked');
            const userName = selectedOption.text.split(' (')[0];

            const data = {
                userId: userId,
                userName: userName,
                role: role
            };

            const result = await callAPI('addDirector', data);

            if (result.success) {
                alert('ç†ç›£äº‹æ–°å¢æˆåŠŸ');
                closeModal('addDirectorModal');
                loadDirectors();
            } else {
                alert(result.message);
            }
        }

        async function removeDirector(directorId, userName) {
            if (!confirm(`ç¢ºå®šè¦ç§»é™¤ç†ç›£äº‹ã€Œ${userName}ã€å—ï¼Ÿ`)) {
                return;
            }

            const result = await callAPI('removeDirector', { id: directorId });

            if (result.success) {
                alert('ç§»é™¤æˆåŠŸ');
                loadDirectors();
            } else {
                alert(result.message);
            }
        }

        // ========== è²¡å‹™å ±è¡¨ ==========
        async function loadFinancialReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            if (!startDate || !endDate) {
                alert('è«‹é¸æ“‡æ—¥æœŸç¯„åœ');
                return;
            }

            if (startDate > endDate) {
                alert('èµ·å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');
                return;
            }

            document.getElementById('reportSummary').innerHTML = '<div class="loading">ç”¢ç”Ÿå ±è¡¨ä¸­...</div>';
            document.getElementById('reportDetails').innerHTML = '';

            const result = await callAPI('getFinancialReport', {
                startDate: startDate,
                endDate: endDate
            });

            if (result.success) {
                renderFinancialReport(result.report);
            } else {
                document.getElementById('reportSummary').innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        function renderFinancialReport(report) {
            // æ‘˜è¦å¡ç‰‡
            const summaryHtml = `
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">
                        <h4>ç¸½æ”¶å…¥</h4>
                        <div class="number">NT$ ${report.totalIncome.toLocaleString()}</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                        <h4>ç¸½æ”¯å‡º</h4>
                        <div class="number">NT$ ${report.totalExpense.toLocaleString()}</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                        <h4>çµé¤˜</h4>
                        <div class="number">NT$ ${report.balance.toLocaleString()}</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                        <h4>äº¤æ˜“ç­†æ•¸</h4>
                        <div class="number">${report.transactionCount}</div>
                    </div>
                </div>
            `;

            document.getElementById('reportSummary').innerHTML = summaryHtml;

            // é¡åˆ¥çµ±è¨ˆ
            let categoryHtml = '<h4 style="margin: 20px 0 10px 0;">ğŸ“‹ é¡åˆ¥çµ±è¨ˆ</h4>';
            
            if (Object.keys(report.categoryStats).length === 0) {
                categoryHtml += '<div class="empty-state">æ­¤æœŸé–“æ²’æœ‰äº¤æ˜“è¨˜éŒ„</div>';
            } else {
                categoryHtml += '<table><thead><tr><th>é¡åˆ¥</th><th>æ”¶å…¥</th><th>æ”¯å‡º</th><th>æ·¨é¡</th></tr></thead><tbody>';

                for (const [category, stats] of Object.entries(report.categoryStats)) {
                    const net = stats.income - stats.expense;
                    categoryHtml += `
                        <tr>
                            <td><strong>${category}</strong></td>
                            <td style="color: #27ae60; font-weight: 600;">NT$ ${stats.income.toLocaleString()}</td>
                            <td style="color: #e74c3c; font-weight: 600;">NT$ ${stats.expense.toLocaleString()}</td>
                            <td style="font-weight: 700; color: ${net >= 0 ? '#27ae60' : '#e74c3c'};">
                                ${net >= 0 ? '+' : ''}NT$ ${net.toLocaleString()}
                            </td>
                        </tr>
                    `;
                }

                categoryHtml += '</tbody></table>';
            }

            // æ˜ç´°è¡¨
            let detailHtml = '<h4 style="margin: 30px 0 10px 0;">ğŸ“ äº¤æ˜“æ˜ç´°</h4>';
            
            if (report.transactions.length === 0) {
                detailHtml += '<div class="empty-state">æ­¤æœŸé–“æ²’æœ‰äº¤æ˜“è¨˜éŒ„</div>';
            } else {
                detailHtml += '<table><thead><tr><th>æ—¥æœŸ</th><th>é¡å‹</th><th>é¡åˆ¥</th><th>åç¨±</th><th>é‡‘é¡</th><th>ç‹€æ…‹</th><th>å–®æ“š</th></tr></thead><tbody>';

                report.transactions.forEach(trans => {
                    const amountColor = trans.type === 'æ”¶å…¥' ? '#27ae60' : '#e74c3c';
                    const statusClass = trans.status === 'å¾…å¯©æŸ¥' ? 'status-pending' : 
                                      trans.status === 'å·²å…¥å¸³' || trans.status === 'æ”¯å‡ºæ ¸å‡†' ? 'status-approved' : 
                                      'status-completed';
                    
                    detailHtml += `
                        <tr>
                            <td>${trans.date}</td>
                            <td>${trans.type === 'æ”¶å…¥' ? 'ğŸ’°' : 'ğŸ’¸'} <strong>${trans.type}</strong></td>
                            <td>${trans.category}</td>
                            <td>${trans.name}</td>
                            <td style="color: ${amountColor}; font-weight: 700; text-align: right;">
                                ${trans.type === 'æ”¶å…¥' ? '+' : '-'}NT$ ${Number(trans.amount).toLocaleString()}
                            </td>
                            <td><span class="status-badge ${statusClass}">${trans.status}</span></td>
                            <td>${trans.receiptPdf ? `<a href="${trans.receiptPdf}" target="_blank" class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;">æŸ¥çœ‹</a>` : '-'}</td>
                        </tr>
                    `;
                });

                detailHtml += '</tbody></table>';
            }

            document.getElementById('reportDetails').innerHTML = categoryHtml + detailHtml;
        }

        function exportReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                alert('è«‹å…ˆç”¢ç”Ÿå ±è¡¨');
                return;
            }
            
            alert('Excel åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­...\n\nç›®å‰æ‚¨å¯ä»¥ï¼š\n1. ä½¿ç”¨ç€è¦½å™¨çš„åˆ—å°åŠŸèƒ½ï¼ˆCtrl+Pï¼‰å„²å­˜ç‚º PDF\n2. è¤‡è£½è¡¨æ ¼å…§å®¹åˆ° Excel');
        }

        // ========== ç™»å‡º ==========
        function adminLogout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                sessionStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>

