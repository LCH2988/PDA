<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友協會 - 管理後台</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f7fa;
    }
    
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 250px;
      height: 100vh;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      overflow-y: auto;
    }
    
    .logo {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .menu-item {
      padding: 12px 15px;
      margin-bottom: 5px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .menu-item:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .menu-item.active {
      background: rgba(255,255,255,0.2);
      font-weight: bold;
    }
    
    .main-content {
      margin-left: 250px;
      padding: 30px;
    }
    
    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 28px;
      color: #333;
    }
    
    .page-content {
      display: none;
    }
    
    .page-content.active {
      display: block;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: #666;
      font-size: 14px;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .card-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #333;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      margin-right: 5px;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #dee2e6;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #dee2e6;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }
    
    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .search-box {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      width: 300px;
      margin-bottom: 20px;
    }
    
    .chart-container {
      height: 300px;
      margin-top: 20px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: bold;
    }
    
    .modal-close {
      font-size: 28px;
      cursor: pointer;
      color: #999;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo">🌟 管理後台</div>
    <div class="menu-item active" onclick="showPage('dashboard')">📊 儀表板</div>
    <div class="menu-item" onclick="showPage('members')">👥 會員管理</div>
    <div class="menu-item" onclick="showPage('activities')">📅 活動管理</div>
    <div class="menu-item" onclick="showPage('registrations')">📝 報名管理</div>
    <div class="menu-item" onclick="showPage('volunteers')">🤝 志工管理</div>
    <div class="menu-item" onclick="showPage('finances')">💰 財務管理</div>
    <div class="menu-item" onclick="showPage('statistics')">📈 統計報表</div>
    <div class="menu-item" onclick="showPage('settings')">⚙️ 系統設定</div>
  </div>

  <div class="main-content">
    <!-- 儀表板 -->
    <div id="dashboard" class="page-content active">
      <div class="header">
        <h1>儀表板</h1>
        <button class="btn btn-primary" onclick="loadDashboard()">🔄 重新整理</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalMembers">0</div>
          <div class="stat-label">總會員數</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalActivities">0</div>
          <div class="stat-label">總活動數</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalVolunteerHours">0</div>
          <div class="stat-label">志工總時數</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="balance">NT$ 0</div>
          <div class="stat-label">財務餘額</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">會員類型分布</div>
        <canvas id="memberTypeChart"></canvas>
      </div>

      <div class="card">
        <div class="card-title">活動狀態統計</div>
        <canvas id="activityStatusChart"></canvas>
      </div>

      <div class="card">
        <div class="card-title">最近活動</div>
        <div id="recentActivities"></div>
      </div>
    </div>

    <!-- 會員管理 -->
    <div id="members" class="page-content">
      <div class="header">
        <h1>會員管理</h1>
      </div>

      <div class="card">
        <input type="text" id="memberSearch" class="search-box" placeholder="搜尋會員姓名或電話..." onkeyup="searchMembers()">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>姓名</th>
                <th>電話</th>
                <th>Email</th>
                <th>會員類型</th>
                <th>角色</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="membersTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 活動管理 -->
    <div id="activities" class="page-content">
      <div class="header">
        <h1>活動管理</h1>
        <button class="btn btn-primary" onclick="showCreateActivity()">➕ 新增活動</button>
      </div>

      <div class="card">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>活動名稱</th>
                <th>類型</th>
                <th>日期</th>
                <th>地點</th>
                <th>報名人數</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="activitiesTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 報名管理 -->
    <div id="registrations" class="page-content">
      <div class="header">
        <h1>報名管理</h1>
      </div>

      <div class="card">
        <select id="activityFilter" class="form-select" style="width: 300px; margin-bottom: 20px;" onchange="loadRegistrations()">
          <option value="">全部活動</option>
        </select>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>活動名稱</th>
                <th>會員姓名</th>
                <th>報名時間</th>
                <th>簽到狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="registrationsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 志工管理 -->
    <div id="volunteers" class="page-content">
      <div class="header">
        <h1>志工管理</h1>
        <span class="badge badge-warning" id="pendingCount">待審核: 0</span>
      </div>

      <div class="card">
        <div class="card-title">待審核記錄</div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>會員姓名</th>
                <th>服務日期</th>
                <th>時數</th>
                <th>說明</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="pendingVolunteers"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 財務管理 -->
    <div id="finances" class="page-content">
      <div class="header">
        <h1>財務管理</h1>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalIncome">NT$ 0</div>
          <div class="stat-label">總收入</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalExpense">NT$ 0</div>
          <div class="stat-label">總支出</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="financialBalance">NT$ 0</div>
          <div class="stat-label">餘額</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          捐款記錄
          <button class="btn btn-primary btn-sm" onclick="showAddDonation()" style="float: right;">➕ 新增捐款</button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>日期</th>
                <th>捐款人</th>
                <th>金額</th>
                <th>說明</th>
              </tr>
            </thead>
            <tbody id="donationsTable"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          支出記錄
          <button class="btn btn-primary btn-sm" onclick="showAddExpense()" style="float: right;">➕ 新增支出</button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>日期</th>
                <th>類別</th>
                <th>對象</th>
                <th>金額</th>
                <th>說明</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="expensesTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 統計報表 -->
    <div id="statistics" class="page-content">
      <div class="header">
        <h1>統計報表</h1>
      </div>

      <div class="card">
        <div class="card-title">月度活動統計</div>
        <canvas id="monthlyActivityChart"></canvas>
      </div>

      <div class="card">
        <div class="card-title">會員成長趨勢</div>
        <canvas id="memberGrowthChart"></canvas>
      </div>

      <div class="card">
        <div class="card-title">志工服務統計</div>
        <canvas id="volunteerStatsChart"></canvas>
      </div>

      <div class="card">
        <div class="card-title">財務收支統計</div>
        <canvas id="financialStatsChart"></canvas>
      </div>
    </div>

    <!-- 系統設定 -->
    <div id="settings" class="page-content">
      <div class="header">
        <h1>系統設定</h1>
      </div>

      <div class="card">
        <div class="card-title">基本設定</div>
        <div class="form-group">
          <label class="form-label">組織名稱</label>
          <input type="text" id="orgName" class="form-input" value="帕金森病友協會">
        </div>
        <div class="form-group">
          <label class="form-label">聯絡電話</label>
          <input type="tel" id="orgPhone" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" id="orgEmail" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">地址</label>
          <input type="text" id="orgAddress" class="form-input">
        </div>
        <button class="btn btn-primary" onclick="saveSettings()">💾 儲存設定</button>
      </div>

      <div class="card">
        <div class="card-title">資料備份</div>
        <p style="color: #666; margin-bottom: 15px;">備份所有系統資料為 JSON 格式</p>
        <button class="btn btn-success" onclick="backupData()">📥 下載備份檔</button>
      </div>
    </div>
  </div>

  <!-- 新增/編輯活動 Modal -->
  <div id="activityModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="activityModalTitle">新增活動</div>
        <span class="modal-close" onclick="closeModal('activityModal')">&times;</span>
      </div>
      <div class="form-group">
        <label class="form-label">活動名稱 *</label>
        <input type="text" id="activityName" class="form-input">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">活動類型 *</label>
          <select id="activityType" class="form-select">
            <option value="講座">講座</option>
            <option value="運動課程">運動課程</option>
            <option value="社交活動">社交活動</option>
            <option value="健康檢查">健康檢查</option>
            <option value="其他">其他</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">日期 *</label>
          <input type="date" id="activityDate" class="form-input">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">開始時間 *</label>
          <input type="time" id="activityStartTime" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">結束時間 *</label>
          <input type="time" id="activityEndTime" class="form-input">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">地點 *</label>
        <input type="text" id="activityLocation" class="form-input">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">人數上限 (0=不限)</label>
          <input type="number" id="activityMaxParticipants" class="form-input" value="0" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">費用 (0=免費)</label>
          <input type="number" id="activityFee" class="form-input" value="0" min="0">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">報名截止日 *</label>
        <input type="date" id="activityDeadline" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">活動說明</label>
        <textarea id="activityDescription" class="form-textarea" rows="3"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">注意事項</label>
        <textarea id="activityNotes" class="form-textarea" rows="3"></textarea>
      </div>
      <button class="btn btn-primary" onclick="saveActivity()">💾 儲存</button>
    </div>
  </div>

  <!-- 審核志工 Modal -->
  <div id="reviewVolunteerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">審核志工記錄</div>
        <span class="modal-close" onclick="closeModal('reviewVolunteerModal')">&times;</span>
      </div>
      <div id="reviewVolunteerContent"></div>
      <div class="form-group">
        <label class="form-label">審核備註</label>
        <textarea id="reviewNote" class="form-textarea" rows="3"></textarea>
      </div>
      <button class="btn btn-success" onclick="approveVolunteer()">✅ 通過</button>
      <button class="btn btn-danger" onclick="rejectVolunteer()">❌ 拒絕</button>
    </div>
  </div>

  <!-- 新增捐款 Modal -->
  <div id="donationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">新增捐款記錄</div>
        <span class="modal-close" onclick="closeModal('donationModal')">&times;</span>
      </div>
      <div class="form-group">
        <label class="form-label">捐款人姓名</label>
        <input type="text" id="donorName" class="form-input" placeholder="匿名捐款可留空">
      </div>
      <div class="form-group">
        <label class="form-label">捐款金額 *</label>
        <input type="number" id="donationAmount" class="form-input" min="1">
      </div>
      <div class="form-group">
        <label class="form-label">捐款日期 *</label>
        <input type="date" id="donationDate" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">說明</label>
        <textarea id="donationDescription" class="form-textarea" rows="2"></textarea>
      </div>
      <button class="btn btn-primary" onclick="saveDonation()">💾 儲存</button>
    </div>
  </div>

  <!-- 新增支出 Modal -->
  <div id="expenseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">新增支出記錄</div>
        <span class="modal-close" onclick="closeModal('expenseModal')">&times;</span>
      </div>
      <div class="form-group">
        <label class="form-label">支出類別 *</label>
        <select id="expenseCategory" class="form-select">
          <option value="活動費用">活動費用</option>
          <option value="場地租金">場地租金</option>
          <option value="設備採購">設備採購</option>
          <option value="行政費用">行政費用</option>
          <option value="其他">其他</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">支付對象 *</label>
        <input type="text" id="expensePayee" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">支出金額 *</label>
        <input type="number" id="expenseAmount" class="form-input" min="1">
      </div>
      <div class="form-group">
        <label class="form-label">支出日期 *</label>
        <input type="date" id="expenseDate" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">說明</label>
        <textarea id="expenseDescription" class="form-textarea" rows="2"></textarea>
      </div>
      <button class="btn btn-primary" onclick="saveExpense()">💾 儲存</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxabz6vmzwklRir1aTOO3jCVe9LmLARa2hioKJpekaTFr0ppjxmVW3-5CJWyIFeBgckXw/exec'; // 請替換為您的 GAS Web App URL
    let currentEditActivityId = null;
    let currentReviewRecordId = null;

    // 頁面切換
    function showPage(pageName) {
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      document.querySelectorAll('.page-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(pageName).classList.add('active');
      
      // 載入對應資料
      switch(pageName) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'members':
          loadMembers();
          break;
        case 'activities':
          loadActivities();
          break;
        case 'registrations':
          loadActivityFilter();
          loadRegistrations();
          break;
        case 'volunteers':
          loadPendingVolunteers();
          break;
        case 'finances':
          loadFinances();
          break;
        case 'statistics':
          loadStatistics();
          break;
        case 'settings':
          loadSettings();
          break;
      }
    }

    // 載入儀表板
    async function loadDashboard() {
      try {
        const response = await fetch(`${API_URL}?action=getDashboardStats`);
        const data = await response.json();
        
        document.getElementById('totalMembers').textContent = data.totalMembers;
        document.getElementById('totalActivities').textContent = data.totalActivities;
        document.getElementById('totalVolunteerHours').textContent = data.totalVolunteerHours;
        document.getElementById('balance').textContent = `NT$ ${data.balance.toLocaleString()}`;
        
        // 會員類型圖表
        renderPieChart('memberTypeChart', data.memberTypes, '會員類型分布');
        
        // 活動狀態圖表
        renderPieChart('activityStatusChart', data.activityStatus, '活動狀態');
        
        // 最近活動
        const container = document.getElementById('recentActivities');
        if (data.recentActivities.length === 0) {
          container.innerHTML = '<p style="color: #999;">暫無活動</p>';
        } else {
          container.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>活動名稱</th>
                  <th>日期</th>
                  <th>報名人數</th>
                  <th>狀態</th>
                </tr>
              </thead>
              <tbody>
                ${data.recentActivities.map(a => `
                  <tr>
                    <td>${a.name}</td>
                    <td>${a.date}</td>
                    <td>${a.registrationCount}/${a.maxParticipants || '不限'}</td>
                    <td><span class="badge badge-info">${a.status}</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (error) {
        console.error('載入儀表板失敗:', error);
      }
    }

    // 載入會員列表
    async function loadMembers() {
      try {
        const response = await fetch(`${API_URL}?action=getAllMembers`);
        const members = await response.json();
        
        const tbody = document.getElementById('membersTable');
        tbody.innerHTML = members.map(m => `
          <tr>
            <td>${m.name}</td>
            <td>${m.phone}</td>
            <td>${m.email || '-'}</td>
            <td>${m.memberType}</td>
            <td>
              <select class="form-select" onchange="updateMemberRole('${m.memberId}', this.value)" style="width: 120px;">
                <option value="member" ${m.role === 'member' ? 'selected' : ''}>會員</option>
                <option value="volunteer" ${m.role === 'volunteer' ? 'selected' : ''}>志工</option>
                <option value="admin" ${m.role === 'admin' ? 'selected' : ''}>管理員</option>
              </select>
            </td>
            <td>
              <select class="form-select" onchange="updateMemberStatus('${m.memberId}', this.value)" style="width: 100px;">
                <option value="正常" ${m.status === '正常' ? 'selected' : ''}>正常</option>
                <option value="停權" ${m.status === '停權' ? 'selected' : ''}>停權</option>
              </select>
            </td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="viewMemberDetail('${m.memberId}')">詳情</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('載入會員失敗:', error);
      }
    }

    // 搜尋會員
    function searchMembers() {
      const keyword = document.getElementById('memberSearch').value.toLowerCase();
      const rows = document.querySelectorAll('#membersTable tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(keyword) ? '' : 'none';
      });
    }

    // 更新會員角色
    async function updateMemberRole(memberId, role) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'updateMemberStatus',
            memberId: memberId,
            role: role
          })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('更新成功！');
        }
      } catch (error) {
        console.error('更新失敗:', error);
      }
    }

    // 更新會員狀態
    async function updateMemberStatus(memberId, status) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'updateMemberStatus',
            memberId: memberId,
            status: status
          })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('更新成功！');
        }
      } catch (error) {
        console.error('更新失敗:', error);
      }
    }

    // 載入活動列表
    async function loadActivities() {
      try {
        const response = await fetch(`${API_URL}?action=getActivities`);
        const activities = await response.json();
        
        const tbody = document.getElementById('activitiesTable');
        tbody.innerHTML = activities.map(a => `
          <tr>
            <td>${a.name}</td>
            <td>${a.type}</td>
            <td>${a.date}</td>
            <td>${a.location}</td>
            <td>${a.registrationCount}/${a.maxParticipants || '不限'}</td>
            <td><span class="badge badge-info">${a.status}</span></td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="editActivity('${a.activityId}')">編輯</button>
              <button class="btn btn-danger btn-sm" onclick="deleteActivity('${a.activityId}')">刪除</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('載入活動失敗:', error);
      }
    }

    // 顯示新增活動
    function showCreateActivity() {
      currentEditActivityId = null;
      document.getElementById('activityModalTitle').textContent = '新增活動';
      document.getElementById('activityName').value = '';
      document.getElementById('activityType').value = '講座';
      document.getElementById('activityDate').value = '';
      document.getElementById('activityStartTime').value = '';
      document.getElementById('activityEndTime').value = '';
      document.getElementById('activityLocation').value = '';
      document.getElementById('activityMaxParticipants').value = '0';
      document.getElementById('activityFee').value = '0';
      document.getElementById('activityDeadline').value = '';
      document.getElementById('activityDescription').value = '';
      document.getElementById('activityNotes').value = '';
      openModal('activityModal');
    }

    // 儲存活動
    async function saveActivity() {
      const data = {
        action: currentEditActivityId ? 'updateActivity' : 'createActivity',
        name: document.getElementById('activityName').value,
        type: document.getElementById('activityType').value,
        date: document.getElementById('activityDate').value,
        startTime: document.getElementById('activityStartTime').value,
        endTime: document.getElementById('activityEndTime').value,
        location: document.getElementById('activityLocation').value,
        maxParticipants: parseInt(document.getElementById('activityMaxParticipants').value),
        fee: parseFloat(document.getElementById('activityFee').value),
        registrationDeadline: document.getElementById('activityDeadline').value,
        description: document.getElementById('activityDescription').value,
        notes: document.getElementById('activityNotes').value
      };
      
      if (currentEditActivityId) {
        data.activityId = currentEditActivityId;
      }
      
      if (!data.name || !data.date || !data.startTime || !data.endTime || !data.location || !data.registrationDeadline) {
        alert('請填寫所有必填欄位');
        return;
      }
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
          alert('儲存成功！');
          closeModal('activityModal');
          loadActivities();
        }
      } catch (error) {
        console.error('儲存失敗:', error);
        alert('儲存失敗，請稍後再試');
      }
    }

    // 刪除活動
    async function deleteActivity(activityId) {
      if (!confirm('確定要刪除此活動嗎？')) return;
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'deleteActivity',
            activityId: activityId
          })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('刪除成功！');
          loadActivities();
        }
      } catch (error) {
        console.error('刪除失敗:', error);
      }
    }

    // 載入活動篩選器
    async function loadActivityFilter() {
      try {
        const response = await fetch(`${API_URL}?action=getActivities`);
        const activities = await response.json();
        
        const select = document.getElementById('activityFilter');
        select.innerHTML = '<option value="">全部活動</option>' +
          activities.map(a => `<option value="${a.activityId}">${a.name}</option>`).join('');
      } catch (error) {
        console.error('載入活動篩選器失敗:', error);
      }
    }

    // 載入報名記錄
    async function loadRegistrations() {
      const activityId = document.getElementById('activityFilter').value;
      
      try {
        const response = await fetch(`${API_URL}?action=getAllRegistrations&activityId=${activityId}`);
        const registrations = await response.json();
        
        const tbody = document.getElementById('registrationsTable');
        if (registrations.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">暫無報名記錄</td></tr>';
          return;
        }
        
        tbody.innerHTML = registrations.map(r => `
          <tr>
            <td>${r.activityId}</td>
            <td>${r.memberName}</td>
            <td>${new Date(r.registeredAt).toLocaleString()}</td>
            <td><span class="badge ${r.checkInStatus === '已簽到' ? 'badge-success' : 'badge-warning'}">${r.checkInStatus}</span></td>
            <td>
              ${r.checkInStatus === '未簽到' ? `<button class="btn btn-success btn-sm" onclick="checkIn('${r.registrationId}')">簽到</button>` : ''}
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('載入報名記錄失敗:', error);
      }
    }

    // 簽到
    async function checkIn(registrationId) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'checkIn',
            registrationId: registrationId
          })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('簽到成功！');
          loadRegistrations();
        }
      } catch (error) {
        console.error('簽到失敗:', error);
      }
    }

    // 載入待審核志工
    async function loadPendingVolunteers() {
      try {
        const response = await fetch(`${API_URL}?action=getPendingVolunteers`);
        const pending = await response.json();
        
        document.getElementById('pendingCount').textContent = `待審核: ${pending.length}`;
        
        const tbody = document.getElementById('pendingVolunteers');
        if (pending.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">暫無待審核記錄</td></tr>';
          return;
        }
        
        tbody.innerHTML = pending.map(v => `
          <tr>
            <td>${v.memberName}</td>
            <td>${v.serviceDate}</td>
            <td>${v.hours} 小時</td>
            <td>${v.description}</td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="showReviewVolunteer('${v.recordId}', '${v.memberName}', '${v.serviceDate}', ${v.hours}, '${v.description}')">審核</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('載入待審核志工失敗:', error);
      }
    }

    // 顯示審核志工
    function showReviewVolunteer(recordId, name, date, hours, description) {
      currentReviewRecordId = recordId;
      document.getElementById('reviewVolunteerContent').innerHTML = `
        <div class="info-row">
          <span class="info-label">會員姓名</span>
          <span class="info-value">${name}</span>
        </div>
        <div class="info-row">
          <span class="info-label">服務日期</span>
          <span class="info-value">${date}</span>
        </div>
        <div class="info-row">
          <span class="info-label">服務時數</span>
          <span class="info-value">${hours} 小時</span>
        </div>
        <div class="info-row">
          <span class="info-label">服務說明</span>
          <span class="info-value">${description}</span>
        </div>
      `;
      document.getElementById('reviewNote').value = '';
      openModal('reviewVolunteerModal');
    }

    // 通過志工審核
    async function approveVolunteer() {
      await reviewVolunteer('已通過');
    }

    // 拒絕志工審核
    async function rejectVolunteer() {
      const note = document.getElementById('reviewNote').value;
      if (!note) {
        alert('請填寫拒絕原因');
        return;
      }
      await reviewVolunteer('已拒絕');
    }

    // 審核志工
    async function reviewVolunteer(status) {
      const note = document.getElementById('reviewNote').value;
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'reviewVolunteer',
            recordId: currentReviewRecordId,
            status: status,
            reviewNote: note
          })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('審核完成！');
          closeModal('reviewVolunteerModal');
          loadPendingVolunteers();
        }
      } catch (error) {
        console.error('審核失敗:', error);
        alert('審核失敗，請稍後再試');
      }
    }

    // 載入財務資料
    async function loadFinances() {
      try {
        const response = await fetch(`${API_URL}?action=getFinancialOverview`);
        const data = await response.json();
        
        document.getElementById('totalIncome').textContent = `NT$ ${data.totalIncome.toLocaleString()}`;
        document.getElementById('totalExpense').textContent = `NT$ ${data.totalExpense.toLocaleString()}`;
        document.getElementById('financialBalance').textContent = `NT$ ${data.balance.toLocaleString()}`;
        
        // 捐款記錄
        const donationsTable = document.getElementById('donationsTable');
        if (data.incomeRecords.length === 0) {
          donationsTable.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">暫無捐款記錄</td></tr>';
        } else {
          donationsTable.innerHTML = data.incomeRecords.map(r => `
            <tr>
              <td>${r.date}</td>
              <td>${r.name || '匿名'}</td>
              <td>NT$ ${parseFloat(r.amount).toLocaleString()}</td>
              <td>${r.description || '-'}</td>
            </tr>
          `).join('');
        }
        
        // 支出記錄
        const expensesTable = document.getElementById('expensesTable');
        if (data.expenseRecords.length === 0) {
          expensesTable.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">暫無支出記錄</td></tr>';
        } else {
          expensesTable.innerHTML = data.expenseRecords.map(r => `
            <tr>
              <td>${r.date}</td>
              <td>${r.category}</td>
              <td>${r.name}</td>
              <td>NT$ ${parseFloat(r.amount).toLocaleString()}</td>
              <td>${r.description || '-'}</td>
              <td><span class="badge badge-info">${r.status}</span></td>
              <td>
                <button class="btn btn-danger btn-sm" onclick="deleteExpense('${r.recordId}')">刪除</button>
              </td>
            </tr>
          `).join('');
        }
      } catch (error) {
        console.error('載入財務資料失敗:', error);
      }
    }

    // 顯示新增捐款
    function showAddDonation() {
      document.getElementById('donorName').value = '';
      document.getElementById('donationAmount').value = '';
      document.getElementById('donationDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('donationDescription').value = '';
      openModal('donationModal');
    }

    // 儲存捐款
    async function saveDonation() {
      const name = document.getElementById('donorName').value || '匿名';
      const amount = document.getElementById('donationAmount').value;
      const date = document.getElementById('donationDate').value;
      const description = document.getElementById('donationDescription').value;
      
      if (!amount || !date) {
        alert('請填寫必填欄位');
        return;
      }
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'addIncome',
            category: '捐款',
            amount: parseFloat(amount),
            name: name,
            description: description,
            date: date
          })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('新增成功！');
          closeModal('donationModal');
          loadFinances();
        }
      } catch (error) {
        console.error('新增失敗:', error);
        alert('新增失敗，請稍後再試');
      }
    }

    // 顯示新增支出
    function showAddExpense() {
      document.getElementById('expenseCategory').value = '活動費用';
      document.getElementById('expensePayee').value = '';
      document.getElementById('expenseAmount').value = '';
      document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('expenseDescription').value = '';
      openModal('expenseModal');
    }

    // 儲存支出
    async function saveExpense() {
      const category = document.getElementById('expenseCategory').value;
      const payee = document.getElementById('expensePayee').value;
      const amount = document.getElementById('expenseAmount').value;
      const date = document.getElementById('expenseDate').value;
      const description = document.getElementById('expenseDescription').value;
      
      if (!category || !payee || !amount || !date) {
        alert('請填寫必填欄位');
        return;
      }
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'addExpense',
            category: category,
            amount: parseFloat(amount),
            name: payee,
            description: description,
            date: date
          })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('新增成功！');
          closeModal('expenseModal');
          loadFinances();
        }
      } catch (error) {
        console.error('新增失敗:', error);
        alert('新增失敗，請稍後再試');
      }
    }

    // 刪除支出
    async function deleteExpense(recordId) {
      if (!confirm('確定要刪除此支出記錄嗎？')) return;
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'deleteFinanceRecord',
            recordId: recordId
          })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('刪除成功！');
          loadFinances();
        }
      } catch (error) {
        console.error('刪除失敗:', error);
      }
    }

    // 載入統計報表
    async function loadStatistics() {
      try {
        const response = await fetch(`${API_URL}?action=getMonthlyStats`);
        const data = await response.json();
        
        // 月度活動統計
        renderLineChart('monthlyActivityChart', data.monthlyActivities, '活動數量');
        
        // 會員成長趨勢
        renderLineChart('memberGrowthChart', data.monthlyMembers, '新增會員');
        
        // 志工服務統計
        renderLineChart('volunteerStatsChart', data.monthlyVolunteerHours, '服務時數');
        
        // 財務收支統計
        renderFinancialChart('financialStatsChart', data.monthlyIncome, data.monthlyExpense);
        
      } catch (error) {
        console.error('載入統計報表失敗:', error);
      }
    }

    // 載入系統設定
    async function loadSettings() {
      try {
        const response = await fetch(`${API_URL}?action=getSettings`);
        const settings = await response.json();
        
        document.getElementById('orgName').value = settings['組織名稱'] || '';
        document.getElementById('orgPhone').value = settings['聯絡電話'] || '';
        document.getElementById('orgEmail').value = settings['Email'] || '';
        document.getElementById('orgAddress').value = settings['地址'] || '';
      } catch (error) {
        console.error('載入設定失敗:', error);
      }
    }

    // 儲存系統設定
    async function saveSettings() {
      const data = {
        action: 'updateSettings',
        orgName: document.getElementById('orgName').value,
        phone: document.getElementById('orgPhone').value,
        email: document.getElementById('orgEmail').value,
        address: document.getElementById('orgAddress').value
      };
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
          alert('儲存成功！');
        }
      } catch (error) {
        console.error('儲存失敗:', error);
        alert('儲存失敗，請稍後再試');
      }
    }

    // 備份資料
    async function backupData() {
      try {
        const response = await fetch(`${API_URL}?action=backupData`);
        const data = await response.json();
        
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        alert('備份完成！');
      } catch (error) {
        console.error('備份失敗:', error);
        alert('備份失敗，請稍後再試');
      }
    }

    // Modal 控制
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // 圖表繪製函數
    function renderPieChart(canvasId, data, label) {
      const ctx = document.getElementById(canvasId);
      if (ctx.chart) ctx.chart.destroy();
      
      const labels = Object.keys(data);
      const values = Object.values(data);
      
      ctx.chart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: values,
            backgroundColor: [
              '#667eea',
              '#764ba2',
              '#f093fb',
              '#4facfe',
              '#43e97b',
              '#fa709a'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    function renderLineChart(canvasId, data, label) {
      const ctx = document.getElementById(canvasId);
      if (ctx.chart) ctx.chart.destroy();
      
      const labels = Object.keys(data).sort();
      const values = labels.map(l => data[l]);
      
      ctx.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: values,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function renderFinancialChart(canvasId, income, expense) {
      const ctx = document.getElementById(canvasId);
      if (ctx.chart) ctx.chart.destroy();
      
      const labels = [...new Set([...Object.keys(income), ...Object.keys(expense)])].sort();
      const incomeData = labels.map(l => income[l] || 0);
      const expenseData = labels.map(l => expense[l] || 0);
      
      ctx.chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: '收入',
              data: incomeData,
              backgroundColor: '#43e97b'
            },
            {
              label: '支出',
              data: expenseData,
              backgroundColor: '#fa709a'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // 初始化
    window.onload = () => {
      loadDashboard();
    };
  </script>
</body>
</html>
