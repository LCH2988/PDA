<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友會 - 管理後台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
  <style>
    :root { --primary-color:#00B900; --secondary-color:#06C755; --sidebar-width:250px; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color:#f5f5f5; }
    .sidebar { position:fixed; top:0; left:0; height:100vh; width:var(--sidebar-width); background:linear-gradient(180deg, var(--primary-color), var(--secondary-color)); padding:20px 0; overflow-y:auto; z-index:1000; }
    .sidebar-brand { color:#fff; font-size:1.5rem; font-weight:bold; padding:0 20px 20px; border-bottom:1px solid rgba(255,255,255,.2); margin-bottom:20px; }
    .sidebar-menu { list-style:none; padding:0; margin:0; }
    .sidebar-menu-item { padding:12px 20px; color:rgba(255,255,255,.85); cursor:pointer; transition:.3s; display:flex; align-items:center; }
    .sidebar-menu-item:hover, .sidebar-menu-item.active { background-color:rgba(255,255,255,.2); color:#fff; }
    .sidebar-menu-item i { margin-right:10px; font-size:1.2rem; }
    .main-content { margin-left:var(--sidebar-width); padding:30px; }
    .top-bar { background:#fff; padding:15px 30px; margin:-30px -30px 30px -30px; box-shadow:0 2px 10px rgba(0,0,0,.1); display:flex; justify-content:space-between; align-items:center; }
    .stat-card { background:#fff; border-radius:15px; padding:25px; box-shadow:0 4px 15px rgba(0,0,0,.1); margin-bottom:20px; transition:.3s; }
    .stat-card:hover { transform:translateY(-5px); }
    .stat-icon { width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.8rem; margin-bottom:15px; }
    .stat-value { font-size:2rem; font-weight:bold; color:#212529; }
    .stat-label { color:#6c757d; font-size:.9rem; }
    .card { border:none; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,.1); margin-bottom:20px; }
    .card-header { background:#fff; border-bottom:2px solid #e9ecef; font-weight:bold; padding:20px; border-radius:15px 15px 0 0!important; }
    .table-responsive { border-radius:10px; }
    .btn-primary { background:linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border:none; border-radius:25px; padding:8px 20px; }
    .btn-primary:hover { transform:scale(1.05); box-shadow:0 5px 15px rgba(0,185,0,.3); }
    .badge { padding:5px 12px; border-radius:20px; }
    .modal-header { background:linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color:#fff; }
    .chart-container { position:relative; height:300px; margin-top:20px; }
    @media (max-width:768px){ .sidebar{ transform:translateX(-100%); transition:.3s; } .sidebar.show{ transform:translateX(0); } .main-content{ margin-left:0; } }
  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-brand"><i class="bi bi-heart-pulse"></i> 管理後台</div>
    <ul class="sidebar-menu">
      <li class="sidebar-menu-item active" data-page="dashboard"><i class="bi bi-speedometer2"></i> 儀表板</li>
      <li class="sidebar-menu-item" data-page="members"><i class="bi bi-people"></i> 會員管理</li>
      <li class="sidebar-menu-item" data-page="activities"><i class="bi bi-calendar-event"></i> 活動管理</li>
      <li class="sidebar-menu-item" data-page="registrations"><i class="bi bi-list-check"></i> 報名管理</li>
      <li class="sidebar-menu-item" data-page="volunteers"><i class="bi bi-heart"></i> 志工管理</li>
      <li class="sidebar-menu-item" data-page="finance"><i class="bi bi-cash-stack"></i> 財務管理</li>
      <li class="sidebar-menu-item" data-page="statistics"><i class="bi bi-graph-up"></i> 統計報表</li>
      <li class="sidebar-menu-item" data-page="settings"><i class="bi bi-gear"></i> 系統設定</li>
    </ul>
  </div>

  <div class="main-content">
    <div class="top-bar">
      <div>
        <button class="btn btn-outline-secondary d-md-none" id="toggleSidebarBtn"><i class="bi bi-list"></i></button>
        <span class="ms-3" id="pageTitle">儀表板</span>
      </div>
      <div>
        <span class="me-3" id="adminName">管理員</span>
        <button class="btn btn-sm btn-outline-danger" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> 登出</button>
      </div>
    </div>

    <!-- 儀表板 -->
    <div id="dashboardPage">
      <h2 class="mb-4">系統概覽</h2>
      <div class="row">
        <div class="col-md-3"><div class="stat-card"><div class="stat-icon bg-primary bg-opacity-10 text-primary"><i class="bi bi-people"></i></div><div class="stat-value" id="totalMembers">0</div><div class="stat-label">總會員數</div></div></div>
        <div class="col-md-3"><div class="stat-card"><div class="stat-icon bg-success bg-opacity-10 text-success"><i class="bi bi-calendar-event"></i></div><div class="stat-value" id="totalActivities">0</div><div class="stat-label">總活動數</div></div></div>
        <div class="col-md-3"><div class="stat-card"><div class="stat-icon bg-warning bg-opacity-10 text-warning"><i class="bi bi-heart"></i></div><div class="stat-value" id="totalVolunteerHours">0</div><div class="stat-label">志工總時數</div></div></div>
        <div class="col-md-3"><div class="stat-card"><div class="stat-icon bg-info bg-opacity-10 text-info"><i class="bi bi-cash-stack"></i></div><div class="stat-value" id="financeBalance">0</div><div class="stat-label">財務餘額</div></div></div>
      </div>
      <div class="row">
        <div class="col-md-6"><div class="card"><div class="card-header">會員類型分布</div><div class="card-body"><div class="chart-container"><canvas id="memberTypeChart"></canvas></div></div></div></div>
        <div class="col-md-6"><div class="card"><div class="card-header">活動狀態統計</div><div class="card-body"><div class="chart-container"><canvas id="activityStatusChart"></canvas></div></div></div></div>
      </div>
      <div class="card">
        <div class="card-header">最近活動</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="recentActivitiesTable">
              <thead><tr><th>活動名稱</th><th>日期</th><th>地點</th><th>報名人數</th><th>狀態</th></tr></thead>
              <tbody><tr><td colspan="5" class="text-center text-muted">載入中...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 會員管理 -->
    <div id="membersPage" style="display:none;">
      <h2 class="mb-4">會員管理</h2>
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>會員列表</span>
          <div>
            <input type="text" class="form-control d-inline-block w-auto me-2" id="memberSearch" placeholder="搜尋會員...">
            <button class="btn btn-primary" id="memberSearchBtn"><i class="bi bi-search"></i> 搜尋</button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="membersTable">
              <thead><tr><th>姓名</th><th>電話</th><th>會員類型</th><th>角色</th><th>狀態</th><th>註冊日期</th><th>操作</th></tr></thead>
              <tbody><tr><td colspan="7" class="text-center text-muted">載入中...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 活動管理 -->
    <div id="activitiesPage" style="display:none;">
      <h2 class="mb-4">活動管理</h2>
      <button class="btn btn-primary mb-3" id="showCreateActivityBtn"><i class="bi bi-plus-circle"></i> 新增活動</button>
      <div class="card">
        <div class="card-header">活動列表</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="activitiesTable">
              <thead><tr><th>活動名稱</th><th>日期</th><th>地點</th><th>類型</th><th>報名人數</th><th>狀態</th><th>操作</th></tr></thead>
              <tbody><tr><td colspan="7" class="text-center text-muted">載入中...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 報名管理 -->
    <div id="registrationsPage" style="display:none;">
      <h2 class="mb-4">報名管理</h2>
      <div class="card">
        <div class="card-header">
          <div class="row">
            <div class="col-md-6">報名列表</div>
            <div class="col-md-6 text-end">
              <select class="form-select d-inline-block w-auto" id="regActivityFilter"></select>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="registrationsTable">
              <thead><tr><th>活動名稱</th><th>會員姓名</th><th>電話</th><th>報名時間</th><th>簽到時間</th><th>狀態</th><th>操作</th></tr></thead>
              <tbody><tr><td colspan="7" class="text-center text-muted">載入中...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 志工管理 -->
    <div id="volunteersPage" style="display:none;">
      <h2 class="mb-4">志工管理</h2>
      <div class="row mb-3">
        <div class="col-md-4"><div class="stat-card"><h5>待審核記錄</h5><div class="stat-value text-warning" id="pendingVolunteerRecords">0</div></div></div>
        <div class="col-md-4"><div class="stat-card"><h5>總志工人數</h5><div class="stat-value text-success" id="totalVolunteers">0</div></div></div>
        <div class="col-md-4"><div class="stat-card"><h5>總服務時數</h5><div class="stat-value text-info" id="totalVolunteerHoursDetail">0</div></div></div>
      </div>
      <div class="card">
        <div class="card-header">志工服務記錄</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="volunteersTable">
              <thead><tr><th>志工姓名</th><th>服務日期</th><th>服務時數</th><th>服務項目</th><th>狀態</th><th>審核者</th><th>操作</th></tr></thead>
              <tbody><tr><td colspan="7" class="text-center text-muted">載入中...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 財務管理 -->
    <div id="financePage" style="display:none;">
      <h2 class="mb-4">財務管理</h2>
      <div class="row mb-3">
        <div class="col-md-4"><div class="stat-card"><h5>總收入</h5><div class="stat-value text-success" id="totalIncome">0</div></div></div>
        <div class="col-md-4"><div class="stat-card"><h5>總支出</h5><div class="stat-value text-danger" id="totalExpense">0</div></div></div>
        <div class="col-md-4"><div class="stat-card"><h5>餘額</h5><div class="stat-value text-primary" id="balance">0</div></div></div>
      </div>
      <div class="row">
        <div class="col-md-6"><div class="card">
          <div class="card-header d-flex justify-content-between align-items-center"><span>捐款記錄</span></div>
          <div class="card-body"><div class="table-responsive">
            <table class="table table-sm" id="donationsTable">
              <thead><tr><th>捐款人</th><th>金額</th><th>日期</th><th>方式</th></tr></thead>
              <tbody><tr><td colspan="4" class="text-center text-muted">載入中...</td></tr></tbody>
            </table>
          </div></div></div></div>
        <div class="col-md-6"><div class="card">
          <div class="card-header d-flex justify-content-between align-items-center"><span>支出記錄</span></div>
          <div class="card-body"><div class="table-responsive">
            <table class="table table-sm" id="expensesTable">
              <thead><tr><th>項目</th><th>金額</th><th>日期</th><th>狀態</th><th>操作</th></tr></thead>
              <tbody><tr><td colspan="5" class="text-center text-muted">載入中...</td></tr></tbody>
            </table>
          </div></div></div></div>
      </div>
    </div>

    <!-- 統計報表 -->
    <div id="statisticsPage" style="display:none;">
      <h2 class="mb-4">統計報表</h2>
      <div class="row">
        <div class="col-md-6"><div class="card"><div class="card-header">月度活動統計</div><div class="card-body"><div class="chart-container"><canvas id="monthlyActivityChart"></canvas></div></div></div></div>
        <div class="col-md-6"><div class="card"><div class="card-header">會員成長趨勢</div><div class="card-body"><div class="chart-container"><canvas id="memberGrowthChart"></canvas></div></div></div></div>
      </div>
      <div class="row">
        <div class="col-md-6"><div class="card"><div class="card-header">志工服務統計</div><div class="card-body"><div class="chart-container"><canvas id="volunteerStatsChart"></canvas></div></div></div></div>
        <div class="col-md-6"><div class="card"><div class="card-header">財務收支統計</div><div class="card-body"><div class="chart-container"><canvas id="financeStatsChart"></canvas></div></div></div></div>
      </div>
    </div>

    <!-- 系統設定 -->
    <div id="settingsPage" style="display:none;">
      <h2 class="mb-4">系統設定</h2>
      <div class="card">
        <div class="card-header">基本設定</div>
        <div class="card-body">
          <form id="settingsForm">
            <div class="mb-3"><label class="form-label">組織名稱</label><input type="text" class="form-control" id="orgName" value="帕金森病友會"></div>
            <div class="mb-3"><label class="form-label">聯絡電話</label><input type="tel" class="form-control" id="orgPhone"></div>
            <div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control" id="orgEmail"></div>
            <div class="mb-3"><label class="form-label">地址</label><input type="text" class="form-control" id="orgAddress"></div>
            <button type="button" class="btn btn-primary" id="saveSettingsBtn"><i class="bi bi-save"></i> 儲存設定</button>
            <button type="button" class="btn btn-success ms-2" id="backupBtn"><i class="bi bi-download"></i> 立即備份</button>
            <p class="mt-3 text-muted">上次備份時間：<span id="lastBackupTime">未備份</span></p>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="createActivityModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">新增活動</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="createActivityForm">
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">活動名稱 *</label><input type="text" class="form-control" id="actTitle" required></div>
            <div class="col-md-6 mb-3"><label class="form-label">活動類型 *</label>
              <select class="form-select" id="actType" required>
                <option value="講座">講座</option><option value="運動課程">運動課程</option><option value="聚會">聚會</option><option value="義診">義診</option><option value="其他">其他</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">活動日期 *</label><input type="date" class="form-control" id="actDate" required></div>
            <div class="col-md-6 mb-3"><label class="form-label">活動時間 *</label><input type="text" class="form-control" id="actTime" placeholder="例：14:00-16:00" required></div>
          </div>
          <div class="mb-3"><label class="form-label">活動地點 *</label><input type="text" class="form-control" id="actLocation" required></div>
          <div class="mb-3"><label class="form-label">活動說明</label><textarea class="form-control" id="actDescription" rows="3"></textarea></div>
          <div class="row">
            <div class="col-md-4 mb-3"><label class="form-label">人數上限</label><input type="number" class="form-control" id="actMaxParticipants" min="0"></div>
            <div class="col-md-4 mb-3"><label class="form-label">活動費用</label><input type="number" class="form-control" id="actFee" min="0" value="0"></div>
            <div class="col-md-4 mb-3"><label class="form-label">報名截止日</label><input type="date" class="form-control" id="actDeadline"></div>
          </div>
          <div class="mb-3"><label class="form-label">注意事項</label><textarea class="form-control" id="actNote" rows="2"></textarea></div>
        </form>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button type="button" class="btn btn-primary" id="submitCreateActivityBtn">建立活動</button></div>
    </div></div>
  </div>

  <div class="modal fade" id="editMemberModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">編輯會員</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="editMemberForm">
          <input type="hidden" id="editMemberId">
          <div class="mb-3"><label class="form-label">角色</label>
            <select class="form-select" id="editMemberRole">
              <option value="member">一般會員</option><option value="volunteer">志工</option><option value="manager">管理員</option><option value="finance">財務</option><option value="admin">系統管理員</option>
            </select>
          </div>
          <div class="mb-3"><label class="form-label">狀態</label>
            <select class="form-select" id="editMemberStatus">
              <option value="啟用">啟用</option><option value="停用">停用</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button type="button" class="btn btn-primary" id="submitEditMemberBtn">儲存</button></div>
    </div></div>
  </div>

  <div class="modal fade" id="approveVolunteerModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">審核志工記錄</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="approveRecordId">
        <div id="volunteerRecordDetail"></div>
        <div class="mb-3"><label class="form-label">審核意見</label><textarea class="form-control" id="approveNote" rows="3"></textarea></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-danger" id="rejectVolunteerBtn">拒絕</button>
        <button type="button" class="btn btn-success" id="approveVolunteerBtn">通過</button>
      </div>
    </div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const CONFIG = {
      API_URL: 'https://script.google.com/macros/s/AKfycbzYkRHEG-f2s_70huSye0mfeUbhFqm0CqkPfzO67PA06e89e2vnJ1BmLkPcgTVZqbqlNA/exec',
      API_KEY: 'AAbb520258185202581'
    };

    let currentPage = 'dashboard';
    let currentAdmin = null;
    let allMembers = [];
    let allActivities = [];
    let allRegistrations = [];
    let allVolunteerRecords = [];

    // 初始
    window.addEventListener('load', () => {
      checkAuth();
      bindUI();
      loadDashboard();
    });

    function bindUI() {
      // Sidebar 切換
      document.getElementById('toggleSidebarBtn').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('show');
      });
      // Menu 點擊
      document.querySelectorAll('.sidebar-menu-item').forEach(item => {
        item.addEventListener('click', (e) => {
          document.querySelectorAll('.sidebar-menu-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          const page = item.getAttribute('data-page');
          showPage(page);
        });
      });
      // 登出
      document.getElementById('logoutBtn').addEventListener('click', logout);

      // 會員搜尋
      document.getElementById('memberSearchBtn').addEventListener('click', searchMembers);

      // 活動 modal
      document.getElementById('showCreateActivityBtn').addEventListener('click', () => {
        document.getElementById('createActivityForm').reset();
        new bootstrap.Modal(document.getElementById('createActivityModal')).show();
      });
      document.getElementById('submitCreateActivityBtn').addEventListener('click', submitCreateActivity);

      // 編輯會員儲存
      document.getElementById('submitEditMemberBtn').addEventListener('click', submitEditMember);

      // 志工審核
      document.getElementById('approveVolunteerBtn').addEventListener('click', approveVolunteerRecord);
      document.getElementById('rejectVolunteerBtn').addEventListener('click', rejectVolunteerRecord);

      // 設定
      document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
      document.getElementById('backupBtn').addEventListener('click', backupData);

      // 報名篩選
      const regFilter = document.getElementById('regActivityFilter');
      if (regFilter) regFilter.addEventListener('change', filterRegistrations);
    }

    function checkAuth() {
      const adminData = localStorage.getItem('adminData') || sessionStorage.getItem('adminData');
      if (!adminData) {
        window.location.href = 'login.html';
        return;
      }
      currentAdmin = JSON.parse(adminData);
      document.getElementById('adminName').textContent = currentAdmin.name || '管理員';
    }

    function logout() {
      localStorage.removeItem('adminData');
      sessionStorage.removeItem('adminData');
      window.location.href = 'login.html';
    }

    function showPage(pageName) {
      document.querySelectorAll('[id$="Page"]').forEach(p => p.style.display = 'none');
      const pageMap = {
        dashboard: 'dashboardPage',
        members: 'membersPage',
        activities: 'activitiesPage',
        registrations: 'registrationsPage',
        volunteers: 'volunteersPage',
        finance: 'financePage',
        statistics: 'statisticsPage',
        settings: 'settingsPage'
      };
      const id = pageMap[pageName];
      if (!id) return;
      document.getElementById(id).style.display = 'block';
      document.getElementById('pageTitle').textContent = document.querySelector(`.sidebar-menu-item[data-page="${pageName}"]`).textContent.trim();
      currentPage = pageName;
      loadPageData(pageName);
    }

    async function loadPageData(pageName) {
      try {
        if (pageName === 'dashboard') await loadDashboard();
        if (pageName === 'members') await loadMembers();
        if (pageName === 'activities') await loadActivitiesManagement();
        if (pageName === 'registrations') await loadRegistrations();
        if (pageName === 'volunteers') await loadVolunteers();
        if (pageName === 'finance') await loadFinance();
        if (pageName === 'statistics') await loadStatistics();
      } catch (e) {
        console.error('載入頁面資料失敗:', e);
        showAlert('載入資料失敗', 'danger');
      }
    }

    // API 包裝
    async function apiCall(action, data = {}) {
      const body = { action, apiKey: CONFIG.API_KEY, ...data };
      const resp = await fetch(CONFIG.API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const result = await resp.json();
      if (!result.success) {
        const msg = result.message || (result.data && result.data.message) || '操作失敗';
        throw new Error(msg);
      }
      return result.data;
    }

    // 儀表板
    let memberTypeChart, activityStatusChart;
    async function loadDashboard() {
      const data = await apiCall('getAdminDashboard');
      document.getElementById('totalMembers').textContent = data.totalMembers;
      document.getElementById('totalActivities').textContent = data.totalActivities;
      document.getElementById('totalVolunteerHours').textContent = data.totalVolunteerHours;
      document.getElementById('financeBalance').textContent = 'NT$ ' + Number(data.financeBalance || 0).toLocaleString();

      // 圖表
      if (data.memberTypeStats) {
        memberTypeChart && memberTypeChart.destroy();
        memberTypeChart = createPieChart('memberTypeChart', data.memberTypeStats.labels, data.memberTypeStats.values);
      }
      if (data.activityStatusStats) {
        activityStatusChart && activityStatusChart.destroy();
        activityStatusChart = createPieChart('activityStatusChart', data.activityStatusStats.labels, data.activityStatusStats.values);
      }

      // 最近活動
      const tbody = document.querySelector('#recentActivitiesTable tbody');
      const list = data.recentActivities || [];
      if (list.length > 0) {
        tbody.innerHTML = list.map(a => `
          <tr>
            <td>${a.title}</td>
            <td>${formatDate(a.date)}</td>
            <td>${a.location || ''}</td>
            <td>${a.currentParticipants}/${a.maxParticipants || '不限'}</td>
            <td><span class="badge bg-${getStatusColor(a.status)}">${a.status}</span></td>
          </tr>
        `).join('');
      } else {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">暫無資料</td></tr>';
      }
    }

    // 會員管理
    async function loadMembers() {
      const result = await apiCall('getAllMembers'); // 後端允許無 lineId 呼叫
      allMembers = result.data || result;
      displayMembers(allMembers);
    }
    function displayMembers(members) {
      const tbody = document.querySelector('#membersTable tbody');
      if (!members || members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暫無會員資料</td></tr>'; return;
      }
      tbody.innerHTML = members.map(m => `
        <tr>
          <td>${m.realName || m.lineName || '-'}</td>
          <td>${m.phone || '-'}</td>
          <td>${m.memberType || '-'}</td>
          <td><span class="badge bg-info">${getRoleText(m.role)}</span></td>
          <td><span class="badge bg-${(m.status === '啟用') ? 'success' : 'secondary'}">${m.status || '啟用'}</span></td>
          <td>${formatDate(m.createdAt)}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="viewMemberDetail('${m.id}')"><i class="bi bi-eye"></i></button>
            <button class="btn btn-sm btn-outline-warning" onclick="editMember('${m.id}')"><i class="bi bi-pencil"></i></button>
          </td>
        </tr>
      `).join('');
    }
    function searchMembers() {
      const q = (document.getElementById('memberSearch').value || '').toLowerCase();
      const filtered = allMembers.filter(m =>
        (m.realName || '').toLowerCase().includes(q) ||
        (m.lineName || '').toLowerCase().includes(q) ||
        (m.phone || '').includes(q)
      );
      displayMembers(filtered);
    }
    function viewMemberDetail(memberId) {
      const m = allMembers.find(x => x.id === memberId);
      if (!m) return;
      alert(`會員詳情：\n姓名：${m.realName || m.lineName}\n電話：${m.phone || ''}\nEmail：${m.email || ''}\n地址：${m.address || ''}`);
    }
    function editMember(memberId) {
      const m = allMembers.find(x => x.id === memberId); if (!m) return;
      document.getElementById('editMemberId').value = m.id;
      document.getElementById('editMemberRole').value = m.role || 'member';
      document.getElementById('editMemberStatus').value = m.status || '啟用';
      new bootstrap.Modal(document.getElementById('editMemberModal')).show();
    }
    async function submitEditMember() {
      try {
        await apiCall('updateMemberRole', {
          memberId: document.getElementById('editMemberId').value,
          role: document.getElementById('editMemberRole').value,
          status: document.getElementById('editMemberStatus').value
        });
        showAlert('會員資料已更新', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editMemberModal')).hide();
        loadMembers();
      } catch (e) {
        showAlert(e.message || '更新失敗', 'danger');
      }
    }

    // 活動管理
    async function loadActivitiesManagement() {
      const result = await apiCall('getAllActivities');
      allActivities = result.data || result;
      displayActivitiesManagement(allActivities);
    }
    function displayActivitiesManagement(list) {
      const tbody = document.querySelector('#activitiesTable tbody');
      if (!list || list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暫無活動資料</td></tr>'; return;
      }
      tbody.innerHTML = list.map(a => `
        <tr>
          <td>${a.title}</td><td>${formatDate(a.date)}</td><td>${a.location || ''}</td><td>${a.type}</td>
          <td>${a.currentParticipants}/${a.maxParticipants || '不限'}</td>
          <td><span class="badge bg-${getStatusColor(a.status)}">${a.status}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteActivity('${a.id}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `).join('');
    }
    async function submitCreateActivity() {
      const form = document.getElementById('createActivityForm');
      if (!form.checkValidity()) { form.reportValidity(); return; }
      try {
        await apiCall('createActivity', {
          activityData: {
            title: document.getElementById('actTitle').value,
            type: document.getElementById('actType').value,
            date: document.getElementById('actDate').value,
            time: document.getElementById('actTime').value,
            location: document.getElementById('actLocation').value,
            description: document.getElementById('actDescription').value,
            maxParticipants: parseInt(document.getElementById('actMaxParticipants').value) || 0,
            fee: parseFloat(document.getElementById('actFee').value) || 0,
            registrationDeadline: document.getElementById('actDeadline').value,
            note: document.getElementById('actNote').value
          }
        });
        showAlert('活動已建立', 'success');
        bootstrap.Modal.getInstance(document.getElementById('createActivityModal')).hide();
        loadActivitiesManagement();
      } catch (e) {
        showAlert(e.message || '建立失敗', 'danger');
      }
    }
    async function deleteActivity(activityId) {
      if (!confirm('確定要刪除此活動嗎？')) return;
      try {
        await apiCall('deleteActivity', { activityId });
        showAlert('活動已刪除', 'success');
        loadActivitiesManagement();
      } catch (e) {
        showAlert(e.message || '刪除失敗', 'danger');
      }
    }

    // 報名管理
    async function loadRegistrations() {
      const result = await apiCall('getAllRegistrations');
      allRegistrations = result.data || result;

      // 活動篩選
      const activityFilter = document.getElementById('regActivityFilter');
      const uniqueTitles = Array.from(new Set(allRegistrations.map(r => r.activityTitle))).filter(Boolean);
      activityFilter.innerHTML = '<option value="">所有活動</option>' + uniqueTitles.map(t => `<option value="${t}">${t}</option>`).join('');

      displayRegistrations(allRegistrations);
    }
    function displayRegistrations(list) {
      const tbody = document.querySelector('#registrationsTable tbody');
      if (!list || list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暫無報名資料</td></tr>'; return;
      }
      tbody.innerHTML = list.map(r => `
        <tr>
          <td>${r.activityTitle}</td>
          <td>${r.memberName}</td>
          <td>${r.memberPhone || '-'}</td>
          <td>${formatDateTime(r.registeredAt)}</td>
          <td>${r.checkInAt ? formatDateTime(r.checkInAt) : '-'}</td>
          <td><span class="badge bg-${getRegistrationStatusColor(r.status)}">${r.status}</span></td>
          <td>${r.status === '已報名' ? `<button class="btn btn-sm btn-success" onclick="checkInRegistration('${r.id}')"><i class="bi bi-check"></i> 簽到</button>` : ''}</td>
        </tr>
      `).join('');
    }
    function filterRegistrations() {
      const t = document.getElementById('regActivityFilter').value;
      const filtered = t ? allRegistrations.filter(r => r.activityTitle === t) : allRegistrations;
      displayRegistrations(filtered);
    }
    async function checkInRegistration(registrationId) {
      if (!confirm('確定要為此會員簽到嗎？')) return;
      try {
        await apiCall('checkInRegistration', { registrationId });
        showAlert('簽到成功', 'success');
        loadRegistrations();
      } catch (e) {
        showAlert(e.message || '簽到失敗', 'danger');
      }
    }

    // 志工管理
    async function loadVolunteers() {
      const result = await apiCall('getAllVolunteerRecords');
      allVolunteerRecords = result.data || result;
      const pending = allVolunteerRecords.filter(r => r.status === '待審核').length;
      const volunteers = Array.from(new Set(allVolunteerRecords.map(r => r.lineId))).length;
      const totalHours = allVolunteerRecords.filter(r => r.status === '已審核').reduce((s, r) => s + Number(r.hours || 0), 0);
      document.getElementById('pendingVolunteerRecords').textContent = pending;
      document.getElementById('totalVolunteers').textContent = volunteers;
      document.getElementById('totalVolunteerHoursDetail').textContent = totalHours;
      displayVolunteerRecords(allVolunteerRecords);
    }
    function displayVolunteerRecords(records) {
      const tbody = document.querySelector('#volunteersTable tbody');
      if (!records || records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暫無志工記錄</td></tr>'; return;
      }
      tbody.innerHTML = records.map(r => `
        <tr>
          <td>${r.memberName}</td>
          <td>${formatDate(r.date)}</td>
          <td>${r.hours}</td>
          <td>${r.activity}</td>
          <td><span class="badge bg-${getVolunteerStatusColor(r.status)}">${r.status}</span></td>
          <td>${r.approver || '-'}</td>
          <td>${r.status === '待審核' ? `<button class="btn btn-sm btn-primary" onclick="showApproveModal('${r.id}')"><i class="bi bi-check-circle"></i> 審核</button>` : ''}</td>
        </tr>
      `).join('');
    }
    function showApproveModal(recordId) {
      const r = allVolunteerRecords.find(x => x.id === recordId); if (!r) return;
      document.getElementById('approveRecordId').value = r.id;
      document.getElementById('volunteerRecordDetail').innerHTML = `
        <p><strong>志工：</strong>${r.memberName}</p>
        <p><strong>服務日期：</strong>${formatDate(r.date)}</p>
        <p><strong>服務時數：</strong>${r.hours} 小時</p>
        <p><strong>服務項目：</strong>${r.activity}</p>
        <p><strong>服務內容：</strong>${r.description || '無'}</p>
      `;
      new bootstrap.Modal(document.getElementById('approveVolunteerModal')).show();
    }
    async function approveVolunteerRecord() {
      const recordId = document.getElementById('approveRecordId').value;
      const note = document.getElementById('approveNote').value;
      try {
        await apiCall('approveVolunteerRecord', { recordId, approved: true, note });
        showAlert('已通過審核', 'success');
        bootstrap.Modal.getInstance(document.getElementById('approveVolunteerModal')).hide();
        loadVolunteers();
      } catch (e) {
        showAlert(e.message || '審核失敗', 'danger');
      }
    }
    async function rejectVolunteerRecord() {
      const recordId = document.getElementById('approveRecordId').value;
      const note = document.getElementById('approveNote').value;
      if (!note) { alert('請填寫拒絕原因'); return; }
      try {
        await apiCall('approveVolunteerRecord', { recordId, approved: false, note });
        showAlert('已拒絕此記錄', 'warning');
        bootstrap.Modal.getInstance(document.getElementById('approveVolunteerModal')).hide();
        loadVolunteers();
      } catch (e) {
        showAlert(e.message || '操作失敗', 'danger');
      }
    }

    // 財務管理
    async function loadFinance() {
      const data = await apiCall('getFinanceData');
      document.getElementById('totalIncome').textContent = 'NT$ ' + Number(data.totalIncome || 0).toLocaleString();
      document.getElementById('totalExpense').textContent = 'NT$ ' + Number(data.totalExpense || 0).toLocaleString();
      document.getElementById('balance').textContent = 'NT$ ' + Number(data.balance || 0).toLocaleString();

      const dBody = document.querySelector('#donationsTable tbody');
      const eBody = document.querySelector('#expensesTable tbody');

      const donations = data.donations || [];
      dBody.innerHTML = donations.length ? donations.slice(0, 20).map(d => `
        <tr><td>${d.donorName}</td><td>NT$ ${Number(d.amount||0).toLocaleString()}</td><td>${formatDate(d.date)}</td><td>${d.method}</td></tr>
      `).join('') : '<tr><td colspan="4" class="text-center text-muted">暫無資料</td></tr>';

      const expenses = data.expenses || [];
      eBody.innerHTML = expenses.length ? expenses.slice(0, 20).map(e => `
        <tr>
          <td>${e.item}</td><td>NT$ ${Number(e.amount||0).toLocaleString()}</td><td>${formatDate(e.date)}</td>
          <td><span class="badge bg-${e.status === '已審核' ? 'success' : 'warning'}">${e.status}</span></td>
          <td>${e.status === '待審核' ? `<button class="btn btn-sm btn-success" onclick="approveExpense('${e.id}')"><i class="bi bi-check"></i></button>` : ''}</td>
        </tr>
      `).join('') : '<tr><td colspan="5" class="text-center text-muted">暫無資料</td></tr>';
    }
    async function approveExpense(expenseId) {
      if (!confirm('確定要核准此支出嗎？')) return;
      try {
        await apiCall('approveExpense', { expenseId });
        showAlert('支出已核准', 'success');
        loadFinance();
      } catch (e) {
        showAlert(e.message || '核准失敗', 'danger');
      }
    }

    // 統計報表（示意，直接用 dashboard 的資料）
    let monthlyActivityChart, memberGrowthChart, volunteerStatsChart, financeStatsChart;
    async function loadStatistics() {
      // 可延伸：呼叫 getStatistics 取得更多維度資料
      const dash = await apiCall('getAdminDashboard');
      // 簡化成示範用資料
      monthlyActivityChart && monthlyActivityChart.destroy();
      monthlyActivityChart = createLineChart('monthlyActivityChart', ['1月','2月','3月','4月','5月','6月'], [2,3,5,4,6,7], '活動數');
      memberGrowthChart && memberGrowthChart.destroy();
      memberGrowthChart = createLineChart('memberGrowthChart', ['1月','2月','3月','4月','5月','6月'], [10,20,35,50,65,80], '會員數');
      volunteerStatsChart && volunteerStatsChart.destroy();
      volunteerStatsChart = createBarChart('volunteerStatsChart', ['志工A','志工B','志工C'], [{ label:'時數', values:[20,15,30] }]);
      financeStatsChart && financeStatsChart.destroy();
      financeStatsChart = createBarChart('financeStatsChart', ['收入','支出'], [{ label:'金額', values:[dash.financeBalance + 20000, 20000] }]);
    }

    // 設定
    async function saveSettings() {
      // 可依需求儲存到 SETTINGS 表，這裡示範提示
      showAlert('設定已儲存（示意）', 'success');
    }
    async function backupData() {
      try {
        const data = await apiCall('backupData');
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        document.getElementById('lastBackupTime').textContent = new Date().toLocaleString('zh-TW');
        showAlert('資料備份成功', 'success');
      } catch (e) {
        showAlert(e.message || '備份失敗', 'danger');
      }
    }

    // 圖表工具
    function createPieChart(canvasId, labels, values) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;
      return new Chart(ctx, {
        type: 'pie',
        data: { labels, datasets: [{ data: values, backgroundColor:['#00B900','#06C755','#FFD700','#FF6B6B','#4ECDC4','#95E1D3'] }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
      });
    }
    function createLineChart(canvasId, labels, values, label='數量') {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;
      return new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label, data: values, borderColor:'#00B900', backgroundColor:'rgba(0,185,0,.1)', tension:.4, fill:true }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } }
      });
    }
    function createBarChart(canvasId, labels, datasets) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;
      return new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: datasets.map((ds,i)=>({ label: ds.label, data: ds.values, backgroundColor: ['#00B900','#06C755','#FFD700','#FF6B6B'][i%4] })) },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } }
      });
    }

    // 工具
    function formatDate(s){ if(!s) return ''; const d=new Date(s); return d.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit'}); }
    function formatDateTime(s){ if(!s) return ''; const d=new Date(s); return d.toLocaleString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}); }
    function getStatusColor(status){ const c={'報名中':'success','即將開始':'warning','進行中':'info','已結束':'secondary'}; return c[status]||'secondary'; }
    function getRegistrationStatusColor(status){ const c={'已報名':'primary','已簽到':'success','已取消':'secondary'}; return c[status]||'secondary'; }
    function getVolunteerStatusColor(status){ const c={'待審核':'warning','已審核':'success','已拒絕':'danger'}; return c[status]||'secondary'; }
    function getRoleText(role){ const m={'member':'一般會員','volunteer':'志工','manager':'管理員','finance':'財務','admin':'系統管理員'}; return m[role]||'一般會員'; }
    function showAlert(message,type='info'){ const el=document.createElement('div'); el.className=`alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`; el.style.zIndex='9999'; el.style.minWidth='300px'; el.innerHTML=`${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`; document.body.appendChild(el); setTimeout(()=>el.remove(),5000); }
  </script>
</body>
</html>
