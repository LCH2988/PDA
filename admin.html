<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†å“¡å¾Œå°</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          background: #f5f7fa;
      }

      .admin-container {
          display: flex;
          min-height: 100vh;
      }

      .sidebar {
          width: 250px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          position: fixed;
          height: 100vh;
          overflow-y: auto;
      }

      .sidebar h2 {
          margin-bottom: 30px;
          font-size: 20px;
          text-align: center;
      }

      .menu-item {
          padding: 12px 15px;
          margin-bottom: 5px;
          border-radius: 8px;
          cursor: pointer;
          transition: background 0.3s;
      }

      .menu-item:hover {
          background: rgba(255,255,255,0.2);
      }

      .menu-item.active {
          background: rgba(255,255,255,0.3);
      }

      .main-content {
          margin-left: 250px;
          flex: 1;
          padding: 30px;
      }

      .header {
          background: white;
          padding: 20px 30px;
          border-radius: 10px;
          margin-bottom: 30px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .header h1 {
          font-size: 24px;
          color: #333;
      }

      .logout-btn {
          background: #e74c3c;
          color: white;
          padding: 10px 20px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
      }

      .logout-btn:hover {
          background: #c0392b;
      }

      .content-section {
          display: none;
      }

      .content-section.active {
          display: block;
      }

      .card {
          background: white;
          border-radius: 10px;
          padding: 25px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          margin-bottom: 20px;
      }

      .card h3 {
          color: #333;
          margin-bottom: 20px;
          font-size: 18px;
          border-bottom: 2px solid #667eea;
          padding-bottom: 10px;
      }

      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
      }

      .stat-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
      }

      .stat-card h4 {
          font-size: 14px;
          margin-bottom: 10px;
          opacity: 0.9;
      }

      .stat-card .number {
          font-size: 32px;
          font-weight: bold;
      }

      .btn {
          padding: 10px 20px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
          transition: all 0.3s;
      }

      .btn-primary {
          background: #667eea;
          color: white;
      }

      .btn-primary:hover {
          background: #5568d3;
      }

      .btn-success {
          background: #27ae60;
          color: white;
      }

      .btn-success:hover {
          background: #229954;
      }

      .btn-danger {
          background: #e74c3c;
          color: white;
      }

      .btn-danger:hover {
          background: #c0392b;
      }

      .btn-warning {
          background: #f39c12;
          color: white;
      }

      .btn-warning:hover {
          background: #e67e22;
      }

      .form-group {
          margin-bottom: 15px;
      }

      .form-group label {
          display: block;
          margin-bottom: 5px;
          color: #333;
          font-weight: 600;
          font-size: 14px;
      }

      .form-group input, .form-group select, .form-group textarea {
          width: 100%;
          padding: 10px;
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          font-size: 14px;
          font-family: inherit;
      }

      .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
          outline: none;
          border-color: #667eea;
      }

      .form-row {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
      }

      table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 15px;
      }

      table th, table td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #e0e0e0;
      }

      table th {
          background: #f8f9fa;
          font-weight: 600;
          color: #333;
      }

      table tr:hover {
          background: #f8f9fa;
      }

      .action-btns {
          display: flex;
          gap: 5px;
      }

      .action-btns button {
          padding: 5px 10px;
          font-size: 12px;
      }

      .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          z-index: 1000;
          justify-content: center;
          align-items: center;
      }

      .modal.active {
          display: flex;
      }

      .modal-content {
          background: white;
          border-radius: 10px;
          padding: 30px;
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
      }

      .modal-header h3 {
          color: #333;
          font-size: 20px;
      }

      .close-btn {
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #999;
      }

      .close-btn:hover {
          color: #333;
      }

      .filter-bar {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
          flex-wrap: wrap;
      }

      .filter-bar input, .filter-bar select {
          padding: 8px 12px;
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          font-size: 14px;
      }

      .status-badge {
          padding: 5px 10px;
          border-radius: 5px;
          font-size: 12px;
          font-weight: 600;
      }

      .status-pending {
          background: #fff3cd;
          color: #856404;
      }

      .status-approved {
          background: #d4edda;
          color: #155724;
      }

      .status-rejected {
          background: #f8d7da;
          color: #721c24;
      }

      .status-completed {
          background: #d1ecf1;
          color: #0c5460;
      }

      .message {
          padding: 12px;
          border-radius: 8px;
          margin-bottom: 15px;
          text-align: center;
      }

      .message.success {
          background: #d4edda;
          color: #155724;
      }

      .message.error {
          background: #f8d7da;
          color: #721c24;
      }

      .loading {
          text-align: center;
          padding: 20px;
          color: #667eea;
      }

      .empty-state {
          text-align: center;
          padding: 40px;
          color: #999;
      }

      .approval-section {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          margin-top: 15px;
      }

      .approval-item {
          background: white;
          padding: 10px;
          border-radius: 5px;
          margin-bottom: 10px;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      @media (max-width: 768px) {
          .sidebar {
              width: 200px;
          }

          .main-content {
              margin-left: 200px;
          }

          .stats-grid {
              grid-template-columns: 1fr;
          }

          .form-row {
              grid-template-columns: 1fr;
          }

          table {
              font-size: 12px;
          }

          table th, table td {
              padding: 8px;
          }
      }
  </style>
</head>
<body>
  <div class="admin-container">
      <!-- å´é‚Šæ¬„ -->
      <div class="sidebar">
          <h2>ğŸ”§ ç®¡ç†å“¡å¾Œå°</h2>
          <div class="menu-item active" onclick="showSection('dashboard')">ğŸ“Š å„€è¡¨æ¿</div>
          <div class="menu-item" onclick="showSection('users')">ğŸ‘¥ äººå“¡ç®¡ç†</div>
          <div class="menu-item" onclick="showSection('transactions')">ğŸ’° æ”¶æ”¯æ—¥è¨˜å¸³</div>
          <div class="menu-item" onclick="showSection('budgets')">ğŸ“‹ é ç®—ç·¨åˆ—</div>
          <div class="menu-item" onclick="showSection('expenses')">ğŸ’³ ç†äº‹é•·äº¤éš›è²»</div>
          <div class="menu-item" onclick="showSection('directors')">ğŸ‘” ç†ç›£äº‹ç®¡ç†</div>
      </div>

      <!-- ä¸»è¦å…§å®¹ -->
      <div class="main-content">
          <div class="header">
              <h1>ç®¡ç†å“¡å¾Œå°</h1>
              <button class="logout-btn" onclick="adminLogout()">ç™»å‡º</button>
          </div>

          <!-- å„€è¡¨æ¿ -->
          <div id="dashboard" class="content-section active">
              <div class="stats-grid">
                  <div class="stat-card">
                      <h4>ç¸½æœƒå“¡æ•¸</h4>
                      <div class="number" id="totalUsers">0</div>
                  </div>
                  <div class="stat-card">
                      <h4>å¾…å¯©æŸ¥äº¤æ˜“</h4>
                      <div class="number" id="pendingTransactions">0</div>
                  </div>
                  <div class="stat-card">
                      <h4>å¾…å¯©æŸ¥é ç®—</h4>
                      <div class="number" id="pendingBudgets">0</div>
                  </div>
                  <div class="stat-card">
                      <h4>å¾…å¯©æŸ¥äº¤éš›è²»</h4>
                      <div class="number" id="pendingExpenses">0</div>
                  </div>
              </div>

              <div class="card">
                  <h3>å¿«é€Ÿæ“ä½œ</h3>
                  <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                      <button class="btn btn-primary" onclick="showSection('transactions'); openAddTransactionModal()">æ–°å¢æ”¶æ”¯</button>
                      <button class="btn btn-primary" onclick="showSection('budgets'); openAddBudgetModal()">æ–°å¢é ç®—</button>
                      <button class="btn btn-primary" onclick="showSection('expenses'); openAddExpenseModal()">æ–°å¢äº¤éš›è²»</button>
                      <button class="btn btn-primary" onclick="showSection('directors'); openAddDirectorModal()">æ–°å¢ç†ç›£äº‹</button>
                  </div>
              </div>
          </div>

          <!-- äººå“¡ç®¡ç† -->
          <div id="users" class="content-section">
              <div class="card">
                  <h3>äººå“¡ç®¡ç†</h3>
                  <div class="filter-bar">
                      <input type="text" id="userSearch" placeholder="æœå°‹å§“åæˆ–é›»è©±" onkeyup="filterUsers()">
                      <select id="userTypeFilter" onchange="filterUsers()">
                          <option value="">å…¨éƒ¨é¡åˆ¥</option>
                          <option value="ä¸€èˆ¬ç¾¤çœ¾">ä¸€èˆ¬ç¾¤çœ¾</option>
                          <option value="ç—…å‹">ç—…å‹</option>
                          <option value="å®¶å±¬">å®¶å±¬</option>
                          <option value="é†«å¸«">é†«å¸«</option>
                      </select>
                  </div>
                  <div id="usersTableContainer">
                      <div class="loading">è¼‰å…¥ä¸­...</div>
                  </div>
              </div>
          </div>

          <!-- æ”¶æ”¯æ—¥è¨˜å¸³ -->
          <div id="transactions" class="content-section">
              <div class="card">
                  <h3>æ”¶æ”¯æ—¥è¨˜å¸³</h3>
                  <button class="btn btn-primary" onclick="openAddTransactionModal()" style="margin-bottom: 15px;">+ æ–°å¢æ”¶æ”¯</button>
                  
                  <div class="filter-bar">
                      <input type="date" id="transStartDate" onchange="filterTransactions()">
                      <input type="date" id="transEndDate" onchange="filterTransactions()">
                      <select id="transTypeFilter" onchange="filterTransactions()">
                          <option value="">å…¨éƒ¨é¡å‹</option>
                          <option value="æ”¶å…¥">æ”¶å…¥</option>
                          <option value="æ”¯å‡º">æ”¯å‡º</option>
                      </select>
                      <select id="transStatusFilter" onchange="filterTransactions()">
                          <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                          <option value="å¾…å¯©æŸ¥">å¾…å¯©æŸ¥</option>
                          <option value="å·²å…¥å¸³">å·²å…¥å¸³</option>
                          <option value="æ”¯å‡ºæ ¸å‡†">æ”¯å‡ºæ ¸å‡†</option>
                          <option value="å·²æ”¯å‡º">å·²æ”¯å‡º</option>
                      </select>
                  </div>

                  <div id="transactionsTableContainer">
                      <div class="loading">è¼‰å…¥ä¸­...</div>
                  </div>
              </div>
          </div>

          <!-- é ç®—ç·¨åˆ— -->
          <div id="budgets" class="content-section">
              <div class="card">
                  <h3>é ç®—ç·¨åˆ—</h3>
                  <button class="btn btn-primary" onclick="openAddBudgetModal()" style="margin-bottom: 15px;">+ æ–°å¢é ç®—é …ç›®</button>
                  
                  <div id="budgetsContainer">
                      <div class="loading">è¼‰å…¥ä¸­...</div>
                  </div>
              </div>
          </div>

          <!-- ç†äº‹é•·äº¤éš›è²» -->
          <div id="expenses" class="content-section">
              <div class="card">
                  <h3>ç†äº‹é•·äº¤éš›è²»</h3>
                  <button class="btn btn-primary" onclick="openAddExpenseModal()" style="margin-bottom: 15px;">+ æ–°å¢äº¤éš›è²»</button>
                  
                  <div id="expensesContainer">
                      <div class="loading">è¼‰å…¥ä¸­...</div>
                  </div>
              </div>
          </div>

          <!-- ç†ç›£äº‹ç®¡ç† -->
          <div id="directors" class="content-section">
              <div class="card">
                  <h3>ç†ç›£äº‹åå–®</h3>
                  <button class="btn btn-primary" onclick="openAddDirectorModal()" style="margin-bottom: 15px;">+ æ–°å¢ç†ç›£äº‹</button>
                  
                  <div id="directorsContainer">
                      <div class="loading">è¼‰å…¥ä¸­...</div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- æ–°å¢/ç·¨è¼¯æ”¶æ”¯ Modal -->
  <div id="transactionModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="transactionModalTitle">æ–°å¢æ”¶æ”¯</h3>
              <button class="close-btn" onclick="closeModal('transactionModal')">&times;</button>
          </div>
          <div id="transactionModalMessage"></div>
          <form id="transactionForm">
              <input type="hidden" id="transactionId">
              <div class="form-row">
                  <div class="form-group">
                      <label>æ—¥æœŸ <span style="color: red;">*</span></label>
                      <input type="date" id="transDate" required>
                  </div>
                  <div class="form-group">
                      <label>é¡å‹ <span style="color: red;">*</span></label>
                      <select id="transType" required>
                          <option value="">è«‹é¸æ“‡</option>
                          <option value="æ”¶å…¥">æ”¶å…¥</option>
                          <option value="æ”¯å‡º">æ”¯å‡º</option>
                      </select>
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>é¡åˆ¥ <span style="color: red;">*</span></label>
                      <input type="text" id="transCategory" placeholder="ä¾‹å¦‚ï¼šææ¬¾ã€æ´»å‹•è²»ç”¨" required>
                  </div>
                  <div class="form-group">
                      <label>åç¨± <span style="color: red;">*</span></label>
                      <input type="text" id="transName" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜ææ¬¾" required>
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>é‡‘é¡ <span style="color: red;">*</span></label>
                      <input type="number" id="transAmount" placeholder="0" min="0" required>
                  </div>
                  <div class="form-group">
                      <label>å¸³æˆ¶</label>
                      <input type="text" id="transAccount" placeholder="ä¾‹å¦‚ï¼šéƒµå±€å¸³æˆ¶">
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>è³‡ç”¢çµé¤˜</label>
                      <input type="number" id="transBalance" placeholder="0" min="0">
                  </div>
                  <div class="form-group">
                      <label>å–®æ“šåºè™Ÿ</label>
                      <input type="text" id="transReceiptNo" placeholder="ä¾‹å¦‚ï¼šR20250001">
                  </div>
              </div>
              <div class="form-group">
                  <label>å–®æ“šPDFæª”é€£çµ</label>
                  <input type="url" id="transReceiptPdf" placeholder="https://...">
              </div>
              <div class="form-group">
                  <label>ç‹€æ…‹</label>
                  <select id="transStatus">
                      <option value="å¾…å¯©æŸ¥">å¾…å¯©æŸ¥</option>
                      <option value="å·²å…¥å¸³">å·²å…¥å¸³</option>
                      <option value="æ”¯å‡ºæ ¸å‡†">æ”¯å‡ºæ ¸å‡†</option>
                      <option value="å·²æ”¯å‡º">å·²æ”¯å‡º</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>å‚™è¨»</label>
                  <textarea id="transNote" rows="3" placeholder="å…¶ä»–èªªæ˜"></textarea>
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">å„²å­˜</button>
          </form>
      </div>
  </div>

  <!-- æ–°å¢é ç®— Modal -->
  <div id="budgetModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>æ–°å¢é ç®—é …ç›®</h3>
              <button class="close-btn" onclick="closeModal('budgetModal')">&times;</button>
          </div>
          <div id="budgetModalMessage"></div>
          <form id="budgetForm">
              <div class="form-group">
                  <label>é …ç›®åç¨± <span style="color: red;">*</span></label>
                  <input type="text" id="budgetItemName" placeholder="ä¾‹å¦‚ï¼šå¹´åº¦æ´»å‹•ç¶“è²»" required>
              </div>
              <div class="form-group">
                  <label>é ç®—é‡‘é¡ <span style="color: red;">*</span></label>
                  <input type="number" id="budgetAmount" placeholder="0" min="0" required>
              </div>
              <div class="form-group">
                  <label>èªªæ˜</label>
                  <textarea id="budgetDescription" rows="3" placeholder="é ç®—ç”¨é€”èªªæ˜"></textarea>
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">æäº¤å¯©æŸ¥</button>
          </form>
      </div>
  </div>

  <!-- æ–°å¢äº¤éš›è²» Modal -->
  <div id="expenseModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>æ–°å¢ç†äº‹é•·äº¤éš›è²»</h3>
              <button class="close-btn" onclick="closeModal('expenseModal')">&times;</button>
          </div>
          <div id="expenseModalMessage"></div>
          <form id="expenseForm">
              <div class="form-row">
                  <div class="form-group">
                      <label>é‡‘é¡ <span style="color: red;">*</span></label>
                      <input type="number" id="expenseAmount" placeholder="0" min="0" required>
                  </div>
                  <div class="form-group">
                      <label>æ—¥æœŸ <span style="color: red;">*</span></label>
                      <input type="date" id="expenseDate" required>
                  </div>
              </div>
              <div class="form-group">
                  <label>ç”¨é€” <span style="color: red;">*</span></label>
                  <textarea id="expensePurpose" rows="3" placeholder="è«‹èªªæ˜äº¤éš›è²»ç”¨é€”" required></textarea>
              </div>
              <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 14px;">
                  ğŸ’¡ æç¤ºï¼šé‡‘é¡è¶…é 10,000 å…ƒéœ€ç¶“ç†ç›£äº‹éåŠæ•¸æ ¸å‡†
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">æäº¤</button>
          </form>
      </div>
  </div>

  <!-- æ–°å¢ç†ç›£äº‹ Modal -->
  <div id="directorModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>æ–°å¢ç†ç›£äº‹</h3>
              <button class="close-btn" onclick="closeModal('directorModal')">&times;</button>
          </div>
          <div id="directorModalMessage"></div>
          <form id="directorForm">
              <div class="form-group">
                  <label>é¸æ“‡æœƒå“¡ <span style="color: red;">*</span></label>
                  <select id="directorUserId" required>
                      <option value="">è«‹é¸æ“‡æœƒå“¡</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>è·ä½ <span style="color: red;">*</span></label>
                  <select id="directorRole" required>
                      <option value="">è«‹é¸æ“‡</option>
                      <option value="ç†äº‹é•·">ç†äº‹é•·</option>
                      <option value="ç†äº‹">ç†äº‹</option>
                      <option value="ç›£äº‹">ç›£äº‹</option>
                  </select>
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">æ–°å¢</button>
          </form>
      </div>
  </div>

  <!-- å¯©æ ¸ Modal -->
  <div id="approvalModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="approvalModalTitle">å¯©æ ¸</h3>
              <button class="close-btn" onclick="closeModal('approvalModal')">&times;</button>
          </div>
          <div id="approvalModalMessage"></div>
          <div id="approvalDetails"></div>
          <form id="approvalForm">
              <input type="hidden" id="approvalItemId">
              <input type="hidden" id="approvalType">
              <div class="form-group">
                  <label>æ±ºå®š <span style="color: red;">*</span></label>
                  <select id="approvalDecision" required>
                      <option value="">è«‹é¸æ“‡</option>
                      <option value="åŒæ„">åŒæ„</option>
                      <option value="ä¸åŒæ„">ä¸åŒæ„</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>æ„è¦‹</label>
                  <textarea id="approvalComment" rows="3" placeholder="è«‹è¼¸å…¥æ‚¨çš„æ„è¦‹ï¼ˆé¸å¡«ï¼‰"></textarea>
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">æäº¤å¯©æ ¸</button>
          </form>
      </div>
  </div>

  <!-- ç·¨è¼¯ç”¨æˆ¶ Modal -->
  <div id="editUserModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>ç·¨è¼¯ç”¨æˆ¶è³‡æ–™</h3>
              <button class="close-btn" onclick="closeModal('editUserModal')">&times;</button>
          </div>
          <div id="editUserModalMessage"></div>
          <form id="editUserForm">
              <input type="hidden" id="editUserId">
              <div class="form-group">
                  <label>å§“å <span style="color: red;">*</span></label>
                  <input type="text" id="editUserName" required>
              </div>
              <div class="form-group">
                  <label>é›»è©±</label>
                  <input type="tel" id="editUserPhone">
              </div>
              <div class="form-group">
                  <label>é¡åˆ¥</label>
                  <select id="editUserType">
                      <option value="ä¸€èˆ¬ç¾¤çœ¾">ä¸€èˆ¬ç¾¤çœ¾</option>
                      <option value="ç—…å‹">ç—…å‹</option>
                      <option value="å®¶å±¬">å®¶å±¬</option>
                      <option value="é†«å¸«">é†«å¸«</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>Email</label>
                  <input type="email" id="editUserEmail">
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">å„²å­˜</button>
          </form>
      </div>
  </div>

  <script>
      // ========== é…ç½® ==========
      const API_URL = 'https://script.google.com/macros/s/AKfycbxIHfuQwSYR0Tg3Y-Z1spe0yCwu8cJeomuWZoVP4-lZVn7qDCmCXrjiMFGjNUivAYmf8w/exec';
      let currentAdmin = JSON.parse(sessionStorage.getItem('currentUser'));
      let allUsers = [];
      let allTransactions = [];
      let allBudgets = [];
      let allExpenses = [];
      let allDirectors = [];

      // ========== åˆå§‹åŒ– ==========
      window.onload = async function() {
          if (!currentAdmin) {
              alert('è«‹å…ˆç™»å…¥');
              window.location.href = 'index.html';
              return;
          }

          // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
          const adminCheck = await callAPI('checkAdmin', { userId: currentAdmin.id });
          if (!adminCheck.success || !adminCheck.isAdmin) {
              alert('æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™');
              window.location.href = 'index.html';
              return;
          }

          loadDashboard();
      };

      // ========== API å‘¼å« ==========
      async function callAPI(action, data = {}) {
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: { 'Content-Type': 'text/plain' },
                  body: JSON.stringify({ action: action, data: data })
              });
              const text = await response.text();
              return JSON.parse(text);
          } catch (error) {
              console.error('API éŒ¯èª¤:', error);
              return { success: false, message: 'ç¶²è·¯é€£ç·šéŒ¯èª¤' };
          }
      }

      // ========== é é¢åˆ‡æ› ==========
      function showSection(sectionId) {
          document.querySelectorAll('.content-section').forEach(section => {
              section.classList.remove('active');
          });
          document.querySelectorAll('.menu-item').forEach(item => {
              item.classList.remove('active');
          });
          
          document.getElementById(sectionId).classList.add('active');
          event.target.classList.add('active');

          // è¼‰å…¥å°æ‡‰è³‡æ–™
          switch(sectionId) {
              case 'dashboard':
                  loadDashboard();
                  break;
              case 'users':
                  loadUsers();
                  break;
              case 'transactions':
                  loadTransactions();
                  break;
              case 'budgets':
                  loadBudgets();
                  break;
              case 'expenses':
                  loadExpenses();
                  break;
              case 'directors':
                  loadDirectors();
                  break;
          }
      }

      // ========== å„€è¡¨æ¿ ==========
      async function loadDashboard() {
          const usersResult = await callAPI('getAllUsers');
          const transResult = await callAPI('getTransactions', {});
          const budgetsResult = await callAPI('getBudgets');
          const expensesResult = await callAPI('getExpenses');

          if (usersResult.success) {
              document.getElementById('totalUsers').textContent = usersResult.users.length;
          }

          if (transResult.success) {
              const pending = transResult.transactions.filter(t => t.status === 'å¾…å¯©æŸ¥').length;
              document.getElementById('pendingTransactions').textContent = pending;
          }

          if (budgetsResult.success) {
              const pending = budgetsResult.budgets.filter(b => b.status === 'å¾…å¯©æŸ¥').length;
              document.getElementById('pendingBudgets').textContent = pending;
          }

          if (expensesResult.success) {
              const pending = expensesResult.expenses.filter(e => e.status === 'å¾…å¯©æŸ¥').length;
              document.getElementById('pendingExpenses').textContent = pending;
          }
      }

      // ========== äººå“¡ç®¡ç† ==========
      async function loadUsers() {
          const container = document.getElementById('usersTableContainer');
          container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';

          const result = await callAPI('getAllUsers');

          if (result.success) {
              allUsers = result.users;
              renderUsersTable(allUsers);
          } else {
              container.innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
          }
      }

      function renderUsersTable(users) {
          const container = document.getElementById('usersTableContainer');

          if (users.length === 0) {
              container.innerHTML = '<div class="empty-state">æ²’æœ‰ç”¨æˆ¶è³‡æ–™</div>';
              return;
          }

          let html = `
              <table>
                  <thead>
                      <tr>
                          <th>å§“å</th>
                          <th>é›»è©±</th>
                          <th>é¡åˆ¥</th>
                          <th>Email</th>
                          <th>è¨»å†Šæ—¥æœŸ</th>
                          <th>æ“ä½œ</th>
                      </tr>
                  </thead>
                  <tbody>
          `;

          users.forEach(user => {
              html += `
                  <tr>
                      <td>${user.name}</td>
                      <td>${user.phone || '-'}</td>
                      <td>${user.type}</td>
                      <td>${user.email || '-'}</td>
                      <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                      <td class="action-btns">
                          <button class="btn btn-primary" onclick='editUser(${JSON.stringify(user)})'>ç·¨è¼¯</button>
                          <button class="btn btn-danger" onclick="deleteUserConfirm('${user.id}', '${user.name}')">åˆªé™¤</button>
                      </td>
                  </tr>
              `;
          });

          html += '</tbody></table>';
          container.innerHTML = html;
      }

      function filterUsers() {
          const search = document.getElementById('userSearch').value.toLowerCase();
          const typeFilter = document.getElementById('userTypeFilter').value;

          let filtered = allUsers.filter(user => {
              const matchSearch = user.name.toLowerCase().includes(search) || 
                                (user.phone && user.phone.includes(search));
              const matchType = !typeFilter || user.type === typeFilter;
              return matchSearch && matchType;
          });

          renderUsersTable(filtered);
      }

      function editUser(user) {
          document.getElementById('editUserId').value = user.id;
          document.getElementById('editUserName').value = user.name;
          document.getElementById('editUserPhone').value = user.phone || '';
          document.getElementById('editUserType').value = user.type;
          document.getElementById('editUserEmail').value = user.email || '';
          openModal('editUserModal');
      }

      document.getElementById('editUserForm').addEventListener('submit', async function(e) {
          e.preventDefault();

          const data = {
              userId: document.getElementById('editUserId').value,
              name: document.getElementById('editUserName').value,
              phone: document.getElementById('editUserPhone').value,
              type: document.getElementById('editUserType').value,
              email: document.getElementById('editUserEmail').value
          };

          const result = await callAPI('updateUserAdmin', data);

          if (result.success) {
              showModalMessage('editUserModal', result.message, 'success');
              setTimeout(() => {
                  closeModal('editUserModal');
                  loadUsers();
              }, 1500);
          } else {
              showModalMessage('editUserModal', result.message, 'error');
          }
      });

      async function deleteUserConfirm(userId, userName) {
          if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç”¨æˆ¶ã€Œ${userName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
              return;
          }

          const result = await callAPI('deleteUser', { userId: userId });

          if (result.success) {
              alert(result.message);
              loadUsers();
          } else {
              alert(result.message);
          }
      }

      // ========== æ”¶æ”¯æ—¥è¨˜å¸³ ==========
      async function loadTransactions() {
          const container = document.getElementById('transactionsTableContainer');
          container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';

          const result = await callAPI('getTransactions', {});

          if (result.success) {
              allTransactions = result.transactions;
              renderTransactionsTable(allTransactions);
          } else {
              container.innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
          }
      }

      function renderTransactionsTable(transactions) {
          const container = document.getElementById('transactionsTableContainer');

          if (transactions.length === 0) {
              container.innerHTML = '<div class="empty-state">æ²’æœ‰äº¤æ˜“è¨˜éŒ„</div>';
              return;
          }

          let html = `
              <table>
                  <thead>
                      <tr>
                          <th>æ—¥æœŸ</th>
                          <th>é¡å‹</th>
                          <th>é¡åˆ¥</th>
                          <th>åç¨±</th>
                          <th>é‡‘é¡</th>
                          <th>ç‹€æ…‹</th>
                          <th>å–®æ“š</th>
                          <th>æ“ä½œ</th>
                      </tr>
                  </thead>
                  <tbody>
          `;

          transactions.forEach(trans => {
              const statusClass = trans.status === 'å¾…å¯©æŸ¥' ? 'status-pending' : 
                                trans.status === 'å·²å…¥å¸³' || trans.status === 'æ”¯å‡ºæ ¸å‡†' ? 'status-approved' : 
                                'status-completed';
              
              html += `
                  <tr>
                      <td>${trans.date}</td>
                      <td><strong>${trans.type === 'æ”¶å…¥' ? 'ğŸ’°' : 'ğŸ’¸'} ${trans.type}</strong></td>
                      <td>${trans.category}</td>
                      <td>${trans.name}</td>
                      <td style="text-align: right; font-weight: 600;">NT$ ${Number(trans.amount).toLocaleString()}</td>
                      <td><span class="status-badge ${statusClass}">${trans.status}</span></td>
                      <td>${trans.receiptPdf ? `<a href="${trans.receiptPdf}" target="_blank">æŸ¥çœ‹</a>` : '-'}</td>
                      <td class="action-btns">
                          <button class="btn btn-primary" onclick='editTransaction(${JSON.stringify(trans)})'>ç·¨è¼¯</button>
                          <button class="btn btn-danger" onclick="deleteTransactionConfirm('${trans.id}')">åˆªé™¤</button>
                      </td>
                  </tr>
              `;
          });

          html += '</tbody></table>';
          container.innerHTML = html;
      }

      function filterTransactions() {
          const startDate = document.getElementById('transStartDate').value;
          const endDate = document.getElementById('transEndDate').value;
          const typeFilter = document.getElementById('transTypeFilter').value;
          const statusFilter = document.getElementById('transStatusFilter').value;

          let filtered = allTransactions.filter(trans => {
              const matchDate = (!startDate || trans.date >= startDate) && 
                              (!endDate || trans.date <= endDate);
              const matchType = !typeFilter || trans.type === typeFilter;
              const matchStatus = !statusFilter || trans.status === statusFilter;
              return matchDate && matchType && matchStatus;
          });

          renderTransactionsTable(filtered);
      }

      function openAddTransactionModal() {
          document.getElementById('transactionForm').reset();
          document.getElementById('transactionId').value = '';
          document.getElementById('transactionModalTitle').textContent = 'æ–°å¢æ”¶æ”¯';
          document.getElementById('transDate').value = new Date().toISOString().split('T')[0];
          openModal('transactionModal');
      }

      function editTransaction(trans) {
          document.getElementById('transactionId').value = trans.id;
          document.getElementById('transDate').value = trans.date;
          document.getElementById('transType').value = trans.type;
          document.getElementById('transCategory').value = trans.category;
          document.getElementById('transName').value = trans.name;
          document.getElementById('transAmount').value = trans.amount;
          document.getElementById('transAccount').value = trans.account || '';
          document.getElementById('transBalance').value = trans.balance || '';
          document.getElementById('transReceiptNo').value = trans.receiptNo || '';
          document.getElementById('transReceiptPdf').value = trans.receiptPdf || '';
          document.getElementById('transStatus').value = trans.status;
          document.getElementById('transNote').value = trans.note || '';
          document.getElementById('transactionModalTitle').textContent = 'ç·¨è¼¯æ”¶æ”¯';
          openModal('transactionModal');
      }

      document.getElementById('transactionForm').addEventListener('submit', async function(e) {
          e.preventDefault();

          const transId = document.getElementById('transactionId').value;
          const data = {
              date: document.getElementById('transDate').value,
              type: document.getElementById('transType').value,
              category: document.getElementById('transCategory').value,
              name: document.getElementById('transName').value,
              amount: document.getElementById('transAmount').value,
              account: document.getElementById('transAccount').value,
              balance: document.getElementById('transBalance').value,
              receiptNo: document.getElementById('transReceiptNo').value,
              receiptPdf: document.getElementById('transReceiptPdf').value,
              status: document.getElementById('transStatus').value,
              note: document.getElementById('transNote').value,
              createdBy: currentAdmin.name
          };

          let result;
          if (transId) {
              data.id = transId;
              result = await callAPI('updateTransaction', data);
          } else {
              result = await callAPI('addTransaction', data);
          }

          if (result.success) {
              showModalMessage('transactionModal', result.message, 'success');
              setTimeout(() => {
                  closeModal('transactionModal');
                  loadTransactions();
                  loadDashboard();
              }, 1500);
          } else {
              showModalMessage('transactionModal', result.message, 'error');
          }
      });

      async function deleteTransactionConfirm(transId) {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤äº¤æ˜“è¨˜éŒ„å—ï¼Ÿ')) {
              return;
          }

          const result = await callAPI('deleteTransaction', { id: transId });

          if (result.success) {
              alert(result.message);
              loadTransactions();
          } else {
              alert(result.message);
          }
      }

      // ========== é ç®—ç®¡ç† ==========
      async function loadBudgets() {
          const container = document.getElementById('budgetsContainer');
          container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';

          const result = await callAPI('getBudgets');

          if (result.success) {
              allBudgets = result.budgets;
              renderBudgets(allBudgets);
          } else {
              container.innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
          }
      }

      function renderBudgets(budgets) {
          const container = document.getElementById('budgetsContainer');

          if (budgets.length === 0) {
              container.innerHTML = '<div class="empty-state">æ²’æœ‰é ç®—é …ç›®</div>';
              return;
          }

          let html = '';

          budgets.forEach(budget => {
              const statusClass = budget.status === 'å¾…å¯©æŸ¥' ? 'status-pending' : 
                                budget.status === 'å·²æ ¸å‡†' ? 'status-approved' : 
                                'status-rejected';
              
              html += `
                  <div class="card" style="margin-bottom: 15px;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                          <div>
                              <h4 style="font-size: 18px; color: #333; margin-bottom: 5px;">${budget.itemName}</h4>
                              <p style="color: #666; font-size: 14px;">${budget.description || 'ç„¡èªªæ˜'}</p>
                          </div>
                          <span class="status-badge ${statusClass}">${budget.status}</span>
                      </div>
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                          <div>
                              <div style="font-size: 24px; font-weight: 700; color: #667eea;">NT$ ${Number(budget.amount).toLocaleString()}</div>
                              <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                  ææ¡ˆäººï¼š${budget.createdBy} | ${new Date(budget.createdAt).toLocaleDateString()}
                              </div>
                              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                  âœ… åŒæ„ï¼š${budget.approvedCount} | âŒ ä¸åŒæ„ï¼š${budget.rejectedCount}
                              </div>
                          </div>
                          ${budget.status === 'å¾…å¯©æŸ¥' ? `
                              <button class="btn btn-warning" onclick='openApprovalModal("${budget.id}", "budget", ${JSON.stringify(budget)})'>å¯©æ ¸</button>
                          ` : ''}
                      </div>
                  </div>
              `;
          });

          container.innerHTML = html;
      }

      function openAddBudgetModal() {
          document.getElementById('budgetForm').reset();
          openModal('budgetModal');
      }

      document.getElementById('budgetForm').addEventListener('submit', async function(e) {
          e.preventDefault();

          const data = {
              itemName: document.getElementById('budgetItemName').value,
              amount: document.getElementById('budgetAmount').value,
              description: document.getElementById('budgetDescription').value,
              createdBy: currentAdmin.name
          };

          const result = await callAPI('addBudget', data);

          if (result.success) {
              showModalMessage('budgetModal', result.message, 'success');
              setTimeout(() => {
                  closeModal('budgetModal');
                  loadBudgets();
                  loadDashboard();
              }, 1500);
          } else {
              showModalMessage('budgetModal', result.message, 'error');
          }
      });

      // ========== äº¤éš›è²»ç®¡ç† ==========
      async function loadExpenses() {
          const container = document.getElementById('expensesContainer');
          container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';

          const result = await callAPI('getExpenses');

          if (result.success) {
              allExpenses = result.expenses;
              renderExpenses(allExpenses);
          } else {
              container.innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
          }
      }

      function renderExpenses(expenses) {
          const container = document.getElementById('expensesContainer');

          if (expenses.length === 0) {
              container.innerHTML = '<div class="empty-state">æ²’æœ‰äº¤éš›è²»è¨˜éŒ„</div>';
              return;
          }

          let html = '';

          expenses.forEach(expense => {
              const statusClass = expense.status === 'å¾…å¯©æŸ¥' ? 'status-pending' : 
                                expense.status === 'å·²æ ¸å‡†' ? 'status-approved' : 
                                'status-rejected';
              
              html += `
                  <div class="card" style="margin-bottom: 15px;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                          <div style="flex: 1;">
                              <div style="font-size: 24px; font-weight: 700; color: #667eea; margin-bottom: 10px;">
                                  NT$ ${Number(expense.amount).toLocaleString()}
                              </div>
                              <p style="color: #666; font-size: 14px; margin-bottom: 5px;"><strong>ç”¨é€”ï¼š</strong>${expense.purpose}</p>
                              <p style="color: #999; font-size: 12px;">æ—¥æœŸï¼š${expense.date}</p>
                          </div>
                          <span class="status-badge ${statusClass}">${expense.status}</span>
                      </div>
                      <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                          <div style="font-size: 12px; color: #666;">
                              ç”³è«‹äººï¼š${expense.createdBy} | ${new Date(expense.createdAt).toLocaleDateString()}
                              <br>âœ… åŒæ„ï¼š${expense.approvedCount} | âŒ ä¸åŒæ„ï¼š${expense.rejectedCount}
                          </div>
                          ${expense.status === 'å¾…å¯©æŸ¥' ? `
                              <button class="btn btn-warning" onclick='openApprovalModal("${expense.id}", "expense", ${JSON.stringify(expense)})'>å¯©æ ¸</button>
                          ` : ''}
                      </div>
                  </div>
              `;
          });

          container.innerHTML = html;
      }

      function openAddExpenseModal() {
          document.getElementById('expenseForm').reset();
          document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
          openModal('expenseModal');
      }

      document.getElementById('expenseForm').addEventListener('submit', async function(e) {
          e.preventDefault();

          const data = {
              amount: document.getElementById('expenseAmount').value,
              date: document.getElementById('expenseDate').value,
              purpose: document.getElementById('expensePurpose').value,
              createdBy: currentAdmin.name
          };

          const result = await callAPI('addExpense', data);

          if (result.success) {
              showModalMessage('expenseModal', result.message, 'success');
              setTimeout(() => {
                  closeModal('expenseModal');
                  loadExpenses();
                  loadDashboard();
              }, 1500);
          } else {
              showModalMessage('expenseModal', result.message, 'error');
          }
      });

      // ========== ç†ç›£äº‹ç®¡ç† ==========
      async function loadDirectors() {
          const container = document.getElementById('directorsContainer');
          container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';

          const result = await callAPI('getDirectors');

          if (result.success) {
              allDirectors = result.directors;
              renderDirectors(allDirectors);
          } else {
              container.innerHTML = '<div class="empty-state">è¼‰å…¥å¤±æ•—</div>';
          }
      }

      function renderDirectors(directors) {
          const container = document.getElementById('directorsContainer');

          if (directors.length === 0) {
              container.innerHTML = '<div class="empty-state">æ²’æœ‰ç†ç›£äº‹</div>';
              return;
          }

          let html = '<table><thead><tr><th>å§“å</th><th>è·ä½</th><th>åŠ å…¥æ—¥æœŸ</th><th>æ“ä½œ</th></tr></thead><tbody>';

          directors.forEach(director => {
              html += `
                  <tr>
                      <td>${director.userName}</td>
                      <td><strong>${director.role}</strong></td>
                      <td>${new Date(director.createdAt).toLocaleDateString()}</td>
                      <td class="action-btns">
                          <button class="btn btn-danger" onclick="removeDirectorConfirm('${director.id}', '${director.userName}')">ç§»é™¤</button>
                      </td>
                  </tr>
              `;
          });

          html += '</tbody></table>';
          container.innerHTML = html;
      }

      async function openAddDirectorModal() {
          // è¼‰å…¥æ‰€æœ‰ç”¨æˆ¶
          const result = await callAPI('getAllUsers');
          
          if (result.success) {
              const select = document.getElementById('directorUserId');
              select.innerHTML = '<option value="">è«‹é¸æ“‡æœƒå“¡</option>';
              
              result.users.forEach(user => {
                  select.innerHTML += `<option value="${user.id}" data-name="${user.name}">${user.name} (${user.phone || user.lineId})</option>`;
              });
          }

          document.getElementById('directorForm').reset();
          openModal('directorModal');
      }

      document.getElementById('directorForm').addEventListener('submit', async function(e) {
          e.preventDefault();

          const select = document.getElementById('directorUserId');
          const selectedOption = select.options[select.selectedIndex];

          const data = {
              userId: select.value,
              userName: selectedOption.getAttribute('data-name'),
              role: document.getElementById('directorRole').value
          };

          const result = await callAPI('addDirector', data);

          if (result.success) {
              showModalMessage('directorModal', result.message, 'success');
              setTimeout(() => {
                  closeModal('directorModal');
                  loadDirectors();
              }, 1500);
          } else {
              showModalMessage('directorModal', result.message, 'error');
          }
      });

      async function removeDirectorConfirm(directorId, directorName) {
          if (!confirm(`ç¢ºå®šè¦ç§»é™¤ç†ç›£äº‹ã€Œ${directorName}ã€å—ï¼Ÿ`)) {
              return;
          }

          const result = await callAPI('removeDirector', { id: directorId });

          if (result.success) {
              alert(result.message);
              loadDirectors();
          } else {
              alert(result.message);
          }
      }

      // ========== å¯©æ ¸åŠŸèƒ½ ==========
      function openApprovalModal(itemId, type, item) {
          document.getElementById('approvalItemId').value = itemId;
          document.getElementById('approvalType').value = type;
          document.getElementById('approvalForm').reset();

          let title = '';
          let details = '';

          if (type === 'budget') {
              title = 'é ç®—å¯©æ ¸';
              details = `
                  <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                      <p style="margin: 5px 0;"><strong>é …ç›®åç¨±ï¼š</strong>${item.itemName}</p>
                      <p style="margin: 5px 0;"><strong>é ç®—é‡‘é¡ï¼š</strong>NT$ ${Number(item.amount).toLocaleString()}</p>
                      <p style="margin: 5px 0;"><strong>èªªæ˜ï¼š</strong>${item.description || 'ç„¡'}</p>
                      <p style="margin: 5px 0;"><strong>ææ¡ˆäººï¼š</strong>${item.createdBy}</p>
                      <p style="margin: 5px 0; font-size: 12px; color: #666;">
                          ç›®å‰ï¼šâœ… ${item.approvedCount} | âŒ ${item.rejectedCount}
                      </p>
                  </div>
              `;
          } else if (type === 'expense') {
              title = 'äº¤éš›è²»å¯©æ ¸';
              details = `
                  <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                      <p style="margin: 5px 0;"><strong>é‡‘é¡ï¼š</strong>NT$ ${Number(item.amount).toLocaleString()}</p>
                      <p style="margin: 5px 0;"><strong>ç”¨é€”ï¼š</strong>${item.purpose}</p>
                      <p style="margin: 5px 0;"><strong>æ—¥æœŸï¼š</strong>${item.date}</p>
                      <p style="margin: 5px 0;"><strong>ç”³è«‹äººï¼š</strong>${item.createdBy}</p>
                      <p style="margin: 5px 0; font-size: 12px; color: #666;">
                          ç›®å‰ï¼šâœ… ${item.approvedCount} | âŒ ${item.rejectedCount}
                      </p>
                  </div>
              `;
          }

          document.getElementById('approvalModalTitle').textContent = title;
          document.getElementById('approvalDetails').innerHTML = details;
          openModal('approvalModal');
      }

      document.getElementById('approvalForm').addEventListener('submit', async function(e) {
          e.preventDefault();

          const itemId = document.getElementById('approvalItemId').value;
          const type = document.getElementById('approvalType').value;
          const decision = document.getElementById('approvalDecision').value;
          const comment = document.getElementById('approvalComment').value;

          const data = {
              userId: currentAdmin.id,
              userName: currentAdmin.name,
              decision: decision,
              comment: comment
          };

          let result;
          if (type === 'budget') {
              data.budgetId = itemId;
              result = await callAPI('approveBudget', data);
          } else if (type === 'expense') {
              data.expenseId = itemId;
              result = await callAPI('approveExpense', data);
          }

          if (result.success) {
              showModalMessage('approvalModal', result.message, 'success');
              setTimeout(() => {
                  closeModal('approvalModal');
                  if (type === 'budget') {
                      loadBudgets();
                  } else if (type === 'expense') {
                      loadExpenses();
                  }
                  loadDashboard();
              }, 1500);
          } else {
              showModalMessage('approvalModal', result.message, 'error');
          }
      });

      // ========== Modal æ§åˆ¶ ==========
      function openModal(modalId) {
          document.getElementById(modalId).classList.add('active');
      }

      function closeModal(modalId) {
          document.getElementById(modalId).classList.remove('active');
      }

      function showModalMessage(modalId, message, type) {
          const messageDiv = document.getElementById(modalId.replace('Modal', 'ModalMessage'));
          messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
          setTimeout(() => {
              messageDiv.innerHTML = '';
          }, 3000);
      }

      // ========== ç™»å‡º ==========
      function adminLogout() {
          if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
              sessionStorage.removeItem('currentUser');
              window.location.href = 'index.html';
          }
      }

      // é»æ“Š Modal å¤–éƒ¨é—œé–‰
      document.querySelectorAll('.modal').forEach(modal => {
          modal.addEventListener('click', function(e) {
              if (e.target === this) {
                  this.classList.remove('active');
              }
          });
      });
  </script>
</body>
</html>
