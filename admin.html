<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理員後台 - 台灣帕金森之友協會</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #f5f7fa;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar h2 {
            margin-bottom: 30px;
            font-size: 20px;
            text-align: center;
        }

        .menu-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.2);
        }

        .menu-item.active {
            background: rgba(255,255,255,0.3);
        }

        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 30px;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            color: #333;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h4 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .action-btns {
            display: flex;
            gap: 5px;
        }

        .action-btns button {
            padding: 5px 10px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar input, .filter-bar select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .budget-item, .expense-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .item-amount {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .item-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .vote-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .vote-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .vote-count {
            font-size: 14px;
            color: #666;
        }

        .vote-count.approve {
            color: #27ae60;
        }

        .vote-count.reject {
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }

            .main-content {
                margin-left: 200px;
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            table th, table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- 側邊欄 -->
        <div class="sidebar">
            <h2>🔧 管理員後台</h2>
            <div class="menu-item active" onclick="showSection('dashboard')">📊 儀表板</div>
            <div class="menu-item" onclick="showSection('users')">👥 人員管理</div>
            <div class="menu-item" onclick="showSection('transactions')">💰 收支日記帳</div>
            <div class="menu-item" onclick="showSection('budgets')">📋 預算編列</div>
            <div class="menu-item" onclick="showSection('expenses')">💳 理事長交際費</div>
            <div class="menu-item" onclick="showSection('directors')">👔 理監事管理</div>
            <div class="menu-item" onclick="showSection('reports')">📊 財務報表</div>
        </div>

        <!-- 主要內容 -->
        <div class="main-content">
            <div class="header">
                <h1>管理員後台</h1>
                <div>
                    <span id="adminName" style="margin-right: 15px; color: #667eea; font-weight: 600;"></span>
                    <button class="logout-btn" onclick="adminLogout()">登出</button>
                </div>
            </div>

            <!-- 儀表板 -->
            <div id="dashboard" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>總會員數</h4>
                        <div class="number" id="totalUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>待審查交易</h4>
                        <div class="number" id="pendingTransactions">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>待審查預算</h4>
                        <div class="number" id="pendingBudgets">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>待審查交際費</h4>
                        <div class="number" id="pendingExpenses">0</div>
                    </div>
                </div>

                <div class="card">
                    <h3>快速操作</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="showSection('transactions'); openAddTransactionModal()">新增收支</button>
                        <button class="btn btn-primary" onclick="showSection('budgets'); openAddBudgetModal()">新增預算</button>
                        <button class="btn btn-primary" onclick="showSection('expenses'); openAddExpenseModal()">新增交際費</button>
                        <button class="btn btn-primary" onclick="showSection('directors'); openAddDirectorModal()">新增理監事</button>
                    </div>
                </div>
            </div>

            <!-- 人員管理 -->
            <div id="users" class="content-section">
                <div class="card">
                    <h3>👥 人員管理</h3>
                    <div class="filter-bar">
                        <input type="text" id="userSearch" placeholder="搜尋姓名或電話" onkeyup="filterUsers()">
                        <select id="userTypeFilter" onchange="filterUsers()">
                            <option value="">全部類別</option>
                            <option value="一般群眾">一般群眾</option>
                            <option value="病友">病友</option>
                            <option value="家屬">家屬</option>
                            <option value="醫師">醫師</option>
                        </select>
                    </div>
                    <div id="usersTableContainer">
                        <div class="loading">載入中...</div>
                    </div>
                </div>
            </div>

            <!-- 收支日記帳 -->
            <div id="transactions" class="content-section">
                <div class="card">
                    <h3>💰 收支日記帳</h3>
                    <button class="btn btn-primary" onclick="openAddTransactionModal()" style="margin-bottom: 15px;">+ 新增收支</button>
                    
                    <div class="filter-bar">
                        <input type="date" id="transStartDate" onchange="filterTransactions()">
                        <input type="date" id="transEndDate" onchange="filterTransactions()">
                        <select id="transTypeFilter" onchange="filterTransactions()">
                            <option value="">全部類型</option>
                            <option value="收入">收入</option>
                            <option value="支出">支出</option>
                        </select>
                        <select id="transStatusFilter" onchange="filterTransactions()">
                            <option value="">全部狀態</option>
                            <option value="待審查">待審查</option>
                            <option value="已入帳">已入帳</option>
                            <option value="支出核准">支出核准</option>
                            <option value="已支出">已支出</option>
                        </select>
                    </div>

                    <div id="transactionsTableContainer">
                        <div class="loading">載入中...</div>
                    </div>
                </div>
            </div>

            <!-- 預算編列 -->
            <div id="budgets" class="content-section">
                <div class="card">
                    <h3>📋 預算編列</h3>
                    <button class="btn btn-primary" onclick="openAddBudgetModal()" style="margin-bottom: 15px;">+ 新增預算項目</button>
                    
                    <div id="budgetsContainer">
                        <div class="loading">載入中...</div>
                    </div>
                </div>
            </div>

            <!-- 理事長交際費 -->
            <div id="expenses" class="content-section">
                <div class="card">
                    <h3>💳 理事長交際費</h3>
                    <button class="btn btn-primary" onclick="openAddExpenseModal()" style="margin-bottom: 15px;">+ 新增交際費</button>
                    
                    <div id="expensesContainer">
                        <div class="loading">載入中...</div>
                    </div>
                </div>
            </div>

            <!-- 理監事管理 -->
            <div id="directors" class="content-section">
                <div class="card">
                    <h3>👔 理監事名單</h3>
                    <button class="btn btn-primary" onclick="openAddDirectorModal()" style="margin-bottom: 15px;">+ 新增理監事</button>
                    
                    <div id="directorsContainer">
                        <div class="loading">載入中...</div>
                    </div>
                </div>
            </div>

            <!-- 財務報表 -->
            <div id="reports" class="content-section">
                <div class="card">
                    <h3>📊 財務報表</h3>
                    
                    <div class="filter-bar">
                        <label style="padding: 8px;">起始日期：</label>
                        <input type="date" id="reportStartDate">
                        <label style="padding: 8px;">結束日期：</label>
                        <input type="date" id="reportEndDate">
                        <button class="btn btn-primary" onclick="loadFinancialReport()">產生報表</button>
                        <button class="btn btn-success" onclick="exportReport()">匯出 Excel</button>
                    </div>

                    <div id="reportSummary" style="margin-top: 20px;"></div>
                    <div id="reportDetails" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: 編輯用戶 -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>編輯用戶資料</h3>
                <button class="close-btn" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <form id="editUserForm" onsubmit="event.preventDefault(); updateUser();">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>姓名</label>
                    <input type="text" id="editUserName" required>
                </div>
                <div class="form-group">
                    <label>電話</label>
                    <input type="tel" id="editUserPhone" required>
                </div>
                <div class="form-group">
                    <label>身份類別</label>
                    <select id="editUserType">
                        <option value="一般群眾">一般群眾</option>
                        <option value="病友">病友</option>
                        <option value="家屬">家屬</option>
                        <option value="醫師">醫師</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="editUserEmail">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">儲存</button>
            </form>
        </div>
    </div>

    <!-- Modal: 新增收支 -->
    <div id="addTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新增收支記錄</h3>
                <button class="close-btn" onclick="closeModal('addTransactionModal')">&times;</button>
            </div>
            <form id="addTransactionForm" onsubmit="event.preventDefault(); addTransaction();">
                <div class="form-group">
                    <label>日期 <span style="color: red;">*</span></label>
                    <input type="date" id="transDate" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>類型 <span style="color: red;">*</span></label>
                        <select id="transType" required>
                            <option value="收入">收入</option>
                            <option value="支出">支出</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>類別 <span style="color: red;">*</span></label>
                        <select id="transCategory" required>
                            <option value="會費">會費</option>
                            <option value="捐款">捐款</option>
                            <option value="補助">補助</option>
                            <option value="活動費用">活動費用</option>
                            <option value="行政費用">行政費用</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>項目名稱 <span style="color: red;">*</span></label>
                    <input type="text" id="transName" placeholder="例如：會員年費" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>金額 <span style="color: red;">*</span></label>
                        <input type="number" id="transAmount" min="1" placeholder="請輸入金額" required>
                    </div>
                    <div class="form-group">
                        <label>帳戶</label>
                        <input type="text" id="transAccount" placeholder="例如：現金、銀行">
                    </div>
                </div>
                <div class="form-group">
                    <label>備註</label>
                    <textarea id="transNote" rows="3" placeholder="其他說明"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">新增</button>
            </form>
        </div>
    </div>

    <!-- Modal: 編輯收支 -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>編輯收支記錄</h3>
                <button class="close-btn" onclick="closeModal('editTransactionModal')">&times;</button>
            </div>
            <form id="editTransactionForm" onsubmit="event.preventDefault(); updateTransaction();">
                <input type="hidden" id="editTransId">
                <div class="form-group">
                    <label>日期</label>
                    <input type="date" id="editTransDate" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>類型</label>
                        <select id="editTransType" required>
                            <option value="收入">收入</option>
                            <option value="支出">支出</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>類別</label>
                        <select id="editTransCategory" required>
                            <option value="會費">會費</option>
                            <option value="捐款">捐款</option>
                            <option value="補助">補助</option>
                            <option value="活動費用">活動費用</option>
                            <option value="行政費用">行政費用</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>項目名稱</label>
                    <input type="text" id="editTransName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>金額</label>
                        <input type="number" id="editTransAmount" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>帳戶</label>
                        <input type="text" id="editTransAccount">
                    </div>
                </div>
                <div class="form-group">
                    <label>狀態</label>
                    <select id="editTransStatus">
                        <option value="待審查">待審查</option>
                        <option value="已入帳">已入帳</option>
                        <option value="支出核准">支出核准</option>
                        <option value="已支出">已支出</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>備註</label>
                    <textarea id="editTransNote" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">更新</button>
            </form>
        </div>
    </div>

    <!-- Modal: 新增預算 -->
    <div id="addBudgetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新增預算項目</h3>
                <button class="close-btn" onclick="closeModal('addBudgetModal')">&times;</button>
            </div>
            <form id="addBudgetForm" onsubmit="event.preventDefault(); addBudget();">
                <div class="form-group">
                    <label>項目名稱 <span style="color: red;">*</span></label>
                    <input type="text" id="budgetItemName" placeholder="例如：年度活動經費" required>
                </div>
                <div class="form-group">
                    <label>預算金額 <span style="color: red;">*</span></label>
                    <input type="number" id="budgetAmount" min="1" placeholder="請輸入金額" required>
                </div>
                <div class="form-group">
                    <label>說明</label>
                    <textarea id="budgetDescription" rows="4" placeholder="請描述預算用途"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">提交審查</button>
            </form>
        </div>
    </div>

    <!-- Modal: 新增交際費 -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新增理事長交際費</h3>
                <button class="close-btn" onclick="closeModal('addExpenseModal')">&times;</button>
            </div>
            <form id="addExpenseForm" onsubmit="event.preventDefault(); addExpense();">
                <div class="form-group">
                    <label>日期 <span style="color: red;">*</span></label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div class="form-group">
                    <label>金額 <span style="color: red;">*</span></label>
                    <input type="number" id="expenseAmount" min="1" placeholder="請輸入金額" required>
                </div>
                <div class="form-group">
                    <label>用途說明 <span style="color: red;">*</span></label>
                    <textarea id="expensePurpose" rows="4" placeholder="請詳細說明交際費用途" required></textarea>
                </div>
                <div style="padding: 10px; background: #fff3cd; border-radius: 8px; margin-bottom: 15px;">
                    <p style="color: #856404; font-size: 13px; margin: 0;">
                        💡 提示：單筆金額 ≥ NT$10,000 需經理監事過半數同意
                    </p>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">提交</button>
            </form>
        </div>
    </div>

    <!-- Modal: 新增理監事 -->
    <div id="addDirectorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新增理監事</h3>
                <button class="close-btn" onclick="closeModal('addDirectorModal')">&times;</button>
            </div>
            <form id="addDirectorForm" onsubmit="event.preventDefault(); addDirector();">
                <div class="form-group">
                    <label>選擇用戶 <span style="color: red;">*</span></label>
                    <select id="directorUserId" required>
                        <option value="">請選擇...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>職位 <span style="color: red;">*</span></label>
                    <select id="directorRole" required>
                        <option value="理事">理事</option>
                        <option value="常務理事">常務理事</option>
                        <option value="理事長">理事長</option>
                        <option value="監事">監事</option>
                        <option value="常務監事">常務監事</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">新增</button>
            </form>
        </div>
    </div>

    <!-- Modal: 預算投票 -->
    <div id="budgetVoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>預算審查投票</h3>
                <button class="close-btn" onclick="closeModal('budgetVoteModal')">&times;</button>
            </div>
            <div id="budgetVoteContent"></div>
            <form id="budgetVoteForm" onsubmit="event.preventDefault(); submitBudgetVote();">
                <input type="hidden" id="voteBudgetId">
                <div class="form-group">
                    <label>您的決定 <span style="color: red;">*</span></label>
                    <select id="budgetDecision" required>
                        <option value="">請選擇...</option>
                        <option value="同意">同意</option>
                        <option value="不同意">不同意</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>意見</label>
                    <textarea id="budgetComment" rows="3" placeholder="請輸入您的意見（選填）"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">提交投票</button>
            </form>
        </div>
    </div>

    <!-- Modal: 交際費投票 -->
    <div id="expenseVoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>交際費審查投票</h3>
                <button class="close-btn" onclick="closeModal('expenseVoteModal')">&times;</button>
            </div>
            <div id="expenseVoteContent"></div>
            <form id="expenseVoteForm" onsubmit="event.preventDefault(); submitExpenseVote();">
                <input type="hidden" id="voteExpenseId">
                <div class="form-group">
                    <label>您的決定 <span style="color: red;">*</span></label>
                    <select id="expenseDecision" required>
                        <option value="">請選擇...</option>
                        <option value="同意">同意</option>
                        <option value="不同意">不同意</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>意見</label>
                    <textarea id="expenseComment" rows="3" placeholder="請輸入您的意見（選填）"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">提交投票</button>
            </form>
        </div>
    </div>

    <script>
        // ========== 配置 ==========
        const API_URL = 'https://script.google.com/macros/s/AKfycby6SNF8aNbxSdsLWumSlXj5n4Z1FNl_N8px3X_jGBhcdeX8iJk9Fz6gzBTkwbRnN3xA8Q/exec'; // 請替換成您的實際 URL
        let currentAdmin = JSON.parse(sessionStorage.getItem('currentUser'));
        let allUsers = [];
        let allTransactions = [];
        let allBudgets = [];
        let allExpenses = [];
        let allDirectors = [];

        // ========== 初始化 ==========
        window.onload = function() {
            if (!currentAdmin) {
                alert('請先登入');
                window.location.href = 'index.html';
                return;
            }

            checkAdminPermission();
        };

        async function checkAdminPermission() {
            const result = await callAPI('checkAdmin', { userId: currentAdmin.id });
            
            if (!result.success || !result.isAdmin) {
                alert('您沒有管理員權限');
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('adminName').textContent = `👋 ${currentAdmin.name}`;
            loadDashboard();
        }

        // ========== API 呼叫 ==========
        async function callAPI(action, data = {}) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: action, data: data })
                });
                const text = await response.text();
                return JSON.parse(text);
            } catch (error) {
                console.error('API 錯誤:', error);
                return { success: false, message: '網路連線錯誤' };
            }
        }

        // ========== 頁面切換 ==========
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            switch(sectionId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'budgets':
                    loadBudgets();
                    break;
                case 'expenses':
                    loadExpenses();
                    break;
                case 'directors':
                    loadDirectors();
                    break;
                case 'reports':
                    const today = new Date();
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                    document.getElementById('reportStartDate').value = firstDay.toISOString().split('T')[0];
                    document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
                    break;
            }
        }

        // ========== Modal 控制 ==========
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ========== 儀表板 ==========
        async function loadDashboard() {
            const usersResult = await callAPI('getAllUsers');
            const transResult = await callAPI('getTransactions', {});
            const budgetsResult = await callAPI('getBudgets');
            const expensesResult = await callAPI('getExpenses');

            if (usersResult.success) {
                document.getElementById('totalUsers').textContent = usersResult.users.length;
            }

            if (transResult.success) {
                const pending = transResult.transactions.filter(t => t.status === '待審查').length;
                document.getElementById('pendingTransactions').textContent = pending;
            }

            if (budgetsResult.success) {
                const pending = budgetsResult.budgets.filter(b => b.status === '待審查').length;
                document.getElementById('pendingBudgets').textContent = pending;
            }

            if (expensesResult.success) {
                const pending = expensesResult.expenses.filter(e => e.status === '待審查').length;
                document.getElementById('pendingExpenses').textContent = pending;
            }
        }

        // ========== 人員管理 ==========
        async function loadUsers() {
            const result = await callAPI('getAllUsers');
            
            if (result.success) {
                allUsers = result.users;
                renderUsers(allUsers);
            } else {
                document.getElementById('usersTableContainer').innerHTML = '<div class="empty-state">載入失敗</div>';
            }
        }

        function renderUsers(users) {
            if (users.length === 0) {
                document.getElementById('usersTableContainer').innerHTML = '<div class="empty-state">沒有用戶資料</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>姓名</th>
                            <th>電話</th>
                            <th>類別</th>
                            <th>Email</th>
                            <th>註冊日期</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.phone || '-'}</td>
                        <td>${user.type}</td>
                        <td>${user.email || '-'}</td>
                        <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString('zh-TW') : '-'}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-primary" onclick='openEditUserModal(${JSON.stringify(user)})'>編輯</button>
                                <button class="btn btn-danger" onclick="deleteUser('${user.id}', '${user.name}')">刪除</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('usersTableContainer').innerHTML = html;
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const typeFilter = document.getElementById('userTypeFilter').value;

            let filtered = allUsers.filter(user => {
                const matchSearch = user.name.toLowerCase().includes(searchTerm) || 
                                  (user.phone && user.phone.includes(searchTerm));
                const matchType = !typeFilter || user.type === typeFilter;
                return matchSearch && matchType;
            });

            renderUsers(filtered);
        }

        function openEditUserModal(user) {
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserPhone').value = user.phone || '';
            document.getElementById('editUserType').value = user.type;
            document.getElementById('editUserEmail').value = user.email || '';
            openModal('editUserModal');
        }

        async function updateUser() {
            const data = {
                userId: document.getElementById('editUserId').value,
                name: document.getElementById('editUserName').value,
                phone: document.getElementById('editUserPhone').value,
                type: document.getElementById('editUserType').value,
                email: document.getElementById('editUserEmail').value
            };

            const result = await callAPI('updateUserAdmin', data);

            if (result.success) {
                alert('更新成功');
                closeModal('editUserModal');
                loadUsers();
            } else {
                alert(result.message);
            }
        }

        async function deleteUser(userId, userName) {
            if (!confirm(`確定要刪除用戶「${userName}」嗎？此操作無法復原。`)) {
                return;
            }

            const result = await callAPI('deleteUser', { userId: userId });

            if (result.success) {
                alert('刪除成功');
                loadUsers();
            } else {
                alert(result.message);
            }
        }

        // ========== 收支日記帳 ==========
        async function loadTransactions() {
            const result = await callAPI('getTransactions', {});
            
            if (result.success) {
                allTransactions = result.transactions;
                renderTransactions(allTransactions);
            } else {
                document.getElementById('transactionsTableContainer').innerHTML = '<div class="empty-state">載入失敗</div>';
            }
        }

        function renderTransactions(transactions) {
            if (transactions.length === 0) {
                document.getElementById('transactionsTableContainer').innerHTML = '<div class="empty-state">沒有交易記錄</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>類型</th>
                            <th>類別</th>
                            <th>項目</th>
                            <th>金額</th>
                            <th>帳戶</th>
                            <th>狀態</th>
                            <th>單據</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            transactions.forEach(trans => {
                const statusClass = trans.status === '待審查' ? 'status-pending' : 
                                  trans.status === '已入帳' || trans.status === '支出核准' ? 'status-approved' : 
                                  'status-completed';
                const amountColor = trans.type === '收入' ? '#27ae60' : '#e74c3c';
                
                html += `
                    <tr>
                        <td>${trans.date}</td>
                        <td>${trans.type === '收入' ? '💰' : '💸'} ${trans.type}</td>
                        <td>${trans.category}</td>
                        <td>${trans.name}</td>
                        <td style="color: ${amountColor}; font-weight: 600;">NT$ ${Number(trans.amount).toLocaleString()}</td>
                        <td>${trans.account || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${trans.status}</span></td>
                        <td>${trans.receiptPdf ? `<a href="${trans.receiptPdf}" target="_blank" class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;">查看</a>` : '-'}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-warning" onclick='openEditTransactionModal(${JSON.stringify(trans)})'>編輯</button>
                                <button class="btn btn-danger" onclick="deleteTransaction('${trans.id}')">刪除</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('transactionsTableContainer').innerHTML = html;
        }

        function filterTransactions() {
            const startDate = document.getElementById('transStartDate').value;
            const endDate = document.getElementById('transEndDate').value;
            const typeFilter = document.getElementById('transTypeFilter').value;
            const statusFilter = document.getElementById('transStatusFilter').value;

            let filtered = allTransactions.filter(trans => {
                const matchDate = (!startDate || trans.date >= startDate) && (!endDate || trans.date <= endDate);
                const matchType = !typeFilter || trans.type === typeFilter;
                const matchStatus = !statusFilter || trans.status === statusFilter;
                return matchDate && matchType && matchStatus;
            });

            renderTransactions(filtered);
        }

        function openAddTransactionModal() {
            document.getElementById('addTransactionForm').reset();
            document.getElementById('transDate').value = new Date().toISOString().split('T')[0];
            openModal('addTransactionModal');
        }

        async function addTransaction() {
            const data = {
                date: document.getElementById('transDate').value,
                type: document.getElementById('transType').value,
                category: document.getElementById('transCategory').value,
                name: document.getElementById('transName').value,
                amount: document.getElementById('transAmount').value,
                account: document.getElementById('transAccount').value,
                note: document.getElementById('transNote').value,
                createdBy: currentAdmin.name
            };

            const result = await callAPI('addTransaction', data);

            if (result.success) {
                alert(result.message);
                closeModal('addTransactionModal');
                loadTransactions();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        function openEditTransactionModal(trans) {
            document.getElementById('editTransId').value = trans.id;
            document.getElementById('editTransDate').value = trans.date;
            document.getElementById('editTransType').value = trans.type;
            document.getElementById('editTransCategory').value = trans.category;
            document.getElementById('editTransName').value = trans.name;
            document.getElementById('editTransAmount').value = trans.amount;
            document.getElementById('editTransAccount').value = trans.account || '';
            document.getElementById('editTransStatus').value = trans.status;
            document.getElementById('editTransNote').value = trans.note || '';
            openModal('editTransactionModal');
        }

        async function updateTransaction() {
            const data = {
                id: document.getElementById('editTransId').value,
                date: document.getElementById('editTransDate').value,
                type: document.getElementById('editTransType').value,
                category: document.getElementById('editTransCategory').value,
                name: document.getElementById('editTransName').value,
                amount: document.getElementById('editTransAmount').value,
                account: document.getElementById('editTransAccount').value,
                status: document.getElementById('editTransStatus').value,
                note: document.getElementById('editTransNote').value
            };

            const result = await callAPI('updateTransaction', data);

            if (result.success) {
                alert('更新成功');
                closeModal('editTransactionModal');
                loadTransactions();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        async function deleteTransaction(transId) {
            if (!confirm('確定要刪除此交易記錄嗎？')) {
                return;
            }

            const result = await callAPI('deleteTransaction', { id: transId });

            if (result.success) {
                alert('刪除成功');
                loadTransactions();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        // ========== 預算編列 ==========
        async function loadBudgets() {
            const result = await callAPI('getBudgets');
            
            if (result.success) {
                allBudgets = result.budgets;
                renderBudgets(allBudgets);
            } else {
                document.getElementById('budgetsContainer').innerHTML = '<div class="empty-state">載入失敗</div>';
            }
        }

        function renderBudgets(budgets) {
            if (budgets.length === 0) {
                document.getElementById('budgetsContainer').innerHTML = '<div class="empty-state">沒有預算項目</div>';
                return;
            }

            let html = '';

            budgets.forEach(budget => {
                const statusClass = budget.status === '待審查' ? 'status-pending' : 
                                  budget.status === '已核准' ? 'status-approved' : 
                                  'status-rejected';
                
                html += `
                    <div class="budget-item">
                        <div class="item-header">
                            <div>
                                <div class="item-title">${budget.itemName}</div>
                                <div class="item-info">提案人：${budget.createdBy} | ${new Date(budget.createdAt).toLocaleDateString('zh-TW')}</div>
                            </div>
                            <div class="item-amount">NT$ ${Number(budget.amount).toLocaleString()}</div>
                        </div>
                        <div class="item-info">${budget.description || '無說明'}</div>
                        <div class="vote-section">
                            <div class="vote-stats">
                                <span class="vote-count approve">✓ 同意：${budget.approvedCount}</span>
                                <span class="vote-count reject">✗ 不同意：${budget.rejectedCount}</span>
                                <span class="status-badge ${statusClass}">${budget.status}</span>
                            </div>
                            ${budget.status === '待審查' ? `<button class="btn btn-primary" onclick='openBudgetVoteModal(${JSON.stringify(budget)})'>投票</button>` : ''}
                        </div>
                    </div>
                `;
            });

            document.getElementById('budgetsContainer').innerHTML = html;
        }

        function openAddBudgetModal() {
            document.getElementById('addBudgetForm').reset();
            openModal('addBudgetModal');
        }

        async function addBudget() {
            const data = {
                itemName: document.getElementById('budgetItemName').value,
                amount: document.getElementById('budgetAmount').value,
                description: document.getElementById('budgetDescription').value,
                createdBy: currentAdmin.name
            };

            const result = await callAPI('addBudget', data);

            if (result.success) {
                alert('預算項目已提交審查');
                closeModal('addBudgetModal');
                loadBudgets();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        function openBudgetVoteModal(budget) {
            document.getElementById('voteBudgetId').value = budget.id;
            document.getElementById('budgetVoteContent').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px;">${budget.itemName}</h4>
                    <p style="color: #667eea; font-size: 20px; font-weight: bold; margin-bottom: 10px;">NT$ ${Number(budget.amount).toLocaleString()}</p>
                    <p style="color: #666;">${budget.description || '無說明'}</p>
                </div>
            `;
            openModal('budgetVoteModal');
        }

        async function submitBudgetVote() {
            const data = {
                budgetId: document.getElementById('voteBudgetId').value,
                userId: currentAdmin.id,
                userName: currentAdmin.name,
                decision: document.getElementById('budgetDecision').value,
                comment: document.getElementById('budgetComment').value
            };

            const result = await callAPI('approveBudget', data);

            if (result.success) {
                alert('投票成功');
                closeModal('budgetVoteModal');
                document.getElementById('budgetVoteForm').reset();
                loadBudgets();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        // ========== 理事長交際費 ==========
        async function loadExpenses() {
            const result = await callAPI('getExpenses');
            
            if (result.success) {
                allExpenses = result.expenses;
                renderExpenses(allExpenses);
            } else {
                document.getElementById('expensesContainer').innerHTML = '<div class="empty-state">載入失敗</div>';
            }
        }

        function renderExpenses(expenses) {
            if (expenses.length === 0) {
                document.getElementById('expensesContainer').innerHTML = '<div class="empty-state">沒有交際費記錄</div>';
                return;
            }

            let html = '';

            expenses.forEach(expense => {
                const statusClass = expense.status === '待審查' ? 'status-pending' : 
                                  expense.status === '已核准' ? 'status-approved' : 
                                  'status-rejected';
                const needVote = Number(expense.amount) >= 10000;
                
                html += `
                    <div class="expense-item">
                        <div class="item-header">
                            <div>
                                <div class="item-title">${expense.purpose}</div>
                                <div class="item-info">申請人：${expense.createdBy} | ${expense.date}</div>
                            </div>
                            <div class="item-amount">NT$ ${Number(expense.amount).toLocaleString()}</div>
                        </div>
                        ${needVote ? `
                        <div class="vote-section">
                            <div class="vote-stats">
                                <span class="vote-count approve">✓ 同意：${expense.approvedCount}</span>
                                <span class="vote-count reject">✗ 不同意：${expense.rejectedCount}</span>
                                <span class="status-badge ${statusClass}">${expense.status}</span>
                            </div>
                            ${expense.status === '待審查' ? `<button class="btn btn-primary" onclick='openExpenseVoteModal(${JSON.stringify(expense)})'>投票</button>` : ''}
                        </div>
                        ` : `
                        <div class="vote-section">
                            <span class="status-badge ${statusClass}">${expense.status}</span>
                            <span style="color: #666; font-size: 13px; margin-left: 10px;">金額未達 NT$10,000，無需投票</span>
                        </div>
                        `}
                    </div>
                `;
            });

            document.getElementById('expensesContainer').innerHTML = html;
        }

        function openAddExpenseModal() {
            document.getElementById('addExpenseForm').reset();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            openModal('addExpenseModal');
        }

        async function addExpense() {
            const data = {
                date: document.getElementById('expenseDate').value,
                amount: document.getElementById('expenseAmount').value,
                purpose: document.getElementById('expensePurpose').value,
                createdBy: currentAdmin.name
            };

            const result = await callAPI('addExpense', data);

            if (result.success) {
                alert(result.message);
                closeModal('addExpenseModal');
                loadExpenses();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        function openExpenseVoteModal(expense) {
            document.getElementById('voteExpenseId').value = expense.id;
            document.getElementById('expenseVoteContent').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px;">${expense.purpose}</h4>
                    <p style="color: #667eea; font-size: 20px; font-weight: bold; margin-bottom: 10px;">NT$ ${Number(expense.amount).toLocaleString()}</p>
                    <p style="color: #666;">日期：${expense.date}</p>
                    <p style="color: #666;">申請人：${expense.createdBy}</p>
                </div>
            `;
            openModal('expenseVoteModal');
        }

        async function submitExpenseVote() {
            const data = {
                expenseId: document.getElementById('voteExpenseId').value,
                userId: currentAdmin.id,
                userName: currentAdmin.name,
                decision: document.getElementById('expenseDecision').value,
                comment: document.getElementById('expenseComment').value
            };

            const result = await callAPI('approveExpense', data);

            if (result.success) {
                alert('投票成功');
                closeModal('expenseVoteModal');
                document.getElementById('expenseVoteForm').reset();
                loadExpenses();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        // ========== 理監事管理 ==========
        async function loadDirectors() {
            const result = await callAPI('getDirectors');
            
            if (result.success) {
                allDirectors = result.directors;
                renderDirectors(allDirectors);
            } else {
                document.getElementById('directorsContainer').innerHTML = '<div class="empty-state">載入失敗</div>';
            }
        }

        function renderDirectors(directors) {
            if (directors.length === 0) {
                document.getElementById('directorsContainer').innerHTML = '<div class="empty-state">沒有理監事資料</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>姓名</th>
                            <th>職位</th>
                            <th>加入日期</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            directors.forEach(director => {
                html += `
                    <tr>
                        <td>${director.userName}</td>
                        <td><strong>${director.role}</strong></td>
                        <td>${new Date(director.createdAt).toLocaleDateString('zh-TW')}</td>
                        <td>
                            <button class="btn btn-danger" onclick="removeDirector('${director.id}', '${director.userName}')">移除</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('directorsContainer').innerHTML = html;
        }

        async function openAddDirectorModal() {
            // 載入所有用戶到下拉選單
            const result = await callAPI('getAllUsers');
            
            if (result.success) {
                let options = '<option value="">請選擇...</option>';
                result.users.forEach(user => {
                    options += `<option value="${user.id}">${user.name} (${user.phone || user.lineId})</option>`;
                });
                document.getElementById('directorUserId').innerHTML = options;
            }
            
            document.getElementById('addDirectorForm').reset();
            openModal('addDirectorModal');
        }

        async function addDirector() {
            const userId = document.getElementById('directorUserId').value;
            const role = document.getElementById('directorRole').value;
            
            // 找到選中的用戶名稱
            const selectedOption = document.querySelector('#directorUserId option:checked');
            const userName = selectedOption.text.split(' (')[0];

            const data = {
                userId: userId,
                userName: userName,
                role: role
            };

            const result = await callAPI('addDirector', data);

            if (result.success) {
                alert('理監事新增成功');
                closeModal('addDirectorModal');
                loadDirectors();
            } else {
                alert(result.message);
            }
        }

        async function removeDirector(directorId, userName) {
            if (!confirm(`確定要移除理監事「${userName}」嗎？`)) {
                return;
            }

            const result = await callAPI('removeDirector', { id: directorId });

            if (result.success) {
                alert('移除成功');
                loadDirectors();
            } else {
                alert(result.message);
            }
        }

        // ========== 財務報表 ==========
        async function loadFinancialReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            if (!startDate || !endDate) {
                alert('請選擇日期範圍');
                return;
            }

            if (startDate > endDate) {
                alert('起始日期不能晚於結束日期');
                return;
            }

            document.getElementById('reportSummary').innerHTML = '<div class="loading">產生報表中...</div>';
            document.getElementById('reportDetails').innerHTML = '';

            const result = await callAPI('getFinancialReport', {
                startDate: startDate,
                endDate: endDate
            });

            if (result.success) {
                renderFinancialReport(result.report);
            } else {
                document.getElementById('reportSummary').innerHTML = '<div class="empty-state">載入失敗</div>';
            }
        }

        function renderFinancialReport(report) {
            // 摘要卡片
            const summaryHtml = `
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">
                        <h4>總收入</h4>
                        <div class="number">NT$ ${report.totalIncome.toLocaleString()}</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                        <h4>總支出</h4>
                        <div class="number">NT$ ${report.totalExpense.toLocaleString()}</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                        <h4>結餘</h4>
                        <div class="number">NT$ ${report.balance.toLocaleString()}</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                        <h4>交易筆數</h4>
                        <div class="number">${report.transactionCount}</div>
                    </div>
                </div>
            `;

            document.getElementById('reportSummary').innerHTML = summaryHtml;

            // 類別統計
            let categoryHtml = '<h4 style="margin: 20px 0 10px 0;">📋 類別統計</h4>';
            
            if (Object.keys(report.categoryStats).length === 0) {
                categoryHtml += '<div class="empty-state">此期間沒有交易記錄</div>';
            } else {
                categoryHtml += '<table><thead><tr><th>類別</th><th>收入</th><th>支出</th><th>淨額</th></tr></thead><tbody>';

                for (const [category, stats] of Object.entries(report.categoryStats)) {
                    const net = stats.income - stats.expense;
                    categoryHtml += `
                        <tr>
                            <td><strong>${category}</strong></td>
                            <td style="color: #27ae60; font-weight: 600;">NT$ ${stats.income.toLocaleString()}</td>
                            <td style="color: #e74c3c; font-weight: 600;">NT$ ${stats.expense.toLocaleString()}</td>
                            <td style="font-weight: 700; color: ${net >= 0 ? '#27ae60' : '#e74c3c'};">
                                ${net >= 0 ? '+' : ''}NT$ ${net.toLocaleString()}
                            </td>
                        </tr>
                    `;
                }

                categoryHtml += '</tbody></table>';
            }

            // 明細表
            let detailHtml = '<h4 style="margin: 30px 0 10px 0;">📝 交易明細</h4>';
            
            if (report.transactions.length === 0) {
                detailHtml += '<div class="empty-state">此期間沒有交易記錄</div>';
            } else {
                detailHtml += '<table><thead><tr><th>日期</th><th>類型</th><th>類別</th><th>名稱</th><th>金額</th><th>狀態</th><th>單據</th></tr></thead><tbody>';

                report.transactions.forEach(trans => {
                    const amountColor = trans.type === '收入' ? '#27ae60' : '#e74c3c';
                    const statusClass = trans.status === '待審查' ? 'status-pending' : 
                                      trans.status === '已入帳' || trans.status === '支出核准' ? 'status-approved' : 
                                      'status-completed';
                    
                    detailHtml += `
                        <tr>
                            <td>${trans.date}</td>
                            <td>${trans.type === '收入' ? '💰' : '💸'} <strong>${trans.type}</strong></td>
                            <td>${trans.category}</td>
                            <td>${trans.name}</td>
                            <td style="color: ${amountColor}; font-weight: 700; text-align: right;">
                                ${trans.type === '收入' ? '+' : '-'}NT$ ${Number(trans.amount).toLocaleString()}
                            </td>
                            <td><span class="status-badge ${statusClass}">${trans.status}</span></td>
                            <td>${trans.receiptPdf ? `<a href="${trans.receiptPdf}" target="_blank" class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;">查看</a>` : '-'}</td>
                        </tr>
                    `;
                });

                detailHtml += '</tbody></table>';
            }

            document.getElementById('reportDetails').innerHTML = categoryHtml + detailHtml;
        }

        function exportReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                alert('請先產生報表');
                return;
            }
            
            alert('Excel 匯出功能開發中...\n\n目前您可以：\n1. 使用瀏覽器的列印功能（Ctrl+P）儲存為 PDF\n2. 複製表格內容到 Excel');
        }

        // ========== 登出 ==========
        function adminLogout() {
            if (confirm('確定要登出嗎？')) {
                sessionStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>

