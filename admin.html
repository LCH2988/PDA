<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†å¾Œå° - å¸•é‡‘æ£®å”æœƒ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fa;
      display: flex;
      min-height: 100vh;
    }
    
    /* å´é‚Šæ¬„ */
    .sidebar {
      width: 250px;
      background: #2c3e50;
      color: white;
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    
    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }
    
    .sidebar-header h2 {
      font-size: 20px;
      margin-bottom: 5px;
    }
    
    .sidebar-header p {
      font-size: 13px;
      opacity: 0.7;
    }
    
    .menu-item {
      padding: 15px 20px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .menu-item:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .menu-item.active {
      background: #667eea;
      border-left: 4px solid white;
    }
    
    .menu-item .icon {
      font-size: 20px;
    }
    
    /* ä¸»è¦å…§å®¹å€ */
    .main-content {
      margin-left: 250px;
      flex: 1;
      padding: 30px;
    }
    
    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 24px;
      color: #333;
    }
    
    .logout-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    
    /* çµ±è¨ˆå¡ç‰‡ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .stat-card .icon {
      font-size: 36px;
      margin-bottom: 10px;
    }
    
    .stat-card .label {
      font-size: 14px;
      color: #999;
      margin-bottom: 5px;
    }
    
    .stat-card .value {
      font-size: 28px;
      font-weight: 600;
      color: #333;
    }
    
    /* å…§å®¹å€å¡Š */
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .card-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
    }
    
    /* æŒ‰éˆ• */
    .btn {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }
    
    .btn-success {
      background: #27ae60;
    }
    
    .btn-danger {
      background: #e74c3c;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    /* è¡¨æ ¼ */
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: #f8f9fa;
    }
    
    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #e0e0e0;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    tbody tr:hover {
      background: #f8f9fa;
    }
    
    /* æœå°‹åˆ— */
    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .search-bar input,
    .search-bar select {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .search-bar input {
      flex: 1;
    }
    
    /* Badge */
    .badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }
    
    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    /* åˆ†é  */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-top: 20px;
    }
    
    .pagination button {
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      background: white;
      cursor: pointer;
      border-radius: 6px;
    }
    
    .pagination button.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 24px;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      color: #999;
      cursor: pointer;
    }
    
    /* è¡¨å–® */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
    }
    
    /* è¼‰å…¥ä¸­ */
    .loading {
      text-align: center;
      padding: 40px;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* éŸ¿æ‡‰å¼ */
    @media (max-width: 768px) {
      .sidebar {
        width: 200px;
      }
      
      .main-content {
        margin-left: 200px;
        padding: 15px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- å´é‚Šæ¬„ -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>ğŸ¥ ç®¡ç†å¾Œå°</h2>
      <p>å¸•é‡‘æ£®å”æœƒ</p>
    </div>
    
    <div class="menu-item active" onclick="showSection('dashboard')">
      <span class="icon">ğŸ“Š</span>
      <span>å„€è¡¨æ¿</span>
    </div>
    
    <div class="menu-item" onclick="showSection('members')">
      <span class="icon">ğŸ‘¥</span>
      <span>æœƒå“¡ç®¡ç†</span>
    </div>
    
    <div class="menu-item" onclick="showSection('events')">
      <span class="icon">ğŸ“…</span>
      <span>æ´»å‹•ç®¡ç†</span>
    </div>
    
    <div class="menu-item" onclick="showSection('volunteers')">
      <span class="icon">ğŸ™‹</span>
      <span>å¿—å·¥ç®¡ç†</span>
    </div>
    
    <div class="menu-item" onclick="showSection('finance')">
      <span class="icon">ğŸ’°</span>
      <span>è²¡å‹™ç®¡ç†</span>
    </div>
    
    <div class="menu-item" onclick="showSection('donations')">
      <span class="icon">ğŸ’</span>
      <span>ææ¬¾ç®¡ç†</span>
    </div>
    
    <div class="menu-item" onclick="showSection('reports')">
      <span class="icon">ğŸ“ˆ</span>
      <span>å ±è¡¨åˆ†æ</span>
    </div>
    
    <div class="menu-item" onclick="showSection('settings')">
      <span class="icon">âš™ï¸</span>
      <span>ç³»çµ±è¨­å®š</span>
    </div>
  </div>
  
  <!-- ä¸»è¦å…§å®¹ -->
  <div class="main-content">
    <div class="header">
      <h1 id="page-title">å„€è¡¨æ¿</h1>
      <button class="logout-btn" onclick="handleLogout()">ç™»å‡º</button>
    </div>
    
    <!-- å„€è¡¨æ¿ -->
    <div id="dashboard-section" class="content-section active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="icon">ğŸ‘¥</div>
          <div class="label">ç¸½æœƒå“¡æ•¸</div>
          <div class="value" id="stat-members">-</div>
        </div>
        
        <div class="stat-card">
          <div class="icon">ğŸ“…</div>
          <div class="label">æœ¬æœˆæ´»å‹•</div>
          <div class="value" id="stat-events">-</div>
        </div>
        
        <div class="stat-card">
          <div class="icon">ğŸ™‹</div>
          <div class="label">å¿—å·¥äººæ•¸</div>
          <div class="value" id="stat-volunteers">-</div>
        </div>
        
        <div class="stat-card">
          <div class="icon">ğŸ’°</div>
          <div class="label">æœ¬æœˆææ¬¾</div>
          <div class="value" id="stat-donations">-</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ“‹ å¾…è™•ç†äº‹é …</div>
        </div>
        <div id="pending-tasks">
          <div class="loading">
            <div class="spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æœƒå“¡ç®¡ç† -->
    <div id="members-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">æœƒå“¡åˆ—è¡¨</div>
          <button class="btn btn-small" onclick="exportMembers()">åŒ¯å‡º</button>
        </div>
        
        <div class="search-bar">
          <input type="text" id="member-search" placeholder="æœå°‹å§“åã€é›»è©±ã€Email..." onkeyup="searchMembers()">
          <select id="member-status-filter" onchange="filterMembers()">
            <option value="">å…¨éƒ¨ç‹€æ…‹</option>
            <option value="æ­£å¸¸">æ­£å¸¸</option>
            <option value="å¾…å¯©æ ¸">å¾…å¯©æ ¸</option>
            <option value="å·²åœç”¨">å·²åœç”¨</option>
          </select>
          <button class="btn" onclick="loadMembers()">æœå°‹</button>
        </div>
        
        <div class="table-container">
          <table id="members-table">
            <thead>
              <tr>
                <th>æœƒå“¡ç·¨è™Ÿ</th>
                <th>å§“å</th>
                <th>Email</th>
                <th>æ‰‹æ©Ÿ</th>
                <th>è¨»å†Šæ—¥æœŸ</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                  <div class="loading">
                    <div class="spinner"></div>
                    <p>è¼‰å…¥ä¸­...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="pagination" id="members-pagination"></div>
      </div>
    </div>
    
    <!-- æ´»å‹•ç®¡ç† -->
    <div id="events-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">æ´»å‹•åˆ—è¡¨</div>
          <button class="btn btn-small" onclick="showCreateEventModal()">+ æ–°å¢æ´»å‹•</button>
        </div>
        
        <div class="table-container">
          <table id="events-table">
            <thead>
              <tr>
                <th>æ´»å‹•åç¨±</th>
                <th>é¡å‹</th>
                <th>æ—¥æœŸ</th>
                <th>åœ°é»</th>
                <th>å ±åäººæ•¸</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                  <div class="loading">
                    <div class="spinner"></div>
                    <p>è¼‰å…¥ä¸­...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- å¿—å·¥ç®¡ç† -->
    <div id="volunteers-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">å¿—å·¥åˆ—è¡¨</div>
        </div>
        
        <div class="table-container">
          <table id="volunteers-table">
            <thead>
              <tr>
                <th>å¿—å·¥ç·¨è™Ÿ</th>
                <th>å§“å</th>
                <th>æ‰‹æ©Ÿ</th>
                <th>åŠ å…¥æ—¥æœŸ</th>
                <th>æœå‹™æ™‚æ•¸</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                  <div class="loading">
                    <div class="spinner"></div>
                    <p>è¼‰å…¥ä¸­...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- è²¡å‹™ç®¡ç† -->
    <div id="finance-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">è²¡å‹™è¨˜éŒ„</div>
          <button class="btn btn-small" onclick="showAddFinanceModal()">+ æ–°å¢è¨˜éŒ„</button>
        </div>
        
        <div class="search-bar">
          <select id="finance-type-filter">
            <option value="">å…¨éƒ¨é¡å‹</option>
            <option value="æ”¶å…¥">æ”¶å…¥</option>
            <option value="æ”¯å‡º">æ”¯å‡º</option>
          </select>
          <input type="date" id="finance-start-date">
          <input type="date" id="finance-end-date">
          <button class="btn" onclick="loadFinanceRecords()">æŸ¥è©¢</button>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
          <div style="background: #d4edda; padding: 20px; border-radius: 8px;">
            <div style="font-size: 14px; color: #155724;">ç¸½æ”¶å…¥</div>
            <div style="font-size: 24px; font-weight: 600; color: #155724;" id="total-income">NT$ 0</div>
          </div>
          <div style="background: #f8d7da; padding: 20px; border-radius: 8px;">
            <div style="font-size: 14px; color: #721c24;">ç¸½æ”¯å‡º</div>
            <div style="font-size: 24px; font-weight: 600; color: #721c24;" id="total-expense">NT$ 0</div>
          </div>
          <div style="background: #d1ecf1; padding: 20px; border-radius: 8px;">
            <div style="font-size: 14px; color: #0c5460;">çµé¤˜</div>
            <div style="font-size: 24px; font-weight: 600; color: #0c5460;" id="balance">NT$ 0</div>
          </div>
        </div>
        
        <div class="table-container">
          <table id="finance-table">
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>é¡å‹</th>
                <th>é¡åˆ¥</th>
                <th>é‡‘é¡</th>
                <th>å» å•†</th>
                <th>èªªæ˜</th>
                <th>ç‹€æ…‹</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                  <div class="loading">
                    <div class="spinner"></div>
                    <p>è¼‰å…¥ä¸­...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- ææ¬¾ç®¡ç† -->
    <div id="donations-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ææ¬¾è¨˜éŒ„</div>
        </div>
        
        <div class="table-container">
          <table id="donations-table">
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>ææ¬¾äºº</th>
                <th>é‡‘é¡</th>
                <th>ç”¨é€”</th>
                <th>ä»˜æ¬¾æ–¹å¼</th>
                <th>æ”¶æ“š</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                  <div class="loading">
                    <div class="spinner"></div>
                    <p>è¼‰å…¥ä¸­...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- æœƒå“¡è©³æƒ… Modal -->
  <div id="member-detail-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">æœƒå“¡è©³æƒ…</div>
        <button class="close-btn" onclick="closeModal('member-detail-modal')">&times;</button>
      </div>
      <div id="member-detail-content">
        <!-- å‹•æ…‹è¼‰å…¥ -->
      </div>
    </div>
  </div>
  
  <!-- æ–°å¢æ´»å‹• Modal -->
  <div id="create-event-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">æ–°å¢æ´»å‹•</div>
        <button class="close-btn" onclick="closeModal('create-event-modal')">&times;</button>
      </div>
      <form id="create-event-form" onsubmit="handleCreateEvent(event)">
        <div class="form-group">
          <label>æ´»å‹•åç¨± *</label>
          <input type="text" id="event-name" required>
        </div>
        
        <div class="form-group">
          <label>æ´»å‹•é¡å‹ *</label>
          <select id="event-type" required>
            <option value="">è«‹é¸æ“‡</option>
            <option value="è¡›æ•™è¬›åº§">è¡›æ•™è¬›åº§</option>
            <option value="ç—…å‹èšæœƒ">ç—…å‹èšæœƒ</option>
            <option value="é‹å‹•èª²ç¨‹">é‹å‹•èª²ç¨‹</option>
            <option value="å¿—å·¥åŸ¹è¨“">å¿—å·¥åŸ¹è¨“</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>æ´»å‹•æ—¥æœŸ *</label>
          <input type="date" id="event-date" required>
        </div>
        
        <div class="form-group">
          <label>é–‹å§‹æ™‚é–“ *</label>
          <input type="time" id="event-start-time" required>
        </div>
        
        <div class="form-group">
          <label>çµæŸæ™‚é–“ *</label>
          <input type="time" id="event-end-time" required>
        </div>
        
        <div class="form-group">
          <label>åœ°é» *</label>
          <input type="text" id="event-location" required>
        </div>
        
        <div class="form-group">
          <label>åœ°å€</label>
          <input type="text" id="event-address">
        </div>
        
        <div class="form-group">
          <label>äººæ•¸ä¸Šé™ *</label>
          <input type="number" id="event-max-participants" required value="30" min="1">
        </div>
        
        <div class="form-group">
          <label>æ´»å‹•èªªæ˜</label>
          <textarea id="event-description" rows="4"></textarea>
        </div>
        
        <button type="submit" class="btn" style="width: 100%;">å»ºç«‹æ´»å‹•</button>
      </form>
    </div>
  </div>
  
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxoVYW42uDEOTi5sdUyqnFJojK1zqHfJxlVwvA5g9JcFdMHmw_9FEcDu4LUaNA26b4olw/exec'; // è«‹æ›¿æ›
    let adminInfo = null;
    let currentPage = 1;
    let pageSize = 20;
    
    // åˆå§‹åŒ–
    window.onload = function() {
      // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
      const stored = localStorage.getItem('adminInfo');
      if (!stored) {
        // é¡¯ç¤ºç™»å…¥è¡¨å–®
        showLoginForm();
        return;
      }
      
      adminInfo = JSON.parse(stored);
      loadDashboard();
    };
    
    // é¡¯ç¤ºç™»å…¥è¡¨å–®
    function showLoginForm() {
      document.body.innerHTML = `
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <div style="background: white; padding: 40px; border-radius:20px; max-width: 400px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
<h2 style="text-align: center; margin-bottom: 30px; color: #333;">ğŸ¥ ç®¡ç†å“¡ç™»å…¥</h2>
<form onsubmit="handleAdminLogin(event)">
<div style="margin-bottom: 20px;">
<label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">å¸³è™Ÿ</label>
<input type="text" id="admin-username" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
</div>
<div style="margin-bottom: 20px;">
<label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">å¯†ç¢¼</label>
<input type="password" id="admin-password" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
</div>
<button type="submit" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">ç™»å…¥</button>
</form>
<div style="text-align: center; margin-top: 20px;">
<a href="/" style="color: #667eea; text-decoration: none; font-size: 14px;">è¿”å›é¦–é </a>
</div>
</div>
</div>
`;
}

// ç®¡ç†å“¡ç™»å…¥
async function handleAdminLogin(event) {
  event.preventDefault();
  
  const username = document.getElementById('admin-username').value;
  const password = document.getElementById('admin-password').value;
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'adminLogin',
        username: username,
        password: password
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      localStorage.setItem('adminInfo', JSON.stringify(result.data));
      location.reload();
    } else {
      alert('âŒ ' + result.message);
    }
  } catch (error) {
    console.error(error);
    alert('âŒ ç³»çµ±éŒ¯èª¤');
  }
}

// è¼‰å…¥å„€è¡¨æ¿
async function loadDashboard() {
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getDashboardStats'
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      document.getElementById('stat-members').textContent = result.data.totalMembers;
      document.getElementById('stat-events').textContent = result.data.monthlyEvents;
      document.getElementById('stat-volunteers').textContent = result.data.totalVolunteers;
      document.getElementById('stat-donations').textContent = 'NT$ ' + result.data.monthlyDonations.toLocaleString();
    }
  } catch (error) {
    console.error(error);
  }
  
  loadPendingTasks();
}

// è¼‰å…¥å¾…è™•ç†äº‹é …
async function loadPendingTasks() {
  const container = document.getElementById('pending-tasks');
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getPendingTasks'
      })
    });
    
    const result = await response.json();
    
    if (result.success && result.data.length > 0) {
      let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
      
      result.data.forEach(task => {
        let badgeClass = 'badge-warning';
        if (task.priority === 'é«˜') badgeClass = 'badge-danger';
        
        html += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div>
              <div style="font-weight: 500; margin-bottom: 5px;">${task.title}</div>
              <div style="font-size: 13px; color: #666;">${task.description}</div>
            </div>
            <span class="badge ${badgeClass}">${task.type}</span>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    } else {
      container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">âœ… ç›®å‰æ²’æœ‰å¾…è™•ç†äº‹é …</div>';
    }
  } catch (error) {
    console.error(error);
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">âŒ è¼‰å…¥å¤±æ•—</div>';
  }
}

// åˆ‡æ›é é¢
function showSection(section) {
  // æ›´æ–°é¸å–®ç‹€æ…‹
  document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
  event.currentTarget.classList.add('active');
  
  // éš±è—æ‰€æœ‰å…§å®¹
  document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
  
  // é¡¯ç¤ºå°æ‡‰å…§å®¹
  const sectionElement = document.getElementById(section + '-section');
  if (sectionElement) {
    sectionElement.classList.add('active');
  }
  
  // æ›´æ–°æ¨™é¡Œ
  const titles = {
    'dashboard': 'å„€è¡¨æ¿',
    'members': 'æœƒå“¡ç®¡ç†',
    'events': 'æ´»å‹•ç®¡ç†',
    'volunteers': 'å¿—å·¥ç®¡ç†',
    'finance': 'è²¡å‹™ç®¡ç†',
    'donations': 'ææ¬¾ç®¡ç†',
    'reports': 'å ±è¡¨åˆ†æ',
    'settings': 'ç³»çµ±è¨­å®š'
  };
  document.getElementById('page-title').textContent = titles[section] || section;
  
  // è¼‰å…¥å°æ‡‰è³‡æ–™
  if (section === 'dashboard') {
    loadDashboard();
  } else if (section === 'members') {
    loadMembers();
  } else if (section === 'events') {
    loadEvents();
  } else if (section === 'volunteers') {
    loadVolunteers();
  } else if (section === 'finance') {
    loadFinanceRecords();
  } else if (section === 'donations') {
    loadDonations();
  }
}

// è¼‰å…¥æœƒå“¡åˆ—è¡¨
async function loadMembers() {
  const tbody = document.querySelector('#members-table tbody');
  tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;"><div class="loading"><div class="spinner"></div><p>è¼‰å…¥ä¸­...</p></div></td></tr>';
  
  try {
    const searchText = document.getElementById('member-search').value;
    const status = document.getElementById('member-status-filter').value;
    
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getMembers',
        searchText: searchText,
        status: status,
        page: currentPage,
        pageSize: pageSize
      })
    });
    
    const result = await response.json();
    
    if (result.success && result.data.length > 0) {
      let html = '';
      
      result.data.forEach(member => {
        let badgeClass = 'badge-success';
        if (member.status === 'å¾…å¯©æ ¸') badgeClass = 'badge-warning';
        else if (member.status === 'å·²åœç”¨') badgeClass = 'badge-danger';
        
        html += `
          <tr>
            <td>${member.memberNo}</td>
            <td>${member.name}</td>
            <td>${member.email}</td>
            <td>${member.phone}</td>
            <td>${member.registerDate}</td>
            <td><span class="badge ${badgeClass}">${member.status}</span></td>
            <td>
              <button class="btn btn-small" onclick="showMemberDetail('${member.memberId}')">æŸ¥çœ‹</button>
              ${member.status === 'å¾…å¯©æ ¸' ? `<button class="btn btn-small btn-success" onclick="approveMember('${member.memberId}')">æ ¸å‡†</button>` : ''}
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    } else {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">æ²’æœ‰æ‰¾åˆ°æœƒå“¡è³‡æ–™</td></tr>';
    }
  } catch (error) {
    console.error(error);
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">âŒ è¼‰å…¥å¤±æ•—</td></tr>';
  }
}

// æœå°‹æœƒå“¡
function searchMembers() {
  if (event.key === 'Enter') {
    loadMembers();
  }
}

// ç¯©é¸æœƒå“¡
function filterMembers() {
  loadMembers();
}

// é¡¯ç¤ºæœƒå“¡è©³æƒ…
async function showMemberDetail(memberId) {
  const modal = document.getElementById('member-detail-modal');
  const content = document.getElementById('member-detail-content');
  
  modal.classList.add('active');
  content.innerHTML = '<div class="loading"><div class="spinner"></div><p>è¼‰å…¥ä¸­...</p></div>';
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getMemberInfo',
        memberId: memberId
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      const member = result.data;
      content.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">æœƒå“¡ç·¨è™Ÿ</div>
            <div style="font-weight: 500;">${member.memberNo}</div>
          </div>
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">å§“å</div>
            <div style="font-weight: 500;">${member.name}</div>
          </div>
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">æ€§åˆ¥</div>
            <div style="font-weight: 500;">${member.gender}</div>
          </div>
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">ç”Ÿæ—¥</div>
            <div style="font-weight: 500;">${member.birthday}</div>
          </div>
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">æ‰‹æ©Ÿ</div>
            <div style="font-weight: 500;">${member.phone}</div>
          </div>
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">Email</div>
            <div style="font-weight: 500;">${member.email}</div>
          </div>
          <div style="grid-column: 1 / -1;">
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">åœ°å€</div>
            <div style="font-weight: 500;">${member.address || 'æœªå¡«å¯«'}</div>
          </div>
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">è¨»å†Šæ—¥æœŸ</div>
            <div style="font-weight: 500;">${member.registerDate}</div>
          </div>
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">ç‹€æ…‹</div>
            <div style="font-weight: 500;">${member.status}</div>
          </div>
        </div>
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button class="btn" onclick="closeModal('member-detail-modal')">é—œé–‰</button>
          ${member.status === 'å¾…å¯©æ ¸' ? `<button class="btn btn-success" onclick="approveMember('${member.memberId}')">æ ¸å‡†æœƒå“¡</button>` : ''}
        </div>
      `;
    }
  } catch (error) {
    console.error(error);
    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">âŒ è¼‰å…¥å¤±æ•—</div>';
  }
}

// æ ¸å‡†æœƒå“¡
async function approveMember(memberId) {
  if (!confirm('ç¢ºå®šè¦æ ¸å‡†æ­¤æœƒå“¡å—ï¼Ÿ')) return;
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'approveMember',
        memberId: memberId
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('âœ… å·²æ ¸å‡†æœƒå“¡');
      closeModal('member-detail-modal');
      loadMembers();
    } else {
      alert('âŒ ' + result.message);
    }
  } catch (error) {
    console.error(error);
    alert('âŒ ç³»çµ±éŒ¯èª¤');
  }
}

// åŒ¯å‡ºæœƒå“¡
function exportMembers() {
  alert('åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­');
}

// è¼‰å…¥æ´»å‹•åˆ—è¡¨
async function loadEvents() {
  const tbody = document.querySelector('#events-table tbody');
  tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;"><div class="loading"><div class="spinner"></div><p>è¼‰å…¥ä¸­...</p></div></td></tr>';
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getAllEvents'
      })
    });
    
    const result = await response.json();
    
    if (result.success && result.data.length > 0) {
      let html = '';
      
      result.data.forEach(event => {
        let badgeClass = 'badge-info';
        if (event.status === 'å·²çµæŸ') badgeClass = 'badge-secondary';
        else if (event.status === 'å·²å–æ¶ˆ') badgeClass = 'badge-danger';
        
        html += `
          <tr>
            <td>${event.eventName}</td>
            <td>${event.eventType}</td>
            <td>${event.eventDate}</td>
            <td>${event.location}</td>
            <td>${event.registrationCount}/${event.maxParticipants}</td>
            <td><span class="badge ${badgeClass}">${event.status}</span></td>
            <td>
              <button class="btn btn-small" onclick="viewEventDetail('${event.eventId}')">æŸ¥çœ‹</button>
              <button class="btn btn-small" onclick="viewRegistrations('${event.eventId}')">å ±ååå–®</button>
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    } else {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">æ²’æœ‰æ´»å‹•è³‡æ–™</td></tr>';
    }
  } catch (error) {
    console.error(error);
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">âŒ è¼‰å…¥å¤±æ•—</td></tr>';
  }
}

// é¡¯ç¤ºæ–°å¢æ´»å‹• Modal
function showCreateEventModal() {
  document.getElementById('create-event-modal').classList.add('active');
}

// æ–°å¢æ´»å‹•
async function handleCreateEvent(event) {
  event.preventDefault();
  
  const data = {
    action: 'createEvent',
    eventName: document.getElementById('event-name').value,
    eventType: document.getElementById('event-type').value,
    eventDate: document.getElementById('event-date').value,
    startTime: document.getElementById('event-start-time').value,
    endTime: document.getElementById('event-end-time').value,
    location: document.getElementById('event-location').value,
    address: document.getElementById('event-address').value,
    maxParticipants: document.getElementById('event-max-participants').value,
    description: document.getElementById('event-description').value,
    organizerId: adminInfo.adminId
  };
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('âœ… æ´»å‹•å»ºç«‹æˆåŠŸï¼');
      closeModal('create-event-modal');
      document.getElementById('create-event-form').reset();
      loadEvents();
    } else {
      alert('âŒ ' + result.message);
    }
  } catch (error) {
    console.error(error);
    alert('âŒ ç³»çµ±éŒ¯èª¤');
  }
}

// è¼‰å…¥å¿—å·¥åˆ—è¡¨
async function loadVolunteers() {
  const tbody = document.querySelector('#volunteers-table tbody');
  tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;"><div class="loading"><div class="spinner"></div><p>è¼‰å…¥ä¸­...</p></div></td></tr>';
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getVolunteers'
      })
    });
    
    const result = await response.json();
    
    if (result.success && result.data.length > 0) {
      let html = '';
      
      result.data.forEach(volunteer => {
        let badgeClass = 'badge-success';
        if (volunteer.status === 'å¾…å¯©æ ¸') badgeClass = 'badge-warning';
        
        html += `
          <tr>
            <td>${volunteer.volunteerNo}</td>
            <td>${volunteer.name}</td>
            <td>${volunteer.phone}</td>
            <td>${volunteer.joinDate}</td>
            <td>${volunteer.totalHours || 0} å°æ™‚</td>
            <td><span class="badge ${badgeClass}">${volunteer.status}</span></td>
            <td>
              <button class="btn btn-small" onclick="viewVolunteerDetail('${volunteer.volunteerId}')">æŸ¥çœ‹</button>
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    } else {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">æ²’æœ‰å¿—å·¥è³‡æ–™</td></tr>';
    }
  } catch (error) {
    console.error(error);
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">âŒ è¼‰å…¥å¤±æ•—</td></tr>';
  }
}

// è¼‰å…¥è²¡å‹™è¨˜éŒ„
async function loadFinanceRecords() {
  const tbody = document.querySelector('#finance-table tbody');
  tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;"><div class="loading"><div class="spinner"></div><p>è¼‰å…¥ä¸­...</p></div></td></tr>';
  
  try {
    const type = document.getElementById('finance-type-filter').value;
    const startDate = document.getElementById('finance-start-date').value;
    const endDate = document.getElementById('finance-end-date').value;
    
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getFinanceRecords',
        type: type,
        startDate: startDate,
        endDate: endDate
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // æ›´æ–°çµ±è¨ˆ
      document.getElementById('total-income').textContent = 'NT$ ' + result.data.totalIncome.toLocaleString();
      document.getElementById('total-expense').textContent = 'NT$ ' + result.data.totalExpense.toLocaleString();
      document.getElementById('balance').textContent = 'NT$ ' + (result.data.totalIncome - result.data.totalExpense).toLocaleString();
      
      if (result.data.records.length > 0) {
        let html = '';
        
        result.data.records.forEach(record => {
          const amountColor = record.type === 'æ”¶å…¥' ? '#27ae60' : '#e74c3c';
          const badgeClass = record.status === 'å·²æ ¸å‡†' ? 'badge-success' : 'badge-warning';
          
          html += `
            <tr>
              <td>${record.transactionDate}</td>
              <td>${record.type}</td>
              <td>${record.category}</td>
              <td style="color: ${amountColor}; font-weight: 600;">
                ${record.type === 'æ”¶å…¥' ? '+' : '-'} NT$ ${record.amount.toLocaleString()}
              </td>
              <td>${record.vendor || '-'}</td>
              <td>${record.description}</td>
              <td><span class="badge ${badgeClass}">${record.status}</span></td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
      } else {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">æ²’æœ‰è²¡å‹™è¨˜éŒ„</td></tr>';
      }
    }
  } catch (error) {
    console.error(error);
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">âŒ è¼‰å…¥å¤±æ•—</td></tr>';
  }
}

// è¼‰å…¥ææ¬¾è¨˜éŒ„
async function loadDonations() {
  const tbody = document.querySelector('#donations-table tbody');
  tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;"><div class="loading"><div class="spinner"></div><p>è¼‰å…¥ä¸­...</p></div></td></tr>';
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getAllDonations'
      })
    });
    
    const result = await response.json();
    
    if (result.success && result.data.length > 0) {
      let html = '';
      
      result.data.forEach(donation => {
        html += `
          <tr>
            <td>${donation.donationDate}</td>
            <td>${donation.donorName}</td>
            <td style="color: #27ae60; font-weight: 600;">NT$ ${donation.amount.toLocaleString()}</td>
            <td>${donation.purpose}</td>
            <td>${donation.paymentMethod}</td>
            <td>${donation.receiptIssued ? '<span class="badge badge-success">å·²é–‹ç«‹</span>' : '<span class="badge badge-warning">æœªé–‹ç«‹</span>'}</td>
            <td>
              ${!donation.receiptIssued ? `<button class="btn btn-small" onclick="issueReceipt('${donation.donationId}')">é–‹ç«‹æ”¶æ“š</button>` : ''}
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    } else {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">æ²’æœ‰ææ¬¾è¨˜éŒ„</td></tr>';
    }
  } catch (error) {
    console.error(error);
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">âŒ è¼‰å…¥å¤±æ•—</td></tr>';
  }
}

// é—œé–‰ Modal
function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

// ç™»å‡º
function handleLogout() {
  if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
    localStorage.removeItem('adminInfo');
    location.reload();
  }
}
</script> 
</body> 
</html>  
