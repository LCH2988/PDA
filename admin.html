<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理後台 - 帕金森協會</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fa;
      display: flex;
      min-height: 100vh;
    }
    
    .sidebar {
      width: 250px;
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 1000;
      transition: all 0.3s;
    }
    
    .sidebar.collapsed {
      width: 60px;
    }
    
    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .sidebar-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .sidebar.collapsed .sidebar-title {
      display: none;
    }
    
    .toggle-btn {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
    }
    
    .sidebar-menu {
      padding: 20px 0;
    }
    
    .menu-item {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .menu-item:hover, .menu-item.active {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    .menu-item .icon {
      margin-right: 15px;
      font-size: 18px;
      width: 20px;
      text-align: center;
    }
    
    .sidebar.collapsed .menu-item .text {
      display: none;
    }
    
    .main-content {
      flex: 1;
      margin-left: 250px;
      transition: all 0.3s;
    }
    
    .sidebar.collapsed + .main-content {
      margin-left: 60px;
    }
    
    .top-bar {
      background: white;
      padding: 15px 25px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .page-title {
      font-size: 24px;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #3498db;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    
    .logout-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .logout-btn:hover {
      background: #c0392b;
    }
    
    .content {
      padding: 25px;
    }
    
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }
    
    .card-header {
      padding: 20px 25px;
      border-bottom: 1px solid #ecf0f1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .card-body {
      padding: 25px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3498db, #2ecc71);
    }
    
    .stat-icon {
      font-size: 32px;
      margin-bottom: 15px;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    
    .stat-label {
      color: #7f8c8d;
      font-size: 14px;
      font-weight: 500;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn-primary {
      background: #3498db;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2980b9;
    }
    
    .btn-success {
      background: #27ae60;
      color: white;
    }
    
    .btn-success:hover {
      background: #229954;
    }
    
    .btn-warning {
      background: #f39c12;
      color: white;
    }
    
    .btn-warning:hover {
      background: #e67e22;
    }
    
    .btn-danger {
      background: #e74c3c;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c0392b;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    
    .data-table th {
      background: #f8f9fa;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #2c3e50;
      border-bottom: 2px solid #ecf0f1;
    }
    
    .data-table td {
      padding: 15px;
      border-bottom: 1px solid #ecf0f1;
      vertical-align: middle;
    }
    
    .data-table tr:hover {
      background: #f8f9fa;
    }
    
    .badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }
    
    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .badge-secondary {
      background: #e2e3e5;
      color: #383d41;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #ecf0f1;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #95a5a6;
      padding: 5px;
      line-height: 1;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #2c3e50;
      font-weight: 500;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ecf0f1;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .search-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 12px 15px;
      border: 2px solid #ecf0f1;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .filter-select {
      padding: 12px 15px;
      border: 2px solid #ecf0f1;
      border-radius: 8px;
      font-size: 14px;
      min-width: 150px;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 25px;
    }
    
    .pagination button {
      padding: 8px 12px;
      border: 2px solid #ecf0f1;
      background: white;
      color: #2c3e50;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .pagination button:hover {
      border-color: #3498db;
      color: #3498db;
    }
    
    .pagination button.active {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }
    
    .loading.show {
      display: block;
    }
    
    .spinner {
      border: 3px solid #ecf0f1;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      display: none;
      align-items: center;
      gap: 10px;
    }
    
    .alert.show {
      display: flex;
      animation: slideDown 0.3s ease-out;
    }
    
    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .alert.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .chart-container {
      height: 400px;
      background: #f8f9fa;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #7f8c8d;
      margin: 20px 0;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #7f8c8d;
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 10px;
      color: #95a5a6;
    }
    
    .empty-state p {
      font-size: 14px;
      line-height: 1.6;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        width: 60px;
      }
      
      .sidebar .sidebar-title,
      .sidebar .menu-item .text {
        display: none;
      }
      
      .main-content {
        margin-left: 60px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .search-bar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .table-container {
        font-size: 12px;
      }
      
      .data-table th,
      .data-table td {
        padding: 10px 8px;
      }
    }
  </style>
</head>
<body>
  <!-- 側邊欄 -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">🌟 管理後台</div>
      <button class="toggle-btn" onclick="toggleSidebar()">☰</button>
    </div>
    <nav class="sidebar-menu">
      <a class="menu-item active" onclick="showSection('dashboard')">
        <span class="icon">📊</span>
        <span class="text">總覽</span>
      </a>
      <a class="menu-item" onclick="showSection('members')">
        <span class="icon">👥</span>
        <span class="text">會員管理</span>
      </a>
      <a class="menu-item" onclick="showSection('events')">
        <span class="icon">🎯</span>
        <span class="text">活動管理</span>
      </a>
      <a class="menu-item" onclick="showSection('health')">
        <span class="icon">📋</span>
        <span class="text">健康記錄</span>
      </a>
      <a class="menu-item" onclick="showSection('donations')">
        <span class="icon">💰</span>
        <span class="text">捐款管理</span>
      </a>
      <a class="menu-item" onclick="showSection('reports')">
        <span class="icon">📈</span>
        <span class="text">統計報表</span>
      </a>
      <a class="menu-item" onclick="showSection('settings')">
        <span class="icon">⚙️</span>
        <span class="text">系統設定</span>
      </a>
    </nav>
  </div>
  
  <!-- 主要內容 -->
  <div class="main-content">
    <div class="top-bar">
      <h1 class="page-title" id="page-title">系統總覽</h1>
      <div class="user-info">
        <div class="user-avatar" id="admin-avatar">A</div>
        <span id="admin-name">管理員</span>
        <button class="logout-btn" onclick="logout()">登出</button>
      </div>
    </div>
    
    <div class="content">
      <div id="alert" class="alert"></div>
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>載入中...</p>
      </div>
      
      <!-- 總覽頁面 -->
      <div id="dashboard-section" class="content-section active">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">👥</div>
            <div class="stat-value" id="total-members">-</div>
            <div class="stat-label">總會員數</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">✅</div>
            <div class="stat-value" id="active-members">-</div>
            <div class="stat-label">活躍會員</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">🎯</div>
            <div class="stat-value" id="total-events">-</div>
            <div class="stat-label">總活動數</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">💰</div>
            <div class="stat-value" id="total-donations">-</div>
            <div class="stat-label">總捐款金額</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">📈 數據趨勢</h3>
          </div>
          <div class="card-body">
            <div class="chart-container">
              會員增長趨勢圖表 (需要圖表庫支援)
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">🔔 最新動態</h3>
          </div>
          <div class="card-body">
            <div id="recent-activities">
              <div class="loading show">
                <div class="spinner"></div>
                <p>載入最新動態...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 會員管理 -->
      <div id="members-section" class="content-section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">👥 會員管理</h3>
            <button class="btn btn-primary" onclick="showAddMemberModal()">新增會員</button>
          </div>
          <div class="card-body">
            <div class="search-bar">
              <input type="text" class="search-input" id="member-search" placeholder="搜尋會員姓名、Email 或電話...">
              <select class="filter-select" id="member-status-filter">
                <option value="">所有狀態</option>
                <option value="已審核">已審核</option>
                <option value="待審核">待審核</option>
                <option value="已停用">已停用</option>
              </select>
              <button class="btn btn-primary" onclick="searchMembers()">搜尋</button>
              <button class="btn btn-warning" onclick="exportMembers()">匯出</button>
            </div>
            
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>會員編號</th>
                    <th>姓名</th>
                    <th>Email</th>
                    <th>電話</th>
                    <th>註冊日期</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="members-tbody">
                  <tr>
                    <td colspan="7">
                      <div class="loading show">
                        <div class="spinner"></div>
                        <p>載入會員資料...</p>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div class="pagination" id="members-pagination"></div>
          </div>
        </div>
      </div>
      
      <!-- 活動管理 -->
      <div id="events-section" class="content-section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">🎯 活動管理</h3>
            <button class="btn btn-primary" onclick="showAddEventModal()">新增活動</button>
          </div>
          <div class="card-body">
            <div class="search-bar">
              <input type="text" class="search-input" id="event-search" placeholder="搜尋活動名稱...">
              <select class="filter-select" id="event-status-filter">
                <option value="">所有狀態</option>
                <option value="報名中">報名中</option>
                <option value="已額滿">已額滿</option>
                <option value="已結束">已結束</option>
                <option value="已取消">已取消</option>
              </select>
              <button class="btn btn-primary" onclick="searchEvents()">搜尋</button>
            </div>
            
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>活動名稱</th>
                    <th>日期時間</th>
                    <th>地點</th>
                    <th>報名人數</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="events-tbody">
                  <tr>
                    <td colspan="6">
                      <div class="loading show">
                        <div class="spinner"></div>
                        <p>載入活動資料...</p>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div class="pagination" id="events-pagination"></div>
          </div>
        </div>
      </div>
      
      <!-- 健康記錄 -->
      <div id="health-section" class="content-section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">📋 健康記錄管理</h3>
          </div>
          <div class="card-body">
            <div class="search-bar">
              <input type="text" class="search-input" id="health-search" placeholder="搜尋會員姓名...">
              <input type="date" class="filter-select" id="health-date-from">
              <input type="date" class="filter-select" id="health-date-to">
              <button class="btn btn-primary" onclick="searchHealthRecords()">搜尋</button>
              <button class="btn btn-warning" onclick="exportHealthData()">匯出數據</button>
            </div>
            
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>會員姓名</th>
                    <th>記錄日期</th>
                    <th>震顫</th>
                    <th>僵硬</th>
                    <th>動作遲緩</th>
                    <th>平衡問題</th>
                    <th>備註</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="health-tbody">
                  <tr>
                    <td colspan="8">
                      <div class="loading show">
                        <div class="spinner"></div>
                        <p>載入健康記錄...</p>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div class="pagination" id="health-pagination"></div>
          </div>
        </div>
      </div>
      
      <!-- 捐款管理 -->
      <div id="donations-section" class="content-section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">💰 捐款管理</h3>
            <button class="btn btn-primary" onclick="showAddDonationModal()">新增捐款記錄</button>
          </div>
          <div class="card-body">
            <div class="search-bar">
              <input type="text" class="search-input" id="donation-search" placeholder="搜尋捐款人姓名...">
              <select class="filter-select" id="donation-type-filter">
                <option value="">所有類型</option>
                <option value="一般捐款">一般捐款</option>
                <option value="定期捐款">定期捐款</option>
                <option value="指定用途">指定用途</option>
              </select>
              <input type="date" class="filter-select" id="donation-date-from">
              <input type="date" class="filter-select" id="donation-date-to">
              <button class="btn btn-primary" onclick="searchDonations()">搜尋</button>
              <button class="btn btn-warning" onclick="exportDonations()">匯出</button>
            </div>
            
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>捐款人</th>
                    <th>金額</th>
                    <th>類型</th>
                    <th>捐款日期</th>
                    <th>付款方式</th>
                    <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="donations-tbody">
                <tr>
                  <td colspan="7">
                    <div class="loading show">
                      <div class="spinner"></div>
                      <p>載入捐款記錄...</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="pagination" id="donations-pagination"></div>
        </div>
      </div>
    </div>
    
    <!-- 統計報表 -->
    <div id="reports-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">📈 統計報表</h3>
          <button class="btn btn-warning" onclick="exportAllReports()">匯出全部報表</button>
        </div>
        <div class="card-body">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">📊</div>
              <div class="stat-value" id="monthly-new-members">-</div>
              <div class="stat-label">本月新增會員</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">🎯</div>
              <div class="stat-value" id="monthly-events">-</div>
              <div class="stat-label">本月活動數</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">💰</div>
              <div class="stat-value" id="monthly-donations">-</div>
              <div class="stat-label">本月捐款總額</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">📝</div>
              <div class="stat-value" id="monthly-health-records">-</div>
              <div class="stat-label">本月健康記錄</div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">📈 年度趨勢分析</h3>
            </div>
            <div class="card-body">
              <div class="chart-container">
                年度數據趨勢圖表 (需要圖表庫支援)
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">🎯 活動參與統計</h3>
            </div>
            <div class="card-body">
              <div class="chart-container">
                活動參與度分析圖表
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 系統設定 -->
    <div id="settings-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">⚙️ 系統設定</h3>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group">
              <label>API 網址</label>
              <input type="url" id="api-url" placeholder="https://example.com/api">
            </div>
            <div class="form-group">
              <label>系統標題</label>
              <input type="text" id="system-title" value="帕金森協會管理系統">
            </div>
            <div class="form-group">
              <label>每頁顯示筆數</label>
              <select id="page-size">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
            <div class="form-group">
              <label>自動備份間隔 (小時)</label>
              <input type="number" id="backup-interval" value="24" min="1" max="168">
            </div>
          </div>
          
          <div class="form-group">
            <label>系統公告</label>
            <textarea id="system-announcement" rows="4" placeholder="輸入系統公告內容..."></textarea>
          </div>
          
          <div style="display: flex; gap: 15px; margin-top: 25px;">
            <button class="btn btn-primary" onclick="saveSettings()">儲存設定</button>
            <button class="btn btn-warning" onclick="exportData()">匯出資料</button>
            <button class="btn btn-success" onclick="backupData()">立即備份</button>
            <button class="btn btn-danger" onclick="clearCache()">清除快取</button>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">🔐 管理員帳號</h3>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>管理員名稱</th>
                  <th>Email</th>
                  <th>權限等級</th>
                  <th>最後登入</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="admins-tbody">
                <tr>
                  <td>系統管理員</td>
                  <td>admin@parkinson.org.tw</td>
                  <td><span class="badge badge-danger">超級管理員</span></td>
                  <td>2024-01-15 14:30</td>
                  <td><span class="badge badge-success">已啟用</span></td>
                  <td>
                    <button class="btn btn-small btn-warning" onclick="editAdmin('admin1')">編輯</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <button class="btn btn-primary" onclick="showAddAdminModal()" style="margin-top: 15px;">新增管理員</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 新增會員彈窗 -->
<div id="add-member-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">新增會員</h3>
      <button class="close-btn" onclick="closeModal('add-member-modal')">&times;</button>
    </div>
    <form onsubmit="saveMember(event)">
      <div class="form-grid">
        <div class="form-group">
          <label>姓名 *</label>
          <input type="text" id="member-name" required>
        </div>
        <div class="form-group">
          <label>會員編號</label>
          <input type="text" id="member-no" placeholder="系統自動產生">
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="member-email" required>
        </div>
        <div class="form-group">
          <label>電話</label>
          <input type="tel" id="member-phone">
        </div>
        <div class="form-group">
          <label>性別</label>
          <select id="member-gender">
            <option value="">請選擇</option>
            <option value="男">男</option>
            <option value="女">女</option>
            <option value="其他">其他</option>
          </select>
        </div>
        <div class="form-group">
          <label>生日</label>
          <input type="date" id="member-birthday">
        </div>
      </div>
      
      <div class="form-group">
        <label>地址</label>
        <textarea id="member-address" rows="2" placeholder="完整地址"></textarea>
      </div>
      
      <div class="form-group">
        <label>備註</label>
        <textarea id="member-notes" rows="3" placeholder="特殊需求或注意事項"></textarea>
      </div>
      
      <button type="submit" class="btn btn-primary" style="width: 100%;">新增會員</button>
    </form>
  </div>
</div>

<!-- 新增活動彈窗 -->
<div id="add-event-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">新增活動</h3>
      <button class="close-btn" onclick="closeModal('add-event-modal')">&times;</button>
    </div>
    <form onsubmit="saveEvent(event)">
      <div class="form-grid">
        <div class="form-group">
          <label>活動名稱 *</label>
          <input type="text" id="event-name" required>
        </div>
        <div class="form-group">
          <label>活動類型</label>
          <select id="event-type">
            <option value="健康講座">健康講座</option>
            <option value="復健課程">復健課程</option>
            <option value="互助聚會">互助聚會</option>
            <option value="志工活動">志工活動</option>
            <option value="其他">其他</option>
          </select>
        </div>
        <div class="form-group">
          <label>活動日期 *</label>
          <input type="date" id="event-date" required>
        </div>
        <div class="form-group">
          <label>開始時間 *</label>
          <input type="time" id="event-start-time" required>
        </div>
        <div class="form-group">
          <label>結束時間 *</label>
          <input type="time" id="event-end-time" required>
        </div>
        <div class="form-group">
          <label>報名上限</label>
          <input type="number" id="event-max-participants" min="1" value="30">
        </div>
      </div>
      
      <div class="form-group">
        <label>活動地點 *</label>
        <input type="text" id="event-location" required placeholder="活動舉辦地點">
      </div>
      
      <div class="form-group">
        <label>活動描述</label>
        <textarea id="event-description" rows="4" placeholder="詳細活動內容、注意事項等"></textarea>
      </div>
      
      <div class="form-group">
        <label>報名費用 (元)</label>
        <input type="number" id="event-fee" min="0" value="0">
      </div>
      
      <button type="submit" class="btn btn-primary" style="width: 100%;">新增活動</button>
    </form>
  </div>
</div>

<!-- 新增捐款記錄彈窗 -->
<div id="add-donation-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">新增捐款記錄</h3>
      <button class="close-btn" onclick="closeModal('add-donation-modal')">&times;</button>
    </div>
    <form onsubmit="saveDonation(event)">
      <div class="form-grid">
        <div class="form-group">
          <label>捐款人姓名 *</label>
          <input type="text" id="donation-donor-name" required>
        </div>
        <div class="form-group">
          <label>捐款金額 *</label>
          <input type="number" id="donation-amount" required min="1">
        </div>
        <div class="form-group">
          <label>捐款類型</label>
          <select id="donation-type">
            <option value="一般捐款">一般捐款</option>
            <option value="定期捐款">定期捐款</option>
            <option value="指定用途">指定用途</option>
          </select>
        </div>
        <div class="form-group">
          <label>捐款日期 *</label>
          <input type="date" id="donation-date" required>
        </div>
        <div class="form-group">
          <label>付款方式</label>
          <select id="donation-payment-method">
            <option value="銀行轉帳">銀行轉帳</option>
            <option value="信用卡">信用卡</option>
            <option value="現金">現金</option>
            <option value="支票">支票</option>
          </select>
        </div>
        <div class="form-group">
          <label>聯絡電話</label>
          <input type="tel" id="donation-phone">
        </div>
      </div>
      
      <div class="form-group">
        <label>捐款用途說明</label>
        <textarea id="donation-purpose" rows="3" placeholder="指定用途或備註"></textarea>
      </div>
      
      <button type="submit" class="btn btn-primary" style="width: 100%;">新增記錄</button>
    </form>
  </div>
</div>

<!-- 新增管理員彈窗 -->
<div id="add-admin-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">新增管理員</h3>
      <button class="close-btn" onclick="closeModal('add-admin-modal')">&times;</button>
    </div>
    <form onsubmit="saveAdmin(event)">
      <div class="form-grid">
        <div class="form-group">
          <label>管理員姓名 *</label>
          <input type="text" id="admin-name-input" required>
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="admin-email" required>
        </div>
        <div class="form-group">
          <label>密碼 *</label>
          <input type="password" id="admin-password" required minlength="6">
        </div>
        <div class="form-group">
          <label>確認密碼 *</label>
          <input type="password" id="admin-password-confirm" required minlength="6">
        </div>
        <div class="form-group">
          <label>權限等級</label>
          <select id="admin-role">
            <option value="一般管理員">一般管理員</option>
            <option value="高級管理員">高級管理員</option>
          </select>
        </div>
        <div class="form-group">
          <label>聯絡電話</label>
          <input type="tel" id="admin-phone">
        </div>
      </div>
      
      <button type="submit" class="btn btn-primary" style="width: 100%;">新增管理員</button>
    </form>
  </div>
</div>

<script>
  // ========== 全域變數 ==========
  let API_URL = localStorage.getItem('admin_API_URL') || '';
  let currentPage = 1;
  let pageSize = 20;
  let currentSection = 'dashboard';
  
  // ========== 初始化 ==========
  window.onload = function() {
    checkAuthStatus();
    loadDashboardData();
    loadSettings();
  };
  
  function checkAuthStatus() {
    const adminInfo = localStorage.getItem('adminInfo');
    if (!adminInfo) {
      alert('請先登入管理後台');
      window.location.href = 'admin-login.html';
      return;
    }
    
    const admin = JSON.parse(adminInfo);
    document.getElementById('admin-name').textContent = admin.name || '管理員';
    document.getElementById('admin-avatar').textContent = (admin.name || 'A').charAt(0);
  }
  
  // ========== 側邊欄控制 ==========
  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('collapsed');
  }
  
  function showSection(section) {
    // 隱藏所有頁面
    document.querySelectorAll('.content-section').forEach(s => {
      s.classList.remove('active');
    });
    
    // 移除所有選單項目的 active
    document.querySelectorAll('.menu-item').forEach(item => {
      item.classList.remove('active');
    });
    
    // 顯示指定頁面
    document.getElementById(section + '-section').classList.add('active');
    
    // 設定選單項目為 active
    event.currentTarget.classList.add('active');
    
    // 更新頁面標題
    const titles = {
      'dashboard': '系統總覽',
      'members': '會員管理',
      'events': '活動管理', 
      'health': '健康記錄',
      'donations': '捐款管理',
      'reports': '統計報表',
      'settings': '系統設定'
    };
    
    document.getElementById('page-title').textContent = titles[section];
    currentSection = section;
    
    // 載入對應資料
    switch(section) {
      case 'dashboard':
        loadDashboardData();
        break;
      case 'members':
        loadMembersData();
        break;
      case 'events':
        loadEventsData();
        break;
      case 'health':
        loadHealthData();
        break;
      case 'donations':
        loadDonationsData();
        break;
      case 'reports':
        loadReportsData();
        break;
      case 'settings':
        loadSettings();
        break;
    }
  }
  
  // ========== API 呼叫 ==========
  async function callAPI(data) {
    if (!API_URL) {
      showAlert('請先在系統設定中設定 API 網址', 'error');
      return { success: false, message: '未設定 API 網址' };
    }
    
    try {
      showLoading(true);
      
      const params = new URLSearchParams();
      for (let key in data) {
        params.append(key, typeof data[key] === 'object' ? JSON.stringify(data[key]) : data[key]);
      }
      
      const response = await fetch(API_URL + '?' + params.toString(), {
        method: 'GET',
        redirect: 'follow',
        mode: 'cors'
      });
      
      if (!response.ok) {
        throw new Error('HTTP ' + response.status);
      }
      
      const text = await response.text();
      return JSON.parse(text);
      
    } catch (error) {
      console.error('API 錯誤:', error);
      showAlert('API 呼叫失敗: ' + error.message, 'error');
      return { success: false, message: error.message };
    } finally {
      showLoading(false);
    }
  }
  
  // ========== 載入資料功能 ==========
  async function loadDashboardData() {
    try {
      const [
        membersResult,
        eventsResult, 
        donationsResult,
        activitiesResult
      ] = await Promise.all([
        callAPI({ action: 'getStats', type: 'members' }),
        callAPI({ action: 'getStats', type: 'events' }),
        callAPI({ action: 'getStats', type: 'donations' }),
        callAPI({ action: 'getRecentActivities' })
      ]);
      
      // 更新統計數據
      if (membersResult.success) {
        document.getElementById('total-members').textContent = membersResult.data.total || 0;
        document.getElementById('active-members').textContent = membersResult.data.active || 0;
      }
      
      if (eventsResult.success) {
        document.getElementById('total-events').textContent = eventsResult.data.total || 0;
      }
      
      if (donationsResult.success) {
        const total = donationsResult.data.total || 0;
        document.getElementById('total-donations').textContent = 'NT$ ' + total.toLocaleString();
      }
      
      // 載入最新動態
      const activitiesContainer = document.getElementById('recent-activities');
      if (activitiesResult.success && activitiesResult.data.length > 0) {
        activitiesContainer.innerHTML = activitiesResult.data.map(activity => `
          <div style="padding: 15px; border-bottom: 1px solid #ecf0f1;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${activity.type}</strong>
                <p style="margin: 5px 0; color: #7f8c8d;">${activity.description}</p>
              </div>
              <small style="color: #95a5a6;">${activity.timestamp}</small>
            </div>
          </div>
        `).join('');
      } else {
        activitiesContainer.innerHTML = '<div class="empty-state"><div class="icon">📝</div><p>暫無動態記錄</p></div>';
      }
      
    } catch (error) {
      console.error('載入總覽資料失敗:', error);
      showAlert('載入總覽資料失敗', 'error');
    }
  }
  
  async function loadMembersData(page = 1) {
    const tbody = document.getElementById('members-tbody');
    tbody.innerHTML = '<tr><td colspan="7"><div class="loading show"><div class="spinner"></div><p>載入會員資料...</p></div></td></tr>';
    
    try {
      const searchTerm = document.getElementById('member-search')?.value || '';
      const statusFilter = document.getElementById('member-status-filter')?.value || '';
      
      const result = await callAPI({
        action: 'getMembers',
        page: page,
        pageSize: pageSize,
        search: searchTerm,
        status: statusFilter
      });
      
      if (result.success && result.data.length > 0) {
        tbody.innerHTML = result.data.map(member => `
          <tr>
            <td>${member.memberNo}</td>
            <td>${member.name}</td>
            <td>${member.email}</td>
            <td>${member.phone || '-'}</td>
            <td>${member.registerDate}</td>
            <td><span class="badge badge-${getStatusClass(member.status)}">${member.status}</span></td>
            <td>
              <button class="btn btn-small btn-primary" onclick="viewMember('${member.memberId}')">查看</button>
              <button class="btn btn-small btn-warning" onclick="editMember('${member.memberId}')">編輯</button>
              <button class="btn btn-small btn-danger" onclick="deleteMember('${member.memberId}')">刪除</button>
            </td>
          </tr>
        `).join('');
        
        // 更新分頁
        updatePagination('members', result.totalPages, page);
      } else {
        tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="icon">👥</div><p>沒有找到會員資料</p></div></td></tr>';
      }
      
    } catch (error) {
      tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="icon">❌</div><p>載入失敗</p></div></td></tr>';
    }
  }
  
  async function loadEventsData(page = 1) {
    const tbody = document.getElementById('events-tbody');
    tbody.innerHTML = '<tr><td colspan="6"><div class="loading show"><div class="spinner"></div><p>載入活動資料...</p></div></td></tr>';
    
    try {
      const searchTerm = document.getElementById('event-search')?.value || '';
      const statusFilter = document.getElementById('event-status-filter')?.value || '';
      
      const result = await callAPI({
        action: 'getEvents',
        page: page,
        pageSize: pageSize,
        search: searchTerm,
        status: statusFilter
      });
      
      if (result.success && result.data.length > 0) {
        tbody.innerHTML = result.data.map(event => `
          <tr>
            <td>${event.eventName}</td>
            <td>${event.eventDate} ${event.startTime}</td>
            <td>${event.location}</td>
            <td>${event.registrationCount}/${event.maxParticipants}</td>
            <td><span class="badge badge-${getStatusClass(event.status)}">${event.status}</span></td>
            <td>
              <button class="btn btn-small btn-primary" onclick="viewEvent('${event.eventId}')">查看</button>
              <button class="btn btn-small btn-warning" onclick="editEvent('${event.eventId}')">編輯</button>
              <button class="btn btn-small btn-danger" onclick="deleteEvent('${event.eventId}')">刪除</button>
            </td>
          </tr>
        `).join('');
        
        updatePagination('events', result.totalPages, page);
      } else {
        tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="icon">🎯</div><p>沒有找到活動資料</p></div></td></tr>';
      }
      
    } catch (error) {
      tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="icon">❌</div><p>載入失敗</p></div></td></tr>';
    }
  }
  
  async function loadHealthData(page = 1) {
    const tbody = document.getElementById('health-tbody');
    tbody.innerHTML = '<tr><td colspan="8"><div class="loading show"><div class="spinner"></div><p>載入健康記錄...</p></div></td></tr>';
    
    try {
      const searchTerm = document.getElementById('health-search')?.value || '';
      const dateFrom = document.getElementById('health-date-from')?.value || '';
      const dateTo = document.getElementById('health-date-to')?.value || '';
      
      const result = await callAPI({
        action: 'getAllHealthRecords',
        page: page,
        pageSize: pageSize,
        search: searchTerm,
        dateFrom: dateFrom,
        dateTo: dateTo
      });
      
      if (result.success && result.data.length > 0) {
        tbody.innerHTML = result.data.map(record => `
          <tr>
            <td>${record.memberName}</td>
            <td>${record.recordDate}</td>
            <td>${record.tremorLevel}</td>
            <td>${record.rigidityLevel}</td>
            <td>${record.bradykinesiaLevel}</td>
            <td>${record.balanceLevel}</td>
            <td>${record.notes || '-'}</td>
            <td>
              <button class="btn btn-small btn-primary" onclick="viewHealthRecord('${record.recordId}')">查看</button>
              <button class="btn btn-small btn-danger" onclick="deleteHealthRecord('${record.recordId}')">刪除</button>
            </td>
          </tr>
        `).join('');
        
        updatePagination('health', result.totalPages, page);
      } else {
        tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><div class="icon">📋</div><p>沒有找到健康記錄</p></div></td></tr>';
      }
      
    } catch (error) {
      tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><div class="icon">❌</div><p>載入失敗</p></div></td></tr>';
    }
  }
  
  async function loadDonationsData(page = 1) {
    const tbody = document.getElementById('donations-tbody');
    tbody.innerHTML = '<tr><td colspan="7"><div class="loading show"><div class="spinner"></div><p>載入捐款記錄...</p></div></td></tr>';
    
    try {
      const searchTerm = document.getElementById('donation-search')?.value || '';
      const typeFilter = document.getElementById('donation-type-filter')?.value || '';
      const dateFrom = document.getElementById('donation-date-from')?.value || '';
      const dateTo = document.getElementById('donation-date-to')?.value || '';
      
      const result = await callAPI({
        action: 'getDonations',
        page: page,
        pageSize: pageSize,
        search: searchTerm,
        type: typeFilter,
        dateFrom: dateFrom,
        dateTo: dateTo
      });
      
      if (result.success && result.data.length > 0) {
        tbody.innerHTML = result.data.map(donation => `
          <tr>
            <td>${donation.donorName}</td>
            <td>NT$ ${donation.amount.toLocaleString()}</td>
            <td>${donation.donationType}</td>
            <td>${donation.donationDate}</td>
            <td>${donation.paymentMethod}</td>
            <td><span class="badge badge-${getStatusClass(donation.status)}">${donation.status}</span></td>
            <td>
              <button class="btn btn-small btn-primary" onclick="viewDonation('${donation.donationId}')">查看</button>
              <button class="btn btn-small btn-warning" onclick="editDonation('${donation.donationId}')">編輯</button>
              <button class="btn btn-small btn-danger" onclick="deleteDonation('${donation.donationId}')">刪除</button>
            </td>
          </tr>
        `).join('');
        
        updatePagination('donations', result.totalPages, page);
      } else {
        tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="icon">💰</div><p>沒有找到捐款記錄</p></div></td></tr>';
      }
      
    } catch (error) {
      tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="icon">❌</div><p>載入失敗</p></div></td></tr>';
    }
  }
  
  async function loadReportsData() {
    try {
      const [
        monthlyStatsResult,
        yearlyTrendsResult
      ] = await Promise.all([
        callAPI({ action: 'getMonthlyStats' }),
        callAPI({ action: 'getYearlyTrends' })
      ]);
      
      // 更新月統計
      if (monthlyStatsResult.success) {
        const data = monthlyStatsResult.data;
        document.getElementById('monthly-new-members').textContent = data.newMembers || 0;
        document.getElementById('monthly-events').textContent = data.events || 0;
        document.getElementById('monthly-donations').textContent = 'NT$ ' + (data.donations || 0).toLocaleString();
        document.getElementById('monthly-health-records').textContent = data.healthRecords || 0;
      }
      
    } catch (error) {
      console.error('載入報表資料失敗:', error);
      showAlert('載入報表資料失敗', 'error');
    }
  }
  
  // ========== 工具函數 ==========
  function getStatusClass(status) {
    const statusMap = {
      '已審核': 'success',
      '待審核': 'warning', 
      '已停用': 'danger',
      '報名中': 'info',
      '已額滿': 'warning',
      '已結束': 'secondary',
      '已取消': 'danger',
      '已完成': 'success',
      '處理中': 'warning',
      '已啟用': 'success'
    };
    return statusMap[status] || 'secondary';
  }
  
  function showLoading(show) {
    const loading = document.getElementById('loading');
    if (show) {
      loading.classList.add('show');
    } else {
      loading.classList.remove('show');
    }
  }
  
  function showAlert(message, type = 'info') {
    const alert = document.getElementById('alert');
    alert.className = `alert ${type} show`;
    alert.innerHTML = `
      <span>📢</span>
      <span>${message}</span>
      <button style="margin-left: auto; background: none; border: none; font-size: 18px; cursor: pointer;" onclick="hideAlert()">&times;</button>
    `;
    
    // 自動隱藏
    setTimeout(() => {
      hideAlert();
    }, 5000);
  }
  
  function hideAlert() {
    document.getElementById('alert').classList.remove('show');
  }
  
  function updatePagination(section, totalPages, currentPage) {
    const paginationContainer = document.getElementById(section + '-pagination');
    if (!paginationContainer) return;
    
    let html = '';
    
    // 上一頁
    html += `<button ${currentPage <= 1 ? 'disabled' : ''} onclick="loadPage${section.charAt(0).toUpperCase() + section.slice(1)}Data(${currentPage - 1})">上一頁</button>`;
    
    // 頁碼
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
      html += `<button class="${i === currentPage ? 'active' : ''}" onclick="loadPage${section.charAt(0).toUpperCase() + section.slice(1)}Data(${i})">${i}</button>`;
    }
    
    // 下一頁
    html += `<button ${currentPage >= totalPages ? 'disabled' : ''} onclick="loadPage${section.charAt(0).toUpperCase() + section.slice(1)}Data(${currentPage + 1})">下一頁</button>`;
    
    paginationContainer.innerHTML = html;
  }
  
  // 分頁載入函數別名
  function loadPageMembersData(page) { loadMembersData(page); }
  function loadPageEventsData(page) { loadEventsData(page); }
  function loadPageHealthData(page) { loadHealthData(page); }
  function loadPageDonationsData(page) { loadDonationsData(page); }
  
  // ========== 彈窗控制 ==========
  function showAddMemberModal() {
    document.getElementById('add-member-modal').classList.add('show');
    // 清空表單
    document.getElementById('add-member-modal').querySelectorAll('input, select, textarea').forEach(input => {
      input.value = '';
    });
  }
  
  function showAddEventModal() {
    document.getElementById('add-event-modal').classList.add('show');
    // 清空表單並設定預設值
    document.getElementById('add-event-modal').querySelectorAll('input, select, textarea').forEach(input => {
      if (input.type === 'date') {
        input.value = new Date().toISOString().split('T')[0];
      } else if (input.id === 'event-max-participants') {
        input.value = '30';
      } else if (input.id === 'event-fee') {
        input.value = '0';
      } else {
        input.value = '';
      }
    });
  }
  
  function showAddDonationModal() {
    document.getElementById('add-donation-modal').classList.add('show');
    // 清空表單並設定今日日期
    document.getElementById('add-donation-modal').querySelectorAll('input, select, textarea').forEach(input => {
      if (input.type === 'date') {
        input.value = new Date().toISOString().split('T')[0];
      } else {
        input.value = '';
      }
    });
  }
  
  function showAddAdminModal() {
    document.getElementById('add-admin-modal').classList.add('show');
    // 清空表單
    document.getElementById('add-admin-modal').querySelectorAll('input, select').forEach(input => {
      input.value = '';
    });
  }
  
  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
  }
  
  // 點擊彈窗背景關閉
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
      e.target.classList.remove('show');
    }
  });
  
  // ========== 表單提交 ==========
  async function saveMember(event) {
    event.preventDefault();
    
    const memberData = {
      action: 'addMember',
      name: document.getElementById('member-name').value,
      memberNo: document.getElementById('member-no').value,
      email: document.getElementById('member-email').value,
      phone: document.getElementById('member-phone').value,
      gender: document.getElementById('member-gender').value,
      birthday: document.getElementById('member-birthday').value,
      address: document.getElementById('member-address').value,
      notes: document.getElementById('member-notes').value
    };
    
    const result = await callAPI(memberData);
    
    if (result.success) {
      showAlert('會員新增成功！', 'success');
      closeModal('add-member-modal');
      loadMembersData(); // 重新載入會員列表
    } else {
      showAlert('新增失敗：' + result.message, 'error');
    }
  }
  
  async function saveEvent(event) {
    event.preventDefault();
    
    const eventData = {
      action: 'addEvent',
      eventName: document.getElementById('event-name').value,
      eventType: document.getElementById('event-type').value,
      eventDate: document.getElementById('event-date').value,
      startTime: document.getElementById('event-start-time').value,
      endTime: document.getElementById('event-end-time').value,
      location: document.getElementById('event-location').value,
      description: document.getElementById('event-description').value,
      maxParticipants: document.getElementById('event-max-participants').value,
      fee: document.getElementById('event-fee').value
    };
    
    const result = await callAPI(eventData);
    
    if (result.success) {
      showAlert('活動新增成功！', 'success');
      closeModal('add-event-modal');
      loadEventsData(); // 重新載入活動列表
    } else {
      showAlert('新增失敗：' + result.message, 'error');
    }
  }
  
  async function saveDonation(event) {
    event.preventDefault();
    
    const donationData = {
      action: 'addDonation',
      donorName: document.getElementById('donation-donor-name').value,
      amount: document.getElementById('donation-amount').value,
      donationType: document.getElementById('donation-type').value,
      donationDate: document.getElementById('donation-date').value,
      paymentMethod: document.getElementById('donation-payment-method').value,
      phone: document.getElementById('donation-phone').value,
      purpose: document.getElementById('donation-purpose').value
    };
    
    const result = await callAPI(donationData);
    
    if (result.success) {
      showAlert('捐款記錄新增成功！', 'success');
      closeModal('add-donation-modal');
      loadDonationsData(); // 重新載入捐款列表
    } else {
      showAlert('新增失敗：' + result.message, 'error');
    }
  }
  
  async function saveAdmin(event) {
    event.preventDefault();
    
    const password = document.getElementById('admin-password').value;
    const confirmPassword = document.getElementById('admin-password-confirm').value;
    
    if (password !== confirmPassword) {
      showAlert('密碼與確認密碼不符！', 'error');
      return;
    }
    
    const adminData = {
      action: 'addAdmin',
      name: document.getElementById('admin-name-input').value,
      email: document.getElementById('admin-email').value,
      password: password,
      role: document.getElementById('admin-role').value,
      phone: document.getElementById('admin-phone').value
    };
    
    const result = await callAPI(adminData);
    
    if (result.success) {
      showAlert('管理員新增成功！', 'success');
      closeModal('add-admin-modal');
      loadSettings(); // 重新載入設定頁面
    } else {
      showAlert('新增失敗：' + result.message, 'error');
    }
  }
  
  // ========== 搜尋功能 ==========
  function searchMembers() {
    loadMembersData(1);
  }
  
  function searchEvents() {
    loadEventsData(1);
  }
  
  function searchHealthRecords() {
    loadHealthData(1);
  }
  
  function searchDonations() {
    loadDonationsData(1);
  }
  
  // ========== 個別操作 ==========
  async function viewMember(memberId) {
    showAlert('查看會員功能開發中...', 'info');
  }
  
  async function editMember(memberId) {
    showAlert('編輯會員功能開發中...', 'info');
  }
  
  async function deleteMember(memberId) {
    if (!confirm('確定要刪除此會員嗎？此操作無法復原。')) return;
    
    const result = await callAPI({
      action: 'deleteMember',
      memberId: memberId
    });
    
    if (result.success) {
      showAlert('會員刪除成功！', 'success');
      loadMembersData();
    } else {
      showAlert('刪除失敗：' + result.message, 'error');
    }
  }
  
  async function viewEvent(eventId) {
    showAlert('查看活動功能開發中...', 'info');
  }
  
  async function editEvent(eventId) {
    showAlert('編輯活動功能開發中...', 'info');
  }
  
  async function deleteEvent(eventId) {
    if (!confirm('確定要刪除此活動嗎？此操作無法復原。')) return;
    
    const result = await callAPI({
      action: 'deleteEvent',
      eventId: eventId
    });
    
    if (result.success) {
      showAlert('活動刪除成功！', 'success');
      loadEventsData();
    } else {
      showAlert('刪除失敗：' + result.message, 'error');
    }
  }
  
  async function viewHealthRecord(recordId) {
    showAlert('查看健康記錄功能開發中...', 'info');
  }
  
  async function deleteHealthRecord(recordId) {
    if (!confirm('確定要刪除此健康記錄嗎？此操作無法復原。')) return;
    
    const result = await callAPI({
      action: 'deleteHealthRecord',
      recordId: recordId
    });
    
    if (result.success) {
      showAlert('健康記錄刪除成功！', 'success');
      loadHealthData();
    } else {
      showAlert('刪除失敗：' + result.message, 'error');
    }
  }
  
  async function viewDonation(donationId) {
    showAlert('查看捐款記錄功能開發中...', 'info');
  }
  
  async function editDonation(donationId) {
    showAlert('編輯捐款記錄功能開發中...', 'info');
  }
  
  async function deleteDonation(donationId) {
    if (!confirm('確定要刪除此捐款記錄嗎？此操作無法復原。')) return;
    
    const result = await callAPI({
      action: 'deleteDonation',
      donationId: donationId
    });
    
    if (result.success) {
      showAlert('捐款記錄刪除成功！', 'success');
      loadDonationsData();
    } else {
      showAlert('刪除失敗：' + result.message, 'error');
    }
  }
  
  async function editAdmin(adminId) {
    showAlert('編輯管理員功能開發中...', 'info');
  }
  
  // ========== 匯出功能 ==========
  async function exportMembers() {
    try {
      showLoading(true);
      const result = await callAPI({ action: 'exportMembers' });
      
      if (result.success) {
        // 創建下載連結
        const blob = new Blob([result.data], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `會員資料_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        showAlert('會員資料匯出成功！', 'success');
      } else {
        showAlert('匯出失敗：' + result.message, 'error');
      }
    } catch (error) {
      showAlert('匯出失敗：' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }
  
  async function exportHealthData() {
    try {
      showLoading(true);
      const result = await callAPI({ action: 'exportHealthData' });
      
      if (result.success) {
        const blob = new Blob([result.data], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `健康記錄_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        showAlert('健康記錄匯出成功！', 'success');
      } else {
        showAlert('匯出失敗：' + result.message, 'error');
      }
    } catch (error) {
      showAlert('匯出失敗：' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }
  
  async function exportDonations() {
    try {
      showLoading(true);
      const result = await callAPI({ action: 'exportDonations' });
      
      if (result.success) {
        const blob = new Blob([result.data], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `捐款記錄_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        showAlert('捐款記錄匯出成功！', 'success');
      } else {
        showAlert('匯出失敗：' + result.message, 'error');
      }
    } catch (error) {
      showAlert('匯出失敗：' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }
  
  async function exportAllReports() {
    try {
      showLoading(true);
      const result = await callAPI({ action: 'exportAllReports' });
      
      if (result.success) {
        const blob = new Blob([result.data], { type: 'application/zip' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `統計報表_${new Date().toISOString().split('T')[0]}.zip`;
        link.click();
        
        showAlert('統計報表匯出成功！', 'success');
      } else {
        showAlert('匯出失敗：' + result.message, 'error');
      }
    } catch (error) {
      showAlert('匯出失敗：' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }
  
  // ========== 系統設定 ==========
  function loadSettings() {
    // 載入儲存的設定
    document.getElementById('api-url').value = localStorage.getItem('admin_API_URL') || '';
    document.getElementById('system-title').value = localStorage.getItem('admin_system_title') || '帕金森協會管理系統';
    document.getElementById('page-size').value = localStorage.getItem('admin_page_size') || '20';
    document.getElementById('backup-interval').value = localStorage.getItem('admin_backup_interval') || '24';
    document.getElementById('system-announcement').value = localStorage.getItem('admin_system_announcement') || '';
  }
  
  function saveSettings() {
    // 儲存設定到 localStorage
    const apiUrl = document.getElementById('api-url').value;
    const systemTitle = document.getElementById('system-title').value;
    const pageSizeValue = document.getElementById('page-size').value;
    const backupInterval = document.getElementById('backup-interval').value;
    const systemAnnouncement = document.getElementById('system-announcement').value;
    
    localStorage.setItem('admin_API_URL', apiUrl);
    localStorage.setItem('admin_system_title', systemTitle);
    localStorage.setItem('admin_page_size', pageSizeValue);
    localStorage.setItem('admin_backup_interval', backupInterval);
    localStorage.setItem('admin_system_announcement', systemAnnouncement);
    
    // 更新全域變數
    API_URL = apiUrl;
    pageSize = parseInt(pageSizeValue);
    
    showAlert('設定儲存成功！', 'success');
  }
  
  async function exportData() {
    try {
      showLoading(true);
      const result = await callAPI({ action: 'exportAllData' });
      
      if (result.success) {
        const blob = new Blob([result.data], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `系統資料備份_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        showAlert('資料匯出成功！', 'success');
      } else {
        showAlert('匯出失敗：' + result.message, 'error');
      }
    } catch (error) {
      showAlert('匯出失敗：' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }
  
  async function backupData() {
    try {
      showLoading(true);
      const result = await callAPI({ action: 'backupData' });
      
      if (result.success) {
        showAlert('資料備份成功！', 'success');
      } else {
        showAlert('備份失敗：' + result.message, 'error');
      }
    } catch (error) {
      showAlert('備份失敗：' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }
  
  function clearCache() {
    if (!confirm('確定要清除所有快取嗎？此操作會清除已儲存的設定。')) return;
    
    // 保留必要的登入資訊
    const adminInfo = localStorage.getItem('adminInfo');
    
    // 清除所有 localStorage
    localStorage.clear();
    
    // 恢復登入資訊
    if (adminInfo) {
      localStorage.setItem('adminInfo', adminInfo);
    }
    
    showAlert('快取清除成功！請重新設定系統參數。', 'success');
    
    // 重新載入設定
    loadSettings();
  }
  
  // ========== 登出功能 ==========
  function logout() {
    if (!confirm('確定要登出嗎？')) return;
    
    // 清除登入資訊
    localStorage.removeItem('adminInfo');
    
    // 跳轉到登入頁面
    alert('已成功登出！');
    window.location.href = 'admin-login.html';
  }
  
  // ========== 鍵盤快捷鍵 ==========
  document.addEventListener('keydown', function(e) {
    // ESC 關閉彈窗
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal.show').forEach(modal => {
        modal.classList.remove('show');
      });
    }
    
    // Ctrl+S 儲存設定 (在設定頁面)
    if (e.ctrlKey && e.key === 's' && currentSection === 'settings') {
      e.preventDefault();
      saveSettings();
    }
  });
  
  // ========== 自動重新整理 ==========
  setInterval(() => {
    // 每 5 分鐘自動重新載入當前頁面資料
    if (currentSection === 'dashboard') {
      loadDashboardData();
    }
  }, 5 * 60 * 1000);
  
  // ========== 錯誤處理 ==========
  window.addEventListener('error', function(e) {
    console.error('全域錯誤:', e.error);
    showAlert('系統發生錯誤，請重新整理頁面', 'error');
  });
  
  window.addEventListener('unhandledrejection', function(e) {
    console.error('未處理的 Promise 錯誤:', e.reason);
    showAlert('系統發生錯誤，請檢查網路連線', 'error');
  });
</script>
</body>
</html>
