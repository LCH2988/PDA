<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友會 - 管理後台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
  <style>
    :root {
      --primary-color: #00B900;
      --secondary-color: #06C755;
      --sidebar-width: 250px;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
    }
    
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: var(--sidebar-width);
      background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
      padding: 20px 0;
      overflow-y: auto;
      z-index: 1000;
    }
    
    .sidebar-brand {
      color: white;
      font-size: 1.5rem;
      font-weight: bold;
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      margin-bottom: 20px;
    }
    
    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .sidebar-menu-item {
      padding: 12px 20px;
      color: rgba(255,255,255,0.8);
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
    }
    
    .sidebar-menu-item:hover,
    .sidebar-menu-item.active {
      background-color: rgba(255,255,255,0.2);
      color: white;
    }
    
    .sidebar-menu-item i {
      margin-right: 10px;
      font-size: 1.2rem;
    }
    
    .main-content {
      margin-left: var(--sidebar-width);
      padding: 30px;
    }
    
    .top-bar {
      background: white;
      padding: 15px 30px;
      margin: -30px -30px 30px -30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      transition: transform 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      margin-bottom: 15px;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #212529;
    }
    
    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
    }
    
    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .card-header {
      background: white;
      border-bottom: 2px solid #e9ecef;
      font-weight: bold;
      padding: 20px;
      border-radius: 15px 15px 0 0 !important;
    }
    
    .table-responsive {
      border-radius: 10px;
    }
    
    .table {
      margin-bottom: 0;
    }
    
    .table thead th {
      border-bottom: 2px solid #dee2e6;
      font-weight: 600;
      color: #495057;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none;
      border-radius: 25px;
      padding: 8px 20px;
    }
    
    .btn-primary:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0,185,0,0.3);
    }
    
    .badge {
      padding: 5px 12px;
      border-radius: 20px;
    }
    
    .modal-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
    }
    
    .form-label {
      font-weight: 600;
      color: #495057;
    }
    
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s;
      }
      
      .sidebar.show {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <!-- 側邊欄 -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <i class="bi bi-heart-pulse"></i> 管理後台
    </div>
    <ul class="sidebar-menu">
      <li class="sidebar-menu-item active" onclick="showPage('dashboard')">
        <i class="bi bi-speedometer2"></i> 儀表板
      </li>
      <li class="sidebar-menu-item" onclick="showPage('members')">
        <i class="bi bi-people"></i> 會員管理
      </li>
      <li class="sidebar-menu-item" onclick="showPage('activities')">
        <i class="bi bi-calendar-event"></i> 活動管理
      </li>
      <li class="sidebar-menu-item" onclick="showPage('registrations')">
        <i class="bi bi-list-check"></i> 報名管理
      </li>
      <li class="sidebar-menu-item" onclick="showPage('volunteers')">
        <i class="bi bi-heart"></i> 志工管理
      </li>
      <li class="sidebar-menu-item" onclick="showPage('finance')">
        <i class="bi bi-cash-stack"></i> 財務管理
      </li>
      <li class="sidebar-menu-item" onclick="showPage('statistics')">
        <i class="bi bi-graph-up"></i> 統計報表
      </li>
      <li class="sidebar-menu-item" onclick="showPage('settings')">
        <i class="bi bi-gear"></i> 系統設定
      </li>
    </ul>
  </div>

  <!-- 主要內容 -->
  <div class="main-content">
    <!-- 頂部欄 -->
    <div class="top-bar">
      <div>
        <button class="btn btn-outline-secondary d-md-none" onclick="toggleSidebar()">
          <i class="bi bi-list"></i>
        </button>
        <span class="ms-3" id="pageTitle">儀表板</span>
      </div>
      <div>
        <span class="me-3" id="adminName">管理員</span>
        <button class="btn btn-sm btn-outline-danger" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i> 登出
        </button>
      </div>
    </div>

    <!-- 儀表板頁面 -->
    <div id="dashboardPage">
      <h2 class="mb-4">系統概覽</h2>
      
      <!-- 統計卡片 -->
      <div class="row">
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-primary bg-opacity-10 text-primary">
              <i class="bi bi-people"></i>
            </div>
            <div class="stat-value" id="totalMembers">0</div>
            <div class="stat-label">總會員數</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-success bg-opacity-10 text-success">
              <i class="bi bi-calendar-event"></i>
            </div>
            <div class="stat-value" id="totalActivities">0</div>
            <div class="stat-label">總活動數</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-warning bg-opacity-10 text-warning">
              <i class="bi bi-heart"></i>
            </div>
            <div class="stat-value" id="totalVolunteerHours">0</div>
            <div class="stat-label">志工總時數</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-info bg-opacity-10 text-info">
              <i class="bi bi-cash-stack"></i>
            </div>
            <div class="stat-value" id="financeBalance">0</div>
            <div class="stat-label">財務餘額</div>
          </div>
        </div>
      </div>

      <!-- 圖表 -->
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">會員類型分布</div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="memberTypeChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">活動狀態統計</div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="activityStatusChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 最近活動 -->
      <div class="card">
        <div class="card-header">最近活動</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="recentActivitiesTable">
              <thead>
                <tr>
                  <th>活動名稱</th>
                  <th>日期</th>
                  <th>地點</th>
                  <th>報名人數</th>
                  <th>狀態</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="5" class="text-center text-muted">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 會員管理頁面 -->
    <div id="membersPage" style="display:none;">
      <h2 class="mb-4">會員管理</h2>
      
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>會員列表</span>
          <div>
            <input type="text" class="form-control d-inline-block w-auto me-2" id="memberSearch" placeholder="搜尋會員...">
            <button class="btn btn-primary" onclick="searchMembers()">
              <i class="bi bi-search"></i> 搜尋
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="membersTable">
              <thead>
                <tr>
                  <th>姓名</th>
                  <th>電話</th>
                  <th>會員類型</th>
                  <th>角色</th>
                  <th>狀態</th>
                  <th>註冊日期</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="7" class="text-center text-muted">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 活動管理頁面 -->
    <div id="activitiesPage" style="display:none;">
      <h2 class="mb-4">活動管理</h2>
      
      <button class="btn btn-primary mb-3" onclick="showCreateActivityModal()">
        <i class="bi bi-plus-circle"></i> 新增活動
      </button>

      <div class="card">
        <div class="card-header">活動列表</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="activitiesTable">
              <thead>
                <tr>
                  <th>活動名稱</th>
                  <th>日期</th>
                  <th>地點</th>
                  <th>類型</th>
                  <th>報名人數</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="7" class="text-center text-muted">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 報名管理頁面 -->
    <div id="registrationsPage" style="display:none;">
      <h2 class="mb-4">報名管理</h2>
      
      <div class="card">
        <div class="card-header">
          <div class="row">
            <div class="col-md-6">報名列表</div>
            <div class="col-md-6 text-end">
              <select class="form-select d-inline-block w-auto" id="regActivityFilter" onchange="filterRegistrations()">
                <option value="">所有活動</option>
              </select>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="registrationsTable">
              <thead>
                <tr>
                  <th>活動名稱</th>
                  <th>會員姓名</th>
                  <th>電話</th>
                  <th>報名時間</th>
                  <th>簽到時間</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="7" class="text-center text-muted">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 志工管理頁面 -->
    <div id="volunteersPage" style="display:none;">
      <h2 class="mb-4">志工管理</h2>
      
      <div class="row mb-3">
        <div class="col-md-4">
          <div class="stat-card">
            <h5>待審核記錄</h5>
            <div class="stat-value text-warning" id="pendingVolunteerRecords">0</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card">
            <h5>總志工人數</h5>
            <div class="stat-value text-success" id="totalVolunteers">0</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card">
            <h5>總服務時數</h5>
            <div class="stat-value text-info" id="totalVolunteerHoursDetail">0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">志工服務記錄</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="volunteersTable">
              <thead>
                <tr>
                  <th>志工姓名</th>
                  <th>服務日期</th>
                  <th>服務時數</th>
                  <th>服務項目</th>
                  <th>狀態</th>
                  <th>審核者</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="7" class="text-center text-muted">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 財務管理頁面 -->
    <div id="financePage" style="display:none;">
      <h2 class="mb-4">財務管理</h2>
      
      <div class="row mb-3">
        <div class="col-md-4">
          <div class="stat-card">
            <h5>總收入</h5>
            <div class="stat-value text-success" id="totalIncome">0</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card">
            <h5>總支出</h5>
            <div class="stat-value text-danger" id="totalExpense">0</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card">
            <h5>餘額</h5>
            <div class="stat-value text-primary" id="balance">0</div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>捐款記錄</span>
              <button class="btn btn-sm btn-primary" onclick="showAddDonationModal()">
                <i class="bi bi-plus"></i> 新增
              </button>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-sm" id="donationsTable">
                  <thead>
                    <tr>
                      <th>捐款人</th>
                      <th>金額</th>
                      <th>日期</th>
                      <th>方式</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="4" class="text-center text-muted">載入中...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>支出記錄</span>
              <button class="btn btn-sm btn-primary" onclick="showAddExpenseModal()">
                <i class="bi bi-plus"></i> 新增
              </button>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-sm" id="expensesTable">
                  <thead>
                    <tr>
                      <th>項目</th>
                      <th>金額</th>
                      <th>日期</th>
                      <th>狀態</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="5" class="text-center text-muted">載入中...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 統計報表頁面 -->
    <div id="statisticsPage" style="display:none;">
      <h2 class="mb-4">統計報表</h2>
      
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">月度活動統計</div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="monthlyActivityChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">會員成長趨勢</div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="memberGrowthChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">志工服務統計</div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="volunteerStatsChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">財務收支統計</div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="financeStatsChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 系統設定頁面 -->
    <div id="settingsPage" style="display:none;">
      <h2 class="mb-4">系統設定</h2>
      
      <div class="card">
        <div class="card-header">基本設定</div>
        <div class="card-body">
          <form id="settingsForm">
            <div class="mb-3">
              <label class="form-label">組織名稱</label>
              <input type="text" class="form-control" id="orgName" value="帕金森病友會">
            </div>
            <div class="mb-3">
              <label class="form-label">聯絡電話</label>
              <input type="tel" class="form-control" id="orgPhone">
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="orgEmail">
            </div>
            <div class="mb-3">
              <label class="form-label">地址</label>
              <input type="text" class="form-control" id="orgAddress">
            </div>
            <button type="button" class="btn btn-primary" onclick="saveSettings()">
              <i class="bi bi-save"></i> 儲存設定
            </button>
          </form>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header">資料備份</div>
        <div class="card-body">
          <p>定期備份系統資料以確保資料安全</p>
          <button class="btn btn-success" onclick="backupData()">
            <i class="bi bi-download"></i> 立即備份
          </button>
          <p class="mt-3 text-muted">上次備份時間：<span id="lastBackupTime">未備份</span></p>
        </div>
      </div>
    </div>
  </div>

  <!-- 新增活動 Modal -->
  <div class="modal fade" id="createActivityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增活動</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="createActivityForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">活動名稱 *</label>
                <input type="text" class="form-control" id="actTitle" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">活動類型 *</label>
                <select class="form-select" id="actType" required>
                  <option value="講座">講座</option>
                  <option value="運動課程">運動課程</option>
                  <option value="聚會">聚會</option>
                  <option value="義診">義診</option>
                  <option value="其他">其他</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">活動日期 *</label>
                <input type="date" class="form-control" id="actDate" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">活動時間 *</label>
                <input type="text" class="form-control" id="actTime" placeholder="例：14:00-16:00" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">活動地點 *</label>
              <input type="text" class="form-control" id="actLocation" required>
            </div>
            <div class="mb-3">
              <label class="form-label">活動說明</label>
              <textarea class="form-control" id="actDescription" rows="3"></textarea>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">人數上限</label>
                <input type="number" class="form-control" id="actMaxParticipants" min="0">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">活動費用</label>
                <input type="number" class="form-control" id="actFee" min="0" value="0">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">報名截止日</label>
                <input type="date" class="form-control" id="actDeadline">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">注意事項</label>
              <textarea class="form-control" id="actNote" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitCreateActivity()">建立活動</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 編輯會員 Modal -->
  <div class="modal fade" id="editMemberModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">編輯會員</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editMemberForm">
            <input type="hidden" id="editMemberId">
            <div class="mb-3">
              <label class="form-label">角色</label>
              <select class="form-select" id="editMemberRole">
                <option value="member">一般會員</option>
                <option value="volunteer">志工</option>
                <option value="manager">管理員</option>
                <option value="finance">財務</option>
                <option value="admin">系統管理員</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">狀態</label>
              <select class="form-select" id="editMemberStatus">
                <option value="active">啟用</option>
                <option value="inactive">停用</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitEditMember()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 審核志工記錄 Modal -->
  <div class="modal fade" id="approveVolunteerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">審核志工記錄</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="approveRecordId">
          <div id="volunteerRecordDetail"></div>
          <div class="mb-3">
            <label class="form-label">審核意見</label>
            <textarea class="form-control" id="approveNote" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-danger" onclick="rejectVolunteerRecord()">拒絕</button>
          <button type="button" class="btn btn-success" onclick="approveVolunteerRecord()">通過</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 新增捐款 Modal -->
  <div class="modal fade" id="addDonationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增捐款記錄</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addDonationForm">
            <div class="mb-3">
              <label class="form-label">捐款人 *</label>
              <input type="text" class="form-control" id="donorName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">捐款金額 *</label>
              <input type="number" class="form-control" id="donationAmount" min="1" required>
            </div>
            <div class="mb-3">
              <label class="form-label">捐款日期 *</label>
              <input type="date" class="form-control" id="donationDate" required>
            </div>
            <div class="mb-3">
              <label class="form-label">捐款方式</label>
              <select class="form-select" id="donationMethod">
                <option value="現金">現金</option>
                <option value="轉帳">轉帳</option>
                <option value="支票">支票</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">備註</label>
              <textarea class="form-control" id="donationNote" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitAddDonation()">新增</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 新增支出 Modal -->
  <div class="modal fade" id="addExpenseModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增支出記錄</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addExpenseForm">
            <div class="mb-3">
              <label class="form-label">支出項目 *</label>
              <input type="text" class="form-control" id="expenseItem" required>
            </div>
            <div class="mb-3">
              <label class="form-label">支出金額 *</label>
              <input type="number" class="form-control" id="expenseAmount" min="1" required>
            </div>
            <div class="mb-3">
              <label class="form-label">支出日期 *</label>
              <input type="date" class="form-control" id="expenseDate" required>
            </div>
            <div class="mb-3">
              <label class="form-label">支出類別</label>
              <select class="form-select" id="expenseCategory">
                <option value="活動費用">活動費用</option>
                <option value="場地租金">場地租金</option>
                <option value="設備購置">設備購置</option>
                <option value="行政費用">行政費用</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">經手人</label>
              <input type="text" class="form-control" id="expenseHandler">
            </div>
            <div class="mb-3">
              <label class="form-label">備註</label>
              <textarea class="form-control" id="expenseNote" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitAddExpense()">新增</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==================== 配置 ====================
    const CONFIG = {
      API_URL: 'https://script.google.com/macros/s/AKfycby5f7LinXNkYd7NM7o3Cr9HVEYfmpL-NT-utI-jjdUcaozR2ZePq9PvMg6tSA8FSl0uXw/exec',
      API_KEY: 'AAbb520258185202581'
    };

    let currentPage = 'dashboard';
    let currentAdmin = null;
    let allMembers = [];
    let allActivities = [];
    let allRegistrations = [];
    let allVolunteerRecords = [];

    // ==================== 初始化 ====================
    window.onload = function() {
      checkAuth();
      loadDashboard();
    };

    function checkAuth() {
      const adminData = localStorage.getItem('adminData');
      if (!adminData) {
        window.location.href = 'login.html';
        return;
      }
      currentAdmin = JSON.parse(adminData);
      document.getElementById('adminName').textContent = currentAdmin.name;
    }

    function logout() {
      localStorage.removeItem('adminData');
      window.location.href = 'login.html';
    }

    // ==================== API 呼叫 ====================
    async function apiCall(action, data = {}) {
      try {
        const requestData = {
          action: action,
          apiKey: CONFIG.API_KEY,
          adminId: currentAdmin?.id,
          ...data
        };

        const response = await fetch(CONFIG.API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestData)
        });

        const result = await response.json();
        
        if (result.success) {
          return result.data;
        } else {
          throw new Error(result.data.message || '操作失敗');
        }
      } catch (error) {
        console.error('API 呼叫失敗:', error);
        throw error;
      }
    }

    // ==================== 頁面切換 ====================
    function showPage(pageName) {
      document.querySelectorAll('[id$="Page"]').forEach(page => {
        page.style.display = 'none';
      });

      document.querySelectorAll('.sidebar-menu-item').forEach(item => {
        item.classList.remove('active');
      });

      const pageMap = {
        'dashboard': { id: 'dashboardPage', title: '儀表板' },
        'members': { id: 'membersPage', title: '會員管理' },
        'activities': { id: 'activitiesPage', title: '活動管理' },
        'registrations': { id: 'registrationsPage', title: '報名管理' },
        'volunteers': { id: 'volunteersPage', title: '志工管理' },
        'finance': { id: 'financePage', title: '財務管理' },
        'statistics': { id: 'statisticsPage', title: '統計報表' },
        'settings': { id: 'settingsPage', title: '系統設定' }
      };

      const pageInfo = pageMap[pageName];
      if (pageInfo) {
        document.getElementById(pageInfo.id).style.display = 'block';
        document.getElementById('pageTitle').textContent = pageInfo.title;
        event.target.classList.add('active');
        currentPage = pageName;

        loadPageData(pageName);
      }
    }

    async function loadPageData(pageName) {
      switch(pageName) {
        case 'dashboard':
          await loadDashboard();
          break;
        case 'members':
          await loadMembers();
          break;
        case 'activities':
          await loadActivitiesManagement();
          break;
        case 'registrations':
          await loadRegistrations();
          break;
        case 'volunteers':
          await loadVolunteers();
          break;
        case 'finance':
          await loadFinance();
          break;
        case 'statistics':
          await loadStatistics();
          break;
      }
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('show');
    }

    // ==================== 儀表板 ====================
    async function loadDashboard() {
      try {
        const data = await apiCall('getAdminDashboard');
        
        document.getElementById('totalMembers').textContent = data.totalMembers;
        document.getElementById('totalActivities').textContent = data.totalActivities;
        document.getElementById('totalVolunteerHours').textContent = data.totalVolunteerHours;
        document.getElementById('financeBalance').textContent = 'NT$ ' + data.financeBalance.toLocaleString();

        // 會員類型分布圖
        if (data.memberTypeStats) {
          createPieChart('memberTypeChart', data.memberTypeStats);
        }

        // 活動狀態統計圖
        if (data.activityStatusStats) {
          createPieChart('activityStatusChart', data.activityStatusStats);
        }

        // 最近活動表格
        const tbody = document.querySelector('#recentActivitiesTable tbody');
        if (data.recentActivities && data.recentActivities.length > 0) {
          tbody.innerHTML = data.recentActivities.map(activity => `
            <tr>
              <td>${activity.title}</td>
              <td>${formatDate(activity.date)}</td>
              <td>${activity.location}</td>
              <td>${activity.currentParticipants}/${activity.maxParticipants || '不限'}</td>
              <td><span class="badge bg-${getStatusColor(activity.status)}">${activity.status}</span></td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">暫無資料</td></tr>';
        }

      } catch (error) {
        console.error('載入儀表板失敗:', error);
        showAlert('載入儀表板失敗', 'danger');
      }
    }

    // ==================== 會員管理 ====================
    async function loadMembers() {
      try {
        const data = await apiCall('getAllMembers');
        allMembers = data.data;
        displayMembers(allMembers);
      } catch (error) {
        console.error('載入會員失敗:', error);
        showAlert('載入會員失敗', 'danger');
      }
    }

    function displayMembers(members) {
      const tbody = document.querySelector('#membersTable tbody');
      
      if (members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暫無會員資料</td></tr>';
        return;
      }

      tbody.innerHTML = members.map(member => `
        <tr>
          <td>${member.realName || member.lineName}</td>
          <td>${member.phone || '-'}</td>
          <td>${member.memberType}</td>
          <td><span class="badge bg-info">${getRoleText(member.role)}</span></td>
          <td><span class="badge bg-${member.status === 'active' ? 'success' : 'secondary'}">${member.status === 'active' ? '啟用' : '停用'}</span></td>
          <td>${formatDate(member.createdAt)}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="viewMemberDetail('${member.id}')">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-warning" onclick="editMember('${member.id}')">
              <i class="bi bi-pencil"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    function searchMembers() {
      const searchText = document.getElementById('memberSearch').value.toLowerCase();
      const filtered = allMembers.filter(member => {
        return (member.realName && member.realName.toLowerCase().includes(searchText)) ||
               (member.lineName && member.lineName.toLowerCase().includes(searchText)) ||
               (member.phone && member.phone.includes(searchText));
      });
      displayMembers(filtered);
    }

    function editMember(memberId) {
      const member = allMembers.find(m => m.id === memberId);
      if (!member) return;

      document.getElementById('editMemberId').value = member.id;
      document.getElementById('editMemberRole').value = member.role || 'member';
      document.getElementById('editMemberStatus').value = member.status || 'active';

      new bootstrap.Modal(document.getElementById('editMemberModal')).show();
    }

    async function submitEditMember() {
      try {
        await apiCall('updateMemberRole', {
          memberId: document.getElementById('editMemberId').value,
          role: document.getElementById('editMemberRole').value,
          status: document.getElementById('editMemberStatus').value
        });

        showAlert('會員資料已更新', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editMemberModal')).hide();
        loadMembers();
      } catch (error) {
        console.error('更新會員失敗:', error);
        showAlert(error.message || '更新失敗', 'danger');
      }
    }

    function viewMemberDetail(memberId) {
      const member = allMembers.find(m => m.id === memberId);
      if (!member) return;
      
      alert(`會員詳情：\n姓名：${member.realName}\n電話：${member.phone}\nEmail：${member.email}\n地址：${member.address}`);
    }

    // ==================== 活動管理 ====================
    async function loadActivitiesManagement() {
      try {
        const data = await apiCall('getAllActivities');
        allActivities = data.data;
        displayActivitiesManagement(allActivities);
      } catch (error) {
        console.error('載入活動失敗:', error);
        showAlert('載入活動失敗', 'danger');
      }
    }

    function displayActivitiesManagement(activities) {
      const tbody = document.querySelector('#activitiesTable tbody');
      
      if (activities.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暫無活動資料</td></tr>';
        return;
      }

      tbody.innerHTML = activities.map(activity => `
        <tr>
          <td>${activity.title}</td>
          <td>${formatDate(activity.date)}</td>
          <td>${activity.location}</td>
          <td>${activity.type}</td>
          <td>${activity.currentParticipants}/${activity.maxParticipants || '不限'}</td>
          <td><span class="badge bg-${getStatusColor(activity.status)}">${activity.status}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="viewActivityDetail('${activity.id}')">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-warning" onclick="editActivity('${activity.id}')">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteActivity('${activity.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    function showCreateActivityModal() {
      document.getElementById('createActivityForm').reset();
      new bootstrap.Modal(document.getElementById('createActivityModal')).show();
    }

    async function submitCreateActivity() {
      const form = document.getElementById('createActivityForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      try {
        await apiCall('createActivity', {
          activityData: {
            title: document.getElementById('actTitle').value,
            type: document.getElementById('actType').value,
            date: document.getElementById('actDate').value,
            time: document.getElementById('actTime').value,
            location: document.getElementById('actLocation').value,
            description: document.getElementById('actDescription').value,
            maxParticipants: parseInt(document.getElementById('actMaxParticipants').value) || 0,
            fee: parseFloat(document.getElementById('actFee').value) || 0,
            registrationDeadline: document.getElementById('actDeadline').value,
            note: document.getElementById('actNote').value
          }
        });

        showAlert('活動已建立', 'success');
        bootstrap.Modal.getInstance(document.getElementById('createActivityModal')).hide();
        loadActivitiesManagement();
      } catch (error) {
        console.error('建立活動失敗:', error);
        showAlert(error.message || '建立失敗', 'danger');
      }
    }

    function viewActivityDetail(activityId) {
      const activity = allActivities.find(a => a.id === activityId);
      if (!activity) return;
      
      alert(`活動詳情：\n名稱：${activity.title}\n日期：${activity.date}\n地點：${activity.location}\n說明：${activity.description}`);
    }

    function editActivity(activityId) {
      alert('編輯活動功能開發中');
    }

    async function deleteActivity(activityId) {
      if (!confirm('確定要刪除此活動嗎？')) return;

      try {
        await apiCall('deleteActivity', { activityId });
        showAlert('活動已刪除', 'success');
        loadActivitiesManagement();
      } catch (error) {
        console.error('刪除活動失敗:', error);
        showAlert(error.message || '刪除失敗', 'danger');
      }
    }

    // ==================== 報名管理 ====================
    async function loadRegistrations() {
      try {
        const data = await apiCall('getAllRegistrations');
        allRegistrations = data.data;
        
        // 填充活動篩選器
        const activityFilter = document.getElementById('regActivityFilter');
        const uniqueActivities = [...new Set(allRegistrations.map(r => r.activityTitle))];
        activityFilter.innerHTML = '<option value="">所有活動</option>' + 
          uniqueActivities.map(title => `<option value="${title}">${title}</option>`).join('');

        displayRegistrations(allRegistrations);
      } catch (error) {
        console.error('載入報名記錄失敗:', error);
        showAlert('載入報名記錄失敗', 'danger');
      }
    }

    function displayRegistrations(registrations) {
      const tbody = document.querySelector('#registrationsTable tbody');
      
      if (registrations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暫無報名資料</td></tr>';
        return;
      }

      tbody.innerHTML = registrations.map(reg => `
        <tr>
          <td>${reg.activityTitle}</td>
          <td>${reg.memberName}</td>
          <td>${reg.memberPhone}</td>
          <td>${formatDateTime(reg.registeredAt)}</td>
          <td>${reg.checkInAt ? formatDateTime(reg.checkInAt) : '-'}</td>
          <td><span class="badge bg-${getRegistrationStatusColor(reg.status)}">${reg.status}</span></td>
          <td>
            ${reg.status === '已報名' ? `
              <button class="btn btn-sm btn-success" onclick="checkInRegistration('${reg.id}')">
                <i class="bi bi-check"></i> 簽到
              </button>
            ` : ''}
          </td>
        </tr>
      `).join('');
    }

    function filterRegistrations() {
      const activityTitle = document.getElementById('regActivityFilter').value;
      const filtered = activityTitle ? 
        allRegistrations.filter(r => r.activityTitle === activityTitle) : 
        allRegistrations;
      displayRegistrations(filtered);
    }

    async function checkInRegistration(registrationId) {
      if (!confirm('確定要為此會員簽到嗎？')) return;

      try {
        await apiCall('checkInRegistration', { registrationId });
        showAlert('簽到成功', 'success');
        loadRegistrations();
      } catch (error) {
        console.error('簽到失敗:', error);
        showAlert(error.message || '簽到失敗', 'danger');
      }
    }

    // ==================== 志工管理 ====================
    async function loadVolunteers() {
      try {
        const data = await apiCall('getAllVolunteerRecords');
        allVolunteerRecords = data.data;
        
        const pending = allVolunteerRecords.filter(r => r.status === '待審核').length;
        const volunteers = [...new Set(allVolunteerRecords.map(r => r.memberId))].length;
        const totalHours = allVolunteerRecords
          .filter(r => r.status === '已審核')
          .reduce((sum, r) => sum + r.hours, 0);

        document.getElementById('pendingVolunteerRecords').textContent = pending;
        document.getElementById('totalVolunteers').textContent = volunteers;
        document.getElementById('totalVolunteerHoursDetail').textContent = totalHours;

        displayVolunteerRecords(allVolunteerRecords);
      } catch (error) {
        console.error('載入志工記錄失敗:', error);
        showAlert('載入志工記錄失敗', 'danger');
      }
    }

    function displayVolunteerRecords(records) {
      const tbody = document.querySelector('#volunteersTable tbody');
      
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暫無志工記錄</td></tr>';
        return;
      }

      tbody.innerHTML = records.map(record => `
        <tr>
          <td>${record.memberName}</td>
          <td>${formatDate(record.date)}</td>
          <td>${record.hours}</td>
          <td>${record.activity}</td>
          <td><span class="badge bg-${getVolunteerStatusColor(record.status)}">${record.status}</span></td>
          <td>${record.approver || '-'}</td>
          <td>
            ${record.status === '待審核' ? `
              <button class="btn btn-sm btn-primary" onclick="showApproveModal('${record.id}')">
                <i class="bi bi-check-circle"></i> 審核
              </button>
            ` : ''}
          </td>
        </tr>
      `).join('');
    }

    function showApproveModal(recordId) {
      const record = allVolunteerRecords.find(r => r.id === recordId);
      if (!record) return;

      document.getElementById('approveRecordId').value = recordId;
      document.getElementById('volunteerRecordDetail').innerHTML = `
        <p><strong>志工：</strong>${record.memberName}</p>
        <p><strong>服務日期：</strong>${formatDate(record.date)}</p>
        <p><strong>服務時數：</strong>${record.hours} 小時</p>
        <p><strong>服務項目：</strong>${record.activity}</p>
        <p><strong>服務內容：</strong>${record.description || '無'}</p>
      `;

      new bootstrap.Modal(document.getElementById('approveVolunteerModal')).show();
    }

    async function approveVolunteerRecord() {
      const recordId = document.getElementById('approveRecordId').value;
      const note = document.getElementById('approveNote').value;

      try {
        await apiCall('approveVolunteerRecord', {
          recordId,
          approved: true,
          note
        });

        showAlert('已通過審核', 'success');
        bootstrap.Modal.getInstance(document.getElementById('approveVolunteerModal')).hide();
        loadVolunteers();
      } catch (error) {
        console.error('審核失敗:', error);
        showAlert(error.message || '審核失敗', 'danger');
      }
    }

    async function rejectVolunteerRecord() {
      const recordId = document.getElementById('approveRecordId').value;
      const note = document.getElementById('approveNote').value;

      if (!note) {
        alert('請填寫拒絕原因');
        return;
      }

      try {
        await apiCall('approveVolunteerRecord', {
          recordId,
          approved: false,
          note
        });

        showAlert('已拒絕此記錄', 'warning');
        bootstrap.Modal.getInstance(document.getElementById('approveVolunteerModal')).hide();
        loadVolunteers();
      } catch (error) {
        console.error('操作失敗:', error);
        showAlert(error.message || '操作失敗', 'danger');
      }
    }

    // ==================== 財務管理 ====================
    async function loadFinance() {
      try {
        const data = await apiCall('getFinanceData');
        
        document.getElementById('totalIncome').textContent = 'NT$ ' + data.totalIncome.toLocaleString();
        document.getElementById('totalExpense').textContent = 'NT$ ' + data.totalExpense.toLocaleString();
        document.getElementById('balance').textContent = 'NT$ ' + data.balance.toLocaleString();

        // 捐款記錄
        const donationsTbody = document.querySelector('#donationsTable tbody');
        if (data.donations && data.donations.length > 0) {
          donationsTbody.innerHTML = data.donations.slice(0, 10).map(d => `
            <tr>
              <td>${d.donorName}</td>
              <td>NT$ ${d.amount.toLocaleString()}</td>
              <td>${formatDate(d.date)}</td>
              <td>${d.method}</td>
            </tr>
          `).join('');
        } else {
          donationsTbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">暫無資料</td></tr>';
        }

        // 支出記錄
        const expensesTbody = document.querySelector('#expensesTable tbody');
        if (data.expenses && data.expenses.length > 0) {
          expensesTbody.innerHTML = data.expenses.slice(0, 10).map(e => `
            <tr>
              <td>${e.item}</td>
              <td>NT$ ${e.amount.toLocaleString()}</td>
              <td>${formatDate(e.date)}</td>
              <td><span class="badge bg-${e.status === '已核准' ? 'success' : 'warning'}">${e.status}</span></td>
              <td>
                ${e.status === '待審核' ? `
                  <button class="btn btn-sm btn-success" onclick="approveExpense('${e.id}')">
                    <i class="bi bi-check"></i>
                  </button>
                ` : ''}
              </td>
            </tr>
          `).join('');
        } else {
          expensesTbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">暫無資料</td></tr>';
        }

      } catch (error) {
        console.error('載入財務資料失敗:', error);
        showAlert('載入財務資料失敗', 'danger');
      }
    }

    function showAddDonationModal() {
      document.getElementById('addDonationForm').reset();
      document.getElementById('donationDate').valueAsDate = new Date();
      new bootstrap.Modal(document.getElementById('addDonationModal')).show();
    }

    async function submitAddDonation() {
      const form = document.getElementById('addDonationForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      try {
        await apiCall('addDonation', {
          donationData: {
            donorName: document.getElementById('donorName').value,
            amount: parseFloat(document.getElementById('donationAmount').value),
            date: document.getElementById('donationDate').value,
            method: document.getElementById('donationMethod').value,
            note: document.getElementById('donationNote').value
          }
        });

        showAlert('捐款記錄已新增', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addDonationModal')).hide();
        loadFinance();
      } catch (error) {
        console.error('新增捐款失敗:', error);
        showAlert(error.message || '新增失敗', 'danger');
      }
    }

    function showAddExpenseModal() {
      document.getElementById('addExpenseForm').reset();
      document.getElementById('expenseDate').valueAsDate = new Date();
      new bootstrap.Modal(document.getElementById('addExpenseModal')).show();
    }

    async function submitAddExpense() {
      const form = document.getElementById('addExpenseForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      try {
        await apiCall('addExpense', {
          expenseData: {
            item: document.getElementById('expenseItem').value,
            amount: parseFloat(document.getElementById('expenseAmount').value),
            date: document.getElementById('expenseDate').value,
            category: document.getElementById('expenseCategory').value,
            handler: document.getElementById('expenseHandler').value,
            note: document.getElementById('expenseNote').value
          }
        });

        showAlert('支出記錄已新增', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addExpenseModal')).hide();
        loadFinance();
      } catch (error) {
        console.error('新增支出失敗:', error);
        showAlert(error.message || '新增失敗', 'danger');
      }
    }

    async function approveExpense(expenseId) {
      if (!confirm('確定要核准此支出嗎？')) return;

      try {
        await apiCall('approveExpense', { expenseId });
        showAlert('支出已核准', 'success');
        loadFinance();
      } catch (error) {
        console.error('核准失敗:', error);
        showAlert(error.message || '核准失敗', 'danger');
      }
    }

    // ==================== 統計報表 ====================
    async function loadStatistics() {
      try {
        const data = await apiCall('getStatistics');

        // 月度活動統計
        if (data.monthlyActivity) {
          createLineChart('monthlyActivityChart', data.monthlyActivity);
        }

        // 會員成長趨勢
        if (data.memberGrowth) {
          createLineChart('memberGrowthChart', data.memberGrowth);
        }

        // 志工服務統計
        if (data.volunteerStats) {
          createBarChart('volunteerStatsChart', data.volunteerStats);
        }

        // 財務收支統計
        if (data.financeStats) {
          createBarChart('financeStatsChart', data.financeStats);
        }

      } catch (error) {
        console.error('載入統計資料失敗:', error);
        showAlert('載入統計資料失敗', 'danger');
      }
    }

    // ==================== 系統設定 ====================
    async function saveSettings() {
      try {
        await apiCall('saveSettings', {
          settings: {
            orgName: document.getElementById('orgName').value,
            orgPhone: document.getElementById('orgPhone').value,
            orgEmail: document.getElementById('orgEmail').value,
            orgAddress: document.getElementById('orgAddress').value
          }
        });

        showAlert('設定已儲存', 'success');
      } catch (error) {
        console.error('儲存設定失敗:', error);
        showAlert(error.message || '儲存失敗', 'danger');
      }
    }

    async function backupData() {
      try {
        const data = await apiCall('backupData');
        
        // 下載備份檔案
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);

        document.getElementById('lastBackupTime').textContent = new Date().toLocaleString('zh-TW');
        showAlert('資料備份成功', 'success');
      } catch (error) {
        console.error('備份失敗:', error);
        showAlert(error.message || '備份失敗', 'danger');
      }
    }

    // ==================== 圖表函數 ====================
    function createPieChart(canvasId, data) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.labels,
          datasets: [{
            data: data.values,
            backgroundColor: [
              '#00B900',
              '#06C755',
              '#FFD700',
              '#FF6B6B',
              '#4ECDC4',
              '#95E1D3'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    function createLineChart(canvasId, data) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels,
          datasets: [{
            label: data.label || '數量',
            data: data.values,
            borderColor: '#00B900',
            backgroundColor: 'rgba(0, 185, 0, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function createBarChart(canvasId, data) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: data.datasets.map((dataset, index) => ({
            label: dataset.label,
            data: dataset.values,
            backgroundColor: ['#00B900', '#06C755', '#FFD700', '#FF6B6B'][index]
          }))
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // ==================== 工具函數 ====================
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    function formatDateTime(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleString('zh-TW', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function getStatusColor(status) {
      const colors = {
        '報名中': 'success',
        '即將開始': 'warning',
        '進行中': 'info',
        '已結束': 'secondary'
      };
      return colors[status] || 'secondary';
    }

    function getRegistrationStatusColor(status) {
      const colors = {
        '已報名': 'primary',
        '已簽到': 'success',
        '已取消': 'secondary'
      };
      return colors[status] || 'secondary';
    }

    function getVolunteerStatusColor(status) {
      const colors = {
        '待審核': 'warning',
        '已審核': 'success',
        '已拒絕': 'danger'
      };
      return colors[status] || 'secondary';
    }

    function getRoleText(role) {
      const roles = {
        'member': '一般會員',
        'volunteer': '志工',
        'manager': '管理員',
        'finance': '財務',
        'admin': '系統管理員'
      };
      return roles[role] || '一般會員';
    }

    function showAlert(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
      alertDiv.style.zIndex = '9999';
      alertDiv.style.minWidth = '300px';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alertDiv);

      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }
  </script>
</body>
</html>


