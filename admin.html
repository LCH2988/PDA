<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>管理後台</title>
  <style>
    :root { --primary:#1e88e5; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, sans-serif; margin: 0; background: #f7f7f9; color: #222; }
    header { background: var(--primary); color:#fff; padding: 16px; display:flex; justify-content:space-between; align-items:center; }
    main { padding: 16px; }
    nav { display:flex; gap:8px; flex-wrap: wrap; margin: 12px 0; }
    button, select, input { padding: 8px 10px; border:1px solid #ddd; border-radius: 8px; background:#fff; }
    button.primary { background: var(--primary); border:none; color:#fff; }
    .grid { display: grid; gap: 12px; }
    @media (min-width: 768px) { .grid-3 { grid-template-columns: repeat(3, 1fr); } .grid-2 { grid-template-columns: repeat(2, 1fr); } }
    .card { background:#fff; border:1px solid #eee; border-radius:10px; padding:12px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#334155; font-size:12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom:1px solid #eee; text-align:left; font-size: 14px; }
    .right { text-align:right; }
  </style>
</head>
<body>
  <header>
    <div>管理後台</div>
    <div>
      <span id="adminName"></span>
      <button onclick="logout()">登出</button>
    </div>
  </header>
  <main>
    <nav>
      <button class="primary" onclick="showTab('dashboard')">總覽</button>
      <button onclick="showTab('members')">會員</button>
      <button onclick="showTab('activities')">活動</button>
      <button onclick="showTab('registrations')">報名</button>
      <button onclick="showTab('volunteers')">志工</button>
      <button onclick="showTab('finance')">財務</button>
    </nav>

    <section id="tab-dashboard" class="tab">
      <div class="grid grid-3">
        <div class="card"><div>會員總數</div><div id="statMembers" style="font-size:28px;font-weight:700;">-</div></div>
        <div class="card"><div>活動總數</div><div id="statActivities" style="font-size:28px;font-weight:700;">-</div></div>
        <div class="card"><div>志工總時數</div><div id="statHours" style="font-size:28px;font-weight:700;">-</div></div>
      </div>
      <div class="grid grid-2" style="margin-top:12px;">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>財務餘額</h3>
            <div id="statBalance" style="font-size:20px;font-weight:700;">-</div>
          </div>
        </div>
        <div class="card">
          <h3>近期活動</h3>
          <div id="recentActs"></div>
        </div>
      </div>
    </section>

    <section id="tab-members" class="tab hidden">
      <div class="card">
        <h3>會員列表</h3>
        <div id="members"></div>
      </div>
    </section>

    <section id="tab-activities" class="tab hidden">
      <div class="card">
        <h3>活動管理</h3>
        <div class="grid grid-3">
          <input id="actTitle" placeholder="標題" />
          <input id="actLocation" placeholder="地點" />
          <input id="actCapacity" type="number" placeholder="人數" />
          <input id="actStart" type="datetime-local" />
          <input id="actEnd" type="datetime-local" />
          <select id="actStatus">
            <option value="報名中">報名中</option>
            <option value="已結束">已結束</option>
          </select>
          <input id="actDesc" placeholder="說明" />
          <button class="primary" onclick="createActivity()">新增活動</button>
        </div>
      </div>
      <div class="card">
        <h3>所有活動</h3>
        <div id="acts"></div>
      </div>
    </section>

    <section id="tab-registrations" class="tab hidden">
      <div class="card">
        <h3>報名記錄</h3>
        <div id="regs"></div>
      </div>
    </section>

    <section id="tab-volunteers" class="tab hidden">
      <div class="card">
        <h3>志工紀錄</h3>
        <div id="vols"></div>
      </div>
    </section>

    <section id="tab-finance" class="tab hidden">
      <div class="card">
        <h3>財務總覽</h3>
        <div id="fin"></div>
      </div>
    </section>
  </main>

  <script>
    const CONFIG = { API_URL: 'https://script.google.com/macros/s/AKfycbz89u618Z_eGh1nCFNG17yPGfr09uC-TDGVr8h3Fjaw5d_ZI-Yu5m5xKZNUt9K2saIoeA/exec' };
    let TOKEN = '';

    function showTab(name) {
      document.querySelectorAll('.tab').forEach(t => t.classList.add('hidden'));
      const el = document.getElementById('tab-' + name);
      if (el) el.classList.remove('hidden');
      if (name === 'dashboard') loadDashboard();
      if (name === 'members') loadMembers();
      if (name === 'activities') loadActivities();
      if (name === 'registrations') loadRegs();
      if (name === 'volunteers') loadVols();
      if (name === 'finance') loadFinance();
    }

    async function api(action, payload = {}) {
      const body = { action, authToken: TOKEN, ...payload };
      const res = await fetch(CONFIG.API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const result = await res.json();
      if (!result.success) throw new Error(result.message || '操作失敗');
      return result.data;
    }

    function requireLogin() {
      TOKEN = localStorage.getItem('adminToken') || '';
      const name = localStorage.getItem('adminName') || '';
      if (!TOKEN) location.href = 'login.html';
      document.getElementById('adminName').textContent = name;
    }
    function logout() {
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminName');
      location.href = 'login.html';
    }

    // Dashboard
    async function loadDashboard() {
      const d = await api('getAdminDashboard', {});
      document.getElementById('statMembers').textContent = d.totalMembers;
      document.getElementById('statActivities').textContent = d.totalActivities;
      document.getElementById('statHours').textContent = d.totalVolunteerHours;
      document.getElementById('statBalance').textContent = 'NT$ ' + Number(d.financeBalance).toFixed(0);
      document.getElementById('recentActs').innerHTML = (d.recentActivities || []).map(a => `
        <div style="margin-bottom:8px;">
          <strong>${a.title}</strong> <span class="badge">${a.status}</span>
          <div style="font-size:12px;opacity:.8;">${a.location} ｜ ${formatDate(a.startAt)}</div>
        </div>
      `).join('') || '<div>無</div>';
    }

    // Members
    async function loadMembers() {
      const data = await api('getAllMembers', {});
      const list = data || [];
      document.getElementById('members').innerHTML = `
        <table>
          <thead><tr><th>姓名</th><th>電話</th><th>角色</th><th>狀態</th><th>操作</th></tr></thead>
          <tbody>
            ${list.map(m => `
              <tr>
                <td>${escapeHtml(m.realName || m.displayName || '')}</td>
                <td>${escapeHtml(m.phone || '')}</td>
                <td>
                  <select onchange="updateRole('${m.id}', this.value, null)">
                    ${['member','volunteer','manager','finance','admin'].map(r => `<option value="${r}" ${m.role===r?'selected':''}>${r}</option>`).join('')}
                  </select>
                </td>
                <td>
                  <select onchange="updateRole('${m.id}', null, this.value)">
                    ${['正常','停用'].map(s => `<option value="${s}" ${m.status===s?'selected':''}>${s}</option>`).join('')}
                  </select>
                </td>
                <td class="right">
                  <button onclick="delMember('${m.id}')">刪除</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
    async function updateRole(memberId, role, status) {
      await api('updateMemberRole', { memberId, ...(role?{role}:{}) , ...(status?{status}:{}) });
      alert('已更新');
      loadMembers();
    }
    async function delMember(id) {
      if (!confirm('確定刪除？')) return;
      await api('deleteMember', { id });
      loadMembers();
    }

    // Activities
    async function createActivity() {
      const payload = {
        title: document.getElementById('actTitle').value,
        location: document.getElementById('actLocation').value,
        capacity: Number(document.getElementById('actCapacity').value || 0),
        startAt: document.getElementById('actStart').value,
        endAt: document.getElementById('actEnd').value,
        status: document.getElementById('actStatus').value,
        description: document.getElementById('actDesc').value
      };
      if (!payload.title) return alert('請輸入標題');
      await api('addActivity', payload);
      alert('已新增活動');
      loadActivities();
    }
    async function loadActivities() {
      const data = await api('getAllActivities', {});
      const list = data || [];
      document.getElementById('acts').innerHTML = `
        <table>
          <thead><tr><th>標題</th><th>時間</th><th>地點</th><th>人數</th><th>狀態</th><th>操作</th></tr></thead>
          <tbody>
            ${list.map(a => `
              <tr>
                <td>${escapeHtml(a.title)}</td>
                <td>${formatDate(a.startAt)} ~ ${formatDate(a.endAt)}</td>
                <td>${escapeHtml(a.location || '')}</td>
                <td>${a.capacity || 0}</td>
                <td>${a.status}</td>
                <td class="right">
                  <button onclick="endActivity('${a.id}')">結束</button>
                  <button onclick="removeActivity('${a.id}')">刪除</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
    async function endActivity(id) {
      await api('updateActivity', { id, status: '已結束' });
      loadActivities();
    }
    async function removeActivity(id) {
      if (!confirm('確定刪除？')) return;
      await api('deleteActivity', { id });
      loadActivities();
    }

    // Registrations
    async function loadRegs() {
      const data = await api('getAllRegistrations', {});
      const list = data || [];
      document.getElementById('regs').innerHTML = `
        <table>
          <thead><tr><th>活動</th><th>姓名</th><th>電話</th><th>狀態</th><th>時間</th></tr></thead>
          <tbody>
            ${list.map(r => `
              <tr>
                <td>${escapeHtml(r.activityTitle)}</td>
                <td>${escapeHtml(r.memberName || '')}</td>
                <td>${escapeHtml(r.memberPhone || '')}</td>
                <td>${r.status}</td>
                <td>${formatDate(r.registeredAt)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // Volunteers
    async function loadVols() {
      const data = await api('getAllVolunteerRecords', {});
      const list = data || [];
      document.getElementById('vols').innerHTML = `
        <table>
          <thead><tr><th>會員</th><th>活動</th><th>日期</th><th>時數</th><th>狀態</th><th>操作</th></tr></thead>
          <tbody>
            ${list.map(v => `
              <tr>
                <td>${escapeHtml(v.memberName || '')}</td>
                <td>${escapeHtml(v.activityTitle || '')}</td>
                <td>${v.date}</td>
                <td>${v.hours}</td>
                <td>${v.status}</td>
                <td class="right">
                  ${v.status === '待審核' ? `<button onclick="approveVR('${v.id}')">通過</button>` : ''}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
    async function approveVR(id) {
      await api('approveVolunteerRecord', { id });
      loadVols();
    }

    // Finance
    async function loadFinance() {
      const d = await api('getFinanceData', {});
      const dons = d.donations || [];
      const exps = d.expenses || [];
      document.getElementById('fin').innerHTML = `
        <div class="grid grid-3">
          <div class="card">收入合計：<strong>NT$ ${Number(d.totalIncome||0).toFixed(0)}</strong></div>
          <div class="card">支出合計：<strong>NT$ ${Number(d.totalExpense||0).toFixed(0)}</strong></div>
          <div class="card">目前餘額：<strong>NT$ ${Number(d.balance||0).toFixed(0)}</strong></div>
        </div>
        <div class="grid grid-2" style="margin-top:12px;">
          <div class="card">
            <h4>捐款</h4>
            ${dons.length ? `
              <table>
                <thead><tr><th>會員</th><th>金額</th><th>日期</th><th>備註</th></tr></thead>
                <tbody>
                  ${dons.map(x => `<tr><td>${escapeHtml(x.memberName||'')}</td><td>${x.amount}</td><td>${formatDate(x.date)}</td><td>${escapeHtml(x.note||'')}</td></tr>`).join('')}
                </tbody>
              </table>
            ` : '無'}
          </div>
          <div class="card">
            <h4>支出</h4>
            ${exps.length ? `
              <table>
                <thead><tr><th>申請人</th><th>金額</th><th>日期</th><th>類別</th><th>狀態</th></tr></thead>
                <tbody>
                  ${exps.map(x => `<tr><td>${escapeHtml(x.memberName||'')}</td><td>${x.amount}</td><td>${formatDate(x.date)}</td><td>${escapeHtml(x.category||'')}</td><td>${x.status}</td></tr>`).join('')}
                </tbody>
              </table>
            ` : '無'}
          </div>
        </div>
      `;
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function formatDate(v){ try{ const d=new Date(v); if(isNaN(d))return String(v); return d.toLocaleString(); }catch{return String(v)} }

    window.addEventListener('load', () => {
      requireLogin();
      showTab('dashboard');
    });
  </script>
</body>
</html>
