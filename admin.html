<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理員後台</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          background: #f5f7fa;
      }

      .admin-container {
          display: flex;
          min-height: 100vh;
      }

      .sidebar {
          width: 250px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          position: fixed;
          height: 100vh;
          overflow-y: auto;
      }

      .sidebar h2 {
          margin-bottom: 30px;
          font-size: 20px;
          text-align: center;
      }

      .menu-item {
          padding: 12px 15px;
          margin-bottom: 5px;
          border-radius: 8px;
          cursor: pointer;
          transition: background 0.3s;
      }

      .menu-item:hover {
          background: rgba(255,255,255,0.2);
      }

      .menu-item.active {
          background: rgba(255,255,255,0.3);
      }

      .main-content {
          margin-left: 250px;
          flex: 1;
          padding: 30px;
      }

      .header {
          background: white;
          padding: 20px 30px;
          border-radius: 10px;
          margin-bottom: 30px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .header h1 {
          font-size: 24px;
          color: #333;
      }

      .logout-btn {
          background: #e74c3c;
          color: white;
          padding: 10px 20px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
      }

      .logout-btn:hover {
          background: #c0392b;
      }

      .content-section {
          display: none;
      }

      .content-section.active {
          display: block;
      }

      .card {
          background: white;
          border-radius: 10px;
          padding: 25px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          margin-bottom: 20px;
      }

      .card h3 {
          color: #333;
          margin-bottom: 20px;
          font-size: 18px;
          border-bottom: 2px solid #667eea;
          padding-bottom: 10px;
      }

      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
      }

      .stat-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
      }

      .stat-card h4 {
          font-size: 14px;
          margin-bottom: 10px;
          opacity: 0.9;
      }

      .stat-card .number {
          font-size: 32px;
          font-weight: bold;
      }

      .btn {
          padding: 10px 20px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
          transition: all 0.3s;
      }

      .btn-primary {
          background: #667eea;
          color: white;
      }

      .btn-primary:hover {
          background: #5568d3;
      }

      .btn-success {
          background: #27ae60;
          color: white;
      }

      .btn-success:hover {
          background: #229954;
      }

      .btn-danger {
          background: #e74c3c;
          color: white;
      }

      .btn-danger:hover {
          background: #c0392b;
      }

      .btn-warning {
          background: #f39c12;
          color: white;
      }

      .btn-warning:hover {
          background: #e67e22;
      }

      .form-group {
          margin-bottom: 15px;
      }

      .form-group label {
          display: block;
          margin-bottom: 5px;
          color: #333;
          font-weight: 600;
          font-size: 14px;
      }

      .form-group input, .form-group select, .form-group textarea {
          width: 100%;
          padding: 10px;
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          font-size: 14px;
          font-family: inherit;
      }

      .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
          outline: none;
          border-color: #667eea;
      }

      .form-row {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
      }

      table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 15px;
      }

      table th, table td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #e0e0e0;
      }

      table th {
          background: #f8f9fa;
          font-weight: 600;
          color: #333;
      }

      table tr:hover {
          background: #f8f9fa;
      }

      .action-btns {
          display: flex;
          gap: 5px;
      }

      .action-btns button {
          padding: 5px 10px;
          font-size: 12px;
      }

      .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          z-index: 1000;
          justify-content: center;
          align-items: center;
      }

      .modal.active {
          display: flex;
      }

      .modal-content {
          background: white;
          border-radius: 10px;
          padding: 30px;
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
      }

      .modal-header h3 {
          color: #333;
          font-size: 20px;
      }

      .close-btn {
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #999;
      }

      .close-btn:hover {
          color: #333;
      }

      .filter-bar {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
          flex-wrap: wrap;
      }

      .filter-bar input, .filter-bar select {
          padding: 8px 12px;
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          font-size: 14px;
      }

      .status-badge {
          padding: 5px 10px;
          border-radius: 5px;
          font-size: 12px;
          font-weight: 600;
      }

      .status-pending {
          background: #fff3cd;
          color: #856404;
      }

      .status-approved {
          background: #d4edda;
          color: #155724;
      }

      .status-rejected {
          background: #f8d7da;
          color: #721c24;
      }

      .status-completed {
          background: #d1ecf1;
          color: #0c5460;
      }

      .message {
          padding: 12px;
          border-radius: 8px;
          margin-bottom: 15px;
          text-align: center;
      }

      .message.success {
          background: #d4edda;
          color: #155724;
      }

      .message.error {
          background: #f8d7da;
          color: #721c24;
      }

      .loading {
          text-align: center;
          padding: 20px;
          color: #667eea;
      }

      .empty-state {
          text-align: center;
          padding: 40px;
          color: #999;
      }

      .approval-section {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          margin-top: 15px;
      }

      .approval-item {
          background: white;
          padding: 10px;
          border-radius: 5px;
          margin-bottom: 10px;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      @media (max-width: 768px) {
          .sidebar {
              width: 200px;
          }

          .main-content {
              margin-left: 200px;
          }

          .stats-grid {
              grid-template-columns: 1fr;
          }

          .form-row {
              grid-template-columns: 1fr;
          }

          table {
              font-size: 12px;
          }

          table th, table td {
              padding: 8px;
          }
      }
  </style>
</head>
<body>
  <div class="admin-container">
      <!-- 側邊欄 -->
      <div class="sidebar">
          <h2>🔧 管理員後台</h2>
          <div class="menu-item active" onclick="showSection('dashboard')">📊 儀表板</div>
          <div class="menu-item" onclick="showSection('users')">👥 人員管理</div>
          <div class="menu-item" onclick="showSection('transactions')">💰 收支日記帳</div>
          <div class="menu-item" onclick="showSection('budgets')">📋 預算編列</div>
          <div class="menu-item" onclick="showSection('expenses')">💳 理事長交際費</div>
          <div class="menu-item" onclick="showSection('directors')">👔 理監事管理</div>
      </div>

      <!-- 主要內容 -->
      <div class="main-content">
          <div class="header">
              <h1>管理員後台</h1>
              <button class="logout-btn" onclick="adminLogout()">登出</button>
          </div>

          <!-- 儀表板 -->
          <div id="dashboard" class="content-section active">
              <div class="stats-grid">
                  <div class="stat-card">
                      <h4>總會員數</h4>
                      <div class="number" id="totalUsers">0</div>
                  </div>
                  <div class="stat-card">
                      <h4>待審查交易</h4>
                      <div class="number" id="pendingTransactions">0</div>
                  </div>
                  <div class="stat-card">
                      <h4>待審查預算</h4>
                      <div class="number" id="pendingBudgets">0</div>
                  </div>
                  <div class="stat-card">
                      <h4>待審查交際費</h4>
                      <div class="number" id="pendingExpenses">0</div>
                  </div>
              </div>

              <div class="card">
                  <h3>快速操作</h3>
                  <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                      <button class="btn btn-primary" onclick="showSection('transactions'); openAddTransactionModal()">新增收支</button>
                      <button class="btn btn-primary" onclick="showSection('budgets'); openAddBudgetModal()">新增預算</button>
                      <button class="btn btn-primary" onclick="showSection('expenses'); openAddExpenseModal()">新增交際費</button>
                      <button class="btn btn-primary" onclick="showSection('directors'); openAddDirectorModal()">新增理監事</button>
                  </div>
              </div>
          </div>

          <!-- 人員管理 -->
          <div id="users" class="content-section">
              <div class="card">
                  <h3>人員管理</h3>
                  <div class="filter-bar">
                      <input type="text" id="userSearch" placeholder="搜尋姓名或電話" onkeyup="filterUsers()">
                      <select id="userTypeFilter" onchange="filterUsers()">
                          <option value="">全部類別</option>
                          <option value="一般群眾">一般群眾</option>
                          <option value="病友">病友</option>
                          <option value="家屬">家屬</option>
                          <option value="醫師">醫師</option>
                      </select>
                  </div>
                  <div id="usersTableContainer">
                      <div class="loading">載入中...</div>
                  </div>
              </div>
          </div>

          <!-- 收支日記帳 -->
          <div id="transactions" class="content-section">
              <div class="card">
                  <h3>收支日記帳</h3>
                  <button class="btn btn-primary" onclick="openAddTransactionModal()" style="margin-bottom: 15px;">+ 新增收支</button>
                  
                  <div class="filter-bar">
                      <input type="date" id="transStartDate" onchange="filterTransactions()">
                      <input type="date" id="transEndDate" onchange="filterTransactions()">
                      <select id="transTypeFilter" onchange="filterTransactions()">
                          <option value="">全部類型</option>
                          <option value="收入">收入</option>
                          <option value="支出">支出</option>
                      </select>
                      <select id="transStatusFilter" onchange="filterTransactions()">
                          <option value="">全部狀態</option>
                          <option value="待審查">待審查</option>
                          <option value="已入帳">已入帳</option>
                          <option value="支出核准">支出核准</option>
                          <option value="已支出">已支出</option>
                      </select>
                  </div>

                  <div id="transactionsTableContainer">
                      <div class="loading">載入中...</div>
                  </div>
              </div>
          </div>

          <!-- 預算編列 -->
          <div id="budgets" class="content-section">
              <div class="card">
                  <h3>預算編列</h3>
                  <button class="btn btn-primary" onclick="openAddBudgetModal()" style="margin-bottom: 15px;">+ 新增預算項目</button>
                  
                  <div id="budgetsContainer">
                      <div class="loading">載入中...</div>
                  </div>
              </div>
          </div>

          <!-- 理事長交際費 -->
          <div id="expenses" class="content-section">
              <div class="card">
                  <h3>理事長交際費</h3>
                  <button class="btn btn-primary" onclick="openAddExpenseModal()" style="margin-bottom: 15px;">+ 新增交際費</button>
                  
                  <div id="expensesContainer">
                      <div class="loading">載入中...</div>
                  </div>
              </div>
          </div>

          <!-- 理監事管理 -->
          <div id="directors" class="content-section">
              <div class="card">
                  <h3>理監事名單</h3>
                  <button class="btn btn-primary" onclick="openAddDirectorModal()" style="margin-bottom: 15px;">+ 新增理監事</button>
                  
                  <div id="directorsContainer">
                      <div class="loading">載入中...</div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- 新增/編輯收支 Modal -->
  <div id="transactionModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="transactionModalTitle">新增收支</h3>
              <button class="close-btn" onclick="closeModal('transactionModal')">&times;</button>
          </div>
          <div id="transactionModalMessage"></div>
          <form id="transactionForm">
              <input type="hidden" id="transactionId">
              <div class="form-row">
                  <div class="form-group">
                      <label>日期 <span style="color: red;">*</span></label>
                      <input type="date" id="transDate" required>
                  </div>
                  <div class="form-group">
                      <label>類型 <span style="color: red;">*</span></label>
                      <select id="transType" required>
                          <option value="">請選擇</option>
                          <option value="收入">收入</option>
                          <option value="支出">支出</option>
                      </select>
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>類別 <span style="color: red;">*</span></label>
                      <input type="text" id="transCategory" placeholder="例如：捐款、活動費用" required>
                  </div>
                  <div class="form-group">
                      <label>名稱 <span style="color: red;">*</span></label>
                      <input type="text" id="transName" placeholder="例如：王小明捐款" required>
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>金額 <span style="color: red;">*</span></label>
                      <input type="number" id="transAmount" placeholder="0" min="0" required>
                  </div>
                  <div class="form-group">
                      <label>帳戶</label>
                      <input type="text" id="transAccount" placeholder="例如：郵局帳戶">
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>資產結餘</label>
                      <input type="number" id="transBalance" placeholder="0" min="0">
                  </div>
                  <div class="form-group">
                      <label>單據序號</label>
                      <input type="text" id="transReceiptNo" placeholder="例如：R20250001">
                  </div>
              </div>
              <div class="form-group">
                  <label>單據PDF檔連結</label>
                  <input type="url" id="transReceiptPdf" placeholder="https://...">
              </div>
              <div class="form-group">
                  <label>狀態</label>
                  <select id="transStatus">
                      <option value="待審查">待審查</option>
                      <option value="已入帳">已入帳</option>
                      <option value="支出核准">支出核准</option>
                      <option value="已支出">已支出</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>備註</label>
                  <textarea id="transNote" rows="3" placeholder="其他說明"></textarea>
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">儲存</button>
          </form>
      </div>
  </div>

  <!-- 新增預算 Modal -->
  <div id="budgetModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>新增預算項目</h3>
              <button class="close-btn" onclick="closeModal('budgetModal')">&times;</button>
          </div>
          <div id="budgetModalMessage"></div>
          <form id="budgetForm">
              <div class="form-group">
                  <label>項目名稱 <span style="color: red;">*</span></label>
                  <input type="text" id="budgetItemName" placeholder="例如：年度活動經費" required>
              </div>
              <div class="form-group">
                  <label>預算金額 <span style="color: red;">*</span></label>
                  <input type="number" id="budgetAmount" placeholder="0" min="0" required>
              </div>
              <div class="form-group">
                  <label>說明</label>
                  <textarea id="budgetDescription" rows="3" placeholder="預算用途說明"></textarea>
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">提交審查</button>
          </form>
      </div>
  </div>

  <!-- 新增交際費 Modal -->
  <div id="expenseModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>新增理事長交際費</h3>
              <button class="close-btn" onclick="closeModal('expenseModal')">&times;</button>
          </div>
          <div id="expenseModalMessage"></div>
          <form id="expenseForm">
              <div class="form-row">
                  <div class="form-group">
                      <label>金額 <span style="color: red;">*</span></label>
                      <input type="number" id="expenseAmount" placeholder="0" min="0" required>
                  </div>
                  <div class="form-group">
                      <label>日期 <span style="color: red;">*</span></label>
                      <input type="date" id="expenseDate" required>
                  </div>
              </div>
              <div class="form-group">
                  <label>用途 <span style="color: red;">*</span></label>
                  <textarea id="expensePurpose" rows="3" placeholder="請說明交際費用途" required></textarea>
              </div>
              <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 14px;">
                  💡 提示：金額超過 10,000 元需經理監事過半數核准
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">提交</button>
          </form>
      </div>
  </div>

  <!-- 新增理監事 Modal -->
  <div id="directorModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>新增理監事</h3>
              <button class="close-btn" onclick="closeModal('directorModal')">&times;</button>
          </div>
          <div id="directorModalMessage"></div>
          <form id="directorForm">
              <div class="form-group">
                  <label>選擇會員 <span style="color: red;">*</span></label>
                  <select id="directorUserId" required>
                      <option value="">請選擇會員</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>職位 <span style="color: red;">*</span></label>
                  <select id="directorRole" required>
                      <option value="">請選擇</option>
                      <option value="理事長">理事長</option>
                      <option value="理事">理事</option>
                      <option value="監事">監事</option>
                  </select>
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">新增</button>
          </form>
      </div>
  </div>

  <!-- 審核 Modal -->
  <div id="approvalModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="approvalModalTitle">審核</h3>
              <button class="close-btn" onclick="closeModal('approvalModal')">&times;</button>
          </div>
          <div id="approvalModalMessage"></div>
          <div id="approvalDetails"></div>
          <form id="approvalForm">
              <input type="hidden" id="approvalItemId">
              <input type="hidden" id="approvalType">
              <div class="form-group">
                  <label>決定 <span style="color: red;">*</span></label>
                  <select id="approvalDecision" required>
                      <option value="">請選擇</option>
                      <option value="同意">同意</option>
                      <option value="不同意">不同意</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>意見</label>
                  <textarea id="approvalComment" rows="3" placeholder="請輸入您的意見（選填）"></textarea>
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">提交審核</button>
          </form>
      </div>
  </div>

  <!-- 編輯用戶 Modal -->
  <div id="editUserModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>編輯用戶資料</h3>
              <button class="close-btn" onclick="closeModal('editUserModal')">&times;</button>
          </div>
          <div id="editUserModalMessage"></div>
          <form id="editUserForm">
              <input type="hidden" id="editUserId">
              <div class="form-group">
                  <label>姓名 <span style="color: red;">*</span></label>
                  <input type="text" id="editUserName" required>
              </div>
              <div class="form-group">
                  <label>電話</label>
                  <input type="tel" id="editUserPhone">
              </div>
              <div class="form-group">
                  <label>類別</label>
                  <select id="editUserType">
                      <option value="一般群眾">一般群眾</option>
                      <option value="病友">病友</option>
                      <option value="家屬">家屬</option>
                      <option value="醫師">醫師</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>Email</label>
                  <input type="email" id="editUserEmail">
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">儲存</button>
          </form>
      </div>
  </div>

  <script>
      // ========== 配置 ==========
      const API_URL = 'https://script.google.com/macros/s/AKfycbxIHfuQwSYR0Tg3Y-Z1spe0yCwu8cJeomuWZoVP4-lZVn7qDCmCXrjiMFGjNUivAYmf8w/exec';
      let currentAdmin = JSON.parse(sessionStorage.getItem('currentUser'));
      let allUsers = [];
      let allTransactions = [];
      let allBudgets = [];
      let allExpenses = [];
      let allDirectors = [];

      // ========== 初始化 ==========
      window.onload = async function() {
          if (!currentAdmin) {
              alert('請先登入');
              window.location.href = 'index.html';
              return;
          }

          // 檢查管理員權限
          const adminCheck = await callAPI('checkAdmin', { userId: currentAdmin.id });
          if (!adminCheck.success || !adminCheck.isAdmin) {
              alert('您沒有管理員權限');
              window.location.href = 'index.html';
              return;
          }

          loadDashboard();
      };

      // ========== API 呼叫 ==========
      async function callAPI(action, data = {}) {
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: { 'Content-Type': 'text/plain' },
                  body: JSON.stringify({ action: action, data: data })
              });
              const text = await response.text();
              return JSON.parse(text);
          } catch (error) {
              console.error('API 錯誤:', error);
              return { success: false, message: '網路連線錯誤' };
          }
      }

      // ========== 頁面切換 ==========
      function showSection(sectionId) {
          document.querySelectorAll('.content-section').forEach(section => {
              section.classList.remove('active');
          });
          document.querySelectorAll('.menu-item').forEach(item => {
              item.classList.remove('active');
          });
          
          document.getElementById(sectionId).classList.add('active');
          event.target.classList.add('active');

          // 載入對應資料
          switch(sectionId) {
              case 'dashboard':
                  loadDashboard();
                  break;
              case 'users':
                  loadUsers();
                  break;
              case 'transactions':
                  loadTransactions();
                  break;
              case 'budgets':
                  loadBudgets();
                  break;
              case 'expenses':
                  loadExpenses();
                  break;
              case 'directors':
                  loadDirectors();
                  break;
          }
      }

      // ========== 儀表板 ==========
      async function loadDashboard() {
          const usersResult = await callAPI('getAllUsers');
          const transResult = await callAPI('getTransactions', {});
          const budgetsResult = await callAPI('getBudgets');
          const expensesResult = await callAPI('getExpenses');

          if (usersResult.success) {
              document.getElementById('totalUsers').textContent = usersResult.users.length;
          }

          if (transResult.success) {
              const pending = transResult.transactions.filter(t => t.status === '待審查').length;
              document.getElementById('pendingTransactions').textContent = pending;
          }

          if (budgetsResult.success) {
              const pending = budgetsResult.budgets.filter(b => b.status === '待審查').length;
              document.getElementById('pendingBudgets').textContent = pending;
          }

          if (expensesResult.success) {
              const pending = expensesResult.expenses.filter(e => e.status === '待審查').length;
              document.getElementById('pendingExpenses').textContent = pending;
          }
      }

      // ========== 人員管理 ==========
      async function loadUsers() {
          const container = document.getElementById('usersTableContainer');
          container.innerHTML = '<div class="loading">載入中...</div>';

          const result = await callAPI('getAllUsers');

          if (result.success) {
              allUsers = result.users;
              renderUsersTable(allUsers);
          } else {
              container.innerHTML = '<div class="empty-state">載入失敗</div>';
          }
      }

      function renderUsersTable(users) {
          const container = document.getElementById('usersTableContainer');

          if (users.length === 0) {
              container.innerHTML = '<div class="empty-state">沒有用戶資料</div>';
              return;
          }

          let html = `
              <table>
                  <thead>
                      <tr>
                          <th>姓名</th>
                          <th>電話</th>
                          <th>類別</th>
                          <th>Email</th>
                          <th>註冊日期</th>
                          <th>操作</th>
                      </tr>
                  </thead>
                  <tbody>
          `;

          users.forEach(user => {
              html += `
                  <tr>
                      <td>${user.name}</td>
                      <td>${user.phone || '-'}</td>
                      <td>${user.type}</td>
                      <td>${user.email || '-'}</td>
                      <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                      <td class="action-btns">
                          <button class="btn btn-primary" onclick='editUser(${JSON.stringify(user)})'>編輯</button>
                          <button class="btn btn-danger" onclick="deleteUserConfirm('${user.id}', '${user.name}')">刪除</button>
                      </td>
                  </tr>
              `;
          });

          html += '</tbody></table>';
          container.innerHTML = html;
      }

      function filterUsers() {
          const search = document.getElementById('userSearch').value.toLowerCase();
          const typeFilter = document.getElementById('userTypeFilter').value;

          let filtered = allUsers.filter(user => {
              const matchSearch = user.name.toLowerCase().includes(search) || 
                                (user.phone && user.phone.includes(search));
              const matchType = !typeFilter || user.type === typeFilter;
              return matchSearch && matchType;
          });

          renderUsersTable(filtered);
      }

      function editUser(user) {
          document.getElementById('editUserId').value = user.id;
          document.getElementById('editUserName').value = user.name;
          document.getElementById('editUserPhone').value = user.phone || '';
          document.getElementById('editUserType').value = user.type;
          document.getElementById('editUserEmail').value = user.email || '';
          openModal('editUserModal');
      }

      document.getElementById('editUserForm').addEventListener('submit', async function(e) {
          e.preventDefault();

          const data = {
              userId: document.getElementById('editUserId').value,
              name: document.getElementById('editUserName').value,
              phone: document.getElementById('editUserPhone').value,
              type: document.getElementById('editUserType').value,
              email: document.getElementById('editUserEmail').value
          };

          const result = await callAPI('updateUserAdmin', data);

          if (result.success) {
              showModalMessage('editUserModal', result.message, 'success');
              setTimeout(() => {
                  closeModal('editUserModal');
                  loadUsers();
              }, 1500);
          } else {
              showModalMessage('editUserModal', result.message, 'error');
          }
      });

      async function deleteUserConfirm(userId, userName) {
          if (!confirm(`確定要刪除用戶「${userName}」嗎？此操作無法復原。`)) {
              return;
          }

          const result = await callAPI('deleteUser', { userId: userId });

          if (result.success) {
              alert(result.message);
              loadUsers();
          } else {
              alert(result.message);
          }
      }

      // ========== 收支日記帳 ==========
      async function loadTransactions() {
          const container = document.getElementById('transactionsTableContainer');
          container.innerHTML = '<div class="loading">載入中...</div>';

          const result = await callAPI('getTransactions', {});

          if (result.success) {
              allTransactions = result.transactions;
              renderTransactionsTable(allTransactions);
          } else {
              container.innerHTML = '<div class="empty-state">載入失敗</div>';
          }
      }

      function renderTransactionsTable(transactions) {
          const container = document.getElementById('transactionsTableContainer');

          if (transactions.length === 0) {
              container.innerHTML = '<div class="empty-state">沒有交易記錄</div>';
              return;
          }

          let html = `
              <table>
                  <thead>
                      <tr>
                          <th>日期</th>
                          <th>類型</th>
                          <th>類別</th>
                          <th>名稱</th>
                          <th>金額</th>
                          <th>狀態</th>
                          <th>單據</th>
                          <th>操作</th>
                      </tr>
                  </thead>
                  <tbody>
          `;

          transactions.forEach(trans => {
              const statusClass = trans.status === '待審查' ? 'status-pending' : 
                                trans.status === '已入帳' || trans.status === '支出核准' ? 'status-approved' : 
                                'status-completed';
              
              html += `
                  <tr>
                      <td>${trans.date}</td>
                      <td><strong>${trans.type === '收入' ? '💰' : '💸'} ${trans.type}</strong></td>
                      <td>${trans.category}</td>
                      <td>${trans.name}</td>
                      <td style="text-align: right; font-weight: 600;">NT$ ${Number(trans.amount).toLocaleString()}</td>
                      <td><span class="status-badge ${statusClass}">${trans.status}</span></td>
                      <td>${trans.receiptPdf ? `<a href="${trans.receiptPdf}" target="_blank">查看</a>` : '-'}</td>
                      <td class="action-btns">
                          <button class="btn btn-primary" onclick='editTransaction(${JSON.stringify(trans)})'>編輯</button>
                          <button class="btn btn-danger" onclick="deleteTransactionConfirm('${trans.id}')">刪除</button>
                      </td>
                  </tr>
              `;
          });

          html += '</tbody></table>';
          container.innerHTML = html;
      }

      function filterTransactions() {
          const startDate = document.getElementById('transStartDate').value;
          const endDate = document.getElementById('transEndDate').value;
          const typeFilter = document.getElementById('transTypeFilter').value;
          const statusFilter = document.getElementById('transStatusFilter').value;

          let filtered = allTransactions.filter(trans => {
              const matchDate = (!startDate || trans.date >= startDate) && 
                              (!endDate || trans.date <= endDate);
              const matchType = !typeFilter || trans.type === typeFilter;
              const matchStatus = !statusFilter || trans.status === statusFilter;
              return matchDate && matchType && matchStatus;
          });

          renderTransactionsTable(filtered);
      }

      function openAddTransactionModal() {
          document.getElementById('transactionForm').reset();
          document.getElementById('transactionId').value = '';
          document.getElementById('transactionModalTitle').textContent = '新增收支';
          document.getElementById('transDate').value = new Date().toISOString().split('T')[0];
          openModal('transactionModal');
      }

      function editTransaction(trans) {
          document.getElementById('transactionId').value = trans.id;
          document.getElementById('transDate').value = trans.date;
          document.getElementById('transType').value = trans.type;
          document.getElementById('transCategory').value = trans.category;
          document.getElementById('transName').value = trans.name;
          document.getElementById('transAmount').value = trans.amount;
          document.getElementById('transAccount').value = trans.account || '';
          document.getElementById('transBalance').value = trans.balance || '';
          document.getElementById('transReceiptNo').value = trans.receiptNo || '';
          document.getElementById('transReceiptPdf').value = trans.receiptPdf || '';
          document.getElementById('transStatus').value = trans.status;
          document.getElementById('transNote').value = trans.note || '';
          document.getElementById('transactionModalTitle').textContent = '編輯收支';
          openModal('transactionModal');
      }

      document.getElementById('transactionForm').addEventListener('submit', async function(e) {
          e.preventDefault();

          const transId = document.getElementById('transactionId').value;
          const data = {
              date: document.getElementById('transDate').value,
              type: document.getElementById('transType').value,
              category: document.getElementById('transCategory').value,
              name: document.getElementById('transName').value,
              amount: document.getElementById('transAmount').value,
              account: document.getElementById('transAccount').value,
              balance: document.getElementById('transBalance').value,
              receiptNo: document.getElementById('transReceiptNo').value,
              receiptPdf: document.getElementById('transReceiptPdf').value,
              status: document.getElementById('transStatus').value,
              note: document.getElementById('transNote').value,
              createdBy: currentAdmin.name
          };

          let result;
          if (transId) {
              data.id = transId;
              result = await callAPI('updateTransaction', data);
          } else {
              result = await callAPI('addTransaction', data);
          }

          if (result.success) {
              showModalMessage('transactionModal', result.message, 'success');
              setTimeout(() => {
                  closeModal('transactionModal');
                  loadTransactions();
                  loadDashboard();
              }, 1500);
          } else {
              showModalMessage('transactionModal', result.message, 'error');
          }
      });

      async function deleteTransactionConfirm(transId) {
          if (!confirm('確定要刪除此交易記錄嗎？')) {
              return;
          }

          const result = await callAPI('deleteTransaction', { id: transId });

          if (result.success) {
              alert(result.message);
              loadTransactions();
          } else {
              alert(result.message);
          }
      }

      // ========== 預算管理 ==========
      async function loadBudgets() {
          const container = document.getElementById('budgetsContainer');
          container.innerHTML = '<div class="loading">載入中...</div>';

          const result = await callAPI('getBudgets');

          if (result.success) {
              allBudgets = result.budgets;
              renderBudgets(allBudgets);
          } else {
              container.innerHTML = '<div class="empty-state">載入失敗</div>';
          }
      }

      function renderBudgets(budgets) {
          const container = document.getElementById('budgetsContainer');

          if (budgets.length === 0) {
              container.innerHTML = '<div class="empty-state">沒有預算項目</div>';
              return;
          }

          let html = '';

          budgets.forEach(budget => {
              const statusClass = budget.status === '待審查' ? 'status-pending' : 
                                budget.status === '已核准' ? 'status-approved' : 
                                'status-rejected';
              
              html += `
                  <div class="card" style="margin-bottom: 15px;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                          <div>
                              <h4 style="font-size: 18px; color: #333; margin-bottom: 5px;">${budget.itemName}</h4>
                              <p style="color: #666; font-size: 14px;">${budget.description || '無說明'}</p>
                          </div>
                          <span class="status-badge ${statusClass}">${budget.status}</span>
                      </div>
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                          <div>
                              <div style="font-size: 24px; font-weight: 700; color: #667eea;">NT$ ${Number(budget.amount).toLocaleString()}</div>
                              <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                  提案人：${budget.createdBy} | ${new Date(budget.createdAt).toLocaleDateString()}
                              </div>
                              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                  ✅ 同意：${budget.approvedCount} | ❌ 不同意：${budget.rejectedCount}
                              </div>
                          </div>
                          ${budget.status === '待審查' ? `
                              <button class="btn btn-warning" onclick='openApprovalModal("${budget.id}", "budget", ${JSON.stringify(budget)})'>審核</button>
                          ` : ''}
                      </div>
                  </div>
              `;
          });

          container.innerHTML = html;
      }

      function openAddBudgetModal() {
          document.getElementById('budgetForm').reset();
          openModal('budgetModal');
      }

      document.getElementById('budgetForm').addEventListener('submit', async function(e) {
          e.preventDefault();

          const data = {
              itemName: document.getElementById('budgetItemName').value,
              amount: document.getElementById('budgetAmount').value,
              description: document.getElementById('budgetDescription').value,
              createdBy: currentAdmin.name
          };

          const result = await callAPI('addBudget', data);

          if (result.success) {
              showModalMessage('budgetModal', result.message, 'success');
              setTimeout(() => {
                  closeModal('budgetModal');
                  loadBudgets();
                  loadDashboard();
              }, 1500);
          } else {
              showModalMessage('budgetModal', result.message, 'error');
          }
      });

      // ========== 交際費管理 ==========
      async function loadExpenses() {
          const container = document.getElementById('expensesContainer');
          container.innerHTML = '<div class="loading">載入中...</div>';

          const result = await callAPI('getExpenses');

          if (result.success) {
              allExpenses = result.expenses;
              renderExpenses(allExpenses);
          } else {
              container.innerHTML = '<div class="empty-state">載入失敗</div>';
          }
      }

      function renderExpenses(expenses) {
          const container = document.getElementById('expensesContainer');

          if (expenses.length === 0) {
              container.innerHTML = '<div class="empty-state">沒有交際費記錄</div>';
              return;
          }

          let html = '';

          expenses.forEach(expense => {
              const statusClass = expense.status === '待審查' ? 'status-pending' : 
                                expense.status === '已核准' ? 'status-approved' : 
                                'status-rejected';
              
              html += `
                  <div class="card" style="margin-bottom: 15px;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                          <div style="flex: 1;">
                              <div style="font-size: 24px; font-weight: 700; color: #667eea; margin-bottom: 10px;">
                                  NT$ ${Number(expense.amount).toLocaleString()}
                              </div>
                              <p style="color: #666; font-size: 14px; margin-bottom: 5px;"><strong>用途：</strong>${expense.purpose}</p>
                              <p style="color: #999; font-size: 12px;">日期：${expense.date}</p>
                          </div>
                          <span class="status-badge ${statusClass}">${expense.status}</span>
                      </div>
                      <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                          <div style="font-size: 12px; color: #666;">
                              申請人：${expense.createdBy} | ${new Date(expense.createdAt).toLocaleDateString()}
                              <br>✅ 同意：${expense.approvedCount} | ❌ 不同意：${expense.rejectedCount}
                          </div>
                          ${expense.status === '待審查' ? `
                              <button class="btn btn-warning" onclick='openApprovalModal("${expense.id}", "expense", ${JSON.stringify(expense)})'>審核</button>
                          ` : ''}
                      </div>
                  </div>
              `;
          });

          container.innerHTML = html;
      }

      function openAddExpenseModal() {
          document.getElementById('expenseForm').reset();
          document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
          openModal('expenseModal');
      }

      document.getElementById('expenseForm').addEventListener('submit', async function(e) {
          e.preventDefault();

          const data = {
              amount: document.getElementById('expenseAmount').value,
              date: document.getElementById('expenseDate').value,
              purpose: document.getElementById('expensePurpose').value,
              createdBy: currentAdmin.name
          };

          const result = await callAPI('addExpense', data);

          if (result.success) {
              showModalMessage('expenseModal', result.message, 'success');
              setTimeout(() => {
                  closeModal('expenseModal');
                  loadExpenses();
                  loadDashboard();
              }, 1500);
          } else {
              showModalMessage('expenseModal', result.message, 'error');
          }
      });

      // ========== 理監事管理 ==========
      async function loadDirectors() {
          const container = document.getElementById('directorsContainer');
          container.innerHTML = '<div class="loading">載入中...</div>';

          const result = await callAPI('getDirectors');

          if (result.success) {
              allDirectors = result.directors;
              renderDirectors(allDirectors);
          } else {
              container.innerHTML = '<div class="empty-state">載入失敗</div>';
          }
      }

      function renderDirectors(directors) {
          const container = document.getElementById('directorsContainer');

          if (directors.length === 0) {
              container.innerHTML = '<div class="empty-state">沒有理監事</div>';
              return;
          }

          let html = '<table><thead><tr><th>姓名</th><th>職位</th><th>加入日期</th><th>操作</th></tr></thead><tbody>';

          directors.forEach(director => {
              html += `
                  <tr>
                      <td>${director.userName}</td>
                      <td><strong>${director.role}</strong></td>
                      <td>${new Date(director.createdAt).toLocaleDateString()}</td>
                      <td class="action-btns">
                          <button class="btn btn-danger" onclick="removeDirectorConfirm('${director.id}', '${director.userName}')">移除</button>
                      </td>
                  </tr>
              `;
          });

          html += '</tbody></table>';
          container.innerHTML = html;
      }

      async function openAddDirectorModal() {
          // 載入所有用戶
          const result = await callAPI('getAllUsers');
          
          if (result.success) {
              const select = document.getElementById('directorUserId');
              select.innerHTML = '<option value="">請選擇會員</option>';
              
              result.users.forEach(user => {
                  select.innerHTML += `<option value="${user.id}" data-name="${user.name}">${user.name} (${user.phone || user.lineId})</option>`;
              });
          }

          document.getElementById('directorForm').reset();
          openModal('directorModal');
      }

      document.getElementById('directorForm').addEventListener('submit', async function(e) {
          e.preventDefault();

          const select = document.getElementById('directorUserId');
          const selectedOption = select.options[select.selectedIndex];

          const data = {
              userId: select.value,
              userName: selectedOption.getAttribute('data-name'),
              role: document.getElementById('directorRole').value
          };

          const result = await callAPI('addDirector', data);

          if (result.success) {
              showModalMessage('directorModal', result.message, 'success');
              setTimeout(() => {
                  closeModal('directorModal');
                  loadDirectors();
              }, 1500);
          } else {
              showModalMessage('directorModal', result.message, 'error');
          }
      });

      async function removeDirectorConfirm(directorId, directorName) {
          if (!confirm(`確定要移除理監事「${directorName}」嗎？`)) {
              return;
          }

          const result = await callAPI('removeDirector', { id: directorId });

          if (result.success) {
              alert(result.message);
              loadDirectors();
          } else {
              alert(result.message);
          }
      }

      // ========== 審核功能 ==========
      function openApprovalModal(itemId, type, item) {
          document.getElementById('approvalItemId').value = itemId;
          document.getElementById('approvalType').value = type;
          document.getElementById('approvalForm').reset();

          let title = '';
          let details = '';

          if (type === 'budget') {
              title = '預算審核';
              details = `
                  <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                      <p style="margin: 5px 0;"><strong>項目名稱：</strong>${item.itemName}</p>
                      <p style="margin: 5px 0;"><strong>預算金額：</strong>NT$ ${Number(item.amount).toLocaleString()}</p>
                      <p style="margin: 5px 0;"><strong>說明：</strong>${item.description || '無'}</p>
                      <p style="margin: 5px 0;"><strong>提案人：</strong>${item.createdBy}</p>
                      <p style="margin: 5px 0; font-size: 12px; color: #666;">
                          目前：✅ ${item.approvedCount} | ❌ ${item.rejectedCount}
                      </p>
                  </div>
              `;
          } else if (type === 'expense') {
              title = '交際費審核';
              details = `
                  <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                      <p style="margin: 5px 0;"><strong>金額：</strong>NT$ ${Number(item.amount).toLocaleString()}</p>
                      <p style="margin: 5px 0;"><strong>用途：</strong>${item.purpose}</p>
                      <p style="margin: 5px 0;"><strong>日期：</strong>${item.date}</p>
                      <p style="margin: 5px 0;"><strong>申請人：</strong>${item.createdBy}</p>
                      <p style="margin: 5px 0; font-size: 12px; color: #666;">
                          目前：✅ ${item.approvedCount} | ❌ ${item.rejectedCount}
                      </p>
                  </div>
              `;
          }

          document.getElementById('approvalModalTitle').textContent = title;
          document.getElementById('approvalDetails').innerHTML = details;
          openModal('approvalModal');
      }

      document.getElementById('approvalForm').addEventListener('submit', async function(e) {
          e.preventDefault();

          const itemId = document.getElementById('approvalItemId').value;
          const type = document.getElementById('approvalType').value;
          const decision = document.getElementById('approvalDecision').value;
          const comment = document.getElementById('approvalComment').value;

          const data = {
              userId: currentAdmin.id,
              userName: currentAdmin.name,
              decision: decision,
              comment: comment
          };

          let result;
          if (type === 'budget') {
              data.budgetId = itemId;
              result = await callAPI('approveBudget', data);
          } else if (type === 'expense') {
              data.expenseId = itemId;
              result = await callAPI('approveExpense', data);
          }

          if (result.success) {
              showModalMessage('approvalModal', result.message, 'success');
              setTimeout(() => {
                  closeModal('approvalModal');
                  if (type === 'budget') {
                      loadBudgets();
                  } else if (type === 'expense') {
                      loadExpenses();
                  }
                  loadDashboard();
              }, 1500);
          } else {
              showModalMessage('approvalModal', result.message, 'error');
          }
      });

      // ========== Modal 控制 ==========
      function openModal(modalId) {
          document.getElementById(modalId).classList.add('active');
      }

      function closeModal(modalId) {
          document.getElementById(modalId).classList.remove('active');
      }

      function showModalMessage(modalId, message, type) {
          const messageDiv = document.getElementById(modalId.replace('Modal', 'ModalMessage'));
          messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
          setTimeout(() => {
              messageDiv.innerHTML = '';
          }, 3000);
      }

      // ========== 登出 ==========
      function adminLogout() {
          if (confirm('確定要登出嗎？')) {
              sessionStorage.removeItem('currentUser');
              window.location.href = 'index.html';
          }
      }

      // 點擊 Modal 外部關閉
      document.querySelectorAll('.modal').forEach(modal => {
          modal.addEventListener('click', function(e) {
              if (e.target === this) {
                  this.classList.remove('active');
              }
          });
      });
  </script>
</body>
</html>
