<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理後台 - 帕金森協會</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fa;
      display: flex;
      min-height: 100vh;
    }
    
    /* 側邊欄 */
    .sidebar {
      width: 250px;
      background: #2c3e50;
      color: white;
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    
    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }
    
    .sidebar-header h2 {
      font-size: 20px;
      margin-bottom: 5px;
    }
    
    .sidebar-header p {
      font-size: 13px;
      opacity: 0.7;
    }
    
    .menu-item {
      padding: 15px 20px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .menu-item:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .menu-item.active {
      background: #667eea;
      border-left: 4px solid white;
    }
    
    .menu-item .icon {
      font-size: 20px;
    }
    
    /* 主要內容區 */
    .main-content {
      margin-left: 250px;
      flex: 1;
      padding: 30px;
    }
    
    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 24px;
      color: #333;
    }
    
    .logout-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    
    /* 統計卡片 */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .stat-card .icon {
      font-size: 36px;
      margin-bottom: 10px;
    }
    
    .stat-card .label {
      font-size: 14px;
      color: #999;
      margin-bottom: 5px;
    }
    
    .stat-card .value {
      font-size: 28px;
      font-weight: 600;
      color: #333;
    }
    
    /* 內容區塊 */
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .card-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
    }
    
    /* 按鈕 */
    .btn {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }
    
    .btn-success {
      background: #27ae60;
    }
    
    .btn-danger {
      background: #e74c3c;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    /* 表格 */
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: #f8f9fa;
    }
    
    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #e0e0e0;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    tbody tr:hover {
      background: #f8f9fa;
    }
    
    /* 搜尋列 */
    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .search-bar input,
    .search-bar select {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .search-bar input {
      flex: 1;
    }
    
    /* Badge */
    .badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }
    
    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    /* 分頁 */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-top: 20px;
    }
    
    .pagination button {
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      background: white;
      cursor: pointer;
      border-radius: 6px;
    }
    
    .pagination button.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 24px;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      color: #999;
      cursor: pointer;
    }
    
    /* 表單 */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
    }
    
    /* 載入中 */
    .loading {
      text-align: center;
      padding: 40px;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 響應式 */
    @media (max-width: 768px) {
      .sidebar {
        width: 200px;
      }
      
      .main-content {
        margin-left: 200px;
        padding: 15px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- 側邊欄 -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>🏥 管理後台</h2>
      <p>帕金森協會</p>
    </div>
    
    <div class="menu-item active" onclick="showSection('dashboard')">
      <span class="icon">📊</span>
      <span>儀表板</span>
    </div>
    
    <div class="menu-item" onclick="showSection('members')">
      <span class="icon">👥</span>
      <span>會員管理</span>
    </div>
    
    <div class="menu-item" onclick="showSection('events')">
      <span class="icon">📅</span>
      <span>活動管理</span>
    </div>
    
    <div class="menu-item" onclick="showSection('volunteers')">
      <span class="icon">🙋</span>
      <span>志工管理</span>
    </div>
    
    <div class="menu-item" onclick="showSection('finance')">
      <span class="icon">💰</span>
      <span>財務管理</span>
    </div>
    
    <div class="menu-item" onclick="showSection('donations')">
      <span class="icon">💝</span>
      <span>捐款管理</span>
    </div>
    
    <div class="menu-item" onclick="showSection('reports')">
      <span class="icon">📈</span>
      <span>報表分析</span>
    </div>
    
    <div class="menu-item" onclick="showSection('settings')">
      <span class="icon">⚙️</span>
      <span>系統設定</span>
    </div>
  </div>
  
  <!-- 主要內容 -->
  <div class="main-content">
    <div class="header">
      <h1 id="page-title">儀表板</h1>
      <button class="logout-btn" onclick="handleLogout()">登出</button>
    </div>
    
    <!-- 儀表板 -->
    <div id="dashboard-section" class="content-section active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="icon">👥</div>
          <div class="label">總會員數</div>
          <div class="value" id="stat-members">-</div>
        </div>
        
        <div class="stat-card">
          <div class="icon">📅</div>
          <div class="label">本月活動</div>
          <div class="value" id="stat-events">-</div>
        </div>
        
        <div class="stat-card">
          <div class="icon">🙋</div>
          <div class="label">志工人數</div>
          <div class="value" id="stat-volunteers">-</div>
        </div>
        
        <div class="stat-card">
          <div class="icon">💰</div>
          <div class="label">本月捐款</div>
          <div class="value" id="stat-donations">-</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <div class="card-title">📋 待處理事項</div>
        </div>
        <div id="pending-tasks">
          <div class="loading">
            <div class="spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 會員管理 -->
    <div id="members-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">會員列表</div>
          <button class="btn btn-small" onclick="exportMembers()">匯出</button>
        </div>
        
        <div class="search-bar">
          <input type="text" id="member-search" placeholder="搜尋姓名、電話、Email..." onkeyup="searchMembers()">
          <select id="member-status-filter" onchange="filterMembers()">
            <option value="">全部狀態</option>
            <option value="正常">正常</option>
            <option value="待審核">待審核</option>
            <option value="已停用">已停用</option>
          </select>
          <button class="btn" onclick="loadMembers()">搜尋</button>
        </div>
        
        <div class="table-container">
          <table id="members-table">
            <thead>
              <tr>
                <th>會員編號</th>
                <th>姓名</th>
                <th>Email</th>
                <th>手機</th>
                <th>註冊日期</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                  <div class="loading">
                    <div class="spinner"></div>
                    <p>載入中...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="pagination" id="members-pagination"></div>
      </div>
    </div>
    
    <!-- 活動管理 -->
    <div id="events-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">活動列表</div>
          <button class="btn btn-small" onclick="showCreateEventModal()">+ 新增活動</button>
        </div>
        
        <div class="table-container">
          <table id="events-table">
            <thead>
              <tr>
                <th>活動名稱</th>
                <th>類型</th>
                <th>日期</th>
                <th>地點</th>
                <th>報名人數</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                  <div class="loading">
                    <div class="spinner"></div>
                    <p>載入中...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- 志工管理 -->
    <div id="volunteers-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">志工列表</div>
        </div>
        
        <div class="table-container">
          <table id="volunteers-table">
            <thead>
              <tr>
                <th>志工編號</th>
                <th>姓名</th>
                <th>手機</th>
                <th>加入日期</th>
                <th>服務時數</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                  <div class="loading">
                    <div class="spinner"></div>
                    <p>載入中...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- 財務管理 -->
    <div id="finance-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">財務記錄</div>
          <button class="btn btn-small" onclick="showAddFinanceModal()">+ 新增記錄</button>
        </div>
        
        <div class="search-bar">
          <select id="finance-type-filter">
            <option value="">全部類型</option>
            <option value="收入">收入</option>
            <option value="支出">支出</option>
          </select>
          <input type="date" id="finance-start-date">
          <input type="date" id="finance-end-date">
          <button class="btn" onclick="loadFinanceRecords()">查詢</button>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
          <div style="background: #d4edda; padding: 20px; border-radius: 8px;">
            <div style="font-size: 14px; color: #155724;">總收入</div>
            <div style="font-size: 24px; font-weight: 600; color: #155724;" id="total-income">NT$ 0</div>
          </div>
          <div style="background: #f8d7da; padding: 20px; border-radius: 8px;">
            <div style="font-size: 14px; color: #721c24;">總支出</div>
            <div style="font-size: 24px; font-weight: 600; color: #721c24;" id="total-expense">NT$ 0</div>
          </div>
          <div style="background: #d1ecf1; padding: 20px; border-radius: 8px;">
            <div style="font-size: 14px; color: #0c5460;">結餘</div>
            <div style="font-size: 24px; font-weight: 600; color: #0c5460;" id="balance">NT$ 0</div>
          </div>
        </div>
        
        <div class="table-container">
          <table id="finance-table">
            <thead>
              <tr>
                <th>日期</th>
                <th>類型</th>
                <th>類別</th>
                <th>金額</th>
                <th>廠商</th>
                <th>說明</th>
                <th>狀態</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                  <div class="loading">
                    <div class="spinner"></div>
                    <p>載入中...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- 捐款管理 -->
    <div id="donations-section" class="content-section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">捐款記錄</div>
        </div>
        
        <div class="table-container">
          <table id="donations-table">
            <thead>
              <tr>
                <th>日期</th>
                <th>捐款人</th>
                <th>金額</th>
                <th>用途</th>
                <th>付款方式</th>
                <th>收據</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                  <div class="loading">
                    <div class="spinner"></div>
                    <p>載入中...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 會員詳情 Modal -->
  <div id="member-detail-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">會員詳情</div>
        <button class="close-btn" onclick="closeModal('member-detail-modal')">&times;</button>
      </div>
      <div id="member-detail-content">
        <!-- 動態載入 -->
      </div>
    </div>
  </div>
  
  <!-- 新增活動 Modal -->
  <div id="create-event-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">新增活動</div>
        <button class="close-btn" onclick="closeModal('create-event-modal')">&times;</button>
      </div>
      <form id="create-event-form" onsubmit="handleCreateEvent(event)">
        <div class="form-group">
          <label>活動名稱 *</label>
          <input type="text" id="event-name" required>
        </div>
        
        <div class="form-group">
          <label>活動類型 *</label>
          <select id="event-type" required>
            <option value="">請選擇</option>
            <option value="衛教講座">衛教講座</option>
            <option value="病友聚會">病友聚會</option>
            <option value="運動課程">運動課程</option>
            <option value="志工培訓">志工培訓</option>
            <option value="其他">其他</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>活動日期 *</label>
          <input type="date" id="event-date" required>
        </div>
        
        <div class="form-group">
          <label>開始時間 *</label>
          <input type="time" id="event-start-time" required>
        </div>
        
        <div class="form-group">
          <label>結束時間 *</label>
          <input type="time" id="event-end-time" required>
        </div>
        
        <div class="form-group">
          <label>地點 *</label>
          <input type="text" id="event-location" required>
        </div>
        
        <div class="form-group">
          <label>地址</label>
          <input type="text" id="event-address">
        </div>
        
        <div class="form-group">
          <label>人數上限 *</label>
          <input type="number" id="event-max-participants" required value="30" min="1">
        </div>
        
        <div class="form-group">
          <label>活動說明</label>
          <textarea id="event-description" rows="4"></textarea>
        </div>
        
        <button type="submit" class="btn" style="width: 100%;">建立活動</button>
      </form>
    </div>
  </div>
  
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxoVYW42uDEOTi5sdUyqnFJojK1zqHfJxlVwvA5g9JcFdMHmw_9FEcDu4LUaNA26b4olw/exec'; // 請替換
    let adminInfo = null;
    let currentPage = 1;
    let pageSize = 20;
    
    // 初始化
    window.onload = function() {
      // 檢查登入狀態
      const stored = localStorage.getItem('adminInfo');
      if (!stored) {
        // 顯示登入表單
        showLoginForm();
        return;
      }
      
      adminInfo = JSON.parse(stored);
      loadDashboard();
    };
    
    // 顯示登入表單
    function showLoginForm() {
      document.body.innerHTML = `
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <div style="background: white; padding: 40px; border-radius:20px; max-width: 400px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
<h2 style="text-align: center; margin-bottom: 30px; color: #333;">🏥 管理員登入</h2>
<form onsubmit="handleAdminLogin(event)">
<div style="margin-bottom: 20px;">
<label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">帳號</label>
<input type="text" id="admin-username" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
</div>
<div style="margin-bottom: 20px;">
<label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">密碼</label>
<input type="password" id="admin-password" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
</div>
<button type="submit" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">登入</button>
</form>
<div style="text-align: center; margin-top: 20px;">
<a href="/" style="color: #667eea; text-decoration: none; font-size: 14px;">返回首頁</a>
</div>
</div>
</div>
`;
}

// 管理員登入
async function handleAdminLogin(event) {
  event.preventDefault();
  
  const username = document.getElementById('admin-username').value;
  const password = document.getElementById('admin-password').value;
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'adminLogin',
        username: username,
        password: password
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      localStorage.setItem('adminInfo', JSON.stringify(result.data));
      location.reload();
    } else {
      alert('❌ ' + result.message);
    }
  } catch (error) {
    console.error(error);
    alert('❌ 系統錯誤');
  }
}

// 載入儀表板
async function loadDashboard() {
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getDashboardStats'
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      document.getElementById('stat-members').textContent = result.data.totalMembers;
      document.getElementById('stat-events').textContent = result.data.monthlyEvents;
      document.getElementById('stat-volunteers').textContent = result.data.totalVolunteers;
      document.getElementById('stat-donations').textContent = 'NT$ ' + result.data.monthlyDonations.toLocaleString();
    }
  } catch (error) {
    console.error(error);
  }
  
  loadPendingTasks();
}

// 載入待處理事項
async function loadPendingTasks() {
  const container = document.getElementById('pending-tasks');
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getPendingTasks'
      })
    });
    
    const result = await response.json();
    
    if (result.success && result.data.length > 0) {
      let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
      
      result.data.forEach(task => {
        let badgeClass = 'badge-warning';
        if (task.priority === '高') badgeClass = 'badge-danger';
        
        html += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div>
              <div style="font-weight: 500; margin-bottom: 5px;">${task.title}</div>
              <div style="font-size: 13px; color: #666;">${task.description}</div>
            </div>
            <span class="badge ${badgeClass}">${task.type}</span>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    } else {
      container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">✅ 目前沒有待處理事項</div>';
    }
  } catch (error) {
    console.error(error);
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">❌ 載入失敗</div>';
  }
}

// 切換頁面
function showSection(section) {
  // 更新選單狀態
  document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
  event.currentTarget.classList.add('active');
  
  // 隱藏所有內容
  document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
  
  // 顯示對應內容
  const sectionElement = document.getElementById(section + '-section');
  if (sectionElement) {
    sectionElement.classList.add('active');
  }
  
  // 更新標題
  const titles = {
    'dashboard': '儀表板',
    'members': '會員管理',
    'events': '活動管理',
    'volunteers': '志工管理',
    'finance': '財務管理',
    'donations': '捐款管理',
    'reports': '報表分析',
    'settings': '系統設定'
  };
  document.getElementById('page-title').textContent = titles[section] || section;
  
  // 載入對應資料
  if (section === 'dashboard') {
    loadDashboard();
  } else if (section === 'members') {
    loadMembers();
  } else if (section === 'events') {
    loadEvents();
  } else if (section === 'volunteers') {
    loadVolunteers();
  } else if (section === 'finance') {
    loadFinanceRecords();
  } else if (section === 'donations') {
    loadDonations();
  }
}

// 載入會員列表
async function loadMembers() {
  const tbody = document.querySelector('#members-table tbody');
  tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;"><div class="loading"><div class="spinner"></div><p>載入中...</p></div></td></tr>';
  
  try {
    const searchText = document.getElementById('member-search').value;
    const status = document.getElementById('member-status-filter').value;
    
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getMembers',
        searchText: searchText,
        status: status,
        page: currentPage,
        pageSize: pageSize
      })
    });
    
    const result = await response.json();
    
    if (result.success && result.data.length > 0) {
      let html = '';
      
      result.data.forEach(member => {
        let badgeClass = 'badge-success';
        if (member.status === '待審核') badgeClass = 'badge-warning';
        else if (member.status === '已停用') badgeClass = 'badge-danger';
        
        html += `
          <tr>
            <td>${member.memberNo}</td>
            <td>${member.name}</td>
            <td>${member.email}</td>
            <td>${member.phone}</td>
            <td>${member.registerDate}</td>
            <td><span class="badge ${badgeClass}">${member.status}</span></td>
            <td>
              <button class="btn btn-small" onclick="showMemberDetail('${member.memberId}')">查看</button>
              ${member.status === '待審核' ? `<button class="btn btn-small btn-success" onclick="approveMember('${member.memberId}')">核准</button>` : ''}
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    } else {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">沒有找到會員資料</td></tr>';
    }
  } catch (error) {
    console.error(error);
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">❌ 載入失敗</td></tr>';
  }
}

// 搜尋會員
function searchMembers() {
  if (event.key === 'Enter') {
    loadMembers();
  }
}

// 篩選會員
function filterMembers() {
  loadMembers();
}

// 顯示會員詳情
async function showMemberDetail(memberId) {
  const modal = document.getElementById('member-detail-modal');
  const content = document.getElementById('member-detail-content');
  
  modal.classList.add('active');
  content.innerHTML = '<div class="loading"><div class="spinner"></div><p>載入中...</p></div>';
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getMemberInfo',
        memberId: memberId
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      const member = result.data;
      content.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">會員編號</div>
            <div style="font-weight: 500;">${member.memberNo}</div>
          </div>
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">姓名</div>
            <div style="font-weight: 500;">${member.name}</div>
          </div>
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">性別</div>
            <div style="font-weight: 500;">${member.gender}</div>
          </div>
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">生日</div>
            <div style="font-weight: 500;">${member.birthday}</div>
          </div>
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">手機</div>
            <div style="font-weight: 500;">${member.phone}</div>
          </div>
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">Email</div>
            <div style="font-weight: 500;">${member.email}</div>
          </div>
          <div style="grid-column: 1 / -1;">
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">地址</div>
            <div style="font-weight: 500;">${member.address || '未填寫'}</div>
          </div>
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">註冊日期</div>
            <div style="font-weight: 500;">${member.registerDate}</div>
          </div>
          <div>
            <div style="color: #999; font-size: 13px; margin-bottom: 5px;">狀態</div>
            <div style="font-weight: 500;">${member.status}</div>
          </div>
        </div>
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button class="btn" onclick="closeModal('member-detail-modal')">關閉</button>
          ${member.status === '待審核' ? `<button class="btn btn-success" onclick="approveMember('${member.memberId}')">核准會員</button>` : ''}
        </div>
      `;
    }
  } catch (error) {
    console.error(error);
    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">❌ 載入失敗</div>';
  }
}

// 核准會員
async function approveMember(memberId) {
  if (!confirm('確定要核准此會員嗎？')) return;
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'approveMember',
        memberId: memberId
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('✅ 已核准會員');
      closeModal('member-detail-modal');
      loadMembers();
    } else {
      alert('❌ ' + result.message);
    }
  } catch (error) {
    console.error(error);
    alert('❌ 系統錯誤');
  }
}

// 匯出會員
function exportMembers() {
  alert('匯出功能開發中');
}

// 載入活動列表
async function loadEvents() {
  const tbody = document.querySelector('#events-table tbody');
  tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;"><div class="loading"><div class="spinner"></div><p>載入中...</p></div></td></tr>';
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getAllEvents'
      })
    });
    
    const result = await response.json();
    
    if (result.success && result.data.length > 0) {
      let html = '';
      
      result.data.forEach(event => {
        let badgeClass = 'badge-info';
        if (event.status === '已結束') badgeClass = 'badge-secondary';
        else if (event.status === '已取消') badgeClass = 'badge-danger';
        
        html += `
          <tr>
            <td>${event.eventName}</td>
            <td>${event.eventType}</td>
            <td>${event.eventDate}</td>
            <td>${event.location}</td>
            <td>${event.registrationCount}/${event.maxParticipants}</td>
            <td><span class="badge ${badgeClass}">${event.status}</span></td>
            <td>
              <button class="btn btn-small" onclick="viewEventDetail('${event.eventId}')">查看</button>
              <button class="btn btn-small" onclick="viewRegistrations('${event.eventId}')">報名名單</button>
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    } else {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">沒有活動資料</td></tr>';
    }
  } catch (error) {
    console.error(error);
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">❌ 載入失敗</td></tr>';
  }
}

// 顯示新增活動 Modal
function showCreateEventModal() {
  document.getElementById('create-event-modal').classList.add('active');
}

// 新增活動
async function handleCreateEvent(event) {
  event.preventDefault();
  
  const data = {
    action: 'createEvent',
    eventName: document.getElementById('event-name').value,
    eventType: document.getElementById('event-type').value,
    eventDate: document.getElementById('event-date').value,
    startTime: document.getElementById('event-start-time').value,
    endTime: document.getElementById('event-end-time').value,
    location: document.getElementById('event-location').value,
    address: document.getElementById('event-address').value,
    maxParticipants: document.getElementById('event-max-participants').value,
    description: document.getElementById('event-description').value,
    organizerId: adminInfo.adminId
  };
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('✅ 活動建立成功！');
      closeModal('create-event-modal');
      document.getElementById('create-event-form').reset();
      loadEvents();
    } else {
      alert('❌ ' + result.message);
    }
  } catch (error) {
    console.error(error);
    alert('❌ 系統錯誤');
  }
}

// 載入志工列表
async function loadVolunteers() {
  const tbody = document.querySelector('#volunteers-table tbody');
  tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;"><div class="loading"><div class="spinner"></div><p>載入中...</p></div></td></tr>';
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getVolunteers'
      })
    });
    
    const result = await response.json();
    
    if (result.success && result.data.length > 0) {
      let html = '';
      
      result.data.forEach(volunteer => {
        let badgeClass = 'badge-success';
        if (volunteer.status === '待審核') badgeClass = 'badge-warning';
        
        html += `
          <tr>
            <td>${volunteer.volunteerNo}</td>
            <td>${volunteer.name}</td>
            <td>${volunteer.phone}</td>
            <td>${volunteer.joinDate}</td>
            <td>${volunteer.totalHours || 0} 小時</td>
            <td><span class="badge ${badgeClass}">${volunteer.status}</span></td>
            <td>
              <button class="btn btn-small" onclick="viewVolunteerDetail('${volunteer.volunteerId}')">查看</button>
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    } else {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">沒有志工資料</td></tr>';
    }
  } catch (error) {
    console.error(error);
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">❌ 載入失敗</td></tr>';
  }
}

// 載入財務記錄
async function loadFinanceRecords() {
  const tbody = document.querySelector('#finance-table tbody');
  tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;"><div class="loading"><div class="spinner"></div><p>載入中...</p></div></td></tr>';
  
  try {
    const type = document.getElementById('finance-type-filter').value;
    const startDate = document.getElementById('finance-start-date').value;
    const endDate = document.getElementById('finance-end-date').value;
    
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getFinanceRecords',
        type: type,
        startDate: startDate,
        endDate: endDate
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // 更新統計
      document.getElementById('total-income').textContent = 'NT$ ' + result.data.totalIncome.toLocaleString();
      document.getElementById('total-expense').textContent = 'NT$ ' + result.data.totalExpense.toLocaleString();
      document.getElementById('balance').textContent = 'NT$ ' + (result.data.totalIncome - result.data.totalExpense).toLocaleString();
      
      if (result.data.records.length > 0) {
        let html = '';
        
        result.data.records.forEach(record => {
          const amountColor = record.type === '收入' ? '#27ae60' : '#e74c3c';
          const badgeClass = record.status === '已核准' ? 'badge-success' : 'badge-warning';
          
          html += `
            <tr>
              <td>${record.transactionDate}</td>
              <td>${record.type}</td>
              <td>${record.category}</td>
              <td style="color: ${amountColor}; font-weight: 600;">
                ${record.type === '收入' ? '+' : '-'} NT$ ${record.amount.toLocaleString()}
              </td>
              <td>${record.vendor || '-'}</td>
              <td>${record.description}</td>
              <td><span class="badge ${badgeClass}">${record.status}</span></td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
      } else {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">沒有財務記錄</td></tr>';
      }
    }
  } catch (error) {
    console.error(error);
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">❌ 載入失敗</td></tr>';
  }
}

// 載入捐款記錄
async function loadDonations() {
  const tbody = document.querySelector('#donations-table tbody');
  tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;"><div class="loading"><div class="spinner"></div><p>載入中...</p></div></td></tr>';
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getAllDonations'
      })
    });
    
    const result = await response.json();
    
    if (result.success && result.data.length > 0) {
      let html = '';
      
      result.data.forEach(donation => {
        html += `
          <tr>
            <td>${donation.donationDate}</td>
            <td>${donation.donorName}</td>
            <td style="color: #27ae60; font-weight: 600;">NT$ ${donation.amount.toLocaleString()}</td>
            <td>${donation.purpose}</td>
            <td>${donation.paymentMethod}</td>
            <td>${donation.receiptIssued ? '<span class="badge badge-success">已開立</span>' : '<span class="badge badge-warning">未開立</span>'}</td>
            <td>
              ${!donation.receiptIssued ? `<button class="btn btn-small" onclick="issueReceipt('${donation.donationId}')">開立收據</button>` : ''}
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    } else {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">沒有捐款記錄</td></tr>';
    }
  } catch (error) {
    console.error(error);
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">❌ 載入失敗</td></tr>';
  }
}

// 關閉 Modal
function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

// 登出
function handleLogout() {
  if (confirm('確定要登出嗎？')) {
    localStorage.removeItem('adminInfo');
    location.reload();
  }
}
</script> 
</body> 
</html>  
