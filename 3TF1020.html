<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LIFF ç™¼é€è¨Šæ¯åˆ°ç¾¤çµ„</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #00B900 0%, #00D300 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 800px;
      margin: 0 auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #00B900;
      margin-bottom: 10px;
      font-size: 28px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .status {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      font-weight: 500;
    }
    .status.loading {
      background: #fff3cd;
      color: #856404;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }
    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: #666;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }
    .tab.active {
      color: #00B900;
      border-bottom-color: #00B900;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 600;
    }
    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
      transition: border-color 0.3s;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #00B900;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-send {
      background: linear-gradient(135deg, #00B900 0%, #00D300 100%);
      color: white;
    }
    .btn-send:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 185, 0, 0.4);
    }
    .btn-preview {
      background: #17a2b8;
      color: white;
    }
    .btn-preview:hover:not(:disabled) {
      background: #138496;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .info {
      background: #e7f3ff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-size: 14px;
      color: #004085;
      line-height: 1.6;
    }
    .preview-box {
      background: #f8f9fa;
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
    }
    .preview-box pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .flex-message-preview {
      background: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .color-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .color-input-group input[type="color"] {
      width: 60px;
      height: 40px;
      padding: 2px;
      cursor: pointer;
    }
    .group-info {
      background: #fff9e6;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #856404;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“± LIFF ç™¼é€è¨Šæ¯åˆ°ç¾¤çµ„</h1>
    
    <div id="status" class="status loading">æ­£åœ¨åˆå§‹åŒ– LIFF...</div>
    
    <div id="groupInfo" class="group-info" style="display:none;">
      <strong>ç•¶å‰ç’°å¢ƒï¼š</strong><span id="contextType">-</span><br>
      <strong>ç¾¤çµ„/èŠå¤©å®¤ IDï¼š</strong><span id="groupId">-</span>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('text')">æ–‡å­—è¨Šæ¯</button>
      <button class="tab" onclick="switchTab('flex')">ç‰Œå¡è¨Šæ¯ (Flex Message)</button>
    </div>

    <!-- æ–‡å­—è¨Šæ¯ Tab -->
    <div id="textTab" class="tab-content active">
      <div class="form-group">
        <label for="textMessage">è¨Šæ¯å…§å®¹ï¼š</label>
        <textarea 
          id="textMessage" 
          rows="6" 
          placeholder="è«‹è¼¸å…¥è¦ç™¼é€çš„æ–‡å­—è¨Šæ¯..."
          disabled
        ></textarea>
      </div>
      
      <div class="button-group">
        <button id="sendTextBtn" class="btn-send" disabled>ç™¼é€æ–‡å­—è¨Šæ¯</button>
      </div>
    </div>

    <!-- Flex Message Tab -->
    <div id="flexTab" class="tab-content">
      <div class="form-group">
        <label>å¿«é€Ÿç¯„æœ¬ï¼š</label>
        <select id="flexTemplate" onchange="loadTemplate()" disabled>
          <option value="">é¸æ“‡ç¯„æœ¬...</option>
          <option value="bubble">åŸºæœ¬æ³¡æ³¡å¡ç‰‡</option>
          <option value="notification">é€šçŸ¥å¡ç‰‡</option>
          <option value="product">ç”¢å“å±•ç¤ºå¡ç‰‡</option>
          <option value="event">æ´»å‹•è³‡è¨Šå¡ç‰‡</option>
          <option value="custom">è‡ªè¨‚ JSON</option>
        </select>
      </div>

      <div id="templateFields" style="display:none;">
        <!-- åŸºæœ¬æ³¡æ³¡å¡ç‰‡æ¬„ä½ -->
        <div id="bubbleFields" class="template-fields" style="display:none;">
          <div class="form-group">
            <label for="bubbleTitle">æ¨™é¡Œï¼š</label>
            <input type="text" id="bubbleTitle" placeholder="è¼¸å…¥æ¨™é¡Œ">
          </div>
          <div class="form-group">
            <label for="bubbleText">å…§å®¹ï¼š</label>
            <textarea id="bubbleText" rows="3" placeholder="è¼¸å…¥å…§å®¹"></textarea>
          </div>
          <div class="input-row">
            <div class="form-group">
              <label for="bubbleImage">åœ–ç‰‡ URLï¼š</label>
              <input type="url" id="bubbleImage" placeholder="https://example.com/image.jpg">
            </div>
            <div class="form-group">
              <label for="bubbleColor">ä¸»é¡Œè‰²ï¼š</label>
              <div class="color-input-group">
                <input type="color" id="bubbleColor" value="#00B900">
                <input type="text" id="bubbleColorText" value="#00B900" readonly>
              </div>
            </div>
          </div>
        </div>

        <!-- é€šçŸ¥å¡ç‰‡æ¬„ä½ -->
        <div id="notificationFields" class="template-fields" style="display:none;">
          <div class="form-group">
            <label for="notifTitle">é€šçŸ¥æ¨™é¡Œï¼š</label>
            <input type="text" id="notifTitle" placeholder="é‡è¦é€šçŸ¥">
          </div>
          <div class="form-group">
            <label for="notifMessage">é€šçŸ¥å…§å®¹ï¼š</label>
            <textarea id="notifMessage" rows="4" placeholder="è«‹è¼¸å…¥é€šçŸ¥å…§å®¹..."></textarea>
          </div>
          <div class="form-group">
            <label for="notifTime">æ™‚é–“ï¼š</label>
            <input type="text" id="notifTime" placeholder="2025-10-20 09:00">
          </div>
        </div>

        <!-- ç”¢å“å±•ç¤ºå¡ç‰‡æ¬„ä½ -->
        <div id="productFields" class="template-fields" style="display:none;">
          <div class="form-group">
            <label for="productName">ç”¢å“åç¨±ï¼š</label>
            <input type="text" id="productName" placeholder="ç”¢å“åç¨±">
          </div>
          <div class="form-group">
            <label for="productDesc">ç”¢å“æè¿°ï¼š</label>
            <textarea id="productDesc" rows="2" placeholder="ç”¢å“æè¿°"></textarea>
          </div>
          <div class="input-row">
            <div class="form-group">
              <label for="productPrice">åƒ¹æ ¼ï¼š</label>
              <input type="text" id="productPrice" placeholder="NT$ 999">
            </div>
            <div class="form-group">
              <label for="productImage">ç”¢å“åœ–ç‰‡ URLï¼š</label>
              <input type="url" id="productImage" placeholder="https://...">
            </div>
          </div>
        </div>

        <!-- æ´»å‹•è³‡è¨Šå¡ç‰‡æ¬„ä½ -->
        <div id="eventFields" class="template-fields" style="display:none;">
          <div class="form-group">
            <label for="eventName">æ´»å‹•åç¨±ï¼š</label>
            <input type="text" id="eventName" placeholder="æ´»å‹•åç¨±">
          </div>
          <div class="form-group">
            <label for="eventDate">æ´»å‹•æ—¥æœŸï¼š</label>
            <input type="text" id="eventDate" placeholder="2025/10/20 14:00">
          </div>
          <div class="form-group">
            <label for="eventLocation">æ´»å‹•åœ°é»ï¼š</label>
            <input type="text" id="eventLocation" placeholder="å°åŒ—å¸‚ä¿¡ç¾©å€...">
          </div>
          <div class="form-group">
            <label for="eventImage">æ´»å‹•åœ–ç‰‡ URLï¼š</label>
            <input type="url" id="eventImage" placeholder="https://...">
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="flexJson">Flex Message JSONï¼š</label>
        <textarea 
          id="flexJson" 
          rows="10" 
          placeholder='{"type": "bubble", "body": {...}}'
          disabled
        ></textarea>
      </div>

      <div class="button-group">
        <button id="previewFlexBtn" class="btn-preview" disabled>é è¦½</button>
        <button id="sendFlexBtn" class="btn-send" disabled>ç™¼é€ç‰Œå¡è¨Šæ¯</button>
      </div>

      <div id="previewBox" class="preview-box" style="display:none;">
        <strong>é è¦½ï¼š</strong>
        <div id="previewContent"></div>
      </div>
    </div>

    <div class="info">
      <strong>ğŸ“Œ ä½¿ç”¨èªªæ˜ï¼š</strong><br>
      1. æ­¤é é¢éœ€è¦åœ¨ LINE ç¾¤çµ„ä¸­é–‹å•Ÿ LIFF<br>
      2. LIFF å¿…é ˆè¨­å®šç‚º <code>chat_message.write</code> æ¬Šé™<br>
      3. è«‹å…ˆåœ¨ LINE Developers Console å»ºç«‹ LIFF æ‡‰ç”¨<br>
      4. å°‡ä¸‹æ–¹ç¨‹å¼ç¢¼ä¸­çš„ LIFF_ID æ›¿æ›ç‚ºä½ çš„ LIFF ID<br>
      5. Flex Message å¯ä½¿ç”¨ <a href="https://developers.line.biz/flex-simulator/" target="_blank">Flex Message Simulator</a> è¨­è¨ˆ
    </div>
  </div>

  <script>
    const statusDiv = document.getElementById('status');
    const groupInfo = document.getElementById('groupInfo');
    const contextType = document.getElementById('contextType');
    const groupId = document.getElementById('groupId');
    
    // è«‹å°‡æ­¤è™•æ›¿æ›ç‚ºä½ çš„ LIFF ID
    const LIFF_ID = '2007905012-o1yDNa92';

    let currentContext = null;

    // åˆå§‹åŒ– LIFF
    async function initializeLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        
        // ç²å–ç•¶å‰ç’°å¢ƒè³‡è¨Š
        currentContext = liff.getContext();
        console.log('Context:', currentContext);
        
        // é¡¯ç¤ºç’°å¢ƒè³‡è¨Š
        if (currentContext) {
          groupInfo.style.display = 'block';
          
          let typeText = '';
          if (currentContext.type === 'group') {
            typeText = 'ç¾¤çµ„';
            groupId.textContent = currentContext.groupId || 'ç„¡æ³•å–å¾—';
          } else if (currentContext.type === 'room') {
            typeText = 'èŠå¤©å®¤';
            groupId.textContent = currentContext.roomId || 'ç„¡æ³•å–å¾—';
          } else if (currentContext.type === 'utou') {
            typeText = 'ä¸€å°ä¸€èŠå¤©';
            groupId.textContent = '(ä¸€å°ä¸€èŠå¤©)';
          } else {
            typeText = currentContext.type || 'æœªçŸ¥';
            groupId.textContent = 'ç„¡æ³•å–å¾—';
          }
          contextType.textContent = typeText;
        }
        
        // LIFF åˆå§‹åŒ–æˆåŠŸ
        statusDiv.className = 'status success';
        statusDiv.textContent = 'âœ“ LIFF åˆå§‹åŒ–æˆåŠŸï¼å¯ä»¥é–‹å§‹ä½¿ç”¨';
        
        // å•Ÿç”¨æ‰€æœ‰è¼¸å…¥
        enableAllInputs();
        
      } catch (error) {
        statusDiv.className = 'status error';
        statusDiv.textContent = 'âœ— åˆå§‹åŒ–å¤±æ•—: ' + error.message;
        console.error('LIFF åˆå§‹åŒ–éŒ¯èª¤:', error);
      }
    }

    function enableAllInputs() {
      document.getElementById('textMessage').disabled = false;
      document.getElementById('sendTextBtn').disabled = false;
      document.getElementById('flexTemplate').disabled = false;
      document.getElementById('flexJson').disabled = false;
      document.getElementById('previewFlexBtn').disabled = false;
      document.getElementById('sendFlexBtn').disabled = false;
    }

    // åˆ‡æ› Tab
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');
    }

    // è¼‰å…¥ç¯„æœ¬
    function loadTemplate() {
      const template = document.getElementById('flexTemplate').value;
      const templateFields = document.getElementById('templateFields');
      const flexJson = document.getElementById('flexJson');
      
      // éš±è—æ‰€æœ‰ç¯„æœ¬æ¬„ä½
      document.querySelectorAll('.template-fields').forEach(field => {
        field.style.display = 'none';
      });
      
      if (!template) {
        templateFields.style.display = 'none';
        flexJson.value = '';
        return;
      }
      
      if (template === 'custom') {
        templateFields.style.display = 'none';
        flexJson.value = '';
        return;
      }
      
      templateFields.style.display = 'block';
      document.getElementById(template + 'Fields').style.display = 'block';
      
      // æ ¹æ“šç¯„æœ¬ç”Ÿæˆåˆå§‹ JSON
      generateFlexJson(template);
    }

    // ç”Ÿæˆ Flex Message JSON
    function generateFlexJson(template) {
      let json = {};
      
      switch(template) {
        case 'bubble':
          const title = document.getElementById('bubbleTitle').value || 'æ¨™é¡Œ';
          const text = document.getElementById('bubbleText').value || 'å…§å®¹æ–‡å­—';
          const image = document.getElementById('bubbleImage').value || 'https://via.placeholder.com/1024x768';
          const color = document.getElementById('bubbleColor').value;
          
          json = {
            type: "bubble",
            hero: {
              type: "image",
              url: image,
              size: "full",
              aspectRatio: "20:13",
              aspectMode: "cover"
            },
            body: {
              type: "box",
              layout: "vertical",
              contents: [
                {
                  type: "text",
                  text: title,
                  weight: "bold",
                  size: "xl",
                  color: color
                },
                {
                  type: "text",
                  text: text,
                  wrap: true,
                  margin: "md"
                }
              ]
            }
          };
          break;
          
        case 'notification':
          json = {
            type: "bubble",
            body: {
              type: "box",
              layout: "vertical",
              contents: [
                {
                  type: "text",
                  text: document.getElementById('notifTitle').value || "é€šçŸ¥",
                  weight: "bold",
                  size: "xl",
                  color: "#FF6B6B"
                },
                {
                  type: "box",
                  layout: "vertical",
                  margin: "lg",
                  spacing: "sm",
                  contents: [
                    {
                      type: "text",
                      text: document.getElementById('notifMessage').value || "é€šçŸ¥å…§å®¹",
                      wrap: true,
                      size: "md"
                    },
                    {
                      type: "text",
                      text: document.getElementById('notifTime').value || new Date().toLocaleString('zh-TW'),
                      size: "xs",
                      color: "#999999",
                      margin: "md"
                    }
                  ]
                }
              ]
            }
          };
          break;
          
        case 'product':
          json = {
            type: "bubble",
            hero: {
              type: "image",
              url: document.getElementById('productImage').value || "https://via.placeholder.com/1024x1024",
              size: "full",
              aspectRatio: "1:1",
              aspectMode: "cover"
            },
            body: {
              type: "box",
              layout: "vertical",
              contents: [
                {
                  type: "text",
                  text: document.getElementById('productName').value || "ç”¢å“åç¨±",
                  weight: "bold",
                  size: "xl"
                },
                {
                  type: "text",
                  text: document.getElementById('productDesc').value || "ç”¢å“æè¿°",
                  wrap: true,
                  size: "sm",
                  margin: "md"
                },
                {
                  type: "text",
                  text: document.getElementById('productPrice').value || "NT$ 999",
                  size: "xxl",
                  weight: "bold",
                  color: "#00B900",
                  margin: "lg"
                }
              ]
            }
          };
          break;
          
        case 'event':
          json = {
            type: "bubble",
            hero: {
              type: "image",
              url: document.getElementById('eventImage').value || "https://via.placeholder.com/1024x768",
              size: "full",
              aspectRatio: "20:13",
              aspectMode: "cover"
            },
            body: {
              type: "box",
              layout: "vertical",
              contents: [
                {
                  type: "text",
                  text: document.getElementById('eventName').value || "æ´»å‹•åç¨±",
                  weight: "bold",
                  size: "xl"
                },
                {
                  type: "box",
                  layout: "vertical",
                  margin: "lg",
                  spacing: "sm",
                  contents: [
                    {
                      type: "box",
                      layout: "baseline",
                      spacing: "sm",
                      contents: [
                        {
                          type: "text",
                          text: "æ—¥æœŸ",
                          color: "#aaaaaa",
                          size: "sm",
                          flex: 1
                        },
                        {
                          type: "text",
                          text: document.getElementById('eventDate').value || "2025/10/20",
                          wrap: true,
                          color: "#666666",
                          size: "sm",
                          flex: 4
                        }
                      ]
                    },
                    {
                      type: "box",
                      layout: "baseline",
                      spacing: "sm",
                      contents: [
                        {
                          type: "text",
                          text: "åœ°é»",
                          color: "#aaaaaa",
                          size: "sm",
                          flex: 1
                        },
                        {
                          type: "text",
                          text: document.getElementById('eventLocation').value || "æ´»å‹•åœ°é»",
                          wrap: true,
                          color: "#666666",
                          size: "sm",
                          flex: 4
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          };
          break;
      }
      
      document.getElementById('flexJson').value = JSON.stringify(json, null, 2);
    }

    // ç›£è½ç¯„æœ¬æ¬„ä½è®ŠåŒ–
    document.addEventListener('input', (e) => {
      if (e.target.closest('.template-fields')) {
        const template = document.getElementById('flexTemplate').value;
        if (template && template !== 'custom') {
          generateFlexJson(template);
        }
      }
      
      // åŒæ­¥é¡è‰²é¸æ“‡å™¨
      if (e.target.id === 'bubbleColor') {
        document.getElementById('bubbleColorText').value = e.target.value;
      }
    });

    // ç™¼é€æ–‡å­—è¨Šæ¯
    async function sendTextMessage() {
      const message = document.getElementById('textMessage').value.trim();
      
      if (!message) {
        alert('è«‹è¼¸å…¥è¨Šæ¯å…§å®¹');
        return;
      }
      
      try {
        await liff.sendMessages([
          {
            type: 'text',
            text: message
          }
        ]);
        
        statusDiv.className = 'status success';
        statusDiv.textContent = 'âœ“ æ–‡å­—è¨Šæ¯ç™¼é€æˆåŠŸï¼';
        document.getElementById('textMessage').value = '';
        
        setTimeout(() => {
          liff.closeWindow();
        }, 2000);
        
      } catch (error) {
        statusDiv.className = 'status error';
        statusDiv.textContent = 'âœ— ç™¼é€å¤±æ•—: ' + error.message;
        console.error('ç™¼é€è¨Šæ¯éŒ¯èª¤:', error);
      }
    }

    // é è¦½ Flex Message
    function previewFlexMessage() {
      const flexJson = document.getElementById('flexJson').value.trim();
      const previewBox = document.getElementById('previewBox');
      const previewContent = document.getElementById('previewContent');
      
      if (!flexJson) {
        alert('è«‹è¼¸å…¥ Flex Message JSON');
        return;
      }
      
      try {
        const json = JSON.parse(flexJson);
        previewContent.innerHTML = '<pre>' + JSON.stringify(json, null, 2) + '</pre>';
        previewBox.style.display = 'block';
        
        statusDiv.className = 'status success';
        statusDiv.textContent = 'âœ“ JSON æ ¼å¼æ­£ç¢º';
      } catch (error) {
        statusDiv.className = 'status error';
        statusDiv.textContent = 'âœ— JSON æ ¼å¼éŒ¯èª¤: ' + error.message;
        previewBox.style.display = 'none';
      }
    }

    // ç™¼é€ Flex Message
    async function sendFlexMessage() {
      const flexJson = document.getElementById('flexJson').value.trim();
      
      if (!flexJson) {
        alert('è«‹è¼¸å…¥ Flex Message JSON');
        return;
      }
      
      try {
        const flexContent = JSON.parse(flexJson);
        
        await liff.sendMessages([
          {
            type: 'flex',
            altText: 'Flex Message',
            contents: flexContent
          }
        ]);
        
        statusDiv.className = 'status success';
        statusDiv.textContent = 'âœ“ Flex Message ç™¼é€æˆåŠŸï¼';
        
        setTimeout(() => {
          liff.closeWindow();
        }, 2000);
        
      } catch (error) {
        statusDiv.className = 'status error';
        statusDiv.textContent = 'âœ— ç™¼é€å¤±æ•—: ' + error.message;
        console.error('ç™¼é€ Flex Message éŒ¯èª¤:', error);
      }
    }

    // äº‹ä»¶ç›£è½
    document.getElementById('sendTextBtn').addEventListener('click', sendTextMessage);
    document.getElementById('previewFlexBtn').addEventListener('click', previewFlexMessage);
    document.getElementById('sendFlexBtn').addEventListener('click', sendFlexMessage);

    // åˆå§‹åŒ–
    initializeLiff();
  </script>
</body>
</html>
