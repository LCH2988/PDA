<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ - ç®¡ç†ç³»çµ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', 'PingFang TC', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background: white;
      border-radius: 12px;
      padding: 20px 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      color: #667eea;
      font-size: 24px;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 15px;
      background: #f5f5f5;
      border-radius: 20px;
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #667eea;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .card h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }
    
    .card h3 {
      color: #555;
      margin: 20px 0 15px 0;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-secondary {
      background: #2196F3;
      color: white;
    }
    
    .btn-success {
      background: #4CAF50;
      color: white;
    }
    
    .btn-danger {
      background: #f44336;
      color: white;
    }
    
    .btn-warning {
      background: #ff9800;
      color: white;
    }
    
    .btn-outline {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
    }
    
    .loading::after {
      content: '';
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .message {
      padding: 15px 20px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .message-error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #f44336;
    }
    
    .message-success {
      background: #e8f5e9;
      color: #2e7d32;
      border-left: 4px solid #4CAF50;
    }
    
    .message-info {
      background: #e3f2fd;
      color: #1565c0;
      border-left: 4px solid #2196F3;
    }
    
    .message-warning {
      background: #fff3e0;
      color: #e65100;
      border-left: 4px solid #ff9800;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stat-card h4 {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 10px;
    }
    
    .stat-card .stat-value {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-card .stat-label {
      font-size: 12px;
      opacity: 0.8;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    table th,
    table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    table th {
      background: #f5f5f5;
      font-weight: 600;
      color: #555;
    }
    
    table tr:hover {
      background: #f9f9f9;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-success {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .badge-warning {
      background: #fff3e0;
      color: #e65100;
    }
    
    .badge-danger {
      background: #ffebee;
      color: #c62828;
    }
    
    .badge-info {
      background: #e3f2fd;
      color: #1565c0;
    }
    
    .badge-secondary {
      background: #f5f5f5;
      color: #666;
    }
    
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .nav-tab {
      padding: 10px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.3s;
    }
    
    .nav-tab:hover {
      color: #667eea;
    }
    
    .nav-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h3 {
      margin: 0;
      color: #333;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    
    .modal-close:hover {
      color: #333;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .pagination button {
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .pagination button:hover:not(:disabled) {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .pagination button.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .search-bar input {
      flex: 1;
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .empty-state svg {
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
      opacity: 0.3;
    }
    
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .login-card {
      background: white;
      border-radius: 12px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .login-card h2 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
    }
    
    .login-card .logo {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .login-card .logo svg {
      width: 80px;
      height: 80px;
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .table-container {
        font-size: 12px;
      }
      
      table th,
      table td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    // ==================== é…ç½® ====================
    const CONFIG = {
      API_URL: 'https://script.google.com/macros/s/AKfycbyOBTgry9skxZWTxh4DeWkIQNj_zBglxNLpa7aPuINqdOi9m5tUf8j-hZakJdCSso92/exec', // è«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS Web App URL
      STORAGE_KEYS: {
        TOKEN: 'pda_token',
        USER: 'pda_user'
      },
      MEMBER_STATUS: {
        ACTIVE: 'æ­£å¸¸',
        PENDING: 'å¾…å¯©æ ¸',
        INACTIVE: 'åœæ¬Š'
      },
      ACTIVITY_STATUS: {
        REGISTRATION: 'å ±åä¸­',
        FULL: 'å·²é¡æ»¿',
        ONGOING: 'é€²è¡Œä¸­',
        COMPLETED: 'å·²çµæŸ',
        CANCELLED: 'å·²å–æ¶ˆ'
      },
      REGISTRATION_STATUS: {
        REGISTERED: 'å·²å ±å',
        WAITLIST: 'å€™è£œ',
        ATTENDED: 'å·²å‡ºå¸­',
        ABSENT: 'ç¼ºå¸­',
        CANCELLED: 'å·²å–æ¶ˆ'
      }
    };

    // ==================== API æœå‹™ ====================
    class APIService {
      static async call(action, data = {}) {
        try {
          const response = await fetch(CONFIG.API_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              action: action,
              ...data
            })
          });

          if (!response.ok) {
            throw new Error('ç¶²è·¯è«‹æ±‚å¤±æ•—');
          }

          const result = await response.json();
          return result;

        } catch (error) {
          console.error('API Error:', error);
          return {
            success: false,
            error: error.message || 'ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦'
          };
        }
      }

      // èªè­‰ç›¸é—œ
      static login(email, password) {
        return this.call('login', { email, password });
      }

      static register(memberData) {
        return this.call('register', memberData);
      }

      static resetPassword(email) {
        return this.call('resetPassword', { email });
      }

      // æœƒå“¡ç›¸é—œ
      static getMembers(page = 1, filters = {}) {
        return this.call('getMembers', { page, itemsPerPage: 20, filters });
      }

      static getMemberDetail(memberId) {
        return this.call('getMemberDetail', { memberId });
      }

      static updateMember(memberId, updateData) {
        return this.call('updateMember', { memberId, updateData });
      }

      static deleteMember(memberId) {
        return this.call('deleteMember', { memberId });
      }

      static getMemberStatistics() {
        return this.call('getMemberStatistics');
      }

      // æ´»å‹•ç›¸é—œ
      static getActivities(page = 1, status = null) {
        return this.call('getActivities', { page, itemsPerPage: 20, status });
      }

      static getActivityDetail(activityId) {
        return this.call('getActivityDetail', { activityId });
      }

      static createActivity(activityData) {
        return this.call('createActivity', activityData);
      }

      static updateActivity(activityId, updateData) {
        return this.call('updateActivity', { activityId, updateData });
      }

      static deleteActivity(activityId) {
        return this.call('deleteActivity', { activityId });
      }

      static cancelActivity(activityId, reason) {
        return this.call('cancelActivity', { activityId, reason });
      }

      static getActivityStatistics() {
        return this.call('getActivityStatistics');
      }

      // å ±åç›¸é—œ
      static registerActivity(memberId, activityId, notes = '') {
        return this.call('registerActivity', { memberId, activityId, notes });
      }

      static cancelRegistration(registrationId, reason = '') {
        return this.call('cancelRegistration', { registrationId, reason });
      }

      static checkIn(registrationId) {
        return this.call('checkIn', { registrationId });
      }

      static getMemberRegistrations(memberId, filters = {}) {
        return this.call('getMemberRegistrations', { memberId, filters });
      }

      static getActivityRegistrations(activityId, status = null) {
        return this.call('getActivityRegistrations', { activityId, status });
      }

      // è²¡å‹™ç›¸é—œ
      static addFinanceRecord(financeData) {
        return this.call('addFinanceRecord', financeData);
      }

      static getFinanceRecords(filters = {}, page = 1) {
        return this.call('getFinanceRecords', { filters, page, itemsPerPage: 20 });
      }

      static updateFinanceRecord(recordId, updateData) {
        return this.call('updateFinanceRecord', { recordId, updateData });
      }

      static deleteFinanceRecord(recordId) {
        return this.call('deleteFinanceRecord', { recordId });
      }

      static getFinanceStatistics(startDate, endDate) {
        return this.call('getFinanceStatistics', { startDate, endDate });
      }

      // å„€è¡¨æ¿
      static getDashboardData() {
        return this.call('getDashboardData');
      }

      // å ±è¡¨
      static generateMemberReport(startDate, endDate) {
        return this.call('generateMemberReport', { startDate, endDate });
      }

      static generateActivityReport(startDate, endDate) {
        return this.call('generateActivityReport', { startDate, endDate });
      }

      static generateAttendanceReport(activityId = null) {
        return this.call('generateAttendanceReport', { activityId });
      }

      // æœå°‹
      static globalSearch(keyword) {
        return this.call('globalSearch', { keyword });
      }

      static advancedMemberSearch(criteria) {
        return this.call('advancedMemberSearch', criteria);
      }

      static advancedActivitySearch(criteria) {
        return this.call('advancedActivitySearch', criteria);
      }

      // é€šçŸ¥
      static sendBulkNotification(recipientIds, title, content, type) {
        return this.call('sendBulkNotification', { recipientIds, title, content, type });
      }

      static sendToAllMembers(title, content) {
        return this.call('sendToAllMembers', { title, content });
      }

      // å‚™ä»½
      static backupAllData() {
        return this.call('backupAllData');
      }

      static listBackups() {
        return this.call('listBackups');
      }

      static restoreData(fileId) {
        return this.call('restoreData', { fileId });
      }
    }

    // ==================== èªè­‰æœå‹™ ====================
    class AuthService {
      static getUser() {
        const userStr = localStorage.getItem(CONFIG.STORAGE_KEYS.USER);
        return userStr ? JSON.parse(userStr) : null;
      }

      static getToken() {
        return localStorage.getItem(CONFIG.STORAGE_KEYS.TOKEN);
      }

      static setAuth(token, user) {
        localStorage.setItem(CONFIG.STORAGE_KEYS.TOKEN, token);
        localStorage.setItem(CONFIG.STORAGE_KEYS.USER, JSON.stringify(user));
      }

      static clearAuth() {
        localStorage.removeItem(CONFIG.STORAGE_KEYS.TOKEN);
        localStorage.removeItem(CONFIG.STORAGE_KEYS.USER);
      }

      static isAuthenticated() {
        return !!this.getToken();
      }

      static isAdmin() {
        const user = this.getUser();
        return user && user.role === 'admin';
      }
    }

    // ==================== UI å·¥å…· ====================
    class UIUtils {
      static showLoading(message = 'è¼‰å…¥ä¸­...') {
        return `<div class="loading">${message}</div>`;
      }

      static showMessage(message, type = 'info') {
        return `<div class="message message-${type}">${message}</div>`;
      }

      static showError(message) {
        return this.showMessage(message, 'error');
      }

      static showSuccess(message) {
        return this.showMessage(message, 'success');
      }

      static showWarning(message) {
        return this.showMessage(message, 'warning');
      }

      static formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
      }

      static formatDateTime(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      static getStatusBadge(status, type = 'member') {
        const badges = {
          member: {
            'æ­£å¸¸': 'success',
            'å¾…å¯©æ ¸': 'warning',
            'åœæ¬Š': 'danger'
          },
          activity: {
            'å ±åä¸­': 'success',
            'å·²é¡æ»¿': 'warning',
            'é€²è¡Œä¸­': 'info',
            'å·²çµæŸ': 'secondary',
            'å·²å–æ¶ˆ': 'danger'
          },
          registration: {
            'å·²å ±å': 'success',
            'å€™è£œ': 'warning',
            'å·²å‡ºå¸­': 'info',
            'ç¼ºå¸­': 'danger',
            'å·²å–æ¶ˆ': 'secondary'
          }
        };

        const badgeType = badges[type][status] || 'secondary';
        return `<span class="badge badge-${badgeType}">${status}</span>`;
      }

      static createPagination(currentPage, totalPages, onPageChange) {
        if (totalPages <= 1) return '';

        let html = '<div class="pagination">';
        
        // ä¸Šä¸€é 
        html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="${onPageChange}(${currentPage - 1})">ä¸Šä¸€é </button>`;
        
        // é ç¢¼
        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<button class="${i === currentPage ? 'active' : ''}" onclick="${onPageChange}(${i})">${i}</button>`;
          } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<button disabled>...</button>';
          }
        }
        
        // ä¸‹ä¸€é 
        html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="${onPageChange}(${currentPage + 1})">ä¸‹ä¸€é </button>`;
        
        html += '</div>';
        return html;
      }

      static showModal(title, content, onClose = null) {
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3>${title}</h3>
              <button class="modal-close" onclick="this.closest('.modal').remove(); ${onClose ? onClose + '()' : ''}">&times;</button>
            </div>
            <div class="modal-body">
              ${content}
            </div>
          </div>
        `;
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
            if (onClose) onClose();
          }
        });
        
        document.body.appendChild(modal);
        return modal;
      }

      static confirmDialog(message, onConfirm, onCancel = null) {
        const content = `
          <p style="margin-bottom: 20px;">${message}</p>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove(); ${onCancel ? onCancel + '()' : ''}">å–æ¶ˆ</button>
            <button class="btn btn-danger" onclick="this.closest('.modal').remove(); ${onConfirm}()">ç¢ºèª</button>
          </div>
        `;
        
        return this.showModal('ç¢ºèªæ“ä½œ', content);
      }
    }

    // ==================== æ‡‰ç”¨ç¨‹å¼ ====================
    class App {
      constructor() {
        this.currentView = null;
        this.currentPage = 1;
        this.init();
      }

      init() {
        if (AuthService.isAuthenticated()) {
          this.showDashboard();
        } else {
          this.showLogin();
        }
      }

      render(content) {
        document.getElementById('root').innerHTML = content;
      }

      // ==================== ç™»å…¥é é¢ ====================
      showLogin() {
        this.currentView = 'login';
        
        const html = `
          <div class="login-container">
            <div class="login-card">
              <div class="logo">
                <svg viewBox="0 0 100 100" fill="#667eea">
                  <circle cx="50" cy="50" r="45" fill="none" stroke="#667eea" stroke-width="3"/>
                  <path d="M30,50 L45,65 L70,35" fill="none" stroke="#667eea" stroke-width="5" stroke-linecap="round"/>
                </svg>
              </div>
              <h2>å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ</h2>
              <div id="loginMessage"></div>
              <form onsubmit="app.handleLogin(event)">
                <div class="form-group">
                  <label>é›»å­éƒµä»¶</label>
                  <input type="email" id="loginEmail" required placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶">
                </div>
                <div class="form-group">
                  <label>å¯†ç¢¼</label>
                  <input type="password" id="loginPassword" required placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">ç™»å…¥</button>
                <button type="button" class="btn btn-outline" style="width: 100%;" onclick="app.showRegister()">è¨»å†Šæ–°å¸³è™Ÿ</button>
              </form>
              <div style="text-align: center; margin-top: 15px;">
                <a href="#" onclick="app.showResetPassword(); return false;" style="color: #667eea; text-decoration: none; font-size: 14px;">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</a>
              </div>
            </div>
          </div>
        `;
        
        this.render(html);
      }

      async handleLogin(event) {
        event.preventDefault();
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const messageDiv = document.getElementById('loginMessage');
        
        messageDiv.innerHTML = UIUtils.showLoading('ç™»å…¥ä¸­...');
        
        const result = await APIService.login(email, password);
        
        if (result.success) {
          AuthService.setAuth(result.token, result.user);
          messageDiv.innerHTML = UIUtils.showSuccess('ç™»å…¥æˆåŠŸï¼');
          setTimeout(() => this.showDashboard(), 500);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error || 'ç™»å…¥å¤±æ•—');
        }
      }

      // ==================== è¨»å†Šé é¢ ====================
      showRegister() {
        this.currentView = 'register';
        
        const html = `
          <div class="login-container">
            <div class="login-card" style="max-width: 600px;">
              <h2>æœƒå“¡è¨»å†Š</h2>
              <div id="registerMessage"></div>
              <form onsubmit="app.handleRegister(event)">
                <div class="form-row">
                  <div class="form-group">
                    <label>å§“å *</label>
                    <input type="text" id="regName" required>
                  </div>
                  <div class="form-group">
                    <label>æ€§åˆ¥ *</label>
                    <select id="regGender" required>
                      <option value="">è«‹é¸æ“‡</option>
                      <option value="ç”·">ç”·</option>
                      <option value="å¥³">å¥³</option>
                      <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label>é›»å­éƒµä»¶ *</label>
                    <input type="email" id="regEmail" required>
                  </div>
                  <div class="form-group">
                    <label>æ‰‹æ©Ÿè™Ÿç¢¼ *</label>
                    <input type="tel" id="regPhone" required>
                  </div>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label>å¯†ç¢¼ *</label>
                    <input type="password" id="regPassword" required minlength="6">
                  </div>
                  <div class="form-group">
                    <label>ç¢ºèªå¯†ç¢¼ *</label>
                    <input type="password" id="regPasswordConfirm" required minlength="6">
                  </div>
                </div>
                
                <div class="form-group">
                  <label>å‡ºç”Ÿæ—¥æœŸ</label>
                  <input type="date" id="regBirthDate">
                </div>
                
                <div class="form-group">
                  <label>åœ°å€</label>
                  <input type="text" id="regAddress">
                </div>
                
                <div style="display: flex; gap: 10px;">
                  <button type="button" class="btn btn-secondary" onclick="app.showLogin()">è¿”å›ç™»å…¥</button>
                  <button type="submit" class="btn btn-primary" style="flex: 1;">è¨»å†Š</button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        this.render(html);
      }

      async handleRegister(event) {
        event.preventDefault();
        
        const password = document.getElementById('regPassword').value;
        const passwordConfirm = document.getElementById('regPasswordConfirm').value;
        const messageDiv = document.getElementById('registerMessage');
        
        if (password !== passwordConfirm) {
          messageDiv.innerHTML = UIUtils.showError('å¯†ç¢¼ä¸ä¸€è‡´');
          return;
        }
        
        const memberData = {
          name: document.getElementById('regName').value,
          gender: document.getElementById('regGender').value,
          email: document.getElementById('regEmail').value,
          phone: document.getElementById('regPhone').value,
          password: password,
          birthDate: document.getElementById('regBirthDate').value,
          address: document.getElementById('regAddress').value
        };
        
        messageDiv.innerHTML = UIUtils.showLoading('è¨»å†Šä¸­...');
        
        const result = await APIService.register(memberData);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess('è¨»å†ŠæˆåŠŸï¼è«‹ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸ã€‚');
          setTimeout(() => this.showLogin(), 2000);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error || 'è¨»å†Šå¤±æ•—');
        }
      }

      // ==================== å¿˜è¨˜å¯†ç¢¼ ====================
      showResetPassword() {
        const content = `
          <div id="resetMessage"></div>
          <div class="form-group">
            <label>é›»å­éƒµä»¶</label>
            <input type="email" id="resetEmail" placeholder="è«‹è¼¸å…¥è¨»å†Šæ™‚çš„é›»å­éƒµä»¶">
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="app.handleResetPassword()">ç™¼é€é‡è¨­é€£çµ</button>
          </div>
        `;
        
        UIUtils.showModal('é‡è¨­å¯†ç¢¼', content);
      }

      async handleResetPassword() {
        const email = document.getElementById('resetEmail').value;
        const messageDiv = document.getElementById('resetMessage');
        
        if (!email) {
          messageDiv.innerHTML = UIUtils.showError('è«‹è¼¸å…¥é›»å­éƒµä»¶');
          return;
        }
        
        messageDiv.innerHTML = UIUtils.showLoading('ç™¼é€ä¸­...');
        
        const result = await APIService.resetPassword(email);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess('é‡è¨­é€£çµå·²ç™¼é€åˆ°æ‚¨çš„ä¿¡ç®±');
          setTimeout(() => {
            document.querySelector('.modal').remove();
          }, 2000);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error || 'ç™¼é€å¤±æ•—');
        }
      }

      // ==================== å„€è¡¨æ¿ ====================
      async showDashboard() {
        this.currentView = 'dashboard';
        const user = AuthService.getUser();
        
        this.render(UIUtils.showLoading('è¼‰å…¥å„€è¡¨æ¿...'));
        
        const result = await APIService.getDashboardData();
        
        if (!result.success) {
          this.render(UIUtils.showError(result.error));
          return;
        }
        
        const data = result.data;
        
        const html = `
          <div class="header">
            <h1>ğŸ¥ å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ</h1>
            <div class="header-actions">
              <div class="user-info">
                <div class="user-avatar">${user.name.charAt(0)}</div>
                <span>${user.name}</span>
              </div>
              <button class="btn btn-secondary btn-sm" onclick="app.showProfile()">å€‹äººè³‡æ–™</button>
              ${user.role === 'admin' ? '<button class="btn btn-warning btn-sm" onclick="app.showAdminPanel()">ç®¡ç†å¾Œå°</button>' : ''}
              <button class="btn btn-danger btn-sm" onclick="app.handleLogout()">ç™»å‡º</button>
            </div>
          </div>
          
          <div class="container">
            <div class="card">
              <h2>ğŸ“Š ç³»çµ±æ¦‚æ³</h2>
              <div class="stats-grid">
                <div class="stat-card">
                  <h4>æœƒå“¡ç¸½æ•¸</h4>
                  <div class="stat-value">${data.summary.members.total}</div>
                  <div class="stat-label">æœ¬æœˆæ–°å¢ ${data.summary.members.thisMonth} äºº</div>
                </div>
                <div class="stat-card">
                  <h4>æ´»å‹•ç¸½æ•¸</h4>
                  <div class="stat-value">${data.summary.activities.total}</div>
                  <div class="stat-label">æœ¬æœˆèˆ‰è¾¦ ${data.summary.activities.thisMonth} å ´</div>
                </div>
                <div class="stat-card">
                  <h4>æœ¬æœˆè²¡å‹™</h4>
                  <div class="stat-value">$${data.summary.finance.balance.toLocaleString()}</div>
                  <div class="stat-label">æ”¶å…¥ $${data.summary.finance.totalIncome.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                  <h4>ç¸½åƒèˆ‡äººæ¬¡</h4>
                  <div class="stat-value">${data.summary.activities.totalParticipants}</div>
                  <div class="stat-label">å¹³å‡ ${data.summary.activities.averageParticipants} äºº/å ´</div>
                </div>
              </div>
            </div>
            
            ${data.alerts.length > 0 ? `
            <div class="card">
              <h2>âš ï¸ ç³»çµ±è­¦ç¤º</h2>
              ${data.alerts.map(alert => `
                <div class="message message-${alert.type}">
                  <strong>${alert.title}</strong><br>
                  ${alert.message}
                </div>
              `).join('')}
            </div>
            ` : ''}
            
            <div class="card">
              <h2>ğŸ“… å³å°‡èˆ‰è¡Œçš„æ´»å‹•</h2>
              ${data.upcomingActivities.length > 0 ? `
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>æ´»å‹•åç¨±</th>
                        <th>æ—¥æœŸ</th>
                        <th>åœ°é»</th>
                        <th>å‰©é¤˜åé¡</th>
                        <th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data.upcomingActivities.map(activity => `
                        <tr>
                          <td>${activity.name}</td>
                          <td>${UIUtils.formatDate(activity.date)}</td>
                          <td>${activity.location}</td>
                          <td>${activity.vacancy > 0 ? activity.vacancy + ' å€‹' : 'å·²é¡æ»¿'}</td>
                          <td>
                            <button class="btn btn-primary btn-sm" onclick="app.showActivityDetail('${activity.id}')">æŸ¥çœ‹è©³æƒ…</button>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              ` : '<div class="empty-state">ç›®å‰æ²’æœ‰å³å°‡èˆ‰è¡Œçš„æ´»å‹•</div>'}
              <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="app.showActivities()">æŸ¥çœ‹æ‰€æœ‰æ´»å‹•</button>
              </div>
            </div>
            
            <div class="card">
              <h2>ğŸ“ æœ€è¿‘çš„å ±åè¨˜éŒ„</h2>
              ${data.recentRegistrations.length > 0 ? `
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>æœƒå“¡</th>
                        <th>æ´»å‹•</th>
                        <th>å ±åæ™‚é–“</th>
                        <th>ç‹€æ…‹</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data.recentRegistrations.map(reg => `
                        <tr>
                          <td>${reg.memberName}</td>
                          <td>${reg.activityName}</td>
                          <td>${UIUtils.formatDateTime(reg.time)}</td>
                          <td>${UIUtils.getStatusBadge(reg.status, 'registration')}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              ` : '<div class="empty-state">ç›®å‰æ²’æœ‰å ±åè¨˜éŒ„</div>'}
            </div>
          </div>
        `;
        
        this.render(html);
      }

      // ==================== æ´»å‹•åˆ—è¡¨ ====================
      async showActivities(page = 1, status = null) {
        this.currentView = 'activities';
        this.currentPage = page;
        
        this.renderWithHeader(UIUtils.showLoading('è¼‰å…¥æ´»å‹•åˆ—è¡¨...'));
        
        const result = await APIService.getActivities(page, status);
        
        if (!result.success) {
          this.renderWithHeader(UIUtils.showError(result.error));
          return;
        }
        
        const html = `
          <div class="card">
            <h2>ğŸ¯ æ´»å‹•åˆ—è¡¨</h2>
            
            <div class="nav-tabs">
              <button class="nav-tab ${!status ? 'active' : ''}" onclick="app.showActivities(1, null)">å…¨éƒ¨</button>
              <button class="nav-tab ${status === 'å ±åä¸­' ? 'active' : ''}" onclick="app.showActivities(1, 'å ±åä¸­')">å ±åä¸­</button>
              <button class="nav-tab ${status === 'å·²é¡æ»¿' ? 'active' : ''}" onclick="app.showActivities(1, 'å·²é¡æ»¿')">å·²é¡æ»¿</button>
              <button class="nav-tab ${status === 'å·²çµæŸ' ? 'active' : ''}" onclick="app.showActivities(1, 'å·²çµæŸ')">å·²çµæŸ</button>
            </div>
            
            ${result.data.length > 0 ? `
              <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                ${result.data.map(activity => `
                  <div class="card" style="margin: 0;">
                    <h3>${activity['æ´»å‹•åç¨±']}</h3>
                    <p><strong>æ—¥æœŸï¼š</strong>${UIUtils.formatDate(activity['æ—¥æœŸ'])}</p>
                    <p><strong>æ™‚é–“ï¼š</strong>${activity['é–‹å§‹æ™‚é–“']} - ${activity['çµæŸæ™‚é–“']}</p>
                    <p><strong>åœ°é»ï¼š</strong>${activity['åœ°é»']}</p>
                    <p><strong>è¬›å¸«ï¼š</strong>${activity['è¬›å¸«'] || 'ç„¡'}</p>
                    <p><strong>åé¡ï¼š</strong>${activity['ç›®å‰å ±åæ•¸']}/${activity['å ±åä¸Šé™']}</p>
                    <p>${UIUtils.getStatusBadge(activity['ç‹€æ…‹'], 'activity')}</p>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                      <button class="btn btn-secondary btn-sm" style="flex: 1;" onclick="app.showActivityDetail('${activity['ID']}')">æŸ¥çœ‹è©³æƒ…</button>
                      ${activity['å¯å ±å'] ? `<button class="btn btn-primary btn-sm" style="flex: 1;" onclick="app.handleRegisterActivity('${activity['ID']}')">ç«‹å³å ±å</button>` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
              
              ${UIUtils.createPagination(result.pagination.currentPage, result.pagination.totalPages, `app.showActivities`)}
            ` : '<div class="empty-state">ç›®å‰æ²’æœ‰æ´»å‹•</div>'}
          </div>
        `;
        
        this.renderWithHeader(html);
      }

      // ==================== æ´»å‹•è©³æƒ… ====================
      async showActivityDetail(activityId) {
        this.renderWithHeader(UIUtils.showLoading('è¼‰å…¥æ´»å‹•è©³æƒ…...'));
        
        const result = await APIService.getActivityDetail(activityId);
        
        if (!result.success) {
          this.renderWithHeader(UIUtils.showError(result.error));
          return;
        }
        
        const activity = result.data;
        const user = AuthService.getUser();
        
        // æª¢æŸ¥æ˜¯å¦å·²å ±å
        const registrations = await APIService.getMemberRegistrations(user.id);
        const hasRegistered = registrations.success && 
          registrations.data.some(r => r['æ´»å‹•ID'] === activityId && r['ç‹€æ…‹'] !== 'å·²å–æ¶ˆ');
        
        const html = `
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
              <div>
                <h2>${activity['æ´»å‹•åç¨±']}</h2>
                <p style="color: #666; margin-top: 5px;">${activity['é¡å‹'] || 'ä¸€èˆ¬æ´»å‹•'}</p>
              </div>
              <div>
                ${UIUtils.getStatusBadge(activity['ç‹€æ…‹'], 'activity')}
              </div>
            </div>
            
            <div class="form-row">
              <div>
                <p><strong>ğŸ“… æ—¥æœŸï¼š</strong>${UIUtils.formatDate(activity['æ—¥æœŸ'])}</p>
                <p><strong>ğŸ• æ™‚é–“ï¼š</strong>${activity['é–‹å§‹æ™‚é–“']} - ${activity['çµæŸæ™‚é–“']}</p>
                <p><strong>ğŸ“ åœ°é»ï¼š</strong>${activity['åœ°é»']}</p>
              </div>
              <div>
                <p><strong>ğŸ‘¨â€ğŸ« è¬›å¸«ï¼š</strong>${activity['è¬›å¸«'] || 'ç„¡'}</p>
                <p><strong>ğŸ‘¥ åé¡ï¼š</strong>${activity['ç›®å‰å ±åæ•¸']}/${activity['å ±åä¸Šé™']}</p>
                <p><strong>ğŸ“ å ±åæˆªæ­¢ï¼š</strong>${UIUtils.formatDate(activity['å ±åæˆªæ­¢æ—¥'])}</p>
              </div>
            </div>
            
            ${activity['æè¿°'] ? `
              <div style="margin-top: 20px;">
                <h3>æ´»å‹•èªªæ˜</h3>
                <p style="white-space: pre-wrap;">${activity['æè¿°']}</p>
              </div>
            ` : ''}
            
            ${activity['æ´»å‹•å…§å®¹'] ? `
              <div style="margin-top: 20px;">
                <h3>æ´»å‹•å…§å®¹</h3>
                <p style="white-space: pre-wrap;">${activity['æ´»å‹•å…§å®¹']}</p>
              </div>
            ` : ''}
            
            ${activity['æ³¨æ„äº‹é …'] ? `
              <div style="margin-top: 20px;">
                <h3>æ³¨æ„äº‹é …</h3>
                <p style="white-space: pre-wrap;">${activity['æ³¨æ„äº‹é …']}</p>
              </div>
            ` : ''}
            
            <div style="display: flex; gap: 10px; margin-top: 30px;">
              <button class="btn btn-secondary" onclick="app.showActivities()">è¿”å›åˆ—è¡¨</button>
              ${!hasRegistered && activity['å‰©é¤˜åé¡'] > 0 && activity['ç‹€æ…‹'] === 'å ±åä¸­' ? 
                `<button class="btn btn-primary" onclick="app.handleRegisterActivity('${activityId}')">ç«‹å³å ±å</button>` : ''}
              ${hasRegistered ? 
                `<button class="btn btn-warning" onclick="app.showMyRegistrations()">æŸ¥çœ‹æˆ‘çš„å ±å</button>` : ''}
            </div>
          </div>
        `;
        
        this.renderWithHeader(html);
      }

      // ==================== å ±åæ´»å‹• ====================
      async handleRegisterActivity(activityId) {
        const user = AuthService.getUser();
        
        const content = `
          <div id="regMessage"></div>
          <p>ç¢ºèªè¦å ±åæ­¤æ´»å‹•å—ï¼Ÿ</p>
          <div class="form-group">
            <label>å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
            <textarea id="regNotes" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚è«‹åœ¨æ­¤èªªæ˜"></textarea>
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="app.confirmRegisterActivity('${activityId}')">ç¢ºèªå ±å</button>
          </div>
        `;
        
        UIUtils.showModal('å ±åæ´»å‹•', content);
      }

      async confirmRegisterActivity(activityId) {
        const user = AuthService.getUser();
        const notes = document.getElementById('regNotes').value;
        const messageDiv = document.getElementById('regMessage');
        
        messageDiv.innerHTML = UIUtils.showLoading('å ±åä¸­...');
        
        const result = await APIService.registerActivity(user.id, activityId, notes);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess(result.message);
          setTimeout(() => {
            document.querySelector('.modal').remove();
            this.showActivityDetail(activityId);
          }, 1500);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      // ==================== æˆ‘çš„å ±å ====================
      async showMyRegistrations() {
        const user = AuthService.getUser();
        
        this.renderWithHeader(UIUtils.showLoading('è¼‰å…¥å ±åè¨˜éŒ„...'));
        
        const result = await APIService.getMemberRegistrations(user.id);
        
        if (!result.success) {
          this.renderWithHeader(UIUtils.showError(result.error));
          return;
        }
        
        const html = `
          <div class="card">
            <h2>ğŸ“ æˆ‘çš„å ±åè¨˜éŒ„</h2>
            
            ${result.data.length > 0 ? `
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>æ´»å‹•åç¨±</th>
                      <th>æ´»å‹•æ—¥æœŸ</th>
                      <th>åœ°é»</th>
                      <th>å ±åæ™‚é–“</th>
                      <th>ç‹€æ…‹</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${result.data.map(reg => `
                      <tr>
                        <td>${reg['æ´»å‹•åç¨±']}</td>
                        <td>${UIUtils.formatDate(reg['æ´»å‹•æ—¥æœŸ'])}</td>
                        <td>${reg['æ´»å‹•åœ°é»']}</td>
                        <td>${UIUtils.formatDateTime(reg['å ±åæ™‚é–“'])}</td>
                        <td>${UIUtils.getStatusBadge(reg['ç‹€æ…‹'], 'registration')}</td>
                        <td>
                          <button class="btn btn-secondary btn-sm" onclick="app.showActivityDetail('${reg['æ´»å‹•ID']}')">æŸ¥çœ‹</button>
                          ${reg['ç‹€æ…‹'] === 'å·²å ±å' || reg['ç‹€æ…‹'] === 'å€™è£œ' ? 
                            `<button class="btn btn-danger btn-sm" onclick="app.handleCancelRegistration('${reg['ID']}')">å–æ¶ˆ</button>` : ''}
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            ` : '<div class="empty-state">æ‚¨é‚„æ²’æœ‰å ±åä»»ä½•æ´»å‹•</div>'}
          </div>
        `;
        
        this.renderWithHeader(html);
      }

      // ==================== å–æ¶ˆå ±å ====================
      async handleCancelRegistration(registrationId) {
        const content = `
          <div id="cancelMessage"></div>
          <p>ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ</p>
          <div class="form-group">
            <label>å–æ¶ˆåŸå› ï¼ˆé¸å¡«ï¼‰</label>
            <textarea id="cancelReason" placeholder="è«‹èªªæ˜å–æ¶ˆåŸå› "></textarea>
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">è¿”å›</button>
            <button class="btn btn-danger" onclick="app.confirmCancelRegistration('${registrationId}')">ç¢ºèªå–æ¶ˆ</button>
          </div>
        `;
        
        UIUtils.showModal('å–æ¶ˆå ±å', content);
      }

      async confirmCancelRegistration(registrationId) {
        const reason = document.getElementById('cancelReason').value;
        const messageDiv = document.getElementById('cancelMessage');
        
        messageDiv.innerHTML = UIUtils.showLoading('è™•ç†ä¸­...');
        
        const result = await APIService.cancelRegistration(registrationId, reason);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess(result.message);
          setTimeout(() => {
            document.querySelector('.modal').remove();
            this.showMyRegistrations();
          }, 1500);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      // ==================== å€‹äººè³‡æ–™ ====================
      async showProfile() {
        const user = AuthService.getUser();
        
        this.renderWithHeader(UIUtils.showLoading('è¼‰å…¥å€‹äººè³‡æ–™...'));
        
        const result = await APIService.getMemberDetail(user.id);
        
        if (!result.success) {
          this.renderWithHeader(UIUtils.showError(result.error));
          return;
        }
        
        const member = result.data;
        
        const html = `
          <div class="card">
            <h2>ğŸ‘¤ å€‹äººè³‡æ–™</h2>
            <div id="profileMessage"></div>
            
            <form onsubmit="app.handleUpdateProfile(event)">
              <div class="form-row">
                <div class="form-group">
                  <label>å§“å</label>
                  <input type="text" id="profileName" value="${member['å§“å']}" required>
                </div>
                <div class="form-group">
                  <label>æ€§åˆ¥</label>
                  <select id="profileGender" required>
                    <option value="ç”·" ${member['æ€§åˆ¥'] === 'ç”·' ? 'selected' : ''}>ç”·</option>
                    <option value="å¥³" ${member['æ€§åˆ¥'] === 'å¥³' ? 'selected' : ''}>å¥³</option>
                    <option value="å…¶ä»–" ${member['æ€§åˆ¥'] === 'å…¶ä»–' ? 'selected' : ''}>å…¶ä»–</option>
                  </select>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label>é›»å­éƒµä»¶</label>
                  <input type="email" id="profileEmail" value="${member['é›»å­éƒµä»¶']}" required>
                </div>
                <div class="form-group">
                  <label>æ‰‹æ©Ÿè™Ÿç¢¼</label>
                  <input type="tel" id="profilePhone" value="${member['æ‰‹æ©Ÿè™Ÿç¢¼']}" required>
                </div>
              </div>
              
              <div class="form-group">
                <label>å‡ºç”Ÿæ—¥æœŸ</label>
                <input type="date" id="profileBirthDate" value="${member['å‡ºç”Ÿæ—¥æœŸ'] || ''}">
              </div>
              
              <div class="form-group">
                <label>åœ°å€</label>
                <input type="text" id="profileAddress" value="${member['åœ°å€'] || ''}">
              </div>
              
              <div class="form-group">
                <label>ç·Šæ€¥è¯çµ¡äºº</label>
                <input type="text" id="profileEmergencyContact" value="${member['ç·Šæ€¥è¯çµ¡äºº'] || ''}">
              </div>
              
              <div class="form-group">
                <label>ç·Šæ€¥è¯çµ¡é›»è©±</label>
                <input type="tel" id="profileEmergencyPhone" value="${member['ç·Šæ€¥è¯çµ¡é›»è©±'] || ''}">
              </div>
              
              <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-secondary" onclick="app.showDashboard()">è¿”å›</button>
                <button type="submit" class="btn btn-primary">å„²å­˜è®Šæ›´</button>
              </div>
            </form>
          </div>
          
          <div class="card">
            <h3>ğŸ”’ è®Šæ›´å¯†ç¢¼</h3>
            <div id="passwordMessage"></div>
            <form onsubmit="app.handleChangePassword(event)">
              <div class="form-group">
                <label>ç›®å‰å¯†ç¢¼</label>
                <input type="password" id="currentPassword" required>
              </div>
              <div class="form-group">
                <label>æ–°å¯†ç¢¼</label>
                <input type="password" id="newPassword" required minlength="6">
              </div>
              <div class="form-group">
                <label>ç¢ºèªæ–°å¯†ç¢¼</label>
                <input type="password" id="confirmPassword" required minlength="6">
              </div>
              <button type="submit" class="btn btn-warning">è®Šæ›´å¯†ç¢¼</button>
            </form>
          </div>
        `;
        
        this.renderWithHeader(html);
      }

      async handleUpdateProfile(event) {
        event.preventDefault();
        
        const user = AuthService.getUser();
        const messageDiv = document.getElementById('profileMessage');
        
        const updateData = {
          å§“å: document.getElementById('profileName').value,
          æ€§åˆ¥: document.getElementById('profileGender').value,
          é›»å­éƒµä»¶: document.getElementById('profileEmail').value,
          æ‰‹æ©Ÿè™Ÿç¢¼: document.getElementById('profilePhone').value,
          å‡ºç”Ÿæ—¥æœŸ: document.getElementById('profileBirthDate').value,
          åœ°å€: document.getElementById('profileAddress').value,
          ç·Šæ€¥è¯çµ¡äºº: document.getElementById('profileEmergencyContact').value,
          ç·Šæ€¥è¯çµ¡é›»è©±: document.getElementById('profileEmergencyPhone').value
        };
        
        messageDiv.innerHTML = UIUtils.showLoading('æ›´æ–°ä¸­...');
        
        const result = await APIService.updateMember(user.id, updateData);
        
        if (result.success) {
          // æ›´æ–°æœ¬åœ°ç”¨æˆ¶è³‡æ–™
          user.name = updateData.å§“å;
          user.email = updateData.é›»å­éƒµä»¶;
          AuthService.setAuth(AuthService.getToken(), user);
          
          messageDiv.innerHTML = UIUtils.showSuccess('è³‡æ–™æ›´æ–°æˆåŠŸï¼');
          setTimeout(() => {
            messageDiv.innerHTML = '';
          }, 3000);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      async handleChangePassword(event) {
        event.preventDefault();
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const messageDiv = document.getElementById('passwordMessage');
        
        if (newPassword !== confirmPassword) {
          messageDiv.innerHTML = UIUtils.showError('æ–°å¯†ç¢¼ä¸ä¸€è‡´');
          return;
        }
        
        const user = AuthService.getUser();
        messageDiv.innerHTML = UIUtils.showLoading('è®Šæ›´ä¸­...');
        
        // å…ˆé©—è­‰èˆŠå¯†ç¢¼
        const loginResult = await APIService.login(user.email, currentPassword);
        
        if (!loginResult.success) {
          messageDiv.innerHTML = UIUtils.showError('ç›®å‰å¯†ç¢¼éŒ¯èª¤');
          return;
        }
        
        // æ›´æ–°å¯†ç¢¼
        const result = await APIService.updateMember(user.id, { password: newPassword });
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess('å¯†ç¢¼è®Šæ›´æˆåŠŸï¼');
          document.getElementById('currentPassword').value = '';
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmPassword').value = '';
          setTimeout(() => {
            messageDiv.innerHTML = '';
          }, 3000);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      // ==================== ç®¡ç†å¾Œå° ====================
      async showAdminPanel() {
        if (!AuthService.isAdmin()) {
          this.renderWithHeader(UIUtils.showError('æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤é é¢'));
          return;
        }
        
        this.currentView = 'admin';
        
        const html = `
          <div class="card">
            <h2>âš™ï¸ ç®¡ç†å¾Œå°</h2>
            
            <div class="nav-tabs">
              <button class="nav-tab active" onclick="app.showAdminMembers()">æœƒå“¡ç®¡ç†</button>
              <button class="nav-tab" onclick="app.showAdminActivities()">æ´»å‹•ç®¡ç†</button>
              <button class="nav-tab" onclick="app.showAdminFinance()">è²¡å‹™ç®¡ç†</button>
              <button class="nav-tab" onclick="app.showAdminReports()">å ±è¡¨åˆ†æ</button>
              <button class="nav-tab" onclick="app.showAdminNotifications()">é€šçŸ¥ç®¡ç†</button>
              <button class="nav-tab" onclick="app.showAdminBackup()">ç³»çµ±å‚™ä»½</button>
            </div>
            
            <div id="adminContent"></div>
          </div>
        `;
        
        this.renderWithHeader(html);
        this.showAdminMembers();
      }

      // ==================== æœƒå“¡ç®¡ç† ====================
      async showAdminMembers(page = 1, status = null) {
        const contentDiv = document.getElementById('adminContent');
        if (!contentDiv) return;
        
        contentDiv.innerHTML = UIUtils.showLoading('è¼‰å…¥æœƒå“¡åˆ—è¡¨...');
        
        const filters = status ? { 'ç‹€æ…‹': status } : {};
        const result = await APIService.getMembers(page, filters);
        
        if (!result.success) {
          contentDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const html = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <button class="btn ${!status ? 'btn-primary' : 'btn-outline'} btn-sm" onclick="app.showAdminMembers(1, null)">å…¨éƒ¨</button>
              <button class="btn ${status === 'æ­£å¸¸' ? 'btn-primary' : 'btn-outline'} btn-sm" onclick="app.showAdminMembers(1, 'æ­£å¸¸')">æ­£å¸¸</button>
              <button class="btn ${status === 'å¾…å¯©æ ¸' ? 'btn-primary' : 'btn-outline'} btn-sm" onclick="app.showAdminMembers(1, 'å¾…å¯©æ ¸')">å¾…å¯©æ ¸</button>
              <button class="btn ${status === 'åœæ¬Š' ? 'btn-primary' : 'btn-outline'} btn-sm" onclick="app.showAdminMembers(1, 'åœæ¬Š')">åœæ¬Š</button>
            </div>
            <div class="search-bar" style="margin: 0; width: 300px;">
              <input type="text" id="memberSearch" placeholder="æœå°‹æœƒå“¡...">
              <button class="btn btn-secondary" onclick="app.searchMembers()">æœå°‹</button>
            </div>
          </div>
          
          ${result.data.length > 0 ? `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>å§“å</th>
                    <th>æ€§åˆ¥</th>
                    <th>é›»å­éƒµä»¶</th>
                    <th>æ‰‹æ©Ÿ</th>
                    <th>åŠ å…¥æ—¥æœŸ</th>
                    <th>ç‹€æ…‹</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.data.map(member => `
                    <tr>
                      <td>${member['ID']}</td>
                      <td>${member['å§“å']}</td>
                      <td>${member['æ€§åˆ¥']}</td>
                      <td>${member['é›»å­éƒµä»¶']}</td>
                      <td>${member['æ‰‹æ©Ÿè™Ÿç¢¼']}</td>
                      <td>${UIUtils.formatDate(member['åŠ å…¥æ—¥æœŸ'])}</td>
                      <td>${UIUtils.getStatusBadge(member['ç‹€æ…‹'], 'member')}</td>
                      <td>
                        <button class="btn btn-secondary btn-sm" onclick="app.showMemberDetail('${member['ID']}')">æŸ¥çœ‹</button>
                        ${member['ç‹€æ…‹'] === 'å¾…å¯©æ ¸' ? 
                          `<button class="btn btn-success btn-sm" onclick="app.approveMember('${member['ID']}')">å¯©æ ¸</button>` : ''}
                        ${member['ç‹€æ…‹'] === 'æ­£å¸¸' ? 
                          `<button class="btn btn-warning btn-sm" onclick="app.suspendMember('${member['ID']}')">åœæ¬Š</button>` : ''}
                        ${member['ç‹€æ…‹'] === 'åœæ¬Š' ? 
                          `<button class="btn btn-success btn-sm" onclick="app.activateMember('${member['ID']}')">å•Ÿç”¨</button>` : ''}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            ${UIUtils.createPagination(result.pagination.currentPage, result.pagination.totalPages, `app.showAdminMembers`)}
          ` : '<div class="empty-state">æ²’æœ‰æ‰¾åˆ°æœƒå“¡</div>'}
        `;
        
        contentDiv.innerHTML = html;
      }

      async searchMembers() {
        const keyword = document.getElementById('memberSearch').value;
        if (!keyword) {
          this.showAdminMembers();
          return;
        }
        
        const contentDiv = document.getElementById('adminContent');
        contentDiv.innerHTML = UIUtils.showLoading('æœå°‹ä¸­...');
        
        const result = await APIService.globalSearch(keyword);
        
        if (!result.success) {
          contentDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const html = `
          <h3>æœå°‹çµæœï¼š${result.totalResults} ç­†</h3>
          
          ${result.data.members.length > 0 ? `
            <h4>æœƒå“¡ (${result.data.members.length})</h4>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>å§“å</th>
                    <th>é›»å­éƒµä»¶</th>
                    <th>æ‰‹æ©Ÿ</th>
                    <th>ç‹€æ…‹</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.data.members.map(member => `
                    <tr>
                      <td>${member.id}</td>
                      <td>${member.name}</td>
                      <td>${member.email}</td>
                      <td>${member.phone}</td>
                      <td>${UIUtils.getStatusBadge(member.status, 'member')}</td>
                      <td>
                        <button class="btn btn-secondary btn-sm" onclick="app.showMemberDetail('${member.id}')">æŸ¥çœ‹</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : ''}
          
          ${result.data.activities.length > 0 ? `
            <h4 style="margin-top: 30px;">æ´»å‹• (${result.data.activities.length})</h4>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>æ´»å‹•åç¨±</th>
                    <th>æ—¥æœŸ</th>
                    <th>åœ°é»</th>
                    <th>ç‹€æ…‹</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.data.activities.map(activity => `
                    <tr>
                      <td>${activity.id}</td>
                      <td>${activity.name}</td>
                      <td>${UIUtils.formatDate(activity.date)}</td>
                      <td>${activity.location}</td>
                      <td>${UIUtils.getStatusBadge(activity.status, 'activity')}</td>
                      <td>
                        <button class="btn btn-secondary btn-sm" onclick="app.showActivityDetail('${activity.id}')">æŸ¥çœ‹</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : ''}
          
          <button class="btn btn-secondary" style="margin-top: 20px;" onclick="app.showAdminMembers()">è¿”å›åˆ—è¡¨</button>
        `;
        
        contentDiv.innerHTML = html;
      }

      async showMemberDetail(memberId) {
        const modal = UIUtils.showModal('æœƒå“¡è©³æƒ…', UIUtils.showLoading('è¼‰å…¥ä¸­...'));
        
        const result = await APIService.getMemberDetail(memberId);
        
        if (!result.success) {
          modal.querySelector('.modal-body').innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const member = result.data;
        
        const html = `
          <div class="form-row">
            <div>
              <p><strong>IDï¼š</strong>${member['ID']}</p>
              <p><strong>å§“åï¼š</strong>${member['å§“å']}</p>
              <p><strong>æ€§åˆ¥ï¼š</strong>${member['æ€§åˆ¥']}</p>
              <p><strong>å‡ºç”Ÿæ—¥æœŸï¼š</strong>${UIUtils.formatDate(member['å‡ºç”Ÿæ—¥æœŸ'])}</p>
            </div>
            <div>
              <p><strong>é›»å­éƒµä»¶ï¼š</strong>${member['é›»å­éƒµä»¶']}</p>
              <p><strong>æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</strong>${member['æ‰‹æ©Ÿè™Ÿç¢¼']}</p>
              <p><strong>åœ°å€ï¼š</strong>${member['åœ°å€'] || 'æœªå¡«å¯«'}</p>
              <p><strong>ç‹€æ…‹ï¼š</strong>${UIUtils.getStatusBadge(member['ç‹€æ…‹'], 'member')}</p>
            </div>
          </div>
          
          <div style="margin-top: 20px;">
            <p><strong>ç·Šæ€¥è¯çµ¡äººï¼š</strong>${member['ç·Šæ€¥è¯çµ¡äºº'] || 'æœªå¡«å¯«'}</p>
            <p><strong>ç·Šæ€¥è¯çµ¡é›»è©±ï¼š</strong>${member['ç·Šæ€¥è¯çµ¡é›»è©±'] || 'æœªå¡«å¯«'}</p>
            <p><strong>åŠ å…¥æ—¥æœŸï¼š</strong>${UIUtils.formatDateTime(member['åŠ å…¥æ—¥æœŸ'])}</p>
          </div>
          
          <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">é—œé–‰</button>
          </div>
        `;
        
        modal.querySelector('.modal-body').innerHTML = html;
      }

      async approveMember(memberId) {
        UIUtils.confirmDialog('ç¢ºå®šè¦å¯©æ ¸é€šéæ­¤æœƒå“¡å—ï¼Ÿ', `app.confirmApproveMember('${memberId}')`);
      }

      async confirmApproveMember(memberId) {
        const result = await APIService.updateMember(memberId, { ç‹€æ…‹: 'æ­£å¸¸' });
        
        if (result.success) {
          alert('å¯©æ ¸æˆåŠŸï¼');
          this.showAdminMembers();
        } else {
          alert('å¯©æ ¸å¤±æ•—ï¼š' + result.error);
        }
      }

      async suspendMember(memberId) {
        UIUtils.confirmDialog('ç¢ºå®šè¦åœæ¬Šæ­¤æœƒå“¡å—ï¼Ÿ', `app.confirmSuspendMember('${memberId}')`);
      }

      async confirmSuspendMember(memberId) {
        const result = await APIService.updateMember(memberId, { ç‹€æ…‹: 'åœæ¬Š' });
        
        if (result.success) {
          alert('å·²åœæ¬Šï¼');
          this.showAdminMembers();
        } else {
          alert('æ“ä½œå¤±æ•—ï¼š' + result.error);
        }
      }

      async activateMember(memberId) {
        const result = await APIService.updateMember(memberId, { ç‹€æ…‹: 'æ­£å¸¸' });
        
        if (result.success) {
          alert('å·²å•Ÿç”¨ï¼');
          this.showAdminMembers();
        } else {
          alert('æ“ä½œå¤±æ•—ï¼š' + result.error);
        }
      }

      // ==================== æ´»å‹•ç®¡ç† ====================
      async showAdminActivities(page = 1, status = null) {
        const contentDiv = document.getElementById('adminContent');
        if (!contentDiv) return;
        
        contentDiv.innerHTML = UIUtils.showLoading('è¼‰å…¥æ´»å‹•åˆ—è¡¨...');
        
        const result = await APIService.getActivities(page, status);
        
        if (!result.success) {
          contentDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const html = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <button class="btn ${!status ? 'btn-primary' : 'btn-outline'} btn-sm" onclick="app.showAdminActivities(1, null)">å…¨éƒ¨</button>
              <button class="btn ${status === 'å ±åä¸­' ? 'btn-primary' : 'btn-outline'} btn-sm" onclick="app.showAdminActivities(1, 'å ±åä¸­')">å ±åä¸­</button>
              <button class="btn ${status === 'å·²çµæŸ' ? 'btn-primary' : 'btn-outline'} btn-sm" onclick="app.showAdminActivities(1, 'å·²çµæŸ')">å·²çµæŸ</button>
            </div>
            <button class="btn btn-success" onclick="app.showCreateActivity()">+ æ–°å¢æ´»å‹•</button>
          </div>
          
          ${result.data.length > 0 ? `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>æ´»å‹•åç¨±</th>
                    <th>æ—¥æœŸ</th>
                    <th>åœ°é»</th>
                    <th>è¬›å¸«</th>
                    <th>å ±åäººæ•¸</th>
                    <th>ç‹€æ…‹</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.data.map(activity => `
                    <tr>
                      <td>${activity['æ´»å‹•åç¨±']}</td>
                      <td>${UIUtils.formatDate(activity['æ—¥æœŸ'])}</td>
                      <td>${activity['åœ°é»']}</td>
                      <td>${activity['è¬›å¸«'] || '-'}</td>
                      <td>${activity['ç›®å‰å ±åæ•¸']}/${activity['å ±åä¸Šé™']}</td>
                      <td>${UIUtils.getStatusBadge(activity['ç‹€æ…‹'], 'activity')}</td>
                      <td>
                        <button class="btn btn-secondary btn-sm" onclick="app.showAdminActivityDetail('${activity['ID']}')">æŸ¥çœ‹</button>
                        <button class="btn btn-primary btn-sm" onclick="app.showEditActivity('${activity['ID']}')">ç·¨è¼¯</button>
                        ${activity['ç‹€æ…‹'] !== 'å·²å–æ¶ˆ' ? 
                          `<button class="btn btn-danger btn-sm" onclick="app.handleCancelActivity('${activity['ID']}')">å–æ¶ˆ</button>` : ''}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            ${UIUtils.createPagination(result.pagination.currentPage, result.pagination.totalPages, `app.showAdminActivities`)}
          ` : '<div class="empty-state">æ²’æœ‰æ´»å‹•</div>'}
        `;
        
        contentDiv.innerHTML = html;
      }

      showCreateActivity() {
        const content = `
          <div id="activityMessage"></div>
          <form onsubmit="app.handleCreateActivity(event)">
            <div class="form-row">
              <div class="form-group">
                <label>æ´»å‹•åç¨± *</label>
                <input type="text" id="activityName" required>
              </div>
              <div class="form-group">
                <label>æ´»å‹•é¡å‹</label>
                <select id="activityType">
                  <option value="è¬›åº§">è¬›åº§</option>
                  <option value="é‹å‹•èª²ç¨‹">é‹å‹•èª²ç¨‹</option>
                  <option value="ç¤¾äº¤æ´»å‹•">ç¤¾äº¤æ´»å‹•</option>
                  <option value="å¥åº·æª¢æŸ¥">å¥åº·æª¢æŸ¥</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>æ—¥æœŸ *</label>
                <input type="date" id="activityDate" required>
              </div>
              <div class="form-group">
                <label>é–‹å§‹æ™‚é–“ *</label>
                <input type="time" id="activityStartTime" required>
              </div>
              <div class="form-group">
                <label>çµæŸæ™‚é–“ *</label>
                <input type="time" id="activityEndTime" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>åœ°é» *</label>
                <input type="text" id="activityLocation" required>
              </div>
              <div class="form-group">
                <label>è¬›å¸«</label>
                <input type="text" id="activityInstructor">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>å ±åä¸Šé™ *</label>
                <input type="number" id="activityMaxParticipants" required min="1" value="30">
              </div>
              <div class="form-group">
                <label>å ±åæˆªæ­¢æ—¥ *</label>
                <input type="date" id="activityDeadline" required>
              </div>
            </div>
            
            <div class="form-group">
              <label>æ´»å‹•æè¿°</label>
              <textarea id="activityDescription" rows="3"></textarea>
            </div>
            
            <div class="form-group">
              <label>æ´»å‹•å…§å®¹</label>
              <textarea id="activityContent" rows="4"></textarea>
            </div>
            
            <div class="form-group">
              <label>æ³¨æ„äº‹é …</label>
              <textarea id="activityNotes" rows="3"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
              <button type="submit" class="btn btn-success">å»ºç«‹æ´»å‹•</button>
            </div>
          </form>
        `;
        
        UIUtils.showModal('æ–°å¢æ´»å‹•', content);
      }

      async handleCreateActivity(event) {
        event.preventDefault();
        
        const user = AuthService.getUser();
        const messageDiv = document.getElementById('activityMessage');
        
        const activityData = {
          name: document.getElementById('activityName').value,
          type: document.getElementById('activityType').value,
          date: document.getElementById('activityDate').value,
          startTime: document.getElementById('activityStartTime').value,
          endTime: document.getElementById('activityEndTime').value,
          location: document.getElementById('activityLocation').value,
          instructor: document.getElementById('activityInstructor').value,
          maxParticipants: document.getElementById('activityMaxParticipants').value,
          registrationDeadline: document.getElementById('activityDeadline').value,
          description: document.getElementById('activityDescription').value,
          content: document.getElementById('activityContent').value,
          notes: document.getElementById('activityNotes').value,
          creatorId: user.id
        };
        
        messageDiv.innerHTML = UIUtils.showLoading('å»ºç«‹ä¸­...');
        
        const result = await APIService.createActivity(activityData);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess('æ´»å‹•å»ºç«‹æˆåŠŸï¼');
          setTimeout(() => {
            document.querySelector('.modal').remove();
            this.showAdminActivities();
          }, 1500);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      async showAdminActivityDetail(activityId) {
        const modal = UIUtils.showModal('æ´»å‹•è©³æƒ…', UIUtils.showLoading('è¼‰å…¥ä¸­...'));
        
        const result = await APIService.getActivityDetail(activityId);
        
        if (!result.success) {
          modal.querySelector('.modal-body').innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const activity = result.data;
        
        // å–å¾—å ±ååå–®
        const registrations = await APIService.getActivityRegistrations(activityId);
        
        const html = `
          <div class="form-row">
            <div>
              <p><strong>æ´»å‹•åç¨±ï¼š</strong>${activity['æ´»å‹•åç¨±']}</p>
              <p><strong>é¡å‹ï¼š</strong>${activity['é¡å‹']}</p>
              <p><strong>æ—¥æœŸï¼š</strong>${UIUtils.formatDate(activity['æ—¥æœŸ'])}</p>
              <p><strong>æ™‚é–“ï¼š</strong>${activity['é–‹å§‹æ™‚é–“']} - ${activity['çµæŸæ™‚é–“']}</p>
            </div>
            <div>
              <p><strong>åœ°é»ï¼š</strong>${activity['åœ°é»']}</p>
              <p><strong>è¬›å¸«ï¼š</strong>${activity['è¬›å¸«'] || 'ç„¡'}</p>
              <p><strong>å ±åäººæ•¸ï¼š</strong>${activity['ç›®å‰å ±åæ•¸']}/${activity['å ±åä¸Šé™']}</p>
              <p><strong>ç‹€æ…‹ï¼š</strong>${UIUtils.getStatusBadge(activity['ç‹€æ…‹'], 'activity')}</p>
            </div>
          </div>
          
          ${activity['æè¿°'] ? `<p style="margin-top: 15px;"><strong>æè¿°ï¼š</strong>${activity['æè¿°']}</p>` : ''}
          
          <h4 style="margin-top: 20px;">å ±ååå–® (${registrations.success ? registrations.data.length : 0})</h4>
          ${registrations.success && registrations.data.length > 0 ? `
            <div class="table-container" style="max-height: 300px; overflow-y: auto;">
              <table>
                <thead>
                  <tr>
                    <th>å§“å</th>
                    <th>é›»è©±</th>
                    <th>å ±åæ™‚é–“</th>
                    <th>ç‹€æ…‹</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  ${registrations.data.map(reg => `
                    <tr>
                      <td>${reg['æœƒå“¡å§“å']}</td>
                      <td>${reg['æœƒå“¡é›»è©±']}</td>
                      <td>${UIUtils.formatDateTime(reg['å ±åæ™‚é–“'])}</td>
                      <td>${UIUtils.getStatusBadge(reg['ç‹€æ…‹'], 'registration')}</td>
                      <td>
                        ${reg['ç‹€æ…‹'] === 'å·²å ±å' ? 
                          `<button class="btn btn-success btn-sm" onclick="app.handleCheckIn('${reg['ID']}')">ç°½åˆ°</button>` : ''}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : '<p>ç›®å‰æ²’æœ‰å ±åè¨˜éŒ„</p>'}
          
          <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">é—œé–‰</button>
            <button class="btn btn-primary" onclick="app.exportRegistrations('${activityId}')">åŒ¯å‡ºåå–®</button>
          </div>
        `;
        
        modal.querySelector('.modal-body').innerHTML = html;
      }

      async handleCheckIn(registrationId) {
        const result = await APIService.checkIn(registrationId);
        
        if (result.success) {
          alert('ç°½åˆ°æˆåŠŸï¼');
          // é‡æ–°è¼‰å…¥ç•¶å‰é é¢
          const modal = document.querySelector('.modal');
          if (modal) {
            modal.remove();
          }
        } else {
          alert('ç°½åˆ°å¤±æ•—ï¼š' + result.error);
        }
      }

      async handleCancelActivity(activityId) {
        const content = `
          <div id="cancelActivityMessage"></div>
          <p>ç¢ºå®šè¦å–æ¶ˆæ­¤æ´»å‹•å—ï¼Ÿç³»çµ±å°‡é€šçŸ¥æ‰€æœ‰å·²å ±åçš„æœƒå“¡ã€‚</p>
          <div class="form-group">
            <label>å–æ¶ˆåŸå›  *</label>
            <textarea id="cancelActivityReason" required placeholder="è«‹èªªæ˜å–æ¶ˆåŸå› "></textarea>
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">è¿”å›</button>
            <button class="btn btn-danger" onclick="app.confirmCancelActivity('${activityId}')">ç¢ºèªå–æ¶ˆ</button>
          </div>
        `;
        
        UIUtils.showModal('å–æ¶ˆæ´»å‹•', content);
      }

      async confirmCancelActivity(activityId) {
        const reason = document.getElementById('cancelActivityReason').value;
        const messageDiv = document.getElementById('cancelActivityMessage');
        
        if (!reason) {
          messageDiv.innerHTML = UIUtils.showError('è«‹å¡«å¯«å–æ¶ˆåŸå› ');
          return;
        }
        
        messageDiv.innerHTML = UIUtils.showLoading('è™•ç†ä¸­...');
        
        const result = await APIService.cancelActivity(activityId, reason);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess(result.message);
          setTimeout(() => {
            document.querySelector('.modal').remove();
            this.showAdminActivities();
          }, 1500);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      // ==================== è²¡å‹™ç®¡ç† ====================
      async showAdminFinance(page = 1) {
        const contentDiv = document.getElementById('adminContent');
        if (!contentDiv) return;
        
        contentDiv.innerHTML = UIUtils.showLoading('è¼‰å…¥è²¡å‹™è¨˜éŒ„...');
        
        const result = await APIService.getFinanceRecords({}, page);
        
        if (!result.success) {
          contentDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        // å–å¾—çµ±è¨ˆè³‡æ–™
        const stats = await APIService.getFinanceStatistics();
        
        const html = `
          ${stats.success ? `
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 30px;">
              <div class="stat-card" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                <h4>ç¸½æ”¶å…¥</h4>
                <div class="stat-value">$${stats.data.totalIncome.toLocaleString()}</div>
                <div class="stat-label">${stats.data.incomeCount} ç­†</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%);">
                <h4>ç¸½æ”¯å‡º</h4>
                <div class="stat-value">$${stats.data.totalExpense.toLocaleString()}</div>
                <div class="stat-label">${stats.data.expenseCount} ç­†</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
                <h4>ç¸½ææ¬¾</h4>
                <div class="stat-value">$${stats.data.totalDonation.toLocaleString()}</div>
                <div class="stat-label">${stats.data.donationCount} ç­†</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                <h4>é¤˜é¡</h4>
                <div class="stat-value">$${stats.data.balance.toLocaleString()}</div>
                <div class="stat-label">æ·¨é¡</div>
              </div>
            </div>
          ` : ''}
          
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>è²¡å‹™è¨˜éŒ„</h3>
            <button class="btn btn-success" onclick="app.showAddFinanceRecord()">+ æ–°å¢è¨˜éŒ„</button>
          </div>
          
          ${result.data.length > 0 ? `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>æ—¥æœŸ</th>
                    <th>é¡å‹</th>
                    <th>é¡åˆ¥</th>
                    <th>æè¿°</th>
                    <th>é‡‘é¡</th>
                    <th>ä»˜æ¬¾æ–¹å¼</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.data.map(record => `
                    <tr>
                      <td>${UIUtils.formatDate(record['æ—¥æœŸ'])}</td>
                      <td>${record['é¡å‹']}</td>
                      <td>${record['é¡åˆ¥']}</td>
                      <td>${record['æè¿°']}</td>
                      <td style="color: ${record['é¡å‹'] === 'æ”¯å‡º' ? '#f44336' : '#4CAF50'}; font-weight: bold;">
                        ${record['é¡å‹'] === 'æ”¯å‡º' ? '-' : '+'}$${parseFloat(record['é‡‘é¡']).toLocaleString()}
                      </td>
                      <td>${record['ä»˜æ¬¾æ–¹å¼']}</td>
                      <td>
                        <button class="btn btn-danger btn-sm" onclick="app.deleteFinanceRecord('${record['ID']}')">åˆªé™¤</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            ${UIUtils.createPagination(result.pagination.currentPage, result.pagination.totalPages, `app.showAdminFinance`)}
          ` : '<div class="empty-state">æ²’æœ‰è²¡å‹™è¨˜éŒ„</div>'}
        `;
        
        contentDiv.innerHTML = html;
      }

      showAddFinanceRecord() {
        const content = `
          <div id="financeMessage"></div>
          <form onsubmit="app.handleAddFinanceRecord(event)">
            <div class="form-row">
              <div class="form-group">
                <label>é¡å‹ *</label>
                <select id="financeType" required>
                  <option value="æ”¶å…¥">æ”¶å…¥</option>
                  <option value="æ”¯å‡º">æ”¯å‡º</option>
                  <option value="ææ¬¾">ææ¬¾</option>
                </select>
              </div>
              <div class="form-group">
                <label>æ—¥æœŸ *</label>
                <input type="date" id="financeDate" required value="${new Date().toISOString().split('T')[0]}">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>é‡‘é¡ *</label>
                <input type="number" id="financeAmount" required min="0" step="0.01">
              </div>
              <div class="form-group">
                <label>ä»˜æ¬¾æ–¹å¼</label>
                <select id="financePaymentMethod">
                  <option value="ç¾é‡‘">ç¾é‡‘</option>
                  <option value="è½‰å¸³">è½‰å¸³</option>
                  <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                  <option value="æ”¯ç¥¨">æ”¯ç¥¨</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label>é¡åˆ¥</label>
              <input type="text" id="financeCategory" placeholder="ä¾‹å¦‚ï¼šæœƒè²»ã€æ´»å‹•è²»ç”¨ã€è¾¦å…¬ç”¨å“ç­‰">
            </div>
            
            <div class="form-group">
              <label>æè¿°</label>
              <textarea id="financeDescription" rows="3"></textarea>
            </div>
            
            <div class="form-group">
              <label>æ”¶æ“šç·¨è™Ÿ</label>
              <input type="text" id="financeReceiptNumber">
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
              <button type="submit" class="btn btn-success">æ–°å¢è¨˜éŒ„</button>
            </div>
          </form>
        `;
        
        UIUtils.showModal('æ–°å¢è²¡å‹™è¨˜éŒ„', content);
      }

      async handleAddFinanceRecord(event) {
        event.preventDefault();
        
        const user = AuthService.getUser();
        const messageDiv = document.getElementById('financeMessage');
        
        const financeData = {
          type: document.getElementById('financeType').value,
          date: document.getElementById('financeDate').value,
          amount: document.getElementById('financeAmount').value,
          paymentMethod: document.getElementById('financePaymentMethod').value,
          category: document.getElementById('financeCategory').value,
          description: document.getElementById('financeDescription').value,
          receiptNumber: document.getElementById('financeReceiptNumber').value,
          creatorId: user.id
        };
        
        messageDiv.innerHTML = UIUtils.showLoading('æ–°å¢ä¸­...');
        
        const result = await APIService.addFinanceRecord(financeData);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess('è¨˜éŒ„æ–°å¢æˆåŠŸï¼');
          setTimeout(() => {
            document.querySelector('.modal').remove();
            this.showAdminFinance();
          }, 1500);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      async deleteFinanceRecord(recordId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è²¡å‹™è¨˜éŒ„å—ï¼Ÿ')) return;
        
        const result = await APIService.deleteFinanceRecord(recordId);
        
        if (result.success) {
          alert('åˆªé™¤æˆåŠŸï¼');
          this.showAdminFinance();
        } else {
          alert('åˆªé™¤å¤±æ•—ï¼š' + result.error);
        }
      }

      // ==================== å ±è¡¨åˆ†æ ====================
      async showAdminReports() {
        const contentDiv = document.getElementById('adminContent');
        if (!contentDiv) return;
        
        const html = `
          <h3>å ±è¡¨åˆ†æ</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
            <div class="card" style="margin: 0;">
              <h4>ğŸ“Š æœƒå“¡å ±è¡¨</h4>
              <p>åˆ†ææœƒå“¡è³‡æ–™ã€æˆé•·è¶¨å‹¢ã€äººå£çµ±è¨ˆç­‰</p>
              <button class="btn btn-primary" onclick="app.generateMemberReport()">ç”Ÿæˆå ±è¡¨</button>
            </div>
            
            <div class="card" style="margin: 0;">
              <h4>ğŸ“… æ´»å‹•å ±è¡¨</h4>
              <p>åˆ†ææ´»å‹•åƒèˆ‡åº¦ã€ç†±é–€æ´»å‹•ã€å‡ºå¸­ç‡ç­‰</p>
              <button class="btn btn-primary" onclick="app.generateActivityReport()">ç”Ÿæˆå ±è¡¨</button>
            </div>
            
            <div class="card" style="margin: 0;">
              <h4>âœ… å‡ºå¸­ç‡å ±è¡¨</h4>
              <p>åˆ†æå„æ´»å‹•çš„å‡ºå¸­ç‡ã€ç¼ºå¸­æƒ…æ³ç­‰</p>
              <button class="btn btn-primary" onclick="app.generateAttendanceReport()">ç”Ÿæˆå ±è¡¨</button>
            </div>
            
            <div class="card" style="margin: 0;">
              <h4>ğŸ’° è²¡å‹™å ±è¡¨</h4>
              <p>åˆ†ææ”¶æ”¯æƒ…æ³ã€è²¡å‹™è¶¨å‹¢ç­‰</p>
              <button class="btn btn-primary" onclick="app.showFinanceReport()">æŸ¥çœ‹å ±è¡¨</button>
            </div>
          </div>
          
          <div id="reportContent" style="margin-top: 30px;"></div>
        `;
        
        contentDiv.innerHTML = html;
      }

      async generateMemberReport() {
        const reportDiv = document.getElementById('reportContent');
        reportDiv.innerHTML = UIUtils.showLoading('ç”Ÿæˆå ±è¡¨ä¸­...');
        
        const result = await APIService.generateMemberReport();
        
        if (!result.success) {
          reportDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const report = result.data;
        
        const html = `
          <div class="card">
            <h3>æœƒå“¡å ±è¡¨</h3>
            <p>çµ±è¨ˆæœŸé–“ï¼š${report.period.start} è‡³ ${report.period.end}</p>
            
            <h4>æœƒå“¡æ¦‚æ³</h4>
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
              <div class="stat-card">
                <h4>ç¸½æœƒå“¡æ•¸</h4>
                <div class="stat-value">${report.summary.total}</div>
              </div>
              <div class="stat-card">
                <h4>æ­£å¸¸æœƒå“¡</h4>
                <div class="stat-value">${report.summary.active}</div>
              </div>
              <div class="stat-card">
                <h4>å¾…å¯©æ ¸</h4>
                <div class="stat-value">${report.summary.pending}</div>
              </div>
              <div class="stat-card">
                <h4>åœæ¬Š</h4>
                <div class="stat-value">${report.summary.inactive}</div>
              </div>
            </div>
            
            <div class="form-row">
              <div>
                <h4>æ€§åˆ¥åˆ†å¸ƒ</h4>
                <ul>
                  ${Object.entries(report.demographics.byGender).map(([gender, count]) => 
                    `<li>${gender}ï¼š${count} äºº (${Math.round(count/report.summary.total*100)}%)</li>`
                  ).join('')}
                </ul>
              </div>
              
              <div>
                <h4>å¹´é½¡åˆ†å¸ƒ</h4>
                <ul>
                  ${Object.entries(report.demographics.byAge).map(([age, count]) => 
                    `<li>${age}ï¼š${count} äºº</li>`
                  ).join('')}
                </ul>
              </div>
              
              <div>
                <h4>åœ°å€åˆ†å¸ƒï¼ˆå‰5åï¼‰</h4>
                <ul>
                  ${Object.entries(report.demographics.byLocation)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([location, count]) => 
                      `<li>${location}ï¼š${count} äºº</li>`
                    ).join('')}
                </ul>
              </div>
            </div>
          </div>
        `;
        
        reportDiv.innerHTML = html;
      }

      async generateActivityReport() {
        const reportDiv = document.getElementById('reportContent');
        reportDiv.innerHTML = UIUtils.showLoading('ç”Ÿæˆå ±è¡¨ä¸­...');
        
        const result = await APIService.generateActivityReport();
        
        if (!result.success) {
          reportDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const report = result.data;
        
        const html = `
          <div class="card">
            <h3>æ´»å‹•å ±è¡¨</h3>
            <p>çµ±è¨ˆæœŸé–“ï¼š${report.period.start} è‡³ ${report.period.end}</p>
            
            <h4>æ´»å‹•æ¦‚æ³</h4>
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
              <div class="stat-card">
                <h4>ç¸½æ´»å‹•æ•¸</h4>
                <div class="stat-value">${report.summary.total}</div>
              </div>
              <div class="stat-card">
                <h4>å·²å®Œæˆ</h4>
                <div class="stat-value">${report.summary.completed}</div>
              </div>
              <div class="stat-card">
                <h4>ç¸½åƒèˆ‡äººæ¬¡</h4>
                <div class="stat-value">${report.summary.totalParticipants}</div>
              </div>
              <div class="stat-card">
                <h4>å¹³å‡å‡ºå¸­ç‡</h4>
                <div class="stat-value">${report.summary.attendanceRate}%</div>
              </div>
            </div>
            
            <div class="form-row">
              <div>
                <h4>æ´»å‹•é¡å‹åˆ†å¸ƒ</h4>
                <ul>
                  ${Object.entries(report.byType).map(([type, data]) => 
                    `<li>${type}ï¼š${data.count} å ´ï¼Œ${data.participants} äººæ¬¡</li>`
                  ).join('')}
                </ul>
              </div>
              
              <div>
                <h4>ç†±é–€åœ°é»ï¼ˆå‰5åï¼‰</h4>
                <ul>
                  ${Object.entries(report.byLocation)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 5)
                    .map(([location, data]) => 
                      `<li>${location}ï¼š${data.count} å ´</li>`
                    ).join('')}
                </ul>
              </div>
            </div>
            
            <h4>ç†±é–€æ´»å‹•æ’è¡Œï¼ˆå‰10åï¼‰</h4>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>æ’å</th>
                    <th>æ´»å‹•åç¨±</th>
                    <th>æ—¥æœŸ</th>
                    <th>åƒèˆ‡äººæ•¸</th>
                  </tr>
                </thead>
                <tbody>
                  ${report.topActivities.map((activity, index) => `
                    <tr>
                      <td>${index + 1}</td>
                      <td>${activity.name}</td>
                      <td>${UIUtils.formatDate(activity.date)}</td>
                      <td>${activity.participants}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
        
        reportDiv.innerHTML = html;
      }

      // ==================== é€šçŸ¥ç®¡ç† ====================
      async showAdminNotifications() {
        const contentDiv = document.getElementById('adminContent');
        if (!contentDiv) return;
        
        const html = `
          <h3>é€šçŸ¥ç®¡ç†</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
            <div class="card" style="margin: 0;">
              <h4>ğŸ“§ ç™¼é€é€šçŸ¥</h4>
              <p>ç™¼é€é›»å­éƒµä»¶é€šçŸ¥çµ¦é¸å®šçš„æœƒå“¡</p>
              <button class="btn btn-primary" onclick="app.showSendNotification()">ç™¼é€é€šçŸ¥</button>
            </div>
            
            <div class="card" style="margin: 0;">
              <h4>ğŸ“¢ ç¾¤ç™¼é€šçŸ¥</h4>
              <p>ç™¼é€é€šçŸ¥çµ¦æ‰€æœ‰æ­£å¸¸æœƒå“¡</p>
              <button class="btn btn-warning" onclick="app.showBroadcastNotification()">ç¾¤ç™¼é€šçŸ¥</button>
            </div>
          </div>
        `;
        
        contentDiv.innerHTML = html;
      }

      showSendNotification() {
        const content = `
          <div id="notificationMessage"></div>
          <form onsubmit="app.handleSendNotification(event)">
            <div class="form-group">
              <label>æ”¶ä»¶è€… *</label>
              <p style="font-size: 12px; color: #666;">è«‹è¼¸å…¥æœƒå“¡IDï¼Œå¤šå€‹IDè«‹ç”¨é€—è™Ÿåˆ†éš”</p>
              <textarea id="notificationRecipients" required placeholder="ä¾‹å¦‚ï¼šMEM001,MEM002,MEM003"></textarea>
            </div>
            
            <div class="form-group">
              <label>æ¨™é¡Œ *</label>
              <input type="text" id="notificationTitle" required>
            </div>
            
            <div class="form-group">
              <label>å…§å®¹ *</label>
              <textarea id="notificationContent" required rows="6"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
              <button type="submit" class="btn btn-primary">ç™¼é€</button>
            </div>
          </form>
        `;
        
        UIUtils.showModal('ç™¼é€é€šçŸ¥', content);
      }

      async handleSendNotification(event) {
        event.preventDefault();
        
        const messageDiv = document.getElementById('notificationMessage');
        const recipientsStr = document.getElementById('notificationRecipients').value;
        const title = document.getElementById('notificationTitle').value;
        const content = document.getElementById('notificationContent').value;
        
        const recipientIds = recipientsStr.split(',').map(id => id.trim());
        
        messageDiv.innerHTML = UIUtils.showLoading('ç™¼é€ä¸­...');
        
        const result = await APIService.sendBulkNotification(recipientIds, title, content, 'email');
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess(result.message);
          setTimeout(() => {
            document.querySelector('.modal').remove();
          }, 2000);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      showBroadcastNotification() {
        const content = `
          <div id="broadcastMessage"></div>
          <p style="color: #ff9800; font-weight: bold;">âš ï¸ æ­¤æ“ä½œå°‡ç™¼é€é€šçŸ¥çµ¦æ‰€æœ‰æ­£å¸¸æœƒå“¡</p>
          <form onsubmit="app.handleBroadcastNotification(event)">
            <div class="form-group">
              <label>æ¨™é¡Œ *</label>
              <input type="text" id="broadcastTitle" required>
            </div>
            
            <div class="form-group">
              <label>å…§å®¹ *</label>
              <textarea id="broadcastContent" required rows="6"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
              <button type="submit" class="btn btn-warning">ç¢ºèªç¾¤ç™¼</button>
            </div>
          </form>
        `;
        
        UIUtils.showModal('ç¾¤ç™¼é€šçŸ¥', content);
      }

      async handleBroadcastNotification(event) {
        event.preventDefault();
        
        const messageDiv = document.getElementById('broadcastMessage');
        const title = document.getElementById('broadcastTitle').value;
        const content = document.getElementById('broadcastContent').value;
        
        if (!confirm('ç¢ºå®šè¦ç™¼é€é€šçŸ¥çµ¦æ‰€æœ‰æ­£å¸¸æœƒå“¡å—ï¼Ÿ')) return;
        
        messageDiv.innerHTML = UIUtils.showLoading('ç™¼é€ä¸­...');
        
        const result = await APIService.sendBroadcastNotification(title, content, 'email');
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess(result.message);
          setTimeout(() => {
            document.querySelector('.modal').remove();
          }, 2000);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      // ==================== ç³»çµ±å‚™ä»½ ====================
      async showAdminBackup() {
        const contentDiv = document.getElementById('adminContent');
        if (!contentDiv) return;
        
        contentDiv.innerHTML = UIUtils.showLoading('è¼‰å…¥å‚™ä»½è³‡è¨Š...');
        
        const result = await APIService.getBackupList();
        
        const html = `
          <h3>ç³»çµ±å‚™ä»½</h3>
          
          <div class="card" style="margin-top: 20px;">
            <h4>å»ºç«‹æ–°å‚™ä»½</h4>
            <p>å‚™ä»½å°‡åŒ…å«æ‰€æœ‰æœƒå“¡ã€æ´»å‹•ã€å ±ååŠè²¡å‹™è³‡æ–™</p>
            <button class="btn btn-success" onclick="app.createBackup()">ç«‹å³å‚™ä»½</button>
          </div>
          
          <h4 style="margin-top: 30px;">å‚™ä»½è¨˜éŒ„</h4>
          ${result.success && result.data.length > 0 ? `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>å‚™ä»½æ™‚é–“</th>
                    <th>æª”æ¡ˆåç¨±</th>
                    <th>æª”æ¡ˆå¤§å°</th>
                    <th>å»ºç«‹è€…</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.data.map(backup => `
                    <tr>
                      <td>${UIUtils.formatDateTime(backup['å»ºç«‹æ™‚é–“'])}</td>
                      <td>${backup['æª”æ¡ˆåç¨±']}</td>
                      <td>${backup['æª”æ¡ˆå¤§å°']}</td>
                      <td>${backup['å»ºç«‹è€…']}</td>
                      <td>
                        <button class="btn btn-primary btn-sm" onclick="app.downloadBackup('${backup['ID']}')">ä¸‹è¼‰</button>
                        <button class="btn btn-danger btn-sm" onclick="app.deleteBackup('${backup['ID']}')">åˆªé™¤</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : '<div class="empty-state">ç›®å‰æ²’æœ‰å‚™ä»½è¨˜éŒ„</div>'}
        `;
        
        contentDiv.innerHTML = html;
      }

      async createBackup() {
        if (!confirm('ç¢ºå®šè¦å»ºç«‹ç³»çµ±å‚™ä»½å—ï¼Ÿ')) return;
        
        const contentDiv = document.getElementById('adminContent');
        const originalContent = contentDiv.innerHTML;
        contentDiv.innerHTML = UIUtils.showLoading('å»ºç«‹å‚™ä»½ä¸­ï¼Œè«‹ç¨å€™...');
        
        const result = await APIService.createBackup();
        
        if (result.success) {
          alert('å‚™ä»½å»ºç«‹æˆåŠŸï¼');
          this.showAdminBackup();
        } else {
          alert('å‚™ä»½å¤±æ•—ï¼š' + result.error);
          contentDiv.innerHTML = originalContent;
        }
      }

      async downloadBackup(backupId) {
        const result = await APIService.downloadBackup(backupId);
        
        if (result.success) {
          // å»ºç«‹ä¸‹è¼‰é€£çµ
          const link = document.createElement('a');
          link.href = result.data.downloadUrl;
          link.download = result.data.filename;
          link.click();
        } else {
          alert('ä¸‹è¼‰å¤±æ•—ï¼š' + result.error);
        }
      }

      async deleteBackup(backupId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å‚™ä»½å—ï¼Ÿ')) return;
        
        const result = await APIService.deleteBackup(backupId);
        
        if (result.success) {
          alert('åˆªé™¤æˆåŠŸï¼');
          this.showAdminBackup();
        } else {
          alert('åˆªé™¤å¤±æ•—ï¼š' + result.error);
        }
      }

      // ==================== è²¡å‹™å ±è¡¨ ====================
      async showFinanceReport() {
        const reportDiv = document.getElementById('reportContent');
        reportDiv.innerHTML = UIUtils.showLoading('ç”Ÿæˆå ±è¡¨ä¸­...');
        
        const result = await APIService.generateFinanceReport();
        
        if (!result.success) {
          reportDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const report = result.data;
        
        const html = `
          <div class="card">
            <h3>è²¡å‹™å ±è¡¨</h3>
            <p>çµ±è¨ˆæœŸé–“ï¼š${report.period.start} è‡³ ${report.period.end}</p>
            
            <h4>è²¡å‹™æ¦‚æ³</h4>
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
              <div class="stat-card" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                <h4>ç¸½æ”¶å…¥</h4>
                <div class="stat-value">$${report.summary.totalIncome.toLocaleString()}</div>
                <div class="stat-label">${report.summary.incomeCount} ç­†</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%);">
                <h4>ç¸½æ”¯å‡º</h4>
                <div class="stat-value">$${report.summary.totalExpense.toLocaleString()}</div>
                <div class="stat-label">${report.summary.expenseCount} ç­†</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
                <h4>ç¸½ææ¬¾</h4>
                <div class="stat-value">$${report.summary.totalDonation.toLocaleString()}</div>
                <div class="stat-label">${report.summary.donationCount} ç­†</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                <h4>æ·¨é¡</h4>
                <div class="stat-value">$${report.summary.netAmount.toLocaleString()}</div>
                <div class="stat-label">${report.summary.netAmount >= 0 ? 'ç›ˆé¤˜' : 'è™§æ'}</div>
              </div>
            </div>
            
            <div class="form-row">
              <div>
                <h4>æ”¶å…¥ä¾†æº</h4>
                <ul>
                  ${Object.entries(report.incomeByCategory).map(([category, amount]) => 
                    `<li>${category}ï¼š$${amount.toLocaleString()}</li>`
                  ).join('')}
                </ul>
              </div>
              
              <div>
                <h4>æ”¯å‡ºé¡åˆ¥</h4>
                <ul>
                  ${Object.entries(report.expenseByCategory).map(([category, amount]) => 
                    `<li>${category}ï¼š$${amount.toLocaleString()}</li>`
                  ).join('')}
                </ul>
              </div>
              
              <div>
                <h4>ä»˜æ¬¾æ–¹å¼åˆ†å¸ƒ</h4>
                <ul>
                  ${Object.entries(report.byPaymentMethod).map(([method, data]) => 
                    `<li>${method}ï¼š${data.count} ç­†ï¼Œ$${data.amount.toLocaleString()}</li>`
                  ).join('')}
                </ul>
              </div>
            </div>
            
            <h4>æœˆåº¦è¶¨å‹¢</h4>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>æœˆä»½</th>
                    <th>æ”¶å…¥</th>
                    <th>æ”¯å‡º</th>
                    <th>ææ¬¾</th>
                    <th>æ·¨é¡</th>
                  </tr>
                </thead>
                <tbody>
                  ${report.monthlyTrend.map(month => `
                    <tr>
                      <td>${month.month}</td>
                      <td style="color: #4CAF50;">$${month.income.toLocaleString()}</td>
                      <td style="color: #f44336;">$${month.expense.toLocaleString()}</td>
                      <td style="color: #2196F3;">$${month.donation.toLocaleString()}</td>
                      <td style="color: ${month.net >= 0 ? '#4CAF50' : '#f44336'}; font-weight: bold;">
                        $${month.net.toLocaleString()}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
        
        reportDiv.innerHTML = html;
      }

      // ==================== å‡ºå¸­ç‡å ±è¡¨ ====================
      async generateAttendanceReport() {
        const reportDiv = document.getElementById('reportContent');
        reportDiv.innerHTML = UIUtils.showLoading('ç”Ÿæˆå ±è¡¨ä¸­...');
        
        const result = await APIService.generateAttendanceReport();
        
        if (!result.success) {
          reportDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const report = result.data;
        
        const html = `
          <div class="card">
            <h3>å‡ºå¸­ç‡å ±è¡¨</h3>
            <p>çµ±è¨ˆæœŸé–“ï¼š${report.period.start} è‡³ ${report.period.end}</p>
            
            <h4>å‡ºå¸­æ¦‚æ³</h4>
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
              <div class="stat-card">
                <h4>ç¸½å ±åäººæ¬¡</h4>
                <div class="stat-value">${report.summary.totalRegistrations}</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                <h4>å·²å‡ºå¸­</h4>
                <div class="stat-value">${report.summary.attended}</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%);">
                <h4>ç¼ºå¸­</h4>
                <div class="stat-value">${report.summary.absent}</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
                <h4>å¹³å‡å‡ºå¸­ç‡</h4>
                <div class="stat-value">${report.summary.averageAttendanceRate}%</div>
              </div>
            </div>
            
            <h4>æ´»å‹•å‡ºå¸­ç‡æ’è¡Œ</h4>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>æ’å</th>
                    <th>æ´»å‹•åç¨±</th>
                    <th>æ—¥æœŸ</th>
                    <th>å ±åäººæ•¸</th>
                    <th>å‡ºå¸­äººæ•¸</th>
                    <th>å‡ºå¸­ç‡</th>
                  </tr>
                </thead>
                <tbody>
                  ${report.activityRanking.map((activity, index) => `
                    <tr>
                      <td>${index + 1}</td>
                      <td>${activity.name}</td>
                      <td>${UIUtils.formatDate(activity.date)}</td>
                      <td>${activity.registered}</td>
                      <td>${activity.attended}</td>
                      <td>
                        <span style="color: ${activity.rate >= 80 ? '#4CAF50' : activity.rate >= 60 ? '#FF9800' : '#f44336'}; font-weight: bold;">
                          ${activity.rate}%
                        </span>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <div class="form-row" style="margin-top: 30px;">
              <div>
                <h4>æœƒå“¡å‡ºå¸­æ’è¡Œï¼ˆå‰10åï¼‰</h4>
                <ul>
                  ${report.memberRanking.slice(0, 10).map((member, index) => 
                    `<li>${index + 1}. ${member.name}ï¼š${member.attendedCount} æ¬¡ (${member.attendanceRate}%)</li>`
                  ).join('')}
                </ul>
              </div>
              
              <div>
                <h4>æ´»å‹•é¡å‹å‡ºå¸­ç‡</h4>
                <ul>
                  ${Object.entries(report.byActivityType).map(([type, data]) => 
                    `<li>${type}ï¼š${data.attendanceRate}% (${data.attended}/${data.total})</li>`
                  ).join('')}
                </ul>
              </div>
            </div>
          </div>
        `;
        
        reportDiv.innerHTML = html;
      }

      // ==================== ç·¨è¼¯æ´»å‹• ====================
      async showEditActivity(activityId) {
        const modal = UIUtils.showModal('ç·¨è¼¯æ´»å‹•', UIUtils.showLoading('è¼‰å…¥ä¸­...'));
        
        const result = await APIService.getActivityDetail(activityId);
        
        if (!result.success) {
          modal.querySelector('.modal-body').innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const activity = result.data;
        
        const content = `
          <div id="editActivityMessage"></div>
          <form onsubmit="app.handleEditActivity(event, '${activityId}')">
            <div class="form-row">
              <div class="form-group">
                <label>æ´»å‹•åç¨± *</label>
                <input type="text" id="editActivityName" value="${activity['æ´»å‹•åç¨±']}" required>
              </div>
              <div class="form-group">
                <label>æ´»å‹•é¡å‹</label>
                <select id="editActivityType">
                  <option value="è¬›åº§" ${activity['é¡å‹'] === 'è¬›åº§' ? 'selected' : ''}>è¬›åº§</option>
                  <option value="é‹å‹•èª²ç¨‹" ${activity['é¡å‹'] === 'é‹å‹•èª²ç¨‹' ? 'selected' : ''}>é‹å‹•èª²ç¨‹</option>
                  <option value="ç¤¾äº¤æ´»å‹•" ${activity['é¡å‹'] === 'ç¤¾äº¤æ´»å‹•' ? 'selected' : ''}>ç¤¾äº¤æ´»å‹•</option>
                  <option value="å¥åº·æª¢æŸ¥" ${activity['é¡å‹'] === 'å¥åº·æª¢æŸ¥' ? 'selected' : ''}>å¥åº·æª¢æŸ¥</option>
                  <option value="å…¶ä»–" ${activity['é¡å‹'] === 'å…¶ä»–' ? 'selected' : ''}>å…¶ä»–</option>
                </select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>æ—¥æœŸ *</label>
                <input type="date" id="editActivityDate" value="${activity['æ—¥æœŸ']}" required>
              </div>
              <div class="form-group">
                <label>é–‹å§‹æ™‚é–“ *</label>
                <input type="time" id="editActivityStartTime" value="${activity['é–‹å§‹æ™‚é–“']}" required>
              </div>
              <div class="form-group">
                <label>çµæŸæ™‚é–“ *</label>
                <input type="time" id="editActivityEndTime" value="${activity['çµæŸæ™‚é–“']}" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>åœ°é» *</label>
                <input type="text" id="editActivityLocation" value="${activity['åœ°é»']}" required>
              </div>
              <div class="form-group">
                <label>è¬›å¸«</label>
                <input type="text" id="editActivityInstructor" value="${activity['è¬›å¸«'] || ''}">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>å ±åä¸Šé™ *</label>
                <input type="number" id="editActivityMaxParticipants" value="${activity['å ±åä¸Šé™']}" required min="1">
              </div>
              <div class="form-group">
                <label>å ±åæˆªæ­¢æ—¥ *</label>
                <input type="date" id="editActivityDeadline" value="${activity['å ±åæˆªæ­¢æ—¥']}" required>
              </div>
            </div>
            
            <div class="form-group">
              <label>æ´»å‹•æè¿°</label>
              <textarea id="editActivityDescription" rows="3">${activity['æè¿°'] || ''}</textarea>
            </div>
            
            <div class="form-group">
              <label>æ´»å‹•å…§å®¹</label>
              <textarea id="editActivityContent" rows="4">${activity['å…§å®¹'] || ''}</textarea>
            </div>
            
            <div class="form-group">
              <label>æ³¨æ„äº‹é …</label>
              <textarea id="editActivityNotes" rows="3">${activity['æ³¨æ„äº‹é …'] || ''}</textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
              <button type="submit" class="btn btn-primary">å„²å­˜è®Šæ›´</button>
            </div>
          </form>
        `;
        
        modal.querySelector('.modal-body').innerHTML = content;
      }

      async handleEditActivity(event, activityId) {
        event.preventDefault();
        
        const messageDiv = document.getElementById('editActivityMessage');
        
        const activityData = {
          name: document.getElementById('editActivityName').value,
          type: document.getElementById('editActivityType').value,
          date: document.getElementById('editActivityDate').value,
          startTime: document.getElementById('editActivityStartTime').value,
          endTime: document.getElementById('editActivityEndTime').value,
          location: document.getElementById('editActivityLocation').value,
          instructor: document.getElementById('editActivityInstructor').value,
          maxParticipants: document.getElementById('editActivityMaxParticipants').value,
          registrationDeadline: document.getElementById('editActivityDeadline').value,
          description: document.getElementById('editActivityDescription').value,
          content: document.getElementById('editActivityContent').value,
          notes: document.getElementById('editActivityNotes').value
        };
        
        messageDiv.innerHTML = UIUtils.showLoading('æ›´æ–°ä¸­...');
        
        const result = await APIService.updateActivity(activityId, activityData);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess('æ›´æ–°æˆåŠŸï¼');
          setTimeout(() => {
            document.querySelector('.modal').remove();
            this.showAdminActivities();
          }, 1500);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      // ==================== åŒ¯å‡ºåŠŸèƒ½ ====================
      async exportRegistrations(activityId) {
        const result = await APIService.exportActivityRegistrations(activityId);
        
        if (result.success) {
          // å»ºç«‹ä¸‹è¼‰é€£çµ
          const link = document.createElement('a');
          link.href = result.data.downloadUrl;
          link.download = result.data.filename;
          link.click();
          alert('åŒ¯å‡ºæˆåŠŸï¼');
        } else {
          alert('åŒ¯å‡ºå¤±æ•—ï¼š' + result.error);
        }
      }

      // ==================== è¼”åŠ©æ–¹æ³• ====================
      renderWithHeader(content) {
        const user = AuthService.getUser();
        const isAdmin = AuthService.isAdmin();
        
        const html = `
          <div class="header">
            <div class="logo">ğŸ  éŠ€é«®é—œæ‡·å”æœƒ</div>
            <nav class="nav">
              <a href="#" onclick="app.showDashboard()" class="${this.currentView === 'dashboard' ? 'active' : ''}">é¦–é </a>
              <a href="#" onclick="app.showActivities()" class="${this.currentView === 'activities' ? 'active' : ''}">æ´»å‹•åˆ—è¡¨</a>
              <a href="#" onclick="app.showMyActivities()" class="${this.currentView === 'myActivities' ? 'active' : ''}">æˆ‘çš„æ´»å‹•</a>
              ${isAdmin ? `<a href="#" onclick="app.showAdminPanel()" class="${this.currentView === 'admin' ? 'active' : ''}">ç®¡ç†å¾Œå°</a>` : ''}
              <div class="user-menu">
                <button class="btn btn-secondary" onclick="app.toggleUserMenu()">
                  ${user.name} â–¼
                </button>
                <div class="dropdown-menu" id="userMenu" style="display: none;">
                  <a href="#" onclick="app.showProfile()">å€‹äººè³‡æ–™</a>
                  <a href="#" onclick="app.showChangePassword()">è®Šæ›´å¯†ç¢¼</a>
                  <a href="#" onclick="app.handleLogout()">ç™»å‡º</a>
                </div>
              </div>
            </nav>
          </div>
          
          <div class="container">
            ${content}
          </div>
        `;
        
        document.getElementById('app').innerHTML = html;
      }

      toggleUserMenu() {
        const menu = document.getElementById('userMenu');
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
      }

      handleLogout() {
        if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
          AuthService.logout();
          this.showLogin();
        }
      }
    }

    // ==================== åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ ====================
    const app = new App();
    app.init();
  </script>
</body>
</html>


