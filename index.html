<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>帕金森病友會管理系統</title>

<!-- LIFF SDK -->
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

<style>
:root {
  --primary: #06c755;
  --primary-dark: #05b04b;
  --secondary: #00b900;
  --danger: #dc3545;
  --warning: #ffc107;
  --info: #17a2b8;
  --light: #f8f9fa;
  --dark: #343a40;
  --border-radius: 12px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding-bottom: 80px;
}

.app-container {
  max-width: 480px;
  margin: 0 auto;
  background: white;
  min-height: 100vh;
  box-shadow: 0 0 30px rgba(0,0,0,0.1);
}

/* 頂部導航 */
.top-bar {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.top-bar h1 { font-size: 18px; font-weight: 600; margin: 0; }
.user-info { display: flex; align-items: center; gap: 10px; }
.user-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid white; }
.user-name { font-size: 14px; font-weight: 500; }

/* 底部導航 */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e0e0e0;
  display: flex; justify-content: space-around; padding: 8px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
  z-index: 1000; max-width: 480px; margin: 0 auto;
}
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px; color: #666; text-decoration: none; transition: all 0.3s; cursor: pointer; border: none; background: none; }
.nav-item i { font-size: 22px; }
.nav-item span { font-size: 11px; }
.nav-item.active { color: var(--primary); }
.nav-item:hover { color: var(--primary); background: rgba(6, 199, 85, 0.05); }

/* 頁面內容 */
.page-content { display: none; padding: 20px; animation: fadeIn 0.3s; }
.page-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* 卡片樣式 */
.card { border: none; border-radius: var(--border-radius); box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; overflow: hidden; }
.card-header { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; font-weight: 600; padding: 15px 20px; border: none; }
.card-body { padding: 20px; }

/* 統計卡片 */
.stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
.stat-card { background: white; border-radius: var(--border-radius); padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; }
.stat-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.stat-icon { font-size: 32px; margin-bottom: 10px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.stat-value { font-size: 28px; font-weight: 700; color: var(--dark); margin: 5px 0; }
.stat-label { font-size: 13px; color: #666; }

/* 活動項目 */
.activity-item { background: white; border-radius: var(--border-radius); padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; }
.activity-item:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.activity-title { font-size: 16px; font-weight: 600; color: var(--dark); margin-bottom: 8px; }
.activity-info { font-size: 14px; color: #666; margin-bottom: 10px; }
.activity-meta { display: flex; flex-wrap: wrap; gap: 10px; font-size: 13px; color: #888; }
.activity-meta span { display: flex; align-items: center; gap: 4px; }
.activity-meta i { font-size: 14px; }

/* 狀態標籤 */
.status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
.status-開放報名, .status-已報名, .status-已完成 { background: #d4edda; color: #155724; }
.status-已額滿, .status-已取消 { background: #f8d7da; color: #721c24; }
.status-已結束 { background: #e2e3e5; color: #383d41; }
.status-審核中, .status-待付款 { background: #fff3cd; color: #856404; }
.status-已核准, .status-已捐款 { background: #d4edda; color: #155724; }
.status-已拒絕 { background: #f8d7da; color: #721c24; }

/* 按鈕樣式 */
.btn-gradient {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: 600; transition: all 0.3s;
  box-shadow: 0 4px 10px rgba(6, 199, 85, 0.3);
}
.btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(6, 199, 85, 0.4); color: white; }
.btn-gradient:active { transform: translateY(0); }

/* 表單樣式 */
.form-floating > label { color: #666; }
.form-control:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 0.2rem rgba(6, 199, 85, 0.25); }

/* 空狀態 */
.empty-state { text-align: center; padding: 40px 20px; color: #999; }
.empty-state i { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
.empty-state p { font-size: 14px; margin: 0; }

/* 載入動畫 */
.loading-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7);
  display: flex; justify-content: center; align-items: center; z-index: 9999;
}
.loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Toast 通知 */
.toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }

/* 管理員專用 */
.admin-only { display: none; }

/* 表格樣式 */
.table-responsive { border-radius: var(--border-radius); overflow: hidden; }
.table { margin-bottom: 0; }
.table thead { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; }
.table tbody tr:hover { background: rgba(6, 199, 85, 0.05); }

/* 響應式 */
@media (max-width: 480px) {
  .stats-grid { grid-template-columns: 1fr; }
  .activity-meta { flex-direction: column; gap: 5px; }
}
</style>
</head>
<body>

<div class="app-container">
  <!-- 頂部導航 -->
  <div class="top-bar">
    <h1><i class="bi bi-heart-pulse me-2"></i>帕金森病友會</h1>
    <div class="user-info">
      <img id="userAvatar" class="user-avatar" src="https://via.placeholder.com/36" alt="頭像">
      <span id="userName" class="user-name">載入中...</span>
    </div>
  </div>

  <!-- 首頁 -->
  <div id="page-home" class="page-content active">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-calendar-event"></i></div>
        <div class="stat-value" id="statActivities">0</div>
        <div class="stat-label">活動總數</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
        <div class="stat-value" id="statRegistrations">0</div>
        <div class="stat-label">我的報名</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
        <div class="stat-value" id="statVolunteerHours">0</div>
        <div class="stat-label">志工時數</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-heart"></i></div>
        <div class="stat-value" id="statDonations">$0</div>
        <div class="stat-label">捐款金額</div>
      </div>
    </div>

    <!-- 最新活動 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-calendar-event me-2"></i>最新活動
      </div>
      <div class="card-body">
        <div id="recentActivities">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 活動頁 -->
  <div id="page-activities" class="page-content">
    <div class="card">
      <div class="card-header">
        <i class="bi bi-calendar-plus me-2"></i>開放報名
      </div>
      <div class="card-body">
        <div id="activitiesList">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-list-check me-2"></i>我的報名
      </div>
      <div class="card-body">
        <div id="myRegistrationsList">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 志工頁 -->
  <div id="page-volunteer" class="page-content">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
        <div class="stat-value" id="volTotalHours">0</div>
        <div class="stat-label">累計時數</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
        <div class="stat-value" id="volTotalActivities">0</div>
        <div class="stat-label">服務次數</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-people me-2"></i>志工需求
      </div>
      <div class="card-body">
        <div id="volunteerNeedsList">
          <div class="empty-state">
            <i class="bi bi-people"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-journal-text me-2"></i>我的記錄
      </div>
      <div class="card-body">
        <div id="myVolunteerRecords">
          <div class="empty-state">
            <i class="bi bi-journal-x"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 財務頁 -->
  <div id="page-finance" class="page-content">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-heart"></i></div>
        <div class="stat-value" id="finTotalDonation">$0</div>
        <div class="stat-label">累計捐款</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-receipt"></i></div>
        <div class="stat-value" id="finPendingExpenses">0</div>
        <div class="stat-label">待審核支出</div>
      </div>
    </div>

    <div class="d-grid gap-2 mb-3">
      <button class="btn btn-gradient" onclick="showDonationModal()">
        <i class="bi bi-heart-fill me-2"></i>我要捐款
      </button>
      <button class="btn btn-outline-primary" onclick="showNewExpenseModal()">
        <i class="bi bi-receipt me-2"></i>支出申請
      </button>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-heart me-2"></i>我的捐款
      </div>
      <div class="card-body">
        <div id="myDonationsList">
          <div class="empty-state">
            <i class="bi bi-heart"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-receipt me-2"></i>我的支出
      </div>
      <div class="card-body">
        <div id="myExpensesList">
          <div class="empty-state">
            <i class="bi bi-receipt"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 個人頁 -->
  <div id="page-profile" class="page-content">
    <div class="card">
      <div class="card-header">
        <i class="bi bi-person me-2"></i>個人資料
      </div>
      <div class="card-body">
        <form id="profileForm">
          <div class="form-floating mb-3">
            <input type="text" class="form-control" name="realName" required>
            <label>真實姓名 *</label>
          </div>
          <div class="form-floating mb-3">
            <select class="form-select" name="memberType" required>
              <option value="">請選擇</option>
              <option value="病友">病友</option>
              <option value="家屬">家屬</option>
              <option value="志工">志工</option>
            </select>
            <label>會員類型 *</label>
          </div>
          <div class="form-floating mb-3">
            <input type="tel" class="form-control" name="phone">
            <label>聯絡電話</label>
          </div>
          <div class="form-floating mb-3">
            <input type="email" class="form-control" name="email">
            <label>電子郵件</label>
          </div>
          <div class="form-floating mb-3">
            <input type="date" class="form-control" name="birthday">
            <label>生日</label>
          </div>
          <div class="form-floating mb-3">
            <input type="date" class="form-control" name="diagnosisDate">
            <label>確診日期</label>
          </div>
          <div class="form-floating mb-3">
            <textarea class="form-control" name="address" style="height:80px;"></textarea>
            <label>地址</label>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-gradient">
              <i class="bi bi-save me-2"></i>儲存變更
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-file-earmark-text me-2"></i>我的收據
      </div>
      <div class="card-body">
        <div id="myReceiptsList">
          <div class="empty-state">
            <i class="bi bi-file-earmark-text"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-info-circle me-2"></i>會員資訊
      </div>
      <div class="card-body">
        <p><strong>會員類型：</strong><span id="userMemberType">-</span></p>
        <p><strong>LINE ID：</strong><span id="userLineId">-</span></p>
        <p class="mb-0"><strong>版本：</strong>v2.1.0</p>
      </div>
    </div>
  </div>

  <!-- 管理頁 -->
  <div id="page-admin" class="page-content admin-only">
    <div class="card">
      <div class="card-header">
        <i class="bi bi-gear me-2"></i>管理功能
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <button class="btn btn-outline-primary" onclick="showNewActivityModal()">
            <i class="bi bi-calendar-plus me-2"></i>新增活動
          </button>
          <button class="btn btn-outline-success" onclick="showNewVolunteerNeedModal()">
            <i class="bi bi-people me-2"></i>新增志工需求
          </button>
          <button class="btn btn-outline-info" onclick="exportMembers()">
            <i class="bi bi-download me-2"></i>匯出會員資料
          </button>
          <button class="btn btn-outline-warning" onclick="exportFinanceData()">
            <i class="bi bi-file-earmark-spreadsheet me-2"></i>匯出財務報表
          </button>
          <button class="btn btn-outline-secondary" onclick="backupSystem()">
            <i class="bi bi-cloud-upload me-2"></i>系統備份
          </button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-people me-2"></i>會員管理
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover table-sm">
            <thead>
              <tr>
                <th>姓名</th>
                <th>類型</th>
                <th>狀態</th>
              </tr>
            </thead>
            <tbody id="memberList">
              <tr><td colspan="3" class="text-center">載入中...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-calendar-event me-2"></i>活動管理
      </div>
      <div class="card-body">
        <div id="adminActivityList">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-cash-stack me-2"></i>財務管理
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>日期</th>
                <th>類型</th>
                <th>金額</th>
                <th>狀態</th>
              </tr>
            </thead>
            <tbody id="transactionList">
              <tr><td colspan="4" class="text-center">載入中...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 底部導航 -->
  <div class="bottom-nav">
    <button class="nav-item active" onclick="switchPage('home', event)">
      <i class="bi bi-house-door-fill"></i>
      <span>首頁</span>
    </button>
    <button class="nav-item" onclick="switchPage('activities', event)">
      <i class="bi bi-calendar-event"></i>
      <span>活動</span>
    </button>
    <button class="nav-item" onclick="switchPage('volunteer', event)">
      <i class="bi bi-people"></i>
      <span>志工</span>
    </button>
    <button class="nav-item" onclick="switchPage('finance', event)">
      <i class="bi bi-wallet2"></i>
      <span>財務</span>
    </button>
    <button class="nav-item" onclick="switchPage('profile', event)">
      <i class="bi bi-person"></i>
      <span>我的</span>
    </button>
    <button class="nav-item admin-only" onclick="switchPage('admin', event)">
      <i class="bi bi-gear"></i>
      <span>管理</span>
    </button>
  </div>
</div>

<!-- Toast 容器 -->
<div id="toastContainer" class="toast-container"></div>

<!-- Modal 容器 -->
<div id="modalContainer"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ==================== 全域變數 ====================
const CONFIG = {
  LIFF_ID: '1656516134-VaGgmaPm',  // 替換
  GAS_URL: 'https://script.google.com/macros/s/AKfycbxOF4Xr-NSlhWUsfyY8pIQ7gl9owNIrAfOghMqVUgtk8aArTbA_cueGpus25A3oQTw/exec',  // 替換
  API_KEY: 'AAbb8520258185202581'
};

let userProfile = null;
let isAdmin = false;
let cachedData = {};

// ==================== LIFF SDK 載入檢查 ====================
function loadLiffSDK() {
  return new Promise((resolve, reject) => {
    let checkCount = 0;
    const maxChecks = 50;
    const checkLiff = () => {
      checkCount++;
      if (typeof liff !== 'undefined') {
        resolve();
        return;
      }
      if (checkCount >= maxChecks) {
        reject(new Error('LIFF SDK 未載入，請於 LINE App 內開啟或檢查網路'));
        return;
      }
      setTimeout(checkLiff, 100);
    };
    checkLiff();
  });
}

// ==================== LIFF 初始化 ====================
async function initLIFF() {
  try {
    await loadLiffSDK();
    await liff.init({ liffId: CONFIG.LIFF_ID });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    userProfile = await liff.getProfile();
    document.getElementById('userAvatar').src = userProfile.pictureUrl || 'https://via.placeholder.com/36';
    document.getElementById('userName').textContent = userProfile.displayName;
    document.getElementById('userLineId').textContent = userProfile.userId;

    // 先確保使用者註冊
    const registered = await ensureUserRegistered();
    if (!registered) return;

    await checkAdminStatus();
    await loadAllData();
  } catch (error) {
    showErrorPage(error);
  }
}

// ==================== 初次註冊流程 ====================
async function ensureUserRegistered() {
  try {
    await callAPI('getUserInfo', {});
    return true;
  } catch (e) {
    if (!/未註冊/.test(e.message || '')) {
      showNotification('取得用戶資訊失敗：' + e.message, 'error');
      return false;
    }
    const html = `
      <div class="modal fade" id="regModal" tabindex="-1">
        <div class="modal-dialog">
          <form class="modal-content" id="regForm">
            <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>加入病友會</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p class="text-muted mb-3">首次使用請先完成簡易註冊。</p>
              <div class="form-floating mb-3">
                <input type="text" class="form-control" name="realName" required>
                <label>真實姓名 *</label>
              </div>
              <div class="form-floating mb-3">
                <select class="form-select" name="memberType" required>
                  <option value="">請選擇</option>
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                </select>
                <label>會員類型 *</label>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="submit" class="btn btn-gradient">立即加入</button>
            </div>
          </form>
        </div>
      </div>
    `;
    return new Promise((resolve) => {
      showModal(html, async (formData) => {
        const data = {
          realName: formData.get('realName'),
          memberType: formData.get('memberType'),
          lineName: userProfile?.displayName || ''
        };
        await callAPI('registerUser', data);
        showNotification('註冊成功！', 'success');
        resolve(true);
      });
      // 若使用者關閉不註冊
      const el = document.getElementById('regModal');
      el?.addEventListener('hidden.bs.modal', () => resolve(false), { once: true });
    });
  }
}

// ==================== 錯誤頁面 ====================
function showErrorPage(error) {
  document.querySelector('.app-container').innerHTML = `
    <div style="padding: 40px 20px; text-align: center;">
      <i class="bi bi-exclamation-triangle" style="font-size: 64px; color: #dc3545;"></i>
      <h3 style="margin-top: 20px;">系統初始化失敗</h3>
      <p style="color: #666; margin: 20px 0;">${error.message}</p>
      <div class="d-grid gap-2 mx-auto" style="max-width: 300px;">
        <button class="btn btn-gradient" onclick="location.reload()">
          <i class="bi bi-arrow-clockwise me-2"></i>重新載入
        </button>
        <button class="btn btn-outline-secondary" onclick="navigator.clipboard.writeText(window.location.href);showNotification('連結已複製，請至 LINE App 開啟','success')">
          <i class="bi bi-clipboard me-2"></i>複製連結
        </button>
      </div>
    </div>`;
}

// ==================== API 呼叫 ====================
async function callAPI(action, data = {}) {
  try {
    const payload = {
      apiKey: CONFIG.API_KEY,
      action: action,
      lineId: userProfile?.userId || '',
      ...data
    };
    const response = await fetch(CONFIG.GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(payload)
    });
    const result = await response.json();
    if (!result.success) {
      throw new Error(result.message || '操作失敗');
    }
    return result;
  } catch (error) {
    throw error;
  }
}

// ==================== 檢查管理員權限 ====================
async function checkAdminStatus() {
  try {
    const response = await callAPI('getUserInfo', {});
    isAdmin = response.data?.isAdmin || false;
    if (isAdmin) {
      document.querySelectorAll('.admin-only').forEach(el => { el.style.display = 'block'; });
    }
  } catch (error) {
    // 忽略
  }
}

// ==================== 載入所有資料 ====================
async function loadAllData() {
  showLoading(true);
  try {
    await Promise.all([
      loadHomeData(),
      loadActivities(),
      loadVolunteerData(),
      loadFinanceData(),
      loadProfileData()
    ]);
    if (isAdmin) {
      await loadAdminData();
    }
  } catch (error) {
    showNotification('載入資料失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== 首頁 ====================
async function loadHomeData() {
  try {
    const response = await callAPI('getDashboardData', {});
    const data = response.data;
    document.getElementById('statActivities').textContent = data.totalActivities || 0;
    document.getElementById('statRegistrations').textContent = data.myRegistrations || 0;
    document.getElementById('statVolunteerHours').textContent = data.myVolunteerHours || 0;
    document.getElementById('statDonations').textContent = '$' + formatCurrency(data.myDonationAmount || 0);
    renderRecentActivities(data.recentActivity || []);
  } catch (error) {
    // 區塊內自行處理
  }
}
function renderRecentActivities(activities) {
  const container = document.getElementById('recentActivities');
  if (activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>目前沒有活動</p></div>';
    return;
  }
  container.innerHTML = activities.slice(0, 3).map(activity => `
    <div class="activity-item">
      <div class="activity-title">${activity.title}</div>
      <div class="activity-info">${activity.description || ''}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(activity.date)}</span>
        <span class="status-badge status-${activity.status}">${activity.status}</span>
      </div>
    </div>
  `).join('');
}

// ==================== 活動 ====================
async function loadActivities() {
  try {
    const response = await callAPI('getActivities', {});
    const activities = response.data || [];
    const openActivities = activities.filter(a => a.status === '開放報名');
    renderActivitiesList(openActivities);

    const regResponse = await callAPI('getMyRegistrations', {});
    renderMyRegistrations(regResponse.data || []);
  } catch (error) {}
}
function renderActivitiesList(activities) {
  const container = document.getElementById('activitiesList');
  if (activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>目前沒有開放報名的活動</p></div>';
    return;
  }
  container.innerHTML = activities.map(activity => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${activity.title}</div>
        <span class="status-badge status-${activity.status}">${activity.status}</span>
      </div>
      <div class="activity-info">${activity.description || ''}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(activity.date)} ${activity.time || ''}</span>
        <span><i class="bi bi-geo-alt"></i>${activity.location || '未指定'}</span>
        <span><i class="bi bi-people"></i>${activity.currentCount || 0}/${activity.maxParticipants}</span>
        ${activity.fee ? `<span><i class="bi bi-cash"></i>$${formatCurrency(activity.fee)}</span>` : ''}
      </div>
      <button class="btn btn-sm btn-gradient mt-2" onclick="registerActivity('${activity.id}')">
        <i class="bi bi-check-circle me-1"></i>我要報名
      </button>
    </div>
  `).join('');
}
function renderMyRegistrations(registrations) {
  const container = document.getElementById('myRegistrationsList');
  if (registrations.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>您還沒有報名任何活動</p></div>';
    return;
  }
  container.innerHTML = registrations.map(reg => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${reg.activityTitle}</div>
        <span class="status-badge status-${reg.status}">${reg.status}</span>
      </div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(reg.registrationTime)}</span>
      </div>
      ${reg.status === '已報名' ? `
        <button class="btn btn-sm btn-outline-danger mt-2" onclick="cancelRegistration('${reg.id}')">
          <i class="bi bi-x-circle me-1"></i>取消報名
        </button>
      ` : ''}
    </div>
  `).join('');
}
async function registerActivity(activityId) {
  if (!confirm('確定要報名此活動嗎？')) return;
  try {
    showLoading(true);
    await callAPI('registerActivity', { activityId });
    showNotification('報名成功！', 'success');
    await loadActivities();
    await loadHomeData();
  } catch (error) {
    showNotification('報名失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}
async function cancelRegistration(registrationId) {
  if (!confirm('確定要取消報名嗎？')) return;
  try {
    showLoading(true);
    await callAPI('cancelRegistration', { registrationId });
    showNotification('已取消報名', 'success');
    await loadActivities();
    await loadHomeData();
  } catch (error) {
    showNotification('取消失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== 志工 ====================
async function loadVolunteerData() {
  try {
    const response = await callAPI('getVolunteerData', {});
    const data = response.data;
    document.getElementById('volTotalHours').textContent = data.stats?.totalHours || 0;
    document.getElementById('volTotalActivities').textContent = data.stats?.totalActivities || 0;
    renderVolunteerNeeds(data.needs || []);
    renderMyVolunteerRecords(data.records || []);
  } catch (error) {}
}
function renderVolunteerNeeds(needs) {
  const container = document.getElementById('volunteerNeedsList');
  if (needs.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-people"></i><p>目前沒有志工需求</p></div>';
    return;
  }
  container.innerHTML = needs.map(need => `
    <div class="activity-item">
      <div class="activity-title">${need.title}</div>
      <div class="activity-info">${need.description || ''}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(need.date)} ${need.time || ''}</span>
        <span><i class="bi bi-people"></i>需求：${need.needCount}人</span>
        <span><i class="bi bi-clock"></i>時數：${need.hours}小時</span>
        <span><i class="bi bi-check-circle"></i>已報名：${need.currentCount || 0}人</span>
      </div>
      <button class="btn btn-sm btn-gradient mt-2" onclick="applyVolunteer('${need.id}')">
        <i class="bi bi-hand-thumbs-up me-1"></i>我要報名
      </button>
    </div>
  `).join('');
}
function renderMyVolunteerRecords(records) {
  const container = document.getElementById('myVolunteerRecords');
  if (records.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-journal-x"></i><p>您還沒有志工服務記錄</p></div>';
    return;
  }
  container.innerHTML = records.map(record => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${record.title}</div>
        <span class="status-badge status-${record.status}">${record.status}</span>
      </div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(record.date)}</span>
        <span><i class="bi bi-clock"></i>${record.hours}小時</span>
      </div>
    </div>
  `).join('');
}
async function applyVolunteer(needId) {
  if (!confirm('確定要報名此志工服務嗎？')) return;
  try {
    showLoading(true);
    await callAPI('applyVolunteer', { needId });
    showNotification('報名成功！', 'success');
    await loadVolunteerData();
  } catch (error) {
    showNotification('報名失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}
// 預留：取消志工報名（前端函式，後端已提供 API）
async function cancelVolunteer(recordId, needId) {
  if (!confirm('確定要取消此志工報名嗎？')) return;
  try {
    showLoading(true);
    await callAPI('cancelVolunteerApply', { recordId, needId });
    showNotification('已取消志工報名', 'success');
    await loadVolunteerData();
  } catch (e) {
    showNotification('取消失敗：' + (e.message || ''), 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== 財務 ====================
async function loadFinanceData() {
  try {
    const response = await callAPI('getFinanceData', {});
    const data = response.data;
    document.getElementById('finTotalDonation').textContent = '$' + formatCurrency(data.stats?.totalDonation || 0);
    document.getElementById('finPendingExpenses').textContent = data.stats?.pendingExpenses || 0;
    renderMyDonations(data.donations || []);
    renderMyExpenses(data.expenses || []);
  } catch (error) {}
}
function renderMyDonations(donations) {
  const container = document.getElementById('myDonationsList');
  if (donations.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-heart"></i><p>您還沒有捐款記錄</p></div>';
    return;
  }
  container.innerHTML = donations.map(donation => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="activity-title">$${formatCurrency(donation.amount)}</div>
          <div class="activity-info">${donation.category || '一般捐款'}</div>
          <div class="activity-meta">
            <span><i class="bi bi-calendar"></i>${formatDate(donation.createdAt)}</span>
            <span class="status-badge status-${donation.status}">${donation.status}</span>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}
function renderMyExpenses(expenses) {
  const container = document.getElementById('myExpensesList');
  if (expenses.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-receipt"></i><p>您還沒有支出申請</p></div>';
    return;
  }
  container.innerHTML = expenses.map(expense => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">$${formatCurrency(expense.amount)}</div>
        <span class="status-badge status-${expense.status}">${expense.status}</span>
      </div>
      <div class="activity-info">${expense.description || ''}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(expense.createdAt)}</span>
        <span><i class="bi bi-tag"></i>${expense.category}</span>
      </div>
    </div>
  `).join('');
}

// ==================== 個人 ====================
async function loadProfileData() {
  try {
    const response = await callAPI('getUserInfo', {});
    const profile = response.data;
    const form = document.getElementById('profileForm');
    if (form && profile) {
      form.elements.realName.value = profile.realName || '';
      form.elements.memberType.value = profile.memberType || '';
      form.elements.phone.value = profile.phone || '';
      form.elements.email.value = profile.email || '';
      form.elements.birthday.value = formatDateInput(profile.birthday);
      form.elements.diagnosisDate.value = formatDateInput(profile.diagnosisDate);
      form.elements.address.value = profile.address || '';
    }
    document.getElementById('userMemberType').textContent = profile.memberType || '-';
    const receiptResponse = await callAPI('getMyReceipts', {});
    renderMyReceipts(receiptResponse.data || []);
  } catch (error) {}
}
function renderMyReceipts(receipts) {
  const container = document.getElementById('myReceiptsList');
  if (receipts.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-file-earmark-text"></i><p>您還沒有收據</p></div>';
    return;
  }
  container.innerHTML = receipts.map(receipt => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="activity-title">${receipt.receiptNumber}</div>
          <div class="activity-meta">
            <span><i class="bi bi-cash"></i>金額：$${formatCurrency(receipt.amount)}</span>
            <span><i class="bi bi-calendar"></i>${formatDate(receipt.issueDate)}</span>
          </div>
        </div>
        ${receipt.pdfUrl ? `
          <button class="btn btn-sm btn-gradient" onclick="window.open('${receipt.pdfUrl}', '_blank')">
            <i class="bi bi-download"></i>下載
          </button>
        ` : ''}
      </div>
    </div>
  `).join('');
}

document.getElementById('profileForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = {
    realName: formData.get('realName'),
    memberType: formData.get('memberType'),
    phone: formData.get('phone'),
    email: formData.get('email'),
    birthday: formData.get('birthday'),
    diagnosisDate: formData.get('diagnosisDate'),
    address: formData.get('address')
  };
  const btn = e.target.querySelector('button[type="submit"]');
  setButtonLoading(btn, true);
  try {
    await callAPI('updateProfile', data);
    showNotification('資料已更新', 'success');
    await loadProfileData();
  } catch (error) {
    showNotification('更新失敗：' + error.message, 'error');
  } finally {
    setButtonLoading(btn, false);
  }
});

// ==================== 管理 ====================
async function loadAdminData() {
  try {
    const response = await callAPI('getAdminData', {});
    cachedData.admin = response.data;
    renderMemberList(cachedData.admin.members || []);
    renderAdminActivityList(cachedData.admin.activities || []);
    renderTransactionList(cachedData.admin.transactions || []);
  } catch (error) {}
}
function renderMemberList(members) {
  const tbody = document.getElementById('memberList');
  if (members.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" class="text-center">沒有會員資料</td></tr>';
    return;
  }
  tbody.innerHTML = members.slice(0, 20).map(member => `
    <tr>
      <td>${member.realName || member.lineName || '-'}</td>
      <td>${member.memberType || '-'}</td>
      <td><span class="status-badge status-${member.status}">${member.status || '-'}</span></td>
    </tr>
  `).join('');
}
function renderAdminActivityList(activities) {
  const container = document.getElementById('adminActivityList');
  if (activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>沒有活動</p></div>';
    return;
  }
  container.innerHTML = activities.slice(0, 10).map(activity => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${activity.title}</div>
        <span class="status-badge status-${activity.status}">${activity.status}</span>
      </div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(activity.date)}</span>
        <span><i class="bi bi-people"></i>${activity.currentCount || 0}/${activity.maxParticipants}</span>
      </div>
    </div>
  `).join('');
}
function renderTransactionList(transactions) {
  const tbody = document.getElementById('transactionList');
  if (transactions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="text-center">沒有交易記錄</td></tr>';
    return;
  }
  tbody.innerHTML = transactions.slice(0, 20).map(trans => `
    <tr>
      <td>${formatDate(trans.date)}</td>
      <td>${trans.type}</td>
      <td>$${formatCurrency(trans.amount)}</td>
      <td><span class="status-badge status-${trans.status}">${trans.status}</span></td>
    </tr>
  `).join('');
}

// 匯出/備份
async function exportMembers() {
  try {
    showLoading(true);
    const response = await callAPI('exportMembers', {});
    if (response.data?.fileUrl) {
      window.open(response.data.fileUrl, '_blank');
      showNotification('會員資料已匯出', 'success');
    }
  } catch (error) {
    showNotification('匯出失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}
async function exportFinanceData() {
  try {
    showLoading(true);
    const response = await callAPI('exportFinanceData', {});
    if (response.data?.donationUrl) {
      window.open(response.data.donationUrl, '_blank');
      setTimeout(() => {
        if (response.data?.expenseUrl) window.open(response.data.expenseUrl, '_blank');
      }, 500);
      showNotification('財務報表已匯出', 'success');
    }
  } catch (error) {
    showNotification('匯出失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}
async function backupSystem() {
  if (!confirm('確定要執行系統備份嗎？')) return;
  try {
    showLoading(true);
    await callAPI('backupSystem', {});
    showNotification('系統備份完成', 'success');
  } catch (error) {
    showNotification('備份失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== Modal ====================
function showDonationModal() {
  const html = `
    <div class="modal fade" id="donationModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="donationForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>我要捐款</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="number" class="form-control" name="amount" required min="1">
              <label>捐款金額 *</label>
            </div>
            <div class="form-floating mb-3">
              <select class="form-select" name="category">
                <option value="一般捐款">一般捐款</option>
                <option value="活動贊助">活動贊助</option>
              </select>
              <label>捐款類別</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" style="height:80px;"></textarea>
              <label>說明</label>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" name="needReceipt" id="needReceipt">
              <label class="form-check-label" for="needReceipt">需要收據</label>
            </div>
            <div class="alert alert-info small" role="alert">
              若您的電子郵件未填寫，收據將僅產生 PDF 供下載，不會寄送 Email。
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-gradient">確認捐款</button>
          </div>
        </form>
      </div>
    </div>
  `;
  showModal(html, async (formData) => {
    const data = {
      amount: formData.get('amount'),
      category: formData.get('category'),
      description: formData.get('description'),
      needReceipt: formData.get('needReceipt') === 'on'
    };
    const res = await callAPI('createDonation', data);
    showNotification('捐款記錄已新增，感謝您的支持！', 'success');
    if (res?.data?.pdfUrl) {
      showNotification('已產生收據 PDF，可於「我的收據」或按此通知下載。', 'info');
    }
    await loadFinanceData();
    await loadHomeData();
  });
}

function showNewExpenseModal() {
  const html = `
    <div class="modal fade" id="expenseModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="expenseForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>支出申請</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="number" class="form-control" name="amount" required min="1">
              <label>金額 *</label>
            </div>
            <div class="form-floating mb-3">
              <select class="form-select" name="category" required>
                <option value="">請選擇</option>
                <option value="活動費用">活動費用</option>
                <option value="行政支出">行政支出</option>
                <option value="設備支出">設備支出</option>
              </select>
              <label>類別 *</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" required style="height:100px;"></textarea>
              <label>說明 *</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-gradient">送出申請</button>
          </div>
        </form>
      </div>
    </div>
  `;
  showModal(html, async (formData) => {
    const data = {
      amount: formData.get('amount'),
      category: formData.get('category'),
      description: formData.get('description')
    };
    await callAPI('createExpense', data);
    showNotification('支出申請已送出', 'success');
    await loadFinanceData();
  });
}

function showNewActivityModal() {
  const html = `
    <div class="modal fade" id="activityModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <form class="modal-content" id="activityForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>新增活動</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="text" class="form-control" name="title" required>
              <label>活動名稱 *</label>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="date" class="form-control" name="date" required>
                  <label>日期 *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="time" class="form-control" name="time">
                  <label>時間</label>
                </div>
              </div>
            </div>
            <div class="form-floating mb-3">
              <input type="text" class="form-control" name="location">
              <label>地點</label>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="maxParticipants" required min="1">
                  <label>人數上限 *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="fee" min="0" value="0">
                  <label>費用</label>
                </div>
              </div>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" style="height:100px;"></textarea>
              <label>活動說明</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-gradient">新增活動</button>
          </div>
        </form>
      </div>
    </div>
  `;
  showModal(html, async (formData) => {
    const data = {
      title: formData.get('title'),
      date: formData.get('date'),
      time: formData.get('time'),
      location: formData.get('location'),
      maxParticipants: formData.get('maxParticipants'),
      fee: formData.get('fee') || 0,
      description: formData.get('description')
    };
    await callAPI('createActivity', data);
    showNotification('活動已新增', 'success');
    await loadAdminData();
    await loadActivities();
  });
}

function showNewVolunteerNeedModal() {
  const html = `
    <div class="modal fade" id="volunteerModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="volunteerForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-people me-2"></i>新增志工需求</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="text" class="form-control" name="title" required>
              <label>需求名稱 *</label>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="date" class="form-control" name="date" required>
                  <label>日期 *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="time" class="form-control" name="time">
                  <label>時間</label>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="needCount" required min="1">
                  <label>需求人數 *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="hours" required min="0.5" step="0.5">
                  <label>服務時數 *</label>
                </div>
              </div>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" style="height:100px;"></textarea>
              <label>說明</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-gradient">新增需求</button>
          </div>
        </form>
      </div>
    </div>
  `;
  showModal(html, async (formData) => {
    const data = {
      title: formData.get('title'),
      date: formData.get('date'),
      time: formData.get('time'),
      needCount: formData.get('needCount'),
      hours: formData.get('hours'),
      description: formData.get('description')
    };
    await callAPI('createVolunteerNeed', data);
    showNotification('志工需求已新增', 'success');
    await loadVolunteerData();
  });
}

// ==================== 工具與導覽 ====================
function switchPage(pageName, event) {
  document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  document.getElementById(`page-${pageName}`).classList.add('active');
  if (event && event.currentTarget) event.currentTarget.classList.add('active');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function formatDate(dateInput) {
  if (!dateInput) return '-';
  try {
    let d;
    if (dateInput instanceof Date) {
      d = dateInput;
    } else if (typeof dateInput === 'number') {
      d = new Date(dateInput);
    } else if (typeof dateInput === 'string') {
      const parsed = Date.parse(dateInput);
      d = isNaN(parsed) ? new Date(dateInput) : new Date(parsed);
    } else {
      return '-';
    }
    if (isNaN(d.getTime())) return '-';
    return d.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
  } catch {
    return '-';
  }
}
function formatDateInput(dateString) {
  if (!dateString) return '';
  try {
    const d = (dateString instanceof Date) ? dateString : new Date(dateString);
    if (isNaN(d.getTime())) return '';
    return d.toISOString().split('T')[0];
  } catch { return ''; }
}
function formatCurrency(amount) {
  return new Intl.NumberFormat('zh-TW').format(Number(amount || 0));
}
function showLoading(show) {
  let overlay = document.querySelector('.loading-overlay');
  if (show) {
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.innerHTML = '<div class="loading-spinner"></div>';
      document.body.appendChild(overlay);
    }
  } else {
    overlay?.remove();
  }
}
function setButtonLoading(button, loading) {
  if (loading) {
    button.disabled = true;
    button.dataset.originalText = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>處理中...';
  } else {
    button.disabled = false;
    if (button.dataset.originalText) button.innerHTML = button.dataset.originalText;
  }
}
function showNotification(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const colors = { success: '#28a745', error: '#dc3545', warning: '#ffc107', info: '#17a2b8' };
  const icons = { success: 'check-circle-fill', error: 'x-circle-fill', warning: 'exclamation-triangle-fill', info: 'info-circle-fill' };
  const toast = document.createElement('div');
  toast.className = 'toast show';
  toast.style.cssText = `min-width: 250px; margin-bottom: 10px; background: white; border-left: 4px solid ${colors[type]}; box-shadow: 0 4px 12px rgba(0,0,0,0.15);`;
  toast.innerHTML = `
    <div class="toast-body d-flex align-items-center">
      <i class="bi bi-${icons[type]} me-2" style="color: ${colors[type]}; font-size: 18px;"></i>
      <div class="flex-grow-1" style="font-size: 14px;">${message}</div>
      <button type="button" class="btn-close ms-2" aria-label="Close"></button>
    </div>
  `;
  const closeBtn = toast.querySelector('.btn-close');
  closeBtn.addEventListener('click', () => toast.remove());
  container.appendChild(toast);
  setTimeout(() => {
    toast.classList.remove('show');
    toast.addEventListener('transitionend', () => toast.remove());
    toast.remove(); // 保底移除
  }, 3000);
}

function showModal(html, onSubmit) {
  const container = document.getElementById('modalContainer');
  container.innerHTML = html;
  const modalEl = container.querySelector('.modal');
  const formEl = container.querySelector('form');
  const bsModal = new bootstrap.Modal(modalEl);
  if (formEl && typeof onSubmit === 'function') {
    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = formEl.querySelector('button[type="submit"]');
      setButtonLoading(submitBtn, true);
      try {
        const formData = new FormData(formEl);
        await onSubmit(formData);
        bsModal.hide();
      } catch (err) {
        showNotification(err.message || '操作失敗', 'error');
      } finally {
        setButtonLoading(submitBtn, false);
      }
    });
  }
  modalEl.addEventListener('hidden.bs.modal', () => {
    // 關閉後清空容器，避免殘留
    container.innerHTML = '';
  }, { once: true });
  bsModal.show();
}

// ==================== 啟動 ====================
document.addEventListener('DOMContentLoaded', () => {
  // 若未在 LINE 環境，仍嘗試初始化，錯誤會由 initLIFF 處理
  initLIFF();
});
</script>
</body>
</html>
