<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒ</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #2196F3;
      --secondary: #4CAF50;
      --accent: #FF9800;
      --danger: #f44336;
      --purple: #9C27B0;
      --dark: #333;
      --light: #666;
      --bg: #f5f5f5;
      --white: #fff;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --shadow-hover: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    body {
      font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
      background: var(--bg);
      color: var(--dark);
      line-height: 1.6;
      padding-bottom: 70px;
    }
    
    .top-bar {
      background: linear-gradient(135deg, var(--primary), #1976D2);
      color: white;
      padding: 1rem;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .top-bar-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 1.2rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
      z-index: 999;
    }
    
    .nav-item {
      flex: 1;
      text-align: center;
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      background: none;
      color: var(--light);
    }
    
    .nav-item.active {
      color: var(--primary);
    }
    
    .nav-item .icon {
      font-size: 1.5rem;
      display: block;
      margin-bottom: 0.25rem;
    }
    
    .nav-item .label {
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    
    .page {
      display: none;
      animation: fadeIn 0.3s;
    }
    
    .page.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
    }
    
    .card-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 1rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .feature-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem 1rem;
      text-align: center;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    
    .feature-card:hover {
      border-color: var(--primary);
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }
    
    .feature-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      display: block;
    }
    
    .feature-label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--dark);
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #1976D2;
      box-shadow: var(--shadow-hover);
    }
    
    .btn-block {
      width: 100%;
      display: flex;
    }
    
    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--dark);
      font-size: 0.95rem;
    }
    
    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s;
      font-family: inherit;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: linear-gradient(135deg, var(--primary), #1976D2);
      color: white;
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: var(--shadow);
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .stat-card.green {
      background: linear-gradient(135deg, #4CAF50, #388E3C);
    }
    
    .stat-card.orange {
      background: linear-gradient(135deg, #FF9800, #F57C00);
    }
    
    .stat-card.purple {
      background: linear-gradient(135deg, #9C27B0, #7B1FA2);
    }
    
    .stat-card.red {
      background: linear-gradient(135deg, #f44336, #d32f2f);
    }
    
    .list-item {
      background: white;
      padding: 1rem;
      margin-bottom: 0.75rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
    }
    
    .list-item:hover {
      box-shadow: var(--shadow-hover);
      transform: translateX(5px);
    }
    
    .list-item-content {
      flex: 1;
    }
    
    .list-item-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--dark);
    }
    
    .list-item-meta {
      font-size: 0.85rem;
      color: var(--light);
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .badge-success { background: #E8F5E9; color: var(--secondary); }
    .badge-warning { background: #FFF3E0; color: var(--accent); }
    .badge-primary { background: #E3F2FD; color: var(--primary); }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(50px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--bg);
    }
    
    .modal-title {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--primary);
    }
    
    .modal-close {
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--light);
      background: none;
      border: none;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }
    
    .modal-close:hover {
      background: var(--bg);
      color: var(--dark);
    }
    
    .notification {
      position: fixed;
      top: 80px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      color: white;
      box-shadow: var(--shadow-hover);
      z-index: 3000;
      max-width: 300px;
      animation: slideInRight 0.3s;
    }
    
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(100px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .notification.success { background: var(--secondary); }
    .notification.error { background: var(--danger); }
    .notification.info { background: var(--primary); }
    
    .loading {
      text-align: center;
      padding: 2rem;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto;
      border: 4px solid var(--bg);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .hidden { display: none !important; }
    
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      overflow-x: auto;
      padding-bottom: 0.5rem;
    }
    
    .tab {
      padding: 0.75rem 1.5rem;
      border: none;
      background: white;
      color: var(--light);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
      white-space: nowrap;
      box-shadow: var(--shadow);
    }
    
    .tab.active {
      background: var(--primary);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--light);
    }
    
    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    @media (max-width: 768px) {
      .feature-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .notification {
        right: 10px;
        left: 10px;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="top-bar-content">
      <div class="logo">
        <span>ğŸ¥</span>
        <span>å¸•é‡‘æ£®å”æœƒ</span>
      </div>
      <div class="user-info">
        <div class="guest-buttons">
          <button class="btn btn-primary btn-small" onclick="handleLIFFLogin()">ç™»å…¥</button>
        </div>
        <div class="member-info hidden">
          <span id="memberName" style="margin-right: 0.5rem;">æœƒå“¡</span>
          <button class="btn btn-small" onclick="logout()" style="background: #FF9800; color: white;">ç™»å‡º</button>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <!-- é¦–é  -->
    <div id="homePage" class="page active">
      <div class="card">
        <div class="card-title">
          <span>ğŸ‘‹</span>
          <span>æ­¡è¿ä½¿ç”¨</span>
        </div>
        <p style="color: var(--light); margin-bottom: 1rem;">å¸•é‡‘æ£®ç—…å‹æ¬Šç›Šä¿ƒé€²æœƒç®¡ç†ç³»çµ±</p>
        
        <div class="feature-grid">
          <div class="feature-card" onclick="showPage('members')">
            <span class="feature-icon">ğŸ‘¥</span>
            <div class="feature-label">æœƒå“¡ç®¡ç†</div>
          </div>
          
          <div class="feature-card" onclick="showPage('activities')">
            <span class="feature-icon">ğŸ“…</span>
            <div class="feature-label">æ´»å‹•ç®¡ç†</div>
          </div>
          
          <div class="feature-card" onclick="showPage('finance')">
            <span class="feature-icon">ğŸ’°</span>
            <div class="feature-label">è²¡å‹™ç®¡ç†</div>
          </div>
          
          <div class="feature-card" onclick="showPage('reports')">
            <span class="feature-icon">ğŸ“Š</span>
            <div class="feature-label">å ±è¡¨çµ±è¨ˆ</div>
          </div>
        </div>
      </div>
      
      <div class="card admin-only hidden">
        <div class="card-title">
          <span>âš™ï¸</span>
          <span>ç®¡ç†åŠŸèƒ½</span>
        </div>
        
        <div class="feature-grid">
          <div class="feature-card" onclick="showPage('receipts')">
            <span class="feature-icon">ğŸ“„</span>
            <div class="feature-label">æ”¶æ“šç®¡ç†</div>
          </div>
          
          <div class="feature-card" onclick="showPage('vouchers')">
            <span class="feature-icon">ğŸ“‹</span>
            <div class="feature-label">æ†‘è­‰ç®¡ç†</div>
          </div>
          
          <div class="feature-card" onclick="exportAllData()">
            <span class="feature-icon">ğŸ’¾</span>
            <div class="feature-label">è³‡æ–™åŒ¯å‡º</div>
          </div>
          
          <div class="feature-card" onclick="backupSystem()">
            <span class="feature-icon">ğŸ”„</span>
            <div class="feature-label">ç³»çµ±å‚™ä»½</div>
          </div>
        </div>
      </div>
    </div>

    <!-- æœƒå“¡ç®¡ç†é é¢ -->
    <div id="membersPage" class="page">
      <div class="card">
        <div class="card-title">
          <span>ğŸ‘¥</span>
          <span>æœƒå“¡ç®¡ç†</span>
        </div>
        
        <button class="btn btn-primary btn-block admin-only hidden" onclick="openModal('addMemberModal')" style="margin-bottom: 1rem;">
          <span>â•</span>
          <span>æ–°å¢æœƒå“¡</span>
        </button>
        
        <div id="membersList"></div>
      </div>
    </div>

    <!-- æ´»å‹•ç®¡ç†é é¢ -->
    <div id="activitiesPage" class="page">
      <div class="card">
        <div class="card-title">
          <span>ğŸ“…</span>
          <span>æ´»å‹•ç®¡ç†</span>
        </div>
        
        <button class="btn btn-primary btn-block admin-only hidden" onclick="openModal('addActivityModal')" style="margin-bottom: 1rem;">
          <span>â•</span>
          <span>æ–°å¢æ´»å‹•</span>
        </button>
        
        <div id="activitiesList"></div>
      </div>
    </div>

    <!-- è²¡å‹™ç®¡ç†é é¢ -->
    <div id="financePage" class="page">
      <div class="card">
        <div class="card-title">
          <span>ğŸ’°</span>
          <span>è²¡å‹™ç®¡ç†</span>
        </div>
        
        <div class="stats-grid" id="financeStats"></div>
        
        <div class="tabs">
          <button class="tab active" onclick="showFinanceTab('fees', event)">æœƒè²»</button>
          <button class="tab" onclick="showFinanceTab('donations', event)">ææ¬¾</button>
          <button class="tab" onclick="showFinanceTab('expenses', event)">æ”¯å‡º</button>
        </div>
        
        <div id="feesTab" class="tab-content active">
          <button class="btn btn-primary admin-only hidden" onclick="openModal('addFeeModal')" style="margin-bottom: 1rem;">
            <span>â•</span>
            <span>æ–°å¢æœƒè²»</span>
          </button>
          <div id="feesList"></div>
        </div>
        
        <div id="donationsTab" class="tab-content">
          <button class="btn btn-primary admin-only hidden" onclick="openModal('addDonationModal')" style="margin-bottom: 1rem;">
            <span>â•</span>
            <span>æ–°å¢ææ¬¾</span>
          </button>
          <div id="donationsList"></div>
        </div>
        
        <div id="expensesTab" class="tab-content">
          <button class="btn btn-primary admin-only hidden" onclick="openModal('addExpenseModal')" style="margin-bottom: 1rem;">
            <span>â•</span>
            <span>æ–°å¢æ”¯å‡º</span>
          </button>
          <div id="expensesList"></div>
        </div>
      </div>
    </div>

    <!-- å ±è¡¨çµ±è¨ˆé é¢ -->
    <div id="reportsPage" class="page">
      <div class="card">
        <div class="card-title">
          <span>ğŸ“Š</span>
          <span>å ±è¡¨çµ±è¨ˆ</span>
        </div>
        
        <div class="tabs">
          <button class="tab active" onclick="showReportTab('income', event)">æ”¶æ”¯æ˜ç´°</button>
          <button class="tab" onclick="showReportTab('cashbook', event)">ç¾é‡‘å‡ºç´</button>
          <button class="tab" onclick="showReportTab('balance', event)">è³‡ç”¢è² å‚µ</button>
        </div>
        
        <div id="incomeTab" class="tab-content active">
          <div class="form-row" style="margin-bottom: 1rem;">
            <div class="form-group">
              <label class="form-label">èµ·å§‹æ—¥æœŸ</label>
              <input type="date" class="form-control" id="incomeStartDate">
            </div>
            <div class="form-group">
              <label class="form-label">çµæŸæ—¥æœŸ</label>
              <input type="date" class="form-control" id="incomeEndDate">
            </div>
            <div style="display: flex; align-items: flex-end;">
              <button class="btn btn-primary" onclick="loadIncomeReport()">
                <span>ğŸ”</span>
                <span>æŸ¥è©¢</span>
              </button>
            </div>
          </div>
          <div id="incomeReportContent"></div>
        </div>
        
        <div id="cashbookTab" class="tab-content">
          <div class="form-row" style="margin-bottom: 1rem;">
            <div class="form-group">
              <label class="form-label">èµ·å§‹æ—¥æœŸ</label>
              <input type="date" class="form-control" id="cashbookStartDate">
            </div>
            <div class="form-group">
              <label class="form-label">çµæŸæ—¥æœŸ</label>
              <input type="date" class="form-control" id="cashbookEndDate">
            </div>
            <div style="display: flex; align-items: flex-end;">
              <button class="btn btn-primary" onclick="loadCashbookReport()">
                <span>ğŸ”</span>
                <span>æŸ¥è©¢</span>
              </button>
            </div>
          </div>
          <div id="cashbookReportContent"></div>
        </div>
        
        <div id="balanceTab" class="tab-content">
          <div class="form-row" style="margin-bottom: 1rem;">
            <div class="form-group">
              <label class="form-label">åŸºæº–æ—¥æœŸ</label>
              <input type="date" class="form-control" id="balanceDate">
            </div>
            <div style="display: flex; align-items: flex-end;">
              <button class="btn btn-primary" onclick="loadBalanceReport()">
                <span>ğŸ”</span>
                <span>æŸ¥è©¢</span>
              </button>
            </div>
          </div>
          <div id="balanceReportContent"></div>
        </div>
      </div>
    </div>

    <!-- æ”¶æ“šç®¡ç†é é¢ -->
    <div id="receiptsPage" class="page admin-only">
      <div class="card">
        <div class="card-title">
          <span>ğŸ“„</span>
          <span>æ”¶æ“šç®¡ç†</span>
        </div>
        
        <button class="btn btn-primary" onclick="openModal('generateReceiptModal')" style="margin-bottom: 1rem;">
          <span>â•</span>
          <span>é–‹ç«‹æ”¶æ“š</span>
        </button>
        
        <div id="receiptsList"></div>
      </div>
    </div>

    <!-- æ†‘è­‰ç®¡ç†é é¢ -->
    <div id="vouchersPage" class="page admin-only">
      <div class="card">
        <div class="card-title">
          <span>ğŸ“‹</span>
          <span>æ†‘è­‰ç®¡ç†</span>
        </div>
        
        <button class="btn btn-primary" onclick="openModal('generateVoucherModal')" style="margin-bottom: 1rem;">
          <span>â•</span>
          <span>é–‹ç«‹æ†‘è­‰</span>
        </button>
        
        <div id="vouchersList"></div>
      </div>
    </div>
  </div>

  <div class="bottom-nav">
    <button class="nav-item active" onclick="showPage('home')">
      <span class="icon">ğŸ </span>
      <span class="label">é¦–é </span>
    </button>
    
    <button class="nav-item" onclick="showPage('members')">
      <span class="icon">ğŸ‘¥</span>
      <span class="label">æœƒå“¡</span>
    </button>
    
    <button class="nav-item" onclick="showPage('activities')">
      <span class="icon">ğŸ“…</span>
      <span class="label">æ´»å‹•</span>
    </button>
    
    <button class="nav-item" onclick="showPage('finance')">
      <span class="icon">ğŸ’°</span>
      <span class="label">è²¡å‹™</span>
    </button>
    
    <button class="nav-item" onclick="showPage('reports')">
      <span class="icon">ğŸ“Š</span>
      <span class="label">å ±è¡¨</span>
    </button>
  </div>

  <!-- æ¨¡æ…‹æ¡† -->
  <div id="addMemberModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">â• æ–°å¢æœƒå“¡</div>
        <button class="modal-close" onclick="closeModal('addMemberModal')">Ã—</button>
      </div>
      <form onsubmit="handleAddMember(event)">
        <div class="form-group">
          <label class="form-label">å§“å *</label>
          <input type="text" class="form-control" name="name" required>
        </div>
        <div class="form-group">
          <label class="form-label">é›»è©± *</label>
          <input type="tel" class="form-control" name="phone" required>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" name="email">
        </div>
        <button type="submit" class="btn btn-primary btn-block">æ–°å¢</button>
      </form>
    </div>
  </div>

  <div id="addActivityModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">â• æ–°å¢æ´»å‹•</div>
        <button class="modal-close" onclick="closeModal('addActivityModal')">Ã—</button>
      </div>
      <form onsubmit="handleAddActivity(event)">
        <div class="form-group">
          <label class="form-label">æ´»å‹•åç¨± *</label>
          <input type="text" class="form-control" name="name" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">æ´»å‹•é¡å‹ *</label>
            <select class="form-control" name="type" required>
              <option value="">è«‹é¸æ“‡</option>
              <option value="åº§è«‡æœƒ">åº§è«‡æœƒ</option>
              <option value="å¾©å¥èª²ç¨‹">å¾©å¥èª²ç¨‹</option>
              <option value="å¥åº·è¬›åº§">å¥åº·è¬›åº§</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">åé¡ *</label>
            <input type="number" class="form-control" name="capacity" required min="1">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">æ´»å‹•æ—¥æœŸ *</label>
            <input type="date" class="form-control" name="date" required>
          </div>
          <div class="form-group">
            <label class="form-label">æ´»å‹•æ™‚é–“ *</label>
            <input type="text" class="form-control" name="time" placeholder="ä¾‹å¦‚ï¼š14:00-16:00" required>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">åœ°é» *</label>
          <input type="text" class="form-control" name="location" required>
        </div>
        <div class="form-group">
          <label class="form-label">è¬›å¸« *</label>
          <input type="text" class="form-control" name="instructor" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">å»ºç«‹æ´»å‹•</button>
      </form>
    </div>
  </div>

  <div id="addFeeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">â• æ–°å¢æœƒè²»</div>
        <button class="modal-close" onclick="closeModal('addFeeModal')">Ã—</button>
      </div>
      <form onsubmit="handleAddFee(event)">
        <div class="form-group">
          <label class="form-label">æœƒå“¡ç·¨è™Ÿ *</label>
          <input type="text" class="form-control" name="memberId" required>
        </div>
        <div class="form-group">
          <label class="form-label">æœƒå“¡å§“å *</label>
          <input type="text" class="form-control" name="memberName" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">å¹´åº¦ *</label>
            <input type="number" class="form-control" name="year" value="2025" required>
          </div>
          <div class="form-group">
            <label class="form-label">é‡‘é¡ *</label>
            <input type="number" class="form-control" name="amount" required min="0">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ç¹³è²»æ—¥æœŸ *</label>
            <input type="date" class="form-control" name="paymentDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">ç¹³è²»æ–¹å¼ *</label>
            <select class="form-control" name="paymentMethod" required>
              <option value="">è«‹é¸æ“‡</option>
              <option value="ç¾é‡‘">ç¾é‡‘</option>
              <option value="è½‰å¸³">è½‰å¸³</option>
              <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
            </select>
          </div>
        </div>
        <button type="submit" class="btn btn-primary btn-block">æ–°å¢</button>
      </form>
    </div>
  </div>

  <div id="addDonationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">â• æ–°å¢ææ¬¾</div>
        <button class="modal-close" onclick="closeModal('addDonationModal')">Ã—</button>
      </div>
      <form onsubmit="handleAddDonation(event)">
        <div class="form-group">
          <label class="form-label">ææ¬¾äººé¡å‹ *</label>
          <select class="form-control" name="donorType" required>
            <option value="">è«‹é¸æ“‡</option>
            <option value="æœƒå“¡">æœƒå“¡</option>
            <option value="éæœƒå“¡">éæœƒå“¡</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ææ¬¾äººå§“å *</label>
          <input type="text" class="form-control" name="donorName" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">é‡‘é¡ *</label>
            <input type="number" class="form-control" name="amount" required min="0">
          </div>
          <div class="form-group">
            <label class="form-label">ææ¬¾æ—¥æœŸ *</label>
            <input type="date" class="form-control" name="donationDate" required>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ææ¬¾æ–¹å¼ *</label>
          <select class="form-control" name="paymentMethod" required>
            <option value="">è«‹é¸æ“‡</option>
            <option value="ç¾é‡‘">ç¾é‡‘</option>
            <option value="è½‰å¸³">è½‰å¸³</option>
            <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ææ¬¾ç”¨é€” *</label>
          <select class="form-control" name="purpose" required>
            <option value="">è«‹é¸æ“‡</option>
            <option value="ä¸€èˆ¬ææ¬¾">ä¸€èˆ¬ææ¬¾</option>
            <option value="æ´»å‹•è´ŠåŠ©">æ´»å‹•è´ŠåŠ©</option>
            <option value="è¨­å‚™è³¼ç½®">è¨­å‚™è³¼ç½®</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary btn-block">æ–°å¢</button>
      </form>
    </div>
  </div>

  <div id="addExpenseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">â• æ–°å¢æ”¯å‡º</div>
        <button class="modal-close" onclick="closeModal('addExpenseModal')">Ã—</button>
      </div>
      <form onsubmit="handleAddExpense(event)">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">æ”¯å‡ºæ—¥æœŸ *</label>
            <input type="date" class="form-control" name="expenseDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">æ”¯å‡ºé¡åˆ¥ *</label>
            <select class="form-control" name="category" required>
              <option value="">è«‹é¸æ“‡</option>
              <option value="å ´åœ°ç§Ÿå€Ÿ">å ´åœ°ç§Ÿå€Ÿ</option>
              <option value="è¬›å¸«è²»">è¬›å¸«è²»</option>
              <option value="å°åˆ·è²»">å°åˆ·è²»</option>
              <option value="é¤é£²è²»">é¤é£²è²»</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">æ”¯å‡ºé …ç›® *</label>
          <input type="text" class="form-control" name="item" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">é‡‘é¡ *</label>
            <input type="number" class="form-control" name="amount" required min="0">
          </div>
          <div class="form-group">
            <label class="form-label">æ”¯ä»˜æ–¹å¼ *</label>
            <select class="form-control" name="paymentMethod" required>
              <option value="">è«‹é¸æ“‡</option>
              <option value="ç¾é‡‘">ç¾é‡‘</option>
              <option value="è½‰å¸³">è½‰å¸³</option>
              <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">å—æ¬¾äºº *</label>
          <input type="text" class="form-control" name="payee" required>
        </div>
        <div class="form-group">
          <label class="form-label">æ ¸å‡†äºº *</label>
          <input type="text" class="form-control" name="approver" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">æ–°å¢</button>
      </form>
    </div>
  </div>

  <div id="generateReceiptModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ğŸ“„ é–‹ç«‹æ”¶æ“š</div>
        <button class="modal-close" onclick="closeModal('generateReceiptModal')">Ã—</button>
      </div>
      <form onsubmit="handleGenerateReceipt(event)">
        <div class="form-group">
          <label class="form-label">æ”¶æ“šé¡å‹ *</label>
          <select class="form-control" name="type" required>
            <option value="">è«‹é¸æ“‡</option>
            <option value="æœƒè²»">æœƒè²»</option>
            <option value="ææ¬¾">ææ¬¾</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">é—œè¯è¨˜éŒ„ç·¨è™Ÿ *</label>
          <input type="text" class="form-control" name="relatedId" required>
        </div>
        <div class="form-group">
          <label class="form-label">æ”¶æ“šæŠ¬é ­ *</label>
          <input type="text" class="form-control" name="receiptName" required>
        </div>
        <div class="form-group">
          <label class="form-label">é‡‘é¡ *</label>
          <input type="number" class="form-control" name="amount" required min="0">
        </div>
        <button type="submit" class="btn btn-primary btn-block">é–‹ç«‹æ”¶æ“š</button>
      </form>
    </div>
  </div>

  <div id="generateVoucherModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ğŸ“‹ é–‹ç«‹æ†‘è­‰</div>
        <button class="modal-close" onclick="closeModal('generateVoucherModal')">Ã—</button>
      </div>
      <form onsubmit="handleGenerateVoucher(event)">
        <div class="form-group">
          <label class="form-label">æ”¯å‡ºè¨˜éŒ„ç·¨è™Ÿ *</label>
          <input type="text" class="form-control" name="expenseId" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">æ†‘è­‰é¡å‹ *</label>
            <select class="form-control" name="voucherType" required>
              <option value="">è«‹é¸æ“‡</option>
              <option value="ç™¼ç¥¨">ç™¼ç¥¨</option>
              <option value="æ”¶æ“š">æ”¶æ“š</option>
              <option value="æ”¯å‡ºè­‰æ˜å–®">æ”¯å‡ºè­‰æ˜å–®</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">æ†‘è­‰æ—¥æœŸ *</label>
            <input type="date" class="form-control" name="voucherDate" required>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ç”¨é€”èªªæ˜ *</label>
          <textarea class="form-control" name="description" rows="3" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary btn-block">é–‹ç«‹æ†‘è­‰</button>
      </form>
    </div>
  </div>

  <script>
    // å…¨åŸŸè®Šæ•¸
    let currentUser = null;
    const API_URL = 'https://script.google.com/macros/s/AKfycby1APlNkkdYZmU0b0hiLirgFFBxViDSdpRQW9js4bc67s_jbrJg8RTD5men0RVXPHFe/exec'; // âš ï¸ è«‹æ›¿æ›ç‚ºæ‚¨çš„ Web App URL
    const LIFF_ID = '1656516134-VaGgmaPm'; // âš ï¸ è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID

    // åˆå§‹åŒ–
    window.onload = function() {
      initLIFF();
      setDefaultDates();
    };

    // LIFF åˆå§‹åŒ–
    async function initLIFF() {
      try {
        await liff.init({ liffId: LIFF_ID });
        
        if (liff.isLoggedIn()) {
          handleLIFFLogin();
        }
      } catch (error) {
        console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
      }
    }

    async function handleLIFFLogin() {
      try {
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        
        const profile = await liff.getProfile();
        
        const response = await callAPI('login', { phone: profile.userId });
        
        if (response.success) {
          currentUser = response.data;
          currentUser.lineProfile = profile;
          updateUIForLoggedInUser();
          showNotification('ç™»å…¥æˆåŠŸï¼', 'success');
          loadInitialData();
        } else {
          showNotification('è«‹å…ˆè¨»å†Šæœƒå“¡', 'error');
        }
      } catch (error) {
        console.error('LIFF ç™»å…¥å¤±æ•—:', error);
        showNotification('ç™»å…¥å¤±æ•—', 'error');
      }
    }

    function setDefaultDates() {
      const today = new Date().toISOString().split('T')[0];
      const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
      
      ['incomeStartDate', 'cashbookStartDate'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = firstDay;
      });
      
      ['incomeEndDate', 'cashbookEndDate', 'balanceDate'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = today;
      });
    }

    function updateUIForLoggedInUser() {
      document.querySelectorAll('.guest-buttons').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.member-info').forEach(el => el.classList.remove('hidden'));
      document.getElementById('memberName').textContent = currentUser.name;
      
      if (currentUser.isAdmin) {
        document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
      }
    }

    function logout() {
      currentUser = null;
      if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
        liff.logout();
      }
      
      document.querySelectorAll('.guest-buttons').forEach(el => el.classList.remove('hidden'));
      document.querySelectorAll('.member-info').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
      
      showPage('home');
      showNotification('å·²æˆåŠŸç™»å‡º', 'info');
    }

    function loadInitialData() {
      loadMembers();
      loadActivities();
      loadFinanceData();
    }

    // API å‘¼å«
    async function callAPI(action, data = {}) {
      try {
        data.action = action;
        data.operator = currentUser ? currentUser.name : 'Guest';
        
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        return await response.json();
      } catch (error) {
        console.error('API å‘¼å«å¤±æ•—:', error);
        return { success: false, message: 'API å‘¼å«å¤±æ•—' };
      }
    }

    // é é¢å°èˆª
    function showPage(pageName) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById(pageName + 'Page').classList.add('active');
      
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      const navItems = document.querySelectorAll('.nav-item');
      const pageMap = { home: 0, members: 1, activities: 2, finance: 3, reports: 4 };
      if (pageMap[pageName] !== undefined) {
        navItems[pageMap[pageName]].classList.add('active');
      }
      
      loadPageData(pageName);
      window.scrollTo(0, 0);
    }

    function loadPageData(pageName) {
      switch(pageName) {
        case 'members': loadMembers(); break;
        case 'activities': loadActivities(); break;
        case 'finance': loadFinanceData(); break;
        case 'receipts': loadReceipts(); break;
        case 'vouchers': loadVouchers(); break;
      }
    }

    // æ¨¡æ…‹æ¡†
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // é€šçŸ¥
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => notification.remove(), 3000);
    }

    // æœƒå“¡ç®¡ç†
    async function loadMembers() {
      const container = document.getElementById('membersList');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      const response = await callAPI('getMembers');
      
      if (response.success && response.data.length > 0) {
        container.innerHTML = response.data.map(member => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="list-item-title">${member.å§“å}</div>
              <div class="list-item-meta">
                <span>ğŸ“± ${member.é›»è©±}</span>
                <span>ğŸ†” ${member.æœƒå“¡ç·¨è™Ÿ}</span>
              </div>
            </div>
            <span class="badge badge-success">${member.ç‹€æ…‹}</span>
          </div>
        `).join('');
      } else {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ‘¥</div><p>å°šç„¡æœƒå“¡è³‡æ–™</p></div>';
      }
    }

    async function handleAddMember(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData);
      
      const response = await callAPI('addMember', data);
      
      if (response.success) {
        showNotification('æœƒå“¡æ–°å¢æˆåŠŸï¼', 'success');
        closeModal('addMemberModal');
        event.target.reset();
        loadMembers();
      } else {
        showNotification(response.message, 'error');
      }
    }

    // æ´»å‹•ç®¡ç†
    async function loadActivities() {
      const container = document.getElementById('activitiesList');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      const response = await callAPI('getActivities');
      
      if (response.success && response.data.length > 0) {
        container.innerHTML = response.data.map(activity => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="list-item-title">${activity.æ´»å‹•åç¨±}</div>
              <div class="list-item-meta">
                <span>ğŸ“… ${new Date(activity.æ´»å‹•æ—¥æœŸ).toLocaleDateString('zh-TW')}</span>
                <span>â° ${activity.æ´»å‹•æ™‚é–“}</span>
                <span>ğŸ“ ${activity.åœ°é»}</span>
              </div>
              <small style="color: var(--light);">å·²å ±å ${activity.å·²å ±å}/${activity.åé¡} äºº</small>
            </div>
            <span class="badge badge-primary">${activity.ç‹€æ…‹}</span>
          </div>
        `).join('');
      } else {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“…</div><p>å°šç„¡æ´»å‹•è³‡æ–™</p></div>';
      }
    }

    async function handleAddActivity(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData);
      
      const response = await callAPI('addActivity', data);
      
      if (response.success) {
        showNotification('æ´»å‹•æ–°å¢æˆåŠŸï¼', 'success');
        closeModal('addActivityModal');
        event.target.reset();
        loadActivities();
      } else {
        showNotification(response.message, 'error');
      }
    }

    // è²¡å‹™ç®¡ç†
    async function loadFinanceData() {
      await loadFinanceStats();
      showFinanceTab('fees', { target: document.querySelector('.tabs .tab') });
    }

    async function loadFinanceStats() {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), 0, 1);
      
      const response = await callAPI('getFinanceReport', {
        startDate: firstDay.toISOString().split('T')[0],
        endDate: today.toISOString().split('T')[0]
      });
      
      if (response.success) {
        const data = response.data;
        document.getElementById('financeStats').innerHTML = `
          <div class="stat-card green">
            <div class="stat-number">NT$ ${data.totalIncome.toLocaleString()}</div>
            <div class="stat-label">æœ¬å¹´åº¦æ”¶å…¥</div>
          </div>
          <div class="stat-card red">
            <div class="stat-number">NT$ ${data.totalExpenses.toLocaleString()}</div>
            <div class="stat-label">æœ¬å¹´åº¦æ”¯å‡º</div>
          </div>
          <div class="stat-card orange">
            <div class="stat-number">NT$ ${data.balance.toLocaleString()}</div>
            <div class="stat-label">æœ¬å¹´åº¦çµé¤˜</div>
          </div>
          <div class="stat-card purple">
            <div class="stat-number">NT$ ${data.totalFees.toLocaleString()}</div>
            <div class="stat-label">æœƒè²»æ”¶å…¥</div>
          </div>
        `;
      }
    }

    function showFinanceTab(tabName, event) {
      document.querySelectorAll('#financePage .tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('#financePage .tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      if (tabName === 'fees') loadFees();
      else if (tabName === 'donations') loadDonations();
      else if (tabName === 'expenses') loadExpenses();
    }

    async function loadFees() {
      const container = document.getElementById('feesList');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      const response = await callAPI('getFees', { year: new Date().getFullYear() });
      
      if (response.success && response.data.length > 0) {
        container.innerHTML = response.data.map(fee => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="list-item-title">${fee.æœƒå“¡å§“å} - ${fee.å¹´åº¦}å¹´åº¦æœƒè²»</div>
              <div class="list-item-meta">
                <span>ğŸ’° NT$ ${Number(fee.é‡‘é¡).toLocaleString()}</span>
                <span>ğŸ“… ${new Date(fee.ç¹³è²»æ—¥æœŸ).toLocaleDateString('zh-TW')}</span>
                <span class="badge badge-success">${fee.ç‹€æ…‹}</span>
              </div>
            </div>
          </div>
        `).join('');
      } else {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ’°</div><p>å°šç„¡æœƒè²»è¨˜éŒ„</p></div>';
      }
    }

    async function loadDonations() {
      const container = document.getElementById('donationsList');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      const response = await callAPI('getDonations', {});
      
      if (response.success && response.data.length > 0) {
        container.innerHTML = response.data.map(donation => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="list-item-title">${donation.ææ¬¾äººå§“å} - ${donation.ç”¨é€”}</div>
              <div class="list-item-meta">
                <span>ğŸ’° NT$ ${Number(donation.é‡‘é¡).toLocaleString()}</span>
                <span>ğŸ“… ${new Date(donation.ææ¬¾æ—¥æœŸ).toLocaleDateString('zh-TW')}</span>
              </div>
            </div>
          </div>
        `).join('');
      } else {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">â¤ï¸</div><p>å°šç„¡ææ¬¾è¨˜éŒ„</p></div>';
      }
    }

    async function loadExpenses() {
      const container = document.getElementById('expensesList');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      const response = await callAPI('getExpenses', {});
      
      if (response.success && response.data.length > 0) {
        container.innerHTML = response.data.map(expense => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="list-item-title">${expense.æ”¯å‡ºé …ç›®}</div>
              <div class="list-item-meta">
                <span>ğŸ’° NT$ ${Number(expense.é‡‘é¡).toLocaleString()}</span>
                <span>ğŸ“… ${new Date(expense.æ”¯å‡ºæ—¥æœŸ).toLocaleDateString('zh-TW')}</span>
                <span class="badge badge-${expense.ç‹€æ…‹ === 'å·²æ ¸å‡†' ? 'success' : 'warning'}">${expense.ç‹€æ…‹}</span>
              </div>
            </div>
          </div>
        `).join('');
      } else {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ’¸</div><p>å°šç„¡æ”¯å‡ºè¨˜éŒ„</p></div>';
      }
    }

    async function handleAddFee(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData);
      
      const response = await callAPI('addFee', data);
      
      if (response.success) {
        showNotification('æœƒè²»è¨˜éŒ„æ–°å¢æˆåŠŸï¼', 'success');
        closeModal('addFeeModal');
        event.target.reset();
        loadFees();
        loadFinanceStats();
      } else {
        showNotification(response.message, 'error');
      }
    }

    async function handleAddDonation(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData);
      
      const response = await callAPI('addDonation', data);
      
      if (response.success) {
        showNotification('ææ¬¾è¨˜éŒ„æ–°å¢æˆåŠŸï¼', 'success');
        closeModal('addDonationModal');
        event.target.reset();
        loadDonations();
        loadFinanceStats();
      } else {
        showNotification(response.message, 'error');
      }
    }

    async function handleAddExpense(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData);
      
      const response = await callAPI('addExpense', data);
      
      if (response.success) {
        showNotification('æ”¯å‡ºè¨˜éŒ„æ–°å¢æˆåŠŸï¼', 'success');
        closeModal('addExpenseModal');
        event.target.reset();
        loadExpenses();
      } else {
        showNotification(response.message, 'error');
      }
    }

    // å ±è¡¨çµ±è¨ˆ
    function showReportTab(tabName, event) {
      document.querySelectorAll('#reportsPage .tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('#reportsPage .tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');
    }

    async function loadIncomeReport() {
      const startDate = document.getElementById('incomeStartDate').value;
      const endDate = document.getElementById('incomeEndDate').value;
      
      if (!startDate || !endDate) {
        showNotification('è«‹é¸æ“‡æ—¥æœŸç¯„åœ', 'error');
        return;
      }
      
      const response = await callAPI('getFinanceReport', { startDate, endDate });
      
      if (response.success) {
        const data = response.data;
        document.getElementById('incomeReportContent').innerHTML = `
          <div class="card">
            <h3 style="margin-bottom: 1rem;">æ”¶æ”¯æ‘˜è¦</h3>
            <div class="stats-grid">
              <div class="stat-card green">
                <div class="stat-number">NT$ ${data.totalIncome.toLocaleString()}</div>
                <div class="stat-label">ç¸½æ”¶å…¥</div>
              </div>
              <div class="stat-card red">
                <div class="stat-number">NT$ ${data.totalExpenses.toLocaleString()}</div>
                <div class="stat-label">ç¸½æ”¯å‡º</div>
              </div>
              <div class="stat-card orange">
                <div class="stat-number">NT$ ${data.balance.toLocaleString()}</div>
                <div class="stat-label">çµé¤˜</div>
              </div>
            </div>
            <div style="margin-top: 1rem;">
              <p><strong>æœƒè²»æ”¶å…¥ï¼š</strong>NT$ ${data.totalFees.toLocaleString()}</p>
              <p><strong>ææ¬¾æ”¶å…¥ï¼š</strong>NT$ ${data.totalDonations.toLocaleString()}</p>
            </div>
          </div>
        `;
      }
    }

    async function loadCashbookReport() {
      const startDate = document.getElementById('cashbookStartDate').value;
      const endDate = document.getElementById('cashbookEndDate').value;
      
      if (!startDate || !endDate) {
        showNotification('è«‹é¸æ“‡æ—¥æœŸç¯„åœ', 'error');
        return;
      }
      
      const response = await callAPI('getCashbook', { startDate, endDate });
      
      if (response.success) {
        const transactions = response.data;
        if (transactions.length > 0) {
          document.getElementById('cashbookReportContent').innerHTML = `
            <div class="card">
              <h3 style="margin-bottom: 1rem;">ç¾é‡‘å‡ºç´æ˜ç´°</h3>
              ${transactions.map(t => `
                <div class="list-item">
                  <div class="list-item-content">
                    <div class="list-item-title">${t.description}</div>
                    <div class="list-item-meta">
                      <span>ğŸ“… ${new Date(t.date).toLocaleDateString('zh-TW')}</span>
                      <span>${t.category}</span>
                      ${t.income > 0 ? `<span style="color: var(--secondary);">+NT$ ${t.income.toLocaleString()}</span>` : ''}
                      ${t.expense > 0 ? `<span style="color: var(--danger);">-NT$ ${t.expense.toLocaleString()}</span>` : ''}
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-weight: bold;">NT$ ${t.balance.toLocaleString()}</div>
                    <small style="color: var(--light);">é¤˜é¡</small>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          document.getElementById('cashbookReportContent').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><p>æ­¤æœŸé–“ç„¡äº¤æ˜“è¨˜éŒ„</p></div>';
        }
      }
    }

    async function loadBalanceReport() {
      const balanceDate = document.getElementById('balanceDate').value;
      
      if (!balanceDate) {
        showNotification('è«‹é¸æ“‡åŸºæº–æ—¥æœŸ', 'error');
        return;
      }
      
      const response = await callAPI('getBalanceSheet', { balanceDate });
      
      if (response.success) {
        const data = response.data;
        document.getElementById('balanceReportContent').innerHTML = `
          <div class="card">
            <h3 style="margin-bottom: 1rem;">è³‡ç”¢è² å‚µè¡¨</h3>
            <p style="margin-bottom: 1rem;"><strong>åŸºæº–æ—¥æœŸï¼š</strong>${new Date(data.balanceDate).toLocaleDateString('zh-TW')}</p>
            
            <div style="margin-bottom: 2rem;">
              <h4 style="color: var(--primary); margin-bottom: 0.5rem;">è³‡ç”¢</h4>
              <p><strong>ç¾é‡‘ï¼š</strong>NT$ ${data.assets.cash.toLocaleString()}</p>
              <p><strong>è³‡ç”¢ç¸½è¨ˆï¼š</strong>NT$ ${data.assets.total.toLocaleString()}</p>
            </div>
            <div style="margin-bottom: 2rem;">
              <h4 style="color: var(--danger); margin-bottom: 0.5rem;">è² å‚µ</h4>
              <p><strong>è² å‚µç¸½è¨ˆï¼š</strong>NT$ ${data.liabilities.total.toLocaleString()}</p>
            </div>
            
            <div style="padding-top: 1rem; border-top: 2px solid var(--bg);">
              <h4 style="color: var(--secondary); margin-bottom: 0.5rem;">æ·¨å€¼</h4>
              <p style="font-size: 1.2rem;"><strong>æ·¨å€¼ç¸½è¨ˆï¼š</strong>NT$ ${data.equity.total.toLocaleString()}</p>
            </div>
          </div>
        `;
      }
    }

    // æ”¶æ“šç®¡ç†
    async function loadReceipts() {
      const container = document.getElementById('receiptsList');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      const response = await callAPI('getReceipts');
      
      if (response.success && response.data.length > 0) {
        container.innerHTML = response.data.map(receipt => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="list-item-title">${receipt.æ”¶æ“šç·¨è™Ÿ} - ${receipt.æ”¶æ“šæŠ¬é ­}</div>
              <div class="list-item-meta">
                <span>ğŸ’° NT$ ${Number(receipt.é‡‘é¡).toLocaleString()}</span>
                <span>ğŸ“… ${new Date(receipt.é–‹ç«‹æ—¥æœŸ).toLocaleDateString('zh-TW')}</span>
                <span class="badge badge-primary">${receipt.é¡å‹}</span>
              </div>
            </div>
          </div>
        `).join('');
      } else {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“„</div><p>å°šç„¡æ”¶æ“šè¨˜éŒ„</p></div>';
      }
    }

    async function handleGenerateReceipt(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData);
      
      const response = await callAPI('generateReceipt', data);
      
      if (response.success) {
        showNotification('æ”¶æ“šé–‹ç«‹æˆåŠŸï¼', 'success');
        closeModal('generateReceiptModal');
        event.target.reset();
        loadReceipts();
        
        if (response.data.pdfUrl) {
          window.open(response.data.pdfUrl, '_blank');
        }
      } else {
        showNotification(response.message, 'error');
      }
    }

    // æ†‘è­‰ç®¡ç†
    async function loadVouchers() {
      const container = document.getElementById('vouchersList');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      const response = await callAPI('getVouchers');
      
      if (response.success && response.data.length > 0) {
        container.innerHTML = response.data.map(voucher => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="list-item-title">${voucher.æ†‘è­‰ç·¨è™Ÿ} - ${voucher.æ†‘è­‰é¡å‹}</div>
              <div class="list-item-meta">
                <span>ğŸ“… ${new Date(voucher.æ†‘è­‰æ—¥æœŸ).toLocaleDateString('zh-TW')}</span>
                <span>ğŸ“‹ ${voucher.æ”¯å‡ºç·¨è™Ÿ}</span>
              </div>
              <small style="color: var(--light);">${voucher.ç”¨é€”èªªæ˜}</small>
            </div>
            <span class="badge badge-success">${voucher.ç‹€æ…‹}</span>
          </div>
        `).join('');
      } else {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><p>å°šç„¡æ†‘è­‰è¨˜éŒ„</p></div>';
      }
    }

    async function handleGenerateVoucher(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData);
      
      const response = await callAPI('generateVoucher', data);
      
      if (response.success) {
        showNotification('æ†‘è­‰é–‹ç«‹æˆåŠŸï¼', 'success');
        closeModal('generateVoucherModal');
        event.target.reset();
        loadVouchers();
      } else {
        showNotification(response.message, 'error');
      }
    }

    // è³‡æ–™åŒ¯å‡º
    async function exportAllData() {
      if (!confirm('ç¢ºå®šè¦åŒ¯å‡ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) return;
      
      showNotification('æ­£åœ¨åŒ¯å‡ºè³‡æ–™...', 'info');
      
      const sheets = ['æœƒå“¡è³‡æ–™', 'æœƒè²»è¨˜éŒ„', 'ææ¬¾è¨˜éŒ„', 'æ”¯å‡ºè¨˜éŒ„', 'æ´»å‹•è¨˜éŒ„'];
      
      for (const sheetName of sheets) {
        const response = await callAPI('exportData', { sheetName });
        
        if (response.success) {
          console.log(`${sheetName} åŒ¯å‡ºæˆåŠŸ:`, response.data.fileUrl);
        }
      }
      
      showNotification('è³‡æ–™åŒ¯å‡ºå®Œæˆï¼', 'success');
    }

    // ç³»çµ±å‚™ä»½
    async function backupSystem() {
      if (!confirm('ç¢ºå®šè¦é€²è¡Œç³»çµ±å‚™ä»½å—ï¼Ÿ')) return;
      
      showNotification('æ­£åœ¨å‚™ä»½ç³»çµ±...', 'info');
      
      const response = await callAPI('backup');
      
      if (response.success) {
        showNotification('ç³»çµ±å‚™ä»½å®Œæˆï¼', 'success');
        window.open(response.data.backupUrl, '_blank');
      } else {
        showNotification('å‚™ä»½å¤±æ•—', 'error');
      }
    }
  </script>
</body>
</html>

      
