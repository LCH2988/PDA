<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣帕金森病友權益促進會 - 會計出納系統</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: "Microsoft JhengHei", "微軟正黑體", Arial, sans-serif;
          line-height: 1.6;
          color: #333;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 20px;
      }

      .header {
          background: rgba(255, 255, 255, 0.95);
          padding: 25px;
          border-radius: 15px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          margin-bottom: 30px;
          text-align: center;
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .header h1 {
          color: #1a472a;
          font-size: 2.5em;
          margin-bottom: 10px;
          text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header .subtitle {
          color: #666;
          font-size: 1.2em;
          font-style: italic;
      }

      .main-content {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 30px;
          margin-bottom: 30px;
      }

      .card {
          background: rgba(255, 255, 255, 0.95);
          padding: 30px;
          border-radius: 15px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          transition: all 0.3s ease;
      }

      .card:hover {
          transform: translateY(-5px);
          box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      }

      .card h2 {
          color: #1a472a;
          margin-bottom: 20px;
          font-size: 1.8em;
          border-bottom: 3px solid #4caf50;
          padding-bottom: 10px;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: bold;
          color: #555;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
          width: 100%;
          padding: 12px;
          border: 2px solid #ddd;
          border-radius: 8px;
          font-size: 16px;
          transition: all 0.3s ease;
          background: rgba(255, 255, 255, 0.9);
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          outline: none;
          border-color: #4caf50;
          box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
          transform: scale(1.02);
      }

      .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
      }

      .checkbox-group {
          display: flex;
          flex-wrap: wrap;
          gap: 15px;
          margin-top: 10px;
      }

      .checkbox-item {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 10px 15px;
          background: rgba(76, 175, 80, 0.1);
          border-radius: 25px;
          border: 2px solid transparent;
          transition: all 0.3s ease;
          cursor: pointer;
      }

      .checkbox-item:hover {
          background: rgba(76, 175, 80, 0.2);
          border-color: #4caf50;
      }

      .checkbox-item input[type="checkbox"] {
          width: auto;
          margin: 0;
      }

      .btn {
          background: linear-gradient(135deg, #4caf50, #45a049);
          color: white;
          padding: 15px 30px;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          font-size: 16px;
          font-weight: bold;
          transition: all 0.3s ease;
          text-transform: uppercase;
          letter-spacing: 1px;
          box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      .btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      }

      .btn:active {
          transform: translateY(0);
      }

      .btn-secondary {
          background: linear-gradient(135deg, #2196f3, #1976d2);
          box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
      }

      .btn-secondary:hover {
          box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
      }

      .btn-danger {
          background: linear-gradient(135deg, #f44336, #d32f2f);
          box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
      }

      .btn-danger:hover {
          box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
      }

      .btn-group {
          display: flex;
          gap: 15px;
          justify-content: center;
          margin-top: 25px;
      }

      .alert {
          padding: 15px 20px;
          border-radius: 10px;
          margin: 20px 0;
          font-weight: bold;
          display: none;
          animation: slideIn 0.3s ease;
      }

      .alert-success {
          background: linear-gradient(135deg, #d4edda, #c3e6cb);
          color: #155724;
          border: 2px solid #28a745;
      }

      .alert-error {
          background: linear-gradient(135deg, #f8d7da, #f5c6cb);
          color: #721c24;
          border: 2px solid #dc3545;
      }

      .alert-info {
          background: linear-gradient(135deg, #d1ecf1, #bee5eb);
          color: #0c5460;
          border: 2px solid #17a2b8;
      }

      @keyframes slideIn {
          from {
              opacity: 0;
              transform: translateY(-20px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }

      .loading {
          display: none;
          text-align: center;
          padding: 20px;
      }

      .spinner {
          border: 4px solid #f3f3f3;
          border-top: 4px solid #4caf50;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
          margin: 0 auto 15px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .tabs {
          display: flex;
          background: rgba(255, 255, 255, 0.9);
          border-radius: 10px;
          margin-bottom: 20px;
          overflow: hidden;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .tab-button {
          flex: 1;
          padding: 15px 20px;
          background: none;
          border: none;
          cursor: pointer;
          font-size: 16px;
          font-weight: bold;
          color: #666;
          transition: all 0.3s ease;
          position: relative;
      }

      .tab-button.active {
          color: #4caf50;
          background: rgba(76, 175, 80, 0.1);
      }

      .tab-button.active::after {
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          height: 3px;
          background: #4caf50;
      }

      .tab-content {
          display: none;
      }

      .tab-content.active {
          display: block;
          animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
      }

      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin: 20px 0;
      }

      .stat-card {
          background: linear-gradient(135deg, #4caf50, #45a049);
          color: white;
          padding: 20px;
          border-radius: 15px;
          text-align: center;
          box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
          transition: transform 0.3s ease;
      }

      .stat-card:hover {
          transform: translateY(-5px);
      }

      .stat-card h3 {
          font-size: 2em;
          margin-bottom: 5px;
      }

      .stat-card p {
          font-size: 0.9em;
          opacity: 0.9;
      }

      .search-section {
          background: rgba(255, 255, 255, 0.95);
          padding: 25px;
          border-radius: 15px;
          margin-bottom: 20px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .search-form {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
          align-items: end;
      }

      .results-table {
          width: 100%;
          border-collapse: collapse;
          background: white;
          border-radius: 10px;
          overflow: hidden;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .results-table th,
      .results-table td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #ddd;
      }

      .results-table th {
          background: linear-gradient(135deg, #4caf50, #45a049);
          color: white;
          font-weight: bold;
      }

      .results-table tr:hover {
          background: rgba(76, 175, 80, 0.1);
      }

      .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          backdrop-filter: blur(5px);
      }

      .modal-content {
          background: white;
          margin: 5% auto;
          padding: 30px;
          border-radius: 15px;
          width: 80%;
          max-width: 600px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          animation: modalSlideIn 0.3s ease;
      }

      @keyframes modalSlideIn {
          from {
              opacity: 0;
              transform: translateY(-50px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }

      .close {
          color: #aaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
          transition: color 0.3s ease;
      }

      .close:hover {
          color: #000;
      }

      .file-upload {
          border: 2px dashed #4caf50;
          border-radius: 10px;
          padding: 30px;
          text-align: center;
          margin: 20px 0;
          transition: all 0.3s ease;
          cursor: pointer;
      }

      .file-upload:hover {
          background: rgba(76, 175, 80, 0.1);
          border-color: #45a049;
      }

      .file-upload.dragover {
          background: rgba(76, 175, 80, 0.2);
          border-color: #2e7d32;
      }

      @media (max-width: 768px) {
          .main-content {
              grid-template-columns: 1fr;
          }

          .form-row {
              grid-template-columns: 1fr;
          }

          .btn-group {
              flex-direction: column;
          }

          .search-form {
              grid-template-columns: 1fr;
          }

          .modal-content {
              width: 95%;
              margin: 10% auto;
          }
      }

      .progress-bar {
          width: 100%;
          height: 20px;
          background: #f0f0f0;
          border-radius: 10px;
          overflow: hidden;
          margin: 10px 0;
      }

      .progress-fill {
          height: 100%;
          background: linear-gradient(135deg, #4caf50, #45a049);
          width: 0%;
          transition: width 0.3s ease;
      }

      .receipt-preview {
          border: 2px solid #4caf50;
          border-radius: 10px;
          padding: 20px;
          margin: 20px 0;
          background: rgba(76, 175, 80, 0.05);
      }

      .receipt-preview h4 {
          color: #1a472a;
          margin-bottom: 15px;
      }

      .receipt-info {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
      }

      .receipt-info div {
          padding: 5px 0;
          border-bottom: 1px solid #eee;
      }

      .receipt-info strong {
          color: #4caf50;
      }
  </style>
</head>
<body>
  <div class="container">
      <!-- 系統標題 -->
      <div class="header">
          <h1>台灣帕金森病友權益促進會</h1>
          <p class="subtitle">Taiwan Parkinson Disease Association</p>
          <p class="subtitle">會計出納管理系統 v4.0</p>
      </div>

      <!-- 主要內容區域 -->
      <div class="tabs">
          <button class="tab-button active" onclick="showTab('transaction')">交易記錄</button>
          <button class="tab-button" onclick="showTab('search')">查詢統計</button>
          <button class="tab-button" onclick="showTab('import')">批次匯入</button>
          <button class="tab-button" onclick="showTab('settings')">系統設定</button>
      </div>

      <!-- 交易記錄頁籤 -->
      <div id="transaction" class="tab-content active">
          <div class="main-content">
              <!-- 交易表單 -->
              <div class="card">
                  <h2>📝 新增交易記錄</h2>
                  <form id="transactionForm">
                      <div class="form-row">
                          <div class="form-group">
                              <label for="date">日期 *</label>
                              <input type="date" id="date" name="date" required>
                          </div>
                          <div class="form-group">
                              <label for="name">姓名 *</label>
                              <input type="text" id="name" name="name" required placeholder="請輸入姓名">
                          </div>
                      </div>

                      <div class="form-row">
                          <div class="form-group">
                              <label for="type">交易類型 *</label>
                              <select id="type" name="type" required onchange="updateFormFields()">
                                  <option value="">請選擇類型</option>
                                  <option value="收入">收入</option>
                                  <option value="支出">支出</option>
                              </select>
                          </div>
                          <div class="form-group">
                              <label for="category">類別</label>
                              <select id="category" name="category">
                                  <option value="">請選擇類別</option>
                              </select>
                          </div>
                      </div>

                      <div class="form-row">
                          <div class="form-group">
                              <label for="amount">金額 *</label>
                              <input type="number" id="amount" name="amount" required min="0" step="1" placeholder="請輸入金額">
                          </div>
                          <div class="form-group">
                              <label for="account">交易帳戶</label>
                              <select id="account" name="account">
                                  <option value="">請選擇帳戶</option>
                                  <option value="現金">現金</option>
                                  <option value="銀行轉帳">銀行轉帳</option>
                                  <option value="支票">支票</option>
                                  <option value="信用卡">信用卡</option>
                              </select>
                          </div>
                      </div>

                      <div class="form-group">
                          <label for="description">說明</label>
                          <textarea id="description" name="description" rows="3" placeholder="請輸入詳細說明"></textarea>
                      </div>

                      <!-- 聯絡資訊 -->
                      <div id="contactInfo" style="display: none;">
                          <h3 style="color: #1a472a; margin: 20px 0 15px 0;">📞 聯絡資訊</h3>
                          <div class="form-row">
                              <div class="form-group">
                                  <label for="identity">身分</label>
                                  <select id="identity" name="identity">
                                      <option value="">請選擇身分</option>
                                      <option value="病友">病友</option>
                                      <option value="家屬">家屬</option>
                                      <option value="志工">志工</option>
                                      <option value="會員">會員</option>
                                      <option value="一般民眾">一般民眾</option>
                                      <option value="企業">企業</option>
                                  </select>
                              </div>
                              <div class="form-group">
                                  <label for="phone">聯絡電話</label>
                                  <input type="tel" id="phone" name="phone" placeholder="請輸入聯絡電話">
                              </div>
                          </div>
                          <div class="form-group">
                              <label for="email">電子郵件</label>
                              <input type="email" id="email" name="email" placeholder="請輸入電子郵件">
                          </div>
                      </div>

                      <!-- 收據選項 -->
                      <div id="receiptOptions" style="display: none;">
                          <h3 style="color: #1a472a; margin: 20px 0 15px 0;">🧾 收據選項</h3>
                          <div class="checkbox-group">
                              <div class="checkbox-item">
                                  <input type="checkbox" id="generateReceipt" name="generateReceipt">
                                  <label for="generateReceipt">開立電子收據</label>
                              </div>
                              <div class="checkbox-item">
                                  <input type="checkbox" id="autoSendEmail" name="autoSendEmail">
                                  <label for="autoSendEmail">自動寄送收據</label>
                              </div>
                          </div>
                      </div>

                      <!-- 支出憑證選項 -->
                      <div id="voucherOptions" style="display: none;">
                          <h3 style="color: #1a472a; margin: 20px 0 15px 0;">📋 支出憑證</h3>
                          <div class="checkbox-group">
                              <div class="checkbox-item">
                                  <input type="checkbox" id="generateVoucher" name="generateVoucher">
                                  <label for="generateVoucher">開立支出憑證</label>
                              </div>
                          </div>
                          <div class="form-row" id="voucherDetails" style="display: none; margin-top: 15px;">
                              <div class="form-group">
                                  <label for="department">部門</label>
                                  <select id="department" name="department">
                                      <option value="會務部">會務部</option>
                                      <option value="財務部">財務部</option>
                                      <option value="活動部">活動部</option>
                                      <option value="宣導部">宣導部</option>
                                  </select>
                              </div>
                              <div class="form-group">
                                  <label for="priority">優先級</label>
                                  <select id="priority" name="priority">
                                      <option value="一般">一般</option>
                                      <option value="緊急">緊急</option>
                                      <option value="低">低</option>
                                  </select>
                              </div>
                          </div>
                          <div class="form-group" id="receiptCountGroup" style="display: none;">
                              <label for="receiptCount">收據張數</label>
                              <input type="number" id="receiptCount" name="receiptCount" min="1" value="1">
                          </div>
                      </div>

                      <div class="btn-group">
                          <button type="submit" class="btn">💾 儲存記錄</button>
                          <button type="button" class="btn btn-secondary" onclick="clearForm()">🔄 清除表單</button>
                      </div>
                  </form>
              </div>

              <!-- 統計資訊 -->
              <div class="card">
                  <h2>📊 即時統計</h2>
                  <div class="stats-grid" id="statsGrid">
                      <div class="stat-card">
                          <h3 id="totalTransactions">0</h3>
                          <p>總交易筆數</p>
                      </div>
                      <div class="stat-card" style="background: linear-gradient(135deg, #2196f3, #1976d2);">
                          <h3 id="totalIncome">$0</h3>
                          <p>總收入</p>
                      </div>
                      <div class="stat-card" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                          <h3 id="totalExpense">$0</h3>
                          <p>總支出</p>
                      </div>
                      <div class="stat-card" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);">
                          <h3 id="netIncome">$0</h3>
                          <p>淨收入</p>
                      </div>
                  </div>
                  
                  <div class="btn-group">
                      <button class="btn btn-secondary" onclick="refreshStats()">🔄 更新統計</button>
                      <button class="btn btn-secondary" onclick="generateReport()">📈 生成報表</button>
                  </div>
              </div>
          </div>
      </div>

      <!-- 查詢統計頁籤 -->
      <div id="search" class="tab-content">
          <div class="search-section">
              <h2>🔍 交易查詢</h2>
              <form id="searchForm" class="search-form">
                  <div class="form-group">
                      <label for="searchStartDate">開始日期</label>
                      <input type="date" id="searchStartDate" name="startDate">
                  </div>
                  <div class="form-group">
                      <label for="searchEndDate">結束日期</label>
                      <input type="date" id="searchEndDate" name="endDate">
                  </div>
                  <div class="form-group">
                      <label for="searchName">姓名</label>
                      <input type="text" id="searchName" name="name" placeholder="請輸入姓名">
                  </div>
                  <div class="form-group">
                      <label for="searchType">類型</label>
                      <select id="searchType" name="type">
                          <option value="">全部</option>
                          <option value="收入">收入</option>
                          <option value="支出">支出</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="searchCategory">類別</label>
                      <input type="text" id="searchCategory" name="category" placeholder="請輸入類別">
                  </div>
                  <div class="form-group">
                      <button type="submit" class="btn">🔍 搜尋</button>
                  </div>
              </form>
          </div>

          <div class="card">
              <h2>📋 搜尋結果</h2>
              <div id="searchResults">
                  <p style="text-align: center; color: #666; padding: 40px;">請輸入搜尋條件後點擊搜尋</p>
              </div>
          </div>
      </div>

      <!-- 批次匯入頁籤 -->
      <div id="import" class="tab-content">
          <div class="card">
              <h2>📥 批次匯入</h2>
              <div class="file-upload" id="fileUpload" onclick="document.getElementById('csvFile').click()">
                  <p>📁 點擊選擇CSV檔案或拖拽檔案到此處</p>
                  <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                      支援格式：CSV檔案<br>
                      必要欄位：日期, 姓名, 類型, 金額
                  </p>
                  <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileSelect(this)">
              </div>
              
              <div id="importProgress" style="display: none;">
                  <h3>匯入進度</h3>
                  <div class="progress-bar">
                      <div class="progress-fill" id="progressFill"></div>
                  </div>
                  <p id="progressText">準備中...</p>
              </div>

              <div class="btn-group">
                  <button class="btn" onclick="startImport()" id="importBtn" disabled>📤 開始匯入</button>
                  <button class="btn btn-secondary" onclick="downloadTemplate()">📋 下載範本</button>
              </div>
          </div>

          <div class="card">
              <h2>📝 匯入記錄</h2>
              <div id="importLog">
                  <p style="text-align: center; color: #666; padding: 40px;">尚無匯入記錄</p>
              </div>
          </div>
      </div>

      <!-- 系統設定頁籤 -->
      <div id="settings" class="tab-content">
          <div class="main-content">
              <div class="card">
                  <h2>⚙️ 系統設定</h2>
                  <div class="form-group">
                      <label>組織資訊</label>
                      <button class="btn btn-secondary" onclick="editOrganizationInfo()">✏️ 編輯組織資訊</button>
                  </div>
                  <div class="form-group">
                      <label>郵件設定</label>
                      <button class="btn btn-secondary" onclick="editEmailSettings()">📧 設定郵件</button>
                  </div>
                  <div class="form-group">
                      <label>系統維護</label>
                      <div class="btn-group">
                          <button class="btn btn-secondary" onclick="createBackup()">💾 建立備份</button>
                          <button class="btn btn-secondary" onclick="systemHealthCheck()">🔧 系統檢查</button>
                          <button class="btn btn-danger" onclick="resetSystem()">🔄 重置系統</button>
                      </div>
                  </div>
              </div>

              <div class="card">
                  <h2>📊 系統狀態</h2>
                  <div id="systemStatus">
                      <div class="stats-grid">
                          <div class="stat-card">
                              <h3 id="systemUptime">載入中...</h3>
                              <p>系統運行時間</p>
                          </div>
                          <div class="stat-card" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                              <h3 id="dataSize">載入中...</h3>
                              <p>資料量</p>
                          </div>
                          <div class="stat-card" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);">
                              <h3 id="lastBackup">載入中...</h3>
                              <p>最後備份</p>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- 通知區域 -->
      <div id="alertContainer"></div>

      <!-- 載入動畫 -->
      <div id="loading" class="loading">
          <div class="spinner"></div>
          <p>處理中，請稍候...</p>
      </div>

      <!-- 模態視窗 -->
      <div id="modal" class="modal">
          <div class="modal-content">
              <span class="close" onclick="closeModal()">&times;</span>
              <div id="modalContent">
                  <!-- 動態內容 -->
              </div>
          </div>
      </div>

      <!-- 收據預覽模態視窗 -->
      <div id="receiptModal" class="modal">
          <div class="modal-content">
              <span class="close" onclick="closeReceiptModal()">&times;</span>
              <h2>🧾 收據預覽</h2>
              <div id="receiptPreview" class="receipt-preview">
                  <!-- 收據內容 -->
              </div>
              <div class="btn-group">
                  <button class="btn" onclick="downloadReceipt()">📥 下載收據</button>
                  <button class="btn btn-secondary" onclick="sendReceiptEmail()">📧 寄送郵件</button>
                  <button class="btn btn-secondary" onclick="printReceipt()">🖨️ 列印收據</button>
              </div>
          </div>
      </div>
  </div>

  <script>
      // 全域變數
      let currentReceiptData = null;
      let csvData = null;
      let systemStartTime = new Date();

      // Google Apps Script 網址 (請替換為實際的部署網址)
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby2xtVyVzS8T0DJq0njO1Nm9ORAWwnD6CcchijHTMD997uuFFnSUu9Hq28CMna4ENdh/exec';

      // 初始化
      document.addEventListener('DOMContentLoaded', function() {
          initializeForm();
          loadStatistics();
          setupEventListeners();
          updateSystemStatus();
      });

      // 設定事件監聽器
      function setupEventListeners() {
          // 表單提交
          document.getElementById('transactionForm').addEventListener('submit', handleFormSubmit);
          document.getElementById('searchForm').addEventListener('submit', handleSearch);

          // 檔案拖拽
          const fileUpload = document.getElementById('fileUpload');
          fileUpload.addEventListener('dragover', handleDragOver);
          fileUpload.addEventListener('drop', handleDrop);
          fileUpload.addEventListener('dragleave', handleDragLeave);

          // 支出憑證選項
          document.getElementById('generateVoucher').addEventListener('change', function() {
              const voucherDetails = document.getElementById('voucherDetails');
              const receiptCountGroup = document.getElementById('receiptCountGroup');
              if (this.checked) {
                  voucherDetails.style.display = 'block';
                  receiptCountGroup.style.display = 'block';
              } else {
                  voucherDetails.style.display = 'none';
                  receiptCountGroup.style.display = 'none';
              }
          });

          // 自動寄送郵件選項
          document.getElementById('autoSendEmail').addEventListener('change', function() {
              if (this.checked && !document.getElementById('email').value) {
                  showAlert('請先填寫電子郵件地址', 'error');
                  this.checked = false;
              }
          });

          // 設定今天日期為預設值
          document.getElementById('date').value = new Date().toISOString().split('T')[0];
      }

      // 初始化表單
      function initializeForm() {
          updateFormFields();
      }

      // 更新表單欄位
      function updateFormFields() {
          const type = document.getElementById('type').value;
          const categorySelect = document.getElementById('category');
          const contactInfo = document.getElementById('contactInfo');
          const receiptOptions = document.getElementById('receiptOptions');
          const voucherOptions = document.getElementById('voucherOptions');

          // 清空類別選項
          categorySelect.innerHTML = '<option value="">請選擇類別</option>';

          if (type === '收入') {
              // 收入類別
              const incomeCategories = [
                  '一般捐款', '定期捐款', '指定捐款', '活動收入', 
                  '會費收入', '政府補助', '企業贊助', '義賣收入',
                  '利息收入', '其他收入'
              ];
              incomeCategories.forEach(category => {
                  const option = document.createElement('option');
                  option.value = category;
                  option.textContent = category;
                  categorySelect.appendChild(option);
              });

              contactInfo.style.display = 'block';
              receiptOptions.style.display = 'block';
              voucherOptions.style.display = 'none';

          } else if (type === '支出') {
              // 支出類別
              const expenseCategories = [
                  '辦公費用', '活動費用', '交通費用', '餐飲費用',
                  '宣傳費用', '設備採購', '場地租金', '人事費用',
                  '水電費用', '通訊費用', '其他支出'
              ];
              expenseCategories.forEach(category => {
                  const option = document.createElement('option');
                  option.value = category;
                  option.textContent = category;
                  categorySelect.appendChild(option);
              });

              contactInfo.style.display = 'block';
              receiptOptions.style.display = 'none';
              voucherOptions.style.display = 'block';

          } else {
              contactInfo.style.display = 'none';
              receiptOptions.style.display = 'none';
              voucherOptions.style.display = 'none';
          }
      }

      // 處理表單提交
      async function handleFormSubmit(e) {
          e.preventDefault();
          
          if (!validateForm()) {
              return;
          }

          showLoading(true);

          try {
              const formData = new FormData(e.target);
              const data = Object.fromEntries(formData.entries());
              
              // 處理複選框
              data.generateReceipt = document.getElementById('generateReceipt').checked ? 'true' : 'false';
              data.autoSendEmail = document.getElementById('autoSendEmail').checked ? 'true' : 'false';
              data.generateVoucher = document.getElementById('generateVoucher').checked ? 'true' : 'false';

              const response = await fetch(SCRIPT_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: new URLSearchParams(data)
              });

              const result = await response.json();

              if (result.success) {
                  showAlert('交易記錄已成功儲存！', 'success');
                  
                  // 如果有生成收據，顯示預覽
                  if (result.receiptNumber) {
                      currentReceiptData = result;
                      showReceiptPreview(result);
                  }

                  // 清除表單並重新載入統計
                  clearForm();
                  loadStatistics();
              } else {
                  showAlert('儲存失敗：' + result.error, 'error');
              }

          } catch (error) {
              console.error('提交錯誤:', error);
              showAlert('系統錯誤，請稍後再試', 'error');
          } finally {
              showLoading(false);
          }
      }

      // 表單驗證
      function validateForm() {
          const requiredFields = ['date', 'name', 'type', 'amount'];
          
          for (const field of requiredFields) {
              const element = document.getElementById(field);
              if (!element.value.trim()) {
                  showAlert(`請填寫 ${element.previousElementSibling.textContent}`, 'error');
                  element.focus();
                  return false;
              }
          }

          // 驗證金額
          const amount = parseFloat(document.getElementById('amount').value);
          if (amount <= 0) {
              showAlert('金額必須大於0', 'error');
              document.getElementById('amount').focus();
              return false;
          }

          // 驗證電子郵件格式
          const email = document.getElementById('email').value;
          if (email && !isValidEmail(email)) {
              showAlert('電子郵件格式不正確', 'error');
              document.getElementById('email').focus();
              return false;
          }

          // 如果要自動寄送郵件，必須有電子郵件
          if (document.getElementById('autoSendEmail').checked && !email) {
              showAlert('自動寄送郵件需要填寫電子郵件地址', 'error');
              document.getElementById('email').focus();
              return false;
          }

          return true;
      }

      // 驗證電子郵件格式
      function isValidEmail(email) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailRegex.test(email);
      }

      // 清除表單
      function clearForm() {
          document.getElementById('transactionForm').reset();
          document.getElementById('date').value = new Date().toISOString().split('T')[0];
          updateFormFields();
      }

      // 載入統計資料
      async function loadStatistics() {
          try {
              const response = await fetch(`${SCRIPT_URL}?action=getStatistics`);
              const result = await response.json();

              if (result.success) {
                  updateStatisticsDisplay(result.statistics);
              }
          } catch (error) {
              console.error('載入統計失敗:', error);
          }
      }

      // 更新統計顯示
      function updateStatisticsDisplay(stats) {
          document.getElementById('totalTransactions').textContent = stats.totalTransactions || 0;
          document.getElementById('totalIncome').textContent = '$' + (stats.totalIncome || 0).toLocaleString();
          document.getElementById('totalExpense').textContent = '$' + (stats.totalExpense || 0).toLocaleString();
          document.getElementById('netIncome').textContent = '$' + (stats.netIncome || 0).toLocaleString();
      }

      // 重新整理統計
      function refreshStats() {
          loadStatistics();
          showAlert('統計資料已更新', 'success');
      }

      // 生成報表
      async function generateReport() {
          showLoading(true);
          
          try {
              const currentDate = new Date();
              const year = currentDate.getFullYear();
              const month = currentDate.getMonth() + 1;

              const response = await fetch(`${SCRIPT_URL}?action=generateReport&year=${year}&month=${month}`);
              const result = await response.json();

              if (result.success) {
                  showReportModal(result.report);
              } else {
                  showAlert('生成報表失敗：' + result.error, 'error');
              }
          } catch (error) {
              console.error('生成報表錯誤:', error);
              showAlert('生成報表失敗', 'error');
          } finally {
              showLoading(false);
          }
      }

      // 顯示報表模態視窗
      function showReportModal(report) {
          const modalContent = document.getElementById('modalContent');
          modalContent.innerHTML = `
              <h2>📊 ${report.period} 月報表</h2>
              <div class="stats-grid">
                  <div class="stat-card">
                      <h3>$${report.summary.totalIncome.toLocaleString()}</h3>
                      <p>總收入</p>
                  </div>
                  <div class="stat-card" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                      <h3>$${report.summary.totalExpense.toLocaleString()}</h3>
                      <p>總支出</p>
                  </div>
                  <div class="stat-card" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);">
                      <h3>$${report.summary.netIncome.toLocaleString()}</h3>
                      <p>淨收入</p>
                  </div>
                  <div class="stat-card" style="background: linear-gradient(135deg, #2196f3, #1976d2);">
                      <h3>${report.summary.transactionCount}</h3>
                      <p>交易筆數</p>
                  </div>
              </div>
              <div style="margin-top: 20px;">
                  <h3>類別統計</h3>
                  <div id="categoryStats"></div>
              </div>
              <div class="btn-group">
                  <button class="btn" onclick="exportReport()">📥 匯出報表</button>
                  <button class="btn btn-secondary" onclick="closeModal()">關閉</button>
              </div>
          `;

          // 顯示類別統計
          const categoryStatsDiv = document.getElementById('categoryStats');
          let categoryHtml = '<table class="results-table"><tr><th>類別</th><th>收入</th><th>支出</th><th>筆數</th></tr>';
          
          for (const [category, stats] of Object.entries(report.categoryStats)) {
              categoryHtml += `
                  <tr>
                      <td>${category}</td>
                      <td>$${stats.income.toLocaleString()}</td>
                      <td>$${stats.expense.toLocaleString()}</td>
                      <td>${stats.count}</td>
                  </tr>
              `;
          }
          categoryHtml += '</table>';
          categoryStatsDiv.innerHTML = categoryHtml;

          document.getElementById('modal').style.display = 'block';
      }

      // 處理搜尋
      async function handleSearch(e) {
          e.preventDefault();
          showLoading(true);

          try {
              const formData = new FormData(e.target);
              const searchParams = Object.fromEntries(formData.entries());

              const queryString = new URLSearchParams({
                  action: 'searchTransactions',
                  ...searchParams
              }).toString();

              const response = await fetch(`${SCRIPT_URL}?${queryString}`);
              const result = await response.json();

              if (result.success) {
                  displaySearchResults(result.results);
              } else {
                  showAlert('搜尋失敗：' + result.error, 'error');
              }
          } catch (error) {
              console.error('搜尋錯誤:', error);
              showAlert('搜尋失敗', 'error');
          } finally {
              showLoading(false);
          }
      }

      // 顯示搜尋結果
      function displaySearchResults(results) {
          const resultsDiv = document.getElementById('searchResults');
          
          if (results.length === 0) {
              resultsDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">沒有找到符合條件的記錄</p>';
              return;
          }

          let html = `
              <p style="margin-bottom: 15px; color: #4caf50; font-weight: bold;">
                  找到 ${results.length} 筆記錄
              </p>
              <table class="results-table">
                  <tr>
                      <th>日期</th>
                      <th>姓名</th>
                      <th>類型</th>
                      <th>類別</th>
                      <th>金額</th>
                      <th>說明</th>
                      <th>操作</th>
                  </tr>
          `;

          results.forEach(record => {
              const amount = parseFloat(record['金額'] || 0);
              const amountClass = record['類型'] === '收入' ? 'color: #4caf50' : 'color: #f44336';
              
              html += `
                  <tr>
                      <td>${record['日期']}</td>
                      <td>${record['姓名']}</td>
                      <td>${record['類型']}</td>
                      <td>${record['類別'] || '-'}</td>
                      <td style="${amountClass}">$${amount.toLocaleString()}</td>
                      <td>${record['說明'] || '-'}</td>
                      <td>
                          ${record['收據編號'] ? `<button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="viewReceipt('${record['收據編號']}')">查看收據</button>` : '-'}
                      </td>
                  </tr>
              `;
          });

          html += '</table>';
          resultsDiv.innerHTML = html;
      }

      // 檔案處理
      function handleFileSelect(input) {
          const file = input.files[0];
          if (file && file.type === 'text/csv') {
              const reader = new FileReader();
              reader.onload = function(e) {
                  csvData = e.target.result;
                  document.getElementById('importBtn').disabled = false;
                  showAlert('CSV檔案已載入，可以開始匯入', 'success');
              };
              reader.readAsText(file);
          } else {
              showAlert('請選擇CSV檔案', 'error');
          }
      }

      // 拖拽處理
      function handleDragOver(e) {
          e.preventDefault();
          e.currentTarget.classList.add('dragover');
      }

      function handleDragLeave(e) {
          e.currentTarget.classList.remove('dragover');
      }

      function handleDrop(e) {
          e.preventDefault();
          e.currentTarget.classList.remove('dragover');
          
          const files = e.dataTransfer.files;
          if (files.length > 0) {
              const file = files[0];
              if (file.type === 'text/csv') {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                      csvData = e.target.result;
                      document.getElementById('importBtn').disabled = false;
                      showAlert('CSV檔案已載入，可以開始匯入', 'success');
                  };
                  reader.readAsText(file);
              } else {
                  showAlert('請拖拽CSV檔案', 'error');
              }
          }
      }

      // 開始匯入
      async function startImport() {
          if (!csvData) {
              showAlert('請先選擇CSV檔案', 'error');
              return;
          }

          showLoading(true);
          document.getElementById('importProgress').style.display = 'block';

          try {
              const response = await fetch(SCRIPT_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: new URLSearchParams({
                      action: 'batchImport',
                      csvData: csvData
                  })
              });

              const result = await response.json();

              if (result.success) {
                  showAlert(result.message, 'success');
                  updateImportLog(result.results);
                  loadStatistics(); // 重新載入統計
              } else {
                  showAlert('匯入失敗：' + result.error, 'error');
              }

          } catch (error) {
              console.error('匯入錯誤:', error);
              showAlert('匯入失敗', 'error');
          } finally {
              showLoading(false);
              document.getElementById('importProgress').style.display = 'none';
              csvData = null;
              document.getElementById('importBtn').disabled = true;
              document.getElementById('csvFile').value = '';
          }
      }

      // 更新匯入記錄
      function updateImportLog(results) {
          const logDiv = document.getElementById('importLog');
          const timestamp = new Date().toLocaleString('zh-TW');
          
          const logHtml = `
              <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                  <h4>匯入時間：${timestamp}</h4>
                  <p>總筆數：${results.total}</p>
                  <p style="color: #4caf50;">成功：${results.success} 筆</p>
                  <p style="color: #f44336;">失敗：${results.failed} 筆</p>
                  <p>收據：${results.receipts} 張</p>
                  <p>憑證：${results.vouchers} 張</p>
                  ${results.errors.length > 0 ? `<p style="color: #f44336;">錯誤：${results.errors.join(', ')}</p>` : ''}
              </div>
          `;
          
          if (logDiv.innerHTML.includes('尚無匯入記錄')) {
              logDiv.innerHTML = logHtml;
          } else {
              logDiv.innerHTML = logHtml + logDiv.innerHTML;
          }
      }

      // 下載範本
      function downloadTemplate() {
          const csvContent = '日期,姓名,類型,類別,金額,說明,交易帳戶,身分,電話,電子郵件,開立收據,自動寄送\n2024-01-01,張三,收入,一般捐款,1000,測試資料,現金,會員,0912345678,test@example.com,是,否';
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = '批次匯入範本.csv';
          link.click();
      }

      // 頁籤切換
      function showTab(tabName) {
          // 隱藏所有頁籤內容
          document.querySelectorAll('.tab-content').forEach(tab => {
              tab.classList.remove('active');
          });

          // 移除所有按鈕的active類別
          document.querySelectorAll('.tab-button').forEach(btn => {
              btn.classList.remove('active');
          });

          // 顯示選中的頁籤
          document.getElementById(tabName).classList.add('active');
          event.target.classList.add('active');
      }

      // 收據相關功能
      function showReceiptPreview(receiptData) {
          const previewDiv = document.getElementById('receiptPreview');
          previewDiv.innerHTML = `
              <h4>收據資訊</h4>
              <div class="receipt-info">
                  <div><strong>收據編號：</strong>${receiptData.receiptNumber}</div>
                  <div><strong>日期：</strong>${receiptData.date}</div>
                  <div><strong>付款人：</strong>${receiptData.payer}</div>
                  <div><strong>類別：</strong>${receiptData.category}</div>
                  <div><strong>金額：</strong>$${receiptData.amount.toLocaleString()}</div>
                  <div><strong>說明：</strong>${receiptData.description || '-'}</div>
              </div>
          `;
          document.getElementById('receiptModal').style.display = 'block';
      }

      function closeReceiptModal() {
          document.getElementById('receiptModal').style.display = 'none';
      }

      function downloadReceipt() {
          if (currentReceiptData && currentReceiptData.downloadUrl) {
              window.open(currentReceiptData.downloadUrl, '_blank');
          }
      }

      function sendReceiptEmail() {
          const email = prompt('請輸入收件人電子郵件地址：');
          if (email && isValidEmail(email)) {
              // 實作寄送郵件功能
              showAlert('收據已寄送至 ' + email, 'success');
          } else if (email) {
              showAlert('電子郵件格式不正確', 'error');
          }
      }

      function printReceipt() {
          if (currentReceiptData && currentReceiptData.viewUrl) {
              const printWindow = window.open(currentReceiptData.viewUrl, '_blank');
              printWindow.onload = function() {
                  printWindow.print();
              };
          }
      }

      // 查看收據
      async function viewReceipt(receiptNumber) {
          try {
              const response = await fetch(`${SCRIPT_URL}?action=getReceipt&receiptNumber=${receiptNumber}`);
              const result = await response.json();

              if (result.success) {
                  currentReceiptData = result.data;
                  showReceiptPreview(result.data);
              } else {
                  showAlert('無法載入收據：' + result.error, 'error');
              }
          } catch (error) {
              console.error('載入收據錯誤:', error);
              showAlert('載入收據失敗', 'error');
          }
      }

      // 系統設定功能
      function editOrganizationInfo() {
          showAlert('組織資訊編輯功能開發中', 'info');
      }

      function editEmailSettings() {
          showAlert('郵件設定功能開發中', 'info');
      }

      async function createBackup() {
          showLoading(true);
          try {
              const response = await fetch(`${SCRIPT_URL}?action=createBackup`);
              const result = await response.json();

              if (result.success) {
                  showAlert('系統備份已建立：' + result.backupName, 'success');
              } else {
                  showAlert('建立備份失敗：' + result.error, 'error');
              }
          } catch (error) {
              console.error('建立備份錯誤:', error);
              showAlert('建立備份失敗', 'error');
          } finally {
              showLoading(false);
          }
      }

      async function systemHealthCheck() {
          showLoading(true);
          try {
              const response = await fetch(`${SCRIPT_URL}?action=healthCheck`);
              const result = await response.json();

              if (result.success) {
                  showHealthCheckResults(result.results);
              } else {
                  showAlert('系統檢查失敗：' + result.error, 'error');
              }
          } catch (error) {
              console.error('系統檢查錯誤:', error);
              showAlert('系統檢查失敗', 'error');
          } finally {
              showLoading(false);
          }
      }

      function showHealthCheckResults(results) {
          const modalContent = document.getElementById('modalContent');
          let html = '<h2>🔧 系統健康檢查報告</h2>';
          html += `<p><strong>檢查時間：</strong>${new Date(results.timestamp).toLocaleString('zh-TW')}</p>`;
          html += '<table class="results-table"><tr><th>類型</th><th>項目</th><th>狀態</th><th>詳細資訊</th></tr>';

          results.checks.forEach(check => {
              const statusColor = check.status === '正常' ? '#4caf50' : '#f44336';
              html += `
                  <tr>
                      <td>${check.type}</td>
                      <td>${check.name}</td>
                      <td style="color: ${statusColor}; font-weight: bold;">${check.status}</td>
                      <td>${check.details}</td>
                  </tr>
              `;
          });

          html += '</table>';
          html += '<div class="btn-group"><button class="btn btn-secondary" onclick="closeModal()">關閉</button></div>';
          
          modalContent.innerHTML = html;
          document.getElementById('modal').style.display = 'block';
      }

      function resetSystem() {
          if (confirm('⚠️ 警告：此操作將重置所有系統設定，但不會刪除交易資料。確定要繼續嗎？')) {
              showAlert('系統重置功能開發中', 'info');
          }
      }

      // 更新系統狀態
      function updateSystemStatus() {
          const now = new Date();
          const uptime = Math.floor((now - systemStartTime) / 1000 / 60); // 分鐘
          
          document.getElementById('systemUptime').textContent = uptime + ' 分鐘';
          document.getElementById('dataSize').textContent = '載入中...';
          document.getElementById('lastBackup').textContent = '未知';

          // 每分鐘更新一次
          setTimeout(updateSystemStatus, 60000);
      }

      // 匯出報表
      async function exportReport() {
          try {
              const response = await fetch(`${SCRIPT_URL}?action=exportCSV&sheetName=會計記錄`);
              const result = await response.json();

              if (result.success) {
                  const link = document.createElement('a');
                  link.href = result.downloadUrl;
                  link.download = result.fileName;
                  link.click();
                  showAlert('報表匯出成功', 'success');
              } else {
                  showAlert('匯出失敗：' + result.error, 'error');
              }
          } catch (error) {
              console.error('匯出錯誤:', error);
              showAlert('匯出失敗', 'error');
          }
      }

      // 工具函數
      function showAlert(message, type = 'info') {
          const alertContainer = document.getElementById('alertContainer');
          const alertDiv = document.createElement('div');
          alertDiv.className = `alert alert-${type}`;
          alertDiv.textContent = message;
          alertDiv.style.display = 'block';

          alertContainer.appendChild(alertDiv);

          // 3秒後自動消失
          setTimeout(() => {
              alertDiv.style.opacity = '0';
              setTimeout(() => {
                  if (alertContainer.contains(alertDiv)) {
                      alertContainer.removeChild(alertDiv);
                  }
              }, 300);
          }, 3000);
      }

      function showLoading(show) {
          document.getElementById('loading').style.display = show ? 'block' : 'none';
      }

      function closeModal() {
          document.getElementById('modal').style.display = 'none';
      }

      // 鍵盤快捷鍵
      document.addEventListener('keydown', function(e) {
          // Ctrl + S 儲存表單
          if (e.ctrlKey && e.key === 's') {
              e.preventDefault();
              const activeTab = document.querySelector('.tab-content.active');
              if (activeTab && activeTab.id === 'transaction') {
                  document.getElementById('transactionForm').dispatchEvent(new Event('submit'));
              }
          }

          // Ctrl + R 重新整理統計
          if (e.ctrlKey && e.key === 'r') {
              e.preventDefault();
              refreshStats();
          }

          // ESC 關閉模態視窗
          if (e.key === 'Escape') {
              closeModal();
              closeReceiptModal();
          }
      });

      // 自動儲存功能（草稿）
      function autoSave() {
          const formData = new FormData(document.getElementById('transactionForm'));
          const data = Object.fromEntries(formData.entries());
          
          // 只有在有重要資料時才儲存
          if (data.name || data.amount) {
              localStorage.setItem('transactionDraft', JSON.stringify(data));
          }
      }

      // 載入草稿
      function loadDraft() {
          const draft = localStorage.getItem('transactionDraft');
          if (draft) {
              const data = JSON.parse(draft);
              Object.keys(data).forEach(key => {
                  const element = document.getElementById(key);
                  if (element) {
                      element.value = data[key];
                  }
              });
              showAlert('已載入上次未完成的表單', 'info');
          }
      }

      // 清除草稿
      function clearDraft() {
          localStorage.removeItem('transactionDraft');
      }

      // 表單變更時自動儲存草稿
      document.addEventListener('input', function(e) {
          if (e.target.form && e.target.form.id === 'transactionForm') {
              setTimeout(autoSave, 1000); // 延遲1秒儲存
          }
      });

      // 頁面載入時嘗試載入草稿
      window.addEventListener('load', function() {
          setTimeout(loadDraft, 500);
      });

      // 表單成功提交後清除草稿
      function clearFormAndDraft() {
          clearForm();
          clearDraft();
      }

      // 數字格式化
      function formatCurrency(amount) {
          return new Intl.NumberFormat('zh-TW', {
              style: 'currency',
              currency: 'TWD',
              minimumFractionDigits: 0
          }).format(amount);
      }

      // 日期格式化
      function formatDate(dateString) {
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
          });
      }

      // 響應式設計輔助函數
      function checkMobile() {
          return window.innerWidth <= 768;
      }

      // 調整移動裝置顯示
      function adjustForMobile() {
          if (checkMobile()) {
              // 移動裝置特殊處理
              document.querySelectorAll('.form-row').forEach(row => {
                  row.style.gridTemplateColumns = '1fr';
              });
          }
      }

      // 視窗大小變更時調整
      window.addEventListener('resize', adjustForMobile);

      // 離線檢測
      window.addEventListener('online', function() {
          showAlert('網路連線已恢復', 'success');
      });

      window.addEventListener('offline', function() {
          showAlert('網路連線中斷，請檢查網路狀態', 'error');
      });

      // 頁面可見性變更處理
      document.addEventListener('visibilitychange', function() {
          if (!document.hidden) {
              // 頁面重新可見時重新載入統計
              loadStatistics();
          }
      });

      // 服務工作者註冊（用於離線支援）
      if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
              navigator.serviceWorker.register('/sw.js').then(function(registration) {
                  console.log('ServiceWorker 註冊成功:', registration.scope);
              }, function(err) {
                  console.log('ServiceWorker 註冊失敗:', err);
              });
          });
      }

      // 效能監控
      function logPerformance(action, startTime) {
          const endTime = performance.now();
          const duration = endTime - startTime;
          console.log(`${action} 執行時間: ${duration.toFixed(2)}ms`);
          
          // 如果執行時間過長，顯示警告
          if (duration > 3000) {
              showAlert('系統回應較慢，請稍候', 'info');
          }
      }

      // 錯誤處理
      window.addEventListener('error', function(e) {
          console.error('JavaScript 錯誤:', e.error);
          showAlert('系統發生錯誤，請重新整理頁面', 'error');
      });

      // 未處理的 Promise 拒絕
      window.addEventListener('unhandledrejection', function(e) {
          console.error('未處理的 Promise 錯誤:', e.reason);
          showAlert('系統發生錯誤，請稍後再試', 'error');
          e.preventDefault();
      });

      // 資料驗證輔助函數
      function validateTaiwanPhone(phone) {
          const phoneRegex = /^(\+886|886|0)?[2-9]\d{8}$/;
          return phoneRegex.test(phone.replace(/[-\s]/g, ''));
      }

      function validateTaiwanID(id) {
          // 台灣身分證字號驗證
          const idRegex = /^[A-Z][12]\d{8}$/;
          if (!idRegex.test(id)) return false;
          
          // 進一步驗證檢查碼
          const letters = 'ABCDEFGHJKLMNPQRSTUVXYWZIO';
          const letterValue = letters.indexOf(id[0]) + 10;
          const checkSum = Math.floor(letterValue / 10) + 
                         (letterValue % 10) * 9 + 
                         parseInt(id[1]) * 8 + 
                         parseInt(id[2]) * 7 + 
                         parseInt(id[3]) * 6 + 
                         parseInt(id[4]) * 5 + 
                         parseInt(id[5]) * 4 + 
                         parseInt(id[6]) * 3 + 
                         parseInt(id[7]) * 2 + 
                         parseInt(id[8]) * 1 + 
                         parseInt(id[9]);
          
          return checkSum % 10 === 0;
      }

      // 資料匯出功能增強
      function exportToExcel() {
          showAlert('Excel 匯出功能開發中', 'info');
      }

      function exportToPDF() {
          showAlert('PDF 匯出功能開發中', 'info');
      }

      // 列印功能
      function printPage() {
          window.print();
      }

      // 全螢幕功能
      function toggleFullscreen() {
          if (!document.fullscreenElement) {
              document.documentElement.requestFullscreen();
          } else {
              document.exitFullscreen();
          }
      }

      // 主題切換（深色模式）
      function toggleDarkMode() {
          document.body.classList.toggle('dark-mode');
          const isDark = document.body.classList.contains('dark-mode');
          localStorage.setItem('darkMode', isDark);
      }

      // 載入主題設定
      function loadTheme() {
          const isDark = localStorage.getItem('darkMode') === 'true';
          if (isDark) {
              document.body.classList.add('dark-mode');
          }
      }

      // 頁面載入完成後執行
      document.addEventListener('DOMContentLoaded', function() {
          loadTheme();
          adjustForMobile();
      });

      // 系統資訊顯示
      function showSystemInfo() {
          const info = {
              userAgent: navigator.userAgent,
              language: navigator.language,
              platform: navigator.platform,
              cookieEnabled: navigator.cookieEnabled,
              onLine: navigator.onLine,
              screenResolution: `${screen.width}x${screen.height}`,
              windowSize: `${window.innerWidth}x${window.innerHeight}`,
              colorDepth: screen.colorDepth,
              timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
          };

          const modalContent = document.getElementById('modalContent');
          modalContent.innerHTML = `
              <h2>💻 系統資訊</h2>
              <table class="results-table">
                  <tr><td>瀏覽器</td><td>${info.userAgent}</td></tr>
                  <tr><td>語言</td><td>${info.language}</td></tr>
                  <tr><td>平台</td><td>${info.platform}</td></tr>
                  <tr><td>Cookie 支援</td><td>${info.cookieEnabled ? '是' : '否'}</td></tr>
                  <tr><td>網路狀態</td><td>${info.onLine ? '線上' : '離線'}</td></tr>
                  <tr><td>螢幕解析度</td><td>${info.screenResolution}</td></tr>
                  <tr><td>視窗大小</td><td>${info.windowSize}</td></tr>
                  <tr><td>色彩深度</td><td>${info.colorDepth} bit</td></tr>
                  <tr><td>時區</td><td>${info.timezone}</td></tr>
              </table>
              <div class="btn-group">
                  <button class="btn btn-secondary" onclick="closeModal()">關閉</button>
              </div>
          `;
          document.getElementById('modal').style.display = 'block';
      }

      // 快速操作按鈕
      function addQuickActions() {
          const quickActions = document.createElement('div');
          quickActions.className = 'quick-actions';
          quickActions.style.cssText = `
              position: fixed;
              bottom: 20px;
              right: 20px;
              z-index: 999;
              display: flex;
              flex-direction: column;
              gap: 10px;
          `;

          const actions = [
              { icon: '📊', title: '快速統計', action: 'refreshStats()' },
              { icon: '💾', title: '儲存草稿', action: 'autoSave()' },
              { icon: '🔝', title: '回到頂部', action: 'scrollToTop()' }
          ];

          actions.forEach(action => {
              const btn = document.createElement('button');
              btn.innerHTML = action.icon;
              btn.title = action.title;
              btn.onclick = new Function(action.action);
              btn.style.cssText = `
                  width: 50px;
                  height: 50px;
                  border-radius: 50%;
                  border: none;
                  background: #4caf50;
                  color: white;
                  font-size: 20px;
                  cursor: pointer;
                  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                  transition: all 0.3s ease;
              `;
              btn.onmouseover = () => btn.style.transform = 'scale(1.1)';
              btn.onmouseout = () => btn.style.transform = 'scale(1)';
              quickActions.appendChild(btn);
          });

          document.body.appendChild(quickActions);
      }

      function scrollToTop() {
          window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // 初始化快速操作
      window.addEventListener('load', addQuickActions);

      // 資料同步狀態指示器
      function showSyncStatus(status) {
          const indicator = document.getElementById('syncIndicator') || document.createElement('div');
          indicator.id = 'syncIndicator';
          indicator.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              padding: 10px 15px;
              border-radius: 20px;
              color: white;
              font-size: 14px;
              z-index: 1000;
              transition: all 0.3s ease;
          `;

          switch (status) {
              case 'syncing':
                  indicator.style.background = '#ff9800';
                  indicator.textContent = '🔄 同步中...';
                  break;
              case 'synced':
                  indicator.style.background = '#4caf50';
                  indicator.textContent = '✅ 已同步';
                  setTimeout(() => indicator.style.opacity = '0', 2000);
                  break;
              case 'error':
                  indicator.style.background = '#f44336';
                  indicator.textContent = '❌ 同步失敗';
                  break;
          }

          if (!document.getElementById('syncIndicator')) {
              document.body.appendChild(indicator);
          }
      }

      console.log('🎉 台灣帕金森病友權益促進會會計系統前端載入完成');
      console.log('📋 功能包含：交易管理、統計查詢、批次匯入、系統設定');
      console.log('🔧 支援功能：離線檢測、自動儲存、響應式設計、鍵盤快捷鍵');
  </script>

  <!-- 深色模式樣式 -->
  <style>
      .dark-mode {
          background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
          color: #ecf0f1;
      }

      .dark-mode .card,
      .dark-mode .header,
      .dark-mode .search-section {
          background: rgba(52, 73, 94, 0.95);
          color: #ecf0f1;
      }

      .dark-mode .form-group input,
      .dark-mode .form-group select,
      .dark-mode .form-group textarea {
          background: rgba(44, 62, 80, 0.8);
          color: #ecf0f1;
          border-color: #5a6c7d;
      }

      .dark-mode .results-table {
          background: rgba(52, 73, 94, 0.95);
          color: #ecf0f1;
      }

      .dark-mode .results-table th {
          background: linear-gradient(135deg, #2c3e50, #34495e);
      }

      .dark-mode .modal-content {
          background: #34495e;
          color: #ecf0f1;
      }

      .dark-mode .alert-success {
          background: linear-gradient(135deg, #27ae60, #2ecc71);
          color: white;
      }

      .dark-mode .alert-error {
          background: linear-gradient(135deg, #e74c3c, #c0392b);
          color: white;
      }

      .dark-mode .alert-info {
          background: linear-gradient(135deg, #3498db, #2980b9);
          color: white;
      }
  </style>

  <!-- PWA 支援 -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#4caf50">
  <link rel="apple-touch-icon" href="/icon-192x192.png">
</body>
</html>
