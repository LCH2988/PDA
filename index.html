<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NGO 會計系統</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css">
  
  <style>
      :root {
          --primary-color: #2c5aa0;
          --secondary-color: #f8f9fa;
          --accent-color: #ffc107;
          --success-color: #198754;
          --danger-color: #dc3545;
          --text-color: #333;
          --light-text: #6c757d;
      }
      
      body {
          font-family: "Microsoft JhengHei", Arial, sans-serif;
          color: var(--text-color);
          background-color: #f5f7fa;
      }
      
      .sidebar {
          background-color: var(--primary-color);
          color: white;
          min-height: 100vh;
          position: fixed;
          left: 0;
          top: 0;
          width: 250px;
          z-index: 1000;
          transition: all 0.3s;
          box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      
      .sidebar.collapsed {
          width: 70px;
      }
      
      .sidebar .nav-link {
          color: rgba(255, 255, 255, 0.8);
          padding: 0.75rem 1rem;
          margin: 0.2rem 0;
          border-radius: 0.25rem;
          transition: all 0.3s;
      }
      
      .sidebar .nav-link:hover {
          color: white;
          background-color: rgba(255, 255, 255, 0.1);
      }
      
      .sidebar .nav-link.active {
          color: white;
          background-color: rgba(255, 255, 255, 0.2);
          font-weight: bold;
      }
      
      .sidebar .nav-link i {
          margin-right: 0.75rem;
          width: 20px;
          text-align: center;
      }
      
      .sidebar.collapsed .nav-link span {
          display: none;
      }
      
      .sidebar.collapsed .nav-link i {
          margin-right: 0;
          font-size: 1.2rem;
      }
      
      .sidebar-header {
          padding: 1rem;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .sidebar-footer {
          padding: 1rem;
          border-top: 1px solid rgba(255, 255, 255, 0.1);
          position: absolute;
          bottom: 0;
          width: 100%;
      }
      
      .main-content {
          margin-left: 250px;
          padding: 1rem;
          transition: all 0.3s;
      }
      
      .main-content.expanded {
          margin-left: 70px;
      }
      
      .card {
          border: none;
          border-radius: 0.5rem;
          box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
          margin-bottom: 1.5rem;
      }
      
      .card-header {
          background-color: white;
          border-bottom: 1px solid rgba(0, 0, 0, 0.05);
          font-weight: 600;
      }
      
      .btn-primary {
          background-color: var(--primary-color);
          border-color: var(--primary-color);
      }
      
      .btn-primary:hover {
          background-color: #224785;
          border-color: #224785;
      }
      
      .stat-card {
          border-left: 4px solid var(--primary-color);
          background-color: white;
          padding: 1rem;
          border-radius: 0.25rem;
          box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
          margin-bottom: 1rem;
      }
      
      .stat-card .stat-title {
          color: var(--light-text);
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
      }
      
      .stat-card .stat-value {
          font-size: 1.5rem;
          font-weight: bold;
          margin-bottom: 0.25rem;
      }
      
      .stat-card .stat-icon {
          float: right;
          font-size: 2rem;
          opacity: 0.3;
      }
      
      .stat-card.income {
          border-left-color: var(--success-color);
      }
      
      .stat-card.expense {
          border-left-color: var(--danger-color);
      }
      
      .stat-card.balance {
          border-left-color: var(--accent-color);
      }
      
      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(255, 255, 255, 0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }
      
      .spinner {
          width: 3rem;
          height: 3rem;
      }
      
      .toast-container {
          position: fixed;
          top: 1rem;
          right: 1rem;
          z-index: 1100;
      }
      
      @media print {
          .sidebar, .navbar, .no-print {
              display: none !important;
          }
          
          .main-content {
              margin-left: 0 !important;
              padding: 0 !important;
          }
          
          .card {
              box-shadow: none !important;
          }
      }
  </style>
</head>
<body>
  <!-- 載入中動畫 -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none;">
      <div class="spinner-border text-primary spinner" role="status">
          <span class="visually-hidden">載入中...</span>
      </div>
  </div>
  
  <!-- 提示訊息容器 -->
  <div class="toast-container"></div>
  
  <!-- 側邊欄 -->
  <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
          <h5 class="mb-0 text-white" id="orgName">NGO 會計系統</h5>
          <button class="btn btn-sm btn-outline-light mt-2" id="toggleSidebar">
              <i class="fas fa-bars"></i>
          </button>
      </div>
      
      <ul class="nav flex-column mt-3">
          <li class="nav-item">
              <a class="nav-link active" href="#" data-page="dashboard">
                  <i class="fas fa-tachometer-alt"></i>
                  <span>儀表板</span>
              </a>
          </li>
          <li class="nav-item">
              <a class="nav-link" href="#" data-page="transactions">
                  <i class="fas fa-exchange-alt"></i>
                  <span>交易記錄</span>
              </a>
          </li>
          <li class="nav-item">
              <a class="nav-link" href="#" data-page="receipts">
                  <i class="fas fa-receipt"></i>
                  <span>收據管理</span>
              </a>
          </li>
          <li class="nav-item">
              <a class="nav-link" href="#" data-page="vouchers">
                  <i class="fas fa-file-invoice-dollar"></i>
                  <span>支出憑證</span>
              </a>
          </li>
          <li class="nav-item">
              <a class="nav-link" href="#" data-page="members">
                  <i class="fas fa-users"></i>
                  <span>人員管理</span>
              </a>
          </li>
          <li class="nav-item">
              <a class="nav-link" href="#" data-page="reports">
                  <i class="fas fa-chart-bar"></i>
                  <span>財務報表</span>
              </a>
          </li>
          <li class="nav-item">
              <a class="nav-link" href="#" data-page="settings">
                  <i class="fas fa-cog"></i>
                  <span>系統設定</span>
              </a>
          </li>
      </ul>
      
      <div class="sidebar-footer">
          <div class="d-flex align-items-center">
              <i class="fas fa-user-circle me-2"></i>
              <span id="userInfo">管理員</span>
          </div>
          <div class="mt-2 small" id="systemVersion">版本: 1.0.0</div>
      </div>
  </div>
  
  <!-- 主要內容區 -->
  <div class="main-content" id="mainContent">
      <!-- 頂部導航 -->
      <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 rounded shadow-sm">
          <div class="container-fluid">
              <ol class="breadcrumb m-0">
                  <li class="breadcrumb-item active" id="currentPage">儀表板</li>
              </ol>
              <div class="d-flex">
                  <button class="btn btn-outline-secondary btn-sm me-2" id="refreshBtn">
                      <i class="fas fa-sync-alt"></i> 重新整理
                  </button>
                  <div class="dropdown">
                      <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="addNewBtn" data-bs-toggle="dropdown" aria-expanded="false">
                          <i class="fas fa-plus"></i> 新增
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="addNewBtn">
                          <li><a class="dropdown-item" href="#" data-action="new-transaction">新增交易</a></li>
                          <li><a class="dropdown-item" href="#" data-action="new-receipt">開立收據</a></li>
                          <li><a class="dropdown-item" href="#" data-action="new-voucher">申請支出憑證</a></li>
                          <li><a class="dropdown-item" href="#" data-action="new-member">新增會員</a></li>
                      </ul>
                  </div>
              </div>
          </div>
      </nav>
      
      <!-- 頁面內容區 -->
      <div id="pageContent">
          <!-- 內容將由 JavaScript 動態載入 -->
      </div>
  </div>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  
  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
  
  <script>
      // ========================================
      // 全域變數與設定
      // ========================================
      
      const CONFIG = {
          API_URL: 'https://script.google.com/macros/s/AKfycbz7mbKyOc5XhfyWKIp_imhurX08jUSeEdXJl0qSFXugWJAXhL1h5qcP-Su7_9bKesHN/exec',
          VERSION: '1.0.0',
          ORGANIZATION: {
              name: '台灣帕金森病友權益促進會',
              englishName: 'Taiwan Parkinson Disease Association'
          }
      };
      
      let systemSettings = {};
      let currentPage = 'dashboard';
      let currentUser = null;
      
      // ========================================
      // 核心工具函數
      // ========================================
      
      class Utils {
          static formatNumber(num) {
              return new Intl.NumberFormat('zh-TW').format(num);
          }
          
          static formatDate(date) {
              if (!date) return '';
              return new Date(date).toLocaleDateString('zh-TW');
          }
          
          static formatDateForInput(date) {
              if (!date) return '';
              const d = new Date(date);
              return d.toISOString().split('T')[0];
          }
          
          static showLoading() {
              document.getElementById('loadingOverlay').style.display = 'flex';
          }
          
          static hideLoading() {
              document.getElementById('loadingOverlay').style.display = 'none';
          }
          
          static showToast(title, message, type = 'info') {
              const toastContainer = document.querySelector('.toast-container');
              const toastId = 'toast-' + Date.now();
              
              const toastHtml = `
                  <div class="toast" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                      <div class="toast-header">
                          <i class="fas fa-${this.getToastIcon(type)} text-${type} me-2"></i>
                          <strong class="me-auto">${title}</strong>
                          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                      </div>
                      <div class="toast-body">
                          ${message}
                      </div>
                  </div>
              `;
              
              toastContainer.insertAdjacentHTML('beforeend', toastHtml);
              
              const toastElement = document.getElementById(toastId);
              const toast = new bootstrap.Toast(toastElement);
              toast.show();
              
              // 自動移除
              toastElement.addEventListener('hidden.bs.toast', () => {
                  toastElement.remove();
              });
          }
          
          static getToastIcon(type) {
              const icons = {
                  success: 'check-circle',
                  danger: 'exclamation-triangle',
                  warning: 'exclamation-circle',
                  info: 'info-circle'
              };
              return icons[type] || 'info-circle';
          }
      }
      
      // ========================================
      // API 管理類
      // ========================================
      
      class ApiManager {
          static async request(action, data = {}) {
              try {
                  const response = await fetch(CONFIG.API_URL, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                          action: action,
                          data: data
                      })
                  });
                  
                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  
                  return await response.json();
              } catch (error) {
                  console.error('API 請求失敗:', error);
                  throw error;
              }
          }
          
          static async getDashboardData() {
              return await this.request('getDashboardData');
          }
          
          static async getTransactions(options = {}) {
              return await this.request('getTransactions', options);
          }
          
          static async addTransaction(transactionData) {
              return await this.request('addTransaction', transactionData);
          }
          
          static async updateTransaction(transactionData) {
              return await this.request('updateTransaction', transactionData);
          }
          
          static async deleteTransaction(id) {
              return await this.request('deleteTransaction', { id });
          }
          
          static async getReceipts(options = {}) {
              return await this.request('getReceipts', options);
          }
          
          static async generateReceipt(receiptData) {
              return await this.request('generateReceipt', receiptData);
          }
          
          static async sendReceiptEmail(receiptNumber, email, subject) {
              return await this.request('sendReceiptByEmail', { receiptNumber, email, subject });
          }
          
          static async getMembers(options = {}) {
              return await this.request('getMembers', options);
          }
          
          static async addMember(memberData) {
              return await this.request('addMember', memberData);
          }
          
          static async getSystemSettings() {
              return await this.request('getSystemSettings');
          }
          
          static async initializeSystem() {
              return await this.request('initializeSystem');
          }
      }
      
      // ========================================
      // 頁面管理類
      // ========================================
      
      class PageManager {
          static pages = {
              dashboard: DashboardPage,
              transactions: TransactionsPage,
              receipts: ReceiptsPage,
              vouchers: VouchersPage,
              members: MembersPage,
              reports: ReportsPage,
              settings: SettingsPage
          };
          
          static async loadPage(pageName) {
              if (!this.pages[pageName]) {
                  console.error('找不到頁面:', pageName);
                  return;
              }
              
              currentPage = pageName;
              
              // 更新導航狀態
              document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                  link.classList.remove('active');
              });
              
              const activeLink = document.querySelector(`[data-page="${pageName}"]`);
              if (activeLink) {
                  activeLink.classList.add('active');
                  document.getElementById('currentPage').textContent = 
                      activeLink.querySelector('span').textContent;
              }
              
              // 載入頁面內容
              Utils.showLoading();
              try {
                  await this.pages[pageName].render();
              } catch (error) {
                  console.error('載入頁面失敗:', error);
                  Utils.showToast('錯誤', '載入頁面失敗: ' + error.message, 'danger');
              } finally {
                  Utils.hideLoading();
              }
          }
      }
      
      // ========================================
      // 儀表板頁面
      // ========================================
      
      class DashboardPage {
          static async render() {
              try {
                  const response = await ApiManager.getDashboardData();
                  
                  if (!response.success) {
                      throw new Error(response.error);
                  }
                  
                  this.renderDashboard(response.data);
              } catch (error) {
                  document.getElementById('pageContent').innerHTML = 
                      '<div class="alert alert-danger">載入儀表板資料失敗: ' + error.message + '</div>';
              }
          }
          
          static renderDashboard(data) {
              const html = `
                  <div class="row">
                      <!-- 財務摘要 -->
                      <div class="col-md-4">
                          <div class="stat-card income">
                              <div class="stat-title">本月收入</div>
                              <div class="stat-value">NT$ ${Utils.formatNumber(data.summary.monthlyIncome || 0)}</div>
                              <div class="stat-icon"><i class="fas fa-arrow-down"></i></div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="stat-card expense">
                              <div class="stat-title">本月支出</div>
                              <div class="stat-value">NT$ ${Utils.formatNumber(data.summary.monthlyExpense || 0)}</div>
                              <div class="stat-icon"><i class="fas fa-arrow-up"></i></div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="stat-card balance">
                              <div class="stat-title">本月餘額</div>
                              <div class="stat-value">NT$ ${Utils.formatNumber(data.summary.monthlyBalance || 0)}</div>
                              <div class="stat-icon"><i class="fas fa-balance-scale"></i></div>
                          </div>
                      </div>
                      
                      <!-- 年度統計 -->
                      <div class="col-md-4">
                          <div class="stat-card income">
                              <div class="stat-title">本年度收入</div>
                              <div class="stat-value">NT$ ${Utils.formatNumber(data.summary.yearlyIncome || 0)}</div>
                              <div class="stat-icon"><i class="fas fa-arrow-down"></i></div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="stat-card expense">
                              <div class="stat-title">本年度支出</div>
                              <div class="stat-value">NT$ ${Utils.formatNumber(data.summary.yearlyExpense || 0)}</div>
                              <div class="stat-icon"><i class="fas fa-arrow-up"></i></div>
                          </div>
                      </div>
                      <div class="col-md-4">
                          <div class="stat-card balance">
                              <div class="stat-title">本年度餘額</div>
                              <div class="stat-value">NT$ ${Utils.formatNumber(data.summary.yearlyBalance || 0)}</div>
                              <div class="stat-icon"><i class="fas fa-balance-scale"></i></div>
                          </div>
                      </div>
                      
                      <!-- 圖表 -->
                      <div class="col-md-8">
                          <div class="card">
                              <div class="card-header">
                                  <span>月度收支趨勢</span>
                              </div>
                              <div class="card-body">
                                  <canvas id="monthlyChart" height="300"></canvas>
                              </div>
                          </div>
                      </div>
                      
                      <div class="col-md-4">
                          <div class="card">
                              <div class="card-header">
                                  <span>收入類別分佈</span>
                              </div>
                              <div class="card-body">
                                  <canvas id="incomePieChart" height="260"></canvas>
                              </div>
                          </div>
                      </div>
                      
                      <!-- 最近交易 -->
                      <div class="col-md-6">
                          <div class="card">
                              <div class="card-header">
                                  最近交易記錄
                              </div>
                              <div class="card-body p-0">
                                  <div class="table-responsive">
                                      <table class="table table-hover mb-0">
                                          <thead class="table-light">
                                              <tr>
                                                  <th>日期</th>
                                                  <th>名稱</th>
                                                  <th>類型</th>
                                                  <th>金額</th>
                                              </tr>
                                          </thead>
                                          <tbody>
                                              ${(data.recentTransactions || []).map(t => `
                                                  <tr>
                                                      <td>${Utils.formatDate(t.date)}</td>
                                                      <td>${t.name}</td>
                                                      <td>
                                                          <span class="badge ${t.type === '收入' ? 'bg-success' : 'bg-danger'}">
                                                              ${t.type}
                                                          </span>
                                                      </td>
                                                      <td class="text-end">NT$ ${Utils.formatNumber(t.amount)}</td>
                                                  </tr>
                                              `).join('')}
                                          </tbody>
                                      </table>
                                  </div>
                                  <div class="text-center py-2">
                                      <button class="btn btn-sm btn-outline-primary" onclick="PageManager.loadPage('transactions')">查看全部</button>
                                  </div>
                              </div>
                          </div>
                      </div>
                      
                      <!-- 會員統計 -->
                      <div class="col-md-6">
                          <div class="card">
                              <div class="card-header">
                                  會員統計
                              </div>
                              <div class="card-body">
                                  <div class="row">
                                      <div class="col-6">
                                          <div class="text-center mb-3">
                                              <div class="fs-1 fw-bold text-primary">${(data.memberStats && data.memberStats.total) || 0}</div>
                                              <div>總會員數</div>
                                          </div>
                                      </div>
                                      <div class="col-6">
                                          <div class="text-center mb-3">
                                              <div class="fs-1 fw-bold text-success">${(data.memberStats && data.memberStats.active) || 0}</div>
                                              <div>正式會員</div>
                                          </div>
                                      </div>
                                  </div>
                                  <div class="text-center mt-3">
                                      <button class="btn btn-sm btn-outline-primary" onclick="PageManager.loadPage('members')">管理會員</button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              `;
              
              document.getElementById('pageContent').innerHTML = html;
              
              // 初始化圖表
              this.initializeCharts(data);
          }
          
          static initializeCharts(data) {
              // 月度收支圖表
              if (data.monthlyData) {
                  this.initializeMonthlyChart(data.monthlyData);
              }
              
              // 收入類別圓餅圖
              if (data.incomeByCategory) {
                  this.initializeIncomePieChart(data.incomeByCategory);
              }
          }
          
          static initializeMonthlyChart(monthlyData) {
              const ctx = document.getElementById('monthlyChart');
              if (!ctx) return;
              
              const months = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
              const incomeData = monthlyData.map(item => item.income || 0);
              const expenseData = monthlyData.map(item => item.expense || 0);
              
              new Chart(ctx, {
                  type: 'bar',
                  data: {
                      labels: months,
                      datasets: [
                          {
                              label: '收入',
                              data: incomeData,
                              backgroundColor: 'rgba(25, 135, 84, 0.6)',
                              borderColor: 'rgba(25, 135, 84, 1)',
                              borderWidth: 1
                          },
                          {
                              label: '支出',
                              data: expenseData,
                              backgroundColor: 'rgba(220, 53, 69, 0.6)',
                              borderColor: 'rgba(220, 53, 69, 1)',
                              borderWidth: 1
                          }
                      ]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                          legend: {
                              position: 'top'
                          },
                          tooltip: {
                              callbacks: {
                                  label: function(context) {
                                      return context.dataset.label + ': NT$ ' + Utils.formatNumber(context.raw);
                                  }
                              }
                          }
                      },
                      scales: {
                          y: {
                              beginAtZero: true,
                              ticks: {
                                  callback: function(value) {
                                      return 'NT$ ' + Utils.formatNumber(value);
                                  }
                              }
                          }
                      }
                  }
              });
          }
          
          static initializeIncomePieChart(incomeByCategory) {
              const ctx = document.getElementById('incomePieChart');
              if (!ctx) return;
              
              const labels = incomeByCategory.map(item => item.category);
              const data = incomeByCategory.map(item => item.amount);
              
              const backgroundColors = [
                  'rgba(25, 135, 84, 0.7)',
                  'rgba(13, 110, 253, 0.7)',
                    'rgba(255, 193, 7, 0.7)',
                    'rgba(111, 66, 193, 0.7)',
                    'rgba(23, 162, 184, 0.7)',
                    'rgba(102, 16, 242, 0.7)',
                    'rgba(253, 126, 20, 0.7)',
                    'rgba(32, 201, 151, 0.7)'
                ];
                
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                data: data,
                                backgroundColor: backgroundColors.slice(0, data.length),
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return context.label + ': NT$ ' + Utils.formatNumber(value) + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // ========================================
        // 交易記錄頁面
        // ========================================
        
        class TransactionsPage {
            static currentFilters = {
                page: 1,
                limit: 20,
                search: '',
                type: '',
                dateFrom: '',
                dateTo: ''
            };
            
            static async render() {
                try {
                    const response = await ApiManager.getTransactions(this.currentFilters);
                    
                    if (!response.success) {
                        throw new Error(response.error);
                    }
                    
                    this.renderTransactionsList(response.data);
                } catch (error) {
                    document.getElementById('pageContent').innerHTML = 
                        '<div class="alert alert-danger">載入交易記錄失敗: ' + error.message + '</div>';
                }
            }
            
            static renderTransactionsList(data) {
                const html = `
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>交易記錄</span>
                            <button class="btn btn-primary btn-sm" onclick="TransactionsPage.showNewTransactionForm()">
                                <i class="fas fa-plus"></i> 新增交易
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- 篩選工具 -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="typeFilter">
                                        <option value="">所有類型</option>
                                        <option value="收入" ${this.currentFilters.type === '收入' ? 'selected' : ''}>收入</option>
                                        <option value="支出" ${this.currentFilters.type === '支出' ? 'selected' : ''}>支出</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="date" class="form-control form-control-sm" id="dateFromFilter" 
                                           value="${this.currentFilters.dateFrom}" placeholder="起始日期">
                                </div>
                                <div class="col-md-3">
                                    <input type="date" class="form-control form-control-sm" id="dateToFilter" 
                                           value="${this.currentFilters.dateTo}" placeholder="結束日期">
                                </div>
                                <div class="col-md-3">
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" id="searchFilter" 
                                               value="${this.currentFilters.search}" placeholder="搜尋...">
                                        <button class="btn btn-outline-secondary" type="button" onclick="TransactionsPage.applyFilters()">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 交易表格 -->
                            <div class="table-responsive">
                                <table class="table table-hover table-striped">
                                    <thead>
                                        <tr>
                                            <th>日期</th>
                                            <th>名稱</th>
                                            <th>類型</th>
                                            <th>類別</th>
                                            <th>金額</th>
                                            <th>說明</th>
                                            <th>狀態</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${(data.transactions || []).map(t => `
                                            <tr>
                                                <td>${Utils.formatDate(t.日期)}</td>
                                                <td>${t.姓名 || t.名稱}</td>
                                                <td>
                                                    <span class="badge ${t.類型 === '收入' ? 'bg-success' : 'bg-danger'}">
                                                        ${t.類型}
                                                    </span>
                                                </td>
                                                <td>${t.類別}</td>
                                                <td class="text-end">NT$ ${Utils.formatNumber(t.金額)}</td>
                                                <td>${t.說明 || ''}</td>
                                                <td>
                                                    <span class="badge ${t.狀態 === '已確認' ? 'bg-success' : t.狀態 === '待確認' ? 'bg-warning text-dark' : 'bg-danger'}">
                                                        ${t.狀態}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary" onclick="TransactionsPage.editTransaction(${t.id})">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger" onclick="TransactionsPage.deleteTransaction(${t.id})">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- 分頁 -->
                            ${this.renderPagination(data.pagination)}
                        </div>
                    </div>
                `;
                
                document.getElementById('pageContent').innerHTML = html;
                this.bindEvents();
            }
            
            static renderPagination(pagination) {
                if (!pagination || pagination.totalPages <= 1) return '';
                
                const currentPage = pagination.page;
                const totalPages = pagination.totalPages;
                let paginationHtml = '<nav aria-label="Page navigation" class="mt-3"><ul class="pagination justify-content-center">';
                
                // 上一頁
                paginationHtml += `
                    <li class="page-item ${currentPage <= 1 ? 'disabled' : ''}">
                        <button class="page-link" onclick="TransactionsPage.changePage(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''}>
                            上一頁
                        </button>
                    </li>
                `;
                
                // 頁碼
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, currentPage + 2);
                
                for (let i = startPage; i <= endPage; i++) {
                    paginationHtml += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <button class="page-link" onclick="TransactionsPage.changePage(${i})">${i}</button>
                        </li>
                    `;
                }
                
                // 下一頁
                paginationHtml += `
                    <li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
                        <button class="page-link" onclick="TransactionsPage.changePage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>
                            下一頁
                        </button>
                    </li>
                `;
                
                paginationHtml += '</ul></nav>';
                return paginationHtml;
            }
            
            static bindEvents() {
                // 綁定篩選事件
                document.getElementById('typeFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('dateFromFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('dateToFilter').addEventListener('change', () => this.applyFilters());
                
                // 搜尋框 Enter 鍵
                document.getElementById('searchFilter').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.applyFilters();
                    }
                });
            }
            
            static applyFilters() {
                this.currentFilters = {
                    page: 1,
                    limit: 20,
                    search: document.getElementById('searchFilter').value,
                    type: document.getElementById('typeFilter').value,
                    dateFrom: document.getElementById('dateFromFilter').value,
                    dateTo: document.getElementById('dateToFilter').value
                };
                
                this.render();
            }
            
            static changePage(page) {
                this.currentFilters.page = page;
                this.render();
            }
            
            static showNewTransactionForm() {
                this.renderTransactionForm();
            }
            
            static editTransaction(id) {
                // 這裡應該先獲取交易詳情，然後顯示編輯表單
                this.renderTransactionForm(id);
            }
            
            static async deleteTransaction(id) {
                if (!confirm('確定要刪除這筆交易記錄嗎？此操作無法復原。')) {
                    return;
                }
                
                try {
                    Utils.showLoading();
                    const response = await ApiManager.deleteTransaction(id);
                    
                    if (response.success) {
                        Utils.showToast('成功', '交易記錄已刪除', 'success');
                        this.render();
                    } else {
                        Utils.showToast('錯誤', '刪除失敗: ' + response.error, 'danger');
                    }
                } catch (error) {
                    Utils.showToast('錯誤', '刪除失敗: ' + error.message, 'danger');
                } finally {
                    Utils.hideLoading();
                }
            }
            
            static renderTransactionForm(id = null) {
                const isEdit = id !== null;
                const title = isEdit ? '編輯交易' : '新增交易';
                
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">${title}</h5>
                        </div>
                        <div class="card-body">
                            <form id="transactionForm">
                                ${isEdit ? `<input type="hidden" name="id" value="${id}">` : ''}
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="transactionDate" class="form-label">日期 <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="transactionDate" name="date" required 
                                               value="${Utils.formatDateForInput(new Date())}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="transactionType" class="form-label">類型 <span class="text-danger">*</span></label>
                                        <select class="form-select" id="transactionType" name="type" required>
                                            <option value="">請選擇類型</option>
                                            <option value="收入">收入</option>
                                            <option value="支出">支出</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="transactionName" class="form-label">名稱 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="transactionName" name="name" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="transactionCategory" class="form-label">類別 <span class="text-danger">*</span></label>
                                        <select class="form-select" id="transactionCategory" name="category" required>
                                            <option value="">請選擇類別</option>
                                            <optgroup label="收入類別" id="incomeCategories">
                                                <option value="會費">會費</option>
                                                <option value="捐款">捐款</option>
                                                <option value="活動收入">活動收入</option>
                                                <option value="專案收入">專案收入</option>
                                                <option value="利息收入">利息收入</option>
                                                <option value="其他收入">其他收入</option>
                                            </optgroup>
                                            <optgroup label="支出類別" id="expenseCategories">
                                                <option value="行政費用">行政費用</option>
                                                <option value="活動費用">活動費用</option>
                                                <option value="專案費用">專案費用</option>
                                                <option value="人事費用">人事費用</option>
                                                <option value="設備費用">設備費用</option>
                                                <option value="其他費用">其他費用</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="transactionAmount" class="form-label">金額 <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text">NT$</span>
                                            <input type="number" class="form-control" id="transactionAmount" name="amount" 
                                                   min="0" step="1" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="transactionStatus" class="form-label">狀態 <span class="text-danger">*</span></label>
                                        <select class="form-select" id="transactionStatus" name="status" required>
                                            <option value="已確認" selected>已確認</option>
                                            <option value="待確認">待確認</option>
                                            <option value="已取消">已取消</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="transactionDescription" class="form-label">說明</label>
                                    <textarea class="form-control" id="transactionDescription" name="description" rows="3"></textarea>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" onclick="TransactionsPage.render()">取消</button>
                                    <button type="submit" class="btn btn-primary">儲存</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.getElementById('pageContent').innerHTML = html;
                this.bindFormEvents();
            }
            
            static bindFormEvents() {
                // 根據類型顯示對應的類別
                document.getElementById('transactionType').addEventListener('change', function() {
                    const type = this.value;
                    const incomeCategories = document.getElementById('incomeCategories');
                    const expenseCategories = document.getElementById('expenseCategories');
                    
                    if (type === '收入') {
                        incomeCategories.style.display = 'block';
                        expenseCategories.style.display = 'none';
                    } else if (type === '支出') {
                        incomeCategories.style.display = 'none';
                        expenseCategories.style.display = 'block';
                    } else {
                        incomeCategories.style.display = 'block';
                        expenseCategories.style.display = 'block';
                    }
                });
                
                // 表單提交處理
                document.getElementById('transactionForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(e.target);
                    const transactionData = Object.fromEntries(formData.entries());
                    
                    try {
                        Utils.showLoading();
                        
                        const isEdit = transactionData.id;
                        const response = isEdit ? 
                            await ApiManager.updateTransaction(transactionData) :
                            await ApiManager.addTransaction(transactionData);
                        
                        if (response.success) {
                            Utils.showToast('成功', isEdit ? '交易記錄已更新' : '交易記錄已新增', 'success');
                            TransactionsPage.render();
                        } else {
                            Utils.showToast('錯誤', '儲存失敗: ' + response.error, 'danger');
                        }
                    } catch (error) {
                        Utils.showToast('錯誤', '儲存失敗: ' + error.message, 'danger');
                    } finally {
                        Utils.hideLoading();
                    }
                });
            }
        }
        
        // ========================================
        // 收據管理頁面
        // ========================================
        
        class ReceiptsPage {
            static currentFilters = {
                page: 1,
                limit: 20,
                search: '',
                status: '',
                category: ''
            };
            
            static async render() {
                try {
                    const response = await ApiManager.getReceipts(this.currentFilters);
                    
                    if (!response.success) {
                        throw new Error(response.error);
                    }
                    
                    this.renderReceiptsList(response.data);
                } catch (error) {
                    document.getElementById('pageContent').innerHTML = 
                        '<div class="alert alert-danger">載入收據記錄失敗: ' + error.message + '</div>';
                }
            }
            
            static renderReceiptsList(data) {
                const html = `
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>收據管理</span>
                            <button class="btn btn-primary btn-sm" onclick="ReceiptsPage.showNewReceiptForm()">
                                <i class="fas fa-plus"></i> 開立收據
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- 篩選工具 -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="statusFilter">
                                        <option value="">所有狀態</option>
                                        <option value="已開立" ${this.currentFilters.status === '已開立' ? 'selected' : ''}>已開立</option>
                                        <option value="已作廢" ${this.currentFilters.status === '已作廢' ? 'selected' : ''}>已作廢</option>
                                        <option value="草稿" ${this.currentFilters.status === '草稿' ? 'selected' : ''}>草稿</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="categoryFilter">
                                        <option value="">所有類別</option>
                                        <option value="會費" ${this.currentFilters.category === '會費' ? 'selected' : ''}>會費</option>
                                        <option value="捐款" ${this.currentFilters.category === '捐款' ? 'selected' : ''}>捐款</option>
                                        <option value="活動收入" ${this.currentFilters.category === '活動收入' ? 'selected' : ''}>活動收入</option>
                                        <option value="專案收入" ${this.currentFilters.category === '專案收入' ? 'selected' : ''}>專案收入</option>
                                        <option value="其他收入" ${this.currentFilters.category === '其他收入' ? 'selected' : ''}>其他收入</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" id="searchFilter" 
                                               value="${this.currentFilters.search}" placeholder="搜尋收據編號、付款人...">
                                        <button class="btn btn-outline-secondary" type="button" onclick="ReceiptsPage.applyFilters()">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 收據表格 -->
                            <div class="table-responsive">
                                <table class="table table-hover table-striped">
                                    <thead>
                                        <tr>
                                            <th>收據編號</th>
                                            <th>日期</th>
                                            <th>付款人</th>
                                            <th>收款項目</th>
                                            <th>金額</th>
                                            <th>狀態</th>
                                            <th>郵件狀態</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${(data.receipts || []).map(r => `
                                            <tr>
                                                <td>${r.收據編號}</td>
                                                <td>${Utils.formatDate(r.日期)}</td>
                                                <td>${r.付款人}</td>
                                                <td>${r.收款項目}</td>
                                                <td class="text-end">NT$ ${Utils.formatNumber(r.金額)}</td>
                                                <td>
                                                    <span class="badge ${r.狀態 === '已開立' ? 'bg-success' : r.狀態 === '草稿' ? 'bg-warning text-dark' : 'bg-danger'}">
                                                        ${r.狀態}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge ${r.郵件狀態 === '已寄送' ? 'bg-success' : r.郵件狀態 === '不需寄送' ? 'bg-secondary' : r.郵件狀態 === '寄送失敗' ? 'bg-danger' : 'bg-warning text-dark'}">
                                                        ${r.郵件狀態}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary" onclick="ReceiptsPage.viewReceipt('${r.收據編號}')">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button class="btn btn-outline-success" onclick="ReceiptsPage.sendReceiptEmail('${r.收據編號}')">
                                                            <i class="fas fa-envelope"></i>
                                                        </button>
                                                        <button class="btn btn-outline-secondary" onclick="ReceiptsPage.downloadReceipt('${r.收據編號}')">
                                                            <i class="fas fa-download"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- 分頁 -->
                            ${this.renderPagination(data.pagination)}
                        </div>
                    </div>
                `;
                
                document.getElementById('pageContent').innerHTML = html;
                this.bindEvents();
            }
            
            static renderPagination(pagination) {
                if (!pagination || pagination.totalPages <= 1) return '';
                
                const currentPage = pagination.page;
                const totalPages = pagination.totalPages;
                let paginationHtml = '<nav aria-label="Page navigation" class="mt-3"><ul class="pagination justify-content-center">';
                
                // 上一頁
                paginationHtml += `
                    <li class="page-item ${currentPage <= 1 ? 'disabled' : ''}">
                        <button class="page-link" onclick="ReceiptsPage.changePage(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''}>
                            上一頁
                        </button>
                    </li>
                `;
                
                // 頁碼
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, currentPage + 2);
                
                for (let i = startPage; i <= endPage; i++) {
                    paginationHtml += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <button class="page-link" onclick="ReceiptsPage.changePage(${i})">${i}</button>
                        </li>
                    `;
                }
                
                // 下一頁
                paginationHtml += `
                    <li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
                        <button class="page-link" onclick="ReceiptsPage.changePage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>
                            下一頁
                        </button>
                    </li>
                `;
                
                paginationHtml += '</ul></nav>';
                return paginationHtml;
            }
            
            static bindEvents() {
                // 綁定篩選事件
                document.getElementById('statusFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('categoryFilter').addEventListener('change', () => this.applyFilters());
                
                // 搜尋框 Enter 鍵
                document.getElementById('searchFilter').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.applyFilters();
                    }
                });
            }
            
            static applyFilters() {
                this.currentFilters = {
                    page: 1,
                    limit: 20,
                    search: document.getElementById('searchFilter').value,
                    status: document.getElementById('statusFilter').value,
                    category: document.getElementById('categoryFilter').value
                };
                
                this.render();
            }
            
            static changePage(page) {
                this.currentFilters.page = page;
                this.render();
            }
            
            static showNewReceiptForm() {
                this.renderReceiptForm();
            }
            
            static viewReceipt(receiptNumber) {
                // 這裡應該顯示收據詳情
                Utils.showToast('資訊', '查看收據: ' + receiptNumber, 'info');
            }
            
            static async sendReceiptEmail(receiptNumber) {
                const email = prompt('請輸入收件人電子郵件地址:');
                if (!email) return;
                
                try {
                    Utils.showLoading();
                    const response = await ApiManager.sendReceiptEmail(receiptNumber, email, '收據寄送');
                    
                    if (response.success) {
                        Utils.showToast('成功', '收據已發送至 ' + email, 'success');
                        this.render();
                    } else {
                        Utils.showToast('錯誤', '發送失敗: ' + response.error, 'danger');
                    }
                } catch (error) {
                    Utils.showToast('錯誤', '發送失敗: ' + error.message, 'danger');
                } finally {
                    Utils.hideLoading();
                }
            }
            
            static downloadReceipt(receiptNumber) {
                Utils.showToast('資訊', '下載收據: ' + receiptNumber, 'info');
            }
            
            static renderReceiptForm() {
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">開立收據</h5>
                        </div>
                        <div class="card-body">
                            <form id="receiptForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="receiptDate" class="form-label">收據日期 <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="receiptDate" name="date" required 
                                               value="${Utils.formatDateForInput(new Date())}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="receiptNumber" class="form-label">收據編號</label>
                                        <input type="text" class="form-control" id="receiptNumber" name="receiptNumber" 
                                               placeholder="系統自動產生" readonly>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="payerName" class="form-label">付款人姓名 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="payerName" name="payerName" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="payerPhone" class="form-label">聯絡電話</label>
                                        <input type="tel" class="form-control" id="payerPhone" name="payerPhone">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="payerEmail" class="form-label">電子郵件</label>
                                    <input type="email" class="form-control" id="payerEmail" name="payerEmail" 
                                           placeholder="用於寄送電子收據">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="payerAddress" class="form-label">地址</label>
                                    <textarea class="form-control" id="payerAddress" name="payerAddress" rows="2"></textarea>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="receiptCategory" class="form-label">收款項目 <span class="text-danger">*</span></label>
                                        <select class="form-select" id="receiptCategory" name="category" required>
                                            <option value="">請選擇收款項目</option>
                                            <option value="會費">會費</option>
                                            <option value="捐款">捐款</option>
                                            <option value="活動收入">活動收入</option>
                                            <option value="專案收入">專案收入</option>
                                            <option value="其他收入">其他收入</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="receiptAmount" class="form-label">金額 <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text">NT$</span>
                                            <input type="number" class="form-control" id="receiptAmount" name="amount" 
                                                   min="0" step="1" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="receiptDescription" class="form-label">備註</label>
                                    <textarea class="form-control" id="receiptDescription" name="description" rows="3"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sendEmail" name="sendEmail" value="1">
                                        <label class="form-check-label" for="sendEmail">
                                            開立後自動寄送電子收據
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" onclick="ReceiptsPage.render()">取消</button>
                                    <div>
                                        <button type="button" class="btn btn-outline-primary me-2" onclick="ReceiptsPage.saveReceiptDraft()">儲存草稿</button>
                                        <button type="submit" class="btn btn-primary">開立收據</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.getElementById('pageContent').innerHTML = html;
                this.bindReceiptFormEvents();
            }
            
            static bindReceiptFormEvents() {
                // 表單提交處理
                document.getElementById('receiptForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(e.target);
                    const receiptData = Object.fromEntries(formData.entries());
                    receiptData.status = '已開立';
                    
                    try {
                        Utils.showLoading();
                        const response = await ApiManager.generateReceipt(receiptData);
                        
                        if (response.success) {
                            Utils.showToast('成功', '收據已開立，編號: ' + response.data.receiptNumber, 'success');
                            ReceiptsPage.render();
                        } else {
                            Utils.showToast('錯誤', '開立失敗: ' + response.error, 'danger');
                        }
                    } catch (error) {
                        Utils.showToast('錯誤', '開立失敗: ' + error.message, 'danger');
                    } finally {
                        Utils.hideLoading();
                    }
                });
            }
            
            static async saveReceiptDraft() {
                const formData = new FormData(document.getElementById('receiptForm'));
                const receiptData = Object.fromEntries(formData.entries());
                receiptData.status = '草稿';
                
                try {
                    Utils.showLoading();
                    const response = await ApiManager.generateReceipt(receiptData);
                    
                    if (response.success) {
                        Utils.showToast('成功', '草稿已儲存', 'success');
                        ReceiptsPage.render();
                    } else {
                        Utils.showToast('錯誤', '儲存失敗: ' + response.error, 'danger');
                    }
                } catch (error) {
                    Utils.showToast('錯誤', '儲存失敗: ' + error.message, 'danger');
                } finally {
                    Utils.hideLoading();
                }
            }
        }
        
        // ========================================
        // 支出憑證頁面
        // ========================================
        
        class VouchersPage {
            static async render() {
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">支出憑證管理</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                支出憑證功能開發中，敬請期待...
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('pageContent').innerHTML = html;
            }
        }
        
        // ========================================
        // 人員管理頁面
        // ========================================
        
        class MembersPage {
            static currentFilters = {
                page: 1,
                limit: 20,
                search: '',
                status: '',
                type: ''
            };
            
            static async render() {
                try {
                    const response = await ApiManager.getMembers(this.currentFilters);
                    
                    if (!response.success) {
                        throw new Error(response.error);
                    }
                    
                    this.renderMembersList(response.data);
                } catch (error) {
                    document.getElementById('pageContent').innerHTML = 
                        '<div class="alert alert-danger">載入會員資料失敗: ' + error.message + '</div>';
                }
            }
            
            static renderMembersList(data) {
                const html = `
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>人員管理</span>
                            <button class="btn btn-primary btn-sm" onclick="MembersPage.showNewMemberForm()">
                                <i class="fas fa-plus"></i> 新增會員
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- 篩選工具 -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="statusFilter">
                                        <option value="">所有狀態</option>
                                        <option value="正式會員" ${this.currentFilters.status === '正式會員' ? 'selected' : ''}>正式會員</option>
                                        <option value="預備會員" ${this.currentFilters.status === '預備會員' ? 'selected' : ''}>預備會員</option>
                                        <option value="停權" ${this.currentFilters.status === '停權' ? 'selected' : ''}>停權</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="typeFilter">
                                        <option value="">所有類型</option>
                                        <option value="病友" ${this.currentFilters.type === '病友' ? 'selected' : ''}>病友</option>
                                        <option value="家屬" ${this.currentFilters.type === '家屬' ? 'selected' : ''}>家屬</option>
                                        <option value="志工" ${this.currentFilters.type === '志工' ? 'selected' : ''}>志工</option>
                                        <option value="醫護人員" ${this.currentFilters.type === '醫護人員' ? 'selected' : ''}>醫護人員</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" id="searchFilter" 
                                               value="${this.currentFilters.search}" placeholder="搜尋姓名、電話、電子郵件...">
                                        <button class="btn btn-outline-secondary" type="button" onclick="MembersPage.applyFilters()">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 會員表格 -->
                            <div class="table-responsive">
                                <table class="table table-hover table-striped">
                                    <thead>
                                        <tr>
                                            <th>姓名</th>
                                            <th>電話</th>
                                            <th>電子郵件</th>
                                            <th>會員類型</th>
                                            <th>狀態</th>
                                            <th>加入日期</th>
                                            <th>最後繳費</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${(data.members || []).map(m => `
                                            <tr>
                                                <td>${m.姓名}</td>
                                                <td>${m.電話 || ''}</td>
                                                <td>${m.電子郵件 || ''}</td>
                                                <td>
                                                    <span class="badge bg-info">
                                                        ${m.會員類型}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge ${m.狀態 === '正式會員' ? 'bg-success' : m.狀態 === '預備會員' ? 'bg-warning text-dark' : 'bg-danger'}">
                                                        ${m.狀態}
                                                    </span>
                                                </td>
                                                <td>${Utils.formatDate(m.加入日期)}</td>
                                                <td>${Utils.formatDate(m.最後繳費日期)}</td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary" onclick="MembersPage.editMember(${m.id})">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-outline-info" onclick="MembersPage.viewMemberHistory(${m.id})">
                                                            <i class="fas fa-history"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- 分頁 -->
                            ${this.renderPagination(data.pagination)}
                        </div>
                    </div>
                `;
                
                document.getElementById('pageContent').innerHTML = html;
                this.bindEvents();
            }
            
            static renderPagination(pagination) {
                if (!pagination || pagination.totalPages <= 1) return '';
                
                const currentPage = pagination.page;
                const totalPages = pagination.totalPages;
                let paginationHtml = '<nav aria-label="Page navigation" class="mt-3"><ul class="pagination justify-content-center">';
                
                // 上一頁
                paginationHtml += `
                    <li class="page-item ${currentPage <= 1 ? 'disabled' : ''}">
                        <button class="page-link" onclick="MembersPage.changePage(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''}>
                            上一頁
                        </button>
                    </li>
                `;
                
                // 頁碼
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, currentPage + 2);
                
                for (let i = startPage; i <= endPage; i++) {
                    paginationHtml += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <button class="page-link" onclick="MembersPage.changePage(${i})">${i}</button>
                        </li>
                    `;
                }
                
                // 下一頁
                paginationHtml += `
                    <li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
                        <button class="page-link" onclick="MembersPage.changePage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>
                            下一頁
                        </button>
                    </li>
                `;
                
                paginationHtml += '</ul></nav>';
                return paginationHtml;
            }
            
            static bindEvents() {
                // 綁定篩選事件
                document.getElementById('statusFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('typeFilter').addEventListener('change', () => this.applyFilters());
                
                // 搜尋框 Enter 鍵
                document.getElementById('searchFilter').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.applyFilters();
                    }
                });
            }
            
            static applyFilters() {
                this.currentFilters = {
                    page: 1,
                    limit: 20,
                    search: document.getElementById('searchFilter').value,
                    status: document.getElementById('statusFilter').value,
                    type: document.getElementById('typeFilter').value
                };
                
                this.render();
            }
            
            static changePage(page) {
                this.currentFilters.page = page;
                this.render();
            }
            
            static showNewMemberForm() {
                this.renderMemberForm();
            }
            
            static editMember(id) {
                this.renderMemberForm(id);
            }
            
            static viewMemberHistory(id) {
                Utils.showToast('資訊', '查看會員歷史記錄: ' + id, 'info');
            }
            
            static renderMemberForm(id = null) {
                const isEdit = id !== null;
                const title = isEdit ? '編輯會員' : '新增會員';
                
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">${title}</h5>
                        </div>
                        <div class="card-body">
                            <form id="memberForm">
                                ${isEdit ? `<input type="hidden" name="id" value="${id}">` : ''}
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="memberName" class="form-label">姓名 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="memberName" name="name" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="memberPhone" class="form-label">電話 <span class="text-danger">*</span></label>
                                        <input type="tel" class="form-control" id="memberPhone" name="phone" required>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="memberEmail" class="form-label">電子郵件</label>
                                        <input type="email" class="form-control" id="memberEmail" name="email">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="memberBirthDate" class="form-label">生日</label>
                                        <input type="date" class="form-control" id="memberBirthDate" name="birthDate">
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="memberType" class="form-label">會員類型 <span class="text-danger">*</span></label>
                                        <select class="form-select" id="memberType" name="type" required>
                                            <option value="">請選擇類型</option>
                                            <option value="病友">病友</option>
                                            <option value="家屬">家屬</option>
                                            <option value="志工">志工</option>
                                            <option value="醫護人員">醫護人員</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="memberStatus" class="form-label">狀態 <span class="text-danger">*</span></label>
                                        <select class="form-select" id="memberStatus" name="status" required>
                                            <option value="預備會員" selected>預備會員</option>
                                            <option value="正式會員">正式會員</option>
                                            <option value="停權">停權</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="memberAddress" class="form-label">地址</label>
                                    <textarea class="form-control" id="memberAddress" name="address" rows="2"></textarea>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="joinDate" class="form-label">加入日期 <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="joinDate" name="joinDate" required 
                                               value="${Utils.formatDateForInput(new Date())}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="emergencyContact" class="form-label">緊急聯絡人</label>
                                        <input type="text" class="form-control" id="emergencyContact" name="emergencyContact">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="memberNotes" class="form-label">備註</label>
                                    <textarea class="form-control" id="memberNotes" name="notes" rows="3"></textarea>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" onclick="MembersPage.render()">取消</button>
                                    <button type="submit" class="btn btn-primary">儲存</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.getElementById('pageContent').innerHTML = html;
                this.bindMemberFormEvents();
            }
            
            static bindMemberFormEvents() {
                // 表單提交處理
                document.getElementById('memberForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(e.target);
                    const memberData = Object.fromEntries(formData.entries());
                    
                    try {
                        Utils.showLoading();
                        
                        const isEdit = memberData.id;
                        const response = isEdit ? 
                            await ApiManager.updateMember(memberData) :
                            await ApiManager.addMember(memberData);
                        
                        if (response.success) {
                            Utils.showToast('成功', isEdit ? '會員資料已更新' : '會員已新增', 'success');
                            MembersPage.render();
                        } else {
                            Utils.showToast('錯誤', '儲存失敗: ' + response.error, 'danger');
                        }
                    } catch (error) {
                        Utils.showToast('錯誤', '儲存失敗: ' + error.message, 'danger');
                    } finally {
                        Utils.hideLoading();
                    }
                });
            }
        }
        
        // ========================================
        // 財務報表頁面
        // ========================================
        
        class ReportsPage {
            static async render() {
                const html = `
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">財務報表</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-3">
                                            <label for="reportType" class="form-label">報表類型</label>
                                            <select class="form-select" id="reportType">
                                                <option value="monthly">月度報表</option>
                                                <option value="yearly">年度報表</option>
                                                <option value="custom">自訂期間</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="reportYear" class="form-label">年份</label>
                                            <select class="form-select" id="reportYear">
                                                ${this.generateYearOptions()}
                                            </select>
                                        </div>
                                        <div class="col-md-3" id="monthSelector">
                                            <label for="reportMonth" class="form-label">月份</label>
                                            <select class="form-select" id="reportMonth">
                                                ${this.generateMonthOptions()}
                                            </select>
                                        </div>
                                        <div class="col-md-3 d-flex align-items-end">
                                            <button class="btn btn-primary" onclick="ReportsPage.generateReport()">
                                                <i class="fas fa-chart-bar"></i> 產生報表
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="reportContent">
                                        <div class="text-center text-muted py-5">
                                            <i class="fas fa-chart-line fa-3x mb-3"></i>
                                            <p>請選擇報表類型並點擊「產生報表」</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('pageContent').innerHTML = html;
                this.bindEvents();
            }
            
            static generateYearOptions() {
                const currentYear = new Date().getFullYear();
                let options = '';
                for (let year = currentYear; year >= currentYear - 5; year--) {
                    options += `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`;
                }
                return options;
            }
            
            static generateMonthOptions() {
                const months = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
                const currentMonth = new Date().getMonth() + 1;
                let options = '';
                months.forEach((month, index) => {
                    const value = index + 1;
                    options += `<option value="${value}" ${value === currentMonth ? 'selected' : ''}>${month}</option>`;
                });
                return options;
            }
            
            static bindEvents() {
                document.getElementById('reportType').addEventListener('change', function() {
                    const monthSelector = document.getElementById('monthSelector');
                    if (this.value === 'yearly') {
                        monthSelector.style.display = 'none';
                    } else {
                        monthSelector.style.display = 'block';
                    }
                });
            }
            
            static async generateReport() {
                const reportType = document.getElementById('reportType').value;
                const year = document.getElementById('reportYear').value;
                const month = document.getElementById('reportMonth').value;
                
                Utils.showLoading();
                
                try {
                    // 模擬報表生成
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const reportContent = this.generateReportContent(reportType, year, month);
                    document.getElementById('reportContent').innerHTML = reportContent;
                } catch (error) {
                    Utils.showToast('錯誤', '產生報表失敗: ' + error.message, 'danger');
                } finally {
                    Utils.hideLoading();
                }
            }
            
            static generateReportContent(type, year, month) {
                const title = type === 'monthly' ? `${year}年${month}月財務報表` : `${year}年度財務報表`;
                
                return `
                    <div class="report-content">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>${title}</h4>
                            <div>
                                <button class="btn btn-outline-secondary btn-sm me-2" onclick="ReportsPage.exportReport('pdf')">
                                    <i class="fas fa-file-pdf"></i> 匯出PDF
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="ReportsPage.exportReport('excel')">
                                    <i class="fas fa-file-excel"></i> 匯出Excel
                                </button>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="stat-card income">
                                    <div class="stat-title">總收入</div>
                                    <div class="stat-value">NT$ 150,000</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-card expense">
                                    <div class="stat-title">總支出</div>
                                    <div class="stat-value">NT$ 120,000</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-card balance">
                                    <div class="stat-title">淨收支</div>
                                    <div class="stat-value">NT$ 30,000</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <span>收入明細</span>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>項目</th>
                                                    <th class="text-end">金額</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>會費收入</td>
                                                    <td class="text-end">NT$ 80,000</td>
                                                </tr>
                                                <tr>
                                                    <td>捐款收入</td>
                                                    <td class="text-end">NT$ 45,000</td>
                                                </tr>
                                                <tr>
                                                    <td>活動收入</td>
                                                    <td class="text-end">NT$ 20,000</td>
                                                </tr>
                                                <tr>
                                                    <td>其他收入</td>
                                                    <td class="text-end">NT$ 5,000</td>
                                                </tr>
                                                <tr class="table-primary fw-bold">
                                                    <td>小計</td>
                                                    <td class="text-end">NT$ 150,000</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <span>支出明細</span>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>項目</th>
                                                    <th class="text-end">金額</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>行政費用</td>
                                                    <td class="text-end">NT$ 40,000</td>
                                                </tr>
                                                <tr>
                                                    <td>活動費用</td>
                                                    <td class="text-end">NT$ 50,000</td>
                                                </tr>
                                                <tr>
                                                    <td>人事費用</td>
                                                    <td class="text-end">NT$ 25,000</td>
                                                </tr>
                                                <tr>
                                                    <td>其他費用</td>
                                                    <td class="text-end">NT$ 5,000</td>
                                                </tr>
                                                <tr class="table-danger fw-bold">
                                                    <td>小計</td>
                                                    <td class="text-end">NT$ 120,000</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            static exportReport(format) {
                Utils.showToast('資訊', `匯出${format.toUpperCase()}報表功能開發中`, 'info');
            }
        }
        
        // ========================================
        // 系統設定頁面
        // ========================================
        
        class SettingsPage {
            static async render() {
                try {
                    const response = await ApiManager.getSystemSettings();
                    
                    if (!response.success) {
                        throw new Error(response.error);
                    }
                    
                    this.renderSettings(response.data);
                } catch (error) {
                    document.getElementById('pageContent').innerHTML = 
                        '<div class="alert alert-danger">載入系統設定失敗: ' + error.message + '</div>';
                }
            }
            
            static renderSettings(settings) {
                const html = `
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">組織基本資訊</h5>
                                </div>
                                <div class="card-body">
                                    <form id="organizationForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="orgName" class="form-label">組織名稱</label>
                                                <input type="text" class="form-control" id="orgName" name="orgName" 
                                                       value="${settings.organization?.name || CONFIG.ORGANIZATION.name}">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="orgEnglishName" class="form-label">英文名稱</label>
                                                <input type="text" class="form-control" id="orgEnglishName" name="orgEnglishName" 
                                                       value="${settings.organization?.englishName || CONFIG.ORGANIZATION.englishName}">
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="orgPhone" class="form-label">聯絡電話</label>
                                                <input type="tel" class="form-control" id="orgPhone" name="orgPhone" 
                                                       value="${settings.organization?.phone || ''}">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="orgEmail" class="form-label">電子郵件</label>
                                                <input type="email" class="form-control" id="orgEmail" name="orgEmail" 
                                                       value="${settings.organization?.email || ''}">
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="orgAddress" class="form-label">地址</label>
                                            <textarea class="form-control" id="orgAddress" name="orgAddress" rows="2">${settings.organization?.address || ''}</textarea>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="orgTaxId" class="form-label">統一編號</label>
                                                <input type="text" class="form-control" id="orgTaxId" name="orgTaxId" 
                                                       value="${settings.organization?.taxId || ''}">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="orgBankAccount" class="form-label">銀行帳號</label>
                                                <input type="text" class="form-control" id="orgBankAccount" name="orgBankAccount" 
                                                       value="${settings.organization?.bankAccount || ''}">
                                            </div>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">儲存設定</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5 class="mb-0">收據設定</h5>
                                </div>
                                <div class="card-body">
                                    <form id="receiptSettingsForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="receiptPrefix" class="form-label">收據編號前綴</label>
                                                <input type="text" class="form-control" id="receiptPrefix" name="receiptPrefix" 
                                                       value="${settings.receipt?.prefix || 'R'}">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="receiptStartNumber" class="form-label">起始編號</label>
                                                <input type="number" class="form-control" id="receiptStartNumber" name="receiptStartNumber" 
                                                       value="${settings.receipt?.startNumber || 1}">
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="autoSendEmail" name="autoSendEmail" 
                                                       ${settings.receipt?.autoSendEmail ? 'checked' : ''}>
                                                <label class="form-check-label" for="autoSendEmail">
                                                    自動寄送電子收據
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">儲存設定</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">系統資訊</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <td>系統版本</td>
                                            <td>${CONFIG.VERSION}</td>
                                        </tr>
                                        <tr>
                                            <td>資料庫狀態</td>
                                            <td><span class="badge bg-success">正常</span></td>
                                        </tr>
                                        <tr>
                                            <td>最後備份</td>
                                            <td>${Utils.formatDate(new Date())}</td>
                                        </tr>
                                        <tr>
                                            <td>總交易記錄</td>
                                            <td>${settings.stats?.totalTransactions || 0}</td>
                                        </tr>
                                        <tr>
                                            <td>總會員數</td>
                                            <td>${settings.stats?.totalMembers || 0}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="mb-0">系統維護</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" onclick="SettingsPage.backupData()">
                                            <i class="fas fa-download"></i> 備份資料
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="SettingsPage.clearCache()">
                                            <i class="fas fa-broom"></i> 清除快取
                                        </button>
                                        <button class="btn btn-outline-info" onclick="SettingsPage.checkUpdates()">
                                            <i class="fas fa-sync-alt"></i> 檢查更新
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="SettingsPage.resetSystem()">
                                            <i class="fas fa-exclamation-triangle"></i> 重置系統
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('pageContent').innerHTML = html;
                this.bindEvents();
            }
            
            static bindEvents() {
                // 組織資訊表單
                document.getElementById('organizationForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(e.target);
                    const organizationData = Object.fromEntries(formData.entries());
                    
                    try {
                        Utils.showLoading();
                        // 這裡應該調用 API 儲存設定
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        Utils.showToast('成功', '組織資訊已更新', 'success');
                    } catch (error) {
                        Utils.showToast('錯誤', '更新失敗: ' + error.message, 'danger');
                    } finally {
                        Utils.hideLoading();
                    }
                });
                
                // 收據設定表單
                document.getElementById('receiptSettingsForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(e.target);
                    const receiptSettings = Object.fromEntries(formData.entries());
                    
                    try {
                        Utils.showLoading();
                        // 這裡應該調用 API 儲存設定
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        Utils.showToast('成功', '收據設定已更新', 'success');
                    } catch (error) {
                        Utils.showToast('錯誤', '更新失敗: ' + error.message, 'danger');
                    } finally {
                        Utils.hideLoading();
                    }
                });
            }
            
            static async backupData() {
                if (!confirm('確定要備份資料嗎？這可能需要一些時間。')) {
                    return;
                }
                
                try {
                    Utils.showLoading();
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    Utils.showToast('成功', '資料備份完成', 'success');
                } catch (error) {
                    Utils.showToast('錯誤', '備份失敗: ' + error.message, 'danger');
                } finally {
                    Utils.hideLoading();
                }
            }
            
            static async clearCache() {
                try {
                    Utils.showLoading();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    Utils.showToast('成功', '快取已清除', 'success');
                } catch (error) {
                    Utils.showToast('錯誤', '清除失敗: ' + error.message, 'danger');
                } finally {
                    Utils.hideLoading();
                }
            }
            
            static async checkUpdates() {
                try {
                    Utils.showLoading();
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    Utils.showToast('資訊', '系統已是最新版本', 'info');
                } catch (error) {
                    Utils.showToast('錯誤', '檢查更新失敗: ' + error.message, 'danger');
                } finally {
                    Utils.hideLoading();
                }
            }
            
            static async resetSystem() {
                if (!confirm('警告：此操作將重置所有系統設定，但不會刪除資料。確定要繼續嗎？')) {
                    return;
                }
                
                const confirmText = prompt('請輸入 "RESET" 確認重置：');
                if (confirmText !== 'RESET') {
                    Utils.showToast('資訊', '重置操作已取消', 'info');
                    return;
                }
                
                try {
                    Utils.showLoading();
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    Utils.showToast('成功', '系統設定已重置', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } catch (error) {
                    Utils.showToast('錯誤', '重置失敗: ' + error.message, 'danger');
                } finally {
                    Utils.hideLoading();
                }
            }
        }
        
        // ========================================
        // 應用程式初始化
        // ========================================
        
        class App {
            static async initialize() {
                try {
                    // 初始化系統
                    await this.initializeSystem();
                    
                    // 綁定事件
                    this.bindEvents();
                    
                    // 載入預設頁面
                    await PageManager.loadPage('dashboard');
                    
                    Utils.showToast('歡迎', '系統載入完成', 'success');
                } catch (error) {
                    console.error('系統初始化失敗:', error);
                    Utils.showToast('錯誤', '系統初始化失敗: ' + error.message, 'danger');
                }
            }
            
            static async initializeSystem() {
                try {
                    const response = await ApiManager.initializeSystem();
                    if (response.success) {
                        systemSettings = response.data.settings || {};
                        currentUser = response.data.user || { name: '管理員' };
                        
                        // 更新 UI
                        document.getElementById('orgName').textContent = 
                            systemSettings.organization?.name || CONFIG.ORGANIZATION.name;
                        document.getElementById('userInfo').textContent = currentUser.name;
                        document.getElementById('systemVersion').textContent = 
                            '版本: ' + CONFIG.VERSION;
                    }
                } catch (error) {
                    console.warn('系統初始化 API 呼叫失敗，使用預設設定:', error);
                    // 使用預設設定
                    systemSettings = {};
                    currentUser = { name: '管理員' };
                }
            }
            
            static bindEvents() {
                // 側邊欄切換
                document.getElementById('toggleSidebar').addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar');
                    const mainContent = document.getElementById('mainContent');
                    
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('expanded');
                });
                
                // 導航選單點擊
                document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = link.getAttribute('data-page');
                        if (page) {
                            PageManager.loadPage(page);
                        }
                    });
                });
                
                // 重新整理按鈕
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    PageManager.loadPage(currentPage);
                });
                
                // 新增按鈕下拉選單
                document.querySelectorAll('[data-action]').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const action = item.getAttribute('data-action');
                        this.handleQuickAction(action);
                    });
                });
                
                // 鍵盤快捷鍵
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 'r':
                                e.preventDefault();
                                PageManager.loadPage(currentPage);
                                break;
                            case 'n':
                                e.preventDefault();
                                this.handleQuickAction('new-transaction');
                                break;
                        }
                    }
                });
                
                // 視窗大小改變時調整佈局
                window.addEventListener('resize', () => {
                    this.adjustLayout();
                });
            }
            
            static handleQuickAction(action) {
                switch (action) {
                    case 'new-transaction':
                        PageManager.loadPage('transactions');
                        setTimeout(() => TransactionsPage.showNewTransactionForm(), 100);
                        break;
                    case 'new-receipt':
                        PageManager.loadPage('receipts');
                        setTimeout(() => ReceiptsPage.showNewReceiptForm(), 100);
                        break;
                    case 'new-voucher':
                        PageManager.loadPage('vouchers');
                        break;
                    case 'new-member':
                        PageManager.loadPage('members');
                        setTimeout(() => MembersPage.showNewMemberForm(), 100);
                        break;
                }
            }
            
            static adjustLayout() {
                // 響應式佈局調整
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('mainContent');
                
                if (window.innerWidth < 768) {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('expanded');
                } else if (window.innerWidth >= 1200) {
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('expanded');
                }
            }
        }
        
        // ========================================
        // 頁面載入完成後初始化
        // ========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            App.initialize();
        });
        
        // ========================================
        // 全域錯誤處理
        // ========================================
        
        window.addEventListener('error', (e) => {
            console.error('全域錯誤:', e.error);
            Utils.showToast('系統錯誤', '發生未預期的錯誤，請重新整理頁面', 'danger');
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('未處理的 Promise 拒絕:', e.reason);
            Utils.showToast('系統錯誤', '發生未預期的錯誤，請重新整理頁面', 'danger');
        });
        
        // ========================================
        // Service Worker 註冊 (PWA 支援)
        // ========================================
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker 註冊成功:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker 註冊失敗:', error);
                    });
            });
        }
    </script>
</body>
</html>


