<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友會管理系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root {
      --primary-color: #00B900;
      --secondary-color: #06C755;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #0dcaf0;
      --dark-color: #212529;
      --light-color: #f8f9fa;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      padding-bottom: 80px;
    }
    
    .navbar {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .navbar-brand {
      font-weight: bold;
      color: white !important;
    }
    
    .nav-link {
      color: rgba(255,255,255,0.9) !important;
      transition: all 0.3s;
    }
    
    .nav-link:hover, .nav-link.active {
      color: white !important;
      background-color: rgba(255,255,255,0.2);
      border-radius: 5px;
    }
    
    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      transition: transform 0.3s;
    }
    
    .card:hover {
      transform: translateY(-5px);
    }
    
    .card-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border-radius: 15px 15px 0 0 !important;
      font-weight: bold;
      padding: 15px 20px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none;
      border-radius: 25px;
      padding: 10px 25px;
      transition: all 0.3s;
    }
    
    .btn-primary:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0,185,0,0.3);
    }
    
    .stat-card {
      text-align: center;
      padding: 20px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .stat-icon {
      font-size: 3rem;
      margin-bottom: 10px;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
    }
    
    .activity-item {
      padding: 15px;
      border-left: 4px solid var(--primary-color);
      background: white;
      margin-bottom: 10px;
      border-radius: 5px;
      transition: all 0.3s;
    }
    
    .activity-item:hover {
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transform: translateX(5px);
    }
    
    .badge-status {
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.85rem;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      padding: 10px 0;
      z-index: 1000;
    }
    
    .bottom-nav-item {
      text-align: center;
      color: #6c757d;
      text-decoration: none;
      display: block;
      padding: 5px;
      transition: all 0.3s;
    }
    
    .bottom-nav-item:hover, .bottom-nav-item.active {
      color: var(--primary-color);
    }
    
    .bottom-nav-item i {
      font-size: 1.5rem;
      display: block;
      margin-bottom: 5px;
    }
    
    .bottom-nav-item span {
      font-size: 0.75rem;
    }
    
    .modal-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
    }
    
    .form-label {
      font-weight: 600;
      color: #495057;
    }
    
    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(0, 185, 0, 0.25);
    }
    
    .alert {
      border-radius: 10px;
      border: none;
    }
    
    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 4px solid var(--primary-color);
      margin: 0 auto 15px;
      display: block;
    }
    
    .info-row {
      padding: 10px 0;
      border-bottom: 1px solid #e9ecef;
    }
    
    .info-label {
      font-weight: 600;
      color: #6c757d;
      width: 120px;
      display: inline-block;
    }
    
    .info-value {
      color: #212529;
    }
  </style>
</head>
<body>
  <!-- 導航列 -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="bi bi-heart-pulse"></i> 帕金森病友會
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="#" id="userNameDisplay"></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="liff.logout(); location.reload();">
              <i class="bi bi-box-arrow-right"></i> 登出
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- 主要內容 -->
  <div class="container mt-4" id="mainContent">
    <!-- 載入中 -->
    <div id="loadingScreen" class="loading">
      <div class="spinner"></div>
      <p class="mt-3">載入中...</p>
    </div>

    <!-- 儀表板頁面 -->
    <div id="dashboardPage" style="display:none;">
      <h2 class="mb-4"><i class="bi bi-speedometer2"></i> 儀表板</h2>
      
      <!-- 統計卡片 -->
      <div class="row" id="statsCards">
        <div class="col-md-4">
          <div class="stat-card">
            <i class="bi bi-calendar-event stat-icon text-primary"></i>
            <div class="stat-value" id="myRegistrationsCount">0</div>
            <div class="stat-label">我的報名</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card">
            <i class="bi bi-clock-history stat-icon text-success"></i>
            <div class="stat-value" id="myVolunteerHours">0</div>
            <div class="stat-label">志工時數</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card">
            <i class="bi bi-star stat-icon text-warning"></i>
            <div class="stat-value" id="memberLevel">一般會員</div>
            <div class="stat-label">會員等級</div>
          </div>
        </div>
      </div>

      <!-- 即將到來的活動 -->
      <div class="card">
        <div class="card-header">
          <i class="bi bi-calendar-check"></i> 即將到來的活動
        </div>
        <div class="card-body" id="upcomingActivitiesList">
          <p class="text-muted">載入中...</p>
        </div>
      </div>

      <!-- 我的最近報名 -->
      <div class="card">
        <div class="card-header">
          <i class="bi bi-list-check"></i> 我的最近報名
        </div>
        <div class="card-body" id="myRecentRegistrations">
          <p class="text-muted">載入中...</p>
        </div>
      </div>
    </div>

    <!-- 活動頁面 -->
    <div id="activitiesPage" style="display:none;">
      <h2 class="mb-4"><i class="bi bi-calendar-event"></i> 活動列表</h2>
      
      <!-- 搜尋和篩選 -->
      <div class="card mb-3">
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <input type="text" class="form-control" id="activitySearch" placeholder="搜尋活動...">
            </div>
            <div class="col-md-4">
              <select class="form-select" id="activityStatusFilter">
                <option value="">所有狀態</option>
                <option value="報名中">報名中</option>
                <option value="即將開始">即將開始</option>
                <option value="進行中">進行中</option>
                <option value="已結束">已結束</option>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary w-100" onclick="searchActivities()">
                <i class="bi bi-search"></i> 搜尋
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 活動列表 -->
      <div id="activitiesList">
        <p class="text-muted">載入中...</p>
      </div>
    </div>

    <!-- 我的報名頁面 -->
    <div id="myRegistrationsPage" style="display:none;">
      <h2 class="mb-4"><i class="bi bi-list-check"></i> 我的報名</h2>
      
      <div id="myRegistrationsList">
        <p class="text-muted">載入中...</p>
      </div>
    </div>

    <!-- 志工記錄頁面 -->
    <div id="volunteerPage" style="display:none;">
      <h2 class="mb-4"><i class="bi bi-heart"></i> 志工記錄</h2>
      
      <!-- 志工統計 -->
      <div class="card mb-3">
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6">
              <h3 class="text-primary" id="totalVolunteerHours">0</h3>
              <p class="text-muted">總服務時數</p>
            </div>
            <div class="col-6">
              <h3 class="text-success" id="totalVolunteerRecords">0</h3>
              <p class="text-muted">服務次數</p>
            </div>
          </div>
        </div>
      </div>

      <button class="btn btn-primary mb-3" onclick="showAddVolunteerModal()">
        <i class="bi bi-plus-circle"></i> 新增服務記錄
      </button>

      <!-- 志工記錄列表 -->
      <div id="volunteerRecordsList">
        <p class="text-muted">載入中...</p>
      </div>
    </div>

    <!-- 個人資料頁面 -->
    <div id="profilePage" style="display:none;">
      <h2 class="mb-4"><i class="bi bi-person-circle"></i> 個人資料</h2>
      
      <div class="card">
        <div class="card-body">
          <img id="profileAvatar" class="profile-avatar" src="" alt="頭像">
          
          <div id="profileInfo">
            <p class="text-muted text-center">載入中...</p>
          </div>
          
          <div class="text-center mt-4">
            <button class="btn btn-primary" onclick="showEditProfileModal()">
              <i class="bi bi-pencil"></i> 編輯資料
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 底部導航 -->
  <div class="bottom-nav">
    <div class="container">
      <div class="row">
        <div class="col">
          <a href="#" class="bottom-nav-item active" onclick="showPage('dashboard')">
            <i class="bi bi-speedometer2"></i>
            <span>首頁</span>
          </a>
        </div>
        <div class="col">
          <a href="#" class="bottom-nav-item" onclick="showPage('activities')">
            <i class="bi bi-calendar-event"></i>
            <span>活動</span>
          </a>
        </div>
        <div class="col">
          <a href="#" class="bottom-nav-item" onclick="showPage('myRegistrations')">
            <i class="bi bi-list-check"></i>
            <span>我的報名</span>
          </a>
        </div>
        <div class="col">
          <a href="#" class="bottom-nav-item" onclick="showPage('volunteer')">
            <i class="bi bi-heart"></i>
            <span>志工</span>
          </a>
        </div>
        <div class="col">
          <a href="#" class="bottom-nav-item" onclick="showPage('profile')">
            <i class="bi bi-person-circle"></i>
            <span>我的</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- 會員註冊 Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">會員註冊</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="registerForm">
            <div class="mb-3">
              <label class="form-label">真實姓名 *</label>
              <input type="text" class="form-control" id="regRealName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">性別</label>
              <select class="form-select" id="regGender">
                <option value="">請選擇</option>
                <option value="男">男</option>
                <option value="女">女</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">生日</label>
              <input type="date" class="form-control" id="regBirthday">
            </div>
            <div class="mb-3">
              <label class="form-label">電話 *</label>
              <input type="tel" class="form-control" id="regPhone" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="regEmail">
            </div>
            <div class="mb-3">
              <label class="form-label">地址</label>
              <input type="text" class="form-control" id="regAddress">
            </div>
            <div class="mb-3">
              <label class="form-label">會員類型</label>
              <select class="form-select" id="regMemberType">
                <option value="病友">病友</option>
                <option value="家屬">家屬</option>
                <option value="志工">志工</option>
                <option value="贊助者">贊助者</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">疾病狀態</label>
              <textarea class="form-control" id="regDiseaseStatus" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">緊急聯絡人</label>
              <input type="text" class="form-control" id="regEmergencyContact">
            </div>
            <div class="mb-3">
              <label class="form-label">緊急聯絡電話</label>
              <input type="tel" class="form-control" id="regEmergencyPhone">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitRegister()">註冊</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 編輯資料 Modal -->
  <div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">編輯個人資料</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editProfileForm">
            <input type="hidden" id="editMemberId">
            <div class="mb-3">
              <label class="form-label">真實姓名</label>
              <input type="text" class="form-control" id="editRealName">
            </div>
            <div class="mb-3">
              <label class="form-label">性別</label>
              <select class="form-select" id="editGender">
                <option value="">請選擇</option>
                <option value="男">男</option>
                <option value="女">女</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">生日</label>
              <input type="date" class="form-control" id="editBirthday">
            </div>
            <div class="mb-3">
              <label class="form-label">電話</label>
              <input type="tel" class="form-control" id="editPhone">
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="editEmail">
            </div>
            <div class="mb-3">
              <label class="form-label">地址</label>
              <input type="text" class="form-control" id="editAddress">
            </div>
            <div class="mb-3">
              <label class="form-label">疾病狀態</label>
              <textarea class="form-control" id="editDiseaseStatus" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">緊急聯絡人</label>
              <input type="text" class="form-control" id="editEmergencyContact">
            </div>
            <div class="mb-3">
              <label class="form-label">緊急聯絡電話</label>
              <input type="tel" class="form-control" id="editEmergencyPhone">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitEditProfile()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 活動詳情 Modal -->
  <div class="modal fade" id="activityDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="activityDetailTitle">活動詳情</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="activityDetailContent">
          <p class="text-muted">載入中...</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
          <button type="button" class="btn btn-primary" id="registerActivityBtn" onclick="registerForActivity()">
            <i class="bi bi-check-circle"></i> 立即報名
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 新增志工記錄 Modal -->
  <div class="modal fade" id="addVolunteerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增服務記錄</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addVolunteerForm">
            <div class="mb-3">
              <label class="form-label">服務日期 *</label>
              <input type="date" class="form-control" id="volDate" required>
            </div>
            <div class="mb-3">
              <label class="form-label">服務時數 *</label>
              <input type="number" class="form-control" id="volHours" min="0.5" step="0.5" required>
            </div>
            <div class="mb-3">
              <label class="form-label">服務項目 *</label>
              <input type="text" class="form-control" id="volActivity" required>
            </div>
            <div class="mb-3">
              <label class="form-label">服務內容</label>
              <textarea class="form-control" id="volDescription" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">備註</label>
              <textarea class="form-control" id="volNote" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitVolunteerRecord()">提交</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==================== 配置 ====================
    const CONFIG = {
      LIFF_ID: '1656516134-X9oq92g9', // 請替換為您的 LIFF ID
      API_URL: 'https://script.google.com/macros/s/AKfycby5f7LinXNkYd7NM7o3Cr9HVEYfmpL-NT-utI-jjdUcaozR2ZePq9PvMg6tSA8FSl0uXw/exec', // 請替換為您的 GAS Web App URL
      API_KEY: 'AAbb520258185202581' // 請替換為您的 API Key
    };

    let currentUser = null;
    let currentPage = 'dashboard';
    let currentActivityId = null;
    let allActivities = [];

    // ==================== LIFF 初始化 ====================
    window.onload = function() {
      initializeLiff();
    };

    async function initializeLiff() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        await loadUserData(profile);
        
      } catch (error) {
        console.error('LIFF 初始化失敗:', error);
        showAlert('系統初始化失敗，請重新整理頁面', 'danger');
      }
    }

    // ==================== 載入使用者資料 ====================
    async function loadUserData(profile) {
      try {
        const response = await apiCall('getMemberByLineId', {
          lineId: profile.userId
        });

        if (response && response.id) {
          currentUser = response;
          document.getElementById('userNameDisplay').textContent = currentUser.realName || currentUser.lineName;
          document.getElementById('loadingScreen').style.display = 'none';
          showPage('dashboard');
        } else {
          // 需要註冊
          showRegisterModal(profile);
        }
      } catch (error) {
        console.error('載入使用者資料失敗:', error);
        showAlert('載入資料失敗', 'danger');
      }
    }

    // ==================== API 呼叫 ====================
    async function apiCall(action, data = {}) {
      try {
        const profile = await liff.getProfile();
        const requestData = {
          action: action,
          apiKey: CONFIG.API_KEY,
          lineId: profile.userId,
          ...data
        };

        const response = await fetch(CONFIG.API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestData)
        });

        const result = await response.json();
        
        if (result.success) {
          return result.data;
        } else {
          throw new Error(result.data.message || '操作失敗');
        }
      } catch (error) {
        console.error('API 呼叫失敗:', error);
        throw error;
      }
    }

    // ==================== 頁面切換 ====================
    function showPage(pageName) {
      // 隱藏所有頁面
      document.querySelectorAll('[id$="Page"]').forEach(page => {
        page.style.display = 'none';
      });

      // 更新底部導航
      document.querySelectorAll('.bottom-nav-item').forEach(item => {
        item.classList.remove('active');
      });

      // 顯示指定頁面
      const pageMap = {
        'dashboard': 'dashboardPage',
        'activities': 'activitiesPage',
        'myRegistrations': 'myRegistrationsPage',
        'volunteer': 'volunteerPage',
        'profile': 'profilePage'
      };

      const pageId = pageMap[pageName];
      if (pageId) {
        document.getElementById(pageId).style.display = 'block';
        event.target.closest('.bottom-nav-item')?.classList.add('active');
        currentPage = pageName;

        // 載入頁面資料
        loadPageData(pageName);
      }
    }

    // ==================== 載入頁面資料 ====================
    async function loadPageData(pageName) {
      switch(pageName) {
        case 'dashboard':
          await loadDashboard();
          break;
        case 'activities':
          await loadActivities();
          break;
        case 'myRegistrations':
          await loadMyRegistrations();
          break;
        case 'volunteer':
          await loadVolunteerRecords();
          break;
        case 'profile':
          await loadProfile();
          break;
      }
    }

    // ==================== 載入儀表板 ====================
    async function loadDashboard() {
      try {
        const data = await apiCall('getDashboardData');
        
        // 更新統計卡片
        document.getElementById('myRegistrationsCount').textContent = data.myRegistrations.length;
        document.getElementById('myVolunteerHours').textContent = data.myVolunteerHours;
        document.getElementById('memberLevel').textContent = data.member.memberType;

        // 顯示即將到來的活動
        const activitiesList = document.getElementById('upcomingActivitiesList');
        if (data.upcomingActivities.length === 0) {
          activitiesList.innerHTML = '<p class="text-muted">目前沒有即將到來的活動</p>';
        } else {
          activitiesList.innerHTML = data.upcomingActivities.map(activity => `
            <div class="activity-item" onclick="showActivityDetail('${activity.id}')">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">${activity.title}</h6>
                  <small class="text-muted">
                    <i class="bi bi-calendar"></i> ${formatDate(activity.date)}
                    <i class="bi bi-clock ms-2"></i> ${activity.time}
                  </small><br>
                  <small class="text-muted">
                    <i class="bi bi-geo-alt"></i> ${activity.location}
                  </small>
                </div>
                <span class="badge bg-success badge-status">${activity.status}</span>
              </div>
            </div>
          `).join('');
        }

        // 顯示我的最近報名
        const registrationsList = document.getElementById('myRecentRegistrations');
        if (data.myRegistrations.length === 0) {
          registrationsList.innerHTML = '<p class="text-muted">您還沒有報名任何活動</p>';
        } else {
          registrationsList.innerHTML = data.myRegistrations.slice(0, 5).map(reg => `
            <div class="activity-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">${reg.activityTitle}</h6>
                  <small class="text-muted">
                    <i class="bi bi-calendar"></i> 報名時間：${formatDateTime(reg.registeredAt)}
                  </small>
                </div>
                <span class="badge bg-primary badge-status">${reg.status}</span>
              </div>
            </div>
          `).join('');
        }

      } catch (error) {
        console.error('載入儀表板失敗:', error);
        showAlert('載入儀表板失敗', 'danger');
      }
    }

    // ==================== 載入活動列表 ====================
    async function loadActivities() {
      try {
        const data = await apiCall('getActivities', {});
        allActivities = data.data;
        displayActivities(allActivities);
      } catch (error) {
        console.error('載入活動失敗:', error);
        showAlert('載入活動失敗', 'danger');
      }
    }

    function displayActivities(activities) {
      const activitiesList = document.getElementById('activitiesList');
      
      if (activities.length === 0) {
        activitiesList.innerHTML = '<p class="text-muted">目前沒有活動</p>';
        return;
      }

      activitiesList.innerHTML = activities.map(activity => {
        const statusColor = {
          '報名中': 'success',
          '即將開始': 'warning',
          '進行中': 'info',
          '已結束': 'secondary'
        }[activity.status] || 'secondary';

        const isFull = activity.maxParticipants > 0 && activity.currentParticipants >= activity.maxParticipants;

        return `
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0">${activity.title}</h5>
                <span class="badge bg-${statusColor} badge-status">${activity.status}</span>
              </div>
              <p class="card-text text-muted mb-2">${activity.description || '暫無說明'}</p>
              <div class="row text-muted small">
                <div class="col-md-6">
                  <i class="bi bi-calendar"></i> ${formatDate(activity.date)}<br>
                  <i class="bi bi-clock"></i> ${activity.time}<br>
                  <i class="bi bi-geo-alt"></i> ${activity.location}
                </div>
                <div class="col-md-6">
                  <i class="bi bi-people"></i> ${activity.currentParticipants}/${activity.maxParticipants || '不限'} 人<br>
                  <i class="bi bi-tag"></i> ${activity.type}<br>
                  <i class="bi bi-cash"></i> ${activity.fee > 0 ? 'NT$ ' + activity.fee : '免費'}
                </div>
              </div>
              <div class="mt-3">
                <button class="btn btn-sm btn-outline-primary" onclick="showActivityDetail('${activity.id}')">
                  <i class="bi bi-info-circle"></i> 查看詳情
                </button>
                ${activity.status === '報名中' && !isFull ? `
                  <button class="btn btn-sm btn-primary" onclick="quickRegisterActivity('${activity.id}')">
                    <i class="bi bi-check-circle"></i> 立即報名
                  </button>
                ` : ''}
                ${isFull ? '<span class="badge bg-danger ms-2">已額滿</span>' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function searchActivities() {
      const searchText = document.getElementById('activitySearch').value.toLowerCase();
      const statusFilter = document.getElementById('activityStatusFilter').value;

      const filtered = allActivities.filter(activity => {
        const matchSearch = !searchText || 
          activity.title.toLowerCase().includes(searchText) ||
          activity.description.toLowerCase().includes(searchText) ||
          activity.location.toLowerCase().includes(searchText);
        
        const matchStatus = !statusFilter || activity.status === statusFilter;

        return matchSearch && matchStatus;
      });

      displayActivities(filtered);
    }

    // ==================== 活動詳情 ====================
    async function showActivityDetail(activityId) {
      try {
        currentActivityId = activityId;
        const activity = await apiCall('getActivityById', { activityId });
        
        document.getElementById('activityDetailTitle').textContent = activity.title;
        document.getElementById('activityDetailContent').innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <h6><i class="bi bi-calendar"></i> 活動日期</h6>
              <p>${formatDate(activity.date)}</p>
            </div>
            <div class="col-md-6">
              <h6><i class="bi bi-clock"></i> 活動時間</h6>
              <p>${activity.time}</p>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <h6><i class="bi bi-geo-alt"></i> 活動地點</h6>
              <p>${activity.location}</p>
            </div>
            <div class="col-md-6">
              <h6><i class="bi bi-tag"></i> 活動類型</h6>
              <p>${activity.type}</p>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <h6><i class="bi bi-people"></i> 人數限制</h6>
              <p>${activity.currentParticipants}/${activity.maxParticipants || '不限'} 人</p>
            </div>
            <div class="col-md-6">
              <h6><i class="bi bi-cash"></i> 活動費用</h6>
              <p>${activity.fee > 0 ? 'NT$ ' + activity.fee : '免費'}</p>
            </div>
          </div>
          <hr>
          <h6><i class="bi bi-file-text"></i> 活動說明</h6>
          <p>${activity.description || '暫無說明'}</p>
          ${activity.note ? `
            <hr>
            <h6><i class="bi bi-info-circle"></i> 注意事項</h6>
            <p>${activity.note}</p>
          ` : ''}
        `;

        const isFull = activity.maxParticipants > 0 && activity.currentParticipants >= activity.maxParticipants;
        const registerBtn = document.getElementById('registerActivityBtn');
        
        if (activity.status === '報名中' && !isFull) {
          registerBtn.style.display = 'inline-block';
        } else {
          registerBtn.style.display = 'none';
        }

        new bootstrap.Modal(document.getElementById('activityDetailModal')).show();
      } catch (error) {
        console.error('載入活動詳情失敗:', error);
        showAlert('載入活動詳情失敗', 'danger');
      }
    }

    async function quickRegisterActivity(activityId) {
      currentActivityId = activityId;
      await registerForActivity();
    }

    async function registerForActivity() {
      if (!currentActivityId) return;

      if (!confirm('確定要報名此活動嗎？')) return;

      try {
        await apiCall('registerActivity', {
          activityId: currentActivityId
        });

        showAlert('報名成功！', 'success');
        bootstrap.Modal.getInstance(document.getElementById('activityDetailModal'))?.hide();
        loadActivities();
        loadDashboard();
      } catch (error) {
        console.error('報名失敗:', error);
        showAlert(error.message || '報名失敗', 'danger');
      }
    }

    // ==================== 我的報名 ====================
    async function loadMyRegistrations() {
      try {
        const data = await apiCall('getMyRegistrations');
        const registrationsList = document.getElementById('myRegistrationsList');

        if (data.data.length === 0) {
          registrationsList.innerHTML = '<p class="text-muted">您還沒有報名任何活動</p>';
          return;
        }

        registrationsList.innerHTML = data.data.map(reg => {
          const statusColor = {
            '已報名': 'primary',
            '已簽到': 'success',
            '已取消': 'secondary'
          }[reg.status] || 'secondary';

          return `
            <div class="card mb-3">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h5 class="card-title mb-0">${reg.activityTitle}</h5>
                  <span class="badge bg-${statusColor} badge-status">${reg.status}</span>
                </div>
                <p class="text-muted small mb-2">
                  <i class="bi bi-calendar"></i> 報名時間：${formatDateTime(reg.registeredAt)}
                </p>
                ${reg.checkInAt ? `
                  <p class="text-muted small mb-2">
                    <i class="bi bi-check-circle"></i> 簽到時間：${formatDateTime(reg.checkInAt)}
                  </p>
                ` : ''}
                ${reg.status === '已報名' ? `
                  <button class="btn btn-sm btn-danger" onclick="cancelRegistration('${reg.id}')">
                    <i class="bi bi-x-circle"></i> 取消報名
                  </button>
                ` : ''}
                <button class="btn btn-sm btn-outline-primary" onclick="showActivityDetail('${reg.activityId}')">
                  <i class="bi bi-info-circle"></i> 活動詳情
                </button>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('載入報名記錄失敗:', error);
        showAlert('載入報名記錄失敗', 'danger');
      }
    }

    async function cancelRegistration(registrationId) {
      if (!confirm('確定要取消報名嗎？')) return;

      try {
        await apiCall('cancelRegistration', { registrationId });
        showAlert('已取消報名', 'success');
        loadMyRegistrations();
        loadDashboard();
      } catch (error) {
        console.error('取消報名失敗:', error);
        showAlert(error.message || '取消報名失敗', 'danger');
      }
    }

    // ==================== 志工記錄 ====================
    async function loadVolunteerRecords() {
      try {
        const data = await apiCall('getVolunteerRecords');
        
        document.getElementById('totalVolunteerHours').textContent = data.totalHours;
        document.getElementById('totalVolunteerRecords').textContent = data.data.length;

        const recordsList = document.getElementById('volunteerRecordsList');

        if (data.data.length === 0) {
          recordsList.innerHTML = '<p class="text-muted">您還沒有服務記錄</p>';
          return;
        }

        recordsList.innerHTML = data.data.map(record => {
          const statusColor = {
            '待審核': 'warning',
            '已審核': 'success',
            '已拒絕': 'danger'
          }[record.status] || 'secondary';

          return `
            <div class="card mb-3">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h5 class="card-title mb-0">${record.activity}</h5>
                  <span class="badge bg-${statusColor} badge-status">${record.status}</span>
                </div>
                <p class="text-muted small mb-2">
                  <i class="bi bi-calendar"></i> ${formatDate(record.date)}
                  <i class="bi bi-clock ms-3"></i> ${record.hours} 小時
                </p>
                ${record.description ? `<p class="mb-2">${record.description}</p>` : ''}
                ${record.approver ? `
                  <p class="text-muted small mb-0">
                    <i class="bi bi-person-check"></i> 審核者：${record.approver}
                    (${formatDateTime(record.approvedAt)})
                  </p>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('載入志工記錄失敗:', error);
        showAlert('載入志工記錄失敗', 'danger');
      }
    }

    function showAddVolunteerModal() {
      document.getElementById('addVolunteerForm').reset();
      document.getElementById('volDate').valueAsDate = new Date();
      new bootstrap.Modal(document.getElementById('addVolunteerModal')).show();
    }

    async function submitVolunteerRecord() {
      const form = document.getElementById('addVolunteerForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      try {
        await apiCall('addVolunteerRecord', {
          recordData: {
            date: document.getElementById('volDate').value,
            hours: parseFloat(document.getElementById('volHours').value),
            activity: document.getElementById('volActivity').value,
            description: document.getElementById('volDescription').value,
            note: document.getElementById('volNote').value
          }
        });

        showAlert('服務記錄已提交，等待審核', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addVolunteerModal')).hide();
        loadVolunteerRecords();
      } catch (error) {
        console.error('提交志工記錄失敗:', error);
        showAlert(error.message || '提交失敗', 'danger');
      }
    }

    // ==================== 個人資料 ====================
    async function loadProfile() {
      try {
        const profile = await liff.getProfile();
        document.getElementById('profileAvatar').src = profile.pictureUrl || 'https://via.placeholder.com/80';

        const infoHtml = `
          <div class="info-row">
            <span class="info-label">LINE 名稱：</span>
            <span class="info-value">${currentUser.lineName}</span>
          </div>
          <div class="info-row">
            <span class="info-label">真實姓名：</span>
            <span class="info-value">${currentUser.realName || '未設定'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">性別：</span>
            <span class="info-value">${currentUser.gender || '未設定'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">生日：</span>
            <span class="info-value">${currentUser.birthday ? formatDate(currentUser.birthday) : '未設定'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">電話：</span>
            <span class="info-value">${currentUser.phone || '未設定'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Email：</span>
            <span class="info-value">${currentUser.email || '未設定'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">地址：</span>
            <span class="info-value">${currentUser.address || '未設定'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">會員類型：</span>
            <span class="info-value">${currentUser.memberType}</span>
          </div>
          <div class="info-row">
            <span class="info-label">緊急聯絡人：</span>
            <span class="info-value">${currentUser.emergencyContact || '未設定'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">緊急聯絡電話：</span>
            <span class="info-value">${currentUser.emergencyPhone || '未設定'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">註冊時間：</span>
            <span class="info-value">${formatDateTime(currentUser.createdAt)}</span>
          </div>
        `;

        document.getElementById('profileInfo').innerHTML = infoHtml;
      } catch (error) {
        console.error('載入個人資料失敗:', error);
        showAlert('載入個人資料失敗', 'danger');
      }
    }

    function showEditProfileModal() {
      document.getElementById('editMemberId').value = currentUser.id;
      document.getElementById('editRealName').value = currentUser.realName || '';
      document.getElementById('editGender').value = currentUser.gender || '';
      document.getElementById('editBirthday').value = currentUser.birthday || '';
      document.getElementById('editPhone').value = currentUser.phone || '';
      document.getElementById('editEmail').value = currentUser.email || '';
      document.getElementById('editAddress').value = currentUser.address || '';
      document.getElementById('editDiseaseStatus').value = currentUser.diseaseStatus || '';
      document.getElementById('editEmergencyContact').value = currentUser.emergencyContact || '';
      document.getElementById('editEmergencyPhone').value = currentUser.emergencyPhone || '';

      new bootstrap.Modal(document.getElementById('editProfileModal')).show();
    }

    async function submitEditProfile() {
      try {
        await apiCall('updateMember', {
          memberId: document.getElementById('editMemberId').value,
          memberData: {
            realName: document.getElementById('editRealName').value,
            gender: document.getElementById('editGender').value,
            birthday: document.getElementById('editBirthday').value,
            phone: document.getElementById('editPhone').value,
            email: document.getElementById('editEmail').value,
            address: document.getElementById('editAddress').value,
            diseaseStatus: document.getElementById('editDiseaseStatus').value,
            emergencyContact: document.getElementById('editEmergencyContact').value,
            emergencyPhone: document.getElementById('editEmergencyPhone').value
          }
        });

        showAlert('資料更新成功', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
        
        // 重新載入使用者資料
        const profile = await liff.getProfile();
        await loadUserData(profile);
        loadProfile();
      } catch (error) {
        console.error('更新資料失敗:', error);
        showAlert(error.message || '更新失敗', 'danger');
      }
    }

    // ==================== 會員註冊 ====================
    function showRegisterModal(profile) {
      document.getElementById('loadingScreen').style.display = 'none';
      new bootstrap.Modal(document.getElementById('registerModal'), {
        backdrop: 'static',
        keyboard: false
      }).show();
    }

    async function submitRegister() {
      const form = document.getElementById('registerForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      try {
        const profile = await liff.getProfile();
        
        await apiCall('registerMember', {
          memberData: {
            lineId: profile.userId,
            lineName: profile.displayName,
            realName: document.getElementById('regRealName').value,
            gender: document.getElementById('regGender').value,
            birthday: document.getElementById('regBirthday').value,
            phone: document.getElementById('regPhone').value,
            email: document.getElementById('regEmail').value,
            address: document.getElementById('regAddress').value,
            memberType: document.getElementById('regMemberType').value,
            diseaseStatus: document.getElementById('regDiseaseStatus').value,
            emergencyContact: document.getElementById('regEmergencyContact').value,
            emergencyPhone: document.getElementById('regEmergencyPhone').value
          }
        });

        showAlert('註冊成功！歡迎加入帕金森病友會', 'success');
        bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
        await loadUserData(profile);
      } catch (error) {
        console.error('註冊失敗:', error);
        showAlert(error.message || '註冊失敗', 'danger');
      }
    }

    // ==================== 工具函數 ====================
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    function formatDateTime(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleString('zh-TW', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function showAlert(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
      alertDiv.style.zIndex = '9999';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alertDiv);

      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }
  </script>
</body>
</html>

