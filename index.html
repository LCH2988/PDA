<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å¸•é‡‘æ£®ç—…å‹æœƒæ•´åˆç³»çµ±</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ¥%3C/text%3E%3C/svg%3E">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"/>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  :root {
    --primary: #06c755;
    --primary-dark: #05b04b;
    --secondary: #00b900;
    --danger: #dc3545;
    --warning: #ffc107;
    --info: #17a2b8;
    --light: #f8f9fa;
    --dark: #343a40;
    --border-radius: 12px;
    --purple-1: #667eea;
    --purple-2: #764ba2;
  }
  
  * { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
  }
  
  body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans TC', sans-serif; 
    background: linear-gradient(135deg, var(--purple-1) 0%, var(--purple-2) 100%); 
    min-height: 100vh; 
    overflow-x: hidden;
  }
  
  .hidden { 
    display: none !important; 
  }
  
  .root-container { 
    max-width: 1200px; 
    margin: 0 auto; 
    padding: 0;
  }
  
  .view { 
    display: none; 
  }
  
  .view.active { 
    display: block; 
  }

  /* Loading Overlay */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  
  .loading-overlay.show {
    display: flex;
  }
  
  .loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Toast Container */
  .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9998;
    max-width: 350px;
  }

  /* Auth View */
  .auth-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  
  .auth-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    width: 100%;
    max-width: 450px;
    overflow: hidden;
  }
  
  .auth-header {
    background: linear-gradient(135deg, var(--purple-1), var(--purple-2));
    color: white;
    padding: 30px;
    text-align: center;
  }
  
  .auth-header h1 {
    font-size: 24px;
    margin-bottom: 5px;
  }
  
  .auth-tabs {
    display: flex;
    border-bottom: 1px solid #dee2e6;
  }
  
  .auth-tab {
    flex: 1;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
  }
  
  .auth-tab.active {
    border-bottom-color: var(--purple-1);
    color: var(--purple-1);
    font-weight: bold;
  }
  
  .auth-pane {
    display: none;
    padding: 30px;
  }
  
  .auth-pane.active {
    display: block;
  }
  
  .form-floating {
    margin-bottom: 15px;
  }
  
  .btn-gradient {
    background: linear-gradient(135deg, var(--purple-1), var(--purple-2));
    border: none;
    color: white;
    padding: 12px;
    border-radius: 8px;
    font-weight: bold;
    width: 100%;
    transition: transform 0.2s;
  }
  
  .btn-gradient:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }
  
  .btn-line {
    background: #06c755;
    border: none;
    color: white;
    padding: 12px;
    border-radius: 8px;
    font-weight: bold;
    width: 100%;
    margin-top: 10px;
  }

  /* Member Center */
  .member-container {
    min-height: 100vh;
    background: #f5f7fa;
  }
  
  .member-header {
    background: linear-gradient(135deg, var(--purple-1), var(--purple-2));
    color: white;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }
  
  .member-profile {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  
  .member-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: white;
    color: var(--purple-1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
  }
  
  .member-nav {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    padding: 20px;
    background: white;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }
  
  .member-nav-item {
    padding: 15px;
    text-align: center;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
  }
  
  .member-nav-item:hover {
    background: #f8f9fa;
    border-color: var(--purple-1);
  }
  
  .member-nav-item i {
    font-size: 24px;
    display: block;
    margin-bottom: 5px;
    color: var(--purple-1);
  }
  
  .member-section {
    display: none;
    padding: 20px;
  }
  
  .member-section.active {
    display: block;
  }
  
  .card {
    border: none;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    margin-bottom: 20px;
  }
  
  .card-header {
    background: linear-gradient(135deg, var(--purple-1), var(--purple-2));
    color: white;
    border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
    padding: 15px 20px;
    font-weight: bold;
  }

  /* Admin Dashboard */
  .admin-container {
    min-height: 100vh;
    background: #f5f7fa;
  }
  
  .admin-sidebar {
    background: white;
    min-height: 100vh;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
  }
  
  .admin-sidebar-header {
    background: linear-gradient(135deg, var(--purple-1), var(--purple-2));
    color: white;
    padding: 20px;
    text-align: center;
  }
  
  .admin-menu {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .admin-menu-item {
    padding: 15px 20px;
    cursor: pointer;
    transition: all 0.3s;
    border-left: 3px solid transparent;
  }
  
  .admin-menu-item:hover {
    background: #f8f9fa;
    border-left-color: var(--purple-1);
  }
  
  .admin-menu-item i {
    margin-right: 10px;
    width: 20px;
  }
  
  .admin-section {
    display: none;
    padding: 20px;
  }
  
  .admin-section.active {
    display: block;
  }
  
  .stat-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    text-align: center;
  }
  
  .stat-card i {
    font-size: 36px;
    margin-bottom: 10px;
  }
  
  .stat-value {
    font-size: 32px;
    font-weight: bold;
    margin: 10px 0;
  }
  
  .stat-label {
    color: #6c757d;
    font-size: 14px;
  }

  /* App View (Mobile) */
  .app-container {
    min-height: 100vh;
    background: #f5f7fa;
    padding-bottom: 70px;
  }
  
  .app-header {
    background: linear-gradient(135deg, var(--purple-1), var(--purple-2));
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }
  
  .app-user {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .app-user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 2px solid white;
  }
  
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    z-index: 1000;
  }
  
  .nav-item {
    flex: 1;
    text-align: center;
    padding: 5px;
    cursor: pointer;
    transition: all 0.3s;
    border-top: 3px solid transparent;
  }
  
  .nav-item.active {
    color: var(--purple-1);
    border-top-color: var(--purple-1);
  }
  
  .nav-item i {
    font-size: 20px;
    display: block;
    margin-bottom: 3px;
  }
  
  .nav-item span {
    font-size: 11px;
  }
  
  .page-content {
    display: none;
    padding: 15px;
  }
  
  .page-content.active {
    display: block;
  }
  
  .stat-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .stat-box {
    background: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }
  
  .stat-box i {
    font-size: 24px;
    color: var(--purple-1);
    margin-bottom: 8px;
  }
  
  .stat-number {
    font-size: 24px;
    font-weight: bold;
    color: var(--purple-1);
  }
  
  .stat-text {
    font-size: 12px;
    color: #6c757d;
    margin-top: 5px;
  }
  
  .activity-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }
  
  .activity-title {
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .activity-info {
    font-size: 13px;
    color: #6c757d;
    margin-bottom: 8px;
  }
  
  .activity-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    font-size: 12px;
    color: #6c757d;
  }
  
  .activity-meta i {
    margin-right: 3px;
  }
  
  .status-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
  }
  
  .status-å ±åä¸­, .status-info { background: #d1ecf1; color: #0c5460; }
  .status-å·²é¡æ»¿, .status-warning { background: #fff3cd; color: #856404; }
  .status-å·²çµæŸ, .status-secondary { background: #e2e3e5; color: #383d41; }
  .status-å·²å–æ¶ˆ, .status-danger { background: #f8d7da; color: #721c24; }
  .status-å·²å®Œæˆ, .status-success { background: #d4edda; color: #155724; }
  
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
  }
  
  .empty-state i {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
  }
  
  .mood-options {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
  }
  
  .mood-option {
    text-align: center;
    cursor: pointer;
    padding: 10px;
    border-radius: 8px;
    transition: all 0.3s;
    border: 2px solid transparent;
  }
  
  .mood-option:hover, .mood-option.active {
    background: #f8f9fa;
    border-color: var(--purple-1);
  }
  
  .mood-option i {
    font-size: 32px;
    display: block;
    margin-bottom: 5px;
  }
  
  .mood-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 15px 0;
  }
  
  .mood-tag {
    padding: 6px 12px;
    border-radius: 20px;
    background: #e9ecef;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.3s;
  }
  
  .mood-tag.active {
    background: var(--purple-1);
    color: white;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .root-container {
      padding: 0;
    }
    
    .auth-card {
      border-radius: 0;
    }
    
    .member-nav {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .stat-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (min-width: 769px) {
    .app-container {
      max-width: 480px;
      margin: 0 auto;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }
  }

  /* Utilities */
  .text-primary { color: var(--purple-1) !important; }
  .bg-primary { background: var(--purple-1) !important; }
  .border-primary { border-color: var(--purple-1) !important; }
  
  .fade-in {
    animation: fadeIn 0.3s ease-in;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

</head>
<body>

  <div class="root-container">
    
    <!-- ==================== èªè­‰è¦–åœ– ==================== -->
    <div id="view-auth" class="view active">
      <div class="auth-container">
        <div class="auth-card">
          <div class="auth-header">
            <h1>ğŸ¥ å¸•é‡‘æ£®ç—…å‹æœƒ</h1>
            <p class="mb-0">æ•´åˆç®¡ç†ç³»çµ±</p>
          </div>
          
          <!-- æ¨™ç±¤é  -->
          <div class="auth-tabs">
            <div class="auth-tab active" data-pane="pane-login">ç™»å…¥</div>
            <div class="auth-tab" data-pane="pane-register">è¨»å†Š</div>
            <div class="auth-tab" data-pane="pane-settings">è¨­å®š</div>
          </div>
          
          <!-- ç™»å…¥é¢æ¿ -->
          <div id="pane-login" class="auth-pane active">
            <div id="auth-alert" class="alert d-none"></div>
            <div id="auth-loading" class="text-center d-none mb-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
              </div>
            </div>
            
            <form id="emailLoginForm">
              <div class="form-floating mb-3">
                <input type="email" class="form-control" id="login-email" placeholder="é›»å­éƒµä»¶" required>
                <label for="login-email">é›»å­éƒµä»¶</label>
              </div>
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="login-password" placeholder="å¯†ç¢¼" required>
                <label for="login-password">å¯†ç¢¼</label>
              </div>
              <button type="submit" class="btn btn-gradient">
                <i class="bi bi-box-arrow-in-right me-2"></i>ç™»å…¥
              </button>
            </form>
            
            <div class="text-center my-3">
              <div class="text-muted small">æˆ–ä½¿ç”¨</div>
            </div>
            
            <button type="button" class="btn btn-line" onclick="APP.Auth.handleLineLogin()">
              <i class="bi bi-line me-2"></i>LINE å¿«é€Ÿç™»å…¥
            </button>
          </div>
          
          <!-- è¨»å†Šé¢æ¿ -->
          <div id="pane-register" class="auth-pane">
            <form id="registerForm">
              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="reg-name" placeholder="å§“å" required>
                <label for="reg-name">å§“å *</label>
              </div>
              <div class="form-floating mb-3">
                <select class="form-select" id="reg-gender" required>
                  <option value="">è«‹é¸æ“‡</option>
                  <option value="ç”·">ç”·</option>
                  <option value="å¥³">å¥³</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <label for="reg-gender">æ€§åˆ¥ *</label>
              </div>
              <div class="form-floating mb-3">
                <input type="date" class="form-control" id="reg-birthday" placeholder="ç”Ÿæ—¥">
                <label for="reg-birthday">ç”Ÿæ—¥</label>
              </div>
              <div class="form-floating mb-3">
                <input type="tel" class="form-control" id="reg-phone" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼" pattern="09[0-9]{8}">
                <label for="reg-phone">æ‰‹æ©Ÿè™Ÿç¢¼</label>
              </div>
              <div class="form-floating mb-3">
                <input type="email" class="form-control" id="reg-email" placeholder="é›»å­éƒµä»¶" required>
                <label for="reg-email">é›»å­éƒµä»¶ *</label>
              </div>
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="reg-password" placeholder="å¯†ç¢¼" required minlength="6">
                <label for="reg-password">å¯†ç¢¼ï¼ˆè‡³å°‘6ä½ï¼‰*</label>
              </div>
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="reg-password-confirm" placeholder="ç¢ºèªå¯†ç¢¼" required>
                <label for="reg-password-confirm">ç¢ºèªå¯†ç¢¼ *</label>
              </div>
              <button type="submit" class="btn btn-gradient">
                <i class="bi bi-person-plus me-2"></i>è¨»å†Š
              </button>
            </form>
          </div>
          
          <!-- è¨­å®šé¢æ¿ -->
          <div id="pane-settings" class="auth-pane">
            <h5 class="mb-3">ç³»çµ±è¨­å®š</h5>
            
            <div class="mb-3">
              <label class="form-label">API ç¶²å€</label>
              <input type="url" class="form-control" id="global-api-url" placeholder="è¼¸å…¥ API ç¶²å€">
              <div class="form-text">ç›®å‰ï¼š<span id="current-api-url"></span></div>
            </div>
            
            <button type="button" class="btn btn-primary w-100 mb-2" onclick="APP.Config.updateAPIUrl()">
              <i class="bi bi-save me-2"></i>å„²å­˜è¨­å®š
            </button>
            
            <button type="button" class="btn btn-info w-100 mb-2" onclick="APP.Auth.testAPIConnection()">
              <i class="bi bi-wifi me-2"></i>æ¸¬è©¦ API é€£ç·š
            </button>
            
            <hr class="my-3">
            
            <h6>é™¤éŒ¯è³‡è¨Š</h6>
            <div id="auth-debug" class="border rounded p-2 bg-light" style="max-height:200px;overflow-y:auto;font-size:12px;font-family:monospace;"></div>
            <button type="button" class="btn btn-sm btn-secondary w-100 mt-2" onclick="APP.Auth.clearDebug()">
              æ¸…é™¤è¨˜éŒ„
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== æœƒå“¡ä¸­å¿ƒè¦–åœ– ==================== -->
    <div id="view-member" class="view">
      <div class="member-container">
        <!-- é ‚éƒ¨å°èˆª -->
        <div class="member-header">
          <div class="member-profile">
            <div class="member-avatar" id="mc-avatar">A</div>
            <div class="flex-grow-1">
              <div class="fw-bold" id="mc-name">è¼‰å…¥ä¸­...</div>
              <div class="small" id="mc-no">æœƒå“¡ç·¨è™Ÿï¼š---</div>
            </div>
            <button class="btn btn-sm btn-light" onclick="APP.Auth.logout()">
              <i class="bi bi-box-arrow-right"></i> ç™»å‡º
            </button>
          </div>
        </div>
        
        <!-- åŠŸèƒ½å°èˆª -->
        <div class="member-nav">
          <div class="member-nav-item" onclick="APP.Member.show('home')">
            <i class="bi bi-house-door"></i>
            <div>é¦–é </div>
          </div>
          <div class="member-nav-item" onclick="APP.Member.show('symptom')">
            <i class="bi bi-clipboard-pulse"></i>
            <div>ç—‡ç‹€è¨˜éŒ„</div>
          </div>
          <div class="member-nav-item" onclick="APP.Member.show('medication')">
            <i class="bi bi-capsule"></i>
            <div>ç”¨è—¥ç®¡ç†</div>
          </div>
          <div class="member-nav-item" onclick="APP.Member.show('exercise')">
            <i class="bi bi-activity"></i>
            <div>é‹å‹•è¨˜éŒ„</div>
          </div>
          <div class="member-nav-item" onclick="APP.Member.show('sleep')">
            <i class="bi bi-moon-stars"></i>
            <div>ç¡çœ è¨˜éŒ„</div>
          </div>
          <div class="member-nav-item" onclick="APP.Member.show('mood')">
            <i class="bi bi-emoji-smile"></i>
            <div>å¿ƒæƒ…æ—¥è¨˜</div>
          </div>
          <div class="member-nav-item" onclick="APP.Member.show('events')">
            <i class="bi bi-calendar-event"></i>
            <div>æ´»å‹•å ±å</div>
          </div>
          <div class="member-nav-item" onclick="APP.Member.show('profile')">
            <i class="bi bi-person-circle"></i>
            <div>å€‹äººè³‡æ–™</div>
          </div>
          <div class="member-nav-item admin-only" onclick="APP.Router.goAdmin()" style="display:none;">
            <i class="bi bi-gear"></i>
            <div>ç®¡ç†å¾Œå°</div>
          </div>
        </div>
        
        <!-- é¦–é  -->
        <div id="mc-home" class="member-section active">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-bell me-2"></i>ä»Šæ—¥æé†’
            </div>
            <div class="card-body" id="mc-today-reminders">
              <div class="text-center text-muted py-3">è¼‰å…¥ä¸­...</div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <i class="bi bi-calendar-check me-2"></i>è¿‘æœŸæ´»å‹•
            </div>
            <div class="card-body" id="mc-upcoming-events">
              <div class="text-center text-muted py-3">è¼‰å…¥ä¸­...</div>
            </div>
          </div>
        </div>
        
        <!-- ç—‡ç‹€è¨˜éŒ„ -->
        <div id="mc-symptom" class="member-section">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-plus-circle me-2"></i>æ–°å¢ç—‡ç‹€è¨˜éŒ„
            </div>
            <div class="card-body">
              <form id="mc-symptom-form">
                <div class="mb-3">
                  <label class="form-label">é¡«æŠ–ç¨‹åº¦ï¼ˆ0-10ï¼‰</label>
                  <input type="range" class="form-range" id="mc-tremor" min="0" max="10" value="0">
                  <div class="text-center"><span id="mc-tremor-val">0</span></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">åƒµç¡¬ç¨‹åº¦ï¼ˆ0-10ï¼‰</label>
                  <input type="range" class="form-range" id="mc-rigidity" min="0" max="10" value="0">
                  <div class="text-center"><span id="mc-rigidity-val">0</span></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">å‹•ä½œé²ç·©ï¼ˆ0-10ï¼‰</label>
                  <input type="range" class="form-range" id="mc-brady" min="0" max="10" value="0">
                  <div class="text-center"><span id="mc-brady-val">0</span></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">å¹³è¡¡å•é¡Œï¼ˆ0-10ï¼‰</label>
                  <input type="range" class="form-range" id="mc-balance" min="0" max="10" value="0">
                  <div class="text-center"><span id="mc-balance-val">0</span></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">å‚™è¨»</label>
                  <textarea class="form-control" id="mc-symptom-notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-gradient w-100">
                  <i class="bi bi-save me-2"></i>å„²å­˜è¨˜éŒ„
                </button>
              </form>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <i class="bi bi-clock-history me-2"></i>æ­·å²è¨˜éŒ„
            </div>
            <div class="card-body" id="mc-symptom-history">
              <div class="text-center text-muted py-3">è¼‰å…¥ä¸­...</div>
            </div>
          </div>
        </div>
        
        <!-- ç”¨è—¥ç®¡ç† -->
        <div id="mc-medication" class="member-section">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span><i class="bi bi-capsule me-2"></i>æˆ‘çš„ç”¨è—¥</span>
              <button class="btn btn-sm btn-light" onclick="APP.Member.openAddMedication()">
                <i class="bi bi-plus"></i> æ–°å¢
              </button>
            </div>
            <div class="card-body" id="mc-medications-list">
              <div class="text-center text-muted py-3">è¼‰å…¥ä¸­...</div>
            </div>
          </div>
        </div>
        
        <!-- é‹å‹•è¨˜éŒ„ -->
        <div id="mc-exercise" class="member-section">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-plus-circle me-2"></i>æ–°å¢é‹å‹•è¨˜éŒ„
            </div>
            <div class="card-body">
              <form id="mc-exercise-form">
                <div class="mb-3">
                  <label class="form-label">é‹å‹•æ—¥æœŸ</label>
                  <input type="date" class="form-control" id="mc-ex-date" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">é‹å‹•é¡å‹</label>
                  <select class="form-select" id="mc-ex-type" required>
                    <option value="">è«‹é¸æ“‡</option>
                    <option>æ•£æ­¥</option>
                    <option>å¤ªæ¥µ</option>
                    <option>ç‘œçˆ</option>
                    <option>æ¸¸æ³³</option>
                    <option>é¨è…³è¸è»Š</option>
                    <option>å…¶ä»–</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">é‹å‹•æ™‚é•·ï¼ˆåˆ†é˜ï¼‰</label>
                  <input type="number" class="form-control" id="mc-ex-duration" min="1" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">é‹å‹•å¼·åº¦</label>
                  <select class="form-select" id="mc-ex-intensity">
                    <option>è¼•åº¦</option>
                    <option>ä¸­åº¦</option>
                    <option>é«˜å¼·åº¦</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">èº«é«”ç‹€æ³</label>
                  <select class="form-select" id="mc-ex-condition">
                    <option>è‰¯å¥½</option>
                    <option>æ™®é€š</option>
                    <option>ç–²ç´¯</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">å‚™è¨»</label>
                  <textarea class="form-control" id="mc-ex-notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-gradient w-100">
                  <i class="bi bi-save me-2"></i>å„²å­˜è¨˜éŒ„
                </button>
              </form>
            </div>
          </div>
        </div>
        
        <!-- ç¡çœ è¨˜éŒ„ -->
        <div id="mc-sleep" class="member-section">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-plus-circle me-2"></i>æ–°å¢ç¡çœ è¨˜éŒ„
            </div>
            <div class="card-body">
              <form id="mc-sleep-form">
                <div class="mb-3">
                  <label class="form-label">ç¡çœ æ—¥æœŸ</label>
                  <input type="date" class="form-control" id="mc-sleep-date" required>
                </div>
                <div class="row mb-3">
                  <div class="col-6">
                    <label class="form-label">å°±å¯¢æ™‚é–“</label>
                    <input type="time" class="form-control" id="mc-sleep-bedtime" required>
                  </div>
                  <div class="col-6">
                    <label class="form-label">èµ·åºŠæ™‚é–“</label>
                    <input type="time" class="form-control" id="mc-sleep-wake" required>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">ç¡çœ å“è³ª</label>
                  <select class="form-select" id="mc-sleep-quality">
                    <option>éå¸¸å¥½</option>
                    <option>å¥½</option>
                    <option>æ™®é€š</option>
                    <option>å·®</option>
                    <option>éå¸¸å·®</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">å¤œé–“é†’ä¾†æ¬¡æ•¸</label>
                  <input type="number" class="form-control" id="mc-sleep-wake-count" min="0" value="0">
                </div>
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="mc-sleep-dream">
                    <label class="form-check-label" for="mc-sleep-dream">æœ‰åšå¤¢</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="mc-sleep-nightmare">
                    <label class="form-check-label" for="mc-sleep-nightmare">æœ‰æƒ¡å¤¢</label>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">å‚™è¨»</label>
                  <textarea class="form-control" id="mc-sleep-notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-gradient w-100">
                  <i class="bi bi-save me-2"></i>å„²å­˜è¨˜éŒ„
                </button>
              </form>
            </div>
          </div>
        </div>
        
        <!-- å¿ƒæƒ…æ—¥è¨˜ -->
        <div id="mc-mood" class="member-section">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-plus-circle me-2"></i>æ–°å¢å¿ƒæƒ…æ—¥è¨˜
            </div>
            <div class="card-body">
              <form id="mc-mood-form">
                <div class="mb-3">
                  <label class="form-label">æ—¥æœŸ</label>
                  <input type="date" class="form-control" id="mc-mood-date" required>
                </div>
                
                <div class="mb-3">
                  <label class="form-label">ä»Šå¤©çš„å¿ƒæƒ…</label>
                  <div class="mood-options">
                    <div class="mood-option" data-score="1" onclick="APP.Member.selectMood(1)">
                      <i class="bi bi-emoji-frown" style="color:#dc3545;"></i>
                      <div class="small">å¾ˆå·®</div>
                    </div>
                    <div class="mood-option" data-score="3" onclick="APP.Member.selectMood(3)">
                      <i class="bi bi-emoji-neutral" style="color:#ffc107;"></i>
                      <div class="small">æ™®é€š</div>
                    </div>
                    <div class="mood-option" data-score="5" onclick="APP.Member.selectMood(5)">
                      <i class="bi bi-emoji-smile" style="color:#28a745;"></i>
                      <div class="small">å¾ˆå¥½</div>
                    </div>
                  </div>
                </div>
                
                <div class="mb-3">
                  <label class="form-label">å¿ƒæƒ…æ¨™ç±¤</label>
                  <div class="mood-tags">
                    <span class="mood-tag" data-tag="é–‹å¿ƒ" onclick="APP.Member.toggleMoodTag('é–‹å¿ƒ')">ğŸ˜Š é–‹å¿ƒ</span>
                    <span class="mood-tag" data-tag="ç„¦æ…®" onclick="APP.Member.toggleMoodTag('ç„¦æ…®')">ğŸ˜° ç„¦æ…®</span>
                    <span class="mood-tag" data-tag="ç–²å€¦" onclick="APP.Member.toggleMoodTag('ç–²å€¦')">ğŸ˜´ ç–²å€¦</span>
                    <span class="mood-tag" data-tag="æ²®å–ª" onclick="APP.Member.toggleMoodTag('æ²®å–ª')">ğŸ˜” æ²®å–ª</span>
                    <span class="mood-tag" data-tag="å¹³éœ" onclick="APP.Member.toggleMoodTag('å¹³éœ')">ğŸ˜Œ å¹³éœ</span>
                    <span class="mood-tag" data-tag="èˆˆå¥®" onclick="APP.Member.toggleMoodTag('èˆˆå¥®')">ğŸ¤© èˆˆå¥®</span>
                  </div>
                </div>
                
                <div class="mb-3">
                  <label class="form-label">ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼...</label>
                  <textarea class="form-control" id="mc-mood-content" rows="5" placeholder="è¨˜éŒ„ä»Šå¤©çš„å¿ƒæƒ…èˆ‡æƒ³æ³•..."></textarea>
                </div>
                
                <button type="submit" class="btn btn-gradient w-100">
                  <i class="bi bi-save me-2"></i>å„²å­˜æ—¥è¨˜
                </button>
              </form>
            </div>
          </div>
        </div>
        
        <!-- æ´»å‹•å ±å -->
        <div id="mc-events" class="member-section">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-calendar-event me-2"></i>æ‰€æœ‰æ´»å‹•
            </div>
            <div class="card-body" id="mc-events-list">
              <div class="text-center text-muted py-3">è¼‰å…¥ä¸­...</div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <i class="bi bi-check-circle me-2"></i>æˆ‘çš„å ±å
            </div>
            <div class="card-body" id="mc-my-events-list">
              <div class="text-center text-muted py-3">è¼‰å…¥ä¸­...</div>
            </div>
          </div>
        </div>
        
        <!-- å€‹äººè³‡æ–™ -->
        <div id="mc-profile" class="member-section">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-person me-2"></i>åŸºæœ¬è³‡æ–™
            </div>
            <div class="card-body">
              <div class="mb-2"><strong>å§“åï¼š</strong><span id="mc-profile-name">-</span></div>
              <div class="mb-2"><strong>æœƒå“¡ç·¨è™Ÿï¼š</strong><span id="mc-profile-no">-</span></div>
              <div class="mb-2"><strong>é›»å­éƒµä»¶ï¼š</strong><span id="mc-profile-email">-</span></div>
              <div class="mb-2"><strong>æ‰‹æ©Ÿï¼š</strong><span id="mc-profile-phone">-</span></div>
              <div class="mb-2"><strong>åœ°å€ï¼š</strong><span id="mc-profile-address">-</span></div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <i class="bi bi-heart me-2"></i>ææ¬¾è¨˜éŒ„
            </div>
            <div class="card-body" id="mc-donation-history">
              <div class="text-center text-muted py-3">è¼‰å…¥ä¸­...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== ç®¡ç†å¾Œå°è¦–åœ– ==================== -->
    <div id="view-admin" class="view">
      <div class="admin-container">
        <div class="row g-0">
          <!-- å´é‚Šæ¬„ -->
          <div class="col-md-3 col-lg-2">
            <div class="admin-sidebar">
              <div class="admin-sidebar-header">
                <h5 class="mb-0">ç®¡ç†å¾Œå°</h5>
              </div>
              <ul class="admin-menu">
                <li class="admin-menu-item" onclick="APP.Admin.show('dashboard')">
                  <i class="bi bi-speedometer2"></i>å„€è¡¨æ¿
                </li>
                <li class="admin-menu-item" onclick="APP.Admin.show('members')">
                  <i class="bi bi-people"></i>æœƒå“¡ç®¡ç†
                </li>
                <li class="admin-menu-item" onclick="APP.Admin.show('events')">
                  <i class="bi bi-calendar-event"></i>æ´»å‹•ç®¡ç†
                </li>
                <li class="admin-menu-item" onclick="APP.Admin.show('health')">
                  <i class="bi bi-clipboard-pulse"></i>å¥åº·è¨˜éŒ„
                </li>
                <li class="admin-menu-item" onclick="APP.Admin.show('donations')">
                  <i class="bi bi-heart"></i>ææ¬¾ç®¡ç†
                </li>
                <li class="admin-menu-item" onclick="APP.Admin.show('volunteers')">
                  <i class="bi bi-hand-thumbs-up"></i>å¿—å·¥ç®¡ç†
                </li>
                <li class="admin-menu-item" onclick="APP.Admin.show('finance')">
                  <i class="bi bi-cash-stack"></i>è²¡å‹™ç®¡ç†
                </li>
                <li class="admin-menu-item" onclick="APP.Router.go('member')">
                  <i class="bi bi-arrow-left"></i>è¿”å›æœƒå“¡ä¸­å¿ƒ
                </li>
              </ul>
            </div>
          </div>
          
          <!-- ä¸»è¦å…§å®¹ -->
          <div class="col-md-9 col-lg-10">
            <!-- å„€è¡¨æ¿ -->
            <div id="admin-dashboard" class="admin-section active">
              <div class="p-4">
                <h3 class="mb-4">ç³»çµ±æ¦‚è¦½</h3>
                
                <div class="row g-3 mb-4">
                  <div class="col-md-3">
                    <div class="stat-card">
                      <i class="bi bi-people text-primary"></i>
                      <div class="stat-value" id="admin-stat-members">0</div>
                      <div class="stat-label">ç¸½æœƒå“¡æ•¸</div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="stat-card">
                      <i class="bi bi-calendar-event text-success"></i>
                      <div class="stat-value" id="admin-stat-events">0</div>
                      <div class="stat-label">æœ¬æœˆæ´»å‹•</div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="stat-card">
                      <i class="bi bi-hand-thumbs-up text-warning"></i>
                      <div class="stat-value" id="admin-stat-volunteers">0</div>
                      <div class="stat-label">å¿—å·¥äººæ•¸</div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="stat-card">
                      <i class="bi bi-heart text-danger"></i>
                      <div class="stat-value" id="admin-stat-donations">$0</div>
                      <div class="stat-label">æœ¬æœˆææ¬¾</div>
                    </div>
                  </div>
                </div>
                
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="card">
                      <div class="card-header">
                        <i class="bi bi-activity me-2"></i>æœ€è¿‘å‹•æ…‹
                      </div>
                      <div class="card-body" id="admin-recent-activities">
                        <div class="text-center text-muted py-3">è¼‰å…¥ä¸­...</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="card">
                      <div class="card-header">
                        <i class="bi bi-exclamation-triangle me-2"></i>å¾…è™•ç†äº‹é …
                      </div>
                      <div class="card-body" id="admin-pending-tasks">
                        <div class="text-center text-muted py-3">è¼‰å…¥ä¸­...</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- æœƒå“¡ç®¡ç† -->
            <div id="admin-members" class="admin-section">
              <div class="p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                  <h3>æœƒå“¡ç®¡ç†</h3>
                  <button class="btn btn-primary" onclick="APP.Admin.openAddMember()">
                    <i class="bi bi-plus-circle me-2"></i>æ–°å¢æœƒå“¡
                  </button>
                </div>
                
                <div class="card">
                  <div class="card-body">
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <input type="text" class="form-control" placeholder="æœå°‹æœƒå“¡..." id="admin-member-search">
                      </div>
                      <div class="col-md-3">
                        <select class="form-select" id="admin-member-status">
                          <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                          <option value="å·²å¯©æ ¸">å·²å¯©æ ¸</option>
                          <option value="å¾…å¯©æ ¸">å¾…å¯©æ ¸</option>
                          <option value="å·²åœç”¨">å·²åœç”¨</option>
                        </select>
                      </div>
                      <div class="col-md-3">
                        <button class="btn btn-primary w-100" onclick="APP.Admin.loadMembers(1, document.getElementById('admin-member-search').value, document.getElementById('admin-member-status').value)">
                          <i class="bi bi-search me-2"></i>æœå°‹
                        </button>
                      </div>
                    </div>
                    
                    <div id="admin-members-list">
                      <div class="text-center text-muted py-4">è¼‰å…¥ä¸­...</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- æ´»å‹•ç®¡ç† -->
            <div id="admin-events" class="admin-section">
              <div class="p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                  <h3>æ´»å‹•ç®¡ç†</h3>
                  <button class="btn btn-primary" onclick="APP.Admin.openAddEvent()">
                    <i class="bi bi-plus-circle me-2"></i>æ–°å¢æ´»å‹•
                  </button>
                </div>
                
                <div class="card">
                  <div class="card-body" id="admin-events-list">
                    <div class="text-center text-muted py-4">è¼‰å…¥ä¸­...</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- å¥åº·è¨˜éŒ„ -->
            <div id="admin-health" class="admin-section">
              <div class="p-4">
                <h3 class="mb-4">å¥åº·è¨˜éŒ„</h3>
                
                <div class="card">
                  <div class="card-body" id="admin-health-list">
                    <div class="text-center text-muted py-4">è¼‰å…¥ä¸­...</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ææ¬¾ç®¡ç† -->
            <div id="admin-donations" class="admin-section">
              <div class="p-4">
                <h3 class="mb-4">ææ¬¾ç®¡ç†</h3>
                
                <div class="card">
                  <div class="card-body" id="admin-donations-list">
                    <div class="text-center text-muted py-4">è¼‰å…¥ä¸­...</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- å¿—å·¥ç®¡ç† -->
            <div id="admin-volunteers" class="admin-section">
              <div class="p-4">
                <h3 class="mb-4">å¿—å·¥ç®¡ç†</h3>
                
                <div class="card">
                  <div class="card-body" id="admin-volunteers-list">
                    <div class="text-center text-muted py-4">è¼‰å…¥ä¸­...</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- è²¡å‹™ç®¡ç† -->
            <div id="admin-finance" class="admin-section">
              <div class="p-4">
                <h3 class="mb-4">è²¡å‹™ç®¡ç†</h3>
                
                <div class="row g-3 mb-4">
                  <div class="col-md-4">
                    <div class="stat-card">
                      <i class="bi bi-arrow-down-circle text-success"></i>
                      <div class="stat-value text-success" id="admin-total-income">$0</div>
                      <div class="stat-label">ç¸½æ”¶å…¥</div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="stat-card">
                      <i class="bi bi-arrow-up-circle text-danger"></i>
                      <div class="stat-value text-danger" id="admin-total-expense">$0</div>
                      <div class="stat-label">ç¸½æ”¯å‡º</div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="stat-card">
                      <i class="bi bi-wallet2 text-primary"></i>
                      <div class="stat-value text-primary" id="admin-net-balance">$0</div>
                      <div class="stat-label">æ·¨é¤˜é¡</div>
                    </div>
                  </div>
                </div>
                
                <div class="card">
                  <div class="card-body" id="admin-finance-list">
                    <div class="text-center text-muted py-4">è¼‰å…¥ä¸­...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Toast/Modal/Loading å®¹å™¨ -->
  <div id="toastContainer" class="toast-container"></div>
  <div id="modalContainer"></div>
  <div id="globalLoading" class="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  <script>
// ========== å¸•é‡‘æ£®ç—…å‹æœƒæ•´åˆç³»çµ± - å®Œæ•´ JavaScript ==========

const APP = {
  State: {
    LIFF_IDS: {
      app: '1656516134-X9oq92g9',
      auth: '1656516134-k8rMQwnQ',
      member: '1656516134-VaGgmaPm'
    },
    API: {
      primary: localStorage.getItem('API_URL') || 'https://script.google.com/macros/s/AKfycbyZ2Lmy3nRHdPu54QErL1qI6MEJER-zEe6Xdt3A-rrY692B6EiZcWwjhWGtR6c23mrMeA/exec',
      alt: localStorage.getItem('admin_API_URL') || 'https://script.google.com/macros/s/AKfycbyZ2Lmy3nRHdPu54QErL1qI6MEJER-zEe6Xdt3A-rrY692B6EiZcWwjhWGtR6c23mrMeA/exec'
    },
    API_KEY: 'AAbb8520258185202581',
    userProfile: null,
    memberInfo: null,
    isAdmin: false,
    routerView: 'auth',
    pageSize: 20
  },

  // ========== å·¥å…·å‡½æ•¸ ==========
  Util: {
    showLoading(show) {
      const el = document.getElementById('globalLoading');
      if (el) el.classList.toggle('show', !!show);
    },
    
    toast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      
      const colors = { 
        success: '#28a745', 
        error: '#dc3545', 
        warning: '#ffc107', 
        info: '#17a2b8' 
      };
      const icons = { 
        success: 'check-circle-fill', 
        error: 'x-circle-fill', 
        warning: 'exclamation-triangle-fill', 
        info: 'info-circle-fill' 
      };
      
      const toast = document.createElement('div');
      toast.className = 'toast show';
      toast.style.cssText = `min-width:250px;margin-bottom:10px;background:white;border-left:4px solid ${colors[type]};box-shadow:0 4px 12px rgba(0,0,0,0.15);`;
      toast.innerHTML = `
        <div class="toast-body d-flex align-items-center">
          <i class="bi bi-${icons[type]} me-2" style="color:${colors[type]};font-size:18px;"></i>
          <div class="flex-grow-1" style="font-size:14px;">${message}</div>
          <button type="button" class="btn-close ms-2" aria-label="Close"></button>
        </div>`;
      
      toast.querySelector('.btn-close').onclick = () => toast.remove();
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    },
    
    modal(html, onSubmit) {
      const container = document.getElementById('modalContainer');
      if (!container) return;
      
      container.innerHTML = html;
      const modalEl = container.querySelector('.modal');
      const formEl = container.querySelector('form');
      const bsModal = new bootstrap.Modal(modalEl);
      
      if (formEl && typeof onSubmit === 'function') {
        formEl.addEventListener('submit', async (e) => {
          e.preventDefault();
          const btn = formEl.querySelector('button[type="submit"]');
          APP.Util.setBtnLoading(btn, true);
          try {
            const fd = new FormData(formEl);
            await onSubmit(fd);
            bsModal.hide();
          } catch (err) {
            APP.Util.toast(err.message || 'æ“ä½œå¤±æ•—', 'error');
          } finally {
            APP.Util.setBtnLoading(btn, false);
          }
        });
      }
      
      modalEl.addEventListener('hidden.bs.modal', () => container.innerHTML = '', { once: true });
      bsModal.show();
    },
    
    setBtnLoading(button, loading) {
      if (!button) return;
      if (loading) {
        button.disabled = true;
        button.dataset.originalText = button.innerHTML;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>è™•ç†ä¸­...';
      } else {
        button.disabled = false;
        if (button.dataset.originalText) button.innerHTML = button.dataset.originalText;
      }
    },
    
    formatDate(dateInput) {
      if (!dateInput) return '-';
      try {
        let d;
        if (dateInput instanceof Date) {
          d = dateInput;
        } else if (typeof dateInput === 'number') {
          d = new Date(dateInput);
        } else if (typeof dateInput === 'string') {
          const parsed = Date.parse(dateInput);
          d = isNaN(parsed) ? new Date(dateInput) : new Date(parsed);
        } else {
          return '-';
        }
        
        if (isNaN(d.getTime())) return '-';
        
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}/${month}/${day}`;
      } catch {
        return '-';
      }
    },
    
    formatDateInput(dateString) {
      if (!dateString) return '';
      try {
        const d = (dateString instanceof Date) ? dateString : new Date(dateString);
        if (isNaN(d.getTime())) return '';
        return d.toISOString().split('T')[0];
      } catch {
        return '';
      }
    },
    
    currency(n) {
      try {
        return new Intl.NumberFormat('zh-TW').format(Number(n || 0));
      } catch {
        return '0';
      }
    },
    
    getStatusClass(status) {
      const map = {
        'å·²å¯©æ ¸': 'success', 'å¾…å¯©æ ¸': 'warning', 'å·²åœç”¨': 'danger',
        'å ±åä¸­': 'info', 'å·²é¡æ»¿': 'warning', 'å·²çµæŸ': 'secondary',
        'å·²å–æ¶ˆ': 'danger', 'å·²å®Œæˆ': 'success', 'è™•ç†ä¸­': 'warning',
        'å·²å•Ÿç”¨': 'success', 'å·²ææ¬¾': 'success', 'é–‹æ”¾å ±å': 'info'
      };
      return map[status] || 'secondary';
    }
  },

  // ========== é…ç½® ==========
  Config: {
    updateAPIUrl() {
      const input = document.getElementById('global-api-url');
      if (!input) return;
      
      const v = input.value.trim();
      if (!v) {
        APP.Util.toast('è«‹è¼¸å…¥æœ‰æ•ˆ URL', 'error');
        return;
      }
      
      APP.State.API.primary = v;
      APP.State.API.alt = v;
      localStorage.setItem('API_URL', v);
      localStorage.setItem('admin_API_URL', v);
      
      const displayEl = document.getElementById('current-api-url');
      if (displayEl) displayEl.textContent = v;
      
      APP.Util.toast('API ç¶²å€å·²æ›´æ–°', 'success');
    }
  },

  // ========== è·¯ç”± ==========
  Router: {
    go(view) {
      APP.State.routerView = view;
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      const viewEl = document.getElementById('view-' + view);
      if (viewEl) viewEl.classList.add('active');
      
      if (view === 'member') {
        APP.Member.initMember();
      } else if (view === 'admin') {
        APP.Admin.initAdmin();
      }
    },
    
    goAdmin() {
      if (!APP.State.isAdmin) {
        APP.Util.toast('æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™', 'error');
        return;
      }
      APP.Router.go('admin');
    }
  },

  // ========== LIFF ==========
  LIFF: {
    inited: false,
    
    async initAny() {
      if (APP.LIFF.inited) return;
      try {
        const anyId = APP.State.LIFF_IDS.app || APP.State.LIFF_IDS.auth || APP.State.LIFF_IDS.member;
        if (anyId && typeof liff !== 'undefined') {
          await liff.init({ liffId: anyId });
          APP.LIFF.inited = true;
        }
      } catch (e) {
        console.log('LIFF init error:', e);
      }
    },
    
    async ensureLogged() {
      try {
        await APP.LIFF.initAny();
        if (typeof liff !== 'undefined' && !liff.isLoggedIn()) {
          liff.login();
        }
      } catch (e) {
        console.log('LIFF login error:', e);
      }
    },
    
    async profile() {
      try {
        await APP.LIFF.initAny();
        if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
          return await liff.getProfile();
        }
      } catch (e) {
        console.log('LIFF profile error:', e);
      }
      return null;
    }
  },

  // ========== API ==========
  API: {
    async call(action, data = {}) {
      try {
        const payload = {
          apiKey: APP.State.API_KEY,
          action,
          ...data
        };
        
        if (APP.State.memberInfo && !data.memberId && !data.lineId) {
          payload.memberId = APP.State.memberInfo.memberId;
        }
        
        if (APP.State.userProfile && !data.lineId) {
          payload.lineId = APP.State.userProfile.userId;
        }
        
        const response = await fetch(APP.State.API.primary, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success && result.message) {
          throw new Error(result.message);
        }
        
        return result;
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }
  },

  // ========== èªè­‰ ==========
  Auth: {
    debug(message) {
      const el = document.getElementById('auth-debug');
      if (!el) return;
      const ts = new Date().toLocaleTimeString();
      el.innerHTML += `[${ts}] ${message}<br/>`;
      el.scrollTop = 999999;
    },
    
    setAlert(msg, type = 'info') {
      const el = document.getElementById('auth-alert');
      if (!el) return;
      el.className = 'alert alert-' + (type === 'error' ? 'danger' : type);
      el.textContent = msg;
      el.classList.remove('d-none');
      setTimeout(() => el.classList.add('d-none'), 5000);
    },
    
    setLoading(on) {
      const el = document.getElementById('auth-loading');
      if (el) el.classList.toggle('d-none', !on);
    },
    
    async init() {
      // Tab åˆ‡æ›
      document.querySelectorAll('.auth-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          document.querySelectorAll('.auth-pane').forEach(p => p.classList.remove('active'));
          const paneId = tab.dataset.pane;
          const pane = document.getElementById(paneId);
          if (pane) pane.classList.add('active');
        });
      });
      
      const urlEl = document.getElementById('current-api-url');
      if (urlEl) urlEl.textContent = APP.State.API.primary;
      
      const inputEl = document.getElementById('global-api-url');
      if (inputEl) inputEl.value = APP.State.API.primary;
      
      // æª¢æŸ¥å·²ç™»å…¥
      const stored = localStorage.getItem('memberInfo');
      if (stored) {
        try {
          APP.State.memberInfo = JSON.parse(stored);
          APP.State.isAdmin = !!APP.State.memberInfo?.isAdmin;
          APP.Router.go('member');
          return;
        } catch (e) {
          localStorage.removeItem('memberInfo');
        }
      }
      
      // åˆå§‹åŒ– LIFF
      try {
        await APP.LIFF.initAny();
        if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          APP.Auth.debug('å·²ç™»å…¥ LINE: ' + profile.displayName);
        }
      } catch (err) {
        APP.Auth.debug('LIFF åˆå§‹åŒ–å¤±æ•—: ' + err.message);
      }
    },
    
    async testAPIConnection() {
      APP.Auth.setLoading(true);
      try {
        APP.Auth.debug('é–‹å§‹æ¸¬è©¦ API...');
        const result = await APP.API.call('test');
        APP.Auth.setLoading(false);
        if (result?.success) {
          APP.Auth.setAlert('API é€£ç·šæˆåŠŸï¼', 'success');
          APP.Auth.debug('æ¸¬è©¦æˆåŠŸ: ' + JSON.stringify(result));
        } else {
          APP.Auth.setAlert('API å›æ‡‰ç•°å¸¸', 'warning');
        }
      } catch (e) {
        APP.Auth.setLoading(false);
        APP.Auth.setAlert('API é€£ç·šå¤±æ•—ï¼š' + e.message, 'error');
        APP.Auth.debug('éŒ¯èª¤: ' + e.message);
      }
    },
    
    clearDebug() {
      const el = document.getElementById('auth-debug');
      if (el) {
        el.innerHTML = '';
        APP.Auth.debug('å·²æ¸…é™¤é™¤éŒ¯è¨˜éŒ„');
      }
    },
    
    async handleEmailLogin(e) {
      e.preventDefault();
      const emailEl = document.getElementById('login-email');
      const passwordEl = document.getElementById('login-password');
      
      if (!emailEl || !passwordEl) return;
      
      const email = emailEl.value.trim();
      const password = passwordEl.value;
      
      APP.Auth.setLoading(true);
      try {
        const result = await APP.API.call('login', { email, password });
        APP.Auth.setLoading(false);
        
        if (result?.success) {
          APP.State.memberInfo = result.data;
          APP.State.isAdmin = !!result.data?.isAdmin;
          localStorage.setItem('memberInfo', JSON.stringify(result.data));
          APP.Auth.setAlert('ç™»å…¥æˆåŠŸï¼', 'success');
          setTimeout(() => APP.Router.go('member'), 800);
        } else {
          APP.Auth.setAlert(result?.message || 'ç™»å…¥å¤±æ•—', 'error');
        }
      } catch (e2) {
        APP.Auth.setLoading(false);
        APP.Auth.setAlert('ç³»çµ±éŒ¯èª¤ï¼š' + e2.message, 'error');
      }
    },
    
    async handleLineLogin() {
      APP.Auth.debug('é–‹å§‹ LINE ç™»å…¥');
      try {
        await APP.LIFF.ensureLogged();
        
        if (typeof liff === 'undefined' || !liff.isLoggedIn()) {
          APP.Auth.setAlert('LINE ç™»å…¥å¤±æ•—', 'error');
          return;
        }
        
        const profile = await liff.getProfile();
        APP.Auth.debug('LINE ä½¿ç”¨è€…ï¼š' + profile.displayName);
        APP.Auth.setLoading(true);
        
        const result = await APP.API.call('lineLogin', {
          lineUserId: profile.userId,
          displayName: profile.displayName,
          pictureUrl: profile.pictureUrl || ''
        });
        
        APP.Auth.setLoading(false);
        
        if (result?.success) {
          APP.State.memberInfo = result.data;
          APP.State.isAdmin = !!result.data?.isAdmin;
          localStorage.setItem('memberInfo', JSON.stringify(result.data));
          APP.Auth.setAlert('ç™»å…¥æˆåŠŸï¼', 'success');
          setTimeout(() => APP.Router.go('member'), 800);
        } else {
          APP.Auth.setAlert(result?.message || 'LINE ç™»å…¥å¤±æ•—', 'error');
        }
      } catch (e) {
        APP.Auth.setLoading(false);
        APP.Auth.setAlert('LINE ç™»å…¥å¤±æ•—ï¼š' + e.message, 'error');
        APP.Auth.debug('éŒ¯èª¤: ' + e.message);
      }
    },
    
    async handleRegister(e) {
      e.preventDefault();
      const form = e.target;
      
      const pwd = form.elements['reg-password']?.value;
      const pwd2 = form.elements['reg-password-confirm']?.value;
      
      if (pwd !== pwd2) {
        APP.Auth.setAlert('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´', 'error');
        return;
      }
      
      APP.Auth.setLoading(true);
      try {
        let lineUserId = '';
        try {
          await APP.LIFF.initAny();
          if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
            const p = await liff.getProfile();
            lineUserId = p.userId;
          }
        } catch {}
        
        const result = await APP.API.call('register', {
          name: form.elements['reg-name']?.value,
          gender: form.elements['reg-gender']?.value,
          birthday: form.elements['reg-birthday']?.value,
          phone: form.elements['reg-phone']?.value,
          email: form.elements['reg-email']?.value,
          password: pwd,
          lineUserId
        });
        
        APP.Auth.setLoading(false);
        
        if (result?.success) {
          APP.Auth.setAlert('è¨»å†ŠæˆåŠŸï¼è«‹ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸', 'success');
          const loginTab = document.querySelector('.auth-tab[data-pane="pane-login"]');
          if (loginTab) loginTab.click();
        } else {
          APP.Auth.setAlert(result?.message || 'è¨»å†Šå¤±æ•—', 'error');
        }
      } catch (e2) {
        APP.Auth.setLoading(false);
        APP.Auth.setAlert('ç³»çµ±éŒ¯èª¤ï¼š' + e2.message, 'error');
      }
    },
    
    logout() {
      localStorage.removeItem('memberInfo');
      try {
        if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
          liff.logout();
        }
      } catch (e) {}
      APP.State.memberInfo = null;
      APP.State.isAdmin = false;
      APP.Router.go('auth');
    }
  },

  // ========== æœƒå“¡ä¸­å¿ƒ ==========
  Member: {
    selectedMood: 5,
    selectedTags: [],
    
    async initMember() {
      const info = APP.State.memberInfo;
      if (info) {
        const nameEl = document.getElementById('mc-name');
        const noEl = document.getElementById('mc-no');
        const avatarEl = document.getElementById('mc-avatar');
        
        if (nameEl) nameEl.textContent = info.name || '-';
        if (noEl) noEl.textContent = 'æœƒå“¡ç·¨è™Ÿï¼š' + (info.memberNo || '---');
        if (avatarEl) avatarEl.textContent = (info.name || 'A').charAt(0);
      }
      
      // æ¬Šé™è¨­å®š
      const isAdmin = !!APP.State.memberInfo?.isAdmin;
      APP.State.isAdmin = isAdmin;
      document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = isAdmin ? 'block' : 'none';
      });
      
      // åˆå§‹åŒ– Range é¡¯ç¤º
      APP.Member.initRangeDisplays();
      
      // è¨­å®šç•¶å‰æ—¥æœŸ
      APP.Member.setDefaultDates();
      
      // è¼‰å…¥è³‡æ–™
      APP.Member.loadTodayReminders();
      APP.Member.loadUpcomingEvents();
    },
    
    initRangeDisplays() {
      const ranges = ['tremor', 'rigidity', 'brady', 'balance'];
      ranges.forEach(id => {
        const input = document.getElementById(`mc-${id}`);
        const display = document.getElementById(`mc-${id}-val`);
        if (input && display) {
          input.addEventListener('input', () => {
            display.textContent = input.value;
          });
        }
      });
    },
    
    setDefaultDates() {
      const today = new Date().toISOString().split('T')[0];
      const dateInputs = [
        'mc-mood-date',
        'mc-ex-date',
        'mc-sleep-date'
      ];
      dateInputs.forEach(id => {
        const el = document.getElementById(id);
        if (el && !el.value) el.value = today;
      });
    },
    
    show(section) {
      document.querySelectorAll('.member-section').forEach(s => s.classList.remove('active'));
      const el = document.getElementById('mc-' + section);
      if (el) el.classList.add('active');
      
      switch (section) {
        case 'home':
          APP.Member.loadTodayReminders();
          APP.Member.loadUpcomingEvents();
          break;
        case 'symptom':
          APP.Member.loadSymptomHistory();
          break;
        case 'medication':
          APP.Member.loadMedications();
          break;
        case 'events':
          APP.Member.loadEvents();
          APP.Member.loadMyEvents();
          break;
        case 'profile':
          APP.Member.loadProfile();
          APP.Member.loadDonationHistory();
          break;
      }
    },
    
    async loadTodayReminders() {
      const c = document.getElementById('mc-today-reminders');
      if (!c) return;
      
      try {
        const result = await APP.API.call('getMedications', {
          memberId: APP.State.memberInfo?.memberId
        });
        const arr = result.data || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">ä»Šå¤©æ²’æœ‰æé†’äº‹é …</div>';
          return;
        }
        
        let html = '';
        arr.forEach(m => {
          let times = [];
          try {
            times = JSON.parse(m.frequency || '[]');
          } catch {}
          
          times.forEach(t => {
            html += `
              <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                <div>
                  <div class="fw-bold">ğŸ’Š ${m.medicineName}</div>
                  <div class="small text-muted">${t} - ${m.dosage || ''}</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="APP.Member.logMedication('${m.medicationId}','${t}')">å·²æœç”¨</button>
              </div>
            `;
          });
        });
        
        c.innerHTML = html || '<div class="text-center text-muted py-4">ä»Šå¤©æ²’æœ‰æé†’äº‹é …</div>';
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
      }
    },
    
    async loadUpcomingEvents() {
      const c = document.getElementById('mc-upcoming-events');
      if (!c) return;
      
      try {
        const today = new Date().toISOString().split('T')[0];
        const result = await APP.API.call('getEvents', {
          status: 'å ±åä¸­',
          startDate: today,
          page: 1,
          pageSize: 3
        });
        const arr = result.data || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">ç›®å‰æ²’æœ‰æ´»å‹•</div>';
          return;
        }
        
        c.innerHTML = arr.slice(0, 3).map(ev => `
          <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
            <div>
              <div class="fw-bold">${ev.eventName || ev.title}</div>
              <div class="small text-muted">ğŸ“… ${APP.Util.formatDate(ev.eventDate || ev.date)} ${ev.startTime || ev.time || ''}ã€€ğŸ“ ${ev.location || 'æœªæŒ‡å®š'}</div>
            </div>
            <span class="badge bg-info">${ev.registrationCount || ev.currentCount || 0}/${ev.maxParticipants || 0}</span>
          </div>
        `).join('');
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
      }
    },
    
    async addSymptom(e) {
      e.preventDefault();
      
      try {
        const result = await APP.API.call('addDailySymptom', {
          memberId: APP.State.memberInfo?.memberId,
          recordDate: new Date().toISOString().split('T')[0],
          tremorLevel: document.getElementById('mc-tremor')?.value || 0,
          rigidityLevel: document.getElementById('mc-rigidity')?.value || 0,
          bradykinesiaLevel: document.getElementById('mc-brady')?.value || 0,
          balanceLevel: document.getElementById('mc-balance')?.value || 0,
          notes: document.getElementById('mc-symptom-notes')?.value || ''
        });
        
        if (result?.success) {
          APP.Util.toast('è¨˜éŒ„æˆåŠŸ', 'success');
          e.target.reset();
          APP.Member.loadSymptomHistory();
        } else {
          APP.Util.toast(result?.message || 'æ–°å¢å¤±æ•—', 'error');
        }
      } catch (e2) {
        APP.Util.toast('ç³»çµ±éŒ¯èª¤ï¼š' + e2.message, 'error');
      }
    },
    
    async loadSymptomHistory() {
      const c = document.getElementById('mc-symptom-history');
      if (!c) return;
      
      try {
        const end = new Date().toISOString().split('T')[0];
        const start = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        const result = await APP.API.call('getDailySymptoms', {
          memberId: APP.State.memberInfo?.memberId,
          startDate: start,
          endDate: end
        });
        const arr = result.data || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">å°šç„¡è¨˜éŒ„</div>';
          return;
        }
        
        c.innerHTML = arr.map(s => `
          <div class="border rounded p-2 mb-2">
            <div class="fw-bold">${APP.Util.formatDate(s.recordDate)}</div>
            <div class="small text-muted">
              é¡«æŠ–:${s.tremorLevel} | åƒµç¡¬:${s.rigidityLevel} |
              é²ç·©:${s.bradykinesiaLevel} | å¹³è¡¡:${s.balanceLevel}
            </div>
            ${s.notes ? `<div class="small text-muted mt-1">${s.notes}</div>` : ''}
          </div>
        `).join('');
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
      }
    },
    
    openAddMedication() {
      const html = `
        <div class="modal fade" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">æ–°å¢ç”¨è—¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">è—¥ç‰©åç¨± *</label>
                  <input class="form-control" name="name" required/>
                </div>
                <div class="mb-3">
                  <label class="form-label">åŠ‘é‡</label>
                  <input class="form-control" name="dosage" placeholder="ä¾‹å¦‚ï¼š1é¡†"/>
                </div>
                <div class="mb-3">
                  <label class="form-label mb-2">æœç”¨æ™‚é–“ï¼ˆè‡³å°‘ä¸€å€‹ï¼‰</label><br/>
                  ${['08:00', '12:00', '18:00', '22:00'].map(t => `
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="checkbox" name="times" value="${t}" id="t-${t}">
                      <label class="form-check-label" for="t-${t}">${t}</label>
                    </div>`).join('')}
                </div>
                <div class="mb-3">
                  <label class="form-label">é–‹å§‹æ—¥æœŸ</label>
                  <input type="date" class="form-control" name="startdate" value="${new Date().toISOString().split('T')[0]}"/>
                </div>
                <div class="form-check mb-3">
                  <input class="form-check-input" type="checkbox" name="reminder" id="reminder" checked/>
                  <label class="form-check-label" for="reminder">å•Ÿç”¨æé†’</label>
                </div>
                <div class="mb-3">
                  <label class="form-label">æå‰æé†’ï¼ˆåˆ†é˜ï¼‰</label>
                  <input type="number" class="form-control" name="advance" value="10" min="0"/>
                </div>
                <div class="mb-3">
                  <label class="form-label">å‚™è¨»</label>
                  <textarea class="form-control" name="notes" rows="3"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button class="btn btn-primary" type="submit">æ–°å¢ç”¨è—¥</button>
              </div>
            </form>
          </div>
        </div>`;
      
      APP.Util.modal(html, async (fd) => {
        const times = fd.getAll('times');
        if (!times.length) throw new Error('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æœè—¥æ™‚é–“');
        
        const result = await APP.API.call('addMedication', {
          memberId: APP.State.memberInfo?.memberId,
          medicineName: fd.get('name'),
          dosage: fd.get('dosage'),
          frequency: JSON.stringify(times),
          startDate: fd.get('startdate') || new Date().toISOString().split('T')[0],
          reminderEnabled: fd.get('reminder') === 'on',
          reminderMinutes: fd.get('advance') || 10,
          notes: fd.get('notes') || ''
        });
        
        if (result?.success) {
          APP.Util.toast('ç”¨è—¥æ–°å¢æˆåŠŸ', 'success');
          APP.Member.loadMedications();
          APP.Member.loadTodayReminders();
        }
      });
    },
    
    async loadMedications() {
      const c = document.getElementById('mc-medications-list');
      if (!c) return;
      
      try {
        const result = await APP.API.call('getMedications', {
          memberId: APP.State.memberInfo?.memberId
        });
        const arr = result.data || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">å°šç„¡ç”¨è—¥è³‡æ–™</div>';
          return;
        }
        
        c.innerHTML = arr.map(m => {
          let times = [];
          try { times = JSON.parse(m.frequency || '[]'); } catch {}
          
          return `
            <div class="border rounded p-3 mb-2">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-bold">${m.medicineName}</div>
                  <div class="small text-muted">åŠ‘é‡ï¼š${m.dosage || '-'}</div>
                  <div class="small text-muted">æ™‚é–“ï¼š${times.join(', ')}</div>
                  <div class="small text-muted">é–‹å§‹æ—¥æœŸï¼š${APP.Util.formatDate(m.startDate)}</div>
                  ${m.notes ? `<div class="small text-muted">å‚™è¨»ï¼š${m.notes}</div>` : ''}
                </div>
                <span class="badge ${m.reminderEnabled ? 'bg-success' : 'bg-secondary'}">
                  ${m.reminderEnabled ? 'æé†’é–‹å•Ÿ' : 'æé†’é—œé–‰'}
                </span>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
      }
    },
    
    async logMedication(medicationId, scheduledTime) {
      try {
        const result = await APP.API.call('logMedication', {
          medicationId,
          memberId: APP.State.memberInfo?.memberId,
          scheduledTime,
          status: 'å·²æœç”¨'
        });
        
        if (result?.success) {
          APP.Util.toast('å·²è¨˜éŒ„æœè—¥', 'success');
          APP.Member.loadTodayReminders();
        }
      } catch (e) {
        APP.Util.toast('è¨˜éŒ„å¤±æ•—ï¼š' + e.message, 'error');
      }
    },
    
    async addExercise(e) {
      e.preventDefault();
      
      try {
        const result = await APP.API.call('addExerciseLog', {
          memberId: APP.State.memberInfo?.memberId,
          exerciseDate: document.getElementById('mc-ex-date')?.value,
          exerciseType: document.getElementById('mc-ex-type')?.value,
          duration: document.getElementById('mc-ex-duration')?.value,
          intensity: document.getElementById('mc-ex-intensity')?.value,
          bodyCondition: document.getElementById('mc-ex-condition')?.value,
          notes: document.getElementById('mc-ex-notes')?.value || ''
        });
        
        if (result?.success) {
          APP.Util.toast('é‹å‹•è¨˜éŒ„æˆåŠŸ', 'success');
          e.target.reset();
          APP.Member.setDefaultDates();
        }
      } catch (e2) {
        APP.Util.toast('è¨˜éŒ„å¤±æ•—ï¼š' + e2.message, 'error');
      }
    },
    
    async addSleep(e) {
      e.preventDefault();
      
      try {
        const bedtime = document.getElementById('mc-sleep-bedtime')?.value;
        const waketime = document.getElementById('mc-sleep-wake')?.value;
        
        let duration = 0;
        if (bedtime && waketime) {
          const bed = new Date('2000-01-01 ' + bedtime);
          let wake = new Date('2000-01-01 ' + waketime);
          if (wake < bed) wake = new Date('2000-01-02 ' + waketime);
          duration = ((wake - bed) / (1000 * 60 * 60)).toFixed(1);
        }
        
        const result = await APP.API.call('addSleepLog', {
          memberId: APP.State.memberInfo?.memberId,
          sleepDate: document.getElementById('mc-sleep-date')?.value,
          bedtime,
          wakeTime: waketime,
          duration,
          quality: document.getElementById('mc-sleep-quality')?.value,
          wakeCount: document.getElementById('mc-sleep-wake-count')?.value || 0,
          hasDream: document.getElementById('mc-sleep-dream')?.checked || false,
          hasNightmare: document.getElementById('mc-sleep-nightmare')?.checked || false,
          notes: document.getElementById('mc-sleep-notes')?.value || ''
        });
        
        if (result?.success) {
          APP.Util.toast('ç¡çœ è¨˜éŒ„æˆåŠŸ', 'success');
          e.target.reset();
          APP.Member.setDefaultDates();
        }
      } catch (e2) {
        APP.Util.toast('è¨˜éŒ„å¤±æ•—ï¼š' + e2.message, 'error');
      }
    },
    
    selectMood(score) {
      APP.Member.selectedMood = score;
      document.querySelectorAll('.mood-option').forEach(opt => {
        opt.classList.toggle('active', parseInt(opt.dataset.score) === score);
      });
    },
    
    toggleMoodTag(tag) {
      const idx = APP.Member.selectedTags.indexOf(tag);
      if (idx > -1) {
        APP.Member.selectedTags.splice(idx, 1);
      } else {
        APP.Member.selectedTags.push(tag);
      }
      
      document.querySelectorAll('.mood-tag').forEach(t => {
        t.classList.toggle('active', APP.Member.selectedTags.includes(t.dataset.tag));
      });
    },
    
    async addMood(e) {
      e.preventDefault();
      
      try {
        const result = await APP.API.call('addMoodDiary', {
          memberId: APP.State.memberInfo?.memberId,
          diaryDate: document.getElementById('mc-mood-date')?.value,
          moodScore: APP.Member.selectedMood,
          moodTags: APP.Member.selectedTags.join(','),
          content: document.getElementById('mc-mood-content')?.value || ''
        });
        
        if (result?.success) {
          APP.Util.toast('å¿ƒæƒ…æ—¥è¨˜è¨˜éŒ„æˆåŠŸ', 'success');
          e.target.reset();
          APP.Member.selectedMood = 5;
          APP.Member.selectedTags = [];
          document.querySelectorAll('.mood-option').forEach(o => o.classList.remove('active'));
          document.querySelectorAll('.mood-tag').forEach(t => t.classList.remove('active'));
          APP.Member.setDefaultDates();
        }
      } catch (e2) {
        APP.Util.toast('è¨˜éŒ„å¤±æ•—ï¼š' + e2.message, 'error');
      }
    },
    
    async loadEvents() {
      const c = document.getElementById('mc-events-list');
      if (!c) return;
      
      try {
        const result = await APP.API.call('getAllEvents');
        const arr = result.data || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">ç›®å‰æ²’æœ‰æ´»å‹•</div>';
          return;
        }
        
        c.innerHTML = arr.map(ev => `
          <div class="border rounded p-3 mb-2">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="fw-bold">${ev.eventName || ev.title}</div>
              <span class="badge bg-${APP.Util.getStatusClass(ev.status)}">${ev.status}</span>
            </div>
            <div class="small text-muted mb-2">${ev.description || ''}</div>
            <div class="small text-muted">
              ğŸ“… ${APP.Util.formatDate(ev.eventDate || ev.date)} ${ev.startTime || ev.time || ''}-${ev.endTime || ''}<br/>
              ğŸ“ ${ev.location || 'æœªæŒ‡å®š'}<br/>
              ğŸ‘¥ ${ev.registrationCount || ev.currentCount || 0}/${ev.maxParticipants || 0}
              ${ev.fee ? `<br/>ğŸ’° $${APP.Util.currency(ev.fee)}` : ''}
            </div>
            ${(ev.status === 'å ±åä¸­' || ev.status === 'é–‹æ”¾å ±å') ? `
              <button class="btn btn-sm btn-primary mt-2" onclick="APP.Member.registerEvent('${ev.id || ev.eventId}')">
                ç«‹å³å ±å
              </button>` : ''}
          </div>
        `).join('');
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
      }
    },
    
    async loadMyEvents() {
      const c = document.getElementById('mc-my-events-list');
      if (!c) return;
      
      try {
        const result = await APP.API.call('getMyEvents', {
          memberId: APP.State.memberInfo?.memberId
        });
        const arr = result.data || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">æ‚¨é‚„æ²’æœ‰å ±åä»»ä½•æ´»å‹•</div>';
          return;
        }
        
        c.innerHTML = arr.map(ev => `
          <div class="border rounded p-3 mb-2">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-bold">${ev.eventName || ev.activityTitle}</div>
                <div class="small text-muted">
                  ğŸ“… ${APP.Util.formatDate(ev.eventDate || ev.date)} ${ev.startTime || ev.time || ''}<br/>
                  ğŸ“ ${ev.location || ''}
                </div>
              </div>
              <span class="badge bg-${APP.Util.getStatusClass(ev.registrationStatus || ev.status)}">
                ${ev.registrationStatus || ev.status}
              </span>
            </div>
          </div>
        `).join('');
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
      }
    },
    
    async registerEvent(eventId) {
      if (!confirm('ç¢ºå®šè¦å ±åæ­¤æ´»å‹•å—ï¼Ÿ')) return;
      
      try {
        const result = await APP.API.call('registerActivity', {
          activityId: eventId,
          memberId: APP.State.memberInfo?.memberId
        });
        
        if (result?.success) {
          APP.Util.toast('å ±åæˆåŠŸï¼', 'success');
          APP.Member.loadEvents();
          APP.Member.loadMyEvents();
        }
      } catch (e) {
        APP.Util.toast('å ±åå¤±æ•—ï¼š' + e.message, 'error');
      }
    },
    
    async loadProfile() {
      try {
        const result = await APP.API.call('getMemberInfo', {
          memberId: APP.State.memberInfo?.memberId
        });
        const info = result.data || {};
        
        const setEl = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.textContent = val || '-';
        };
        
        setEl('mc-profile-name', info.name);
        setEl('mc-profile-no', info.memberNo);
        setEl('mc-profile-email', info.email);
        setEl('mc-profile-phone', info.phone);
        setEl('mc-profile-address', info.address);
      } catch (e) {
        console.error('loadProfile error:', e);
      }
    },
    
    async loadDonationHistory() {
      const c = document.getElementById('mc-donation-history');
      if (!c) return;
      
      try {
        const result = await APP.API.call('getFinanceData', {
          memberId: APP.State.memberInfo?.memberId
        });
        const arr = result.data?.donations || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">å°šç„¡ææ¬¾è¨˜éŒ„</div>';
          return;
        }
        
        c.innerHTML = arr.map(d => `
          <div class="border rounded p-2 mb-2">
            <div class="d-flex justify-content-between">
              <div>
                <div class="fw-bold">$${APP.Util.currency(d.amount)}</div>
                <div class="small text-muted">${d.category || 'ä¸€èˆ¬ææ¬¾'} - ${APP.Util.formatDate(d.createdAt || d.donationDate)}</div>
              </div>
              <span class="badge bg-${APP.Util.getStatusClass(d.status)}">${d.status}</span>
            </div>
          </div>
        `).join('');
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
      }
    }
  },

  // ========== ç®¡ç†å¾Œå° ==========
  Admin: {
    currentPage: 1,
    
    async initAdmin() {
      APP.Admin.show('dashboard');
    },
    
    show(section) {
      document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
      const el = document.getElementById('admin-' + section);
      if (el) el.classList.add('active');
      
      switch (section) {
        case 'dashboard':
          APP.Admin.loadDashboard();
          break;
        case 'members':
          APP.Admin.loadMembers();
          break;
        case 'events':
          APP.Admin.loadEvents();
          break;
        case 'health':
          APP.Admin.loadHealthRecords();
          break;
        case 'donations':
          APP.Admin.loadDonations();
          break;
        case 'volunteers':
          APP.Admin.loadVolunteers();
          break;
        case 'finance':
          APP.Admin.loadFinance();
          break;
      }
    },
    
    async loadDashboard() {
      try {
        const result = await APP.API.call('getDashboardStats');
        const stats = result.data || {};
        
        const setEl = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.textContent = val;
        };
        
        setEl('admin-stat-members', stats.totalMembers || 0);
        setEl('admin-stat-events', stats.monthlyEvents || 0);
        setEl('admin-stat-volunteers', stats.totalVolunteers || 0);
        setEl('admin-stat-donations', '$' + APP.Util.currency(stats.monthlyDonations || 0));
        
        const actResult = await APP.API.call('getRecentActivities');
        APP.Admin.renderRecentActivities(actResult.data || []);
        
        const taskResult = await APP.API.call('getPendingTasks');
        APP.Admin.renderPendingTasks(taskResult.data || []);
      } catch (e) {
        console.error('loadDashboard error:', e);
      }
    },
    
    renderRecentActivities(arr) {
      const c = document.getElementById('admin-recent-activities');
      if (!c) return;
      
      if (!arr.length) {
        c.innerHTML = '<div class="text-center text-muted py-3">æš«ç„¡å‹•æ…‹</div>';
        return;
      }
      
      c.innerHTML = arr.map(a => `
        <div class="d-flex align-items-start mb-2 pb-2 border-bottom">
          <i class="bi bi-circle-fill text-primary me-2" style="font-size:8px;margin-top:6px;"></i>
          <div class="flex-grow-1">
            <div class="small">${a.description}</div>
            <div class="text-muted" style="font-size:11px;">${a.timestamp}</div>
          </div>
        </div>
      `).join('');
    },
    
    renderPendingTasks(arr) {
      const c = document.getElementById('admin-pending-tasks');
      if (!c) return;
      
      if (!arr.length) {
        c.innerHTML = '<div class="text-center text-muted py-3">æ²’æœ‰å¾…è™•ç†äº‹é …</div>';
        return;
      }
      
      c.innerHTML = arr.map(t => `
        <div class="border rounded p-2 mb-2">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-bold">${t.title}</div>
              <div class="small text-muted">${t.description}</div>
            </div>
            <span class="badge bg-${t.priority === 'é«˜' ? 'danger' : 'warning'}">${t.priority}</span>
          </div>
        </div>
      `).join('');
    },
    
    async loadMembers(page = 1, search = '', status = '') {
      APP.Admin.currentPage = page;
      const c = document.getElementById('admin-members-list');
      if (!c) return;
      
      try {
        APP.Util.showLoading(true);
        const result = await APP.API.call('getMembers', {
          page,
          pageSize: APP.State.pageSize,
          search,
          status
        });
        const arr = result.data || [];
        const totalPages = result.totalPages || 1;
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">æŸ¥ç„¡è³‡æ–™</div>';
          return;
        }
        
        c.innerHTML = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>æœƒå“¡ç·¨è™Ÿ</th>
                <th>å§“å</th>
                <th>é›»å­éƒµä»¶</th>
                <th>æ‰‹æ©Ÿ</th>
                <th>è¨»å†Šæ—¥æœŸ</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(m => `
                <tr>
                  <td>${m.memberNo || '-'}</td>
                  <td>${m.name || '-'}</td>
                  <td>${m.email || '-'}</td>
                  <td>${m.phone || '-'}</td>
                  <td>${APP.Util.formatDate(m.registerDate || m.createdAt)}</td>
                  <td><span class="badge bg-${APP.Util.getStatusClass(m.status)}">${m.status}</span></td>
                  <td>
                    ${m.status === 'å¾…å¯©æ ¸' ? `
                      <button class="btn btn-sm btn-success" onclick="APP.Admin.approveMember('${m.memberId || m.id}')">
                        <i class="bi bi-check"></i>
                      </button>` : ''}
                    <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteMember('${m.memberId || m.id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          ${APP.Admin.renderPagination(page, totalPages, 'loadMembers')}
        `;
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
      } finally {
        APP.Util.showLoading(false);
      }
    },
    
    renderPagination(current, total, funcName) {
      if (total <= 1) return '';
      
      let html = '<nav class="mt-3"><ul class="pagination justify-content-center">';
      
      if (current > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="APP.Admin.${funcName}(${current - 1});return false;">ä¸Šä¸€é </a></li>`;
      }
      
      for (let i = 1; i <= total; i++) {
        if (i === current) {
          html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else if (i === 1 || i === total || Math.abs(i - current) <= 2) {
          html += `<li class="page-item"><a class="page-link" href="#" onclick="APP.Admin.${funcName}(${i});return false;">${i}</a></li>`;
        } else if (Math.abs(i - current) === 3) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
      }
      
      if (current < total) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="APP.Admin.${funcName}(${current + 1});return false;">ä¸‹ä¸€é </a></li>`;
      }
      
      html += '</ul></nav>';
      return html;
    },
    
    async approveMember(memberId) {
      if (!confirm('ç¢ºå®šè¦æ ¸å‡†æ­¤æœƒå“¡å—ï¼Ÿ')) return;
      
      try {
        await APP.API.call('approveMember', { memberId });
        APP.Util.toast('å·²æ ¸å‡†', 'success');
        APP.Admin.loadMembers(APP.Admin.currentPage);
      } catch (e) {
        APP.Util.toast('æ“ä½œå¤±æ•—ï¼š' + e.message, 'error');
      }
    },
    
    async deleteMember(memberId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æœƒå“¡å—ï¼Ÿ')) return;
      
      try {
        await APP.API.call('deleteMember', { memberId });
        APP.Util.toast('å·²åˆªé™¤', 'success');
        APP.Admin.loadMembers(APP.Admin.currentPage);
      } catch (e) {
        APP.Util.toast('æ“ä½œå¤±æ•—ï¼š' + e.message, 'error');
      }
    },
    
    openAddMember() {
      const html = `
        <div class="modal fade" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">æ–°å¢æœƒå“¡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">å§“å *</label>
                  <input class="form-control" name="name" required/>
                </div>
                <div class="mb-3">
                  <label class="form-label">é›»å­éƒµä»¶ *</label>
                  <input type="email" class="form-control" name="email" required/>
                </div>
                <div class="mb-3">
                  <label class="form-label">æ‰‹æ©Ÿ</label>
                  <input class="form-control" name="phone"/>
                </div>
                <div class="mb-3">
                  <label class="form-label">åœ°å€</label>
                  <input class="form-control" name="address"/>
                </div>
                <div class="mb-3">
                  <label class="form-label">å‚™è¨»</label>
                  <textarea class="form-control" name="notes" rows="3"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">æ–°å¢</button>
              </div>
            </form>
          </div>
        </div>`;
      
      APP.Util.modal(html, async (fd) => {
        await APP.API.call('addMember', {
          name: fd.get('name'),
          email: fd.get('email'),
          phone: fd.get('phone'),
          address: fd.get('address'),
          notes: fd.get('notes')
        });
        APP.Util.toast('æœƒå“¡æ–°å¢æˆåŠŸ', 'success');
        APP.Admin.loadMembers();
      });
    },
    
    async loadEvents(page = 1) {
      APP.Admin.currentPage = page;
      const c = document.getElementById('admin-events-list');
      if (!c) return;
      
      try {
        APP.Util.showLoading(true);
        const result = await APP.API.call('getEvents', {
          page,
          pageSize: APP.State.pageSize
        });
        const arr = result.data || [];
        const totalPages = result.totalPages || 1;
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">æŸ¥ç„¡è³‡æ–™</div>';
          return;
        }
        
        c.innerHTML = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>æ´»å‹•åç¨±</th>
                <th>é¡å‹</th>
                <th>æ—¥æœŸ</th>
                <th>åœ°é»</th>
                <th>äººæ•¸</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(e => `
                <tr>
                  <td>${e.eventName || e.title}</td>
                  <td>${e.eventType || e.type || '-'}</td>
                  <td>${APP.Util.formatDate(e.eventDate || e.date)}</td>
                  <td>${e.location || '-'}</td>
                  <td>${e.registrationCount || e.currentCount || 0}/${e.maxParticipants || 0}</td>
                  <td><span class="badge bg-${APP.Util.getStatusClass(e.status)}">${e.status}</span></td>
                  <td>
                    <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteEvent('${e.eventId || e.id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          ${APP.Admin.renderPagination(page, totalPages, 'loadEvents')}
        `;
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
      } finally {
        APP.Util.showLoading(false);
      }
    },
    
    async deleteEvent(eventId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ´»å‹•å—ï¼Ÿ')) return;
      
      try {
        await APP.API.call('deleteEvent', { eventId });
        APP.Util.toast('å·²åˆªé™¤', 'success');
        APP.Admin.loadEvents(APP.Admin.currentPage);
      } catch (e) {
        APP.Util.toast('æ“ä½œå¤±æ•—ï¼š' + e.message, 'error');
      }
    },
    
    openAddEvent() {
      const html = `
        <div class="modal fade" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">æ–°å¢æ´»å‹•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">æ´»å‹•åç¨± *</label>
                  <input class="form-control" name="eventName" required/>
                </div>
                <div class="mb-3">
                  <label class="form-label">æ´»å‹•é¡å‹</label>
                  <select class="form-select" name="eventType">
                    <option>è¬›åº§</option>
                    <option>é‹å‹•èª²ç¨‹</option>
                    <option>è¯èª¼æ´»å‹•</option>
                    <option>å…¶ä»–</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">æ´»å‹•æ—¥æœŸ *</label>
                  <input type="date" class="form-control" name="eventDate" required/>
                </div>
                <div class="row mb-3">
                  <div class="col-6">
                    <label class="form-label">é–‹å§‹æ™‚é–“</label>
                    <input type="time" class="form-control" name="startTime" value="09:00"/>
                  </div>
                  <div class="col-6">
                    <label class="form-label">çµæŸæ™‚é–“</label>
                    <input type="time" class="form-control" name="endTime" value="12:00"/>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">åœ°é» *</label>
                  <input class="form-control" name="location" required/>
                </div>
                <div class="mb-3">
                  <label class="form-label">äººæ•¸ä¸Šé™ *</label>
                  <input type="number" class="form-control" name="maxParticipants" value="30" required/>
                </div>
                <div class="mb-3">
                  <label class="form-label">è²»ç”¨</label>
                  <input type="number" class="form-control" name="fee" value="0"/>
                </div>
                <div class="mb-3">
                  <label class="form-label">æ´»å‹•èªªæ˜</label>
                  <textarea class="form-control" name="description" rows="3"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">æ–°å¢</button>
              </div>
            </form>
          </div>
        </div>`;
      
      APP.Util.modal(html, async (fd) => {
        await APP.API.call('createEvent', {
          eventName: fd.get('eventName'),
          eventType: fd.get('eventType'),
          eventDate: fd.get('eventDate'),
          startTime: fd.get('startTime'),
          endTime: fd.get('endTime'),
          location: fd.get('location'),
          maxParticipants: fd.get('maxParticipants'),
          fee: fd.get('fee'),
          description: fd.get('description')
        });
        APP.Util.toast('æ´»å‹•æ–°å¢æˆåŠŸ', 'success');
        APP.Admin.loadEvents();
      });
    },
    
    async loadHealthRecords(page = 1) {
      APP.Admin.currentPage = page;
      const c = document.getElementById('admin-health-list');
      if (!c) return;
      
      try {
        APP.Util.showLoading(true);
        const result = await APP.API.call('getAllHealthRecords', {
          page,
          pageSize: APP.State.pageSize
        });
        const arr = result.data || [];
        const totalPages = result.totalPages || 1;
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">æŸ¥ç„¡è³‡æ–™</div>';
          return;
        }
        
        c.innerHTML = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>æœƒå“¡å§“å</th>
                <th>è¨˜éŒ„æ—¥æœŸ</th>
                <th>é¡«æŠ–</th>
                <th>åƒµç¡¬</th>
                <th>é²ç·©</th>
                <th>å¹³è¡¡</th>
                <th>å‚™è¨»</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(r => `
                <tr>
                  <td>${r.memberName || '-'}</td>
                  <td>${APP.Util.formatDate(r.recordDate)}</td>
                  <td>${r.tremorLevel}</td>
                  <td>${r.rigidityLevel}</td>
                  <td>${r.bradykinesiaLevel}</td>
                  <td>${r.balanceLevel}</td>
                  <td>${r.notes || '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          ${APP.Admin.renderPagination(page, totalPages, 'loadHealthRecords')}
        `;
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
      } finally {
        APP.Util.showLoading(false);
      }
    },
    
    async loadDonations(page = 1) {
      APP.Admin.currentPage = page;
      const c = document.getElementById('admin-donations-list');
      if (!c) return;
      
      try {
        APP.Util.showLoading(true);
        const result = await APP.API.call('getDonations', {
          page,
          pageSize: APP.State.pageSize
        });
        const arr = result.data || [];
        const totalPages = result.totalPages || 1;
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">æŸ¥ç„¡è³‡æ–™</div>';
          return;
        }
        
        c.innerHTML = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ææ¬¾äºº</th>
                <th>é‡‘é¡</th>
                <th>é¡å‹</th>
                <th>æ—¥æœŸ</th>
                <th>ä»˜æ¬¾æ–¹å¼</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(d => `
                <tr>
                  <td>${d.donorName || d.memberName || '-'}</td>
                  <td>$${APP.Util.currency(d.amount)}</td>
                  <td>${d.donationType || d.category || '-'}</td>
                  <td>${APP.Util.formatDate(d.donationDate || d.createdAt)}</td>
                  <td>${d.paymentMethod || '-'}</td>
                  <td><span class="badge bg-${APP.Util.getStatusClass(d.status)}">${d.status}</span></td>
                  <td>
                    <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteDonation('${d.donationId || d.id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          ${APP.Admin.renderPagination(page, totalPages, 'loadDonations')}
        `;
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
      } finally {
        APP.Util.showLoading(false);
      }
    },
    
    async deleteDonation(donationId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ææ¬¾è¨˜éŒ„å—ï¼Ÿ')) return;
      
      try {
        await APP.API.call('deleteDonation', { donationId });
        APP.Util.toast('å·²åˆªé™¤', 'success');
        APP.Admin.loadDonations(APP.Admin.currentPage);
      } catch (e) {
        APP.Util.toast('æ“ä½œå¤±æ•—ï¼š' + e.message, 'error');
      }
    },
    
    async loadVolunteers() {
      const c = document.getElementById('admin-volunteers-list');
      if (!c) return;
      
      try {
        APP.Util.showLoading(true);
        const result = await APP.API.call('getVolunteers');
        const arr = result.data || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">æŸ¥ç„¡è³‡æ–™</div>';
          return;
        }
        
        c.innerHTML = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>å¿—å·¥ç·¨è™Ÿ</th>
                <th>å§“å</th>
                <th>æ‰‹æ©Ÿ</th>
                <th>åŠ å…¥æ—¥æœŸ</th>
                <th>ç¸½æ™‚æ•¸</th>
                <th>ç‹€æ…‹</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(v => `
                <tr>
                  <td>${v.volunteerNo || '-'}</td>
                  <td>${v.name || '-'}</td>
                  <td>${v.phone || '-'}</td>
                  <td>${APP.Util.formatDate(v.joinDate)}</td>
                  <td>${v.totalHours || 0}å°æ™‚</td>
                  <td><span class="badge bg-${APP.Util.getStatusClass(v.status)}">${v.status}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
      } finally {
        APP.Util.showLoading(false);
      }
    },
    
    async loadFinance() {
      const c = document.getElementById('admin-finance-list');
      if (!c) return;
      
      try {
        APP.Util.showLoading(true);
        const result = await APP.API.call('getFinanceRecords', {});
        const data = result.data || {};
        
        const setEl = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.textContent = val;
        };
        
        setEl('admin-total-income', '$' + APP.Util.currency(data.totalIncome || 0));
        setEl('admin-total-expense', '$' + APP.Util.currency(data.totalExpense || 0));
        setEl('admin-net-balance', '$' + APP.Util.currency((data.totalIncome || 0) - (data.totalExpense || 0)));
        
        const arr = data.records || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">æŸ¥ç„¡è³‡æ–™</div>';
          return;
        }
        
        c.innerHTML = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>é¡å‹</th>
                <th>é¡åˆ¥</th>
                <th>é‡‘é¡</th>
                <th>å» å•†/ææ¬¾äºº</th>
                <th>èªªæ˜</th>
                <th>ç‹€æ…‹</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(r => `
                <tr>
                  <td>${APP.Util.formatDate(r.transactionDate || r.date)}</td>
                  <td><span class="badge bg-${r.type === 'æ”¶å…¥' ? 'success' : 'danger'}">${r.type}</span></td>
                  <td>${r.category}</td>
                  <td class="${r.type === 'æ”¶å…¥' ? 'text-success' : 'text-danger'}">
                    ${r.type === 'æ”¶å…¥' ? '+' : '-'}$${APP.Util.currency(r.amount)}
                  </td>
                  <td>${r.vendor || r.donorName || '-'}</td>
                  <td>${r.description || '-'}</td>
                  <td><span class="badge bg-${APP.Util.getStatusClass(r.status)}">${r.status}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">è¼‰å…¥å¤±æ•—</div>';
      } finally {
        APP.Util.showLoading(false);
      }
    }
  }
};

// ========== åˆå§‹åŒ– ==========
document.addEventListener('DOMContentLoaded', async () => {
  console.log('ç³»çµ±åˆå§‹åŒ–ä¸­...');
  
  // åˆå§‹åŒ–èªè­‰
  await APP.Auth.init();
  
  // ç¶å®šå…¨åŸŸäº‹ä»¶
  const loginForm = document.getElementById('emailLoginForm');
  if (loginForm) {
    loginForm.addEventListener('submit', APP.Auth.handleEmailLogin);
  }
  
  const regForm = document.getElementById('registerForm');
  if (regForm) {
    regForm.addEventListener('submit', APP.Auth.handleRegister);
  }
  
  const symptomForm = document.getElementById('mc-symptom-form');
  if (symptomForm) {
    symptomForm.addEventListener('submit', APP.Member.addSymptom);
  }
  
  const exerciseForm = document.getElementById('mc-exercise-form');
  if (exerciseForm) {
    exerciseForm.addEventListener('submit', APP.Member.addExercise);
  }
  
  const sleepForm = document.getElementById('mc-sleep-form');
  if (sleepForm) {
    sleepForm.addEventListener('submit', APP.Member.addSleep);
  }
  
  const moodForm = document.getElementById('mc-mood-form');
  if (moodForm) {
    moodForm.addEventListener('submit', APP.Member.addMood);
  }
  
  // è¨­å®šç•¶å‰ API URL
  const urlDisplay = document.getElementById('current-api-url');
  if (urlDisplay) urlDisplay.textContent = APP.State.API.primary;
  
  const urlInput = document.getElementById('global-api-url');
  if (urlInput) urlInput.value = APP.State.API.primary;
  
  console.log('ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
});

// æš´éœ²å…¨åŸŸå‡½æ•¸ä¾› HTML onclick ä½¿ç”¨
window.APP = APP;

// ========== é¡å¤–çš„ UI å¢å¼· ==========

// è‡ªå‹•éš±è— Alert
document.addEventListener('DOMContentLoaded', () => {
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        const target = mutation.target;
        if (target.classList.contains('alert') && !target.classList.contains('d-none')) {
          setTimeout(() => {
            target.classList.add('d-none');
          }, 5000);
        }
      }
    });
  });
  
  const alerts = document.querySelectorAll('.alert');
  alerts.forEach(alert => {
    observer.observe(alert, { attributes: true });
  });
});

// è¡¨å–®é©—è­‰å¢å¼·
document.addEventListener('DOMContentLoaded', () => {
  const forms = document.querySelectorAll('form');
  forms.forEach(form => {
    form.addEventListener('submit', (e) => {
      if (!form.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
      }
      form.classList.add('was-validated');
    });
  });
});

// è‡ªå‹•èª¿æ•´ Textarea é«˜åº¦
document.addEventListener('DOMContentLoaded', () => {
  const textareas = document.querySelectorAll('textarea');
  textareas.forEach(textarea => {
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
  });
});

// åœ–ç‰‡è¼‰å…¥éŒ¯èª¤è™•ç†
document.addEventListener('DOMContentLoaded', () => {
  document.addEventListener('error', (e) => {
    if (e.target.tagName === 'IMG') {
      e.target.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23f0f0f0" width="100" height="100"/%3E%3Ctext x="50" y="50" text-anchor="middle" dominant-baseline="middle" font-size="40"%3EğŸ‘¤%3C/text%3E%3C/svg%3E';
    }
  }, true);
});

// ç¶²è·¯ç‹€æ…‹ç›£æ§
window.addEventListener('online', () => {
  APP.Util.toast('ç¶²è·¯é€£ç·šå·²æ¢å¾©', 'success');
});

window.addEventListener('offline', () => {
  APP.Util.toast('ç¶²è·¯é€£ç·šå·²ä¸­æ–·', 'warning');
});

// é˜²æ­¢é‡è¤‡æäº¤
document.addEventListener('DOMContentLoaded', () => {
  let isSubmitting = false;
  
  document.addEventListener('submit', (e) => {
    if (isSubmitting) {
      e.preventDefault();
      return false;
    }
    
    isSubmitting = true;
    setTimeout(() => {
      isSubmitting = false;
    }, 2000);
  });
});

// Smooth Scroll
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
      const href = this.getAttribute('href');
      if (href === '#') return;
      
      e.preventDefault();
      const target = document.querySelector(href);
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });
});

// è¿”å›é ‚éƒ¨æŒ‰éˆ•ï¼ˆå¯é¸ï¼‰
document.addEventListener('DOMContentLoaded', () => {
  const backToTop = document.createElement('button');
  backToTop.innerHTML = '<i class="bi bi-arrow-up"></i>';
  backToTop.className = 'btn btn-primary';
  backToTop.style.cssText = `
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: none;
    z-index: 1000;
    padding: 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  `;
  
  backToTop.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
  
  document.body.appendChild(backToTop);
  
  window.addEventListener('scroll', () => {
    if (window.pageYOffset > 300) {
      backToTop.style.display = 'block';
    } else {
      backToTop.style.display = 'none';
    }
  });
});

// éµç›¤å¿«æ·éµï¼ˆå¯é¸ï¼‰
document.addEventListener('keydown', (e) => {
  // Ctrl/Cmd + K: æœå°‹
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    const searchInput = document.querySelector('input[type="search"], input[placeholder*="æœå°‹"]');
    if (searchInput) searchInput.focus();
  }
  
  // ESC: é—œé–‰ Modal
  if (e.key === 'Escape') {
    const modals = document.querySelectorAll('.modal.show');
    modals.forEach(modal => {
      const bsModal = bootstrap.Modal.getInstance(modal);
      if (bsModal) bsModal.hide();
    });
  }
});

// è¤‡è£½åˆ°å‰ªè²¼ç°¿åŠŸèƒ½
window.copyToClipboard = async (text) => {
  try {
    await navigator.clipboard.writeText(text);
    APP.Util.toast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
  } catch (err) {
    // Fallback
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    APP.Util.toast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
  }
};

// åˆ—å°åŠŸèƒ½
window.printPage = () => {
  window.print();
};

// åŒ¯å‡ºè³‡æ–™ç‚º CSVï¼ˆç¯„ä¾‹ï¼‰
window.exportToCSV = (data, filename = 'export.csv') => {
  if (!data || !data.length) {
    APP.Util.toast('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º', 'warning');
    return;
  }
  
  const headers = Object.keys(data[0]);
  const csv = [
    headers.join(','),
    ...data.map(row => headers.map(header => {
      const value = row[header] || '';
      return `"${String(value).replace(/"/g, '""')}"`;
    }).join(','))
  ].join('\n');
  
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
  URL.revokeObjectURL(link.href);
  
  APP.Util.toast('åŒ¯å‡ºæˆåŠŸ', 'success');
};

// æ—¥æœŸæ ¼å¼åŒ–è¼”åŠ©
window.formatDateTime = (date) => {
  if (!date) return '-';
  const d = new Date(date);
  if (isNaN(d.getTime())) return '-';
  
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  const hours = String(d.getHours()).padStart(2, '0');
  const minutes = String(d.getMinutes()).padStart(2, '0');
  
  return `${year}/${month}/${day} ${hours}:${minutes}`;
};

// æª”æ¡ˆå¤§å°æ ¼å¼åŒ–
window.formatFileSize = (bytes) => {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
};

// é›»è©±è™Ÿç¢¼æ ¼å¼åŒ–
window.formatPhone = (phone) => {
  if (!phone) return '-';
  const cleaned = phone.replace(/\D/g, '');
  if (cleaned.length === 10) {
    return cleaned.replace(/(\d{4})(\d{3})(\d{3})/, '$1-$2-$3');
  }
  return phone;
};

// èº«åˆ†è­‰å­—è™Ÿé©—è­‰ï¼ˆå°ç£ï¼‰
window.validateTWID = (id) => {
  if (!id || !/^[A-Z][12]\d{8}$/.test(id)) return false;
  
  const letters = 'ABCDEFGHJKLMNPQRSTUVXYWZIO';
  const weights = [1, 9, 8, 7, 6, 5, 4, 3, 2, 1, 1];
  
  let sum = Math.floor((letters.indexOf(id[0]) + 10) / 10) + 
            (letters.indexOf(id[0]) + 10) % 10 * 9;
  
  for (let i = 1; i < 10; i++) {
    sum += parseInt(id[i]) * weights[i];
  }
  
  return sum % 10 === 0;
};

// Email é©—è­‰
window.validateEmail = (email) => {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
};

// æ‰‹æ©Ÿè™Ÿç¢¼é©—è­‰ï¼ˆå°ç£ï¼‰
window.validatePhone = (phone) => {
  const cleaned = phone.replace(/\D/g, '');
  return /^09\d{8}$/.test(cleaned);
};

// å¯†ç¢¼å¼·åº¦æª¢æŸ¥
window.checkPasswordStrength = (password) => {
  if (!password) return { strength: 0, text: 'ç„¡' };
  
  let strength = 0;
  if (password.length >= 8) strength++;
  if (password.length >= 12) strength++;
  if (/[a-z]/.test(password)) strength++;
  if (/[A-Z]/.test(password)) strength++;
  if (/[0-9]/.test(password)) strength++;
  if (/[^a-zA-Z0-9]/.test(password)) strength++;
  
  const levels = ['æ¥µå¼±', 'å¼±', 'æ™®é€š', 'å¼·', 'å¾ˆå¼·', 'æ¥µå¼·'];
  return {
    strength: Math.min(strength, 5),
    text: levels[Math.min(strength, 5)]
  };
};

// æœ¬åœ°å„²å­˜è¼”åŠ©
window.storage = {
  set: (key, value) => {
    try {
      localStorage.setItem(key, JSON.stringify(value));
      return true;
    } catch (e) {
      console.error('Storage set error:', e);
      return false;
    }
  },
  get: (key, defaultValue = null) => {
    try {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : defaultValue;
    } catch (e) {
      console.error('Storage get error:', e);
      return defaultValue;
    }
  },
  remove: (key) => {
    try {
      localStorage.removeItem(key);
      return true;
    } catch (e) {
      console.error('Storage remove error:', e);
      return false;
    }
  },
  clear: () => {
    try {
      localStorage.clear();
      return true;
    } catch (e) {
      console.error('Storage clear error:', e);
      return false;
    }
  }
};

// é˜²æŠ–å‡½æ•¸
window.debounce = (func, wait = 300) => {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
};

// ç¯€æµå‡½æ•¸
window.throttle = (func, limit = 300) => {
  let inThrottle;
  return function(...args) {
    if (!inThrottle) {
      func.apply(this, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
};

// æ·±åº¦è¤‡è£½
window.deepClone = (obj) => {
  if (obj === null || typeof obj !== 'object') return obj;
  if (obj instanceof Date) return new Date(obj.getTime());
  if (obj instanceof Array) return obj.map(item => deepClone(item));
  if (obj instanceof Object) {
    const clonedObj = {};
    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {
        clonedObj[key] = deepClone(obj[key]);
      }
    }
    return clonedObj;
  }
};

// éš¨æ©Ÿ ID ç”Ÿæˆ
window.generateId = (length = 16) => {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
};

// UUID v4 ç”Ÿæˆ
window.generateUUID = () => {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
};

console.log('ğŸ¥ å¸•é‡‘æ£®ç—…å‹æœƒæ•´åˆç³»çµ±å·²è¼‰å…¥å®Œæˆ');
console.log('ğŸ“± ç³»çµ±ç‰ˆæœ¬: 1.0.0');
console.log('ğŸ”§ é–‹ç™¼æ¨¡å¼:', location.hostname === 'localhost' ? 'æ˜¯' : 'å¦');
</script>

  </script>
</body>
</html>


