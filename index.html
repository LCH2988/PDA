<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕促會病友權益促進會管理系統</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --info-color: #17a2b8;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
    }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; margin: 0; padding: 0; }
    .navbar-custom { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .navbar-brand { font-weight: bold; color: white !important; }
    .main-container { display: flex; min-height: calc(100vh - 56px); }
    .sidebar { width: 280px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: all 0.3s ease; position: relative; }
    .sidebar.collapsed { width: 70px; }
    .sidebar-header { padding: 20px; border-bottom: 1px solid #dee2e6; text-align: center; }
    .nav-menu { padding: 20px 0; }
    .nav-item { margin: 5px 15px; }
    .nav-link { display: flex; align-items: center; padding: 12px 15px; color: #495057; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; position: relative; }
    .nav-link:hover { background-color: #e9ecef; color: var(--primary-color); transform: translateX(5px); }
    .nav-link.active { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; }
    .nav-link i { width: 20px; margin-right: 12px; text-align: center; }
    .main-content { flex: 1; padding: 30px; overflow-y: auto; }
    .page-header { background: white; padding: 25px 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; border-left: 4px solid var(--primary-color); }
    .page-title { margin: 0; color: var(--primary-color); font-size: 1.8rem; font-weight: 600; }
    .page-subtitle { color: #6c757d; margin-top: 5px; margin-bottom: 0; }
    .stats-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.3s ease, box-shadow 0.3s ease; border-left: 4px solid transparent; }
    .stats-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
    .stats-card.primary { border-left-color: var(--primary-color); }
    .stats-card.success { border-left-color: var(--success-color); }
    .stats-card.info { border-left-color: var(--info-color); }
    .stats-card.warning { border-left-color: var(--warning-color); }
    .stats-card.danger { border-left-color: var(--danger-color); }
    .stats-icon { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; margin-bottom: 15px; }
    .stats-icon.primary { background: linear-gradient(135deg, var(--primary-color), #34495e); }
    .stats-icon.success { background: linear-gradient(135deg, var(--success-color), #2ecc71); }
    .stats-icon.info { background: linear-gradient(135deg, var(--info-color), #3498db); }
    .stats-icon.warning { background: linear-gradient(135deg, var(--warning-color), #e67e22); }
    .stats-icon.danger { background: linear-gradient(135deg, var(--danger-color), #c0392b); }
    .stats-number { font-size: 2.5rem; font-weight: bold; color: var(--primary-color); margin: 0; }
    .stats-label { color: #6c757d; font-size: 0.9rem; margin: 0; }
    .content-card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
    .content-card-header { background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px 25px; border-bottom: 1px solid #dee2e6; }
    .content-card-title { margin: 0; color: var(--primary-color); font-size: 1.2rem; font-weight: 600; }
    .content-card-body { padding: 25px; }
    .btn-custom { border-radius: 8px; padding: 10px 20px; font-weight: 500; transition: all 0.3s ease; border: none; }
    .btn-custom:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .btn-primary-custom { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; }
    .btn-success-custom { background: linear-gradient(135deg, var(--success-color), #2ecc71); color: white; }
    .btn-warning-custom { background: linear-gradient(135deg, var(--warning-color), #e67e22); color: white; }
    .btn-danger-custom { background: linear-gradient(135deg, var(--danger-color), #c0392b); color: white; }
    .table-responsive { border-radius: 8px; overflow: hidden; }
    .table { margin-bottom: 0; }
    .table th { background-color: #f8f9fa; border-top: none; font-weight: 600; color: var(--primary-color); }
    .badge-custom { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
    .loading-spinner { display: flex; justify-content: center; align-items: center; height: 200px; }
    .alert-custom { border-radius: 8px; border: none; padding: 15px 20px; }
    .modal-custom .modal-content { border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal-custom .modal-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border-radius: 12px 12px 0 0; }
    .modal-custom .modal-title { font-weight: 600; }
    .form-control:focus, .form-select:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25); }
    .connection-status { position: fixed; top: 10px; right: 10px; z-index: 1050; padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .connection-status.online { background: linear-gradient(135deg, var(--success-color), #2ecc71); }
    .connection-status.offline { background: linear-gradient(135deg, var(--warning-color), #e67e22); }
    .quick-actions { position: fixed; bottom: 30px; right: 30px; z-index: 1040; }
    .quick-action-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 20px; margin-bottom: 10px; display: block; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .quick-action-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    .quick-action-btn.primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); }
    .quick-action-btn.success { background: linear-gradient(135deg, var(--success-color), #2ecc71); }
    @media (max-width: 768px) {
      .sidebar { width: 100%; position: fixed; top: 56px; left: -100%; height: calc(100vh - 56px); z-index: 1030; transition: left 0.3s ease; }
      .sidebar.show { left: 0; }
      .main-content { padding: 20px 15px; }
      .page-header { padding: 20px; }
      .stats-card { margin-bottom: 20px; }
      .quick-actions { bottom: 20px; right: 20px; }
    }
    .chart-container { position: relative; height: 400px; margin: 20px 0; }
    .pending-item { background: #fff3cd; border-left: 4px solid var(--warning-color); padding: 15px; margin-bottom: 10px; border-radius: 0 8px 8px 0; }
    .pending-item:hover { background: #ffeaa7; cursor: pointer; }
    .user-info { display: flex; align-items: center; color: white; margin-left: auto; }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; margin-right: 10px; }
    .sidebar-toggle { background: none; border: none; color: white; font-size: 18px; margin-right: 15px; }
  </style>
</head>
<body>
  <!-- 頂部導航列 -->
  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container-fluid">
      <button class="sidebar-toggle d-lg-none" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
      <a class="navbar-brand" href="#">
        <i class="fas fa-heartbeat me-2"></i>
        帕促會病友權益促進會管理系統
      </a>
      <div class="user-info">
        <div class="connection-status" id="connectionStatus">
          <i class="fas fa-wifi"></i> 連接中...
        </div>
        <div class="user-avatar"><i class="fas fa-user"></i></div>
        <span>管理員</span>
        <div class="dropdown ms-3">
          <button class="btn btn-link text-white dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-cog"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" onclick="loadPage('settings')"><i class="fas fa-cog me-2"></i>系統設定</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>登出</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- 主要容器 -->
  <div class="main-container">
    <!-- 側邊欄 -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h5 class="mb-0"><i class="fas fa-heartbeat text-primary"></i><span>帕促會</span></h5>
      </div>
      <nav class="nav-menu">
        <div class="nav-item"><a href="#" class="nav-link active" onclick="loadPage('dashboard')"><i class="fas fa-tachometer-alt"></i><span>儀表板</span></a></div>
        <div class="nav-item"><a href="#" class="nav-link" onclick="loadPage('membership')"><i class="fas fa-users"></i><span>會員管理</span></a></div>
        <div class="nav-item"><a href="#" class="nav-link" onclick="loadPage('membership-fee')"><i class="fas fa-credit-card"></i><span>會費管理</span></a></div>
        <div class="nav-item"><a href="#" class="nav-link" onclick="loadPage('donation')"><i class="fas fa-hand-holding-heart"></i><span>捐款管理</span></a></div>
        <div class="nav-item"><a href="#" class="nav-link" onclick="loadPage('expense')"><i class="fas fa-receipt"></i><span>支出管理</span></a></div>
        <div class="nav-item"><a href="#" class="nav-link" onclick="loadPage('receipt')"><i class="fas fa-file-invoice"></i><span>收據管理</span></a></div>
        <div class="nav-item"><a href="#" class="nav-link" onclick="loadPage('approval')"><i class="fas fa-check-circle"></i><span>核准流程</span></a></div>
        <div class="nav-item"><a href="#" class="nav-link" onclick="loadPage('financial-report')"><i class="fas fa-chart-bar"></i><span>財務報表</span></a></div>
        <div class="nav-item"><a href="#" class="nav-link" onclick="loadPage('settings')"><i class="fas fa-cog"></i><span>系統設定</span></a></div>
      </nav>
    </div>

    <!-- 主要內容區域 -->
    <div class="main-content">
      <div id="pageContent"></div>
    </div>
  </div>

  <!-- 快速操作按鈕 -->
  <div class="quick-actions">
    <button class="quick-action-btn success" onclick="quickAddMember()" title="快速新增會員"><i class="fas fa-user-plus"></i></button>
    <button class="quick-action-btn primary" onclick="quickAddExpense()" title="快速新增支出"><i class="fas fa-plus"></i></button>
  </div>

  <!-- 通用模態框 -->
  <div class="modal fade modal-custom" id="universalModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">標題</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer" id="modalFooter"></div>
    </div></div>
  </div>

  <!-- 提示訊息容器 -->
  <div id="alertContainer" style="position: fixed; top: 70px; right: 20px; z-index: 1060; width: 350px;"></div>

  <script>
    // ==================== 工具與設定 ====================
    const API_CONFIG = {
      url: 'https://script.google.com/macros/s/AKfycby3Y0G2FbMeAx-luXdxe6tTCpWrYkFk8vr3Mmsm4YstRwcs90zcr9afedtywkExQOnPgg/exec',
      timeout: 30000,
      retries: 3,
      offlineMode: false
    };
    let currentPage = 'dashboard';
    let currentData = {};
    let dataTable = null;

    function escapeHTML(str) {
      return String(str)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    async function apiCall(action, data = {}) {
      if (API_CONFIG.offlineMode) return getOfflineData(action);

      let lastError;
      for (let attempt = 1; attempt <= API_CONFIG.retries; attempt++) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);
          const params = new URLSearchParams({ action, timestamp: Date.now().toString() });
          if (data && typeof data === 'object') {
            Object.keys(data).forEach(key => {
              const v = data[key];
              if (v === null || v === undefined) return;
              if (typeof v === 'object') params.append(key, JSON.stringify(v));
              else params.append(key, String(v));
            });
          }
          const url = `${API_CONFIG.url}?${params.toString()}`;
          const response = await fetch(url, {
            method: 'GET',
            signal: controller.signal,
            headers: { 'Accept': 'application/json', 'Cache-Control': 'no-cache' }
          });
          clearTimeout(timeoutId);
          if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          const result = await response.json();
          return result;
        } catch (error) {
          lastError = error;
          if (attempt < API_CONFIG.retries) await new Promise(r => setTimeout(r, 1000 * attempt));
        }
      }
      API_CONFIG.offlineMode = true;
      updateConnectionStatus(false);
      showAlert('網路連接異常，已切換到離線模式', 'warning', 10000);
      return getOfflineData(action);
    }

    async function checkApiConnection() {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        const params = new URLSearchParams({ action: 'test', timestamp: Date.now().toString() });
        const url = `${API_CONFIG.url}?${params.toString()}`;
        const res = await fetch(url, { method: 'GET', signal: controller.signal, headers: { 'Accept': 'application/json' } });
        clearTimeout(timeoutId);
        if (!res.ok) return false;
        const json = await res.json();
        return json.success === true;
      } catch {
        return false;
      }
    }

    function updateConnectionStatus(isOnline) {
      const statusElement = document.getElementById('connectionStatus');
      if (!statusElement) return;
      if (isOnline) {
        statusElement.className = 'connection-status online';
        statusElement.innerHTML = '<i class="fas fa-wifi"></i> 已連接';
      } else {
        statusElement.className = 'connection-status offline';
        statusElement.innerHTML = '<i class="fas fa-wifi-slash"></i> 離線模式';
      }
    }

    async function checkConnectionStatus() {
      if (API_CONFIG.offlineMode) {
        const isConnected = await checkApiConnection();
        if (isConnected) {
          API_CONFIG.offlineMode = false;
          updateConnectionStatus(true);
          showAlert('網路連接已恢復', 'success');
        }
      }
    }

    // ==================== 初始化 ====================
    document.addEventListener('DOMContentLoaded', async function() {
      const isConnected = await checkApiConnection();
      updateConnectionStatus(isConnected);
      if (!isConnected) {
        API_CONFIG.offlineMode = true;
        showAlert('無法連接到伺服器，已啟用離線模式', 'warning', 10000);
      }
      loadPage('dashboard');
      setInterval(checkConnectionStatus, 30000);
    });

    // ==================== 離線資料 ====================
    function getOfflineData(action) {
      const mockData = {
        getDashboardStats: { success: true, data: { totalMembers: 150, totalMembershipFees: 150000, totalDonations: 89500, totalExpenses: 45000, balance: 194500, pending: { fees: 5, expenses: 3, approvals: 2 } } },
        getMembers: { success: true, data: [ { '會員編號': 'M20240001', '姓名': '張三', '性別': '男', '手機': '0912345678', '電子郵件': 'zhang@example.com', '入會日期': '2024-01-15', '會員狀態': '有效' } ] },
        getMembershipFees: { success: true, data: [ { '記錄編號': 'F240001', '會員姓名': '張三', '繳費年度': '2024', '金額': '1000', '繳費日期': '2024-03-01', '繳費方式': '轉帳', '狀態': '已確認', '收據編號': 'PCA240001' } ] },
        getDonations: { success: true, data: [ { '捐款編號': 'D240001', '捐款人姓名': '陳先生', '捐款金額': '5000', '捐款日期': '2024-03-20', '捐款用途': '一般捐款', '捐款方式': '轉帳', '收據編號': 'PCA240002' } ] },
        getExpenses: { success: true, data: [ { '支出編號': 'E240001', '申請人': '管理員', '支出項目': '辦公用品採購', '金額': '2500', '支出日期': '2024-03-25', '優先級': '中', '核准狀態': '待核准' } ] },
        getReceipts: { success: true, data: [ { '收據編號': 'PCA240001', '收據類型': '會費', '收款人': '張三', '金額': '1000', '開立日期': '2024-03-01', '用途': '2024年度會費', '狀態': '有效' } ] },
        getApprovals: { success: true, data: [ { '流程編號': 'A240001', '申請編號': 'E240001', '申請類型': '支出', '申請人': '管理員', '申請金額': '2500', '申請日期': '2024-03-25', '優先級': '中', '目前狀態': '待核准' } ] },
        getSettings: { success: true, data: { '組織名稱': '帕促會病友權益促進會', '年度會費': '1000', '收據前綴': 'PCA', '二級核准門檻': '10000', '提醒天數': '3', '組織地址': '台北市中正區XX路XX號', '聯絡電話': '02-12345678', '電子郵件': 'info@pacu.org' } },
        getFinancialReport: { success: true, data: { income: { total: 239500, membershipFees: 150000, donations: 89500 }, expenses: { total: 45000, byCategory: { '辦公用品': 15000, '活動費用': 18000, '交通費': 5000, '餐費': 7000 } }, balance: 194500, summary: { totalTransactions: 89, membershipCount: 150, donationCount: 25, expenseCount: 14 } } }
      };
      const result = mockData[action] || { success: false, message: '找不到離線資料' };
      if (result.success) result.offlineMode = true;
      return result;
    }

    // ==================== 頁面載入 ====================
    async function loadPage(pageName) {
      try {
        updateNavigation(pageName);
        currentPage = pageName;
        showLoading();
        let content = '';
        switch (pageName) {
          case 'dashboard': content = await loadDashboard(); break;
          case 'membership': content = await loadMembership(); break;
          case 'membership-fee': content = await loadMembershipFee(); break;
          case 'donation': content = await loadDonation(); break;
          case 'expense': content = await loadExpense(); break;
          case 'receipt': content = await loadReceipt(); break;
          case 'approval': content = await loadApproval(); break;
          case 'financial-report': content = await loadFinancialReport(); break;
          case 'settings': content = await loadSettings(); break;
          default: content = getDefaultContent('頁面');
        }
        document.getElementById('pageContent').innerHTML = content;
        initializePageFeatures(pageName);
      } catch (error) {
        showAlert('載入頁面失敗：' + error.message, 'danger');
      }
    }

    function updateNavigation(activePage) {
      document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
      const activeLink = document.querySelector(`[onclick="loadPage('${activePage}')"]`);
      if (activeLink) activeLink.classList.add('active');
    }

    function showLoading() {
      document.getElementById('pageContent').innerHTML = `
        <div class="loading-spinner">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">載入中...</span></div>
        </div>`;
    }

    function initializePageFeatures(pageName) {
      if (document.querySelector('.data-table')) {
        if (dataTable) dataTable.destroy();
        dataTable = $('.data-table').DataTable({
          language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json' },
          responsive: true, pageLength: 25, order: [[0, 'desc']]
        });
      }
      if (pageName === 'dashboard') initializeDashboardCharts();
      else if (pageName === 'financial-report') initializeFinancialCharts();
    }

    // ==================== 儀表板 ====================
    async function loadDashboard() {
      const result = await apiCall('getDashboardStats');
      if (!result.success) return `<div class="alert alert-danger">載入儀表板資料失敗：${escapeHTML(result.message || '')}</div>`;
      const stats = result.data; currentData.dashboardStats = stats;
      return `
        <div class="page-header"><h1 class="page-title">儀表板</h1><p class="page-subtitle">系統概覽與統計資訊</p></div>
        <div class="row mb-4">
          <div class="col-lg-3 col-md-6 mb-4"><div class="stats-card primary"><div class="stats-icon primary"><i class="fas fa-users"></i></div><h3 class="stats-number">${stats.totalMembers}</h3><p class="stats-label">總會員數</p></div></div>
          <div class="col-lg-3 col-md-6 mb-4"><div class="stats-card success"><div class="stats-icon success"><i class="fas fa-dollar-sign"></i></div><h3 class="stats-number">$${stats.totalMembershipFees.toLocaleString()}</h3><p class="stats-label">會費收入</p></div></div>
          <div class="col-lg-3 col-md-6 mb-4"><div class="stats-card info"><div class="stats-icon info"><i class="fas fa-hand-holding-heart"></i></div><h3 class="stats-number">$${stats.totalDonations.toLocaleString()}</h3><p class="stats-label">捐款收入</p></div></div>
          <div class="col-lg-3 col-md-6 mb-4"><div class="stats-card warning"><div class="stats-icon warning"><i class="fas fa-receipt"></i></div><h3 class="stats-number">$${stats.totalExpenses.toLocaleString()}</h3><p class="stats-label">總支出</p></div></div>
        </div>
        <div class="row">
          <div class="col-lg-8 mb-4"><div class="content-card"><div class="content-card-header"><h5 class="content-card-title"><i class="fas fa-chart-line me-2"></i>收支概覽</h5></div><div class="content-card-body"><div class="chart-container"><canvas id="incomeExpenseChart"></canvas></div></div></div></div>
          <div class="col-lg-4 mb-4"><div class="content-card"><div class="content-card-header"><h5 class="content-card-title"><i class="fas fa-tasks me-2"></i>待辦事項</h5></div><div class="content-card-body">
            <div class="pending-item" onclick="loadPage('membership-fee')"><div class="d-flex justify-content-between align-items-center"><div><i class="fas fa-credit-card text-warning me-2"></i>待確認會費</div><span class="badge bg-warning">${stats.pending.fees}</span></div></div>
            <div class="pending-item" onclick="loadPage('expense')"><div class="d-flex justify-content-between align-items-center"><div><i class="fas fa-receipt text-info me-2"></i>待核准支出</div><span class="badge bg-info">${stats.pending.expenses}</span></div></div>
            <div class="pending-item" onclick="loadPage('approval')"><div class="d-flex justify-content-between align-items-center"><div><i class="fas fa-check-circle text-primary me-2"></i>待處理核准</div><span class="badge bg-primary">${stats.pending.approvals}</span></div></div>
            ${stats.pending.fees === 0 && stats.pending.expenses === 0 && stats.pending.approvals === 0 ? '<div class="text-center text-muted py-3"><i class="fas fa-check-circle fa-2x mb-2"></i><br>所有事項都已處理完成！</div>' : ''}
          </div></div></div>
        </div>
        <div class="row"><div class="col-12"><div class="content-card"><div class="content-card-body text-center">
          <h4 class="mb-3"><i class="fas fa-wallet text-success me-2"></i>目前餘額</h4>
          <h2 class="text-success mb-0">$${stats.balance.toLocaleString()}</h2>
          <small class="text-muted">收入總額 $${(stats.totalMembershipFees + stats.totalDonations).toLocaleString()} - 支出總額 $${stats.totalExpenses.toLocaleString()}</small>
        </div></div></div></div>`;
    }

    function initializeDashboardCharts() {
      const ctx = document.getElementById('incomeExpenseChart');
      if (!ctx || !currentData.dashboardStats) return;
      const s = currentData.dashboardStats;
      new Chart(ctx, { type: 'doughnut', data: { labels: ['會費收入', '捐款收入', '支出'], datasets: [{ data: [s.totalMembershipFees, s.totalDonations, s.totalExpenses], backgroundColor: ['#27ae60', '#3498db', '#e74c3c'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
    }

    // ==================== 會員管理 ====================
    async function loadMembership() {
      const result = await apiCall('getMembers');
      if (!result.success) return `<div class="alert alert-danger">載入會員資料失敗：${escapeHTML(result.message || '')}</div>`;
      const members = result.data; currentData.members = members;
      const rows = members.map(member => `
        <tr>
          <td>${escapeHTML(member['會員編號'] || '')}</td>
          <td>${escapeHTML(member['姓名'] || '')}</td>
          <td>${escapeHTML(member['性別'] || '-')}</td>
          <td>${escapeHTML(member['手機'] || '-')}</td>
          <td>${escapeHTML(member['電子郵件'] || '-')}</td>
          <td>${escapeHTML(member['入會日期'] || '')}</td>
          <td><span class="badge-custom ${member['會員狀態'] === '有效' ? 'bg-success' : 'bg-secondary'}">${escapeHTML(member['會員狀態'] || '')}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="editMember('${escapeHTML(member['會員編號'] || '')}')"><i class="fas fa-edit"></i></button>
            <button class="btn btn-sm btn-outline-info" onclick="viewMember('${escapeHTML(member['會員編號'] || '')}')"><i class="fas fa-eye"></i></button>
          </td>
        </tr>`).join('');
      return `
        <div class="page-header">
          <div class="d-flex justify-content-between align-items-center">
            <div><h1 class="page-title">會員管理</h1><p class="page-subtitle">管理會員資料與狀態</p></div>
            <button class="btn btn-primary-custom btn-custom" onclick="showAddMemberModal()"><i class="fas fa-user-plus me-2"></i>新增會員</button>
          </div>
        </div>
        <div class="content-card"><div class="content-card-header"><h5 class="content-card-title"><i class="fas fa-users me-2"></i>會員列表 (${members.length} 人)</h5></div>
        <div class="content-card-body"><div class="table-responsive">
          <table class="table table-hover data-table">
            <thead><tr><th>會員編號</th><th>姓名</th><th>性別</th><th>手機</th><th>電子郵件</th><th>入會日期</th><th>狀態</th><th>操作</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div></div></div>`;
    }

    // ==================== 會費管理 ====================
    async function loadMembershipFee() {
      const result = await apiCall('getMembershipFees');
      if (!result.success) return `<div class="alert alert-danger">載入會費記錄失敗：${escapeHTML(result.message || '')}</div>`;
      const fees = result.data; currentData.membershipFees = fees;
      const rows = fees.map(fee => `
        <tr>
          <td>${escapeHTML(fee['記錄編號'] || '')}</td>
          <td>${escapeHTML(fee['會員姓名'] || '')}</td>
          <td>${escapeHTML(fee['繳費年度'] || '')}</td>
          <td>$${Number(fee['金額'] || 0).toLocaleString()}</td>
          <td>${escapeHTML(fee['繳費日期'] || '')}</td>
          <td>${escapeHTML(fee['繳費方式'] || '')}</td>
          <td><span class="badge-custom ${fee['狀態'] === '已確認' ? 'bg-success' : 'bg-warning'}">${escapeHTML(fee['狀態'] || '')}</span></td>
          <td>${escapeHTML(fee['收據編號'] || '-')}</td>
          <td>
            ${fee['狀態'] === '待確認' ? 
              `<button class="btn btn-sm btn-success" onclick="confirmFee('${escapeHTML(fee['記錄編號'] || '')}')"><i class="fas fa-check"></i> 確認</button>` : 
              `<button class="btn btn-sm btn-outline-info" onclick="viewFee('${escapeHTML(fee['記錄編號'] || '')}')"><i class="fas fa-eye"></i></button>`}
          </td>
        </tr>`).join('');
      return `
        <div class="page-header">
          <div class="d-flex justify-content-between align-items-center">
            <div><h1 class="page-title">會費管理</h1><p class="page-subtitle">管理會員繳費記錄</p></div>
            <button class="btn btn-primary-custom btn-custom" onclick="showAddFeeModal()"><i class="fas fa-plus me-2"></i>新增會費記錄</button>
          </div>
        </div>
        <div class="content-card"><div class="content-card-header"><h5 class="content-card-title"><i class="fas fa-credit-card me-2"></i>會費記錄 (${fees.length} 筆)</h5></div>
        <div class="content-card-body"><div class="table-responsive">
          <table class="table table-hover data-table">
            <thead><tr><th>記錄編號</th><th>會員姓名</th><th>繳費年度</th><th>金額</th><th>繳費日期</th><th>繳費方式</th><th>狀態</th><th>收據編號</th><th>操作</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div></div></div>`;
    }

    // ==================== 捐款管理 ====================
    async function loadDonation() {
      const result = await apiCall('getDonations');
      if (!result.success) return `<div class="alert alert-danger">載入捐款記錄失敗：${escapeHTML(result.message || '')}</div>`;
      const donations = result.data; currentData.donations = donations;
      const rows = donations.map(d => `
        <tr>
          <td>${escapeHTML(d['捐款編號'] || '')}</td>
          <td>${escapeHTML(d['捐款人姓名'] || '')}</td>
          <td>$${Number(d['捐款金額'] || 0).toLocaleString()}</td>
          <td>${escapeHTML(d['捐款日期'] || '')}</td>
          <td>${escapeHTML(d['捐款用途'] || '')}</td>
          <td>${escapeHTML(d['捐款方式'] || '')}</td>
          <td>${escapeHTML(d['收據編號'] || '')}</td>
          <td>
            <button class="btn btn-sm btn-outline-info" onclick="viewDonation('${escapeHTML(d['捐款編號'] || '')}')"><i class="fas fa-eye"></i></button>
            <button class="btn btn-sm btn-outline-primary" onclick="printReceipt('${escapeHTML(d['收據編號'] || '')}')"><i class="fas fa-print"></i></button>
          </td>
        </tr>`).join('');
      return `
        <div class="page-header">
          <div class="d-flex justify-content-between align-items-center">
            <div><h1 class="page-title">捐款管理</h1><p class="page-subtitle">管理捐款記錄與收據</p></div>
            <button class="btn btn-primary-custom btn-custom" onclick="showAddDonationModal()"><i class="fas fa-hand-holding-heart me-2"></i>新增捐款記錄</button>
          </div>
        </div>
        <div class="content-card"><div class="content-card-header"><h5 class="content-card-title"><i class="fas fa-hand-holding-heart me-2"></i>捐款記錄 (${donations.length} 筆)</h5></div>
        <div class="content-card-body"><div class="table-responsive">
          <table class="table table-hover data-table">
            <thead><tr><th>捐款編號</th><th>捐款人</th><th>金額</th><th>捐款日期</th><th>用途</th><th>方式</th><th>收據編號</th><th>操作</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div></div></div>`;
    }

    // ==================== 支出管理 ====================
    async function loadExpense() {
      const result = await apiCall('getExpenses');
      if (!result.success) return `<div class="alert alert-danger">載入支出記錄失敗：${escapeHTML(result.message || '')}</div>`;
      const expenses = result.data; currentData.expenses = expenses;
      const rows = expenses.map(e => `
        <tr>
          <td>${escapeHTML(e['支出編號'] || '')}</td>
          <td>${escapeHTML(e['申請人'] || '')}</td>
          <td>${escapeHTML(e['支出項目'] || '')}</td>
          <td>$${Number(e['金額'] || 0).toLocaleString()}</td>
          <td>${escapeHTML(e['支出日期'] || '')}</td>
          <td><span class="badge-custom ${e['優先級'] === '高' ? 'bg-danger' : e['優先級'] === '中' ? 'bg-warning' : 'bg-secondary'}">${escapeHTML(e['優先級'] || '')}</span></td>
          <td><span class="badge-custom ${e['核准狀態'] === '已核准' ? 'bg-success' : e['核准狀態'] === '已拒絕' ? 'bg-danger' : 'bg-warning'}">${escapeHTML(e['核准狀態'] || '')}</span></td>
          <td>
            ${e['核准狀態'] === '待核准' ? 
              `<button class="btn btn-sm btn-success me-1" onclick="approveExpense('${escapeHTML(e['支出編號'] || '')}')"><i class="fas fa-check"></i></button>
               <button class="btn btn-sm btn-danger" onclick="rejectExpense('${escapeHTML(e['支出編號'] || '')}')"><i class="fas fa-times"></i></button>` : 
              `<button class="btn btn-sm btn-outline-info" onclick="viewExpense('${escapeHTML(e['支出編號'] || '')}')"><i class="fas fa-eye"></i></button>`}
          </td>
        </tr>`).join('');
      return `
        <div class="page-header">
          <div class="d-flex justify-content-between align-items-center">
            <div><h1 class="page-title">支出管理</h1><p class="page-subtitle">管理支出申請與核准</p></div>
            <button class="btn btn-primary-custom btn-custom" onclick="showAddExpenseModal()"><i class="fas fa-plus me-2"></i>新增支出申請</button>
          </div>
        </div>
        <div class="content-card"><div class="content-card-header"><h5 class="content-card-title"><i class="fas fa-receipt me-2"></i>支出記錄 (${expenses.length} 筆)</h5></div>
        <div class="content-card-body"><div class="table-responsive">
          <table class="table table-hover data-table">
            <thead><tr><th>支出編號</th><th>申請人</th><th>支出項目</th><th>金額</th><th>支出日期</th><th>優先級</th><th>核准狀態</th><th>操作</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div></div></div>`;
    }

    // ==================== 收據管理 ====================
    async function loadReceipt() {
      const result = await apiCall('getReceipts');
      if (!result.success) return `<div class="alert alert-danger">載入收據記錄失敗：${escapeHTML(result.message || '')}</div>`;
      const receipts = result.data; currentData.receipts = receipts;
      const rows = receipts.map(r => `
        <tr>
          <td>${escapeHTML(r['收據編號'] || '')}</td>
          <td>${escapeHTML(r['收據類型'] || '')}</td>
          <td>${escapeHTML(r['收款人'] || '')}</td>
          <td>$${Number(r['金額'] || 0).toLocaleString()}</td>
          <td>${escapeHTML(r['開立日期'] || '')}</td>
          <td>${escapeHTML(r['用途'] || '')}</td>
          <td><span class="badge-custom ${r['狀態'] === '有效' ? 'bg-success' : 'bg-danger'}">${escapeHTML(r['狀態'] || '')}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="printReceipt('${escapeHTML(r['收據編號'] || '')}')"><i class="fas fa-print"></i></button>
            ${r['狀態'] === '有效' ? `<button class="btn btn-sm btn-outline-danger" onclick="voidReceiptConfirm('${escapeHTML(r['收據編號'] || '')}')"><i class="fas fa-ban"></i></button>` : ''}
          </td>
        </tr>`).join('');
      return `
        <div class="page-header"><h1 class="page-title">收據管理</h1><p class="page-subtitle">管理收據開立與作廢</p></div>
        <div class="content-card"><div class="content-card-header"><h5 class="content-card-title"><i class="fas fa-file-invoice me-2"></i>收據記錄 (${receipts.length} 筆)</h5></div>
        <div class="content-card-body"><div class="table-responsive">
          <table class="table table-hover data-table">
            <thead><tr><th>收據編號</th><th>類型</th><th>收款人</th><th>金額</th><th>開立日期</th><th>用途</th><th>狀態</th><th>操作</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div></div></div>`;
    }

    // ==================== 核准流程 ====================
    async function loadApproval() {
      const result = await apiCall('getApprovals');
      if (!result.success) return `<div class="alert alert-danger">載入核准流程失敗：${escapeHTML(result.message || '')}</div>`;
      const approvals = result.data; currentData.approvals = approvals;
      const rows = approvals.map(a => `
        <tr>
          <td>${escapeHTML(a['流程編號'] || '')}</td>
          <td>${escapeHTML(a['申請編號'] || '')}</td>
          <td>${escapeHTML(a['申請類型'] || '')}</td>
          <td>${escapeHTML(a['申請人'] || '')}</td>
          <td>$${Number(a['申請金額'] || 0).toLocaleString()}</td>
          <td>${escapeHTML(a['申請日期'] || '')}</td>
          <td><span class="badge-custom ${a['優先級'] === '高' ? 'bg-danger' : a['優先級'] === '中' ? 'bg-warning' : 'bg-secondary'}">${escapeHTML(a['優先級'] || '')}</span></td>
          <td><span class="badge-custom ${a['目前狀態'] === '已核准' ? 'bg-success' : a['目前狀態'] === '已拒絕' ? 'bg-danger' : 'bg-warning'}">${escapeHTML(a['目前狀態'] || '')}</span></td>
          <td>
            ${a['目前狀態'] === '待核准' ? 
              `<button class="btn btn-sm btn-success me-1" onclick="processApprovalAction('${escapeHTML(a['流程編號'] || '')}', 'approve')"><i class="fas fa-check"></i></button>
               <button class="btn btn-sm btn-danger" onclick="processApprovalAction('${escapeHTML(a['流程編號'] || '')}', 'reject')"><i class="fas fa-times"></i></button>` :
              `<button class="btn btn-sm btn-outline-info" onclick="viewApproval('${escapeHTML(a['流程編號'] || '')}')"><i class="fas fa-eye"></i></button>`}
          </td>
        </tr>`).join('');
      return `
        <div class="page-header"><h1 class="page-title">核准流程</h1><p class="page-subtitle">管理申請核准與審查</p></div>
        <div class="content-card"><div class="content-card-header"><h5 class="content-card-title"><i class="fas fa-check-circle me-2"></i>核准流程 (${approvals.length} 筆)</h5></div>
        <div class="content-card-body"><div class="table-responsive">
          <table class="table table-hover data-table">
            <thead><tr><th>流程編號</th><th>申請編號</th><th>申請類型</th><th>申請人</th><th>申請金額</th><th>申請日期</th><th>優先級</th><th>目前狀態</th><th>操作</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div></div></div>`;
    }

    // ==================== 財務報表 ====================
    async function loadFinancialReport() {
      const result = await apiCall('getFinancialReport', { startDate: '2024-01-01', endDate: '2024-12-31' });
      if (!result.success) return `<div class="alert alert-danger">載入財務報表失敗：${escapeHTML(result.message || '')}</div>`;
      const report = result.data; currentData.financialReport = report;
      const rows = Object.entries(report.expenses.byCategory || {}).map(([category, amount]) => `
        <tr><td>${escapeHTML(category)}</td><td>$${Number(amount || 0).toLocaleString()}</td><td>${report.expenses.total ? ((amount / report.expenses.total) * 100).toFixed(1) : '0.0'}%</td></tr>`).join('');
      return `
        <div class="page-header">
          <div class="d-flex justify-content-between align-items-center">
            <div><h1 class="page-title">財務報表</h1><p class="page-subtitle">財務收支分析與統計</p></div>
            <div>
              <button class="btn btn-outline-primary me-2" onclick="exportFinancialReport()"><i class="fas fa-download me-2"></i>匯出報表</button>
              <button class="btn btn-primary-custom btn-custom" onclick="showDateRangeModal()"><i class="fas fa-calendar me-2"></i>選擇期間</button>
            </div>
          </div>
        </div>
        <div class="row mb-4">
          <div class="col-lg-4 mb-4"><div class="stats-card success"><div class="stats-icon success"><i class="fas fa-arrow-up"></i></div><h3 class="stats-number">$${report.income.total.toLocaleString()}</h3><p class="stats-label">總收入</p></div></div>
          <div class="col-lg-4 mb-4"><div class="stats-card danger"><div class="stats-icon danger"><i class="fas fa-arrow-down"></i></div><h3 class="stats-number">$${report.expenses.total.toLocaleString()}</h3><p class="stats-label">總支出</p></div></div>
          <div class="col-lg-4 mb-4"><div class="stats-card ${report.balance >= 0 ? 'info' : 'warning'}"><div class="stats-icon ${report.balance >= 0 ? 'info' : 'warning'}"><i class="fas fa-wallet"></i></div><h3 class="stats-number">$${report.balance.toLocaleString()}</h3><p class="stats-label">淨餘額</p></div></div>
        </div>
        <div class="row">
          <div class="col-lg-6 mb-4"><div class="content-card"><div class="content-card-header"><h5 class="content-card-title"><i class="fas fa-chart-pie me-2"></i>收入結構</h5></div><div class="content-card-body"><div class="chart-container"><canvas id="incomeChart"></canvas></div>
            <div class="mt-3"><div class="d-flex justify-content-between"><span>會費收入：</span><strong>$${report.income.membershipFees.toLocaleString()}</strong></div>
            <div class="d-flex justify-content-between"><span>捐款收入：</span><strong>$${report.income.donations.toLocaleString()}</strong></div></div>
          </div></div></div>
          <div class="col-lg-6 mb-4"><div class="content-card"><div class="content-card-header"><h5 class="content-card-title"><i class="fas fa-chart-doughnut me-2"></i>支出分類</h5></div><div class="content-card-body"><div class="chart-container"><canvas id="expenseChart"></canvas></div></div></div></div>
        </div>
        <div class="row"><div class="col-12"><div class="content-card"><div class="content-card-header"><h5 class="content-card-title"><i class="fas fa-list me-2"></i>支出分類明細</h5></div>
          <div class="content-card-body"><div class="table-responsive">
            <table class="table table-hover">
              <thead><tr><th>支出類別</th><th>金額</th><th>佔比</th></tr></thead>
              <tbody>${rows}</tbody>
              <tfoot><tr class="table-active"><th>總計</th><th>$${report.expenses.total.toLocaleString()}</th><th>100.0%</th></tr></tfoot>
            </table>
          </div></div></div></div></div>`;
    }

    function initializeFinancialCharts() {
      if (!currentData.financialReport) return;
      const report = currentData.financialReport;
      const incomeCtx = document.getElementById('incomeChart');
      if (incomeCtx) {
        new Chart(incomeCtx, { type: 'pie', data: { labels: ['會費收入', '捐款收入'], datasets: [{ data: [report.income.membershipFees, report.income.donations], backgroundColor: ['#27ae60', '#3498db'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
      }
      const expenseCtx = document.getElementById('expenseChart');
      if (expenseCtx) {
        const cats = Object.keys(report.expenses.byCategory || {});
        const amounts = Object.values(report.expenses.byCategory || {});
        const colors = ['#e74c3c', '#f39c12', '#9b59b6', '#1abc9c', '#34495e', '#2ecc71', '#8e44ad'];
        new Chart(expenseCtx, { type: 'doughnut', data: { labels: cats, datasets: [{ data: amounts, backgroundColor: colors.slice(0, cats.length), borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
      }
    }

    // ==================== 系統設定 ====================
    async function loadSettings() {
      const result = await apiCall('getSettings');
      if (!result.success) return `<div class="alert alert-danger">載入系統設定失敗：${escapeHTML(result.message || '')}</div>`;
      const settings = result.data; currentData.settings = settings;
      const rows = Object.entries(settings).map(([key, value]) => `
        <tr><td>${escapeHTML(key)}</td><td>
          <div class="input-group">
            <input type="text" class="form-control" id="setting_${escapeHTML(key)}" value="${escapeHTML(value)}">
            <button class="btn btn-outline-primary" onclick="updateSettingValue('${escapeHTML(key)}')"><i class="fas fa-save"></i></button>
          </div>
        </td></tr>`).join('');
      return `
        <div class="page-header">
          <div class="d-flex justify-content-between align-items-center">
            <div><h1 class="page-title">系統設定</h1><p class="page-subtitle">管理系統參數與設定</p></div>
            <div>
              <button class="btn btn-warning-custom btn-custom me-2" onclick="backupSystem()"><i class="fas fa-database me-2"></i>備份資料</button>
              <button class="btn btn-info btn-custom" onclick="systemHealthCheck()"><i class="fas fa-heartbeat me-2"></i>系統檢查</button>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-8">
            <div class="content-card"><div class="content-card-header"><h5 class="content-card-title"><i class="fas fa-cogs me-2"></i>系統參數設定</h5></div>
            <div class="content-card-body"><div class="table-responsive">
              <table class="table table-hover"><thead><tr><th>設定項目</th><th>設定值</th></tr></thead><tbody>${rows}</tbody></table>
            </div></div></div>
          </div>
          <div class="col-lg-4">
            <div class="content-card"><div class="content-card-header"><h5 class="content-card-title"><i class="fas fa-tools me-2"></i>系統工具</h5></div>
            <div class="content-card-body"><div class="d-grid gap-3">
              <button class="btn btn-outline-primary" onclick="initializeSystemData()"><i class="fas fa-play-circle me-2"></i>初始化系統</button>
              <button class="btn btn-outline-success" onclick="testAllFunctions()"><i class="fas fa-vial me-2"></i>測試所有功能</button>
              <button class="btn btn-outline-warning" onclick="clearCache()"><i class="fas fa-broom me-2"></i>清除快取</button>
              <button class="btn btn-outline-info" onclick="showSystemInfo()"><i class="fas fa-info-circle me-2"></i>系統資訊</button>
            </div></div></div>
            <div class="content-card mt-4"><div class="content-card-header"><h5 class="content-card-title"><i class="fas fa-shield-alt me-2"></i>安全設定</h5></div>
            <div class="content-card-body">
              <div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="enableAuditLog" checked><label class="form-check-label" for="enableAuditLog">啟用操作記錄</label></div>
              <div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="enableAutoBackup"><label class="form-check-label" for="enableAutoBackup">自動備份</label></div>
              <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="enableNotifications" checked><label class="form-check-label" for="enableNotifications">系統通知</label></div>
            </div></div>
          </div>
        </div>`;
    }

    // ==================== 通用功能/提示 ====================
    function getDefaultContent(pageName) {
      return `
        <div class="page-header"><h1 class="page-title">${escapeHTML(pageName)}</h1><p class="page-subtitle">此頁面正在開發中...</p></div>
        <div class="content-card"><div class="content-card-body text-center py-5">
          <i class="fas fa-tools fa-3x text-muted mb-3"></i>
          <h4 class="text-muted">功能開發中</h4>
          <p class="text-muted">此功能即將推出，敬請期待！</p>
        </div></div>`;
    }

    function showModal(title, body, footer = '') {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').innerHTML = body;
      document.getElementById('modalFooter').innerHTML = footer;
      new bootstrap.Modal(document.getElementById('universalModal')).show();
    }
    function hideModal() {
      const modal = bootstrap.Modal.getInstance(document.getElementById('universalModal'));
      if (modal) modal.hide();
    }

    function showAlert(message, type = 'info', duration = 5000) {
      const alertContainer = document.getElementById('alertContainer');
      const alertId = 'alert_' + Date.now();
      const alertHtml = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
          <i class="fas fa-${getAlertIcon(type)} me-2"></i>${escapeHTML(message)}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      alertContainer.insertAdjacentHTML('beforeend', alertHtml);
      if (duration > 0) setTimeout(() => {
        const alertElement = document.getElementById(alertId);
        if (alertElement) new bootstrap.Alert(alertElement).close();
      }, duration);
    }
    function getAlertIcon(type) {
      const icons = { success: 'check-circle', danger: 'exclamation-triangle', warning: 'exclamation-triangle', info: 'info-circle', primary: 'info-circle' };
      return icons[type] || 'info-circle';
    }

    // ==================== 新增/編輯/操作 ====================
    function showAddMemberModal() {
      const body = `
        <form id="addMemberForm">
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">姓名 *</label><input type="text" class="form-control" name="name" required></div>
            <div class="col-md-6 mb-3"><label class="form-label">性別</label><select class="form-select" name="gender"><option value="">請選擇</option><option value="男">男</option><option value="女">女</option></select></div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">出生日期</label><input type="date" class="form-control" name="birthDate"></div>
            <div class="col-md-6 mb-3"><label class="form-label">身分證字號</label><input type="text" class="form-control" name="idNumber"></div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">電話</label><input type="tel" class="form-control" name="phone"></div>
            <div class="col-md-6 mb-3"><label class="form-label">手機</label><input type="tel" class="form-control" name="mobile"></div>
          </div>
          <div class="mb-3"><label class="form-label">電子郵件</label><input type="email" class="form-control" name="email"></div>
          <div class="mb-3"><label class="form-label">地址</label><textarea class="form-control" name="address" rows="2"></textarea></div>
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">緊急聯絡人</label><input type="text" class="form-control" name="emergencyContact"></div>
            <div class="col-md-6 mb-3"><label class="form-label">緊急聯絡電話</label><input type="tel" class="form-control" name="emergencyPhone"></div>
          </div>
          <div class="mb-3"><label class="form-label">備註</label><textarea class="form-control" name="note" rows="2"></textarea></div>
        </form>`;
      const footer = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary-custom btn-custom" onclick="submitAddMember()"><i class="fas fa-save me-2"></i>儲存</button>`;
      showModal('新增會員', body, footer);
    }

    async function submitAddMember() {
      try {
        const form = document.getElementById('addMemberForm');
        const formData = Object.fromEntries(new FormData(form).entries());
        if (!formData.name) return showAlert('請輸入會員姓名', 'warning');
        showLoading();
        const result = await apiCall('addMember', { memberData: formData });
        hideModal();
        if (result.success) {
          showAlert('會員新增成功', 'success'); loadPage('membership');
        } else showAlert('新增會員失敗：' + (result.message || ''), 'danger');
      } catch (e) { showAlert('新增會員失敗：' + e.message, 'danger'); }
    }

    function showAddFeeModal() {
      const today = new Date().toISOString().split('T')[0];
      const body = `
        <form id="addFeeForm">
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">會員編號 *</label><input type="text" class="form-control" name="memberId" required placeholder="例：M20240001"></div>
            <div class="col-md-6 mb-3"><label class="form-label">會員姓名</label><input type="text" class="form-control" name="memberName" placeholder="會自動帶入"></div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">繳費年度 *</label>
              <select class="form-select" name="year" required><option value="">請選擇年度</option><option value="2024">2024</option><option value="2025">2025</option></select></div>
            <div class="col-md-6 mb-3"><label class="form-label">金額 *</label><input type="number" class="form-control" name="amount" required value="1000"></div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">繳費日期 *</label><input type="date" class="form-control" name="paymentDate" required value="${today}"></div>
            <div class="col-md-6 mb-3"><label class="form-label">繳費方式 *</label>
              <select class="form-select" name="paymentMethod" required><option value="">請選擇</option><option value="現金">現金</option><option value="轉帳">轉帳</option><option value="支票">支票</option><option value="信用卡">信用卡</option></select>
            </div>
          </div>
          <div class="mb-3"><label class="form-label">備註</label><textarea class="form-control" name="note" rows="2"></textarea></div>
        </form>`;
      const footer = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary-custom btn-custom" onclick="submitAddFee()"><i class="fas fa-save me-2"></i>儲存</button>`;
      showModal('新增會費記錄', body, footer);
    }

    async function submitAddFee() {
      try {
        const form = document.getElementById('addFeeForm');
        const feeData = Object.fromEntries(new FormData(form).entries());
        const required = ['memberId', 'year', 'amount', 'paymentDate', 'paymentMethod'];
        for (const f of required) if (!feeData[f]) return showAlert('請填寫所有必填欄位', 'warning');
        showLoading();
        const result = await apiCall('addMembershipFee', { feeData });
        hideModal();
        if (result.success) { showAlert('會費記錄新增成功', 'success'); loadPage('membership-fee'); }
        else showAlert('新增會費記錄失敗：' + (result.message || ''), 'danger');
      } catch (e) { showAlert('新增會費記錄失敗：' + e.message, 'danger'); }
    }

    function showAddDonationModal() {
      const today = new Date().toISOString().split('T')[0];
      const body = `
        <form id="addDonationForm">
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">捐款人姓名 *</label><input type="text" class="form-control" name="donorName" required></div>
            <div class="col-md-6 mb-3"><label class="form-label">會員編號</label><input type="text" class="form-control" name="memberId" placeholder="如為會員請填寫"></div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">捐款金額 *</label><input type="number" class="form-control" name="amount" required></div>
            <div class="col-md-6 mb-3"><label class="form-label">捐款日期 *</label><input type="date" class="form-control" name="donationDate" required value="${today}"></div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">捐款用途 *</label>
              <select class="form-select" name="purpose" required>
                <option value="">請選擇</option><option value="一般捐款">一般捐款</option><option value="醫療補助">醫療補助</option>
                <option value="教育推廣">教育推廣</option><option value="活動經費">活動經費</option><option value="其他">其他</option>
              </select>
            </div>
            <div class="col-md-6 mb-3"><label class="form-label">捐款方式 *</label>
              <select class="form-select" name="method" required>
                <option value="">請選擇</option><option value="現金">現金</option><option value="轉帳">轉帳</option><option value="支票">支票</option><option value="信用卡">信用卡</option>
              </select>
            </div>
          </div>
          <div class="mb-3"><label class="form-label">統一編號</label><input type="text" class="form-control" name="taxNumber" placeholder="需要開立統編收據時填寫"></div>
          <div class="mb-3"><label class="form-label">備註</label><textarea class="form-control" name="note" rows="2"></textarea></div>
        </form>`;
      const footer = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary-custom btn-custom" onclick="submitAddDonation()"><i class="fas fa-save me-2"></i>儲存</button>`;
      showModal('新增捐款記錄', body, footer);
    }

    async function submitAddDonation() {
      try {
        const form = document.getElementById('addDonationForm');
        const donationData = Object.fromEntries(new FormData(form).entries());
        const required = ['donorName', 'amount', 'donationDate', 'purpose', 'method'];
        for (const f of required) if (!donationData[f]) return showAlert('請填寫所有必填欄位', 'warning');
        showLoading();
        const result = await apiCall('addDonation', { donationData });
        hideModal();
        if (result.success) { showAlert('捐款記錄新增成功', 'success'); loadPage('donation'); }
        else showAlert('新增捐款記錄失敗：' + (result.message || ''), 'danger');
      } catch (e) { showAlert('新增捐款記錄失敗：' + e.message, 'danger'); }
    }

    function showAddExpenseModal() {
      const today = new Date().toISOString().split('T')[0];
      const body = `
        <form id="addExpenseForm">
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">申請人 *</label><input type="text" class="form-control" name="applicant" required value="管理員"></div>
            <div class="col-md-6 mb-3"><label class="form-label">支出日期 *</label><input type="date" class="form-control" name="expenseDate" required value="${today}"></div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">支出類別 *</label>
              <select class="form-select" name="category" required>
                <option value="">請選擇</option><option value="辦公用品">辦公用品</option><option value="活動費用">活動費用</option>
                <option value="交通費">交通費</option><option value="餐費">餐費</option><option value="場地租借">場地租借</option><option value="設備購置">設備購置</option><option value="其他">其他</option>
              </select>
            </div>
            <div class="col-md-6 mb-3"><label class="form-label">金額 *</label><input type="number" class="form-control" name="amount" required></div>
          </div>
          <div class="mb-3"><label class="form-label">支出項目 *</label><input type="text" class="form-control" name="item" required placeholder="詳細說明支出項目"></div>
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">收款人 *</label><input type="text" class="form-control" name="payee" required></div>
            <div class="col-md-6 mb-3"><label class="form-label">付款方式 *</label>
              <select class="form-select" name="paymentMethod" required><option value="">請選擇</option><option value="現金">現金</option><option value="轉帳">轉帳</option><option value="支票">支票</option><option value="信用卡">信用卡</option></select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">憑證編號</label><input type="text" class="form-control" name="voucherNumber" placeholder="發票或收據編號"></div>
            <div class="col-md-6 mb-3"><label class="form-label">優先級 *</label>
              <select class="form-select" name="priority" required><option value="中">中</option><option value="高">高</option><option value="低">低</option></select>
            </div>
          </div>
          <div class="mb-3"><label class="form-label">申請事由 *</label><textarea class="form-control" name="reason" rows="3" required placeholder="詳細說明申請支出的原因"></textarea></div>
          <div class="mb-3"><label class="form-label">備註</label><textarea class="form-control" name="note" rows="2"></textarea></div>
        </form>`;
      const footer = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary-custom btn-custom" onclick="submitAddExpense()"><i class="fas fa-save me-2"></i>提交申請</button>`;
      showModal('新增支出申請', body, footer);
    }

    async function submitAddExpense() {
      try {
        const form = document.getElementById('addExpenseForm');
        const expenseData = Object.fromEntries(new FormData(form).entries());
        const required = ['applicant','expenseDate','category','amount','item','payee','paymentMethod','priority','reason'];
        for (const f of required) if (!expenseData[f]) return showAlert('請填寫所有必填欄位', 'warning');
        showLoading();
        const result = await apiCall('addExpense', { expenseData });
        hideModal();
        if (result.success) { showAlert('支出申請提交成功', 'success'); loadPage('expense'); }
        else showAlert('提交支出申請失敗：' + (result.message || ''), 'danger');
      } catch (e) { showAlert('提交支出申請失敗：' + e.message, 'danger'); }
    }

    async function confirmFee(recordId) {
      try {
        showLoading();
        const result = await apiCall('updateMembershipFeeStatus', { recordId, status: '已確認', note: '手動確認' });
        hideLoading();
        if (result.success) { showAlert('會費確認成功', 'success'); loadPage('membership-fee'); }
        else showAlert('會費確認失敗：' + (result.message || ''), 'danger');
      } catch (e) { hideLoading(); showAlert('會費確認失敗：' + e.message, 'danger'); }
    }

    async function approveExpense(expenseId) {
      try {
        showLoading();
        const result = await apiCall('updateExpenseStatus', { expenseId, status: '已核准', approver: '管理員', note: '手動核准' });
        hideLoading();
        if (result.success) { showAlert('支出核准成功', 'success'); loadPage('expense'); }
        else showAlert('支出核准失敗：' + (result.message || ''), 'danger');
      } catch (e) { hideLoading(); showAlert('支出核准失敗：' + e.message, 'danger'); }
    }

    async function rejectExpense(expenseId) {
      try {
        showLoading();
        const result = await apiCall('updateExpenseStatus', { expenseId, status: '已拒絕', approver: '管理員', note: '手動拒絕' });
        hideLoading();
        if (result.success) { showAlert('支出已拒絕', 'warning'); loadPage('expense'); }
        else showAlert('支出拒絕失敗：' + (result.message || ''), 'danger');
      } catch (e) { hideLoading(); showAlert('支出拒絕失敗：' + e.message, 'danger'); }
    }

    async function processApprovalAction(processId, action) {
      try {
        showLoading();
        const result = await apiCall('processApproval', { processId, action, approver: '管理員', note: action === 'approve' ? '核准通過' : '核准拒絕' });
        hideLoading();
        if (result.success) { showAlert(action === 'approve' ? '核准成功' : '已拒絕申請', action === 'approve' ? 'success' : 'warning'); loadPage('approval'); }
        else showAlert('處理核准失敗：' + (result.message || ''), 'danger');
      } catch (e) { hideLoading(); showAlert('處理核准失敗：' + e.message, 'danger'); }
    }

    function voidReceiptConfirm(receiptId) {
      const body = `
        <div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>確定要作廢收據 ${escapeHTML(receiptId)} 嗎？此操作無法復原。</div>
        <div class="mb-3"><label class="form-label">作廢原因 *</label><textarea class="form-control" id="voidReason" rows="3" required placeholder="請說明作廢原因"></textarea></div>`;
      const footer = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-danger" onclick="voidReceiptExecute('${escapeHTML(receiptId)}')"><i class="fas fa-ban me-2"></i>確認作廢</button>`;
      showModal('作廢收據', body, footer);
    }

    async function voidReceiptExecute(receiptId) {
      try {
        const reason = document.getElementById('voidReason').value.trim();
        if (!reason) return showAlert('請填寫作廢原因', 'warning');
        showLoading();
        const result = await apiCall('voidReceipt', { receiptId, reason });
        hideLoading(); hideModal();
        if (result.success) { showAlert('收據作廢成功', 'success'); loadPage('receipt'); }
        else showAlert('收據作廢失敗：' + (result.message || ''), 'danger');
      } catch (e) { hideLoading(); showAlert('收據作廢失敗：' + e.message, 'danger'); }
    }

    async function updateSettingValue(settingName) {
      try {
        const inputElement = document.getElementById(`setting_${settingName}`);
        const newValue = inputElement ? inputElement.value : '';
        showLoading();
        const result = await apiCall('updateSetting', { settingName, settingValue: newValue });
        hideLoading();
        if (result.success) showAlert('設定更新成功', 'success');
        else showAlert('設定更新失敗：' + (result.message || ''), 'danger');
      } catch (e) { hideLoading(); showAlert('設定更新失敗：' + e.message, 'danger'); }
    }

    async function backupSystem() {
      try {
        showAlert('正在備份系統資料...', 'info');
        showLoading();
        const result = await apiCall('backupData');
        hideLoading();
        if (result.success) showAlert('系統備份完成', 'success');
        else showAlert('系統備份失敗：' + (result.message || ''), 'danger');
      } catch (e) { hideLoading(); showAlert('系統備份失敗：' + e.message, 'danger'); }
    }

    async function systemHealthCheck() {
      try {
        showAlert('正在執行系統健康檢查...', 'info');
        showLoading();
        const result = await apiCall('systemHealthCheck');
        hideLoading();
        if (result.success) {
          const healthData = result.data;
          let statusClass = 'success', statusText = '系統狀態良好';
          if (healthData.overallStatus === 'WARNING') { statusClass = 'warning'; statusText = '系統有警告'; }
          else if (healthData.overallStatus === 'ERROR') { statusClass = 'danger'; statusText = '系統有錯誤'; }
          showAlert(statusText, statusClass);
          const checksHtml = (healthData.checks || []).map(check => `
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>${escapeHTML(check.name)}</span>
              <span class="badge bg-${check.status === 'OK' ? 'success' : check.status === 'WARNING' ? 'warning' : 'danger'}">${escapeHTML(check.status)}</span>
            </div>`).join('');
          showModal('系統健康檢查結果', `
            <div class="alert alert-${statusClass}"><strong>整體狀態：${escapeHTML(healthData.overallStatus)}</strong></div>
            ${checksHtml}
            <small class="text-muted">檢查時間：${new Date(healthData.timestamp).toLocaleString()}</small>`, '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>');
        } else showAlert('系統健康檢查失敗：' + (result.message || ''), 'danger');
      } catch (e) { hideLoading(); showAlert('系統健康檢查失敗：' + e.message, 'danger'); }
    }

    async function initializeSystemData() {
      try {
        if (!confirm('確定要初始化系統嗎？這將建立所有必要的工作表結構。')) return;
        showAlert('正在初始化系統...', 'info');
        showLoading();
        const result = await apiCall('initializeSystem');
        hideLoading();
        if (result.success) showAlert('系統初始化完成', 'success');
        else showAlert('系統初始化失敗：' + (result.message || ''), 'danger');
      } catch (e) { hideLoading(); showAlert('系統初始化失敗：' + e.message, 'danger'); }
    }

    async function testAllFunctions() {
      try {
        showAlert('正在測試所有功能...', 'info');
        showLoading();
        const result = await apiCall('testAllApiFunctions');
        hideLoading();
        if (result.success) {
          const testResults = result.data || [];
          const passed = testResults.filter(t => t.success).length;
          const total = testResults.length;
          showAlert(`功能測試完成：${passed}/${total} 項通過`, passed === total ? 'success' : 'warning');
          const resultsHtml = testResults.map(test => `
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>${escapeHTML(test.name)}</span>
              <span class="badge bg-${test.success ? 'success' : 'danger'}">${test.success ? '通過' : '失敗'}</span>
            </div>`).join('');
          showModal('功能測試結果', resultsHtml, '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>');
        } else showAlert('功能測試失敗：' + (result.message || ''), 'danger');
      } catch (e) { hideLoading(); showAlert('功能測試失敗：' + e.message, 'danger'); }
    }

    function showDateRangeModal() {
      const body = `
        <form id="dateRangeForm">
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">開始日期 *</label><input type="date" class="form-control" name="startDate" value="2024-01-01" required></div>
            <div class="col-md-6 mb-3"><label class="form-label">結束日期 *</label><input type="date" class="form-control" name="endDate" value="2024-12-31" required></div>
          </div>
        </form>`;
      const footer = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary-custom btn-custom" onclick="applyDateRange()"><i class="fas fa-search me-2"></i>查詢</button>`;
      showModal('選擇查詢期間', body, footer);
    }

    async function applyDateRange() {
      try {
        const form = document.getElementById('dateRangeForm');
        const dateRange = Object.fromEntries(new FormData(form).entries());
        hideModal();
        showLoading();
        const result = await apiCall('getFinancialReport', dateRange);
        if (result.success) { currentData.financialReport = result.data; loadPage('financial-report'); }
        else { hideLoading(); showAlert('查詢財務報表失敗：' + (result.message || ''), 'danger'); }
      } catch (e) { hideLoading(); showAlert('查詢財務報表失敗：' + e.message, 'danger'); }
    }

    function viewMember(memberId) {
      const m = currentData.members?.find(x => x['會員編號'] === memberId);
      if (!m) return showAlert('找不到會員資料', 'warning');
      const body = `
        <div class="row">
          <div class="col-md-6">
            <strong>會員編號：</strong> ${escapeHTML(m['會員編號'] || '')}<br>
            <strong>姓名：</strong> ${escapeHTML(m['姓名'] || '')}<br>
            <strong>性別：</strong> ${escapeHTML(m['性別'] || '-') }<br>
            <strong>手機：</strong> ${escapeHTML(m['手機'] || '-') }<br>
          </div>
          <div class="col-md-6">
            <strong>電子郵件：</strong> ${escapeHTML(m['電子郵件'] || '-') }<br>
            <strong>入會日期：</strong> ${escapeHTML(m['入會日期'] || '')}<br>
            <strong>會員狀態：</strong> ${escapeHTML(m['會員狀態'] || '')}<br>
          </div>
        </div>`;
      showModal('會員詳細資料', body, '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>');
    }

    function editMember(memberId) {
      const m = currentData.members?.find(x => x['會員編號'] === memberId);
      if (!m) return showAlert('找不到會員資料', 'warning');
      const body = `
        <form id="editMemberForm">
          <input type="hidden" name="memberId" value="${escapeHTML(m['會員編號'] || '')}">
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">姓名 *</label><input type="text" class="form-control" name="name" value="${escapeHTML(m['姓名'] || '')}" required></div>
            <div class="col-md-6 mb-3"><label class="form-label">性別</label>
              <select class="form-select" name="gender">
                <option value="">請選擇</option>
                <option value="男" ${m['性別'] === '男' ? 'selected' : ''}>男</option>
                <option value="女" ${m['性別'] === '女' ? 'selected' : ''}>女</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label class="form-label">手機</label><input type="tel" class="form-control" name="mobile" value="${escapeHTML(m['手機'] || '')}"></div>
            <div class="col-md-6 mb-3"><label class="form-label">電子郵件</label><input type="email" class="form-control" name="email" value="${escapeHTML(m['電子郵件'] || '')}"></div>
          </div>
          <div class="mb-3"><label class="form-label">會員狀態</label>
            <select class="form-select" name="status">
              <option value="有效" ${m['會員狀態'] === '有效' ? 'selected' : ''}>有效</option>
              <option value="停權" ${m['會員狀態'] === '停權' ? 'selected' : ''}>停權</option>
              <option value="退會" ${m['會員狀態'] === '退會' ? 'selected' : ''}>退會</option>
            </select>
          </div>
        </form>`;
      const footer = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary-custom btn-custom" onclick="submitEditMember()"><i class="fas fa-save me-2"></i>更新</button>`;
      showModal('編輯會員資料', body, footer);
    }

    async function submitEditMember() {
      try {
        const form = document.getElementById('editMemberForm');
        const memberData = Object.fromEntries(new FormData(form).entries());
        showLoading();
        const result = await apiCall('updateMember', { memberData });
        hideLoading(); hideModal();
        if (result.success) { showAlert('會員資料更新成功', 'success'); loadPage('membership'); }
        else showAlert('更新會員資料失敗：' + (result.message || ''), 'danger');
      } catch (e) { hideLoading(); showAlert('更新會員資料失敗：' + e.message, 'danger'); }
    }

    function viewFee(recordId) {
      const f = currentData.membershipFees?.find(x => x['記錄編號'] === recordId);
      if (!f) return showAlert('找不到會費記錄', 'warning');
      const body = `
        <div class="row">
          <div class="col-md-6">
            <strong>記錄編號：</strong> ${escapeHTML(f['記錄編號'] || '')}<br>
            <strong>會員姓名：</strong> ${escapeHTML(f['會員姓名'] || '')}<br>
            <strong>繳費年度：</strong> ${escapeHTML(f['繳費年度'] || '')}<br>
            <strong>金額：</strong> $${Number(f['金額'] || 0).toLocaleString()}<br>
          </div>
          <div class="col-md-6">
            <strong>繳費日期：</strong> ${escapeHTML(f['繳費日期'] || '')}<br>
            <strong>繳費方式：</strong> ${escapeHTML(f['繳費方式'] || '')}<br>
            <strong>狀態：</strong> ${escapeHTML(f['狀態'] || '')}<br>
            <strong>收據編號：</strong> ${escapeHTML(f['收據編號'] || '-') }<br>
          </div>
        </div>`;
      showModal('會費記錄詳細資料', body, '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>');
    }

    function viewDonation(donationId) {
      const d = currentData.donations?.find(x => x['捐款編號'] === donationId);
      if (!d) return showAlert('找不到捐款記錄', 'warning');
      const body = `
        <div class="row">
          <div class="col-md-6">
            <strong>捐款編號：</strong> ${escapeHTML(d['捐款編號'] || '')}<br>
            <strong>捐款人姓名：</strong> ${escapeHTML(d['捐款人姓名'] || '')}<br>
            <strong>捐款金額：</strong> $${Number(d['捐款金額'] || 0).toLocaleString()}<br>
            <strong>捐款日期：</strong> ${escapeHTML(d['捐款日期'] || '')}<br>
          </div>
          <div class="col-md-6">
            <strong>捐款用途：</strong> ${escapeHTML(d['捐款用途'] || '')}<br>
            <strong>捐款方式：</strong> ${escapeHTML(d['捐款方式'] || '')}<br>
            <strong>收據編號：</strong> ${escapeHTML(d['收據編號'] || '')}<br>
          </div>
        </div>`;
      showModal('捐款記錄詳細資料', body, '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>');
    }

    function viewExpense(expenseId) {
      const e = currentData.expenses?.find(x => x['支出編號'] === expenseId);
      if (!e) return showAlert('找不到支出記錄', 'warning');
      const body = `
        <div class="row">
          <div class="col-md-6">
            <strong>支出編號：</strong> ${escapeHTML(e['支出編號'] || '')}<br>
            <strong>申請人：</strong> ${escapeHTML(e['申請人'] || '')}<br>
            <strong>支出項目：</strong> ${escapeHTML(e['支出項目'] || '')}<br>
            <strong>金額：</strong> $${Number(e['金額'] || 0).toLocaleString()}<br>
          </div>
          <div class="col-md-6">
            <strong>支出日期：</strong> ${escapeHTML(e['支出日期'] || '')}<br>
            <strong>優先級：</strong> ${escapeHTML(e['優先級'] || '')}<br>
            <strong>核准狀態：</strong> ${escapeHTML(e['核准狀態'] || '')}<br>
          </div>
        </div>`;
      showModal('支出記錄詳細資料', body, '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>');
    }

    function viewApproval(processId) {
      const a = currentData.approvals?.find(x => x['流程編號'] === processId);
      if (!a) return showAlert('找不到核准流程', 'warning');
      const body = `
        <div class="row">
          <div class="col-md-6">
            <strong>流程編號：</strong> ${escapeHTML(a['流程編號'] || '')}<br>
            <strong>申請編號：</strong> ${escapeHTML(a['申請編號'] || '')}<br>
            <strong>申請類型：</strong> ${escapeHTML(a['申請類型'] || '')}<br>
            <strong>申請人：</strong> ${escapeHTML(a['申請人'] || '')}<br>
          </div>
          <div class="col-md-6">
            <strong>申請金額：</strong> $${Number(a['申請金額'] || 0).toLocaleString()}<br>
            <strong>申請日期：</strong> ${escapeHTML(a['申請日期'] || '')}<br>
            <strong>優先級：</strong> ${escapeHTML(a['優先級'] || '')}<br>
            <strong>目前狀態：</strong> ${escapeHTML(a['目前狀態'] || '')}<br>
          </div>
        </div>`;
      showModal('核准流程詳細資料', body, '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>');
    }

    async function printReceipt(receiptId) {
      try {
        showAlert('正在產生收據...', 'info');
        showLoading();
        const result = await apiCall('generateReceipt', { receiptId });
        hideLoading();
        if (result.success && result.data && result.data.html) {
          const w = window.open('', '_blank');
          w.document.write(result.data.html); w.document.close(); w.focus(); w.print();
          showAlert('收據產生成功', 'success');
        } else showAlert('產生收據失敗：' + (result.message || '未知錯誤'), 'danger');
      } catch (e) { hideLoading(); showAlert('產生收據失敗：' + e.message, 'danger'); }
    }

    async function exportFinancialReport() {
      try {
        showAlert('正在產生財務報表...', 'info');
        showLoading();
        const result = await apiCall('exportFinancialReport', { format: 'excel', startDate: '2024-01-01', endDate: '2024-12-31' });
        hideLoading();
        if (result.success && result.data && result.data.downloadUrl) {
          const a = document.createElement('a');
          a.href = result.data.downloadUrl; a.download = result.data.filename || 'report.xlsx';
          document.body.appendChild(a); a.click(); a.remove();
          showAlert('財務報表匯出成功', 'success');
        } else showAlert('匯出財務報表失敗：' + (result.message || '未知錯誤'), 'danger');
      } catch (e) { hideLoading(); showAlert('匯出財務報表失敗：' + e.message, 'danger'); }
    }

    function showSystemInfo() {
      const body = `
        <div class="row">
          <div class="col-md-6">
            <h6>系統資訊</h6><hr>
            <strong>系統名稱：</strong> 帕促會病友權益促進會管理系統<br>
            <strong>版本：</strong> 1.0.0<br>
            <strong>建置日期：</strong> 2024-11-04<br>
            <strong>瀏覽器：</strong> ${escapeHTML(navigator.userAgent || '')}<br>
          </div>
          <div class="col-md-6">
            <h6>連接資訊</h6><hr>
            <strong>API 狀態：</strong> ${API_CONFIG.offlineMode ? '離線模式' : '已連接'}<br>
            <strong>目前頁面：</strong> ${escapeHTML(currentPage)}<br>
            <strong>載入時間：</strong> ${new Date().toLocaleString()}<br>
            <strong>會話狀態：</strong> 活躍<br>
          </div>
        </div>
        <div class="mt-3">
          <h6>功能模組</h6><hr>
          <div class="row">
            <div class="col-md-4"><i class="fas fa-check text-success"></i> 會員管理<br><i class="fas fa-check text-success"></i> 會費管理<br><i class="fas fa-check text-success"></i> 捐款管理<br></div>
            <div class="col-md-4"><i class="fas fa-check text-success"></i> 支出管理<br><i class="fas fa-check text成功"></i> 收據管理<br><i class="fas fa-check text-success"></i> 核准流程<br></div>
            <div class="col-md-4"><i class="fas fa-check text-success"></i> 財務報表<br><i class="fas fa-check text-success"></i> 系統設定<br><i class="fas fa-check text-success"></i> 離線模式<br></div>
          </div>
        </div>`;
      showModal('系統資訊', body, '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>');
    }

    function clearCache() {
      try {
        currentData = {};
        if (dataTable) { dataTable.destroy(); dataTable = null; }
        showAlert('快取已清除', 'success');
      } catch (e) { showAlert('清除快取失敗：' + e.message, 'danger'); }
    }

    function quickAddMember() { showAddMemberModal(); }
    function quickAddExpense() { showAddExpenseModal(); }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); }

    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.key === 'n') {
        event.preventDefault();
        switch (currentPage) {
          case 'membership': showAddMemberModal(); break;
          case 'membership-fee': showAddFeeModal(); break;
          case 'donation': showAddDonationModal(); break;
          case 'expense': showAddExpenseModal(); break;
        }
      }
      if (event.key === 'Escape') {
        const modal = bootstrap.Modal.getInstance(document.getElementById('universalModal'));
        if (modal) modal.hide();
      }
    });

    window.addEventListener('resize', function() {
      if (dataTable) { dataTable.columns.adjust().draw(); }
      if (window.Chart && Chart.instances) {
        Object.values(Chart.instances).forEach(instance => instance.resize());
      }
    });

    window.addEventListener('error', function(event) {
      showAlert('系統發生錯誤，請重新整理頁面', 'danger');
    });
    window.addEventListener('unhandledrejection', function(event) {
      showAlert('系統處理請求時發生錯誤', 'danger');
    });
  </script>
</body>
</html>
