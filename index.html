<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友權益促進會 - 管理系統</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', 'PingFang TC', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background: white;
      border-radius: 12px;
      padding: 20px 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      color: #667eea;
      font-size: 24px;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 15px;
      background: #f5f5f5;
      border-radius: 20px;
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #667eea;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .card h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }
    
    .card h3 {
      color: #555;
      margin: 20px 0 15px 0;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-secondary {
      background: #2196F3;
      color: white;
    }
    
    .btn-success {
      background: #4CAF50;
      color: white;
    }
    
    .btn-danger {
      background: #f44336;
      color: white;
    }
    
    .btn-warning {
      background: #ff9800;
      color: white;
    }
    
    .btn-outline {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
    }
    
    .loading::after {
      content: '';
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .message {
      padding: 15px 20px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .message-error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #f44336;
    }
    
    .message-success {
      background: #e8f5e9;
      color: #2e7d32;
      border-left: 4px solid #4CAF50;
    }
    
    .message-info {
      background: #e3f2fd;
      color: #1565c0;
      border-left: 4px solid #2196F3;
    }
    
    .message-warning {
      background: #fff3e0;
      color: #e65100;
      border-left: 4px solid #ff9800;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stat-card h4 {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 10px;
    }
    
    .stat-card .stat-value {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-card .stat-label {
      font-size: 12px;
      opacity: 0.8;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    table th,
    table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    table th {
      background: #f5f5f5;
      font-weight: 600;
      color: #555;
    }
    
    table tr:hover {
      background: #f9f9f9;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-success {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .badge-warning {
      background: #fff3e0;
      color: #e65100;
    }
    
    .badge-danger {
      background: #ffebee;
      color: #c62828;
    }
    
    .badge-info {
      background: #e3f2fd;
      color: #1565c0;
    }
    
    .badge-secondary {
      background: #f5f5f5;
      color: #666;
    }
    
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .nav-tab {
      padding: 10px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.3s;
    }
    
    .nav-tab:hover {
      color: #667eea;
    }
    
    .nav-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h3 {
      margin: 0;
      color: #333;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    
    .modal-close:hover {
      color: #333;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .pagination button {
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .pagination button:hover:not(:disabled) {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .pagination button.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .search-bar input {
      flex: 1;
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .empty-state svg {
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
      opacity: 0.3;
    }
    
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .login-card {
      background: white;
      border-radius: 12px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .login-card h2 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
    }
    
    .login-card .logo {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .login-card .logo svg {
      width: 80px;
      height: 80px;
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .table-container {
        font-size: 12px;
      }
      
      table th,
      table td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    // ==================== 配置 ====================
    const CONFIG = {
      API_URL: 'https://script.google.com/macros/s/AKfycbyOBTgry9skxZWTxh4DeWkIQNj_zBglxNLpa7aPuINqdOi9m5tUf8j-hZakJdCSso92/exec', // 請替換為您的 GAS Web App URL
      STORAGE_KEYS: {
        TOKEN: 'pda_token',
        USER: 'pda_user'
      },
      MEMBER_STATUS: {
        ACTIVE: '正常',
        PENDING: '待審核',
        INACTIVE: '停權'
      },
      ACTIVITY_STATUS: {
        REGISTRATION: '報名中',
        FULL: '已額滿',
        ONGOING: '進行中',
        COMPLETED: '已結束',
        CANCELLED: '已取消'
      },
      REGISTRATION_STATUS: {
        REGISTERED: '已報名',
        WAITLIST: '候補',
        ATTENDED: '已出席',
        ABSENT: '缺席',
        CANCELLED: '已取消'
      }
    };

    // ==================== API 服務 ====================
    class APIService {
      static async call(action, data = {}) {
        try {
          const response = await fetch(CONFIG.API_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              action: action,
              ...data
            })
          });

          if (!response.ok) {
            throw new Error('網路請求失敗');
          }

          const result = await response.json();
          return result;

        } catch (error) {
          console.error('API Error:', error);
          return {
            success: false,
            error: error.message || '系統錯誤，請稍後再試'
          };
        }
      }

      // 認證相關
      static login(email, password) {
        return this.call('login', { email, password });
      }

      static register(memberData) {
        return this.call('register', memberData);
      }

      static resetPassword(email) {
        return this.call('resetPassword', { email });
      }

      // 會員相關
      static getMembers(page = 1, filters = {}) {
        return this.call('getMembers', { page, itemsPerPage: 20, filters });
      }

      static getMemberDetail(memberId) {
        return this.call('getMemberDetail', { memberId });
      }

      static updateMember(memberId, updateData) {
        return this.call('updateMember', { memberId, updateData });
      }

      static deleteMember(memberId) {
        return this.call('deleteMember', { memberId });
      }

      static getMemberStatistics() {
        return this.call('getMemberStatistics');
      }

      // 活動相關
      static getActivities(page = 1, status = null) {
        return this.call('getActivities', { page, itemsPerPage: 20, status });
      }

      static getActivityDetail(activityId) {
        return this.call('getActivityDetail', { activityId });
      }

      static createActivity(activityData) {
        return this.call('createActivity', activityData);
      }

      static updateActivity(activityId, updateData) {
        return this.call('updateActivity', { activityId, updateData });
      }

      static deleteActivity(activityId) {
        return this.call('deleteActivity', { activityId });
      }

      static cancelActivity(activityId, reason) {
        return this.call('cancelActivity', { activityId, reason });
      }

      static getActivityStatistics() {
        return this.call('getActivityStatistics');
      }

      // 報名相關
      static registerActivity(memberId, activityId, notes = '') {
        return this.call('registerActivity', { memberId, activityId, notes });
      }

      static cancelRegistration(registrationId, reason = '') {
        return this.call('cancelRegistration', { registrationId, reason });
      }

      static checkIn(registrationId) {
        return this.call('checkIn', { registrationId });
      }

      static getMemberRegistrations(memberId, filters = {}) {
        return this.call('getMemberRegistrations', { memberId, filters });
      }

      static getActivityRegistrations(activityId, status = null) {
        return this.call('getActivityRegistrations', { activityId, status });
      }

      // 財務相關
      static addFinanceRecord(financeData) {
        return this.call('addFinanceRecord', financeData);
      }

      static getFinanceRecords(filters = {}, page = 1) {
        return this.call('getFinanceRecords', { filters, page, itemsPerPage: 20 });
      }

      static updateFinanceRecord(recordId, updateData) {
        return this.call('updateFinanceRecord', { recordId, updateData });
      }

      static deleteFinanceRecord(recordId) {
        return this.call('deleteFinanceRecord', { recordId });
      }

      static getFinanceStatistics(startDate, endDate) {
        return this.call('getFinanceStatistics', { startDate, endDate });
      }

      // 儀表板
      static getDashboardData() {
        return this.call('getDashboardData');
      }

      // 報表
      static generateMemberReport(startDate, endDate) {
        return this.call('generateMemberReport', { startDate, endDate });
      }

      static generateActivityReport(startDate, endDate) {
        return this.call('generateActivityReport', { startDate, endDate });
      }

      static generateAttendanceReport(activityId = null) {
        return this.call('generateAttendanceReport', { activityId });
      }

      // 搜尋
      static globalSearch(keyword) {
        return this.call('globalSearch', { keyword });
      }

      static advancedMemberSearch(criteria) {
        return this.call('advancedMemberSearch', criteria);
      }

      static advancedActivitySearch(criteria) {
        return this.call('advancedActivitySearch', criteria);
      }

      // 通知
      static sendBulkNotification(recipientIds, title, content, type) {
        return this.call('sendBulkNotification', { recipientIds, title, content, type });
      }

      static sendToAllMembers(title, content) {
        return this.call('sendToAllMembers', { title, content });
      }

      // 備份
      static backupAllData() {
        return this.call('backupAllData');
      }

      static listBackups() {
        return this.call('listBackups');
      }

      static restoreData(fileId) {
        return this.call('restoreData', { fileId });
      }
    }

    // ==================== 認證服務 ====================
    class AuthService {
      static getUser() {
        const userStr = localStorage.getItem(CONFIG.STORAGE_KEYS.USER);
        return userStr ? JSON.parse(userStr) : null;
      }

      static getToken() {
        return localStorage.getItem(CONFIG.STORAGE_KEYS.TOKEN);
      }

      static setAuth(token, user) {
        localStorage.setItem(CONFIG.STORAGE_KEYS.TOKEN, token);
        localStorage.setItem(CONFIG.STORAGE_KEYS.USER, JSON.stringify(user));
      }

      static clearAuth() {
        localStorage.removeItem(CONFIG.STORAGE_KEYS.TOKEN);
        localStorage.removeItem(CONFIG.STORAGE_KEYS.USER);
      }

      static isAuthenticated() {
        return !!this.getToken();
      }

      static isAdmin() {
        const user = this.getUser();
        return user && user.role === 'admin';
      }
    }

    // ==================== UI 工具 ====================
    class UIUtils {
      static showLoading(message = '載入中...') {
        return `<div class="loading">${message}</div>`;
      }

      static showMessage(message, type = 'info') {
        return `<div class="message message-${type}">${message}</div>`;
      }

      static showError(message) {
        return this.showMessage(message, 'error');
      }

      static showSuccess(message) {
        return this.showMessage(message, 'success');
      }

      static showWarning(message) {
        return this.showMessage(message, 'warning');
      }

      static formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
      }

      static formatDateTime(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      static getStatusBadge(status, type = 'member') {
        const badges = {
          member: {
            '正常': 'success',
            '待審核': 'warning',
            '停權': 'danger'
          },
          activity: {
            '報名中': 'success',
            '已額滿': 'warning',
            '進行中': 'info',
            '已結束': 'secondary',
            '已取消': 'danger'
          },
          registration: {
            '已報名': 'success',
            '候補': 'warning',
            '已出席': 'info',
            '缺席': 'danger',
            '已取消': 'secondary'
          }
        };

        const badgeType = badges[type][status] || 'secondary';
        return `<span class="badge badge-${badgeType}">${status}</span>`;
      }

      static createPagination(currentPage, totalPages, onPageChange) {
        if (totalPages <= 1) return '';

        let html = '<div class="pagination">';
        
        // 上一頁
        html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="${onPageChange}(${currentPage - 1})">上一頁</button>`;
        
        // 頁碼
        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<button class="${i === currentPage ? 'active' : ''}" onclick="${onPageChange}(${i})">${i}</button>`;
          } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<button disabled>...</button>';
          }
        }
        
        // 下一頁
        html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="${onPageChange}(${currentPage + 1})">下一頁</button>`;
        
        html += '</div>';
        return html;
      }

      static showModal(title, content, onClose = null) {
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3>${title}</h3>
              <button class="modal-close" onclick="this.closest('.modal').remove(); ${onClose ? onClose + '()' : ''}">&times;</button>
            </div>
            <div class="modal-body">
              ${content}
            </div>
          </div>
        `;
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
            if (onClose) onClose();
          }
        });
        
        document.body.appendChild(modal);
        return modal;
      }

      static confirmDialog(message, onConfirm, onCancel = null) {
        const content = `
          <p style="margin-bottom: 20px;">${message}</p>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove(); ${onCancel ? onCancel + '()' : ''}">取消</button>
            <button class="btn btn-danger" onclick="this.closest('.modal').remove(); ${onConfirm}()">確認</button>
          </div>
        `;
        
        return this.showModal('確認操作', content);
      }
    }

    // ==================== 應用程式 ====================
    class App {
      constructor() {
        this.currentView = null;
        this.currentPage = 1;
        this.init();
      }

      init() {
        if (AuthService.isAuthenticated()) {
          this.showDashboard();
        } else {
          this.showLogin();
        }
      }

      render(content) {
        document.getElementById('root').innerHTML = content;
      }

      // ==================== 登入頁面 ====================
      showLogin() {
        this.currentView = 'login';
        
        const html = `
          <div class="login-container">
            <div class="login-card">
              <div class="logo">
                <svg viewBox="0 0 100 100" fill="#667eea">
                  <circle cx="50" cy="50" r="45" fill="none" stroke="#667eea" stroke-width="3"/>
                  <path d="M30,50 L45,65 L70,35" fill="none" stroke="#667eea" stroke-width="5" stroke-linecap="round"/>
                </svg>
              </div>
              <h2>帕金森病友權益促進會</h2>
              <div id="loginMessage"></div>
              <form onsubmit="app.handleLogin(event)">
                <div class="form-group">
                  <label>電子郵件</label>
                  <input type="email" id="loginEmail" required placeholder="請輸入電子郵件">
                </div>
                <div class="form-group">
                  <label>密碼</label>
                  <input type="password" id="loginPassword" required placeholder="請輸入密碼">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">登入</button>
                <button type="button" class="btn btn-outline" style="width: 100%;" onclick="app.showRegister()">註冊新帳號</button>
              </form>
              <div style="text-align: center; margin-top: 15px;">
                <a href="#" onclick="app.showResetPassword(); return false;" style="color: #667eea; text-decoration: none; font-size: 14px;">忘記密碼？</a>
              </div>
            </div>
          </div>
        `;
        
        this.render(html);
      }

      async handleLogin(event) {
        event.preventDefault();
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const messageDiv = document.getElementById('loginMessage');
        
        messageDiv.innerHTML = UIUtils.showLoading('登入中...');
        
        const result = await APIService.login(email, password);
        
        if (result.success) {
          AuthService.setAuth(result.token, result.user);
          messageDiv.innerHTML = UIUtils.showSuccess('登入成功！');
          setTimeout(() => this.showDashboard(), 500);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error || '登入失敗');
        }
      }

      // ==================== 註冊頁面 ====================
      showRegister() {
        this.currentView = 'register';
        
        const html = `
          <div class="login-container">
            <div class="login-card" style="max-width: 600px;">
              <h2>會員註冊</h2>
              <div id="registerMessage"></div>
              <form onsubmit="app.handleRegister(event)">
                <div class="form-row">
                  <div class="form-group">
                    <label>姓名 *</label>
                    <input type="text" id="regName" required>
                  </div>
                  <div class="form-group">
                    <label>性別 *</label>
                    <select id="regGender" required>
                      <option value="">請選擇</option>
                      <option value="男">男</option>
                      <option value="女">女</option>
                      <option value="其他">其他</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label>電子郵件 *</label>
                    <input type="email" id="regEmail" required>
                  </div>
                  <div class="form-group">
                    <label>手機號碼 *</label>
                    <input type="tel" id="regPhone" required>
                  </div>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label>密碼 *</label>
                    <input type="password" id="regPassword" required minlength="6">
                  </div>
                  <div class="form-group">
                    <label>確認密碼 *</label>
                    <input type="password" id="regPasswordConfirm" required minlength="6">
                  </div>
                </div>
                
                <div class="form-group">
                  <label>出生日期</label>
                  <input type="date" id="regBirthDate">
                </div>
                
                <div class="form-group">
                  <label>地址</label>
                  <input type="text" id="regAddress">
                </div>
                
                <div style="display: flex; gap: 10px;">
                  <button type="button" class="btn btn-secondary" onclick="app.showLogin()">返回登入</button>
                  <button type="submit" class="btn btn-primary" style="flex: 1;">註冊</button>
                </div>
              </form>
            </div>
          </div>
        `;
        
        this.render(html);
      }

      async handleRegister(event) {
        event.preventDefault();
        
        const password = document.getElementById('regPassword').value;
        const passwordConfirm = document.getElementById('regPasswordConfirm').value;
        const messageDiv = document.getElementById('registerMessage');
        
        if (password !== passwordConfirm) {
          messageDiv.innerHTML = UIUtils.showError('密碼不一致');
          return;
        }
        
        const memberData = {
          name: document.getElementById('regName').value,
          gender: document.getElementById('regGender').value,
          email: document.getElementById('regEmail').value,
          phone: document.getElementById('regPhone').value,
          password: password,
          birthDate: document.getElementById('regBirthDate').value,
          address: document.getElementById('regAddress').value
        };
        
        messageDiv.innerHTML = UIUtils.showLoading('註冊中...');
        
        const result = await APIService.register(memberData);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess('註冊成功！請等待管理員審核。');
          setTimeout(() => this.showLogin(), 2000);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error || '註冊失敗');
        }
      }

      // ==================== 忘記密碼 ====================
      showResetPassword() {
        const content = `
          <div id="resetMessage"></div>
          <div class="form-group">
            <label>電子郵件</label>
            <input type="email" id="resetEmail" placeholder="請輸入註冊時的電子郵件">
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">取消</button>
            <button class="btn btn-primary" onclick="app.handleResetPassword()">發送重設連結</button>
          </div>
        `;
        
        UIUtils.showModal('重設密碼', content);
      }

      async handleResetPassword() {
        const email = document.getElementById('resetEmail').value;
        const messageDiv = document.getElementById('resetMessage');
        
        if (!email) {
          messageDiv.innerHTML = UIUtils.showError('請輸入電子郵件');
          return;
        }
        
        messageDiv.innerHTML = UIUtils.showLoading('發送中...');
        
        const result = await APIService.resetPassword(email);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess('重設連結已發送到您的信箱');
          setTimeout(() => {
            document.querySelector('.modal').remove();
          }, 2000);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error || '發送失敗');
        }
      }

      // ==================== 儀表板 ====================
      async showDashboard() {
        this.currentView = 'dashboard';
        const user = AuthService.getUser();
        
        this.render(UIUtils.showLoading('載入儀表板...'));
        
        const result = await APIService.getDashboardData();
        
        if (!result.success) {
          this.render(UIUtils.showError(result.error));
          return;
        }
        
        const data = result.data;
        
        const html = `
          <div class="header">
            <h1>🏥 帕金森病友權益促進會</h1>
            <div class="header-actions">
              <div class="user-info">
                <div class="user-avatar">${user.name.charAt(0)}</div>
                <span>${user.name}</span>
              </div>
              <button class="btn btn-secondary btn-sm" onclick="app.showProfile()">個人資料</button>
              ${user.role === 'admin' ? '<button class="btn btn-warning btn-sm" onclick="app.showAdminPanel()">管理後台</button>' : ''}
              <button class="btn btn-danger btn-sm" onclick="app.handleLogout()">登出</button>
            </div>
          </div>
          
          <div class="container">
            <div class="card">
              <h2>📊 系統概況</h2>
              <div class="stats-grid">
                <div class="stat-card">
                  <h4>會員總數</h4>
                  <div class="stat-value">${data.summary.members.total}</div>
                  <div class="stat-label">本月新增 ${data.summary.members.thisMonth} 人</div>
                </div>
                <div class="stat-card">
                  <h4>活動總數</h4>
                  <div class="stat-value">${data.summary.activities.total}</div>
                  <div class="stat-label">本月舉辦 ${data.summary.activities.thisMonth} 場</div>
                </div>
                <div class="stat-card">
                  <h4>本月財務</h4>
                  <div class="stat-value">$${data.summary.finance.balance.toLocaleString()}</div>
                  <div class="stat-label">收入 $${data.summary.finance.totalIncome.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                  <h4>總參與人次</h4>
                  <div class="stat-value">${data.summary.activities.totalParticipants}</div>
                  <div class="stat-label">平均 ${data.summary.activities.averageParticipants} 人/場</div>
                </div>
              </div>
            </div>
            
            ${data.alerts.length > 0 ? `
            <div class="card">
              <h2>⚠️ 系統警示</h2>
              ${data.alerts.map(alert => `
                <div class="message message-${alert.type}">
                  <strong>${alert.title}</strong><br>
                  ${alert.message}
                </div>
              `).join('')}
            </div>
            ` : ''}
            
            <div class="card">
              <h2>📅 即將舉行的活動</h2>
              ${data.upcomingActivities.length > 0 ? `
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>活動名稱</th>
                        <th>日期</th>
                        <th>地點</th>
                        <th>剩餘名額</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data.upcomingActivities.map(activity => `
                        <tr>
                          <td>${activity.name}</td>
                          <td>${UIUtils.formatDate(activity.date)}</td>
                          <td>${activity.location}</td>
                          <td>${activity.vacancy > 0 ? activity.vacancy + ' 個' : '已額滿'}</td>
                          <td>
                            <button class="btn btn-primary btn-sm" onclick="app.showActivityDetail('${activity.id}')">查看詳情</button>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              ` : '<div class="empty-state">目前沒有即將舉行的活動</div>'}
              <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="app.showActivities()">查看所有活動</button>
              </div>
            </div>
            
            <div class="card">
              <h2>📝 最近的報名記錄</h2>
              ${data.recentRegistrations.length > 0 ? `
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>會員</th>
                        <th>活動</th>
                        <th>報名時間</th>
                        <th>狀態</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data.recentRegistrations.map(reg => `
                        <tr>
                          <td>${reg.memberName}</td>
                          <td>${reg.activityName}</td>
                          <td>${UIUtils.formatDateTime(reg.time)}</td>
                          <td>${UIUtils.getStatusBadge(reg.status, 'registration')}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              ` : '<div class="empty-state">目前沒有報名記錄</div>'}
            </div>
          </div>
        `;
        
        this.render(html);
      }

      // ==================== 活動列表 ====================
      async showActivities(page = 1, status = null) {
        this.currentView = 'activities';
        this.currentPage = page;
        
        this.renderWithHeader(UIUtils.showLoading('載入活動列表...'));
        
        const result = await APIService.getActivities(page, status);
        
        if (!result.success) {
          this.renderWithHeader(UIUtils.showError(result.error));
          return;
        }
        
        const html = `
          <div class="card">
            <h2>🎯 活動列表</h2>
            
            <div class="nav-tabs">
              <button class="nav-tab ${!status ? 'active' : ''}" onclick="app.showActivities(1, null)">全部</button>
              <button class="nav-tab ${status === '報名中' ? 'active' : ''}" onclick="app.showActivities(1, '報名中')">報名中</button>
              <button class="nav-tab ${status === '已額滿' ? 'active' : ''}" onclick="app.showActivities(1, '已額滿')">已額滿</button>
              <button class="nav-tab ${status === '已結束' ? 'active' : ''}" onclick="app.showActivities(1, '已結束')">已結束</button>
            </div>
            
            ${result.data.length > 0 ? `
              <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                ${result.data.map(activity => `
                  <div class="card" style="margin: 0;">
                    <h3>${activity['活動名稱']}</h3>
                    <p><strong>日期：</strong>${UIUtils.formatDate(activity['日期'])}</p>
                    <p><strong>時間：</strong>${activity['開始時間']} - ${activity['結束時間']}</p>
                    <p><strong>地點：</strong>${activity['地點']}</p>
                    <p><strong>講師：</strong>${activity['講師'] || '無'}</p>
                    <p><strong>名額：</strong>${activity['目前報名數']}/${activity['報名上限']}</p>
                    <p>${UIUtils.getStatusBadge(activity['狀態'], 'activity')}</p>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                      <button class="btn btn-secondary btn-sm" style="flex: 1;" onclick="app.showActivityDetail('${activity['ID']}')">查看詳情</button>
                      ${activity['可報名'] ? `<button class="btn btn-primary btn-sm" style="flex: 1;" onclick="app.handleRegisterActivity('${activity['ID']}')">立即報名</button>` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
              
              ${UIUtils.createPagination(result.pagination.currentPage, result.pagination.totalPages, `app.showActivities`)}
            ` : '<div class="empty-state">目前沒有活動</div>'}
          </div>
        `;
        
        this.renderWithHeader(html);
      }

      // ==================== 活動詳情 ====================
      async showActivityDetail(activityId) {
        this.renderWithHeader(UIUtils.showLoading('載入活動詳情...'));
        
        const result = await APIService.getActivityDetail(activityId);
        
        if (!result.success) {
          this.renderWithHeader(UIUtils.showError(result.error));
          return;
        }
        
        const activity = result.data;
        const user = AuthService.getUser();
        
        // 檢查是否已報名
        const registrations = await APIService.getMemberRegistrations(user.id);
        const hasRegistered = registrations.success && 
          registrations.data.some(r => r['活動ID'] === activityId && r['狀態'] !== '已取消');
        
        const html = `
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
              <div>
                <h2>${activity['活動名稱']}</h2>
                <p style="color: #666; margin-top: 5px;">${activity['類型'] || '一般活動'}</p>
              </div>
              <div>
                ${UIUtils.getStatusBadge(activity['狀態'], 'activity')}
              </div>
            </div>
            
            <div class="form-row">
              <div>
                <p><strong>📅 日期：</strong>${UIUtils.formatDate(activity['日期'])}</p>
                <p><strong>🕐 時間：</strong>${activity['開始時間']} - ${activity['結束時間']}</p>
                <p><strong>📍 地點：</strong>${activity['地點']}</p>
              </div>
              <div>
                <p><strong>👨‍🏫 講師：</strong>${activity['講師'] || '無'}</p>
                <p><strong>👥 名額：</strong>${activity['目前報名數']}/${activity['報名上限']}</p>
                <p><strong>📝 報名截止：</strong>${UIUtils.formatDate(activity['報名截止日'])}</p>
              </div>
            </div>
            
            ${activity['描述'] ? `
              <div style="margin-top: 20px;">
                <h3>活動說明</h3>
                <p style="white-space: pre-wrap;">${activity['描述']}</p>
              </div>
            ` : ''}
            
            ${activity['活動內容'] ? `
              <div style="margin-top: 20px;">
                <h3>活動內容</h3>
                <p style="white-space: pre-wrap;">${activity['活動內容']}</p>
              </div>
            ` : ''}
            
            ${activity['注意事項'] ? `
              <div style="margin-top: 20px;">
                <h3>注意事項</h3>
                <p style="white-space: pre-wrap;">${activity['注意事項']}</p>
              </div>
            ` : ''}
            
            <div style="display: flex; gap: 10px; margin-top: 30px;">
              <button class="btn btn-secondary" onclick="app.showActivities()">返回列表</button>
              ${!hasRegistered && activity['剩餘名額'] > 0 && activity['狀態'] === '報名中' ? 
                `<button class="btn btn-primary" onclick="app.handleRegisterActivity('${activityId}')">立即報名</button>` : ''}
              ${hasRegistered ? 
                `<button class="btn btn-warning" onclick="app.showMyRegistrations()">查看我的報名</button>` : ''}
            </div>
          </div>
        `;
        
        this.renderWithHeader(html);
      }

      // ==================== 報名活動 ====================
      async handleRegisterActivity(activityId) {
        const user = AuthService.getUser();
        
        const content = `
          <div id="regMessage"></div>
          <p>確認要報名此活動嗎？</p>
          <div class="form-group">
            <label>備註（選填）</label>
            <textarea id="regNotes" placeholder="如有特殊需求請在此說明"></textarea>
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">取消</button>
            <button class="btn btn-primary" onclick="app.confirmRegisterActivity('${activityId}')">確認報名</button>
          </div>
        `;
        
        UIUtils.showModal('報名活動', content);
      }

      async confirmRegisterActivity(activityId) {
        const user = AuthService.getUser();
        const notes = document.getElementById('regNotes').value;
        const messageDiv = document.getElementById('regMessage');
        
        messageDiv.innerHTML = UIUtils.showLoading('報名中...');
        
        const result = await APIService.registerActivity(user.id, activityId, notes);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess(result.message);
          setTimeout(() => {
            document.querySelector('.modal').remove();
            this.showActivityDetail(activityId);
          }, 1500);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      // ==================== 我的報名 ====================
      async showMyRegistrations() {
        const user = AuthService.getUser();
        
        this.renderWithHeader(UIUtils.showLoading('載入報名記錄...'));
        
        const result = await APIService.getMemberRegistrations(user.id);
        
        if (!result.success) {
          this.renderWithHeader(UIUtils.showError(result.error));
          return;
        }
        
        const html = `
          <div class="card">
            <h2>📝 我的報名記錄</h2>
            
            ${result.data.length > 0 ? `
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>活動名稱</th>
                      <th>活動日期</th>
                      <th>地點</th>
                      <th>報名時間</th>
                      <th>狀態</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${result.data.map(reg => `
                      <tr>
                        <td>${reg['活動名稱']}</td>
                        <td>${UIUtils.formatDate(reg['活動日期'])}</td>
                        <td>${reg['活動地點']}</td>
                        <td>${UIUtils.formatDateTime(reg['報名時間'])}</td>
                        <td>${UIUtils.getStatusBadge(reg['狀態'], 'registration')}</td>
                        <td>
                          <button class="btn btn-secondary btn-sm" onclick="app.showActivityDetail('${reg['活動ID']}')">查看</button>
                          ${reg['狀態'] === '已報名' || reg['狀態'] === '候補' ? 
                            `<button class="btn btn-danger btn-sm" onclick="app.handleCancelRegistration('${reg['ID']}')">取消</button>` : ''}
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            ` : '<div class="empty-state">您還沒有報名任何活動</div>'}
          </div>
        `;
        
        this.renderWithHeader(html);
      }

      // ==================== 取消報名 ====================
      async handleCancelRegistration(registrationId) {
        const content = `
          <div id="cancelMessage"></div>
          <p>確定要取消報名嗎？</p>
          <div class="form-group">
            <label>取消原因（選填）</label>
            <textarea id="cancelReason" placeholder="請說明取消原因"></textarea>
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">返回</button>
            <button class="btn btn-danger" onclick="app.confirmCancelRegistration('${registrationId}')">確認取消</button>
          </div>
        `;
        
        UIUtils.showModal('取消報名', content);
      }

      async confirmCancelRegistration(registrationId) {
        const reason = document.getElementById('cancelReason').value;
        const messageDiv = document.getElementById('cancelMessage');
        
        messageDiv.innerHTML = UIUtils.showLoading('處理中...');
        
        const result = await APIService.cancelRegistration(registrationId, reason);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess(result.message);
          setTimeout(() => {
            document.querySelector('.modal').remove();
            this.showMyRegistrations();
          }, 1500);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      // ==================== 個人資料 ====================
      async showProfile() {
        const user = AuthService.getUser();
        
        this.renderWithHeader(UIUtils.showLoading('載入個人資料...'));
        
        const result = await APIService.getMemberDetail(user.id);
        
        if (!result.success) {
          this.renderWithHeader(UIUtils.showError(result.error));
          return;
        }
        
        const member = result.data;
        
        const html = `
          <div class="card">
            <h2>👤 個人資料</h2>
            <div id="profileMessage"></div>
            
            <form onsubmit="app.handleUpdateProfile(event)">
              <div class="form-row">
                <div class="form-group">
                  <label>姓名</label>
                  <input type="text" id="profileName" value="${member['姓名']}" required>
                </div>
                <div class="form-group">
                  <label>性別</label>
                  <select id="profileGender" required>
                    <option value="男" ${member['性別'] === '男' ? 'selected' : ''}>男</option>
                    <option value="女" ${member['性別'] === '女' ? 'selected' : ''}>女</option>
                    <option value="其他" ${member['性別'] === '其他' ? 'selected' : ''}>其他</option>
                  </select>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label>電子郵件</label>
                  <input type="email" id="profileEmail" value="${member['電子郵件']}" required>
                </div>
                <div class="form-group">
                  <label>手機號碼</label>
                  <input type="tel" id="profilePhone" value="${member['手機號碼']}" required>
                </div>
              </div>
              
              <div class="form-group">
                <label>出生日期</label>
                <input type="date" id="profileBirthDate" value="${member['出生日期'] || ''}">
              </div>
              
              <div class="form-group">
                <label>地址</label>
                <input type="text" id="profileAddress" value="${member['地址'] || ''}">
              </div>
              
              <div class="form-group">
                <label>緊急聯絡人</label>
                <input type="text" id="profileEmergencyContact" value="${member['緊急聯絡人'] || ''}">
              </div>
              
              <div class="form-group">
                <label>緊急聯絡電話</label>
                <input type="tel" id="profileEmergencyPhone" value="${member['緊急聯絡電話'] || ''}">
              </div>
              
              <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-secondary" onclick="app.showDashboard()">返回</button>
                <button type="submit" class="btn btn-primary">儲存變更</button>
              </div>
            </form>
          </div>
          
          <div class="card">
            <h3>🔒 變更密碼</h3>
            <div id="passwordMessage"></div>
            <form onsubmit="app.handleChangePassword(event)">
              <div class="form-group">
                <label>目前密碼</label>
                <input type="password" id="currentPassword" required>
              </div>
              <div class="form-group">
                <label>新密碼</label>
                <input type="password" id="newPassword" required minlength="6">
              </div>
              <div class="form-group">
                <label>確認新密碼</label>
                <input type="password" id="confirmPassword" required minlength="6">
              </div>
              <button type="submit" class="btn btn-warning">變更密碼</button>
            </form>
          </div>
        `;
        
        this.renderWithHeader(html);
      }

      async handleUpdateProfile(event) {
        event.preventDefault();
        
        const user = AuthService.getUser();
        const messageDiv = document.getElementById('profileMessage');
        
        const updateData = {
          姓名: document.getElementById('profileName').value,
          性別: document.getElementById('profileGender').value,
          電子郵件: document.getElementById('profileEmail').value,
          手機號碼: document.getElementById('profilePhone').value,
          出生日期: document.getElementById('profileBirthDate').value,
          地址: document.getElementById('profileAddress').value,
          緊急聯絡人: document.getElementById('profileEmergencyContact').value,
          緊急聯絡電話: document.getElementById('profileEmergencyPhone').value
        };
        
        messageDiv.innerHTML = UIUtils.showLoading('更新中...');
        
        const result = await APIService.updateMember(user.id, updateData);
        
        if (result.success) {
          // 更新本地用戶資料
          user.name = updateData.姓名;
          user.email = updateData.電子郵件;
          AuthService.setAuth(AuthService.getToken(), user);
          
          messageDiv.innerHTML = UIUtils.showSuccess('資料更新成功！');
          setTimeout(() => {
            messageDiv.innerHTML = '';
          }, 3000);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      async handleChangePassword(event) {
        event.preventDefault();
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const messageDiv = document.getElementById('passwordMessage');
        
        if (newPassword !== confirmPassword) {
          messageDiv.innerHTML = UIUtils.showError('新密碼不一致');
          return;
        }
        
        const user = AuthService.getUser();
        messageDiv.innerHTML = UIUtils.showLoading('變更中...');
        
        // 先驗證舊密碼
        const loginResult = await APIService.login(user.email, currentPassword);
        
        if (!loginResult.success) {
          messageDiv.innerHTML = UIUtils.showError('目前密碼錯誤');
          return;
        }
        
        // 更新密碼
        const result = await APIService.updateMember(user.id, { password: newPassword });
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess('密碼變更成功！');
          document.getElementById('currentPassword').value = '';
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmPassword').value = '';
          setTimeout(() => {
            messageDiv.innerHTML = '';
          }, 3000);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      // ==================== 管理後台 ====================
      async showAdminPanel() {
        if (!AuthService.isAdmin()) {
          this.renderWithHeader(UIUtils.showError('您沒有權限訪問此頁面'));
          return;
        }
        
        this.currentView = 'admin';
        
        const html = `
          <div class="card">
            <h2>⚙️ 管理後台</h2>
            
            <div class="nav-tabs">
              <button class="nav-tab active" onclick="app.showAdminMembers()">會員管理</button>
              <button class="nav-tab" onclick="app.showAdminActivities()">活動管理</button>
              <button class="nav-tab" onclick="app.showAdminFinance()">財務管理</button>
              <button class="nav-tab" onclick="app.showAdminReports()">報表分析</button>
              <button class="nav-tab" onclick="app.showAdminNotifications()">通知管理</button>
              <button class="nav-tab" onclick="app.showAdminBackup()">系統備份</button>
            </div>
            
            <div id="adminContent"></div>
          </div>
        `;
        
        this.renderWithHeader(html);
        this.showAdminMembers();
      }

      // ==================== 會員管理 ====================
      async showAdminMembers(page = 1, status = null) {
        const contentDiv = document.getElementById('adminContent');
        if (!contentDiv) return;
        
        contentDiv.innerHTML = UIUtils.showLoading('載入會員列表...');
        
        const filters = status ? { '狀態': status } : {};
        const result = await APIService.getMembers(page, filters);
        
        if (!result.success) {
          contentDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const html = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <button class="btn ${!status ? 'btn-primary' : 'btn-outline'} btn-sm" onclick="app.showAdminMembers(1, null)">全部</button>
              <button class="btn ${status === '正常' ? 'btn-primary' : 'btn-outline'} btn-sm" onclick="app.showAdminMembers(1, '正常')">正常</button>
              <button class="btn ${status === '待審核' ? 'btn-primary' : 'btn-outline'} btn-sm" onclick="app.showAdminMembers(1, '待審核')">待審核</button>
              <button class="btn ${status === '停權' ? 'btn-primary' : 'btn-outline'} btn-sm" onclick="app.showAdminMembers(1, '停權')">停權</button>
            </div>
            <div class="search-bar" style="margin: 0; width: 300px;">
              <input type="text" id="memberSearch" placeholder="搜尋會員...">
              <button class="btn btn-secondary" onclick="app.searchMembers()">搜尋</button>
            </div>
          </div>
          
          ${result.data.length > 0 ? `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>姓名</th>
                    <th>性別</th>
                    <th>電子郵件</th>
                    <th>手機</th>
                    <th>加入日期</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.data.map(member => `
                    <tr>
                      <td>${member['ID']}</td>
                      <td>${member['姓名']}</td>
                      <td>${member['性別']}</td>
                      <td>${member['電子郵件']}</td>
                      <td>${member['手機號碼']}</td>
                      <td>${UIUtils.formatDate(member['加入日期'])}</td>
                      <td>${UIUtils.getStatusBadge(member['狀態'], 'member')}</td>
                      <td>
                        <button class="btn btn-secondary btn-sm" onclick="app.showMemberDetail('${member['ID']}')">查看</button>
                        ${member['狀態'] === '待審核' ? 
                          `<button class="btn btn-success btn-sm" onclick="app.approveMember('${member['ID']}')">審核</button>` : ''}
                        ${member['狀態'] === '正常' ? 
                          `<button class="btn btn-warning btn-sm" onclick="app.suspendMember('${member['ID']}')">停權</button>` : ''}
                        ${member['狀態'] === '停權' ? 
                          `<button class="btn btn-success btn-sm" onclick="app.activateMember('${member['ID']}')">啟用</button>` : ''}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            ${UIUtils.createPagination(result.pagination.currentPage, result.pagination.totalPages, `app.showAdminMembers`)}
          ` : '<div class="empty-state">沒有找到會員</div>'}
        `;
        
        contentDiv.innerHTML = html;
      }

      async searchMembers() {
        const keyword = document.getElementById('memberSearch').value;
        if (!keyword) {
          this.showAdminMembers();
          return;
        }
        
        const contentDiv = document.getElementById('adminContent');
        contentDiv.innerHTML = UIUtils.showLoading('搜尋中...');
        
        const result = await APIService.globalSearch(keyword);
        
        if (!result.success) {
          contentDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const html = `
          <h3>搜尋結果：${result.totalResults} 筆</h3>
          
          ${result.data.members.length > 0 ? `
            <h4>會員 (${result.data.members.length})</h4>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>姓名</th>
                    <th>電子郵件</th>
                    <th>手機</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.data.members.map(member => `
                    <tr>
                      <td>${member.id}</td>
                      <td>${member.name}</td>
                      <td>${member.email}</td>
                      <td>${member.phone}</td>
                      <td>${UIUtils.getStatusBadge(member.status, 'member')}</td>
                      <td>
                        <button class="btn btn-secondary btn-sm" onclick="app.showMemberDetail('${member.id}')">查看</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : ''}
          
          ${result.data.activities.length > 0 ? `
            <h4 style="margin-top: 30px;">活動 (${result.data.activities.length})</h4>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>活動名稱</th>
                    <th>日期</th>
                    <th>地點</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.data.activities.map(activity => `
                    <tr>
                      <td>${activity.id}</td>
                      <td>${activity.name}</td>
                      <td>${UIUtils.formatDate(activity.date)}</td>
                      <td>${activity.location}</td>
                      <td>${UIUtils.getStatusBadge(activity.status, 'activity')}</td>
                      <td>
                        <button class="btn btn-secondary btn-sm" onclick="app.showActivityDetail('${activity.id}')">查看</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : ''}
          
          <button class="btn btn-secondary" style="margin-top: 20px;" onclick="app.showAdminMembers()">返回列表</button>
        `;
        
        contentDiv.innerHTML = html;
      }

      async showMemberDetail(memberId) {
        const modal = UIUtils.showModal('會員詳情', UIUtils.showLoading('載入中...'));
        
        const result = await APIService.getMemberDetail(memberId);
        
        if (!result.success) {
          modal.querySelector('.modal-body').innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const member = result.data;
        
        const html = `
          <div class="form-row">
            <div>
              <p><strong>ID：</strong>${member['ID']}</p>
              <p><strong>姓名：</strong>${member['姓名']}</p>
              <p><strong>性別：</strong>${member['性別']}</p>
              <p><strong>出生日期：</strong>${UIUtils.formatDate(member['出生日期'])}</p>
            </div>
            <div>
              <p><strong>電子郵件：</strong>${member['電子郵件']}</p>
              <p><strong>手機號碼：</strong>${member['手機號碼']}</p>
              <p><strong>地址：</strong>${member['地址'] || '未填寫'}</p>
              <p><strong>狀態：</strong>${UIUtils.getStatusBadge(member['狀態'], 'member')}</p>
            </div>
          </div>
          
          <div style="margin-top: 20px;">
            <p><strong>緊急聯絡人：</strong>${member['緊急聯絡人'] || '未填寫'}</p>
            <p><strong>緊急聯絡電話：</strong>${member['緊急聯絡電話'] || '未填寫'}</p>
            <p><strong>加入日期：</strong>${UIUtils.formatDateTime(member['加入日期'])}</p>
          </div>
          
          <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">關閉</button>
          </div>
        `;
        
        modal.querySelector('.modal-body').innerHTML = html;
      }

      async approveMember(memberId) {
        UIUtils.confirmDialog('確定要審核通過此會員嗎？', `app.confirmApproveMember('${memberId}')`);
      }

      async confirmApproveMember(memberId) {
        const result = await APIService.updateMember(memberId, { 狀態: '正常' });
        
        if (result.success) {
          alert('審核成功！');
          this.showAdminMembers();
        } else {
          alert('審核失敗：' + result.error);
        }
      }

      async suspendMember(memberId) {
        UIUtils.confirmDialog('確定要停權此會員嗎？', `app.confirmSuspendMember('${memberId}')`);
      }

      async confirmSuspendMember(memberId) {
        const result = await APIService.updateMember(memberId, { 狀態: '停權' });
        
        if (result.success) {
          alert('已停權！');
          this.showAdminMembers();
        } else {
          alert('操作失敗：' + result.error);
        }
      }

      async activateMember(memberId) {
        const result = await APIService.updateMember(memberId, { 狀態: '正常' });
        
        if (result.success) {
          alert('已啟用！');
          this.showAdminMembers();
        } else {
          alert('操作失敗：' + result.error);
        }
      }

      // ==================== 活動管理 ====================
      async showAdminActivities(page = 1, status = null) {
        const contentDiv = document.getElementById('adminContent');
        if (!contentDiv) return;
        
        contentDiv.innerHTML = UIUtils.showLoading('載入活動列表...');
        
        const result = await APIService.getActivities(page, status);
        
        if (!result.success) {
          contentDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const html = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <button class="btn ${!status ? 'btn-primary' : 'btn-outline'} btn-sm" onclick="app.showAdminActivities(1, null)">全部</button>
              <button class="btn ${status === '報名中' ? 'btn-primary' : 'btn-outline'} btn-sm" onclick="app.showAdminActivities(1, '報名中')">報名中</button>
              <button class="btn ${status === '已結束' ? 'btn-primary' : 'btn-outline'} btn-sm" onclick="app.showAdminActivities(1, '已結束')">已結束</button>
            </div>
            <button class="btn btn-success" onclick="app.showCreateActivity()">+ 新增活動</button>
          </div>
          
          ${result.data.length > 0 ? `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>活動名稱</th>
                    <th>日期</th>
                    <th>地點</th>
                    <th>講師</th>
                    <th>報名人數</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.data.map(activity => `
                    <tr>
                      <td>${activity['活動名稱']}</td>
                      <td>${UIUtils.formatDate(activity['日期'])}</td>
                      <td>${activity['地點']}</td>
                      <td>${activity['講師'] || '-'}</td>
                      <td>${activity['目前報名數']}/${activity['報名上限']}</td>
                      <td>${UIUtils.getStatusBadge(activity['狀態'], 'activity')}</td>
                      <td>
                        <button class="btn btn-secondary btn-sm" onclick="app.showAdminActivityDetail('${activity['ID']}')">查看</button>
                        <button class="btn btn-primary btn-sm" onclick="app.showEditActivity('${activity['ID']}')">編輯</button>
                        ${activity['狀態'] !== '已取消' ? 
                          `<button class="btn btn-danger btn-sm" onclick="app.handleCancelActivity('${activity['ID']}')">取消</button>` : ''}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            ${UIUtils.createPagination(result.pagination.currentPage, result.pagination.totalPages, `app.showAdminActivities`)}
          ` : '<div class="empty-state">沒有活動</div>'}
        `;
        
        contentDiv.innerHTML = html;
      }

      showCreateActivity() {
        const content = `
          <div id="activityMessage"></div>
          <form onsubmit="app.handleCreateActivity(event)">
            <div class="form-row">
              <div class="form-group">
                <label>活動名稱 *</label>
                <input type="text" id="activityName" required>
              </div>
              <div class="form-group">
                <label>活動類型</label>
                <select id="activityType">
                  <option value="講座">講座</option>
                  <option value="運動課程">運動課程</option>
                  <option value="社交活動">社交活動</option>
                  <option value="健康檢查">健康檢查</option>
                  <option value="其他">其他</option>
                </select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>日期 *</label>
                <input type="date" id="activityDate" required>
              </div>
              <div class="form-group">
                <label>開始時間 *</label>
                <input type="time" id="activityStartTime" required>
              </div>
              <div class="form-group">
                <label>結束時間 *</label>
                <input type="time" id="activityEndTime" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>地點 *</label>
                <input type="text" id="activityLocation" required>
              </div>
              <div class="form-group">
                <label>講師</label>
                <input type="text" id="activityInstructor">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>報名上限 *</label>
                <input type="number" id="activityMaxParticipants" required min="1" value="30">
              </div>
              <div class="form-group">
                <label>報名截止日 *</label>
                <input type="date" id="activityDeadline" required>
              </div>
            </div>
            
            <div class="form-group">
              <label>活動描述</label>
              <textarea id="activityDescription" rows="3"></textarea>
            </div>
            
            <div class="form-group">
              <label>活動內容</label>
              <textarea id="activityContent" rows="4"></textarea>
            </div>
            
            <div class="form-group">
              <label>注意事項</label>
              <textarea id="activityNotes" rows="3"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">取消</button>
              <button type="submit" class="btn btn-success">建立活動</button>
            </div>
          </form>
        `;
        
        UIUtils.showModal('新增活動', content);
      }

      async handleCreateActivity(event) {
        event.preventDefault();
        
        const user = AuthService.getUser();
        const messageDiv = document.getElementById('activityMessage');
        
        const activityData = {
          name: document.getElementById('activityName').value,
          type: document.getElementById('activityType').value,
          date: document.getElementById('activityDate').value,
          startTime: document.getElementById('activityStartTime').value,
          endTime: document.getElementById('activityEndTime').value,
          location: document.getElementById('activityLocation').value,
          instructor: document.getElementById('activityInstructor').value,
          maxParticipants: document.getElementById('activityMaxParticipants').value,
          registrationDeadline: document.getElementById('activityDeadline').value,
          description: document.getElementById('activityDescription').value,
          content: document.getElementById('activityContent').value,
          notes: document.getElementById('activityNotes').value,
          creatorId: user.id
        };
        
        messageDiv.innerHTML = UIUtils.showLoading('建立中...');
        
        const result = await APIService.createActivity(activityData);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess('活動建立成功！');
          setTimeout(() => {
            document.querySelector('.modal').remove();
            this.showAdminActivities();
          }, 1500);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      async showAdminActivityDetail(activityId) {
        const modal = UIUtils.showModal('活動詳情', UIUtils.showLoading('載入中...'));
        
        const result = await APIService.getActivityDetail(activityId);
        
        if (!result.success) {
          modal.querySelector('.modal-body').innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const activity = result.data;
        
        // 取得報名名單
        const registrations = await APIService.getActivityRegistrations(activityId);
        
        const html = `
          <div class="form-row">
            <div>
              <p><strong>活動名稱：</strong>${activity['活動名稱']}</p>
              <p><strong>類型：</strong>${activity['類型']}</p>
              <p><strong>日期：</strong>${UIUtils.formatDate(activity['日期'])}</p>
              <p><strong>時間：</strong>${activity['開始時間']} - ${activity['結束時間']}</p>
            </div>
            <div>
              <p><strong>地點：</strong>${activity['地點']}</p>
              <p><strong>講師：</strong>${activity['講師'] || '無'}</p>
              <p><strong>報名人數：</strong>${activity['目前報名數']}/${activity['報名上限']}</p>
              <p><strong>狀態：</strong>${UIUtils.getStatusBadge(activity['狀態'], 'activity')}</p>
            </div>
          </div>
          
          ${activity['描述'] ? `<p style="margin-top: 15px;"><strong>描述：</strong>${activity['描述']}</p>` : ''}
          
          <h4 style="margin-top: 20px;">報名名單 (${registrations.success ? registrations.data.length : 0})</h4>
          ${registrations.success && registrations.data.length > 0 ? `
            <div class="table-container" style="max-height: 300px; overflow-y: auto;">
              <table>
                <thead>
                  <tr>
                    <th>姓名</th>
                    <th>電話</th>
                    <th>報名時間</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${registrations.data.map(reg => `
                    <tr>
                      <td>${reg['會員姓名']}</td>
                      <td>${reg['會員電話']}</td>
                      <td>${UIUtils.formatDateTime(reg['報名時間'])}</td>
                      <td>${UIUtils.getStatusBadge(reg['狀態'], 'registration')}</td>
                      <td>
                        ${reg['狀態'] === '已報名' ? 
                          `<button class="btn btn-success btn-sm" onclick="app.handleCheckIn('${reg['ID']}')">簽到</button>` : ''}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : '<p>目前沒有報名記錄</p>'}
          
          <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">關閉</button>
            <button class="btn btn-primary" onclick="app.exportRegistrations('${activityId}')">匯出名單</button>
          </div>
        `;
        
        modal.querySelector('.modal-body').innerHTML = html;
      }

      async handleCheckIn(registrationId) {
        const result = await APIService.checkIn(registrationId);
        
        if (result.success) {
          alert('簽到成功！');
          // 重新載入當前頁面
          const modal = document.querySelector('.modal');
          if (modal) {
            modal.remove();
          }
        } else {
          alert('簽到失敗：' + result.error);
        }
      }

      async handleCancelActivity(activityId) {
        const content = `
          <div id="cancelActivityMessage"></div>
          <p>確定要取消此活動嗎？系統將通知所有已報名的會員。</p>
          <div class="form-group">
            <label>取消原因 *</label>
            <textarea id="cancelActivityReason" required placeholder="請說明取消原因"></textarea>
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">返回</button>
            <button class="btn btn-danger" onclick="app.confirmCancelActivity('${activityId}')">確認取消</button>
          </div>
        `;
        
        UIUtils.showModal('取消活動', content);
      }

      async confirmCancelActivity(activityId) {
        const reason = document.getElementById('cancelActivityReason').value;
        const messageDiv = document.getElementById('cancelActivityMessage');
        
        if (!reason) {
          messageDiv.innerHTML = UIUtils.showError('請填寫取消原因');
          return;
        }
        
        messageDiv.innerHTML = UIUtils.showLoading('處理中...');
        
        const result = await APIService.cancelActivity(activityId, reason);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess(result.message);
          setTimeout(() => {
            document.querySelector('.modal').remove();
            this.showAdminActivities();
          }, 1500);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      // ==================== 財務管理 ====================
      async showAdminFinance(page = 1) {
        const contentDiv = document.getElementById('adminContent');
        if (!contentDiv) return;
        
        contentDiv.innerHTML = UIUtils.showLoading('載入財務記錄...');
        
        const result = await APIService.getFinanceRecords({}, page);
        
        if (!result.success) {
          contentDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        // 取得統計資料
        const stats = await APIService.getFinanceStatistics();
        
        const html = `
          ${stats.success ? `
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 30px;">
              <div class="stat-card" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                <h4>總收入</h4>
                <div class="stat-value">$${stats.data.totalIncome.toLocaleString()}</div>
                <div class="stat-label">${stats.data.incomeCount} 筆</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%);">
                <h4>總支出</h4>
                <div class="stat-value">$${stats.data.totalExpense.toLocaleString()}</div>
                <div class="stat-label">${stats.data.expenseCount} 筆</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
                <h4>總捐款</h4>
                <div class="stat-value">$${stats.data.totalDonation.toLocaleString()}</div>
                <div class="stat-label">${stats.data.donationCount} 筆</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                <h4>餘額</h4>
                <div class="stat-value">$${stats.data.balance.toLocaleString()}</div>
                <div class="stat-label">淨額</div>
              </div>
            </div>
          ` : ''}
          
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>財務記錄</h3>
            <button class="btn btn-success" onclick="app.showAddFinanceRecord()">+ 新增記錄</button>
          </div>
          
          ${result.data.length > 0 ? `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>日期</th>
                    <th>類型</th>
                    <th>類別</th>
                    <th>描述</th>
                    <th>金額</th>
                    <th>付款方式</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.data.map(record => `
                    <tr>
                      <td>${UIUtils.formatDate(record['日期'])}</td>
                      <td>${record['類型']}</td>
                      <td>${record['類別']}</td>
                      <td>${record['描述']}</td>
                      <td style="color: ${record['類型'] === '支出' ? '#f44336' : '#4CAF50'}; font-weight: bold;">
                        ${record['類型'] === '支出' ? '-' : '+'}$${parseFloat(record['金額']).toLocaleString()}
                      </td>
                      <td>${record['付款方式']}</td>
                      <td>
                        <button class="btn btn-danger btn-sm" onclick="app.deleteFinanceRecord('${record['ID']}')">刪除</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            ${UIUtils.createPagination(result.pagination.currentPage, result.pagination.totalPages, `app.showAdminFinance`)}
          ` : '<div class="empty-state">沒有財務記錄</div>'}
        `;
        
        contentDiv.innerHTML = html;
      }

      showAddFinanceRecord() {
        const content = `
          <div id="financeMessage"></div>
          <form onsubmit="app.handleAddFinanceRecord(event)">
            <div class="form-row">
              <div class="form-group">
                <label>類型 *</label>
                <select id="financeType" required>
                  <option value="收入">收入</option>
                  <option value="支出">支出</option>
                  <option value="捐款">捐款</option>
                </select>
              </div>
              <div class="form-group">
                <label>日期 *</label>
                <input type="date" id="financeDate" required value="${new Date().toISOString().split('T')[0]}">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>金額 *</label>
                <input type="number" id="financeAmount" required min="0" step="0.01">
              </div>
              <div class="form-group">
                <label>付款方式</label>
                <select id="financePaymentMethod">
                  <option value="現金">現金</option>
                  <option value="轉帳">轉帳</option>
                  <option value="信用卡">信用卡</option>
                  <option value="支票">支票</option>
                  <option value="其他">其他</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label>類別</label>
              <input type="text" id="financeCategory" placeholder="例如：會費、活動費用、辦公用品等">
            </div>
            
            <div class="form-group">
              <label>描述</label>
              <textarea id="financeDescription" rows="3"></textarea>
            </div>
            
            <div class="form-group">
              <label>收據編號</label>
              <input type="text" id="financeReceiptNumber">
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">取消</button>
              <button type="submit" class="btn btn-success">新增記錄</button>
            </div>
          </form>
        `;
        
        UIUtils.showModal('新增財務記錄', content);
      }

      async handleAddFinanceRecord(event) {
        event.preventDefault();
        
        const user = AuthService.getUser();
        const messageDiv = document.getElementById('financeMessage');
        
        const financeData = {
          type: document.getElementById('financeType').value,
          date: document.getElementById('financeDate').value,
          amount: document.getElementById('financeAmount').value,
          paymentMethod: document.getElementById('financePaymentMethod').value,
          category: document.getElementById('financeCategory').value,
          description: document.getElementById('financeDescription').value,
          receiptNumber: document.getElementById('financeReceiptNumber').value,
          creatorId: user.id
        };
        
        messageDiv.innerHTML = UIUtils.showLoading('新增中...');
        
        const result = await APIService.addFinanceRecord(financeData);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess('記錄新增成功！');
          setTimeout(() => {
            document.querySelector('.modal').remove();
            this.showAdminFinance();
          }, 1500);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      async deleteFinanceRecord(recordId) {
        if (!confirm('確定要刪除此財務記錄嗎？')) return;
        
        const result = await APIService.deleteFinanceRecord(recordId);
        
        if (result.success) {
          alert('刪除成功！');
          this.showAdminFinance();
        } else {
          alert('刪除失敗：' + result.error);
        }
      }

      // ==================== 報表分析 ====================
      async showAdminReports() {
        const contentDiv = document.getElementById('adminContent');
        if (!contentDiv) return;
        
        const html = `
          <h3>報表分析</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
            <div class="card" style="margin: 0;">
              <h4>📊 會員報表</h4>
              <p>分析會員資料、成長趨勢、人口統計等</p>
              <button class="btn btn-primary" onclick="app.generateMemberReport()">生成報表</button>
            </div>
            
            <div class="card" style="margin: 0;">
              <h4>📅 活動報表</h4>
              <p>分析活動參與度、熱門活動、出席率等</p>
              <button class="btn btn-primary" onclick="app.generateActivityReport()">生成報表</button>
            </div>
            
            <div class="card" style="margin: 0;">
              <h4>✅ 出席率報表</h4>
              <p>分析各活動的出席率、缺席情況等</p>
              <button class="btn btn-primary" onclick="app.generateAttendanceReport()">生成報表</button>
            </div>
            
            <div class="card" style="margin: 0;">
              <h4>💰 財務報表</h4>
              <p>分析收支情況、財務趨勢等</p>
              <button class="btn btn-primary" onclick="app.showFinanceReport()">查看報表</button>
            </div>
          </div>
          
          <div id="reportContent" style="margin-top: 30px;"></div>
        `;
        
        contentDiv.innerHTML = html;
      }

      async generateMemberReport() {
        const reportDiv = document.getElementById('reportContent');
        reportDiv.innerHTML = UIUtils.showLoading('生成報表中...');
        
        const result = await APIService.generateMemberReport();
        
        if (!result.success) {
          reportDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const report = result.data;
        
        const html = `
          <div class="card">
            <h3>會員報表</h3>
            <p>統計期間：${report.period.start} 至 ${report.period.end}</p>
            
            <h4>會員概況</h4>
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
              <div class="stat-card">
                <h4>總會員數</h4>
                <div class="stat-value">${report.summary.total}</div>
              </div>
              <div class="stat-card">
                <h4>正常會員</h4>
                <div class="stat-value">${report.summary.active}</div>
              </div>
              <div class="stat-card">
                <h4>待審核</h4>
                <div class="stat-value">${report.summary.pending}</div>
              </div>
              <div class="stat-card">
                <h4>停權</h4>
                <div class="stat-value">${report.summary.inactive}</div>
              </div>
            </div>
            
            <div class="form-row">
              <div>
                <h4>性別分布</h4>
                <ul>
                  ${Object.entries(report.demographics.byGender).map(([gender, count]) => 
                    `<li>${gender}：${count} 人 (${Math.round(count/report.summary.total*100)}%)</li>`
                  ).join('')}
                </ul>
              </div>
              
              <div>
                <h4>年齡分布</h4>
                <ul>
                  ${Object.entries(report.demographics.byAge).map(([age, count]) => 
                    `<li>${age}：${count} 人</li>`
                  ).join('')}
                </ul>
              </div>
              
              <div>
                <h4>地區分布（前5名）</h4>
                <ul>
                  ${Object.entries(report.demographics.byLocation)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([location, count]) => 
                      `<li>${location}：${count} 人</li>`
                    ).join('')}
                </ul>
              </div>
            </div>
          </div>
        `;
        
        reportDiv.innerHTML = html;
      }

      async generateActivityReport() {
        const reportDiv = document.getElementById('reportContent');
        reportDiv.innerHTML = UIUtils.showLoading('生成報表中...');
        
        const result = await APIService.generateActivityReport();
        
        if (!result.success) {
          reportDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const report = result.data;
        
        const html = `
          <div class="card">
            <h3>活動報表</h3>
            <p>統計期間：${report.period.start} 至 ${report.period.end}</p>
            
            <h4>活動概況</h4>
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
              <div class="stat-card">
                <h4>總活動數</h4>
                <div class="stat-value">${report.summary.total}</div>
              </div>
              <div class="stat-card">
                <h4>已完成</h4>
                <div class="stat-value">${report.summary.completed}</div>
              </div>
              <div class="stat-card">
                <h4>總參與人次</h4>
                <div class="stat-value">${report.summary.totalParticipants}</div>
              </div>
              <div class="stat-card">
                <h4>平均出席率</h4>
                <div class="stat-value">${report.summary.attendanceRate}%</div>
              </div>
            </div>
            
            <div class="form-row">
              <div>
                <h4>活動類型分布</h4>
                <ul>
                  ${Object.entries(report.byType).map(([type, data]) => 
                    `<li>${type}：${data.count} 場，${data.participants} 人次</li>`
                  ).join('')}
                </ul>
              </div>
              
              <div>
                <h4>熱門地點（前5名）</h4>
                <ul>
                  ${Object.entries(report.byLocation)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 5)
                    .map(([location, data]) => 
                      `<li>${location}：${data.count} 場</li>`
                    ).join('')}
                </ul>
              </div>
            </div>
            
            <h4>熱門活動排行（前10名）</h4>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>排名</th>
                    <th>活動名稱</th>
                    <th>日期</th>
                    <th>參與人數</th>
                  </tr>
                </thead>
                <tbody>
                  ${report.topActivities.map((activity, index) => `
                    <tr>
                      <td>${index + 1}</td>
                      <td>${activity.name}</td>
                      <td>${UIUtils.formatDate(activity.date)}</td>
                      <td>${activity.participants}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
        
        reportDiv.innerHTML = html;
      }

      // ==================== 通知管理 ====================
      async showAdminNotifications() {
        const contentDiv = document.getElementById('adminContent');
        if (!contentDiv) return;
        
        const html = `
          <h3>通知管理</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
            <div class="card" style="margin: 0;">
              <h4>📧 發送通知</h4>
              <p>發送電子郵件通知給選定的會員</p>
              <button class="btn btn-primary" onclick="app.showSendNotification()">發送通知</button>
            </div>
            
            <div class="card" style="margin: 0;">
              <h4>📢 群發通知</h4>
              <p>發送通知給所有正常會員</p>
              <button class="btn btn-warning" onclick="app.showBroadcastNotification()">群發通知</button>
            </div>
          </div>
        `;
        
        contentDiv.innerHTML = html;
      }

      showSendNotification() {
        const content = `
          <div id="notificationMessage"></div>
          <form onsubmit="app.handleSendNotification(event)">
            <div class="form-group">
              <label>收件者 *</label>
              <p style="font-size: 12px; color: #666;">請輸入會員ID，多個ID請用逗號分隔</p>
              <textarea id="notificationRecipients" required placeholder="例如：MEM001,MEM002,MEM003"></textarea>
            </div>
            
            <div class="form-group">
              <label>標題 *</label>
              <input type="text" id="notificationTitle" required>
            </div>
            
            <div class="form-group">
              <label>內容 *</label>
              <textarea id="notificationContent" required rows="6"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">取消</button>
              <button type="submit" class="btn btn-primary">發送</button>
            </div>
          </form>
        `;
        
        UIUtils.showModal('發送通知', content);
      }

      async handleSendNotification(event) {
        event.preventDefault();
        
        const messageDiv = document.getElementById('notificationMessage');
        const recipientsStr = document.getElementById('notificationRecipients').value;
        const title = document.getElementById('notificationTitle').value;
        const content = document.getElementById('notificationContent').value;
        
        const recipientIds = recipientsStr.split(',').map(id => id.trim());
        
        messageDiv.innerHTML = UIUtils.showLoading('發送中...');
        
        const result = await APIService.sendBulkNotification(recipientIds, title, content, 'email');
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess(result.message);
          setTimeout(() => {
            document.querySelector('.modal').remove();
          }, 2000);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      showBroadcastNotification() {
        const content = `
          <div id="broadcastMessage"></div>
          <p style="color: #ff9800; font-weight: bold;">⚠️ 此操作將發送通知給所有正常會員</p>
          <form onsubmit="app.handleBroadcastNotification(event)">
            <div class="form-group">
              <label>標題 *</label>
              <input type="text" id="broadcastTitle" required>
            </div>
            
            <div class="form-group">
              <label>內容 *</label>
              <textarea id="broadcastContent" required rows="6"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">取消</button>
              <button type="submit" class="btn btn-warning">確認群發</button>
            </div>
          </form>
        `;
        
        UIUtils.showModal('群發通知', content);
      }

      async handleBroadcastNotification(event) {
        event.preventDefault();
        
        const messageDiv = document.getElementById('broadcastMessage');
        const title = document.getElementById('broadcastTitle').value;
        const content = document.getElementById('broadcastContent').value;
        
        if (!confirm('確定要發送通知給所有正常會員嗎？')) return;
        
        messageDiv.innerHTML = UIUtils.showLoading('發送中...');
        
        const result = await APIService.sendBroadcastNotification(title, content, 'email');
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess(result.message);
          setTimeout(() => {
            document.querySelector('.modal').remove();
          }, 2000);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      // ==================== 系統備份 ====================
      async showAdminBackup() {
        const contentDiv = document.getElementById('adminContent');
        if (!contentDiv) return;
        
        contentDiv.innerHTML = UIUtils.showLoading('載入備份資訊...');
        
        const result = await APIService.getBackupList();
        
        const html = `
          <h3>系統備份</h3>
          
          <div class="card" style="margin-top: 20px;">
            <h4>建立新備份</h4>
            <p>備份將包含所有會員、活動、報名及財務資料</p>
            <button class="btn btn-success" onclick="app.createBackup()">立即備份</button>
          </div>
          
          <h4 style="margin-top: 30px;">備份記錄</h4>
          ${result.success && result.data.length > 0 ? `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>備份時間</th>
                    <th>檔案名稱</th>
                    <th>檔案大小</th>
                    <th>建立者</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.data.map(backup => `
                    <tr>
                      <td>${UIUtils.formatDateTime(backup['建立時間'])}</td>
                      <td>${backup['檔案名稱']}</td>
                      <td>${backup['檔案大小']}</td>
                      <td>${backup['建立者']}</td>
                      <td>
                        <button class="btn btn-primary btn-sm" onclick="app.downloadBackup('${backup['ID']}')">下載</button>
                        <button class="btn btn-danger btn-sm" onclick="app.deleteBackup('${backup['ID']}')">刪除</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : '<div class="empty-state">目前沒有備份記錄</div>'}
        `;
        
        contentDiv.innerHTML = html;
      }

      async createBackup() {
        if (!confirm('確定要建立系統備份嗎？')) return;
        
        const contentDiv = document.getElementById('adminContent');
        const originalContent = contentDiv.innerHTML;
        contentDiv.innerHTML = UIUtils.showLoading('建立備份中，請稍候...');
        
        const result = await APIService.createBackup();
        
        if (result.success) {
          alert('備份建立成功！');
          this.showAdminBackup();
        } else {
          alert('備份失敗：' + result.error);
          contentDiv.innerHTML = originalContent;
        }
      }

      async downloadBackup(backupId) {
        const result = await APIService.downloadBackup(backupId);
        
        if (result.success) {
          // 建立下載連結
          const link = document.createElement('a');
          link.href = result.data.downloadUrl;
          link.download = result.data.filename;
          link.click();
        } else {
          alert('下載失敗：' + result.error);
        }
      }

      async deleteBackup(backupId) {
        if (!confirm('確定要刪除此備份嗎？')) return;
        
        const result = await APIService.deleteBackup(backupId);
        
        if (result.success) {
          alert('刪除成功！');
          this.showAdminBackup();
        } else {
          alert('刪除失敗：' + result.error);
        }
      }

      // ==================== 財務報表 ====================
      async showFinanceReport() {
        const reportDiv = document.getElementById('reportContent');
        reportDiv.innerHTML = UIUtils.showLoading('生成報表中...');
        
        const result = await APIService.generateFinanceReport();
        
        if (!result.success) {
          reportDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const report = result.data;
        
        const html = `
          <div class="card">
            <h3>財務報表</h3>
            <p>統計期間：${report.period.start} 至 ${report.period.end}</p>
            
            <h4>財務概況</h4>
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
              <div class="stat-card" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                <h4>總收入</h4>
                <div class="stat-value">$${report.summary.totalIncome.toLocaleString()}</div>
                <div class="stat-label">${report.summary.incomeCount} 筆</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%);">
                <h4>總支出</h4>
                <div class="stat-value">$${report.summary.totalExpense.toLocaleString()}</div>
                <div class="stat-label">${report.summary.expenseCount} 筆</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
                <h4>總捐款</h4>
                <div class="stat-value">$${report.summary.totalDonation.toLocaleString()}</div>
                <div class="stat-label">${report.summary.donationCount} 筆</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                <h4>淨額</h4>
                <div class="stat-value">$${report.summary.netAmount.toLocaleString()}</div>
                <div class="stat-label">${report.summary.netAmount >= 0 ? '盈餘' : '虧損'}</div>
              </div>
            </div>
            
            <div class="form-row">
              <div>
                <h4>收入來源</h4>
                <ul>
                  ${Object.entries(report.incomeByCategory).map(([category, amount]) => 
                    `<li>${category}：$${amount.toLocaleString()}</li>`
                  ).join('')}
                </ul>
              </div>
              
              <div>
                <h4>支出類別</h4>
                <ul>
                  ${Object.entries(report.expenseByCategory).map(([category, amount]) => 
                    `<li>${category}：$${amount.toLocaleString()}</li>`
                  ).join('')}
                </ul>
              </div>
              
              <div>
                <h4>付款方式分布</h4>
                <ul>
                  ${Object.entries(report.byPaymentMethod).map(([method, data]) => 
                    `<li>${method}：${data.count} 筆，$${data.amount.toLocaleString()}</li>`
                  ).join('')}
                </ul>
              </div>
            </div>
            
            <h4>月度趨勢</h4>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>月份</th>
                    <th>收入</th>
                    <th>支出</th>
                    <th>捐款</th>
                    <th>淨額</th>
                  </tr>
                </thead>
                <tbody>
                  ${report.monthlyTrend.map(month => `
                    <tr>
                      <td>${month.month}</td>
                      <td style="color: #4CAF50;">$${month.income.toLocaleString()}</td>
                      <td style="color: #f44336;">$${month.expense.toLocaleString()}</td>
                      <td style="color: #2196F3;">$${month.donation.toLocaleString()}</td>
                      <td style="color: ${month.net >= 0 ? '#4CAF50' : '#f44336'}; font-weight: bold;">
                        $${month.net.toLocaleString()}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
        
        reportDiv.innerHTML = html;
      }

      // ==================== 出席率報表 ====================
      async generateAttendanceReport() {
        const reportDiv = document.getElementById('reportContent');
        reportDiv.innerHTML = UIUtils.showLoading('生成報表中...');
        
        const result = await APIService.generateAttendanceReport();
        
        if (!result.success) {
          reportDiv.innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const report = result.data;
        
        const html = `
          <div class="card">
            <h3>出席率報表</h3>
            <p>統計期間：${report.period.start} 至 ${report.period.end}</p>
            
            <h4>出席概況</h4>
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
              <div class="stat-card">
                <h4>總報名人次</h4>
                <div class="stat-value">${report.summary.totalRegistrations}</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                <h4>已出席</h4>
                <div class="stat-value">${report.summary.attended}</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%);">
                <h4>缺席</h4>
                <div class="stat-value">${report.summary.absent}</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
                <h4>平均出席率</h4>
                <div class="stat-value">${report.summary.averageAttendanceRate}%</div>
              </div>
            </div>
            
            <h4>活動出席率排行</h4>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>排名</th>
                    <th>活動名稱</th>
                    <th>日期</th>
                    <th>報名人數</th>
                    <th>出席人數</th>
                    <th>出席率</th>
                  </tr>
                </thead>
                <tbody>
                  ${report.activityRanking.map((activity, index) => `
                    <tr>
                      <td>${index + 1}</td>
                      <td>${activity.name}</td>
                      <td>${UIUtils.formatDate(activity.date)}</td>
                      <td>${activity.registered}</td>
                      <td>${activity.attended}</td>
                      <td>
                        <span style="color: ${activity.rate >= 80 ? '#4CAF50' : activity.rate >= 60 ? '#FF9800' : '#f44336'}; font-weight: bold;">
                          ${activity.rate}%
                        </span>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <div class="form-row" style="margin-top: 30px;">
              <div>
                <h4>會員出席排行（前10名）</h4>
                <ul>
                  ${report.memberRanking.slice(0, 10).map((member, index) => 
                    `<li>${index + 1}. ${member.name}：${member.attendedCount} 次 (${member.attendanceRate}%)</li>`
                  ).join('')}
                </ul>
              </div>
              
              <div>
                <h4>活動類型出席率</h4>
                <ul>
                  ${Object.entries(report.byActivityType).map(([type, data]) => 
                    `<li>${type}：${data.attendanceRate}% (${data.attended}/${data.total})</li>`
                  ).join('')}
                </ul>
              </div>
            </div>
          </div>
        `;
        
        reportDiv.innerHTML = html;
      }

      // ==================== 編輯活動 ====================
      async showEditActivity(activityId) {
        const modal = UIUtils.showModal('編輯活動', UIUtils.showLoading('載入中...'));
        
        const result = await APIService.getActivityDetail(activityId);
        
        if (!result.success) {
          modal.querySelector('.modal-body').innerHTML = UIUtils.showError(result.error);
          return;
        }
        
        const activity = result.data;
        
        const content = `
          <div id="editActivityMessage"></div>
          <form onsubmit="app.handleEditActivity(event, '${activityId}')">
            <div class="form-row">
              <div class="form-group">
                <label>活動名稱 *</label>
                <input type="text" id="editActivityName" value="${activity['活動名稱']}" required>
              </div>
              <div class="form-group">
                <label>活動類型</label>
                <select id="editActivityType">
                  <option value="講座" ${activity['類型'] === '講座' ? 'selected' : ''}>講座</option>
                  <option value="運動課程" ${activity['類型'] === '運動課程' ? 'selected' : ''}>運動課程</option>
                  <option value="社交活動" ${activity['類型'] === '社交活動' ? 'selected' : ''}>社交活動</option>
                  <option value="健康檢查" ${activity['類型'] === '健康檢查' ? 'selected' : ''}>健康檢查</option>
                  <option value="其他" ${activity['類型'] === '其他' ? 'selected' : ''}>其他</option>
                </select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>日期 *</label>
                <input type="date" id="editActivityDate" value="${activity['日期']}" required>
              </div>
              <div class="form-group">
                <label>開始時間 *</label>
                <input type="time" id="editActivityStartTime" value="${activity['開始時間']}" required>
              </div>
              <div class="form-group">
                <label>結束時間 *</label>
                <input type="time" id="editActivityEndTime" value="${activity['結束時間']}" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>地點 *</label>
                <input type="text" id="editActivityLocation" value="${activity['地點']}" required>
              </div>
              <div class="form-group">
                <label>講師</label>
                <input type="text" id="editActivityInstructor" value="${activity['講師'] || ''}">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>報名上限 *</label>
                <input type="number" id="editActivityMaxParticipants" value="${activity['報名上限']}" required min="1">
              </div>
              <div class="form-group">
                <label>報名截止日 *</label>
                <input type="date" id="editActivityDeadline" value="${activity['報名截止日']}" required>
              </div>
            </div>
            
            <div class="form-group">
              <label>活動描述</label>
              <textarea id="editActivityDescription" rows="3">${activity['描述'] || ''}</textarea>
            </div>
            
            <div class="form-group">
              <label>活動內容</label>
              <textarea id="editActivityContent" rows="4">${activity['內容'] || ''}</textarea>
            </div>
            
            <div class="form-group">
              <label>注意事項</label>
              <textarea id="editActivityNotes" rows="3">${activity['注意事項'] || ''}</textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">取消</button>
              <button type="submit" class="btn btn-primary">儲存變更</button>
            </div>
          </form>
        `;
        
        modal.querySelector('.modal-body').innerHTML = content;
      }

      async handleEditActivity(event, activityId) {
        event.preventDefault();
        
        const messageDiv = document.getElementById('editActivityMessage');
        
        const activityData = {
          name: document.getElementById('editActivityName').value,
          type: document.getElementById('editActivityType').value,
          date: document.getElementById('editActivityDate').value,
          startTime: document.getElementById('editActivityStartTime').value,
          endTime: document.getElementById('editActivityEndTime').value,
          location: document.getElementById('editActivityLocation').value,
          instructor: document.getElementById('editActivityInstructor').value,
          maxParticipants: document.getElementById('editActivityMaxParticipants').value,
          registrationDeadline: document.getElementById('editActivityDeadline').value,
          description: document.getElementById('editActivityDescription').value,
          content: document.getElementById('editActivityContent').value,
          notes: document.getElementById('editActivityNotes').value
        };
        
        messageDiv.innerHTML = UIUtils.showLoading('更新中...');
        
        const result = await APIService.updateActivity(activityId, activityData);
        
        if (result.success) {
          messageDiv.innerHTML = UIUtils.showSuccess('更新成功！');
          setTimeout(() => {
            document.querySelector('.modal').remove();
            this.showAdminActivities();
          }, 1500);
        } else {
          messageDiv.innerHTML = UIUtils.showError(result.error);
        }
      }

      // ==================== 匯出功能 ====================
      async exportRegistrations(activityId) {
        const result = await APIService.exportActivityRegistrations(activityId);
        
        if (result.success) {
          // 建立下載連結
          const link = document.createElement('a');
          link.href = result.data.downloadUrl;
          link.download = result.data.filename;
          link.click();
          alert('匯出成功！');
        } else {
          alert('匯出失敗：' + result.error);
        }
      }

      // ==================== 輔助方法 ====================
      renderWithHeader(content) {
        const user = AuthService.getUser();
        const isAdmin = AuthService.isAdmin();
        
        const html = `
          <div class="header">
            <div class="logo">🏠 銀髮關懷協會</div>
            <nav class="nav">
              <a href="#" onclick="app.showDashboard()" class="${this.currentView === 'dashboard' ? 'active' : ''}">首頁</a>
              <a href="#" onclick="app.showActivities()" class="${this.currentView === 'activities' ? 'active' : ''}">活動列表</a>
              <a href="#" onclick="app.showMyActivities()" class="${this.currentView === 'myActivities' ? 'active' : ''}">我的活動</a>
              ${isAdmin ? `<a href="#" onclick="app.showAdminPanel()" class="${this.currentView === 'admin' ? 'active' : ''}">管理後台</a>` : ''}
              <div class="user-menu">
                <button class="btn btn-secondary" onclick="app.toggleUserMenu()">
                  ${user.name} ▼
                </button>
                <div class="dropdown-menu" id="userMenu" style="display: none;">
                  <a href="#" onclick="app.showProfile()">個人資料</a>
                  <a href="#" onclick="app.showChangePassword()">變更密碼</a>
                  <a href="#" onclick="app.handleLogout()">登出</a>
                </div>
              </div>
            </nav>
          </div>
          
          <div class="container">
            ${content}
          </div>
        `;
        
        document.getElementById('app').innerHTML = html;
      }

      toggleUserMenu() {
        const menu = document.getElementById('userMenu');
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
      }

      handleLogout() {
        if (confirm('確定要登出嗎？')) {
          AuthService.logout();
          this.showLogin();
        }
      }
    }

    // ==================== 初始化應用程式 ====================
    const app = new App();
    app.init();
  </script>
</body>
</html>


