<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友會管理系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #4285f4;
      --secondary-color: #34a853;
      --danger-color: #ea4335;
      --warning-color: #fbbc04;
    }
    
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: #f8f9fa;
      padding-bottom: 70px;
    }
    
    /* Loading */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Skeleton Loading */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 8px;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .skeleton-card {
      height: 120px;
      margin-bottom: 15px;
    }
    
    .skeleton-text {
      height: 20px;
      margin-bottom: 10px;
    }
    
    .skeleton-text.short {
      width: 60%;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 3px solid white;
    }
    
    /* Stats Cards */
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    /* Cards */
    .activity-card, .volunteer-card, .finance-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: all 0.3s;
    }
    
    .activity-card:hover, .volunteer-card:hover, .finance-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Badges */
    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-open { background: #e8f5e9; color: #2e7d32; }
    .status-closed { background: #ffebee; color: #c62828; }
    .status-pending { background: #fff3e0; color: #ef6c00; }
    .status-completed { background: #e3f2fd; color: #1565c0; }
    
    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      z-index: 1000;
    }
    
    .nav-item {
      flex: 1;
      text-align: center;
      padding: 8px;
      color: #666;
      text-decoration: none;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .nav-item.active {
      color: var(--primary-color);
    }
    
    .nav-item i {
      font-size: 24px;
      display: block;
      margin-bottom: 5px;
    }
    
    .nav-item span {
      font-size: 12px;
    }
    
    /* Pages */
    .page-content {
      display: none;
      padding: 20px;
      animation: fadeIn 0.3s;
    }
    
    .page-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Toast */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9998;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    
    .empty-state i {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    /* Buttons */
    .btn-primary {
      background: var(--primary-color);
      border: none;
    }
    
    .btn-success {
      background: var(--secondary-color);
      border: none;
    }
    
    .btn-danger {
      background: var(--danger-color);
      border: none;
    }
    
    /* Pull to Refresh Indicator */
    .pull-refresh-indicator {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 10px 20px;
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
      z-index: 1001;
    }
    
    /* Responsive */
    @media (max-width: 576px) {
      .stat-card {
        padding: 15px;
      }
      
      .page-content {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
  </div>
  
  <!-- Pull to Refresh Indicator -->
  <div class="pull-refresh-indicator" id="pullRefreshIndicator">
    <i class="bi bi-arrow-clockwise"></i> 重新整理中...
  </div>
  
  <!-- Toast Container -->
  <div class="toast-container"></div>
  
  <!-- Header -->
  <div class="header">
    <div class="user-info">
      <img id="userAvatar" class="user-avatar" src="" alt="User">
      <div>
        <h5 class="mb-0" id="userName">載入中...</h5>
        <small id="userMemberType">會員</small>
        <div><small id="userLineId" style="font-size: 10px; opacity: 0.8;"></small></div>
      </div>
    </div>
  </div>
  
  <!-- Page: Home -->
  <div id="page-home" class="page-content active">
    <h4 class="mb-3"><i class="bi bi-house-door"></i> 首頁</h4>
    
    <div class="row g-3 mb-4">
      <div class="col-6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #e3f2fd; color: #1976d2;">
            <i class="bi bi-calendar-event"></i>
          </div>
          <h3 id="statActivities">0</h3>
          <small class="text-muted">開放活動</small>
        </div>
      </div>
      <div class="col-6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #e8f5e9; color: #388e3c;">
            <i class="bi bi-check-circle"></i>
          </div>
          <h3 id="statRegistrations">0</h3>
          <small class="text-muted">我的報名</small>
        </div>
      </div>
      <div class="col-6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #fff3e0; color: #f57c00;">
            <i class="bi bi-clock-history"></i>
          </div>
          <h3 id="statVolunteerHours">0</h3>
          <small class="text-muted">志工時數</small>
        </div>
      </div>
      <div class="col-6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #fce4ec; color: #c2185b;">
            <i class="bi bi-heart"></i>
          </div>
          <h3 id="statDonations">$0</h3>
          <small class="text-muted">捐款金額</small>
        </div>
      </div>
    </div>
    
    <h5 class="mb-3">最新活動</h5>
    <div id="recentActivitiesList">
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
    </div>
  </div>
  
  <!-- Page: Activities -->
  <div id="page-activities" class="page-content">
    <h4 class="mb-3"><i class="bi bi-calendar-event"></i> 活動報名</h4>
    
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#openActivities">開放報名</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#myRegistrations">我的報名</a>
      </li>
    </ul>
    
    <div class="tab-content">
      <div class="tab-pane fade show active" id="openActivities">
        <div id="activitiesList">
          <div class="skeleton skeleton-card"></div>
          <div class="skeleton skeleton-card"></div>
        </div>
      </div>
      <div class="tab-pane fade" id="myRegistrations">
        <div id="myRegistrationsList">
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>尚無報名記錄</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Page: Volunteer -->
  <div id="page-volunteer" class="page-content">
    <h4 class="mb-3"><i class="bi bi-people"></i> 志工服務</h4>
    
    <div class="row g-3 mb-4">
      <div class="col-6">
        <div class="stat-card text-center">
          <h3 id="volTotalHours">0</h3>
          <small class="text-muted">總服務時數</small>
        </div>
      </div>
      <div class="col-6">
        <div class="stat-card text-center">
          <h3 id="volTotalActivities">0</h3>
          <small class="text-muted">服務次數</small>
        </div>
      </div>
    </div>
    
    <h5 class="mb-3">志工需求</h5>
    <div id="volunteerNeedsList">
      <div class="skeleton skeleton-card"></div>
    </div>
    
    <h5 class="mb-3 mt-4">我的志工記錄</h5>
    <div id="myVolunteerRecordsList">
      <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <p>尚無志工記錄</p>
      </div>
    </div>
  </div>
  
  <!-- Page: Finance -->
  <div id="page-finance" class="page-content">
    <h4 class="mb-3"><i class="bi bi-wallet2"></i> 財務管理</h4>
    
    <div class="row g-3 mb-4">
      <div class="col-6">
        <div class="stat-card text-center">
          <h3 id="finTotalDonation">$0</h3>
          <small class="text-muted">我的捐款</small>
        </div>
      </div>
      <div class="col-6">
        <div class="stat-card text-center">
          <h3 id="finPendingExpenses">0</h3>
          <small class="text-muted">待審核支出</small>
        </div>
      </div>
    </div>
    
    <div class="d-flex gap-2 mb-3">
      <button class="btn btn-primary flex-fill" onclick="showDonationModal()">
        <i class="bi bi-heart"></i> 我要捐款
      </button>
      <button class="btn btn-secondary flex-fill" onclick="showExpenseModal()">
        <i class="bi bi-receipt"></i> 申請支出
      </button>
    </div>
    
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#myDonations">我的捐款</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#myExpenses">我的支出</a>
      </li>
    </ul>
    
    <div class="tab-content">
      <div class="tab-pane fade show active" id="myDonations">
        <div id="myDonationsList">
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>尚無捐款記錄</p>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="myExpenses">
        <div id="myExpensesList">
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>尚無支出記錄</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Page: Profile -->
  <div id="page-profile" class="page-content">
    <h4 class="mb-3"><i class="bi bi-person-circle"></i> 個人資料</h4>
    
    <div class="card mb-3">
      <div class="card-body">
        <form id="profileForm">
          <div class="mb-3">
            <label class="form-label">真實姓名</label>
            <input type="text" class="form-control" name="realName" required>
          </div>
          <div class="mb-3">
            <label class="form-label">會員類型</label>
            <select class="form-select" name="memberType" required>
              <option value="病友">病友</option>
              <option value="家屬">家屬</option>
              <option value="志工">志工</option>
              <option value="一般會員">一般會員</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">聯絡電話</label>
            <input type="tel" class="form-control" name="phone">
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="email">
          </div>
          <div class="mb-3">
            <label class="form-label">生日</label>
            <input type="date" class="form-control" name="birthday">
          </div>
          <div class="mb-3">
            <label class="form-label">確診日期（病友填寫）</label>
            <input type="date" class="form-control" name="diagnosisDate">
          </div>
          <div class="mb-3">
            <label class="form-label">地址</label>
            <textarea class="form-control" name="address" rows="2"></textarea>
          </div>
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-save"></i> 儲存資料
          </button>
        </form>
      </div>
    </div>
    
    <h5 class="mb-3">我的收據</h5>
    <div id="myReceiptsList">
      <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <p>尚無收據記錄</p>
      </div>
    </div>
  </div>
  
  <!-- Page: Admin (只有管理員可見) -->
  <div id="page-admin" class="page-content">
    <h4 class="mb-3"><i class="bi bi-gear"></i> 系統管理</h4>
    
    <div class="row g-2 mb-4">
      <div class="col-6">
        <button class="btn btn-outline-primary w-100" onclick="showCreateActivityModal()">
          <i class="bi bi-plus-circle"></i><br>新增活動
        </button>
      </div>
      <div class="col-6">
        <button class="btn btn-outline-success w-100" onclick="showCreateVolunteerNeedModal()">
          <i class="bi bi-people"></i><br>新增志工需求
        </button>
      </div>
      <div class="col-6">
        <button class="btn btn-outline-info w-100" onclick="exportMembers()">
          <i class="bi bi-download"></i><br>匯出會員
        </button>
      </div>
      <div class="col-6">
        <button class="btn btn-outline-warning w-100" onclick="backupSystem()">
          <i class="bi bi-cloud-upload"></i><br>系統備份
        </button>
      </div>
    </div>
    
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#adminMembers">會員管理</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#adminActivities">活動管理</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#adminFinance">財務管理</a>
      </li>
    </ul>
    
    <div class="tab-content">
      <div class="tab-pane fade show active" id="adminMembers">
        <div id="membersList">
          <div class="skeleton skeleton-card"></div>
        </div>
      </div>
      <div class="tab-pane fade" id="adminActivities">
        <div id="adminActivitiesList">
          <div class="skeleton skeleton-card"></div>
        </div>
      </div>
      <div class="tab-pane fade" id="adminFinance">
        <div id="transactionsList">
          <div class="skeleton skeleton-card"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="switchPage('home', event)">
      <i class="bi bi-house-door"></i>
      <span>首頁</span>
    </div>
    <div class="nav-item" onclick="switchPage('activities', event)">
      <i class="bi bi-calendar-event"></i>
      <span>活動</span>
    </div>
    <div class="nav-item" onclick="switchPage('volunteer', event)">
      <i class="bi bi-people"></i>
      <span>志工</span>
    </div>
    <div class="nav-item" onclick="switchPage('finance', event)">
      <i class="bi bi-wallet2"></i>
      <span>財務</span>
    </div>
    <div class="nav-item" onclick="switchPage('profile', event)">
      <i class="bi bi-person-circle"></i>
      <span>我的</span>
    </div>
    <div class="nav-item" id="adminNavItem" style="display: none;" onclick="switchPage('admin', event)">
      <i class="bi bi-gear"></i>
      <span>管理</span>
    </div>
  </div>
  
  <!-- Modals -->
  <!-- Donation Modal -->
  <div class="modal fade" id="donationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增捐款</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="donationForm">
            <div class="mb-3">
              <label class="form-label">捐款人姓名</label>
              <input type="text" class="form-control" name="donorName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">金額</label>
              <input type="number" class="form-control" name="amount" required min="1">
            </div>
            <div class="mb-3">
              <label class="form-label">捐款方式</label>
              <select class="form-select" name="method">
                <option value="現金">現金</option>
                <option value="轉帳">轉帳</option>
                <option value="信用卡">信用卡</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">用途</label>
              <input type="text" class="form-control" name="purpose" value="一般捐款">
            </div>
            <div class="mb-3">
              <label class="form-label">日期</label>
              <input type="date" class="form-control" name="date" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">提交</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Expense Modal -->
  <div class="modal fade" id="expenseModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">申請支出</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="expenseForm">
            <div class="mb-3">
              <label class="form-label">類別</label>
              <select class="form-select" name="category" required>
                <option value="活動支出">活動支出</option>
                <option value="行政支出">行政支出</option>
                <option value="設備支出">設備支出</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">金額</label>
              <input type="number" class="form-control" name="amount" required min="1">
            </div>
            <div class="mb-3">
              <label class="form-label">說明</label>
              <textarea class="form-control" name="description" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">日期</label>
              <input type="date" class="form-control" name="date" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">提交申請</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Create Activity Modal (Admin) -->
  <div class="modal fade" id="createActivityModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增活動</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="createActivityForm">
            <div class="mb-3">
              <label class="form-label">活動標題</label>
              <input type="text" class="form-control" name="title" required>
            </div>
            <div class="mb-3">
              <label class="form-label">活動說明</label>
              <textarea class="form-control" name="description" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">活動日期</label>
              <input type="datetime-local" class="form-control" name="date" required>
            </div>
            <div class="mb-3">
              <label class="form-label">地點</label>
              <input type="text" class="form-control" name="location">
            </div>
            <div class="mb-3">
              <label class="form-label">人數上限</label>
              <input type="number" class="form-control" name="maxParticipants" min="0">
            </div>
            <div class="mb-3">
              <label class="form-label">費用</label>
              <input type="number" class="form-control" name="fee" min="0" value="0">
            </div>
            <div class="mb-3">
              <label class="form-label">主辦人</label>
              <input type="text" class="form-control" name="organizer">
            </div>
            <button type="submit" class="btn btn-primary w-100">建立活動</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Create Volunteer Need Modal (Admin) -->
  <div class="modal fade" id="createVolunteerNeedModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增志工需求</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="createVolunteerNeedForm">
            <div class="mb-3">
              <label class="form-label">活動標題</label>
              <input type="text" class="form-control" name="activityTitle" required>
            </div>
            <div class="mb-3">
              <label class="form-label">志工角色</label>
              <input type="text" class="form-control" name="role" required placeholder="例：活動協助、場地布置">
            </div>
            <div class="mb-3">
              <label class="form-label">需求人數</label>
              <input type="number" class="form-control" name="requiredCount" min="1" required>
            </div>
            <div class="mb-3">
              <label class="form-label">服務日期</label>
              <input type="date" class="form-control" name="date" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">建立需求</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ==================== 全域配置 ====================
    const CONFIG = {
      LIFF_ID: '1656516134-VaGgmaPm',
      GAS_URL: 'https://script.google.com/macros/s/AKfycbyEnQavM8ABaGK9NueVdnY2iZMZkfCDe5h1QnpsQCY-kq46tSt_fz9NCpTqQyFveC0x/exec',
      API_KEY: 'AAbb8520258185202581',
      CACHE_DURATION: 5 * 60 * 1000, // 5分鐘快取
    };

    let userProfile = null;
    let isAdmin = false;
    let cachedData = {
      dashboard: { data: null, timestamp: 0 },
      activities: { data: null, timestamp: 0 },
      myRegistrations: { data: null, timestamp: 0 },
      volunteer: { data: null, timestamp: 0 },
      finance: { data: null, timestamp: 0 },
      profile: { data: null, timestamp: 0 },
      receipts: { data: null, timestamp: 0 },
      admin: { data: null, timestamp: 0 }
    };
    let loadingPromises = {};

    // ==================== 快取管理 ====================
    function isCacheValid(cacheKey) {
      const cache = cachedData[cacheKey];
      if (!cache || !cache.data) return false;
      return (Date.now() - cache.timestamp) < CONFIG.CACHE_DURATION;
    }

    function setCache(cacheKey, data) {
      cachedData[cacheKey] = {
        data: data,
        timestamp: Date.now()
      };
    }

    function getCache(cacheKey) {
      return cachedData[cacheKey]?.data || null;
    }

    function clearCache(cacheKey = null) {
      if (cacheKey) {
        cachedData[cacheKey] = { data: null, timestamp: 0 };
      } else {
        Object.keys(cachedData).forEach(key => {
          cachedData[key] = { data: null, timestamp: 0 };
        });
      }
    }

    // ==================== API 呼叫（含快取） ====================
    async function callAPI(action, data = {}, useCache = false, cacheKey = null) {
      if (useCache && cacheKey && isCacheValid(cacheKey)) {
        console.log(`✅ 使用快取: ${cacheKey}`);
        return { success: true, data: getCache(cacheKey) };
      }

      const requestKey = action + JSON.stringify(data);
      if (loadingPromises[requestKey]) {
        console.log(`⏳ 等待現有請求: ${action}`);
        return loadingPromises[requestKey];
      }

      try {
        const payload = {
          apiKey: CONFIG.API_KEY,
          action: action,
          lineId: userProfile?.userId || '',
          ...data
        };
        
        const promise = fetch(CONFIG.GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(payload)
        }).then(response => response.json()).then(result => {
          if (!result.success) {
            throw new Error(result.message || '操作失敗');
          }
          
          if (useCache && cacheKey) {
            setCache(cacheKey, result.data);
          }
          
          return result;
        });

        loadingPromises[requestKey] = promise;
        const result = await promise;
        delete loadingPromises[requestKey];
        
        return result;
      } catch (error) {
        delete loadingPromises[requestKey];
        throw error;
      }
    }

    // ==================== 批次載入初始資料 ====================
    async function loadInitialData() {
      showLoading(true);
      try {
        console.log('📦 批次載入初始資料...');
        const actions = ['dashboard', 'activities'];
        if (isAdmin) actions.push('admin');
        
        const response = await callAPI('getBatchData', { actions });
        
        if (response.data.dashboard) {
          setCache('dashboard', response.data.dashboard);
          renderDashboard(response.data.dashboard);
        }
        
        if (response.data.activities) {
          setCache('activities', response.data.activities);
          const openActivities = response.data.activities.filter(a => a.status === '開放報名');
          renderActivitiesList(openActivities);
        }
        
        if (response.data.myRegistrations) {
          setCache('myRegistrations', response.data.myRegistrations);
          renderMyRegistrations(response.data.myRegistrations);
        }
        
        if (response.data.admin && isAdmin) {
          setCache('admin', response.data.admin);
          renderAdminData(response.data.admin);
        }
        
        console.log('✅ 初始資料載入完成');
      } catch (error) {
        console.error('❌ 初始資料載入失敗:', error);
        showNotification('載入資料失敗：' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // ==================== 懶加載頁面資料 ====================
    async function loadPageData(pageName, forceRefresh = false) {
      if (forceRefresh) {
        clearCache(pageName);
      }
      
      if (!forceRefresh && isCacheValid(pageName)) {
        console.log(`✅ 使用快取顯示: ${pageName}`);
        renderPageFromCache(pageName);
        return;
      }
      
      console.log(`🔄 載入頁面資料: ${pageName}`);
      
      try {
        switch(pageName) {
          case 'home':
            await loadHomeData(forceRefresh);
            break;
          case 'activities':
            await loadActivities(forceRefresh);
            break;
          case 'volunteer':
            await loadVolunteerData(forceRefresh);
            break;
          case 'finance':
            await loadFinanceData(forceRefresh);
            break;
          case 'profile':
            await loadProfileData(forceRefresh);
            break;
          case 'admin':
            if (isAdmin) await loadAdminData(forceRefresh);
            break;
        }
      } catch (error) {
        console.error(`❌ 載入 ${pageName} 失敗:`, error);
        showNotification('載入失敗：' + error.message, 'error');
      }
    }

    function renderPageFromCache(pageName) {
      const data = getCache(pageName);
      if (!data) return;
      
      switch(pageName) {
        case 'home':
          renderDashboard(data);
          break;
        case 'activities':
          const openActivities = data.filter(a => a.status === '開放報名');
          renderActivitiesList(openActivities);
          break;
        case 'volunteer':
          renderVolunteerData(data);
          break;
        case 'finance':
          renderFinanceData(data);
          break;
        case 'profile':
          renderProfileData(data);
          break;
        case 'admin':
          renderAdminData(data);
          break;
      }
    }

    // ==================== 各頁面載入函數 ====================
    async function loadHomeData(forceRefresh = false) {
      try {
        const response = await callAPI('getDashboardData', {}, !forceRefresh, 'dashboard');
        renderDashboard(response.data);
      } catch (error) {
        console.error('載入首頁失敗:', error);
      }
    }

    function renderDashboard(data) {
      document.getElementById('statActivities').textContent = data.totalActivities || 0;
      document.getElementById('statRegistrations').textContent = data.myRegistrations || 0;
      document.getElementById('statVolunteerHours').textContent = data.myVolunteerHours || 0;
      document.getElementById('statDonations').textContent = '$' + formatCurrency(data.myDonationAmount || 0);
      renderRecentActivities(data.recentActivity || []);
    }

    function renderRecentActivities(activities) {
      const container = document.getElementById('recentActivitiesList');
      if (activities.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有活動</p></div>';
        return;
      }
      
      container.innerHTML = activities.map(act => `
        <div class="activity-card">
          <h6>${act.title}</h6>
          <p class="text-muted small mb-2">${act.description || ''}</p>
          <div class="d-flex justify-content-between align-items-center">
            <small><i class="bi bi-calendar"></i> ${formatDate(act.date)}</small>
            <span class="status-badge ${act.status === '開放報名' ? 'status-open' : 'status-closed'}">${act.status}</span>
          </div>
        </div>
      `).join('');
    }

    async function loadActivities(forceRefresh = false) {
      try {
        const response = await callAPI('getActivities', {}, !forceRefresh, 'activities');
        const activities = response.data || [];
        const openActivities = activities.filter(a => a.status === '開放報名');
        renderActivitiesList(openActivities);

        const regResponse = await callAPI('getMyRegistrations', {}, !forceRefresh, 'myRegistrations');
        renderMyRegistrations(regResponse.data || []);
      } catch (error) {
        console.error('載入活動失敗:', error);
      }
    }

    function renderActivitiesList(activities) {
      const container = document.getElementById('activitiesList');
      if (activities.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有開放報名的活動</p></div>';
        return;
      }
      
      container.innerHTML = activities.map(act => `
        <div class="activity-card">
          <h6>${act.title}</h6>
          <p class="text-muted small">${act.description || ''}</p>
          <div class="mb-2">
            <small><i class="bi bi-calendar"></i> ${formatDate(act.date)}</small><br>
            <small><i class="bi bi-geo-alt"></i> ${act.location || '待定'}</small><br>
            <small><i class="bi bi-people"></i> ${act.currentParticipants}/${act.maxParticipants || '不限'} 人</small>
          </div>
          <button class="btn btn-primary btn-sm w-100" onclick="registerActivity('${act.id}')">
            <i class="bi bi-check-circle"></i> 立即報名
          </button>
        </div>
      `).join('');
    }

    function renderMyRegistrations(registrations) {
      const container = document.getElementById('myRegistrationsList');
      if (registrations.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>尚無報名記錄</p></div>';
        return;
      }
      
      container.innerHTML = registrations.map(reg => `
        <div class="activity-card">
          <h6>${reg.activityTitle}</h6>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <small><i class="bi bi-calendar"></i> ${formatDate(reg.registeredAt)}</small>
            <span class="status-badge ${reg.status === '已報名' ? 'status-open' : reg.status === '已取消' ? 'status-closed' : 'status-completed'}">${reg.status}</span>
          </div>
          ${reg.status === '已報名' ? `
            <button class="btn btn-danger btn-sm w-100" onclick="cancelRegistration('${reg.id}')">
              <i class="bi bi-x-circle"></i> 取消報名
            </button>
          ` : ''}
        </div>
      `).join('');
    }

    async function loadVolunteerData(forceRefresh = false) {
      try {
        const response = await callAPI('getVolunteerData', {}, !forceRefresh, 'volunteer');
        renderVolunteerData(response.data);
      } catch (error) {
        console.error('載入志工資料失敗:', error);
      }
    }

    function renderVolunteerData(data) {
      document.getElementById('volTotalHours').textContent = data.stats?.totalHours || 0;
      document.getElementById('volTotalActivities').textContent = data.stats?.totalActivities || 0;
      renderVolunteerNeeds(data.needs || []);
      renderMyVolunteerRecords(data.records || []);
    }

    function renderVolunteerNeeds(needs) {
      const container = document.getElementById('volunteerNeedsList');
      if (needs.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>目前沒有志工需求</p></div>';
        return;
      }
      
      container.innerHTML = needs.map(need => `
        <div class="volunteer-card">
          <h6>${need.activityTitle}</h6>
          <p class="text-muted small mb-2">角色：${need.role}</p>
          <div class="mb-2">
            <small><i class="bi bi-calendar"></i> ${formatDate(need.date)}</small><br>
            <small><i class="bi bi-people"></i> ${need.currentCount}/${need.requiredCount} 人</small>
          </div>
          <button class="btn btn-success btn-sm w-100" onclick="applyVolunteer('${need.id}')">
            <i class="bi bi-hand-thumbs-up"></i> 我要報名
          </button>
        </div>
      `).join('');
    }

    function renderMyVolunteerRecords(records) {
      const container = document.getElementById('myVolunteerRecordsList');
      if (records.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>尚無志工記錄</p></div>';
        return;
      }
      
      container.innerHTML = records.map(rec => `
        <div class="volunteer-card">
          <h6>${rec.activityTitle}</h6>
          <p class="text-muted small mb-2">角色：${rec.role}</p>
          <div class="d-flex justify-content-between align-items-center">
            <small><i class="bi bi-clock"></i> ${rec.hours} 小時</small>
            <span class="status-badge ${rec.status === '已完成' ? 'status-completed' : rec.status === '已報名' ? 'status-open' : 'status-pending'}">${rec.status}</span>
          </div>
        </div>
      `).join('');
    }

    async function loadFinanceData(forceRefresh = false) {
      try {
        const response = await callAPI('getFinanceData', {}, !forceRefresh, 'finance');
        renderFinanceData(response.data);
      } catch (error) {
        console.error('載入財務資料失敗:', error);
      }
    }

    function renderFinanceData(data) {
      document.getElementById('finTotalDonation').textContent = '$' + formatCurrency(data.stats?.totalDonation || 0);
      document.getElementById('finPendingExpenses').textContent = data.stats?.pendingExpenses || 0;
      renderMyDonations(data.donations || []);
      renderMyExpenses(data.expenses || []);
    }

    function renderMyDonations(donations) {
      const container = document.getElementById('myDonationsList');
      if (donations.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>尚無捐款記錄</p></div>';
        return;
      }
      
      container.innerHTML = donations.map(don => `
        <div class="finance-card">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="mb-1">${don.purpose}</h6>
              <small class="text-muted">${don.method}</small>
            </div>
            <h5 class="text-success mb-0">$${formatCurrency(don.amount)}</h5>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <small><i class="bi bi-calendar"></i> ${formatDate(don.date)}</small>
            <span class="status-badge ${don.status === '已確認' ? 'status-completed' : 'status-pending'}">${don.status}</span>
          </div>
        </div>
      `).join('');
    }

    function renderMyExpenses(expenses) {
      const container = document.getElementById('myExpensesList');
      if (expenses.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>尚無支出記錄</p></div>';
        return;
      }
      
      container.innerHTML = expenses.map(exp => `
        <div class="finance-card">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="mb-1">${exp.category}</h6>
              <small class="text-muted">${exp.description}</small>
            </div>
            <h5 class="text-danger mb-0">$${formatCurrency(exp.amount)}</h5>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <small><i class="bi bi-calendar"></i> ${formatDate(exp.date)}</small>
            <span class="status-badge ${exp.status === '已核准' ? 'status-completed' : exp.status === '已拒絕' ? 'status-closed' : 'status-pending'}">${exp.status}</span>
          </div>
        </div>
      `).join('');
    }

    async function loadProfileData(forceRefresh = false) {
      try {
        const response = await callAPI('getUserInfo', {}, !forceRefresh, 'profile');
        const profile = response.data;
        renderProfileData(profile);
        
        const receiptResponse = await callAPI('getMyReceipts', {}, !forceRefresh, 'receipts');
        renderMyReceipts(receiptResponse.data || []);
      } catch (error) {
        console.error('載入個人資料失敗:', error);
      }
    }

    function renderProfileData(profile) {
      const form = document.getElementById('profileForm');
      if (form && profile) {
        form.elements.realName.value = profile.realName || '';
        form.elements.memberType.value = profile.memberType || '';
        form.elements.phone.value = profile.phone || '';
        form.elements.email.value = profile.email || '';
        form.elements.birthday.value = formatDateInput(profile.birthday);
        form.elements.diagnosisDate.value = formatDateInput(profile.diagnosisDate);
        form.elements.address.value = profile.address || '';
      }
      document.getElementById('userMemberType').textContent = profile.memberType || '-';
    }

    function renderMyReceipts(receipts) {
      const container = document.getElementById('myReceiptsList');
      if (receipts.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>尚無收據記錄</p></div>';
        return;
      }
      
      container.innerHTML = receipts.map(rec => `
        <div class="finance-card">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="mb-1">收據 ${rec.receiptNumber}</h6>
              <small class="text-muted">${rec.purpose}</small>
            </div>
            <h6 class="mb-0">$${formatCurrency(rec.amount)}</h6>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <small><i class="bi bi-calendar"></i> ${formatDate(rec.date)}</small>
            ${rec.pdfUrl ? `<a href="${rec.pdfUrl}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> 下載</a>` : ''}
          </div>
        </div>
      `).join('');
    }

    async function loadAdminData(forceRefresh = false) {
      if (!isAdmin) return;
      try {
        const response = await callAPI('getAdminData', {}, !forceRefresh, 'admin');
        renderAdminData(response.data);
      } catch (error) {
        console.error('載入管理資料失敗:', error);
      }
    }

    function renderAdminData(data) {
      renderMemberList(data.members || []);
      renderAdminActivityList(data.activities || []);
      renderTransactionList(data.transactions || []);
    }

    function renderMemberList(members) {
      const container = document.getElementById('membersList');
      if (members.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>無會員資料</p></div>';
        return;
      }
      
      container.innerHTML = `
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>姓名</th>
                <th>類型</th>
                <th>電話</th>
                <th>Email</th>
              </tr>
            </thead>
            <tbody>
              ${members.map(m => `
                <tr>
                  <td>${m.realName || m.displayName}</td>
                  <td><span class="badge bg-secondary">${m.memberType}</span></td>
                  <td>${m.phone || '-'}</td>
                  <td>${m.email || '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderAdminActivityList(activities) {
      const container = document.getElementById('adminActivitiesList');
      if (activities.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>無活動資料</p></div>';
        return;
      }
      
      container.innerHTML = activities.map(act => `
        <div class="activity-card">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="mb-1">${act.title}</h6>
              <small class="text-muted"><i class="bi bi-calendar"></i> ${formatDate(act.date)}</small>
            </div>
            <span class="status-badge ${act.status === '開放報名' ? 'status-open' : 'status-closed'}">${act.status}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <small><i class="bi bi-people"></i> ${act.currentParticipants}/${act.maxParticipants || '不限'}</small>
            <button class="btn btn-sm btn-outline-primary" onclick="editActivity('${act.id}')">編輯</button>
          </div>
        </div>
      `).join('');
    }

    function renderTransactionList(transactions) {
      const container = document.getElementById('transactionsList');
      if (transactions.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>無交易記錄</p></div>';
        return;
      }
      
      container.innerHTML = `
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>類型</th>
                <th>項目</th>
                <th>金額</th>
                <th>日期</th>
                <th>狀態</th>
              </tr>
            </thead>
            <tbody>
              ${transactions.slice(0, 20).map(t => `
                <tr>
                  <td><span class="badge ${t.type === '收入' ? 'bg-success' : 'bg-danger'}">${t.type}</span></td>
                  <td>${t.category}</td>
                  <td class="${t.type === '收入' ? 'text-success' : 'text-danger'}">$${formatCurrency(t.amount)}</td>
                  <td>${formatDate(t.date)}</td>
                  <td><span class="status-badge status-${t.status === '已確認' || t.status === '已核准' ? 'completed' : 'pending'}">${t.status}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // ==================== 頁面切換 ====================
    function switchPage(pageName, event) {
      document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      document.getElementById(`page-${pageName}`).classList.add('active');
      if (event && event.currentTarget) event.currentTarget.classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      loadPageData(pageName);
    }

    // ==================== 操作函數 ====================
    async function registerActivity(activityId) {
      if (!confirm('確定要報名此活動嗎？')) return;
      try {
        showLoading(true);
        await callAPI('registerActivity', { activityId });
        showNotification('報名成功！', 'success');
        
        clearCache('activities');
        clearCache('myRegistrations');
        clearCache('dashboard');
        await Promise.all([
          loadActivities(true),
          loadHomeData(true)
        ]);
      } catch (error) {
        showNotification('報名失敗：' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function cancelRegistration(registrationId) {
      if (!confirm('確定要取消報名嗎？')) return;
      try {
        showLoading(true);
        await callAPI('cancelRegistration', { registrationId });
        showNotification('已取消報名', 'success');
        
        clearCache('activities');
        clearCache('myRegistrations');
        clearCache('dashboard');
        await Promise.all([
          loadActivities(true),
          loadHomeData(true)
        ]);
      } catch (error) {
        showNotification('取消失敗：' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function applyVolunteer(needId) {
      if (!confirm('確定要報名此志工服務嗎？')) return;
      try {
        showLoading(true);
        await callAPI('applyVolunteer', { needId });
        showNotification('報名成功！', 'success');
        
        clearCache('volunteer');
        clearCache('dashboard');
        await Promise.all([
          loadVolunteerData(true),
          loadHomeData(true)
        ]);
      } catch (error) {
        showNotification('報名失敗：' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // ==================== Modal Functions ====================
    function showDonationModal() {
      const modal = new bootstrap.Modal(document.getElementById('donationModal'));
      document.getElementById('donationForm').reset();
      document.getElementById('donationForm').elements.date.valueAsDate = new Date();
      modal.show();
    }

    function showExpenseModal() {
      const modal = new bootstrap.Modal(document.getElementById('expenseModal'));
      document.getElementById('expenseForm').reset();
      document.getElementById('expenseForm').elements.date.valueAsDate = new Date();
      modal.show();
    }

    function showCreateActivityModal() {
      const modal = new bootstrap.Modal(document.getElementById('createActivityModal'));
      document.getElementById('createActivityForm').reset();
      modal.show();
    }

    function showCreateVolunteerNeedModal() {
      const modal = new bootstrap.Modal(document.getElementById('createVolunteerNeedModal'));
      document.getElementById('createVolunteerNeedForm').reset();
      modal.show();
    }

    // ==================== Form Handlers ====================
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      
      try {
        showLoading(true);
        await callAPI('updateProfile', data);
        showNotification('資料更新成功！', 'success');
        clearCache('profile');
        await loadProfileData(true);
      } catch (error) {
        showNotification('更新失敗：' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    });

    document.getElementById('donationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      
      try {
        showLoading(true);
        await callAPI('createDonation', data);
        showNotification('捐款記錄已建立！', 'success');
        bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
        
        clearCache('finance');
        clearCache('dashboard');
        await Promise.all([
          loadFinanceData(true),
          loadHomeData(true)
        ]);
      } catch (error) {
        showNotification('提交失敗：' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    });

    document.getElementById('expenseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      
      try {
        showLoading(true);
        await callAPI('createExpense', data);
        showNotification('支出申請已提交！', 'success');
        bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
        
        clearCache('finance');
        await loadFinanceData(true);
      } catch (error) {
        showNotification('提交失敗：' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    });

    document.getElementById('createActivityForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      
      try {
        showLoading(true);
        await callAPI('createActivity', data);
        showNotification('活動建立成功！', 'success');
        bootstrap.Modal.getInstance(document.getElementById('createActivityModal')).hide();
        
        clearCache('activities');
        clearCache('admin');
        await Promise.all([
          loadActivities(true),
          loadAdminData(true)
        ]);
      } catch (error) {
        showNotification('建立失敗：' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    });

    document.getElementById('createVolunteerNeedForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      
      try {
        showLoading(true);
        await callAPI('createVolunteerNeed', data);
        showNotification('志工需求建立成功！', 'success');
        bootstrap.Modal.getInstance(document.getElementById('createVolunteerNeedModal')).hide();
        
        clearCache('volunteer');
        await loadVolunteerData(true);
      } catch (error) {
        showNotification('建立失敗：' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    });

    // ==================== Admin Functions ====================
    async function exportMembers() {
      try {
        showLoading(true);
        const response = await callAPI('exportMembers', {});
        if (response.data && response.data.url) {
          window.open(response.data.url, '_blank');
          showNotification('匯出成功！', 'success');
        }
      } catch (error) {
        showNotification('匯出失敗：' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function backupSystem() {
      if (!confirm('確定要備份系統嗎？')) return;
      try {
        showLoading(true);
        const response = await callAPI('backupSystem', {});
        if (response.data && response.data.url) {
          window.open(response.data.url, '_blank');
          showNotification('備份成功！', 'success');
        }
      } catch (error) {
        showNotification('備份失敗：' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    function editActivity(activityId) {
      // TODO: 實作編輯活動功能
      showNotification('編輯功能開發中...', 'info');
    }

    // ==================== 下拉刷新功能 ====================
    let touchStartY = 0;
    let isPulling = false;

    document.addEventListener('touchstart', (e) => {
      if (window.scrollY === 0) {
        touchStartY = e.touches[0].clientY;
      }
    }, { passive: true });

    document.addEventListener('touchmove', (e) => {
      if (window.scrollY === 0 && !isPulling) {
        const touchY = e.touches[0].clientY;
        const pullDistance = touchY - touchStartY;
        
        if (pullDistance > 80) {
          isPulling = true;
          refreshCurrentPage();
        }
      }
    }, { passive: true });

    document.addEventListener('touchend', () => {
      touchStartY = 0;
      isPulling = false;
    });

    async function refreshCurrentPage() {
      const activePage = document.querySelector('.page-content.active');
      if (!activePage) return;
      
      const pageName = activePage.id.replace('page-', '');
      const indicator = document.getElementById('pullRefreshIndicator');
      indicator.style.display = 'block';
      
      clearCache(pageName);
      await loadPageData(pageName, true);
      
      setTimeout(() => {
        indicator.style.display = 'none';
      }, 500);
    }

    // ==================== 工具函數 ====================
    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function showNotification(message, type = 'info') {
      const container = document.querySelector('.toast-container');
      const colors = {
        success: 'bg-success',
        error: 'bg-danger',
        warning: 'bg-warning',
        info: 'bg-info'
      };
      
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white ${colors[type] || colors.info} border-0`;
      toast.setAttribute('role', 'alert');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      
      container.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
      bsToast.show();
      
      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return dateStr;
      }
    }

    function formatDateInput(dateStr) {
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        return date.toISOString().split('T')[0];
      } catch (e) {
        return '';
      }
    }

    function formatCurrency(amount) {
      return Number(amount || 0).toLocaleString('zh-TW');
    }

    function showErrorPage(error) {
      document.body.innerHTML = `
        <div style="padding: 40px; text-align: center;">
          <i class="bi bi-exclamation-triangle" style="font-size: 64px; color: #ea4335;"></i>
          <h3 style="margin-top: 20px;">系統錯誤</h3>
          <p style="color: #666;">${error.message || '發生未知錯誤'}</p>
          <button class="btn btn-primary" onclick="location.reload()">重新載入</button>
        </div>
      `;
    }

    // ==================== LIFF 初始化 ====================
    function loadLiffSDK() {
      return new Promise((resolve, reject) => {
        if (window.liff) {
          resolve();
        } else {
          const script = document.createElement('script');
          script.src = 'https://static.line-scdn.net/liff/edge/2/sdk.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        }
      });
    }

    async function initLIFF() {
      try {
        await loadLiffSDK();
        await liff.init({ liffId: CONFIG.LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        userProfile = await liff.getProfile();
        document.getElementById('userAvatar').src = userProfile.pictureUrl || 'https://via.placeholder.com/50';
        document.getElementById('userName').textContent = userProfile.displayName;
        document.getElementById('userLineId').textContent = userProfile.userId;

        const registered = await ensureUserRegistered();
        if (!registered) return;

        await checkAdminStatus();
        
        // 🚀 只載入初始必要資料
        await loadInitialData();
        
      } catch (error) {
        console.error('LIFF 初始化失敗:', error);
        showErrorPage(error);
      }
    }

    async function ensureUserRegistered() {
      try {
        const response = await callAPI('getUserInfo', {});
        if (response.success && response.data) {
          return true;
        }
      } catch (error) {
        // 用戶不存在，進行註冊
        try {
          await callAPI('registerUser', {
            lineId: userProfile.userId,
            displayName: userProfile.displayName,
            memberType: '一般會員'
          });
          showNotification('歡迎加入！請先完善個人資料', 'success');
          switchPage('profile');
          return true;
        } catch (regError) {
          showNotification('註冊失敗：' + regError.message, 'error');
          return false;
        }
      }
      return true;
    }

    async function checkAdminStatus() {
      try {
        const response = await callAPI('getAdminData', {});
        if (response.success) {
          isAdmin = true;
          document.getElementById('adminNavItem').style.display = 'block';
        }
      } catch (error) {
        isAdmin = false;
        document.getElementById('adminNavItem').style.display = 'none';
      }
    }

    // ==================== 啟動應用 ====================
    window.addEventListener('load', () => {
      initLIFF();
    });

    // ==================== 防止意外離開 ====================
    window.addEventListener('beforeunload', (e) => {
      const forms = document.querySelectorAll('form');
      let hasUnsavedChanges = false;
      
      forms.forEach(form => {
        if (form.classList.contains('was-validated')) {
          hasUnsavedChanges = true;
        }
      });
      
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // ==================== 自動重新連線 ====================
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 3;

    window.addEventListener('online', () => {
      showNotification('網路已恢復', 'success');
      reconnectAttempts = 0;
      refreshCurrentPage();
    });

    window.addEventListener('offline', () => {
      showNotification('網路連線中斷', 'warning');
    });

    // ==================== 定期刷新快取 ====================
    setInterval(() => {
      const activePage = document.querySelector('.page-content.active');
      if (activePage) {
        const pageName = activePage.id.replace('page-', '');
        if (!isCacheValid(pageName)) {
          console.log('🔄 快取過期，自動重新載入:', pageName);
          loadPageData(pageName, true);
        }
      }
    }, CONFIG.CACHE_DURATION);

    // ==================== 效能監控 ====================
    if (window.performance && window.performance.timing) {
      window.addEventListener('load', () => {
        setTimeout(() => {
          const timing = window.performance.timing;
          const loadTime = timing.loadEventEnd - timing.navigationStart;
          console.log('📊 頁面載入時間:', loadTime + 'ms');
          
          if (loadTime > 5000) {
            console.warn('⚠️ 頁面載入時間過長');
          }
        }, 0);
      });
    }

    // ==================== Service Worker (PWA 支援) ====================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(registration => {
          console.log('✅ Service Worker 註冊成功:', registration.scope);
        }).catch(error => {
          console.log('❌ Service Worker 註冊失敗:', error);
        });
      });
    }

    console.log('🚀 帕金森病友會管理系統已啟動');
    console.log('📦 快取時效:', CONFIG.CACHE_DURATION / 1000 / 60, '分鐘');
  </script>
</body>
</html>
