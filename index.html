<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>帕金森病友會管理系統</title>

<!-- LIFF SDK -->
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

<style>
:root {
  --primary: #06c755;
  --primary-dark: #05b04b;
  --secondary: #00b900;
  --danger: #dc3545;
  --warning: #ffc107;
  --info: #17a2b8;
  --light: #f8f9fa;
  --dark: #343a40;
  --border-radius: 12px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding-bottom: 80px;
}

.app-container {
  max-width: 480px;
  margin: 0 auto;
  background: white;
  min-height: 100vh;
  box-shadow: 0 0 30px rgba(0,0,0,0.1);
}

/* 頂部導航 */
.top-bar {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.top-bar h1 { font-size: 18px; font-weight: 600; margin: 0; }
.user-info { display: flex; align-items: center; gap: 10px; }
.user-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid white; }
.user-name { font-size: 14px; font-weight: 500; }

/* 底部導航 */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e0e0e0;
  display: flex; justify-content: space-around; padding: 8px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
  z-index: 1000; max-width: 480px; margin: 0 auto;
}
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px; color: #666; text-decoration: none; transition: all 0.3s; cursor: pointer; border: none; background: none; }
.nav-item i { font-size: 22px; }
.nav-item span { font-size: 11px; }
.nav-item.active { color: var(--primary); }
.nav-item:hover { color: var(--primary); background: rgba(6, 199, 85, 0.05); }

/* 頁面內容 */
.page-content { display: none; padding: 20px; animation: fadeIn 0.3s; }
.page-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* 卡片樣式 */
.card { border: none; border-radius: var(--border-radius); box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; overflow: hidden; }
.card-header { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; font-weight: 600; padding: 15px 20px; border: none; }
.card-body { padding: 20px; }

/* 統計卡片 */
.stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
.stat-card { background: white; border-radius: var(--border-radius); padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; }
.stat-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.stat-icon { font-size: 32px; margin-bottom: 10px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.stat-value { font-size: 28px; font-weight: 700; color: var(--dark); margin: 5px 0; }
.stat-label { font-size: 13px; color: #666; }

/* 活動項目 */
.activity-item { background: white; border-radius: var(--border-radius); padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; }
.activity-item:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.activity-title { font-size: 16px; font-weight: 600; color: var(--dark); margin-bottom: 8px; }
.activity-info { font-size: 14px; color: #666; margin-bottom: 10px; }
.activity-meta { display: flex; flex-wrap: wrap; gap: 10px; font-size: 13px; color: #888; }
.activity-meta span { display: flex; align-items: center; gap: 4px; }
.activity-meta i { font-size: 14px; }

/* 狀態標籤 */
.status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
.status-開放報名, .status-已報名, .status-已完成 { background: #d4edda; color: #155724; }
.status-已額滿, .status-已取消 { background: #f8d7da; color: #721c24; }
.status-已結束 { background: #e2e3e5; color: #383d41; }
.status-審核中, .status-待付款 { background: #fff3cd; color: #856404; }
.status-已核准, .status-已捐款 { background: #d4edda; color: #155724; }
.status-已拒絕 { background: #f8d7da; color: #721c24; }

/* 按鈕樣式 */
.btn-gradient {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: 600; transition: all 0.3s;
  box-shadow: 0 4px 10px rgba(6, 199, 85, 0.3);
}
.btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(6, 199, 85, 0.4); color: white; }
.btn-gradient:active { transform: translateY(0); }

/* 表單樣式 */
.form-floating > label { color: #666; }
.form-control:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 0.2rem rgba(6, 199, 85, 0.25); }

/* 空狀態 */
.empty-state { text-align: center; padding: 40px 20px; color: #999; }
.empty-state i { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
.empty-state p { font-size: 14px; margin: 0; }

/* 載入動畫 */
.loading-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7);
  display: flex; justify-content: center; align-items: center; z-index: 9999;
}
.loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Toast 通知 */
.toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }

/* 管理員專用 */
.admin-only { display: none; }

/* 表格樣式 */
.table-responsive { border-radius: var(--border-radius); overflow: hidden; }
.table { margin-bottom: 0; }
.table thead { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; }
.table tbody tr:hover { background: rgba(6, 199, 85, 0.05); }

/* 響應式 */
@media (max-width: 480px) {
  .stats-grid { grid-template-columns: 1fr; }
  .activity-meta { flex-direction: column; gap: 5px; }
}

/* ===== Admin 專用作用域樣式（避免影響前台） ===== */
#adminApp .spinner{width:48px;height:48px;border:4px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
#adminApp .admin-loading{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;background:linear-gradient(135deg,#00B900,#06C755);color:#fff;border-radius:12px}
#adminApp .admin-layout{display:flex;gap:16px}
#adminApp .admin-sidebar{width:240px;min-height:70vh;background:linear-gradient(180deg,#00B900,#06C755);color:#fff;border-radius:12px;padding:16px;position:relative}
#adminApp .admin-sidebar-header .title{font-weight:700;display:flex;align-items:center;gap:8px}
#adminApp .admin-sidebar-header .subtitle{opacity:.85;font-size:.9rem;margin-top:4px}
#adminApp .admin-menu{list-style:none;margin:16px 0 0;padding:0}
#adminApp .admin-menu-item{padding:10px 12px;border-radius:10px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:.2s}
#adminApp .admin-menu-item:hover{background:rgba(255,255,255,.12)}
#adminApp .admin-menu-item.active{background:rgba(255,255,255,.22);border-left:4px solid #fff}
#adminApp .admin-main{flex:1}
#adminApp .admin-topbar{display:flex;align-items:center;justify-content:space-between;background:#fff;border-radius:12px;padding:12px 16px;box-shadow:0 2px 10px rgba(0,0,0,.06);margin-bottom:16px}
#adminApp .admin-topbar .avatar{width:40px;height:40px;border-radius:50%;border:2px solid #00B900}
#adminApp .admin-mobile-menu{display:none;background:linear-gradient(135deg,#00B900,#06C755);color:#fff;border:none;border-radius:10px;padding:8px 12px}
#adminApp .admin-page{display:none;animation:fadeIn .25s}
#adminApp .admin-page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
#adminApp .admin-stat{background:#fff;border-radius:12px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
#adminApp .admin-stat .head{display:flex;justify-content:space-between;align-items:center}
#adminApp .admin-stat .title{color:#7f8c8d;font-weight:600;font-size:.9rem}
#adminApp .admin-stat .value{font-size:1.8rem;font-weight:800;color:#2c3e50;margin-top:4px}
#adminApp .admin-stat .change{font-size:.85rem;color:#27ae60}
#adminApp .icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center}
#adminApp .bg-blue{background:#e3f2fd;color:#2196f3}
#adminApp .bg-purple{background:#f3e5f5;color:#9c27b0}
#adminApp .bg-green{background:#e8f5e9;color:#4caf50}
#adminApp .bg-orange{background:#fff3e0;color:#ff9800}
#adminApp .admin-card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);margin-bottom:16px}
#adminApp .admin-card-header{padding:14px 16px;border-bottom:1px solid #f0f0f0;font-weight:700;color:#2c3e50;border-radius:12px 12px 0 0}
#adminApp .admin-card-body{padding:16px}
#adminApp .chart-wrap{position:relative;height:300px}
#adminApp .admin-empty{padding:32px 16px;text-align:center;color:#999}
#adminApp .admin-empty i{font-size:2.4rem;opacity:.35}
@media (max-width: 992px){#adminApp .admin-layout{flex-direction:column}#adminApp .admin-sidebar{width:100%}#adminApp .admin-mobile-menu{display:inline-flex}}
</style>
</head>
<body>

<div class="app-container">
  <!-- 頂部導航 -->
  <div class="top-bar">
    <h1><i class="bi bi-heart-pulse me-2"></i>帕金森病友會</h1>
    <div class="user-info">
      <img id="userAvatar" class="user-avatar" src='https://placehold.co/36' alt="頭像">
      <span id="userName" class="user-name">載入中...</span>
    </div>
  </div>

  <!-- 首頁 -->
  <div id="page-home" class="page-content active">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-calendar-event"></i></div>
        <div class="stat-value" id="statActivities">0</div>
        <div class="stat-label">活動總數</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
        <div class="stat-value" id="statRegistrations">0</div>
        <div class="stat-label">我的報名</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
        <div class="stat-value" id="statVolunteerHours">0</div>
        <div class="stat-label">志工時數</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-heart"></i></div>
        <div class="stat-value" id="statDonations">$0</div>
        <div class="stat-label">捐款金額</div>
      </div>
    </div>

    <!-- 最新活動 -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-calendar-event me-2"></i>最新活動
      </div>
      <div class="card-body">
        <div id="recentActivities">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 活動頁 -->
  <div id="page-activities" class="page-content">
    <div class="card">
      <div class="card-header">
        <i class="bi bi-calendar-plus me-2"></i>開放報名
      </div>
      <div class="card-body">
        <div id="activitiesList">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-list-check me-2"></i>我的報名
      </div>
      <div class="card-body">
        <div id="myRegistrationsList">
          <div class="empty-state">
            <i class="bi bi-calendar-x"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 志工頁 -->
  <div id="page-volunteer" class="page-content">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
        <div class="stat-value" id="volTotalHours">0</div>
        <div class="stat-label">累計時數</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
        <div class="stat-value" id="volTotalActivities">0</div>
        <div class="stat-label">服務次數</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-people me-2"></i>志工需求
      </div>
      <div class="card-body">
        <div id="volunteerNeedsList">
          <div class="empty-state">
            <i class="bi bi-people"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-journal-text me-2"></i>我的記錄
      </div>
      <div class="card-body">
        <div id="myVolunteerRecords">
          <div class="empty-state">
            <i class="bi bi-journal-x"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 財務頁 -->
  <div id="page-finance" class="page-content">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-heart"></i></div>
        <div class="stat-value" id="finTotalDonation">$0</div>
        <div class="stat-label">累計捐款</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-receipt"></i></div>
        <div class="stat-value" id="finPendingExpenses">0</div>
        <div class="stat-label">待審核支出</div>
      </div>
    </div>

    <div class="d-grid gap-2 mb-3">
      <button class="btn btn-gradient" onclick="showDonationModal()">
        <i class="bi bi-heart-fill me-2"></i>我要捐款
      </button>
      <button class="btn btn-outline-primary" onclick="showNewExpenseModal()">
        <i class="bi bi-receipt me-2"></i>支出申請
      </button>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-heart me-2"></i>我的捐款
      </div>
      <div class="card-body">
        <div id="myDonationsList">
          <div class="empty-state">
            <i class="bi bi-heart"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-receipt me-2"></i>我的支出
      </div>
      <div class="card-body">
        <div id="myExpensesList">
          <div class="empty-state">
            <i class="bi bi-receipt"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 個人頁 -->
  <div id="page-profile" class="page-content">
    <div class="card">
      <div class="card-header">
        <i class="bi bi-person me-2"></i>個人資料
      </div>
      <div class="card-body">
        <form id="profileForm">
          <div class="form-floating mb-3">
            <input type="text" class="form-control" name="realName" required>
            <label>真實姓名 *</label>
          </div>
          <div class="form-floating mb-3">
            <select class="form-select" name="memberType" required>
              <option value="">請選擇</option>
              <option value="病友">病友</option>
              <option value="家屬">家屬</option>
              <option value="志工">志工</option>
            </select>
            <label>會員類型 *</label>
          </div>
          <div class="form-floating mb-3">
            <input type="tel" class="form-control" name="phone">
            <label>聯絡電話</label>
          </div>
          <div class="form-floating mb-3">
            <input type="email" class="form-control" name="email">
            <label>電子郵件</label>
          </div>
          <div class="form-floating mb-3">
            <input type="date" class="form-control" name="birthday">
            <label>生日</label>
          </div>
          <div class="form-floating mb-3">
            <input type="date" class="form-control" name="diagnosisDate">
            <label>確診日期</label>
          </div>
          <div class="form-floating mb-3">
            <textarea class="form-control" name="address" style="height:80px;"></textarea>
            <label>地址</label>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-gradient">
              <i class="bi bi-save me-2"></i>儲存變更
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-file-earmark-text me-2"></i>我的收據
      </div>
      <div class="card-body">
        <div id="myReceiptsList">
          <div class="empty-state">
            <i class="bi bi-file-earmark-text"></i>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="bi bi-info-circle me-2"></i>會員資訊
      </div>
      <div class="card-body">
        <p><strong>會員類型：</strong><span id="userMemberType">-</span></p>
        <p><strong>LINE ID：</strong><span id="userLineId">-</span></p>
        <p class="mb-0"><strong>版本：</strong>v2.2.0</p>
      </div>
    </div>
  </div>

  <!-- 管理頁：以 page-admin 作容器，嵌入 adminApp -->
  <div id="page-admin" class="page-content admin-only">
    <!-- Admin App 內嵌（作用域 #adminApp） -->
    <div id="adminApp" class="admin-root" style="display:none;">
      <div id="adminLoading" class="admin-loading">
        <div class="spinner"></div>
        <p class="mt-2">管理後台載入中...</p>
      </div>

      <div class="admin-layout" style="display:none;">
        <aside class="admin-sidebar" id="adminSidebar">
          <div class="admin-sidebar-header">
            <div class="title">
              <i class="bi bi-heart-pulse"></i>
              <span>管理後台</span>
            </div>
            <div class="subtitle">台灣帕金森病友會</div>
          </div>
          <ul class="admin-menu">
            <li class="admin-menu-item active" data-page="dashboard" onclick="adminSwitchPage('dashboard', event)">
              <i class="bi bi-speedometer2"></i> 儀表板
            </li>
            <li class="admin-menu-item" data-page="members" onclick="adminSwitchPage('members', event)">
              <i class="bi bi-people"></i> 會員管理
            </li>
            <li class="admin-menu-item" data-page="activities" onclick="adminSwitchPage('activities', event)">
              <i class="bi bi-calendar-event"></i> 活動管理
            </li>
            <li class="admin-menu-item" data-page="registrations" onclick="adminSwitchPage('registrations', event)">
              <i class="bi bi-list-check"></i> 報名管理
            </li>
            <li class="admin-menu-item" data-page="volunteers" onclick="adminSwitchPage('volunteers', event)">
              <i class="bi bi-heart"></i> 志工管理
            </li>
            <li class="admin-menu-item" data-page="finance" onclick="adminSwitchPage('finance', event)">
              <i class="bi bi-cash-stack"></i> 財務管理
            </li>
            <li class="admin-menu-item" data-page="statistics" onclick="adminSwitchPage('statistics', event)">
              <i class="bi bi-graph-up"></i> 統計報表
            </li>
            <li class="admin-menu-item" data-page="settings" onclick="adminSwitchPage('settings', event)">
              <i class="bi bi-gear"></i> 系統設定
            </li>
          </ul>
        </aside>

        <main class="admin-main">
          <div class="admin-topbar">
            <h1 id="adminPageTitle">儀表板</h1>
            <div class="user">
              <span id="adminDisplayName">管理員</span> 'https://placehold.co/40' alt="頭像">
              <button class="admin-mobile-menu" onclick="document.getElementById('adminSidebar').classList.toggle('show')">
                <i class="bi bi-list"></i>
              </button>
            </div>
          </div>

          <!-- 儀表板 -->
          <section id="adminPage-dashboard" class="admin-page active">
            <div class="row g-4 mb-4">
              <div class="col-md-3 col-sm-6">
                <div class="admin-stat">
                  <div class="head">
                    <div>
                      <div class="title">總會員數</div>
                      <div class="value" id="admStatTotalMembers">0</div>
                      <div class="change"><i class="bi bi-arrow-up"></i> 本月新增 <span id="admStatNewMembers">0</span></div>
                    </div>
                    <div class="icon bg-blue"><i class="bi bi-people"></i></div>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-sm-6">
                <div class="admin-stat">
                  <div class="head">
                    <div>
                      <div class="title">活動數量</div>
                      <div class="value" id="admStatTotalActivities">0</div>
                      <div class="change"><i class="bi bi-calendar-check"></i> 進行中 <span id="admStatActiveActivities">0</span></div>
                    </div>
                    <div class="icon bg-purple"><i class="bi bi-calendar-event"></i></div>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-sm-6">
                <div class="admin-stat">
                  <div class="head">
                    <div>
                      <div class="title">志工時數</div>
                      <div class="value" id="admStatVolunteerHours">0</div>
                      <div class="change"><i class="bi bi-clock-history"></i> 累計服務時數</div>
                    </div>
                    <div class="icon bg-green"><i class="bi bi-heart"></i></div>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-sm-6">
                <div class="admin-stat">
                  <div class="head">
                    <div>
                      <div class="title">財務餘額</div>
                      <div class="value" id="admStatBalance">$0</div>
                      <div class="change"><i class="bi bi-cash"></i> 本月收支</div>
                    </div>
                    <div class="icon bg-orange"><i class="bi bi-cash-stack"></i></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-4">
              <div class="col-lg-8">
                <div class="admin-card">
                  <div class="admin-card-header"><i class="bi bi-graph-up"></i> 會員成長趨勢</div>
                  <div class="admin-card-body">
                    <div class="chart-wrap">
                      <canvas id="admMemberGrowthChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="admin-card">
                  <div class="admin-card-header"><i class="bi bi-pie-chart"></i> 會員類型分布</div>
                  <div class="admin-card-body">
                    <div class="chart-wrap">
                      <canvas id="admMemberTypeChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="admin-card mt-3">
              <div class="admin-card-header"><i class="bi bi-calendar-check"></i> 近期活動</div>
              <div class="admin-card-body" id="admRecentActivities">
                <div class="admin-empty">
                  <i class="bi bi-inbox"></i>
                  <p>載入中...</p>
                </div>
              </div>
            </div>
          </section>

          <!-- 會員管理 -->
          <section id="adminPage-members" class="admin-page">
            <div class="admin-card">
              <div class="admin-card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-people"></i> 會員列表</span>
                <input id="admMemberSearch" type="text" class="form-control form-control-sm" style="max-width:260px" placeholder="搜尋會員...">
              </div>
              <div class="admin-card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>會員編號</th><th>姓名</th><th>類型</th><th>電話</th><th>Email</th><th>加入日期</th><th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="admMembersTbody">
                      <tr><td colspan="7" class="text-center text-muted">載入中...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- 活動管理 -->
          <section id="adminPage-activities" class="admin-page">
            <div class="admin-card">
              <div class="admin-card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-calendar-event"></i> 活動列表</span>
                <button class="btn btn-primary btn-sm" onclick="adminShowAddActivity()"><i class="bi bi-plus-circle"></i> 新增活動</button>
              </div>
              <div class="admin-card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>活動編號</th><th>活動名稱</th><th>類型</th><th>日期</th><th>地點</th><th>報名人數</th><th>狀態</th><th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="admActivitiesTbody">
                      <tr><td colspan="8" class="text-center text-muted">載入中...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- 報名管理 -->
          <section id="adminPage-registrations" class="admin-page">
            <div class="admin-card">
              <div class="admin-card-header"><i class="bi bi-list-check"></i> 報名記錄</div>
              <div class="admin-card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>報名編號</th><th>會員姓名</th><th>活動名稱</th><th>報名時間</th><th>狀態</th><th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="admRegistrationsTbody">
                      <tr><td colspan="6" class="text-center text-muted">載入中...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- 志工管理 -->
          <section id="adminPage-volunteers" class="admin-page">
            <div class="admin-card">
              <div class="admin-card-header"><i class="bi bi-heart"></i> 志工服務記錄</div>
              <div class="admin-card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>記錄編號</th><th>志工姓名</th><th>服務日期</th><th>服務時數</th><th>服務項目</th><th>狀態</th><th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="admVolunteersTbody">
                      <tr><td colspan="7" class="text-center text-muted">載入中...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- 財務管理 -->
          <section id="adminPage-finance" class="admin-page">
            <div class="row g-4 mb-3">
              <div class="col-md-4"><div class="admin-stat"><div class="title">總收入</div><div class="value text-success" id="admFinIncome">$0</div></div></div>
              <div class="col-md-4"><div class="admin-stat"><div class="title">總支出</div><div class="value text-danger" id="admFinExpense">$0</div></div></div>
              <div class="col-md-4"><div class="admin-stat"><div class="title">餘額</div><div class="value text-primary" id="admFinBalance">$0</div></div></div>
            </div>
            <div class="row g-4">
              <div class="col-lg-6">
                <div class="admin-card">
                  <div class="admin-card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-arrow-down-circle"></i> 捐款記錄</span>
                    <button class="btn btn-primary btn-sm" onclick="adminShowAddDonation()"><i class="bi bi-plus-circle"></i> 新增捐款</button>
                  </div>
                  <div class="admin-card-body">
                    <div class="table-responsive">
                      <table class="table table-hover table-sm">
                        <thead><tr><th>捐款人</th><th>金額</th><th>日期</th><th>方式</th></tr></thead>
                        <tbody id="admDonationsTbody"><tr><td colspan="4" class="text-center text-muted">載入中...</td></tr></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="admin-card">
                  <div class="admin-card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-arrow-up-circle"></i> 支出記錄</span>
                    <button class="btn btn-primary btn-sm" onclick="adminShowAddExpense()"><i class="bi bi-plus-circle"></i> 新增支出</button>
                  </div>
                  <div class="admin-card-body">
                    <div class="table-responsive">
                      <table class="table table-hover table-sm">
                        <thead><tr><th>項目</th><th>金額</th><th>日期</th><th>狀態</th><th>操作</th></tr></thead>
                        <tbody id="admExpensesTbody"><tr><td colspan="5" class="text-center text-muted">載入中...</td></tr></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- 統計 -->
          <section id="adminPage-statistics" class="admin-page">
            <div class="row g-4">
              <div class="col-lg-6">
                <div class="admin-card">
                  <div class="admin-card-header"><i class="bi bi-bar-chart"></i> 活動類型統計</div>
                  <div class="admin-card-body"><div class="chart-wrap"><canvas id="admActivityTypeChart"></canvas></div></div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="admin-card">
                  <div class="admin-card-header"><i class="bi bi-graph-up"></i> 志工服務統計</div>
                  <div class="admin-card-body"><div class="chart-wrap"><canvas id="admVolunteerStatsChart"></canvas></div></div>
                </div>
              </div>
            </div>
          </section>

          <!-- 設定 -->
          <section id="adminPage-settings" class="admin-page">
            <div class="admin-card">
              <div class="admin-card-header"><i class="bi bi-gear"></i> 系統設定</div>
              <div class="admin-card-body">
                <form id="admSettingsForm">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">組織名稱</label>
                      <input type="text" class="form-control" id="admSetOrgName">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">聯絡電話</label>
                      <input type="tel" class="form-control" id="admSetPhone">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">聯絡Email</label>
                      <input type="email" class="form-control" id="admSetEmail">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">組織地址</label>
                      <input type="text" class="form-control" id="admSetAddress">
                    </div>
                    <div class="col-12">
                      <label class="form-label">LINE Notify Token</label>
                      <input type="text" class="form-control" id="admSetLineNotifyToken" placeholder="用於發送通知">
                    </div>
                    <div class="col-12">
                      <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> 儲存設定</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <div class="admin-card mt-4">
              <div class="admin-card-header"><i class="bi bi-shield-check"></i> 管理員帳號</div>
              <div class="admin-card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead><tr><th>姓名</th><th>LINE ID</th><th>權限</th><th>加入日期</th><th>操作</th></tr></thead>
                  <tbody id="admAdminsTbody"><tr><td colspan="5" class="text-center text-muted">載入中...</td></tr></tbody>
                </table>
                </div>
                <button class="btn btn-primary mt-3" onclick="adminShowAddAdmin()"><i class="bi bi-plus-circle"></i> 新增管理員</button>
              </div>
            </div>
          </section>
        </main>
      </div>

      <!-- Modals -->
      <div id="adminModals">
        <!-- 新增活動 -->
        <div class="modal fade" id="admAddActivityModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header"><h5 class="modal-title"><i class="bi bi-plus-circle"></i> 新增活動</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
              <div class="modal-body">
                <form id="admAddActivityForm">
                  <div class="row g-3">
                    <div class="col-md-8"><label class="form-label">活動名稱 *</label><input type="text" class="form-control" id="admActTitle" required></div>
                    <div class="col-md-4"><label class="form-label">活動類型 *</label>
                      <select class="form-select" id="admActType" required>
                        <option value="">請選擇</option><option>健康講座</option><option>復健課程</option><option>社交活動</option><option>志工培訓</option><option>戶外活動</option><option>其他</option>
                      </select>
                    </div>
                    <div class="col-md-6"><label class="form-label">活動日期 *</label><input type="date" class="form-control" id="admActDate" required></div>
                    <div class="col-md-6"><label class="form-label">活動時間</label><input type="time" class="form-control" id="admActTime"></div>
                    <div class="col-md-8"><label class="form-label">活動地點</label><input type="text" class="form-control" id="admActLocation"></div>
                    <div class="col-md-4"><label class="form-label">活動費用</label><input type="number" class="form-control" id="admActFee" value="0" min="0"></div>
                    <div class="col-md-6"><label class="form-label">人數上限</label><input type="number" class="form-control" id="admActMaxParticipants" min="0" placeholder="0 = 不限"></div>
                    <div class="col-md-6"><label class="form-label">報名截止日期</label><input type="date" class="form-control" id="admActDeadline"></div>
                    <div class="col-12"><label class="form-label">活動說明</label><textarea class="form-control" id="admActDescription" rows="4"></textarea></div>
                    <div class="col-12"><label class="form-label">備註</label><textarea class="form-control" id="admActNote" rows="2"></textarea></div>
                    <div class="col-md-6"><label class="form-label">活動狀態</label>
                      <select class="form-select" id="admActStatus"><option>報名中</option><option>已額滿</option><option>已結束</option><option>已取消</option></select>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button class="btn btn-primary" onclick="adminSubmitActivity()"><i class="bi bi-check-circle"></i> 新增</button></div>
            </div>
          </div>
        </div>

        <!-- 編輯活動 -->
        <div class="modal fade" id="admEditActivityModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header"><h5 class="modal-title"><i class="bi bi-pencil"></i> 編輯活動</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
              <div class="modal-body">
                <form id="admEditActivityForm">
                  <input type="hidden" id="admEditActId">
                  <div class="row g-3">
                    <div class="col-md-8"><label class="form-label">活動名稱 *</label><input type="text" class="form-control" id="admEditActTitle" required></div>
                    <div class="col-md-4"><label class="form-label">活動類型 *</label>
                      <select class="form-select" id="admEditActType" required>
                        <option>健康講座</option><option>復健課程</option><option>社交活動</option><option>志工培訓</option><option>戶外活動</option><option>其他</option>
                      </select>
                    </div>
                    <div class="col-md-6"><label class="form-label">活動日期 *</label><input type="date" class="form-control" id="admEditActDate" required></div>
                    <div class="col-md-6"><label class="form-label">活動時間</label><input type="time" class="form-control" id="admEditActTime"></div>
                    <div class="col-md-8"><label class="form-label">活動地點</label><input type="text" class="form-control" id="admEditActLocation"></div>
                    <div class="col-md-4"><label class="form-label">活動費用</label><input type="number" class="form-control" id="admEditActFee" min="0"></div>
                    <div class="col-md-6"><label class="form-label">人數上限</label><input type="number" class="form-control" id="admEditActMaxParticipants" min="0"></div>
                    <div class="col-md-6"><label class="form-label">報名截止日期</label><input type="date" class="form-control" id="admEditActDeadline"></div>
                    <div class="col-12"><label class="form-label">活動說明</label><textarea class="form-control" id="admEditActDescription" rows="4"></textarea></div>
                    <div class="col-12"><label class="form-label">備註</label><textarea class="form-control" id="admEditActNote" rows="2"></textarea></div>
                    <div class="col-md-6"><label class="form-label">活動狀態</label>
                      <select class="form-select" id="admEditActStatus"><option>報名中</option><option>已額滿</option><option>已結束</option><option>已取消</option></select>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button class="btn btn-primary" onclick="adminUpdateActivity()"><i class="bi bi-check-circle"></i> 更新</button></div>
            </div>
          </div>
        </div>

        <!-- 會員詳情 -->
        <div class="modal fade" id="admMemberDetailModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header"><h5 class="modal-title"><i class="bi bi-person-circle"></i> 會員詳情</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
              <div class="modal-body" id="admMemberDetailContent"><p class="text-muted">載入中...</p></div>
              <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">關閉</button></div>
            </div>
          </div>
        </div>

        <!-- 新增捐款 -->
        <div class="modal fade" id="admAddDonationModal" tabindex="-1">
          <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title"><i class="bi bi-plus-circle"></i> 新增捐款</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <form id="admAddDonationForm">
                <div class="mb-3"><label class="form-label">捐款人 *</label><input type="text" class="form-control" id="admDonDonor" required></div>
                <div class="mb-3"><label class="form-label">捐款金額 *</label><input type="number" class="form-control" id="admDonAmount" min="1" required></div>
                <div class="mb-3"><label class="form-label">捐款日期 *</label><input type="date" class="form-control" id="admDonDate" required></div>
                <div class="mb-3"><label class="form-label">捐款方式</label>
                  <select class="form-select" id="admDonMethod"><option>現金</option><option>轉帳</option><option>支票</option><option>其他</option></select>
                </div>
                <div class="mb-3"><label class="form-label">備註</label><textarea class="form-control" id="admDonNote" rows="2"></textarea></div>
              </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button class="btn btn-primary" onclick="adminSubmitDonation()"><i class="bi bi-check-circle"></i> 新增</button></div>
          </div></div>
        </div>

        <!-- 新增支出 -->
        <div class="modal fade" id="admAddExpenseModal" tabindex="-1">
          <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title"><i class="bi bi-plus-circle"></i> 新增支出</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <form id="admAddExpenseForm">
                <div class="mb-3"><label class="form-label">支出項目 *</label><input type="text" class="form-control" id="admExpItem" required></div>
                <div class="mb-3"><label class="form-label">支出金額 *</label><input type="number" class="form-control" id="admExpAmount" min="1" required></div>
                <div class="mb-3"><label class="form-label">支出日期 *</label><input type="date" class="form-control" id="admExpDate" required></div>
                <div class="mb-3"><label class="form-label">支出類別</label>
                  <select class="form-select" id="admExpCategory"><option>活動費用</option><option>場地租金</option><option>行政費用</option><option>設備購置</option><option>其他</option></select>
                </div>
                <div class="mb-3"><label class="form-label">備註</label><textarea class="form-control" id="admExpNote" rows="2"></textarea></div>
              </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button class="btn btn-primary" onclick="adminSubmitExpense()"><i class="bi bi-check-circle"></i> 新增</button></div>
          </div></div>
        </div>

        <!-- 新增管理員 -->
        <div class="modal fade" id="admAddAdminModal" tabindex="-1">
          <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title"><i class="bi bi-plus-circle"></i> 新增管理員</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <form id="admAddAdminForm">
                <div class="mb-3"><label class="form-label">LINE User ID *</label><input type="text" class="form-control" id="admAdminLineUserId" required><small class="text-muted">請輸入要設為管理員的 LINE User ID</small></div>
                <div class="mb-3"><label class="form-label">姓名 *</label><input type="text" class="form-control" id="admAdminName" required></div>
                <div class="mb-3"><label class="form-label">權限</label><select class="form-select" id="admAdminRole"><option>管理員</option><option>超級管理員</option></select></div>
              </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button class="btn btn-primary" onclick="adminSubmitAdmin()"><i class="bi bi-check-circle"></i> 新增</button></div>
          </div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 底部導航 -->
  <div class="bottom-nav">
    <button class="nav-item active" onclick="switchPage('home', event)">
      <i class="bi bi-house-door-fill"></i>
      <span>首頁</span>
    </button>
    <button class="nav-item" onclick="switchPage('activities', event)">
      <i class="bi bi-calendar-event"></i>
      <span>活動</span>
    </button>
    <button class="nav-item" onclick="switchPage('volunteer', event)">
      <i class="bi bi-people"></i>
      <span>志工</span>
    </button>
    <button class="nav-item" onclick="switchPage('finance', event)">
      <i class="bi bi-wallet2"></i>
      <span>財務</span>
    </button>
    <button class="nav-item" onclick="switchPage('profile', event)">
      <i class="bi bi-person"></i>
      <span>我的</span>
    </button>
    <button class="nav-item admin-only" onclick="switchPage('admin', event)">
      <i class="bi bi-gear"></i>
      <span>管理</span>
    </button>
  </div>
</div>

<!-- Toast 容器 -->
<div id="toastContainer" class="toast-container"></div>

<!-- Modal 容器 -->
<div id="modalContainer"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js for Admin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
// ==================== 全域變數 ====================
const CONFIG = {
  LIFF_ID: '1656516134-X9oq92g9',  // TODO: 替換
  GAS_URL: 'https://script.google.com/macros/s/AKfycbw2i03kcviCjtSVg_7NZmNR1J_CWDhzFaAgDwVc3cEIX4FUYyo6xKzvuuNkXArdvlBvCA/exec',  // TODO: 替換
  API_KEY: 'AAbb8520258185202581'
};

let userProfile = null;
let isAdmin = false;
let cachedData = {};

// Admin data caches
let admMembers=[], admActivities=[], admRegistrations=[], admVolunteers=[];
let admCharts = { memberGrowth:null, memberType:null, actType:null, volStats:null };
let admCurrentEditActivityId = null;

// ==================== LIFF SDK 載入檢查 ====================
function loadLiffSDK() {
  return new Promise((resolve, reject) => {
    let checkCount = 0;
    const maxChecks = 50;
    const checkLiff = () => {
      checkCount++;
      if (typeof liff !== 'undefined') {
        resolve();
        return;
      }
      if (checkCount >= maxChecks) {
        reject(new Error('LIFF SDK 未載入，請於 LINE App 內開啟或檢查網路'));
        return;
      }
      setTimeout(checkLiff, 100);
    };
    checkLiff();
  });
}

// ==================== LIFF 初始化 ====================
async function initLIFF() {
  try {
    await loadLiffSDK();
    await liff.init({ liffId: CONFIG.LIFF_ID });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    userProfile = await liff.getProfile();
    document.getElementById('userAvatar').src = userProfile.pictureUrl || 'https://placehold.co/36';
    document.getElementById('userName').textContent = userProfile.displayName;
    document.getElementById('userLineId').textContent = userProfile.userId;

    // 先確保使用者註冊
    const registered = await ensureUserRegistered();
    if (!registered) return;

    await checkAdminStatus();
    await loadAllData();
  } catch (error) {
    showErrorPage(error);
  }
}

// ==================== 初次註冊流程 ====================
async function ensureUserRegistered() {
  try {
    await callAPI('getUserInfo', {});
    return true;
  } catch (e) {
    if (!/未註冊/.test(e.message || '')) {
      showNotification('取得用戶資訊失敗：' + e.message, 'error');
      return false;
    }
    const html = `
      <div class="modal fade" id="regModal" tabindex="-1">
        <div class="modal-dialog">
          <form class="modal-content" id="regForm">
            <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>加入病友會</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p class="text-muted mb-3">首次使用請先完成簡易註冊。</p>
              <div class="form-floating mb-3">
                <input type="text" class="form-control" name="realName" required>
                <label>真實姓名 *</label>
              </div>
              <div class="form-floating mb-3">
                <select class="form-select" name="memberType" required>
                  <option value="">請選擇</option>
                  <option value="病友">病友</option>
                  <option value="家屬">家屬</option>
                  <option value="志工">志工</option>
                </select>
                <label>會員類型 *</label>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="submit" class="btn btn-gradient">立即加入</button>
            </div>
          </form>
        </div>
      </div>
    `;
    return new Promise((resolve) => {
      showModal(html, async (formData) => {
        const data = {
          realName: formData.get('realName'),
          memberType: formData.get('memberType'),
          lineName: userProfile?.displayName || ''
        };
        await callAPI('registerUser', data);
        showNotification('註冊成功！', 'success');
        resolve(true);
      });
      const el = document.getElementById('regModal');
      el?.addEventListener('hidden.bs.modal', () => resolve(false), { once: true });
    });
  }
}

// ==================== 錯誤頁面 ====================
function showErrorPage(error) {
  document.querySelector('.app-container').innerHTML = `
    <div style="padding: 40px 20px; text-align: center;">
      <i class="bi bi-exclamation-triangle" style="font-size: 64px; color: #dc3545;"></i>
      <h3 style="margin-top: 20px;">系統初始化失敗</h3>
      <p style="color: #666; margin: 20px 0;">${error.message}</p>
      <div class="d-grid gap-2 mx-auto" style="max-width: 300px;">
        <button class="btn btn-gradient" onclick="location.reload()">
          <i class="bi bi-arrow-clockwise me-2"></i>重新載入
        </button>
        <button class="btn btn-outline-secondary" onclick="navigator.clipboard.writeText(window.location.href);showNotification('連結已複製，請至 LINE App 開啟','success')">
          <i class="bi bi-clipboard me-2"></i>複製連結
        </button>
      </div>
    </div>`;
}

// ==================== API 呼叫 ====================
async function callAPI(action, data = {}) {
  try {
    const payload = {
      apiKey: CONFIG.API_KEY,
      action: action,
      lineId: userProfile?.userId || '',
      ...data
    };
    const response = await fetch(CONFIG.GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(payload)
    });
    const result = await response.json();
    if (!result.success) {
      throw new Error(result.message || ('操作失敗: '+action));
    }
    return result;
  } catch (error) {
    throw error;
  }
}

// ==================== 檢查管理員權限 ====================
async function checkAdminStatus() {
  try {
    const response = await callAPI('getUserInfo', {});
    isAdmin = response.data?.isAdmin || false;
    if (isAdmin) {
      document.querySelectorAll('.admin-only').forEach(el => { el.style.display = 'block'; });
    }
  } catch (error) {
    // 忽略
  }
}

// ==================== 載入所有資料 ====================
async function loadAllData() {
  showLoading(true);
  try {
    await Promise.all([
      loadHomeData(),
      loadActivities(),
      loadVolunteerData(),
      loadFinanceData(),
      loadProfileData()
    ]);
    if (isAdmin) {
      try { await loadAdminData(); } catch {}
    }
  } catch (error) {
    showNotification('載入資料失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== 首頁 ====================
async function loadHomeData() {
  try {
    const response = await callAPI('getDashboardData', {});
    const data = response.data;
    document.getElementById('statActivities').textContent = data.totalActivities || 0;
    document.getElementById('statRegistrations').textContent = data.myRegistrations || 0;
    document.getElementById('statVolunteerHours').textContent = data.myVolunteerHours || 0;
    document.getElementById('statDonations').textContent = '$' + formatCurrency(data.myDonationAmount || 0);
    renderRecentActivities(data.recentActivity || []);
  } catch (error) {
    // 區塊內自行處理
  }
}
function renderRecentActivities(activities) {
  const container = document.getElementById('recentActivities');
  if (!activities || activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>目前沒有活動</p></div>';
    return;
  }
  container.innerHTML = activities.slice(0, 3).map(activity => `
    <div class="activity-item">
      <div class="activity-title">${escapeHTML(activity.title)}</div>
      <div class="activity-info">${escapeHTML(activity.description || '')}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(activity.date)}</span>
        <span class="status-badge status-${escapeHTML(activity.status)}">${escapeHTML(activity.status)}</span>
      </div>
    </div>
  `).join('');
}

// ==================== 活動 ====================
async function loadActivities() {
  try {
    const response = await callAPI('getActivities', {});
    const activities = response.data || [];
    const openActivities = activities.filter(a => a.status === '開放報名');
    renderActivitiesList(openActivities);

    const regResponse = await callAPI('getMyRegistrations', {});
    renderMyRegistrations(regResponse.data || []);
  } catch (error) {}
}
function renderActivitiesList(activities) {
  const container = document.getElementById('activitiesList');
  if (!activities || activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>目前沒有開放報名的活動</p></div>';
    return;
  }
  container.innerHTML = activities.map(activity => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${escapeHTML(activity.title)}</div>
        <span class="status-badge status-${escapeHTML(activity.status)}">${escapeHTML(activity.status)}</span>
      </div>
      <div class="activity-info">${escapeHTML(activity.description || '')}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(activity.date)} ${escapeHTML(activity.time || '')}</span>
        <span><i class="bi bi-geo-alt"></i>${escapeHTML(activity.location || '未指定')}</span>
        <span><i class="bi bi-people"></i>${Number(activity.currentCount || 0)}/${escapeHTML(activity.maxParticipants)}</span>
        ${activity.fee ? `<span><i class="bi bi-cash"></i>$${formatCurrency(activity.fee)}</span>` : ''}
      </div>
      <button class="btn btn-sm btn-gradient mt-2" onclick="registerActivity('${escapeAttr(activity.id)}')">
        <i class="bi bi-check-circle me-1"></i>我要報名
      </button>
    </div>
  `).join('');
}
function renderMyRegistrations(registrations) {
  const container = document.getElementById('myRegistrationsList');
  if (!registrations || registrations.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>您還沒有報名任何活動</p></div>';
    return;
  }
  container.innerHTML = registrations.map(reg => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${escapeHTML(reg.activityTitle)}</div>
        <span class="status-badge status-${escapeHTML(reg.status)}">${escapeHTML(reg.status)}</span>
      </div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(reg.registrationTime)}</span>
      </div>
      ${reg.status === '已報名' ? `
        <button class="btn btn-sm btn-outline-danger mt-2" onclick="cancelRegistration('${escapeAttr(reg.id)}')">
          <i class="bi bi-x-circle me-1"></i>取消報名
        </button>
      ` : ''}
    </div>
  `).join('');
}
async function registerActivity(activityId) {
  if (!confirm('確定要報名此活動嗎？')) return;
  try {
    showLoading(true);
    await callAPI('registerActivity', { activityId });
    showNotification('報名成功！', 'success');
    await loadActivities();
    await loadHomeData();
  } catch (error) {
    showNotification('報名失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}
async function cancelRegistration(registrationId) {
  if (!confirm('確定要取消報名嗎？')) return;
  try {
    showLoading(true);
    await callAPI('cancelRegistration', { registrationId });
    showNotification('已取消報名', 'success');
    await loadActivities();
    await loadHomeData();
  } catch (error) {
    showNotification('取消失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== 志工 ====================
async function loadVolunteerData() {
  try {
    const response = await callAPI('getVolunteerData', {});
    const data = response.data || {};
    document.getElementById('volTotalHours').textContent = data.stats?.totalHours || 0;
    document.getElementById('volTotalActivities').textContent = data.stats?.totalActivities || 0;
    renderVolunteerNeeds(data.needs || []);
    renderMyVolunteerRecords(data.records || []);
  } catch (error) {}
}
function renderVolunteerNeeds(needs) {
  const container = document.getElementById('volunteerNeedsList');
  if (!needs || needs.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-people"></i><p>目前沒有志工需求</p></div>';
    return;
  }
  container.innerHTML = needs.map(need => `
    <div class="activity-item">
      <div class="activity-title">${escapeHTML(need.title)}</div>
      <div class="activity-info">${escapeHTML(need.description || '')}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(need.date)} ${escapeHTML(need.time || '')}</span>
        <span><i class="bi bi-people"></i>需求：${escapeHTML(need.needCount)}人</span>
        <span><i class="bi bi-clock"></i>時數：${escapeHTML(need.hours)}小時</span>
        <span><i class="bi bi-check-circle"></i>已報名：${Number(need.currentCount || 0)}人</span>
      </div>
      <button class="btn btn-sm btn-gradient mt-2" onclick="applyVolunteer('${escapeAttr(need.id)}')">
        <i class="bi bi-hand-thumbs-up me-1"></i>我要報名
      </button>
    </div>
  `).join('');
}
function renderMyVolunteerRecords(records) {
  const container = document.getElementById('myVolunteerRecords');
  if (!records || records.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-journal-x"></i><p>您還沒有志工服務記錄</p></div>';
    return;
  }
  container.innerHTML = records.map(record => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${escapeHTML(record.title)}</div>
        <span class="status-badge status-${escapeHTML(record.status)}">${escapeHTML(record.status)}</span>
      </div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(record.date)}</span>
        <span><i class="bi bi-clock"></i>${escapeHTML(record.hours)}小時</span>
      </div>
    </div>
  `).join('');
}
async function applyVolunteer(needId) {
  if (!confirm('確定要報名此志工服務嗎？')) return;
  try {
    showLoading(true);
    await callAPI('applyVolunteer', { needId });
    showNotification('報名成功！', 'success');
    await loadVolunteerData();
  } catch (error) {
    showNotification('報名失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}
async function cancelVolunteer(recordId, needId) {
  if (!confirm('確定要取消此志工報名嗎？')) return;
  try {
    showLoading(true);
    await callAPI('cancelVolunteerApply', { recordId, needId });
    showNotification('已取消志工報名', 'success');
    await loadVolunteerData();
  } catch (e) {
    showNotification('取消失敗：' + (e.message || ''), 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== 財務 ====================
async function loadFinanceData() {
  try {
    const response = await callAPI('getFinanceData', {});
    const data = response.data || {};
    document.getElementById('finTotalDonation').textContent = '$' + formatCurrency(data.stats?.totalDonation || 0);
    document.getElementById('finPendingExpenses').textContent = data.stats?.pendingExpenses || 0;
    renderMyDonations(data.donations || []);
    renderMyExpenses(data.expenses || []);
  } catch (error) {}
}
function renderMyDonations(donations) {
  const container = document.getElementById('myDonationsList');
  if (!donations || donations.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-heart"></i><p>您還沒有捐款記錄</p></div>';
    return;
  }
  container.innerHTML = donations.map(donation => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="activity-title">$${formatCurrency(donation.amount)}</div>
          <div class="activity-info">${escapeHTML(donation.category || '一般捐款')}</div>
          <div class="activity-meta">
            <span><i class="bi bi-calendar"></i>${formatDate(donation.createdAt)}</span>
            <span class="status-badge status-${escapeHTML(donation.status)}">${escapeHTML(donation.status)}</span>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}
function renderMyExpenses(expenses) {
  const container = document.getElementById('myExpensesList');
  if (!expenses || expenses.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-receipt"></i><p>您還沒有支出申請</p></div>';
    return;
  }
  container.innerHTML = expenses.map(expense => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">$${formatCurrency(expense.amount)}</div>
        <span class="status-badge status-${escapeHTML(expense.status)}">${escapeHTML(expense.status)}</span>
      </div>
      <div class="activity-info">${escapeHTML(expense.description || '')}</div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(expense.createdAt)}</span>
        <span><i class="bi bi-tag"></i>${escapeHTML(expense.category)}</span>
      </div>
    </div>
  `).join('');
}

// ==================== 個人 ====================
async function loadProfileData() {
  try {
    const response = await callAPI('getUserInfo', {});
    const profile = response.data || {};
    const form = document.getElementById('profileForm');
    if (form && profile) {
      form.elements.realName.value = profile.realName || '';
      form.elements.memberType.value = profile.memberType || '';
      form.elements.phone.value = profile.phone || '';
      form.elements.email.value = profile.email || '';
      form.elements.birthday.value = formatDateInput(profile.birthday);
      form.elements.diagnosisDate.value = formatDateInput(profile.diagnosisDate);
      form.elements.address.value = profile.address || '';
    }
    document.getElementById('userMemberType').textContent = profile.memberType || '-';
    const receiptResponse = await callAPI('getMyReceipts', {});
    renderMyReceipts(receiptResponse.data || []);
  } catch (error) {}
}
function renderMyReceipts(receipts) {
  const container = document.getElementById('myReceiptsList');
  if (!receipts || receipts.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-file-earmark-text"></i><p>您還沒有收據</p></div>';
    return;
  }
  container.innerHTML = receipts.map(receipt => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="activity-title">${escapeHTML(receipt.receiptNumber)}</div>
          <div class="activity-meta">
            <span><i class="bi bi-cash"></i>金額：$${formatCurrency(receipt.amount)}</span>
            <span><i class="bi bi-calendar"></i>${formatDate(receipt.issueDate)}</span>
          </div>
        </div>
        ${receipt.pdfUrl ? `
          <button class="btn btn-sm btn-gradient" onclick="window.open('${escapeAttr(receipt.pdfUrl)}', '_blank')">
            <i class="bi bi-download"></i>下載
          </button>
        ` : ''}
      </div>
    </div>
  `).join('');
}

document.getElementById('profileForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = {
    realName: formData.get('realName'),
    memberType: formData.get('memberType'),
    phone: formData.get('phone'),
    email: formData.get('email'),
    birthday: formData.get('birthday'),
    diagnosisDate: formData.get('diagnosisDate'),
    address: formData.get('address')
  };
  const btn = e.target.querySelector('button[type="submit"]');
  setButtonLoading(btn, true);
  try {
    await callAPI('updateProfile', data);
    showNotification('資料已更新', 'success');
    await loadProfileData();
  } catch (error) {
    showNotification('更新失敗：' + error.message, 'error');
  } finally {
    setButtonLoading(btn, false);
  }
});

// ==================== 管理（舊簡版，保留相容） ====================
async function loadAdminData() {
  try {
    const response = await callAPI('getAdminData', {});
    cachedData.admin = response.data || {};
    renderMemberList(cachedData.admin.members || []);
    renderAdminActivityList(cachedData.admin.activities || []);
    renderTransactionList(cachedData.admin.transactions || []);
  } catch (error) {}
}
function renderMemberList(members) {
  const tbody = document.getElementById('memberList');
  if (!tbody) return;
  if (!members || members.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" class="text-center">沒有會員資料</td></tr>';
    return;
  }
  tbody.innerHTML = members.slice(0, 20).map(member => `
    <tr>
      <td>${escapeHTML(member.realName || member.lineName || '-')}</td>
      <td>${escapeHTML(member.memberType || '-')}</td>
      <td><span class="status-badge status-${escapeHTML(member.status)}">${escapeHTML(member.status || '-')}</span></td>
    </tr>
  `).join('');
}
function renderAdminActivityList(activities) {
  const container = document.getElementById('adminActivityList');
  if (!container) return;
  if (!activities || activities.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="bi bi-calendar-x"></i><p>沒有活動</p></div>';
    return;
  }
  container.innerHTML = activities.slice(0, 10).map(activity => `
    <div class="activity-item">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="activity-title">${escapeHTML(activity.title)}</div>
        <span class="status-badge status-${escapeHTML(activity.status)}">${escapeHTML(activity.status)}</span>
      </div>
      <div class="activity-meta">
        <span><i class="bi bi-calendar"></i>${formatDate(activity.date)}</span>
        <span><i class="bi bi-people"></i>${Number(activity.currentCount || 0)}/${escapeHTML(activity.maxParticipants)}</span>
      </div>
    </div>
  `).join('');
}
function renderTransactionList(transactions) {
  const tbody = document.getElementById('transactionList');
  if (!tbody) return;
  if (!transactions || transactions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="text-center">沒有交易記錄</td></tr>';
    return;
  }
  tbody.innerHTML = transactions.slice(0, 20).map(trans => `
    <tr>
      <td>${formatDate(trans.date)}</td>
      <td>${escapeHTML(trans.type)}</td>
      <td>$${formatCurrency(trans.amount)}</td>
      <td><span class="status-badge status-${escapeHTML(trans.status)}">${escapeHTML(trans.status)}</span></td>
    </tr>
  `).join('');
}

// 匯出/備份
async function exportMembers() {
  try {
    showLoading(true);
    const response = await callAPI('exportMembers', {});
    if (response.data?.fileUrl) {
      window.open(response.data.fileUrl, '_blank');
      showNotification('會員資料已匯出', 'success');
    }
  } catch (error) {
    showNotification('匯出失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}
async function exportFinanceData() {
  try {
    showLoading(true);
    const response = await callAPI('exportFinanceData', {});
    if (response.data?.donationUrl) {
      window.open(response.data.donationUrl, '_blank');
      setTimeout(() => {
        if (response.data?.expenseUrl) window.open(response.data.expenseUrl, '_blank');
      }, 500);
      showNotification('財務報表已匯出', 'success');
    }
  } catch (error) {
    showNotification('匯出失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}
async function backupSystem() {
  if (!confirm('確定要執行系統備份嗎？')) return;
  try {
    showLoading(true);
    await callAPI('backupSystem', {});
    showNotification('系統備份完成', 'success');
  } catch (error) {
    showNotification('備份失敗：' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== 前台 Modal ====================
function showDonationModal() {
  const html = `
    <div class="modal fade" id="donationModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="donationForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>我要捐款</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="number" class="form-control" name="amount" required min="1">
              <label>捐款金額 *</label>
            </div>
            <div class="form-floating mb-3">
              <select class="form-select" name="category">
                <option value="一般捐款">一般捐款</option>
                <option value="活動贊助">活動贊助</option>
              </select>
              <label>捐款類別</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" style="height:80px;"></textarea>
              <label>說明</label>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" name="needReceipt" id="needReceipt">
              <label class="form-check-label" for="needReceipt">需要收據</label>
            </div>
            <div class="alert alert-info small" role="alert">
              若您的電子郵件未填寫，收據將僅產生 PDF 供下載，不會寄送 Email。
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-gradient">確認捐款</button>
          </div>
        </form>
      </div>
    </div>
  `;
  showModal(html, async (formData) => {
    const data = {
      amount: formData.get('amount'),
      category: formData.get('category'),
      description: formData.get('description'),
      needReceipt: formData.get('needReceipt') === 'on'
    };
    const res = await callAPI('createDonation', data);
    showNotification('捐款記錄已新增，感謝您的支持！', 'success');
    if (res?.data?.pdfUrl) {
      showNotification('已產生收據 PDF，可於「我的收據」或按此通知下載。', 'info');
    }
    await loadFinanceData();
    await loadHomeData();
  });
}

function showNewExpenseModal() {
  const html = `
    <div class="modal fade" id="expenseModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="expenseForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>支出申請</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="number" class="form-control" name="amount" required min="1">
              <label>金額 *</label>
            </div>
            <div class="form-floating mb-3">
              <select class="form-select" name="category" required>
                <option value="">請選擇</option>
                <option value="活動費用">活動費用</option>
                <option value="行政支出">行政支出</option>
                <option value="設備支出">設備支出</option>
              </select>
              <label>類別 *</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" required style="height:100px;"></textarea>
              <label>說明 *</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-gradient">送出申請</button>
          </div>
        </form>
      </div>
    </div>
  `;
  showModal(html, async (formData) => {
    const data = {
      amount: formData.get('amount'),
      category: formData.get('category'),
      description: formData.get('description')
    };
    await callAPI('createExpense', data);
    showNotification('支出申請已送出', 'success');
    await loadFinanceData();
  });
}

function showNewActivityModal() {
  const html = `
    <div class="modal fade" id="activityModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <form class="modal-content" id="activityForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>新增活動</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="text" class="form-control" name="title" required>
              <label>活動名稱 *</label>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="date" class="form-control" name="date" required>
                  <label>日期 *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="time" class="form-control" name="time">
                  <label>時間</label>
                </div>
              </div>
            </div>
            <div class="form-floating mb-3">
              <input type="text" class="form-control" name="location">
              <label>地點</label>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="maxParticipants" required min="1">
                  <label>人數上限 *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="fee" min="0" value="0">
                  <label>費用</label>
                </div>
              </div>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" style="height:100px;"></textarea>
              <label>活動說明</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-gradient">新增活動</button>
          </div>
        </form>
      </div>
    </div>
  `;
  showModal(html, async (formData) => {
    const data = {
      title: formData.get('title'),
      date: formData.get('date'),
      time: formData.get('time'),
      location: formData.get('location'),
      maxParticipants: formData.get('maxParticipants'),
      fee: formData.get('fee') || 0,
      description: formData.get('description')
    };
    await callAPI('createActivity', data);
    showNotification('活動已新增', 'success');
    await loadAdminData();
    await loadActivities();
  });
}

function showNewVolunteerNeedModal() {
  const html = `
    <div class="modal fade" id="volunteerModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" id="volunteerForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-people me-2"></i>新增志工需求</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating mb-3">
              <input type="text" class="form-control" name="title" required>
              <label>需求名稱 *</label>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="date" class="form-control" name="date" required>
                  <label>日期 *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="time" class="form-control" name="time">
                  <label>時間</label>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="needCount" required min="1">
                  <label>需求人數 *</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-floating">
                  <input type="number" class="form-control" name="hours" required min="0.5" step="0.5">
                  <label>服務時數 *</label>
                </div>
              </div>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" name="description" style="height:100px;"></textarea>
              <label>說明</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-gradient">新增需求</button>
          </div>
        </form>
      </div>
    </div>
  `;
  showModal(html, async (formData) => {
    const data = {
      title: formData.get('title'),
      date: formData.get('date'),
      time: formData.get('time'),
      needCount: formData.get('needCount'),
      hours: formData.get('hours'),
      description: formData.get('description')
    };
    await callAPI('createVolunteerNeed', data);
    showNotification('志工需求已新增', 'success');
    await loadVolunteerData();
  });
}

// ==================== 工具與導覽 ====================
function switchPage(pageName, event) {
  // admin 權限保護
  if (pageName === 'admin' && !isAdmin) {
    showNotification('您沒有權限存取管理頁', 'error');
    return;
  }
  document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  document.getElementById(`page-${pageName}`).classList.add('active');
  if (event && event.currentTarget) event.currentTarget.classList.add('active');
  window.scrollTo({ top: 0, behavior: 'smooth' });

  if (pageName === 'admin') {
    // 初始化 admin 區
    const root = document.getElementById('adminApp');
    if (root && root.style.display !== 'block') {
      adminInit({ displayName: userProfile?.displayName, pictureUrl: userProfile?.pictureUrl });
    }
    // 恢復上次子頁
    try { adminSwitchPage(localStorage.getItem('adminSubPage') || 'dashboard'); } catch {}
  }
}

function formatDate(dateInput) {
  if (!dateInput) return '-';
  try {
    let d;
    if (dateInput instanceof Date) {
      d = dateInput;
    } else if (typeof dateInput === 'number') {
      d = new Date(dateInput);
    } else if (typeof dateInput === 'string') {
      const parsed = Date.parse(dateInput);
      d = isNaN(parsed) ? new Date(dateInput) : new Date(parsed);
    } else {
      return '-';
    }
    if (isNaN(d.getTime())) return '-';
    return d.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
  } catch {
    return '-';
  }
}
function formatDateInput(dateString) {
  if (!dateString) return '';
  try {
    const d = (dateString instanceof Date) ? dateString : new Date(dateString);
    if (isNaN(d.getTime())) return '';
    return d.toISOString().split('T')[0];
  } catch { return ''; }
}
function formatCurrency(amount) {
  return new Intl.NumberFormat('zh-TW').format(Number(amount || 0));
}
function showLoading(show) {
  let overlay = document.querySelector('.loading-overlay');
  if (show) {
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.innerHTML = '<div class="loading-spinner"></div>';
      document.body.appendChild(overlay);
    }
  } else {
    overlay?.remove();
  }
}
function setButtonLoading(button, loading) {
  if (!button) return;
  if (loading) {
    button.disabled = true;
    button.dataset.originalText = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>處理中...';
  } else {
    button.disabled = false;
    if (button.dataset.originalText) button.innerHTML = button.dataset.originalText;
  }
}
function showNotification(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const colors = { success: '#28a745', error: '#dc3545', warning: '#ffc107', info: '#17a2b8' };
  const icons = { success: 'check-circle-fill', error: 'x-circle-fill', warning: 'exclamation-triangle-fill', info: 'info-circle-fill' };
  const toast = document.createElement('div');
  toast.className = 'toast show';
  toast.style.cssText = `min-width: 250px; margin-bottom: 10px; background: white; border-left: 4px solid ${colors[type]}; box-shadow: 0 4px 12px rgba(0,0,0,0.15);`;
  toast.innerHTML = `
    <div class="toast-body d-flex align-items-center">
      <i class="bi bi-${icons[type]} me-2" style="color: ${colors[type]}; font-size: 18px;"></i>
      <div class="flex-grow-1" style="font-size: 14px;">${escapeHTML(message)}</div>
      <button type="button" class="btn-close ms-2" aria-label="Close"></button>
    </div>
  `;
  const closeBtn = toast.querySelector('.btn-close');
  closeBtn.addEventListener('click', () => toast.remove());
  container.appendChild(toast);
  setTimeout(() => {
    toast.classList.remove('show');
    toast.addEventListener('transitionend', () => toast.remove());
    toast.remove();
  }, 3000);
}
function showModal(html, onSubmit) {
  const container = document.getElementById('modalContainer');
  container.innerHTML = html;
  const modalEl = container.querySelector('.modal');
  const formEl = container.querySelector('form');
  const bsModal = new bootstrap.Modal(modalEl);
  if (formEl && typeof onSubmit === 'function') {
    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = formEl.querySelector('button[type="submit"]');
      setButtonLoading(submitBtn, true);
      try {
        const formData = new FormData(formEl);
        await onSubmit(formData);
        bsModal.hide();
      } catch (err) {
        showNotification(err.message || '操作失敗', 'error');
      } finally {
        setButtonLoading(submitBtn, false);
      }
    });
  }
  modalEl.addEventListener('hidden.bs.modal', () => {
    container.innerHTML = '';
  }, { once: true });
  bsModal.show();
}
function escapeHTML(str){ if(str==null) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function escapeAttr(str){ return escapeHTML(str).replace(/"/g,'&quot;'); }

// ==================== Admin App 腳本 ====================
async function adminInit(adminProfile){
  const root = document.getElementById('adminApp');
  if (!root) return;
  root.style.display='block';
  document.getElementById('adminLoading').style.display='block';
  document.querySelector('#adminApp .admin-layout').style.display='none';

  if(adminProfile){
    const nameEl = document.getElementById('adminDisplayName');
    const avatarEl = document.getElementById('adminDisplayAvatar');
    if(nameEl) nameEl.textContent = adminProfile.displayName || '管理員';
    if(avatarEl && adminProfile.pictureUrl) avatarEl.src = adminProfile.pictureUrl;
  }

  try{
    await adminLoadDashboard();
  }catch(e){
    console.error('Admin init failed:', e);
    showNotification('管理後台初始化失敗','error');
  }finally{
    document.getElementById('adminLoading').style.display='none';
    document.querySelector('#adminApp .admin-layout').style.display='flex';
  }
}

function adminSwitchPage(page, evt){
  document.querySelectorAll('#adminApp .admin-page').forEach(p=>p.classList.remove('active'));
  const target = document.getElementById('adminPage-'+page);
  if (target) target.classList.add('active');

  document.querySelectorAll('#adminApp .admin-menu-item').forEach(i=>i.classList.remove('active'));
  if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');
  document.getElementById('adminPageTitle').textContent = adminPageTitles[page] || '管理後台';

  switch(page){
    case 'dashboard': adminLoadDashboard(); break;
    case 'members': adminLoadMembers(); break;
    case 'activities': adminLoadActivities(); break;
    case 'registrations': adminLoadRegistrations(); break;
    case 'volunteers': adminLoadVolunteers(); break;
    case 'finance': adminLoadFinance(); break;
    case 'statistics': adminLoadStatistics(); break;
    case 'settings': adminLoadSettings(); break;
  }
  try{ localStorage.setItem('adminSubPage', page); }catch{}
}

const adminPageTitles = {
  dashboard: '儀表板', members:'會員管理', activities:'活動管理',
  registrations:'報名管理', volunteers:'志工管理', finance:'財務管理',
  statistics:'統計報表', settings:'系統設定'
};

// 儀表板
async function adminLoadDashboard(){
  let res;
  try{
    res = await callAPI('getAdminDashboard', {});
  }catch(e){
    const all = await callAPI('getAdminData', {});
    const d = all.data || {};
    const totalMembers = (d.members||[]).length;
    const totalActivities = (d.activities||[]).filter(a=>a.status==='開放報名' || a.status==='報名中').length;
    const volunteerHours = 0;
    const balance = 0;
    setText('admStatTotalMembers', totalMembers);
    setText('admStatNewMembers', 0);
    setText('admStatTotalActivities', totalActivities);
    setText('admStatActiveActivities', totalActivities);
    setText('admStatVolunteerHours', volunteerHours);
    setText('admStatBalance', '$'+(balance.toLocaleString()));
    adminRenderRecentActivities((d.activities||[]).slice(0,5).map(a=>({ title:a.title, type:a.type||'-', date:a.date, currentParticipants:a.currentCount, maxParticipants:a.maxParticipants, status: a.status==='開放報名'?'報名中':a.status })));
    adminDrawMemberGrowth([]);
    adminDrawMemberType({});
    return;
  }
  if(!res || !res.success) return;
  const d = res.data || {};
  setText('admStatTotalMembers', d.totalMembers||0);
  setText('admStatNewMembers', d.newMembers||0);
  setText('admStatTotalActivities', d.totalActivities||0);
  setText('admStatActiveActivities', d.activeActivities||0);
  setText('admStatVolunteerHours', d.volunteerHours||0);
  setText('admStatBalance', '$'+((d.balance||0).toLocaleString()));
  adminRenderRecentActivities(d.recentActivities||[]);
  adminDrawMemberGrowth(d.memberGrowth||[]);
  adminDrawMemberType(d.memberTypes||{});
}

function adminRenderRecentActivities(list){
  const c = document.getElementById('admRecentActivities');
  if(!list || !list.length){
    c.innerHTML = '<div class="admin-empty"><i class="bi bi-inbox"></i><p>目前沒有近期活動</p></div>';
    return;
  }
  c.innerHTML = `
    <div class="table-responsive">
      <table class="table table-hover">
        <thead><tr><th>活動名稱</th><th>類型</th><th>日期</th><th>報名人數</th><th>狀態</th></tr></thead>
        <tbody>
          ${list.map(a=>`
            <tr>
              <td>${escapeHTML(a.title)}</td>
              <td>${escapeHTML(a.type||'-')}</td>
              <td>${formatDate(a.date)}</td>
              <td>${Number(a.currentParticipants||0)}/${a.maxParticipants||'不限'}</td>
              <td><span class="badge ${badgeClassByStatus(a.status)}">${safeStatus(a.status)}</span></td>
            </tr>`).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function adminDrawMemberGrowth(rows){
  const el = document.getElementById('admMemberGrowthChart');
  if(!el) return;
  const labels = rows.length? rows.map(r=>r.month): ['1月','2月','3月','4月','5月','6月'];
  const data = rows.length? rows.map(r=>r.count): [10,15,22,28,35,42];
  if (admCharts.memberGrowth) { admCharts.memberGrowth.destroy(); }
  admCharts.memberGrowth = new Chart(el, {
    type:'line',
    data:{ labels, datasets:[{ label:'會員數', data, borderColor:'#00B900', backgroundColor:'rgba(0,185,0,0.1)', tension:.4, fill:true }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });
}

function adminDrawMemberType(map){
  const el = document.getElementById('admMemberTypeChart');
  if(!el) return;
  const labels = Object.keys(map).length? Object.keys(map): ['病友','家屬','志工','其他'];
  const data = Object.keys(map).length? Object.values(map): [45,30,15,10];
  if (admCharts.memberType) { admCharts.memberType.destroy(); }
  admCharts.memberType = new Chart(el, {
    type:'doughnut',
    data:{ labels, datasets:[{ data, backgroundColor:['#00B900','#06C755','#4CAF50','#8BC34A'] }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
  });
}

// 會員管理
async function adminLoadMembers(){
  let res;
  try{
    res = await callAPI('getAllMembers', {});
    if(res && res.success){
      admMembers = res.data || [];
    }
  }catch(e){
    const all = await callAPI('getAdminData', {});
    admMembers = (all.data?.members||[]).map(m=>({
      id: m.lineId, realName: m.realName || m.lineName || '-', memberType: m.memberType || '一般會員',
      phone: m.phone, email: m.email, joinDate: m.joinDate, lineUserId: m.lineId
    }));
  }
  adminRenderMembers(admMembers);
}

function adminRenderMembers(list){
  const tb = document.getElementById('admMembersTbody');
  if(!list || !list.length){ setTbodyEmpty('admMembersTbody', 7); return; }
  tb.innerHTML = list.map(m=>`
    <tr>
      <td>${escapeHTML(m.id || '-')}</td>
      <td>${escapeHTML(m.realName || m.lineDisplayName || '-')}</td>
      <td><span class="badge bg-info text-dark">${escapeHTML(m.memberType || '一般會員')}</span></td>
      <td>${escapeHTML(m.phone || '-')}</td>
      <td>${escapeHTML(m.email || '-')}</td>
      <td>${formatDate(m.joinDate)}</td>
      <td><button class="btn btn-sm btn-primary" onclick="adminShowMemberDetail('${escapeAttr(m.lineUserId||m.id||'')}')"><i class="bi bi-eye"></i></button></td>
    </tr>
  `).join('');
}

document.addEventListener('input', (e)=>{
  if(e.target && e.target.id==='admMemberSearch'){
    const kw = e.target.value.trim().toLowerCase();
    const filtered = admMembers.filter(m=>{
      return [m.realName,m.lineDisplayName,m.phone,m.email].some(v=> (v||'').toString().toLowerCase().includes(kw));
    });
    adminRenderMembers(filtered);
  }
});

async function adminShowMemberDetail(lineUserId){
  let res;
  try{
    res = await callAPI('getMemberProfile', { lineUserId });
  }catch(e){
    const m = admMembers.find(x => x.lineUserId===lineUserId || x.id===lineUserId) || {};
    renderMemberDetailModal(m);
    new bootstrap.Modal(document.getElementById('admMemberDetailModal')).show();
    return;
  }
  if(!res || !res.success){ showNotification('載入失敗','error'); return; }
  renderMemberDetailModal(res.data||{});
  new bootstrap.Modal(document.getElementById('admMemberDetailModal')).show();
}
function renderMemberDetailModal(m){
  const html = `
    <div class="row g-3">
      <div class="col-md-6"><strong>會員編號：</strong> ${escapeHTML(m.id||'-')}</div>
      <div class="col-md-6"><strong>真實姓名：</strong> ${escapeHTML(m.realName||'-')}</div>
      <div class="col-md-6"><strong>LINE 名稱：</strong> ${escapeHTML(m.lineDisplayName||m.lineName||'-')}</div>
      <div class="col-md-6"><strong>會員類型：</strong> ${escapeHTML(m.memberType||'-')}</div>
      <div class="col-md-6"><strong>性別：</strong> ${escapeHTML(m.gender||'-')}</div>
      <div class="col-md-6"><strong>生日：</strong> ${formatDate(m.birthday)||'-'}</div>
      <div class="col-md-6"><strong>電話：</strong> ${escapeHTML(m.phone||'-')}</div>
      <div class="col-md-6"><strong>Email：</strong> ${escapeHTML(m.email||'-')}</div>
      <div class="col-12"><strong>地址：</strong> ${escapeHTML(m.address||'-')}</div>
      <div class="col-12"><strong>疾病狀態：</strong> ${escapeHTML(m.diseaseStatus||'-')}</div>
      <div class="col-md-6"><strong>確診日期：</strong> ${formatDate(m.diagnosisDate)||'-'}</div>
      <div class="col-md-6"><strong>加入日期：</strong> ${formatDate(m.joinDate)||'-'}</div>
      <div class="col-md-6"><strong>緊急聯絡人：</strong> ${escapeHTML(m.emergencyContact||'-')}</div>
      <div class="col-md-6"><strong>緊急聯絡電話：</strong> ${escapeHTML(m.emergencyPhone||'-')}</div>
    </div>`;
  document.getElementById('admMemberDetailContent').innerHTML = html;
}

// 活動管理
async function adminLoadActivities(){
  let res;
  try{
    res = await callAPI('getAllActivities', {});
  }catch(e){
    const r2 = await callAPI('getActivities', {});
    admActivities = (r2.data||[]).map(a=>({
      id:a.id, title:a.title, type:a.type||'-', date:a.date, location:a.location,
      currentParticipants:a.currentCount, maxParticipants:a.maxParticipants, status: a.status==='開放報名'?'報名中':a.status
    }));
    adminRenderActivities(admActivities);
    return;
  }
  if(!res || !res.success){ setTbodyEmpty('admActivitiesTbody', 8); return; }
  admActivities = res.data || [];
  adminRenderActivities(admActivities);
}

function adminRenderActivities(list){
  const tb = document.getElementById('admActivitiesTbody');
  if(!list || !list.length){ setTbodyEmpty('admActivitiesTbody', 8); return; }
  tb.innerHTML = list.map(a=>`
    <tr>
      <td>${escapeHTML(a.id||'-')}</td>
      <td>${escapeHTML(a.title||'-')}</td>
      <td><span class="badge bg-info text-dark">${escapeHTML(a.type||'-')}</span></td>
      <td>${formatDate(a.date)}</td>
      <td>${escapeHTML(a.location||'-')}</td>
      <td>${Number(a.currentParticipants||a.currentCount||0)}/${a.maxParticipants||'不限'}</td>
      <td><span class="badge ${badgeClassByStatus(a.status)}">${safeStatus(a.status)}</span></td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="adminEditActivity('${escapeAttr(a.id||'')}')"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-danger" onclick="adminDeleteActivity('${escapeAttr(a.id||'')}')"><i class="bi bi-trash"></i></button>
      </td>
    </tr>
  `).join('');
}

function adminShowAddActivity(){
  document.getElementById('admAddActivityForm').reset();
  new bootstrap.Modal(document.getElementById('admAddActivityModal')).show();
}

async function adminSubmitActivity(){
  const f = document.getElementById('admAddActivityForm');
  if(!f.checkValidity()){ f.reportValidity(); return; }
  const payload = {
    title: gv('admActTitle'),
    type: gv('admActType'),
    date: gv('admActDate'),
    time: gv('admActTime'),
    location: gv('admActLocation'),
    fee: parseFloat(gv('admActFee'))||0,
    maxParticipants: parseInt(gv('admActMaxParticipants'))||0,
    registrationDeadline: gv('admActDeadline'),
    description: gv('admActDescription'),
    note: gv('admActNote'),
    status: gv('admActStatus')
  };
  let ok=false, res=null;
  try{
    res = await callAPI('addActivity', { activityData: payload });
    ok = !!(res && res.success);
  }catch{}
  if(!ok){
    const alt = {
      title: payload.title, date: payload.date, time: payload.time,
      location: payload.location, maxParticipants: payload.maxParticipants||1,
      fee: payload.fee, description: payload.description
    };
    res = await callAPI('createActivity', alt);
    ok = !!(res && res.success);
  }
  if(ok){
    showNotification('活動新增成功','success');
    bootstrap.Modal.getInstance(document.getElementById('admAddActivityModal')).hide();
    adminLoadActivities(); adminLoadDashboard();
  }else{
    showNotification('新增失敗','error');
  }
}

async function adminEditActivity(id){
  let res;
  try{
    res = await callAPI('getActivityById', id);
  }catch(e){
    const a = admActivities.find(x=>x.id===id) || {};
    admCurrentEditActivityId = id;
    sv('admEditActId', id);
    sv('admEditActTitle', a.title||'');
    sv('admEditActType', a.type||'');
    sv('admEditActDate', a.date||'');
    sv('admEditActTime', a.time||'');
    sv('admEditActLocation', a.location||'');
    sv('admEditActFee', a.fee||0);
    sv('admEditActMaxParticipants', a.maxParticipants||0);
    sv('admEditActDeadline', a.registrationDeadline||'');
    sv('admEditActDescription', a.description||'');
    sv('admEditActNote', a.note||'');
    sv('admEditActStatus', a.status||'報名中');
    new bootstrap.Modal(document.getElementById('admEditActivityModal')).show();
    return;
  }
  if(!res || !res.success){ showNotification('載入失敗','error'); return; }
  const a = res.data||{};
  admCurrentEditActivityId = id;
  sv('admEditActId', id);
  sv('admEditActTitle', a.title||'');
  sv('admEditActType', a.type||'');
  sv('admEditActDate', a.date||'');
  sv('admEditActTime', a.time||'');
  sv('admEditActLocation', a.location||'');
  sv('admEditActFee', a.fee||0);
  sv('admEditActMaxParticipants', a.maxParticipants||0);
  sv('admEditActDeadline', a.registrationDeadline||'');
  sv('admEditActDescription', a.description||'');
  sv('admEditActNote', a.note||'');
  sv('admEditActStatus', a.status||'報名中');
  new bootstrap.Modal(document.getElementById('admEditActivityModal')).show();
}

async function adminUpdateActivity(){
  const f = document.getElementById('admEditActivityForm');
  if(!f.checkValidity()){ f.reportValidity(); return; }
  const data = {
    title: gv('admEditActTitle'), type: gv('admEditActType'),
    date: gv('admEditActDate'), time: gv('admEditActTime'),
    location: gv('admEditActLocation'), fee: parseFloat(gv('admEditActFee'))||0,
    maxParticipants: parseInt(gv('admEditActMaxParticipants'))||0,
    registrationDeadline: gv('admEditActDeadline'),
    description: gv('admEditActDescription'), note: gv('admEditActNote'),
    status: gv('admEditActStatus')
  };
  let ok=false;
  try{
    const res = await callAPI('updateActivity', { activityId: admCurrentEditActivityId, ...data });
    ok = res && res.success;
  }catch(e){}
  if(ok){
    showNotification('活動更新成功','success');
    bootstrap.Modal.getInstance(document.getElementById('admEditActivityModal')).hide();
    adminLoadActivities(); adminLoadDashboard();
  }else{
    showNotification('更新失敗','error');
  }
}

async function adminDeleteActivity(id){
  if(!confirm('確定要刪除此活動嗎？此操作無法復原。')) return;
  let ok=false;
  try{
    const res = await callAPI('deleteActivity', { activityId: id });
    ok = res && res.success;
  }catch(e){
    try{
      const res2 = await callAPI('updateActivity', { activityId: id, status: '已刪除' });
      ok = res2 && res2.success;
    }catch{}
  }
  if(ok){
    showNotification('活動已刪除','success');
    adminLoadActivities(); adminLoadDashboard();
  }else{
    showNotification('刪除失敗','error');
  }
}

// 報名管理
async function adminLoadRegistrations(){
  let res;
  try{
    res = await callAPI('getAllRegistrations', {});
    admRegistrations = res?.data || [];
  }catch(e){
    admRegistrations = [];
  }
  const tb = document.getElementById('admRegistrationsTbody');
  if(!admRegistrations.length){ setTbodyEmpty('admRegistrationsTbody', 6); return; }
  tb.innerHTML = admRegistrations.map(r=>`
    <tr>
      <td>${escapeHTML(r.id||'-')}</td>
      <td>${escapeHTML(r.memberName||'-')}</td>
      <td>${escapeHTML(r.activityTitle||'-')}</td>
      <td>${formatDateTimeSafe(r.registeredAt||r.registrationTime)}</td>
      <td><span class="badge ${r.status==='已報名'?'bg-success':'bg-secondary'}">${escapeHTML(r.status||'-')}</span></td>
      <td>${r.status==='已報名'? `<button class="btn btn-sm btn-danger" onclick="adminCancelRegistration('${escapeAttr(r.id||'')}')"><i class="bi bi-x-circle"></i> 取消</button>` : '-'}</td>
    </tr>
  `).join('');
}

async function adminCancelRegistration(id){
  if(!confirm('確定要取消此報名嗎？')) return;
  let ok=false;
  try{
    const res = await callAPI('cancelRegistrationAdmin', { registrationId: id });
    ok = res && res.success;
  }catch(e){
    showNotification('後端尚未提供 cancelRegistrationAdmin，請於活動或使用者端處理','warning');
  }
  if(ok){ showNotification('已取消報名','success'); adminLoadRegistrations(); adminLoadDashboard();}
}

// 志工管理
async function adminLoadVolunteers(){
  let res;
  try{
    res = await callAPI('getAllVolunteerRecords', {});
    admVolunteers = res?.data || [];
  }catch(e){
    admVolunteers = [];
  }
  const tb = document.getElementById('admVolunteersTbody');
  if(!admVolunteers.length){ setTbodyEmpty('admVolunteersTbody', 7); return; }
  tb.innerHTML = admVolunteers.map(v=>`
    <tr>
      <td>${escapeHTML(v.id||'-')}</td>
      <td>${escapeHTML(v.memberName||'-')}</td>
      <td>${formatDate(v.date)}</td>
      <td>${Number(v.hours||0)} 小時</td>
      <td>${escapeHTML(v.activity||v.title||'-')}</td>
      <td><span class="badge ${volBadgeClass(v.status)}">${safeVolunteerStatus(v.status)}</span></td>
      <td>
        ${v.status==='待審核' ? `
          <button class="btn btn-sm btn-success" onclick="adminApproveVolunteer('${escapeAttr(v.id||'')}')"><i class="bi bi-check"></i></button>
          <button class="btn btn-sm btn-danger" onclick="adminRejectVolunteer('${escapeAttr(v.id||'')}')"><i class="bi bi-x"></i></button>` : '-'}
      </td>
    </tr>
  `).join('');
}

async function adminApproveVolunteer(id){
  let ok=false;
  try{
    const res = await callAPI('approveVolunteerRecord', { recordId: id });
    ok = res && res.success;
  }catch(e){
    showNotification('後端尚未提供 approveVolunteerRecord','warning');
  }
  if(ok){ showNotification('已核准志工記錄','success'); adminLoadVolunteers(); adminLoadDashboard();}
}

async function adminRejectVolunteer(id){
  if(!confirm('確定要拒絕此志工記錄嗎？')) return;
  let ok=false;
  try{
    const res = await callAPI('rejectVolunteerRecord', { recordId: id });
    ok = res && res.success;
  }catch(e){
    showNotification('後端尚未提供 rejectVolunteerRecord','warning');
  }
  if(ok){ showNotification('已拒絕志工記錄','success'); adminLoadVolunteers();}
}

// 財務管理
async function adminLoadFinance(){
  const res = await callAPI('getFinanceData', {});
  const d = res?.data || {};
  setText('admFinIncome', '$'+((d.adminStats?.totalIncome||0).toLocaleString()));
  setText('admFinExpense', '$'+((d.adminStats?.totalExpense||0).toLocaleString()));
  setText('admFinBalance', '$'+((d.adminStats?.currentBalance||0).toLocaleString()));
  adminRenderDonations(d.donations||[]);
  adminRenderExpenses(d.expenses||[]);
}

function adminRenderDonations(list){
  const tb = document.getElementById('admDonationsTbody');
  if(!list || !list.length){ setTbodyEmpty('admDonationsTbody', 4); return; }
  tb.innerHTML = list.map(x=>`
    <tr>
      <td>${escapeHTML(x.donor || x.lineId || '-')}</td>
      <td class="text-success">$${Number(x.amount||0).toLocaleString()}</td>
      <td>${formatDate(x.createdAt || x.date)}</td>
      <td><span class="badge bg-info text-dark">${escapeHTML(x.method||x.category||'-')}</span></td>
    </tr>
  `).join('');
}

function adminRenderExpenses(list){
  const tb = document.getElementById('admExpensesTbody');
  if(!list || !list.length){ setTbodyEmpty('admExpensesTbody', 5); return; }
  tb.innerHTML = list.map(x=>`
    <tr>
      <td>${escapeHTML(x.item||x.description||'-')}</td>
      <td class="text-danger">$${Number(x.amount||0).toLocaleString()}</td>
      <td>${formatDate(x.date || x.createdAt)}</td>
      <td><span class="badge ${x.status==='已核銷' || x.status==='已核准' ? 'bg-success':'bg-warning text-dark'}">${escapeHTML(x.status||'-')}</span></td>
      <td>${x.status==='審核中' ? `<button class="btn btn-sm btn成功" onclick="adminApproveExpense('${escapeAttr(x.id||'')}')"><i class="bi bi-check"></i></button>` : '-'}</td>
    </tr>
  `).join('');
}

function adminShowAddDonation(){
  document.getElementById('admAddDonationForm').reset();
  document.getElementById('admDonDate').valueAsDate = new Date();
  new bootstrap.Modal(document.getElementById('admAddDonationModal')).show();
}

async function adminSubmitDonation(){
  const f = document.getElementById('admAddDonationForm');
  if(!f.checkValidity()){ f.reportValidity(); return; }
  const payload = {
    donationData:{
      donor: gv('admDonDonor'),
      amount: parseFloat(gv('admDonAmount')),
      date: gv('admDonDate'),
      method: gv('admDonMethod'),
      note: gv('admDonNote')
    }
  };
  let ok=false;
  try{
    const res = await callAPI('addDonation', payload);
    ok = res && res.success;
  }catch(e){
    showNotification('後端尚未提供 addDonation','warning');
  }
  if(ok){
    showNotification('捐款記錄已新增','success');
    bootstrap.Modal.getInstance(document.getElementById('admAddDonationModal')).hide();
    adminLoadFinance(); adminLoadDashboard();
  }
}

function adminShowAddExpense(){
  document.getElementById('admAddExpenseForm').reset();
  document.getElementById('admExpDate').valueAsDate = new Date();
  new bootstrap.Modal(document.getElementById('admAddExpenseModal')).show();
}

async function adminSubmitExpense(){
  const f = document.getElementById('admAddExpenseForm');
  if(!f.checkValidity()){ f.reportValidity(); return; }
  const payload = {
    expenseData:{
      item: gv('admExpItem'),
      amount: parseFloat(gv('admExpAmount')),
      date: gv('admExpDate'),
      category: gv('admExpCategory'),
      note: gv('admExpNote'),
      status: '已核銷'
    }
  };
  let ok=false;
  try{
    const res = await callAPI('addExpense', payload);
    ok = res && res.success;
  }catch(e){
    showNotification('後端尚未提供 addExpense','warning');
  }
  if(ok){
    showNotification('支出記錄已新增','success');
    bootstrap.Modal.getInstance(document.getElementById('admAddExpenseModal')).hide();
    adminLoadFinance(); adminLoadDashboard();
  }
}

async function adminApproveExpense(id){
  let ok=false;
  try{
    const res = await callAPI('approveExpense', { expenseId: id });
    ok = res && res.success;
  }catch(e){
    try{
      const res2 = await callAPI('approveExpenseWithPayment', { expenseId: id, decision:'approve', paymentInfo:{} });
      ok = res2 && res2.success;
    }catch{}
  }
  if(ok){ showNotification('已核銷','success'); adminLoadFinance(); }
  else{ showNotification('核銷失敗','error'); }
}

// 統計
async function adminLoadStatistics(){
  let res;
  try{
    res = await callAPI('getStatistics', {});
  }catch(e){
    const all = await callAPI('getAdminData', {});
    const acts = all.data?.activities || [];
    const actTypeMap = {};
    acts.forEach(a=>{ const t=a.type||'其他'; actTypeMap[t]=(actTypeMap[t]||0)+1; });
    adminDrawActivityType(actTypeMap);
    adminDrawVolunteerStats([]);
    return;
  }
  if(!res || !res.success) return;
  const d = res.data||{};
  adminDrawActivityType(d.activityTypes||{});
  adminDrawVolunteerStats(d.volunteerStats||[]);
}

function adminDrawActivityType(map){
  const el = document.getElementById('admActivityTypeChart');
  if(!el) return;
  const labels = Object.keys(map).length? Object.keys(map): ['健康講座','復健課程','社交活動','志工培訓'];
  const data = Object.keys(map).length? Object.values(map): [8,5,12,3];
  if (admCharts.actType) admCharts.actType.destroy();
  admCharts.actType = new Chart(el, {
    type:'bar',
    data:{ labels, datasets:[{ label:'活動數量', data, backgroundColor:['#00B900','#06C755','#4CAF50','#8BC34A'] }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
}

function adminDrawVolunteerStats(rows){
  const el = document.getElementById('admVolunteerStatsChart');
  if(!el) return;
  const labels = rows.length? rows.map(r=>r.month): ['1月','2月','3月','4月','5月','6月'];
  const data = rows.length? rows.map(r=>r.hours): [20,35,28,42,38,50];
  if (admCharts.volStats) admCharts.volStats.destroy();
  admCharts.volStats = new Chart(el, {
    type:'line',
    data:{ labels, datasets:[{ label:'服務時數', data, borderColor:'#00B900', backgroundColor:'rgba(0,185,0,0.1)', tension:.4, fill:true }]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}} }
  });
}

// 設定與管理員
async function adminLoadSettings(){
  let s = {};
  try{
    const res = await callAPI('getSettings', {});
    if(res && res.success) s = res.data||{};
  }catch(e){
    s = { orgName:'台灣帕金森病友會', phone:'', email:'', address:'', lineNotifyToken:'' };
  }
  sv('admSetOrgName', s.orgName||'台灣帕金森病友會');
  sv('admSetPhone', s.phone||'');
  sv('admSetEmail', s.email||'');
  sv('admSetAddress', s.address||'');
  sv('admSetLineNotifyToken', s.lineNotifyToken||'');
  await adminLoadAdmins();
}

document.addEventListener('submit', async (e)=>{
  if(e.target && e.target.id==='admSettingsForm'){
    e.preventDefault();
    const settings = {
      orgName: gv('admSetOrgName'),
      phone: gv('admSetPhone'),
      email: gv('admSetEmail'),
      address: gv('admSetAddress'),
      lineNotifyToken: gv('admSetLineNotifyToken')
    };
    let ok=false;
    try{
      const res = await callAPI('updateSettings', { settings });
      ok = res && res.success;
    }catch(e){
      showNotification('後端尚未提供 updateSettings','warning');
    }
    if(ok) showNotification('設定已儲存','success');
    else showNotification('儲存失敗','error');
  }
});

async function adminLoadAdmins(){
  let list=[];
  try{
    const res = await callAPI('getAdmins', {});
    if(res && res.success) list = res.data||[];
  }catch(e){
    if(cachedData?.admin?.members){
      list = cachedData.admin.members.filter(m=>m.isAdmin).map(m=>({
        name: m.realName||m.lineName||'-', lineUserId: m.lineId, role: '管理員', createdAt: m.joinDate
      }));
    }
  }
  const tb = document.getElementById('admAdminsTbody');
  if(!list.length){ setTbodyEmpty('admAdminsTbody', 5); return; }
  tb.innerHTML = list.map(a=>`
    <tr>
      <td>${escapeHTML(a.name||'-')}</td>
      <td>${escapeHTML(a.lineUserId||'-')}</td>
      <td><span class="badge bg-warning text-dark">${escapeHTML(a.role||'-')}</span></td>
      <td>${formatDate(a.createdAt)}</td>
      <td><button class="btn btn-sm btn-danger" onclick="adminDeleteAdmin('${escapeAttr(a.lineUserId||'')}')"><i class="bi bi-trash"></i></button></td>
    </tr>
  `).join('');
}

function adminShowAddAdmin(){
  document.getElementById('admAddAdminForm').reset();
  new bootstrap.Modal(document.getElementById('admAddAdminModal')).show();
}

async function adminSubmitAdmin(){
  const f = document.getElementById('admAddAdminForm');
  if(!f.checkValidity()){ f.reportValidity(); return; }
  const adminData = { lineUserId: gv('admAdminLineUserId'), name: gv('admAdminName'), role: gv('admAdminRole') };
  let ok=false;
  try{
    const res = await callAPI('addAdmin', { adminData });
    ok = res && res.success;
  }catch(e){
    showNotification('後端尚未提供 addAdmin','warning');
  }
  if(ok){
    showNotification('管理員已新增','success');
    bootstrap.Modal.getInstance(document.getElementById('admAddAdminModal')).hide();
    adminLoadAdmins();
  }
}

async function adminDeleteAdmin(lineUserId){
  if(!confirm('確定要刪除此管理員嗎？')) return;
  let ok=false;
  try{
    const res = await callAPI('deleteAdmin', { lineUserId });
    ok = res && res.success;
  }catch(e){
    showNotification('後端尚未提供 deleteAdmin','warning');
  }
  if(ok){ showNotification('管理員已刪除','success'); adminLoadAdmins(); }
}

// 工具（Admin）
function gv(id){ return (document.getElementById(id)?.value||'').trim(); }
function sv(id,v){ const el=document.getElementById(id); if(el) el.value=v; }
function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent=v; }
function setTbodyEmpty(id, cols){ const el=document.getElementById(id); if(el) el.innerHTML = `<tr><td colspan="${cols}" class="text-center text-muted">沒有資料</td></tr>`; }
function formatDateTimeSafe(s){ if(!s) return '-'; const d=new Date(s); if(isNaN(d)) return '-'; return d.toLocaleString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}); }
function safeStatus(st){ const allow=['報名中','已額滿','已結束','已取消','開放報名']; return allow.includes(st)? st:(st==='開放報名'?'報名中':'已結束'); }
function badgeClassByStatus(st){ const map={ '報名中':'bg-success', '開放報名':'bg-success', '已額滿':'bg-warning text-dark', '已結束':'bg-secondary', '已取消':'bg-danger' }; return map[st]||'bg-info'; }
function safeVolunteerStatus(st){ const allow=['待審核','已審核','已拒絕','已報名','已完成']; return allow.includes(st)? st:'待審核'; }
function volBadgeClass(st){ const map={ '待審核':'bg-warning text-dark', '已審核':'bg成功', '已完成':'bg-success', '已拒絕':'bg-danger', '已報名':'bg-primary' }; return map[st]||'bg-secondary'; }

// ==================== 啟動 ====================
document.addEventListener('DOMContentLoaded', () => {
  initLIFF();
});
</script>
</body>
</html>
