<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸•é‡‘æ£®ç—…å‹å”æœƒ - æœƒå“¡ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      padding-bottom: 70px;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .header p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 15px;
    }
    
    .nav-tabs {
      display: flex;
      background: white;
      border-radius: 10px;
      padding: 5px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .nav-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
      color: #666;
    }
    
    .nav-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .card-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 2px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .info-row:last-child {
      border-bottom: none;
    }
    
    .info-label {
      color: #666;
      font-size: 14px;
    }
    
    .info-value {
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }
    
    .member-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 15px;
    }
    
    .member-id {
      font-size: 16px;
      margin-bottom: 15px;
      opacity: 0.9;
    }
    
    .qr-code {
      background: white;
      padding: 15px;
      border-radius: 10px;
      display: inline-block;
      margin-top: 10px;
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:active {
      transform: scale(0.98);
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #666;
    }
    
    .btn-danger {
      background: #ff4757;
      color: white;
    }
    
    .activity-item {
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .activity-item:hover {
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    .activity-title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    
    .activity-info {
      font-size: 13px;
      color: #666;
      margin: 5px 0;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .stat-box {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      margin-bottom: 15px;
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      animation: fadeIn 0.3s;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 25px;
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;
      animation: slideUp 0.3s;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }
    
    .modal-close {
      float: right;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 14px;
      z-index: 2000;
      animation: slideUp 0.3s;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸŒŸ å¸•é‡‘æ£®ç—…å‹å”æœƒ</h1>
    <p id="memberName">è¼‰å…¥ä¸­...</p>
  </div>

  <div class="container">
    <div class="nav-tabs">
      <div class="nav-tab active" onclick="switchTab('dashboard')">é¦–é </div>
      <div class="nav-tab" onclick="switchTab('profile')">å€‹äºº</div>
      <div class="nav-tab" onclick="switchTab('activities')">æ´»å‹•</div>
      <div class="nav-tab" onclick="switchTab('volunteer')">å¿—å·¥</div>
    </div>

    <!-- é¦–é  -->
    <div id="dashboard" class="tab-content active">
      <div class="member-card">
        <div class="member-id">æœƒå“¡ç·¨è™Ÿï¼š<span id="memberIdDisplay">-</span></div>
        <div class="qr-code">
          <div id="qrcode"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">å¿«é€ŸåŠŸèƒ½</div>
        <button class="btn btn-primary" onclick="switchTab('activities')">ğŸ“… ç€è¦½æ´»å‹•</button>
        <button class="btn btn-primary" onclick="switchTab('volunteer')">ğŸ¤ ç™»è¨˜å¿—å·¥æœå‹™</button>
        <button class="btn btn-secondary" onclick="viewDonations()">ğŸ’° æŸ¥çœ‹ææ¬¾è¨˜éŒ„</button>
      </div>

      <div class="card">
        <div class="card-title">æœ€æ–°æ´»å‹•</div>
        <div id="recentActivities"></div>
      </div>
    </div>

    <!-- å€‹äººè³‡æ–™ -->
    <div id="profile" class="tab-content">
      <div class="card">
        <div class="card-title">å€‹äººè³‡æ–™</div>
        <div id="profileInfo"></div>
        <button class="btn btn-primary" onclick="editProfile()">ç·¨è¼¯è³‡æ–™</button>
      </div>

      <div class="card">
        <div class="card-title">æˆ‘çš„çµ±è¨ˆ</div>
        <div class="info-row">
          <span class="info-label">åƒåŠ æ´»å‹•æ¬¡æ•¸</span>
          <span class="info-value" id="activityCount">0</span>
        </div>
        <div class="info-row">
          <span class="info-label">å¿—å·¥æœå‹™æ™‚æ•¸</span>
          <span class="info-value" id="volunteerHours">0</span>
        </div>
        <div class="info-row">
          <span class="info-label">ç´¯è¨ˆææ¬¾é‡‘é¡</span>
          <span class="info-value" id="donationAmount">NT$ 0</span>
        </div>
      </div>
    </div>

    <!-- æ´»å‹•å ±å -->
    <div id="activities" class="tab-content">
      <div class="card">
        <div class="card-title">é€²è¡Œä¸­çš„æ´»å‹•</div>
        <div id="activitiesList"></div>
      </div>

      <div class="card">
        <div class="card-title">æˆ‘çš„å ±å</div>
        <div id="myRegistrations"></div>
      </div>
    </div>

    <!-- å¿—å·¥æœå‹™ -->
    <div id="volunteer" class="tab-content">
      <div class="stat-box">
        <div class="stat-value" id="totalHours">0</div>
        <div class="stat-label">ç´¯è¨ˆæœå‹™æ™‚æ•¸</div>
      </div>

      <div class="card">
        <div class="card-title">ç™»è¨˜æœå‹™æ™‚æ•¸</div>
        <div class="form-group">
          <label class="form-label">æœå‹™æ—¥æœŸ</label>
          <input type="date" id="serviceDate" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">æœå‹™æ™‚æ•¸</label>
          <input type="number" id="serviceHours" class="form-input" placeholder="è«‹è¼¸å…¥æ™‚æ•¸" step="0.5" min="0.5">
        </div>
        <div class="form-group">
          <label class="form-label">æœå‹™èªªæ˜</label>
          <textarea id="serviceDescription" class="form-input" rows="3" placeholder="è«‹æè¿°æœå‹™å…§å®¹"></textarea>
        </div>
        <button class="btn btn-primary" onclick="submitVolunteer()">æäº¤è¨˜éŒ„</button>
      </div>

      <div class="card">
        <div class="card-title">æœå‹™è¨˜éŒ„</div>
        <div id="volunteerRecords"></div>
      </div>
    </div>
  </div>

  <!-- æ´»å‹•è©³æƒ… Modal -->
  <div id="activityModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal('activityModal')">&times;</span>
      <div id="activityDetail"></div>
    </div>
  </div>

  <!-- ç·¨è¼¯è³‡æ–™ Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal('editModal')">&times;</span>
      <div class="modal-title">ç·¨è¼¯å€‹äººè³‡æ–™</div>
      <div class="form-group">
        <label class="form-label">å§“å</label>
        <input type="text" id="editName" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">é›»è©±</label>
        <input type="tel" id="editPhone" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="editEmail" class="form-input">
      </div>
      <button class="btn btn-primary" onclick="saveProfile()">å„²å­˜</button>
    </div>
  </div>

  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxabz6vmzwklRir1aTOO3jCVe9LmLARa2hioKJpekaTFr0ppjxmVW3-5CJWyIFeBgckXw/exec'; // è«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS Web App URL
    let liffId = '1656516134-X9oq92g9'; // è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID
    let userId = '';
    let memberData = null;

    // åˆå§‹åŒ– LIFF
    async function initializeLiff() {
      try {
        await liff.init({ liffId: liffId });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        
        const profile = await liff.getProfile();
        userId = profile.userId;
        
        await loadMemberData();
        await loadDashboard();
        
      } catch (error) {
        console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
        showToast('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
      }
    }

    // è¼‰å…¥æœƒå“¡è³‡æ–™
    async function loadMemberData() {
      try {
        const response = await fetch(`${API_URL}?action=getMemberInfo&userId=${userId}`);
        const data = await response.json();
        
        if (!data) {
          // æ–°æœƒå“¡è¨»å†Š
          const profile = await liff.getProfile();
          await registerNewMember(profile);
        } else {
          memberData = data;
          document.getElementById('memberName').textContent = data.name;
          document.getElementById('memberIdDisplay').textContent = data.memberId;
          
          // ç”Ÿæˆ QR Code
          new QRCode(document.getElementById('qrcode'), {
            text: data.memberId,
            width: 150,
            height: 150
          });
          
          loadProfileInfo();
        }
      } catch (error) {
        console.error('è¼‰å…¥æœƒå“¡è³‡æ–™å¤±æ•—:', error);
      }
    }

    // è¨»å†Šæ–°æœƒå“¡
    async function registerNewMember(profile) {
      const name = prompt('è«‹è¼¸å…¥æ‚¨çš„å§“åï¼š');
      const phone = prompt('è«‹è¼¸å…¥æ‚¨çš„é›»è©±ï¼š');
      const email = prompt('è«‹è¼¸å…¥æ‚¨çš„ Emailï¼š');
      
      if (!name || !phone) {
        showToast('è«‹å®Œæ•´å¡«å¯«è³‡æ–™');
        return;
      }
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'registerMember',
            lineUserId: userId,
            name: name,
            phone: phone,
            email: email
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('è¨»å†ŠæˆåŠŸï¼');
          await loadMemberData();
        }
      } catch (error) {
        console.error('è¨»å†Šå¤±æ•—:', error);
      }
    }

    // è¼‰å…¥é¦–é 
    async function loadDashboard() {
      loadRecentActivities();
      loadMyStats();
    }

    // è¼‰å…¥æœ€æ–°æ´»å‹•
    async function loadRecentActivities() {
      try {
        const response = await fetch(`${API_URL}?action=getActivities&status=é€²è¡Œä¸­`);
        const activities = await response.json();
        
        const container = document.getElementById('recentActivities');
        if (activities.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„æ´»å‹•</p></div>';
          return;
        }
        
        container.innerHTML = activities.slice(0, 3).map(activity => `
          <div class="activity-item" onclick="viewActivity('${activity.activityId}')">
            <div class="activity-title">${activity.name}</div>
            <div class="activity-info">ğŸ“… ${activity.date} ${activity.startTime}</div>
            <div class="activity-info">ğŸ“ ${activity.location}</div>
          </div>
        `).join('');
      } catch (error) {
        console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', error);
      }
    }

    // è¼‰å…¥å€‹äººçµ±è¨ˆ
    async function loadMyStats() {
      try {
        // è¼‰å…¥å ±åè¨˜éŒ„
        const regResponse = await fetch(`${API_URL}?action=getMyRegistrations&userId=${userId}`);
        const registrations = await regResponse.json();
        document.getElementById('activityCount').textContent = registrations.length;
        
        // è¼‰å…¥å¿—å·¥æ™‚æ•¸
        const volResponse = await fetch(`${API_URL}?action=getVolunteerRecords&userId=${userId}`);
        const volunteer = await volResponse.json();
        document.getElementById('volunteerHours').textContent = volunteer.totalHours;
        document.getElementById('totalHours').textContent = volunteer.totalHours;
        
        // è¼‰å…¥ææ¬¾è¨˜éŒ„
        const donResponse = await fetch(`${API_URL}?action=getDonationRecords&userId=${userId}`);
        const donations = await donResponse.json();
        document.getElementById('donationAmount').textContent = `NT$ ${donations.totalAmount.toLocaleString()}`;
      } catch (error) {
        console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
      }
    }

    // è¼‰å…¥å€‹äººè³‡æ–™
    function loadProfileInfo() {
      const container = document.getElementById('profileInfo');
      container.innerHTML = `
        <div class="info-row">
          <span class="info-label">å§“å</span>
          <span class="info-value">${memberData.name}</span>
        </div>
        <div class="info-row">
          <span class="info-label">é›»è©±</span>
          <span class="info-value">${memberData.phone}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Email</span>
          <span class="info-value">${memberData.email || '-'}</span>
        </div>
        <div class="info-row">
          <span class="info-label">æœƒå“¡é¡å‹</span>
          <span class="info-value">${memberData.memberType}</span>
        </div>
        <div class="info-row">
          <span class="info-label">åŠ å…¥æ—¥æœŸ</span>
          <span class="info-value">${new Date(memberData.createdAt).toLocaleDateString()}</span>
        </div>
      `;
    }

    // ç·¨è¼¯å€‹äººè³‡æ–™
    function editProfile() {
      document.getElementById('editName').value = memberData.name;
      document.getElementById('editPhone').value = memberData.phone;
      document.getElementById('editEmail').value = memberData.email || '';
      openModal('editModal');
    }

    // å„²å­˜å€‹äººè³‡æ–™
    async function saveProfile() {
      const name = document.getElementById('editName').value;
      const phone = document.getElementById('editPhone').value;
      const email = document.getElementById('editEmail').value;
      
      if (!name || !phone) {
        showToast('è«‹å¡«å¯«å¿…è¦è³‡æ–™');
        return;
      }
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'updateMember',
            lineUserId: userId,
            name: name,
            phone: phone,
            email: email
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('æ›´æ–°æˆåŠŸï¼');
          closeModal('editModal');
          await loadMemberData();
        }
      } catch (error) {
        console.error('æ›´æ–°å¤±æ•—:', error);
        showToast('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // è¼‰å…¥æ´»å‹•åˆ—è¡¨
    async function loadActivities() {
      try {
        const response = await fetch(`${API_URL}?action=getActivities&status=é€²è¡Œä¸­`);
        const activities = await response.json();
        
        const container = document.getElementById('activitiesList');
        if (activities.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„æ´»å‹•</p></div>';
          return;
        }
        
        container.innerHTML = activities.map(activity => {
          const isFull = activity.maxParticipants > 0 && activity.registrationCount >= activity.maxParticipants;
          return `
            <div class="activity-item" onclick="viewActivity('${activity.activityId}')">
              <div class="activity-title">
                ${activity.name}
                ${isFull ? '<span class="badge badge-warning">å·²é¡æ»¿</span>' : ''}
              </div>
              <div class="activity-info">ğŸ“… ${activity.date} ${activity.startTime} - ${activity.endTime}</div>
              <div class="activity-info">ğŸ“ ${activity.location}</div>
              <div class="activity-info">ğŸ‘¥ ${activity.registrationCount}/${activity.maxParticipants || 'ä¸é™'} äºº</div>
              <div class="activity-info">ğŸ’° ${activity.fee > 0 ? 'NT$ ' + activity.fee : 'å…è²»'}</div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', error);
      }
    }

    // æŸ¥çœ‹æ´»å‹•è©³æƒ…
    async function viewActivity(activityId) {
      try {
        const response = await fetch(`${API_URL}?action=getActivities&status=é€²è¡Œä¸­`);
        const activities = await response.json();
        const activity = activities.find(a => a.activityId === activityId);
        
        if (!activity) return;
        
        const isFull = activity.maxParticipants > 0 && activity.registrationCount >= activity.maxParticipants;
        const isDeadlinePassed = new Date(activity.registrationDeadline) < new Date();
        
        // æª¢æŸ¥æ˜¯å¦å·²å ±å
        const regResponse = await fetch(`${API_URL}?action=getMyRegistrations&userId=${userId}`);
        const myRegs = await regResponse.json();
        const isRegistered = myRegs.some(r => r.activityId === activityId);
        
        const container = document.getElementById('activityDetail');
        container.innerHTML = `
          <div class="modal-title">${activity.name}</div>
          <div class="info-row">
            <span class="info-label">æ´»å‹•é¡å‹</span>
            <span class="info-value">${activity.type}</span>
          </div>
          <div class="info-row">
            <span class="info-label">æ—¥æœŸæ™‚é–“</span>
            <span class="info-value">${activity.date} ${activity.startTime} - ${activity.endTime}</span>
          </div>
          <div class="info-row">
            <span class="info-label">åœ°é»</span>
            <span class="info-value">${activity.location}</span>
          </div>
          <div class="info-row">
            <span class="info-label">äººæ•¸</span>
            <span class="info-value">${activity.registrationCount}/${activity.maxParticipants || 'ä¸é™'} äºº</span>
          </div>
          <div class="info-row">
            <span class="info-label">è²»ç”¨</span>
            <span class="info-value">${activity.fee > 0 ? 'NT$ ' + activity.fee : 'å…è²»'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">å ±åæˆªæ­¢</span>
            <span class="info-value">${activity.registrationDeadline}</span>
          </div>
          <div class="form-group">
            <label class="form-label">æ´»å‹•èªªæ˜</label>
            <p style="color: #666; line-height: 1.6;">${activity.description || 'ç„¡'}</p>
          </div>
          <div class="form-group">
            <label class="form-label">æ³¨æ„äº‹é …</label>
            <p style="color: #666; line-height: 1.6;">${activity.notes || 'ç„¡'}</p>
          </div>
          ${isRegistered 
            ? '<button class="btn btn-secondary" disabled>å·²å ±å</button>' 
            : isFull 
              ? '<button class="btn btn-secondary" disabled>å·²é¡æ»¿</button>'
              : isDeadlinePassed
                ? '<button class="btn btn-secondary" disabled>å ±åå·²æˆªæ­¢</button>'
                : `<button class="btn btn-primary" onclick="registerActivity('${activityId}')">ç«‹å³å ±å</button>`
          }
        `;
        
        openModal('activityModal');
      } catch (error) {
        console.error('è¼‰å…¥æ´»å‹•è©³æƒ…å¤±æ•—:', error);
      }
    }

    // å ±åæ´»å‹•
    async function registerActivity(activityId) {
      if (!confirm('ç¢ºå®šè¦å ±åæ­¤æ´»å‹•å—ï¼Ÿ')) return;
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'registerActivity',
            activityId: activityId,
            userId: userId,
            memberName: memberData.name
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('å ±åæˆåŠŸï¼');
          closeModal('activityModal');
          loadActivities();
          loadMyRegistrations();
        } else {
          showToast(result.error || 'å ±åå¤±æ•—');
        }
      } catch (error) {
        console.error('å ±åå¤±æ•—:', error);
        showToast('å ±åå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // è¼‰å…¥æˆ‘çš„å ±å
    async function loadMyRegistrations() {
      try {
        const response = await fetch(`${API_URL}?action=getMyRegistrations&userId=${userId}`);
        const registrations = await response.json();
        
        const container = document.getElementById('myRegistrations');
        if (registrations.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><p>å°šæœªå ±åä»»ä½•æ´»å‹•</p></div>';
          return;
        }
        
        container.innerHTML = registrations.map(reg => `
          <div class="activity-item">
            <div class="activity-title">
              ${reg.activityName}
              <span class="badge ${reg.checkInStatus === 'å·²ç°½åˆ°' ? 'badge-success' : 'badge-info'}">${reg.checkInStatus}</span>
            </div>
            <div class="activity-info">ğŸ“… ${reg.activityDate}</div>
            <div class="activity-info">ğŸ“ ${reg.activityLocation}</div>
            <button class="btn btn-danger" onclick="cancelRegistration('${reg.registrationId}')">å–æ¶ˆå ±å</button>
          </div>
        `).join('');
      } catch (error) {
        console.error('è¼‰å…¥å ±åè¨˜éŒ„å¤±æ•—:', error);
      }
    }

    // å–æ¶ˆå ±å
    async function cancelRegistration(registrationId) {
      if (!confirm('ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ')) return;
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'cancelRegistration',
            registrationId: registrationId,
            userId: userId
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('å·²å–æ¶ˆå ±å');
          loadMyRegistrations();
        }
      } catch (error) {
        console.error('å–æ¶ˆå ±åå¤±æ•—:', error);
        showToast('å–æ¶ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // æäº¤å¿—å·¥è¨˜éŒ„
    async function submitVolunteer() {
      const date = document.getElementById('serviceDate').value;
      const hours = document.getElementById('serviceHours').value;
      const description = document.getElementById('serviceDescription').value;
      
      if (!date || !hours || !description) {
        showToast('è«‹å¡«å¯«å®Œæ•´è³‡æ–™');
        return;
      }
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'submitVolunteerRecord',
            userId: userId,
            memberName: memberData.name,
            serviceDate: date,
            hours: parseFloat(hours),
            description: description
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('æäº¤æˆåŠŸï¼Œç­‰å¾…å¯©æ ¸');
          document.getElementById('serviceDate').value = '';
          document.getElementById('serviceHours').value = '';
          document.getElementById('serviceDescription').value = '';
          loadVolunteerRecords();
        }
      } catch (error) {
        console.error('æäº¤å¤±æ•—:', error);
        showToast('æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // è¼‰å…¥å¿—å·¥è¨˜éŒ„
    async function loadVolunteerRecords() {
      try {
        const response = await fetch(`${API_URL}?action=getVolunteerRecords&userId=${userId}`);
        const data = await response.json();
        
        document.getElementById('totalHours').textContent = data.totalHours;
        
        const container = document.getElementById('volunteerRecords');
        if (data.records.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><p>å°šç„¡æœå‹™è¨˜éŒ„</p></div>';
          return;
        }
        
        container.innerHTML = data.records.map(record => `
          <div class="activity-item">
            <div class="activity-title">
              ${record.serviceDate}
              <span class="badge ${
                record.status === 'å·²é€šé' ? 'badge-success' : 
                record.status === 'å¾…å¯©æ ¸' ? 'badge-warning' : 'badge-danger'
              }">${record.status}</span>
            </div>
            <div class="activity-info">â° ${record.hours} å°æ™‚</div>
            <div class="activity-info">ğŸ“ ${record.description}</div>
            ${record.reviewNote ? `<div class="activity-info" style="color: #ff4757;">ğŸ’¬ ${record.reviewNote}</div>` : ''}
          </div>
        `).join('');
      } catch (error) {
        console.error('è¼‰å…¥å¿—å·¥è¨˜éŒ„å¤±æ•—:', error);
      }
    }

    // æŸ¥çœ‹ææ¬¾è¨˜éŒ„
    async function viewDonations() {
      try {
        const response = await fetch(`${API_URL}?action=getDonationRecords&userId=${userId}`);
        const data = await response.json();
        
        if (data.donations.length === 0) {
          alert('å°šç„¡ææ¬¾è¨˜éŒ„');
          return;
        }
        
        let message = `ç´¯è¨ˆææ¬¾ï¼šNT$ ${data.totalAmount.toLocaleString()}\n\n`;
        data.donations.forEach(d => {
          message += `${d.date}\nNT$ ${d.amount.toLocaleString()}\n${d.description || ''}\n\n`;
        });
        
        alert(message);
      } catch (error) {
        console.error('è¼‰å…¥ææ¬¾è¨˜éŒ„å¤±æ•—:', error);
      }
    }

    // åˆ‡æ›åˆ†é 
    function switchTab(tabName) {
      document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      // è¼‰å…¥å°æ‡‰è³‡æ–™
      if (tabName === 'activities') {
        loadActivities();
        loadMyRegistrations();
      } else if (tabName === 'volunteer') {
        loadVolunteerRecords();
      }
    }

    // Modal æ§åˆ¶
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // Toast æç¤º
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // åˆå§‹åŒ–
    window.onload = () => {
      initializeLiff();
    };
  </script>
</body>
</html>
