<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕促會病友權益促進會管理系統</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- 自訂樣式 -->
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --info-color: #16a085;
      --light-bg: #ecf0f1;
      --sidebar-width: 260px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light-bg);
      overflow-x: hidden;
    }
    
    /* 頂部導航列 */
    .top-navbar {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 1rem 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .top-navbar h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }
    
    .navbar-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      font-size: 0.9rem;
    }
    
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .status-indicator.online {
      background-color: var(--success-color);
    }
    
    .status-indicator.offline {
      background-color: var(--danger-color);
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .menu-toggle {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    /* 側邊欄 */
    .sidebar {
      position: fixed;
      left: 0;
      top: 70px;
      width: var(--sidebar-width);
      height: calc(100vh - 70px);
      background: white;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      overflow-y: auto;
      transition: transform 0.3s ease;
      z-index: 999;
    }
    
    .sidebar-menu {
      list-style: none;
      padding: 1rem 0;
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      padding: 1rem 1.5rem;
      color: var(--primary-color);
      text-decoration: none;
      transition: all 0.3s ease;
      cursor: pointer;
      border-left: 4px solid transparent;
    }
    
    .nav-link:hover {
      background-color: var(--light-bg);
      border-left-color: var(--secondary-color);
    }
    
    .nav-link.active {
      background-color: var(--light-bg);
      border-left-color: var(--secondary-color);
      color: var(--secondary-color);
      font-weight: 600;
    }
    
    .nav-link i {
      width: 24px;
      margin-right: 1rem;
      font-size: 1.1rem;
    }
    
    /* 主要內容區 */
    .main-content {
      margin-left: var(--sidebar-width);
      margin-top: 70px;
      padding: 2rem;
      min-height: calc(100vh - 70px);
    }
    
    .page-header {
      margin-bottom: 2rem;
    }
    
    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .page-subtitle {
      color: #7f8c8d;
      font-size: 1rem;
    }
    
    /* 卡片樣式 */
    .stats-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    
    .stats-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--secondary-color), var(--info-color));
    }
    
    .stats-card.primary::before {
      background: linear-gradient(90deg, #3498db, #2980b9);
    }
    
    .stats-card.success::before {
      background: linear-gradient(90deg, #27ae60, #229954);
    }
    
    .stats-card.info::before {
      background: linear-gradient(90deg, #16a085, #138d75);
    }
    
    .stats-card.warning::before {
      background: linear-gradient(90deg, #f39c12, #e67e22);
    }
    
    .stats-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      margin-bottom: 1rem;
    }
    
    .stats-icon.primary {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
    }
    
    .stats-icon.success {
      background: linear-gradient(135deg, #27ae60, #229954);
      color: white;
    }
    
    .stats-icon.info {
      background: linear-gradient(135deg, #16a085, #138d75);
      color: white;
    }
    
    .stats-icon.warning {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: white;
    }
    
    .stats-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .stats-label {
      color: #7f8c8d;
      font-size: 0.95rem;
      margin: 0;
    }
    
    .content-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    
    .content-card-header {
      padding: 1.5rem;
      border-bottom: 1px solid #ecf0f1;
    }
    
    .content-card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary-color);
      margin: 0;
    }
    
    .content-card-body {
      padding: 1.5rem;
    }
    
    /* 按鈕樣式 */
    .btn-custom {
      padding: 0.6rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
      border: none;
    }
    
    .btn-primary-custom {
      background: linear-gradient(135deg, var(--secondary-color), var(--info-color));
      color: white;
    }
    
    .btn-primary-custom:hover {
      background: linear-gradient(135deg, #2980b9, #138d75);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
    }
    
    .btn-success-custom {
      background: linear-gradient(135deg, var(--success-color), #229954);
      color: white;
    }
    
    .btn-warning-custom {
      background: linear-gradient(135deg, var(--warning-color), #e67e22);
      color: white;
    }
    
    /* 表格樣式 */
    .table-responsive {
      border-radius: 8px;
      overflow: hidden;
    }
    
    .table {
      margin-bottom: 0;
    }
    
    .table thead th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
      border: none;
      padding: 1rem;
    }
    
    .table tbody tr {
      transition: background-color 0.2s ease;
    }
    
    .table tbody tr:hover {
      background-color: #f8f9fa;
    }
    
    /* Badge 樣式 */
    .badge-custom {
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.85rem;
    }
    
    /* 圖表容器 */
    .chart-container {
      position: relative;
      height: 300px;
      margin: 1rem 0;
    }
    
    /* 待辦事項 */
    .pending-item {
      padding: 1rem;
      border-left: 4px solid var(--warning-color);
      background-color: #fff9f0;
      margin-bottom: 0.75rem;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .pending-item:hover {
      background-color: #fff3e0;
      transform: translateX(5px);
    }
    
    /* 載入動畫 */
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
    }
    
    /* 警告容器 */
    #alertContainer {
      position: fixed;
      top: 90px;
      right: 20px;
      z-index: 9999;
      max-width: 400px;
    }
    
    /* 響應式設計 */
    @media (max-width: 768px) {
      .menu-toggle {
        display: block;
      }
      
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.show {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .top-navbar h1 {
        font-size: 1.2rem;
      }
      
      .connection-status {
        display: none;
      }
      
      .stats-card {
        margin-bottom: 1rem;
      }
    }
    
    /* 快速操作按鈕 */
    .quick-actions {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      z-index: 998;
    }
    
    .quick-action-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--secondary-color), var(--info-color));
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    
    .quick-action-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <!-- 頂部導航列 -->
  <nav class="top-navbar">
    <div style="display: flex; align-items: center; gap: 1rem;">
      <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
      <h1>
        <i class="fas fa-heartbeat me-2"></i>
        帕促會管理系統
      </h1>
    </div>
    <div class="navbar-actions">
      <div class="connection-status" id="connectionStatus">
        <span class="status-indicator online" id="statusIndicator"></span>
        <span id="statusText">連線中...</span>
      </div>
    </div>
  </nav>

  <!-- 側邊欄 -->
  <aside class="sidebar" id="sidebar">
    <ul class="sidebar-menu">
      <li>
        <a class="nav-link active" onclick="loadPage('dashboard')">
          <i class="fas fa-tachometer-alt"></i>
          <span>儀表板</span>
        </a>
      </li>
      <li>
        <a class="nav-link" onclick="loadPage('membership')">
          <i class="fas fa-users"></i>
          <span>會員管理</span>
        </a>
      </li>
      <li>
        <a class="nav-link" onclick="loadPage('membership-fee')">
          <i class="fas fa-credit-card"></i>
          <span>會費管理</span>
        </a>
      </li>
      <li>
        <a class="nav-link" onclick="loadPage('donation')">
          <i class="fas fa-hand-holding-heart"></i>
          <span>捐款管理</span>
        </a>
      </li>
      <li>
        <a class="nav-link" onclick="loadPage('expense')">
          <i class="fas fa-receipt"></i>
          <span>支出管理</span>
        </a>
      </li>
      <li>
        <a class="nav-link" onclick="loadPage('receipt')">
          <i class="fas fa-file-invoice"></i>
          <span>收據管理</span>
        </a>
      </li>
      <li>
        <a class="nav-link" onclick="loadPage('approval')">
          <i class="fas fa-check-circle"></i>
          <span>核准流程</span>
        </a>
      </li>
      <li>
        <a class="nav-link" onclick="loadPage('financial-report')">
          <i class="fas fa-chart-line"></i>
          <span>財務報表</span>
        </a>
      </li>
      <li>
        <a class="nav-link" onclick="loadPage('settings')">
          <i class="fas fa-cog"></i>
          <span>系統設定</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- 主要內容區 -->
  <main class="main-content" id="pageContent">
    <!-- 頁面內容將動態載入到這裡 -->
  </main>

  <!-- 警告訊息容器 -->
  <div id="alertContainer"></div>

  <!-- 快速操作按鈕 -->
  <div class="quick-actions">
    <button class="quick-action-btn" onclick="quickAddMember()" title="快速新增會員">
      <i class="fas fa-user-plus"></i>
    </button>
    <button class="quick-action-btn" onclick="quickAddExpense()" title="快速新增支出">
      <i class="fas fa-plus"></i>
    </button>
  </div>

  <!-- 通用模態框 -->
  <div class="modal fade" id="universalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer" id="modalFooter"></div>
      </div>
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <script>
    // ==================== API 設定 ====================
    
    const API_CONFIG = {
      url: 'https://script.google.com/macros/s/AKfycbz2okGfJWEm-uMvQRwDGOpIcX08dkqb8WH33dQOqetkp8aynZkc7cUDLEEIgbCFht1X1Q/exec',  // ← 請在這裡填入您的 API URL
      timeout: 30000,
      retries: 3,
      offlineMode: false
    };

    // ==================== 全域變數 ====================
    
    let currentPage = 'dashboard';
    let currentData = {
      members: [],
      membershipFees: [],
      donations: [],
      expenses: [],
      receipts: [],
      approvals: [],
      dashboardStats: null,
      financialReport: null,
      settings: {}
    };
    let dataTable = null;

    // ==================== 初始化 ====================
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('系統初始化中...');
      console.log('API URL:', API_CONFIG.url);
      
      // 檢查 API URL 是否已設定
      if (!API_CONFIG.url || API_CONFIG.url.includes('請替換')) {
        showAlert('⚠️ 系統尚未設定 API 連接！請先設定 API_CONFIG.url', 'danger', 0);
        updateConnectionStatus(false);
      } else {
        // 測試 API 連接
        testApiConnection();
      }
      
      // 載入首頁
      loadPage('dashboard');
    });

    // ==================== API 連接測試 ====================
    
    async function testApiConnection() {
      try {
        console.log('測試 API 連接...');
        console.log('測試 URL:', API_CONFIG.url);
        
        const testUrl = `${API_CONFIG.url}?action=test&timestamp=${Date.now()}`;
        console.log('完整測試 URL:', testUrl);
        
        const response = await fetch(testUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache'
          },
          mode: 'cors'
        });
        
        console.log('測試回應狀態:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const text = await response.text();
        console.log('測試回應內容:', text);
        
        const result = JSON.parse(text);
        console.log('解析後的結果:', result);
        
        if (result.success) {
          console.log('✅ API 連接成功');
          updateConnectionStatus(true);
          showAlert('✅ 系統已成功連接到伺服器', 'success', 3000);
        } else {
          throw new Error(result.message || 'API 回應失敗');
        }
        
      } catch (error) {
        console.error('❌ API 連接失敗:', error);
        updateConnectionStatus(false);
        showAlert(`❌ 無法連接到伺服器：${error.message}`, 'danger', 0);
      }
    }
    
    function updateConnectionStatus(isOnline) {
      const indicator = document.getElementById('statusIndicator');
      const statusText = document.getElementById('statusText');
      
      if (isOnline) {
        indicator.className = 'status-indicator online';
        statusText.textContent = '已連線';
        API_CONFIG.offlineMode = false;
      } else {
        indicator.className = 'status-indicator offline';
        statusText.textContent = '離線';
        API_CONFIG.offlineMode = true;
      }
    }

    // 由於程式碼過長，請告訴我是否需要繼續提供剩餘的 JavaScript 程式碼
    // 或者您可以使用之前提供的完整程式碼，只需要修改 API_CONFIG.url 即可
        // ==================== API 調用函數 ====================
    
    async function apiCall(action, data = {}) {
      if (API_CONFIG.offlineMode) {
        console.log('離線模式，使用模擬資料');
        return getOfflineData(action);
      }
      
      // 檢查 URL 是否已設定
      if (!API_CONFIG.url || API_CONFIG.url.includes('請替換')) {
        console.error('API URL 尚未設定');
        showAlert('系統尚未設定 API 連接，請聯繫管理員', 'danger', 10000);
        API_CONFIG.offlineMode = true;
        updateConnectionStatus(false);
        return getOfflineData(action);
      }
      
      let lastError;
      
      for (let attempt = 1; attempt <= API_CONFIG.retries; attempt++) {
        try {
          console.log(`API 調用 ${action} (嘗試 ${attempt}/${API_CONFIG.retries})`);
          console.log('請求參數:', data);
          
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);
          
          const params = new URLSearchParams({
            action: action,
            timestamp: Date.now().toString()
          });
          
          if (data && typeof data === 'object') {
            Object.keys(data).forEach(key => {
              if (data[key] !== null && data[key] !== undefined) {
                if (typeof data[key] === 'object') {
                  params.append(key, JSON.stringify(data[key]));
                } else {
                  params.append(key, data[key].toString());
                }
              }
            });
          }
          
          const url = `${API_CONFIG.url}?${params.toString()}`;
          
          const response = await fetch(url, {
            method: 'GET',
            signal: controller.signal,
            headers: {
              'Accept': 'application/json',
              'Cache-Control': 'no-cache'
            },
            mode: 'cors'
          });
          
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const text = await response.text();
          let result;
          
          try {
            result = JSON.parse(text);
          } catch (parseError) {
            console.error('JSON 解析錯誤:', parseError);
            console.error('無法解析的內容:', text);
            throw new Error('伺服器回應格式錯誤');
          }
          
          console.log(`API 調用 ${action} 成功:`, result);
          return result;
          
        } catch (error) {
          lastError = error;
          console.error(`API 調用 ${action} 失敗 (嘗試 ${attempt}):`, error);
          
          if (attempt < API_CONFIG.retries) {
            const delay = 1000 * attempt;
            console.log(`等待 ${delay}ms 後重試...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }
      
      console.error('所有重試均失敗，最後錯誤:', lastError);
      console.warn('切換到離線模式');
      API_CONFIG.offlineMode = true;
      updateConnectionStatus(false);
      
      showAlert(`無法連接到伺服器：${lastError.message}。已切換到離線模式`, 'warning', 10000);
      
      return getOfflineData(action);
    }

    // ==================== 離線模式模擬資料 ====================
    
    function getOfflineData(action) {
      console.log('使用離線模擬資料:', action);
      
      const offlineData = {
        getDashboardStats: {
          success: true,
          data: {
            totalMembers: 156,
            activeDonations: 23,
            pendingApprovals: 5,
            monthlyRevenue: 125000,
            recentActivities: [
              { type: '新會員', name: '張小明', time: '2小時前' },
              { type: '捐款', name: '李大華', time: '5小時前' },
              { type: '支出申請', name: '王美麗', time: '1天前' }
            ],
            pendingTasks: [
              { id: 1, title: '審核會費記錄', count: 3 },
              { id: 2, title: '核准支出申請', count: 2 },
              { id: 3, title: '開立收據', count: 5 }
            ]
          }
        },
        
        getMembers: {
          success: true,
          data: [
            {
              '會員編號': 'M001',
              '姓名': '張小明',
              '性別': '男',
              '電話': '0912-345-678',
              '電子郵件': 'zhang@example.com',
              '入會日期': '2024-01-15',
              '會員狀態': '有效'
            },
            {
              '會員編號': 'M002',
              '姓名': '李大華',
              '性別': '女',
              '電話': '0923-456-789',
              '電子郵件': 'li@example.com',
              '入會日期': '2024-02-20',
              '會員狀態': '有效'
            },
            {
              '會員編號': 'M003',
              '姓名': '王美麗',
              '性別': '女',
              '電話': '0934-567-890',
              '電子郵件': 'wang@example.com',
              '入會日期': '2024-03-10',
              '會員狀態': '有效'
            }
          ]
        },
        
        getMembershipFees: {
          success: true,
          data: [
            {
              '記錄編號': 'F001',
              '會員編號': 'M001',
              '會員姓名': '張小明',
              '繳費年度': '2024',
              '金額': 1000,
              '繳費日期': '2024-01-20',
              '繳費方式': '轉帳',
              '狀態': '已確認'
            },
            {
              '記錄編號': 'F002',
              '會員編號': 'M002',
              '會員姓名': '李大華',
              '繳費年度': '2024',
              '金額': 1000,
              '繳費日期': '2024-02-25',
              '繳費方式': '現金',
              '狀態': '待確認'
            }
          ]
        },
        
        getDonations: {
          success: true,
          data: [
            {
              '捐款編號': 'D001',
              '捐款人姓名': '陳先生',
              '金額': 5000,
              '捐款日期': '2024-03-15',
              '捐款用途': '一般捐款',
              '捐款方式': '轉帳',
              '收據編號': 'R001'
            },
            {
              '捐款編號': 'D002',
              '捐款人姓名': '林小姐',
              '金額': 10000,
              '捐款日期': '2024-03-20',
              '捐款用途': '專案捐款',
              '捐款方式': '信用卡',
              '收據編號': 'R002'
            }
          ]
        },
        
        getExpenses: {
          success: true,
          data: [
            {
              '支出編號': 'E001',
              '申請人': '王美麗',
              '支出日期': '2024-03-10',
              '支出類別': '行政費用',
              '支出項目': '辦公用品',
              '金額': 2500,
              '狀態': '已核准',
              '優先級': '中'
            },
            {
              '支出編號': 'E002',
              '申請人': '張小明',
              '支出日期': '2024-03-18',
              '支出類別': '活動費用',
              '支出項目': '場地租金',
              '金額': 8000,
              '狀態': '待核准',
              '優先級': '高'
            }
          ]
        },
        
        getReceipts: {
          success: true,
          data: [
            {
              '收據編號': 'R001',
              '收據類型': '捐款收據',
              '開立日期': '2024-03-15',
              '收款人': '陳先生',
              '金額': 5000,
              '狀態': '已開立'
            },
            {
              '收據編號': 'R002',
              '收據類型': '捐款收據',
              '開立日期': '2024-03-20',
              '收款人': '林小姐',
              '金額': 10000,
              '狀態': '已開立'
            }
          ]
        },
        
        getApprovals: {
          success: true,
          data: [
            {
              '流程編號': 'A001',
              '申請類型': '支出申請',
              '申請人': '張小明',
              '申請日期': '2024-03-18',
              '金額': 8000,
              '狀態': '待核准',
              '優先級': '高'
            },
            {
              '流程編號': 'A002',
              '申請類型': '會費確認',
              '申請人': '李大華',
              '申請日期': '2024-02-25',
              '金額': 1000,
              '狀態': '待確認',
              '優先級': '中'
            }
          ]
        },
        
        getFinancialReport: {
          success: true,
          data: {
            period: '2024年第一季',
            totalIncome: 150000,
            totalExpense: 45000,
            balance: 105000,
            incomeBreakdown: {
              membershipFees: 50000,
              donations: 100000
            },
            expenseBreakdown: {
              administrative: 15000,
              activities: 20000,
              other: 10000
            },
            monthlyData: [
              { month: '1月', income: 45000, expense: 12000 },
              { month: '2月', income: 52000, expense: 15000 },
              { month: '3月', income: 53000, expense: 18000 }
            ]
          }
        },
        
        getSettings: {
          success: true,
          data: {
            organizationName: '帕促會病友權益促進會',
            receiptPrefix: 'R',
            memberIdPrefix: 'M',
            annualMembershipFee: 1000,
            fiscalYearStart: '01-01'
          }
        }
      };
      
      return offlineData[action] || {
        success: false,
        message: '離線模式：功能不可用'
      };
    }

    // ==================== 頁面載入函數 ====================
    
    async function loadPage(pageName) {
      console.log('載入頁面:', pageName);
      
      // 更新側邊欄選中狀態
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      event?.target?.closest('.nav-link')?.classList.add('active');
      
      // 關閉手機版側邊欄
      if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('show');
      }
      
      currentPage = pageName;
      const contentArea = document.getElementById('pageContent');
      
      // 顯示載入動畫
      contentArea.innerHTML = `
        <div class="loading-spinner">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">載入中...</span>
          </div>
        </div>
      `;
      
      try {
        switch (pageName) {
          case 'dashboard':
            await loadDashboard();
            break;
          case 'membership':
            await loadMembership();
            break;
          case 'membership-fee':
            await loadMembershipFee();
            break;
          case 'donation':
            await loadDonation();
            break;
          case 'expense':
            await loadExpense();
            break;
          case 'receipt':
            await loadReceipt();
            break;
          case 'approval':
            await loadApproval();
            break;
          case 'financial-report':
            await loadFinancialReport();
            break;
          case 'settings':
            await loadSettings();
            break;
          default:
            contentArea.innerHTML = getDefaultContent(pageName);
        }
      } catch (error) {
        console.error('載入頁面失敗:', error);
        contentArea.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            載入頁面失敗：${error.message}
          </div>
        `;
      }
    }

    // ==================== 儀表板 ====================
    
    async function loadDashboard() {
      const result = await apiCall('getDashboardStats');
      
      if (!result.success) {
        throw new Error(result.message || '載入儀表板失敗');
      }
      
      currentData.dashboardStats = result.data;
      const data = result.data;
      
      const html = `
        <div class="page-header">
          <h1 class="page-title">儀表板</h1>
          <p class="page-subtitle">系統概覽與快速統計</p>
        </div>
        
        <!-- 統計卡片 -->
        <div class="row mb-4">
          <div class="col-md-3 mb-3">
            <div class="stats-card primary">
              <div class="stats-icon primary">
                <i class="fas fa-users"></i>
              </div>
              <div class="stats-number">${data.totalMembers || 0}</div>
              <p class="stats-label">總會員數</p>
            </div>
          </div>
          
          <div class="col-md-3 mb-3">
            <div class="stats-card success">
              <div class="stats-icon success">
                <i class="fas fa-hand-holding-heart"></i>
              </div>
              <div class="stats-number">${data.activeDonations || 0}</div>
              <p class="stats-label">本月捐款筆數</p>
            </div>
          </div>
          
          <div class="col-md-3 mb-3">
            <div class="stats-card warning">
              <div class="stats-icon warning">
                <i class="fas fa-clock"></i>
              </div>
              <div class="stats-number">${data.pendingApprovals || 0}</div>
              <p class="stats-label">待核准項目</p>
            </div>
          </div>
          
          <div class="col-md-3 mb-3">
            <div class="stats-card info">
              <div class="stats-icon info">
                <i class="fas fa-dollar-sign"></i>
              </div>
              <div class="stats-number">$${(data.monthlyRevenue || 0).toLocaleString()}</div>
              <p class="stats-label">本月收入</p>
            </div>
          </div>
        </div>
        
        <div class="row">
          <!-- 最近活動 -->
          <div class="col-md-6 mb-4">
            <div class="content-card">
              <div class="content-card-header">
                <h3 class="content-card-title">
                  <i class="fas fa-history me-2"></i>最近活動
                </h3>
              </div>
              <div class="content-card-body">
                ${data.recentActivities && data.recentActivities.length > 0 ? 
                  data.recentActivities.map(activity => `
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                      <div>
                        <span class="badge bg-primary me-2">${activity.type}</span>
                        <strong>${activity.name}</strong>
                      </div>
                      <small class="text-muted">${activity.time}</small>
                    </div>
                  `).join('') :
                  '<p class="text-muted text-center py-3">暫無最近活動</p>'
                }
              </div>
            </div>
          </div>
          
          <!-- 待辦事項 -->
          <div class="col-md-6 mb-4">
            <div class="content-card">
              <div class="content-card-header">
                <h3 class="content-card-title">
                  <i class="fas fa-tasks me-2"></i>待辦事項
                </h3>
              </div>
              <div class="content-card-body">
                ${data.pendingTasks && data.pendingTasks.length > 0 ?
                  data.pendingTasks.map(task => `
                    <div class="pending-item">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <i class="fas fa-circle text-warning me-2" style="font-size: 0.5rem;"></i>
                          <strong>${task.title}</strong>
                        </div>
                        <span class="badge bg-warning">${task.count}</span>
                      </div>
                    </div>
                  `).join('') :
                  '<p class="text-muted text-center py-3">暫無待辦事項</p>'
                }
              </div>
            </div>
          </div>
        </div>
        
        <!-- 收支趨勢圖 -->
        <div class="row">
          <div class="col-12">
            <div class="content-card">
              <div class="content-card-header">
                <h3 class="content-card-title">
                  <i class="fas fa-chart-line me-2"></i>收支趨勢
                </h3>
              </div>
              <div class="content-card-body">
                <div class="chart-container">
                  <canvas id="trendChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('pageContent').innerHTML = html;
      
      // 繪製圖表
      renderTrendChart();
    }
    
    function renderTrendChart() {
      const ctx = document.getElementById('trendChart');
      if (!ctx) return;
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
          datasets: [
            {
              label: '收入',
              data: [45000, 52000, 53000, 48000, 55000, 60000],
              borderColor: '#27ae60',
              backgroundColor: 'rgba(39, 174, 96, 0.1)',
              tension: 0.4
            },
            {
              label: '支出',
              data: [12000, 15000, 18000, 14000, 16000, 17000],
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    // ==================== 會員管理 ====================
    
    async function loadMembership() {
      const result = await apiCall('getMembers');
      
      if (!result.success) {
        throw new Error(result.message || '載入會員資料失敗');
      }
      
      currentData.members = result.data || [];
      
      const html = `
        <div class="page-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="page-title">會員管理</h1>
              <p class="page-subtitle">管理所有會員資料</p>
            </div>
            <button class="btn btn-primary-custom btn-custom" onclick="showAddMemberModal()">
              <i class="fas fa-user-plus me-2"></i>新增會員
            </button>
          </div>
        </div>
        
        <div class="content-card">
          <div class="content-card-body">
            <div class="table-responsive">
              <table id="memberTable" class="table table-hover">
                <thead>
                  <tr>
                    <th>會員編號</th>
                    <th>姓名</th>
                    <th>性別</th>
                    <th>電話</th>
                    <th>電子郵件</th>
                    <th>入會日期</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${currentData.members.map(member => `
                    <tr>
                      <td>${member['會員編號']}</td>
                      <td><strong>${member['姓名']}</strong></td>
                      <td>${member['性別'] || '-'}</td>
                      <td>${member['電話'] || '-'}</td>
                      <td>${member['電子郵件'] || '-'}</td>
                      <td>${member['入會日期']}</td>
                      <td>
                        <span class="badge-custom ${member['會員狀態'] === '有效' ? 'bg-success' : 'bg-secondary'}">
                          ${member['會員狀態']}
                        </span>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-info" onclick="viewMember('${member['會員編號']}')">
                          <i class="fas fa-eye"></i>
                        </button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('pageContent').innerHTML = html;
      
      // 初始化 DataTable
      if ($.fn.DataTable.isDataTable('#memberTable')) {
        $('#memberTable').DataTable().destroy();
      }
      
      $('#memberTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
        },
        order: [[0, 'desc']],
        pageLength: 25
      });
    }

    // ==================== 會費管理 ====================
    
    async function loadMembershipFee() {
      const result = await apiCall('getMembershipFees');
      
      if (!result.success) {
        throw new Error(result.message || '載入會費資料失敗');
      }
      
      currentData.membershipFees = result.data || [];
      
      const html = `
        <div class="page-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="page-title">會費管理</h1>
              <p class="page-subtitle">管理會員年費繳納記錄</p>
            </div>
            <button class="btn btn-primary-custom btn-custom" onclick="showAddFeeModal()">
              <i class="fas fa-plus me-2"></i>新增會費記錄
            </button>
          </div>
        </div>
        
        <div class="content-card">
          <div class="content-card-body">
            <div class="table-responsive">
              <table id="feeTable" class="table table-hover">
                <thead>
                  <tr>
                    <th>記錄編號</th>
                    <th>會員編號</th>
                    <th>會員姓名</th>
                    <th>繳費年度</th>
                    <th>金額</th>
                    <th>繳費日期</th>
                    <th>繳費方式</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${currentData.membershipFees.map(fee => `
                    <tr>
                      <td>${fee['記錄編號']}</td>
                      <td>${fee['會員編號']}</td>
                      <td><strong>${fee['會員姓名']}</strong></td>
                      <td>${fee['繳費年度']}</td>
                      <td>$${fee['金額'].toLocaleString()}</td>
                      <td>${fee['繳費日期']}</td>
                      <td>${fee['繳費方式']}</td>
                      <td>
                        <span class="badge-custom ${fee['狀態'] === '已確認' ? 'bg-success' : 'bg-warning'}">
                          ${fee['狀態']}
                        </span>
                      </td>
                      <td>
                        ${fee['狀態'] === '待確認' ? `
                          <button class="btn btn-sm btn-success" onclick="confirmFee('${fee['記錄編號']}')">
                            <i class="fas fa-check"></i> 確認
                          </button>
                        ` : `
                          <button class="btn btn-sm btn-info" onclick="viewFee('${fee['記錄編號']}')">
                            <i class="fas fa-eye"></i>
                          </button>
                        `}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('pageContent').innerHTML = html;
      
      if ($.fn.DataTable.isDataTable('#feeTable')) {
        $('#feeTable').DataTable().destroy();
      }
      
      $('#feeTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
        },
        order: [[5, 'desc']],
        pageLength: 25
      });
    }

    // ==================== 捐款管理 ====================
    
    async function loadDonation() {
      const result = await apiCall('getDonations');
      
      if (!result.success) {
        throw new Error(result.message || '載入捐款資料失敗');
      }
      
      currentData.donations = result.data || [];
      
      const html = `
        <div class="page-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="page-title">捐款管理</h1>
              <p class="page-subtitle">管理所有捐款記錄</p>
            </div>
            <button class="btn btn-primary-custom btn-custom" onclick="showAddDonationModal()">
              <i class="fas fa-hand-holding-heart me-2"></i>新增捐款
            </button>
          </div>
        </div>
        
        <div class="content-card">
          <div class="content-card-body">
            <div class="table-responsive">
              <table id="donationTable" class="table table-hover">
                <thead>
                  <tr>
                    <th>捐款編號</th>
                    <th>捐款人姓名</th>
                    <th>金額</th>
                    <th>捐款日期</th>
                    <th>捐款用途</th>
                    <th>捐款方式</th>
                    <th>收據編號</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${currentData.donations.map(donation => `
                    <tr>
                      <td>${donation['捐款編號']}</td>
                      <td><strong>${donation['捐款人姓名']}</strong></td>
                      <td><span class="text-success fw-bold">$${donation['金額'].toLocaleString()}</span></td>
                      <td>${donation['捐款日期']}</td>
                      <td>${donation['捐款用途']}</td>
                      <td>${donation['捐款方式']}</td>
                      <td>${donation['收據編號'] || '-'}</td>
                      <td>
                        <button class="btn btn-sm btn-info" onclick="viewDonation('${donation['捐款編號']}')">
                          <i class="fas fa-eye"></i>
                        </button>
                        ${donation['收據編號'] ? `
                          <button class="btn btn-sm btn-secondary" onclick="printReceipt('${donation['收據編號']}')">
                            <i class="fas fa-print"></i>
                          </button>
                        ` : ''}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('pageContent').innerHTML = html;
      
      if ($.fn.DataTable.isDataTable('#donationTable')) {
        $('#donationTable').DataTable().destroy();
      }
      
      $('#donationTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
        },
        order: [[3, 'desc']],
        pageLength: 25
      });
    }

    // ==================== 支出管理 ====================
    
    async function loadExpense() {
      const result = await apiCall('getExpenses');
      
      if (!result.success) {
        throw new Error(result.message || '載入支出資料失敗');
      }
      
      currentData.expenses = result.data || [];
      
      const html = `
        <div class="page-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="page-title">支出管理</h1>
              <p class="page-subtitle">管理所有支出申請與記錄</p>
            </div>
            <button class="btn btn-primary-custom btn-custom" onclick="showAddExpenseModal()">
              <i class="fas fa-plus me-2"></i>新增支出申請
            </button>
          </div>
        </div>
        
        <div class="content-card">
          <div class="content-card-body">
            <div class="table-responsive">
              <table id="expenseTable" class="table table-hover">
                <thead>
                  <tr>
                    <th>支出編號</th>
                    <th>申請人</th>
                    <th>支出日期</th>
                    <th>支出類別</th>
                    <th>支出項目</th>
                    <th>金額</th>
                    <th>優先級</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${currentData.expenses.map(expense => `
                    <tr>
                      <td>${expense['支出編號']}</td>
                      <td><strong>${expense['申請人']}</strong></td>
                      <td>${expense['支出日期']}</td>
                      <td>${expense['支出類別']}</td>
                      <td>${expense['支出項目']}</td>
                      <td><span class="text-danger fw-bold">$${expense['金額'].toLocaleString()}</span></td>
                      <td>
                        <span class="badge-custom ${
                          expense['優先級'] === '高' ? 'bg-danger' :
                          expense['優先級'] === '中' ? 'bg-warning' : 'bg-secondary'
                        }">
                          ${expense['優先級']}
                        </span>
                      </td>
                      <td>
                        <span class="badge-custom ${
                          expense['狀態'] === '已核准' ? 'bg-success' :
                          expense['狀態'] === '待核准' ? 'bg-warning' : 'bg-danger'
                        }">
                          ${expense['狀態']}
                        </span>
                      </td>
                      <td>
                        ${expense['狀態'] === '待核准' ? `
                          <button class="btn btn-sm btn-success" onclick="approveExpense('${expense['支出編號']}')">
                            <i class="fas fa-check"></i>
                          </button>
                          <button class="btn btn-sm btn-danger" onclick="rejectExpense('${expense['支出編號']}')">
                            <i class="fas fa-times"></i>
                          </button>
                        ` : `
                          <button class="btn btn-sm btn-info" onclick="viewExpense('${expense['支出編號']}')">
                            <i class="fas fa-eye"></i>
                          </button>
                        `}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('pageContent').innerHTML = html;
      
      if ($.fn.DataTable.isDataTable('#expenseTable')) {
        $('#expenseTable').DataTable().destroy();
      }
      
      $('#expenseTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
        },
        order: [[2, 'desc']],
        pageLength: 25
      });
    }

    // ==================== 收據管理 ====================
    
    async function loadReceipt() {
      const result = await apiCall('getReceipts');
      
      if (!result.success) {
        throw new Error(result.message || '載入收據資料失敗');
      }
      
      currentData.receipts = result.data || [];
      
      const html = `
        <div class="page-header">
          <h1 class="page-title">收據管理</h1>
          <p class="page-subtitle">管理所有收據開立記錄</p>
        </div>
        
        <div class="content-card">
          <div class="content-card-body">
            <div class="table-responsive">
              <table id="receiptTable" class="table table-hover">
                <thead>
                  <tr>
                    <th>收據編號</th>
                    <th>收據類型</th>
                    <th>開立日期</th>
                    <th>收款人</th>
                    <th>金額</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${currentData.receipts.map(receipt => `
                    <tr>
                      <td><strong>${receipt['收據編號']}</strong></td>
                      <td>${receipt['收據類型']}</td>
                      <td>${receipt['開立日期']}</td>
                      <td>${receipt['收款人']}</td>
                      <td>$${receipt['金額'].toLocaleString()}</td>
                      <td>
                        <span class="badge-custom ${receipt['狀態'] === '已開立' ? 'bg-success' : 'bg-danger'}">
                          ${receipt['狀態']}
                        </span>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-primary" onclick="printReceipt('${receipt['收據編號']}')">
                          <i class="fas fa-print"></i> 列印
                        </button>
                        ${receipt['狀態'] === '已開立' ? `
                          <button class="btn btn-sm btn-danger" onclick="voidReceiptConfirm('${receipt['收據編號']}')">
                            <i class="fas fa-ban"></i> 作廢
                          </button>
                        ` : ''}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('pageContent').innerHTML = html;
      
      if ($.fn.DataTable.isDataTable('#receiptTable')) {
        $('#receiptTable').DataTable().destroy();
      }
      
      $('#receiptTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
        },
        order: [[2, 'desc']],
        pageLength: 25
      });
    }

        // ==================== 核准流程 ====================
    
    async function loadApproval() {
      const result = await apiCall('getApprovals');
      
      if (!result.success) {
        throw new Error(result.message || '載入核准流程失敗');
      }
      
      currentData.approvals = result.data || [];
      
      const html = `
        <div class="page-header">
          <h1 class="page-title">核准流程</h1>
          <p class="page-subtitle">管理所有待核准項目</p>
        </div>
        
        <div class="content-card">
          <div class="content-card-body">
            <div class="table-responsive">
              <table id="approvalTable" class="table table-hover">
                <thead>
                  <tr>
                    <th>流程編號</th>
                    <th>申請類型</th>
                    <th>申請人</th>
                    <th>申請日期</th>
                    <th>金額</th>
                    <th>優先級</th>
                    <th>狀態</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${currentData.approvals.map(approval => `
                    <tr>
                      <td><strong>${approval['流程編號']}</strong></td>
                      <td>
                        <span class="badge-custom ${
                          approval['申請類型'] === '支出申請' ? 'bg-danger' : 'bg-info'
                        }">
                          ${approval['申請類型']}
                        </span>
                      </td>
                      <td>${approval['申請人']}</td>
                      <td>${approval['申請日期']}</td>
                      <td>$${approval['金額'].toLocaleString()}</td>
                      <td>
                        <span class="badge-custom ${
                          approval['優先級'] === '高' ? 'bg-danger' :
                          approval['優先級'] === '中' ? 'bg-warning' : 'bg-secondary'
                        }">
                          ${approval['優先級']}
                        </span>
                      </td>
                      <td>
                        <span class="badge-custom ${
                          approval['狀態'] === '已核准' ? 'bg-success' :
                          approval['狀態'] === '待核准' ? 'bg-warning' :
                          approval['狀態'] === '待確認' ? 'bg-info' : 'bg-danger'
                        }">
                          ${approval['狀態']}
                        </span>
                      </td>
                      <td>
                        ${approval['狀態'].includes('待') ? `
                          <button class="btn btn-sm btn-success" onclick="approveItem('${approval['流程編號']}', '${approval['申請類型']}')">
                            <i class="fas fa-check"></i> 核准
                          </button>
                          <button class="btn btn-sm btn-danger" onclick="rejectItem('${approval['流程編號']}', '${approval['申請類型']}')">
                            <i class="fas fa-times"></i> 拒絕
                          </button>
                        ` : `
                          <button class="btn btn-sm btn-info" onclick="viewApprovalDetail('${approval['流程編號']}')">
                            <i class="fas fa-eye"></i> 查看
                          </button>
                        `}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('pageContent').innerHTML = html;
      
      if ($.fn.DataTable.isDataTable('#approvalTable')) {
        $('#approvalTable').DataTable().destroy();
      }
      
      $('#approvalTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
        },
        order: [[3, 'desc']],
        pageLength: 25
      });
    }

    // ==================== 財務報表 ====================
    
    async function loadFinancialReport() {
      const result = await apiCall('getFinancialReport');
      
      if (!result.success) {
        throw new Error(result.message || '載入財務報表失敗');
      }
      
      currentData.financialReport = result.data;
      const data = result.data;
      
      const html = `
        <div class="page-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="page-title">財務報表</h1>
              <p class="page-subtitle">${data.period || '財務統計與分析'}</p>
            </div>
            <div>
              <button class="btn btn-success-custom btn-custom me-2" onclick="exportFinancialReport('excel')">
                <i class="fas fa-file-excel me-2"></i>匯出 Excel
              </button>
              <button class="btn btn-primary-custom btn-custom" onclick="exportFinancialReport('pdf')">
                <i class="fas fa-file-pdf me-2"></i>匯出 PDF
              </button>
            </div>
          </div>
        </div>
        
        <!-- 財務摘要卡片 -->
        <div class="row mb-4">
          <div class="col-md-4 mb-3">
            <div class="stats-card success">
              <div class="stats-icon success">
                <i class="fas fa-arrow-up"></i>
              </div>
              <div class="stats-number">$${(data.totalIncome || 0).toLocaleString()}</div>
              <p class="stats-label">總收入</p>
            </div>
          </div>
          
          <div class="col-md-4 mb-3">
            <div class="stats-card warning">
              <div class="stats-icon warning">
                <i class="fas fa-arrow-down"></i>
              </div>
              <div class="stats-number">$${(data.totalExpense || 0).toLocaleString()}</div>
              <p class="stats-label">總支出</p>
            </div>
          </div>
          
          <div class="col-md-4 mb-3">
            <div class="stats-card ${(data.balance || 0) >= 0 ? 'info' : 'warning'}">
              <div class="stats-icon ${(data.balance || 0) >= 0 ? 'info' : 'warning'}">
                <i class="fas fa-balance-scale"></i>
              </div>
              <div class="stats-number">$${(data.balance || 0).toLocaleString()}</div>
              <p class="stats-label">結餘</p>
            </div>
          </div>
        </div>
        
        <div class="row">
          <!-- 收入分析 -->
          <div class="col-md-6 mb-4">
            <div class="content-card">
              <div class="content-card-header">
                <h3 class="content-card-title">
                  <i class="fas fa-chart-pie me-2"></i>收入分析
                </h3>
              </div>
              <div class="content-card-body">
                <div class="chart-container">
                  <canvas id="incomeChart"></canvas>
                </div>
                <div class="mt-3">
                  ${data.incomeBreakdown ? Object.entries(data.incomeBreakdown).map(([key, value]) => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <span>${getIncomeLabel(key)}</span>
                      <strong class="text-success">$${value.toLocaleString()}</strong>
                    </div>
                  `).join('') : '<p class="text-muted">暫無資料</p>'}
                </div>
              </div>
            </div>
          </div>
          
          <!-- 支出分析 -->
          <div class="col-md-6 mb-4">
            <div class="content-card">
              <div class="content-card-header">
                <h3 class="content-card-title">
                  <i class="fas fa-chart-pie me-2"></i>支出分析
                </h3>
              </div>
              <div class="content-card-body">
                <div class="chart-container">
                  <canvas id="expenseChart"></canvas>
                </div>
                <div class="mt-3">
                  ${data.expenseBreakdown ? Object.entries(data.expenseBreakdown).map(([key, value]) => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <span>${getExpenseLabel(key)}</span>
                      <strong class="text-danger">$${value.toLocaleString()}</strong>
                    </div>
                  `).join('') : '<p class="text-muted">暫無資料</p>'}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 月度收支趨勢 -->
        <div class="row">
          <div class="col-12">
            <div class="content-card">
              <div class="content-card-header">
                <h3 class="content-card-title">
                  <i class="fas fa-chart-line me-2"></i>月度收支趨勢
                </h3>
              </div>
              <div class="content-card-body">
                <div class="chart-container" style="height: 400px;">
                  <canvas id="monthlyTrendChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('pageContent').innerHTML = html;
      
      // 繪製圖表
      renderIncomeChart(data.incomeBreakdown);
      renderExpenseChart(data.expenseBreakdown);
      renderMonthlyTrendChart(data.monthlyData);
    }
    
    function getIncomeLabel(key) {
      const labels = {
        membershipFees: '會費收入',
        donations: '捐款收入',
        other: '其他收入'
      };
      return labels[key] || key;
    }
    
    function getExpenseLabel(key) {
      const labels = {
        administrative: '行政費用',
        activities: '活動費用',
        other: '其他支出'
      };
      return labels[key] || key;
    }
    
    function renderIncomeChart(data) {
      const ctx = document.getElementById('incomeChart');
      if (!ctx || !data) return;
      
      const labels = Object.keys(data).map(key => getIncomeLabel(key));
      const values = Object.values(data);
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: [
              '#3498db',
              '#27ae60',
              '#16a085',
              '#f39c12'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
    
    function renderExpenseChart(data) {
      const ctx = document.getElementById('expenseChart');
      if (!ctx || !data) return;
      
      const labels = Object.keys(data).map(key => getExpenseLabel(key));
      const values = Object.values(data);
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: [
              '#e74c3c',
              '#e67e22',
              '#95a5a6',
              '#c0392b'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
    
    function renderMonthlyTrendChart(data) {
      const ctx = document.getElementById('monthlyTrendChart');
      if (!ctx || !data) return;
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(item => item.month),
          datasets: [
            {
              label: '收入',
              data: data.map(item => item.income),
              backgroundColor: 'rgba(39, 174, 96, 0.7)',
              borderColor: '#27ae60',
              borderWidth: 2
            },
            {
              label: '支出',
              data: data.map(item => item.expense),
              backgroundColor: 'rgba(231, 76, 60, 0.7)',
              borderColor: '#e74c3c',
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    // ==================== 系統設定 ====================
    
    async function loadSettings() {
      const result = await apiCall('getSettings');
      
      if (!result.success) {
        throw new Error(result.message || '載入系統設定失敗');
      }
      
      currentData.settings = result.data || {};
      const settings = result.data;
      
      const html = `
        <div class="page-header">
          <h1 class="page-title">系統設定</h1>
          <p class="page-subtitle">管理系統基本設定</p>
        </div>
        
        <div class="content-card">
          <div class="content-card-header">
            <h3 class="content-card-title">
              <i class="fas fa-cog me-2"></i>基本設定
            </h3>
          </div>
          <div class="content-card-body">
            <form id="settingsForm">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">組織名稱</label>
                  <input type="text" class="form-control" id="organizationName" 
                         value="${settings.organizationName || ''}" required>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label class="form-label">年度會費金額</label>
                  <input type="number" class="form-control" id="annualMembershipFee" 
                         value="${settings.annualMembershipFee || 1000}" required>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label class="form-label">收據編號前綴</label>
                  <input type="text" class="form-control" id="receiptPrefix" 
                         value="${settings.receiptPrefix || 'R'}" required>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label class="form-label">會員編號前綴</label>
                  <input type="text" class="form-control" id="memberIdPrefix" 
                         value="${settings.memberIdPrefix || 'M'}" required>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label class="form-label">財務年度開始日期</label>
                  <input type="text" class="form-control" id="fiscalYearStart" 
                         value="${settings.fiscalYearStart || '01-01'}" 
                         placeholder="MM-DD" required>
                </div>
              </div>
              
              <div class="mt-4">
                <button type="submit" class="btn btn-primary-custom btn-custom">
                  <i class="fas fa-save me-2"></i>儲存設定
                </button>
                <button type="button" class="btn btn-secondary btn-custom" onclick="loadSettings()">
                  <i class="fas fa-undo me-2"></i>重設
                </button>
              </div>
            </form>
          </div>
        </div>
        
        <!-- 資料管理 -->
        <div class="content-card mt-4">
          <div class="content-card-header">
            <h3 class="content-card-title">
              <i class="fas fa-database me-2"></i>資料管理
            </h3>
          </div>
          <div class="content-card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="card border-info">
                  <div class="card-body">
                    <h5 class="card-title">
                      <i class="fas fa-download me-2 text-info"></i>資料備份
                    </h5>
                    <p class="card-text text-muted">匯出所有系統資料作為備份</p>
                    <button class="btn btn-info" onclick="backupData()">
                      <i class="fas fa-download me-2"></i>立即備份
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <div class="card border-warning">
                  <div class="card-body">
                    <h5 class="card-title">
                      <i class="fas fa-upload me-2 text-warning"></i>資料還原
                    </h5>
                    <p class="card-text text-muted">從備份檔案還原系統資料</p>
                    <button class="btn btn-warning" onclick="restoreData()">
                      <i class="fas fa-upload me-2"></i>還原資料
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 系統資訊 -->
        <div class="content-card mt-4">
          <div class="content-card-header">
            <h3 class="content-card-title">
              <i class="fas fa-info-circle me-2"></i>系統資訊
            </h3>
          </div>
          <div class="content-card-body">
            <table class="table">
              <tbody>
                <tr>
                  <th width="200">系統版本</th>
                  <td>v1.0.0</td>
                </tr>
                <tr>
                  <th>最後更新</th>
                  <td>${new Date().toLocaleDateString('zh-TW')}</td>
                </tr>
                <tr>
                  <th>連線狀態</th>
                  <td>
                    <span class="badge ${API_CONFIG.offlineMode ? 'bg-danger' : 'bg-success'}">
                      ${API_CONFIG.offlineMode ? '離線模式' : '已連線'}
                    </span>
                  </td>
                </tr>
                <tr>
                  <th>API URL</th>
                  <td><code>${API_CONFIG.url}</code></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      document.getElementById('pageContent').innerHTML = html;
      
      // 綁定表單提交事件
      document.getElementById('settingsForm').addEventListener('submit', saveSettings);
    }
    
    async function saveSettings(e) {
      e.preventDefault();
      
      const settings = {
        organizationName: document.getElementById('organizationName').value,
        annualMembershipFee: parseInt(document.getElementById('annualMembershipFee').value),
        receiptPrefix: document.getElementById('receiptPrefix').value,
        memberIdPrefix: document.getElementById('memberIdPrefix').value,
        fiscalYearStart: document.getElementById('fiscalYearStart').value
      };
      
      try {
        const result = await apiCall('updateSettings', { settings: JSON.stringify(settings) });
        
        if (result.success) {
          showAlert('設定已成功儲存', 'success');
          currentData.settings = settings;
        } else {
          throw new Error(result.message || '儲存失敗');
        }
      } catch (error) {
        console.error('儲存設定失敗:', error);
        showAlert('儲存設定失敗：' + error.message, 'danger');
      }
    }

    // ==================== 模態框函數 ====================
    
    function showAddMemberModal() {
      const modal = new bootstrap.Modal(document.getElementById('universalModal'));
      document.getElementById('modalTitle').textContent = '新增會員';
      document.getElementById('modalBody').innerHTML = `
        <form id="addMemberForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">姓名 *</label>
              <input type="text" class="form-control" name="name" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">性別</label>
              <select class="form-select" name="gender">
                <option value="">請選擇</option>
                <option value="男">男</option>
                <option value="女">女</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">電話</label>
              <input type="tel" class="form-control" name="phone">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">電子郵件</label>
              <input type="email" class="form-control" name="email">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">出生日期</label>
              <input type="date" class="form-control" name="birthDate">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">入會日期 *</label>
              <input type="date" class="form-control" name="joinDate" 
                     value="${new Date().toISOString().split('T')[0]}" required>
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">地址</label>
              <input type="text" class="form-control" name="address">
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">備註</label>
              <textarea class="form-control" name="notes" rows="3"></textarea>
            </div>
          </div>
        </form>
      `;
      document.getElementById('modalFooter').innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="submitAddMember()">新增會員</button>
      `;
      modal.show();
    }
    
    async function submitAddMember() {
      const form = document.getElementById('addMemberForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const formData = new FormData(form);
      const memberData = Object.fromEntries(formData.entries());
      
      try {
        const result = await apiCall('addMember', memberData);
        
        if (result.success) {
          showAlert('會員新增成功', 'success');
          bootstrap.Modal.getInstance(document.getElementById('universalModal')).hide();
          loadPage('membership');
        } else {
          throw new Error(result.message || '新增失敗');
        }
      } catch (error) {
        console.error('新增會員失敗:', error);
        showAlert('新增會員失敗：' + error.message, 'danger');
      }
    }
    
    function showAddFeeModal() {
      const modal = new bootstrap.Modal(document.getElementById('universalModal'));
      document.getElementById('modalTitle').textContent = '新增會費記錄';
      document.getElementById('modalBody').innerHTML = `
        <form id="addFeeForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">會員編號 *</label>
              <input type="text" class="form-control" name="memberId" required 
                     placeholder="例如：M001">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">繳費年度 *</label>
              <input type="number" class="form-control" name="year" 
                     value="${new Date().getFullYear()}" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">金額 *</label>
              <input type="number" class="form-control" name="amount" 
                     value="${currentData.settings.annualMembershipFee || 1000}" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">繳費日期 *</label>
              <input type="date" class="form-control" name="paymentDate" 
                     value="${new Date().toISOString().split('T')[0]}" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">繳費方式 *</label>
              <select class="form-select" name="paymentMethod" required>
                <option value="">請選擇</option>
                <option value="現金">現金</option>
                <option value="轉帳">轉帳</option>
                <option value="信用卡">信用卡</option>
                <option value="支票">支票</option>
              </select>
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">備註</label>
              <textarea class="form-control" name="notes" rows="2"></textarea>
            </div>
          </div>
        </form>
      `;
      document.getElementById('modalFooter').innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="submitAddFee()">新增記錄</button>
      `;
      modal.show();
    }
    
    async function submitAddFee() {
      const form = document.getElementById('addFeeForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const formData = new FormData(form);
      const feeData = Object.fromEntries(formData.entries());
      
      try {
        const result = await apiCall('addMembershipFee', feeData);
        
        if (result.success) {
          showAlert('會費記錄新增成功', 'success');
          bootstrap.Modal.getInstance(document.getElementById('universalModal')).hide();
          loadPage('membership-fee');
        } else {
          throw new Error(result.message || '新增失敗');
        }
      } catch (error) {
        console.error('新增會費記錄失敗:', error);
        showAlert('新增會費記錄失敗：' + error.message, 'danger');
      }
    }
    
    function showAddDonationModal() {
      const modal = new bootstrap.Modal(document.getElementById('universalModal'));
      document.getElementById('modalTitle').textContent = '新增捐款';
      document.getElementById('modalBody').innerHTML = `
        <form id="addDonationForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">捐款人姓名 *</label>
              <input type="text" class="form-control" name="donorName" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">金額 *</label>
              <input type="number" class="form-control" name="amount" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">捐款日期 *</label>
              <input type="date" class="form-control" name="donationDate" 
                     value="${new Date().toISOString().split('T')[0]}" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">捐款方式 *</label>
              <select class="form-select" name="paymentMethod" required>
                <option value="">請選擇</option>
                <option value="現金">現金</option>
                <option value="轉帳">轉帳</option>
                <option value="信用卡">信用卡</option>
                <option value="支票">支票</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">捐款用途</label>
              <select class="form-select" name="purpose">
                <option value="一般捐款">一般捐款</option>
                <option value="專案捐款">專案捐款</option>
                <option value="指定用途">指定用途</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">聯絡電話</label>
              <input type="tel" class="form-control" name="phone">
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">地址（用於寄送收據）</label>
              <input type="text" class="form-control" name="address">
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">備註</label>
              <textarea class="form-control" name="notes" rows="2"></textarea>
            </div>
            <div class="col-12 mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="needReceipt" 
                       id="needReceipt" checked>
                <label class="form-check-label" for="needReceipt">
                  需要開立收據
                </label>
              </div>
            </div>
          </div>
        </form>
      `;
      document.getElementById('modalFooter').innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="submitAddDonation()">新增捐款</button>
      `;
      modal.show();
    }
    
    async function submitAddDonation() {
      const form = document.getElementById('addDonationForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const formData = new FormData(form);
      const donationData = Object.fromEntries(formData.entries());
      donationData.needReceipt = document.getElementById('needReceipt').checked;
      
      try {
        const result = await apiCall('addDonation', donationData);
        
        if (result.success) {
          showAlert('捐款記錄新增成功', 'success');
          bootstrap.Modal.getInstance(document.getElementById('universalModal')).hide();
          loadPage('donation');
        } else {
          throw new Error(result.message || '新增失敗');
        }
      } catch (error) {
        console.error('新增捐款失敗:', error);
        showAlert('新增捐款失敗：' + error.message, 'danger');
      }
    }
    
    function showAddExpenseModal() {
      const modal = new bootstrap.Modal(document.getElementById('universalModal'));
      document.getElementById('modalTitle').textContent = '新增支出申請';
      document.getElementById('modalBody').innerHTML = `
        <form id="addExpenseForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">申請人 *</label>
              <input type="text" class="form-control" name="applicant" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">支出日期 *</label>
              <input type="date" class="form-control" name="expenseDate" 
                     value="${new Date().toISOString().split('T')[0]}" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">支出類別 *</label>
              <select class="form-select" name="category" required>
                <option value="">請選擇</option>
                <option value="行政費用">行政費用</option>
                <option value="活動費用">活動費用</option>
                <option value="設備費用">設備費用</option>
                <option value="其他費用">其他費用</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">金額 *</label>
              <input type="number" class="form-control" name="amount" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">支出項目 *</label>
              <input type="text" class="form-control" name="item" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">優先級 *</label>
              <select class="form-select" name="priority" required>
                <option value="低">低</option>
                <option value="中" selected>中</option>
                <option value="高">高</option>
              </select>
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">支出說明 *</label>
              <textarea class="form-control" name="description" rows="3" required></textarea>
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">附件（發票/收據）</label>
              <input type="file" class="form-control" name="attachment" 
                     accept="image/*,.pdf">
              <small class="text-muted">支援圖片或 PDF 檔案</small>
            </div>
          </div>
        </form>
      `;
      document.getElementById('modalFooter').innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="submitAddExpense()">提交申請</button>
      `;
      modal.show();
    }
    
    async function submitAddExpense() {
      const form = document.getElementById('addExpenseForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const formData = new FormData(form);
      const expenseData = Object.fromEntries(formData.entries());
      
      try {
        const result = await apiCall('addExpense', expenseData);
        
        if (result.success) {
          showAlert('支出申請已提交，等待核准', 'success');
          bootstrap.Modal.getInstance(document.getElementById('universalModal')).hide();
          loadPage('expense');
        } else {
          throw new Error(result.message || '提交失敗');
        }
      } catch (error) {
        console.error('提交支出申請失敗:', error);
        showAlert('提交支出申請失敗：' + error.message, 'danger');
      }
    }

    // ==================== 操作函數 ====================
    
    async function confirmFee(feeId) {
      if (!confirm('確定要確認這筆會費記錄嗎？')) return;
      
      try {
        const result = await apiCall('confirmMembershipFee', { feeId });
        
        if (result.success) {
          showAlert('會費記錄已確認', 'success');
          loadPage('membership-fee');
        } else {
          throw new Error(result.message || '確認失敗');
        }
      } catch (error) {
        console.error('確認會費失敗:', error);
        showAlert('確認會費失敗：' + error.message, 'danger');
      }
    }
    
    async function approveExpense(expenseId) {
      if (!confirm('確定要核准這筆支出申請嗎？')) return;
      
      try {
        const result = await apiCall('approveExpense', { expenseId });
        
        if (result.success) {
          showAlert('支出申請已核准', 'success');
          loadPage('expense');
        } else {
          throw new Error(result.message || '核准失敗');
        }
      } catch (error) {
        console.error('核准支出失敗:', error);
        showAlert('核准支出失敗：' + error.message, 'danger');
      }
    }
    
    async function rejectExpense(expenseId) {
      const reason = prompt('請輸入拒絕原因：');
      if (!reason) return;
      
      try {
        const result = await apiCall('rejectExpense', { expenseId, reason });
        
        if (result.success) {
          showAlert('支出申請已拒絕', 'info');
          loadPage('expense');
        } else {
          throw new Error(result.message || '拒絕失敗');
        }
      } catch (error) {
        console.error('拒絕支出失敗:', error);
        showAlert('拒絕支出失敗：' + error.message, 'danger');
      }
    }
    
    async function approveItem(approvalId, type) {
      if (!confirm(`確定要核准這個${type}嗎？`)) return;
      
      try {
        const result = await apiCall('approveItem', { approvalId, type });
        
        if (result.success) {
          showAlert('已核准', 'success');
          loadPage('approval');
        } else {
          throw new Error(result.message || '核准失敗');
        }
      } catch (error) {
        console.error('核准失敗:', error);
        showAlert('核准失敗：' + error.message, 'danger');
      }
    }
    
    async function rejectItem(approvalId, type) {
      const reason = prompt('請輸入拒絕原因：');
      if (!reason) return;
      
      try {
        const result = await apiCall('rejectItem', { approvalId, type, reason });
        
        if (result.success) {
          showAlert('已拒絕', 'info');
          loadPage('approval');
        } else {
          throw new Error(result.message || '拒絕失敗');
        }
      } catch (error) {
        console.error('拒絕失敗:', error);
        showAlert('拒絕失敗：' + error.message, 'danger');
      }
    }
    
    function printReceipt(receiptId) {
      showAlert('收據列印功能開發中...', 'info');
      console.log('列印收據:', receiptId);
    }
    
    async function voidReceiptConfirm(receiptId) {
      if (!confirm('確定要作廢這張收據嗎？此操作無法復原！')) return;
      
      const reason = prompt('請輸入作廢原因：');
      if (!reason) return;
      
      try {
        const result = await apiCall('voidReceipt', { receiptId, reason });
        
        if (result.success) {
          showAlert('收據已作廢', 'warning');
          loadPage('receipt');
        } else {
          throw new Error(result.message || '作廢失敗');
        }
      } catch (error) {
        console.error('作廢收據失敗:', error);
        showAlert('作廢收據失敗：' + error.message, 'danger');
      }
    }
    
    function viewMember(memberId) {
      showAlert('會員詳情功能開發中...', 'info');
      console.log('查看會員:', memberId);
    }
    
    function viewFee(feeId) {
      showAlert('會費詳情功能開發中...', 'info');
      console.log('查看會費:', feeId);
    }
    
    function viewDonation(donationId) {
      showAlert('捐款詳情功能開發中...', 'info');
      console.log('查看捐款:', donationId);
    }
    
    function viewExpense(expenseId) {
      showAlert('支出詳情功能開發中...', 'info');
      console.log('查看支出:', expenseId);
    }
    
    function viewApprovalDetail(approvalId) {
      showAlert('核准詳情功能開發中...', 'info');
      console.log('查看核准詳情:', approvalId);
    }
    
    function exportFinancialReport(format) {
      showAlert(`匯出 ${format.toUpperCase()} 功能開發中...`, 'info');
      console.log('匯出財務報表:', format);
    }
    
    function backupData() {
      showAlert('資料備份功能開發中...', 'info');
      console.log('備份資料');
    }
    
    function restoreData() {
      showAlert('資料還原功能開發中...', 'info');
      console.log('還原資料');
    }

    // ==================== 快速操作 ====================
    
    function quickAddMember() {
      loadPage('membership');
      setTimeout(() => showAddMemberModal(), 500);
    }
    
    function quickAddExpense() {
      loadPage('expense');
      setTimeout(() => showAddExpenseModal(), 500);
    }

    // ==================== 工具函數 ====================
    
    function showAlert(message, type = 'info', duration = 5000) {
      const alertContainer = document.getElementById('alertContainer');
      const alertId = 'alert-' + Date.now();
      
      const alertHtml = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
          <i class="fas ${getAlertIcon(type)} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      
      alertContainer.insertAdjacentHTML('beforeend', alertHtml);
      
      if (duration > 0) {
        setTimeout(() => {
          const alertElement = document.getElementById(alertId);
          if (alertElement) {
            const bsAlert = new bootstrap.Alert(alertElement);
            bsAlert.close();
          }
        }, duration);
      }
    }
    
    function getAlertIcon(type) {
      const icons = {
        success: 'fa-check-circle',
        danger: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
      };
      return icons[type] || 'fa-info-circle';
    }
    
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('show');
    }
    
    function getDefaultContent(pageName) {
      return `
        <div class="page-header">
          <h1 class="page-title">${pageName}</h1>
          <p class="page-subtitle">此頁面功能開發中...</p>
        </div>
        <div class="content-card">
          <div class="content-card-body text-center py-5">
            <i class="fas fa-tools fa-4x text-muted mb-3"></i>
            <h3 class="text-muted">功能開發中</h3>
            <p class="text-muted">此功能即將推出，敬請期待！</p>
          </div>
        </div>
      `;
    }
    
    // 處理視窗大小變化
    window.addEventListener('resize', function() {
      if (window.innerWidth > 768) {
        document.getElementById('sidebar').classList.remove('show');
      }
    });
    
    // 點擊側邊欄外部關閉側邊欄（手機版）
    document.addEventListener('click', function(e) {
      const sidebar = document.getElementById('sidebar');
      const menuToggle = document.querySelector('.menu-toggle');
      
      if (window.innerWidth <= 768 && 
          sidebar.classList.contains('show') && 
          !sidebar.contains(e.target) && 
          !menuToggle.contains(e.target)) {
        sidebar.classList.remove('show');
      }
    });
  </script>
</body>
</html>
