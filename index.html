<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="LINE活動報名系統">
  <title>活動報名系統</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js" rel="stylesheet">

  <style>
    body {
      background-color: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading.active {
      display: flex;
    }

    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .profile-image {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin: 20px auto;
      display: block;
      border: 3px solid #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
      background-color: #00B900;
      border-color: #00B900;
    }

    .btn-primary:hover {
      background-color: #009900;
      border-color: #009900;
    }

    .form-control:focus {
      border-color: #00B900;
      box-shadow: 0 0 0 0.2rem rgba(0, 185, 0, 0.25);
    }

    .error-message {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }

    .error-message.show {
      display: block;
    }
  </style>
</head>

<body>
  <!-- Loading 遮罩 -->
  <div id="loading" class="loading">
    <div class="spinner-border text-light" role="status">
      <span class="visually-hidden">載入中...</span>
    </div>
  </div>

  <div class="container py-4">
    <!-- 個人資料卡片 -->
    <div class="card">
      <div class="card-body text-center">
        <img id="profileImage" src="https://via.placeholder.com/100" alt="個人頭像" class="profile-image">
        <h5 id="displayName" class="mb-1">載入中...</h5>
        <p id="loginCount" class="text-muted small mb-0">登入次數: --</p>
      </div>
    </div>

    <!-- 個人資料表單 -->
    <div class="card">
      <div class="card-body">
        <h5 class="card-title mb-4">個人資料</h5>
        <form id="profileForm" novalidate>
          <div class="mb-3">
            <label for="realName" class="form-label">真實姓名</label>
            <input type="text" class="form-control" id="realName" name="realName" required>
            <div class="error-message">請輸入真實姓名</div>
          </div>

          <div class="mb-3">
            <label for="phone" class="form-label">手機號碼</label>
            <input type="tel" class="form-control" id="phone" name="phone"
                               pattern="^09\d{8}$" required>
            <div class="error-message">請輸入有效的手機號碼</div>
          </div>

          <div class="mb-3">
            <label for="email" class="form-label">電子信箱</label>
            <input type="email" class="form-control" id="email" name="email" required>
            <div class="error-message">請輸入有效的電子信箱</div>
          </div>

          <div class="mb-3">
            <label for="birthday" class="form-label">生日</label>
            <input type="date" class="form-control" id="birthday" name="birthday">
            <div class="error-message">請選擇生日</div>
          </div>

          <div class="mb-3">
            <label for="idNumber" class="form-label">身分證字號</label>
            <input type="text" class="form-control" id="idNumber" name="idNumber"
                               pattern="^[A-Z][12]\d{8}$">
            <div class="error-message">請輸入有效的身分證字號</div>
          </div>

          <div class="mb-3">
            <label for="dietary" class="form-label">飲食習慣</label>
            <select class="form-select" id="dietary" name="dietary">
                            <option value="">請選擇</option>
                            <option value="normal">一般</option>
                            <option value="vegetarian">素食</option>
                            <option value="halal">清真</option>
                        </select>
          </div>

          <button type="submit" class="btn btn-primary w-100">更新資料</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
  <script>
    // config.js
    const CONFIG = {
    LIFF_ID: '2001679903-r5VXNe5g',  // 請替換為您的 LIFF ID
    API_URL: 'https://script.google.com/macros/s/AKfycbzX9qCDxUuSTgiE_AqyjlSor4YnHTt0EdeX_HpNkRVpJRW8ocSZLIk32gppbCeA_k1Gig/exec',  // 請替換為您的 Apps Script 部署網址
    DEBUG: true  // 開發時設為 true，正式環境設為 false
    };

    // app.js

// 全域狀態管理
const state = {
    userId: null,
    csrfToken: null,
    profile: null
};

// UI 元素管理
const UI = {
    loading: document.getElementById('loading'),
    profileImage: document.getElementById('profileImage'),
    displayName: document.getElementById('displayName'),
    loginCount: document.getElementById('loginCount'),
    profileForm: document.getElementById('profileForm'),
    
    showLoading(show = true) {
        this.loading.classList.toggle('active', show);
    },

    showError(title, message) {
        return Swal.fire({
            icon: 'error',
            title: title,
            text: message,
            confirmButtonText: '確定'
        });
    },

    showSuccess(title, message) {
        return Swal.fire({
            icon: 'success',
            title: title,
            text: message,
            confirmButtonText: '確定'
        });
    },

    updateProfile(profile) {
        this.profileImage.src = profile.pictureUrl || 'https://via.placeholder.com/100';
        this.displayName.textContent = profile.displayName || '未知用戶';
        this.loginCount.textContent = `登入次數: ${profile.loginCount || 0}`;

        // 更新表單資料
        const form = this.profileForm;
        Object.entries(profile).forEach(([key, value]) => {
            const input = form.elements[key];
            if (input && value) {
                input.value = value;
            }
        });
    }
};

// API 服務
const API = {
    async request(action, data = {}) {
        try {
            const payload = {
                ...data,
                action,
                csrfToken: state.csrfToken
            };

            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error('網路請求失敗');
            }

            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error || '請求失敗');
            }

            return result;
        } catch (error) {
            console.error('API 請求失敗:', error);
            throw error;
        }
    },

    async recordLogin(data) {
        return this.request('recordLogin', data);
    },

    async getUserProfile() {
        return this.request('getUserProfile', { userId: state.userId });
    },

    async updateProfile(data) {
        return this.request('updateProfile', {
            ...data,
            userId: state.userId
        });
    }
};

// 表單驗證
const FormValidator = {
    patterns: {
        phone: /^09\d{8}$/,
        email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
        idNumber: /^[A-Z][12]\d{8}$/
    },

    validateField(input) {
        const errorDiv = input.nextElementSibling;
        let isValid = true;
        let errorMessage = '';

        if (input.required && !input.value) {
            isValid = false;
            errorMessage = '此欄位為必填';
        } else if (input.pattern && !new RegExp(input.pattern).test(input.value)) {
            isValid = false;
            errorMessage = '格式不正確';
        }

        input.classList.toggle('is-invalid', !isValid);
        errorDiv.classList.toggle('show', !isValid);
        errorDiv.textContent = errorMessage;

        return isValid;
    },

    validateForm(form) {
        const inputs = form.querySelectorAll('input[required]');
        let isValid = true;

        inputs.forEach(input => {
            if (!this.validateField(input)) {
                isValid = false;
            }
        });

        return isValid;
    },

    setupValidation(form) {
        const inputs = form.querySelectorAll('input[required]');
        inputs.forEach(input => {
            input.addEventListener('input', () => this.validateField(input));
            input.addEventListener('blur', () => this.validateField(input));
        });
    }
};

// 應用程式初始化
async function initializeApp() {
    try {
        UI.showLoading(true);

        // 初始化 LIFF
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        // 檢查登入狀態
        if (!liff.isLoggedIn()) {
            await liff.login();
            return;
        }

        // 獲取用戶資料
        const profile = await liff.getProfile();
        state.userId = profile.userId;

        // 記錄登入
        const loginResult = await API.recordLogin({
            userId: profile.userId,
            displayName: profile.displayName,
            pictureUrl: profile.pictureUrl,
            statusMessage: profile.statusMessage,
            os: liff.getOS(),
            language: liff.getLanguage(),
            version: liff.getVersion(),
            lineVersion: liff.getLineVersion(),
            isInClient: liff.isInClient(),
            userAgent: navigator.userAgent,
            screenWidth: window.screen.width,
            screenHeight: window.screen.height
        });

        // 儲存 CSRF Token
        state.csrfToken = loginResult.csrfToken;

        // 載入用戶資料
        const userProfile = await API.getUserProfile();
        state.profile = userProfile.profile;

        // 更新 UI
        UI.updateProfile(state.profile);

        // 設定表單驗證
        FormValidator.setupValidation(UI.profileForm);

        // 處理表單提交
        UI.profileForm.addEventListener('submit', handleFormSubmit);

    } catch (error) {
        console.error('初始化失敗:', error);
        await UI.showError('初始化失敗', 
            CONFIG.DEBUG ? error.message : '請重新整理頁面後再試');
    } finally {
        UI.showLoading(false);
    }
}

// 表單提交處理
async function handleFormSubmit(event) {
    event.preventDefault();

    if (!FormValidator.validateForm(event.target)) {
        return;
    }

    try {
        UI.showLoading(true);

        const formData = new FormData(event.target);
        const profileData = Object.fromEntries(formData.entries());

        await API.updateProfile(profileData);
        await UI.showSuccess('更新成功', '您的個人資料已更新');

    } catch (error) {
        console.error('更新失敗:', error);
        await UI.showError('更新失敗', 
            CONFIG.DEBUG ? error.message : '請稍後再試');
    } finally {
        UI.showLoading(false);
    }
}

// 錯誤處理
window.addEventListener('error', (event) => {
    console.error('全域錯誤:', event.error);
});

window.addEventListener('unhandledrejection', (event) => {
    console.error('未處理的 Promise 錯誤:', event.reason);
});

// 啟動應用程式
document.addEventListener('DOMContentLoaded', initializeApp);

  </script>
  
</body>

</html>
