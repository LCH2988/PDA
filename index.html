<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#667eea">
  <title>ä¸‰éµé£›ç¿”å¥½å”æœƒæ´»å‹•å ±åç³»çµ±</title>
  
  <!-- LINE LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    /* ========================================
       åŸºç¤æ¨£å¼è¨­å®š
       ======================================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #667eea;
      --primary-dark: #5568d3;
      --secondary-color: #764ba2;
      --success-color: #4CAF50;
      --danger-color: #f44336;
      --warning-color: #ff9800;
      --info-color: #2196F3;
      --light-gray: #f5f5f5;
      --border-color: #e0e0e0;
      --text-primary: #333;
      --text-secondary: #666;
      --text-light: #999;
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.15);
      --border-radius: 10px;
      --transition: all 0.3s ease;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, 
                   "Helvetica Neue", Arial, "Noto Sans", sans-serif,
                   "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      min-height: 100vh;
      padding: 10px;
      line-height: 1.6;
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ========================================
       å®¹å™¨èˆ‡ä½ˆå±€
       ======================================== */
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding-bottom: 20px;
    }

    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: var(--shadow-md);
      text-align: center;
      animation: slideDown 0.5s ease;
    }

    .header h1 {
      color: var(--primary-color);
      font-size: 24px;
      margin-bottom: 8px;
      font-weight: 700;
    }

    .header p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .user-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid var(--primary-color);
    }

    .user-name {
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
    }

    /* ========================================
       åˆ†é æ¨™ç±¤
       ======================================== */
    .tabs {
      display: flex;
      background: white;
      border-radius: 15px;
      padding: 5px;
      margin-bottom: 15px;
      box-shadow: var(--shadow-md);
      gap: 5px;
      animation: slideDown 0.5s ease 0.1s both;
    }

    .tab {
      flex: 1;
      padding: 12px 8px;
      text-align: center;
      border-radius: 10px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      color: var(--text-secondary);
      font-size: 14px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .tab:active {
      transform: scale(0.95);
    }

    .tab.active {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    /* ========================================
       å…§å®¹å€åŸŸ
       ======================================== */
    .content {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--shadow-md);
      min-height: 400px;
      animation: fadeIn 0.5s ease 0.2s both;
    }

    .page {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .page.active {
      display: block;
    }

    /* ========================================
       é¡åˆ¥ç¯©é¸æŒ‰éˆ•
       ======================================== */
    .category-filter {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      animation: slideUp 0.5s ease;
    }

    .category-btn {
      padding: 8px 16px;
      border: 2px solid var(--primary-color);
      background: white;
      color: var(--primary-color);
      border-radius: 20px;
      cursor: pointer;
      transition: var(--transition);
      font-size: 13px;
      font-weight: 500;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .category-btn:active {
      transform: scale(0.95);
    }

    .category-btn.active {
      background: var(--primary-color);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    /* ========================================
       æ´»å‹•å¡ç‰‡
       ======================================== */
    .activity-card {
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 16px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: var(--transition);
      background: white;
      animation: slideUp 0.3s ease;
    }

    .activity-card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .activity-card:active {
      transform: translateY(0);
    }

    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      gap: 10px;
    }

    .activity-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .activity-category {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 600;
      color: white;
      white-space: nowrap;
    }

    .category-mountain { background: var(--success-color); }
    .category-bike { background: var(--info-color); }
    .category-run { background: var(--warning-color); }
    .category-swim { background: #00BCD4; }

    .activity-info {
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.8;
    }

    .activity-info div {
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .activity-status {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 12px;
    }

    .status-open {
      background: #d4edda;
      color: #155724;
    }

    .status-full {
      background: #f8d7da;
      color: #721c24;
    }

    .status-closed {
      background: #e2e3e5;
      color: #383d41;
    }

    .status-soon {
      background: #fff3cd;
      color: #856404;
    }

    /* ========================================
       è¡¨å–®å…ƒç´ 
       ======================================== */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-label.required::after {
      content: ' *';
      color: var(--danger-color);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      transition: var(--transition);
      font-family: inherit;
      background: white;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-input:disabled,
    .form-select:disabled,
    .form-textarea:disabled {
      background: var(--light-gray);
      cursor: not-allowed;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
      line-height: 1.6;
    }

    .form-hint {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 6px;
    }

    /* ========================================
       æŒ‰éˆ•æ¨£å¼
       ======================================== */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      width: 100%;
      text-align: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--light-gray);
      color: var(--text-primary);
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-warning {
      background: var(--warning-color);
      color: white;
    }

    .btn-outline {
      background: white;
      color: var(--primary-color);
      border: 2px solid var(--primary-color);
    }

    .btn-add {
      background: white;
      color: var(--primary-color);
      border: 2px dashed var(--primary-color);
      margin-top: 10px;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 13px;
    }

    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }

    /* ========================================
       åƒåŠ è€…å¡ç‰‡ï¼ˆåœ˜å ±ç”¨ï¼‰
       ======================================== */
    .participant-card {
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 16px;
      margin-bottom: 15px;
      position: relative;
      background: #fafafa;
      animation: slideUp 0.3s ease;
    }

    .participant-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-color);
    }

    .participant-number {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary-color);
    }

    .btn-remove {
      background: var(--danger-color);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: var(--transition);
    }

    .btn-remove:active {
      transform: scale(0.95);
    }

    /* ========================================
       æ ¸å–æ–¹å¡Š
       ======================================== */
    .checkbox-group {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin: 20px 0;
      padding: 16px;
      background: var(--light-gray);
      border-radius: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      margin-top: 4px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-group label {
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-secondary);
      cursor: pointer;
      user-select: none;
    }

    /* ========================================
       æ³¨æ„äº‹é …æ¡†
       ======================================== */
    .notice-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
    }

    .notice-box h3 {
      color: #856404;
      font-size: 16px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .notice-box ul {
      margin-left: 20px;
      color: #856404;
      font-size: 14px;
      line-height: 1.8;
    }

    .notice-box li {
      margin-bottom: 6px;
    }

    /* ========================================
       æç¤ºè¨Šæ¯
       ======================================== */
    .alert {
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
      line-height: 1.6;
      animation: slideDown 0.3s ease;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    /* ========================================
       è¼‰å…¥èˆ‡ç©ºç‹€æ…‹
       ======================================== */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-light);
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--light-gray);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-light);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state p {
      font-size: 16px;
      color: var(--text-light);
    }

    /* ========================================
       Modal å½ˆçª—
       ======================================== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 0;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 2px solid var(--border-color);
      position: sticky;
      top: 0;
      background: white;
      z-index: 1;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--text-light);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
      padding: 0;
    }

    .btn-close:hover {
      background: var(--light-gray);
      color: var(--text-primary);
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 2px solid var(--border-color);
      position: sticky;
      bottom: 0;
      background: white;
    }

    /* ========================================
       å‹•ç•«æ•ˆæœ
       ======================================== */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ========================================
       éŸ¿æ‡‰å¼è¨­è¨ˆ
       ======================================== */
    @media (max-width: 600px) {
      body {
        padding: 8px;
      }

      .header h1 {
        font-size: 20px;
      }

      .tab {
        font-size: 13px;
        padding: 10px 6px;
      }

      .activity-title {
        font-size: 16px;
      }

      .btn-group {
        grid-template-columns: 1fr;
      }

      .modal-content {
        max-height: 95vh;
      }
    }

    /* ========================================
       å·¥å…·é¡åˆ¥
       ======================================== */
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .text-muted { color: var(--text-light); }
    .mt-10 { margin-top: 10px; }
    .mt-20 { margin-top: 20px; }
    .mb-10 { margin-bottom: 10px; }
    .mb-20 { margin-bottom: 20px; }
    .hidden { display: none !important; }
    .flex { display: flex; }
    .flex-center { display: flex; align-items: center; justify-content: center; }
    .gap-10 { gap: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- æ¨™é¡Œå€åŸŸ -->
    <div class="header">
      <h1>ğŸƒâ€â™‚ï¸ ä¸‰éµé£›ç¿”å¥½å”æœƒ</h1>
      <p>æ´»å‹•å ±åç³»çµ±</p>
      <div class="user-info hidden" id="userInfo">
        <img class="user-avatar" id="userAvatar" src="" alt="User">
        <span class="user-name" id="userName"></span>
      </div>
    </div>

    <!-- åˆ†é æ¨™ç±¤ -->
    <div class="tabs">
      <div class="tab active" data-tab="activities">æ´»å‹•åˆ—è¡¨</div>
      <div class="tab" data-tab="myRegistrations">æˆ‘çš„å ±å</div>
      <div class="tab" data-tab="profile">å€‹äººè³‡æ–™</div>
    </div>

    <!-- å…§å®¹å€åŸŸ -->
    <div class="content">
      <!-- æ´»å‹•åˆ—è¡¨é é¢ -->
      <div id="activitiesPage" class="page active">
        <div class="category-filter">
          <button class="category-btn active" data-category="all">å…¨éƒ¨</button>
          <button class="category-btn" data-category="mountain">ğŸ”ï¸ ç™»å±±</button>
          <button class="category-btn" data-category="bike">ğŸš´ å–®è»Š</button>
          <button class="category-btn" data-category="run">ğŸƒ è·¯è·‘</button>
          <button class="category-btn" data-category="swim">ğŸŠ æ¸¸æ³³</button>
        </div>
        <div id="activitiesList">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>

      <!-- æˆ‘çš„å ±åé é¢ -->
      <div id="myRegistrationsPage" class="page">
        <div id="registrationsList">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>

      <!-- å€‹äººè³‡æ–™é é¢ -->
      <div id="profilePage" class="page">
        <div id="profileContent">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ´»å‹•è©³æƒ… Modal -->
  <div id="activityModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">æ´»å‹•è©³æƒ…</div>
        <button class="btn-close" onclick="closeModal('activityModal')">&times;</button>
      </div>
      <div class="modal-body" id="activityDetail"></div>
    </div>
  </div>

  <!-- å ±å Modal -->
  <div id="registrationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="registrationModalTitle">å ±å</div>
        <button class="btn-close" onclick="closeModal('registrationModal')">&times;</button>
      </div>
      <div class="modal-body" id="registrationForm"></div>
    </div>
  </div>
  <script>
    // ============================================
    // å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š
    // ============================================
    let liff;
    let lineUserId = null;
    let currentUser = null;
    let currentActivity = null;
    let currentCategory = 'all';
    let allActivities = [];
    
    // API ç«¯é»ï¼ˆè«‹æ›¿æ›ç‚ºæ‚¨çš„ Google Apps Script Web App URLï¼‰
    const API_URL = 'https://script.google.com/macros/s/AKfycbz19jQ3dNmXAiVyq_F0fMaX_gE3Nlbpv3VTNrboGyJ116kiuc0l87CyzgaUvLVLApEr/exec';
    
    // LIFF IDï¼ˆè«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF IDï¼‰
    const LIFF_ID = '2007905012-NXJEXmda';

    // ============================================
    // åˆå§‹åŒ– LIFF
    // ============================================
    async function initializeLiff() {
      try {
        console.log('åˆå§‹åŒ– LIFF...');
        
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          console.log('æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
          liff.login();
          return;
        }
        
        console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');
        
        // å–å¾—ä½¿ç”¨è€…è³‡æ–™
        const profile = await liff.getProfile();
        lineUserId = profile.userId;
        
        console.log('ä½¿ç”¨è€… ID:', lineUserId);
        
        // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
        displayUserInfo(profile);
        
        // è¨»å†Šæˆ–å–å¾—æœƒå“¡è³‡æ–™
        await registerOrGetMember(profile);
        
        // è¼‰å…¥æ´»å‹•åˆ—è¡¨
        await loadActivities();
        
      } catch (error) {
        console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
        showAlert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
      }
    }

    // ============================================
    // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
    // ============================================
    function displayUserInfo(profile) {
      const userInfo = document.getElementById('userInfo');
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');
      
      if (profile.pictureUrl) {
        userAvatar.src = profile.pictureUrl;
      }
      
      userName.textContent = profile.displayName || 'æœƒå“¡';
      userInfo.classList.remove('hidden');
    }

    // ============================================
    // è¨»å†Šæˆ–å–å¾—æœƒå“¡
    // ============================================
    async function registerOrGetMember(profile) {
      try {
        const response = await apiRequest('registerMember', {
          memberData: {
            line_user_id: lineUserId,
            name: profile.displayName || '',
            phone: '',
            email: ''
          }
        });
        
        if (response.success) {
          currentUser = response.data;
          console.log('æœƒå“¡è³‡æ–™:', currentUser);
        } else {
          console.error('è¨»å†Šæœƒå“¡å¤±æ•—:', response.message);
        }
        
      } catch (error) {
        console.error('è¨»å†Šæœƒå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      }
    }

    // ============================================
    // API è«‹æ±‚å‡½æ•¸
    // ============================================
    async function apiRequest(action, data = {}) {
      try {
        showLoading(true);
        
        const requestData = {
          action: action,
          ...data
        };
        
        console.log('API è«‹æ±‚:', requestData);
        
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('API å›æ‡‰:', result);
        
        return result;
        
      } catch (error) {
        console.error('API è«‹æ±‚å¤±æ•—:', error);
        return { 
          success: false, 
          message: 'API è«‹æ±‚å¤±æ•—: ' + error.message 
        };
      } finally {
        showLoading(false);
      }
    }

    // ============================================
    // è¼‰å…¥æ´»å‹•åˆ—è¡¨
    // ============================================
    async function loadActivities() {
      try {
        const response = await apiRequest('getActivities', {
          filters: {
            open_only: false,
            upcoming: true
          }
        });
        
        if (response.success) {
          allActivities = response.data;
          displayActivities(allActivities);
        } else {
          showEmptyState('activitiesList', 'ç„¡æ³•è¼‰å…¥æ´»å‹•åˆ—è¡¨');
        }
        
      } catch (error) {
        console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', error);
        showEmptyState('activitiesList', 'è¼‰å…¥æ´»å‹•æ™‚ç™¼ç”ŸéŒ¯èª¤');
      }
    }

    // ============================================
    // é¡¯ç¤ºæ´»å‹•åˆ—è¡¨
    // ============================================
    function displayActivities(activities) {
      const container = document.getElementById('activitiesList');
      
      // ä¾é¡åˆ¥ç¯©é¸
      let filteredActivities = activities;
      if (currentCategory !== 'all') {
        filteredActivities = activities.filter(a => a.category === currentCategory);
      }
      
      if (filteredActivities.length === 0) {
        showEmptyState('activitiesList', 'ç›®å‰æ²’æœ‰æ´»å‹•');
        return;
      }
      
      const html = filteredActivities.map(activity => {
        const categoryClass = `category-${activity.category}`;
        const categoryName = getCategoryName(activity.category);
        
        // è¨ˆç®—å ±åç‹€æ…‹
        const statusInfo = getActivityStatus(activity);
        
        return `
          <div class="activity-card" onclick="showActivityDetail('${activity.activity_id}')">
            <div class="activity-header">
              <div style="flex: 1;">
                <div class="activity-title">${escapeHtml(activity.activity_name)}</div>
                <span class="activity-category ${categoryClass}">${categoryName}</span>
              </div>
            </div>
            <div class="activity-info">
              <div>ğŸ“… ${formatDate(activity.activity_date)}</div>
              <div>ğŸ“ ${escapeHtml(activity.location)}</div>
              <div>ğŸ‘¥ ${activity.current_participants} / ${activity.max_participants} äºº</div>
              <div>ğŸ“ å ±åæœŸé™ï¼š${formatDate(activity.registration_end)}</div>
            </div>
            <span class="activity-status ${statusInfo.className}">${statusInfo.text}</span>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
    }

    // ============================================
    // å–å¾—æ´»å‹•ç‹€æ…‹
    // ============================================
    function getActivityStatus(activity) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const regStart = new Date(activity.registration_start);
      const regEnd = new Date(activity.registration_end);
      const activityDate = new Date(activity.activity_date);
      
      regStart.setHours(0, 0, 0, 0);
      regEnd.setHours(23, 59, 59, 999);
      
      // æª¢æŸ¥æ˜¯å¦é¡æ»¿
      if (activity.current_participants >= activity.max_participants) {
        return { className: 'status-full', text: 'âŒ å·²é¡æ»¿' };
      }
      
      // æª¢æŸ¥å ±åæ˜¯å¦é–‹å§‹
      if (today < regStart) {
        return { className: 'status-closed', text: 'â° å°šæœªé–‹æ”¾' };
      }
      
      // æª¢æŸ¥å ±åæ˜¯å¦çµæŸ
      if (today > regEnd) {
        return { className: 'status-closed', text: 'â° å ±åæˆªæ­¢' };
      }
      
      // æª¢æŸ¥æ´»å‹•æ˜¯å¦å·²éæœŸ
      if (today > activityDate) {
        return { className: 'status-closed', text: 'âœ… å·²çµæŸ' };
      }
      
      // æª¢æŸ¥æ˜¯å¦å³å°‡é¡æ»¿
      const availableSlots = activity.max_participants - activity.current_participants;
      if (availableSlots <= 5) {
        return { className: 'status-soon', text: `âš ï¸ å‰©é¤˜ ${availableSlots} åé¡` };
      }
      
      // é–‹æ”¾å ±åä¸­
      return { className: 'status-open', text: 'âœ… é–‹æ”¾å ±å' };
    }

    // ============================================
    // é¡¯ç¤ºæ´»å‹•è©³æƒ…
    // ============================================
    async function showActivityDetail(activityId) {
      try {
        const response = await apiRequest('getActivityDetail', {
          activityId: activityId
        });
        
        if (!response.success) {
          showAlert(response.message, 'error');
          return;
        }
        
        currentActivity = response.data;
        
        // æª¢æŸ¥æ˜¯å¦å·²å ±å
        const checkResponse = await apiRequest('checkMemberRegistration', {
          lineUserId: lineUserId,
          activityId: activityId
        });
        
        const isRegistered = checkResponse.success && checkResponse.is_registered;
        
        // é¡¯ç¤ºè©³æƒ…
        displayActivityDetail(currentActivity, isRegistered);
        openModal('activityModal');
        
      } catch (error) {
        console.error('è¼‰å…¥æ´»å‹•è©³æƒ…å¤±æ•—:', error);
        showAlert('è¼‰å…¥æ´»å‹•è©³æƒ…å¤±æ•—', 'error');
      }
    }

    // ============================================
    // é¡¯ç¤ºæ´»å‹•è©³æƒ…å…§å®¹
    // ============================================
    function displayActivityDetail(activity, isRegistered) {
      const categoryName = getCategoryName(activity.category);
      const categoryClass = `category-${activity.category}`;
      
      let registrationItemsHtml = '';
      if (activity.registration_items && activity.registration_items.length > 0) {
        registrationItemsHtml = `
          <div class="form-group">
            <div class="form-label">å ±åé …ç›®</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              ${activity.registration_items.map(item => `
                <div style="padding: 10px; background: var(--light-gray); border-radius: 6px;">
                  â€¢ ${escapeHtml(item.item_name)}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      let surveyItemsHtml = '';
      if (activity.survey_items && activity.survey_items.length > 0) {
        surveyItemsHtml = `
          <div class="form-group">
            <div class="form-label">èª¿æŸ¥é …ç›®</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              ${activity.survey_items.map(item => `
                <div style="padding: 10px; background: var(--light-gray); border-radius: 6px;">
                  â€¢ ${escapeHtml(item.survey_question)}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      let notesHtml = '';
      if (activity.notes) {
        notesHtml = `
          <div class="notice-box">
            <h3>ğŸ“ æ´»å‹•èªªæ˜</h3>
            <p style="white-space: pre-wrap; line-height: 1.8;">${escapeHtml(activity.notes)}</p>
          </div>
        `;
      }
      
      let actionButtonsHtml = '';
      if (isRegistered) {
        actionButtonsHtml = `
          <div class="alert alert-success">
            âœ… æ‚¨å·²å ±åæ­¤æ´»å‹•
          </div>
          <button class="btn btn-secondary" onclick="closeModal('activityModal')">é—œé–‰</button>
        `;
      } else if (activity.can_register) {
        actionButtonsHtml = `
          <div class="btn-group">
            <button class="btn btn-primary" onclick="showRegistrationForm('individual')">
              å€‹äººå ±å
            </button>
            <button class="btn btn-outline" onclick="showRegistrationForm('group')">
              åœ˜é«”å ±å
            </button>
          </div>
        `;
      } else {
        actionButtonsHtml = `
          <div class="alert alert-warning">
            ${activity.status_message}
          </div>
          <button class="btn btn-secondary" onclick="closeModal('activityModal')">é—œé–‰</button>
        `;
      }
      
      const html = `
        <div style="margin-bottom: 20px;">
          <span class="activity-category ${categoryClass}">${categoryName}</span>
          <h2 style="margin: 12px 0; font-size: 22px; color: var(--text-primary);">
            ${escapeHtml(activity.activity_name)}
          </h2>
        </div>
        
        <div class="activity-info" style="margin-bottom: 20px;">
          <div>ğŸ“… æ´»å‹•æ—¥æœŸï¼š${formatDate(activity.activity_date)}</div>
          <div>ğŸ“ æ´»å‹•åœ°é»ï¼š${escapeHtml(activity.location)}</div>
          <div>ğŸ‘¥ å ±åäººæ•¸ï¼š${activity.current_participants} / ${activity.max_participants} äºº</div>
          <div>ğŸ“ å ±åæœŸé–“ï¼š${formatDate(activity.registration_start)} ~ ${formatDate(activity.registration_end)}</div>
          ${activity.available_slots !== undefined ? `<div>ğŸ« å‰©é¤˜åé¡ï¼š${activity.available_slots} äºº</div>` : ''}
        </div>
        
        ${notesHtml}
        ${registrationItemsHtml}
        ${surveyItemsHtml}
        
        <div class="notice-box">
          <h3>âš ï¸ æ³¨æ„äº‹é …</h3>
          <ul>
            <li>è«‹ç¢ºèªæ´»å‹•æ—¥æœŸèˆ‡æ™‚é–“</li>
            <li>å ±åå¾Œè«‹æº–æ™‚åƒåŠ </li>
            <li>æ´»å‹•å‰ 3 å¤©å…§ç„¡æ³•å–æ¶ˆå ±å</li>
            <li>å¦‚æœ‰ç–‘å•è«‹è¯ç¹«ä¸»è¾¦å–®ä½</li>
          </ul>
        </div>
        
        ${actionButtonsHtml}
      `;
      
      document.getElementById('activityDetail').innerHTML = html;
    }

    // ============================================
    // é¡¯ç¤ºå ±åè¡¨å–®
    // ============================================
    function showRegistrationForm(type) {
      closeModal('activityModal');
      
      const modalTitle = document.getElementById('registrationModalTitle');
      modalTitle.textContent = type === 'individual' ? 'å€‹äººå ±å' : 'åœ˜é«”å ±å';
      
      if (type === 'individual') {
        displayIndividualRegistrationForm();
      } else {
        displayGroupRegistrationForm();
      }
      
      openModal('registrationModal');
    }

    // ============================================
    // é¡¯ç¤ºå€‹äººå ±åè¡¨å–®
    // ============================================
    function displayIndividualRegistrationForm() {
      let registrationItemsHtml = '';
      if (currentActivity.registration_items && currentActivity.registration_items.length > 0) {
        registrationItemsHtml = `
          <div class="form-group">
            <label class="form-label required">å ±åé …ç›®</label>
            <select class="form-select" id="selectedItem" required>
              <option value="">è«‹é¸æ“‡</option>
              ${currentActivity.registration_items.map(item => `
                <option value="${escapeHtml(item.item_name)}">${escapeHtml(item.item_name)}</option>
              `).join('')}
            </select>
          </div>
        `;
      }
      
      let surveyItemsHtml = '';
      if (currentActivity.survey_items && currentActivity.survey_items.length > 0) {
        surveyItemsHtml = `
          <div style="margin: 20px 0;">
            <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--text-primary);">ğŸ“‹ èª¿æŸ¥é …ç›®</h3>
            ${currentActivity.survey_items.map((item, index) => `
              <div class="form-group">
                <label class="form-label">${escapeHtml(item.survey_question)}</label>
                ${item.survey_type === 'textarea' ? 
                  `<textarea class="form-textarea" id="survey_${index}" placeholder="è«‹è¼¸å…¥..."></textarea>` :
                  `<input type="text" class="form-input" id="survey_${index}" placeholder="è«‹è¼¸å…¥...">`
                }
              </div>
            `).join('')}
          </div>
        `;
      }
      
      const html = `
        <form id="individualRegistrationForm" onsubmit="submitIndividualRegistration(event)">
          <div class="alert alert-info">
            <strong>æ´»å‹•åç¨±ï¼š</strong>${escapeHtml(currentActivity.activity_name)}<br>
            <strong>æ´»å‹•æ—¥æœŸï¼š</strong>${formatDate(currentActivity.activity_date)}
          </div>
          
          ${registrationItemsHtml}
          
          <div class="form-group">
            <label class="form-label">å‚™è¨»</label>
            <textarea class="form-textarea" id="notes" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚è«‹è¨»æ˜..."></textarea>
          </div>
          
          ${surveyItemsHtml}
          
          <div class="notice-box">
            <h3>âš ï¸ å ±åé ˆçŸ¥</h3>
            <ul>
              <li>å ±åå¾Œè«‹æº–æ™‚åƒåŠ æ´»å‹•</li>
              <li>æ´»å‹•å‰ 3 å¤©å…§ç„¡æ³•å–æ¶ˆå ±å</li>
              <li>å¦‚éœ€å–æ¶ˆè«‹è‡³ã€Œæˆ‘çš„å ±åã€é é¢æ“ä½œ</li>
              <li>å ±åå³è¡¨ç¤ºåŒæ„æ´»å‹•ç›¸é—œè¦å®š</li>
            </ul>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="agreement" required>
            <label for="agreement">
              æˆ‘å·²è©³é–±ä¸¦åŒæ„æ´»å‹•è¦å®šåŠæˆæ¬Šæ¢æ¬¾
            </label>
          </div>
          
          <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="closeModal('registrationModal')">
              å–æ¶ˆ
            </button>
            <button type="submit" class="btn btn-primary">
              ç¢ºèªå ±å
            </button>
          </div>
        </form>
      `;
      
      document.getElementById('registrationForm').innerHTML = html;
    }

    // ============================================
    // é¡¯ç¤ºåœ˜é«”å ±åè¡¨å–®
    // ============================================
    function displayGroupRegistrationForm() {
      const html = `
        <form id="groupRegistrationForm" onsubmit="submitGroupRegistration(event)">
          <div class="alert alert-info">
            <strong>æ´»å‹•åç¨±ï¼š</strong>${escapeHtml(currentActivity.activity_name)}<br>
            <strong>æ´»å‹•æ—¥æœŸï¼š</strong>${formatDate(currentActivity.activity_date)}<br>
            <strong>åœ˜å ±ä¸Šé™ï¼š</strong>æœ€å¤š 5 äºº
          </div>
          
          <div id="participantsList">
            <!-- åƒåŠ è€…å°‡å‹•æ…‹åŠ å…¥ -->
          </div>
          
          <button type="button" class="btn btn-add" onclick="addParticipant()">
            â• æ–°å¢åƒåŠ è€…
          </button>
          
          <div class="notice-box" style="margin-top: 20px;">
            <h3>âš ï¸ åœ˜å ±é ˆçŸ¥</h3>
            <ul>
              <li>åœ˜å ±æœ€å¤š 5 äºº</li>
              <li>å–æ¶ˆåœ˜å ±å°‡å–æ¶ˆæ‰€æœ‰æˆå“¡çš„å ±å</li>
              <li>æ´»å‹•å‰ 3 å¤©å…§ç„¡æ³•å–æ¶ˆå ±å</li>
              <li>è«‹ç¢ºèªæ‰€æœ‰åƒåŠ è€…è³‡æ–™æ­£ç¢º</li>
            </ul>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="groupAgreement" required>
            <label for="groupAgreement">
              æˆ‘å·²è©³é–±ä¸¦åŒæ„æ´»å‹•è¦å®šåŠæˆæ¬Šæ¢æ¬¾ï¼Œä¸”å·²å–å¾—æ‰€æœ‰åƒåŠ è€…åŒæ„
            </label>
          </div>
          
          <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="closeModal('registrationModal')">
              å–æ¶ˆ
            </button>
            <button type="submit" class="btn btn-primary">
              ç¢ºèªåœ˜å ±
            </button>
          </div>
        </form>
      `;
      
      document.getElementById('registrationForm').innerHTML = html;
      
      // é è¨­æ–°å¢ä¸€ä½åƒåŠ è€…
      addParticipant();
    }

    // ============================================
    // æ–°å¢åƒåŠ è€…
    // ============================================
    let participantCount = 0;

    function addParticipant() {
      if (participantCount >= 5) {
        showAlert('åœ˜å ±æœ€å¤š 5 äºº', 'warning');
        return;
      }
      
      participantCount++;
      const participantId = `participant_${participantCount}`;
      
      let registrationItemsHtml = '';
      if (currentActivity.registration_items && currentActivity.registration_items.length > 0) {
        registrationItemsHtml = `
          <div class="form-group">
            <label class="form-label required">å ±åé …ç›®</label>
            <select class="form-select" id="${participantId}_item" required>
              <option value="">è«‹é¸æ“‡</option>
              ${currentActivity.registration_items.map(item => `
                <option value="${escapeHtml(item.item_name)}">${escapeHtml(item.item_name)}</option>
              `).join('')}
            </select>
          </div>
        `;
      }
      
      let surveyItemsHtml = '';
      if (currentActivity.survey_items && currentActivity.survey_items.length > 0) {
        surveyItemsHtml = `
          <div style="margin-top: 15px;">
            <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px; color: var(--text-secondary);">
              ğŸ“‹ èª¿æŸ¥é …ç›®
            </div>
            ${currentActivity.survey_items.map((item, index) => `
              <div class="form-group">
                <label class="form-label">${escapeHtml(item.survey_question)}</label>
                ${item.survey_type === 'textarea' ? 
                  `<textarea class="form-textarea" id="${participantId}_survey_${index}" placeholder="è«‹è¼¸å…¥..."></textarea>` :
                  `<input type="text" class="form-input" id="${participantId}_survey_${index}" placeholder="è«‹è¼¸å…¥...">`
                }
              </div>
            `).join('')}
          </div>
        `;
      }
      
      const html = `
        <div class="participant-card" id="${participantId}">
          <div class="participant-header">
            <div class="participant-number">åƒåŠ è€… ${participantCount}</div>
            ${participantCount > 1 ? `<button type="button" class="btn-remove" onclick="removeParticipant('${participantId}')">ç§»é™¤</button>` : ''}
          </div>
          
          <div class="form-group">
            <label class="form-label required">å§“å</label>
            <input type="text" class="form-input" id="${participantId}_name" placeholder="è«‹è¼¸å…¥å§“å" required>
          </div>
          
          ${registrationItemsHtml}
          
          <div class="form-group">
            <label class="form-label">å‚™è¨»</label>
            <textarea class="form-textarea" id="${participantId}_notes" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚è«‹è¨»æ˜..."></textarea>
          </div>
          
          ${surveyItemsHtml}
        </div>
      `;
      
      document.getElementById('participantsList').insertAdjacentHTML('beforeend', html);
    }

    // ============================================
    // ç§»é™¤åƒåŠ è€…
    // ============================================
    function removeParticipant(participantId) {
      const element = document.getElementById(participantId);
      if (element) {
        element.remove();
        participantCount--;
        
        // é‡æ–°ç·¨è™Ÿ
        const participants = document.querySelectorAll('.participant-card');
        participants.forEach((card, index) => {
          const numberElement = card.querySelector('.participant-number');
          if (numberElement) {
            numberElement.textContent = `åƒåŠ è€… ${index + 1}`;
          }
        });
      }
    }

    // ============================================
    // æäº¤å€‹äººå ±å
    // ============================================
    async function submitIndividualRegistration(event) {
      event.preventDefault();
      
      try {
        const selectedItem = document.getElementById('selectedItem')?.value || '';
        const notes = document.getElementById('notes')?.value || '';
        const agreement = document.getElementById('agreement').checked;
        
        if (!agreement) {
          showAlert('è«‹åŒæ„æ´»å‹•è¦å®šåŠæˆæ¬Šæ¢æ¬¾', 'warning');
          return;
        }
        
        // æ”¶é›†èª¿æŸ¥é …ç›®ç­”æ¡ˆ
        const surveyAnswers = {};
        if (currentActivity.survey_items) {
          currentActivity.survey_items.forEach((item, index) => {
            const answer = document.getElementById(`survey_${index}`)?.value || '';
            surveyAnswers[item.survey_question] = answer;
          });
        }
        
        const registrationData = {
          activity_id: currentActivity.activity_id,
          line_user_id: lineUserId,
          selected_item: selectedItem,
          notes: notes,
          survey_answers: surveyAnswers,
          agreement_checked: true
        };
        
        const response = await apiRequest('individualRegistration', {
          registrationData: registrationData
        });
        
        if (response.success) {
          showAlert('å ±åæˆåŠŸï¼', 'success');
          closeModal('registrationModal');
          
          // é‡æ–°è¼‰å…¥æ´»å‹•åˆ—è¡¨
          await loadActivities();
          
          // åˆ‡æ›åˆ°æˆ‘çš„å ±åé é¢
          setTimeout(() => {
            switchTab('myRegistrations');
          }, 1500);
        } else {
          showAlert(response.message, 'error');
        }
        
      } catch (error) {
        console.error('å ±åå¤±æ•—:', error);
        showAlert('å ±åæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
      }
    }

    // ============================================
    // æäº¤åœ˜é«”å ±å
    // ============================================
    async function submitGroupRegistration(event) {
      event.preventDefault();
      
      try {
        const agreement = document.getElementById('groupAgreement').checked;
        
        if (!agreement) {
          showAlert('è«‹åŒæ„æ´»å‹•è¦å®šåŠæˆæ¬Šæ¢æ¬¾', 'warning');
          return;
        }
        
        // æ”¶é›†æ‰€æœ‰åƒåŠ è€…è³‡æ–™
        const participants = [];
        const participantCards = document.querySelectorAll('.participant-card');
        
        for (let card of participantCards) {
          const id = card.id;
          const name = document.getElementById(`${id}_name`)?.value || '';
          const selectedItem = document.getElementById(`${id}_item`)?.value || '';
          const notes = document.getElementById(`${id}_notes`)?.value || '';
          
          if (!name.trim()) {
            showAlert('è«‹å¡«å¯«æ‰€æœ‰åƒåŠ è€…çš„å§“å', 'warning');
            return;
          }
          
          // æ”¶é›†èª¿æŸ¥é …ç›®ç­”æ¡ˆ
          const surveyAnswers = {};
          if (currentActivity.survey_items) {
            currentActivity.survey_items.forEach((item, index) => {
              const answer = document.getElementById(`${id}_survey_${index}`)?.value || '';
              surveyAnswers[item.survey_question] = answer;
            });
          }
          
          participants.push({
            name: name,
            selected_item: selectedItem,
            notes: notes,
            survey_answers: surveyAnswers
          });
        }
        
        if (participants.length === 0) {
          showAlert('è«‹è‡³å°‘æ–°å¢ä¸€ä½åƒåŠ è€…', 'warning');
          return;
        }
        
        const registrationData = {
          activity_id: currentActivity.activity_id,
          line_user_id: lineUserId,
          participants: participants,
          agreement_checked: true
        };
        
        const response = await apiRequest('groupRegistration', {
          registrationData: registrationData
        });
        
        if (response.success) {
          showAlert(`åœ˜å ±æˆåŠŸï¼å…± ${participants.length} äºº`, 'success');
          closeModal('registrationModal');
          
          // é‡æ–°è¼‰å…¥æ´»å‹•åˆ—è¡¨
          await loadActivities();
          
          // åˆ‡æ›åˆ°æˆ‘çš„å ±åé é¢
          setTimeout(() => {
            switchTab('myRegistrations');
          }, 1500);
        } else {
          showAlert(response.message, 'error');
        }
        
      } catch (error) {
        console.error('åœ˜å ±å¤±æ•—:', error);
        showAlert('åœ˜å ±æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
      }
    }

    // ============================================
    // è¼‰å…¥æˆ‘çš„å ±åç´€éŒ„
    // ============================================
    async function loadMyRegistrations() {
      try {
        const response = await apiRequest('getMemberRegistrations', {
          lineUserId: lineUserId,
          filters: {
            status: 'registered'
          }
        });
        
        if (response.success) {
          displayMyRegistrations(response.data);
        } else {
          showEmptyState('registrationsList', 'ç„¡æ³•è¼‰å…¥å ±åç´€éŒ„');
        }
        
      } catch (error) {
        console.error('è¼‰å…¥å ±åç´€éŒ„å¤±æ•—:', error);
        showEmptyState('registrationsList', 'è¼‰å…¥å ±åç´€éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤');
      }
    }

    // ============================================
    // é¡¯ç¤ºæˆ‘çš„å ±åç´€éŒ„
    // ============================================
    function displayMyRegistrations(registrations) {
      const container = document.getElementById('registrationsList');
      
      if (registrations.length === 0) {
        showEmptyState('registrationsList', 'æ‚¨é‚„æ²’æœ‰å ±åä»»ä½•æ´»å‹•');
        return;
      }
      
      // åˆ†é¡ï¼šå³å°‡åƒåŠ ã€å·²å®Œæˆ
      const upcoming = registrations.filter(r => r.activity_status === 'upcoming' || r.activity_status === 'soon');
      const completed = registrations.filter(r => r.activity_status === 'completed');
      
      let html = '';
      
      if (upcoming.length > 0) {
        html += '<h3 style="font-size: 18px; margin-bottom: 15px; color: var(--text-primary);">ğŸ“… å³å°‡åƒåŠ </h3>';
        html += upcoming.map(reg => createRegistrationCard(reg)).join('');
      }
      
      if (completed.length > 0) {
        html += '<h3 style="font-size: 18px; margin: 25px 0 15px; color: var(--text-primary);">âœ… å·²å®Œæˆ</h3>';
        html += completed.map(reg => createRegistrationCard(reg, true)).join('');
      }
      
      container.innerHTML = html;
    }

    // ============================================
    // å»ºç«‹å ±åå¡ç‰‡
    // ============================================
    function createRegistrationCard(registration, isCompleted = false) {
      const categoryClass = `category-${registration.category}`;
      const categoryName = getCategoryName(registration.category);
      
      let statusBadge = '';
      if (registration.activity_status === 'soon') {
        statusBadge = '<span class="activity-status status-soon">âš ï¸ å³å°‡èˆ‰è¡Œ</span>';
      } else if (isCompleted) {
        statusBadge = '<span class="activity-status status-closed">âœ… å·²å®Œæˆ</span>';
      }
      
      let cancelButton = '';
      if (registration.can_cancel && !isCompleted) {
        cancelButton = `
          <button class="btn btn-danger btn-small" 
                  onclick="confirmCancelRegistration('${registration.registration_id}', '${escapeHtml(registration.activity_name)}')">
            å–æ¶ˆå ±å
          </button>
        `;
      }
      
      let groupBadge = '';
      if (registration.registration_type === 'group') {
        groupBadge = '<span style="background: var(--info-color); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 8px;">ğŸ‘¥ åœ˜å ±</span>';
      }
      
      return `
        <div class="activity-card" style="cursor: default;">
          <div class="activity-header">
            <div style="flex: 1;">
              <div class="activity-title">
                ${escapeHtml(registration.activity_name)}
                ${groupBadge}
              </div>
              <span class="activity-category ${categoryClass}">${categoryName}</span>
            </div>
          </div>
          
          <div class="activity-info">
            <div>ğŸ“… æ´»å‹•æ—¥æœŸï¼š${formatDate(registration.activity_date)}</div>
            <div>ğŸ“ åœ°é»ï¼š${escapeHtml(registration.activity_location)}</div>
            ${registration.participant_name ? `<div>ğŸ‘¤ åƒåŠ è€…ï¼š${escapeHtml(registration.participant_name)}</div>` : ''}
            ${registration.selected_item ? `<div>ğŸ« é …ç›®ï¼š${escapeHtml(registration.selected_item)}</div>` : ''}
            <div>â° å ±åæ™‚é–“ï¼š${formatDateTime(registration.registered_at)}</div>
            ${registration.days_until_activity !== null ? `<div>ğŸ“† è·é›¢æ´»å‹•ï¼š${registration.days_until_activity} å¤©</div>` : ''}
          </div>
          
          ${statusBadge}
          
          ${cancelButton ? `<div style="margin-top: 15px;">${cancelButton}</div>` : ''}
          
          ${!registration.can_cancel && !isCompleted ? 
            '<div class="alert alert-warning" style="margin-top: 15px; font-size: 13px;">âš ï¸ æ´»å‹•å‰ 3 å¤©å…§ç„¡æ³•å–æ¶ˆå ±å</div>' : 
            ''}
        </div>
      `;
    }

    // ============================================
    // ç¢ºèªå–æ¶ˆå ±å
    // ============================================
    function confirmCancelRegistration(registrationId, activityName) {
      if (confirm(`ç¢ºå®šè¦å–æ¶ˆå ±åã€Œ${activityName}ã€å—ï¼Ÿ\n\nå–æ¶ˆå¾Œå°‡ç„¡æ³•å¾©åŸã€‚`)) {
        cancelRegistration(registrationId);
      }
    }

    // ============================================
    // å–æ¶ˆå ±å
    // ============================================
    async function cancelRegistration(registrationId) {
      try {
        const response = await apiRequest('cancelRegistration', {
          registrationId: registrationId,
          lineUserId: lineUserId
        });
        
        if (response.success) {
          showAlert('å·²æˆåŠŸå–æ¶ˆå ±å', 'success');
          
          // é‡æ–°è¼‰å…¥å ±åç´€éŒ„
          await loadMyRegistrations();
          
          // é‡æ–°è¼‰å…¥æ´»å‹•åˆ—è¡¨
          await loadActivities();
        } else {
          showAlert(response.message, 'error');
        }
        
      } catch (error) {
        console.error('å–æ¶ˆå ±åå¤±æ•—:', error);
        showAlert('å–æ¶ˆå ±åæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
      }
    }

    // ============================================
    // è¼‰å…¥å€‹äººè³‡æ–™
    // ============================================
    async function loadProfile() {
      try {
        const response = await apiRequest('getMember', {
          lineUserId: lineUserId
        });
        
        if (response.success) {
          displayProfile(response.data);
          
          // åŒæ™‚è¼‰å…¥çµ±è¨ˆè³‡æ–™
          loadMemberStatistics();
        } else {
          showEmptyState('profileContent', 'ç„¡æ³•è¼‰å…¥å€‹äººè³‡æ–™');
        }
        
      } catch (error) {
        console.error('è¼‰å…¥å€‹äººè³‡æ–™å¤±æ•—:', error);
        showEmptyState('profileContent', 'è¼‰å…¥å€‹äººè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤');
      }
    }

    // ============================================
    // é¡¯ç¤ºå€‹äººè³‡æ–™
    // ============================================
    function displayProfile(member) {
      const html = `
        <div style="text-align: center; margin-bottom: 30px;">
          <div style="width: 80px; height: 80px; margin: 0 auto 15px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: 700;">
            ${member.name ? member.name.charAt(0) : 'æœƒ'}
          </div>
          <h2 style="font-size: 22px; margin-bottom: 8px; color: var(--text-primary);">
            ${escapeHtml(member.name || 'æœƒå“¡')}
          </h2>
          <p style="color: var(--text-light); font-size: 14px;">
            æœƒå“¡ç·¨è™Ÿï¼š${member.member_id}
          </p>
        </div>
        
        <form id="profileForm" onsubmit="updateProfile(event)">
          <div class="form-group">
            <label class="form-label">å§“å</label>
            <input type="text" class="form-input" id="profileName" 
                   value="${escapeHtml(member.name || '')}" 
                   placeholder="è«‹è¼¸å…¥å§“å">
          </div>
          
          <div class="form-group">
            <label class="form-label">é›»è©±</label>
            <input type="tel" class="form-input" id="profilePhone" 
                   value="${escapeHtml(member.phone || '')}" 
                   placeholder="è«‹è¼¸å…¥é›»è©±">
          </div>
          
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="profileEmail" 
                   value="${escapeHtml(member.email || '')}" 
                   placeholder="è«‹è¼¸å…¥ Email">
          </div>
          
          <div class="form-group">
            <label class="form-label">è¨»å†Šæ—¥æœŸ</label>
            <input type="text" class="form-input" 
                   value="${formatDateTime(member.registered_at)}" 
                   disabled>
          </div>
          
          <button type="submit" class="btn btn-primary">
            ğŸ’¾ å„²å­˜è®Šæ›´
          </button>
        </form>
        
        <div id="memberStatistics" style="margin-top: 30px;">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥çµ±è¨ˆè³‡æ–™...</p>
          </div>
        </div>
      `;
      
      document.getElementById('profileContent').innerHTML = html;
    }

    // ============================================
    // æ›´æ–°å€‹äººè³‡æ–™
    // ============================================
    async function updateProfile(event) {
      event.preventDefault();
      
      try {
        const name = document.getElementById('profileName').value.trim();
        const phone = document.getElementById('profilePhone').value.trim();
        const email = document.getElementById('profileEmail').value.trim();
        
        const response = await apiRequest('updateMember', {
          lineUserId: lineUserId,
          memberData: {
            name: name,
            phone: phone,
            email: email
          }
        });
        
        if (response.success) {
          showAlert('å€‹äººè³‡æ–™å·²æ›´æ–°', 'success');
          
          // æ›´æ–°å…¨åŸŸè®Šæ•¸
          currentUser = response.data;
          
          // æ›´æ–°é¡¯ç¤ºçš„ä½¿ç”¨è€…åç¨±
          document.getElementById('userName').textContent = name || 'æœƒå“¡';
        } else {
          showAlert(response.message, 'error');
        }
        
      } catch (error) {
        console.error('æ›´æ–°å€‹äººè³‡æ–™å¤±æ•—:', error);
        showAlert('æ›´æ–°å€‹äººè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
      }
    }

    // ============================================
    // è¼‰å…¥æœƒå“¡çµ±è¨ˆè³‡æ–™
    // ============================================
    async function loadMemberStatistics() {
      try {
        const response = await apiRequest('getMemberStatistics', {
          lineUserId: lineUserId
        });
        
        if (response.success) {
          displayMemberStatistics(response.data);
        } else {
          document.getElementById('memberStatistics').innerHTML = 
            '<div class="alert alert-warning">ç„¡æ³•è¼‰å…¥çµ±è¨ˆè³‡æ–™</div>';
        }
        
      } catch (error) {
        console.error('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—:', error);
        document.getElementById('memberStatistics').innerHTML = 
          '<div class="alert alert-error">è¼‰å…¥çµ±è¨ˆè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤</div>';
      }
    }

    // ============================================
    // é¡¯ç¤ºæœƒå“¡çµ±è¨ˆè³‡æ–™
    // ============================================
    function displayMemberStatistics(stats) {
      const categoryStats = stats.category_statistics || {};
      const categoryNames = {
        'mountain': 'ğŸ”ï¸ ç™»å±±',
        'bike': 'ğŸš´ å–®è»Š',
        'run': 'ğŸƒ è·¯è·‘',
        'swim': 'ğŸŠ æ¸¸æ³³'
      };
      
      let categoryStatsHtml = '';
      if (Object.keys(categoryStats).length > 0) {
        categoryStatsHtml = `
          <div style="margin-top: 20px;">
            <h4 style="font-size: 16px; margin-bottom: 12px; color: var(--text-primary);">
              ğŸ“Š æ´»å‹•é¡åˆ¥çµ±è¨ˆ
            </h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
              ${Object.entries(categoryStats).map(([category, count]) => `
                <div style="padding: 12px; background: var(--light-gray); border-radius: 8px; text-align: center;">
                  <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;">
                    ${categoryNames[category] || category}
                  </div>
                  <div style="font-size: 24px; font-weight: 700; color: var(--primary-color);">
                    ${count}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      let recentRegistrationsHtml = '';
      if (stats.recent_registrations && stats.recent_registrations.length > 0) {
        recentRegistrationsHtml = `
          <div style="margin-top: 20px;">
            <h4 style="font-size: 16px; margin-bottom: 12px; color: var(--text-primary);">
              ğŸ“ æœ€è¿‘å ±å
            </h4>
            ${stats.recent_registrations.map(reg => `
              <div style="padding: 12px; background: var(--light-gray); border-radius: 8px; margin-bottom: 8px;">
                <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                  ${escapeHtml(reg.activity_name)}
                </div>
                <div style="font-size: 12px; color: var(--text-light);">
                  æ´»å‹•æ—¥æœŸï¼š${formatDate(reg.activity_date)}
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }
      
      const html = `
        <div style="border-top: 2px solid var(--border-color); padding-top: 20px;">
          <h3 style="font-size: 18px; margin-bottom: 20px; color: var(--text-primary);">
            ğŸ“ˆ åƒèˆ‡çµ±è¨ˆ
          </h3>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; text-align: center; color: white;">
              <div style="font-size: 14px; margin-bottom: 8px; opacity: 0.9;">ç¸½å ±åæ¬¡æ•¸</div>
              <div style="font-size: 32px; font-weight: 700;">${stats.total_registrations}</div>
            </div>
            
            <div style="padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; text-align: center; color: white;">
              <div style="font-size: 14px; margin-bottom: 8px; opacity: 0.9;">å³å°‡åƒåŠ </div>
              <div style="font-size: 32px; font-weight: 700;">${stats.upcoming_activities}</div>
            </div>
            
            <div style="padding: 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 12px; text-align: center; color: white;">
              <div style="font-size: 14px; margin-bottom: 8px; opacity: 0.9;">å·²å®Œæˆ</div>
              <div style="font-size: 32px; font-weight: 700;">${stats.completed_activities}</div>
            </div>
            
            <div style="padding: 20px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 12px; text-align: center; color: white;">
              <div style="font-size: 14px; margin-bottom: 8px; opacity: 0.9;">å–æ¶ˆæ¬¡æ•¸</div>
              <div style="font-size: 32px; font-weight: 700;">${stats.total_cancelled}</div>
            </div>
          </div>
          
          ${categoryStatsHtml}
          ${recentRegistrationsHtml}
          
          <div style="margin-top: 20px; padding: 15px; background: var(--light-gray); border-radius: 8px; text-align: center;">
            <div style="font-size: 13px; color: var(--text-light);">
              æœƒå“¡èº«åˆ†è‡ª ${formatDate(stats.member_since)} èµ·
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('memberStatistics').innerHTML = html;
    }

    // ============================================
    // åˆ†é åˆ‡æ›
    // ============================================
    function switchTab(tabName) {
      // æ›´æ–°åˆ†é æŒ‰éˆ•
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        }
      });
      
      // æ›´æ–°é é¢é¡¯ç¤º
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      
      const pageMap = {
        'activities': 'activitiesPage',
        'myRegistrations': 'myRegistrationsPage',
        'profile': 'profilePage'
      };
      
      const pageId = pageMap[tabName];
      if (pageId) {
        document.getElementById(pageId).classList.add('active');
        
        // è¼‰å…¥å°æ‡‰è³‡æ–™
        if (tabName === 'myRegistrations') {
          loadMyRegistrations();
        } else if (tabName === 'profile') {
          loadProfile();
        }
      }
    }

    // ============================================
    // é¡åˆ¥ç¯©é¸
    // ============================================
    function filterByCategory(category) {
      currentCategory = category;
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.category === category) {
          btn.classList.add('active');
        }
      });
      
      // é‡æ–°é¡¯ç¤ºæ´»å‹•åˆ—è¡¨
      displayActivities(allActivities);
    }

    // ============================================
    // Modal æ§åˆ¶
    // ============================================
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        
        // é‡ç½®åœ˜å ±åƒåŠ è€…è¨ˆæ•¸
        if (modalId === 'registrationModal') {
          participantCount = 0;
        }
      }
    }

    // é»æ“Š Modal èƒŒæ™¯é—œé–‰
    document.addEventListener('click', function(event) {
      if (event.target.classList.contains('modal')) {
        closeModal(event.target.id);
      }
    });

    // ============================================
    // é¡¯ç¤ºæç¤ºè¨Šæ¯
    // ============================================
    function showAlert(message, type = 'info') {
      const alertClass = `alert-${type}`;
      const alertHtml = `
        <div class="alert ${alertClass}" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; max-width: 90%; animation: slideDown 0.3s ease;">
          ${escapeHtml(message)}
        </div>
      `;
      
      // ç§»é™¤èˆŠçš„æç¤º
      const oldAlert = document.querySelector('.alert[style*="position: fixed"]');
      if (oldAlert) {
        oldAlert.remove();
      }
      
      // åŠ å…¥æ–°çš„æç¤º
      document.body.insertAdjacentHTML('beforeend', alertHtml);
      
      // 3 ç§’å¾Œè‡ªå‹•ç§»é™¤
      setTimeout(() => {
        const alert = document.querySelector('.alert[style*="position: fixed"]');
        if (alert) {
          alert.style.animation = 'fadeOut 0.3s ease';
          setTimeout(() => alert.remove(), 300);
        }
      }, 3000);
    }

    // ============================================
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    // ============================================
    let loadingCount = 0;

    function showLoading(show) {
      if (show) {
        loadingCount++;
      } else {
        loadingCount--;
      }
      
      // ç¢ºä¿è¨ˆæ•¸ä¸æœƒå°æ–¼ 0
      if (loadingCount < 0) loadingCount = 0;
      
      // é€™è£¡å¯ä»¥åŠ å…¥å…¨åŸŸè¼‰å…¥æŒ‡ç¤ºå™¨
      // ä¾‹å¦‚åœ¨é é¢é ‚éƒ¨é¡¯ç¤ºé€²åº¦æ¢
    }

    // ============================================
    // é¡¯ç¤ºç©ºç‹€æ…‹
    // ============================================
    function showEmptyState(containerId, message) {
      const container = document.getElementById(containerId);
      if (container) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“­</div>
            <p>${escapeHtml(message)}</p>
          </div>
        `;
      }
    }

    // ============================================
    // å·¥å…·å‡½æ•¸
    // ============================================
    function getCategoryName(category) {
      const names = {
        'mountain': 'ğŸ”ï¸ ç™»å±±çµ„',
        'bike': 'ğŸš´ å–®è»Šçµ„',
        'run': 'ğŸƒ è·¯è·‘çµ„',
        'swim': 'ğŸŠ æ¸¸æ³³çµ„'
      };
      return names[category] || category;
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      
      return `${year}-${month}-${day}`;
    }

    function formatDateTime(dateString) {
      if (!dateString) return '';
      
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    function escapeHtml(text) {
      if (!text) return '';
      
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============================================
    // äº‹ä»¶ç›£è½
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      // åˆ†é åˆ‡æ›
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          switchTab(this.dataset.tab);
        });
      });
      
      // é¡åˆ¥ç¯©é¸
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          filterByCategory(this.dataset.category);
        });
      });
      
      // åˆå§‹åŒ– LIFF
      initializeLiff();
    });

    // æ·¡å‡ºå‹•ç•«
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
