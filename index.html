<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>帕金森病友權益促進會管理系統</title>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    /* ==================== 全域樣式 ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #667eea;
      --secondary-color: #764ba2;
      --success-color: #43e97b;
      --danger-color: #fa709a;
      --warning-color: #fbbc04;
      --info-color: #4facfe;
      --dark-color: #333;
      --light-color: #f8f9fa;
      --border-radius: 12px;
      --box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
      /* 深色模式新增 */
      --bg-color: var(--light-color);
      --text-color: var(--dark-color);
      --card-bg: #fff;
      --table-header-bg: #f5f7fa;
      --table-border: #f0f0f0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
      color: var(--text-color);
      background: var(--bg-color);
      line-height: 1.6;
    }

    /* 深色模式覆寫 */
    body.dark-mode {
      --bg-color: #121212;
      --text-color: #e6e6e6;
      --card-bg: #1e1e1e;
      --table-header-bg: #222;
      --table-border: #333;
      --light-color: #1e1e1e;
      --dark-color: #e6e6e6;
    }

    /* ==================== 頂部導航欄 ==================== */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 0.8rem 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .topbar-container {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .brand i {
      font-size: 1.5rem;
    }

    .topnav {
      display: flex;
      gap: 0.5rem;
    }

    .topnav a {
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      transition: var(--transition);
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
    }

    .topnav a:hover,
    .topnav a.active {
      background: rgba(255,255,255,0.2);
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .notification-badge {
      position: relative;
    }

    .notification-badge .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger-color);
      color: white;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 700;
      display: none; /* 先隱藏，未讀>0再顯示 */
    }

    /* ==================== 按鈕樣式 ==================== */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: var(--light-color);
      color: var(--dark-color);
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-warning {
      background: var(--warning-color);
      color: white;
    }

    .btn-info {
      background: var(--info-color);
      color: white;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    .btn-group {
      display: flex;
      gap: 5px;
    }

    /* ==================== 載入覆蓋層 ==================== */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
      gap: 1rem;
    }

    .loading-overlay.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ==================== 頁面容器 ==================== */
    .page {
      display: none;
      padding: 1.5rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    .page.active {
      display: block;
    }

    .page-header {
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .page-header h2 {
      color: var(--dark-color);
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* ==================== 卡片樣式 ==================== */
    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--table-border);
    }

    .card-header h3 {
      color: var(--dark-color);
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-body {
      color: #bbb;
    }

    /* ==================== 網格佈局 ==================== */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    .grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .grid-4 {
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    /* ==================== 統計卡片 ==================== */
    .stat-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow);
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: white;
    }

    .stat-content h3 {
      font-size: 1.8rem;
      font-weight: 800;
      margin: 0;
      color: var(--dark-color);
    }

    .stat-content p {
      margin: 0;
      color: #888;
      font-size: 0.9rem;
    }

    /* ==================== 表格樣式 ==================== */
    .table-container {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: var(--table-header-bg);
    }

    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--table-border);
    }

    th {
      font-weight: 600;
      color: var(--dark-color);
    }

    tbody tr:hover {
      background: #f9f9f9;
    }

    body.dark-mode tbody tr:hover {
      background: #2a2a2a;
    }

    /* ==================== 表單樣式 ==================== */
    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #bbb;
      font-weight: 600;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: var(--transition);
      background: #fff;
    }

    body.dark-mode .form-group input,
    body.dark-mode .form-group select,
    body.dark-mode .form-group textarea {
      background: #1f1f1f;
      color: #e6e6e6;
      border: 1px solid #333;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    /* ==================== Modal 樣式 ==================== */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5000;
      padding: 1rem;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 1.5rem;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--table-border);
      margin-bottom: 1rem;
    }

    .modal-header h3 {
      color: var(--dark-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-body {
      padding: 1rem 0;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding-top: 1rem;
      border-top: 1px solid var(--table-border);
      margin-top: 1rem;
    }

    /* ==================== Badge 樣式 ==================== */
    .badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .badge-success {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .badge-danger {
      background: #ffebee;
      color: #c62828;
    }

    .badge-warning {
      background: #fff3e0;
      color: #f57c00;
    }

    .badge-info {
      background: #e3f2fd;
      color: #1976d2;
    }

    .badge-primary {
      background: rgba(102, 126, 234, 0.1);
      color: var(--primary-color);
    }

    /* ==================== 空狀態 ==================== */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #999;
    }

    .empty-state i {
      font-size: 3rem;
      opacity: 0.3;
      margin-bottom: 1rem;
    }

    .empty-state p {
      font-size: 1.1rem;
    }

    /* ==================== Toast 通知 ==================== */
    .toast-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 6000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideIn 0.3s ease;
      color: var(--text-color);
      border-left: 4px solid transparent;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success { border-left-color: var(--success-color); }
    .toast.error { border-left-color: var(--danger-color); }
    .toast.warning { border-left-color: var(--warning-color); }
    .toast.info { border-left-color: var(--info-color); }

    .toast i { font-size: 1.5rem; }
    .toast.success i { color: var(--success-color); }
    .toast.error i { color: var(--danger-color); }
    .toast.warning i { color: var(--warning-color); }
    .toast.info i { color: var(--info-color); }

    /* ==================== 分頁樣式 ==================== */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }

    .pagination button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
    }

    .pagination button:hover:not(:disabled) {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .pagination button.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ==================== 響應式設計 ==================== */
    @media (max-width: 768px) {
      .topnav { display: none; }
      .page { padding: 1rem; }
      .page-header { flex-direction: column; align-items: flex-start; }
      .grid, .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
      .modal-content { max-width: 100%; max-height: 100vh; border-radius: 0; }
      .toast-container { right: 10px; left: 10px; }
      .toast { min-width: auto; }
      table { font-size: 0.85rem; }
      th, td { padding: 0.6rem; }
    }

    /* ==================== 工具類 ==================== */
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .text-left { text-align: left; }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mt-3 { margin-top: 1.5rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }
    .mb-3 { margin-bottom: 1.5rem; }
    .hidden { display: none !important; }
    .text-success { color: var(--success-color); }
    .text-danger { color: var(--danger-color); }
    .text-warning { color: var(--warning-color); }
    .text-muted { color: #999; }
  </style>
</head>
<body>
  <!-- Toast 容器 -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- 載入覆蓋層 -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p style="color: #fff;">載入中...</p>
  </div>

  <!-- 頂部導航欄 -->
  <header class="topbar">
    <div class="topbar-container">
      <div class="brand">
        <i class="fas fa-heartbeat"></i>
        <span>帕金森病友權益促進會</span>
      </div>
      <nav class="topnav" id="topnav">
        <a href="#" data-page="home" class="active"><i class="fas fa-home"></i> 首頁</a>
        <a href="#" data-page="activities"><i class="fas fa-calendar-alt"></i> 活動</a>
        <a href="#" data-page="member"><i class="fas fa-user"></i> 會員</a>
        <a href="#" data-page="finance"><i class="fas fa-dollar-sign"></i> 財務</a>
        <a href="#" data-page="admin" class="hidden" id="adminNav"><i class="fas fa-user-shield"></i> 管理</a>
      </nav>
      <div class="top-actions">
        <div class="notification-badge">
          <button class="btn btn-secondary btn-sm" id="notificationBtn"><i class="fas fa-bell"></i></button>
          <span class="badge" id="notificationCount"></span>
        </div>
        <button class="btn btn-primary btn-sm" id="loginBtn">
          <i class="fas fa-sign-in-alt"></i>
          <span id="loginText">登入</span>
        </button>
      </div>
    </div>
  </header>

  <!-- ==================== 首頁 ==================== -->
  <div id="homePage" class="page active">
    <!-- Hero Section -->
    <div class="card" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; text-align: center; padding: 3rem 1.5rem;">
      <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">攜手同行，溫暖相伴</h1>
      <p style="font-size: 1.2rem; opacity: 0.9; margin-bottom: 1.5rem;">為帕金森病友提供全方位支持與關懷服務</p>
      <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
        <button class="btn btn-primary" style="background: white; color: var(--primary-color);" onclick="showPage('activities')">
          <i class="fas fa-calendar-check"></i> 查看活動
        </button>
        <button class="btn btn-secondary" onclick="openModal('registerModal')">
          <i class="fas fa-user-plus"></i> 立即加入
        </button>
      </div>
    </div>

    <!-- 統計數據 -->
    <div class="grid grid-4">
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h3 id="statMembers">0</h3>
          <p>會員總數</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--success-color), #38f9d7);">
          <i class="fas fa-calendar-check"></i>
        </div>
        <div class="stat-content">
          <h3 id="statActivities">0</h3>
          <p>舉辦活動</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--info-color), #00f2fe);">
          <i class="fas fa-user-friends"></i>
        </div>
        <div class="stat-content">
          <h3 id="statParticipants">0</h3>
          <p>參與人次</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--danger-color), #fee140);">
          <i class="fas fa-heart"></i>
        </div>
        <div class="stat-content">
          <h3 id="statSatisfaction">98%</h3>
          <p>滿意度</p>
        </div>
      </div>
    </div>

    <!-- 近期活動 -->
    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-calendar-alt"></i> 近期活動</h3>
        <button class="btn btn-primary btn-sm" onclick="showPage('activities')">查看更多</button>
      </div>
      <div class="grid grid-3" id="homeActivities">
        <div class="empty-state">
          <div class="spinner"></div>
          <p>載入中...</p>
        </div>
      </div>
    </div>

    <!-- 服務項目 -->
    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-hand-holding-heart"></i> 我們的服務</h3>
      </div>
      <div class="grid grid-3">
        <div class="card" style="cursor: pointer;" onclick="showPage('member')">
          <div style="font-size: 3rem; color: var(--primary-color); text-align: center; margin-bottom: 1rem;">
            <i class="fas fa-user-circle"></i>
          </div>
          <h4 style="text-align: center; margin-bottom: 0.5rem;">會員服務</h4>
          <p style="text-align: center; color: #666;">完善的會員管理系統，享受專屬權益與個人化服務</p>
        </div>
        <div class="card" style="cursor: pointer;" onclick="showPage('activities')">
          <div style="font-size: 3rem; color: var(--success-color); text-align: center; margin-bottom: 1rem;">
            <i class="fas fa-calendar-alt"></i>
          </div>
          <h4 style="text-align: center; margin-bottom: 0.5rem;">活動報名</h4>
          <p style="text-align: center; color: #666;">定期舉辦病友聚會、醫療講座、復健課程</p>
        </div>
        <div class="card" style="cursor: pointer;">
          <div style="font-size: 3rem; color: var(--info-color); text-align: center; margin-bottom: 1rem;">
            <i class="fas fa-book-medical"></i>
          </div>
          <h4 style="text-align: center; margin-bottom: 0.5rem;">醫療資源</h4>
          <p style="text-align: center; color: #666;">提供最新醫療資訊、用藥指導與照護知識</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== 活動頁面 ==================== -->
  <div id="activitiesPage" class="page">
    <div class="page-header">
      <h2><i class="fas fa-calendar-alt"></i> 活動列表</h2>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="openModal('activityFilterModal')"><i class="fas fa-filter"></i> 篩選</button>
        <button class="btn btn-primary" onclick="openModal('addActivityModal')" id="addActivityBtn" style="display: none;"><i class="fas fa-plus"></i> 新增活動</button>
      </div>
    </div>

    <div class="card">
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center;">
        <button class="btn btn-secondary btn-sm activity-filter-btn active" data-category="all">全部</button>
        <button class="btn btn-secondary btn-sm activity-filter-btn" data-category="lecture">健康講座</button>
        <button class="btn btn-secondary btn-sm activity-filter-btn" data-category="rehabilitation">復健課程</button>
        <button class="btn btn-secondary btn-sm activity-filter-btn" data-category="social">社交活動</button>
        <button class="btn btn-secondary btn-sm activity-filter-btn" data-category="support">支持團體</button>
        <button class="btn btn-secondary btn-sm activity-filter-btn" data-category="workshop">工作坊</button>
      </div>
    </div>

    <div class="grid grid-3" id="activitiesList">
      <div class="empty-state">
        <div class="spinner"></div>
        <p>載入中...</p>
      </div>
    </div>

    <div id="activitiesPagination"></div>
  </div>

  <!-- ==================== 會員頁面 ==================== -->
  <div id="memberPage" class="page">
    <div class="page-header">
      <h2><i class="fas fa-user"></i> 會員專區</h2>
    </div>

    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-id-card"></i> 個人資料</h3>
        <button class="btn btn-primary btn-sm" onclick="openModal('editProfileModal')"><i class="fas fa-edit"></i> 編輯</button>
      </div>
      <div style="display: flex; gap: 1.5rem; align-items: flex-start; flex-wrap: wrap;">
        <div style="width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: 800;" id="memberAvatar">會</div>
        <div style="flex: 1; min-width: 250px;">
          <h3 id="memberName">會員姓名</h3>
          <p class="text-muted">會員編號：<span id="memberId">M0000001</span></p>
          <div class="grid grid-2 mt-2">
            <div><i class="fas fa-envelope" style="color: var(--primary-color);"></i> <span id="memberEmail">email@example.com</span></div>
            <div><i class="fas fa-phone" style="color: var(--primary-color);"></i> <span id="memberPhone">0912-345-678</span></div>
            <div><i class="fas fa-calendar" style="color: var(--primary-color);"></i> 加入日期：<span id="memberJoinDate">2024-01-01</span></div>
            <div><i class="fas fa-check-circle" style="color: var(--success-color);"></i> 狀態：<span class="badge badge-success" id="memberStatus">正常</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-4">
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));"><i class="fas fa-calendar-check"></i></div>
        <div class="stat-content"><h3 id="memberUpcomingActivities">0</h3><p>即將參加</p></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--success-color), #38f9d7);"><i class="fas fa-check-circle"></i></div>
        <div class="stat-content"><h3 id="memberCompletedActivities">0</h3><p>已參加</p></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--info-color), #00f2fe);"><i class="fas fa-bell"></i></div>
        <div class="stat-content"><h3 id="memberUnreadNotifications">0</h3><p>未讀通知</p></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--warning-color), #ffa000);"><i class="fas fa-calendar-day"></i></div>
        <div class="stat-content"><h3 id="memberDays">0</h3><p>會員天數</p></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><h3><i class="fas fa-calendar-alt"></i> 我的活動</h3></div>
      <div id="memberActivitiesList">
        <div class="empty-state">
          <div class="spinner"></div>
          <p>載入中...</p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-bell"></i> 通知中心</h3>
        <button class="btn btn-secondary btn-sm" onclick="markAllNotificationsAsRead()"><i class="fas fa-check-double"></i> 全部已讀</button>
      </div>
      <div id="memberNotificationsList">
        <div class="empty-state">
          <div class="spinner"></div>
          <p>載入中...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== 財務頁面 ==================== -->
  <div id="financePage" class="page">
    <div class="page-header">
      <h2><i class="fas fa-dollar-sign"></i> 財務管理</h2>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="openModal('financeFilterModal')"><i class="fas fa-filter"></i> 篩選</button>
        <button class="btn btn-secondary" onclick="exportFinanceData()"><i class="fas fa-file-export"></i> 匯出</button>
        <button class="btn btn-primary" onclick="openModal('addFinanceRecordModal')"><i class="fas fa-plus"></i> 新增記錄</button>
      </div>
    </div>

    <div class="finance-summary">
      <div class="grid grid-4">
        <div class="stat-card" style="border-left: 4px solid var(--success-color);">
          <div class="stat-icon" style="background: linear-gradient(135deg, var(--success-color), #38f9d7);"><i class="fas fa-arrow-up"></i></div>
          <div class="stat-content"><h3 id="totalIncome">$0</h3><p>總收入</p></div>
        </div>
        <div class="stat-card" style="border-left: 4px solid var(--danger-color);">
          <div class="stat-icon" style="background: linear-gradient(135deg, var(--danger-color), #fee140);"><i class="fas fa-arrow-down"></i></div>
          <div class="stat-content"><h3 id="totalExpense">$0</h3><p>總支出</p></div>
        </div>
        <div class="stat-card" style="border-left: 4px solid var(--primary-color);">
          <div class="stat-icon" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));"><i class="fas fa-balance-scale"></i></div>
          <div class="stat-content"><h3 id="netIncome">$0</h3><p>淨收入</p></div>
        </div>
        <div class="stat-card" style="border-left: 4px solid var(--warning-color);">
          <div class="stat-icon" style="background: linear-gradient(135deg, var(--warning-color), #ffa000);"><i class="fas fa-clock"></i></div>
          <div class="stat-content"><h3 id="pendingApprovals">0</h3><p>待審核</p></div>
        </div>
      </div>

      <div class="period-selector" style="display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;margin-top:1rem;">
        <button class="period-btn" data-period="week">本週</button>
        <button class="period-btn active" data-period="month">本月</button>
        <button class="period-btn" data-period="quarter">本季</button>
        <button class="period-btn" data-period="year">本年</button>
      </div>
    </div>

    <div class="chart-container card">
      <h3>收支趨勢</h3>
      <canvas id="trendChart" width="800" height="300"></canvas>
    </div>

    <div class="grid grid-2">
      <div class="chart-container card">
        <h3>收入分類</h3>
        <canvas id="incomeChart" width="400" height="300"></canvas>
      </div>
      <div class="chart-container card">
        <h3>支出分類</h3>
        <canvas id="expenseChart" width="400" height="300"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-list"></i> 財務記錄</h3>
        <button class="btn btn-success btn-sm" onclick="batchApproveRecords()"><i class="fas fa-check-double"></i> 批次審核</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllRecords" onchange="toggleSelectAll(this)"></th>
              <th>記錄ID</th>
              <th>交易日期</th>
              <th>類型</th>
              <th>分類</th>
              <th>金額</th>
              <th>狀態</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="financeRecordsTable">
            <tr>
              <td colspan="8" class="empty-state">
                <div class="spinner"></div>
                <p>載入中...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div id="financePagination"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-chart-pie"></i> 預算管理</h3>
        <button class="btn btn-primary btn-sm" onclick="openModal('addBudgetModal')"><i class="fas fa-plus"></i> 新增預算</button>
      </div>
      <div class="grid grid-3" id="budgetList">
        <div class="empty-state">
          <div class="spinner"></div>
          <p>載入中...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== 管理員頁面 ==================== -->
  <div id="adminPage" class="page">
    <div class="page-header">
      <h2><i class="fas fa-user-shield"></i> 管理員專區</h2>
    </div>

    <div class="grid grid-4">
      <div class="stat-card"><div class="stat-icon" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));"><i class="fas fa-users"></i></div><div class="stat-content"><h3 id="adminStatMembers">0</h3><p>總會員數</p></div></div>
      <div class="stat-card"><div class="stat-icon" style="background: linear-gradient(135deg, var(--success-color), #38f9d7);"><i class="fas fa-calendar-check"></i></div><div class="stat-content"><h3 id="adminStatActivities">0</h3><p>舉辦活動</p></div></div>
      <div class="stat-card"><div class="stat-icon" style="background: linear-gradient(135deg, var(--info-color), #00f2fe);"><i class="fas fa-user-friends"></i></div><div class="stat-content"><h3 id="adminStatParticipants">0</h3><p>參與人次</p></div></div>
      <div class="stat-card"><div class="stat-icon" style="background: linear-gradient(135deg, var(--danger-color), #fee140);"><i class="fas fa-dollar-sign"></i></div><div class="stat-content"><h3 id="adminStatIncome">$0</h3><p>總收入</p></div></div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-bolt"></i> 快速操作</h3>
      </div>
      <div class="grid grid-4">
        <button class="btn btn-primary" onclick="openModal('addMemberModal')"><i class="fas fa-user-plus"></i> 新增會員</button>
        <button class="btn btn-primary" style="background: linear-gradient(135deg, var(--success-color), #38f9d7);" onclick="openModal('addActivityModal')"><i class="fas fa-calendar-plus"></i> 新增活動</button>
        <button class="btn btn-primary" style="background: linear-gradient(135deg, var(--info-color), #00f2fe);" onclick="openModal('sendNotificationModal')"><i class="fas fa-paper-plane"></i> 發送通知</button>
        <button class="btn btn-primary" style="background: linear-gradient(135deg, var(--warning-color), #ffa000);" onclick="generateReport()"><i class="fas fa-file-export"></i> 產生報告</button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-users"></i> 會員管理</h3>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-secondary btn-sm"><i class="fas fa-filter"></i> 篩選</button>
          <button class="btn btn-secondary btn-sm"><i class="fas fa-download"></i> 匯出</button>
        </div>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>會員編號</th>
              <th>姓名</th>
              <th>Email</th>
              <th>電話</th>
              <th>加入日期</th>
              <th>狀態</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="adminMembersTable">
            <tr>
              <td colspan="7" class="empty-state">
                <div class="spinner"></div>
                <p>載入中...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ==================== Modal: 登入 ==================== -->
  <div class="modal" id="loginModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-sign-in-alt"></i> 會員登入</h3>
        <button class="btn btn-secondary btn-sm" onclick="closeModal('loginModal')"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form id="loginForm">
          <div class="form-group">
            <label>電子郵件</label>
            <input type="email" name="email" placeholder="請輸入您的電子郵件">
            <small class="text-muted">提示：若使用 LINE 登入首次需綁定電子郵件。</small>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="loginWithLine()"><i class="fab fa-line"></i> 使用 LINE 登入</button>
            <button type="submit" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> 登入</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ==================== Modal: 註冊 ==================== -->
  <div class="modal" id="registerModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-user-plus"></i> 會員註冊</h3>
        <button class="btn btn-secondary btn-sm" onclick="closeModal('registerModal')"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form id="registerForm">
          <div class="form-group">
            <label>姓名 *</label>
            <input type="text" name="name" required placeholder="請輸入您的姓名">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>性別 *</label>
              <select name="gender" required>
                <option value="">請選擇</option>
                <option value="male">男性</option>
                <option value="female">女性</option>
                <option value="other">其他</option>
              </select>
            </div>
            <div class="form-group">
              <label>出生日期</label>
              <input type="date" name="birthDate">
            </div>
          </div>
          <div class="form-group">
            <label>電子郵件 *</label>
            <input type="email" name="email" required placeholder="請輸入您的電子郵件">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>手機號碼 *</label>
              <input type="tel" name="phone" required pattern="09[0-9]{8}" placeholder="0912345678">
            </div>
            <div class="form-group">
              <label>LINE ID</label>
              <input type="text" name="lineId" placeholder="選填">
            </div>
          </div>
          <div class="form-group">
            <label>聯絡地址</label>
            <input type="text" name="address" placeholder="選填">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('registerModal')">取消</button>
            <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> 送出註冊</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ==================== Modal: 新增財務記錄 ==================== -->
  <div class="modal" id="addFinanceRecordModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-plus"></i> 新增財務記錄</h3>
        <button class="btn btn-secondary btn-sm" onclick="closeModal('addFinanceRecordModal')"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form id="addFinanceRecordForm">
          <div class="form-row">
            <div class="form-group">
              <label>類型 *</label>
              <select name="type" required>
                <option value="">請選擇</option>
                <option value="income">收入</option>
                <option value="expense">支出</option>
              </select>
            </div>
            <div class="form-group">
              <label>交易日期 *</label>
              <input type="date" name="transactionDate" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>分類 *</label>
              <select name="category" required>
                <option value="">請選擇</option>
                <option value="捐款收入">捐款收入</option>
                <option value="活動收入">活動收入</option>
                <option value="補助收入">補助收入</option>
                <option value="人事費用">人事費用</option>
                <option value="活動費用">活動費用</option>
                <option value="行政費用">行政費用</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="form-group">
              <label>子分類</label>
              <input type="text" name="subCategory" placeholder="選填">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>金額 *</label>
              <input type="number" name="amount" min="0" step="1" required placeholder="請輸入金額">
            </div>
            <div class="form-group">
              <label>付款方式</label>
              <select name="paymentMethod">
                <option value="">請選擇</option>
                <option value="現金">現金</option>
                <option value="轉帳">轉帳</option>
                <option value="信用卡">信用卡</option>
                <option value="支票">支票</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>描述</label>
            <textarea name="description" rows="3" placeholder="請輸入描述"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('addFinanceRecordModal')">取消</button>
            <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> 確認新增</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ==================== Modal: 新增預算 ==================== -->
  <div class="modal" id="addBudgetModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-chart-pie"></i> 新增預算</h3>
        <button class="btn btn-secondary btn-sm" onclick="closeModal('addBudgetModal')"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form id="addBudgetForm">
          <div class="form-row">
            <div class="form-group">
              <label>年度 *</label>
              <input type="number" name="year" min="2024" max="2030" required value="2025">
            </div>
            <div class="form-group">
              <label>月份 *</label>
              <select name="month" required>
                <option value="">請選擇</option>
                <option value="1">1月</option>
                <option value="2">2月</option>
                <option value="3">3月</option>
                <option value="4">4月</option>
                <option value="5">5月</option>
                <option value="6">6月</option>
                <option value="7">7月</option>
                <option value="8">8月</option>
                <option value="9">9月</option>
                <option value="10">10月</option>
                <option value="11">11月</option>
                <option value="12">12月</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>分類 *</label>
            <select name="category" required>
              <option value="">請選擇</option>
              <option value="人事費用">人事費用</option>
              <option value="活動費用">活動費用</option>
              <option value="行政費用">行政費用</option>
              <option value="其他">其他</option>
            </select>
          </div>
          <div class="form-group">
            <label>預算金額 *</label>
            <input type="number" name="amount" min="0" step="1000" required placeholder="請輸入預算金額">
          </div>
          <div class="form-group">
            <label>備註</label>
            <textarea name="note" rows="2" placeholder="選填"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('addBudgetModal')">取消</button>
            <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> 確認新增</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ==================== Modal: 新增活動 ==================== -->
  <div class="modal" id="addActivityModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-calendar-plus"></i> 新增活動</h3>
        <button class="btn btn-secondary btn-sm" onclick="closeModal('addActivityModal')"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form id="addActivityForm">
          <div class="form-group">
            <label>活動名稱 *</label>
            <input type="text" name="title" required placeholder="請輸入活動名稱">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>活動類型 *</label>
              <select name="category" required>
                <option value="">請選擇</option>
                <option value="lecture">健康講座</option>
                <option value="rehabilitation">復健課程</option>
                <option value="social">社交活動</option>
                <option value="support">支持團體</option>
                <option value="workshop">工作坊</option>
                <option value="other">其他</option>
              </select>
            </div>
            <div class="form-group">
              <label>活動費用</label>
              <input type="number" name="fee" min="0" step="1" value="0" placeholder="0 表示免費">
            </div>
          </div>
          <div class="form-group">
            <label>活動描述</label>
            <textarea name="description" rows="3" placeholder="請輸入活動描述"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>開始時間 *</label>
              <input type="datetime-local" name="startDate" required>
            </div>
            <div class="form-group">
              <label>結束時間 *</label>
              <input type="datetime-local" name="endDate" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>地點名稱</label>
              <input type="text" name="location" placeholder="例：台北市立圖書館">
            </div>
            <div class="form-group">
              <label>詳細地址</label>
              <input type="text" name="address" placeholder="完整地址">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>最大人數</label>
              <input type="number" name="maxParticipants" min="0" value="0" placeholder="0 表示不限">
            </div>
            <div class="form-group">
              <label>報名截止日期</label>
              <input type="datetime-local" name="deadline">
            </div>
          </div>
          <div class="form-group">
            <label>備註</label>
            <textarea name="note" rows="2" placeholder="選填"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('addActivityModal')">取消</button>
            <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> 確認新增</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ==================== Modal: 活動詳情 ==================== -->
  <div class="modal" id="activityDetailModal">
    <div class="modal-content"></div>
  </div>

  <!-- ==================== Modal: 編輯個人資料 ==================== -->
  <div class="modal" id="editProfileModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-edit"></i> 編輯個人資料</h3>
        <button class="btn btn-secondary btn-sm" onclick="closeModal('editProfileModal')"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form id="editProfileForm">
          <div class="form-group">
            <label>姓名</label>
            <input type="text" name="name" id="editName" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>性別</label>
              <select name="gender" id="editGender">
                <option value="">請選擇</option>
                <option value="male">男性</option>
                <option value="female">女性</option>
                <option value="other">其他</option>
              </select>
            </div>
            <div class="form-group">
              <label>出生日期</label>
              <input type="date" name="birthDate" id="editBirthDate">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>手機號碼</label>
              <input type="tel" name="phone" id="editPhone" pattern="09[0-9]{8}">
            </div>
            <div class="form-group">
              <label>LINE ID</label>
              <input type="text" name="lineId" id="editLineId">
            </div>
          </div>
          <div class="form-group">
            <label>聯絡地址</label>
            <input type="text" name="address" id="editAddress">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('editProfileModal')">取消</button>
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 儲存變更</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ==================== Modal: 發送通知 ==================== -->
  <div class="modal" id="sendNotificationModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-paper-plane"></i> 發送通知</h3>
        <button class="btn btn-secondary btn-sm" onclick="closeModal('sendNotificationModal')"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form id="sendNotificationForm">
          <div class="form-group">
            <label>通知標題 *</label>
            <input type="text" name="title" required placeholder="請輸入通知標題">
          </div>
          <div class="form-group">
            <label>通知內容 *</label>
            <textarea name="content" rows="4" required placeholder="請輸入通知內容"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>通知類型</label>
              <select name="type">
                <option value="system">系統通知</option>
                <option value="activity">活動通知</option>
                <option value="announcement">公告</option>
                <option value="reminder">提醒</option>
              </select>
            </div>
            <div class="form-group">
              <label>優先級</label>
              <select name="priority">
                <option value="normal">一般</option>
                <option value="high">高</option>
                <option value="urgent">緊急</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>發送管道</label>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="channels" value="system" checked><span>系統通知</span></label>
              <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="channels" value="email"><span>電子郵件</span></label>
              <label style="display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="channels" value="line"><span>LINE 訊息</span></label>
            </div>
          </div>
          <div class="form-group">
            <label>目標用戶</label>
            <select name="targetUsers">
              <option value="all">全體會員</option>
              <option value="active">活躍會員</option>
              <option value="custom">自訂用戶</option>
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('sendNotificationModal')">取消</button>
            <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> 發送通知</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ==================== JavaScript ==================== -->
  <script>
    // ========== 設定 ==========
    const CONFIG = {
      GAS_URL: 'https://script.google.com/macros/s/AKfycbzIhLYqxZ3s1NXmdSfsdxQ--Lrw4bMCbOe9_TD11c-BWaznGDXu0-dElS9kvWATnT-4/exec', // 後端 Web App URL
      LIFF_ID: '1656516134-X9oq92g9' // LIFF ID
    };

    // ========== 全域變數 ==========
    let currentUser = null;
    let currentPage = 'home';
    let currentFilters = {};
    let lastFinanceSummary = null; // 用於圖表快取

    // ========== API 模組 ==========
    const API = {
      baseUrl: CONFIG.GAS_URL,
      accessToken: null,

      setToken(token) {
        this.accessToken = token || null;
        if (token) {
          localStorage.setItem('accessToken', token);
        } else {
          localStorage.removeItem('accessToken');
        }
      },

      getToken() {
        if (!this.accessToken) {
          const stored = localStorage.getItem('accessToken');
          this.accessToken = stored || null;
        }
        return this.accessToken;
      },

      async request(action, data = {}) {
        const payload = {
          action: action,
          data: data,
          token: this.getToken()
        };

        try {
          const response = await fetch(this.baseUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            mode: 'cors'
          });
          return await response.json();
        } catch (error) {
          console.error('API 請求失敗:', error);
          return { success: false, error: '網路錯誤，請檢查連線' };
        }
      },

      // 會員相關
      async register(data) { return await this.request('register', data); },
      async login(email, liffUserId = null) { return await this.request('login', { email, liffUserId }); },
      async getProfile() { return await this.request('getProfile', {}); }, // 後端依 token 解析 _userId
      async updateProfile(memberId, updates) { return await this.request('updateProfile', { memberId, ...updates }); },
      async getMemberList(filters = {}) { return await this.request('getMemberList', filters); },

      // 活動相關
      async getActivities(filters = {}) { return await this.request('getActivities', filters); },
      async getActivityDetails(activityId) { return await this.request('getActivityDetails', { activityId }); },
      async createActivity(data) { return await this.request('createActivity', data); },
      async registerActivity(activityId, memberId) { return await this.request('registerActivity', { activityId, memberId }); },
      async cancelActivity(activityId, memberId) { return await this.request('cancelActivity', { activityId, memberId }); },

      // 財務相關
      async addFinanceRecord(data) { return await this.request('addFinanceRecord', data); },
      async getFinanceRecords(filters = {}) { return await this.request('getFinanceRecords', filters); },
      async getFinanceSummary(period = 'month') { return await this.request('getFinanceSummary', { period }); },
      async approveFinanceRecord(recordId) { return await this.request('approveFinanceRecord', { recordId }); },
      async rejectFinanceRecord(recordId, reason) { return await this.request('rejectFinanceRecord', { recordId, reason }); },
      async exportFinanceData(filters = {}) { return await this.request('exportFinanceData', filters); },
      async setBudget(data) { return await this.request('setBudget', data); },
      async getBudgets(filters = {}) { return await this.request('getBudgets', filters); },

      // 通知相關
      async getUserNotifications(userId, filters = {}) { return await this.request('getUserNotifications', { userId, ...filters }); },
      async markNotificationAsRead(userId, notificationId) { return await this.request('markNotificationAsRead', { userId, notificationId }); },
      async markAllNotificationsAsRead(userId) { return await this.request('markAllNotificationsAsRead', { userId }); },
      async sendNotification(data) { return await this.request('sendNotification', data); },

      // 統計資料與報告
      async getStats() { return await this.request('getStats', {}); },
      async generateReport(type, period) { return await this.request('generateReport', { type, period }); }
    };

    // ========== 工具函數 ==========
    function showLoading(show = true) {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.toggle('active', show);
      }
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
      };

      toast.innerHTML = `
        <i class="fas ${icons[type] || icons.info}"></i>
        <span>${message}</span>
      `;

      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    const showSuccess = (m) => showToast(m, 'success');
    const showError = (m) => showToast(m, 'error');
    const showWarning = (m) => showToast(m, 'warning');
    const showInfo = (m) => showToast(m, 'info');

    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.classList.add('active');
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.classList.remove('active');
    }

    function showPage(pageName) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      const targetPage = document.getElementById(pageName + 'Page');
      if (targetPage) {
        targetPage.classList.add('active');
        currentPage = pageName;

        document.querySelectorAll('.topnav a').forEach(link => {
          link.classList.remove('active');
          if (link.dataset.page === pageName) link.classList.add('active');
        });

        loadPageData(pageName);
      }
    }

    async function loadPageData(pageName) {
      switch (pageName) {
        case 'home': await loadHomePage(); break;
        case 'activities': await loadActivitiesPage(); break;
        case 'member': await loadMemberPage(); break;
        case 'finance': await loadFinancePage(); break;
        case 'admin': await loadAdminPage(); break;
      }
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(amount);
    }

    function formatDate(dateString, format = 'yyyy-MM-dd HH:mm') {
      if (!dateString) return '';
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');

      return format
        .replace('yyyy', year).replace('MM', month).replace('dd', day).replace('HH', hours).replace('mm', minutes);
    }

    function getCategoryName(category) {
      const names = {
        'lecture': '健康講座',
        'rehabilitation': '復健課程',
        'social': '社交活動',
        'support': '支持團體',
        'workshop': '工作坊',
        'other': '其他'
      };
      return names[category] || category;
    }

    function getCategoryIcon(category) {
      const icons = {
        'lecture': 'fa-chalkboard-teacher',
        'rehabilitation': 'fa-dumbbell',
        'social': 'fa-users',
        'support': 'fa-hands-helping',
        'workshop': 'fa-tools',
        'other': 'fa-calendar'
      };
      return icons[category] || 'fa-calendar';
    }

    // ========== 首頁功能 ==========
    async function loadHomePage() {
      try {
        const statsResult = await API.getStats();
        if (statsResult.success) {
          document.getElementById('statMembers').textContent = statsResult.data.members || 0;
          document.getElementById('statActivities').textContent = statsResult.data.activities || 0;
          document.getElementById('statParticipants').textContent = statsResult.data.participants || 0;
          document.getElementById('statSatisfaction').textContent = (statsResult.data.satisfaction || 98) + '%';
        }

        const activitiesResult = await API.getActivities({ upcoming: true, pageSize: 3 });
        if (activitiesResult.success) {
          renderHomeActivities(activitiesResult.data);
        }
      } catch (e) {
        console.error('載入首頁資料失敗:', e);
      }
    }

    function renderHomeActivities(activities) {
      const container = document.getElementById('homeActivities');
      if (!activities || activities.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><p>目前沒有即將舉行的活動</p></div>';
        return;
      }

      container.innerHTML = activities.map(activity => `
        <div class="activity-card" onclick="viewActivityDetail('${activity.activityId}')">
          <div class="activity-image"><i class="fas ${getCategoryIcon(activity.category)}"></i></div>
          <div class="activity-content">
            <div class="activity-category">${getCategoryName(activity.category)}</div>
            <h4 class="activity-title">${activity.title}</h4>
            <div class="activity-meta">
              <div><i class="fas fa-clock"></i> ${formatDate(activity.startDate)}</div>
              <div><i class="fas fa-map-marker-alt"></i> ${activity.location || '待公布'}</div>
              <div><i class="fas fa-users"></i> ${activity.currentParticipants}/${activity.maxParticipants || '不限'} 人</div>
            </div>
            <div class="activity-footer">
              <span class="badge badge-success">${activity.fee > 0 ? formatCurrency(activity.fee) : '免費'}</span>
              <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); registerForActivity('${activity.activityId}')"><i class="fas fa-user-plus"></i> 立即報名</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // ========== 活動頁面功能 ==========
    async function loadActivitiesPage() { await loadActivities(); }

    async function loadActivities(filters = {}) {
      showLoading(true);
      try {
        const result = await API.getActivities({ ...filters, upcoming: true });
        if (result.success) {
          renderActivities(result.data);
          renderPagination('activities', result.page, result.totalPages);
        } else {
          showError('載入活動失敗：' + result.error);
        }
      } catch (e) {
        showError('系統錯誤');
      } finally {
        showLoading(false);
      }
    }

    function renderActivities(activities) {
      const container = document.getElementById('activitiesList');
      if (!activities || activities.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><p>目前沒有活動</p></div>';
        return;
      }

      container.innerHTML = activities.map(activity => `
        <div class="activity-card" onclick="viewActivityDetail('${activity.activityId}')">
          <div class="activity-image"><i class="fas ${getCategoryIcon(activity.category)}"></i></div>
          <div class="activity-content">
            <div class="activity-category">${getCategoryName(activity.category)}</div>
            <h4 class="activity-title">${activity.title}</h4>
            <div class="activity-meta">
              <div><i class="fas fa-clock"></i> ${formatDate(activity.startDate)}</div>
              <div><i class="fas fa-map-marker-alt"></i> ${activity.location || '待公布'}</div>
              <div><i class="fas fa-users"></i> ${activity.currentParticipants}/${activity.maxParticipants || '不限'} 人</div>
            </div>
            <div class="activity-footer">
              <span class="badge badge-success">${activity.fee > 0 ? formatCurrency(activity.fee) : '免費'}</span>
              <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); registerForActivity('${activity.activityId}')"><i class="fas fa-user-plus"></i> 立即報名</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function viewActivityDetail(activityId) {
      showLoading(true);
      try {
        const result = await API.getActivityDetails(activityId);
        if (result.success) {
          showActivityDetailModal(result.data);
        } else {
          showError('載入活動詳情失敗');
        }
      } catch (e) {
        showError('系統錯誤');
      } finally {
        showLoading(false);
      }
    }

    function showActivityDetailModal(activity) {
      const modal = document.getElementById('activityDetailModal');
      modal.querySelector('.modal-content').innerHTML = `
        <div class="modal-header">
          <h3><i class="fas ${getCategoryIcon(activity.category)}"></i> ${activity.title}</h3>
          <button class="btn btn-secondary btn-sm" onclick="closeModal('activityDetailModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <div class="activity-category mb-2">${getCategoryName(activity.category)}</div>
          <p style="color: #ccc; line-height: 1.8;">${activity.description || '暫無描述'}</p>
          <div class="grid grid-2 mt-3">
            <div class="card" style="margin: 0;">
              <h4 style="margin-bottom: 1rem;"><i class="fas fa-info-circle"></i> 活動資訊</h4>
              <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                <div><i class="fas fa-clock" style="color: var(--primary-color); width: 20px;"></i> <strong>開始：</strong>${formatDate(activity.startDate)}</div>
                <div><i class="fas fa-clock" style="color: var(--primary-color); width: 20px;"></i> <strong>結束：</strong>${formatDate(activity.endDate)}</div>
                <div><i class="fas fa-map-marker-alt" style="color: var(--primary-color); width: 20px;"></i> <strong>地點：</strong>${activity.location || '待公布'}</div>
                ${activity.address ? `<div><i class="fas fa-location-arrow" style="color: var(--primary-color); width: 20px;"></i> <strong>地址：</strong>${activity.address}</div>` : ''}
                <div><i class="fas fa-dollar-sign" style="color: var(--primary-color); width: 20px;"></i> <strong>費用：</strong>${activity.fee > 0 ? formatCurrency(activity.fee) : '免費'}</div>
                <div><i class="fas fa-users" style="color: var(--primary-color); width: 20px;"></i> <strong>人數：</strong>${activity.currentParticipants}/${activity.maxParticipants || '不限'}</div>
                ${activity.deadline ? `<div><i class="fas fa-calendar-times" style="color: var(--danger-color); width: 20px;"></i> <strong>報名截止：</strong>${formatDate(activity.deadline)}</div>` : ''}
              </div>
            </div>
            <div class="card" style="margin: 0;">
              <h4 style="margin-bottom: 1rem;"><i class="fas fa-user-friends"></i> 參與者 (${activity.participants ? activity.participants.length : 0})</h4>
              <div style="max-height: 200px; overflow-y: auto;">
                ${activity.participants && activity.participants.length > 0 ? 
                  activity.participants.map(p => `
                    <div style="padding: 0.5rem; border-bottom: 1px solid var(--table-border);">
                      <i class="fas fa-user"></i> ${p['會員姓名']}
                    </div>
                  `).join('') :
                  '<p class="text-muted">目前尚無參與者</p>'
                }
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('activityDetailModal')">關閉</button>
          <button class="btn btn-primary" onclick="registerForActivity('${activity.activityId}')"><i class="fas fa-user-plus"></i> 立即報名</button>
        </div>
      `;
      openModal('activityDetailModal');
    }

    async function registerForActivity(activityId) {
      if (!currentUser) {
        showWarning('請先登入');
        openModal('loginModal');
        return;
      }
      if (!confirm('確定要報名此活動嗎？')) return;

      showLoading(true);
      try {
        const result = await API.registerActivity(activityId, currentUser.memberId);
        if (result.success) {
          showSuccess(result.message);
          closeModal('activityDetailModal');
          await loadActivities();
        } else {
          showError(result.error);
        }
      } catch (e) {
        showError('系統錯誤');
      } finally {
        showLoading(false);
      }
    }

    // ========== 會員頁面功能 ==========
    async function loadMemberPage() {
      if (!currentUser) {
        document.getElementById('memberPage').innerHTML = `
          <div class="empty-state" style="padding: 5rem 1rem;">
            <i class="fas fa-user-lock"></i>
            <h3>請先登入</h3>
            <p>登入後即可查看會員專區</p>
            <button class="btn btn-primary mt-2" onclick="openModal('loginModal')"><i class="fas fa-sign-in-alt"></i> 立即登入</button>
          </div>
        `;
        return;
      }

      showLoading(true);
      try {
        const profileResult = await API.getProfile();
        if (profileResult.success) {
          renderMemberProfile(profileResult.data);
        }

        const notificationsResult = await API.getUserNotifications(currentUser.memberId);
        if (notificationsResult.success) {
          renderMemberNotifications(notificationsResult.data);
          const unread = notificationsResult.unreadCount || 0;
          document.getElementById('memberUnreadNotifications').textContent = unread;
          const badge = document.getElementById('notificationCount');
          if (unread > 0) {
            badge.textContent = unread;
            badge.style.display = 'inline-block';
          } else {
            badge.textContent = '';
            badge.style.display = 'none';
          }
        }
      } catch (e) {
        showError('載入會員資料失敗');
      } finally {
        showLoading(false);
      }
    }

    function renderMemberProfile(profile) {
      document.getElementById('memberName').textContent = profile.name;
      document.getElementById('memberId').textContent = profile.memberId;
      document.getElementById('memberEmail').textContent = profile.email;
      document.getElementById('memberPhone').textContent = profile.phone || '未設定';
      document.getElementById('memberJoinDate').textContent = profile.registrationDate;
      document.getElementById('memberAvatar').textContent = profile.name.substring(0, 1);

      const joinDate = new Date(profile.registrationDate);
      const today = new Date();
      const days = Math.floor((today - joinDate) / (1000 * 60 * 60 * 24));
      document.getElementById('memberDays').textContent = days;

      // 儲存 memberId（供其他 API 使用）
      currentUser = { ...currentUser, memberId: profile.memberId, name: profile.name, role: profile.role, email: profile.email };
    }

    function renderMemberNotifications(notifications) {
      const container = document.getElementById('memberNotificationsList');
      if (!notifications || notifications.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-bell-slash"></i><p>目前沒有通知</p></div>';
        return;
      }

      container.innerHTML = notifications.map(n => `
        <div class="notification-item ${n.status === 'unread' ? 'unread' : ''}" onclick="markNotificationAsRead('${n.notificationId}')">
          <div class="notification-icon"><i class="fas fa-bell"></i></div>
          <div class="notification-content">
            <div class="notification-title">${n.title}</div>
            <div class="notification-text">${n.content}</div>
            <div class="notification-time">${formatDate(n.time)}</div>
          </div>
        </div>
      `).join('');
    }

    async function markNotificationAsRead(notificationId) {
      if (!currentUser) return;
      const result = await API.markNotificationAsRead(currentUser.memberId, notificationId);
      if (result.success) await loadMemberPage();
    }

    async function markAllNotificationsAsRead() {
      if (!currentUser) return;

      showLoading(true);
      try {
        const result = await API.markAllNotificationsAsRead(currentUser.memberId);
        if (result.success) {
          showSuccess(result.message);
          await loadMemberPage();
        }
      } catch (e) {
        showError('操作失敗');
      } finally {
        showLoading(false);
      }
    }

    // ========== 財務頁面功能 ==========
    async function loadFinancePage() {
      await loadFinanceSummary();
      await loadFinanceRecords();
      await loadBudgets();
    }

    async function loadFinanceSummary(period = 'month') {
      showLoading(true);
      try {
        const result = await API.getFinanceSummary(period);
        if (result.success) {
          lastFinanceSummary = result.data; // 快取
          renderFinanceSummary(result.data);
        }
      } catch (e) {
        showError('載入財務摘要失敗');
      } finally {
        showLoading(false);
      }
    }

    function renderFinanceSummary(data) {
      document.getElementById('totalIncome').textContent = formatCurrency(data.totalIncome || 0);
      document.getElementById('totalExpense').textContent = formatCurrency(data.totalExpense || 0);
      document.getElementById('netIncome').textContent = formatCurrency(data.netIncome || 0);
      document.getElementById('pendingApprovals').textContent = data.pendingApprovals || 0;

      if (data.monthlyTrend) drawTrendChart(data.monthlyTrend);
      if (data.incomeByCategory) drawPieChart('incomeChart', data.incomeByCategory, '收入分類');
      if (data.expenseByCategory) drawPieChart('expenseChart', data.expenseByCategory, '支出分類');
    }

    function drawTrendChart(trendData) {
      const canvas = document.getElementById('trendChart');
      if (!canvas || !trendData || trendData.length === 0) return;

      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      const padding = 50;

      ctx.clearRect(0, 0, width, height);

      const maxValue = Math.max(...trendData.map(d => Math.max(d.income, d.expense)));
      if (maxValue === 0) {
        ctx.font = '16px Arial'; ctx.fillStyle = '#999'; ctx.textAlign = 'center';
        ctx.fillText('暫無資料', width / 2, height / 2);
        return;
      }

      ctx.strokeStyle = '#ddd'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(padding, padding); ctx.lineTo(padding, height - padding); ctx.lineTo(width - padding, height - padding); ctx.stroke();

      const stepX = (width - 2 * padding) / (trendData.length - 1);
      const stepY = (height - 2 * padding) / maxValue;

      ctx.strokeStyle = '#43e97b'; ctx.lineWidth = 3; ctx.beginPath();
      trendData.forEach((d, i) => {
        const x = padding + i * stepX;
        const y = height - padding - d.income * stepY;
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.stroke();

      ctx.strokeStyle = '#fa709a'; ctx.lineWidth = 3; ctx.beginPath();
      trendData.forEach((d, i) => {
        const x = padding + i * stepX;
        const y = height - padding - d.expense * stepY;
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.stroke();

      ctx.fillStyle = '#666'; ctx.font = '12px Arial'; ctx.textAlign = 'center';
      trendData.forEach((d, i) => {
        const x = padding + i * stepX;
        if (i % Math.ceil(trendData.length / 10) === 0) {
          ctx.fillText(d.date, x, height - padding + 20);
        }
      });

      ctx.fillStyle = '#43e97b'; ctx.fillRect(width - 150, 20, 20, 20);
      ctx.fillStyle = '#333'; ctx.font = '14px Arial'; ctx.textAlign = 'left'; ctx.fillText('收入', width - 125, 35);

      ctx.fillStyle = '#fa709a'; ctx.fillRect(width - 150, 45, 20, 20);
      ctx.fillStyle = '#333'; ctx.fillText('支出', width - 125, 60);
    }

    function drawPieChart(canvasId, data, title) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;

      ctx.clearRect(0, 0, width, height);

      const labels = Object.keys(data);
      const values = Object.values(data);
      const total = values.reduce((sum, v) => sum + v, 0);

      if (total === 0) {
        ctx.font = '14px Arial'; ctx.fillStyle = '#999'; ctx.textAlign = 'center';
        ctx.fillText('暫無資料', width / 2, height / 2);
        return;
      }

      const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#fbbc04'];
      let currentAngle = -Math.PI / 2;
      const centerX = width / 2;
      const centerY = height / 2 - 30;
      const radius = Math.min(width, height) / 3;

      values.forEach((value, index) => {
        const sliceAngle = (value / total) * 2 * Math.PI;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.lineTo(centerX, centerY);
        ctx.fillStyle = colors[index % colors.length];
        ctx.fill();
        currentAngle += sliceAngle;
      });

      const legendY = height - 80;
      const legendX = 20;
      labels.forEach((label, index) => {
        ctx.fillStyle = colors[index % colors.length];
        ctx.fillRect(legendX, legendY + index * 20, 15, 15);
        ctx.fillStyle = '#333';
        ctx.font = '12px Arial';
        ctx.textAlign = 'left';
        const percentage = ((values[index] / total) * 100).toFixed(1);
        ctx.fillText(`${label} (${percentage}%)`, legendX + 20, legendY + index * 20 + 12);
      });
    }

    async function loadFinanceRecords(filters = {}) {
      showLoading(true);
      try {
        const result = await API.getFinanceRecords(filters);
        if (result.success) {
          renderFinanceRecords(result.data);
          renderPagination('finance', result.page, result.totalPages);
        }
      } catch (e) {
        showError('載入財務記錄失敗');
      } finally {
        showLoading(false);
      }
    }

    function renderFinanceRecords(records) {
      const tbody = document.getElementById('financeRecordsTable');
      if (!records || records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><i class="fas fa-file-invoice-dollar"></i><p>目前沒有財務記錄</p></td></tr>';
        return;
      }

      tbody.innerHTML = records.map(r => `
        <tr>
          <td><input type="checkbox" class="record-checkbox" data-id="${r.recordId}"></td>
          <td>${r.recordId}</td>
          <td>${r.transactionDate}</td>
          <td><span class="badge ${r.type === 'income' ? 'badge-success' : 'badge-danger'}">${r.type === 'income' ? '收入' : '支出'}</span></td>
          <td>${r.category}</td>
          <td class="text-right">${formatCurrency(r.amount)}</td>
          <td><span class="badge ${getStatusBadgeClass(r.status)}">${getStatusText(r.status)}</span></td>
          <td>
            <div class="btn-group">
              ${r.status === 'pending' && currentUser && currentUser.role === 'admin' ? `
                <button class="btn btn-success btn-sm" onclick="approveRecord('${r.recordId}')" title="審核通過"><i class="fas fa-check"></i></button>
                <button class="btn btn-danger btn-sm" onclick="rejectRecord('${r.recordId}')" title="拒絕"><i class="fas fa-times"></i></button>
              ` : ''}
              ${r.receiptUrl ? `<a href="${r.receiptUrl}" target="_blank" class="btn btn-info btn-sm" title="查看收據"><i class="fas fa-file-download"></i></a>` : ''}
            </div>
          </td>
        </tr>
      `).join('');
    }

    function getStatusBadgeClass(status) {
      const classes = { 'pending': 'badge-warning', 'approved': 'badge-success', 'rejected': 'badge-danger' };
      return classes[status] || 'badge-info';
    }

    function getStatusText(status) {
      const texts = { 'pending': '待審核', 'approved': '已審核', 'rejected': '已拒絕' };
      return texts[status] || status;
    }

    async function approveRecord(recordId) {
      if (!confirm('確定要審核通過此記錄嗎？')) return;

      showLoading(true);
      try {
        const result = await API.approveFinanceRecord(recordId);
        if (result.success) {
          showSuccess('審核成功');
          await loadFinanceRecords();
          await loadFinanceSummary();
        } else {
          showError(result.error);
        }
      } catch (e) {
        showError('系統錯誤');
      } finally {
        showLoading(false);
      }
    }

    async function rejectRecord(recordId) {
      const reason = prompt('請輸入拒絕原因：');
      if (!reason) return;

      showLoading(true);
      try {
        const result = await API.rejectFinanceRecord(recordId, reason);
        if (result.success) {
          showSuccess('已拒絕此記錄');
          await loadFinanceRecords();
        } else {
          showError(result.error);
        }
      } catch (e) {
        showError('系統錯誤');
      } finally {
        showLoading(false);
      }
    }

    async function batchApproveRecords() {
      const checkboxes = document.querySelectorAll('.record-checkbox:checked');
      if (checkboxes.length === 0) {
        showWarning('請選擇要審核的記錄');
        return;
      }

      if (!confirm(`確定要審核 ${checkboxes.length} 筆記錄嗎？`)) return;

      showLoading(true);
      let successCount = 0;
      let failCount = 0;

      for (const checkbox of checkboxes) {
        const recordId = checkbox.dataset.id;
        const result = await API.approveFinanceRecord(recordId);
        if (result.success) successCount++;
        else failCount++;
      }

      showLoading(false);
      showSuccess(`審核完成：成功 ${successCount} 筆，失敗 ${failCount} 筆`);
      await loadFinanceRecords();
      await loadFinanceSummary();
    }

    async function exportFinanceData() {
      if (!confirm('確定要匯出財務資料嗎？')) return;

      showLoading(true);
      try {
        const result = await API.exportFinanceData(currentFilters);
        if (result.success) {
          showSuccess(`匯出成功！共 ${result.data.recordCount} 筆記錄`);
          window.open(result.data.exportUrl, '_blank');
        } else {
          showError(result.error);
        }
      } catch (e) {
        showError('系統錯誤');
      } finally {
        showLoading(false);
      }
    }

    async function loadBudgets(filters = {}) {
      showLoading(true);
      try {
        const result = await API.getBudgets(filters);
        if (result.success) {
          renderBudgets(result.data);
        }
      } catch (e) {
        showError('載入預算失敗');
      } finally {
        showLoading(false);
      }
    }

    function renderBudgets(budgets) {
      const container = document.getElementById('budgetList');
      if (!budgets || budgets.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-chart-pie"></i><p>目前沒有預算設定</p></div>';
        return;
      }

      container.innerHTML = budgets.map(b => `
        <div class="budget-card card">
          <div class="budget-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <h4 style="margin:0;">${b.year}年 ${b.month}月 - ${b.category}</h4>
            <span class="badge ${b.status === 'active' ? 'badge-success' : 'badge-secondary'}">${b.status === 'active' ? '進行中' : '已結束'}</span>
          </div>
          <div class="progress-bar" style="height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; position: relative; margin: 1rem 0;">
            <div class="progress-fill" style="height: 100%; background: linear-gradient(90deg, var(--success-color), #38f9d7); transition: width 0.5s ease; width: ${b.usageRate}"></div>
          </div>
          <div class="progress-text" style="text-align:center;margin-top:0.5rem;font-weight:600;color:var(--primary-color);">${b.usageRate}</div>
          <div class="budget-stats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-top:1rem;">
            <div class="stat-item" style="text-align:center;">
              <label style="display:block;font-size:0.8rem;color:#666;margin-bottom:0.3rem;">預算金額</label>
              <span>${formatCurrency(b.budgetAmount)}</span>
            </div>
            <div class="stat-item" style="text-align:center;">
              <label style="display:block;font-size:0.8rem;color:#666;margin-bottom:0.3rem;">已使用</label>
              <span class="text-danger">${formatCurrency(b.usedAmount)}</span>
            </div>
            <div class="stat-item" style="text-align:center;">
              <label style="display:block;font-size:0.8rem;color:#666;margin-bottom:0.3rem;">剩餘</label>
              <span class="text-success">${formatCurrency(b.remainingAmount)}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    // ========== 管理員頁面功能 ==========
    async function loadAdminPage() {
      if (!currentUser || currentUser.role !== 'admin') {
        document.getElementById('adminPage').innerHTML = `
          <div class="empty-state" style="padding: 5rem 1rem;">
            <i class="fas fa-lock"></i>
            <h3>權限不足</h3>
            <p>此頁面僅限管理員訪問</p>
          </div>
        `;
        return;
      }

      showLoading(true);
      try {
        const statsResult = await API.getStats();
        if (statsResult.success) {
          document.getElementById('adminStatMembers').textContent = statsResult.data.members || 0;
          document.getElementById('adminStatActivities').textContent = statsResult.data.activities || 0;
          document.getElementById('adminStatParticipants').textContent = statsResult.data.participants || 0;
          document.getElementById('adminStatIncome').textContent = formatCurrency(statsResult.data.income || 0);
        }

        const membersResult = await API.getMemberList({ pageSize: 20 });
        if (membersResult.success) {
          renderAdminMembers(membersResult.data);
        }
      } catch (e) {
        showError('載入管理員資料失敗');
      } finally {
        showLoading(false);
      }
    }

    function renderAdminMembers(members) {
      const tbody = document.getElementById('adminMembersTable');
      if (!members || members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="fas fa-users"></i><p>目前沒有會員</p></td></tr>';
        return;
      }

      tbody.innerHTML = members.map(m => `
        <tr>
          <td>${m.memberId}</td>
          <td>${m.name}</td>
          <td>${m.email}</td>
          <td>${m.phone}</td>
          <td>${m.registrationDate}</td>
          <td><span class="badge ${m.status === 'active' ? 'badge-success' : 'badge-warning'}">${m.status === 'active' ? '正常' : '待驗證'}</span></td>
          <td>
            <div class="btn-group">
              <button class="btn btn-primary btn-sm" title="查看詳情"><i class="fas fa-eye"></i></button>
              <button class="btn btn-secondary btn-sm" title="編輯"><i class="fas fa-edit"></i></button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    async function generateReport() {
      const type = prompt('請輸入報告類型：\n1. member_statistics (會員統計)\n2. activity_summary (活動摘要)\n3. financial_report (財務報告)\n4. comprehensive (綜合報告)', 'comprehensive');
      if (!type) return;

      const period = prompt('請輸入期間：week, month, quarter, year', 'month');
      if (!period) return;

      showLoading(true);
      try {
        const result = await API.generateReport(type, period);
        if (result.success) {
          showSuccess('報告產生成功');
          window.open(result.data.reportUrl, '_blank');
        } else {
          showError(result.error);
        }
      } catch (e) {
        showError('系統錯誤');
      } finally {
        showLoading(false);
      }
    }

    // ========== 分頁功能 ==========
    function renderPagination(prefix, currentPage, totalPages) {
      const container = document.getElementById(prefix + 'Pagination');
      if (!container || totalPages <= 1) {
        if (container) container.innerHTML = '';
        return;
      }

      let html = '<div class="pagination">';

      if (currentPage > 1) {
        html += `<button class="btn btn-sm btn-secondary" onclick="loadPage${prefix.charAt(0).toUpperCase() + prefix.slice(1)}(${currentPage - 1})">上一頁</button>`;
      }

      for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
          html += `<button class="btn btn-sm btn-primary active">${i}</button>`;
        } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += `<button class="btn btn-sm btn-secondary" onclick="loadPage${prefix.charAt(0).toUpperCase() + prefix.slice(1)}(${i})">${i}</button>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += `<span>...</span>`;
        }
      }

      if (currentPage < totalPages) {
        html += `<button class="btn btn-sm btn-secondary" onclick="loadPage${prefix.charAt(0).toUpperCase() + prefix.slice(1)}(${currentPage + 1})">下一頁</button>`;
      }

      html += '</div>';
      container.innerHTML = html;
    }

    function loadPageActivities(page) { loadActivities({ ...currentFilters, page: page }); }
    function loadPageFinance(page) { loadFinanceRecords({ ...currentFilters, page: page }); }

    // ========== 表單處理 ==========
    function setupForms() {
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const email = formData.get('email') || '';

        showLoading(true);
        try {
          const result = await API.login(email);
          if (result.success) {
            API.setToken(result.data.accessToken);
            currentUser = result.data;
            showSuccess('登入成功');
            closeModal('loginModal');
            updateUserInterface();
            await loadMemberPage(); // 立即載入會員資料
            loadPageData(currentPage);
          } else {
            showError(result.error || '登入失敗');
          }
        } catch (e) {
          showError('系統錯誤');
        } finally {
          showLoading(false);
        }
      });

      document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        showLoading(true);
        try {
          const result = await API.register(data);
          if (result.success) {
            showSuccess(result.message);
            closeModal('registerModal');
            e.target.reset();
          } else {
            showError(result.error);
          }
        } catch (e) {
          showError('系統錯誤');
        } finally {
          showLoading(false);
        }
      });

      document.getElementById('addFinanceRecordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        data.amount = parseFloat(data.amount);

        showLoading(true);
        try {
          const result = await API.addFinanceRecord(data);
          if (result.success) {
            showSuccess('財務記錄新增成功');
            closeModal('addFinanceRecordModal');
            e.target.reset();
            await loadFinanceRecords();
            await loadFinanceSummary();
          } else {
            showError(result.error);
          }
        } catch (e) {
          showError('系統錯誤');
        } finally {
          showLoading(false);
        }
      });

      document.getElementById('addBudgetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        data.year = parseInt(data.year);
        data.month = parseInt(data.month);
        data.amount = parseFloat(data.amount);

        showLoading(true);
        try {
          const result = await API.setBudget(data);
          if (result.success) {
            showSuccess('預算設定成功');
            closeModal('addBudgetModal');
            e.target.reset();
            await loadBudgets();
          } else {
            showError(result.error);
          }
        } catch (e) {
          showError('系統錯誤');
        } finally {
          showLoading(false);
        }
      });

      document.getElementById('addActivityForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        data.fee = parseFloat(data.fee) || 0;
        data.maxParticipants = parseInt(data.maxParticipants) || 0;

        showLoading(true);
        try {
          const result = await API.createActivity(data);
          if (result.success) {
            showSuccess('活動建立成功');
            closeModal('addActivityModal');
            e.target.reset();
            await loadActivities();
          } else {
            showError(result.error);
          }
        } catch (e) {
          showError('系統錯誤');
        } finally {
          showLoading(false);
        }
      });

      document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser) return;

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        showLoading(true);
        try {
          const result = await API.updateProfile(currentUser.memberId, data);
          if (result.success) {
            showSuccess('個人資料更新成功');
            closeModal('editProfileModal');
            await loadMemberPage();
          } else {
            showError(result.error);
          }
        } catch (e) {
          showError('系統錯誤');
        } finally {
          showLoading(false);
        }
      });

      document.getElementById('sendNotificationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        const channels = formData.getAll('channels');
        data.channels = channels;

        showLoading(true);
        try {
          const result = await API.sendNotification(data);
          if (result.success) {
            showSuccess('通知發送成功');
            closeModal('sendNotificationModal');
            e.target.reset();
          } else {
            showError(result.error);
          }
        } catch (e) {
          showError('系統錯誤');
        } finally {
          showLoading(false);
        }
      });
    }

    // ========== 使用者介面更新 ==========
    function updateUserInterface() {
      const loginBtn = document.getElementById('loginBtn');
      const loginText = document.getElementById('loginText');
      const adminNav = document.getElementById('adminNav');
      const addActivityBtn = document.getElementById('addActivityBtn');

      if (currentUser) {
        loginText.textContent = currentUser.name || '會員';
        loginBtn.onclick = logout;
        loginBtn.querySelector('i').className = 'fas fa-sign-out-alt';

        if (currentUser.role === 'admin') {
          adminNav.classList.remove('hidden');
          if (addActivityBtn) addActivityBtn.style.display = 'inline-flex';
        }
      } else {
        loginText.textContent = '登入';
        loginBtn.onclick = () => openModal('loginModal');
        loginBtn.querySelector('i').className = 'fas fa-sign-in-alt';
        adminNav.classList.add('hidden');
        if (addActivityBtn) addActivityBtn.style.display = 'none';
      }
    }

    function logout() {
      if (!confirm('確定要登出嗎？')) return;
      
      currentUser = null;
      API.setToken(null);
      updateUserInterface();
      showPage('home');
      showSuccess('已登出');
    }

    // ========== LIFF 相關 ==========
    async function initializeLIFF() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if (liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          await autoLoginWithLIFF(profile);
        }
      } catch (error) {
        console.warn('LIFF 初始化失敗:', error);
      }
    }

    async function autoLoginWithLIFF(profile) {
      showLoading(true);
      try {
        const result = await API.login(profile.email || '', profile.userId);
        if (result.success) {
          API.setToken(result.data.accessToken);
          currentUser = result.data;
          updateUserInterface();
          showSuccess('歡迎回來，' + (currentUser.name || '會員'));
        } else {
          showInfo('尚未綁定帳號，請輸入電子郵件完成綁定/登入');
          openModal('loginModal');
        }
      } catch (e) {
        console.error('自動登入失敗:', e);
      } finally {
        showLoading(false);
      }
    }

    async function loginWithLine() {
      try {
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          const profile = await liff.getProfile();
          await autoLoginWithLIFF(profile);
          closeModal('loginModal');
        }
      } catch (error) {
        showError('LINE 登入失敗');
        console.error('LINE 登入錯誤:', error);
      }
    }

    // ========== 活動篩選 ==========
    function setupActivityFilters() {
      document.querySelectorAll('.activity-filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.activity-filter-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          
          const category = e.target.dataset.category;
          const filters = category === 'all' ? {} : { category: category };
          loadActivities(filters);
        });
      });
    }

    // ========== 期間選擇器 ==========
    function setupPeriodSelector() {
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          
          const period = e.target.dataset.period;
          loadFinanceSummary(period);
        });
      });
    }

    // ========== 全選功能 ==========
    function toggleSelectAll(checkbox) {
      const checkboxes = document.querySelectorAll('.record-checkbox');
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
    }

    // ========== 導航功能 ==========
    function setupNavigation() {
      document.querySelectorAll('.topnav a').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const page = e.currentTarget.dataset.page;
          if (page) showPage(page);
        });
      });

      document.getElementById('notificationBtn').addEventListener('click', () => {
        if (currentUser) {
          showPage('member');
          setTimeout(() => {
            document.getElementById('memberNotificationsList').scrollIntoView({ behavior: 'smooth' });
          }, 300);
        } else {
          showWarning('請先登入');
          openModal('loginModal');
        }
      });
    }

    // ========== 鍵盤快捷鍵 ==========
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal.active').forEach(modal => modal.classList.remove('active'));
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
        }
      });
    }

    // ========== 點擊 Modal 外部關閉 ==========
    function setupModalClose() {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });
      });
    }

    // ========== 自動儲存草稿 ==========
    function setupAutoSave() {
      const forms = ['addFinanceRecordForm', 'addActivityForm', 'addBudgetForm'];
      forms.forEach(formId => {
        const form = document.getElementById(formId);
        if (!form) return;

        const draft = localStorage.getItem(`draft_${formId}`);
        if (draft) {
          try {
            const data = JSON.parse(draft);
            Object.keys(data).forEach(key => {
              const input = form.elements[key];
              if (input) input.value = data[key];
            });
          } catch (e) { console.error('載入草稿失敗:', e); }
        }

        form.addEventListener('input', () => {
          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());
          localStorage.setItem(`draft_${formId}`, JSON.stringify(data));
        });

        form.addEventListener('submit', () => {
          localStorage.removeItem(`draft_${formId}`);
        });
      });
    }

    // ========== 離線檢測 ==========
    function setupOfflineDetection() {
      window.addEventListener('online', () => { showSuccess('網路連線已恢復'); loadPageData(currentPage); });
      window.addEventListener('offline', () => { showWarning('網路連線已中斷，部分功能可能無法使用'); });
    }

    // ========== 效能監控 ==========
    function setupPerformanceMonitoring() {
      window.addEventListener('load', () => {
        const perfData = performance.timing;
        const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
        console.log('頁面載入時間:', pageLoadTime + 'ms');
      });

      const originalFetch = window.fetch;
      window.fetch = async function(...args) {
        const startTime = performance.now();
        const response = await originalFetch.apply(this, args);
        const endTime = performance.now();
        console.log(`API 請求時間 (${args[0]}):`, (endTime - startTime).toFixed(2) + 'ms');
        return response;
      };
    }

    // ========== 錯誤追蹤 ==========
    function setupErrorTracking() {
      window.addEventListener('error', (event) => { console.error('全域錯誤:', event.error); });
      window.addEventListener('unhandledrejection', (event) => { console.error('未處理的 Promise 拒絕:', event.reason); });
    }

    // ========== 資料預載 ==========
    const DataCache = {
      cache: new Map(),
      ttl: 5 * 60 * 1000,

      set(key, value) { this.cache.set(key, { value, timestamp: Date.now() }); },
      get(key) {
        const item = this.cache.get(key);
        if (!item) return null;
        const age = Date.now() - item.timestamp;
        if (age > this.ttl) { this.cache.delete(key); return null; }
        return item.value;
      },
      clear() { this.cache.clear(); }
    };

    async function preloadData() {
      API.getStats().then(result => { if (result.success) DataCache.set('stats', result.data); });
      API.getActivities({ upcoming: true, pageSize: 10 }).then(result => { if (result.success) DataCache.set('upcomingActivities', result.data); });
    }

    // ========== Service Worker 註冊 ==========
    function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => { console.log('Service Worker 註冊成功:', registration); })
          .catch(error => { console.log('Service Worker 註冊失敗:', error); });
      }
    }

    // ========== 推播通知 ==========
    async function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') { showSuccess('已開啟推播通知'); }
      }
    }

    // ========== 深色模式 ==========
    function setupDarkMode() {
      const darkModeToggle = document.createElement('button');
      darkModeToggle.className = 'btn btn-secondary btn-sm';
      darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
      darkModeToggle.style.position = 'fixed';
      darkModeToggle.style.bottom = '20px';
      darkModeToggle.style.right = '20px';
      darkModeToggle.style.zIndex = '1000';
      darkModeToggle.style.borderRadius = '50%';
      darkModeToggle.style.width = '50px';
      darkModeToggle.style.height = '50px';
      darkModeToggle.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';

      darkModeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        darkModeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        localStorage.setItem('darkMode', isDark);
      });

      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      }

      document.body.appendChild(darkModeToggle);
    }

    // ========== 輔助功能 ==========
    function setupAccessibility() {
      const skipLink = document.createElement('a');
      skipLink.href = '#main-content';
      skipLink.textContent = '跳到主要內容';
      skipLink.className = 'skip-link';
      skipLink.style.cssText = `
        position: absolute;
        top: -40px;
        left: 0;
        background: var(--primary-color);
        color: white;
        padding: 8px;
        text-decoration: none;
        z-index: 100;
      `;
      skipLink.addEventListener('focus', () => { skipLink.style.top = '0'; });
      skipLink.addEventListener('blur', () => { skipLink.style.top = '-40px'; });
      document.body.insertBefore(skipLink, document.body.firstChild);

      document.querySelectorAll('button:not([aria-label])').forEach(btn => {
        const text = btn.textContent.trim() || btn.title;
        if (text) btn.setAttribute('aria-label', text);
      });
    }

    // ========== 列印樣式 ==========
    function setupPrintStyles() {
      const printBtn = document.createElement('button');
      printBtn.className = 'btn btn-secondary btn-sm';
      printBtn.innerHTML = '<i class="fas fa-print"></i> 列印';
      printBtn.style.display = 'none';
      printBtn.addEventListener('click', () => window.print());
      
      document.querySelectorAll('.page-header').forEach(header => {
        const clone = printBtn.cloneNode(true);
        clone.style.display = 'inline-flex';
        clone.addEventListener('click', () => window.print());
        header.querySelector('.header-actions')?.appendChild(clone);
      });
    }

    // ========== 匯出功能 ==========
    function exportToCSV(data, filename) {
      const csv = convertToCSV(data);
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    function convertToCSV(data) {
      if (!data || data.length === 0) return '';
      const headers = Object.keys(data[0]);
      const rows = data.map(row => 
        headers.map(header => {
          const value = row[header];
          return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
        }).join(',')
      );
      return [headers.join(','), ...rows].join('\n');
    }

    function exportChart(canvasId, filename) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename + '.png';
        link.click();
        URL.revokeObjectURL(url);
      });
    }

    function validateForm(formId) {
      const form = document.getElementById(formId);
      if (!form) return false;
      const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
      let isValid = true;

      inputs.forEach(input => {
        if (!input.value.trim()) {
          input.style.borderColor = 'var(--danger-color)';
          isValid = false;
        } else {
          input.style.borderColor = '';
        }
      });
      if (!isValid) showError('請填寫所有必填欄位');
      return isValid;
    }

    // ========== 初始化應用程式 ==========
    async function initializeApp() {
      console.log('🚀 初始化應用程式...');

      if (!CONFIG.GAS_URL || CONFIG.GAS_URL === 'YOUR_GAS_WEB_APP_URL') {
        showError('請先設定 GAS_URL');
        return;
      }

      setupForms();
      setupNavigation();
      setupActivityFilters();
      setupPeriodSelector();
      setupKeyboardShortcuts();
      setupModalClose();
      setupAutoSave();
      setupOfflineDetection();
      setupPerformanceMonitoring();
      setupErrorTracking();
      setupAccessibility();
      setupPrintStyles();
      setupDarkMode();

      await initializeLIFF();

      const token = API.getToken();
      if (token) {
        try {
          const result = await API.getProfile();
          if (result.success) {
            currentUser = result.data;
            updateUserInterface();
          } else {
            API.setToken(null);
          }
        } catch (e) {
          console.error('載入使用者資料失敗:', e);
        }
      }

      await loadHomePage();
      preloadData();
      setTimeout(requestNotificationPermission, 3000);

      console.log('✅ 應用程式初始化完成');
    }

    document.addEventListener('DOMContentLoaded', () => { initializeApp(); });

    document.addEventListener('visibilitychange', () => { if (!document.hidden && currentUser) loadPageData(currentPage); });

    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (currentPage === 'finance' && lastFinanceSummary) {
          renderFinanceSummary(lastFinanceSummary);
        }
      }, 250);
    });

    const backToTopBtn = document.createElement('button');
    backToTopBtn.className = 'btn btn-primary btn-sm';
    backToTopBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
    backToTopBtn.style.cssText = `
      position: fixed; bottom: 80px; right: 20px; z-index: 1000;
      border-radius: 50%; width: 50px; height: 50px; display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    backToTopBtn.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });
    document.body.appendChild(backToTopBtn);

    window.addEventListener('scroll', () => {
      if (window.pageYOffset > 300) {
        backToTopBtn.style.display = 'flex';
        backToTopBtn.style.alignItems = 'center';
        backToTopBtn.style.justifyContent = 'center';
      } else {
        backToTopBtn.style.display = 'none';
      }
    });

    window.onerror = function(message, source, lineno, colno, error) {
      console.error('全域錯誤:', { message, source, lineno, colno, error });
      showError('系統發生錯誤，請重新整理頁面');
      return true;
    };

    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      console.log('%c開發模式', 'color: #43e97b; font-size: 20px; font-weight: bold;');
      console.log('可用的全域函數:', { API, showPage, openModal, closeModal, showToast, formatCurrency, formatDate, DataCache });
    }

    document.addEventListener('submit', (e) => {
      const submitBtn = e.target.querySelector('button[type="submit"]');
      if (submitBtn && !submitBtn.disabled) {
        submitBtn.disabled = true;
        setTimeout(() => { submitBtn.disabled = false; }, 3000);
      }
    });

    let inactivityTimer;
    const INACTIVITY_TIMEOUT = 30 * 60 * 1000;
    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      if (currentUser) {
        inactivityTimer = setTimeout(() => {
          showWarning('由於長時間無操作，系統已自動登出');
          logout();
        }, INACTIVITY_TIMEOUT);
      }
    }
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
      document.addEventListener(event, resetInactivityTimer, true);
    });

    const APP_VERSION = '1.0.1';
    console.log(`%c帕金森病友權益促進會管理系統 v${APP_VERSION}`, 'color: #667eea; font-size: 16px; font-weight: bold;');
    console.log('%c系統就緒 ✓', 'color: #43e97b; font-size: 14px;');
  </script>
</body>
</html>
