<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>帕促會病友權益促進會管理系統</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<style>
  :root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --accent-color: #e74c3c;
    --success-color: #27ae60;
    --warning-color: #f39c12;
    --info-color: #17a2b8;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f8f9fa;
  }

  /* 側邊欄樣式 */
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    width: 280px;
    background: linear-gradient(135deg, var(--primary-color) 0%, #34495e 100%);
    color: white;
    transition: all 0.3s ease;
    z-index: 1000;
    overflow-y: auto;
  }

  .sidebar.collapsed {
    width: 70px;
  }

  .sidebar-header {
    padding: 20px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .sidebar.collapsed .sidebar-header .logo-text {
    display: none;
  }

  .sidebar-nav {
    padding: 20px 0;
  }

  .nav-item {
    margin: 5px 15px;
    border-radius: 10px;
    transition: all 0.3s ease;
    position: relative;
  }

  .nav-item:hover {
    background-color: rgba(255,255,255,0.1);
  }

  .nav-item.active {
    background: linear-gradient(135deg, var(--secondary-color) 0%, #2980b9 100%);
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
  }

  .nav-link {
    color: white !important;
    padding: 15px 20px;
    text-decoration: none;
    display: flex;
    align-items: center;
    transition: all 0.3s ease;
  }

  .nav-link i {
    width: 20px;
    margin-right: 15px;
    text-align: center;
  }

  .sidebar.collapsed .nav-link span {
    display: none;
  }

  .sidebar.collapsed .nav-item {
    margin: 5px 10px;
  }

  /* 通知徽章 */
  .notification-badge {
    position: absolute;
    top: 5px;
    right: 10px;
    background: var(--accent-color);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }

  .sidebar.collapsed .notification-badge {
    right: 5px;
  }

  /* 主要內容區域 */
  .main-content {
    margin-left: 280px;
    transition: all 0.3s ease;
    min-height: 100vh;
  }

  .main-content.expanded {
    margin-left: 70px;
  }

  /* 頂部導航 */
  .top-navbar {
    background: white;
    padding: 15px 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 999;
  }

  .toggle-btn {
    background: none;
    border: none;
    font-size: 20px;
    color: var(--primary-color);
    cursor: pointer;
    padding: 10px;
    border-radius: 5px;
    transition: all 0.3s ease;
  }

  .toggle-btn:hover {
    background-color: #f8f9fa;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--secondary-color) 0%, #2980b9 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
  }

  /* 頁面內容 */
  .page-content {
    padding: 30px;
  }

  .page-title {
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e9ecef;
  }

  .page-title h1 {
    color: var(--primary-color);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .page-title .subtitle {
    color: #6c757d;
    font-size: 16px;
    margin-top: 5px;
  }

  /* 統計卡片 */
  .stat-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    border: none;
  }

  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }

  .stat-card .icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
  }

  .stat-card .number {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 5px;
  }

  .stat-card .label {
    color: #6c757d;
    font-size: 0.9rem;
  }

  /* 載入動畫 */
  .loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 400px;
    flex-direction: column;
    gap: 20px;
  }

  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--secondary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* 表格樣式 */
  .table-container {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }

  .table th {
    background-color: #f8f9fa;
    border: none;
    font-weight: 600;
    color: var(--primary-color);
  }

  .table td {
    border: none;
    border-bottom: 1px solid #e9ecef;
    vertical-align: middle;
  }

  /* 狀態徽章 */
  .status-badge {
    padding: 0.35rem 0.65rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .status-active { background-color: #d4edda; color: #155724; }
  .status-pending { background-color: #fff3cd; color: #856404; }
  .status-approved { background-color: #d4edda; color: #155724; }
  .status-rejected { background-color: #f8d7da; color: #721c24; }
  .status-void { background-color: #e2e3e5; color: #383d41; }

  /* 按鈕樣式 */
  .btn-primary {
    background: linear-gradient(135deg, var(--secondary-color) 0%, #2980b9 100%);
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: 500;
  }

  .btn-success {
    background: linear-gradient(135deg, var(--success-color) 0%, #229954 100%);
    border: none;
    border-radius: 8px;
  }

  .btn-danger {
    background: linear-gradient(135deg, var(--accent-color) 0%, #c0392b 100%);
    border: none;
    border-radius: 8px;
  }

  .btn-warning {
    background: linear-gradient(135deg, var(--warning-color) 0%, #d68910 100%);
    border: none;
    border-radius: 8px;
  }

  /* 表單樣式 */
  .form-control:focus {
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
  }

  .form-select:focus {
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
  }

  /* 快速操作按鈕 */
  .quick-actions {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
  }

  .quick-action-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--secondary-color) 0%, #2980b9 100%);
    border: none;
    color: white;
    font-size: 24px;
    box-shadow: 0 4px 20px rgba(52, 152, 219, 0.4);
    transition: all 0.3s ease;
    margin-bottom: 15px;
    display: block;
  }

  .quick-action-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 25px rgba(52, 152, 219, 0.6);
    color: white;
  }

  /* 響應式設計 */
  @media (max-width: 768px) {
    .sidebar {
      transform: translateX(-100%);
    }
    
    .sidebar.show {
      transform: translateX(0);
    }
    
    .main-content {
      margin-left: 0;
    }
    
    .main-content.expanded {
      margin-left: 0;
    }

    .page-content {
      padding: 15px;
    }

    .quick-actions {
      bottom: 20px;
      right: 20px;
    }

    .quick-action-btn {
      width: 50px;
      height: 50px;
      font-size: 20px;
    }
  }

  /* 圖表容器 */
  .chart-container {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }

  /* 待辦事項 */
  .todo-item {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .todo-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  }

  .todo-item .badge {
    float: right;
  }

  /* 模態框樣式 */
  .modal-content {
    border: none;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }

  .modal-header {
    border-bottom: 1px solid #e9ecef;
    border-radius: 15px 15px 0 0;
  }

  .modal-footer {
    border-top: 1px solid #e9ecef;
    border-radius: 0 0 15px 15px;
  }

  /* 提示訊息 */
  .alert {
    border: none;
    border-radius: 10px;
    padding: 15px 20px;
  }

  .alert-success {
    background-color: #d4edda;
    color: #155724;
  }

  .alert-warning {
    background-color: #fff3cd;
    color: #856404;
  }

  .alert-danger {
    background-color: #f8d7da;
    color: #721c24;
  }

  .alert-info {
    background-color: #d1ecf1;
    color: #0c5460;
  }
</style>
</head>
<body>
<!-- 側邊欄 -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="d-flex align-items-center">
      <i class="fas fa-heartbeat fa-2x text-danger me-3"></i>
      <div class="logo-text">
        <h5 class="mb-0">帕促會</h5>
        <small class="text-light">管理系統</small>
      </div>
    </div>
  </div>

  <nav class="sidebar-nav">
    <div class="nav-item active" data-page="dashboard">
      <a href="#" class="nav-link">
        <i class="fas fa-tachometer-alt"></i>
        <span>儀表板</span>
      </a>
    </div>

    <div class="nav-item" data-page="membership">
      <a href="#" class="nav-link">
        <i class="fas fa-users"></i>
        <span>會員管理</span>
      </a>
    </div>

    <div class="nav-item" data-page="membership-fee">
      <a href="#" class="nav-link">
        <i class="fas fa-credit-card"></i>
        <span>會費管理</span>
        <span class="notification-badge" id="feeNotification">0</span>
      </a>
    </div>

    <div class="nav-item" data-page="donation">
      <a href="#" class="nav-link">
        <i class="fas fa-hand-holding-heart"></i>
        <span>捐款管理</span>
      </a>
    </div>

    <div class="nav-item" data-page="expense">
      <a href="#" class="nav-link">
        <i class="fas fa-money-bill-wave"></i>
        <span>支出管理</span>
        <span class="notification-badge" id="expenseNotification">0</span>
      </a>
    </div>

    <div class="nav-item" data-page="receipt">
      <a href="#" class="nav-link">
        <i class="fas fa-receipt"></i>
        <span>收據管理</span>
      </a>
    </div>

    <div class="nav-item" data-page="approval">
      <a href="#" class="nav-link">
        <i class="fas fa-check-circle"></i>
        <span>核准流程</span>
        <span class="notification-badge" id="approvalNotification">0</span>
      </a>
    </div>

    <div class="nav-item" data-page="report">
      <a href="#" class="nav-link">
        <i class="fas fa-chart-bar"></i>
        <span>財務報表</span>
      </a>
    </div>

    <hr style="border-color: rgba(255,255,255,0.2); margin: 20px 15px;">

    <div class="nav-item" data-page="settings">
      <a href="#" class="nav-link">
        <i class="fas fa-cog"></i>
        <span>系統設定</span>
      </a>
    </div>

    <div class="nav-item" onclick="logout()">
      <a href="#" class="nav-link">
        <i class="fas fa-sign-out-alt"></i>
        <span>登出</span>
      </a>
    </div>
  </nav>
</div>

<!-- 主要內容區域 -->
<div class="main-content" id="mainContent">
  <!-- 頂部導航 -->
  <div class="top-navbar">
    <div class="d-flex align-items-center">
      <button class="toggle-btn" id="toggleBtn">
        <i class="fas fa-bars"></i>
      </button>
      <div class="ms-3">
        <span class="fw-bold" id="currentPageTitle">儀表板</span>
        <div class="small text-muted" id="currentTime"></div>
      </div>
    </div>

    <div class="user-info">
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="fas fa-bell me-2"></i>
          通知 <span class="badge bg-danger" id="totalNotifications">0</span>
        </button>
        <ul class="dropdown-menu" id="notificationDropdown">
          <li><h6 class="dropdown-header">通知中心</h6></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-center text-muted" href="#">暫無通知</a></li>
        </ul>
      </div>

      <div class="user-avatar">
        <i class="fas fa-user"></i>
      </div>
      
      <div class="dropdown">
        <button class="btn btn-link text-decoration-none text-dark dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <div class="text-start">
            <div class="fw-bold">管理員</div>
            <small class="text-muted">admin@pacu.org</small>
          </div>
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>個人資料</a></li>
          <li><a class="dropdown-item" href="#"><i class="fas fa-key me-2"></i>修改密碼</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>登出</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- 頁面內容 -->
  <div class="page-content">
    <div class="page-title">
      <h1 id="pageTitle">
        <i class="fas fa-tachometer-alt text-primary"></i>
        儀表板
      </h1>
      <div class="subtitle" id="pageSubtitle">系統概覽與快速操作</div>
    </div>

    <!-- 動態載入的頁面內容 -->
    <div id="pageContainer">
      <div class="loading">
        <div class="spinner"></div>
        <p class="text-muted">載入中...</p>
      </div>
    </div>
  </div>
</div>

<!-- 快速操作按鈕 -->
<div class="quick-actions">
  <button class="quick-action-btn" onclick="quickAddMember()" title="快速新增會員">
    <i class="fas fa-user-plus"></i>
  </button>
  <button class="quick-action-btn" onclick="quickAddExpense()" title="快速新增支出">
    <i class="fas fa-plus"></i>
  </button>
</div>

<!-- 通用模態框 -->
<div class="modal fade" id="universalModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="universalModalTitle">標題</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="universalModalBody">
        內容載入中...
      </div>
      <div class="modal-footer" id="universalModalFooter">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript 函式庫 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // ==================== 全域變數 ====================
  
  // API 端點 URL - 請替換為您的 Google Apps Script Web App URL
  const API_URL = 'https://script.google.com/macros/s/AKfycbz9-YpcFegC04KTG5-WJJhYEFauPhXPoLPsG6n_jNTb_kX3x0V3ntGVS4h9ODigitqp/exec';
  
  // 頁面配置
  const pageConfig = {
    'dashboard': {
      title: '儀表板',
      subtitle: '系統概覽與快速操作',
      icon: 'fas fa-tachometer-alt'
    },
    'membership': {
      title: '會員管理',
      subtitle: '管理所有會員資料與狀態',
      icon: 'fas fa-users'
    },
    'membership-fee': {
      title: '會費管理',
      subtitle: '管理會員繳費記錄與狀態',
      icon: 'fas fa-credit-card'
    },
    'donation': {
      title: '捐款管理',
      subtitle: '管理所有捐款記錄與收據',
      icon: 'fas fa-hand-holding-heart'
    },
    'expense': {
      title: '支出管理',
      subtitle: '管理所有支出申請與核准流程',
      icon: 'fas fa-money-bill-wave'
    },
    'receipt': {
      title: '收據管理',
      subtitle: '管理所有收據的開立、查詢與作廢',
      icon: 'fas fa-receipt'
    },
    'approval': {
      title: '核准流程',
      subtitle: '管理所有需要核准的申請案件',
      icon: 'fas fa-check-circle'
    },
    'report': {
      title: '財務報表',
      subtitle: '查看各種財務統計與分析報表',
      icon: 'fas fa-chart-bar'
    },
    'settings': {
      title: '系統設定',
      subtitle: '系統參數與使用者權限設定',
      icon: 'fas fa-cog'
    }
  };

  // 當前頁面和資料
  let currentPage = 'dashboard';
  let currentData = {};
  let dataTable = null;

  // ==================== 系統初始化 ====================
  
  document.addEventListener('DOMContentLoaded', function() {
    initializeSystem();
  });

  /**
   * 初始化系統
   */
  function initializeSystem() {
    try {
      // 初始化導航
      initializeNavigation();
      
      // 更新時間
      updateCurrentTime();
      setInterval(updateCurrentTime, 60000);
      
      // 載入儀表板
      loadPage('dashboard');
      
      // 載入通知
      loadNotifications();
      
      // 響應式處理
      handleResponsive();
      window.addEventListener('resize', handleResponsive);
      
      console.log('系統初始化完成');
      
    } catch (error) {
      console.error('系統初始化失敗:', error);
      showAlert('系統初始化失敗，請重新整理頁面', 'danger');
    }
  }

  /**
   * 初始化導航系統
   */
  function initializeNavigation() {
    // 側邊欄切換
    document.getElementById('toggleBtn').addEventListener('click', toggleSidebar);
    
    // 導航項目點擊事件
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        const page = this.getAttribute('data-page');
        if (page) {
          loadPage(page);
        }
      });
    });
  }

  // ==================== 頁面管理 ====================
  
  /**
   * 載入頁面
   */
  function loadPage(pageName) {
    if (!pageConfig[pageName]) {
      console.error('頁面配置不存在:', pageName);
      return;
    }

    const config = pageConfig[pageName];
    
    // 更新導航狀態
    updateNavigation(pageName);
    
    // 更新頁面標題
    updatePageTitle(config);
    
    // 顯示載入動畫
    showLoading();
    
    // 載入頁面內容
    setTimeout(() => {
      loadPageContent(pageName, config);
    }, 300);
  }

  /**
   * 更新導航狀態
   */
  function updateNavigation(pageName) {
    // 移除所有 active 狀態
    document.querySelectorAll('.nav-item').forEach(item => {
      item.classList.remove('active');
    });
    
    // 添加當前頁面的 active 狀態
    const currentNavItem = document.querySelector(`[data-page="${pageName}"]`);
    if (currentNavItem) {
      currentNavItem.classList.add('active');
    }
    
    currentPage = pageName;
  }

  /**
   * 更新頁面標題
   */
  function updatePageTitle(config) {
    document.getElementById('currentPageTitle').textContent = config.title;
    document.getElementById('pageTitle').innerHTML = `
      <i class="${config.icon} text-primary"></i>
      ${config.title}
    `;
    document.getElementById('pageSubtitle').textContent = config.subtitle;
    document.title = `${config.title} - 帕促會管理系統`;
  }

  /**
   * 顯示載入動畫
   */
  function showLoading() {
    document.getElementById('pageContainer').innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        <p class="text-muted">載入中...</p>
      </div>
    `;
  }

  /**
   * 載入頁面內容
   */
  async function loadPageContent(pageName, config) {
    try {
      let content = '';
      
      switch(pageName) {
        case 'dashboard':
          content = await loadDashboard();
          break;
        case 'membership':
          content = await loadMembership();
          break;
        case 'membership-fee':
          content = await loadMembershipFee();
          break;
        case 'donation':
          content = await loadDonation();
          break;
        case 'expense':
          content = await loadExpense();
          break;
        case 'receipt':
          content = await loadReceipt();
          break;
        case 'approval':
          content = await loadApproval();
          break;
        case 'report':
          content = await loadReport();
          break;
        case 'settings':
          content = await loadSettings();
          break;
        default:
          content = getDefaultContent(config.title);
      }
      
      document.getElementById('pageContainer').innerHTML = content;
      
      // 初始化頁面特定功能
      initializePageFeatures(pageName);
      
    } catch (error) {
      console.error('載入頁面內容失敗:', error);
      document.getElementById('pageContainer').innerHTML = `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          載入頁面失敗：${error.message}
        </div>
      `;
    }
  }

  // ==================== 儀表板 ====================
  
  /**
   * 載入儀表板
   */
  async function loadDashboard() {
    try {
      const stats = await apiCall('getDashboardStats');
      
      if (!stats.success) {
        throw new Error(stats.message);
      }
      
      const data = stats.data;
      
      return `
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-primary">
                <i class="fas fa-users"></i>
              </div>
              <div class="number text-primary">${data.totalMembers}</div>
              <div class="label">總會員數</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-success">
                <i class="fas fa-credit-card"></i>
              </div>
              <div class="number text-success">$${data.totalMembershipFees.toLocaleString()}</div>
              <div class="label">本年度會費</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-info">
                <i class="fas fa-hand-holding-heart"></i>
              </div>
              <div class="number text-info">$${data.totalDonations.toLocaleString()}</div>
              <div class="label">捐款總額</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-danger">
                <i class="fas fa-money-bill-wave"></i>
              </div>
              <div class="number text-danger">$${data.totalExpenses.toLocaleString()}</div>
              <div class="label">本月支出</div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-8">
            <div class="chart-container">
              <h5 class="mb-4"><i class="fas fa-chart-line me-2"></i>財務趨勢</h5>
              <canvas id="financeChart" height="100"></canvas>
            </div>
          </div>
          <div class="col-md-4">
            <div class="chart-container">
              <h5 class="mb-4"><i class="fas fa-tasks me-2"></i>待處理事項</h5>
              <div id="todoList">
                ${data.pending.fees > 0 ? `
                  <div class="todo-item" onclick="loadPage('membership-fee')">
                    <i class="fas fa-credit-card text-warning me-2"></i>
                    會費待確認
                    <span class="badge bg-warning">${data.pending.fees}</span>
                  </div>
                ` : ''}
                
                ${data.pending.expenses > 0 ? `
                  <div class="todo-item" onclick="loadPage('expense')">
                    <i class="fas fa-money-bill-wave text-danger me-2"></i>
                    支出待核准
                    <span class="badge bg-danger">${data.pending.expenses}</span>
                  </div>
                ` : ''}
                
                ${data.pending.approvals > 0 ? `
                  <div class="todo-item" onclick="loadPage('approval')">
                    <i class="fas fa-check-circle text-info me-2"></i>
                    流程待處理
                    <span class="badge bg-info">${data.pending.approvals}</span>
                  </div>
                ` : ''}
                
                ${(data.pending.fees + data.pending.expenses + data.pending.approvals) === 0 ? `
                  <div class="text-center text-muted py-4">
                    <i class="fas fa-check-circle fa-3x mb-3"></i>
                    <p>所有事項都已處理完成！</p>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
        </div>
      `;
      
    } catch (error) {
      console.error('載入儀表板失敗:', error);
      return `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          載入儀表板資料失敗：${error.message}
        </div>
      `;
    }
  }

  // ==================== 會員管理 ====================
  
  /**
   * 載入會員管理頁面
   */
  async function loadMembership() {
    try {
      const members = await apiCall('getMembers');
      
      if (!members.success) {
        throw new Error(members.message);
      }
      
      currentData.members = members.data;
      
      return `
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <button class="btn btn-primary" onclick="showAddMemberModal()">
              <i class="fas fa-user-plus me-2"></i>新增會員
            </button>
            <button class="btn btn-outline-success ms-2" onclick="importMembers()">
              <i class="fas fa-file-import me-2"></i>批量匯入
            </button>
          </div>
          <div>
            <button class="btn btn-outline-primary" onclick="exportMembers()">
              <i class="fas fa-download me-2"></i>匯出資料
            </button>
          </div>
        </div>

        <div class="table-container">
          <table class="table table-hover" id="membersTable">
            <thead>
              <tr>
                <th>會員編號</th>
                <th>姓名</th>
                <th>電話</th>
                <th>電子郵件</th>
                <th>入會日期</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              ${members.data.map(member => `
                <tr>
                  <td>${member['會員編號']}</td>
                  <td>${member['姓名']}</td>
                  <td>${member['手機'] || member['電話'] || '-'}</td>
                  <td>${member['電子郵件'] || '-'}</td>
                  <td>${formatDate(member['入會日期'])}</td>
                  <td>
                    <span class="status-badge ${member['會員狀態'] === '有效' ? 'status-active' : 'status-pending'}">
                      ${member['會員狀態']}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editMember('${member['會員編號']}')">
                      <i class="fas fa-edit"></i> 編輯
                    </button>
                    <button class="btn btn-sm btn-outline-info ms-1" onclick="viewMember('${member['會員編號']}')">
                      <i class="fas fa-eye"></i> 詳情
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
    } catch (error) {
      console.error('載入會員管理失敗:', error);
      return `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          載入會員資料失敗：${error.message}
        </div>
      `;
    }
  }

  // ==================== 會費管理 ====================
  
  /**
   * 載入會費管理頁面
   */
  async function loadMembershipFee() {
    try {
      const fees = await apiCall('getMembershipFees');
      
      if (!fees.success) {
        throw new Error(fees.message);
      }
      
      currentData.fees = fees.data;
      
      // 計算統計資料
      const confirmedFees = fees.data.filter(fee => fee['狀態'] === '已確認');
      const pendingFees = fees.data.filter(fee => fee['狀態'] === '待確認');
      const totalConfirmed = confirmedFees.reduce((sum, fee) => sum + parseFloat(fee['金額'] || 0), 0);
      const totalPending = pendingFees.reduce((sum, fee) => sum + parseFloat(fee['金額'] || 0), 0);
      
      return `
        ${pendingFees.length > 0 ? `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>注意：</strong>有 ${pendingFees.length} 筆會費記錄待確認，請及時處理。
          </div>
        ` : ''}

        <div class="row mb-4">
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-success">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="number text-success">$${totalConfirmed.toLocaleString()}</div>
              <div class="label">已收會費</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-warning">
                <i class="fas fa-clock"></i>
              </div>
              <div class="number text-warning">$${totalPending.toLocaleString()}</div>
              <div class="label">待收會費</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-info">
                <i class="fas fa-users"></i>
              </div>
              <div class="number text-info">${confirmedFees.length}</div>
              <div class="label">已繳人數</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-danger">
                <i class="fas fa-user-times"></i>
              </div>
              <div class="number text-danger">${pendingFees.length}</div>
              <div class="label">待確認</div>
            </div>
          </div>
        </div>

        <div class="table-container">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">會費記錄</h5>
            <button class="btn btn-primary" onclick="showAddFeeModal()">
              <i class="fas fa-plus me-2"></i>新增繳費記錄
            </button>
          </div>
          
          <table class="table table-hover" id="feesTable">
            <thead>
              <tr>
                <th>會員姓名</th>
                <th>繳費年度</th>
                <th>金額</th>
                <th>繳費日期</th>
                <th>繳費方式</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              ${fees.data.map(fee => `
                <tr class="${fee['狀態'] === '待確認' ? 'table-warning' : ''}">
                  <td>${fee['會員姓名']}</td>
                  <td>${fee['繳費年度']}</td>
                  <td>$${parseFloat(fee['金額'] || 0).toLocaleString()}</td>
                  <td>${formatDate(fee['繳費日期'])}</td>
                  <td>${fee['繳費方式']}</td>
                  <td>
                    <span class="status-badge ${fee['狀態'] === '已確認' ? 'status-approved' : 'status-pending'}">
                      ${fee['狀態']}
                    </span>
                  </td>
                  <td>
                    ${fee['狀態'] === '待確認' ? `
                      <button class="btn btn-sm btn-success" onclick="confirmFee('${fee['記錄編號']}')">
                        <i class="fas fa-check"></i> 確認
                      </button>
                      <button class="btn btn-sm btn-outline-danger ms-1" onclick="rejectFee('${fee['記錄編號']}')">
                        <i class="fas fa-times"></i> 拒絕
                      </button>
                    ` : `
                      <button class="btn btn-sm btn-outline-info" onclick="viewReceipt('${fee['收據編號']}')">
                        <i class="fas fa-receipt"></i> 收據
                      </button>
                    `}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
    } catch (error) {
      console.error('載入會費管理失敗:', error);
      return `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          載入會費資料失敗：${error.message}
        </div>
      `;
    }
  }

  // ==================== 捐款管理 ====================
  
  /**
   * 載入捐款管理頁面
   */
  async function loadDonation() {
    try {
      const donations = await apiCall('getDonations');
      
      if (!donations.success) {
        throw new Error(donations.message);
      }
      
      currentData.donations = donations.data;
      
      const totalAmount = donations.data.reduce((sum, donation) => sum + parseFloat(donation['捐款金額'] || 0), 0);
      
      return `
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="stat-card">
              <div class="icon text-success">
                <i class="fas fa-hand-holding-heart"></i>
              </div>
              <div class="number text-success">$${totalAmount.toLocaleString()}</div>
              <div class="label">捐款總額</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card">
              <div class="icon text-info">
                <i class="fas fa-users"></i>
              </div>
              <div class="number text-info">${donations.data.length}</div>
              <div class="label">捐款筆數</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card">
              <div class="icon text-primary">
                <i class="fas fa-calendar"></i>
              </div>
              <div class="number text-primary">${new Date().getFullYear()}</div>
              <div class="label">統計年度</div>
            </div>
          </div>
        </div>

        <div class="table-container">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">捐款記錄</h5>
            <button class="btn btn-primary" onclick="showAddDonationModal()">
              <i class="fas fa-plus me-2"></i>新增捐款記錄
            </button>
          </div>
          
          <table class="table table-hover" id="donationsTable">
            <thead>
              <tr>
                <th>捐款人</th>
                <th>捐款金額</th>
                <th>捐款日期</th>
                <th>捐款用途</th>
                <th>捐款方式</th>
                <th>收據編號</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              ${donations.data.map(donation => `
                <tr>
                  <td>${donation['捐款人姓名']}</td>
                  <td>$${parseFloat(donation['捐款金額'] || 0).toLocaleString()}</td>
                  <td>${formatDate(donation['捐款日期'])}</td>
                  <td>${donation['捐款用途']}</td>
                  <td>${donation['捐款方式']}</td>
                  <td>${donation['收據編號']}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editDonation('${donation['捐款編號']}')">
                      <i class="fas fa-edit"></i> 編輯
                    </button>
                    <button class="btn btn-sm btn-outline-info ms-1" onclick="viewReceipt('${donation['收據編號']}')">
                      <i class="fas fa-receipt"></i> 收據
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
    } catch (error) {
      console.error('載入捐款管理失敗:', error);
      return `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          載入捐款資料失敗：${error.message}
        </div>
      `;
    }
  }

  // ==================== 支出管理 ====================
  
  /**
   * 載入支出管理頁面
   */
  async function loadExpense() {
    try {
      const expenses = await apiCall('getExpenses');
      
      if (!expenses.success) {
        throw new Error(expenses.message);
      }
      
      currentData.expenses = expenses.data;
      
      const pendingExpenses = expenses.data.filter(expense => 
        expense['核准狀態'] === '待核准' || expense['核准狀態'] === '一級核准'
      );
      const approvedExpenses = expenses.data.filter(expense => expense['核准狀態'] === '已核准');
      const rejectedExpenses = expenses.data.filter(expense => expense['核准狀態'] === '已拒絕');
      
      const totalApproved = approvedExpenses.reduce((sum, expense) => sum + parseFloat(expense['金額'] || 0), 0);
      const totalPending = pendingExpenses.reduce((sum, expense) => sum + parseFloat(expense['金額'] || 0), 0);
      
      return `
        ${pendingExpenses.length > 0 ? `
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>提醒：</strong>有 ${pendingExpenses.length} 筆支出申請待處理。
          </div>
        ` : ''}

        <div class="row mb-4">
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-success">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="number text-success">$${totalApproved.toLocaleString()}</div>
              <div class="label">已核准金額</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-warning">
                <i class="fas fa-clock"></i>
              </div>
              <div class="number text-warning">$${totalPending.toLocaleString()}</div>
              <div class="label">待核准金額</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-info">
                <i class="fas fa-list"></i>
              </div>
              <div class="number text-info">${pendingExpenses.length}</div>
              <div class="label">待處理筆數</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-danger">
                <i class="fas fa-times-circle"></i>
              </div>
              <div class="number text-danger">${rejectedExpenses.length}</div>
              <div class="label">已拒絕筆數</div>
            </div>
          </div>
        </div>

        <div class="table-container">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">支出記錄</h5>
            <button class="btn btn-primary" onclick="showAddExpenseModal()">
              <i class="fas fa-plus me-2"></i>新增支出申請
            </button>
          </div>
          
          <table class="table table-hover" id="expensesTable">
            <thead>
              <tr>
                <th>申請人</th>
                <th>支出項目</th>
                <th>金額</th>
                <th>申請日期</th>
                <th>優先級</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              ${expenses.data.map(expense => `
                <tr class="${getExpenseRowClass(expense['核准狀態'])}">
                  <td>${expense['申請人']}</td>
                  <td>${expense['支出項目']}</td>
                  <td>$${parseFloat(expense['金額'] || 0).toLocaleString()}</td>
                  <td>${formatDate(expense['支出日期'])}</td>
                  <td>
                    <span class="badge ${getPriorityClass(expense['優先級'])}">
                      ${expense['優先級']}
                    </span>
                  </td>
                  <td>
                    <span class="status-badge ${getStatusClass(expense['核准狀態'])}">
                      ${expense['核准狀態']}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-info" onclick="viewExpense('${expense['支出編號']}')">
                      <i class="fas fa-eye"></i> 詳情
                    </button>
                    ${(expense['核准狀態'] === '待核准' || expense['核准狀態'] === '一級核准') ? `
                      <button class="btn btn-sm btn-success ms-1" onclick="approveExpense('${expense['支出編號']}')">
                        <i class="fas fa-check"></i> 核准
                      </button>
                      <button class="btn btn-sm btn-danger ms-1" onclick="rejectExpense('${expense['支出編號']}')">
                        <i class="fas fa-times"></i> 拒絕
                      </button>
                    ` : ''}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
    } catch (error) {
      console.error('載入支出管理失敗:', error);
      return `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          載入支出資料失敗：${error.message}
        </div>
      `;
    }
  }

  // ==================== 收據管理 ====================
  
  /**
   * 載入收據管理頁面
   */
  async function loadReceipt() {
    try {
      const receipts = await apiCall('getReceipts');
      
      if (!receipts.success) {
        throw new Error(receipts.message);
      }
      
      currentData.receipts = receipts.data;
      
      const validReceipts = receipts.data.filter(receipt => receipt['狀態'] === '有效');
      const voidReceipts = receipts.data.filter(receipt => receipt['狀態'] === '作廢');
      const totalAmount = validReceipts.reduce((sum, receipt) => sum + parseFloat(receipt['金額'] || 0), 0);
      
      return `
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-success">
                <i class="fas fa-receipt"></i>
              </div>
              <div class="number text-success">${validReceipts.length}</div>
              <div class="label">有效收據</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-danger">
                <i class="fas fa-ban"></i>
              </div>
              <div class="number text-danger">${voidReceipts.length}</div>
              <div class="label">作廢收據</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-info">
                <i class="fas fa-dollar-sign"></i>
              </div>
              <div class="number text-info">$${totalAmount.toLocaleString()}</div>
              <div class="label">收據總額</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="icon text-primary">
                <i class="fas fa-list"></i>
              </div>
              <div class="number text-primary">${receipts.data.length}</div>
              <div class="label">總收據數</div>
            </div>
          </div>
        </div>

        <div class="table-container">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">收據記錄</h5>
            <button class="btn btn-primary" onclick="showGenerateReceiptModal()">
              <i class="fas fa-plus me-2"></i>開立收據
            </button>
          </div>
          
          <table class="table table-hover" id="receiptsTable">
            <thead>
              <tr>
                <th>收據編號</th>
                <th>收據類型</th>
                <th>收款人</th>
                <th>金額</th>
                <th>開立日期</th>
                <th>用途</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              ${receipts.data.map(receipt => `
                <tr class="${receipt['狀態'] === '作廢' ? 'table-secondary' : ''}">
                  <td>${receipt['收據編號']}</td>
                  <td>
                    <span class="badge ${receipt['收據類型'] === '會費' ? 'bg-primary' : 'bg-success'}">
                      ${receipt['收據類型']}
                    </span>
                  </td>
                  <td>${receipt['收款人']}</td>
                  <td>$${parseFloat(receipt['金額'] || 0).toLocaleString()}</td>
                  <td>${formatDate(receipt['開立日期'])}</td>
                  <td>${receipt['用途']}</td>
                  <td>
                    <span class="status-badge ${receipt['狀態'] === '有效' ? 'status-active' : 'status-void'}">
                      ${receipt['狀態']}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-info" onclick="printReceipt('${receipt['收據編號']}')">
                      <i class="fas fa-print"></i> 列印
                    </button>
                    ${receipt['狀態'] === '有效' ? `
                      <button class="btn btn-sm btn-outline-danger ms-1" onclick="voidReceipt('${receipt['收據編號']}')">
                        <i class="fas fa-ban"></i> 作廢
                      </button>
                    ` : ''}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
    } catch (error) {
      console.error('載入收據管理失敗:', error);
      return `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          載入收據資料失敗：${error.message}
        </div>
      `;
    }
  }

  // ==================== 核准流程 ====================
  
  /**
   * 載入核准流程頁面
   */
  async function loadApproval() {
    try {
      const approvals = await apiCall('getApprovals');
      
      if (!approvals.success) {
        throw new Error(approvals.message);
      }
      
      currentData.approvals = approvals.data;
      
      const pendingApprovals = approvals.data.filter(approval => 
        approval['目前狀態'] === '待核准' || approval['目前狀態'] === '一級核准'
      );
      const completedApprovals = approvals.data.filter(approval => 
        approval['目前狀態'] === '已核准' || approval['目前狀態'] === '已拒絕'
      );
      
      return `
        ${pendingApprovals.length > 0 ? `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>注意：</strong>有 ${pendingApprovals.length} 個核准流程待處理。
          </div>
        ` : ''}

        <div class="row mb-4">
          <div class="col-md-4">
            <div class="stat-card">
              <div class="icon text-warning">
                <i class="fas fa-clock"></i>
              </div>
              <div class="number text-warning">${pendingApprovals.length}</div>
              <div class="label">待處理流程</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card">
              <div class="icon text-success">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="number text-success">${completedApprovals.length}</div>
              <div class="label">已完成流程</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card">
              <div class="icon text-info">
                <i class="fas fa-list"></i>
              </div>
              <div class="number text-info">${approvals.data.length}</div>
              <div class="label">總流程數</div>
            </div>
          </div>
        </div>

        <div class="table-container">
          <h5 class="mb-3">核准流程</h5>
          
          <table class="table table-hover" id="approvalsTable">
            <thead>
              <tr>
                <th>申請編號</th>
                <th>申請類型</th>
                <th>申請人</th>
                <th>申請金額</th>
                <th>申請日期</th>
                <th>優先級</th>
                <th>目前狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              ${approvals.data.map(approval => `
                <tr class="${getApprovalRowClass(approval['目前狀態'])}">
                  <td>${approval['申請編號']}</td>
                  <td>
                    <span class="badge ${approval['申請類型'] === '支出' ? 'bg-danger' : 'bg-primary'}">
                      ${approval['申請類型']}
                    </span>
                  </td>
                  <td>${approval['申請人']}</td>
                  <td>$${parseFloat(approval['申請金額'] || 0).toLocaleString()}</td>
                  <td>${formatDate(approval['申請日期'])}</td>
                  <td>
                    <span class="badge ${getPriorityClass(approval['優先級'])}">
                      ${approval['優先級']}
                    </span>
                  </td>
                  <td>
                    <span class="status-badge ${getApprovalStatusClass(approval['目前狀態'])}">
                      ${approval['目前狀態']}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-info" onclick="viewApproval('${approval['流程編號']}')">
                      <i class="fas fa-eye"></i> 詳情
                    </button>
                    ${(approval['目前狀態'] === '待核准' || approval['目前狀態'] === '一級核准') ? `
                      <button class="btn btn-sm btn-success ms-1" onclick="processApproval('${approval['流程編號']}', 'approve')">
                        <i class="fas fa-check"></i> 核准
                      </button>
                      <button class="btn btn-sm btn-danger ms-1" onclick="processApproval('${approval['流程編號']}', 'reject')">
                        <i class="fas fa-times"></i> 拒絕
                      </button>
                    ` : ''}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
    } catch (error) {
      console.error('載入核准流程失敗:', error);
      return `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          載入核准流程失敗：${error.message}
        </div>
      `;
    }
  }

  // ==================== 財務報表 ====================
  
  /**
   * 載入財務報表頁面
   */
  async function loadReport() {
    try {
      const currentYear = new Date().getFullYear();
      const startDate = `${currentYear}-01-01`;
      const endDate = `${currentYear}-12-31`;
      
      const report = await apiCall('getFinancialReport', { startDate, endDate });
      
      if (!report.success) {
        throw new Error(report.message);
      }
      
      const data = report.data;
      
      return `
        <div class="row mb-4">
          <div class="col-md-12">
            <div class="chart-container">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">財務報表 - ${currentYear}年度</h5>
                <div>
                  <button class="btn btn-outline-primary" onclick="exportReport()">
                    <i class="fas fa-download me-2"></i>匯出報表
                  </button>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-4">
                  <div class="stat-card">
                    <div class="icon text-success">
                      <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="number text-success">$${data.income.total.toLocaleString()}</div>
                    <div class="label">總收入</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="stat-card">
                    <div class="icon text-danger">
                      <i class="fas fa-arrow-down"></i>
                    </div>
                    <div class="number text-danger">$${data.expenses.total.toLocaleString()}</div>
                    <div class="label">總支出</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="stat-card">
                    <div class="icon ${data.balance >= 0 ? 'text-success' : 'text-danger'}">
                      <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="number ${data.balance >= 0 ? 'text-success' : 'text-danger'}">
                      $${data.balance.toLocaleString()}
                    </div>
                    <div class="label">餘額</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="chart-container">
              <h6 class="mb-3">收入明細</h6>
              <div class="mb-3">
                <div class="d-flex justify-content-between">
                  <span>會費收入：</span>
                  <strong>$${data.income.membershipFees.toLocaleString()}</strong>
                </div>
                <div class="progress mb-2">
                  <div class="progress-bar bg-primary" style="width: ${(data.income.membershipFees / data.income.total * 100).toFixed(1)}%"></div>
                </div>
              </div>
              <div class="mb-3">
                <div class="d-flex justify-content-between">
                  <span>捐款收入：</span>
                  <strong>$${data.income.donations.toLocaleString()}</strong>
                </div>
                <div class="progress mb-2">
                  <div class="progress-bar bg-success" style="width: ${(data.income.donations / data.income.total * 100).toFixed(1)}%"></div>
                </div>
              </div>
              <canvas id="incomeChart" height="200"></canvas>
            </div>
          </div>
          <div class="col-md-6">
            <div class="chart-container">
              <h6 class="mb-3">支出明細</h6>
              ${Object.entries(data.expenses.byCategory).map(([category, amount]) => `
                <div class="mb-3">
                  <div class="d-flex justify-content-between">
                    <span>${category}：</span>
                    <strong>$${amount.toLocaleString()}</strong>
                  </div>
                  <div class="progress mb-2">
                    <div class="progress-bar bg-warning" style="width: ${(amount / data.expenses.total * 100).toFixed(1)}%"></div>
                  </div>
                </div>
              `).join('')}
              <canvas id="expenseChart" height="200"></canvas>
            </div>
          </div>
        </div>

        <div class="row mt-4">
          <div class="col-md-12">
            <div class="chart-container">
              <h6 class="mb-3">統計摘要</h6>
              <div class="row">
                <div class="col-md-3">
                  <div class="text-center">
                    <div class="h4 text-primary">${data.summary.totalTransactions}</div>
                    <div class="text-muted">總交易筆數</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="text-center">
                    <div class="h4 text-success">${data.summary.membershipCount}</div>
                    <div class="text-muted">會費筆數</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="text-center">
                    <div class="h4 text-info">${data.summary.donationCount}</div>
                    <div class="text-muted">捐款筆數</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="text-center">
                    <div class="h4 text-danger">${data.summary.expenseCount}</div>
                    <div class="text-muted">支出筆數</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
    } catch (error) {
      console.error('載入財務報表失敗:', error);
      return `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          載入財務報表失敗：${error.message}
        </div>
      `;
    }
  }

  // ==================== 系統設定 ====================
  
  /**
   * 載入系統設定頁面
   */
  async function loadSettings() {
    try {
      const settings = await apiCall('getSettings');
      
      if (!settings.success) {
        throw new Error(settings.message);
      }
      
      currentData.settings = settings.data;
      
      return `
        <div class="row">
          <div class="col-md-8">
            <div class="table-container">
              <h5 class="mb-3">系統參數設定</h5>
              
              <form id="settingsForm">
                <div class="row mb-3">
                  <label class="col-sm-3 col-form-label">組織名稱</label>
                  <div class="col-sm-9">
                    <input type="text" class="form-control" name="組織名稱" value="${settings.data['組織名稱'] || ''}">
                  </div>
                </div>
                
                <div class="row mb-3">
                  <label class="col-sm-3 col-form-label">年度會費</label>
                  <div class="col-sm-9">
                    <input type="number" class="form-control" name="年度會費" value="${settings.data['年度會費'] || ''}">
                  </div>
                </div>
                
                <div class="row mb-3">
                  <label class="col-sm-3 col-form-label">收據前綴</label>
                  <div class="col-sm-9">
                    <input type="text" class="form-control" name="收據前綴" value="${settings.data['收據前綴'] || ''}">
                  </div>
                </div>
                
                <div class="row mb-3">
                  <label class="col-sm-3 col-form-label">二級核准門檻</label>
                  <div class="col-sm-9">
                    <input type="number" class="form-control" name="二級核准門檻" value="${settings.data['二級核准門檻'] || ''}">
                    <div class="form-text">超過此金額的支出需要二級核准</div>
                  </div>
                </div>
                
                <div class="row mb-3">
                  <label class="col-sm-3 col-form-label">提醒天數</label>
                  <div class="col-sm-9">
                    <input type="number" class="form-control" name="提醒天數" value="${settings.data['提醒天數'] || ''}">
                    <div class="form-text">核准逾期提醒天數</div>
                  </div>
                </div>
                
                <div class="row mb-3">
                  <label class="col-sm-3 col-form-label">組織地址</label>
                  <div class="col-sm-9">
                    <textarea class="form-control" name="組織地址" rows="2">${settings.data['組織地址'] || ''}</textarea>
                  </div>
                </div>
                
                <div class="row mb-3">
                  <label class="col-sm-3 col-form-label">聯絡電話</label>
                  <div class="col-sm-9">
                    <input type="tel" class="form-control" name="聯絡電話" value="${settings.data['聯絡電話'] || ''}">
                  </div>
                </div>
                
                <div class="row mb-3">
                  <label class="col-sm-3 col-form-label">電子郵件</label>
                  <div class="col-sm-9">
                    <input type="email" class="form-control" name="電子郵件" value="${settings.data['電子郵件'] || ''}">
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-sm-9 offset-sm-3">
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">
                      <i class="fas fa-save me-2"></i>儲存設定
                    </button>
                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetSettings()">
                      <i class="fas fa-undo me-2"></i>重設
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="table-container">
              <h5 class="mb-3">系統資訊</h5>
              <div class="mb-3">
                <strong>系統版本：</strong>1.0.0
              </div>
              <div class="mb-3">
                <strong>最後更新：</strong>2024-11-04
              </div>
              <div class="mb-3">
                <strong>資料庫狀態：</strong>
                <span class="badge bg-success">正常</span>
              </div>
              
              <hr>
              
              <h6>系統維護</h6>
              <div class="d-grid gap-2">
                <button class="btn btn-outline-primary" onclick="backupData()">
                  <i class="fas fa-download me-2"></i>備份資料
                </button>
                <button class="btn btn-outline-warning" onclick="systemHealthCheck()">
                  <i class="fas fa-stethoscope me-2"></i>系統檢查
                </button>
                <button class="btn btn-outline-info" onclick="viewSystemLog()">
                  <i class="fas fa-list me-2"></i>系統日誌
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
    } catch (error) {
      console.error('載入系統設定失敗:', error);
      return `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          載入系統設定失敗：${error.message}
        </div>
      `;
    }
  }

  // ==================== API 調用函數 ====================
  
  /**
   * API 調用函數
   */
  async function apiCall(action, data = {}) {
    try {
      showLoadingSpinner();
      
      const requestData = {
        action: action,
        ...data
      };
      
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      
      hideLoadingSpinner();
      
      return result;
      
    } catch (error) {
      hideLoadingSpinner();
      console.error('API 調用失敗:', error);
      throw new Error(`API 調用失敗: ${error.message}`);
    }
  }

  // ==================== 輔助函數 ====================
  
  /**
   * 格式化日期
   */
  function formatDate(dateString) {
    if (!dateString) return '-';
    
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-TW');
    } catch (error) {
      return dateString;
    }
  }

  /**
   * 取得支出行樣式
   */
  function getExpenseRowClass(status) {
    switch (status) {
      case '待核准': return 'table-warning';
      case '一級核准': return 'table-info';
      case '已核准': return 'table-success';
      case '已拒絕': return 'table-danger';
      default: return '';
    }
  }

  /**
   * 取得優先級樣式
   */
  function getPriorityClass(priority) {
    switch (priority) {
      case '高': return 'bg-danger';
      case '中': return 'bg-warning';
      case '低': return 'bg-secondary';
      default: return 'bg-secondary';
    }
  }

  /**
   * 取得狀態樣式
   */
  function getStatusClass(status) {
    switch (status) {
      case '已核准': return 'status-approved';
      case '待核准': return 'status-pending';
      case '一級核准': return 'status-pending';
      case '已拒絕': return 'status-rejected';
      default: return 'status-pending';
    }
  }

  /**
   * 取得核准流程行樣式
   */
  function getApprovalRowClass(status) {
    switch (status) {
      case '待核准': return 'table-warning';
      case '一級核准': return 'table-info';
      case '已核准': return 'table-success';
      case '已拒絕': return 'table-danger';
      default: return '';
    }
  }

  /**
   * 取得核准狀態樣式
   */
  function getApprovalStatusClass(status) {
    switch (status) {
      case '已核准': return 'status-approved';
      case '待核准': return 'status-pending';
      case '一級核准': return 'status-pending';
      case '已拒絕': return 'status-rejected';
      default: return 'status-pending';
    }
  }

  /**
   * 顯示載入動畫
   */
  function showLoadingSpinner() {
    // 可以在這裡添加全域載入動畫
  }

  /**
   * 隱藏載入動畫
   */
  function hideLoadingSpinner() {
    // 隱藏全域載入動畫
  }

  /**
   * 顯示提示訊息
   */
  function showAlert(message, type = 'info', duration = 5000) {
    const alertHtml = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
    
    const alertContainer = document.createElement('div');
    alertContainer.innerHTML = alertHtml;
    alertContainer.style.position = 'fixed';
    alertContainer.style.top = '20px';
    alertContainer.style.right = '20px';
    alertContainer.style.zIndex = '9999';
    alertContainer.style.minWidth = '300px';
    
    document.body.appendChild(alertContainer);
    
    // 自動移除
    setTimeout(() => {
      if (alertContainer.parentNode) {
        alertContainer.parentNode.removeChild(alertContainer);
      }
    }, duration);
  }

  /**
   * 更新當前時間
   */
  function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleString('zh-TW', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
    document.getElementById('currentTime').textContent = timeString;
  }

  /**
   * 切換側邊欄
   */
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    
    sidebar.classList.toggle('collapsed');
    mainContent.classList.toggle('expanded');
  }

  /**
   * 響應式處理
   */
  function handleResponsive() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    
    if (window.innerWidth <= 768) {
      sidebar.classList.remove('show');
      mainContent.classList.remove('expanded');
    }
  }

  /**
   * 載入通知
   */
  async function loadNotifications() {
    try {
      // 載入各種待處理事項的數量
      const stats = await apiCall('getDashboardStats');
      
      if (stats.success) {
        const data = stats.data;
        
        // 更新通知徽章
        document.getElementById('feeNotification').textContent = data.pending.fees || 0;
        document.getElementById('expenseNotification').textContent = data.pending.expenses || 0;
        document.getElementById('approvalNotification').textContent = data.pending.approvals || 0;
        
        const totalNotifications = (data.pending.fees || 0) + (data.pending.expenses || 0) + (data.pending.approvals || 0);
        document.getElementById('totalNotifications').textContent = totalNotifications;
        
        // 更新通知下拉選單
        updateNotificationDropdown(data.pending);
      }
      
    } catch (error) {
      console.error('載入通知失敗:', error);
    }
  }

  /**
   * 更新通知下拉選單
   */
  function updateNotificationDropdown(pending) {
    const dropdown = document.getElementById('notificationDropdown');
    let html = '<li><h6 class="dropdown-header">通知中心</h6></li><li><hr class="dropdown-divider"></li>';
    
    if (pending.fees > 0) {
      html += `
        <li>
          <a class="dropdown-item" href="#" onclick="loadPage('membership-fee')">
            <i class="fas fa-credit-card text-warning me-2"></i>
            ${pending.fees}筆會費待確認
          </a>
        </li>
      `;
    }
    
    if (pending.expenses > 0) {
      html += `
        <li>
          <a class="dropdown-item" href="#" onclick="loadPage('expense')">
            <i class="fas fa-money-bill-wave text-danger me-2"></i>
            ${pending.expenses}筆支出待核准
          </a>
        </li>
      `;
    }
    
    if (pending.approvals > 0) {
      html += `
        <li>
          <a class="dropdown-item" href="#" onclick="loadPage('approval')">
            <i class="fas fa-check-circle text-info me-2"></i>
            ${pending.approvals}筆流程待處理
          </a>
        </li>
      `;
    }
    
    if ((pending.fees + pending.expenses + pending.approvals) === 0) {
      html += '<li><a class="dropdown-item text-center text-muted" href="#">暫無通知</a></li>';
    } else {
      html += '<li><hr class="dropdown-divider"></li><li><a class="dropdown-item text-center" href="#">查看所有通知</a></li>';
    }
    
    dropdown.innerHTML = html;
  }

  /**
   * 初始化頁面特定功能
   */
  function initializePageFeatures(pageName) {
    // 初始化 DataTables
    if (document.getElementById('membersTable')) {
      $('#membersTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/zh_Hant.json'
        },
        responsive: true,
        pageLength: 25
      });
    }
    
    if (document.getElementById('feesTable')) {
      $('#feesTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/zh_Hant.json'
        },
        responsive: true,
        pageLength: 25
      });
    }
    
    // 其他表格類似處理...
    
    // 初始化圖表
    if (pageName === 'dashboard') {
      initializeDashboardCharts();
    } else if (pageName === 'report') {
      initializeReportCharts();
    }
  }

  /**
   * 初始化儀表板圖表
   */
  function initializeDashboardCharts() {
    const ctx = document.getElementById('financeChart');
    if (ctx) {
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
          datasets: [{
            label: '收入',
            data: [12000, 15000, 13000, 18000, 16000, 14000, 17000, 19000, 15000, 16000, 18000, 20000],
            borderColor: 'rgb(52, 152, 219)',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            tension: 0.4
          }, {
            label: '支出',
            data: [8000, 9000, 7000, 12000, 10000, 8000, 11000, 13000, 9000, 10000, 12000, 14000],
            borderColor: 'rgb(231, 76, 60)',
            backgroundColor: 'rgba(231, 76, 60, 0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }
  }

  /**
   * 初始化報表圖表
   */
  function initializeReportCharts() {
    // 收入圓餅圖
    const incomeCtx = document.getElementById('incomeChart');
    if (incomeCtx) {
      new Chart(incomeCtx, {
        type: 'doughnut',
        data: {
          labels: ['會費收入', '捐款收入'],
          datasets: [{
            data: [145000, 89500],
            backgroundColor: [
              'rgba(52, 152, 219, 0.8)',
              'rgba(46, 204, 113, 0.8)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
    
    // 支出圓餅圖
    const expenseCtx = document.getElementById('expenseChart');
    if (expenseCtx) {
      new Chart(expenseCtx, {
        type: 'doughnut',
        data: {
          labels: ['辦公用品', '活動費用', '交通費', '餐費', '設備採購'],
          datasets: [{
            data: [15000, 25000, 8000, 12000, 18000],
            backgroundColor: [
              'rgba(255, 193, 7, 0.8)',
              'rgba(220, 53, 69, 0.8)',
              'rgba(13, 202, 240, 0.8)',
              'rgba(25, 135, 84, 0.8)',
              'rgba(108, 117, 125, 0.8)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
  }

  // ==================== 模態框函數 ====================
  
  /**
   * 顯示通用模態框
   */
  function showModal(title, content, footerButtons = null) {
    document.getElementById('universalModalTitle').textContent = title;
    document.getElementById('universalModalBody').innerHTML = content;
    
    if (footerButtons) {
      document.getElementById('universalModalFooter').innerHTML = footerButtons;
    } else {
      document.getElementById('universalModalFooter').innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
      `;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('universalModal'));
    modal.show();
  }

  // ==================== 業務邏輯函數 ====================
  
  /**
   * 新增會員
   */
  function showAddMemberModal() {
    const content = `
      <form id="addMemberForm">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">姓名 *</label>
              <input type="text" class="form-control" name="name" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">性別</label>
              <select class="form-select" name="gender">
                <option value="">請選擇</option>
                <option value="男">男</option>
                <option value="女">女</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">出生日期</label>
              <input type="date" class="form-control" name="birthDate">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">身分證字號</label>
              <input type="text" class="form-control" name="idNumber">
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">電話</label>
              <input type="tel" class="form-control" name="phone">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">手機 *</label>
              <input type="tel" class="form-control" name="mobile" required>
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">電子郵件</label>
          <input type="email" class="form-control" name="email">
        </div>
        
        <div class="mb-3">
          <label class="form-label">地址</label>
          <textarea class="form-control" name="address" rows="2"></textarea>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">緊急聯絡人</label>
              <input type="text" class="form-control" name="emergencyContact">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">緊急聯絡電話</label>
              <input type="tel" class="form-control" name="emergencyPhone">
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">備註</label>
          <textarea class="form-control" name="note" rows="2"></textarea>
        </div>
      </form>
    `;
    
    const footerButtons = `
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
      <button type="button" class="btn btn-primary" onclick="submitAddMember()">新增會員</button>
    `;
    
    showModal('新增會員', content, footerButtons);
  }

  /**
   * 提交新增會員
   */
  async function submitAddMember() {
    try {
      const form = document.getElementById('addMemberForm');
      const formData = new FormData(form);
      const memberData = Object.fromEntries(formData.entries());
      
      const result = await apiCall('addMember', { memberData });
      
      if (result.success) {
        showAlert('會員新增成功', 'success');
        bootstrap.Modal.getInstance(document.getElementById('universalModal')).hide();
        loadPage('membership'); // 重新載入會員頁面
      } else {
        showAlert('新增會員失敗：' + result.message, 'danger');
      }
      
    } catch (error) {
      console.error('新增會員失敗:', error);
      showAlert('新增會員失敗：' + error.message, 'danger');
    }
  }

  /**
   * 新增會費記錄
   */
  function showAddFeeModal() {
    const content = `
      <form id="addFeeForm">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">會員 *</label>
              <select class="form-select" name="memberId" required>
                <option value="">請選擇會員</option>
                ${currentData.members ? currentData.members.map(member => `
                  <option value="${member['會員編號']}">${member['姓名']} (${member['會員編號']})</option>
                `).join('') : ''}
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">繳費年度 *</label>
              <select class="form-select" name="year" required>
                <option value="">請選擇年度</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">金額 *</label>
              <input type="number" class="form-control" name="amount" value="1000" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">繳費方式 *</label>
              <select class="form-select" name="paymentMethod" required>
                <option value="">請選擇</option>
                <option value="現金">現金</option>
                <option value="轉帳">轉帳</option>
                <option value="支票">支票</option>
                <option value="信用卡">信用卡</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">繳費日期 *</label>
          <input type="date" class="form-control" name="paymentDate" value="${new Date().toISOString().split('T')[0]}" required>
        </div>
        
        <div class="mb-3">
          <label class="form-label">備註</label>
          <textarea class="form-control" name="note" rows="2"></textarea>
        </div>
      </form>
    `;
    
    const footerButtons = `
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
      <button type="button" class="btn btn-primary" onclick="submitAddFee()">新增記錄</button>
    `;
    
    showModal('新增會費記錄', content, footerButtons);
  }

  /**
   * 提交新增會費記錄
   */
  async function submitAddFee() {
    try {
      const form = document.getElementById('addFeeForm');
      const formData = new FormData(form);
      const feeData = Object.fromEntries(formData.entries());
      
      // 取得會員姓名
      const member = currentData.members.find(m => m['會員編號'] === feeData.memberId);
      feeData.memberName = member ? member['姓名'] : '';
      
      const result = await apiCall('addMembershipFee', { feeData });
      
      if (result.success) {
        showAlert('會費記錄新增成功', 'success');
        bootstrap.Modal.getInstance(document.getElementById('universalModal')).hide();
        loadPage('membership-fee');
      } else {
        showAlert('新增會費記錄失敗：' + result.message, 'danger');
      }
      
    } catch (error) {
      console.error('新增會費記錄失敗:', error);
      showAlert('新增會費記錄失敗：' + error.message, 'danger');
    }
  }

  /**
   * 確認會費
   */
  async function confirmFee(recordId) {
    if (confirm('確定要確認這筆會費記錄嗎？')) {
      try {
        const result = await apiCall('updateMembershipFeeStatus', {
          recordId: recordId,
          status: '已確認',
          note: '管理員確認'
        });
        
        if (result.success) {
          showAlert('會費確認成功', 'success');
          loadPage('membership-fee');
        } else {
          showAlert('會費確認失敗：' + result.message, 'danger');
        }
        
      } catch (error) {
        console.error('會費確認失敗:', error);
        showAlert('會費確認失敗：' + error.message, 'danger');
      }
    }
  }

  /**
   * 新增捐款記錄
   */
  function showAddDonationModal() {
    const content = `
      <form id="addDonationForm">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">捐款人姓名 *</label>
              <input type="text" class="form-control" name="donorName" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">會員編號</label>
              <select class="form-select" name="memberId">
                <option value="">非會員或選擇會員</option>
                ${currentData.members ? currentData.members.map(member => `
                  <option value="${member['會員編號']}">${member['姓名']} (${member['會員編號']})</option>
                `).join('') : ''}
              </select>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">捐款金額 *</label>
              <input type="number" class="form-control" name="amount" required min="1">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">捐款方式 *</label>
              <select class="form-select" name="method" required>
                <option value="">請選擇</option>
                <option value="現金">現金</option>
                <option value="轉帳">轉帳</option>
                <option value="支票">支票</option>
                <option value="信用卡">信用卡</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">捐款用途 *</label>
              <select class="form-select" name="purpose" required>
                <option value="">請選擇</option>
                <option value="一般捐款">一般捐款</option>
                <option value="醫療補助">醫療補助</option>
                <option value="設備捐贈">設備捐贈</option>
                <option value="活動贊助">活動贊助</option>
                <option value="其他">其他</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">捐款日期 *</label>
              <input type="date" class="form-control" name="donationDate" value="${new Date().toISOString().split('T')[0]}" required>
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">統一編號</label>
          <input type="text" class="form-control" name="taxNumber" placeholder="如需開立統編收據請填寫">
        </div>
        
        <div class="mb-3">
          <label class="form-label">備註</label>
          <textarea class="form-control" name="note" rows="2"></textarea>
        </div>
      </form>
    `;
    
    const footerButtons = `
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
      <button type="button" class="btn btn-primary" onclick="submitAddDonation()">新增捐款</button>
    `;
    
    showModal('新增捐款記錄', content, footerButtons);
  }

  /**
   * 提交新增捐款記錄
   */
  async function submitAddDonation() {
    try {
      const form = document.getElementById('addDonationForm');
      const formData = new FormData(form);
      const donationData = Object.fromEntries(formData.entries());
      
      const result = await apiCall('addDonation', { donationData });
      
      if (result.success) {
        showAlert('捐款記錄新增成功', 'success');
        bootstrap.Modal.getInstance(document.getElementById('universalModal')).hide();
        loadPage('donation');
      } else {
        showAlert('新增捐款記錄失敗：' + result.message, 'danger');
      }
      
    } catch (error) {
      console.error('新增捐款記錄失敗:', error);
      showAlert('新增捐款記錄失敗：' + error.message, 'danger');
    }
  }

  /**
   * 新增支出申請
   */
  function showAddExpenseModal() {
    const content = `
      <form id="addExpenseForm">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">申請人 *</label>
              <input type="text" class="form-control" name="applicant" value="管理員" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">支出日期 *</label>
              <input type="date" class="form-control" name="expenseDate" value="${new Date().toISOString().split('T')[0]}" required>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">支出類別 *</label>
              <select class="form-select" name="category" required>
                <option value="">請選擇</option>
                <option value="辦公用品">辦公用品</option>
                <option value="活動費用">活動費用</option>
                <option value="交通費">交通費</option>
                <option value="餐費">餐費</option>
                <option value="設備採購">設備採購</option>
                <option value="其他">其他</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">優先級 *</label>
              <select class="form-select" name="priority" required>
                <option value="中">中</option>
                <option value="高">高</option>
                <option value="低">低</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">支出項目 *</label>
          <input type="text" class="form-control" name="item" required placeholder="詳細說明支出項目">
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">金額 *</label>
              <input type="number" class="form-control" name="amount" required min="1">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">收款人 *</label>
              <input type="text" class="form-control" name="payee" required>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">付款方式 *</label>
              <select class="form-select" name="paymentMethod" required>
                <option value="">請選擇</option>
                <option value="現金">現金</option>
                <option value="轉帳">轉帳</option>
                <option value="支票">支票</option>
                <option value="信用卡">信用卡</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">憑證編號</label>
              <input type="text" class="form-control" name="voucherNumber" placeholder="發票或收據編號">
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">申請事由 *</label>
          <textarea class="form-control" name="reason" rows="3" required placeholder="詳細說明申請原因"></textarea>
        </div>
        
        <div class="mb-3">
          <label class="form-label">備註</label>
          <textarea class="form-control" name="note" rows="2"></textarea>
        </div>
      </form>
    `;
    
    const footerButtons = `
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
      <button type="button" class="btn btn-primary" onclick="submitAddExpense()">提交申請</button>
    `;
    
    showModal('新增支出申請', content, footerButtons);
  }

  /**
   * 提交新增支出申請
   */
  async function submitAddExpense() {
    try {
      const form = document.getElementById('addExpenseForm');
      const formData = new FormData(form);
      const expenseData = Object.fromEntries(formData.entries());
      
      const result = await apiCall('addExpense', { expenseData });
      
      if (result.success) {
        showAlert('支出申請提交成功', 'success');
        bootstrap.Modal.getInstance(document.getElementById('universalModal')).hide();
        loadPage('expense');
      } else {
        showAlert('提交支出申請失敗：' + result.message, 'danger');
      }
      
    } catch (error) {
      console.error('提交支出申請失敗:', error);
      showAlert('提交支出申請失敗：' + error.message, 'danger');
    }
  }

  /**
   * 核准支出
   */
  async function approveExpense(expenseId) {
    const note = prompt('請輸入核准備註（可選）：');
    if (note !== null) {
      try {
        const result = await apiCall('updateExpenseStatus', {
          expenseId: expenseId,
          status: '已核准',
          approver: '管理員',
          note: note
        });
        
        if (result.success) {
          showAlert('支出核准成功', 'success');
          loadPage('expense');
        } else {
          showAlert('支出核准失敗：' + result.message, 'danger');
        }
        
      } catch (error) {
        console.error('支出核准失敗:', error);
        showAlert('支出核准失敗：' + error.message, 'danger');
      }
    }
  }

  /**
   * 拒絕支出
   */
  async function rejectExpense(expenseId) {
    const reason = prompt('請輸入拒絕原因：');
    if (reason && reason.trim()) {
      try {
        const result = await apiCall('updateExpenseStatus', {
          expenseId: expenseId,
          status: '已拒絕',
          approver: '管理員',
          note: reason
        });
        
        if (result.success) {
          showAlert('支出已拒絕', 'success');
          loadPage('expense');
        } else {
          showAlert('拒絕支出失敗：' + result.message, 'danger');
        }
        
      } catch (error) {
        console.error('拒絕支出失敗:', error);
        showAlert('拒絕支出失敗：' + error.message, 'danger');
      }
    }
  }

  /**
   * 處理核准流程
   */
  async function processApproval(processId, action) {
    const message = action === 'approve' ? '核准' : '拒絕';
    const note = prompt(`請輸入${message}備註：`);
    
    if (note !== null) {
      try {
        const result = await apiCall('processApproval', {
          processId: processId,
          action: action,
          approver: '管理員',
          note: note
        });
        
        if (result.success) {
          showAlert(`${message}處理成功`, 'success');
          loadPage('approval');
        } else {
          showAlert(`${message}處理失敗：` + result.message, 'danger');
        }
        
      } catch (error) {
        console.error(`${message}處理失敗:`, error);
        showAlert(`${message}處理失敗：` + error.message, 'danger');
      }
    }
  }

  /**
   * 作廢收據
   */
  async function voidReceipt(receiptId) {
    const reason = prompt('請輸入作廢原因：');
    if (reason && reason.trim()) {
      try {
        const result = await apiCall('voidReceipt', {
          receiptId: receiptId,
          reason: reason
        });
        
        if (result.success) {
          showAlert('收據作廢成功', 'success');
          loadPage('receipt');
        } else {
          showAlert('收據作廢失敗：' + result.message, 'danger');
        }
        
      } catch (error) {
        console.error('收據作廢失敗:', error);
        showAlert('收據作廢失敗：' + error.message, 'danger');
      }
    }
  }

  /**
   * 列印收據
   */
  function printReceipt(receiptId) {
    // 這裡可以實作收據列印功能
    showAlert('收據列印功能開發中', 'info');
  }

  /**
   * 儲存系統設定
   */
  async function saveSettings() {
    try {
      const form = document.getElementById('settingsForm');
      const formData = new FormData(form);
      
      const promises = [];
      for (const [key, value] of formData.entries()) {
        promises.push(apiCall('updateSetting', {
          settingName: key,
          settingValue: value
        }));
      }
      
      const results = await Promise.all(promises);
      const failedUpdates = results.filter(result => !result.success);
      
      if (failedUpdates.length === 0) {
        showAlert('系統設定儲存成功', 'success');
      } else {
        showAlert(`部分設定儲存失敗，請檢查後重試`, 'warning');
      }
      
    } catch (error) {
      console.error('儲存系統設定失敗:', error);
      showAlert('儲存系統設定失敗：' + error.message, 'danger');
    }
  }

  /**
   * 系統備份
   */
  async function backupData() {
    try {
      showAlert('正在備份資料，請稍候...', 'info');
      
      const result = await apiCall('backupData');
      
      if (result.success) {
        showAlert('資料備份成功', 'success');
      } else {
        showAlert('資料備份失敗：' + result.message, 'danger');
      }
      
    } catch (error) {
      console.error('資料備份失敗:', error);
      showAlert('資料備份失敗：' + error.message, 'danger');
    }
  }

  /**
   * 系統健康檢查
   */
  async function systemHealthCheck() {
    try {
      showAlert('正在進行系統檢查，請稍候...', 'info');
      
      const result = await apiCall('systemHealthCheck');
      
      if (result.success) {
        showAlert('系統檢查完成，狀態正常', 'success');
      } else {
        showAlert('系統檢查發現問題，請聯繫技術支援', 'warning');
      }
      
    } catch (error) {
      console.error('系統健康檢查失敗:', error);
      showAlert('系統健康檢查失敗：' + error.message, 'danger');
    }
  }

  /**
   * 快速新增會員
   */
  function quickAddMember() {
    loadPage('membership');
    setTimeout(() => {
      showAddMemberModal();
    }, 500);
  }

  /**
   * 快速新增支出
   */
  function quickAddExpense() {
    loadPage('expense');
    setTimeout(() => {
      showAddExpenseModal();
    }, 500);
  }

  /**
   * 登出系統
   */
  function logout() {
    if (confirm('確定要登出系統嗎？')) {
      // 清除本地資料
      localStorage.clear();
      sessionStorage.clear();
      
      // 重新導向到登入頁面或顯示登入表單
      showAlert('已成功登出系統', 'success');
      
      // 這裡可以重新導向到登入頁面
      // window.location.href = 'login.html';
    }
  }

  /**
   * 取得預設內容
   */
  function getDefaultContent(title) {
    return `
      <div class="text-center py-5">
        <i class="fas fa-construction fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">${title}功能開發中</h4>
        <p class="text-muted">此功能正在開發中，敬請期待。</p>
      </div>
    `;
  }

  // ==================== 系統啟動 ====================
  
  // 當頁面載入完成時自動執行系統初始化
  console.log('帕促會病友權益促進會管理系統 v1.0.0');
  console.log('系統正在初始化...');
  
</script>
</body>
</html>
