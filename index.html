<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友協會 - 會員系統</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      padding-bottom: 70px;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .header p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 15px;
    }
    
    .nav-tabs {
      display: flex;
      background: white;
      border-radius: 10px;
      padding: 5px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .nav-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
      color: #666;
    }
    
    .nav-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .card-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 2px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .info-row:last-child {
      border-bottom: none;
    }
    
    .info-label {
      color: #666;
      font-size: 14px;
    }
    
    .info-value {
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }
    
    .member-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 15px;
    }
    
    .member-id {
      font-size: 16px;
      margin-bottom: 15px;
      opacity: 0.9;
    }
    
    .qr-code {
      background: white;
      padding: 15px;
      border-radius: 10px;
      display: inline-block;
      margin-top: 10px;
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:active {
      transform: scale(0.98);
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #666;
    }
    
    .btn-danger {
      background: #ff4757;
      color: white;
    }
    
    .activity-item {
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .activity-item:hover {
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    .activity-title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    
    .activity-info {
      font-size: 13px;
      color: #666;
      margin: 5px 0;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .stat-box {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      margin-bottom: 15px;
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      animation: fadeIn 0.3s;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 25px;
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;
      animation: slideUp 0.3s;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }
    
    .modal-close {
      float: right;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 14px;
      z-index: 2000;
      animation: slideUp 0.3s;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🌟 帕金森病友協會</h1>
    <p id="memberName">載入中...</p>
  </div>

  <div class="container">
    <div class="nav-tabs">
      <div class="nav-tab active" onclick="switchTab('dashboard')">首頁</div>
      <div class="nav-tab" onclick="switchTab('profile')">個人</div>
      <div class="nav-tab" onclick="switchTab('activities')">活動</div>
      <div class="nav-tab" onclick="switchTab('volunteer')">志工</div>
    </div>

    <!-- 首頁 -->
    <div id="dashboard" class="tab-content active">
      <div class="member-card">
        <div class="member-id">會員編號：<span id="memberIdDisplay">-</span></div>
        <div class="qr-code">
          <div id="qrcode"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">快速功能</div>
        <button class="btn btn-primary" onclick="switchTab('activities')">📅 瀏覽活動</button>
        <button class="btn btn-primary" onclick="switchTab('volunteer')">🤝 登記志工服務</button>
        <button class="btn btn-secondary" onclick="viewDonations()">💰 查看捐款記錄</button>
      </div>

      <div class="card">
        <div class="card-title">最新活動</div>
        <div id="recentActivities"></div>
      </div>
    </div>

    <!-- 個人資料 -->
    <div id="profile" class="tab-content">
      <div class="card">
        <div class="card-title">個人資料</div>
        <div id="profileInfo"></div>
        <button class="btn btn-primary" onclick="editProfile()">編輯資料</button>
      </div>

      <div class="card">
        <div class="card-title">我的統計</div>
        <div class="info-row">
          <span class="info-label">參加活動次數</span>
          <span class="info-value" id="activityCount">0</span>
        </div>
        <div class="info-row">
          <span class="info-label">志工服務時數</span>
          <span class="info-value" id="volunteerHours">0</span>
        </div>
        <div class="info-row">
          <span class="info-label">累計捐款金額</span>
          <span class="info-value" id="donationAmount">NT$ 0</span>
        </div>
      </div>
    </div>

    <!-- 活動報名 -->
    <div id="activities" class="tab-content">
      <div class="card">
        <div class="card-title">進行中的活動</div>
        <div id="activitiesList"></div>
      </div>

      <div class="card">
        <div class="card-title">我的報名</div>
        <div id="myRegistrations"></div>
      </div>
    </div>

    <!-- 志工服務 -->
    <div id="volunteer" class="tab-content">
      <div class="stat-box">
        <div class="stat-value" id="totalHours">0</div>
        <div class="stat-label">累計服務時數</div>
      </div>

      <div class="card">
        <div class="card-title">登記服務時數</div>
        <div class="form-group">
          <label class="form-label">服務日期</label>
          <input type="date" id="serviceDate" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">服務時數</label>
          <input type="number" id="serviceHours" class="form-input" placeholder="請輸入時數" step="0.5" min="0.5">
        </div>
        <div class="form-group">
          <label class="form-label">服務說明</label>
          <textarea id="serviceDescription" class="form-input" rows="3" placeholder="請描述服務內容"></textarea>
        </div>
        <button class="btn btn-primary" onclick="submitVolunteer()">提交記錄</button>
      </div>

      <div class="card">
        <div class="card-title">服務記錄</div>
        <div id="volunteerRecords"></div>
      </div>
    </div>
  </div>

  <!-- 活動詳情 Modal -->
  <div id="activityModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal('activityModal')">&times;</span>
      <div id="activityDetail"></div>
    </div>
  </div>

  <!-- 編輯資料 Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal('editModal')">&times;</span>
      <div class="modal-title">編輯個人資料</div>
      <div class="form-group">
        <label class="form-label">姓名</label>
        <input type="text" id="editName" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">電話</label>
        <input type="tel" id="editPhone" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="editEmail" class="form-input">
      </div>
      <button class="btn btn-primary" onclick="saveProfile()">儲存</button>
    </div>
  </div>

  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxabz6vmzwklRir1aTOO3jCVe9LmLARa2hioKJpekaTFr0ppjxmVW3-5CJWyIFeBgckXw/exec'; // 請替換為您的 GAS Web App URL
    let liffId = '1656516134-X9oq92g9'; // 請替換為您的 LIFF ID
    let userId = '';
    let memberData = null;

    // 初始化 LIFF
    async function initializeLiff() {
      try {
        await liff.init({ liffId: liffId });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        
        const profile = await liff.getProfile();
        userId = profile.userId;
        
        await loadMemberData();
        await loadDashboard();
        
      } catch (error) {
        console.error('LIFF 初始化失敗:', error);
        showToast('系統初始化失敗，請重新整理頁面');
      }
    }

    // 載入會員資料
    async function loadMemberData() {
      try {
        const response = await fetch(`${API_URL}?action=getMemberInfo&userId=${userId}`);
        const data = await response.json();
        
        if (!data) {
          // 新會員註冊
          const profile = await liff.getProfile();
          await registerNewMember(profile);
        } else {
          memberData = data;
          document.getElementById('memberName').textContent = data.name;
          document.getElementById('memberIdDisplay').textContent = data.memberId;
          
          // 生成 QR Code
          new QRCode(document.getElementById('qrcode'), {
            text: data.memberId,
            width: 150,
            height: 150
          });
          
          loadProfileInfo();
        }
      } catch (error) {
        console.error('載入會員資料失敗:', error);
      }
    }

    // 註冊新會員
    async function registerNewMember(profile) {
      const name = prompt('請輸入您的姓名：');
      const phone = prompt('請輸入您的電話：');
      const email = prompt('請輸入您的 Email：');
      
      if (!name || !phone) {
        showToast('請完整填寫資料');
        return;
      }
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'registerMember',
            lineUserId: userId,
            name: name,
            phone: phone,
            email: email
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('註冊成功！');
          await loadMemberData();
        }
      } catch (error) {
        console.error('註冊失敗:', error);
      }
    }

    // 載入首頁
    async function loadDashboard() {
      loadRecentActivities();
      loadMyStats();
    }

    // 載入最新活動
    async function loadRecentActivities() {
      try {
        const response = await fetch(`${API_URL}?action=getActivities&status=進行中`);
        const activities = await response.json();
        
        const container = document.getElementById('recentActivities');
        if (activities.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📭</div><p>目前沒有進行中的活動</p></div>';
          return;
        }
        
        container.innerHTML = activities.slice(0, 3).map(activity => `
          <div class="activity-item" onclick="viewActivity('${activity.activityId}')">
            <div class="activity-title">${activity.name}</div>
            <div class="activity-info">📅 ${activity.date} ${activity.startTime}</div>
            <div class="activity-info">📍 ${activity.location}</div>
          </div>
        `).join('');
      } catch (error) {
        console.error('載入活動失敗:', error);
      }
    }

    // 載入個人統計
    async function loadMyStats() {
      try {
        // 載入報名記錄
        const regResponse = await fetch(`${API_URL}?action=getMyRegistrations&userId=${userId}`);
        const registrations = await regResponse.json();
        document.getElementById('activityCount').textContent = registrations.length;
        
        // 載入志工時數
        const volResponse = await fetch(`${API_URL}?action=getVolunteerRecords&userId=${userId}`);
        const volunteer = await volResponse.json();
        document.getElementById('volunteerHours').textContent = volunteer.totalHours;
        document.getElementById('totalHours').textContent = volunteer.totalHours;
        
        // 載入捐款記錄
        const donResponse = await fetch(`${API_URL}?action=getDonationRecords&userId=${userId}`);
        const donations = await donResponse.json();
        document.getElementById('donationAmount').textContent = `NT$ ${donations.totalAmount.toLocaleString()}`;
      } catch (error) {
        console.error('載入統計失敗:', error);
      }
    }

    // 載入個人資料
    function loadProfileInfo() {
      const container = document.getElementById('profileInfo');
      container.innerHTML = `
        <div class="info-row">
          <span class="info-label">姓名</span>
          <span class="info-value">${memberData.name}</span>
        </div>
        <div class="info-row">
          <span class="info-label">電話</span>
          <span class="info-value">${memberData.phone}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Email</span>
          <span class="info-value">${memberData.email || '-'}</span>
        </div>
        <div class="info-row">
          <span class="info-label">會員類型</span>
          <span class="info-value">${memberData.memberType}</span>
        </div>
        <div class="info-row">
          <span class="info-label">加入日期</span>
          <span class="info-value">${new Date(memberData.createdAt).toLocaleDateString()}</span>
        </div>
      `;
    }

    // 編輯個人資料
    function editProfile() {
      document.getElementById('editName').value = memberData.name;
      document.getElementById('editPhone').value = memberData.phone;
      document.getElementById('editEmail').value = memberData.email || '';
      openModal('editModal');
    }

    // 儲存個人資料
    async function saveProfile() {
      const name = document.getElementById('editName').value;
      const phone = document.getElementById('editPhone').value;
      const email = document.getElementById('editEmail').value;
      
      if (!name || !phone) {
        showToast('請填寫必要資料');
        return;
      }
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'updateMember',
            lineUserId: userId,
            name: name,
            phone: phone,
            email: email
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('更新成功！');
          closeModal('editModal');
          await loadMemberData();
        }
      } catch (error) {
        console.error('更新失敗:', error);
        showToast('更新失敗，請稍後再試');
      }
    }

    // 載入活動列表
    async function loadActivities() {
      try {
        const response = await fetch(`${API_URL}?action=getActivities&status=進行中`);
        const activities = await response.json();
        
        const container = document.getElementById('activitiesList');
        if (activities.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📭</div><p>目前沒有進行中的活動</p></div>';
          return;
        }
        
        container.innerHTML = activities.map(activity => {
          const isFull = activity.maxParticipants > 0 && activity.registrationCount >= activity.maxParticipants;
          return `
            <div class="activity-item" onclick="viewActivity('${activity.activityId}')">
              <div class="activity-title">
                ${activity.name}
                ${isFull ? '<span class="badge badge-warning">已額滿</span>' : ''}
              </div>
              <div class="activity-info">📅 ${activity.date} ${activity.startTime} - ${activity.endTime}</div>
              <div class="activity-info">📍 ${activity.location}</div>
              <div class="activity-info">👥 ${activity.registrationCount}/${activity.maxParticipants || '不限'} 人</div>
              <div class="activity-info">💰 ${activity.fee > 0 ? 'NT$ ' + activity.fee : '免費'}</div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('載入活動失敗:', error);
      }
    }

    // 查看活動詳情
    async function viewActivity(activityId) {
      try {
        const response = await fetch(`${API_URL}?action=getActivities&status=進行中`);
        const activities = await response.json();
        const activity = activities.find(a => a.activityId === activityId);
        
        if (!activity) return;
        
        const isFull = activity.maxParticipants > 0 && activity.registrationCount >= activity.maxParticipants;
        const isDeadlinePassed = new Date(activity.registrationDeadline) < new Date();
        
        // 檢查是否已報名
        const regResponse = await fetch(`${API_URL}?action=getMyRegistrations&userId=${userId}`);
        const myRegs = await regResponse.json();
        const isRegistered = myRegs.some(r => r.activityId === activityId);
        
        const container = document.getElementById('activityDetail');
        container.innerHTML = `
          <div class="modal-title">${activity.name}</div>
          <div class="info-row">
            <span class="info-label">活動類型</span>
            <span class="info-value">${activity.type}</span>
          </div>
          <div class="info-row">
            <span class="info-label">日期時間</span>
            <span class="info-value">${activity.date} ${activity.startTime} - ${activity.endTime}</span>
          </div>
          <div class="info-row">
            <span class="info-label">地點</span>
            <span class="info-value">${activity.location}</span>
          </div>
          <div class="info-row">
            <span class="info-label">人數</span>
            <span class="info-value">${activity.registrationCount}/${activity.maxParticipants || '不限'} 人</span>
          </div>
          <div class="info-row">
            <span class="info-label">費用</span>
            <span class="info-value">${activity.fee > 0 ? 'NT$ ' + activity.fee : '免費'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">報名截止</span>
            <span class="info-value">${activity.registrationDeadline}</span>
          </div>
          <div class="form-group">
            <label class="form-label">活動說明</label>
            <p style="color: #666; line-height: 1.6;">${activity.description || '無'}</p>
          </div>
          <div class="form-group">
            <label class="form-label">注意事項</label>
            <p style="color: #666; line-height: 1.6;">${activity.notes || '無'}</p>
          </div>
          ${isRegistered 
            ? '<button class="btn btn-secondary" disabled>已報名</button>' 
            : isFull 
              ? '<button class="btn btn-secondary" disabled>已額滿</button>'
              : isDeadlinePassed
                ? '<button class="btn btn-secondary" disabled>報名已截止</button>'
                : `<button class="btn btn-primary" onclick="registerActivity('${activityId}')">立即報名</button>`
          }
        `;
        
        openModal('activityModal');
      } catch (error) {
        console.error('載入活動詳情失敗:', error);
      }
    }

    // 報名活動
    async function registerActivity(activityId) {
      if (!confirm('確定要報名此活動嗎？')) return;
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'registerActivity',
            activityId: activityId,
            userId: userId,
            memberName: memberData.name
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('報名成功！');
          closeModal('activityModal');
          loadActivities();
          loadMyRegistrations();
        } else {
          showToast(result.error || '報名失敗');
        }
      } catch (error) {
        console.error('報名失敗:', error);
        showToast('報名失敗，請稍後再試');
      }
    }

    // 載入我的報名
    async function loadMyRegistrations() {
      try {
        const response = await fetch(`${API_URL}?action=getMyRegistrations&userId=${userId}`);
        const registrations = await response.json();
        
        const container = document.getElementById('myRegistrations');
        if (registrations.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📋</div><p>尚未報名任何活動</p></div>';
          return;
        }
        
        container.innerHTML = registrations.map(reg => `
          <div class="activity-item">
            <div class="activity-title">
              ${reg.activityName}
              <span class="badge ${reg.checkInStatus === '已簽到' ? 'badge-success' : 'badge-info'}">${reg.checkInStatus}</span>
            </div>
            <div class="activity-info">📅 ${reg.activityDate}</div>
            <div class="activity-info">📍 ${reg.activityLocation}</div>
            <button class="btn btn-danger" onclick="cancelRegistration('${reg.registrationId}')">取消報名</button>
          </div>
        `).join('');
      } catch (error) {
        console.error('載入報名記錄失敗:', error);
      }
    }

    // 取消報名
    async function cancelRegistration(registrationId) {
      if (!confirm('確定要取消報名嗎？')) return;
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'cancelRegistration',
            registrationId: registrationId,
            userId: userId
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('已取消報名');
          loadMyRegistrations();
        }
      } catch (error) {
        console.error('取消報名失敗:', error);
        showToast('取消失敗，請稍後再試');
      }
    }

    // 提交志工記錄
    async function submitVolunteer() {
      const date = document.getElementById('serviceDate').value;
      const hours = document.getElementById('serviceHours').value;
      const description = document.getElementById('serviceDescription').value;
      
      if (!date || !hours || !description) {
        showToast('請填寫完整資料');
        return;
      }
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'submitVolunteerRecord',
            userId: userId,
            memberName: memberData.name,
            serviceDate: date,
            hours: parseFloat(hours),
            description: description
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('提交成功，等待審核');
          document.getElementById('serviceDate').value = '';
          document.getElementById('serviceHours').value = '';
          document.getElementById('serviceDescription').value = '';
          loadVolunteerRecords();
        }
      } catch (error) {
        console.error('提交失敗:', error);
        showToast('提交失敗，請稍後再試');
      }
    }

    // 載入志工記錄
    async function loadVolunteerRecords() {
      try {
        const response = await fetch(`${API_URL}?action=getVolunteerRecords&userId=${userId}`);
        const data = await response.json();
        
        document.getElementById('totalHours').textContent = data.totalHours;
        
        const container = document.getElementById('volunteerRecords');
        if (data.records.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📝</div><p>尚無服務記錄</p></div>';
          return;
        }
        
        container.innerHTML = data.records.map(record => `
          <div class="activity-item">
            <div class="activity-title">
              ${record.serviceDate}
              <span class="badge ${
                record.status === '已通過' ? 'badge-success' : 
                record.status === '待審核' ? 'badge-warning' : 'badge-danger'
              }">${record.status}</span>
            </div>
            <div class="activity-info">⏰ ${record.hours} 小時</div>
            <div class="activity-info">📝 ${record.description}</div>
            ${record.reviewNote ? `<div class="activity-info" style="color: #ff4757;">💬 ${record.reviewNote}</div>` : ''}
          </div>
        `).join('');
      } catch (error) {
        console.error('載入志工記錄失敗:', error);
      }
    }

    // 查看捐款記錄
    async function viewDonations() {
      try {
        const response = await fetch(`${API_URL}?action=getDonationRecords&userId=${userId}`);
        const data = await response.json();
        
        if (data.donations.length === 0) {
          alert('尚無捐款記錄');
          return;
        }
        
        let message = `累計捐款：NT$ ${data.totalAmount.toLocaleString()}\n\n`;
        data.donations.forEach(d => {
          message += `${d.date}\nNT$ ${d.amount.toLocaleString()}\n${d.description || ''}\n\n`;
        });
        
        alert(message);
      } catch (error) {
        console.error('載入捐款記錄失敗:', error);
      }
    }

    // 切換分頁
    function switchTab(tabName) {
      document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      // 載入對應資料
      if (tabName === 'activities') {
        loadActivities();
        loadMyRegistrations();
      } else if (tabName === 'volunteer') {
        loadVolunteerRecords();
      }
    }

    // Modal 控制
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // Toast 提示
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // 初始化
    window.onload = () => {
      initializeLiff();
    };
  </script>
</body>
</html>
