<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±ï¼ˆæ•´åˆç‰ˆï¼‰</title>

  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    :root {
      --primary: #06c755;
      --primary-dark: #05b04b;
      --secondary: #00b900;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --border-radius: 12px;
      --indigo-1: #667eea;
      --indigo-2: #764ba2;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, var(--indigo-1) 0%, var(--indigo-2) 100%); min-height: 100vh; }
    a { text-decoration: none; }

    /* æ¡†æ¶ï¼šä¸»å®¹å™¨èˆ‡é ‚éƒ¨å°è¦½ */
    .app-container { max-width: 1200px; margin: 0 auto; min-height: 100vh; background: white; box-shadow: 0 0 30px rgba(0,0,0,0.12); }
    .global-topbar { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: #fff; }
    .global-topbar h1 { font-size: 18px; margin: 0; display: flex; align-items: center; gap: 8px; }
    .global-user { display: flex; align-items: center; gap: 10px; }
    .global-avatar { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.3); display: inline-flex; align-items:center; justify-content:center; font-weight: 700; }
    .global-name { font-size: 14px; font-weight: 600; }

    .global-nav { display: flex; gap: 8px; padding: 8px 12px; border-bottom: 1px solid #eee; background: #fff; }
    .global-nav button { border: 1px solid #e0e0e0; background: #fff; padding: 8px 12px; border-radius: 8px; color: #444; cursor: pointer; transition: all .2s; }
    .global-nav button.active, .global-nav button:hover { border-color: var(--primary); color: var(--primary); }

    .section { display: none; }
    .section.active { display: block; }

    /* Toast é€šçŸ¥ */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }

    /* Loading Overlay */
    .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.65); display: none; align-items:center; justify-content:center; z-index: 9998; }
    .loading-overlay.show { display: flex; }
    .loading-spinner { width: 60px; height: 60px; border: 6px solid rgba(255,255,255,.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* åˆ†é æ¨™é¡Œèˆ‡å®¹å™¨ */
    .container-inner { padding: 16px; }
    .page-header { display:flex; justify-content: space-between; align-items:center; margin: 8px 0 16px; }
    .page-header h2 { font-size: 18px; margin: 0; display: inline-flex; gap: 8px; align-items:center; }

    /* å¡ç‰‡æ¨£å¼ï¼ˆé€šç”¨ï¼‰ */
    .card { border: none; border-radius: var(--border-radius); box-shadow: 0 2px 8px rgba(0,0,0,0.08); background: #fff; margin-bottom: 16px; }
    .card-header { padding: 12px 16px; background: linear-gradient(135deg, var(--indigo-1) 0%, var(--indigo-2) 100%); color:#fff; border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); }
    .card-body { padding: 16px; }
    .btn-gradient { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color:#fff; border:none; padding:10px 16px; border-radius: 8px; font-weight:600; }
    .btn-gradient:hover { opacity: .95; }
    .btn-outline { background: #fff; border: 1px solid var(--primary); color: var(--primary); padding: 8px 16px; border-radius: 8px; }
    .status-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #eef2f7; color:#333; }
    .status-success { background: #d4edda; color: #155724; }
    .status-warning { background: #fff3cd; color: #856404; }
    .status-danger { background: #f8d7da; color: #721c24; }
    .status-info { background: #d1ecf1; color: #0c5460; }
    .empty-state { text-align:center; color:#888; padding:24px 8px; }

    /* è¡¨æ ¼ */
    .table-responsive { border-radius: var(--border-radius); overflow: hidden; }

    /* åº•éƒ¨å›ºå®šå°è¦½ï¼ˆåªåœ¨ LIFF App å…§é ç”¨ï¼‰ */
    .bottom-nav { position: sticky; bottom: 0; left:0; right:0; background:#fff; border-top: 1px solid #eee; display:flex; gap: 8px; justify-content: space-around; padding: 8px 0; }
    .bottom-nav button { display:flex; flex-direction: column; align-items:center; color:#777; background:none; border:none; padding:6px; }
    .bottom-nav button.active, .bottom-nav button:hover { color: var(--primary); }

    /* ç™»å…¥/è¨»å†Šé çš„æ¨£å¼ï¼ˆç°¡åŒ–æ•´åˆï¼‰ */
    .auth-wrapper { display:flex; align-items:center; justify-content:center; min-height: 70vh; padding: 16px; }
    .auth-card { background: #fff; border-radius: 12px; padding: 20px; max-width: 420px; width: 100%; box-shadow: 0 12px 40px rgba(0,0,0,0.2); }
    .auth-title { text-align:center; margin-bottom: 16px; }
    .api-config { background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .api-config small { color:#856404; }
    .api-config input { width: 100%; padding: 8px; border:1px solid #ffc107; border-radius:6px; margin-top: 8px; font-size: 12px; font-family: monospace; }
    .tabs { display:flex; gap: 8px; border-bottom: 1px solid #eee; margin: 12px 0; }
    .tabs button { flex: 1; background:none; border:none; padding: 10px; color:#999; cursor:pointer; }
    .tabs button.active { color: var(--indigo-1); border-bottom: 2px solid var(--indigo-1); }
    .form-group { margin-bottom: 12px; }
    .form-group label { display:block; margin-bottom: 6px; font-weight: 600; color:#333; }
    .form-group input, .form-group select, .form-group textarea { width:100%; padding:10px 12px; border: 1px solid #e0e0e0; border-radius: 8px; }
    .btn { border: none; border-radius: 8px; padding: 10px 16px; cursor: pointer; }
    .btn-primary { background: linear-gradient(135deg, var(--indigo-1), var(--indigo-2)); color:#fff; }
    .btn-secondary { background: #6c757d; color:#fff; }
    .btn-line { background: #06C755; color:#fff; display:flex; align-items:center; justify-content:center; gap: 8px; }

    .divider { text-align:center; color:#aaa; margin: 10px 0; }

    /* ç®¡ç†å¾Œå° layout */
    .admin-layout { display:flex; min-height: calc(100vh - 56px); }
    .sidebar { width: 240px; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color:#fff; padding-bottom: 24px; }
    .sidebar .brand { padding: 16px; font-weight: 700; }
    .sidebar .menu a { display:flex; gap: 12px; padding: 12px 16px; color: rgba(255,255,255,.85); cursor:pointer; }
    .sidebar .menu a:hover, .sidebar .menu a.active { background: rgba(255,255,255,0.12); color:#fff; }
    .admin-main { flex:1; background:#f5f7fa; }
    .admin-topbar { background:#fff; padding: 12px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content: space-between; }
    .admin-content { padding: 16px; }

    @media (max-width: 992px) {
      .admin-layout { flex-direction: column; }
      .sidebar { width: 100%; height: auto; position: relative; }
    }
  </style>
</head>

<body>
  <div class="app-container">
    <!-- å…¨åŸŸé ‚éƒ¨ -->
    <div class="global-topbar">
      <h1><i class="bi bi-heart-pulse"></i> å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±ï¼ˆæ•´åˆï¼‰</h1>
      <div class="global-user">
        <div class="global-avatar" id="gUserAvatar">U</div>
        <div class="global-name" id="gUserName">æœªç™»å…¥</div>
      </div>
    </div>

    <!-- å…¨åŸŸå°è¦½ï¼ˆä¾ç™»å…¥ç‹€æ…‹èˆ‡è§’è‰²åˆ‡æ›ï¼‰ -->
    <div class="global-nav" id="globalNav">
      <!-- æœªç™»å…¥ï¼šé¡¯ç¤ºç™»å…¥è¨»å†Š -->
      <button class="active" data-target="section-auth" onclick="switchSection('section-auth', this)">ç™»å…¥/è¨»å†Š</button>
      <!-- ç™»å…¥å¾Œï¼ˆä¸€èˆ¬æœƒå“¡ï¼‰ -->
      <!-- <button data-target="section-member" onclick="switchSection('section-member', this)">æœƒå“¡ä¸­å¿ƒ</button> -->
      <!-- ç™»å…¥å¾Œï¼ˆç®¡ç†å“¡ï¼‰ -->
      <!-- <button data-target="section-admin" onclick="switchSection('section-admin', this)">ç®¡ç†å¾Œå°</button> -->
      <!-- LIFF App æ¨¡å¼ -->
      <!-- <button data-target="section-liffApp" onclick="switchSection('section-liffApp', this)">LIFF App</button> -->
    </div>

    <!-- Toast -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Loading -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-spinner"></div>
    </div>

    <!-- å…§å®¹å€ -->
    <div class="container-inner">
      <!-- å€å¡Šï¼šç™»å…¥è¨»å†Š -->
      <div id="section-auth" class="section active">
        <div class="auth-wrapper">
          <div class="auth-card">
            <div class="auth-title">
              <h3>ğŸŒŸ å¸•é‡‘æ£®å”æœƒï½œæœƒå“¡ç™»å…¥/è¨»å†Š</h3>
              <p class="text-muted" style="font-size:13px;">è«‹å…ˆå®Œæˆ API è¨­å®šï¼Œå†é€²è¡Œç™»å…¥/è¨»å†Š</p>
            </div>

            <div class="api-config">
              <small>âš™ï¸ API è¨­å®šï¼ˆè«‹è²¼ä¸Š Google Apps Script éƒ¨ç½²ç¶²å€ï¼‰</small>
              <input type="text" id="api-url-input" placeholder="https://script.google.com/macros/s/xxxx/exec" />
              <div class="d-grid gap-2 mt-2">
                <button class="btn btn-secondary" onclick="updateAPIUrl()">æ›´æ–° API ç¶²å€</button>
                <button class="btn btn-outline" onclick="testAPIConnection()">æ¸¬è©¦ API é€£ç·š</button>
              </div>
            </div>

            <div class="tabs">
              <button class="active" id="tab-login" onclick="switchAuthTab('login')">ç™»å…¥</button>
              <button id="tab-register" onclick="switchAuthTab('register')">è¨»å†Š</button>
            </div>

            <div id="auth-login" class="auth-pane">
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="login-email" placeholder="è«‹è¼¸å…¥ Email" />
              </div>
              <div class="form-group">
                <label>å¯†ç¢¼</label>
                <input type="password" id="login-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-primary" onclick="handleLogin()">ç™»å…¥</button>
                <div class="divider">æˆ–</div>
                <button class="btn btn-line" onclick="handleLineLogin()">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="white">
                    <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                  </svg>
                  LINE å¿«é€Ÿç™»å…¥
                </button>
              </div>
            </div>

            <div id="auth-register" class="auth-pane" style="display:none;">
              <div class="form-group">
                <label>å§“å *</label>
                <input type="text" id="reg-name" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" />
              </div>
              <div class="form-group">
                <label>æ€§åˆ¥ *</label>
                <select id="reg-gender">
                  <option value="">è«‹é¸æ“‡</option>
                  <option value="ç”·">ç”·</option>
                  <option value="å¥³">å¥³</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
              </div>
              <div class="form-group">
                <label>ç”Ÿæ—¥ *</label>
                <input type="date" id="reg-birthday" />
              </div>
              <div class="form-group">
                <label>æ‰‹æ©Ÿ *</label>
                <input type="tel" id="reg-phone" placeholder="0912-345-678" />
              </div>
              <div class="form-group">
                <label>Email *</label>
                <input type="email" id="reg-email" placeholder="example@email.com" />
              </div>
              <div class="form-group">
                <label>å¯†ç¢¼ *</label>
                <input type="password" id="reg-password" minlength="8" placeholder="è‡³å°‘ 8 å€‹å­—å…ƒ" />
              </div>
              <div class="form-group">
                <label>ç¢ºèªå¯†ç¢¼ *</label>
                <input type="password" id="reg-password-confirm" minlength="8" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼" />
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-primary" onclick="handleRegister()">è¨»å†Š</button>
              </div>
            </div>

            <div class="mt-3">
              <small class="text-muted">è‹¥æ‚¨æ˜¯ç®¡ç†å“¡ï¼Œç™»å…¥å¾Œè«‹é»é¸ã€Œç®¡ç†å¾Œå°ã€é€²å…¥ç®¡ç†ç³»çµ±ã€‚</small>
            </div>
          </div>
        </div>
      </div>

      <!-- å€å¡Šï¼šæœƒå“¡ä¸­å¿ƒï¼ˆæ•´åˆåŸ Member Centerï¼‰ -->
      <div id="section-member" class="section">
        <div class="page-header">
          <h2><i class="bi bi-person-circle"></i> æœƒå“¡ä¸­å¿ƒ</h2>
          <div class="d-flex gap-2">
            <button class="btn btn-outline" onclick="goLIFFApp()">é–‹å•Ÿ LIFF App</button>
            <button class="btn btn-outline" onclick="switchSection('section-admin')">ç®¡ç†å¾Œå°</button>
            <button class="btn btn-danger" onclick="globalLogout()">ç™»å‡º</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">æˆ‘çš„è³‡è¨Š</div>
          <div class="card-body" id="memberProfileInfo">
            <div class="text-muted">è¼‰å…¥ä¸­...</div>
          </div>
        </div>

        <!-- å¿«æ· -->
        <div class="card">
          <div class="card-header">å¿«æ·å·¥å…·</div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-6 col-md-3">
                <button class="btn btn-gradient w-100" onclick="showMemberSub('symptom')">ç—‡ç‹€è¨˜éŒ„</button>
              </div>
              <div class="col-6 col-md-3">
                <button class="btn btn-gradient w-100" onclick="showMemberSub('medication')">ç”¨è—¥ç®¡ç†</button>
              </div>
              <div class="col-6 col-md-3">
                <button class="btn btn-gradient w-100" onclick="showMemberSub('exercise')">é‹å‹•è¨˜éŒ„</button>
              </div>
              <div class="col-6 col-md-3">
                <button class="btn btn-gradient w-100" onclick="showMemberSub('mood')">æƒ…ç·’æ—¥è¨˜</button>
              </div>
            </div>
          </div>
        </div>

        <!-- å­é ï¼šç—‡ç‹€ -->
        <div class="card" data-member-sub="symptom" style="display:none;">
          <div class="card-header">ç—‡ç‹€è¨˜éŒ„</div>
          <div class="card-body">
            <form id="symptom-form" onsubmit="handleAddSymptom(event)">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">é¡«æŠ–(0-10)</label>
                  <input type="range" min="0" max="10" id="tremor-level" class="form-range" value="5" oninput="document.getElementById('lbl-tremor').textContent=this.value" />
                  <div class="text-center fw-bold" id="lbl-tremor">5</div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">åƒµç¡¬(0-10)</label>
                  <input type="range" min="0" max="10" id="rigidity-level" class="form-range" value="5" oninput="document.getElementById('lbl-rigid').textContent=this.value" />
                  <div class="text-center fw-bold" id="lbl-rigid">5</div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">é²ç·©(0-10)</label>
                  <input type="range" min="0" max="10" id="bradykinesia-level" class="form-range" value="5" oninput="document.getElementById('lbl-brady').textContent=this.value" />
                  <div class="text-center fw-bold" id="lbl-brady">5</div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">å¹³è¡¡(0-10)</label>
                  <input type="range" min="0" max="10" id="balance-level" class="form-range" value="5" oninput="document.getElementById('lbl-balance').textContent=this.value" />
                  <div class="text-center fw-bold" id="lbl-balance">5</div>
                </div>
                <div class="col-12">
                  <label class="form-label">å‚™è¨»</label>
                  <textarea id="symptom-notes" class="form-control" rows="3" placeholder="å…¶ä»–ç—‡ç‹€æˆ–èªªæ˜..."></textarea>
                </div>
              </div>
              <div class="mt-3">
                <button type="submit" class="btn btn-primary">å„²å­˜è¨˜éŒ„</button>
              </div>
            </form>

            <div class="mt-3">
              <h6 class="fw-bold">è¿‘ 30 å¤©ç´€éŒ„</h6>
              <div id="symptom-history" class="mt-2">
                <div class="text-muted">è¼‰å…¥ä¸­...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- å­é ï¼šç”¨è—¥ -->
        <div class="card" data-member-sub="medication" style="display:none;">
          <div class="card-header">ç”¨è—¥ç®¡ç†</div>
          <div class="card-body">
            <div class="d-flex gap-2 mb-2">
              <button class="btn btn-primary" onclick="openAddMedicationModal()">æ–°å¢ç”¨è—¥</button>
              <button class="btn btn-outline" onclick="loadMedications()">é‡æ–°æ•´ç†</button>
            </div>
            <div id="medication-list" class="mb-3">
              <div class="text-muted">è¼‰å…¥ä¸­...</div>
            </div>

            <h6 class="fw-bold">ä»Šæ—¥æé†’</h6>
            <div id="today-reminders" class="mt-2">
              <div class="text-muted">è¼‰å…¥ä¸­...</div>
            </div>
          </div>
        </div>

        <!-- å­é ï¼šé‹å‹• -->
        <div class="card" data-member-sub="exercise" style="display:none;">
          <div class="card-header">é‹å‹•è¨˜éŒ„</div>
          <div class="card-body">
            <form id="exercise-form" onsubmit="handleAddExercise(event)">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">é‹å‹•é¡å‹</label>
                  <select id="exercise-type" class="form-select" required>
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="æ•£æ­¥">æ•£æ­¥</option>
                    <option value="å¤ªæ¥µ">å¤ªæ¥µ</option>
                    <option value="ç‘œçˆ">ç‘œçˆ</option>
                    <option value="æ¸¸æ³³">æ¸¸æ³³</option>
                    <option value="é¨è…³è¸è»Š">é¨è…³è¸è»Š</option>
                    <option value="å¾©å¥é‹å‹•">å¾©å¥é‹å‹•</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">åˆ†é˜æ•¸</label>
                  <input type="number" id="exercise-duration" class="form-control" min="1" required />
                </div>
                <div class="col-md-3">
                  <label class="form-label">å¼·åº¦</label>
                  <select id="exercise-intensity" class="form-select" required>
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="è¼•åº¦">è¼•åº¦</option>
                    <option value="ä¸­åº¦">ä¸­åº¦</option>
                    <option value="é«˜å¼·åº¦">é«˜å¼·åº¦</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">èº«é«”ç‹€æ³</label>
                  <select id="exercise-condition" class="form-select" required>
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="è‰¯å¥½">è‰¯å¥½</option>
                    <option value="æ™®é€š">æ™®é€š</option>
                    <option value="ç–²ç´¯">ç–²ç´¯</option>
                    <option value="ä¸é©">ä¸é©</option>
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">å‚™è¨»</label>
                  <textarea id="exercise-notes" class="form-control" rows="3"></textarea>
                </div>
              </div>
              <div class="mt-3">
                <button type="submit" class="btn btn-primary">å„²å­˜è¨˜éŒ„</button>
              </div>
            </form>
          </div>
        </div>

        <!-- å­é ï¼šç¡çœ  -->
        <div class="card" data-member-sub="sleep" style="display:none;">
          <div class="card-header">ç¡çœ è¨˜éŒ„</div>
          <div class="card-body">
            <form id="sleep-form" onsubmit="handleAddSleep(event)">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">å°±å¯¢æ™‚é–“</label>
                  <input type="time" id="sleep-bedtime" class="form-control" required />
                </div>
                <div class="col-md-3">
                  <label class="form-label">èµ·åºŠæ™‚é–“</label>
                  <input type="time" id="sleep-waketime" class="form-control" required />
                </div>
                <div class="col-md-3">
                  <label class="form-label">ç¡çœ å“è³ª</label>
                  <select id="sleep-quality" class="form-select" required>
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="å¾ˆå¥½">å¾ˆå¥½</option>
                    <option value="å¥½">å¥½</option>
                    <option value="æ™®é€š">æ™®é€š</option>
                    <option value="å·®">å·®</option>
                    <option value="å¾ˆå·®">å¾ˆå·®</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">å¤œé–“é†’ä¾†</label>
                  <input type="number" id="sleep-wakecount" class="form-control" min="0" value="0" />
                </div>
                <div class="col-md-3">
                  <label class="form-check"><input type="checkbox" id="sleep-hasdream" class="form-check-input" /> æœ‰åšå¤¢</label>
                </div>
                <div class="col-md-3">
                  <label class="form-check"><input type="checkbox" id="sleep-hasnightmare" class="form-check-input" /> æœ‰æƒ¡å¤¢</label>
                </div>
                <div class="col-12">
                  <label class="form-label">å‚™è¨»</label>
                  <textarea id="sleep-notes" class="form-control" rows="3" placeholder="ç¡çœ ç‹€æ³èªªæ˜..."></textarea>
                </div>
              </div>
              <div class="mt-3">
                <button type="submit" class="btn btn-primary">å„²å­˜è¨˜éŒ„</button>
              </div>
            </form>
          </div>
        </div>

        <!-- å­é ï¼šæƒ…ç·’ -->
        <div class="card" data-member-sub="mood" style="display:none;">
          <div class="card-header">æƒ…ç·’æ—¥è¨˜</div>
          <div class="card-body">
            <div class="mb-2">é¸æ“‡å¿ƒæƒ…</div>
            <div class="d-flex justify-content-between" style="max-width: 340px;">
              <button class="btn btn-outline" onclick="selectMood(1)">ğŸ˜¢</button>
              <button class="btn btn-outline" onclick="selectMood(3)">ğŸ˜•</button>
              <button class="btn btn-outline" onclick="selectMood(5)">ğŸ˜</button>
              <button class="btn btn-outline" onclick="selectMood(7)">ğŸ™‚</button>
              <button class="btn btn-outline" onclick="selectMood(10)">ğŸ˜„</button>
            </div>
            <input type="hidden" id="mood-score" value="5" />
            <div class="mt-3">
              <div class="mb-2">å¿ƒæƒ…æ¨™ç±¤</div>
              <div class="d-flex flex-wrap gap-2" id="mood-tags">
                <span class="badge bg-light text-dark" onclick="toggleTag(this)">é–‹å¿ƒ</span>
                <span class="badge bg-light text-dark" onclick="toggleTag(this)">ç„¦æ…®</span>
                <span class="badge bg-light text-dark" onclick="toggleTag(this)">ç–²ç´¯</span>
                <span class="badge bg-light text-dark" onclick="toggleTag(this)">å¹³éœ</span>
                <span class="badge bg-light text-dark" onclick="toggleTag(this)">æ²®å–ª</span>
                <span class="badge bg-light text-dark" onclick="toggleTag(this)">å……æ»¿æ´»åŠ›</span>
              </div>
            </div>
            <div class="mt-3">
              <label class="form-label">å¿ƒæƒ…æ—¥è¨˜</label>
              <textarea id="mood-content" class="form-control" rows="4" placeholder="å¯«ä¸‹ä»Šå¤©çš„å¿ƒæƒ…..."></textarea>
            </div>
            <div class="mt-3">
              <button class="btn btn-primary" onclick="handleAddMood()">å„²å­˜æ—¥è¨˜</button>
            </div>
          </div>
        </div>

        <!-- å­é ï¼šæ´»å‹• -->
        <div class="card" data-member-sub="events" style="display:none;">
          <div class="card-header">æ´»å‹•å ±å</div>
          <div class="card-body">
            <div class="row">
              <div class="col-12 col-lg-6">
                <h6>å¯å ±åæ´»å‹•</h6>
                <div id="events-list" class="mt-2">
                  <div class="text-muted">è¼‰å…¥ä¸­...</div>
                </div>
              </div>
              <div class="col-12 col-lg-6">
                <h6>æˆ‘çš„å ±å</h6>
                <div id="my-events-list" class="mt-2">
                  <div class="text-muted">è¼‰å…¥ä¸­...</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ææ¬¾ï¼†æ”¶æ“š -->
        <div class="card" data-member-sub="donation" style="display:none;">
          <div class="card-header">ææ¬¾è¨˜éŒ„</div>
          <div class="card-body" id="donation-history">
            <div class="text-muted">è¼‰å…¥ä¸­...</div>
          </div>
        </div>
      </div>

      <!-- å€å¡Šï¼šLIFF Appï¼ˆæ•´åˆåŸè¡Œå‹• LIFF ç‰ˆï¼‰ -->
      <div id="section-liffApp" class="section">
        <div class="page-header">
          <h2><i class="bi bi-phone"></i> LIFF è¡Œå‹•ç‰ˆ</h2>
          <div class="d-flex gap-2">
            <button class="btn btn-outline" onclick="switchSection('section-member')">å›æœƒå“¡ä¸­å¿ƒ</button>
            <button class="btn btn-outline" onclick="switchSection('section-admin')">ç®¡ç†å¾Œå°</button>
            <button class="btn btn-danger" onclick="globalLogout()">ç™»å‡º</button>
          </div>
        </div>

        <!-- LIFF Header -->
        <div class="card">
          <div class="card-header">LIFF ä½¿ç”¨è€…</div>
          <div class="card-body d-flex align-items-center gap-3">
            <img id="liffUserAvatar" src="https://via.placeholder.com/48" class="rounded-circle border" width="48" height="48" />
            <div>
              <div id="liffUserName" class="fw-bold">è¼‰å…¥ä¸­...</div>
              <div class="text-muted" style="font-size:12px;">LINE User IDï¼š<span id="liffUserId">-</span></div>
            </div>
            <div class="ms-auto">
              <span class="badge bg-success" id="liffRoleBadge">æœƒå“¡</span>
            </div>
          </div>
        </div>

        <!-- LIFF Dashboard -->
        <div class="card">
          <div class="card-header">å„€è¡¨æ¿</div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-6 col-md-3">
                <div class="p-3 rounded border text-center">
                  <div class="text-muted">æ´»å‹•ç¸½æ•¸</div>
                  <div id="statActivities" class="fs-3 fw-bold">0</div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="p-3 rounded border text-center">
                  <div class="text-muted">æˆ‘çš„å ±å</div>
                  <div id="statRegistrations" class="fs-3 fw-bold">0</div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="p-3 rounded border text-center">
                  <div class="text-muted">å¿—å·¥æ™‚æ•¸</div>
                  <div id="statVolunteerHours" class="fs-3 fw-bold">0</div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="p-3 rounded border text-center">
                  <div class="text-muted">ææ¬¾é‡‘é¡</div>
                  <div id="statDonations" class="fs-3 fw-bold">$0</div>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <h6>æœ€æ–°æ´»å‹•</h6>
              <div id="recentActivities">
                <div class="text-muted">è¼‰å…¥ä¸­...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- LIFF Tabs -->
        <div class="card">
          <div class="card-header">åŠŸèƒ½</div>
          <div class="card-body">
            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-outline" onclick="liffLoadActivities()">æ´»å‹•åˆ—è¡¨</button>
              <button class="btn btn-outline" onclick="liffLoadMyRegistrations()">æˆ‘çš„å ±å</button>
              <button class="btn btn-outline" onclick="liffLoadVolunteer()">å¿—å·¥</button>
              <button class="btn btn-outline" onclick="liffLoadFinance()">è²¡å‹™</button>
              <button class="btn btn-outline" onclick="liffLoadProfile()">å€‹äººè³‡æ–™</button>
              <button class="btn btn-outline" onclick="liffLoadAdmin()" id="liffAdminBtn" style="display:none;">ç®¡ç†</button>
            </div>

            <div id="liffDynamicArea" class="mt-3">
              <div class="empty-state">è«‹é¸æ“‡ä¸Šæ–¹åŠŸèƒ½è¼‰å…¥</div>
            </div>
          </div>
        </div>
      </div>

      <!-- å€å¡Šï¼šç®¡ç†å¾Œå°ï¼ˆæ•´åˆåŸ Adminï¼‰ -->
      <div id="section-admin" class="section">
        <div class="page-header">
          <h2><i class="bi bi-gear-wide-connected"></i> ç®¡ç†å¾Œå°</h2>
          <div class="d-flex gap-2">
            <button class="btn btn-outline" onclick="switchSection('section-member')">æœƒå“¡ä¸­å¿ƒ</button>
            <button class="btn btn-outline" onclick="goLIFFApp()">LIFF App</button>
            <button class="btn btn-danger" onclick="globalLogout()">ç™»å‡º</button>
          </div>
        </div>

        <div class="admin-layout">
          <div class="sidebar">
            <div class="brand">ğŸŒŸ å¾Œå°é¸å–®</div>
            <div class="menu">
              <a class="active" onclick="adminShow('dashboard', this)">ğŸ“Š ç¸½è¦½</a>
              <a onclick="adminShow('members', this)">ğŸ‘¥ æœƒå“¡ç®¡ç†</a>
              <a onclick="adminShow('events', this)">ğŸ¯ æ´»å‹•ç®¡ç†</a>
              <a onclick="adminShow('health', this)">ğŸ“‹ å¥åº·è¨˜éŒ„</a>
              <a onclick="adminShow('donations', this)">ğŸ’° ææ¬¾ç®¡ç†</a>
              <a onclick="adminShow('reports', this)">ğŸ“ˆ çµ±è¨ˆå ±è¡¨</a>
              <a onclick="adminShow('settings', this)">âš™ï¸ ç³»çµ±è¨­å®š</a>
            </div>
          </div>
          <div class="admin-main">
            <div class="admin-topbar">
              <div id="adminTitle">ç³»çµ±ç¸½è¦½</div>
              <div class="d-flex align-items-center gap-2">
                <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center" style="width:32px;height:32px;" id="adminAvatarTxt">A</div>
                <div id="adminNameTxt">ç®¡ç†å“¡</div>
              </div>
            </div>
            <div class="admin-content">
              <div id="admin-alert" class="alert alert-info d-none"></div>

              <!-- Dashboard -->
              <div data-admin-section="dashboard">
                <div class="row g-3">
                  <div class="col-6 col-lg-3">
                    <div class="card"><div class="card-body text-center"><div class="text-muted">ç¸½æœƒå“¡æ•¸</div><div id="adm-total-members" class="fs-2 fw-bold">-</div></div></div>
                  </div>
                  <div class="col-6 col-lg-3">
                    <div class="card"><div class="card-body text-center"><div class="text-muted">æ´»èºæœƒå“¡</div><div id="adm-active-members" class="fs-2 fw-bold">-</div></div></div>
                  </div>
                  <div class="col-6 col-lg-3">
                    <div class="card"><div class="card-body text-center"><div class="text-muted">ç¸½æ´»å‹•æ•¸</div><div id="adm-total-events" class="fs-2 fw-bold">-</div></div></div>
                  </div>
                  <div class="col-6 col-lg-3">
                    <div class="card"><div class="card-body text-center"><div class="text-muted">ç¸½ææ¬¾é‡‘é¡</div><div id="adm-total-donations" class="fs-2 fw-bold">-</div></div></div>
                  </div>
                </div>
                <div class="card">
                  <div class="card-header">æœ€æ–°å‹•æ…‹</div>
                  <div class="card-body" id="adm-recent-activities">
                    <div class="text-muted">è¼‰å…¥ä¸­...</div>
                  </div>
                </div>
              </div>

              <!-- Members -->
              <div data-admin-section="members" style="display:none;">
                <div class="card">
                  <div class="card-header d-flex justify-content-between">
                    <span>æœƒå“¡ç®¡ç†</span>
                    <button class="btn btn-primary btn-sm" onclick="admShowAddMember()">æ–°å¢æœƒå“¡</button>
                  </div>
                  <div class="card-body">
                    <div class="row g-2 align-items-end">
                      <div class="col-md-4">
                        <label class="form-label">æœå°‹</label>
                        <input type="text" class="form-control" id="member-search" placeholder="å§“åã€Email æˆ–é›»è©±..." />
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">ç‹€æ…‹</label>
                        <select class="form-select" id="member-status-filter">
                          <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                          <option value="å·²å¯©æ ¸">å·²å¯©æ ¸</option>
                          <option value="å¾…å¯©æ ¸">å¾…å¯©æ ¸</option>
                          <option value="å·²åœç”¨">å·²åœç”¨</option>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <button class="btn btn-outline w-100" onclick="loadMembersData(1)">æœå°‹</button>
                      </div>
                      <div class="col-md-3">
                        <button class="btn btn-outline w-100" onclick="exportMembersCSV()">åŒ¯å‡º</button>
                      </div>
                    </div>

                    <div class="table-responsive mt-3">
                      <table class="table table-hover">
                        <thead class="table-light">
                          <tr>
                            <th>æœƒå“¡ç·¨è™Ÿ</th>
                            <th>å§“å</th>
                            <th>Email</th>
                            <th>é›»è©±</th>
                            <th>è¨»å†Šæ—¥æœŸ</th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                          </tr>
                        </thead>
                        <tbody id="members-tbody">
                          <tr><td colspan="7" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                      </table>
                    </div>
                    <div id="members-pagination" class="d-flex justify-content-center gap-2 mt-2"></div>
                  </div>
                </div>
              </div>

              <!-- Events -->
              <div data-admin-section="events" style="display:none;">
                <div class="card">
                  <div class="card-header d-flex justify-content-between">
                    <span>æ´»å‹•ç®¡ç†</span>
                    <button class="btn btn-primary btn-sm" onclick="admShowAddEvent()">æ–°å¢æ´»å‹•</button>
                  </div>
                  <div class="card-body">
                    <div class="row g-2 align-items-end">
                      <div class="col-md-6">
                        <label class="form-label">æœå°‹æ´»å‹•</label>
                        <input type="text" id="event-search" class="form-control" placeholder="æ´»å‹•åç¨±..." />
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">ç‹€æ…‹</label>
                        <select class="form-select" id="event-status-filter">
                          <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                          <option value="å ±åä¸­">å ±åä¸­</option>
                          <option value="å·²é¡æ»¿">å·²é¡æ»¿</option>
                          <option value="å·²çµæŸ">å·²çµæŸ</option>
                          <option value="å·²å–æ¶ˆ">å·²å–æ¶ˆ</option>
                        </select>
                      </div>
                      <div class="col-md-3">
                        <button class="btn btn-outline w-100" onclick="loadEventsData(1)">æœå°‹</button>
                      </div>
                    </div>
                    <div class="table-responsive mt-3">
                      <table class="table table-hover">
                        <thead class="table-light">
                          <tr>
                            <th>æ´»å‹•åç¨±</th>
                            <th>æ—¥æœŸæ™‚é–“</th>
                            <th>åœ°é»</th>
                            <th>å ±åäººæ•¸</th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                          </tr>
                        </thead>
                        <tbody id="events-tbody">
                          <tr><td colspan="6" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                      </table>
                    </div>
                    <div id="events-pagination" class="d-flex justify-content-center gap-2 mt-2"></div>
                  </div>
                </div>
              </div>

              <!-- Health -->
              <div data-admin-section="health" style="display:none;">
                <div class="card">
                  <div class="card-header">å¥åº·è¨˜éŒ„ç®¡ç†</div>
                  <div class="card-body">
                    <div class="row g-2 align-items-end">
                      <div class="col-md-4">
                        <label class="form-label">æœå°‹æœƒå“¡</label>
                        <input type="text" id="health-search" class="form-control" />
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">èµ·æ—¥</label>
                        <input type="date" id="health-date-from" class="form-control" />
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">è¿„æ—¥</label>
                        <input type="date" id="health-date-to" class="form-control" />
                      </div>
                      <div class="col-md-2">
                        <button class="btn btn-outline w-100" onclick="loadHealthData(1)">æœå°‹</button>
                      </div>
                    </div>
                    <div class="table-responsive mt-3">
                      <table class="table table-hover">
                        <thead class="table-light">
                          <tr>
                            <th>æœƒå“¡å§“å</th>
                            <th>è¨˜éŒ„æ—¥æœŸ</th>
                            <th>éœ‡é¡«</th>
                            <th>åƒµç¡¬</th>
                            <th>é²ç·©</th>
                            <th>å¹³è¡¡</th>
                            <th>å‚™è¨»</th>
                            <th>æ“ä½œ</th>
                          </tr>
                        </thead>
                        <tbody id="health-tbody">
                          <tr><td colspan="8" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                      </table>
                    </div>
                    <div id="health-pagination" class="d-flex justify-content-center gap-2 mt-2"></div>
                  </div>
                </div>
              </div>

              <!-- Donations -->
              <div data-admin-section="donations" style="display:none;">
                <div class="card">
                  <div class="card-header d-flex justify-content-between">
                    <span>ææ¬¾ç®¡ç†</span>
                    <button class="btn btn-primary btn-sm" onclick="admShowAddDonation()">æ–°å¢ææ¬¾</button>
                  </div>
                  <div class="card-body">
                    <div class="row g-2 align-items-end">
                      <div class="col-md-4">
                        <label class="form-label">æœå°‹ææ¬¾äºº</label>
                        <input type="text" id="donation-search" class="form-control" />
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">é¡å‹</label>
                        <select id="donation-type-filter" class="form-select">
                          <option value="">æ‰€æœ‰é¡å‹</option>
                          <option value="ä¸€èˆ¬ææ¬¾">ä¸€èˆ¬ææ¬¾</option>
                          <option value="å®šæœŸææ¬¾">å®šæœŸææ¬¾</option>
                          <option value="æŒ‡å®šç”¨é€”">æŒ‡å®šç”¨é€”</option>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <label class="form-label">èµ·æ—¥</label>
                        <input type="date" id="donation-date-from" class="form-control" />
                      </div>
                      <div class="col-md-2">
                        <label class="form-label">è¿„æ—¥</label>
                        <input type="date" id="donation-date-to" class="form-control" />
                      </div>
                      <div class="col-md-1">
                        <button class="btn btn-outline w-100" onclick="loadDonationsData(1)">æœå°‹</button>
                      </div>
                    </div>

                    <div class="table-responsive mt-3">
                      <table class="table table-hover">
                        <thead class="table-light">
                          <tr>
                            <th>ææ¬¾äºº</th>
                            <th>é‡‘é¡</th>
                            <th>é¡å‹</th>
                            <th>æ—¥æœŸ</th>
                            <th>ä»˜æ¬¾æ–¹å¼</th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                          </tr>
                        </thead>
                        <tbody id="donations-tbody">
                          <tr><td colspan="7" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                      </table>
                    </div>
                    <div id="donations-pagination" class="d-flex justify-content-center gap-2 mt-2"></div>

                    <div class="mt-2 d-flex gap-2">
                      <button class="btn btn-outline" onclick="exportDonationsCSV()">åŒ¯å‡º</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Reports -->
              <div data-admin-section="reports" style="display:none;">
                <div class="card">
                  <div class="card-header d-flex justify-content-between">
                    <span>çµ±è¨ˆå ±è¡¨</span>
                    <button class="btn btn-outline btn-sm" onclick="exportAllReportsZip()">åŒ¯å‡ºå…¨éƒ¨å ±è¡¨</button>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-6 col-lg-3">
                        <div class="p-3 rounded border text-center">
                          <div class="text-muted">æœ¬æœˆæ–°å¢æœƒå“¡</div>
                          <div id="monthly-new-members" class="fs-3 fw-bold">-</div>
                        </div>
                      </div>
                      <div class="col-6 col-lg-3">
                        <div class="p-3 rounded border text-center">
                          <div class="text-muted">æœ¬æœˆæ´»å‹•æ•¸</div>
                          <div id="monthly-events" class="fs-3 fw-bold">-</div>
                        </div>
                      </div>
                      <div class="col-6 col-lg-3">
                        <div class="p-3 rounded border text-center">
                          <div class="text-muted">æœ¬æœˆææ¬¾ç¸½é¡</div>
                          <div id="monthly-donations" class="fs-3 fw-bold">-</div>
                        </div>
                      </div>
                      <div class="col-6 col-lg-3">
                        <div class="p-3 rounded border text-center">
                          <div class="text-muted">æœ¬æœˆå¥åº·è¨˜éŒ„</div>
                          <div id="monthly-health-records" class="fs-3 fw-bold">-</div>
                        </div>
                      </div>
                    </div>
                    <div class="mt-3 text-muted">
                      åœ–è¡¨å€ï¼ˆå¯æ•´åˆæ‚¨çš„åœ–è¡¨å¥—ä»¶ï¼‰ã€‚
                    </div>
                  </div>
                </div>
              </div>

              <!-- Settings -->
              <div data-admin-section="settings" style="display:none;">
                <div class="card">
                  <div class="card-header">ç³»çµ±è¨­å®š</div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">API ç¶²å€</label>
                        <input type="url" id="sys-api-url" class="form-control" placeholder="https://..." />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">ç³»çµ±æ¨™é¡Œ</label>
                        <input type="text" id="sys-title" class="form-control" value="å¸•é‡‘æ£®å”æœƒç®¡ç†ç³»çµ±" />
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">æ¯é ç­†æ•¸</label>
                        <select id="sys-page-size" class="form-select">
                          <option>10</option>
                          <option selected>20</option>
                          <option>50</option>
                          <option>100</option>
                        </select>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">è‡ªå‹•å‚™ä»½é–“éš”(å°æ™‚)</label>
                        <input type="number" id="sys-backup-interval" class="form-control" value="24" min="1" />
                      </div>
                      <div class="col-md-12">
                        <label class="form-label">ç³»çµ±å…¬å‘Š</label>
                        <textarea id="sys-announcement" class="form-control" rows="3"></textarea>
                      </div>
                    </div>
                    <div class="mt-3 d-flex gap-2">
                      <button class="btn btn-primary" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
                      <button class="btn btn-outline" onclick="exportAllDataJSON()">åŒ¯å‡ºè³‡æ–™</button>
                      <button class="btn btn-success" onclick="backupData()">ç«‹å³å‚™ä»½</button>
                      <button class="btn btn-danger" onclick="clearCache()">æ¸…é™¤å¿«å–</button>
                    </div>
                  </div>
                </div>

                <div class="card">
                  <div class="card-header d-flex justify-content-between">
                    <span>ç®¡ç†å“¡å¸³è™Ÿ</span>
                    <button class="btn btn-primary btn-sm" onclick="admShowAddAdmin()">æ–°å¢ç®¡ç†å“¡</button>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table">
                        <thead class="table-light">
                          <tr>
                            <th>åç¨±</th>
                            <th>Email</th>
                            <th>æ¬Šé™</th>
                            <th>æœ€å¾Œç™»å…¥</th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                          </tr>
                        </thead>
                        <tbody id="admins-tbody">
                          <tr>
                            <td>ç³»çµ±ç®¡ç†å“¡</td>
                            <td>admin@parkinson.org.tw</td>
                            <td><span class="status-badge status-danger">è¶…ç´šç®¡ç†å“¡</span></td>
                            <td>â€”</td>
                            <td><span class="status-badge status-success">å·²å•Ÿç”¨</span></td>
                            <td><button class="btn btn-sm btn-outline" onclick="editAdmin('admin1')">ç·¨è¼¯</button></td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

    </div> <!-- /container-inner -->
  </div> <!-- /app-container -->

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ==================== å…¨åŸŸè¨­å®š ====================
    const AppConfig = {
      // é è¨­è®€ localStorage('API_URL')ï¼Œè‹¥ç„¡å‰‡ç©ºå­—ä¸²ï¼Œè«‹åœ¨ç™»å…¥é æˆ–è¨­å®šé æ›´æ–°
      get API_URL() {
        return localStorage.getItem('API_URL') || '';
      },
      set API_URL(v) {
        localStorage.setItem('API_URL', v || '');
      },

      // LIFFï¼šè«‹ä¾éœ€æ±‚çµ±ä¸€æˆ–åˆ†é–‹
      LIFF_ID_GENERAL: '1656516134-X9oq92g9',   // ç™»å…¥é  LIFF (å¯æ²¿ç”¨)
      LIFF_ID_MEMBER: '1656516134-k8rMQwnQ',    // æœƒå“¡ä¸­å¿ƒ LIFF
      LIFF_ID_APP: '1656516134-VaGgmaPm',       // LIFF App ä¸» App
    };

    // è§’è‰²/ç™»å…¥ç‹€æ…‹
    let currentUser = null; // { memberId, name, email, isAdmin, lineUserId? }
    let liffReady = false;
    let selectedMoodScore = 5;
    let selectedTags = [];

    // ==================== å…±ç”¨ UI å·¥å…· ====================
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const colors = { success: '#28a745', error: '#dc3545', warning: '#ffc107', info: '#17a2b8' };
      const icons = { success: 'check-circle-fill', error: 'x-circle-fill', warning: 'exclamation-triangle-fill', info: 'info-circle-fill' };
      const toast = document.createElement('div');
      toast.className = 'toast show';
      toast.style.cssText = 'min-width:260px;margin-bottom:10px;background:#fff;border-left:4px solid '+colors[type]+';box-shadow:0 4px 12px rgba(0,0,0,.15);';
      toast.innerHTML = '<div class="toast-body d-flex align-items-center"><i class="bi bi-'+icons[type]+' me-2" style="color:'+colors[type]+'; font-size:18px;"></i><div class="flex-grow-1" style="font-size:14px;">'+message+'</div><button type="button" class="btn-close ms-2"></button></div>';
      toast.querySelector('.btn-close').addEventListener('click', ()=> toast.remove());
      container.appendChild(toast);
      setTimeout(()=> toast.remove(), 3200);
    }

    function setLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('show', !!show);
    }

    function switchSection(id, btn) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');

      // æ›´æ–°é ‚éƒ¨ nav active
      if (btn) {
        document.querySelectorAll('#globalNav button').forEach(b=> b.classList.remove('active'));
        btn.classList.add('active');
      } else {
        // å°æ‡‰ nav çš„ dataset åˆ¤æ–·
        document.querySelectorAll('#globalNav button').forEach(b=>{
          if (b.dataset.target === id) b.classList.add('active'); else b.classList.remove('active');
        });
      }

      // é€²å…¥é æ™‚è¼‰å…¥è³‡æ–™
      if (id === 'section-member') {
        refreshMemberProfile();
      } else if (id === 'section-admin') {
        adminLoadDashboard();
      } else if (id === 'section-liffApp') {
        initLIFFApp();
      }
    }

    function rebuildGlobalNav() {
      const nav = document.getElementById('globalNav');
      nav.innerHTML = '';
      if (!currentUser) {
        const btn = document.createElement('button');
        btn.className = 'active';
        btn.dataset.target = 'section-auth';
        btn.textContent = 'ç™»å…¥/è¨»å†Š';
        btn.onclick = ()=> switchSection('section-auth', btn);
        nav.appendChild(btn);
        return;
      }
      // æœƒå“¡ä¸­å¿ƒ
      const m = document.createElement('button');
      m.dataset.target = 'section-member';
      m.textContent = 'æœƒå“¡ä¸­å¿ƒ';
      m.onclick = ()=> switchSection('section-member', m);
      nav.appendChild(m);
      // ç®¡ç†å¾Œå°ï¼ˆç®¡ç†å“¡ï¼‰
      if (currentUser.isAdmin) {
        const a = document.createElement('button');
        a.dataset.target = 'section-admin';
        a.textContent = 'ç®¡ç†å¾Œå°';
        a.onclick = ()=> switchSection('section-admin', a);
        nav.appendChild(a);
      }
      // LIFF
      const l = document.createElement('button');
      l.dataset.target = 'section-liffApp';
      l.textContent = 'LIFF App';
      l.onclick = ()=> switchSection('section-liffApp', l);
      nav.appendChild(l);

      // é è¨­é¸æœƒå“¡ä¸­å¿ƒ
      switchSection('section-member', m);
    }

    // ==================== ç™»å…¥/è¨»å†Š ====================
    function switchAuthTab(tab) {
      document.getElementById('tab-login').classList.toggle('active', tab==='login');
      document.getElementById('tab-register').classList.toggle('active', tab==='register');
      document.getElementById('auth-login').style.display = tab==='login' ? '' : 'none';
      document.getElementById('auth-register').style.display = tab==='register' ? '' : 'none';
    }

    function updateAPIUrl() {
      const v = (document.getElementById('api-url-input').value || '').trim();
      if (!v) {
        showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ API ç¶²å€', 'warning');
        return;
      }
      AppConfig.API_URL = v;
      document.getElementById('sys-api-url').value = v; // åŒæ­¥å¾Œå°è¨­å®šé 
      showToast('API ç¶²å€å·²æ›´æ–°', 'success');
    }

    async function testAPIConnection() {
      if (!AppConfig.API_URL) { showToast('å°šæœªè¨­å®š API ç¶²å€', 'warning'); return; }
      setLoading(true);
      try {
        const r = await callAPI({ action: 'test' }, 'GET');
        if (r && r.success) showToast('API é€£ç·šæˆåŠŸ', 'success');
        else showToast('API å›æ‡‰ç•°å¸¸', 'warning');
      } catch(e) {
        showToast('API é€£ç·šå¤±æ•—ï¼š' + (e.message||e), 'error');
      } finally {
        setLoading(false);
      }
    }

    async function handleLogin() {
      if (!AppConfig.API_URL) { showToast('è«‹å…ˆè¨­å®š API ç¶²å€', 'warning'); return; }
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      if (!email || !password) { showToast('è«‹å¡«å¯« Email èˆ‡å¯†ç¢¼', 'warning'); return; }

      setLoading(true);
      try {
        const result = await callAPI({ action: 'login', email, password }, 'GET');
        if (result?.success) {
          currentUser = normalizeLoginUser(result.data);
          postLoginSetup();
          showToast('ç™»å…¥æˆåŠŸ', 'success');
        } else {
          showToast(result?.message || 'ç™»å…¥å¤±æ•—', 'error');
        }
      } catch(e) {
        showToast('ç³»çµ±éŒ¯èª¤ï¼š' + (e.message||e), 'error');
      } finally {
        setLoading(false);
      }
    }

    async function handleLineLogin() {
      try {
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
      } catch(e) {
        // è‹¥ LIFF ç„¡æ³•ä½¿ç”¨ï¼Œä»å¯èµ°å¾Œç«¯ lineLogin by user input
      }
      setLoading(true);
      try {
        let profile = null;
        try {
          await liff.init({ liffId: AppConfig.LIFF_ID_GENERAL });
          if (liff.isLoggedIn()) {
            profile = await liff.getProfile();
          }
        } catch(e) {}
        const payload = {
          action: 'lineLogin',
          lineUserId: profile?.userId || '',
          displayName: profile?.displayName || '',
          pictureUrl: profile?.pictureUrl || ''
        };
        const result = await callAPI(payload, 'GET');
        if (result?.success) {
          currentUser = normalizeLoginUser(result.data);
          postLoginSetup();
          showToast('LINE ç™»å…¥æˆåŠŸ', 'success');
        } else {
          showToast(result?.message || 'LINE ç™»å…¥å¤±æ•—', 'error');
        }
      } catch(e) {
        showToast('LINE ç™»å…¥å¤±æ•—ï¼š' + (e.message||e), 'error');
      } finally {
        setLoading(false);
      }
    }

    async function handleRegister() {
      if (!AppConfig.API_URL) { showToast('è«‹å…ˆè¨­å®š API ç¶²å€', 'warning'); return; }
      const pwd = document.getElementById('reg-password').value;
      const pwd2 = document.getElementById('reg-password-confirm').value;
      if (pwd !== pwd2) { showToast('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´', 'warning'); return; }

      setLoading(true);
      try {
        let lineUserId = '';
        try {
          await liff.init({ liffId: AppConfig.LIFF_ID_GENERAL });
          if (liff.isLoggedIn()) {
            const profile = await liff.getProfile();
            lineUserId = profile.userId || '';
          }
        } catch(e) {}
        const result = await callAPI({
          action: 'register',
          name: document.getElementById('reg-name').value,
          gender: document.getElementById('reg-gender').value,
          birthday: document.getElementById('reg-birthday').value,
          phone: document.getElementById('reg-phone').value,
          email: document.getElementById('reg-email').value,
          password: pwd,
          lineUserId
        }, 'GET');
        if (result?.success) {
          showToast('è¨»å†ŠæˆåŠŸï¼è«‹ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸æˆ–ç›´æ¥ç™»å…¥', 'success');
          switchAuthTab('login');
        } else {
          showToast(result?.message || 'è¨»å†Šå¤±æ•—', 'error');
        }
      } catch(e) {
        showToast('è¨»å†ŠéŒ¯èª¤ï¼š' + (e.message||e), 'error');
      } finally {
        setLoading(false);
      }
    }

    function normalizeLoginUser(data) {
      // çµ±ä¸€ä½¿ç”¨ currentUser æ ¼å¼
      const user = {
        memberId: data.memberId || data.id || '',
        name: data.name || data.realName || data.lineName || 'æœƒå“¡',
        email: data.email || '',
        isAdmin: !!data.isAdmin,
        memberNo: data.memberNo || '',
        lineUserId: data.lineUserId || data.lineId || ''
      };
      // å¯«å…¥ localStorage å…¼å®¹èˆŠå‘½å
      localStorage.setItem('loginInfo', JSON.stringify(user));
      localStorage.setItem('memberInfo', JSON.stringify(user)); // æœƒå“¡ä¸­å¿ƒæ²¿ç”¨
      if (user.isAdmin) localStorage.setItem('adminInfo', JSON.stringify({ name: user.name, email: user.email }));
      return user;
    }

    function postLoginSetup() {
      // å…¨åŸŸé ­åƒèˆ‡åç¨±
      document.getElementById('gUserAvatar').textContent = (currentUser.name||'U').substr(0,1).toUpperCase();
      document.getElementById('gUserName').textContent = currentUser.name || 'æœƒå“¡';

      rebuildGlobalNav();
    }

    function globalLogout() {
      if (!confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) return;
      currentUser = null;
      localStorage.removeItem('loginInfo');
      localStorage.removeItem('memberInfo');
      localStorage.removeItem('adminInfo');
      try { if (liff.isLoggedIn()) liff.logout(); } catch(e){}
      document.getElementById('gUserAvatar').textContent = 'U';
      document.getElementById('gUserName').textContent = 'æœªç™»å…¥';
      rebuildGlobalNav();
      switchSection('section-auth');
      showToast('å·²ç™»å‡º', 'success');
    }

    // ==================== å…±ç”¨ API å‘¼å« ====================
    async function callAPI(params, method = 'POST') {
      const API = AppConfig.API_URL;
      if (!API) throw new Error('æœªè¨­å®š API_URL');
      if (method === 'GET') {
        const usp = new URLSearchParams();
        for (const k in params) {
          usp.append(k, typeof params[k] === 'object' ? JSON.stringify(params[k]) : params[k]);
        }
        const url = API + '?' + usp.toString();
        const r = await fetch(url, { method: 'GET', redirect: 'follow', mode: 'cors' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const t = await r.text();
        return JSON.parse(t);
      } else {
        const r = await fetch(API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(params)
        });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      }
    }

    // ==================== æœƒå“¡ä¸­å¿ƒ ====================
    function showMemberSub(name) {
      document.querySelectorAll('[data-member-sub]').forEach(el => el.style.display = 'none');
      const el = document.querySelector('[data-member-sub="'+name+'"]');
      if (el) {
        el.style.display = '';
        // è¼‰å…¥å°æ‡‰è³‡æ–™
        if (name === 'symptom') loadSymptomHistory();
        if (name === 'medication') { loadMedications(); loadTodayReminders(); }
        if (name === 'events') { loadEvents(); loadMyEvents(); }
        if (name === 'donation') loadDonationHistory();
      }
    }

    async function refreshMemberProfile() {
      const infoBox = document.getElementById('memberProfileInfo');
      if (!currentUser) { infoBox.innerHTML = '<div class="text-muted">å°šæœªç™»å…¥</div>'; return; }
      try {
        const r = await callAPI({ action: 'getMemberInfo', memberId: currentUser.memberId });
        if (r?.success) {
          const d = r.data;
          infoBox.innerHTML = `
            <div class="row g-3">
              <div class="col-md-3"><div class="text-muted">å§“å</div><div class="fw-bold">${d.name||currentUser.name}</div></div>
              <div class="col-md-3"><div class="text-muted">æœƒå“¡ç·¨è™Ÿ</div><div class="fw-bold">${d.memberNo||currentUser.memberNo||'-'}</div></div>
              <div class="col-md-3"><div class="text-muted">Email</div><div class="fw-bold">${d.email||currentUser.email||'-'}</div></div>
              <div class="col-md-3"><div class="text-muted">é›»è©±</div><div class="fw-bold">${d.phone||'-'}</div></div>
            </div>
          `;
        } else {
          infoBox.innerHTML = '<div class="text-muted">è³‡æ–™è¼‰å…¥å¤±æ•—</div>';
        }
      } catch(e) {
        infoBox.innerHTML = '<div class="text-muted">è³‡æ–™è¼‰å…¥éŒ¯èª¤</div>';
      }
    }

    // ç—‡ç‹€
    async function handleAddSymptom(e) {
      e.preventDefault();
      if (!currentUser) return showToast('å°šæœªç™»å…¥','warning');
      const data = {
        action: 'addDailySymptom',
        memberId: currentUser.memberId,
        recordDate: new Date().toISOString().split('T')[0],
        tremorLevel: document.getElementById('tremor-level').value,
        rigidityLevel: document.getElementById('rigidity-level').value,
        bradykinesiaLevel: document.getElementById('bradykinesia-level').value,
        balanceLevel: document.getElementById('balance-level').value,
        notes: document.getElementById('symptom-notes').value
      };
      setLoading(true);
      try {
        const r = await callAPI(data, 'POST');
        if (r?.success) {
          showToast('è¨˜éŒ„æˆåŠŸ','success');
          document.getElementById('symptom-form').reset();
          loadSymptomHistory();
        } else showToast(r?.message || 'è¨˜éŒ„å¤±æ•—','error');
      } catch(e) {
        showToast('ç³»çµ±éŒ¯èª¤','error');
      } finally {
        setLoading(false);
      }
    }

    async function loadSymptomHistory() {
      const box = document.getElementById('symptom-history');
      if (!currentUser) { box.innerHTML = '<div class="text-muted">å°šæœªç™»å…¥</div>'; return; }
      try {
        const endDate = new Date().toISOString().split('T')[0];
        const startDate = new Date(Date.now()-30*24*3600*1000).toISOString().split('T')[0];
        const r = await callAPI({ action: 'getDailySymptoms', memberId: currentUser.memberId, startDate, endDate }, 'POST');
        if (r?.success && r.data?.length) {
          box.innerHTML = r.data.map(sym=> `
            <div class="border rounded p-2 mb-2">
              <div class="fw-bold">${sym.recordDate}</div>
              <div class="text-muted">é¡«æŠ–:${sym.tremorLevel} | åƒµç¡¬:${sym.rigidityLevel} | é²ç·©:${sym.bradykinesiaLevel} | å¹³è¡¡:${sym.balanceLevel}</div>
              ${sym.notes? `<div class="small mt-1">${sym.notes}</div>`:''}
            </div>
          `).join('');
        } else {
          box.innerHTML = '<div class="text-muted">å°šç„¡è¨˜éŒ„</div>';
        }
      } catch(e) {
        box.innerHTML = '<div class="text-muted">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // ç”¨è—¥
    function openAddMedicationModal() {
      const html = `
        <div class="modal fade" id="addMedModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content" id="addMedForm">
              <div class="modal-header">
                <h5 class="modal-title">æ–°å¢ç”¨è—¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="form-group mb-2">
                  <label>è—¥ç‰©åç¨± *</label>
                  <input type="text" class="form-control" id="med-name" required />
                </div>
                <div class="form-group mb-2">
                  <label>åŠ‘é‡</label>
                  <input type="text" class="form-control" id="med-dosage" />
                </div>
                <div class="form-group mb-2">
                  <label>æœç”¨æ™‚é–“ï¼ˆå¯å¤šé¸ï¼‰</label>
                  <div class="d-flex flex-wrap gap-2 mt-1">
                    ${['08:00','12:00','18:00','22:00'].map(t=>`
                      <label class="form-check"><input type="checkbox" class="form-check-input med-time" value="${t}" /> ${t}</label>
                    `).join('')}
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label>é–‹å§‹æ—¥æœŸ</label>
                    <input type="date" id="med-startdate" class="form-control" />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label>æå‰æé†’(åˆ†é˜)</label>
                    <input type="number" id="med-reminder-minutes" class="form-control" value="10" min="0" />
                    <div class="form-check mt-1">
                      <input type="checkbox" id="med-reminder" class="form-check-input" checked />
                      <label class="form-check-label" for="med-reminder">å•Ÿç”¨æé†’</label>
                    </div>
                  </div>
                </div>
                <div class="form-group">
                  <label>å‚™è¨»</label>
                  <textarea id="med-notes" class="form-control" rows="3"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">æ–°å¢</button>
              </div>
            </form>
          </div>
        </div>
      `;
      const container = document.createElement('div');
      container.innerHTML = html;
      document.body.appendChild(container.firstElementChild);
      const modalEl = document.getElementById('addMedModal');
      const modal = new bootstrap.Modal(modalEl);
      modalEl.addEventListener('hidden.bs.modal', ()=> modalEl.remove(), { once:true });
      document.getElementById('addMedForm').addEventListener('submit', handleAddMedication);
      modal.show();
    }

    async function handleAddMedication(e) {
      e.preventDefault();
      if (!currentUser) return showToast('å°šæœªç™»å…¥','warning');
      const times = Array.from(document.querySelectorAll('.med-time:checked')).map(x=>x.value);
      if (!times.length) { showToast('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ™‚é–“','warning'); return; }
      const data = {
        action: 'addMedication',
        memberId: currentUser.memberId,
        medicineName: document.getElementById('med-name').value,
        dosage: document.getElementById('med-dosage').value,
        frequency: JSON.stringify(times),
        startDate: document.getElementById('med-startdate').value || new Date().toISOString().split('T')[0],
        reminderEnabled: document.getElementById('med-reminder').checked,
        reminderMinutes: document.getElementById('med-reminder-minutes').value,
        notes: document.getElementById('med-notes').value
      };
      setLoading(true);
      try {
        const r = await callAPI(data, 'POST');
        if (r?.success) {
          showToast('æ–°å¢æˆåŠŸ','success');
          document.querySelector('#addMedModal .btn-close').click();
          loadMedications();
        } else {
          showToast(r?.message||'æ–°å¢å¤±æ•—','error');
        }
      } catch(e) {
        showToast('ç³»çµ±éŒ¯èª¤','error');
      } finally {
        setLoading(false);
      }
    }

    async function loadMedications() {
      const box = document.getElementById('medication-list');
      if (!currentUser) { box.innerHTML = '<div class="text-muted">å°šæœªç™»å…¥</div>'; return; }
      try {
        const r = await callAPI({ action: 'getMedications', memberId: currentUser.memberId }, 'POST');
        if (r?.success && r.data?.length) {
          box.innerHTML = r.data.map(m=>{
            let times = [];
            try { times = JSON.parse(m.frequency||'[]'); } catch(e){}
            return `
              <div class="border rounded p-2 mb-2 d-flex align-items-center justify-content-between">
                <div>
                  <div class="fw-bold">${m.medicineName}</div>
                  <div class="text-muted small">${m.dosage||''} ${times.length? (' | ' + times.join(', ')) : ''}</div>
                </div>
                <span class="status-badge status-success">ä½¿ç”¨ä¸­</span>
              </div>
            `;
          }).join('');
        } else {
          box.innerHTML = '<div class="text-muted">å°šæœªæ–°å¢ç”¨è—¥</div>';
        }
      } catch(e) {
        box.innerHTML = '<div class="text-muted">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function loadTodayReminders() {
      const box = document.getElementById('today-reminders');
      if (!currentUser) { box.innerHTML = '<div class="text-muted">å°šæœªç™»å…¥</div>'; return; }
      try {
        const r = await callAPI({ action: 'getMedications', memberId: currentUser.memberId }, 'POST');
        if (r?.success && r.data?.length) {
          let html = '';
          r.data.forEach(m=>{
            let times = [];
            try { times = JSON.parse(m.frequency||'[]'); } catch(e){}
            times.forEach(t=>{
              html += `
                <div class="border rounded p-2 mb-2 d-flex align-items-center justify-content-between">
                  <div>
                    <div class="fw-bold">ğŸ’Š ${m.medicineName}</div>
                    <div class="text-muted small">${t} - ${m.dosage||''}</div>
                  </div>
                  <button class="btn btn-sm btn-outline" onclick="logMedication('${m.medicationId}','${t}')">å·²æœç”¨</button>
                </div>
              `;
            });
          });
          box.innerHTML = html || '<div class="text-muted">ä»Šå¤©æ²’æœ‰æé†’</div>';
        } else {
          box.innerHTML = '<div class="text-muted">ä»Šå¤©æ²’æœ‰æé†’</div>';
        }
      } catch(e) {
        box.innerHTML = '<div class="text-muted">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function logMedication(medicationId, scheduledTime) {
      if (!currentUser) return showToast('å°šæœªç™»å…¥','warning');
      try {
        const r = await callAPI({ action: 'logMedication', medicationId, memberId: currentUser.memberId, scheduledTime, status: 'å·²æœç”¨' }, 'POST');
        if (r?.success) {
          showToast('å·²è¨˜éŒ„æœè—¥','success');
          loadTodayReminders();
        } else showToast(r?.message||'è¨˜éŒ„å¤±æ•—','error');
      } catch(e) {
        showToast('ç³»çµ±éŒ¯èª¤','error');
      }
    }

    // é‹å‹•
    async function handleAddExercise(e) {
      e.preventDefault();
      if (!currentUser) return showToast('å°šæœªç™»å…¥','warning');
      const data = {
        action: 'addExerciseLog',
        memberId: currentUser.memberId,
        exerciseDate: new Date().toISOString().split('T')[0],
        exerciseType: document.getElementById('exercise-type').value,
        duration: document.getElementById('exercise-duration').value,
        intensity: document.getElementById('exercise-intensity').value,
        bodyCondition: document.getElementById('exercise-condition').value,
        notes: document.getElementById('exercise-notes').value
      };
      setLoading(true);
      try {
        const r = await callAPI(data, 'POST');
        if (r?.success) showToast('è¨˜éŒ„æˆåŠŸ','success');
        else showToast(r?.message||'è¨˜éŒ„å¤±æ•—','error');
        document.getElementById('exercise-form').reset();
      } catch(e) {
        showToast('ç³»çµ±éŒ¯èª¤','error');
      } finally {
        setLoading(false);
      }
    }

    // ç¡çœ 
    async function handleAddSleep(e) {
      e.preventDefault();
      if (!currentUser) return showToast('å°šæœªç™»å…¥','warning');
      const bedtime = document.getElementById('sleep-bedtime').value;
      const waketime = document.getElementById('sleep-waketime').value;
      const bed = new Date('2000-01-01 '+bedtime);
      let wake = new Date('2000-01-01 '+waketime);
      if (wake < bed) wake.setDate(wake.getDate()+1);
      const duration = (wake - bed) / 3600000;
      const data = {
        action: 'addSleepLog',
        memberId: currentUser.memberId,
        sleepDate: new Date().toISOString().split('T')[0],
        bedtime,
        wakeTime: waketime,
        duration: duration.toFixed(1),
        quality: document.getElementById('sleep-quality').value,
        wakeCount: document.getElementById('sleep-wakecount').value,
        hasDream: document.getElementById('sleep-hasdream').checked,
        hasNightmare: document.getElementById('sleep-hasnightmare').checked,
        notes: document.getElementById('sleep-notes').value
      };
      setLoading(true);
      try {
        const r = await callAPI(data, 'POST');
        if (r?.success) showToast('è¨˜éŒ„æˆåŠŸ','success');
        else showToast(r?.message||'è¨˜éŒ„å¤±æ•—','error');
        document.getElementById('sleep-form').reset();
      } catch(e) {
        showToast('ç³»çµ±éŒ¯èª¤','error');
      } finally {
        setLoading(false);
      }
    }

    // æƒ…ç·’
    function selectMood(score) {
      selectedMoodScore = score;
      document.getElementById('mood-score').value = score;
      showToast('å¿ƒæƒ…åˆ†æ•¸ï¼š'+score, 'info');
    }
    function toggleTag(el) {
      el.classList.toggle('bg-primary');
      el.classList.toggle('text-white');
    }
    async function handleAddMood() {
      if (!currentUser) return showToast('å°šæœªç™»å…¥','warning');
      const tags = Array.from(document.querySelectorAll('#mood-tags .bg-primary')).map(x=> x.textContent.trim());
      const data = {
        action: 'addMoodDiary',
        memberId: currentUser.memberId,
        diaryDate: new Date().toISOString().split('T')[0],
        moodScore: selectedMoodScore,
        moodTags: tags.join(','),
        content: document.getElementById('mood-content').value
      };
      setLoading(true);
      try {
        const r = await callAPI(data, 'POST');
        if (r?.success) {
          showToast('æ—¥è¨˜å·²å„²å­˜','success');
          document.getElementById('mood-content').value = '';
          document.querySelectorAll('#mood-tags .bg-primary').forEach(x=>{
            x.classList.remove('bg-primary','text-white');
            x.classList.add('bg-light','text-dark');
          });
        } else showToast(r?.message||'å„²å­˜å¤±æ•—','error');
      } catch(e) {
        showToast('ç³»çµ±éŒ¯èª¤','error');
      } finally {
        setLoading(false);
      }
    }

    // æ´»å‹•èˆ‡å ±åï¼ˆæœƒå“¡è¦–è§’ï¼‰
    async function loadEvents() {
      const box = document.getElementById('events-list');
      try {
        const today = new Date().toISOString().split('T')[0];
        const r = await callAPI({ action: 'getEvents', status: 'å ±åä¸­', startDate: today }, 'POST');
        if (r?.success && r.data?.length) {
          box.innerHTML = r.data.map(ev=>{
            const isFull = (ev.registrationCount||0) >= (ev.maxParticipants||0);
            return `
              <div class="border rounded p-2 mb-2 d-flex align-items-center justify-content-between">
                <div>
                  <div class="fw-bold">${ev.eventName}</div>
                  <div class="text-muted small">ğŸ“… ${ev.eventDate} ${ev.startTime||''} | ğŸ“ ${ev.location||''}</div>
                </div>
                <span class="status-badge ${isFull?'status-danger':'status-info'}">${isFull?'å·²é¡æ»¿':'å ±åä¸­'}</span>
              </div>
            `;
          }).join('');
        } else {
          box.innerHTML = '<div class="text-muted">ç›®å‰æ²’æœ‰æ´»å‹•</div>';
        }
      } catch(e) {
        box.innerHTML = '<div class="text-muted">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function loadMyEvents() {
      const box = document.getElementById('my-events-list');
      if (!currentUser) { box.innerHTML = '<div class="text-muted">å°šæœªç™»å…¥</div>'; return; }
      try {
        const r = await callAPI({ action: 'getMyEvents', memberId: currentUser.memberId }, 'POST');
        if (r?.success && r.data?.length) {
          box.innerHTML = r.data.map(ev=>{
            let cls = 'status-info';
            if (ev.registrationStatus==='å·²ç¢ºèª') cls='status-success';
            else if (ev.registrationStatus==='å€™è£œ') cls='status-warning';
            else if (ev.registrationStatus==='å·²å–æ¶ˆ') cls='status-danger';
            return `
              <div class="border rounded p-2 mb-2 d-flex align-items-center justify-content-between">
                <div>
                  <div class="fw-bold">${ev.eventName}</div>
                  <div class="text-muted small">ğŸ“… ${ev.eventDate} ${ev.startTime||''} | ğŸ“ ${ev.location||''}</div>
                </div>
                <span class="status-badge ${cls}">${ev.registrationStatus}</span>
              </div>
            `;
          }).join('');
        } else {
          box.innerHTML = '<div class="text-muted">å°šæœªå ±åæ´»å‹•</div>';
        }
      } catch(e) {
        box.innerHTML = '<div class="text-muted">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function loadDonationHistory() {
      const box = document.getElementById('donation-history');
      if (!currentUser) { box.innerHTML = '<div class="text-muted">å°šæœªç™»å…¥</div>'; return; }
      try {
        const r = await callAPI({ action: 'getDonations', memberId: currentUser.memberId }, 'POST');
        if (r?.success && r.data?.donations?.length) {
          let html = `
            <div class="p-2 rounded border mb-2">
              <div class="text-muted small">ç´¯è¨ˆææ¬¾</div>
              <div class="fs-4 fw-bold text-primary">NT$ ${(r.data.totalAmount||0).toLocaleString()}</div>
            </div>
          `;
          html += r.data.donations.map(d=>`
            <div class="border rounded p-2 mb-2 d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-bold">NT$ ${Number(d.amount||0).toLocaleString()}</div>
                <div class="text-muted small">${d.donationDate||''} | ${d.purpose||'ä¸€èˆ¬ææ¬¾'}</div>
              </div>
              ${d.receiptIssued? '<span class="status-badge status-success">å·²é–‹ç«‹æ”¶æ“š</span>':''}
            </div>
          `).join('');
          box.innerHTML = html;
        } else {
          box.innerHTML = '<div class="text-muted">å°šç„¡ææ¬¾è¨˜éŒ„</div>';
        }
      } catch(e) {
        box.innerHTML = '<div class="text-muted">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // ==================== LIFF Appï¼ˆç²¾ç°¡æ•´åˆï¼‰ ====================
    async function initLIFFApp() {
      // é¡¯ç¤ºä½¿ç”¨è€…åŸºæœ¬è³‡è¨Šï¼ˆè‹¥å·²ç™»å…¥ LINEï¼‰
      try {
        await liff.init({ liffId: AppConfig.LIFF_ID_APP });
        liffReady = true;
      } catch(e) {
        liffReady = false;
      }

      let profile = null;
      if (liffReady && liff.isLoggedIn()) {
        try { profile = await liff.getProfile(); } catch(e){}
      }
      document.getElementById('liffUserAvatar').src = profile?.pictureUrl || 'https://via.placeholder.com/48';
      document.getElementById('liffUserName').textContent = profile?.displayName || (currentUser?.name || 'è¨ªå®¢');
      document.getElementById('liffUserId').textContent = profile?.userId || (currentUser?.lineUserId || '-');
      document.getElementById('liffRoleBadge').textContent = currentUser?.isAdmin ? 'ç®¡ç†å“¡' : 'æœƒå“¡';
      document.getElementById('liffAdminBtn').style.display = currentUser?.isAdmin ? '' : 'none';

      // è¼‰å…¥å„€è¡¨æ¿è³‡æ–™ï¼ˆæ²¿ç”¨ getDashboardDataï¼‰
      try {
        const res = await callAPI({ action: 'getDashboardData', lineId: profile?.userId || '' }, 'POST');
        if (res?.success) {
          const d = res.data || {};
          document.getElementById('statActivities').textContent = d.totalActivities || 0;
          document.getElementById('statRegistrations').textContent = d.myRegistrations || 0;
          document.getElementById('statVolunteerHours').textContent = d.myVolunteerHours || 0;
          document.getElementById('statDonations').textContent = '$' + (Number(d.myDonationAmount||0).toLocaleString());
          renderRecentActivities(d.recentActivity || []);
        } else {
          renderRecentActivities([]);
        }
      } catch(e) {
        renderRecentActivities([]);
      }
    }

    function renderRecentActivities(activities) {
      const box = document.getElementById('recentActivities');
      if (!activities || !activities.length) {
        box.innerHTML = '<div class="text-muted">ç›®å‰æ²’æœ‰æ´»å‹•</div>';
        return;
      }
      box.innerHTML = activities.slice(0,3).map(a=>`
        <div class="border rounded p-2 mb-2">
          <div class="fw-bold">${a.title}</div>
          <div class="text-muted small">${a.description||''}</div>
          <div class="small">ğŸ“… ${formatDate(a.date)} <span class="ms-2 status-badge">${a.status}</span></div>
        </div>
      `).join('');
    }

    function formatDate(x) {
      if (!x) return '-';
      const d = new Date(x);
      if (isNaN(d.getTime())) return '-';
      return d.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    async function liffLoadActivities() {
      const area = document.getElementById('liffDynamicArea');
      area.innerHTML = '<div class="text-muted">è¼‰å…¥ä¸­...</div>';
      try {
        const r = await callAPI({ action: 'getActivities' }, 'POST');
        if (r?.success && r.data?.length) {
          const open = r.data.filter(a=> a.status==='é–‹æ”¾å ±å' || a.status==='å ±åä¸­');
          area.innerHTML = open.map(a=>`
            <div class="border rounded p-2 mb-2">
              <div class="d-flex justify-content-between">
                <div class="fw-bold">${a.title||a.eventName}</div>
                <span class="status-badge status-info">${a.status}</span>
              </div>
              <div class="text-muted small">${a.description||''}</div>
              <div class="small">ğŸ“… ${formatDate(a.date||a.eventDate)} ${a.time||a.startTime||''} ï½œ ğŸ“ ${a.location||'æœªæŒ‡å®š'}</div>
              <div class="small mt-1">ğŸ‘¥ ${(a.currentCount||a.registrationCount)||0}/${a.maxParticipants||'-'} ${a.fee? 'ï½œ ğŸ’° $'+Number(a.fee).toLocaleString():''}</div>
              <button class="btn btn-sm btn-primary mt-2" onclick="liffRegisterActivity('${a.id||a.eventId}')">æˆ‘è¦å ±å</button>
            </div>
          `).join('');
        } else {
          area.innerHTML = '<div class="text-muted">ç›®å‰ç„¡é–‹æ”¾å ±åæ´»å‹•</div>';
        }
      } catch(e) {
        area.innerHTML = '<div class="text-muted">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function liffRegisterActivity(id) {
      if (!currentUser) return showToast('è«‹å…ˆç™»å…¥','warning');
      if (!confirm('ç¢ºå®šè¦å ±åæ­¤æ´»å‹•å—ï¼Ÿ')) return;
      setLoading(true);
      try {
        await callAPI({ action: 'registerActivity', activityId: id, lineId: currentUser.lineUserId||'' }, 'POST');
        showToast('å ±åæˆåŠŸ','success');
        liffLoadActivities();
      } catch(e) {
        showToast('å ±åå¤±æ•—ï¼š'+(e.message||e),'error');
      } finally {
        setLoading(false);
      }
    }

    async function liffLoadMyRegistrations() {
      const area = document.getElementById('liffDynamicArea');
      if (!currentUser) return area.innerHTML = '<div class="text-muted">è«‹å…ˆç™»å…¥</div>';
      area.innerHTML = '<div class="text-muted">è¼‰å…¥ä¸­...</div>';
      try {
        const r = await callAPI({ action: 'getMyRegistrations', lineId: currentUser.lineUserId||'' }, 'POST');
        if (r?.success && r.data?.length) {
          area.innerHTML = r.data.map(reg=>`
            <div class="border rounded p-2 mb-2 d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-bold">${reg.activityTitle}</div>
                <div class="small text-muted">å ±åæ™‚é–“ï¼š${formatDate(reg.registrationTime)}</div>
              </div>
              <div>
                <span class="status-badge">${reg.status}</span>
                ${reg.status==='å·²å ±å' ? `<button class="btn btn-sm btn-outline ms-2" onclick="liffCancelRegistration('${reg.id}')">å–æ¶ˆ</button>`:''}
              </div>
            </div>
          `).join('');
        } else {
          area.innerHTML = '<div class="text-muted">ç›®å‰æ²’æœ‰å ±å</div>';
        }
      } catch(e) {
        area.innerHTML = '<div class="text-muted">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function liffCancelRegistration(id) {
      if (!confirm('ç¢ºå®šå–æ¶ˆï¼Ÿ')) return;
      setLoading(true);
      try {
        await callAPI({ action: 'cancelRegistration', registrationId: id }, 'POST');
        showToast('å·²å–æ¶ˆ','success');
        liffLoadMyRegistrations();
      } catch(e) {
        showToast('å–æ¶ˆå¤±æ•—ï¼š'+(e.message||e),'error');
      } finally {
        setLoading(false);
      }
    }

    async function liffLoadVolunteer() {
      const area = document.getElementById('liffDynamicArea');
      area.innerHTML = '<div class="text-muted">è¼‰å…¥ä¸­...</div>';
      try {
        const r = await callAPI({ action: 'getVolunteerData', lineId: currentUser?.lineUserId||'' }, 'POST');
        const d = r?.data || {};
        const stats = d.stats || {};
        const needs = d.needs || [];
        const records = d.records || [];
        area.innerHTML = `
          <div class="row g-2">
            <div class="col-6">
              <div class="border rounded p-2 text-center">
                <div class="text-muted small">ç´¯è¨ˆæ™‚æ•¸</div>
                <div class="fs-4 fw-bold">${stats.totalHours||0}</div>
              </div>
            </div>
            <div class="col-6">
              <div class="border rounded p-2 text-center">
                <div class="text-muted small">æœå‹™æ¬¡æ•¸</div>
                <div class="fs-4 fw-bold">${stats.totalActivities||0}</div>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <h6>å¿—å·¥éœ€æ±‚</h6>
            ${needs.length? needs.map(n=>`
              <div class="border rounded p-2 mb-2">
                <div class="fw-bold">${n.title}</div>
                <div class="small text-muted">ğŸ“… ${formatDate(n.date)} ${n.time||''} ï½œ éœ€æ±‚ï¼š${n.needCount}äºº ï½œ æ™‚æ•¸ï¼š${n.hours}å°æ™‚</div>
                <div class="small">å·²å ±åï¼š${n.currentCount||0}äºº</div>
                <button class="btn btn-sm btn-primary mt-2" onclick="liffApplyVolunteer('${n.id}')">æˆ‘è¦å ±å</button>
              </div>
            `).join('') : '<div class="text-muted">ç›®å‰æ²’æœ‰å¿—å·¥éœ€æ±‚</div>'}
          </div>
          <div class="mt-3">
            <h6>æˆ‘çš„è¨˜éŒ„</h6>
            ${records.length? records.map(r=>`
              <div class="border rounded p-2 mb-2 d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-bold">${r.title}</div>
                  <div class="small text-muted">ğŸ“… ${formatDate(r.date)} ï½œ ${r.hours} å°æ™‚</div>
                </div>
                <span class="status-badge">${r.status}</span>
              </div>
            `).join('') : '<div class="text-muted">å°šç„¡è¨˜éŒ„</div>'}
          </div>
        `;
      } catch(e) {
        area.innerHTML = '<div class="text-muted">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function liffApplyVolunteer(id) {
      if (!currentUser) return showToast('è«‹å…ˆç™»å…¥','warning');
      if (!confirm('ç¢ºå®šè¦å ±åæ­¤å¿—å·¥æœå‹™ï¼Ÿ')) return;
      setLoading(true);
      try {
        await callAPI({ action: 'applyVolunteer', needId: id, lineId: currentUser.lineUserId||'' }, 'POST');
        showToast('å ±åæˆåŠŸ','success');
        liffLoadVolunteer();
      } catch(e) {
        showToast('å ±åå¤±æ•—ï¼š'+(e.message||e),'error');
      } finally {
        setLoading(false);
      }
    }

    async function liffLoadFinance() {
      const area = document.getElementById('liffDynamicArea');
      area.innerHTML = '<div class="text-muted">è¼‰å…¥ä¸­...</div>';
      try {
        const r = await callAPI({ action: 'getFinanceData', lineId: currentUser?.lineUserId||'' }, 'POST');
        const d = r?.data || {};
        const donations = d.donations || [];
        const expenses = d.expenses || [];
        const total = d.stats?.totalDonation || 0;
        const pending = d.stats?.pendingExpenses || 0;
        area.innerHTML = `
          <div class="row g-2">
            <div class="col-6"><div class="border rounded p-2 text-center"><div class="text-muted">ç´¯è¨ˆææ¬¾</div><div class="fs-5 fw-bold">NT$ ${Number(total).toLocaleString()}</div></div></div>
            <div class="col-6"><div class="border rounded p-2 text-center"><div class="text-muted">å¾…å¯©æ ¸æ”¯å‡º</div><div class="fs-5 fw-bold">${pending}</div></div></div>
          </div>
          <div class="mt-2 d-flex gap-2">
            <button class="btn btn-primary btn-sm" onclick="liffOpenDonation()">æˆ‘è¦ææ¬¾</button>
            <button class="btn btn-outline btn-sm" onclick="liffOpenExpense()">æ”¯å‡ºç”³è«‹</button>
          </div>
          <div class="mt-3">
            <h6>æˆ‘çš„ææ¬¾</h6>
            ${donations.length? donations.map(d=>`
              <div class="border rounded p-2 mb-2 d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-bold">NT$ ${Number(d.amount||0).toLocaleString()}</div>
                  <div class="text-muted small">${d.category||'ä¸€èˆ¬ææ¬¾'} ï½œ ${formatDate(d.createdAt)}</div>
                </div>
                <span class="status-badge">${d.status}</span>
              </div>
            `).join('') : '<div class="text-muted">å°šç„¡ææ¬¾è¨˜éŒ„</div>'}
          </div>
          <div class="mt-3">
            <h6>æˆ‘çš„æ”¯å‡º</h6>
            ${expenses.length? expenses.map(e=>`
              <div class="border rounded p-2 mb-2 d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-bold">NT$ ${Number(e.amount||0).toLocaleString()}</div>
                  <div class="text-muted small">${e.category||''} ï½œ ${formatDate(e.createdAt)}</div>
                </div>
                <span class="status-badge">${e.status}</span>
              </div>
            `).join('') : '<div class="text-muted">å°šç„¡æ”¯å‡ºç”³è«‹</div>'}
          </div>
        `;
      } catch(e) {
        area.innerHTML = '<div class="text-muted">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    function liffOpenDonation() {
      const html = `
        <div class="modal fade" id="donationModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content" id="donationForm">
              <div class="modal-header">
                <h5 class="modal-title">æˆ‘è¦ææ¬¾</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="form-group mb-2">
                  <label>é‡‘é¡ *</label>
                  <input type="number" id="don-amount" class="form-control" min="1" required />
                </div>
                <div class="form-group mb-2">
                  <label>é¡åˆ¥</label>
                  <select id="don-category" class="form-select">
                    <option value="ä¸€èˆ¬ææ¬¾">ä¸€èˆ¬ææ¬¾</option>
                    <option value="æ´»å‹•è´ŠåŠ©">æ´»å‹•è´ŠåŠ©</option>
                  </select>
                </div>
                <div class="form-group mb-2">
                  <label>èªªæ˜</label>
                  <textarea id="don-desc" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-check">
                  <input type="checkbox" id="don-receipt" class="form-check-input" />
                  <label class="form-check-label" for="don-receipt">éœ€è¦æ”¶æ“š</label>
                </div>
                <div class="alert alert-info small mt-2">è‹¥æœªå¡« Emailï¼Œæ”¶æ“šåƒ…æä¾› PDF ä¸‹è¼‰ï¼Œä¸æœƒå¯„é€ Emailã€‚</div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ç¢ºèª</button>
              </div>
            </form>
          </div>
        </div>
      `;
      const wrap = document.createElement('div'); wrap.innerHTML = html; document.body.appendChild(wrap.firstElementChild);
      const modalEl = document.getElementById('donationModal'); const modal = new bootstrap.Modal(modalEl);
      modalEl.addEventListener('hidden.bs.modal', ()=> modalEl.remove(), { once:true });
      document.getElementById('donationForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!currentUser) return showToast('å°šæœªç™»å…¥','warning');
        const payload = {
          action: 'createDonation',
          amount: document.getElementById('don-amount').value,
          category: document.getElementById('don-category').value,
          description: document.getElementById('don-desc').value,
          needReceipt: document.getElementById('don-receipt').checked
        };
        setLoading(true);
        try {
          const r = await callAPI(payload, 'POST');
          if (r?.success) {
            showToast('ææ¬¾å·²æ–°å¢ï¼Œæ„Ÿè¬æ”¯æŒï¼','success');
            modal.hide();
            liffLoadFinance();
          } else showToast(r?.message||'æ–°å¢å¤±æ•—','error');
        } catch(e) {
          showToast('ç³»çµ±éŒ¯èª¤','error');
        } finally {
          setLoading(false);
        }
      });
      modal.show();
    }

    function liffOpenExpense() {
      const html = `
        <div class="modal fade" id="expenseModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content" id="expenseForm">
              <div class="modal-header">
                <h5 class="modal-title">æ”¯å‡ºç”³è«‹</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="form-group mb-2">
                  <label>é‡‘é¡ *</label>
                  <input type="number" id="exp-amount" class="form-control" min="1" required />
                </div>
                <div class="form-group mb-2">
                  <label>é¡åˆ¥ *</label>
                  <select id="exp-category" class="form-select" required>
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="æ´»å‹•è²»ç”¨">æ´»å‹•è²»ç”¨</option>
                    <option value="è¡Œæ”¿æ”¯å‡º">è¡Œæ”¿æ”¯å‡º</option>
                    <option value="è¨­å‚™æ”¯å‡º">è¨­å‚™æ”¯å‡º</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>èªªæ˜ *</label>
                  <textarea id="exp-desc" class="form-control" rows="3" required></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">é€å‡º</button>
              </div>
            </form>
          </div>
        </div>
      `;
      const wrap = document.createElement('div'); wrap.innerHTML = html; document.body.appendChild(wrap.firstElementChild);
      const modalEl = document.getElementById('expenseModal'); const modal = new bootstrap.Modal(modalEl);
      modalEl.addEventListener('hidden.bs.modal', ()=> modalEl.remove(), { once:true });
      document.getElementById('expenseForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!currentUser) return showToast('å°šæœªç™»å…¥','warning');
        const payload = {
          action: 'createExpense',
          amount: document.getElementById('exp-amount').value,
          category: document.getElementById('exp-category').value,
          description: document.getElementById('exp-desc').value
        };
        setLoading(true);
        try {
          const r = await callAPI(payload, 'POST');
          if (r?.success) {
            showToast('æ”¯å‡ºç”³è«‹å·²é€å‡º','success');
            modal.hide();
            liffLoadFinance();
          } else showToast(r?.message||'ç”³è«‹å¤±æ•—','error');
        } catch(e) {
          showToast('ç³»çµ±éŒ¯èª¤','error');
        } finally {
          setLoading(false);
        }
      });
      modal.show();
    }

    async function liffLoadProfile() {
      const area = document.getElementById('liffDynamicArea');
      if (!currentUser) return area.innerHTML = '<div class="text-muted">è«‹å…ˆç™»å…¥</div>';
      area.innerHTML = '<div class="text-muted">è¼‰å…¥ä¸­...</div>';
      try {
        const r = await callAPI({ action: 'getUserInfo', lineId: currentUser.lineUserId||'' }, 'POST');
        const p = r?.data || {};
        area.innerHTML = `
          <div class="border rounded p-2 mb-2"><div class="text-muted small">çœŸå¯¦å§“å</div><div class="fw-bold">${p.realName||currentUser.name}</div></div>
          <div class="border rounded p-2 mb-2"><div class="text-muted small">æœƒå“¡é¡å‹</div><div class="fw-bold">${p.memberType||'-'}</div></div>
          <div class="border rounded p-2 mb-2"><div class="text-muted small">Email</div><div class="fw-bold">${p.email||currentUser.email||'-'}</div></div>
          <div class="border rounded p-2 mb-2"><div class="text-muted small">é›»è©±</div><div class="fw-bold">${p.phone||'-'}</div></div>
          <button class="btn btn-outline btn-sm" onclick="showToast('è«‹è‡³æœƒå“¡ä¸­å¿ƒä¿®æ”¹å€‹è³‡','info')">ä¿®æ”¹è³‡æ–™</button>
        `;
      } catch(e) {
        area.innerHTML = '<div class="text-muted">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    async function liffLoadAdmin() {
      if (!currentUser?.isAdmin) return showToast('ä½ æ²’æœ‰ç®¡ç†å“¡æ¬Šé™','warning');
      showToast('è«‹ä½¿ç”¨ã€Œç®¡ç†å¾Œå°ã€é é¢é€²è¡Œç®¡ç†','info');
    }

    function goLIFFApp() {
      switchSection('section-liffApp');
    }

    // ==================== ç®¡ç†å¾Œå° ====================
    function adminShow(section, anchor) {
      document.querySelectorAll('.sidebar .menu a').forEach(a=> a.classList.remove('active'));
      anchor.classList.add('active');
      document.getElementById('adminTitle').textContent = {
        'dashboard':'ç³»çµ±ç¸½è¦½','members':'æœƒå“¡ç®¡ç†','events':'æ´»å‹•ç®¡ç†','health':'å¥åº·è¨˜éŒ„','donations':'ææ¬¾ç®¡ç†','reports':'çµ±è¨ˆå ±è¡¨','settings':'ç³»çµ±è¨­å®š'
      }[section] || 'ç®¡ç†';
      document.querySelectorAll('[data-admin-section]').forEach(s=> s.style.display='none');
      document.querySelector('[data-admin-section="'+section+'"]').style.display = '';
      // è¼‰å…¥è³‡æ–™
      if (section==='dashboard') adminLoadDashboard();
      if (section==='members') loadMembersData(1);
      if (section==='events') loadEventsData(1);
      if (section==='health') loadHealthData(1);
      if (section==='donations') loadDonationsData(1);
      if (section==='reports') loadReportsData();
      if (section==='settings') adminLoadSettings();
    }

    async function adminLoadDashboard() {
      document.getElementById('adminAvatarTxt').textContent = (currentUser?.name||'A').substr(0,1).toUpperCase();
      document.getElementById('adminNameTxt').textContent = currentUser?.name || 'ç®¡ç†å“¡';
      try {
        const [m, e, d, act] = await Promise.all([
          callAPI({ action: 'getStats', type: 'members' }, 'GET'),
          callAPI({ action: 'getStats', type: 'events' }, 'GET'),
          callAPI({ action: 'getStats', type: 'donations' }, 'GET'),
          callAPI({ action: 'getRecentActivities' }, 'GET')
        ]);
        if (m?.success) {
          document.getElementById('adm-total-members').textContent = m.data.total || 0;
          document.getElementById('adm-active-members').textContent = m.data.active || 0;
        }
        if (e?.success) document.getElementById('adm-total-events').textContent = e.data.total || 0;
        if (d?.success) document.getElementById('adm-total-donations').textContent = 'NT$ ' + Number(d.data.total||0).toLocaleString();
        const ra = document.getElementById('adm-recent-activities');
        if (act?.success && act.data?.length) {
          ra.innerHTML = act.data.map(a=>`
            <div class="border-bottom py-2 small d-flex justify-content-between">
              <div><strong>${a.type}</strong> <span class="text-muted">- ${a.description||''}</span></div>
              <div class="text-muted">${a.timestamp||''}</div>
            </div>
          `).join('');
        } else {
          ra.innerHTML = '<div class="text-muted">æš«ç„¡å‹•æ…‹</div>';
        }
      } catch(e) {
        showAdminAlert('è¼‰å…¥ç¸½è¦½è³‡æ–™å¤±æ•—ï¼š'+(e.message||e), 'warning');
      }
    }

    function showAdminAlert(msg, type='info') {
      const box = document.getElementById('admin-alert');
      box.textContent = msg;
      box.className = 'alert alert-'+type;
      box.classList.remove('d-none');
      setTimeout(()=> box.classList.add('d-none'), 4000);
    }

    let pageSize = parseInt(localStorage.getItem('admin_page_size')||'20',10);

    // Members
    async function loadMembersData(page=1) {
      const tbody = document.getElementById('members-tbody');
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>';
      try {
        const search = document.getElementById('member-search').value || '';
        const status = document.getElementById('member-status-filter').value || '';
        const r = await callAPI({ action: 'getMembers', page, pageSize, search, status }, 'GET');
        if (r?.success && r.data?.length) {
          tbody.innerHTML = r.data.map(m=>`
            <tr>
              <td>${m.memberNo||'-'}</td>
              <td>${m.name||'-'}</td>
              <td>${m.email||'-'}</td>
              <td>${m.phone||'-'}</td>
              <td>${m.registerDate||'-'}</td>
              <td><span class="status-badge ${statusClass(m.status)}">${m.status||'-'}</span></td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="viewMember('${m.memberId}')">æŸ¥çœ‹</button>
                <button class="btn btn-sm btn-outline" onclick="editMember('${m.memberId}')">ç·¨è¼¯</button>
                <button class="btn btn-sm btn-danger" onclick="deleteMember('${m.memberId}')">åˆªé™¤</button>
              </td>
            </tr>
          `).join('');
          updatePagination('members', r.totalPages||1, page);
        } else {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">æ²’æœ‰è³‡æ–™</td></tr>';
          updatePagination('members', 1, 1);
        }
      } catch(e) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">è¼‰å…¥å¤±æ•—</td></tr>';
      }
    }

    // Events
    async function loadEventsData(page=1) {
      const tbody = document.getElementById('events-tbody');
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>';
      try {
        const search = document.getElementById('event-search').value || '';
        const status = document.getElementById('event-status-filter').value || '';
        const r = await callAPI({ action: 'getEvents', page, pageSize, search, status }, 'GET');
        if (r?.success && r.data?.length) {
          tbody.innerHTML = r.data.map(ev=>`
            <tr>
              <td>${ev.eventName||'-'}</td>
              <td>${ev.eventDate||'-'} ${ev.startTime||''}</td>
              <td>${ev.location||'-'}</td>
              <td>${(ev.registrationCount||0)}/${ev.maxParticipants||0}</td>
              <td><span class="status-badge ${statusClass(ev.status)}">${ev.status||'-'}</span></td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="viewEvent('${ev.eventId}')">æŸ¥çœ‹</button>
                <button class="btn btn-sm btn-outline" onclick="editEvent('${ev.eventId}')">ç·¨è¼¯</button>
                <button class="btn btn-sm btn-danger" onclick="deleteEvent('${ev.eventId}')">åˆªé™¤</button>
              </td>
            </tr>
          `).join('');
          updatePagination('events', r.totalPages||1, page);
        } else {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">æ²’æœ‰è³‡æ–™</td></tr>';
          updatePagination('events',1,1);
        }
      } catch(e) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">è¼‰å…¥å¤±æ•—</td></tr>';
      }
    }

    // Health
    async function loadHealthData(page=1) {
      const tbody = document.getElementById('health-tbody');
      tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>';
      try {
        const search = document.getElementById('health-search').value || '';
        const dateFrom = document.getElementById('health-date-from').value || '';
        const dateTo = document.getElementById('health-date-to').value || '';
        const r = await callAPI({ action: 'getAllHealthRecords', page, pageSize, search, dateFrom, dateTo }, 'GET');
        if (r?.success && r.data?.length) {
          tbody.innerHTML = r.data.map(rec=>`
            <tr>
              <td>${rec.memberName||'-'}</td>
              <td>${rec.recordDate||'-'}</td>
              <td>${rec.tremorLevel||0}</td>
              <td>${rec.rigidityLevel||0}</td>
              <td>${rec.bradykinesiaLevel||0}</td>
              <td>${rec.balanceLevel||0}</td>
              <td>${rec.notes||'-'}</td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="viewHealthRecord('${rec.recordId}')">æŸ¥çœ‹</button>
                <button class="btn btn-sm btn-danger" onclick="deleteHealthRecord('${rec.recordId}')">åˆªé™¤</button>
              </td>
            </tr>
          `).join('');
          updatePagination('health', r.totalPages||1, page);
        } else {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æ²’æœ‰è³‡æ–™</td></tr>';
          updatePagination('health',1,1);
        }
      } catch(e) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">è¼‰å…¥å¤±æ•—</td></tr>';
      }
    }

    // Donations
    async function loadDonationsData(page=1) {
      const tbody = document.getElementById('donations-tbody');
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>';
      try {
        const search = document.getElementById('donation-search').value || '';
        const type = document.getElementById('donation-type-filter').value || '';
        const dateFrom = document.getElementById('donation-date-from').value || '';
        const dateTo = document.getElementById('donation-date-to').value || '';
        const r = await callAPI({ action: 'getDonations', page, pageSize, search, type, dateFrom, dateTo }, 'GET');
        if (r?.success && r.data?.length) {
          tbody.innerHTML = r.data.map(d=>`
            <tr>
              <td>${d.donorName||'-'}</td>
              <td>NT$ ${Number(d.amount||0).toLocaleString()}</td>
              <td>${d.donationType||'-'}</td>
              <td>${d.donationDate||'-'}</td>
              <td>${d.paymentMethod||'-'}</td>
              <td><span class="status-badge ${statusClass(d.status)}">${d.status||'-'}</span></td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="viewDonation('${d.donationId}')">æŸ¥çœ‹</button>
                <button class="btn btn-sm btn-outline" onclick="editDonation('${d.donationId}')">ç·¨è¼¯</button>
                <button class="btn btn-sm btn-danger" onclick="deleteDonation('${d.donationId}')">åˆªé™¤</button>
              </td>
            </tr>
          `).join('');
          updatePagination('donations', r.totalPages||1, page);
        } else {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">æ²’æœ‰è³‡æ–™</td></tr>';
          updatePagination('donations',1,1);
        }
      } catch(e) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">è¼‰å…¥å¤±æ•—</td></tr>';
      }
    }

    // Reports
    async function loadReportsData() {
      try {
        const [m, y] = await Promise.all([
          callAPI({ action: 'getMonthlyStats' }, 'GET'),
          callAPI({ action: 'getYearlyTrends' }, 'GET')
        ]);
        if (m?.success) {
          const d = m.data || {};
          document.getElementById('monthly-new-members').textContent = d.newMembers||0;
          document.getElementById('monthly-events').textContent = d.events||0;
          document.getElementById('monthly-donations').textContent = 'NT$ ' + Number(d.donations||0).toLocaleString();
          document.getElementById('monthly-health-records').textContent = d.healthRecords||0;
        }
      } catch(e) {
        showAdminAlert('è¼‰å…¥å ±è¡¨è³‡æ–™å¤±æ•—','warning');
      }
    }

    // Admin è¨­å®š
    function adminLoadSettings() {
      document.getElementById('sys-api-url').value = AppConfig.API_URL || '';
      document.getElementById('sys-title').value = localStorage.getItem('admin_system_title') || 'å¸•é‡‘æ£®å”æœƒç®¡ç†ç³»çµ±';
      document.getElementById('sys-page-size').value = localStorage.getItem('admin_page_size') || '20';
      document.getElementById('sys-backup-interval').value = localStorage.getItem('admin_backup_interval') || '24';
      document.getElementById('sys-announcement').value = localStorage.getItem('admin_system_announcement') || '';
    }
    function saveSettings() {
      const api = document.getElementById('sys-api-url').value;
      AppConfig.API_URL = api;
      localStorage.setItem('admin_system_title', document.getElementById('sys-title').value);
      localStorage.setItem('admin_page_size', document.getElementById('sys-page-size').value);
      localStorage.setItem('admin_backup_interval', document.getElementById('sys-backup-interval').value);
      localStorage.setItem('admin_system_announcement', document.getElementById('sys-announcement').value);
      pageSize = parseInt(localStorage.getItem('admin_page_size')||'20',10);
      showAdminAlert('è¨­å®šå·²å„²å­˜','success');
    }
    async function exportAllDataJSON() {
      try {
        const r = await callAPI({ action: 'exportAllData' }, 'GET');
        if (r?.success) {
          const blob = new Blob([r.data], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `ç³»çµ±è³‡æ–™å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
          a.click();
        } else showAdminAlert('åŒ¯å‡ºå¤±æ•—','warning');
      } catch(e) {
        showAdminAlert('åŒ¯å‡ºå¤±æ•—ï¼š'+(e.message||e),'warning');
      }
    }
    async function backupData() {
      try {
        const r = await callAPI({ action: 'backupData' }, 'GET');
        if (r?.success) showAdminAlert('å‚™ä»½æˆåŠŸ','success');
        else showAdminAlert('å‚™ä»½å¤±æ•—','warning');
      } catch(e) {
        showAdminAlert('å‚™ä»½å¤±æ•—','warning');
      }
    }
    function clearCache() {
      if (!confirm('ç¢ºå®šæ¸…é™¤å¿«å–ï¼Ÿ')) return;
      const adminInfo = localStorage.getItem('adminInfo');
      localStorage.clear();
      if (adminInfo) localStorage.setItem('adminInfo', adminInfo);
      showAdminAlert('å¿«å–å·²æ¸…é™¤','success');
      adminLoadSettings();
    }

    // åŒ¯å‡º
    async function exportMembersCSV() {
      try {
        const r = await callAPI({ action: 'exportMembers' }, 'GET');
        if (r?.success) {
          const blob = new Blob([r.data], { type: 'text/csv;charset=utf-8;' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `æœƒå“¡è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
          showAdminAlert('æœƒå“¡è³‡æ–™åŒ¯å‡ºæˆåŠŸ','success');
        } else showAdminAlert('åŒ¯å‡ºå¤±æ•—','warning');
      } catch(e) {
        showAdminAlert('åŒ¯å‡ºå¤±æ•—','warning');
      }
    }
    async function exportDonationsCSV() {
      try {
        const r = await callAPI({ action: 'exportDonations' }, 'GET');
        if (r?.success) {
          const blob = new Blob([r.data], { type: 'text/csv;charset=utf-8;' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `ææ¬¾è¨˜éŒ„_${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
          showAdminAlert('ææ¬¾åŒ¯å‡ºæˆåŠŸ','success');
        } else showAdminAlert('åŒ¯å‡ºå¤±æ•—','warning');
      } catch(e) {
        showAdminAlert('åŒ¯å‡ºå¤±æ•—','warning');
      }
    }
    async function exportAllReportsZip() {
      try {
        const r = await callAPI({ action: 'exportAllReports' }, 'GET');
        if (r?.success) {
          const blob = new Blob([r.data], { type: 'application/zip' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `çµ±è¨ˆå ±è¡¨_${new Date().toISOString().split('T')[0]}.zip`;
          a.click();
          showAdminAlert('å ±è¡¨åŒ¯å‡ºæˆåŠŸ','success');
        } else showAdminAlert('åŒ¯å‡ºå¤±æ•—','warning');
      } catch(e) {
        showAdminAlert('åŒ¯å‡ºå¤±æ•—','warning');
      }
    }

    // åˆ†é æ§åˆ¶
    function updatePagination(section, totalPages, currentPage) {
      const id = section+'-pagination';
      const box = document.getElementById(id);
      if (!box) return;
      let html = '';
      const prev = Math.max(1, currentPage-1);
      const next = Math.min(totalPages, currentPage+1);
      html += `<button class="btn btn-sm btn-outline" ${currentPage<=1?'disabled':''} onclick="loadPage('${section}', ${prev})">ä¸Šä¸€é </button>`;
      const start = Math.max(1, currentPage-2);
      const end = Math.min(totalPages, currentPage+2);
      for (let i=start;i<=end;i++) {
        html += `<button class="btn btn-sm ${i===currentPage?'btn-primary':'btn-outline'}" onclick="loadPage('${section}', ${i})">${i}</button>`;
      }
      html += `<button class="btn btn-sm btn-outline" ${currentPage>=totalPages?'disabled':''} onclick="loadPage('${section}', ${next})">ä¸‹ä¸€é </button>`;
      box.innerHTML = html;
    }
    function loadPage(section, page) {
      if (section==='members') loadMembersData(page);
      if (section==='events') loadEventsData(page);
      if (section==='health') loadHealthData(page);
      if (section==='donations') loadDonationsData(page);
    }

    function statusClass(s) {
      const m = {
        'å·²å¯©æ ¸':'status-success','å¾…å¯©æ ¸':'status-warning','å·²åœç”¨':'status-danger',
        'å ±åä¸­':'status-info','å·²é¡æ»¿':'status-warning','å·²çµæŸ':'','å·²å–æ¶ˆ':'status-danger',
        'å·²å®Œæˆ':'status-success','è™•ç†ä¸­':'status-warning','å·²å•Ÿç”¨':'status-success'
      };
      return m[s] || '';
    }

    // å¾Œå°ï¼šæ–°å¢é …ç›®çš„ Modalï¼ˆåƒ…å±•ç¤ºéª¨æ¶ï¼‰
    function admShowAddMember() { showToast('æ–°å¢æœƒå“¡åŠŸèƒ½å¯ä¾éœ€è¦æ“´å……','info'); }
    function admShowAddEvent() { showToast('æ–°å¢æ´»å‹•åŠŸèƒ½å¯ä¾éœ€è¦æ“´å……','info'); }
    function admShowAddDonation() { showToast('æ–°å¢ææ¬¾åŠŸèƒ½å¯ä¾éœ€è¦æ“´å……','info'); }
    function admShowAddAdmin() { showToast('æ–°å¢ç®¡ç†å“¡åŠŸèƒ½å¯ä¾éœ€è¦æ“´å……','info'); }
    function viewMember(id){ showToast('æŸ¥çœ‹æœƒå“¡ '+id+'ï¼ˆé–‹ç™¼ä¸­ï¼‰','info'); }
    function editMember(id){ showToast('ç·¨è¼¯æœƒå“¡ '+id+'ï¼ˆé–‹ç™¼ä¸­ï¼‰','info'); }
    async function deleteMember(id){
      if (!confirm('ç¢ºå®šåˆªé™¤æœƒå“¡ï¼Ÿ')) return;
      try {
        const r = await callAPI({ action: 'deleteMember', memberId: id }, 'GET');
        if (r?.success) { showAdminAlert('åˆªé™¤æˆåŠŸ','success'); loadMembersData(1); }
        else showAdminAlert('åˆªé™¤å¤±æ•—','warning');
      } catch(e) { showAdminAlert('åˆªé™¤å¤±æ•—','warning'); }
    }
    function viewEvent(id){ showToast('æŸ¥çœ‹æ´»å‹• '+id+'ï¼ˆé–‹ç™¼ä¸­ï¼‰','info'); }
    function editEvent(id){ showToast('ç·¨è¼¯æ´»å‹• '+id+'ï¼ˆé–‹ç™¼ä¸­ï¼‰','info'); }
    async function deleteEvent(id){
      if (!confirm('ç¢ºå®šåˆªé™¤æ´»å‹•ï¼Ÿ')) return;
      try {
        const r = await callAPI({ action: 'deleteEvent', eventId: id }, 'GET');
        if (r?.success) { showAdminAlert('åˆªé™¤æˆåŠŸ','success'); loadEventsData(1); }
        else showAdminAlert('åˆªé™¤å¤±æ•—','warning');
      } catch(e) { showAdminAlert('åˆªé™¤å¤±æ•—','warning'); }
    }
    function viewHealthRecord(id){ showToast('æŸ¥çœ‹å¥åº·è¨˜éŒ„ '+id+'ï¼ˆé–‹ç™¼ä¸­ï¼‰','info'); }
    async function deleteHealthRecord(id){
      if (!confirm('ç¢ºå®šåˆªé™¤å¥åº·è¨˜éŒ„ï¼Ÿ')) return;
      try {
        const r = await callAPI({ action: 'deleteHealthRecord', recordId: id }, 'GET');
        if (r?.success) { showAdminAlert('åˆªé™¤æˆåŠŸ','success'); loadHealthData(1); }
        else showAdminAlert('åˆªé™¤å¤±æ•—','warning');
      } catch(e) { showAdminAlert('åˆªé™¤å¤±æ•—','warning'); }
    }
    function viewDonation(id){ showToast('æŸ¥çœ‹ææ¬¾ '+id+'ï¼ˆé–‹ç™¼ä¸­ï¼‰','info'); }
    function editDonation(id){ showToast('ç·¨è¼¯ææ¬¾ '+id+'ï¼ˆé–‹ç™¼ä¸­ï¼‰','info'); }
    async function deleteDonation(id){
      if (!confirm('ç¢ºå®šåˆªé™¤ææ¬¾ï¼Ÿ')) return;
      try {
        const r = await callAPI({ action: 'deleteDonation', donationId: id }, 'GET');
        if (r?.success) { showAdminAlert('åˆªé™¤æˆåŠŸ','success'); loadDonationsData(1); }
        else showAdminAlert('åˆªé™¤å¤±æ•—','warning');
      } catch(e) { showAdminAlert('åˆªé™¤å¤±æ•—','warning'); }
    }
    function editAdmin(id){ showToast('ç·¨è¼¯ç®¡ç†å“¡ '+id+'ï¼ˆé–‹ç™¼ä¸­ï¼‰','info'); }

    // ==================== å•Ÿå‹• ====================
    (function init() {
      // å¸¶å…¥ API URL
      document.getElementById('api-url-input').value = AppConfig.API_URL || '';
      // å˜—è©¦è®€å–ç™»å…¥ç‹€æ…‹
      const saved = localStorage.getItem('loginInfo');
      if (saved) {
        try {
          currentUser = JSON.parse(saved);
          postLoginSetup();
        } catch(e){}
      }
    })();

    // å°èˆªå¿«æ·
    window.addEventListener('keydown', (e)=>{
      if (e.ctrlKey && e.key === 's') {
        if (document.getElementById('section-admin').classList.contains('active')) {
          e.preventDefault(); saveSettings();
        }
      }
    });
  </script>
</body>
</html>
