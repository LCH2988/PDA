<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帕金森病友權益促進會</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            flex-direction: column;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4285f4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e9ecef;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 80px;
        }

        .nav-tab.active {
            background: #4285f4;
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #f8f9fa;
        }

        .nav-tab i {
            display: block;
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .nav-tab span {
            font-size: 0.8rem;
        }

        /* Content */
        .content {
            padding: 1rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-header i {
            font-size: 1.5rem;
            margin-right: 0.75rem;
            color: #4285f4;
        }

        .card-header h3 {
            font-size: 1.2rem;
            color: #333;
        }

        .card-content {
            color: #666;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #4285f4;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-align: center;
            margin: 0.25rem;
        }

        .btn:hover {
            background: #3367d6;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #34a853;
        }

        .btn-success:hover {
            background: #2d8f47;
        }

        .btn-warning {
            background: #fbbc04;
            color: #333;
        }

        .btn-warning:hover {
            background: #f9ab00;
        }

        .btn-danger {
            background: #ea4335;
        }

        .btn-danger:hover {
            background: #d33b2c;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #4285f4;
            color: #4285f4;
        }

        .btn-outline:hover {
            background: #4285f4;
            color: white;
        }

        .btn-full {
            width: 100%;
            margin: 0.5rem 0;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        /* Activity Cards */
        .activity-card {
            border-left: 4px solid #4285f4;
            position: relative;
            overflow: hidden;
        }

        .activity-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #4285f4, #34a853);
            opacity: 0.1;
            border-radius: 0 12px 0 60px;
        }

        .activity-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1rem 0;
            font-size: 0.9rem;
            color: #666;
        }

        .activity-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .activity-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-upcoming {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-ongoing {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-completed {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }

        /* Member Profile */
        .profile-header {
            text-align: center;
            padding: 2rem 1rem;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            margin: -1rem -1.5rem 2rem -1.5rem;
            border-radius: 0 0 20px 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .profile-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .profile-info-item {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .profile-info-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4285f4;
            display: block;
        }

        .profile-info-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-top: 4px solid #4285f4;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4285f4;
            display: block;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        /* Notifications */
        .notification-item {
            display: flex;
            align-items: flex-start;
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }

        .notification-item:hover {
            background: #f8f9fa;
        }

        .notification-item.unread {
            background: #e3f2fd;
            border-left: 4px solid #4285f4;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .notification-icon.system {
            background: #e3f2fd;
            color: #4285f4;
        }

        .notification-icon.activity {
            background: #e8f5e8;
            color: #34a853;
        }

        .notification-icon.finance {
            background: #fff3e0;
            color: #fbbc04;
        }

        .notification-icon.emergency {
            background: #ffebee;
            color: #ea4335;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: #333;
        }

        .notification-text {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        .notification-time {
            font-size: 0.8rem;
            color: #999;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #666;
        }

        .empty-state i {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .modal-close:hover {
            background: #f0f0f0;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.3rem;
            }

            .nav-tab {
                padding: 0.75rem 0.5rem;
            }

            .nav-tab i {
                font-size: 1rem;
            }

            .nav-tab span {
                font-size: 0.7rem;
            }

            .card {
                padding: 1rem;
            }

            .profile-info {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }
        }

        /* Utilities */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .d-none { display: none; }
        .d-block { display: block; }
        .d-flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .text-muted { color: #666; }
        .text-primary { color: #4285f4; }
        .text-success { color: #34a853; }
        .text-warning { color: #fbbc04; }
        .text-danger { color: #ea4335; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>帕金森病友權益促進會</h1>
            <p>關懷每一位病友，共創美好未來</p>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>載入中...</p>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="d-none">
            <!-- Navigation -->
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="home">
                    <i class="fas fa-home"></i>
                    <span>首頁</span>
                </button>
                <button class="nav-tab" data-tab="profile">
                    <i class="fas fa-user"></i>
                    <span>個人</span>
                </button>
                <button class="nav-tab" data-tab="activities">
                    <i class="fas fa-calendar"></i>
                    <span>活動</span>
                </button>
                <button class="nav-tab" data-tab="notifications">
                    <i class="fas fa-bell"></i>
                    <span>通知</span>
                </button>
                <button class="nav-tab" data-tab="settings">
                    <i class="fas fa-cog"></i>
                    <span>設定</span>
                </button>
            </div>

            <!-- Content -->
            <div class="content">
                <!-- Home Tab -->
                <div id="homeTab" class="tab-content active">
                    <div class="stats-grid" id="homeStats">
                        <!-- Statistics will be loaded here -->
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-bullhorn"></i>
                            <h3>最新公告</h3>
                        </div>
                        <div class="card-content" id="latestAnnouncements">
                            <!-- Announcements will be loaded here -->
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-calendar-alt"></i>
                            <h3>即將舉行的活動</h3>
                        </div>
                        <div class="card-content" id="upcomingActivities">
                            <!-- Upcoming activities will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Profile Tab -->
                <div id="profileTab" class="tab-content">
                    <div id="memberProfile">
                        <!-- Member profile will be loaded here -->
                    </div>
                </div>

                <!-- Activities Tab -->
                <div id="activitiesTab" class="tab-content">
                    <div class="d-flex justify-between align-center mb-2">
                        <h2>活動列表</h2>
                        <select id="activityFilter" class="form-control form-select" style="width: auto;">
                            <option value="all">全部活動</option>
                            <option value="upcoming">即將舉行</option>
                            <option value="ongoing">進行中</option>
                            <option value="completed">已完成</option>
                        </select>
                    </div>
                    <div id="activitiesList">
                        <!-- Activities list will be loaded here -->
                    </div>
                </div>

                <!-- Notifications Tab -->
                <div id="notificationsTab" class="tab-content">
                    <div class="d-flex justify-between align-center mb-2">
                        <h2>通知中心</h2>
                        <button id="markAllReadBtn" class="btn btn-outline">全部已讀</button>
                    </div>
                    <div id="notificationsList">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-bell"></i>
                            <h3>通知設定</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="emailNotifications"> 
                                    接收電子郵件通知
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="lineNotifications"> 
                                    接收 LINE 通知
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="activityReminders"> 
                                    活動提醒通知
                                </label>
                            </div>
                            <button id="saveNotificationSettings" class="btn btn-success btn-full">
                                儲存設定
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-shield-alt"></i>
                            <h3>隱私設定</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="profileVisibility"> 
                                    公開個人資料
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="activityVisibility"> 
                                    公開參與活動
                                </label>
                            </div>
                            <button id="savePrivacySettings" class="btn btn-success btn-full">
                                儲存設定
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-info-circle"></i>
                            <h3>關於應用程式</h3>
                        </div>
                        <div class="card-content">
                            <p><strong>版本：</strong>1.0.0</p>
                            <p><strong>更新日期：</strong>2024年12月</p>
                            <p class="text-muted">帕金森病友權益促進會官方應用程式</p>
                            <button id="contactSupport" class="btn btn-outline btn-full mt-2">
                                聯絡客服
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <!-- Activity Detail Modal -->
        <div id="activityModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">活動詳情</h3>
                    <button class="modal-close" onclick="closeModal('activityModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="activityModalContent">
                    <!-- Activity details will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Profile Edit Modal -->
        <div id="profileModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">編輯個人資料</h3>
                    <button class="modal-close" onclick="closeModal('profileModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="profileModalContent">
                    <form id="profileForm">
                        <div class="form-group">
                            <label class="form-label">姓名</label>
                            <input type="text" id="profileName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">電子郵件</label>
                            <input type="email" id="profileEmail" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">電話</label>
                            <input type="tel" id="profilePhone" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">地址</label>
                            <textarea id="profileAddress" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="d-flex justify-between">
                            <button type="button" class="btn btn-outline" onclick="closeModal('profileModal')">
                                取消
                            </button>
                            <button type="submit" class="btn btn-success">
                                儲存
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let liffId = '1656516134-X9oq92g9'; // 請替換為實際的 LIFF ID
        let gasApiUrl = 'https://script.google.com/macros/s/AKfycbyO01xgnsIz6IVWy9ZJH4ZUZpLc0FJKkQFlwdDPvMa7t5HBE8A-o1SqYH-lwm-ahZgE/exec'; // 請替換為實際的 GAS API URL
        let currentUser = null;
        let currentMember = null;

        // Initialize LIFF
        async function initializeLiff() {
            try {
                await liff.init({ liffId: liffId });
                
                if (liff.isLoggedIn()) {
                    currentUser = await liff.getProfile();
                    await loadMemberData();
                    await loadInitialData();
                    showMainContent();
                } else {
                    liff.login();
                }
            } catch (error) {
                console.error('LIFF initialization failed:', error);
                showError('初始化失敗，請重新整理頁面');
            }
        }

        // Load member data
        async function loadMemberData() {
            try {
                const response = await fetch(`${gasApiUrl}?action=getMemberByLineId&lineId=${currentUser.userId}`);
                const result = await response.json();
                
                if (result.success) {
                    currentMember = result.member;
                } else {
                    // Not a member yet, show registration option
                    showRegistrationPrompt();
                }
            } catch (error) {
                console.error('Failed to load member data:', error);
            }
        }

        // Load initial data
        async function loadInitialData() {
            await Promise.all([
                loadHomeData(),
                loadProfileData(),
                loadActivitiesData(),
                loadNotificationsData(),
                loadSettingsData()
            ]);
        }

        // Show main content
        function showMainContent() {
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('mainContent').classList.remove('d-none');
        }

        // Show error
        function showError(message) {
            document.getElementById('loading').innerHTML = `
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    ${message}
                </div>
            `;
        }

        // Show registration prompt
        function showRegistrationPrompt() {
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="content">
                    <div class="card text-center">
                        <div class="card-content">
                            <i class="fas fa-user-plus" style="font-size: 3rem; color: #4285f4; margin-bottom: 1rem;"></i>
                            <h3>歡迎加入帕金森病友權益促進會</h3>
                            <p class="text-muted mb-3">請先完成會員註冊，即可使用所有功能</p>
                            <button onclick="startRegistration()" class="btn btn-success btn-full">
                                <i class="fas fa-user-plus"></i> 立即註冊
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Start registration
        function startRegistration() {
            const registrationForm = `
                <div class="content">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-user-plus"></i>
                            <h3>會員註冊</h3>
                        </div>
                        <div class="card-content">
                            <form id="registrationForm">
                                <div class="form-group">
                                    <label class="form-label">姓名 *</label>
                                    <input type="text" id="regName" class="form-control" required 
                                           value="${currentUser.displayName || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">電子郵件 *</label>
                                    <input type="email" id="regEmail" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">電話</label>
                                    <input type="tel" id="regPhone" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">出生日期</label>
                                    <input type="date" id="regBirthDate" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">地址</label>
                                    <textarea id="regAddress" class="form-control" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        <input type="checkbox" id="agreeTerms" required>
                                        我同意<a href="#" onclick="showTerms()">服務條款</a>和<a href="#" onclick="showPrivacy()">隱私政策</a>
                                    </label>
                                </div>
                                <button type="submit" class="btn btn-success btn-full">
                                    提交註冊申請
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = registrationForm;
            
            // Handle registration form submission
            document.getElementById('registrationForm').addEventListener('submit', handleRegistration);
        }

        // Handle registration
        async function handleRegistration(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('regName').value,
                email: document.getElementById('regEmail').value,
                phone: document.getElementById('regPhone').value,
                birthDate: document.getElementById('regBirthDate').value,
                address: document.getElementById('regAddress').value,
                lineId: currentUser.userId,
                lineDisplayName: currentUser.displayName
            };
            
            try {
                const response = await fetch(gasApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'registerMember',
                        data: formData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('註冊申請已提交，請等待審核通過', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showAlert(result.error || '註冊失敗，請稍後再試', 'error');
                }
            } catch (error) {
                console.error('Registration failed:', error);
                showAlert('註冊過程發生錯誤，請稍後再試', 'error');
            }
        }

        // Load home data
        async function loadHomeData() {
            try {
                // Load statistics
                const statsResponse = await fetch(`${gasApiUrl}?action=getHomeStats`);
                const statsResult = await statsResponse.json();
                
                if (statsResult.success) {
                    renderHomeStats(statsResult.stats);
                }
                
                // Load announcements
                const announcementsResponse = await fetch(`${gasApiUrl}?action=getAnnouncements&limit=3`);
                const announcementsResult = await announcementsResponse.json();
                
                if (announcementsResult.success) {
                    renderAnnouncements(announcementsResult.announcements);
                }
                
                // Load upcoming activities
                const activitiesResponse = await fetch(`${gasApiUrl}?action=getActivities&upcoming=true&limit=3`);
                const activitiesResult = await activitiesResponse.json();
                
                if (activitiesResult.success) {
                    renderUpcomingActivities(activitiesResult.activities);
                }
            } catch (error) {
                console.error('Failed to load home data:', error);
            }
        }

        // Render home statistics
        function renderHomeStats(stats) {
            const statsHtml = `
                <div class="stat-card">
                    <span class="stat-value">${stats.totalMembers || 0}</span>
                    <div class="stat-label">總會員數</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value">${stats.upcomingActivities || 0}</span>
                    <div class="stat-label">即將舉行</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value">${stats.thisMonthActivities || 0}</span>
                    <div class="stat-label">本月活動</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value">${stats.activeMembers || 0}</span>
                    <div class="stat-label">活躍會員</div>
                </div>
            `;
            
            document.getElementById('homeStats').innerHTML = statsHtml;
        }

        // Render announcements
        function renderAnnouncements(announcements) {
            if (!announcements || announcements.length === 0) {
                document.getElementById('latestAnnouncements').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bullhorn"></i>
                        <h3>暫無公告</h3>
                        <p>目前沒有最新公告</p>
                    </div>
                `;
                return;
            }
            
            const announcementsHtml = announcements.map(announcement => `
                <div class="notification-item">
                    <div class="notification-icon system">
                        <i class="fas fa-bullhorn"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${announcement.title}</div>
                        <div class="notification-text">${announcement.content}</div>
                        <div class="notification-time">${formatDate(announcement.date)}</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('latestAnnouncements').innerHTML = announcementsHtml;
        }

        // Render upcoming activities
        function renderUpcomingActivities(activities) {
            if (!activities || activities.length === 0) {
                document.getElementById('upcomingActivities').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar"></i>
                        <h3>暫無活動</h3>
                        <p>目前沒有即將舉行的活動</p>
                    </div>
                `;
                return;
            }
            
            const activitiesHtml = activities.map(activity => `
                <div class="activity-card card" onclick="showActivityDetail('${activity.id}')">
                    <h4>${activity.title}</h4>
                    <div class="activity-meta">
                        <div class="activity-meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>${formatDateTime(activity.startTime)}</span>
                        </div>
                        <div class="activity-meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${activity.location}</span>
                        </div>
                        <div class="activity-meta-item">
                            <i class="fas fa-users"></i>
                            <span>${activity.currentParticipants}/${activity.maxParticipants || '不限'}</span>
                        </div>
                    </div>
                    <p class="text-muted">${activity.description}</p>
                    <div class="mt-2">
                        <span class="activity-status status-upcoming">即將舉行</span>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('upcomingActivities').innerHTML = activitiesHtml;
        }

        // Load profile data
        async function loadProfileData() {
            if (!currentMember) return;
            
            try {
                const response = await fetch(`${gasApiUrl}?action=getMemberProfile&memberId=${currentMember.id}`);
                const result = await response.json();
                
                if (result.success) {
                    renderMemberProfile(result.profile);
                }
            } catch (error) {
                console.error('Failed to load profile data:', error);
            }
        }

        // Render member profile
        function renderMemberProfile(profile) {
            const profileHtml = `
                <div class="card">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <h2>${profile.name}</h2>
                        <p>會員編號：${profile.memberId}</p>
                    </div>
                    
                    <div class="profile-info">
                        <div class="profile-info-item">
                            <span class="profile-info-value">${profile.joinedActivities || 0}</span>
                            <div class="profile-info-label">參與活動</div>
                        </div>
                        <div class="profile-info-item">
                            <span class="profile-info-value">${calculateMembershipDays(profile.registrationDate)}</span>
                            <div class="profile-info-label">加入天數</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-info-circle"></i>
                            <h3>基本資料</h3>
                        </div>
                        <div class="card-content">
                            <p><strong>電子郵件：</strong>${profile.email}</p>
                            <p><strong>電話：</strong>${profile.phone || '未設定'}</p>
                            <p><strong>地址：</strong>${profile.address || '未設定'}</p>
                            <p><strong>註冊日期：</strong>${formatDate(profile.registrationDate)}</p>
                            <p><strong>會員狀態：</strong>
                                <span class="activity-status ${profile.status === 'active' ? 'status-ongoing' : 'status-upcoming'}">
                                    ${profile.status === 'active' ? '正常' : '待審核'}
                                </span>
                            </p>
                            <button onclick="editProfile()" class="btn btn-outline btn-full mt-2">
                                <i class="fas fa-edit"></i> 編輯資料
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line"></i>
                            <h3>活動參與記錄</h3>
                        </div>
                        <div class="card-content" id="activityHistory">
                            <!-- Activity history will be loaded here -->
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('memberProfile').innerHTML = profileHtml;
            
            // Load activity history
            loadActivityHistory();
        }

        // Load activity history
        async function loadActivityHistory() {
            if (!currentMember) return;
            
            try {
                const response = await fetch(`${gasApiUrl}?action=getMemberActivityHistory&memberId=${currentMember.id}`);
                const result = await response.json();
                
                if (result.success && result.activities.length > 0) {
                    const historyHtml = result.activities.map(activity => `
                        <div class="notification-item">
                            <div class="notification-icon activity">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="notification-content">
                                <div class="notification-title">${activity.title}</div>
                                <div class="notification-text">${formatDateTime(activity.startTime)} - ${activity.location}</div>
                                <div class="notification-time">
                                    <span class="activity-status ${getActivityStatusClass(activity.status)}">
                                        ${getActivityStatusText(activity.status)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('activityHistory').innerHTML = historyHtml;
                } else {
                    document.getElementById('activityHistory').innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar"></i>
                            <h3>暫無參與記錄</h3>
                            <p>您還沒有參與任何活動</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load activity history:', error);
            }
        }

        // Load activities data
        async function loadActivitiesData() {
            try {
                const response = await fetch(`${gasApiUrl}?action=getActivities&pageSize=20`);
                const result = await response.json();
                
                if (result.success) {
                    renderActivitiesList(result.activities);
                }
            } catch (error) {
                console.error('Failed to load activities data:', error);
            }
        }

        // Render activities list
        function renderActivitiesList(activities) {
            if (!activities || activities.length === 0) {
                document.getElementById('activitiesList').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar"></i>
                        <h3>暫無活動</h3>
                        <p>目前沒有活動</p>
                    </div>
                `;
                return;
            }
            
            const activitiesHtml = activities.map(activity => `
                <div class="activity-card card" onclick="showActivityDetail('${activity.id}')">
                    <div class="d-flex justify-between align-center mb-2">
                        <h4>${activity.title}</h4>
                        <span class="activity-status ${getActivityStatusClass(activity.status)}">
                            ${getActivityStatusText(activity.status)}
                        </span>
                    </div>
                    
                    <div class="activity-meta">
                        <div class="activity-meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>${formatDateTime(activity.startTime)}</span>
                        </div>
                        <div class="activity-meta-item">
                            <i class="fas fa-clock"></i>
                            <span>${activity.duration || '2小時'}</span>
                        </div>
                        <div class="activity-meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${activity.location}</span>
                        </div>
                        <div class="activity-meta-item">
                            <i class="fas fa-users"></i>
                            <span>${activity.currentParticipants}/${activity.maxParticipants || '不限'}</span>
                        </div>
                    </div>
                    
                    <p class="text-muted mb-2">${activity.description}</p>
                    
                    <div class="d-flex justify-between align-center">
                        <div class="text-muted">
                            <i class="fas fa-user"></i> ${activity.organizer || '協會'}
                        </div>
                        <div>
                            ${activity.isJoined ? 
                                '<span class="text-success"><i class="fas fa-check"></i> 已報名</span>' : 
                                '<span class="text-primary"><i class="fas fa-plus"></i> 可報名</span>'
                            }
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('activitiesList').innerHTML = activitiesHtml;
        }

        // Load notifications data
        async function loadNotificationsData() {
            if (!currentMember) return;
            
            try {
                const response = await fetch(`${gasApiUrl}?action=getUserNotifications&userId=${currentMember.id}&pageSize=20`);
                const result = await response.json();
                
                if (result.success) {
                    renderNotificationsList(result.notifications);
                    updateNotificationBadge(result.unreadCount);
                }
            } catch (error) {
                console.error('Failed to load notifications data:', error);
            }
        }

        // Render notifications list
        function renderNotificationsList(notifications) {
            if (!notifications || notifications.length === 0) {
                document.getElementById('notificationsList').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell"></i>
                        <h3>暫無通知</h3>
                        <p>您目前沒有任何通知</p>
                    </div>
                `;
                return;
            }
            
            const notificationsHtml = notifications.map(notification => `
                <div class="notification-item ${notification.status === 'unread' ? 'unread' : ''}" 
                     onclick="markNotificationAsRead('${notification.id}')">
                    <div class="notification-icon ${notification.type}">
                        <i class="fas ${getNotificationIcon(notification.type)}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-text">${notification.content}</div>
                        <div class="notification-time">${formatDateTime(notification.time)}</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('notificationsList').innerHTML = notificationsHtml;
        }

        // Load settings data
        async function loadSettingsData() {
            if (!currentMember) return;
            
            try {
                const response = await fetch(`${gasApiUrl}?action=getMemberSettings&memberId=${currentMember.id}`);
                const result = await response.json();
                
                if (result.success) {
                    populateSettingsForm(result.settings);
                }
            } catch (error) {
                console.error('Failed to load settings data:', error);
            }
        }

        // Populate settings form
        function populateSettingsForm(settings) {
            document.getElementById('emailNotifications').checked = settings.emailNotifications !== false;
            document.getElementById('lineNotifications').checked = settings.lineNotifications !== false;
            document.getElementById('activityReminders').checked = settings.activityReminders !== false;
            document.getElementById('profileVisibility').checked = settings.profileVisibility !== false;
            document.getElementById('activityVisibility').checked = settings.activityVisibility !== false;
        }

        // Tab switching
        function switchTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // Show activity detail
        async function showActivityDetail(activityId) {
            try {
                const response = await fetch(`${gasApiUrl}?action=getActivityDetail&activityId=${activityId}`);
                const result = await response.json();
                
                if (result.success) {
                    renderActivityDetail(result.activity);
                    showModal('activityModal');
                }
            } catch (error) {
                console.error('Failed to load activity detail:', error);
                showAlert('載入活動詳情失敗', 'error');
            }
        }

        // Render activity detail
        function renderActivityDetail(activity) {
            const detailHtml = `
                <div class="mb-3">
                    <h4>${activity.title}</h4>
                    <span class="activity-status ${getActivityStatusClass(activity.status)}">
                        ${getActivityStatusText(activity.status)}
                    </span>
                </div>
                
                <div class="activity-meta mb-3">
                    <div class="activity-meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>${formatDateTime(activity.startTime)}</span>
                    </div>
                    <div class="activity-meta-item">
                        <i class="fas fa-clock"></i>
                        <span>${activity.duration || '2小時'}</span>
                    </div>
                    <div class="activity-meta-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${activity.location}</span>
                    </div>
                    <div class="activity-meta-item">
                        <i class="fas fa-users"></i>
                        <span>${activity.currentParticipants}/${activity.maxParticipants || '不限'}</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h5>活動描述</h5>
                    <p>${activity.description}</p>
                </div>
                
                ${activity.requirements ? `
                    <div class="mb-3">
                        <h5>參與要求</h5>
                        <p>${activity.requirements}</p>
                    </div>
                ` : ''}
                
                <div class="mb-3">
                    <h5>主辦單位</h5>
                    <p>${activity.organizer || '帕金森病友權益促進會'}</p>
                </div>
                
                <div class="d-flex justify-between">
                    ${activity.isJoined ? 
                        `<button onclick="cancelActivity('${activity.id}')" class="btn btn-danger">
                            <i class="fas fa-times"></i> 取消報名
                        </button>` :
                        `<button onclick="joinActivity('${activity.id}')" class="btn btn-success">
                            <i class="fas fa-plus"></i> 立即報名
                        </button>`
                    }
                    <button onclick="shareActivity('${activity.id}')" class="btn btn-outline">
                        <i class="fas fa-share"></i> 分享
                    </button>
                </div>
            `;
            
            document.getElementById('activityModalContent').innerHTML = detailHtml;
        }

        // Join activity
        async function joinActivity(activityId) {
            if (!currentMember) {
                showAlert('請先完成會員註冊', 'warning');
                return;
            }
            
            try {
                const response = await fetch(gasApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'joinActivity',
                        data: {
                            activityId: activityId,
                            memberId: currentMember.id,
                            memberName: currentMember.name,
                            memberEmail: currentMember.email
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('報名成功！', 'success');
                    closeModal('activityModal');
                    loadActivitiesData(); // Refresh activities list
                } else {
                    showAlert(result.error || '報名失敗', 'error');
                }
            } catch (error) {
                console.error('Failed to join activity:', error);
                showAlert('報名過程發生錯誤', 'error');
            }
        }

        // Cancel activity
        async function cancelActivity(activityId) {
            if (!confirm('確定要取消報名嗎？')) return;
            
            try {
                const response = await fetch(gasApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'cancelActivity',
                        data: {
                            activityId: activityId,
                            memberId: currentMember.id
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('取消報名成功', 'success');
                    closeModal('activityModal');
                    loadActivitiesData(); // Refresh activities list
                } else {
                    showAlert(result.error || '取消報名失敗', 'error');
                }
            } catch (error) {
                console.error('Failed to cancel activity:', error);
                showAlert('取消報名過程發生錯誤', 'error');
            }
        }

        // Share activity
        function shareActivity(activityId) {
            if (liff.isApiAvailable('shareTargetPicker')) {
                liff.shareTargetPicker([{
                    type: 'text',
                    text: `我發現了一個很棒的活動，一起來參加吧！\n${window.location.href}?activity=${activityId}`
                }]);
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(`${window.location.href}?activity=${activityId}`)
                    .then(() => showAlert('活動連結已複製到剪貼簿', 'success'))
                    .catch(() => showAlert('分享功能暫時無法使用', 'error'));
            }
        }

        // Edit profile
        function editProfile() {
            if (!currentMember) return;
            
            // Populate form with current data
            document.getElementById('profileName').value = currentMember.name || '';
            document.getElementById('profileEmail').value = currentMember.email || '';
            document.getElementById('profilePhone').value = currentMember.phone || '';
            document.getElementById('profileAddress').value = currentMember.address || '';
            
            showModal('profileModal');
        }

        // Mark notification as read
        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch(gasApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'markNotificationAsRead',
                        data: {
                            userId: currentMember.id,
                            notificationId: notificationId
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadNotificationsData(); // Refresh notifications
                }
            } catch (error) {
                console.error('Failed to mark notification as read:', error);
            }
        }

        // Mark all notifications as read
        async function markAllNotificationsAsRead() {
            try {
                const response = await fetch(gasApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'markAllNotificationsAsRead',
                        data: { userId: currentMember.id }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('所有通知已標記為已讀', 'success');
                    loadNotificationsData(); // Refresh notifications
                }
            } catch (error) {
                console.error('Failed to mark all notifications as read:', error);
            }
        }

        // Save notification settings
        async function saveNotificationSettings() {
            const settings = {
                emailNotifications: document.getElementById('emailNotifications').checked,
                lineNotifications: document.getElementById('lineNotifications').checked,
                activityReminders: document.getElementById('activityReminders').checked
            };
            
            try {
                const response = await fetch(gasApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateNotificationSettings',
                        data: {
                            memberId: currentMember.id,
                            settings: settings
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('通知設定已儲存', 'success');
                } else {
                    showAlert('儲存設定失敗', 'error');
                }
            } catch (error) {
                console.error('Failed to save notification settings:', error);
                showAlert('儲存過程發生錯誤', 'error');
            }
        }

        // Save privacy settings
        async function savePrivacySettings() {
            const settings = {
                profileVisibility: document.getElementById('profileVisibility').checked,
                activityVisibility: document.getElementById('activityVisibility').checked
            };
            
            try {
                const response = await fetch(gasApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updatePrivacySettings',
                        data: {
                            memberId: currentMember.id,
                            settings: settings
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('隱私設定已儲存', 'success');
                } else {
                    showAlert('儲存設定失敗', 'error');
                }
            } catch (error) {
                console.error('Failed to save privacy settings:', error);
                showAlert('儲存過程發生錯誤', 'error');
            }
        }

        // Contact support
        function contactSupport() {
            if (liff.isApiAvailable('openWindow')) {
                liff.openWindow({
                    url: 'tel:02-1234-5678',
                    external: true
                });
            } else {
                showAlert('客服電話：(02) 1234-5678', 'info');
            }
        }

        // Show modal
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas ${getAlertIcon(type)}"></i>
                ${message}
            `;
            
            // Insert at the beginning of content
            const content = document.querySelector('.content');
            content.insertBefore(alertDiv, content.firstChild);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        // Update notification badge
        function updateNotificationBadge(unreadCount) {
            const notificationTab = document.querySelector('[data-tab="notifications"]');
            const existingBadge = notificationTab.querySelector('.badge');
            
            if (existingBadge) {
                existingBadge.remove();
            }
            
            if (unreadCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'badge';
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.style.cssText = `
                    position: absolute;
                    top: 5px;
                    right: 5px;
                    background: #ea4335;
                    color: white;
                    border-radius: 10px;
                    padding: 2px 6px;
                    font-size: 0.7rem;
                    min-width: 16px;
                    text-align: center;
                `;
                
                notificationTab.style.position = 'relative';
                notificationTab.appendChild(badge);
            }
        }

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW', {
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function calculateMembershipDays(registrationDate) {
            const today = new Date();
            const regDate = new Date(registrationDate);
            const diffTime = Math.abs(today - regDate);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function getActivityStatusClass(status) {
            const statusMap = {
                'upcoming': 'status-upcoming',
                'ongoing': 'status-ongoing',
                'completed': 'status-completed',
                'cancelled': 'status-cancelled'
            };
            return statusMap[status] || 'status-upcoming';
        }

        function getActivityStatusText(status) {
            const statusMap = {
                'upcoming': '即將舉行',
                'ongoing': '進行中',
                'completed': '已完成',
                'cancelled': '已取消'
            };
            return statusMap[status] || '即將舉行';
        }

        function getNotificationIcon(type) {
            const iconMap = {
                'system': 'fa-cog',
                'activity': 'fa-calendar',
                'finance': 'fa-dollar-sign',
                'emergency': 'fa-exclamation-triangle'
            };
            return iconMap[type] || 'fa-bell';
        }

        function getAlertIcon(type) {
            const iconMap = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            };
            return iconMap[type] || 'fa-info-circle';
        }

        function showTerms() {
            const termsContent = `
                <h3>服務條款</h3>
                <div style="max-height: 300px; overflow-y: auto; padding: 1rem; background: #f8f9fa; border-radius: 8px; margin: 1rem 0;">
                    <h4>1. 服務說明</h4>
                    <p>帕金森病友權益促進會提供病友支持、活動參與、資訊分享等服務。</p>
                    
                    <h4>2. 會員權利與義務</h4>
                    <p>會員享有參與活動、獲取資訊等權利，同時需遵守協會規範。</p>
                    
                    <h4>3. 隱私保護</h4>
                    <p>我們承諾保護會員個人資料，不會未經同意對外提供。</p>
                    
                    <h4>4. 服務變更</h4>
                    <p>協會保留修改服務內容的權利，重要變更將提前通知會員。</p>
                    
                    <h4>5. 責任限制</h4>
                    <p>協會盡力提供準確資訊，但不對因使用服務產生的損失承擔責任。</p>
                </div>
                <button onclick="closeModal('termsModal')" class="btn btn-primary btn-full">我已閱讀並同意</button>
            `;
            
            showCustomModal('服務條款', termsContent, 'termsModal');
        }

        function showPrivacy() {
            const privacyContent = `
                <h3>隱私政策</h3>
                <div style="max-height: 300px; overflow-y: auto; padding: 1rem; background: #f8f9fa; border-radius: 8px; margin: 1rem 0;">
                    <h4>1. 資料收集</h4>
                    <p>我們收集您提供的基本資料，包括姓名、聯絡方式等，用於提供服務。</p>
                    
                    <h4>2. 資料使用</h4>
                    <p>您的資料僅用於協會服務提供、活動通知、會員管理等用途。</p>
                    
                    <h4>3. 資料保護</h4>
                    <p>我們採用適當的技術和管理措施保護您的個人資料安全。</p>
                    
                    <h4>4. 資料分享</h4>
                    <p>除法律要求外，我們不會向第三方分享您的個人資料。</p>
                    
                    <h4>5. 權利行使</h4>
                    <p>您有權查詢、更正、刪除您的個人資料。</p>
                </div>
                <button onclick="closeModal('privacyModal')" class="btn btn-primary btn-full">我已閱讀並同意</button>
            `;
            
            showCustomModal('隱私政策', privacyContent, 'privacyModal');
        }

        function showCustomModal(title, content, modalId) {
            // Create modal if it doesn't exist
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${title}</h3>
                            <button class="modal-close" onclick="closeModal('${modalId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            showModal(modalId);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize LIFF
            initializeLiff();
            
            // Tab switching
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // Activity filter
            document.getElementById('activityFilter').addEventListener('change', function() {
                const filterValue = this.value;
                filterActivities(filterValue);
            });
            
            // Mark all notifications as read
            document.getElementById('markAllReadBtn').addEventListener('click', markAllNotificationsAsRead);
            
            // Settings forms
            document.getElementById('saveNotificationSettings').addEventListener('click', saveNotificationSettings);
            document.getElementById('savePrivacySettings').addEventListener('click', savePrivacySettings);
            document.getElementById('contactSupport').addEventListener('click', contactSupport);
            
            // Profile form
            document.getElementById('profileForm').addEventListener('submit', async function(event) {
                event.preventDefault();
                
                const formData = {
                    name: document.getElementById('profileName').value,
                    email: document.getElementById('profileEmail').value,
                    phone: document.getElementById('profilePhone').value,
                    address: document.getElementById('profileAddress').value
                };
                
                try {
                    const response = await fetch(gasApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'updateMemberProfile',
                            data: {
                                memberId: currentMember.id,
                                profile: formData
                            }
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showAlert('個人資料已更新', 'success');
                        closeModal('profileModal');
                        currentMember = { ...currentMember, ...formData };
                        loadProfileData(); // Refresh profile display
                    } else {
                        showAlert(result.error || '更新失敗', 'error');
                    }
                } catch (error) {
                    console.error('Failed to update profile:', error);
                    showAlert('更新過程發生錯誤', 'error');
                }
            });
            
            // Close modals when clicking outside
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.classList.remove('show');
                }
            });
            
            // Handle URL parameters (for shared activities)
            const urlParams = new URLSearchParams(window.location.search);
            const activityId = urlParams.get('activity');
            if (activityId) {
                setTimeout(() => {
                    switchTab('activities');
                    showActivityDetail(activityId);
                }, 1000);
            }
        });

        // Filter activities
        function filterActivities(filter) {
            const activities = document.querySelectorAll('#activitiesList .activity-card');
            
            activities.forEach(activity => {
                const statusElement = activity.querySelector('.activity-status');
                const status = statusElement.textContent.trim();
                
                let show = true;
                
                switch (filter) {
                    case 'upcoming':
                        show = status === '即將舉行';
                        break;
                    case 'ongoing':
                        show = status === '進行中';
                        break;
                    case 'completed':
                        show = status === '已完成';
                        break;
                    case 'all':
                    default:
                        show = true;
                        break;
                }
                
                activity.style.display = show ? 'block' : 'none';
            });
        }

        // Refresh data
        async function refreshData() {
            showAlert('正在更新資料...', 'info');
            
            try {
                await loadInitialData();
                showAlert('資料已更新', 'success');
            } catch (error) {
                console.error('Failed to refresh data:', error);
                showAlert('更新資料失敗', 'error');
            }
        }

        // Pull to refresh (for mobile)
        let startY = 0;
        let pullDistance = 0;
        const pullThreshold = 100;
        let isPulling = false;

        document.addEventListener('touchstart', function(event) {
            if (window.scrollY === 0) {
                startY = event.touches[0].clientY;
                isPulling = true;
            }
        });

        document.addEventListener('touchmove', function(event) {
            if (isPulling && window.scrollY === 0) {
                pullDistance = event.touches[0].clientY - startY;
                
                if (pullDistance > 0) {
                    event.preventDefault();
                    
                    // Visual feedback
                    const header = document.querySelector('.header');
                    const scale = Math.min(pullDistance / pullThreshold, 1);
                    header.style.transform = `translateY(${pullDistance * 0.5}px) scale(${1 + scale * 0.1})`;
                    
                    if (pullDistance > pullThreshold) {
                        header.style.background = 'linear-gradient(135deg, #34a853 0%, #4285f4 100%)';
                    }
                }
            }
        });

        document.addEventListener('touchend', function() {
            if (isPulling) {
                const header = document.querySelector('.header');
                header.style.transform = '';
                header.style.background = '';
                
                if (pullDistance > pullThreshold) {
                    refreshData();
                }
                
                isPulling = false;
                pullDistance = 0;
            }
        });

        // Service worker registration (for PWA)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker registration failed');
                    });
            });
        }

        // Add to home screen prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', function(event) {
            event.preventDefault();
            deferredPrompt = event;
            
            // Show install button
            const installButton = document.createElement('button');
            installButton.textContent = '安裝應用程式';
            installButton.className = 'btn btn-outline btn-full mt-2';
            installButton.onclick = function() {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(function(choiceResult) {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    installButton.remove();
                });
            };
            
            document.querySelector('#settingsTab .card:last-child .card-content').appendChild(installButton);
        });

        // Handle online/offline status
        window.addEventListener('online', function() {
            showAlert('網路連線已恢復', 'success');
            refreshData();
        });

        window.addEventListener('offline', function() {
            showAlert('網路連線中斷，部分功能可能無法使用', 'warning');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.altKey) {
                switch (event.key) {
                    case '1':
                        switchTab('home');
                        break;
                    case '2':
                        switchTab('profile');
                        break;
                    case '3':
                        switchTab('activities');
                        break;
                    case '4':
                        switchTab('notifications');
                        break;
                    case '5':
                        switchTab('settings');
                        break;
                }
            }
            
            // ESC to close modals
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
            }
        });

        // Auto-refresh notifications every 5 minutes
        setInterval(function() {
            if (currentMember && document.querySelector('[data-tab="notifications"]').classList.contains('active')) {
                loadNotificationsData();
            }
        }, 5 * 60 * 1000);

        // Console welcome message
        console.log(`
            %c帕金森病友權益促進會 LIFF 應用程式
            %c版本：1.0.0
            %c開發者工具已開啟，請謹慎操作
        `, 
        'color: #4285f4; font-size: 18px; font-weight: bold;',
        'color: #666; font-size: 12px;',
        'color: #ea4335; font-size: 12px;'
        );
    </script>
</body>
</html>
