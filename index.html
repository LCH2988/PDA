<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>社團會員系統</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, sans-serif; margin: 0; background: #f7f7f9; color: #222; }
    header { background: #1e88e5; color: #fff; padding: 16px; }
    main { padding: 16px; }
    nav { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    button, input, select, textarea { padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; background: #fff; }
    button.primary { background: #1e88e5; color: #fff; border: none; }
    .card { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .hidden { display: none; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef2ff; color: #334155; font-size: 12px; }
    @media (min-width: 768px) { .row-2 { grid-template-columns: repeat(2, 1fr); } .row-3 { grid-template-columns: repeat(3, 1fr); } }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <header>
    <h1>社團會員系統</h1>
    <div id="userDisplay" style="font-size:14px; opacity:0.9;"></div>
  </header>
  <main>
    <nav>
      <button class="primary" onclick="showPage('activities')">活動列表</button>
      <button onclick="showPage('my')">我的報名</button>
      <button onclick="showPage('volunteer')">志工時數</button>
      <button onclick="showPage('donation')">捐款紀錄</button>
    </nav>

    <section id="page-activities" class="page">
      <div class="card">
        <h2>活動列表</h2>
        <div id="activities"></div>
      </div>
    </section>

    <section id="page-my" class="page hidden">
      <div class="card">
        <h2>我的報名</h2>
        <div id="myRegs"></div>
      </div>
    </section>

    <section id="page-volunteer" class="page hidden">
      <div class="card">
        <h2>志工時數申報</h2>
        <div class="row row-2">
          <input id="vrActivityId" placeholder="活動ID (選填)" />
          <input id="vrActivityTitle" placeholder="活動名稱 (選填)" />
          <input id="vrHours" type="number" placeholder="時數" />
          <input id="vrDate" type="date" />
          <button class="primary" onclick="submitVolunteer()">送出申報</button>
        </div>
      </div>
      <div class="card">
        <h3>我的志工紀錄</h3>
        <div id="myVRs"></div>
      </div>
    </section>

    <section id="page-donation" class="page hidden">
      <div class="card">
        <h2>捐款</h2>
        <div class="row row-2">
          <input id="donAmount" type="number" placeholder="金額" />
          <input id="donDate" type="date" />
          <input id="donNote" placeholder="備註 (選填)" />
          <button class="primary" onclick="addDonation()">新增捐款</button>
        </div>
      </div>
      <div class="card">
        <h3>我的捐款紀錄</h3>
        <div id="myDons"></div>
      </div>
    </section>
  </main>

  <script>
    const CONFIG = {
      API_URL: 'https://script.google.com/macros/s/AKfycbz89u618Z_eGh1nCFNG17yPGfr09uC-TDGVr8h3Fjaw5d_ZI-Yu5m5xKZNUt9K2saIoeA/exec',
      LIFF_ID: '1656516134-X9oq92g9'
    };
    let state = { lineId: '', profile: null };

    function showPage(name) {
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      const el = document.getElementById('page-' + name);
      if (el) el.classList.remove('hidden');
      if (name === 'activities') loadActivities();
      if (name === 'my') loadMyRegs();
      if (name === 'volunteer') loadMyVRs();
      if (name === 'donation') loadMyDonations();
    }

    async function api(action, payload = {}) {
      const body = { action, ...payload };
      const res = await fetch(CONFIG.API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const result = await res.json();
      if (!result.success) throw new Error(result.message || '操作失敗');
      return result.data;
    }

    async function initLIFF() {
      await liff.init({ liffId: CONFIG.LIFF_ID });
      if (!liff.isLoggedIn()) liff.login();
      const profile = await liff.getProfile();
      state.profile = profile;
      state.lineId = profile.userId;
      document.getElementById('userDisplay').textContent = `歡迎，${profile.displayName}`;
      // 確認會員存在，不存在則建立
      const member = await api('getMemberByLineId', { lineId: state.lineId });
      if (!member) {
        await api('registerMember', { lineId: state.lineId, displayName: profile.displayName });
      }
      showPage('activities');
    }

    // 活動
    async function loadActivities() {
      const data = await api('getActivities', { status: '報名中' });
      const list = data || [];
      const el = document.getElementById('activities');
      el.innerHTML = list.length ? list.map(a => `
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div><strong>${a.title}</strong> <span class="badge">${a.status}</span></div>
              <div style="font-size:14px;opacity:.8;">${a.location} ｜ ${formatDate(a.startAt)} - ${formatDate(a.endAt)}</div>
            </div>
            <button class="primary" onclick="registerActivity('${a.id}', '${escapeHtml(a.title)}')">報名</button>
          </div>
          <div style="margin-top:8px;font-size:14px;">${escapeHtml(a.description || '')}</div>
        </div>
      `).join('') : '<div>目前沒有可報名的活動</div>';
    }

    async function registerActivity(activityId, title) {
      await api('registerActivity', { lineId: state.lineId, activityId, activityTitle: title });
      alert('報名成功');
      loadMyRegs();
    }

    async function loadMyRegs() {
      const data = await api('getMyRegistrations', { lineId: state.lineId });
      const list = data || [];
      const el = document.getElementById('myRegs');
      el.innerHTML = list.length ? list.map(r => `
        <div class="card">
          <div><strong>${r.activityTitle}</strong> <span class="badge">${r.status}</span></div>
          <div style="font-size:14px;opacity:.8;">報名：${formatDate(r.registeredAt)}${r.checkInAt ? ' ｜ 報到：' + formatDate(r.checkInAt) : ''}</div>
          ${r.status === '已報名' ? `<button onclick="cancelReg('${r.id}')">取消報名</button>` : ''}
        </div>
      `).join('') : '<div>尚無報名紀錄</div>';
    }

    async function cancelReg(id) {
      await api('cancelRegistration', { id, lineId: state.lineId });
      alert('已取消');
      loadMyRegs();
    }

    // 志工
    async function submitVolunteer() {
      const hours = Number(document.getElementById('vrHours').value || 0);
      const date = document.getElementById('vrDate').value;
      const activityId = document.getElementById('vrActivityId').value;
      const activityTitle = document.getElementById('vrActivityTitle').value;
      if (hours <= 0) return alert('請輸入大於 0 的時數');
      await api('addVolunteerRecord', { lineId: state.lineId, hours, date, activityId, activityTitle });
      alert('已送出，待審核');
      loadMyVRs();
    }

    async function loadMyVRs() {
      const data = await api('getVolunteerRecords', { lineId: state.lineId });
      const list = data || [];
      const el = document.getElementById('myVRs');
      el.innerHTML = list.length ? list.map(v => `
        <div class="card">
          <div><strong>${v.activityTitle || '(未填活動)'}</strong> <span class="badge">${v.status}</span></div>
          <div style="font-size:14px;opacity:.8;">${v.date} ｜ ${v.hours} 小時</div>
        </div>
      `).join('') : '<div>尚無志工紀錄</div>';
    }

    // 捐款
    async function addDonation() {
      const amount = Number(document.getElementById('donAmount').value || 0);
      const date = document.getElementById('donDate').value || new Date().toISOString();
      const note = document.getElementById('donNote').value || '';
      if (amount <= 0) return alert('請輸入有效金額');
      await api('addDonation', { lineId: state.lineId, amount, date, note });
      alert('已新增捐款');
      loadMyDonations();
    }

    async function loadMyDonations() {
      const data = await api('getDonations', { lineId: state.lineId });
      const list = data || [];
      const el = document.getElementById('myDons');
      el.innerHTML = list.length ? list.map(d => `
        <div class="card">
          <div><strong>$${Number(d.amount).toFixed(0)}</strong></div>
          <div style="font-size:14px;opacity:.8;">${formatDate(d.date)} ｜ ${escapeHtml(d.note || '')}</div>
        </div>
      `).join('') : '<div>尚無捐款紀錄</div>';
    }

    function formatDate(v) {
      try {
        const d = new Date(v);
        if (isNaN(d.getTime())) return String(v);
        return d.toLocaleString();
      } catch { return String(v); }
    }
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    window.addEventListener('load', () => { initLIFF().catch(err => alert('LIFF 初始化失敗：' + err.message)); });
  </script>
</body>
</html>
