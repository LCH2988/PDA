<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #4285f4;
      --secondary-color: #34a853;
      --danger-color: #ea4335;
      --warning-color: #fbbc04;
    }
    
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: #f8f9fa;
      padding-bottom: 70px;
    }
    
    /* Loading */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Skeleton Loading */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 8px;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .skeleton-card {
      height: 120px;
      margin-bottom: 15px;
    }
    
    .skeleton-text {
      height: 20px;
      margin-bottom: 10px;
    }
    
    .skeleton-text.short {
      width: 60%;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 3px solid white;
    }
    
    /* Stats Cards */
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    /* Cards */
    .activity-card, .volunteer-card, .finance-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: all 0.3s;
    }
    
    .activity-card:hover, .volunteer-card:hover, .finance-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Badges */
    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-open { background: #e8f5e9; color: #2e7d32; }
    .status-closed { background: #ffebee; color: #c62828; }
    .status-pending { background: #fff3e0; color: #ef6c00; }
    .status-completed { background: #e3f2fd; color: #1565c0; }
    
    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      z-index: 1000;
    }
    
    .nav-item {
      flex: 1;
      text-align: center;
      padding: 8px;
      color: #666;
      text-decoration: none;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .nav-item.active {
      color: var(--primary-color);
    }
    
    .nav-item i {
      font-size: 24px;
      display: block;
      margin-bottom: 5px;
    }
    
    .nav-item span {
      font-size: 12px;
    }
    
    /* Pages */
    .page-content {
      display: none;
      padding: 20px;
      animation: fadeIn 0.3s;
    }
    
    .page-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Toast */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9998;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    
    .empty-state i {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    /* Buttons */
    .btn-primary {
      background: var(--primary-color);
      border: none;
    }
    
    .btn-success {
      background: var(--secondary-color);
      border: none;
    }
    
    .btn-danger {
      background: var(--danger-color);
      border: none;
    }
    
    /* Pull to Refresh Indicator */
    .pull-refresh-indicator {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 10px 20px;
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
      z-index: 1001;
    }
    
    /* Responsive */
    @media (max-width: 576px) {
      .stat-card {
        padding: 15px;
      }
      
      .page-content {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
  </div>
  
  <!-- Pull to Refresh Indicator -->
  <div class="pull-refresh-indicator" id="pullRefreshIndicator">
    <i class="bi bi-arrow-clockwise"></i> é‡æ–°æ•´ç†ä¸­...
  </div>
  
  <!-- Toast Container -->
  <div class="toast-container"></div>
  
  <!-- Header -->
  <div class="header">
    <div class="user-info">
      <img id="userAvatar" class="user-avatar" src="" alt="User">
      <div>
        <h5 class="mb-0" id="userName">è¼‰å…¥ä¸­...</h5>
        <small id="userMemberType">æœƒå“¡</small>
      </div>
    </div>
  </div>
  
  <!-- Page: Home -->
  <div id="page-home" class="page-content active">
    <h4 class="mb-3"><i class="bi bi-house-door"></i> é¦–é </h4>
    
    <div class="row g-3 mb-4">
      <div class="col-6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #e3f2fd; color: #1976d2;">
            <i class="bi bi-calendar-event"></i>
          </div>
          <h3 id="statActivities">0</h3>
          <small class="text-muted">é–‹æ”¾æ´»å‹•</small>
        </div>
      </div>
      <div class="col-6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #e8f5e9; color: #388e3c;">
            <i class="bi bi-check-circle"></i>
          </div>
          <h3 id="statRegistrations">0</h3>
          <small class="text-muted">æˆ‘çš„å ±å</small>
        </div>
      </div>
      <div class="col-6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #fff3e0; color: #f57c00;">
            <i class="bi bi-clock-history"></i>
          </div>
          <h3 id="statVolunteerHours">0</h3>
          <small class="text-muted">å¿—å·¥æ™‚æ•¸</small>
        </div>
      </div>
      <div class="col-6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #fce4ec; color: #c2185b;">
            <i class="bi bi-heart"></i>
          </div>
          <h3 id="statDonations">$0</h3>
          <small class="text-muted">ææ¬¾é‡‘é¡</small>
        </div>
      </div>
    </div>
    
    <h5 class="mb-3">æœ€æ–°æ´»å‹•</h5>
    <div id="recentActivitiesList">
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
    </div>
  </div>
  
  <!-- Page: Activities -->
  <div id="page-activities" class="page-content">
    <h4 class="mb-3"><i class="bi bi-calendar-event"></i> æ´»å‹•å ±å</h4>
    
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#openActivities">é–‹æ”¾å ±å</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#myRegistrations">æˆ‘çš„å ±å</a>
      </li>
    </ul>
    
    <div class="tab-content">
      <div class="tab-pane fade show active" id="openActivities">
        <div id="activitiesList">
          <div class="skeleton skeleton-card"></div>
          <div class="skeleton skeleton-card"></div>
        </div>
      </div>
      <div class="tab-pane fade" id="myRegistrations">
        <div id="myRegistrationsList">
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>å°šç„¡å ±åè¨˜éŒ„</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Page: Volunteer -->
  <div id="page-volunteer" class="page-content">
    <h4 class="mb-3"><i class="bi bi-people"></i> å¿—å·¥æœå‹™</h4>
    
    <div class="row g-3 mb-4">
      <div class="col-6">
        <div class="stat-card text-center">
          <h3 id="volTotalHours">0</h3>
          <small class="text-muted">ç¸½æœå‹™æ™‚æ•¸</small>
        </div>
      </div>
      <div class="col-6">
        <div class="stat-card text-center">
          <h3 id="volTotalActivities">0</h3>
          <small class="text-muted">åƒèˆ‡æ´»å‹•æ•¸</small>
        </div>
      </div>
    </div>
    
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#volunteerNeeds">å¿—å·¥æ‹›å‹Ÿ</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#myVolunteerRecords">æˆ‘çš„è¨˜éŒ„</a>
      </li>
    </ul>
    
    <div class="tab-content">
      <div class="tab-pane fade show active" id="volunteerNeeds">
        <div id="volunteerNeedsList">
          <div class="empty-state">
            <i class="bi bi-person-plus"></i>
            <p>ç›®å‰æ²’æœ‰å¿—å·¥æ‹›å‹Ÿ</p>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="myVolunteerRecords">
        <div id="myVolunteerRecordsList">
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>å°šç„¡å¿—å·¥è¨˜éŒ„</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Page: Finance -->
  <div id="page-finance" class="page-content">
    <h4 class="mb-3"><i class="bi bi-cash-coin"></i> è²¡å‹™ä¸­å¿ƒ</h4>
    
    <div class="row g-3 mb-4">
      <div class="col-6">
        <div class="stat-card text-center">
          <h3 id="finTotalDonation">$0</h3>
          <small class="text-muted">æˆ‘çš„ç¸½ææ¬¾</small>
        </div>
      </div>
      <div class="col-6">
        <div class="stat-card text-center">
          <h3 id="finPendingExpenses">0</h3>
          <small class="text-muted">å¾…å¯©æ ¸æ”¯å‡º</small>
        </div>
      </div>
    </div>
    
    <div class="d-grid gap-2 mb-3">
      <button class="btn btn-success"><i class="bi bi-heart-fill"></i> æˆ‘è¦ææ¬¾</button>
      <button class="btn btn-outline-primary"><i class="bi bi-receipt"></i> ç”³è«‹è²»ç”¨å ±éŠ·</button>
    </div>
    
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#myDonations">æˆ‘çš„ææ¬¾</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#myExpenses">æˆ‘çš„æ”¯å‡º</a>
      </li>
    </ul>
    
    <div class="tab-content">
      <div class="tab-pane fade show active" id="myDonations">
        <div id="myDonationsList">
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>å°šç„¡ææ¬¾è¨˜éŒ„</p>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="myExpenses">
        <div id="myExpensesList">
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>å°šç„¡æ”¯å‡ºè¨˜éŒ„</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Page: Profile -->
  <div id="page-profile" class="page-content">
    <h4 class="mb-3"><i class="bi bi-person-circle"></i> å€‹äººè³‡æ–™</h4>
    
    <form id="profileForm">
      <div class="mb-3">
        <label class="form-label">çœŸå¯¦å§“å</label>
        <input type="text" class="form-control" name="realName" readonly>
      </div>
      <div class="mb-3">
        <label class="form-label">æœƒå“¡é¡å‹</label>
        <input type="text" class="form-control" name="memberType" readonly>
      </div>
      <div class="mb-3">
        <label class="form-label">é›»è©±</label>
        <input type="tel" class="form-control" name="phone" readonly>
      </div>
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input type="email" class="form-control" name="email" readonly>
      </div>
      <div class="mb-3">
        <label class="form-label">ç”Ÿæ—¥</label>
        <input type="date" class="form-control" name="birthday" readonly>
      </div>
      <div class="mb-3">
        <label class="form-label">ç¢ºè¨ºæ—¥æœŸ</label>
        <input type="date" class="form-control" name="diagnosisDate" readonly>
      </div>
      <div class="mb-3">
        <label class="form-label">åœ°å€</label>
        <input type="text" class="form-control" name="address" readonly>
      </div>
      
      <div id="profile-view-buttons">
        <button type="button" class="btn btn-primary w-100" onclick="toggleProfileEdit(true)">ç·¨è¼¯è³‡æ–™</button>
      </div>
      <div id="profile-edit-buttons" style="display:none;">
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-success" onclick="saveProfile()">å„²å­˜è®Šæ›´</button>
          <button type="button" class="btn btn-secondary" onclick="toggleProfileEdit(false)">å–æ¶ˆ</button>
        </div>
      </div>
    </form>
    
    <hr class="my-4">
    
    <h5 class="mb-3">æˆ‘çš„æ”¶æ“š</h5>
    <div id="myReceiptsList">
      <div class="empty-state">
        <i class="bi bi-receipt"></i>
        <p>å°šç„¡æ”¶æ“š</p>
      </div>
    </div>
  </div>
  
  <!-- Page: Admin -->
  <div id="page-admin" class="page-content">
    <h4 class="mb-3"><i class="bi bi-shield-lock"></i> ç®¡ç†å¾Œå°</h4>
    
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#admin-members">æœƒå“¡ç®¡ç†</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#admin-activities">æ´»å‹•ç®¡ç†</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#admin-finance">è²¡å‹™ç¸½è¦½</a></li>
    </ul>
    
    <div class="tab-content">
      <div class="tab-pane fade show active" id="admin-members">
        <div id="adminMemberList"></div>
      </div>
      <div class="tab-pane fade" id="admin-activities">
        <div id="adminActivityList"></div>
      </div>
      <div class="tab-pane fade" id="admin-finance">
        <div id="adminTransactionList"></div>
      </div>
    </div>
    
    <hr class="my-4">
    <h5 class="mb-3">ç®¡ç†å“¡æ“ä½œ</h5>
    <div class="d-grid gap-2">
      <button class="btn btn-outline-primary">åŒ¯å‡ºæœƒå“¡è³‡æ–™</button>
      <button class="btn btn-outline-secondary">åŒ¯å‡ºè²¡å‹™å ±è¡¨</button>
      <button class="btn btn-outline-warning">å‚™ä»½ç³»çµ±</button>
    </div>
  </div>
  
  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a class="nav-item active" onclick="switchPage('home', this)">
      <i class="bi bi-house-door"></i>
      <span>é¦–é </span>
    </a>
    <a class="nav-item" onclick="switchPage('activities', this)">
      <i class="bi bi-calendar-event"></i>
      <span>æ´»å‹•</span>
    </a>
    <a class="nav-item" onclick="switchPage('volunteer', this)">
      <i class="bi bi-people"></i>
      <span>å¿—å·¥</span>
    </a>
    <a class="nav-item" onclick="switchPage('finance', this)">
      <i class="bi bi-cash-coin"></i>
      <span>è²¡å‹™</span>
    </a>
    <a class="nav-item" onclick="switchPage('profile', this)">
      <i class="bi bi-person-circle"></i>
      <span>æˆ‘çš„</span>
    </a>
    <a class="nav-item" id="admin-nav-item" style="display:none;" onclick="switchPage('admin', this)">
      <i class="bi bi-shield-lock"></i>
      <span>ç®¡ç†</span>
    </a>
  </nav>
  
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
// ==================== å…¨åŸŸé…ç½®èˆ‡ç‹€æ…‹ ====================
const CONFIG = {
  LIFF_ID: '1656516134-VaGgmaPm', // âš ï¸ è«‹æ›¿æ›æˆæ‚¨çš„ LIFF ID
  GAS_URL: 'https://script.google.com/macros/s/AKfycbzxc3878f5Ydwu8xpjF6t1DCmRwZS6UAN8gDgrNwTu_MyJukrhLVJ12I9LDtoEoig/exec', // âš ï¸ è«‹æ›¿æ›æˆæ‚¨çš„ GAS URL
  API_KEY: 'AAbb8520258185202581',
  CACHE_DURATION: 5 * 60 * 1000, // 5 åˆ†é˜å¿«å–
};

let userProfile = null;
let isAdmin = false;
let cachedData = {
  dashboard: { data: null, timestamp: 0 },
  activities: { data: null, timestamp: 0 },
  myRegistrations: { data: null, timestamp: 0 },
  volunteer: { data: null, timestamp: 0 },
  finance: { data: null, timestamp: 0 },
  profile: { data: null, timestamp: 0 },
  receipts: { data: null, timestamp: 0 },
  admin: { data: null, timestamp: 0 }
};
let loadingPromises = {};

// ==================== LIFF åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', initLIFF);

async function initLIFF() {
  showLoading(true);
  try {
    await liff.init({ liffId: CONFIG.LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    userProfile = await liff.getProfile();
    document.getElementById('userAvatar').src = userProfile.pictureUrl || '';
    document.getElementById('userName').textContent = userProfile.displayName;

    await ensureUserRegistered();
    await checkAdminStatus();
    
    await loadInitialData();
    setupPullToRefresh();
    
  } catch (error) {
    console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
    showNotification('ç³»çµ±åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

async function ensureUserRegistered() {
  const profile = await callAPI('getUserInfo', {}, true, 'profile');
  if (!profile.success || !profile.data) {
    await callAPI('registerUser', { displayName: userProfile.displayName });
    clearCache('profile'); // è¨»å†Šå¾Œæ¸…é™¤å¿«å–
  } else {
    setCache('profile', profile.data);
    renderProfileData(profile.data);
  }
}

async function checkAdminStatus() {
  const profileData = getCache('profile');
  // å¾Œç«¯æ‡‰æ ¹æ“š lineId åˆ¤æ–·æ¬Šé™ï¼Œå‰ç«¯åƒ…åš UI é¡¯ç¤º
  const adminResponse = await callAPI('getAdminData');
  isAdmin = adminResponse.success; 
  if (isAdmin) {
    document.getElementById('admin-nav-item').style.display = 'block';
  }
}

// ==================== æ ¸å¿ƒ API èˆ‡å¿«å–é‚è¼¯ ====================
function isCacheValid(key) {
  const cache = cachedData[key];
  if (!cache || !cache.data) return false;
  return (Date.now() - cache.timestamp) < CONFIG.CACHE_DURATION;
}

function setCache(key, data) {
  cachedData[key] = { data, timestamp: Date.now() };
}

function getCache(key) {
  return cachedData[key]?.data;
}

function clearCache(key = null) {
  if (key) {
    cachedData[key] = { data: null, timestamp: 0 };
  } else {
    Object.keys(cachedData).forEach(k => {
      cachedData[k] = { data: null, timestamp: 0 };
    });
  }
  console.log(`ğŸ§¹ å¿«å–å·²æ¸…é™¤: ${key || 'All'}`);
}

async function callAPI(action, data = {}, useCache = false, cacheKey = action) {
  if (useCache && isCacheValid(cacheKey)) {
    console.log(`âœ… ä½¿ç”¨å¿«å–: ${cacheKey}`);
    return { success: true, data: getCache(cacheKey) };
  }

  const requestKey = action + JSON.stringify(data);
  if (loadingPromises[requestKey]) {
    console.log(`â³ ç­‰å¾…ç¾æœ‰è«‹æ±‚: ${action}`);
    return loadingPromises[requestKey];
  }

  const promise = fetch(CONFIG.GAS_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify({
      apiKey: CONFIG.API_KEY,
      action,
      lineId: userProfile?.userId,
      ...data
    })
  })
  .then(res => res.json())
  .then(result => {
    delete loadingPromises[requestKey];
    if (!result.success) throw new Error(result.message);
    if (useCache) setCache(cacheKey, result.data);
    return result;
  })
  .catch(error => {
    delete loadingPromises[requestKey];
    console.error(`âŒ API å‘¼å«å¤±æ•— (${action}):`, error);
    throw error;
  });

  loadingPromises[requestKey] = promise;
  return promise;
}

// ==================== é é¢è¼‰å…¥èˆ‡åˆ‡æ› ====================
async function loadInitialData() {
  showLoading(true);
  try {
    console.log('ğŸ“¦ æ‰¹æ¬¡è¼‰å…¥åˆå§‹è³‡æ–™...');
    const actions = ['dashboard', 'activities'];
    const response = await callAPI('getBatchData', { actions });

    if (response.data.dashboard) {
      setCache('dashboard', response.data.dashboard);
      renderDashboard(response.data.dashboard);
    }
    if (response.data.activities) {
      setCache('activities', response.data.activities);
      renderActivitiesList(response.data.activities);
    }
    if (response.data.myRegistrations) {
      setCache('myRegistrations', response.data.myRegistrations);
      renderMyRegistrations(response.data.myRegistrations);
    }
    console.log('âœ… åˆå§‹è³‡æ–™è¼‰å…¥å®Œæˆ');
  } catch (error) {
    showNotification('è¼‰å…¥åˆå§‹è³‡æ–™å¤±æ•—', 'error');
  } finally {
    showLoading(false);
  }
}

async function loadPageData(pageName, forceRefresh = false) {
  if (forceRefresh) clearCache(); // ç°¡å–®èµ·è¦‹ï¼Œå¼·åˆ¶åˆ·æ–°æ™‚æ¸…é™¤æ‰€æœ‰å¿«å–

  if (!forceRefresh && isCacheValid(pageName)) {
    console.log(`âœ… ä½¿ç”¨å¿«å–é¡¯ç¤º: ${pageName}`);
    renderPageFromCache(pageName);
    return;
  }

  console.log(`ğŸ”„ è¼‰å…¥é é¢è³‡æ–™: ${pageName}`);
  showLoading(true);
  try {
    let actions = [];
    switch(pageName) {
      case 'home': actions = ['dashboard']; break;
      case 'activities': actions = ['activities']; break;
      case 'volunteer': actions = ['volunteer']; break;
      case 'finance': actions = ['finance']; break;
      case 'profile': actions = ['profile', 'receipts']; break;
      case 'admin': if(isAdmin) actions = ['admin']; break;
    }
    
    if(actions.length > 0){
      const response = await callAPI('getBatchData', { actions });
      
      Object.keys(response.data).forEach(key => {
        setCache(key, response.data[key]);
        renderPageFromCache(key);
      });
    }
  } catch (error) {
    showNotification(`è¼‰å…¥ ${pageName} å¤±æ•—`, 'error');
  } finally {
    showLoading(false);
  }
}

function renderPageFromCache(key) {
  const data = getCache(key);
  if (!data) return;
  switch(key) {
    case 'dashboard': renderDashboard(data); break;
    case 'activities': renderActivitiesList(data); break;
    case 'myRegistrations': renderMyRegistrations(data); break;
    case 'volunteer': renderVolunteerData(data); break;
    case 'finance': renderFinanceData(data); break;
    case 'profile': renderProfileData(data); break;
    case 'receipts': renderMyReceipts(data); break;
    case 'admin': if(isAdmin) renderAdminData(data); break;
  }
}

function switchPage(pageName, element) {
  document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  document.getElementById(`page-${pageName}`).classList.add('active');
  if (element) element.classList.add('active');
  window.scrollTo({ top: 0, behavior: 'smooth' });
  loadPageData(pageName);
}

// ==================== æ¸²æŸ“å‡½å¼ ====================
function renderDashboard(data) {
  document.getElementById('statActivities').textContent = data.totalActivities || 0;
  document.getElementById('statRegistrations').textContent = data.myRegistrations || 0;
  document.getElementById('statVolunteerHours').textContent = data.myVolunteerHours || 0;
  document.getElementById('statDonations').textContent = '$' + (data.myDonationAmount || 0).toLocaleString();
  renderRecentActivities(data.recentActivity || []);
}

function renderRecentActivities(activities) {
  const list = document.getElementById('recentActivitiesList');
  if (activities.length === 0) {
    list.innerHTML = `<div class="empty-state"><i class="bi bi-calendar-x"></i><p>è¿‘æœŸæ²’æœ‰æ´»å‹•</p></div>`;
    return;
  }
  list.innerHTML = activities.map(act => `
    <div class="activity-card">
      <h6>${act.title}</h6>
      <small class="text-muted"><i class="bi bi-calendar"></i> ${new Date(act.date).toLocaleDateString()}</small>
      <span class="status-badge float-end status-open">${act.status}</span>
    </div>
  `).join('');
}

function renderActivitiesList(activities) {
  const list = document.getElementById('activitiesList');
  const openActivities = activities.filter(a => a.status === 'é–‹æ”¾å ±å');
  if (openActivities.length === 0) {
    list.innerHTML = `<div class="empty-state"><i class="bi bi-calendar-x"></i><p>ç›®å‰æ²’æœ‰é–‹æ”¾å ±åçš„æ´»å‹•</p></div>`;
    return;
  }
  list.innerHTML = openActivities.map(act => `
    <div class="activity-card">
      <h5>${act.title}</h5>
      <p><i class="bi bi-calendar"></i> ${new Date(act.date).toLocaleString()}</p>
      <p><i class="bi bi-geo-alt"></i> ${act.location}</p>
      <p><i class="bi bi-people"></i> ${act.currentParticipants}/${act.maxParticipants || 'ä¸é™'}</p>
      <button class="btn btn-primary w-100" onclick="registerActivity('${act.id}')">ç«‹å³å ±å</button>
    </div>
  `).join('');
}

function renderMyRegistrations(registrations) {
  const list = document.getElementById('myRegistrationsList');
  if (registrations.length === 0) {
    list.innerHTML = `<div class="empty-state"><i class="bi bi-inbox"></i><p>å°šç„¡å ±åè¨˜éŒ„</p></div>`;
    return;
  }
  list.innerHTML = registrations.map(reg => `
    <div class="activity-card">
      <h6>${reg.activityTitle}</h6>
      <p><i class="bi bi-clock"></i> å ±åæ™‚é–“: ${new Date(reg.registeredAt).toLocaleDateString()}</p>
      <span class="status-badge float-end ${reg.status === 'å·²å ±å' ? 'status-open' : 'status-closed'}">${reg.status}</span>
      ${reg.status === 'å·²å ±å' ? `<button class="btn btn-sm btn-outline-danger mt-2" onclick="cancelRegistration('${reg.id}')">å–æ¶ˆå ±å</button>` : ''}
    </div>
  `).join('');
}

function renderVolunteerData(data) {
  document.getElementById('volTotalHours').textContent = data.stats?.totalHours || 0;
  document.getElementById('volTotalActivities').textContent = data.stats?.totalActivities || 0;
  // ... æ¸²æŸ“å¿—å·¥éœ€æ±‚å’Œæˆ‘çš„è¨˜éŒ„åˆ—è¡¨
}

function renderFinanceData(data) {
  document.getElementById('finTotalDonation').textContent = '$' + (data.stats?.totalDonation || 0).toLocaleString();
  document.getElementById('finPendingExpenses').textContent = data.stats?.pendingExpenses || 0;
  // ... æ¸²æŸ“ææ¬¾å’Œæ”¯å‡ºåˆ—è¡¨
}

function renderProfileData(profile) {
  const form = document.getElementById('profileForm');
  if (form && profile) {
    form.elements.realName.value = profile.realName || '';
    form.elements.memberType.value = profile.memberType || 'ä¸€èˆ¬æœƒå“¡';
    form.elements.phone.value = profile.phone || '';
    form.elements.email.value = profile.email || '';
    form.elements.birthday.value = profile.birthday ? profile.birthday.split('T')[0] : '';
    form.elements.diagnosisDate.value = profile.diagnosisDate ? profile.diagnosisDate.split('T')[0] : '';
    form.elements.address.value = profile.address || '';
    document.getElementById('userMemberType').textContent = profile.memberType || 'æœƒå“¡';
  }
}

function renderMyReceipts(receipts) {
  // ... æ¸²æŸ“æˆ‘çš„æ”¶æ“šåˆ—è¡¨
}

function renderAdminData(data) {
  // ... æ¸²æŸ“ç®¡ç†å“¡é¢æ¿
}

// ==================== æ“ä½œå‡½å¼ ====================
async function registerActivity(activityId) {
  if (!confirm('ç¢ºå®šè¦å ±åæ­¤æ´»å‹•å—ï¼Ÿ')) return;
  showLoading(true);
  try {
    await callAPI('registerActivity', { activityId });
    showNotification('å ±åæˆåŠŸï¼', 'success');
    await loadPageData('activities', true); // å¼·åˆ¶åˆ·æ–°æ´»å‹•é é¢
    await loadPageData('home', true); // å¼·åˆ¶åˆ·æ–°é¦–é 
  } catch (error) {
    showNotification(`å ±åå¤±æ•—: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

async function cancelRegistration(registrationId) {
  if (!confirm('ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ')) return;
  showLoading(true);
  try {
    await callAPI('cancelRegistration', { registrationId });
    showNotification('å·²å–æ¶ˆå ±å', 'success');
    await loadPageData('activities', true);
    await loadPageData('home', true);
  } catch (error) {
    showNotification(`å–æ¶ˆå¤±æ•—: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

function toggleProfileEdit(isEditing) {
  const form = document.getElementById('profileForm');
  const fields = form.querySelectorAll('input, select');
  fields.forEach(field => {
    if (field.name !== 'memberType') { // æœƒå“¡é¡å‹é€šå¸¸ä¸å¯è‡ªè¡Œä¿®æ”¹
      field.readOnly = !isEditing;
    }
  });
  document.getElementById('profile-view-buttons').style.display = isEditing ? 'none' : 'block';
  document.getElementById('profile-edit-buttons').style.display = isEditing ? 'block' : 'none';
}

async function saveProfile() {
  const form = document.getElementById('profileForm');
  const data = {
    realName: form.elements.realName.value,
    phone: form.elements.phone.value,
    email: form.elements.email.value,
    birthday: form.elements.birthday.value,
    diagnosisDate: form.elements.diagnosisDate.value,
    address: form.elements.address.value,
  };
  
  showLoading(true);
  try {
    await callAPI('updateProfile', data);
    showNotification('è³‡æ–™æ›´æ–°æˆåŠŸï¼', 'success');
    toggleProfileEdit(false);
    await loadPageData('profile', true);
  } catch (error) {
    showNotification(`æ›´æ–°å¤±æ•—: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

// ==================== å·¥å…·å‡½å¼ ====================
function showLoading(show) {
  document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

function showNotification(message, type = 'info') {
  const container = document.querySelector('.toast-container');
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
  container.appendChild(toast);
  setTimeout(() => {
    toast.remove();
  }, 3000);
}

function setupPullToRefresh() {
  let touchStartY = 0;
  const indicator = document.getElementById('pullRefreshIndicator');
  
  document.addEventListener('touchstart', e => {
    if (window.scrollY === 0) touchStartY = e.touches[0].clientY;
  }, { passive: true });

  document.addEventListener('touchmove', e => {
    const pullDistance = e.touches[0].clientY - touchStartY;
    if (window.scrollY === 0 && pullDistance > 0) {
      if (pullDistance > 100) {
        indicator.style.display = 'block';
      }
    }
  }, { passive: true });

  document.addEventListener('touchend', async e => {
    const pullDistance = e.changedTouches[0].clientY - touchStartY;
    indicator.style.display = 'none';
    if (window.scrollY === 0 && pullDistance > 100) {
      const activePage = document.querySelector('.page-content.active').id.replace('page-', '');
      showNotification('ğŸ”„ é‡æ–°æ•´ç†ä¸­...', 'info');
      await loadPageData(activePage, true);
      showNotification('âœ… æ›´æ–°å®Œæˆ', 'success');
    }
    touchStartY = 0;
  });
}
  </script>
</body>
</html>
