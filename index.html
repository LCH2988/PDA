<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Â∏ïÈáëÊ£ÆÁóÖÂèãÊúÉÊï¥ÂêàÁ≥ªÁµ±</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüè•%3C/text%3E%3C/svg%3E">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"/>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  :root {
    --primary: #06c755;
    --primary-dark: #05b04b;
    --secondary: #00b900;
    --danger: #dc3545;
    --warning: #ffc107;
    --info: #17a2b8;
    --light: #f8f9fa;
    --dark: #343a40;
    --border-radius: 12px;
    --purple-1: #667eea;
    --purple-2: #764ba2;
  }
  
  * { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
  }
  
  body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans TC', sans-serif; 
    background: linear-gradient(135deg, var(--purple-1) 0%, var(--purple-2) 100%); 
    min-height: 100vh; 
    overflow-x: hidden;
  }
  
  .hidden { 
    display: none !important; 
  }
  
  .root-container { 
    max-width: 1200px; 
    margin: 0 auto; 
    padding: 0;
  }
  
  .view { 
    display: none; 
  }
  
  .view.active { 
    display: block; 
  }

  /* Loading Overlay */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  
  .loading-overlay.show {
    display: flex;
  }
  
  .loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Toast Container */
  .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9998;
    max-width: 350px;
  }

  /* Auth View */
  .auth-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  
  .auth-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    width: 100%;
    max-width: 450px;
    overflow: hidden;
  }
  
  .auth-header {
    background: linear-gradient(135deg, var(--purple-1), var(--purple-2));
    color: white;
    padding: 30px;
    text-align: center;
  }
  
  .auth-header h1 {
    font-size: 24px;
    margin-bottom: 5px;
  }
  
  .auth-tabs {
    display: flex;
    border-bottom: 1px solid #dee2e6;
  }
  
  .auth-tab {
    flex: 1;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
  }
  
  .auth-tab.active {
    border-bottom-color: var(--purple-1);
    color: var(--purple-1);
    font-weight: bold;
  }
  
  .auth-pane {
    display: none;
    padding: 30px;
  }
  
  .auth-pane.active {
    display: block;
  }
  
  .form-floating {
    margin-bottom: 15px;
  }
  
  .btn-gradient {
    background: linear-gradient(135deg, var(--purple-1), var(--purple-2));
    border: none;
    color: white;
    padding: 12px;
    border-radius: 8px;
    font-weight: bold;
    width: 100%;
    transition: transform 0.2s;
  }
  
  .btn-gradient:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }
  
  .btn-line {
    background: #06c755;
    border: none;
    color: white;
    padding: 12px;
    border-radius: 8px;
    font-weight: bold;
    width: 100%;
    margin-top: 10px;
  }

  /* Member Center */
  .member-container {
    min-height: 100vh;
    background: #f5f7fa;
  }
  
  .member-header {
    background: linear-gradient(135deg, var(--purple-1), var(--purple-2));
    color: white;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }
  
  .member-profile {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  
  .member-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: white;
    color: var(--purple-1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
  }
  
  .member-nav {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    padding: 20px;
    background: white;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }
  
  .member-nav-item {
    padding: 15px;
    text-align: center;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
  }
  
  .member-nav-item:hover {
    background: #f8f9fa;
    border-color: var(--purple-1);
  }
  
  .member-nav-item i {
    font-size: 24px;
    display: block;
    margin-bottom: 5px;
    color: var(--purple-1);
  }
  
  .member-section {
    display: none;
    padding: 20px;
  }
  
  .member-section.active {
    display: block;
  }
  
  .card {
    border: none;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    margin-bottom: 20px;
  }
  
  .card-header {
    background: linear-gradient(135deg, var(--purple-1), var(--purple-2));
    color: white;
    border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
    padding: 15px 20px;
    font-weight: bold;
  }

  /* Admin Dashboard */
  .admin-container {
    min-height: 100vh;
    background: #f5f7fa;
  }
  
  .admin-sidebar {
    background: white;
    min-height: 100vh;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
  }
  
  .admin-sidebar-header {
    background: linear-gradient(135deg, var(--purple-1), var(--purple-2));
    color: white;
    padding: 20px;
    text-align: center;
  }
  
  .admin-menu {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .admin-menu-item {
    padding: 15px 20px;
    cursor: pointer;
    transition: all 0.3s;
    border-left: 3px solid transparent;
  }
  
  .admin-menu-item:hover {
    background: #f8f9fa;
    border-left-color: var(--purple-1);
  }
  
  .admin-menu-item i {
    margin-right: 10px;
    width: 20px;
  }
  
  .admin-section {
    display: none;
    padding: 20px;
  }
  
  .admin-section.active {
    display: block;
  }
  
  .stat-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    text-align: center;
  }
  
  .stat-card i {
    font-size: 36px;
    margin-bottom: 10px;
  }
  
  .stat-value {
    font-size: 32px;
    font-weight: bold;
    margin: 10px 0;
  }
  
  .stat-label {
    color: #6c757d;
    font-size: 14px;
  }

  /* App View (Mobile) */
  .app-container {
    min-height: 100vh;
    background: #f5f7fa;
    padding-bottom: 70px;
  }
  
  .app-header {
    background: linear-gradient(135deg, var(--purple-1), var(--purple-2));
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }
  
  .app-user {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .app-user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 2px solid white;
  }
  
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    z-index: 1000;
  }
  
  .nav-item {
    flex: 1;
    text-align: center;
    padding: 5px;
    cursor: pointer;
    transition: all 0.3s;
    border-top: 3px solid transparent;
  }
  
  .nav-item.active {
    color: var(--purple-1);
    border-top-color: var(--purple-1);
  }
  
  .nav-item i {
    font-size: 20px;
    display: block;
    margin-bottom: 3px;
  }
  
  .nav-item span {
    font-size: 11px;
  }
  
  .page-content {
    display: none;
    padding: 15px;
  }
  
  .page-content.active {
    display: block;
  }
  
  .stat-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .stat-box {
    background: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }
  
  .stat-box i {
    font-size: 24px;
    color: var(--purple-1);
    margin-bottom: 8px;
  }
  
  .stat-number {
    font-size: 24px;
    font-weight: bold;
    color: var(--purple-1);
  }
  
  .stat-text {
    font-size: 12px;
    color: #6c757d;
    margin-top: 5px;
  }
  
  .activity-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }
  
  .activity-title {
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .activity-info {
    font-size: 13px;
    color: #6c757d;
    margin-bottom: 8px;
  }
  
  .activity-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    font-size: 12px;
    color: #6c757d;
  }
  
  .activity-meta i {
    margin-right: 3px;
  }
  
  .status-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
  }
  
  .status-Â†±Âêç‰∏≠, .status-info { background: #d1ecf1; color: #0c5460; }
  .status-Â∑≤È°çÊªø, .status-warning { background: #fff3cd; color: #856404; }
  .status-Â∑≤ÁµêÊùü, .status-secondary { background: #e2e3e5; color: #383d41; }
  .status-Â∑≤ÂèñÊ∂à, .status-danger { background: #f8d7da; color: #721c24; }
  .status-Â∑≤ÂÆåÊàê, .status-success { background: #d4edda; color: #155724; }
  
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
  }
  
  .empty-state i {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
  }
  
  .mood-options {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
  }
  
  .mood-option {
    text-align: center;
    cursor: pointer;
    padding: 10px;
    border-radius: 8px;
    transition: all 0.3s;
    border: 2px solid transparent;
  }
  
  .mood-option:hover, .mood-option.active {
    background: #f8f9fa;
    border-color: var(--purple-1);
  }
  
  .mood-option i {
    font-size: 32px;
    display: block;
    margin-bottom: 5px;
  }
  
  .mood-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 15px 0;
  }
  
  .mood-tag {
    padding: 6px 12px;
    border-radius: 20px;
    background: #e9ecef;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.3s;
  }
  
  .mood-tag.active {
    background: var(--purple-1);
    color: white;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .root-container {
      padding: 0;
    }
    
    .auth-card {
      border-radius: 0;
    }
    
    .member-nav {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .stat-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (min-width: 769px) {
    .app-container {
      max-width: 480px;
      margin: 0 auto;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }
  }

  /* Utilities */
  .text-primary { color: var(--purple-1) !important; }
  .bg-primary { background: var(--purple-1) !important; }
  .border-primary { border-color: var(--purple-1) !important; }
  
  .fade-in {
    animation: fadeIn 0.3s ease-in;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

</head>
<body>

  <div class="root-container">
    
    <!-- ==================== Ë™çË≠âË¶ñÂúñ ==================== -->
    <div id="view-auth" class="view active">
      <div class="auth-container">
        <div class="auth-card">
          <div class="auth-header">
            <h1>üè• Â∏ïÈáëÊ£ÆÁóÖÂèãÊúÉ</h1>
            <p class="mb-0">Êï¥ÂêàÁÆ°ÁêÜÁ≥ªÁµ±</p>
          </div>
          
          <!-- Ê®ôÁ±§È†Å -->
          <div class="auth-tabs">
            <div class="auth-tab active" data-pane="pane-login">ÁôªÂÖ•</div>
            <div class="auth-tab" data-pane="pane-register">Ë®ªÂÜä</div>
            <div class="auth-tab" data-pane="pane-settings">Ë®≠ÂÆö</div>
          </div>
          
          <!-- ÁôªÂÖ•Èù¢Êùø -->
          <div id="pane-login" class="auth-pane active">
            <div id="auth-alert" class="alert d-none"></div>
            <div id="auth-loading" class="text-center d-none mb-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ËºâÂÖ•‰∏≠...</span>
              </div>
            </div>
            
            <form id="emailLoginForm">
              <div class="form-floating mb-3">
                <input type="email" class="form-control" id="login-email" placeholder="ÈõªÂ≠êÈÉµ‰ª∂" required>
                <label for="login-email">ÈõªÂ≠êÈÉµ‰ª∂</label>
              </div>
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="login-password" placeholder="ÂØÜÁ¢º" required>
                <label for="login-password">ÂØÜÁ¢º</label>
              </div>
              <button type="submit" class="btn btn-gradient">
                <i class="bi bi-box-arrow-in-right me-2"></i>ÁôªÂÖ•
              </button>
            </form>
            
            <div class="text-center my-3">
              <div class="text-muted small">Êàñ‰ΩøÁî®</div>
            </div>
            
            <button type="button" class="btn btn-line" onclick="APP.Auth.handleLineLogin()">
              <i class="bi bi-line me-2"></i>LINE Âø´ÈÄüÁôªÂÖ•
            </button>
          </div>
          
          <!-- Ë®ªÂÜäÈù¢Êùø -->
          <div id="pane-register" class="auth-pane">
            <form id="registerForm">
              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="reg-name" placeholder="ÂßìÂêç" required>
                <label for="reg-name">ÂßìÂêç *</label>
              </div>
              <div class="form-floating mb-3">
                <select class="form-select" id="reg-gender" required>
                  <option value="">Ë´ãÈÅ∏Êìá</option>
                  <option value="Áî∑">Áî∑</option>
                  <option value="Â•≥">Â•≥</option>
                  <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                </select>
                <label for="reg-gender">ÊÄßÂà• *</label>
              </div>
              <div class="form-floating mb-3">
                <input type="date" class="form-control" id="reg-birthday" placeholder="ÁîüÊó•">
                <label for="reg-birthday">ÁîüÊó•</label>
              </div>
              <div class="form-floating mb-3">
                <input type="tel" class="form-control" id="reg-phone" placeholder="ÊâãÊ©üËôüÁ¢º" pattern="09[0-9]{8}">
                <label for="reg-phone">ÊâãÊ©üËôüÁ¢º</label>
              </div>
              <div class="form-floating mb-3">
                <input type="email" class="form-control" id="reg-email" placeholder="ÈõªÂ≠êÈÉµ‰ª∂" required>
                <label for="reg-email">ÈõªÂ≠êÈÉµ‰ª∂ *</label>
              </div>
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="reg-password" placeholder="ÂØÜÁ¢º" required minlength="6">
                <label for="reg-password">ÂØÜÁ¢ºÔºàËá≥Â∞ë6‰ΩçÔºâ*</label>
              </div>
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="reg-password-confirm" placeholder="Á¢∫Ë™çÂØÜÁ¢º" required>
                <label for="reg-password-confirm">Á¢∫Ë™çÂØÜÁ¢º *</label>
              </div>
              <button type="submit" class="btn btn-gradient">
                <i class="bi bi-person-plus me-2"></i>Ë®ªÂÜä
              </button>
            </form>
          </div>
          
          <!-- Ë®≠ÂÆöÈù¢Êùø -->
          <div id="pane-settings" class="auth-pane">
            <h5 class="mb-3">Á≥ªÁµ±Ë®≠ÂÆö</h5>
            
            <div class="mb-3">
              <label class="form-label">API Á∂≤ÂùÄ</label>
              <input type="url" class="form-control" id="global-api-url" placeholder="Ëº∏ÂÖ• API Á∂≤ÂùÄ">
              <div class="form-text">ÁõÆÂâçÔºö<span id="current-api-url"></span></div>
            </div>
            
            <button type="button" class="btn btn-primary w-100 mb-2" onclick="APP.Config.updateAPIUrl()">
              <i class="bi bi-save me-2"></i>ÂÑ≤Â≠òË®≠ÂÆö
            </button>
            
            <button type="button" class="btn btn-info w-100 mb-2" onclick="APP.Auth.testAPIConnection()">
              <i class="bi bi-wifi me-2"></i>Ê∏¨Ë©¶ API ÈÄ£Á∑ö
            </button>
            
            <hr class="my-3">
            
            <h6>Èô§ÈåØË≥áË®ä</h6>
            <div id="auth-debug" class="border rounded p-2 bg-light" style="max-height:200px;overflow-y:auto;font-size:12px;font-family:monospace;"></div>
            <button type="button" class="btn btn-sm btn-secondary w-100 mt-2" onclick="APP.Auth.clearDebug()">
              Ê∏ÖÈô§Ë®òÈåÑ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== ÊúÉÂì°‰∏≠ÂøÉË¶ñÂúñ ==================== -->
    <div id="view-member" class="view">
      <div class="member-container">
        <!-- È†ÇÈÉ®Â∞éËà™ -->
        <div class="member-header">
          <div class="member-profile">
            <div class="member-avatar" id="mc-avatar">A</div>
            <div class="flex-grow-1">
              <div class="fw-bold" id="mc-name">ËºâÂÖ•‰∏≠...</div>
              <div class="small" id="mc-no">ÊúÉÂì°Á∑®ËôüÔºö---</div>
            </div>
            <button class="btn btn-sm btn-light" onclick="APP.Auth.logout()">
              <i class="bi bi-box-arrow-right"></i> ÁôªÂá∫
            </button>
          </div>
        </div>
        
        <!-- ÂäüËÉΩÂ∞éËà™ -->
        <div class="member-nav">
          <div class="member-nav-item" onclick="APP.Member.show('home')">
            <i class="bi bi-house-door"></i>
            <div>È¶ñÈ†Å</div>
          </div>
          <div class="member-nav-item" onclick="APP.Member.show('symptom')">
            <i class="bi bi-clipboard-pulse"></i>
            <div>ÁóáÁãÄË®òÈåÑ</div>
          </div>
          <div class="member-nav-item" onclick="APP.Member.show('medication')">
            <i class="bi bi-capsule"></i>
            <div>Áî®Ëó•ÁÆ°ÁêÜ</div>
          </div>
          <div class="member-nav-item" onclick="APP.Member.show('exercise')">
            <i class="bi bi-activity"></i>
            <div>ÈÅãÂãïË®òÈåÑ</div>
          </div>
          <div class="member-nav-item" onclick="APP.Member.show('sleep')">
            <i class="bi bi-moon-stars"></i>
            <div>Áù°Áú†Ë®òÈåÑ</div>
          </div>
          <div class="member-nav-item" onclick="APP.Member.show('mood')">
            <i class="bi bi-emoji-smile"></i>
            <div>ÂøÉÊÉÖÊó•Ë®ò</div>
          </div>
          <div class="member-nav-item" onclick="APP.Member.show('events')">
            <i class="bi bi-calendar-event"></i>
            <div>Ê¥ªÂãïÂ†±Âêç</div>
          </div>
          <div class="member-nav-item" onclick="APP.Member.show('profile')">
            <i class="bi bi-person-circle"></i>
            <div>ÂÄã‰∫∫Ë≥áÊñô</div>
          </div>
          <div class="member-nav-item admin-only" onclick="APP.Router.goAdmin()" style="display:none;">
            <i class="bi bi-gear"></i>
            <div>ÁÆ°ÁêÜÂæåÂè∞</div>
          </div>
        </div>
        
        <!-- È¶ñÈ†Å -->
        <div id="mc-home" class="member-section active">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-bell me-2"></i>‰ªäÊó•ÊèêÈÜí
            </div>
            <div class="card-body" id="mc-today-reminders">
              <div class="text-center text-muted py-3">ËºâÂÖ•‰∏≠...</div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <i class="bi bi-calendar-check me-2"></i>ËøëÊúüÊ¥ªÂãï
            </div>
            <div class="card-body" id="mc-upcoming-events">
              <div class="text-center text-muted py-3">ËºâÂÖ•‰∏≠...</div>
            </div>
          </div>
        </div>
        
        <!-- ÁóáÁãÄË®òÈåÑ -->
        <div id="mc-symptom" class="member-section">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-plus-circle me-2"></i>Êñ∞Â¢ûÁóáÁãÄË®òÈåÑ
            </div>
            <div class="card-body">
              <form id="mc-symptom-form">
                <div class="mb-3">
                  <label class="form-label">È°´ÊäñÁ®ãÂ∫¶Ôºà0-10Ôºâ</label>
                  <input type="range" class="form-range" id="mc-tremor" min="0" max="10" value="0">
                  <div class="text-center"><span id="mc-tremor-val">0</span></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">ÂÉµÁ°¨Á®ãÂ∫¶Ôºà0-10Ôºâ</label>
                  <input type="range" class="form-range" id="mc-rigidity" min="0" max="10" value="0">
                  <div class="text-center"><span id="mc-rigidity-val">0</span></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Âãï‰ΩúÈÅ≤Á∑©Ôºà0-10Ôºâ</label>
                  <input type="range" class="form-range" id="mc-brady" min="0" max="10" value="0">
                  <div class="text-center"><span id="mc-brady-val">0</span></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Âπ≥Ë°°ÂïèÈ°åÔºà0-10Ôºâ</label>
                  <input type="range" class="form-range" id="mc-balance" min="0" max="10" value="0">
                  <div class="text-center"><span id="mc-balance-val">0</span></div>
                </div>
                <div class="mb-3">
                  <label class="form-label">ÂÇôË®ª</label>
                  <textarea class="form-control" id="mc-symptom-notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-gradient w-100">
                  <i class="bi bi-save me-2"></i>ÂÑ≤Â≠òË®òÈåÑ
                </button>
              </form>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <i class="bi bi-clock-history me-2"></i>Ê≠∑Âè≤Ë®òÈåÑ
            </div>
            <div class="card-body" id="mc-symptom-history">
              <div class="text-center text-muted py-3">ËºâÂÖ•‰∏≠...</div>
            </div>
          </div>
        </div>
        
        <!-- Áî®Ëó•ÁÆ°ÁêÜ -->
        <div id="mc-medication" class="member-section">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span><i class="bi bi-capsule me-2"></i>ÊàëÁöÑÁî®Ëó•</span>
              <button class="btn btn-sm btn-light" onclick="APP.Member.openAddMedication()">
                <i class="bi bi-plus"></i> Êñ∞Â¢û
              </button>
            </div>
            <div class="card-body" id="mc-medications-list">
              <div class="text-center text-muted py-3">ËºâÂÖ•‰∏≠...</div>
            </div>
          </div>
        </div>
        
        <!-- ÈÅãÂãïË®òÈåÑ -->
        <div id="mc-exercise" class="member-section">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-plus-circle me-2"></i>Êñ∞Â¢ûÈÅãÂãïË®òÈåÑ
            </div>
            <div class="card-body">
              <form id="mc-exercise-form">
                <div class="mb-3">
                  <label class="form-label">ÈÅãÂãïÊó•Êúü</label>
                  <input type="date" class="form-control" id="mc-ex-date" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">ÈÅãÂãïÈ°ûÂûã</label>
                  <select class="form-select" id="mc-ex-type" required>
                    <option value="">Ë´ãÈÅ∏Êìá</option>
                    <option>Êï£Ê≠•</option>
                    <option>Â§™Ê•µ</option>
                    <option>ÁëúÁèà</option>
                    <option>Ê∏∏Ê≥≥</option>
                    <option>È®éËÖ≥Ë∏èËªä</option>
                    <option>ÂÖ∂‰ªñ</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">ÈÅãÂãïÊôÇÈï∑ÔºàÂàÜÈêòÔºâ</label>
                  <input type="number" class="form-control" id="mc-ex-duration" min="1" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">ÈÅãÂãïÂº∑Â∫¶</label>
                  <select class="form-select" id="mc-ex-intensity">
                    <option>ËºïÂ∫¶</option>
                    <option>‰∏≠Â∫¶</option>
                    <option>È´òÂº∑Â∫¶</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ë∫´È´îÁãÄÊ≥Å</label>
                  <select class="form-select" id="mc-ex-condition">
                    <option>ËâØÂ•Ω</option>
                    <option>ÊôÆÈÄö</option>
                    <option>Áñ≤Á¥Ø</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">ÂÇôË®ª</label>
                  <textarea class="form-control" id="mc-ex-notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-gradient w-100">
                  <i class="bi bi-save me-2"></i>ÂÑ≤Â≠òË®òÈåÑ
                </button>
              </form>
            </div>
          </div>
        </div>
        
        <!-- Áù°Áú†Ë®òÈåÑ -->
        <div id="mc-sleep" class="member-section">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-plus-circle me-2"></i>Êñ∞Â¢ûÁù°Áú†Ë®òÈåÑ
            </div>
            <div class="card-body">
              <form id="mc-sleep-form">
                <div class="mb-3">
                  <label class="form-label">Áù°Áú†Êó•Êúü</label>
                  <input type="date" class="form-control" id="mc-sleep-date" required>
                </div>
                <div class="row mb-3">
                  <div class="col-6">
                    <label class="form-label">Â∞±ÂØ¢ÊôÇÈñì</label>
                    <input type="time" class="form-control" id="mc-sleep-bedtime" required>
                  </div>
                  <div class="col-6">
                    <label class="form-label">Ëµ∑Â∫äÊôÇÈñì</label>
                    <input type="time" class="form-control" id="mc-sleep-wake" required>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Áù°Áú†ÂìÅË≥™</label>
                  <select class="form-select" id="mc-sleep-quality">
                    <option>ÈùûÂ∏∏Â•Ω</option>
                    <option>Â•Ω</option>
                    <option>ÊôÆÈÄö</option>
                    <option>Â∑Æ</option>
                    <option>ÈùûÂ∏∏Â∑Æ</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Â§úÈñìÈÜí‰æÜÊ¨°Êï∏</label>
                  <input type="number" class="form-control" id="mc-sleep-wake-count" min="0" value="0">
                </div>
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="mc-sleep-dream">
                    <label class="form-check-label" for="mc-sleep-dream">ÊúâÂÅöÂ§¢</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="mc-sleep-nightmare">
                    <label class="form-check-label" for="mc-sleep-nightmare">ÊúâÊÉ°Â§¢</label>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">ÂÇôË®ª</label>
                  <textarea class="form-control" id="mc-sleep-notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-gradient w-100">
                  <i class="bi bi-save me-2"></i>ÂÑ≤Â≠òË®òÈåÑ
                </button>
              </form>
            </div>
          </div>
        </div>
        
        <!-- ÂøÉÊÉÖÊó•Ë®ò -->
        <div id="mc-mood" class="member-section">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-plus-circle me-2"></i>Êñ∞Â¢ûÂøÉÊÉÖÊó•Ë®ò
            </div>
            <div class="card-body">
              <form id="mc-mood-form">
                <div class="mb-3">
                  <label class="form-label">Êó•Êúü</label>
                  <input type="date" class="form-control" id="mc-mood-date" required>
                </div>
                
                <div class="mb-3">
                  <label class="form-label">‰ªäÂ§©ÁöÑÂøÉÊÉÖ</label>
                  <div class="mood-options">
                    <div class="mood-option" data-score="1" onclick="APP.Member.selectMood(1)">
                      <i class="bi bi-emoji-frown" style="color:#dc3545;"></i>
                      <div class="small">ÂæàÂ∑Æ</div>
                    </div>
                    <div class="mood-option" data-score="3" onclick="APP.Member.selectMood(3)">
                      <i class="bi bi-emoji-neutral" style="color:#ffc107;"></i>
                      <div class="small">ÊôÆÈÄö</div>
                    </div>
                    <div class="mood-option" data-score="5" onclick="APP.Member.selectMood(5)">
                      <i class="bi bi-emoji-smile" style="color:#28a745;"></i>
                      <div class="small">ÂæàÂ•Ω</div>
                    </div>
                  </div>
                </div>
                
                <div class="mb-3">
                  <label class="form-label">ÂøÉÊÉÖÊ®ôÁ±§</label>
                  <div class="mood-tags">
                    <span class="mood-tag" data-tag="ÈñãÂøÉ" onclick="APP.Member.toggleMoodTag('ÈñãÂøÉ')">üòä ÈñãÂøÉ</span>
                    <span class="mood-tag" data-tag="ÁÑ¶ÊÖÆ" onclick="APP.Member.toggleMoodTag('ÁÑ¶ÊÖÆ')">üò∞ ÁÑ¶ÊÖÆ</span>
                    <span class="mood-tag" data-tag="Áñ≤ÂÄ¶" onclick="APP.Member.toggleMoodTag('Áñ≤ÂÄ¶')">üò¥ Áñ≤ÂÄ¶</span>
                    <span class="mood-tag" data-tag="Ê≤ÆÂñ™" onclick="APP.Member.toggleMoodTag('Ê≤ÆÂñ™')">üòî Ê≤ÆÂñ™</span>
                    <span class="mood-tag" data-tag="Âπ≥Èùú" onclick="APP.Member.toggleMoodTag('Âπ≥Èùú')">üòå Âπ≥Èùú</span>
                    <span class="mood-tag" data-tag="ËààÂ•Æ" onclick="APP.Member.toggleMoodTag('ËààÂ•Æ')">ü§© ËààÂ•Æ</span>
                  </div>
                </div>
                
                <div class="mb-3">
                  <label class="form-label">‰ªäÂ§©ÁôºÁîü‰∫Ü‰ªÄÈ∫º...</label>
                  <textarea class="form-control" id="mc-mood-content" rows="5" placeholder="Ë®òÈåÑ‰ªäÂ§©ÁöÑÂøÉÊÉÖËàáÊÉ≥Ê≥ï..."></textarea>
                </div>
                
                <button type="submit" class="btn btn-gradient w-100">
                  <i class="bi bi-save me-2"></i>ÂÑ≤Â≠òÊó•Ë®ò
                </button>
              </form>
            </div>
          </div>
        </div>
        
        <!-- Ê¥ªÂãïÂ†±Âêç -->
        <div id="mc-events" class="member-section">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-calendar-event me-2"></i>ÊâÄÊúâÊ¥ªÂãï
            </div>
            <div class="card-body" id="mc-events-list">
              <div class="text-center text-muted py-3">ËºâÂÖ•‰∏≠...</div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <i class="bi bi-check-circle me-2"></i>ÊàëÁöÑÂ†±Âêç
            </div>
            <div class="card-body" id="mc-my-events-list">
              <div class="text-center text-muted py-3">ËºâÂÖ•‰∏≠...</div>
            </div>
          </div>
        </div>
        
        <!-- ÂÄã‰∫∫Ë≥áÊñô -->
        <div id="mc-profile" class="member-section">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-person me-2"></i>Âü∫Êú¨Ë≥áÊñô
            </div>
            <div class="card-body">
              <div class="mb-2"><strong>ÂßìÂêçÔºö</strong><span id="mc-profile-name">-</span></div>
              <div class="mb-2"><strong>ÊúÉÂì°Á∑®ËôüÔºö</strong><span id="mc-profile-no">-</span></div>
              <div class="mb-2"><strong>ÈõªÂ≠êÈÉµ‰ª∂Ôºö</strong><span id="mc-profile-email">-</span></div>
              <div class="mb-2"><strong>ÊâãÊ©üÔºö</strong><span id="mc-profile-phone">-</span></div>
              <div class="mb-2"><strong>Âú∞ÂùÄÔºö</strong><span id="mc-profile-address">-</span></div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <i class="bi bi-heart me-2"></i>ÊçêÊ¨æË®òÈåÑ
            </div>
            <div class="card-body" id="mc-donation-history">
              <div class="text-center text-muted py-3">ËºâÂÖ•‰∏≠...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== ÁÆ°ÁêÜÂæåÂè∞Ë¶ñÂúñ ==================== -->
    <div id="view-admin" class="view">
      <div class="admin-container">
        <div class="row g-0">
          <!-- ÂÅ¥ÈÇäÊ¨Ñ -->
          <div class="col-md-3 col-lg-2">
            <div class="admin-sidebar">
              <div class="admin-sidebar-header">
                <h5 class="mb-0">ÁÆ°ÁêÜÂæåÂè∞</h5>
              </div>
              <ul class="admin-menu">
                <li class="admin-menu-item" onclick="APP.Admin.show('dashboard')">
                  <i class="bi bi-speedometer2"></i>ÂÑÄË°®Êùø
                </li>
                <li class="admin-menu-item" onclick="APP.Admin.show('members')">
                  <i class="bi bi-people"></i>ÊúÉÂì°ÁÆ°ÁêÜ
                </li>
                <li class="admin-menu-item" onclick="APP.Admin.show('events')">
                  <i class="bi bi-calendar-event"></i>Ê¥ªÂãïÁÆ°ÁêÜ
                </li>
                <li class="admin-menu-item" onclick="APP.Admin.show('health')">
                  <i class="bi bi-clipboard-pulse"></i>ÂÅ•Â∫∑Ë®òÈåÑ
                </li>
                <li class="admin-menu-item" onclick="APP.Admin.show('donations')">
                  <i class="bi bi-heart"></i>ÊçêÊ¨æÁÆ°ÁêÜ
                </li>
                <li class="admin-menu-item" onclick="APP.Admin.show('volunteers')">
                  <i class="bi bi-hand-thumbs-up"></i>ÂøóÂ∑•ÁÆ°ÁêÜ
                </li>
                <li class="admin-menu-item" onclick="APP.Admin.show('finance')">
                  <i class="bi bi-cash-stack"></i>Ë≤°ÂãôÁÆ°ÁêÜ
                </li>
                <li class="admin-menu-item" onclick="APP.Router.go('member')">
                  <i class="bi bi-arrow-left"></i>ËøîÂõûÊúÉÂì°‰∏≠ÂøÉ
                </li>
              </ul>
            </div>
          </div>
          
          <!-- ‰∏ªË¶ÅÂÖßÂÆπ -->
          <div class="col-md-9 col-lg-10">
            <!-- ÂÑÄË°®Êùø -->
            <div id="admin-dashboard" class="admin-section active">
              <div class="p-4">
                <h3 class="mb-4">Á≥ªÁµ±Ê¶ÇË¶Ω</h3>
                
                <div class="row g-3 mb-4">
                  <div class="col-md-3">
                    <div class="stat-card">
                      <i class="bi bi-people text-primary"></i>
                      <div class="stat-value" id="admin-stat-members">0</div>
                      <div class="stat-label">Á∏ΩÊúÉÂì°Êï∏</div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="stat-card">
                      <i class="bi bi-calendar-event text-success"></i>
                      <div class="stat-value" id="admin-stat-events">0</div>
                      <div class="stat-label">Êú¨ÊúàÊ¥ªÂãï</div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="stat-card">
                      <i class="bi bi-hand-thumbs-up text-warning"></i>
                      <div class="stat-value" id="admin-stat-volunteers">0</div>
                      <div class="stat-label">ÂøóÂ∑•‰∫∫Êï∏</div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="stat-card">
                      <i class="bi bi-heart text-danger"></i>
                      <div class="stat-value" id="admin-stat-donations">$0</div>
                      <div class="stat-label">Êú¨ÊúàÊçêÊ¨æ</div>
                    </div>
                  </div>
                </div>
                
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="card">
                      <div class="card-header">
                        <i class="bi bi-activity me-2"></i>ÊúÄËøëÂãïÊÖã
                      </div>
                      <div class="card-body" id="admin-recent-activities">
                        <div class="text-center text-muted py-3">ËºâÂÖ•‰∏≠...</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="card">
                      <div class="card-header">
                        <i class="bi bi-exclamation-triangle me-2"></i>ÂæÖËôïÁêÜ‰∫ãÈ†Ö
                      </div>
                      <div class="card-body" id="admin-pending-tasks">
                        <div class="text-center text-muted py-3">ËºâÂÖ•‰∏≠...</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ÊúÉÂì°ÁÆ°ÁêÜ -->
            <div id="admin-members" class="admin-section">
              <div class="p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                  <h3>ÊúÉÂì°ÁÆ°ÁêÜ</h3>
                  <button class="btn btn-primary" onclick="APP.Admin.openAddMember()">
                    <i class="bi bi-plus-circle me-2"></i>Êñ∞Â¢ûÊúÉÂì°
                  </button>
                </div>
                
                <div class="card">
                  <div class="card-body">
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <input type="text" class="form-control" placeholder="ÊêúÂ∞ãÊúÉÂì°..." id="admin-member-search">
                      </div>
                      <div class="col-md-3">
                        <select class="form-select" id="admin-member-status">
                          <option value="">ÂÖ®ÈÉ®ÁãÄÊÖã</option>
                          <option value="Â∑≤ÂØ©Ê†∏">Â∑≤ÂØ©Ê†∏</option>
                          <option value="ÂæÖÂØ©Ê†∏">ÂæÖÂØ©Ê†∏</option>
                          <option value="Â∑≤ÂÅúÁî®">Â∑≤ÂÅúÁî®</option>
                        </select>
                      </div>
                      <div class="col-md-3">
                        <button class="btn btn-primary w-100" onclick="APP.Admin.loadMembers(1, document.getElementById('admin-member-search').value, document.getElementById('admin-member-status').value)">
                          <i class="bi bi-search me-2"></i>ÊêúÂ∞ã
                        </button>
                      </div>
                    </div>
                    
                    <div id="admin-members-list">
                      <div class="text-center text-muted py-4">ËºâÂÖ•‰∏≠...</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Ê¥ªÂãïÁÆ°ÁêÜ -->
            <div id="admin-events" class="admin-section">
              <div class="p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                  <h3>Ê¥ªÂãïÁÆ°ÁêÜ</h3>
                  <button class="btn btn-primary" onclick="APP.Admin.openAddEvent()">
                    <i class="bi bi-plus-circle me-2"></i>Êñ∞Â¢ûÊ¥ªÂãï
                  </button>
                </div>
                
                <div class="card">
                  <div class="card-body" id="admin-events-list">
                    <div class="text-center text-muted py-4">ËºâÂÖ•‰∏≠...</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ÂÅ•Â∫∑Ë®òÈåÑ -->
            <div id="admin-health" class="admin-section">
              <div class="p-4">
                <h3 class="mb-4">ÂÅ•Â∫∑Ë®òÈåÑ</h3>
                
                <div class="card">
                  <div class="card-body" id="admin-health-list">
                    <div class="text-center text-muted py-4">ËºâÂÖ•‰∏≠...</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ÊçêÊ¨æÁÆ°ÁêÜ -->
            <div id="admin-donations" class="admin-section">
              <div class="p-4">
                <h3 class="mb-4">ÊçêÊ¨æÁÆ°ÁêÜ</h3>
                
                <div class="card">
                  <div class="card-body" id="admin-donations-list">
                    <div class="text-center text-muted py-4">ËºâÂÖ•‰∏≠...</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ÂøóÂ∑•ÁÆ°ÁêÜ -->
            <div id="admin-volunteers" class="admin-section">
              <div class="p-4">
                <h3 class="mb-4">ÂøóÂ∑•ÁÆ°ÁêÜ</h3>
                
                <div class="card">
                  <div class="card-body" id="admin-volunteers-list">
                    <div class="text-center text-muted py-4">ËºâÂÖ•‰∏≠...</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Ë≤°ÂãôÁÆ°ÁêÜ -->
            <div id="admin-finance" class="admin-section">
              <div class="p-4">
                <h3 class="mb-4">Ë≤°ÂãôÁÆ°ÁêÜ</h3>
                
                <div class="row g-3 mb-4">
                  <div class="col-md-4">
                    <div class="stat-card">
                      <i class="bi bi-arrow-down-circle text-success"></i>
                      <div class="stat-value text-success" id="admin-total-income">$0</div>
                      <div class="stat-label">Á∏ΩÊî∂ÂÖ•</div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="stat-card">
                      <i class="bi bi-arrow-up-circle text-danger"></i>
                      <div class="stat-value text-danger" id="admin-total-expense">$0</div>
                      <div class="stat-label">Á∏ΩÊîØÂá∫</div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="stat-card">
                      <i class="bi bi-wallet2 text-primary"></i>
                      <div class="stat-value text-primary" id="admin-net-balance">$0</div>
                      <div class="stat-label">Ê∑®È§òÈ°ç</div>
                    </div>
                  </div>
                </div>
                
                <div class="card">
                  <div class="card-body" id="admin-finance-list">
                    <div class="text-center text-muted py-4">ËºâÂÖ•‰∏≠...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Toast/Modal/Loading ÂÆπÂô® -->
  <div id="toastContainer" class="toast-container"></div>
  <div id="modalContainer"></div>
  <div id="globalLoading" class="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  <script>
// ========== Â∏ïÈáëÊ£ÆÁóÖÂèãÊúÉÊï¥ÂêàÁ≥ªÁµ± - ÂÆåÊï¥ JavaScript ==========

const APP = {
  State: {
    LIFF_IDS: {
      app: '1656516134-X9oq92g9',
      auth: '1656516134-k8rMQwnQ',
      member: '1656516134-VaGgmaPm'
    },
    API: {
      primary: localStorage.getItem('API_URL') || 'https://script.google.com/macros/s/AKfycbyZ2Lmy3nRHdPu54QErL1qI6MEJER-zEe6Xdt3A-rrY692B6EiZcWwjhWGtR6c23mrMeA/exec',
      alt: localStorage.getItem('admin_API_URL') || 'https://script.google.com/macros/s/AKfycbyZ2Lmy3nRHdPu54QErL1qI6MEJER-zEe6Xdt3A-rrY692B6EiZcWwjhWGtR6c23mrMeA/exec'
    },
    API_KEY: 'AAbb8520258185202581',
    userProfile: null,
    memberInfo: null,
    isAdmin: false,
    routerView: 'auth',
    pageSize: 20
  },

  // ========== Â∑•ÂÖ∑ÂáΩÊï∏ ==========
  Util: {
    showLoading(show) {
      const el = document.getElementById('globalLoading');
      if (el) el.classList.toggle('show', !!show);
    },
    
    toast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      
      const colors = { 
        success: '#28a745', 
        error: '#dc3545', 
        warning: '#ffc107', 
        info: '#17a2b8' 
      };
      const icons = { 
        success: 'check-circle-fill', 
        error: 'x-circle-fill', 
        warning: 'exclamation-triangle-fill', 
        info: 'info-circle-fill' 
      };
      
      const toast = document.createElement('div');
      toast.className = 'toast show';
      toast.style.cssText = `min-width:250px;margin-bottom:10px;background:white;border-left:4px solid ${colors[type]};box-shadow:0 4px 12px rgba(0,0,0,0.15);`;
      toast.innerHTML = `
        <div class="toast-body d-flex align-items-center">
          <i class="bi bi-${icons[type]} me-2" style="color:${colors[type]};font-size:18px;"></i>
          <div class="flex-grow-1" style="font-size:14px;">${message}</div>
          <button type="button" class="btn-close ms-2" aria-label="Close"></button>
        </div>`;
      
      toast.querySelector('.btn-close').onclick = () => toast.remove();
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    },
    
    modal(html, onSubmit) {
      const container = document.getElementById('modalContainer');
      if (!container) return;
      
      container.innerHTML = html;
      const modalEl = container.querySelector('.modal');
      const formEl = container.querySelector('form');
      const bsModal = new bootstrap.Modal(modalEl);
      
      if (formEl && typeof onSubmit === 'function') {
        formEl.addEventListener('submit', async (e) => {
          e.preventDefault();
          const btn = formEl.querySelector('button[type="submit"]');
          APP.Util.setBtnLoading(btn, true);
          try {
            const fd = new FormData(formEl);
            await onSubmit(fd);
            bsModal.hide();
          } catch (err) {
            APP.Util.toast(err.message || 'Êìç‰ΩúÂ§±Êïó', 'error');
          } finally {
            APP.Util.setBtnLoading(btn, false);
          }
        });
      }
      
      modalEl.addEventListener('hidden.bs.modal', () => container.innerHTML = '', { once: true });
      bsModal.show();
    },
    
    setBtnLoading(button, loading) {
      if (!button) return;
      if (loading) {
        button.disabled = true;
        button.dataset.originalText = button.innerHTML;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ËôïÁêÜ‰∏≠...';
      } else {
        button.disabled = false;
        if (button.dataset.originalText) button.innerHTML = button.dataset.originalText;
      }
    },
    
    formatDate(dateInput) {
      if (!dateInput) return '-';
      try {
        let d;
        if (dateInput instanceof Date) {
          d = dateInput;
        } else if (typeof dateInput === 'number') {
          d = new Date(dateInput);
        } else if (typeof dateInput === 'string') {
          const parsed = Date.parse(dateInput);
          d = isNaN(parsed) ? new Date(dateInput) : new Date(parsed);
        } else {
          return '-';
        }
        
        if (isNaN(d.getTime())) return '-';
        
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}/${month}/${day}`;
      } catch {
        return '-';
      }
    },
    
    formatDateInput(dateString) {
      if (!dateString) return '';
      try {
        const d = (dateString instanceof Date) ? dateString : new Date(dateString);
        if (isNaN(d.getTime())) return '';
        return d.toISOString().split('T')[0];
      } catch {
        return '';
      }
    },
    
    currency(n) {
      try {
        return new Intl.NumberFormat('zh-TW').format(Number(n || 0));
      } catch {
        return '0';
      }
    },
    
    getStatusClass(status) {
      const map = {
        'Â∑≤ÂØ©Ê†∏': 'success', 'ÂæÖÂØ©Ê†∏': 'warning', 'Â∑≤ÂÅúÁî®': 'danger',
        'Â†±Âêç‰∏≠': 'info', 'Â∑≤È°çÊªø': 'warning', 'Â∑≤ÁµêÊùü': 'secondary',
        'Â∑≤ÂèñÊ∂à': 'danger', 'Â∑≤ÂÆåÊàê': 'success', 'ËôïÁêÜ‰∏≠': 'warning',
        'Â∑≤ÂïüÁî®': 'success', 'Â∑≤ÊçêÊ¨æ': 'success', 'ÈñãÊîæÂ†±Âêç': 'info'
      };
      return map[status] || 'secondary';
    }
  },

  // ========== ÈÖçÁΩÆ ==========
  Config: {
    updateAPIUrl() {
      const input = document.getElementById('global-api-url');
      if (!input) return;
      
      const v = input.value.trim();
      if (!v) {
        APP.Util.toast('Ë´ãËº∏ÂÖ•ÊúâÊïà URL', 'error');
        return;
      }
      
      APP.State.API.primary = v;
      APP.State.API.alt = v;
      localStorage.setItem('API_URL', v);
      localStorage.setItem('admin_API_URL', v);
      
      const displayEl = document.getElementById('current-api-url');
      if (displayEl) displayEl.textContent = v;
      
      APP.Util.toast('API Á∂≤ÂùÄÂ∑≤Êõ¥Êñ∞', 'success');
    }
  },

  // ========== Ë∑ØÁî± ==========
  Router: {
    go(view) {
      APP.State.routerView = view;
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      const viewEl = document.getElementById('view-' + view);
      if (viewEl) viewEl.classList.add('active');
      
      if (view === 'member') {
        APP.Member.initMember();
      } else if (view === 'admin') {
        APP.Admin.initAdmin();
      }
    },
    
    goAdmin() {
      if (!APP.State.isAdmin) {
        APP.Util.toast('ÊÇ®Ê≤íÊúâÁÆ°ÁêÜÂì°Ê¨äÈôê', 'error');
        return;
      }
      APP.Router.go('admin');
    }
  },

  // ========== LIFF ==========
  LIFF: {
    inited: false,
    
    async initAny() {
      if (APP.LIFF.inited) return;
      try {
        const anyId = APP.State.LIFF_IDS.app || APP.State.LIFF_IDS.auth || APP.State.LIFF_IDS.member;
        if (anyId && typeof liff !== 'undefined') {
          await liff.init({ liffId: anyId });
          APP.LIFF.inited = true;
        }
      } catch (e) {
        console.log('LIFF init error:', e);
      }
    },
    
    async ensureLogged() {
      try {
        await APP.LIFF.initAny();
        if (typeof liff !== 'undefined' && !liff.isLoggedIn()) {
          liff.login();
        }
      } catch (e) {
        console.log('LIFF login error:', e);
      }
    },
    
    async profile() {
      try {
        await APP.LIFF.initAny();
        if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
          return await liff.getProfile();
        }
      } catch (e) {
        console.log('LIFF profile error:', e);
      }
      return null;
    }
  },

  // ========== API ==========
  API: {
    async call(action, data = {}) {
      try {
        const payload = {
          apiKey: APP.State.API_KEY,
          action,
          ...data
        };
        
        if (APP.State.memberInfo && !data.memberId && !data.lineId) {
          payload.memberId = APP.State.memberInfo.memberId;
        }
        
        if (APP.State.userProfile && !data.lineId) {
          payload.lineId = APP.State.userProfile.userId;
        }
        
        const response = await fetch(APP.State.API.primary, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success && result.message) {
          throw new Error(result.message);
        }
        
        return result;
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }
  },

  // ========== Ë™çË≠â ==========
  Auth: {
    debug(message) {
      const el = document.getElementById('auth-debug');
      if (!el) return;
      const ts = new Date().toLocaleTimeString();
      el.innerHTML += `[${ts}] ${message}<br/>`;
      el.scrollTop = 999999;
    },
    
    setAlert(msg, type = 'info') {
      const el = document.getElementById('auth-alert');
      if (!el) return;
      el.className = 'alert alert-' + (type === 'error' ? 'danger' : type);
      el.textContent = msg;
      el.classList.remove('d-none');
      setTimeout(() => el.classList.add('d-none'), 5000);
    },
    
    setLoading(on) {
      const el = document.getElementById('auth-loading');
      if (el) el.classList.toggle('d-none', !on);
    },
    
    async init() {
      // Tab ÂàáÊèõ
      document.querySelectorAll('.auth-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          document.querySelectorAll('.auth-pane').forEach(p => p.classList.remove('active'));
          const paneId = tab.dataset.pane;
          const pane = document.getElementById(paneId);
          if (pane) pane.classList.add('active');
        });
      });
      
      const urlEl = document.getElementById('current-api-url');
      if (urlEl) urlEl.textContent = APP.State.API.primary;
      
      const inputEl = document.getElementById('global-api-url');
      if (inputEl) inputEl.value = APP.State.API.primary;
      
      // Ê™¢Êü•Â∑≤ÁôªÂÖ•
      const stored = localStorage.getItem('memberInfo');
      if (stored) {
        try {
          APP.State.memberInfo = JSON.parse(stored);
          APP.State.isAdmin = !!APP.State.memberInfo?.isAdmin;
          APP.Router.go('member');
          return;
        } catch (e) {
          localStorage.removeItem('memberInfo');
        }
      }
      
      // ÂàùÂßãÂåñ LIFF
      try {
        await APP.LIFF.initAny();
        if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          APP.Auth.debug('Â∑≤ÁôªÂÖ• LINE: ' + profile.displayName);
        }
      } catch (err) {
        APP.Auth.debug('LIFF ÂàùÂßãÂåñÂ§±Êïó: ' + err.message);
      }
    },
    
    async testAPIConnection() {
      APP.Auth.setLoading(true);
      try {
        APP.Auth.debug('ÈñãÂßãÊ∏¨Ë©¶ API...');
        const result = await APP.API.call('test');
        APP.Auth.setLoading(false);
        if (result?.success) {
          APP.Auth.setAlert('API ÈÄ£Á∑öÊàêÂäüÔºÅ', 'success');
          APP.Auth.debug('Ê∏¨Ë©¶ÊàêÂäü: ' + JSON.stringify(result));
        } else {
          APP.Auth.setAlert('API ÂõûÊáâÁï∞Â∏∏', 'warning');
        }
      } catch (e) {
        APP.Auth.setLoading(false);
        APP.Auth.setAlert('API ÈÄ£Á∑öÂ§±ÊïóÔºö' + e.message, 'error');
        APP.Auth.debug('ÈåØË™§: ' + e.message);
      }
    },
    
    clearDebug() {
      const el = document.getElementById('auth-debug');
      if (el) {
        el.innerHTML = '';
        APP.Auth.debug('Â∑≤Ê∏ÖÈô§Èô§ÈåØË®òÈåÑ');
      }
    },
    
    async handleEmailLogin(e) {
      e.preventDefault();
      const emailEl = document.getElementById('login-email');
      const passwordEl = document.getElementById('login-password');
      
      if (!emailEl || !passwordEl) return;
      
      const email = emailEl.value.trim();
      const password = passwordEl.value;
      
      APP.Auth.setLoading(true);
      try {
        const result = await APP.API.call('login', { email, password });
        APP.Auth.setLoading(false);
        
        if (result?.success) {
          APP.State.memberInfo = result.data;
          APP.State.isAdmin = !!result.data?.isAdmin;
          localStorage.setItem('memberInfo', JSON.stringify(result.data));
          APP.Auth.setAlert('ÁôªÂÖ•ÊàêÂäüÔºÅ', 'success');
          setTimeout(() => APP.Router.go('member'), 800);
        } else {
          APP.Auth.setAlert(result?.message || 'ÁôªÂÖ•Â§±Êïó', 'error');
        }
      } catch (e2) {
        APP.Auth.setLoading(false);
        APP.Auth.setAlert('Á≥ªÁµ±ÈåØË™§Ôºö' + e2.message, 'error');
      }
    },
    
    async handleLineLogin() {
      APP.Auth.debug('ÈñãÂßã LINE ÁôªÂÖ•');
      try {
        await APP.LIFF.ensureLogged();
        
        if (typeof liff === 'undefined' || !liff.isLoggedIn()) {
          APP.Auth.setAlert('LINE ÁôªÂÖ•Â§±Êïó', 'error');
          return;
        }
        
        const profile = await liff.getProfile();
        APP.Auth.debug('LINE ‰ΩøÁî®ËÄÖÔºö' + profile.displayName);
        APP.Auth.setLoading(true);
        
        const result = await APP.API.call('lineLogin', {
          lineUserId: profile.userId,
          displayName: profile.displayName,
          pictureUrl: profile.pictureUrl || ''
        });
        
        APP.Auth.setLoading(false);
        
        if (result?.success) {
          APP.State.memberInfo = result.data;
          APP.State.isAdmin = !!result.data?.isAdmin;
          localStorage.setItem('memberInfo', JSON.stringify(result.data));
          APP.Auth.setAlert('ÁôªÂÖ•ÊàêÂäüÔºÅ', 'success');
          setTimeout(() => APP.Router.go('member'), 800);
        } else {
          APP.Auth.setAlert(result?.message || 'LINE ÁôªÂÖ•Â§±Êïó', 'error');
        }
      } catch (e) {
        APP.Auth.setLoading(false);
        APP.Auth.setAlert('LINE ÁôªÂÖ•Â§±ÊïóÔºö' + e.message, 'error');
        APP.Auth.debug('ÈåØË™§: ' + e.message);
      }
    },
    
    async handleRegister(e) {
      e.preventDefault();
      const form = e.target;
      
      const pwd = form.elements['reg-password']?.value;
      const pwd2 = form.elements['reg-password-confirm']?.value;
      
      if (pwd !== pwd2) {
        APP.Auth.setAlert('ÂÖ©Ê¨°ÂØÜÁ¢º‰∏ç‰∏ÄËá¥', 'error');
        return;
      }
      
      APP.Auth.setLoading(true);
      try {
        let lineUserId = '';
        try {
          await APP.LIFF.initAny();
          if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
            const p = await liff.getProfile();
            lineUserId = p.userId;
          }
        } catch {}
        
        const result = await APP.API.call('register', {
          name: form.elements['reg-name']?.value,
          gender: form.elements['reg-gender']?.value,
          birthday: form.elements['reg-birthday']?.value,
          phone: form.elements['reg-phone']?.value,
          email: form.elements['reg-email']?.value,
          password: pwd,
          lineUserId
        });
        
        APP.Auth.setLoading(false);
        
        if (result?.success) {
          APP.Auth.setAlert('Ë®ªÂÜäÊàêÂäüÔºÅË´ãÁ≠âÂæÖÁÆ°ÁêÜÂì°ÂØ©Ê†∏', 'success');
          const loginTab = document.querySelector('.auth-tab[data-pane="pane-login"]');
          if (loginTab) loginTab.click();
        } else {
          APP.Auth.setAlert(result?.message || 'Ë®ªÂÜäÂ§±Êïó', 'error');
        }
      } catch (e2) {
        APP.Auth.setLoading(false);
        APP.Auth.setAlert('Á≥ªÁµ±ÈåØË™§Ôºö' + e2.message, 'error');
      }
    },
    
    logout() {
      localStorage.removeItem('memberInfo');
      try {
        if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
          liff.logout();
        }
      } catch (e) {}
      APP.State.memberInfo = null;
      APP.State.isAdmin = false;
      APP.Router.go('auth');
    }
  },

  // ========== ÊúÉÂì°‰∏≠ÂøÉ ==========
  Member: {
    selectedMood: 5,
    selectedTags: [],
    
    async initMember() {
      const info = APP.State.memberInfo;
      if (info) {
        const nameEl = document.getElementById('mc-name');
        const noEl = document.getElementById('mc-no');
        const avatarEl = document.getElementById('mc-avatar');
        
        if (nameEl) nameEl.textContent = info.name || '-';
        if (noEl) noEl.textContent = 'ÊúÉÂì°Á∑®ËôüÔºö' + (info.memberNo || '---');
        if (avatarEl) avatarEl.textContent = (info.name || 'A').charAt(0);
      }
      
      // Ê¨äÈôêË®≠ÂÆö
      const isAdmin = !!APP.State.memberInfo?.isAdmin;
      APP.State.isAdmin = isAdmin;
      document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = isAdmin ? 'block' : 'none';
      });
      
      // ÂàùÂßãÂåñ Range È°ØÁ§∫
      APP.Member.initRangeDisplays();
      
      // Ë®≠ÂÆöÁï∂ÂâçÊó•Êúü
      APP.Member.setDefaultDates();
      
      // ËºâÂÖ•Ë≥áÊñô
      APP.Member.loadTodayReminders();
      APP.Member.loadUpcomingEvents();
    },
    
    initRangeDisplays() {
      const ranges = ['tremor', 'rigidity', 'brady', 'balance'];
      ranges.forEach(id => {
        const input = document.getElementById(`mc-${id}`);
        const display = document.getElementById(`mc-${id}-val`);
        if (input && display) {
          input.addEventListener('input', () => {
            display.textContent = input.value;
          });
        }
      });
    },
    
    setDefaultDates() {
      const today = new Date().toISOString().split('T')[0];
      const dateInputs = [
        'mc-mood-date',
        'mc-ex-date',
        'mc-sleep-date'
      ];
      dateInputs.forEach(id => {
        const el = document.getElementById(id);
        if (el && !el.value) el.value = today;
      });
    },
    
    show(section) {
      document.querySelectorAll('.member-section').forEach(s => s.classList.remove('active'));
      const el = document.getElementById('mc-' + section);
      if (el) el.classList.add('active');
      
      switch (section) {
        case 'home':
          APP.Member.loadTodayReminders();
          APP.Member.loadUpcomingEvents();
          break;
        case 'symptom':
          APP.Member.loadSymptomHistory();
          break;
        case 'medication':
          APP.Member.loadMedications();
          break;
        case 'events':
          APP.Member.loadEvents();
          APP.Member.loadMyEvents();
          break;
        case 'profile':
          APP.Member.loadProfile();
          APP.Member.loadDonationHistory();
          break;
      }
    },
    
    async loadTodayReminders() {
      const c = document.getElementById('mc-today-reminders');
      if (!c) return;
      
      try {
        const result = await APP.API.call('getMedications', {
          memberId: APP.State.memberInfo?.memberId
        });
        const arr = result.data || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">‰ªäÂ§©Ê≤íÊúâÊèêÈÜí‰∫ãÈ†Ö</div>';
          return;
        }
        
        let html = '';
        arr.forEach(m => {
          let times = [];
          try {
            times = JSON.parse(m.frequency || '[]');
          } catch {}
          
          times.forEach(t => {
            html += `
              <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                <div>
                  <div class="fw-bold">üíä ${m.medicineName}</div>
                  <div class="small text-muted">${t} - ${m.dosage || ''}</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="APP.Member.logMedication('${m.medicationId}','${t}')">Â∑≤ÊúçÁî®</button>
              </div>
            `;
          });
        });
        
        c.innerHTML = html || '<div class="text-center text-muted py-4">‰ªäÂ§©Ê≤íÊúâÊèêÈÜí‰∫ãÈ†Ö</div>';
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">ËºâÂÖ•Â§±Êïó</div>';
      }
    },
    
    async loadUpcomingEvents() {
      const c = document.getElementById('mc-upcoming-events');
      if (!c) return;
      
      try {
        const today = new Date().toISOString().split('T')[0];
        const result = await APP.API.call('getEvents', {
          status: 'Â†±Âêç‰∏≠',
          startDate: today,
          page: 1,
          pageSize: 3
        });
        const arr = result.data || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">ÁõÆÂâçÊ≤íÊúâÊ¥ªÂãï</div>';
          return;
        }
        
        c.innerHTML = arr.slice(0, 3).map(ev => `
          <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
            <div>
              <div class="fw-bold">${ev.eventName || ev.title}</div>
              <div class="small text-muted">üìÖ ${APP.Util.formatDate(ev.eventDate || ev.date)} ${ev.startTime || ev.time || ''}„ÄÄüìç ${ev.location || 'Êú™ÊåáÂÆö'}</div>
            </div>
            <span class="badge bg-info">${ev.registrationCount || ev.currentCount || 0}/${ev.maxParticipants || 0}</span>
          </div>
        `).join('');
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">ËºâÂÖ•Â§±Êïó</div>';
      }
    },
    
    async addSymptom(e) {
      e.preventDefault();
      
      try {
        const result = await APP.API.call('addDailySymptom', {
          memberId: APP.State.memberInfo?.memberId,
          recordDate: new Date().toISOString().split('T')[0],
          tremorLevel: document.getElementById('mc-tremor')?.value || 0,
          rigidityLevel: document.getElementById('mc-rigidity')?.value || 0,
          bradykinesiaLevel: document.getElementById('mc-brady')?.value || 0,
          balanceLevel: document.getElementById('mc-balance')?.value || 0,
          notes: document.getElementById('mc-symptom-notes')?.value || ''
        });
        
        if (result?.success) {
          APP.Util.toast('Ë®òÈåÑÊàêÂäü', 'success');
          e.target.reset();
          APP.Member.loadSymptomHistory();
        } else {
          APP.Util.toast(result?.message || 'Êñ∞Â¢ûÂ§±Êïó', 'error');
        }
      } catch (e2) {
        APP.Util.toast('Á≥ªÁµ±ÈåØË™§Ôºö' + e2.message, 'error');
      }
    },
    
    async loadSymptomHistory() {
      const c = document.getElementById('mc-symptom-history');
      if (!c) return;
      
      try {
        const end = new Date().toISOString().split('T')[0];
        const start = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        const result = await APP.API.call('getDailySymptoms', {
          memberId: APP.State.memberInfo?.memberId,
          startDate: start,
          endDate: end
        });
        const arr = result.data || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">Â∞öÁÑ°Ë®òÈåÑ</div>';
          return;
        }
        
        c.innerHTML = arr.map(s => `
          <div class="border rounded p-2 mb-2">
            <div class="fw-bold">${APP.Util.formatDate(s.recordDate)}</div>
            <div class="small text-muted">
              È°´Êäñ:${s.tremorLevel} | ÂÉµÁ°¨:${s.rigidityLevel} |
              ÈÅ≤Á∑©:${s.bradykinesiaLevel} | Âπ≥Ë°°:${s.balanceLevel}
            </div>
            ${s.notes ? `<div class="small text-muted mt-1">${s.notes}</div>` : ''}
          </div>
        `).join('');
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">ËºâÂÖ•Â§±Êïó</div>';
      }
    },
    
    openAddMedication() {
      const html = `
        <div class="modal fade" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Êñ∞Â¢ûÁî®Ëó•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">Ëó•Áâ©ÂêçÁ®± *</label>
                  <input class="form-control" name="name" required/>
                </div>
                <div class="mb-3">
                  <label class="form-label">ÂäëÈáè</label>
                  <input class="form-control" name="dosage" placeholder="‰æãÂ¶ÇÔºö1È°Ü"/>
                </div>
                <div class="mb-3">
                  <label class="form-label mb-2">ÊúçÁî®ÊôÇÈñìÔºàËá≥Â∞ë‰∏ÄÂÄãÔºâ</label><br/>
                  ${['08:00', '12:00', '18:00', '22:00'].map(t => `
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="checkbox" name="times" value="${t}" id="t-${t}">
                      <label class="form-check-label" for="t-${t}">${t}</label>
                    </div>`).join('')}
                </div>
                <div class="mb-3">
                  <label class="form-label">ÈñãÂßãÊó•Êúü</label>
                  <input type="date" class="form-control" name="startdate" value="${new Date().toISOString().split('T')[0]}"/>
                </div>
                <div class="form-check mb-3">
                  <input class="form-check-input" type="checkbox" name="reminder" id="reminder" checked/>
                  <label class="form-check-label" for="reminder">ÂïüÁî®ÊèêÈÜí</label>
                </div>
                <div class="mb-3">
                  <label class="form-label">ÊèêÂâçÊèêÈÜíÔºàÂàÜÈêòÔºâ</label>
                  <input type="number" class="form-control" name="advance" value="10" min="0"/>
                </div>
                <div class="mb-3">
                  <label class="form-label">ÂÇôË®ª</label>
                  <textarea class="form-control" name="notes" rows="3"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                <button class="btn btn-primary" type="submit">Êñ∞Â¢ûÁî®Ëó•</button>
              </div>
            </form>
          </div>
        </div>`;
      
      APP.Util.modal(html, async (fd) => {
        const times = fd.getAll('times');
        if (!times.length) throw new Error('Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄãÊúçËó•ÊôÇÈñì');
        
        const result = await APP.API.call('addMedication', {
          memberId: APP.State.memberInfo?.memberId,
          medicineName: fd.get('name'),
          dosage: fd.get('dosage'),
          frequency: JSON.stringify(times),
          startDate: fd.get('startdate') || new Date().toISOString().split('T')[0],
          reminderEnabled: fd.get('reminder') === 'on',
          reminderMinutes: fd.get('advance') || 10,
          notes: fd.get('notes') || ''
        });
        
        if (result?.success) {
          APP.Util.toast('Áî®Ëó•Êñ∞Â¢ûÊàêÂäü', 'success');
          APP.Member.loadMedications();
          APP.Member.loadTodayReminders();
        }
      });
    },
    
    async loadMedications() {
      const c = document.getElementById('mc-medications-list');
      if (!c) return;
      
      try {
        const result = await APP.API.call('getMedications', {
          memberId: APP.State.memberInfo?.memberId
        });
        const arr = result.data || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">Â∞öÁÑ°Áî®Ëó•Ë≥áÊñô</div>';
          return;
        }
        
        c.innerHTML = arr.map(m => {
          let times = [];
          try { times = JSON.parse(m.frequency || '[]'); } catch {}
          
          return `
            <div class="border rounded p-3 mb-2">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-bold">${m.medicineName}</div>
                  <div class="small text-muted">ÂäëÈáèÔºö${m.dosage || '-'}</div>
                  <div class="small text-muted">ÊôÇÈñìÔºö${times.join(', ')}</div>
                  <div class="small text-muted">ÈñãÂßãÊó•ÊúüÔºö${APP.Util.formatDate(m.startDate)}</div>
                  ${m.notes ? `<div class="small text-muted">ÂÇôË®ªÔºö${m.notes}</div>` : ''}
                </div>
                <span class="badge ${m.reminderEnabled ? 'bg-success' : 'bg-secondary'}">
                  ${m.reminderEnabled ? 'ÊèêÈÜíÈñãÂïü' : 'ÊèêÈÜíÈóúÈñâ'}
                </span>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">ËºâÂÖ•Â§±Êïó</div>';
      }
    },
    
    async logMedication(medicationId, scheduledTime) {
      try {
        const result = await APP.API.call('logMedication', {
          medicationId,
          memberId: APP.State.memberInfo?.memberId,
          scheduledTime,
          status: 'Â∑≤ÊúçÁî®'
        });
        
        if (result?.success) {
          APP.Util.toast('Â∑≤Ë®òÈåÑÊúçËó•', 'success');
          APP.Member.loadTodayReminders();
        }
      } catch (e) {
        APP.Util.toast('Ë®òÈåÑÂ§±ÊïóÔºö' + e.message, 'error');
      }
    },
    
    async addExercise(e) {
      e.preventDefault();
      
      try {
        const result = await APP.API.call('addExerciseLog', {
          memberId: APP.State.memberInfo?.memberId,
          exerciseDate: document.getElementById('mc-ex-date')?.value,
          exerciseType: document.getElementById('mc-ex-type')?.value,
          duration: document.getElementById('mc-ex-duration')?.value,
          intensity: document.getElementById('mc-ex-intensity')?.value,
          bodyCondition: document.getElementById('mc-ex-condition')?.value,
          notes: document.getElementById('mc-ex-notes')?.value || ''
        });
        
        if (result?.success) {
          APP.Util.toast('ÈÅãÂãïË®òÈåÑÊàêÂäü', 'success');
          e.target.reset();
          APP.Member.setDefaultDates();
        }
      } catch (e2) {
        APP.Util.toast('Ë®òÈåÑÂ§±ÊïóÔºö' + e2.message, 'error');
      }
    },
    
    async addSleep(e) {
      e.preventDefault();
      
      try {
        const bedtime = document.getElementById('mc-sleep-bedtime')?.value;
        const waketime = document.getElementById('mc-sleep-wake')?.value;
        
        let duration = 0;
        if (bedtime && waketime) {
          const bed = new Date('2000-01-01 ' + bedtime);
          let wake = new Date('2000-01-01 ' + waketime);
          if (wake < bed) wake = new Date('2000-01-02 ' + waketime);
          duration = ((wake - bed) / (1000 * 60 * 60)).toFixed(1);
        }
        
        const result = await APP.API.call('addSleepLog', {
          memberId: APP.State.memberInfo?.memberId,
          sleepDate: document.getElementById('mc-sleep-date')?.value,
          bedtime,
          wakeTime: waketime,
          duration,
          quality: document.getElementById('mc-sleep-quality')?.value,
          wakeCount: document.getElementById('mc-sleep-wake-count')?.value || 0,
          hasDream: document.getElementById('mc-sleep-dream')?.checked || false,
          hasNightmare: document.getElementById('mc-sleep-nightmare')?.checked || false,
          notes: document.getElementById('mc-sleep-notes')?.value || ''
        });
        
        if (result?.success) {
          APP.Util.toast('Áù°Áú†Ë®òÈåÑÊàêÂäü', 'success');
          e.target.reset();
          APP.Member.setDefaultDates();
        }
      } catch (e2) {
        APP.Util.toast('Ë®òÈåÑÂ§±ÊïóÔºö' + e2.message, 'error');
      }
    },
    
    selectMood(score) {
      APP.Member.selectedMood = score;
      document.querySelectorAll('.mood-option').forEach(opt => {
        opt.classList.toggle('active', parseInt(opt.dataset.score) === score);
      });
    },
    
    toggleMoodTag(tag) {
      const idx = APP.Member.selectedTags.indexOf(tag);
      if (idx > -1) {
        APP.Member.selectedTags.splice(idx, 1);
      } else {
        APP.Member.selectedTags.push(tag);
      }
      
      document.querySelectorAll('.mood-tag').forEach(t => {
        t.classList.toggle('active', APP.Member.selectedTags.includes(t.dataset.tag));
      });
    },
    
    async addMood(e) {
      e.preventDefault();
      
      try {
        const result = await APP.API.call('addMoodDiary', {
          memberId: APP.State.memberInfo?.memberId,
          diaryDate: document.getElementById('mc-mood-date')?.value,
          moodScore: APP.Member.selectedMood,
          moodTags: APP.Member.selectedTags.join(','),
          content: document.getElementById('mc-mood-content')?.value || ''
        });
        
        if (result?.success) {
          APP.Util.toast('ÂøÉÊÉÖÊó•Ë®òË®òÈåÑÊàêÂäü', 'success');
          e.target.reset();
          APP.Member.selectedMood = 5;
          APP.Member.selectedTags = [];
          document.querySelectorAll('.mood-option').forEach(o => o.classList.remove('active'));
          document.querySelectorAll('.mood-tag').forEach(t => t.classList.remove('active'));
          APP.Member.setDefaultDates();
        }
      } catch (e2) {
        APP.Util.toast('Ë®òÈåÑÂ§±ÊïóÔºö' + e2.message, 'error');
      }
    },
    
    async loadEvents() {
      const c = document.getElementById('mc-events-list');
      if (!c) return;
      
      try {
        const result = await APP.API.call('getAllEvents');
        const arr = result.data || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">ÁõÆÂâçÊ≤íÊúâÊ¥ªÂãï</div>';
          return;
        }
        
        c.innerHTML = arr.map(ev => `
          <div class="border rounded p-3 mb-2">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="fw-bold">${ev.eventName || ev.title}</div>
              <span class="badge bg-${APP.Util.getStatusClass(ev.status)}">${ev.status}</span>
            </div>
            <div class="small text-muted mb-2">${ev.description || ''}</div>
            <div class="small text-muted">
              üìÖ ${APP.Util.formatDate(ev.eventDate || ev.date)} ${ev.startTime || ev.time || ''}-${ev.endTime || ''}<br/>
              üìç ${ev.location || 'Êú™ÊåáÂÆö'}<br/>
              üë• ${ev.registrationCount || ev.currentCount || 0}/${ev.maxParticipants || 0}
              ${ev.fee ? `<br/>üí∞ $${APP.Util.currency(ev.fee)}` : ''}
            </div>
            ${(ev.status === 'Â†±Âêç‰∏≠' || ev.status === 'ÈñãÊîæÂ†±Âêç') ? `
              <button class="btn btn-sm btn-primary mt-2" onclick="APP.Member.registerEvent('${ev.id || ev.eventId}')">
                Á´ãÂç≥Â†±Âêç
              </button>` : ''}
          </div>
        `).join('');
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">ËºâÂÖ•Â§±Êïó</div>';
      }
    },
    
    async loadMyEvents() {
      const c = document.getElementById('mc-my-events-list');
      if (!c) return;
      
      try {
        const result = await APP.API.call('getMyEvents', {
          memberId: APP.State.memberInfo?.memberId
        });
        const arr = result.data || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">ÊÇ®ÈÇÑÊ≤íÊúâÂ†±Âêç‰ªª‰ΩïÊ¥ªÂãï</div>';
          return;
        }
        
        c.innerHTML = arr.map(ev => `
          <div class="border rounded p-3 mb-2">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-bold">${ev.eventName || ev.activityTitle}</div>
                <div class="small text-muted">
                  üìÖ ${APP.Util.formatDate(ev.eventDate || ev.date)} ${ev.startTime || ev.time || ''}<br/>
                  üìç ${ev.location || ''}
                </div>
              </div>
              <span class="badge bg-${APP.Util.getStatusClass(ev.registrationStatus || ev.status)}">
                ${ev.registrationStatus || ev.status}
              </span>
            </div>
          </div>
        `).join('');
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">ËºâÂÖ•Â§±Êïó</div>';
      }
    },
    
    async registerEvent(eventId) {
      if (!confirm('Á¢∫ÂÆöË¶ÅÂ†±ÂêçÊ≠§Ê¥ªÂãïÂóéÔºü')) return;
      
      try {
        const result = await APP.API.call('registerActivity', {
          activityId: eventId,
          memberId: APP.State.memberInfo?.memberId
        });
        
        if (result?.success) {
          APP.Util.toast('Â†±ÂêçÊàêÂäüÔºÅ', 'success');
          APP.Member.loadEvents();
          APP.Member.loadMyEvents();
        }
      } catch (e) {
        APP.Util.toast('Â†±ÂêçÂ§±ÊïóÔºö' + e.message, 'error');
      }
    },
    
    async loadProfile() {
      try {
        const result = await APP.API.call('getMemberInfo', {
          memberId: APP.State.memberInfo?.memberId
        });
        const info = result.data || {};
        
        const setEl = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.textContent = val || '-';
        };
        
        setEl('mc-profile-name', info.name);
        setEl('mc-profile-no', info.memberNo);
        setEl('mc-profile-email', info.email);
        setEl('mc-profile-phone', info.phone);
        setEl('mc-profile-address', info.address);
      } catch (e) {
        console.error('loadProfile error:', e);
      }
    },
    
    async loadDonationHistory() {
      const c = document.getElementById('mc-donation-history');
      if (!c) return;
      
      try {
        const result = await APP.API.call('getFinanceData', {
          memberId: APP.State.memberInfo?.memberId
        });
        const arr = result.data?.donations || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">Â∞öÁÑ°ÊçêÊ¨æË®òÈåÑ</div>';
          return;
        }
        
        c.innerHTML = arr.map(d => `
          <div class="border rounded p-2 mb-2">
            <div class="d-flex justify-content-between">
              <div>
                <div class="fw-bold">$${APP.Util.currency(d.amount)}</div>
                <div class="small text-muted">${d.category || '‰∏ÄËà¨ÊçêÊ¨æ'} - ${APP.Util.formatDate(d.createdAt || d.donationDate)}</div>
              </div>
              <span class="badge bg-${APP.Util.getStatusClass(d.status)}">${d.status}</span>
            </div>
          </div>
        `).join('');
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">ËºâÂÖ•Â§±Êïó</div>';
      }
    }
  },

  // ========== ÁÆ°ÁêÜÂæåÂè∞ ==========
  Admin: {
    currentPage: 1,
    
    async initAdmin() {
      APP.Admin.show('dashboard');
    },
    
    show(section) {
      document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
      const el = document.getElementById('admin-' + section);
      if (el) el.classList.add('active');
      
      switch (section) {
        case 'dashboard':
          APP.Admin.loadDashboard();
          break;
        case 'members':
          APP.Admin.loadMembers();
          break;
        case 'events':
          APP.Admin.loadEvents();
          break;
        case 'health':
          APP.Admin.loadHealthRecords();
          break;
        case 'donations':
          APP.Admin.loadDonations();
          break;
        case 'volunteers':
          APP.Admin.loadVolunteers();
          break;
        case 'finance':
          APP.Admin.loadFinance();
          break;
      }
    },
    
    async loadDashboard() {
      try {
        const result = await APP.API.call('getDashboardStats');
        const stats = result.data || {};
        
        const setEl = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.textContent = val;
        };
        
        setEl('admin-stat-members', stats.totalMembers || 0);
        setEl('admin-stat-events', stats.monthlyEvents || 0);
        setEl('admin-stat-volunteers', stats.totalVolunteers || 0);
        setEl('admin-stat-donations', '$' + APP.Util.currency(stats.monthlyDonations || 0));
        
        const actResult = await APP.API.call('getRecentActivities');
        APP.Admin.renderRecentActivities(actResult.data || []);
        
        const taskResult = await APP.API.call('getPendingTasks');
        APP.Admin.renderPendingTasks(taskResult.data || []);
      } catch (e) {
        console.error('loadDashboard error:', e);
      }
    },
    
    renderRecentActivities(arr) {
      const c = document.getElementById('admin-recent-activities');
      if (!c) return;
      
      if (!arr.length) {
        c.innerHTML = '<div class="text-center text-muted py-3">Êö´ÁÑ°ÂãïÊÖã</div>';
        return;
      }
      
      c.innerHTML = arr.map(a => `
        <div class="d-flex align-items-start mb-2 pb-2 border-bottom">
          <i class="bi bi-circle-fill text-primary me-2" style="font-size:8px;margin-top:6px;"></i>
          <div class="flex-grow-1">
            <div class="small">${a.description}</div>
            <div class="text-muted" style="font-size:11px;">${a.timestamp}</div>
          </div>
        </div>
      `).join('');
    },
    
    renderPendingTasks(arr) {
      const c = document.getElementById('admin-pending-tasks');
      if (!c) return;
      
      if (!arr.length) {
        c.innerHTML = '<div class="text-center text-muted py-3">Ê≤íÊúâÂæÖËôïÁêÜ‰∫ãÈ†Ö</div>';
        return;
      }
      
      c.innerHTML = arr.map(t => `
        <div class="border rounded p-2 mb-2">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-bold">${t.title}</div>
              <div class="small text-muted">${t.description}</div>
            </div>
            <span class="badge bg-${t.priority === 'È´ò' ? 'danger' : 'warning'}">${t.priority}</span>
          </div>
        </div>
      `).join('');
    },
    
    async loadMembers(page = 1, search = '', status = '') {
      APP.Admin.currentPage = page;
      const c = document.getElementById('admin-members-list');
      if (!c) return;
      
      try {
        APP.Util.showLoading(true);
        const result = await APP.API.call('getMembers', {
          page,
          pageSize: APP.State.pageSize,
          search,
          status
        });
        const arr = result.data || [];
        const totalPages = result.totalPages || 1;
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">Êü•ÁÑ°Ë≥áÊñô</div>';
          return;
        }
        
        c.innerHTML = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ÊúÉÂì°Á∑®Ëôü</th>
                <th>ÂßìÂêç</th>
                <th>ÈõªÂ≠êÈÉµ‰ª∂</th>
                <th>ÊâãÊ©ü</th>
                <th>Ë®ªÂÜäÊó•Êúü</th>
                <th>ÁãÄÊÖã</th>
                <th>Êìç‰Ωú</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(m => `
                <tr>
                  <td>${m.memberNo || '-'}</td>
                  <td>${m.name || '-'}</td>
                  <td>${m.email || '-'}</td>
                  <td>${m.phone || '-'}</td>
                  <td>${APP.Util.formatDate(m.registerDate || m.createdAt)}</td>
                  <td><span class="badge bg-${APP.Util.getStatusClass(m.status)}">${m.status}</span></td>
                  <td>
                    ${m.status === 'ÂæÖÂØ©Ê†∏' ? `
                      <button class="btn btn-sm btn-success" onclick="APP.Admin.approveMember('${m.memberId || m.id}')">
                        <i class="bi bi-check"></i>
                      </button>` : ''}
                    <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteMember('${m.memberId || m.id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          ${APP.Admin.renderPagination(page, totalPages, 'loadMembers')}
        `;
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">ËºâÂÖ•Â§±Êïó</div>';
      } finally {
        APP.Util.showLoading(false);
      }
    },
    
    renderPagination(current, total, funcName) {
      if (total <= 1) return '';
      
      let html = '<nav class="mt-3"><ul class="pagination justify-content-center">';
      
      if (current > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="APP.Admin.${funcName}(${current - 1});return false;">‰∏ä‰∏ÄÈ†Å</a></li>`;
      }
      
      for (let i = 1; i <= total; i++) {
        if (i === current) {
          html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else if (i === 1 || i === total || Math.abs(i - current) <= 2) {
          html += `<li class="page-item"><a class="page-link" href="#" onclick="APP.Admin.${funcName}(${i});return false;">${i}</a></li>`;
        } else if (Math.abs(i - current) === 3) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
      }
      
      if (current < total) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="APP.Admin.${funcName}(${current + 1});return false;">‰∏ã‰∏ÄÈ†Å</a></li>`;
      }
      
      html += '</ul></nav>';
      return html;
    },
    
    async approveMember(memberId) {
      if (!confirm('Á¢∫ÂÆöË¶ÅÊ†∏ÂáÜÊ≠§ÊúÉÂì°ÂóéÔºü')) return;
      
      try {
        await APP.API.call('approveMember', { memberId });
        APP.Util.toast('Â∑≤Ê†∏ÂáÜ', 'success');
        APP.Admin.loadMembers(APP.Admin.currentPage);
      } catch (e) {
        APP.Util.toast('Êìç‰ΩúÂ§±ÊïóÔºö' + e.message, 'error');
      }
    },
    
    async deleteMember(memberId) {
      if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÊúÉÂì°ÂóéÔºü')) return;
      
      try {
        await APP.API.call('deleteMember', { memberId });
        APP.Util.toast('Â∑≤Âà™Èô§', 'success');
        APP.Admin.loadMembers(APP.Admin.currentPage);
      } catch (e) {
        APP.Util.toast('Êìç‰ΩúÂ§±ÊïóÔºö' + e.message, 'error');
      }
    },
    
    openAddMember() {
      const html = `
        <div class="modal fade" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Êñ∞Â¢ûÊúÉÂì°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">ÂßìÂêç *</label>
                  <input class="form-control" name="name" required/>
                </div>
                <div class="mb-3">
                  <label class="form-label">ÈõªÂ≠êÈÉµ‰ª∂ *</label>
                  <input type="email" class="form-control" name="email" required/>
                </div>
                <div class="mb-3">
                  <label class="form-label">ÊâãÊ©ü</label>
                  <input class="form-control" name="phone"/>
                </div>
                <div class="mb-3">
                  <label class="form-label">Âú∞ÂùÄ</label>
                  <input class="form-control" name="address"/>
                </div>
                <div class="mb-3">
                  <label class="form-label">ÂÇôË®ª</label>
                  <textarea class="form-control" name="notes" rows="3"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                <button type="submit" class="btn btn-primary">Êñ∞Â¢û</button>
              </div>
            </form>
          </div>
        </div>`;
      
      APP.Util.modal(html, async (fd) => {
        await APP.API.call('addMember', {
          name: fd.get('name'),
          email: fd.get('email'),
          phone: fd.get('phone'),
          address: fd.get('address'),
          notes: fd.get('notes')
        });
        APP.Util.toast('ÊúÉÂì°Êñ∞Â¢ûÊàêÂäü', 'success');
        APP.Admin.loadMembers();
      });
    },
    
    async loadEvents(page = 1) {
      APP.Admin.currentPage = page;
      const c = document.getElementById('admin-events-list');
      if (!c) return;
      
      try {
        APP.Util.showLoading(true);
        const result = await APP.API.call('getEvents', {
          page,
          pageSize: APP.State.pageSize
        });
        const arr = result.data || [];
        const totalPages = result.totalPages || 1;
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">Êü•ÁÑ°Ë≥áÊñô</div>';
          return;
        }
        
        c.innerHTML = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Ê¥ªÂãïÂêçÁ®±</th>
                <th>È°ûÂûã</th>
                <th>Êó•Êúü</th>
                <th>Âú∞Èªû</th>
                <th>‰∫∫Êï∏</th>
                <th>ÁãÄÊÖã</th>
                <th>Êìç‰Ωú</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(e => `
                <tr>
                  <td>${e.eventName || e.title}</td>
                  <td>${e.eventType || e.type || '-'}</td>
                  <td>${APP.Util.formatDate(e.eventDate || e.date)}</td>
                  <td>${e.location || '-'}</td>
                  <td>${e.registrationCount || e.currentCount || 0}/${e.maxParticipants || 0}</td>
                  <td><span class="badge bg-${APP.Util.getStatusClass(e.status)}">${e.status}</span></td>
                  <td>
                    <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteEvent('${e.eventId || e.id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          ${APP.Admin.renderPagination(page, totalPages, 'loadEvents')}
        `;
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">ËºâÂÖ•Â§±Êïó</div>';
      } finally {
        APP.Util.showLoading(false);
      }
    },
    
    async deleteEvent(eventId) {
      if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ê¥ªÂãïÂóéÔºü')) return;
      
      try {
        await APP.API.call('deleteEvent', { eventId });
        APP.Util.toast('Â∑≤Âà™Èô§', 'success');
        APP.Admin.loadEvents(APP.Admin.currentPage);
      } catch (e) {
        APP.Util.toast('Êìç‰ΩúÂ§±ÊïóÔºö' + e.message, 'error');
      }
    },
    
    openAddEvent() {
      const html = `
        <div class="modal fade" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Êñ∞Â¢ûÊ¥ªÂãï</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">Ê¥ªÂãïÂêçÁ®± *</label>
                  <input class="form-control" name="eventName" required/>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ê¥ªÂãïÈ°ûÂûã</label>
                  <select class="form-select" name="eventType">
                    <option>Ë¨õÂ∫ß</option>
                    <option>ÈÅãÂãïË™≤Á®ã</option>
                    <option>ËÅØË™ºÊ¥ªÂãï</option>
                    <option>ÂÖ∂‰ªñ</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ê¥ªÂãïÊó•Êúü *</label>
                  <input type="date" class="form-control" name="eventDate" required/>
                </div>
                <div class="row mb-3">
                  <div class="col-6">
                    <label class="form-label">ÈñãÂßãÊôÇÈñì</label>
                    <input type="time" class="form-control" name="startTime" value="09:00"/>
                  </div>
                  <div class="col-6">
                    <label class="form-label">ÁµêÊùüÊôÇÈñì</label>
                    <input type="time" class="form-control" name="endTime" value="12:00"/>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Âú∞Èªû *</label>
                  <input class="form-control" name="location" required/>
                </div>
                <div class="mb-3">
                  <label class="form-label">‰∫∫Êï∏‰∏äÈôê *</label>
                  <input type="number" class="form-control" name="maxParticipants" value="30" required/>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ë≤ªÁî®</label>
                  <input type="number" class="form-control" name="fee" value="0"/>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ê¥ªÂãïË™™Êòé</label>
                  <textarea class="form-control" name="description" rows="3"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                <button type="submit" class="btn btn-primary">Êñ∞Â¢û</button>
              </div>
            </form>
          </div>
        </div>`;
      
      APP.Util.modal(html, async (fd) => {
        await APP.API.call('createEvent', {
          eventName: fd.get('eventName'),
          eventType: fd.get('eventType'),
          eventDate: fd.get('eventDate'),
          startTime: fd.get('startTime'),
          endTime: fd.get('endTime'),
          location: fd.get('location'),
          maxParticipants: fd.get('maxParticipants'),
          fee: fd.get('fee'),
          description: fd.get('description')
        });
        APP.Util.toast('Ê¥ªÂãïÊñ∞Â¢ûÊàêÂäü', 'success');
        APP.Admin.loadEvents();
      });
    },
    
    async loadHealthRecords(page = 1) {
      APP.Admin.currentPage = page;
      const c = document.getElementById('admin-health-list');
      if (!c) return;
      
      try {
        APP.Util.showLoading(true);
        const result = await APP.API.call('getAllHealthRecords', {
          page,
          pageSize: APP.State.pageSize
        });
        const arr = result.data || [];
        const totalPages = result.totalPages || 1;
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">Êü•ÁÑ°Ë≥áÊñô</div>';
          return;
        }
        
        c.innerHTML = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ÊúÉÂì°ÂßìÂêç</th>
                <th>Ë®òÈåÑÊó•Êúü</th>
                <th>È°´Êäñ</th>
                <th>ÂÉµÁ°¨</th>
                <th>ÈÅ≤Á∑©</th>
                <th>Âπ≥Ë°°</th>
                <th>ÂÇôË®ª</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(r => `
                <tr>
                  <td>${r.memberName || '-'}</td>
                  <td>${APP.Util.formatDate(r.recordDate)}</td>
                  <td>${r.tremorLevel}</td>
                  <td>${r.rigidityLevel}</td>
                  <td>${r.bradykinesiaLevel}</td>
                  <td>${r.balanceLevel}</td>
                  <td>${r.notes || '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          ${APP.Admin.renderPagination(page, totalPages, 'loadHealthRecords')}
        `;
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">ËºâÂÖ•Â§±Êïó</div>';
      } finally {
        APP.Util.showLoading(false);
      }
    },
    
    async loadDonations(page = 1) {
      APP.Admin.currentPage = page;
      const c = document.getElementById('admin-donations-list');
      if (!c) return;
      
      try {
        APP.Util.showLoading(true);
        const result = await APP.API.call('getDonations', {
          page,
          pageSize: APP.State.pageSize
        });
        const arr = result.data || [];
        const totalPages = result.totalPages || 1;
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">Êü•ÁÑ°Ë≥áÊñô</div>';
          return;
        }
        
        c.innerHTML = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ÊçêÊ¨æ‰∫∫</th>
                <th>ÈáëÈ°ç</th>
                <th>È°ûÂûã</th>
                <th>Êó•Êúü</th>
                <th>‰ªòÊ¨æÊñπÂºè</th>
                <th>ÁãÄÊÖã</th>
                <th>Êìç‰Ωú</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(d => `
                <tr>
                  <td>${d.donorName || d.memberName || '-'}</td>
                  <td>$${APP.Util.currency(d.amount)}</td>
                  <td>${d.donationType || d.category || '-'}</td>
                  <td>${APP.Util.formatDate(d.donationDate || d.createdAt)}</td>
                  <td>${d.paymentMethod || '-'}</td>
                  <td><span class="badge bg-${APP.Util.getStatusClass(d.status)}">${d.status}</span></td>
                  <td>
                    <button class="btn btn-sm btn-danger" onclick="APP.Admin.deleteDonation('${d.donationId || d.id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          ${APP.Admin.renderPagination(page, totalPages, 'loadDonations')}
        `;
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">ËºâÂÖ•Â§±Êïó</div>';
      } finally {
        APP.Util.showLoading(false);
      }
    },
    
    async deleteDonation(donationId) {
      if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÊçêÊ¨æË®òÈåÑÂóéÔºü')) return;
      
      try {
        await APP.API.call('deleteDonation', { donationId });
        APP.Util.toast('Â∑≤Âà™Èô§', 'success');
        APP.Admin.loadDonations(APP.Admin.currentPage);
      } catch (e) {
        APP.Util.toast('Êìç‰ΩúÂ§±ÊïóÔºö' + e.message, 'error');
      }
    },
    
    async loadVolunteers() {
      const c = document.getElementById('admin-volunteers-list');
      if (!c) return;
      
      try {
        APP.Util.showLoading(true);
        const result = await APP.API.call('getVolunteers');
        const arr = result.data || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">Êü•ÁÑ°Ë≥áÊñô</div>';
          return;
        }
        
        c.innerHTML = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ÂøóÂ∑•Á∑®Ëôü</th>
                <th>ÂßìÂêç</th>
                <th>ÊâãÊ©ü</th>
                <th>Âä†ÂÖ•Êó•Êúü</th>
                <th>Á∏ΩÊôÇÊï∏</th>
                <th>ÁãÄÊÖã</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(v => `
                <tr>
                  <td>${v.volunteerNo || '-'}</td>
                  <td>${v.name || '-'}</td>
                  <td>${v.phone || '-'}</td>
                  <td>${APP.Util.formatDate(v.joinDate)}</td>
                  <td>${v.totalHours || 0}Â∞èÊôÇ</td>
                  <td><span class="badge bg-${APP.Util.getStatusClass(v.status)}">${v.status}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">ËºâÂÖ•Â§±Êïó</div>';
      } finally {
        APP.Util.showLoading(false);
      }
    },
    
    async loadFinance() {
      const c = document.getElementById('admin-finance-list');
      if (!c) return;
      
      try {
        APP.Util.showLoading(true);
        const result = await APP.API.call('getFinanceRecords', {});
        const data = result.data || {};
        
        const setEl = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.textContent = val;
        };
        
        setEl('admin-total-income', '$' + APP.Util.currency(data.totalIncome || 0));
        setEl('admin-total-expense', '$' + APP.Util.currency(data.totalExpense || 0));
        setEl('admin-net-balance', '$' + APP.Util.currency((data.totalIncome || 0) - (data.totalExpense || 0)));
        
        const arr = data.records || [];
        
        if (!arr.length) {
          c.innerHTML = '<div class="text-center text-muted py-4">Êü•ÁÑ°Ë≥áÊñô</div>';
          return;
        }
        
        c.innerHTML = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Êó•Êúü</th>
                <th>È°ûÂûã</th>
                <th>È°ûÂà•</th>
                <th>ÈáëÈ°ç</th>
                <th>Âª†ÂïÜ/ÊçêÊ¨æ‰∫∫</th>
                <th>Ë™™Êòé</th>
                <th>ÁãÄÊÖã</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(r => `
                <tr>
                  <td>${APP.Util.formatDate(r.transactionDate || r.date)}</td>
                  <td><span class="badge bg-${r.type === 'Êî∂ÂÖ•' ? 'success' : 'danger'}">${r.type}</span></td>
                  <td>${r.category}</td>
                  <td class="${r.type === 'Êî∂ÂÖ•' ? 'text-success' : 'text-danger'}">
                    ${r.type === 'Êî∂ÂÖ•' ? '+' : '-'}$${APP.Util.currency(r.amount)}
                  </td>
                  <td>${r.vendor || r.donorName || '-'}</td>
                  <td>${r.description || '-'}</td>
                  <td><span class="badge bg-${APP.Util.getStatusClass(r.status)}">${r.status}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (e) {
        c.innerHTML = '<div class="text-center text-danger py-4">ËºâÂÖ•Â§±Êïó</div>';
      } finally {
        APP.Util.showLoading(false);
      }
    }
  }
};

// ========== ÂàùÂßãÂåñ ==========
document.addEventListener('DOMContentLoaded', async () => {
  console.log('Á≥ªÁµ±ÂàùÂßãÂåñ‰∏≠...');
  
  // ÂàùÂßãÂåñË™çË≠â
  await APP.Auth.init();
  
  // Á∂ÅÂÆöÂÖ®Âüü‰∫ã‰ª∂
  const loginForm = document.getElementById('emailLoginForm');
  if (loginForm) {
    loginForm.addEventListener('submit', APP.Auth.handleEmailLogin);
  }
  
  const regForm = document.getElementById('registerForm');
  if (regForm) {
    regForm.addEventListener('submit', APP.Auth.handleRegister);
  }
  
  const symptomForm = document.getElementById('mc-symptom-form');
  if (symptomForm) {
    symptomForm.addEventListener('submit', APP.Member.addSymptom);
  }
  
  const exerciseForm = document.getElementById('mc-exercise-form');
  if (exerciseForm) {
    exerciseForm.addEventListener('submit', APP.Member.addExercise);
  }
  
  const sleepForm = document.getElementById('mc-sleep-form');
  if (sleepForm) {
    sleepForm.addEventListener('submit', APP.Member.addSleep);
  }
  
  const moodForm = document.getElementById('mc-mood-form');
  if (moodForm) {
    moodForm.addEventListener('submit', APP.Member.addMood);
  }
  
  // Ë®≠ÂÆöÁï∂Ââç API URL
  const urlDisplay = document.getElementById('current-api-url');
  if (urlDisplay) urlDisplay.textContent = APP.State.API.primary;
  
  const urlInput = document.getElementById('global-api-url');
  if (urlInput) urlInput.value = APP.State.API.primary;
  
  console.log('Á≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàê');
});

// Êö¥Èú≤ÂÖ®ÂüüÂáΩÊï∏‰æõ HTML onclick ‰ΩøÁî®
window.APP = APP;

// ========== È°çÂ§ñÁöÑ UI Â¢ûÂº∑ ==========

// Ëá™ÂãïÈö±Ëóè Alert
document.addEventListener('DOMContentLoaded', () => {
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        const target = mutation.target;
        if (target.classList.contains('alert') && !target.classList.contains('d-none')) {
          setTimeout(() => {
            target.classList.add('d-none');
          }, 5000);
        }
      }
    });
  });
  
  const alerts = document.querySelectorAll('.alert');
  alerts.forEach(alert => {
    observer.observe(alert, { attributes: true });
  });
});

// Ë°®ÂñÆÈ©óË≠âÂ¢ûÂº∑
document.addEventListener('DOMContentLoaded', () => {
  const forms = document.querySelectorAll('form');
  forms.forEach(form => {
    form.addEventListener('submit', (e) => {
      if (!form.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
      }
      form.classList.add('was-validated');
    });
  });
});

// Ëá™ÂãïË™øÊï¥ Textarea È´òÂ∫¶
document.addEventListener('DOMContentLoaded', () => {
  const textareas = document.querySelectorAll('textarea');
  textareas.forEach(textarea => {
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
  });
});

// ÂúñÁâáËºâÂÖ•ÈåØË™§ËôïÁêÜ
document.addEventListener('DOMContentLoaded', () => {
  document.addEventListener('error', (e) => {
    if (e.target.tagName === 'IMG') {
      e.target.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23f0f0f0" width="100" height="100"/%3E%3Ctext x="50" y="50" text-anchor="middle" dominant-baseline="middle" font-size="40"%3Eüë§%3C/text%3E%3C/svg%3E';
    }
  }, true);
});

// Á∂≤Ë∑ØÁãÄÊÖãÁõ£Êéß
window.addEventListener('online', () => {
  APP.Util.toast('Á∂≤Ë∑ØÈÄ£Á∑öÂ∑≤ÊÅ¢Âæ©', 'success');
});

window.addEventListener('offline', () => {
  APP.Util.toast('Á∂≤Ë∑ØÈÄ£Á∑öÂ∑≤‰∏≠Êñ∑', 'warning');
});

// Èò≤Ê≠¢ÈáçË§áÊèê‰∫§
document.addEventListener('DOMContentLoaded', () => {
  let isSubmitting = false;
  
  document.addEventListener('submit', (e) => {
    if (isSubmitting) {
      e.preventDefault();
      return false;
    }
    
    isSubmitting = true;
    setTimeout(() => {
      isSubmitting = false;
    }, 2000);
  });
});

// Smooth Scroll
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
      const href = this.getAttribute('href');
      if (href === '#') return;
      
      e.preventDefault();
      const target = document.querySelector(href);
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });
});

// ËøîÂõûÈ†ÇÈÉ®ÊåâÈàïÔºàÂèØÈÅ∏Ôºâ
document.addEventListener('DOMContentLoaded', () => {
  const backToTop = document.createElement('button');
  backToTop.innerHTML = '<i class="bi bi-arrow-up"></i>';
  backToTop.className = 'btn btn-primary';
  backToTop.style.cssText = `
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: none;
    z-index: 1000;
    padding: 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  `;
  
  backToTop.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
  
  document.body.appendChild(backToTop);
  
  window.addEventListener('scroll', () => {
    if (window.pageYOffset > 300) {
      backToTop.style.display = 'block';
    } else {
      backToTop.style.display = 'none';
    }
  });
});

// ÈçµÁõ§Âø´Êç∑ÈçµÔºàÂèØÈÅ∏Ôºâ
document.addEventListener('keydown', (e) => {
  // Ctrl/Cmd + K: ÊêúÂ∞ã
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    const searchInput = document.querySelector('input[type="search"], input[placeholder*="ÊêúÂ∞ã"]');
    if (searchInput) searchInput.focus();
  }
  
  // ESC: ÈóúÈñâ Modal
  if (e.key === 'Escape') {
    const modals = document.querySelectorAll('.modal.show');
    modals.forEach(modal => {
      const bsModal = bootstrap.Modal.getInstance(modal);
      if (bsModal) bsModal.hide();
    });
  }
});

// Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÂäüËÉΩ
window.copyToClipboard = async (text) => {
  try {
    await navigator.clipboard.writeText(text);
    APP.Util.toast('Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø', 'success');
  } catch (err) {
    // Fallback
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    APP.Util.toast('Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø', 'success');
  }
};

// ÂàóÂç∞ÂäüËÉΩ
window.printPage = () => {
  window.print();
};

// ÂåØÂá∫Ë≥áÊñôÁÇ∫ CSVÔºàÁØÑ‰æãÔºâ
window.exportToCSV = (data, filename = 'export.csv') => {
  if (!data || !data.length) {
    APP.Util.toast('Ê≤íÊúâË≥áÊñôÂèØÂåØÂá∫', 'warning');
    return;
  }
  
  const headers = Object.keys(data[0]);
  const csv = [
    headers.join(','),
    ...data.map(row => headers.map(header => {
      const value = row[header] || '';
      return `"${String(value).replace(/"/g, '""')}"`;
    }).join(','))
  ].join('\n');
  
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
  URL.revokeObjectURL(link.href);
  
  APP.Util.toast('ÂåØÂá∫ÊàêÂäü', 'success');
};

// Êó•ÊúüÊ†ºÂºèÂåñËºîÂä©
window.formatDateTime = (date) => {
  if (!date) return '-';
  const d = new Date(date);
  if (isNaN(d.getTime())) return '-';
  
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  const hours = String(d.getHours()).padStart(2, '0');
  const minutes = String(d.getMinutes()).padStart(2, '0');
  
  return `${year}/${month}/${day} ${hours}:${minutes}`;
};

// Ê™îÊ°àÂ§ßÂ∞èÊ†ºÂºèÂåñ
window.formatFileSize = (bytes) => {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
};

// ÈõªË©±ËôüÁ¢ºÊ†ºÂºèÂåñ
window.formatPhone = (phone) => {
  if (!phone) return '-';
  const cleaned = phone.replace(/\D/g, '');
  if (cleaned.length === 10) {
    return cleaned.replace(/(\d{4})(\d{3})(\d{3})/, '$1-$2-$3');
  }
  return phone;
};

// Ë∫´ÂàÜË≠âÂ≠óËôüÈ©óË≠âÔºàÂè∞ÁÅ£Ôºâ
window.validateTWID = (id) => {
  if (!id || !/^[A-Z][12]\d{8}$/.test(id)) return false;
  
  const letters = 'ABCDEFGHJKLMNPQRSTUVXYWZIO';
  const weights = [1, 9, 8, 7, 6, 5, 4, 3, 2, 1, 1];
  
  let sum = Math.floor((letters.indexOf(id[0]) + 10) / 10) + 
            (letters.indexOf(id[0]) + 10) % 10 * 9;
  
  for (let i = 1; i < 10; i++) {
    sum += parseInt(id[i]) * weights[i];
  }
  
  return sum % 10 === 0;
};

// Email È©óË≠â
window.validateEmail = (email) => {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
};

// ÊâãÊ©üËôüÁ¢ºÈ©óË≠âÔºàÂè∞ÁÅ£Ôºâ
window.validatePhone = (phone) => {
  const cleaned = phone.replace(/\D/g, '');
  return /^09\d{8}$/.test(cleaned);
};

// ÂØÜÁ¢ºÂº∑Â∫¶Ê™¢Êü•
window.checkPasswordStrength = (password) => {
  if (!password) return { strength: 0, text: 'ÁÑ°' };
  
  let strength = 0;
  if (password.length >= 8) strength++;
  if (password.length >= 12) strength++;
  if (/[a-z]/.test(password)) strength++;
  if (/[A-Z]/.test(password)) strength++;
  if (/[0-9]/.test(password)) strength++;
  if (/[^a-zA-Z0-9]/.test(password)) strength++;
  
  const levels = ['Ê•µÂº±', 'Âº±', 'ÊôÆÈÄö', 'Âº∑', 'ÂæàÂº∑', 'Ê•µÂº∑'];
  return {
    strength: Math.min(strength, 5),
    text: levels[Math.min(strength, 5)]
  };
};

// Êú¨Âú∞ÂÑ≤Â≠òËºîÂä©
window.storage = {
  set: (key, value) => {
    try {
      localStorage.setItem(key, JSON.stringify(value));
      return true;
    } catch (e) {
      console.error('Storage set error:', e);
      return false;
    }
  },
  get: (key, defaultValue = null) => {
    try {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : defaultValue;
    } catch (e) {
      console.error('Storage get error:', e);
      return defaultValue;
    }
  },
  remove: (key) => {
    try {
      localStorage.removeItem(key);
      return true;
    } catch (e) {
      console.error('Storage remove error:', e);
      return false;
    }
  },
  clear: () => {
    try {
      localStorage.clear();
      return true;
    } catch (e) {
      console.error('Storage clear error:', e);
      return false;
    }
  }
};

// Èò≤ÊäñÂáΩÊï∏
window.debounce = (func, wait = 300) => {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
};

// ÁØÄÊµÅÂáΩÊï∏
window.throttle = (func, limit = 300) => {
  let inThrottle;
  return function(...args) {
    if (!inThrottle) {
      func.apply(this, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
};

// Ê∑±Â∫¶Ë§áË£Ω
window.deepClone = (obj) => {
  if (obj === null || typeof obj !== 'object') return obj;
  if (obj instanceof Date) return new Date(obj.getTime());
  if (obj instanceof Array) return obj.map(item => deepClone(item));
  if (obj instanceof Object) {
    const clonedObj = {};
    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {
        clonedObj[key] = deepClone(obj[key]);
      }
    }
    return clonedObj;
  }
};

// Èö®Ê©ü ID ÁîüÊàê
window.generateId = (length = 16) => {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
};

// UUID v4 ÁîüÊàê
window.generateUUID = () => {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
};

console.log('üè• Â∏ïÈáëÊ£ÆÁóÖÂèãÊúÉÊï¥ÂêàÁ≥ªÁµ±Â∑≤ËºâÂÖ•ÂÆåÊàê');
console.log('üì± Á≥ªÁµ±ÁâàÊú¨: 1.0.0');
console.log('üîß ÈñãÁôºÊ®°Âºè:', location.hostname === 'localhost' ? 'ÊòØ' : 'Âê¶');
</script>

  </script>
</body>
</html>


