<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BOGOÂ§öÁ¶èÊ∞£ ÂúòÈöäÂàÜÊûêÁ≥ªÁµ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 10px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      text-align: center;
    }
    
    .header h1 {
      color: #667eea;
      font-size: clamp(1.5em, 5vw, 2.5em);
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: clamp(0.9em, 2vw, 1em);
    }
    
    .btn {
      padding: 12px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: clamp(0.9em, 2vw, 1em);
      font-weight: 600;
      transition: background 0.3s;
      white-space: nowrap;
    }
    
    .btn:hover {
      background: #5568d3;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .team-container {
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      page-break-inside: avoid;
    }
    
    .team-header {
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: clamp(1.2em, 4vw, 1.8em);
      font-weight: bold;
    }
    
    .section-title {
      background: #8b5cf6;
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: clamp(1em, 3vw, 1.2em);
      font-weight: bold;
      margin: 20px 0 15px 0;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-radius: 8px;
      overflow: hidden;
      font-size: clamp(0.8em, 2vw, 0.95em);
    }
    
    .data-table thead {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
    }
    
    .data-table th {
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
      font-size: 0.9em;
    }
    
    .data-table th:last-child,
    .data-table td:last-child {
      text-align: right;
    }
    
    .data-table tbody tr {
      border-bottom: 1px solid #f3f4f6;
      transition: background 0.2s;
    }
    
    .data-table tbody tr:hover {
      background: #faf5ff;
    }
    
    .data-table td {
      padding: 8px;
      color: #374151;
    }
    
    .data-table .total-row {
      background: #fef3c7;
      font-weight: bold;
      color: #92400e;
    }
    
    .data-table .total-row td {
      padding: 10px 8px;
      border-top: 2px solid #f59e0b;
    }
    
    .person-card {
      border: 3px solid #8b5cf6;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      background: #faf5ff;
      page-break-inside: avoid;
    }
    
    .person-name {
      color: #6b21a8;
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 10px;
      padding: 8px 12px;
      background: white;
      border-radius: 8px;
      border-left: 5px solid #8b5cf6;
    }
    
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-radius: 8px;
      overflow-x: auto;
      display: block;
      font-size: clamp(0.75em, 2vw, 0.95em);
    }
    
    .summary-table table {
      width: 100%;
      min-width: 600px;
    }
    
    .summary-table thead {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .summary-table th {
      padding: 12px 8px;
      text-align: center;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .summary-table tbody tr {
      border-bottom: 1px solid #f3f4f6;
    }
    
    .summary-table tbody tr:hover {
      background: #f0fdf4;
    }
    
    .summary-table td {
      padding: 10px 8px;
      text-align: center;
      color: #000;
    }
    
    .summary-table td:first-child {
      text-align: left;
      font-weight: 600;
      position: sticky;
      left: 0;
      background: white;
      z-index: 1;
    }
    
    .summary-table tbody tr:hover td:first-child {
      background: #f0fdf4;
    }
    
    /* ÂúòÈöäÈ°èËâ≤ */
    .team-color-1 { background: #fef3c7 !important; }
    .team-color-2 { background: #dbeafe !important; }
    .team-color-3 { background: #fce7f3 !important; }
    .team-color-4 { background: #d1fae5 !important; }
    .team-color-5 { background: #fef2f2 !important; }
    .team-color-6 { background: #f3e8ff !important; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      padding: 15px;
      border-radius: 10px;
      border-left: 4px solid #8b5cf6;
      text-align: center;
    }
    
    .stat-card .label {
      color: #6b7280;
      font-size: 0.85em;
      margin-bottom: 5px;
    }
    
    .stat-card .value {
      color: #8b5cf6;
      font-size: clamp(1.5em, 4vw, 2em);
      font-weight: bold;
    }
    
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }
    
    .loading.show {
      display: flex;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    .loading-text {
      color: white;
      font-size: 1.2em;
      font-weight: 600;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .alert {
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 15px;
      font-size: 0.9em;
    }
    
    .alert-success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .alert-error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .filter-bar {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .filter-bar label {
      font-weight: 600;
      font-size: clamp(0.9em, 2vw, 1em);
      white-space: nowrap;
    }
    
    select, input[type="text"] {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: clamp(0.9em, 2vw, 1em);
      min-width: 120px;
    }
    
    .comparison-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .comparison-title {
      color: #8b5cf6;
      font-size: clamp(1.2em, 4vw, 1.5em);
      font-weight: bold;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f3f4f6;
    }
    
    .sync-status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      margin-left: 10px;
    }
    
    .sync-status.syncing {
      background: #fef3c7;
      color: #92400e;
    }
    
    .sync-status.synced {
      background: #d1fae5;
      color: #065f46;
    }
    
    .maintenance-input {
      padding: 5px 10px;
      border: 1px solid #d1d5db;
      border-radius: 5px;
      font-size: 0.9em;
      width: 120px;
    }
    
    .maintenance-input:focus {
      outline: none;
      border-color: #8b5cf6;
    }
    
    .save-btn {
      padding: 5px 12px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.85em;
      margin-left: 5px;
    }
    
    .save-btn:hover {
      background: #059669;
    }
    
    @media print {
      @page {
        size: A4;
        margin: 15mm;
      }
      
      body {
        background: white;
        padding: 0;
      }
      
      .header, .filter-bar, .btn, .no-print {
        display: none !important;
      }
      
      .container {
        max-width: 100%;
      }
      
      .team-container {
        page-break-inside: avoid;
        box-shadow: none;
        border: 1px solid #e5e7eb;
      }
      
      .person-card {
        page-break-inside: avoid;
      }
      
      .comparison-section {
        page-break-before: always;
      }
      
      .page-number {
        display: block;
        text-align: center;
        margin-top: 10px;
        font-size: 0.9em;
        color: #6b7280;
      }
      
      .page-number:after {
        counter-increment: page;
        content: "Á¨¨ " counter(page) " È†Å";
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      
      .header {
        padding: 15px;
      }
      
      .team-container {
        padding: 15px;
      }
      
      .filter-bar {
        padding: 10px;
      }
      
      .data-table th,
      .data-table td {
        padding: 6px 4px;
        font-size: 0.8em;
      }
      
      .btn {
        padding: 10px 15px;
        font-size: 0.9em;
      }
    }
    
    .page-number {
      display: none;
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">ËºâÂÖ•‰∏≠...</div>
  </div>
  
  <div class="container">
    <div class="header no-print">
      <h1>üéØ BOGOÂ§öÁ¶èÊ∞£ ÂúòÈöäÂàÜÊûêÁ≥ªÁµ±</h1>
      <p>‰ª•ÂúòÈöäÁÇ∫‰∏ªËª∏ÁöÑÂÆåÊï¥Ë®ÇË≥ºËàáÊê∂Ë≥ºÂàÜÊûê
        <span class="sync-status synced" id="syncStatus">‚óè Â∑≤ÂêåÊ≠•</span>
      </p>
    </div>
    
    <!-- ÁØ©ÈÅ∏Âàó -->
    <div class="filter-bar no-print" id="filterBar" style="display: none;">
      <label>ÂúòÈöäÔºö</label>
      <select id="teamFilter" onchange="filterData()">
        <option value="all">ÂÖ®ÈÉ®ÂúòÈöä</option>
      </select>
      
      <label>È°ûÂûãÔºö</label>
      <select id="typeFilter" onchange="filterData()">
        <option value="all">ÂÖ®ÈÉ®</option>
        <option value="order">Ë®ÇË≥º</option>
        <option value="report">Êê∂Ë≥º</option>
      </select>
      
      <button class="btn" onclick="exportReport()">üì• ÂåØÂá∫</button>
      <button class="btn" onclick="window.print()">üñ®Ô∏è ÂàóÂç∞</button>
    </div>
    
    <!-- ÂúòÈöäÊØîËºÉË°®Ê†º -->
    <div class="comparison-section" id="comparisonSection" style="display: none;">
      <h3 class="comparison-title">üìä ÂúòÈöäÁ∏æÊïàÊØîËºÉÁ∏ΩË°®</h3>
      <div class="summary-table">
        <table id="comparisonTable"></table>
      </div>
      <div class="page-number"></div>
    </div>
    
    <!-- ÂàÜÊûêÂÖßÂÆπ -->
    <div id="analysisContent"></div>
  </div>
  
  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx4xr4X6lfiGzc7Bh--vlgrWgS-t9gcG73zAfqEmFHlkb5Moz0SXBEZTWLJhtupf-GB9A/exec';
    
    let allOrders = [];
    let allReports = [];
    let maintenanceData = [];
    let teamAnalysisData = {};
    let autoSyncInterval = null;
    let productNameMap = {
      '1A': 'Â§öÁ¶èÊ∞£ÁµÑÂêàA',
      '1B': 'Â§öÁ¶èÊ∞£ÁµÑÂêàB',
      '2A': 'ÂÅ•Â∫∑Ê¥ªÂäõÁµÑÂêàA',
      '2B': 'ÂÅ•Â∫∑Ê¥ªÂäõÁµÑÂêàB',
      '3A': 'ÁæéÈ∫ó‰øùÈ§äÁµÑÂêàA',
      '3B': 'ÁæéÈ∫ó‰øùÈ§äÁµÑÂêàB',
      '4A': 'ÂÆ∂Â∫≠Ë≠∑ÁêÜÁµÑÂêàA',
      '4B': 'ÂÆ∂Â∫≠Ë≠∑ÁêÜÁµÑÂêàB',
      '5A': 'ÁáüÈ§äË£úÁµ¶ÁµÑÂêàA',
      '5B': 'ÁáüÈ§äË£úÁµ¶ÁµÑÂêàB'
    };
    
    function sortGroupCode(a, b) {
      const order = ['1A', '1B', '2A', '2B', '3A', '3B', '4A', '4B', '5A', '5B'];
      const indexA = order.indexOf(a);
      const indexB = order.indexOf(b);
      
      if (indexA !== -1 && indexB !== -1) {
        return indexA - indexB;
      }
      if (indexA !== -1) return -1;
      if (indexB !== -1) return 1;
      return a.localeCompare(b);
    }
    
    function showLoading(show, text = 'ËºâÂÖ•‰∏≠...') {
      document.getElementById('loading').classList.toggle('show', show);
      document.getElementById('loadingText').textContent = text;
    }
    
    function updateSyncStatus(status) {
      const syncStatus = document.getElementById('syncStatus');
      if (status === 'syncing') {
        syncStatus.className = 'sync-status syncing';
        syncStatus.textContent = '‚óè ÂêåÊ≠•‰∏≠...';
      } else {
        syncStatus.className = 'sync-status synced';
        const now = new Date();
        syncStatus.textContent = `‚óè Â∑≤ÂêåÊ≠• ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
      }
    }
    
    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '10000';
      alertDiv.style.minWidth = '250px';
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    }
    
    async function autoConnectAndAnalyze(silent = false) {
      if (!silent) {
        showLoading(true, 'Ê≠£Âú®ÈÄ£Êé•Ë©¶ÁÆóË°®...');
      } else {
        updateSyncStatus('syncing');
      }
      
      try {
        const ordersResponse = await fetch(WEB_APP_URL + '?action=getOrders');
        const ordersResult = await ordersResponse.json();
        
        if (!ordersResult.success) {
          throw new Error('ËºâÂÖ•Ë®ÇÂñÆÂ§±Êïó');
        }
        allOrders = ordersResult.data;
        
        const reportsResponse = await fetch(WEB_APP_URL + '?action=getReports');
        const reportsResult = await reportsResponse.json();
        
        if (!reportsResult.success) {
          throw new Error('ËºâÂÖ•Êê∂Ë≥ºÂõûÂ†±Â§±Êïó');
        }
        allReports = reportsResult.data;
        
        const maintenanceResponse = await fetch(WEB_APP_URL + '?action=getMaintenance');
        const maintenanceResult = await maintenanceResponse.json();
        
        if (maintenanceResult.success) {
          maintenanceData = maintenanceResult.data;
        }
        
        analyzeByTeam();
        
        if (!silent) {
          showAlert(`‚úÖ ÂàÜÊûêÂÆåÊàêÔºÅË®ÇÂñÆÔºö${allOrders.length} Á≠ÜÔºåÊê∂Ë≥ºÔºö${allReports.length} Á≠Ü`);
        }
        
        updateSyncStatus('synced');
        
        document.getElementById('filterBar').style.display = 'flex';
        document.getElementById('comparisonSection').style.display = 'block';
        
      } catch (error) {
        if (!silent) {
          showAlert('‚ùå ' + error.message, 'error');
        }
        console.error(error);
      } finally {
        if (!silent) {
          showLoading(false);
        }
      }
    }
    
    function analyzeByTeam() {
      teamAnalysisData = {};
      
      const nameToTeamMap = {};
      maintenanceData.forEach(item => {
        if (item.Ë®ÇË≥ºÂêçÂñÆ && item.ÂúòÈöä) {
          nameToTeamMap[item.Ë®ÇË≥ºÂêçÂñÆ] = item.ÂúòÈöä;
        }
      });
      
      allReports.forEach(report => {
        if (report.Êê∂Ë≥ºËÄÖ && report.ÂúòÈöä) {
          nameToTeamMap[report.Êê∂Ë≥ºËÄÖ] = report.ÂúòÈöä;
        }
      });
      
      allOrders.forEach(order => {
        const name = order.LINEÂêçÁ®±.split('(‰ª£)')[0].trim();
        const team = order.ÂúòÈöä || nameToTeamMap[name] || nameToTeamMap[order.LINEÂêçÁ®±] || 'Êú™ÂàÜÈÖç';
        const groupCode = order.ÁµÑÂà•‰ª£Ëôü || order.ÁµÑÂà• || 'Êú™ÂàÜÁµÑ';
        
        if (!teamAnalysisData[team]) {
          teamAnalysisData[team] = {
            orders: {},
            reports: {},
            groupSummary: {},
            reportGroupSummary: {},
            totalOrderQty: 0,
            totalOrderAmount: 0,
            totalOrderPV: 0,
            totalReportQty: 0,
            totalReportAmount: 0,
            totalReportPV: 0,
            needsMaintenance: []
          };
        }
        
        if (!teamAnalysisData[team].orders[name]) {
          teamAnalysisData[team].orders[name] = {};
        }
        
        if (!teamAnalysisData[team].orders[name][groupCode]) {
          teamAnalysisData[team].orders[name][groupCode] = {
            qty: 0,
            amount: 0,
            pv: 0,
            price: 0
          };
        }
        
        const qty = parseInt(order.Ë®ÇË≥ºÊï∏Èáè) || 0;
        const price = parseInt(order.ÂñÆÂÉπ) || 0;
        const pv = parseInt(order.PV) || 0;
        const amount = parseInt(order.ÂêàË®à) || (qty * price);
        
        teamAnalysisData[team].orders[name][groupCode].qty += qty;
        teamAnalysisData[team].orders[name][groupCode].amount += amount;
        teamAnalysisData[team].orders[name][groupCode].pv += pv * qty;
        teamAnalysisData[team].orders[name][groupCode].price = price;
        
        if (!teamAnalysisData[team].groupSummary[groupCode]) {
          teamAnalysisData[team].groupSummary[groupCode] = {
            qty: 0,
            amount: 0,
            pv: 0
          };
        }
        teamAnalysisData[team].groupSummary[groupCode].qty += qty;
        teamAnalysisData[team].groupSummary[groupCode].amount += amount;
        teamAnalysisData[team].groupSummary[groupCode].pv += pv * qty;
        
        teamAnalysisData[team].totalOrderQty += qty;
        teamAnalysisData[team].totalOrderAmount += amount;
        teamAnalysisData[team].totalOrderPV += pv * qty;
        
        if (team === 'Êú™ÂàÜÈÖç' && !teamAnalysisData[team].needsMaintenance.includes(name)) {
          teamAnalysisData[team].needsMaintenance.push(name);
        }
      });
      
      allReports.forEach(report => {
        const team = report.ÂúòÈöä || 'Êú™ÂàÜÈÖç';
        const buyer = report.Êê∂Ë≥ºËÄÖ;
        const groupCode = report.ÁµÑÂà•‰ª£Ëôü || 'Êú™ÂàÜÁµÑ';
        
        if (!teamAnalysisData[team]) {
          teamAnalysisData[team] = {
            orders: {},
            reports: {},
            groupSummary: {},
            reportGroupSummary: {},
            totalOrderQty: 0,
            totalOrderAmount: 0,
            totalOrderPV: 0,
            totalReportQty: 0,
            totalReportAmount: 0,
            totalReportPV: 0,
            needsMaintenance: []
          };
        }
        
        if (!teamAnalysisData[team].reports[buyer]) {
          teamAnalysisData[team].reports[buyer] = {};
        }
        
        if (!teamAnalysisData[team].reports[buyer][groupCode]) {
          teamAnalysisData[team].reports[buyer][groupCode] = {
            items: [],
            totalQty: 0,
            totalAmount: 0,
            totalPV: 0
          };
        }
        
        const qty = parseInt(report.Êê∂Ë≥ºÁµÑÊï∏) || 0;
        const price = parseInt(report.ÂñÆÂÉπ) || 0;
        const pv = parseInt(report.PVÊï∏) || 0;
        const amount = qty * price;
        
        teamAnalysisData[team].reports[buyer][groupCode].items.push({
          qty: qty,
          price: price,
          pv: pv,
          amount: amount,
          buySend: report['Ë≤∑/ÈÄÅ'] || ''
        });
        
        teamAnalysisData[team].reports[buyer][groupCode].totalQty += qty;
        teamAnalysisData[team].reports[buyer][groupCode].totalAmount += amount;
        teamAnalysisData[team].reports[buyer][groupCode].totalPV += pv * qty;
        
        if (!teamAnalysisData[team].reportGroupSummary[groupCode]) {
          teamAnalysisData[team].reportGroupSummary[groupCode] = {
            qty: 0,
            amount: 0,
            pv: 0
          };
        }
        teamAnalysisData[team].reportGroupSummary[groupCode].qty += qty;
        teamAnalysisData[team].reportGroupSummary[groupCode].amount += amount;
        teamAnalysisData[team].reportGroupSummary[groupCode].pv += pv * qty;
        
        teamAnalysisData[team].totalReportQty += qty;
        teamAnalysisData[team].totalReportAmount += amount;
        teamAnalysisData[team].totalReportPV += pv * qty;
      });
      
      const teamFilter = document.getElementById('teamFilter');
      teamFilter.innerHTML = '<option value="all">ÂÖ®ÈÉ®ÂúòÈöä</option>';
      Object.keys(teamAnalysisData).sort().forEach(team => {
        teamFilter.innerHTML += `<option value="${team}">${team}</option>`;
      });
      
      displayComparisonTable();
      displayTeamAnalysis();
    }
    
    function displayComparisonTable() {
      const table = document.getElementById('comparisonTable');
      const teams = Object.keys(teamAnalysisData).sort();
      const typeFilter = document.getElementById('typeFilter').value;
      
      const allGroups = new Set();
      teams.forEach(team => {
        if (typeFilter === 'all' || typeFilter === 'order') {
          Object.keys(teamAnalysisData[team].groupSummary).forEach(g => allGroups.add(g));
        }
        if (typeFilter === 'all' || typeFilter === 'report') {
          Object.keys(teamAnalysisData[team].reportGroupSummary).forEach(g => allGroups.add(g));
        }
      });
      
      const sortedGroups = Array.from(allGroups).sort(sortGroupCode);
      
      let html = '<thead><tr><th style="color: #000;">ÁµÑÂà•</th><th style="color: #000;">Áî¢ÂìÅÂêçÁ®±</th>';
      
      teams.forEach((team, index) => {
        const colorClass = `team-color-${(index % 6) + 1}`;
        if (typeFilter === 'all') {
          html += `<th class="${colorClass}" colspan="2" style="color: #000;">${team}</th>`;
        } else {
          html += `<th class="${colorClass}" style="color: #000;">${team}</th>`;
        }
      });
      
      html += '</tr>';
      
      if (typeFilter === 'all') {
        html += '<tr><th></th><th></th>';
        teams.forEach((team, index) => {
          const colorClass = `team-color-${(index % 6) + 1}`;
          html += `<th class="${colorClass}" style="color: #000;">Ë®ÇË≥º</th><th class="${colorClass}" style="color: #000;">Êê∂Ë≥º</th>`;
        });
        html += '</tr>';
      }
      
      html += '</thead><tbody>';
      
      sortedGroups.forEach(group => {
        const productName = productNameMap[group] || group;
        html += `<tr><td style="color: #000;"><strong>${group}</strong></td><td style="color: #000;">${productName}</td>`;
        
        teams.forEach((team, index) => {
          const data = teamAnalysisData[team];
          const colorClass = `team-color-${(index % 6) + 1}`;
          
          if (typeFilter === 'all') {
            const orderQty = data.groupSummary[group]?.qty || 0;
            const reportQty = data.reportGroupSummary[group]?.qty || 0;
            html += `<td class="${colorClass}" style="color: #000;">${orderQty > 0 ? orderQty : '-'}</td>`;
            html += `<td class="${colorClass}" style="color: #000;">${reportQty > 0 ? reportQty : '-'}</td>`;
          } else if (typeFilter === 'order') {
            const orderQty = data.groupSummary[group]?.qty || 0;
            html += `<td class="${colorClass}" style="color: #000;">${orderQty > 0 ? orderQty : '-'}</td>`;
          } else {
            const reportQty = data.reportGroupSummary[group]?.qty || 0;
            html += `<td class="${colorClass}" style="color: #000;">${reportQty > 0 ? reportQty : '-'}</td>`;
          }
        });
        
        html += '</tr>';
      });
      
      html += '</tbody>';
      
      table.innerHTML = html;
    }
    
    function displayTeamAnalysis(selectedTeam = 'all') {
      const container = document.getElementById('analysisContent');
      const typeFilter = document.getElementById('typeFilter').value;
      let html = '';
      
      const teamsToShow = selectedTeam === 'all' 
        ? Object.keys(teamAnalysisData).sort() 
        : [selectedTeam];
      
      teamsToShow.forEach(team => {
        const data = teamAnalysisData[team];
        
        html += `
          <div class="team-container">
            <div class="team-header">üè¢ ${team}</div>
            
            <div class="stats-grid">
        `;
        
        if (typeFilter === 'all' || typeFilter === 'order') {
          html += `
            <div class="stat-card">
              <div class="label">Ë®ÇË≥ºÁ∏ΩÊï∏Èáè</div>
              <div class="value">${data.totalOrderQty}</div>
            </div>
            <div class="stat-card">
              <div class="label">Ë®ÇË≥ºÁ∏ΩÈáëÈ°ç</div>
              <div class="value">$${(data.totalOrderAmount / 1000).toFixed(0)}K</div>
            </div>
            <div class="stat-card">
              <div class="label">Ë®ÇË≥ºÁ∏Ω PV</div>
              <div class="value">${data.totalOrderPV.toLocaleString()}</div>
            </div>
          `;
        }
        
        if (typeFilter === 'all' || typeFilter === 'report') {
          html += `
            <div class="stat-card">
              <div class="label">Êê∂Ë≥ºÁ∏ΩÊï∏Èáè</div>
              <div class="value">${data.totalReportQty}</div>
            </div>
            <div class="stat-card">
              <div class="label">Êê∂Ë≥ºÁ∏ΩÈáëÈ°ç</div>
              <div class="value">$${(data.totalReportAmount / 1000).toFixed(0)}K</div>
            </div>
            <div class="stat-card">
              <div class="label">Êê∂Ë≥ºÁ∏Ω PV</div>
              <div class="value">${data.totalReportPV.toLocaleString()}</div>
            </div>
          `;
        }
        
        html += `</div>`;
        
        // Ë®ÇË≥ºÁµÑÂà•Áµ±Ë®à
        if ((typeFilter === 'all' || typeFilter === 'order') && Object.keys(data.groupSummary).length > 0) {
          html += `
            <div class="section-title">üì¶ Ë®ÇË≥ºÁµÑÂà•Áµ±Ë®à</div>
            <table class="data-table">
              <thead>
                <tr>
                  <th>ÁµÑÂà•</th>
                  <th>Áî¢ÂìÅÂêçÁ®±</th>
                  <th>Êï∏Èáè</th>
                  <th>ÈáëÈ°ç</th>
                  <th>PV</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          const sortedGroups = Object.keys(data.groupSummary).sort(sortGroupCode);
          sortedGroups.forEach(groupCode => {
            const stats = data.groupSummary[groupCode];
            const productName = productNameMap[groupCode] || groupCode;
            html += `
              <tr>
                <td><strong>${groupCode}</strong></td>
                <td>${productName}</td>
                <td>${stats.qty} ÁµÑ</td>
                <td>$${stats.amount.toLocaleString()}</td>
                <td>${stats.pv}</td>
              </tr>
            `;
          });
          
          html += `
              </tbody>
            </table>
          `;
        }
        
        // Ë®ÇË≥ºË©≥Á¥∞Ê∏ÖÂñÆ
        if (typeFilter === 'all' || typeFilter === 'order') {
          html += `<div class="section-title">üìã Ë®ÇË≥ºË©≥Á¥∞Ê∏ÖÂñÆ</div>`;
          
          for (const [person, groups] of Object.entries(data.orders)) {
            html += `
              <div class="person-card">
                <div class="person-name">üë§ ${person}</div>
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>ÁµÑÂà•</th>
                      <th>Êï∏Èáè</th>
                      <th>ÂñÆÂÉπ</th>
                      <th>ÈáëÈ°ç</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            
            let personTotal = { qty: 0, amount: 0 };
            const sortedGroupCodes = Object.keys(groups).sort(sortGroupCode);
            
            for (const groupCode of sortedGroupCodes) {
              const groupData = groups[groupCode];
              
              html += `
                <tr>
                  <td>${groupCode}</td>
                  <td>${groupData.qty}</td>
                  <td>$${groupData.price.toLocaleString()}</td>
                  <td>$${groupData.amount.toLocaleString()}</td>
                </tr>
              `;
              
              personTotal.qty += groupData.qty;
              personTotal.amount += groupData.amount;
            }
            
            html += `
                <tr class="total-row">
                  <td><strong>Á∏ΩË®à</strong></td>
                  <td><strong>${personTotal.qty}</strong></td>
                  <td>-</td>
                  <td><strong>$${personTotal.amount.toLocaleString()}</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
            `;
          }
        }
        
        // Êê∂Ë≥ºÁµÑÂà•Áµ±Ë®à
        if ((typeFilter === 'all' || typeFilter === 'report') && Object.keys(data.reportGroupSummary).length > 0) {
          html += `
            <div class="section-title">üéØ Êê∂Ë≥ºÁµÑÂà•Áµ±Ë®à</div>
            <table class="data-table">
              <thead>
                <tr>
                  <th>ÁµÑÂà•</th>
                  <th>Áî¢ÂìÅÂêçÁ®±</th>
                  <th>Êï∏Èáè</th>
                  <th>ÈáëÈ°ç</th>
                  <th>PV</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          const sortedReportGroups = Object.keys(data.reportGroupSummary).sort(sortGroupCode);
          sortedReportGroups.forEach(groupCode => {
            const stats = data.reportGroupSummary[groupCode];
            const productName = productNameMap[groupCode] || groupCode;
            html += `
              <tr>
                <td><strong>${groupCode}</strong></td>
                <td>${productName}</td>
                <td>${stats.qty} ÁµÑ</td>
                <td>$${stats.amount.toLocaleString()}</td>
                <td>${stats.pv}</td>
              </tr>
            `;
          });
          
          html += `
              </tbody>
            </table>
          `;
        }
        
        // Êê∂Ë≥ºË©≥Á¥∞Ê∏ÖÂñÆ
        if (typeFilter === 'all' || typeFilter === 'report') {
          html += `<div class="section-title">üéØ Êê∂Ë≥ºË©≥Á¥∞Ê∏ÖÂñÆ</div>`;
          
          for (const [buyer, groups] of Object.entries(data.reports)) {
            html += `
              <div class="person-card">
                <div class="person-name">üë§ ${buyer}</div>
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>ÁµÑÂà•</th>
                      <th>Ë≤∑/ÈÄÅ</th>
                      <th>Êï∏Èáè</th>
                      <th>ÂñÆÂÉπ</th>
                      <th>ÈáëÈ°ç</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            
            let buyerTotal = { qty: 0, amount: 0 };
            const sortedGroupCodes = Object.keys(groups).sort(sortGroupCode);
            
            for (const groupCode of sortedGroupCodes) {
              const groupData = groups[groupCode];
              
              groupData.items.forEach(item => {
                html += `
                  <tr>
                    <td>${groupCode}</td>
                    <td>${item.buySend}</td>
                    <td>${item.qty}</td>
                    <td>$${item.price.toLocaleString()}</td>
                    <td>$${item.amount.toLocaleString()}</td>
                  </tr>
                `;
              });
              
              buyerTotal.qty += groupData.totalQty;
              buyerTotal.amount += groupData.totalAmount;
            }
            
            html += `
                <tr class="total-row">
                  <td colspan="2"><strong>Á∏ΩË®à</strong></td>
                  <td><strong>${buyerTotal.qty}</strong></td>
                  <td>-</td>
                  <td><strong>$${buyerTotal.amount.toLocaleString()}</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
            `;
          }
        }
        
        html += `<div class="page-number"></div></div>`;
      });
      
      container.innerHTML = html;
    }
    
    function filterData() {
      const selectedTeam = document.getElementById('teamFilter').value;
      displayComparisonTable();
      displayTeamAnalysis(selectedTeam);
    }
    
    function exportReport() {
      let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
      csvContent += "BOGO ÂúòÈöäÂàÜÊûêÂ†±Âëä\n\n";
      
      for (const [team, data] of Object.entries(teamAnalysisData)) {
        csvContent += `\nÂúòÈöäÔºö${team}\n`;
        csvContent += `Ë®ÇË≥ºÁ∏ΩÊï∏Èáè,${data.totalOrderQty}\n`;
        csvContent += `Ë®ÇË≥ºÁ∏ΩÈáëÈ°ç,$${data.totalOrderAmount}\n`;
        csvContent += `Ë®ÇË≥ºÁ∏ΩPV,${data.totalOrderPV}\n`;
        csvContent += `Êê∂Ë≥ºÁ∏ΩÊï∏Èáè,${data.totalReportQty}\n`;
        csvContent += `Êê∂Ë≥ºÁ∏ΩÈáëÈ°ç,$${data.totalReportAmount}\n`;
        csvContent += `Êê∂Ë≥ºÁ∏ΩPV,${data.totalReportPV}\n\n`;
      }
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "BOGOÂúòÈöäÂàÜÊûê_" + new Date().toISOString().split('T')[0] + ".csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showAlert('‚úÖ Â†±ÂëäÂ∑≤ÂåØÂá∫');
    }
    
    function startAutoSync() {
      autoSyncInterval = setInterval(() => {
        autoConnectAndAnalyze(true);
      }, 30000);
    }
    
    window.addEventListener('DOMContentLoaded', () => {
      autoConnectAndAnalyze();
      startAutoSync();
    });
    
    window.addEventListener('beforeunload', () => {
      if (autoSyncInterval) {
        clearInterval(autoSyncInterval);
      }
    });
  </script>
</body>
</html>
