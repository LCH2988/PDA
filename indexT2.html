<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã€å¤šç¦æ°£ã€‘BOGO åœ˜éšŠåˆ†æç³»çµ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 10px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      text-align: center;
    }
    
    .header h1 {
      color: #667eea;
      font-size: clamp(1.5em, 5vw, 2.5em);
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: clamp(0.9em, 2vw, 1em);
    }
    
    .btn {
      padding: 12px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: clamp(0.9em, 2vw, 1em);
      font-weight: 600;
      transition: background 0.3s;
      white-space: nowrap;
    }
    
    .btn:hover {
      background: #5568d3;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .team-container {
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .team-header {
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: clamp(1.2em, 4vw, 1.8em);
      font-weight: bold;
    }
    
    .section-title {
      background: #8b5cf6;
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: clamp(1em, 3vw, 1.2em);
      font-weight: bold;
      margin: 20px 0 15px 0;
    }
    
    /* è¨‚è³¼æ¨™é¡Œ - è—è‰² */
    .section-title.order-title {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    
    /* æ¶è³¼æ¨™é¡Œ - æ©™è‰² */
    .section-title.report-title {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    }
    
    /* ç”¢å“éŠ·å”®æ¨™é¡Œ - ç¶ è‰² */
    .section-title.product-title {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-radius: 8px;
      overflow: hidden;
      font-size: clamp(0.8em, 2vw, 1em);
    }
    
    .data-table thead {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
    }
    
    .data-table th {
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      font-size: 0.95em;
    }
    
    .data-table th:last-child,
    .data-table td:last-child {
      text-align: right;
    }
    
    .data-table tbody tr {
      border-bottom: 1px solid #f3f4f6;
      transition: background 0.2s;
    }
    
    .data-table tbody tr:hover {
      background: #faf5ff;
    }
    
    .data-table td {
      padding: 10px 8px;
      color: #374151;
    }
    
    .data-table .total-row {
      background: #fef3c7;
      font-weight: bold;
      color: #92400e;
    }
    
    .data-table .total-row td {
      padding: 12px 8px;
      border-top: 2px solid #f59e0b;
    }
    
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-radius: 8px;
      overflow-x: auto;
      display: block;
      font-size: clamp(0.75em, 2vw, 0.95em);
    }
    
    .summary-table table {
      width: 100%;
      min-width: 600px;
    }
    
    .summary-table thead {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .summary-table th {
      padding: 12px 8px;
      text-align: center;
      font-weight: 600;
      white-space: nowrap;
      color: #000 !important;
    }
    
    .summary-table tbody tr {
      border-bottom: 1px solid #f3f4f6;
    }
    
    .summary-table tbody tr:hover {
      background: #f0fdf4;
    }
    
    .summary-table td {
      padding: 10px 8px;
      text-align: center;
      color: #000 !important;
    }
    
    .summary-table td:first-child {
      text-align: left;
      font-weight: 600;
      position: sticky;
      left: 0;
      background: white;
      z-index: 1;
      color: #000 !important;
    }
    
    .summary-table tbody tr:hover td:first-child {
      background: #f0fdf4;
    }
    
    /* åˆè¨ˆè¡Œæ¨£å¼ */
    .summary-table .total-row {
      background: #fef3c7 !important;
      font-weight: bold;
      border-top: 3px solid #f59e0b;
    }
    
    .summary-table .total-row td {
      padding: 12px 8px;
      font-weight: bold;
      color: #92400e !important;
    }
    
    .summary-table .total-row td:first-child {
      background: #fef3c7 !important;
    }
    
    /* åœ˜éšŠé¡è‰² */
    .team-color-1 { background: #fef3c7 !important; }
    .team-color-2 { background: #dbeafe !important; }
    .team-color-3 { background: #fce7f3 !important; }
    .team-color-4 { background: #d1fae5 !important; }
    .team-color-5 { background: #fef2f2 !important; }
    .team-color-6 { background: #f3e8ff !important; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      padding: 15px;
      border-radius: 10px;
      border-left: 4px solid #8b5cf6;
      text-align: center;
    }
    
    .stat-card .label {
      color: #6b7280;
      font-size: 0.85em;
      margin-bottom: 5px;
    }
    
    .stat-card .value {
      color: #8b5cf6;
      font-size: clamp(1.5em, 4vw, 2em);
      font-weight: bold;
    }
    
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }
    
    .loading.show {
      display: flex;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    .loading-text {
      color: white;
      font-size: 1.2em;
      font-weight: 600;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .alert {
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 15px;
      font-size: 0.9em;
    }
    
    .alert-success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .alert-error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .filter-bar {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .filter-bar label {
      font-weight: 600;
      font-size: clamp(0.9em, 2vw, 1em);
      white-space: nowrap;
    }
    
    select {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: clamp(0.9em, 2vw, 1em);
      min-width: 120px;
    }
    
    .comparison-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .comparison-title {
      color: #8b5cf6;
      font-size: clamp(1.2em, 4vw, 1.5em);
      font-weight: bold;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f3f4f6;
    }
    
    .sync-status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      margin-left: 10px;
    }
    
    .sync-status.syncing {
      background: #fef3c7;
      color: #92400e;
    }
    
    .sync-status.synced {
      background: #d1fae5;
      color: #065f46;
    }
    
    /* äººå“¡æ¨™é¡Œé¡è‰² */
    .person-header {
      color: #6b21a8;
      margin: 15px 0 10px 0;
      padding: 10px;
      border-radius: 8px;
      font-size: clamp(1em, 3vw, 1.2em);
      font-weight: 600;
    }
    
    /* è¨‚è³¼äººå“¡ - è—è‰²èƒŒæ™¯ */
    .person-header.order-person {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      color: #1e40af;
    }
    
    /* æ¶è³¼äººå“¡ - æ©™è‰²èƒŒæ™¯ */
    .person-header.report-person {
      background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
      color: #9a3412;
    }
    
    /* ç”¢å“éŠ·å”®è¡¨æ ¼ */
    .product-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-radius: 8px;
      overflow-x: auto;
      display: block;
      font-size: clamp(0.75em, 2vw, 0.9em);
    }
    
    .product-table table {
      width: 100%;
      min-width: 800px;
    }
    
    .product-table thead {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .product-table th {
      padding: 12px 8px;
      text-align: center;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .product-table tbody tr {
      border-bottom: 1px solid #f3f4f6;
    }
    
    .product-table tbody tr:hover {
      background: #f0fdf4;
    }
    
    .product-table td {
      padding: 10px 8px;
      text-align: center;
      color: #374151;
    }
    
    .product-table td:nth-child(2) {
      text-align: left;
      max-width: 300px;
    }
    
    .product-table .total-row {
      background: #fef3c7 !important;
      font-weight: bold;
      color: #92400e;
      border-top: 3px solid #f59e0b;
    }
    
    @media print {
      body {
        background: white;
      }
      .header, .filter-bar {
        display: none;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      
      .header {
        padding: 15px;
      }
      
      .team-container {
        padding: 15px;
      }
      
      .filter-bar {
        padding: 10px;
      }
      
      .data-table th,
      .data-table td {
        padding: 8px 5px;
        font-size: 0.85em;
      }
      
      .btn {
        padding: 10px 15px;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">è¼‰å…¥ä¸­...</div>
  </div>
  
  <div class="container">
    <div class="header">
      <h1>ğŸ¯ ã€å¤šç¦æ°£ã€‘BOGO åœ˜éšŠåˆ†æç³»çµ±</h1>
      <p>ä»¥åœ˜éšŠç‚ºä¸»è»¸çš„å®Œæ•´è¨‚è³¼èˆ‡æ¶è³¼åˆ†æ
        <span class="sync-status synced" id="syncStatus">â— å·²åŒæ­¥</span>
      </p>
    </div>
    
    <!-- ç¯©é¸åˆ— -->
    <div class="filter-bar" id="filterBar" style="display: none;">
      <label>åœ˜éšŠï¼š</label>
      <select id="teamFilter" onchange="filterData()">
        <option value="all">å…¨éƒ¨åœ˜éšŠ</option>
      </select>
      
      <label>é¡å‹ï¼š</label>
      <select id="typeFilter" onchange="filterData()">
        <option value="all">å…¨éƒ¨</option>
        <option value="order">è¨‚è³¼</option>
        <option value="report">æ¶è³¼</option>
      </select>
      
      <button class="btn" onclick="exportReport()">ğŸ“¥ åŒ¯å‡º</button>
      <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
    </div>
    
    <!-- ç”¢å“éŠ·å”®ç‹€æ…‹ -->
    <div class="comparison-section" id="productSection" style="display: none;">
      <h3 class="comparison-title">ğŸ“¦ ç”¢å“éŠ·å”®ç‹€æ…‹</h3>
      <div class="product-table">
        <table id="productTable"></table>
      </div>
    </div>
    
    <!-- åœ˜éšŠçµ„æ•¸çµ±è¨ˆ -->
    <div class="comparison-section" id="comparisonSection" style="display: none;">
      <h3 class="comparison-title">ğŸ“Š åœ˜éšŠçµ„æ•¸çµ±è¨ˆ</h3>
      <div class="summary-table">
        <table id="comparisonTable"></table>
      </div>
    </div>
    
    <!-- åˆ†æå…§å®¹ -->
    <div id="analysisContent"></div>
  </div>
  
  <script>
    // ç›´æ¥å¯«å…¥ Google Sheets Web App URL
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx4xr4X6lfiGzc7Bh--vlgrWgS-t9gcG73zAfqEmFHlkb5Moz0SXBEZTWLJhtupf-GB9A/exec';
    
    let allOrders = [];
    let allReports = [];
    let maintenanceData = [];
    let teamAnalysisData = {};
    let productSalesData = {};
    let autoSyncInterval = null;
    let lastDataHash = '';
    
    // çµ„åˆ¥æ’åºå‡½æ•¸
    function sortGroupCode(a, b) {
      const order = ['1A', '1B', '2A', '2B', '3A', '3B', '4A', '4B', '5A', '5B'];
      const indexA = order.indexOf(a);
      const indexB = order.indexOf(b);
      
      if (indexA !== -1 && indexB !== -1) {
        return indexA - indexB;
      }
      if (indexA !== -1) return -1;
      if (indexB !== -1) return 1;
      return a.localeCompare(b);
    }
    
    // è¨ˆç®—è³‡æ–™é›œæ¹Šå€¼ï¼ˆç”¨æ–¼æª¢æ¸¬è®Šæ›´ï¼‰
    function calculateDataHash(data) {
      return JSON.stringify(data).length + '_' + JSON.stringify(data).split('').reduce((a, b) => {
        a = ((a << 5) - a) + b.charCodeAt(0);
        return a & a;
      }, 0);
    }
    
    // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
    function showLoading(show, text = 'è¼‰å…¥ä¸­...') {
      document.getElementById('loading').classList.toggle('show', show);
      document.getElementById('loadingText').textContent = text;
    }
    
    // æ›´æ–°åŒæ­¥ç‹€æ…‹
    function updateSyncStatus(status) {
      const syncStatus = document.getElementById('syncStatus');
      if (status === 'syncing') {
        syncStatus.className = 'sync-status syncing';
        syncStatus.textContent = 'â— åŒæ­¥ä¸­...';
      } else {
        syncStatus.className = 'sync-status synced';
        const now = new Date();
        syncStatus.textContent = `â— å·²åŒæ­¥ ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
      }
    }
    
    // é¡¯ç¤ºæç¤º
    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '10000';
      alertDiv.style.minWidth = '250px';
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    }
    
    // è‡ªå‹•é€£æ¥ä¸¦åˆ†æ
    async function autoConnectAndAnalyze(silent = false) {
      if (!silent) {
        showLoading(true, 'æ­£åœ¨é€£æ¥è©¦ç®—è¡¨...');
      } else {
        updateSyncStatus('syncing');
      }
      
      try {
        // è¼‰å…¥è¨‚å–®è³‡æ–™
        const ordersResponse = await fetch(WEB_APP_URL + '?action=getOrders&t=' + Date.now());
        const ordersResult = await ordersResponse.json();
        
        if (!ordersResult.success) {
          throw new Error('è¼‰å…¥è¨‚å–®å¤±æ•—');
        }
        
        // è¼‰å…¥æ¶è³¼å›å ±
        const reportsResponse = await fetch(WEB_APP_URL + '?action=getReports&t=' + Date.now());
        const reportsResult = await reportsResponse.json();
        
        if (!reportsResult.success) {
          throw new Error('è¼‰å…¥æ¶è³¼å›å ±å¤±æ•—');
        }
        
        // è¼‰å…¥ä¸Šç·šç¶­è­·è³‡æ–™
        const maintenanceResponse = await fetch(WEB_APP_URL + '?action=getMaintenance&t=' + Date.now());
        const maintenanceResult = await maintenanceResponse.json();
        
        // æª¢æŸ¥è³‡æ–™æ˜¯å¦æœ‰è®Šæ›´
        const newDataHash = calculateDataHash({
          orders: ordersResult.data,
          reports: reportsResult.data,
          maintenance: maintenanceResult.data
        });
        
        if (silent && newDataHash === lastDataHash) {
          updateSyncStatus('synced');
          return; // è³‡æ–™æ²’æœ‰è®Šæ›´ï¼Œä¸éœ€è¦é‡æ–°åˆ†æ
        }
        
        lastDataHash = newDataHash;
        allOrders = ordersResult.data;
        allReports = reportsResult.data;
        
        if (maintenanceResult.success) {
          maintenanceData = maintenanceResult.data;
        }
        
        // é–‹å§‹åˆ†æ
        analyzeByTeam();
        analyzeProductSales();
        
        if (!silent) {
          showAlert(`âœ… åˆ†æå®Œæˆï¼è¨‚å–®ï¼š${allOrders.length} ç­†ï¼Œæ¶è³¼ï¼š${allReports.length} ç­†`);
        } else {
          console.log('ğŸ”„ è³‡æ–™å·²æ›´æ–°ä¸¦é‡æ–°åˆ†æ');
        }
        
        updateSyncStatus('synced');
        
        document.getElementById('filterBar').style.display = 'flex';
        document.getElementById('productSection').style.display = 'block';
        document.getElementById('comparisonSection').style.display = 'block';
        
      } catch (error) {
        if (!silent) {
          showAlert('âŒ ' + error.message, 'error');
        }
        console.error(error);
      } finally {
        if (!silent) {
          showLoading(false);
        }
      }
    }
    
    // åˆ†æç”¢å“éŠ·å”®ç‹€æ…‹
    function analyzeProductSales() {
      productSalesData = {};
      
      // è™•ç†è¨‚å–®æ•¸æ“š
      allOrders.forEach(order => {
        const groupCode = order.çµ„åˆ¥ä»£è™Ÿ || order.çµ„åˆ¥ || 'æœªåˆ†çµ„';
        const productName = order['ç”¢å“åç¨±( BOGOå°ˆç”¨ )'] || order.çµ„åˆ¥ä»£è™Ÿ;
        const price = parseInt(order.å–®åƒ¹) || 0;
        const pv = parseInt(order.PV) || 0;
        const qty = parseInt(order.è¨‚è³¼æ•¸é‡) || 0;
        
        const key = `${groupCode}_${productName}`;
        
        if (!productSalesData[key]) {
          productSalesData[key] = {
            groupCode: groupCode,
            productName: productName,
            price: price,
            pv: pv,
            orderQty: 0,
            reportQty: 0
          };
        }
        
        productSalesData[key].orderQty += qty;
      });
      
      // è™•ç†æ¶è³¼æ•¸æ“š
      allReports.forEach(report => {
        const groupCode = report.çµ„åˆ¥ä»£è™Ÿ || 'æœªåˆ†çµ„';
        const productName = groupCode; // æ¶è³¼é€šå¸¸åªæœ‰çµ„åˆ¥ä»£è™Ÿ
        const qty = parseInt(report.æ¶è³¼çµ„æ•¸) || 0;
        
        const key = `${groupCode}_${productName}`;
        
        if (!productSalesData[key]) {
          const price = parseInt(report.å–®åƒ¹) || 0;
          const pv = parseInt(report.PVæ•¸) || 0;
          
          productSalesData[key] = {
            groupCode: groupCode,
            productName: productName,
            price: price,
            pv: pv,
            orderQty: 0,
            reportQty: 0
          };
        }
        
        productSalesData[key].reportQty += qty;
      });
      
      displayProductSales();
    }
    
    // é¡¯ç¤ºç”¢å“éŠ·å”®ç‹€æ…‹
    function displayProductSales() {
      const table = document.getElementById('productTable');
      
      // æŒ‰çµ„åˆ¥æ’åº
      const sortedProducts = Object.values(productSalesData).sort((a, b) => {
        return sortGroupCode(a.groupCode, b.groupCode);
      });
      
      let html = `
        <thead>
          <tr>
            <th>çµ„åˆ¥</th>
            <th>ç”¢å“åç¨±</th>
            <th>å–®åƒ¹</th>
            <th>PV</th>
            <th>æ¥é¾çµ„æ•¸<br>(è¨‚è³¼)</th>
            <th>æ¶è³¼çµ„æ•¸</th>
          </tr>
        </thead>
        <tbody>
      `;
      
      let totalOrder = 0;
      let totalReport = 0;
      
      sortedProducts.forEach(product => {
        html += `
          <tr>
            <td><strong>${product.groupCode}</strong></td>
            <td>${product.productName}</td>
            <td>$${product.price.toLocaleString()}</td>
            <td>${product.pv}</td>
            <td>${product.orderQty}</td>
            <td>${product.reportQty}</td>
          </tr>
        `;
        
        totalOrder += product.orderQty;
        totalReport += product.reportQty;
      });
      
      // åˆè¨ˆè¡Œ
      html += `
        <tr class="total-row">
          <td colspan="4"><strong>åˆè¨ˆ</strong></td>
          <td><strong>${totalOrder}</strong></td>
          <td><strong>${totalReport}</strong></td>
        </tr>
      `;
      
      html += '</tbody>';
      
      table.innerHTML = html;
    }
    
    // ä»¥åœ˜éšŠç‚ºä¸»è»¸åˆ†æ
    function analyzeByTeam() {
      teamAnalysisData = {};
      
      // å»ºç«‹è¨‚è³¼åå–®åˆ°åœ˜éšŠçš„æ˜ å°„
      const nameToTeamMap = {};
      maintenanceData.forEach(item => {
        if (item.è¨‚è³¼åå–® && item.åœ˜éšŠ) {
          nameToTeamMap[item.è¨‚è³¼åå–®] = item.åœ˜éšŠ;
        }
      });
      
      // å»ºç«‹æ¶è³¼è€…åˆ°åœ˜éšŠçš„æ˜ å°„
      allReports.forEach(report => {
        if (report.æ¶è³¼è€… && report.åœ˜éšŠ) {
          nameToTeamMap[report.æ¶è³¼è€…] = report.åœ˜éšŠ;
        }
      });
      
      // è™•ç†è¨‚å–®æ•¸æ“š
      allOrders.forEach(order => {
        const name = order.LINEåç¨±.split('(ä»£)')[0].trim();
        const team = order.åœ˜éšŠ || nameToTeamMap[name] || nameToTeamMap[order.LINEåç¨±] || 'æœªåˆ†é…';
        const groupCode = order.çµ„åˆ¥ä»£è™Ÿ || order.çµ„åˆ¥ || 'æœªåˆ†çµ„';
        
        if (!teamAnalysisData[team]) {
          teamAnalysisData[team] = {
            orders: {},
            reports: {},
            groupSummary: {},
            reportGroupSummary: {},
            totalOrderQty: 0,
            totalOrderAmount: 0,
            totalOrderPV: 0,
            totalReportQty: 0,
            totalReportAmount: 0,
            totalReportPV: 0
          };
        }
        
        if (!teamAnalysisData[team].orders[name]) {
          teamAnalysisData[team].orders[name] = {};
        }
        
        if (!teamAnalysisData[team].orders[name][groupCode]) {
          teamAnalysisData[team].orders[name][groupCode] = {
            products: {},
            totalQty: 0,
            totalAmount: 0,
            totalPV: 0
          };
        }
        
        const qty = parseInt(order.è¨‚è³¼æ•¸é‡) || 0;
        const price = parseInt(order.å–®åƒ¹) || 0;
        const pv = parseInt(order.PV) || 0;
        const amount = parseInt(order.åˆè¨ˆ) || (qty * price);
        const productName = order['ç”¢å“åç¨±( BOGOå°ˆç”¨ )'] || order.çµ„åˆ¥ä»£è™Ÿ;
        
        // åˆä½µç›¸åŒç”¢å“
        if (!teamAnalysisData[team].orders[name][groupCode].products[productName]) {
          teamAnalysisData[team].orders[name][groupCode].products[productName] = {
            productName: productName,
            qty: 0,
            price: price,
            pv: pv,
            amount: 0
          };
        }
        
        teamAnalysisData[team].orders[name][groupCode].products[productName].qty += qty;
        teamAnalysisData[team].orders[name][groupCode].products[productName].amount += amount;
        
        teamAnalysisData[team].orders[name][groupCode].totalQty += qty;
        teamAnalysisData[team].orders[name][groupCode].totalAmount += amount;
        teamAnalysisData[team].orders[name][groupCode].totalPV += pv * qty;
        
        // çµ„åˆ¥çµ±è¨ˆ
        if (!teamAnalysisData[team].groupSummary[groupCode]) {
          teamAnalysisData[team].groupSummary[groupCode] = {
            qty: 0,
            amount: 0,
            pv: 0
          };
        }
        teamAnalysisData[team].groupSummary[groupCode].qty += qty;
        teamAnalysisData[team].groupSummary[groupCode].amount += amount;
        teamAnalysisData[team].groupSummary[groupCode].pv += pv * qty;
        
        teamAnalysisData[team].totalOrderQty += qty;
        teamAnalysisData[team].totalOrderAmount += amount;
        teamAnalysisData[team].totalOrderPV += pv * qty;
      });
      
      // è™•ç†æ¶è³¼å›å ±æ•¸æ“š
      allReports.forEach(report => {
        const team = report.åœ˜éšŠ || 'æœªåˆ†é…';
        const buyer = report.æ¶è³¼è€…;
        const groupCode = report.çµ„åˆ¥ä»£è™Ÿ || 'æœªåˆ†çµ„';
        
        if (!teamAnalysisData[team]) {
          teamAnalysisData[team] = {
            orders: {},
            reports: {},
            groupSummary: {},
            reportGroupSummary: {},
            totalOrderQty: 0,
            totalOrderAmount: 0,
            totalOrderPV: 0,
            totalReportQty: 0,
            totalReportAmount: 0,
            totalReportPV: 0
          };
        }
        
        if (!teamAnalysisData[team].reports[buyer]) {
          teamAnalysisData[team].reports[buyer] = {};
        }
        
        if (!teamAnalysisData[team].reports[buyer][groupCode]) {
          teamAnalysisData[team].reports[buyer][groupCode] = {
            items: [],
            totalQty: 0,
            totalAmount: 0,
            totalPV: 0
          };
        }
        
        const qty = parseInt(report.æ¶è³¼çµ„æ•¸) || 0;
        const price = parseInt(report.å–®åƒ¹) || 0;
        const pv = parseInt(report.PVæ•¸) || 0;
        const amount = qty * price;
        
        teamAnalysisData[team].reports[buyer][groupCode].items.push({
          qty: qty,
          price: price,
          pv: pv,
          amount: amount,
          buySend: report['è²·/é€'] || '',
          account: report['æ¶è³¼å¸³è™Ÿ/å‚™è¨»'] || ''
        });
        
        teamAnalysisData[team].reports[buyer][groupCode].totalQty += qty;
        teamAnalysisData[team].reports[buyer][groupCode].totalAmount += amount;
        teamAnalysisData[team].reports[buyer][groupCode].totalPV += pv * qty;
        
        // æ¶è³¼çµ„åˆ¥çµ±è¨ˆ
        if (!teamAnalysisData[team].reportGroupSummary[groupCode]) {
          teamAnalysisData[team].reportGroupSummary[groupCode] = {
            qty: 0,
            amount: 0,
            pv: 0
          };
        }
        teamAnalysisData[team].reportGroupSummary[groupCode].qty += qty;
        teamAnalysisData[team].reportGroupSummary[groupCode].amount += amount;
        teamAnalysisData[team].reportGroupSummary[groupCode].pv += pv * qty;
        
        teamAnalysisData[team].totalReportQty += qty;
        teamAnalysisData[team].totalReportAmount += amount;
        teamAnalysisData[team].totalReportPV += pv * qty;
      });
      
      // æ›´æ–°åœ˜éšŠé¸æ“‡å™¨
      const teamFilter = document.getElementById('teamFilter');
      teamFilter.innerHTML = '<option value="all">å…¨éƒ¨åœ˜éšŠ</option>';
      Object.keys(teamAnalysisData).sort().forEach(team => {
        teamFilter.innerHTML += `<option value="${team}">${team}</option>`;
      });
      
      // é¡¯ç¤ºæ¯”è¼ƒè¡¨æ ¼
      displayComparisonTable();
      
      // é¡¯ç¤ºåˆ†æçµæœ
      displayTeamAnalysis();
    }
    
    // é¡¯ç¤ºåœ˜éšŠçµ„æ•¸çµ±è¨ˆï¼ˆæ–°æ ¼å¼ï¼‰
    function displayComparisonTable() {
      const table = document.getElementById('comparisonTable');
      const teams = Object.keys(teamAnalysisData).sort();
      const typeFilter = document.getElementById('typeFilter').value;
      
      // æ”¶é›†æ‰€æœ‰çµ„åˆ¥
      const allGroups = new Set();
      teams.forEach(team => {
        if (typeFilter === 'all' || typeFilter === 'order') {
          Object.keys(teamAnalysisData[team].groupSummary).forEach(g => allGroups.add(g));
        }
        if (typeFilter === 'all' || typeFilter === 'report') {
          Object.keys(teamAnalysisData[team].reportGroupSummary).forEach(g => allGroups.add(g));
        }
      });
      
      const sortedGroups = Array.from(allGroups).sort(sortGroupCode);
      
      // è¡¨é ­
      let html = '<thead><tr><th rowspan="2" style="color: #000;">çµ„åˆ¥</th>';
      
      // ç¸½è¨ˆæ¬„
      if (typeFilter === 'all') {
        html += '<th colspan="2" style="color: #000; background: #e5e7eb;">ç¸½è¨ˆ</th>';
      } else {
        html += '<th rowspan="2" style="color: #000; background: #e5e7eb;">ç¸½è¨ˆ</th>';
      }
      
      // å„åœ˜éšŠæ¬„
      teams.forEach((team, index) => {
        const colorClass = `team-color-${(index % 6) + 1}`;
        if (typeFilter === 'all') {
          html += `<th class="${colorClass}" colspan="2" style="color: #000;">${team}</th>`;
        } else {
          html += `<th class="${colorClass}" rowspan="2" style="color: #000;">${team}</th>`;
        }
      });
      
      html += '</tr>';
      
      // å­æ¨™é¡Œè¡Œ
      html += '<tr>';
      
      // ç¸½è¨ˆå­æ¨™é¡Œ
      if (typeFilter === 'all') {
        html += '<th style="color: #000; background: #e5e7eb;">æ¥é¾æ•¸é‡</th>';
        html += '<th style="color: #000; background: #e5e7eb;">æ¶è³¼æ•¸é‡</th>';
      }
      
      // å„åœ˜éšŠå­æ¨™é¡Œ
      if (typeFilter === 'all') {
        teams.forEach((team, index) => {
          const colorClass = `team-color-${(index % 6) + 1}`;
          html += `<th class="${colorClass}" style="color: #000;">æ¥é¾æ•¸é‡</th>`;
          html += `<th class="${colorClass}" style="color: #000;">æ¶è³¼æ•¸é‡</th>`;
        });
      }
      
      html += '</tr></thead><tbody>';
      
      // çµ„åˆ¥æ•¸æ“š
      sortedGroups.forEach(group => {
        html += `<tr><td style="color: #000;"><strong>${group}</strong></td>`;
        
        // ç¸½è¨ˆæ¬„
        let totalOrder = 0;
        let totalReport = 0;
        
        teams.forEach(team => {
          const data = teamAnalysisData[team];
          totalOrder += data.groupSummary[group]?.qty || 0;
          totalReport += data.reportGroupSummary[group]?.qty || 0;
        });
        
        if (typeFilter === 'all') {
          html += `<td style="background: #f3f4f6;"><strong>${totalOrder > 0 ? totalOrder : '-'}</strong></td>`;
          html += `<td style="background: #f3f4f6;"><strong>${totalReport > 0 ? totalReport : '-'}</strong></td>`;
        } else if (typeFilter === 'order') {
          html += `<td style="background: #f3f4f6;"><strong>${totalOrder > 0 ? totalOrder : '-'}</strong></td>`;
        } else {
          html += `<td style="background: #f3f4f6;"><strong>${totalReport > 0 ? totalReport : '-'}</strong></td>`;
        }
        
        // å„åœ˜éšŠæ•¸æ“š
        teams.forEach((team, index) => {
          const data = teamAnalysisData[team];
          const colorClass = `team-color-${(index % 6) + 1}`;
          
          if (typeFilter === 'all') {
            const orderQty = data.groupSummary[group]?.qty || 0;
            const reportQty = data.reportGroupSummary[group]?.qty || 0;
            html += `<td class="${colorClass}" style="color: #000;">${orderQty > 0 ? orderQty : '-'}</td>`;
            html += `<td class="${colorClass}" style="color: #000;">${reportQty > 0 ? reportQty : '-'}</td>`;
          } else if (typeFilter === 'order') {
            const orderQty = data.groupSummary[group]?.qty || 0;
            html += `<td class="${colorClass}" style="color: #000;">${orderQty > 0 ? orderQty : '-'}</td>`;
          } else {
            const reportQty = data.reportGroupSummary[group]?.qty || 0;
            html += `<td class="${colorClass}" style="color: #000;">${reportQty > 0 ? reportQty : '-'}</td>`;
          }
        });
        
        html += '</tr>';
      });
      
      html += '</tbody>';
      
      table.innerHTML = html;
    }
    
    // é¡¯ç¤ºåœ˜éšŠåˆ†æ
    function displayTeamAnalysis(selectedTeam = 'all') {
      const container = document.getElementById('analysisContent');
      const typeFilter = document.getElementById('typeFilter').value;
      let html = '';
      
      const teamsToShow = selectedTeam === 'all' 
        ? Object.keys(teamAnalysisData).sort() 
        : [selectedTeam];
      
      teamsToShow.forEach(team => {
        const data = teamAnalysisData[team];
        
        html += `
          <div class="team-container">
            <div class="team-header">ğŸ¢ ${team}</div>
            
            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="stats-grid">
        `;
        
        if (typeFilter === 'all' || typeFilter === 'order') {
          html += `
            <div class="stat-card">
              <div class="label">è¨‚è³¼ç¸½æ•¸é‡</div>
              <div class="value">${data.totalOrderQty}</div>
            </div>
            <div class="stat-card">
              <div class="label">è¨‚è³¼ç¸½é‡‘é¡</div>
              <div class="value">$${(data.totalOrderAmount / 1000).toFixed(0)}K</div>
            </div>
            <div class="stat-card">
              <div class="label">è¨‚è³¼ç¸½ PV</div>
              <div class="value">${data.totalOrderPV.toLocaleString()}</div>
            </div>
          `;
        }
        
        if (typeFilter === 'all' || typeFilter === 'report') {
          html += `
            <div class="stat-card">
              <div class="label">æ¶è³¼ç¸½æ•¸é‡</div>
              <div class="value">${data.totalReportQty}</div>
            </div>
            <div class="stat-card">
              <div class="label">æ¶è³¼ç¸½é‡‘é¡</div>
              <div class="value">$${(data.totalReportAmount / 1000).toFixed(0)}K</div>
            </div>
            <div class="stat-card">
              <div class="label">æ¶è³¼ç¸½ PV</div>
              <div class="value">${data.totalReportPV.toLocaleString()}</div>
            </div>
          `;
        }
        
        html += `</div>`;
        
        // è¨‚è³¼çµ„åˆ¥çµ±è¨ˆè¡¨
        if ((typeFilter === 'all' || typeFilter === 'order') && Object.keys(data.groupSummary).length > 0) {
          html += `
            <div class="section-title order-title">ğŸ“¦ è¨‚è³¼çµ„åˆ¥çµ±è¨ˆ</div>
            <div class="summary-table">
              <table>
                <thead>
                  <tr>
                    <th>çµ„åˆ¥</th>
                    <th>æ•¸é‡</th>
                    <th>é‡‘é¡</th>
                    <th>PV</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          const sortedGroups = Object.keys(data.groupSummary).sort(sortGroupCode);
          sortedGroups.forEach(groupCode => {
            const stats = data.groupSummary[groupCode];
            html += `
              <tr>
                <td><strong>${groupCode}</strong></td>
                <td>${stats.qty} çµ„</td>
                <td>$${stats.amount.toLocaleString()}</td>
                <td>${stats.pv}</td>
              </tr>
            `;
          });
          
          html += `
                </tbody>
              </table>
            </div>
          `;
        }
        
        // è¨‚è³¼è©³ç´°æ¸…å–®
        if (typeFilter === 'all' || typeFilter === 'order') {
          html += `<div class="section-title order-title">ğŸ“‹ è¨‚è³¼è©³ç´°æ¸…å–®</div>`;
          
          for (const [person, groups] of Object.entries(data.orders)) {
            html += `
              <h4 class="person-header order-person">
                ğŸ‘¤ ${person}
              </h4>
              <table class="data-table">
                <thead>
                  <tr>
                    <th>çµ„åˆ¥</th>
                    <th>ç”¢å“åç¨±</th>
                    <th>æ•¸é‡</th>
                    <th>å–®åƒ¹</th>
                    <th>PV</th>
                    <th>é‡‘é¡</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            let personTotal = { qty: 0, amount: 0, pv: 0 };
            const sortedGroupCodes = Object.keys(groups).sort(sortGroupCode);
            
            for (const groupCode of sortedGroupCodes) {
              const groupData = groups[groupCode];
              
              for (const [productName, product] of Object.entries(groupData.products)) {
                html += `
                  <tr>
                    <td>${groupCode}</td>
                    <td>${product.productName}</td>
                    <td>${product.qty}</td>
                    <td>$${product.price.toLocaleString()}</td>
                    <td>${product.pv}</td>
                    <td>$${product.amount.toLocaleString()}</td>
                  </tr>
                `;
              }
              
              personTotal.qty += groupData.totalQty;
              personTotal.amount += groupData.totalAmount;
              personTotal.pv += groupData.totalPV;
            }
            
            html += `
                <tr class="total-row">
                  <td colspan="2"><strong>${person} ç¸½è¨ˆ</strong></td>
                  <td><strong>${personTotal.qty}</strong></td>
                  <td>-</td>
                  <td><strong>${personTotal.pv}</strong></td>
                  <td><strong>$${personTotal.amount.toLocaleString()}</strong></td>
                </tr>
              </tbody>
            </table>
            `;
          }
        }
        
        // æ¶è³¼çµ„åˆ¥çµ±è¨ˆè¡¨
        if ((typeFilter === 'all' || typeFilter === 'report') && Object.keys(data.reportGroupSummary).length > 0) {
          html += `
            <div class="section-title report-title">ğŸ¯ æ¶è³¼çµ„åˆ¥çµ±è¨ˆ</div>
            <div class="summary-table">
              <table>
                <thead>
                  <tr>
                    <th>çµ„åˆ¥</th>
                    <th>æ•¸é‡</th>
                    <th>é‡‘é¡</th>
                    <th>PV</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          const sortedReportGroups = Object.keys(data.reportGroupSummary).sort(sortGroupCode);
          sortedReportGroups.forEach(groupCode => {
            const stats = data.reportGroupSummary[groupCode];
            html += `
              <tr>
                <td><strong>${groupCode}</strong></td>
                <td>${stats.qty} çµ„</td>
                <td>$${stats.amount.toLocaleString()}</td>
                <td>${stats.pv}</td>
              </tr>
            `;
          });
          
          html += `
                </tbody>
              </table>
            </div>
          `;
        }
        
        // æ¶è³¼è©³ç´°æ¸…å–®
        if (typeFilter === 'all' || typeFilter === 'report') {
          html += `<div class="section-title report-title">ğŸ¯ æ¶è³¼è©³ç´°æ¸…å–®</div>`;
          
          for (const [buyer, groups] of Object.entries(data.reports)) {
            html += `
              <h4 class="person-header report-person">
                ğŸ‘¤ ${buyer}
              </h4>
              <table class="data-table">
                <thead>
                  <tr>
                    <th>çµ„åˆ¥</th>
                    <th>è²·/é€</th>
                    <th>æ•¸é‡</th>
                    <th>å–®åƒ¹</th>
                    <th>PV</th>
                    <th>é‡‘é¡</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            let buyerTotal = { qty: 0, amount: 0, pv: 0 };
            const sortedGroupCodes = Object.keys(groups).sort(sortGroupCode);
            
            for (const groupCode of sortedGroupCodes) {
              const groupData = groups[groupCode];
              
              groupData.items.forEach(item => {
                html += `
                  <tr>
                    <td>${groupCode}</td>
                    <td>${item.buySend}</td>
                    <td>${item.qty}</td>
                    <td>$${item.price.toLocaleString()}</td>
                    <td>${item.pv}</td>
                    <td>$${item.amount.toLocaleString()}</td>
                  </tr>
                `;
              });
              
              buyerTotal.qty += groupData.totalQty;
              buyerTotal.amount += groupData.totalAmount;
              buyerTotal.pv += groupData.totalPV;
            }
            
            html += `
                <tr class="total-row">
                  <td colspan="2"><strong>${buyer} ç¸½è¨ˆ</strong></td>
                  <td><strong>${buyerTotal.qty}</strong></td>
                  <td>-</td>
                  <td><strong>${buyerTotal.pv}</strong></td>
                  <td><strong>$${buyerTotal.amount.toLocaleString()}</strong></td>
                </tr>
              </tbody>
            </table>
            `;
          }
        }
        
        html += `</div>`;
      });
      
      container.innerHTML = html;
    }
    
    // ç¯©é¸æ•¸æ“š
    function filterData() {
      const selectedTeam = document.getElementById('teamFilter').value;
      displayComparisonTable();
      displayTeamAnalysis(selectedTeam);
    }
    
    // åŒ¯å‡ºå ±å‘Š
    function exportReport() {
      let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
      csvContent += "BOGO åœ˜éšŠåˆ†æå ±å‘Š\n\n";
      
      // ç”¢å“éŠ·å”®ç‹€æ…‹
      csvContent += "ç”¢å“éŠ·å”®ç‹€æ…‹\n";
      csvContent += "çµ„åˆ¥,ç”¢å“åç¨±,å–®åƒ¹,PV,æ¥é¾çµ„æ•¸,æ¶è³¼çµ„æ•¸\n";
      
      const sortedProducts = Object.values(productSalesData).sort((a, b) => {
        return sortGroupCode(a.groupCode, b.groupCode);
      });
      
      sortedProducts.forEach(product => {
        csvContent += `${product.groupCode},${product.productName},${product.price},${product.pv},${product.orderQty},${product.reportQty}\n`;
      });
      
      csvContent += "\n\nåœ˜éšŠçµ±è¨ˆ\n";
      
      for (const [team, data] of Object.entries(teamAnalysisData)) {
        csvContent += `\nåœ˜éšŠï¼š${team}\n`;
        csvContent += `è¨‚è³¼ç¸½æ•¸é‡,${data.totalOrderQty}\n`;
        csvContent += `è¨‚è³¼ç¸½é‡‘é¡,$${data.totalOrderAmount}\n`;
        csvContent += `è¨‚è³¼ç¸½PV,${data.totalOrderPV}\n`;
        csvContent += `æ¶è³¼ç¸½æ•¸é‡,${data.totalReportQty}\n`;
        csvContent += `æ¶è³¼ç¸½é‡‘é¡,$${data.totalReportAmount}\n`;
        csvContent += `æ¶è³¼ç¸½PV,${data.totalReportPV}\n\n`;
      }
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "BOGOåœ˜éšŠåˆ†æ_" + new Date().toISOString().split('T')[0] + ".csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showAlert('âœ… å ±å‘Šå·²åŒ¯å‡º');
    }
    
    // å•Ÿå‹•è‡ªå‹•åŒæ­¥ï¼ˆæ¯10ç§’æª¢æŸ¥ä¸€æ¬¡ï¼‰
    function startAutoSync() {
      autoSyncInterval = setInterval(() => {
        autoConnectAndAnalyze(true);
      }, 10000); // 10ç§’åŒæ­¥ä¸€æ¬¡
    }
    
    // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œåˆ†æ
    window.addEventListener('DOMContentLoaded', () => {
      autoConnectAndAnalyze();
      startAutoSync();
    });
    
    // é é¢é—œé–‰æ™‚æ¸…é™¤å®šæ™‚å™¨
    window.addEventListener('beforeunload', () => {
      if (autoSyncInterval) {
        clearInterval(autoSyncInterval);
      }
    });
  </script>
</body>
</html>
