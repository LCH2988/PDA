<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸•é‡‘æ£®ç—…å‹æœƒç®¡ç†ç³»çµ±</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          background: white;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          overflow: hidden;
      }

      .header {
          background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
          color: white;
          padding: 30px;
          text-align: center;
      }

      .header h1 {
          font-size: 2.5em;
          margin-bottom: 10px;
      }

      .header p {
          font-size: 1.2em;
          opacity: 0.9;
      }

      .nav-tabs {
          display: flex;
          background: #f8f9fa;
          border-bottom: 1px solid #dee2e6;
          flex-wrap: wrap;
      }

      .nav-tab {
          flex: 1;
          min-width: 120px;
          padding: 15px 10px;
          background: none;
          border: none;
          cursor: pointer;
          font-size: 14px;
          font-weight: 500;
          color: #6c757d;
          transition: all 0.3s ease;
          text-align: center;
      }

      .nav-tab:hover {
          background: #e9ecef;
          color: #495057;
      }

      .nav-tab.active {
          background: white;
          color: #4CAF50;
          border-bottom: 3px solid #4CAF50;
      }

      .tab-content {
          display: none;
          padding: 30px;
      }

      .tab-content.active {
          display: block;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          font-size: 16px;
          transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          outline: none;
          border-color: #4CAF50;
      }

      .btn {
          padding: 12px 30px;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          margin-right: 10px;
          margin-bottom: 10px;
      }

      .btn-primary {
          background: #4CAF50;
          color: white;
      }

      .btn-primary:hover {
          background: #45a049;
          transform: translateY(-2px);
      }

      .btn-secondary {
          background: #6c757d;
          color: white;
      }

      .btn-secondary:hover {
          background: #5a6268;
      }

      .btn-danger {
          background: #dc3545;
          color: white;
      }

      .btn-danger:hover {
          background: #c82333;
      }

      .alert {
          padding: 15px;
          margin-bottom: 20px;
          border-radius: 8px;
          font-weight: 500;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .alert-error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .alert-info {
          background: #d1ecf1;
          color: #0c5460;
          border: 1px solid #bee5eb;
      }

      .card {
          background: white;
          border-radius: 10px;
          padding: 20px;
          margin-bottom: 20px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          border-left: 4px solid #4CAF50;
      }

      .card h3 {
          color: #333;
          margin-bottom: 15px;
          font-size: 1.3em;
      }

      .card p {
          color: #666;
          line-height: 1.6;
          margin-bottom: 10px;
      }

      .activity-list {
          display: grid;
          gap: 20px;
      }

      .activity-item {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 10px;
          border-left: 4px solid #4CAF50;
      }

      .activity-item h4 {
          color: #333;
          margin-bottom: 10px;
      }

      .activity-item .meta {
          color: #666;
          font-size: 14px;
          margin-bottom: 10px;
      }

      .activity-item .description {
          color: #555;
          margin-bottom: 15px;
          line-height: 1.5;
      }

      .loading {
          text-align: center;
          padding: 40px;
          color: #666;
      }

      .spinner {
          border: 4px solid #f3f3f3;
          border-top: 4px solid #4CAF50;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
          margin: 0 auto 20px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .form-row {
          display: flex;
          gap: 20px;
      }

      .form-row .form-group {
          flex: 1;
      }

      .status-badge {
          display: inline-block;
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
          text-transform: uppercase;
      }

      .status-active {
          background: #d4edda;
          color: #155724;
      }

      .status-pending {
          background: #fff3cd;
          color: #856404;
      }

      .status-inactive {
          background: #f8d7da;
          color: #721c24;
      }

      @media (max-width: 768px) {
          .container {
              margin: 10px;
              border-radius: 10px;
          }

          .header {
              padding: 20px;
          }

          .header h1 {
              font-size: 2em;
          }

          .nav-tabs {
              flex-direction: column;
          }

          .nav-tab {
              flex: none;
              width: 100%;
          }

          .tab-content {
              padding: 20px;
          }

          .form-row {
              flex-direction: column;
              gap: 0;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>ğŸŒŸ å¸•é‡‘æ£®ç—…å‹æœƒ</h1>
          <p>é—œæ‡·ã€æ”¯æŒã€å…±åŒæˆé•·</p>
      </div>

      <div class="nav-tabs">
          <button class="nav-tab active" onclick="showTab('register')">æœƒå“¡è¨»å†Š</button>
          <button class="nav-tab" onclick="showTab('profile')">å€‹äººè³‡æ–™</button>
          <button class="nav-tab" onclick="showTab('activities')">æ´»å‹•å ±å</button>
          <button class="nav-tab" onclick="showTab('volunteer')">å¿—å·¥æœå‹™</button>
          <button class="nav-tab" onclick="showTab('donation')">æ„›å¿ƒææ¬¾</button>
          <button class="nav-tab" onclick="showTab('admin')">ç®¡ç†åŠŸèƒ½</button>
      </div>

      <!-- æœƒå“¡è¨»å†Š -->
      <div id="register" class="tab-content active">
          <div class="card">
              <h3>ğŸ¯ æœƒå“¡è¨»å†Š</h3>
              <p>æ­¡è¿åŠ å…¥å¸•é‡‘æ£®ç—…å‹æœƒï¼è«‹å¡«å¯«ä»¥ä¸‹è³‡æ–™å®Œæˆè¨»å†Šã€‚</p>
          </div>

          <form id="registerForm">
              <div class="form-row">
                  <div class="form-group">
                      <label for="lineId">LINE ID *</label>
                      <input type="text" id="lineId" name="lineId" required placeholder="è«‹è¼¸å…¥æ‚¨çš„LINE ID">
                  </div>
                  <div class="form-group">
                      <label for="lineName">LINE æš±ç¨±</label>
                      <input type="text" id="lineName" name="lineName" placeholder="æ‚¨çš„LINEé¡¯ç¤ºåç¨±">
                  </div>
              </div>

              <div class="form-row">
                  <div class="form-group">
                      <label for="realName">çœŸå¯¦å§“å *</label>
                      <input type="text" id="realName" name="realName" required placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
                  </div>
                  <div class="form-group">
                      <label for="memberType">æœƒå“¡é¡åˆ¥ *</label>
                      <select id="memberType" name="memberType" required>
                          <option value="">è«‹é¸æ“‡</option>
                          <option value="ç—…å‹">ç—…å‹</option>
                          <option value="å®¶å±¬">å®¶å±¬</option>
                          <option value="å¿—å·¥">å¿—å·¥</option>
                          <option value="é†«è­·">é†«è­·äººå“¡</option>
                          <option value="æ”¯æŒè€…">æ”¯æŒè€…</option>
                      </select>
                  </div>
              </div>

              <div class="form-row">
                  <div class="form-group">
                      <label for="phone">è¯çµ¡é›»è©±</label>
                      <input type="tel" id="phone" name="phone" placeholder="09XX-XXX-XXX">
                  </div>
                  <div class="form-group">
                      <label for="email">é›»å­éƒµä»¶</label>
                      <input type="email" id="email" name="email" placeholder="example@email.com">
                  </div>
              </div>

              <div class="form-row">
                  <div class="form-group">
                      <label for="birthday">ç”Ÿæ—¥</label>
                      <input type="date" id="birthday" name="birthday">
                  </div>
                  <div class="form-group">
                      <label for="address">é€šè¨Šåœ°å€</label>
                      <input type="text" id="address" name="address" placeholder="å®Œæ•´åœ°å€">
                  </div>
              </div>

              <button type="submit" class="btn btn-primary">æäº¤è¨»å†Š</button>
              <button type="reset" class="btn btn-secondary">é‡ç½®è¡¨å–®</button>
          </form>
      </div>

      <!-- å€‹äººè³‡æ–™ -->
      <div id="profile" class="tab-content">
          <div class="card">
              <h3>ğŸ‘¤ å€‹äººè³‡æ–™ç®¡ç†</h3>
              <p>æŸ¥çœ‹å’Œæ›´æ–°æ‚¨çš„å€‹äººè³‡æ–™ã€‚</p>
          </div>

          <div id="profileInfo">
              <div class="loading">
                  <div class="spinner"></div>
                  <p>è¼‰å…¥ä¸­...</p>
              </div>
          </div>

          <form id="profileForm" style="display: none;">
              <div class="form-row">
                  <div class="form-group">
                      <label for="profileLineName">LINE æš±ç¨±</label>
                      <input type="text" id="profileLineName" name="lineName">
                  </div>
                  <div class="form-group">
                      <label for="profileRealName">çœŸå¯¦å§“å</label>
                      <input type="text" id="profileRealName" name="realName">
                  </div>
              </div>

              <div class="form-row">
                  <div class="form-group">
                      <label for="profilePhone">è¯çµ¡é›»è©±</label>
                      <input type="tel" id="profilePhone" name="phone">
                  </div>
                  <div class="form-group">
                      <label for="profileEmail">é›»å­éƒµä»¶</label>
                      <input type="email" id="profileEmail" name="email">
                  </div>
              </div>

              <div class="form-group">
                  <label for="profileAddress">é€šè¨Šåœ°å€</label>
                  <input type="text" id="profileAddress" name="address">
              </div>

              <button type="submit" class="btn btn-primary">æ›´æ–°è³‡æ–™</button>
          </form>
      </div>

      <!-- æ´»å‹•å ±å -->
      <div id="activities" class="tab-content">
          <div class="card">
              <h3>ğŸª æ´»å‹•å ±å</h3>
              <p>åƒèˆ‡æˆ‘å€‘ç²¾å¿ƒå®‰æ’çš„å„ç¨®æ´»å‹•ï¼Œèˆ‡ç—…å‹å€‘ä¸€èµ·å­¸ç¿’æˆé•·ã€‚</p>
          </div>

          <div id="activitiesList">
              <div class="loading">
                  <div class="spinner"></div>
                  <p>è¼‰å…¥æ´»å‹•åˆ—è¡¨ä¸­...</p>
              </div>
          </div>
      </div>

      <!-- å¿—å·¥æœå‹™ -->
      <div id="volunteer" class="tab-content">
          <div class="card">
              <h3>ğŸ¤ å¿—å·¥æœå‹™</h3>
              <p>åŠ å…¥æˆ‘å€‘çš„å¿—å·¥è¡Œåˆ—ï¼Œç”¨æ„›å¿ƒå’Œè¡Œå‹•å¹«åŠ©æ›´å¤šéœ€è¦çš„äººã€‚</p>
          </div>

          <div id="volunteerList">
              <div class="loading">
                  <div class="spinner"></div>
                  <p>è¼‰å…¥å¿—å·¥éœ€æ±‚ä¸­...</p>
              </div>
          </div>
      </div>

      <!-- æ„›å¿ƒææ¬¾ -->
      <div id="donation" class="tab-content">
          <div class="card">
              <h3>ğŸ’ æ„›å¿ƒææ¬¾</h3>
              <p>æ‚¨çš„æ¯ä¸€ä»½æ„›å¿ƒéƒ½å°‡ç”¨æ–¼æ”¯æŒç—…å‹æœƒçš„å„é …æœå‹™å’Œæ´»å‹•ã€‚</p>
          </div>

          <form id="donationForm">
              <div class="form-row">
                  <div class="form-group">
                      <label for="donationAmount">ææ¬¾é‡‘é¡ *</label>
                      <input type="number" id="donationAmount" name="amount" required min="1" placeholder="è«‹è¼¸å…¥ææ¬¾é‡‘é¡">
                  </div>
                  <div class="form-group">
                      <label for="donationCategory">ææ¬¾é¡åˆ¥</label>
                      <select id="donationCategory" name="category">
                          <option value="ä¸€èˆ¬ææ¬¾">ä¸€èˆ¬ææ¬¾</option>
                          <option value="æ´»å‹•è´ŠåŠ©">æ´»å‹•è´ŠåŠ©</option>
                          <option value="è¨­å‚™è³¼ç½®">è¨­å‚™è³¼ç½®</option>
                          <option value="å…¶ä»–">å…¶ä»–</option>
                      </select>
                  </div>
              </div>

              <div class="form-group">
                  <label for="donationDescription">ææ¬¾èªªæ˜</label>
                  <textarea id="donationDescription" name="description" rows="3" placeholder="è«‹æè¿°æ‚¨çš„ææ¬¾ç”¨é€”æˆ–ç•™è¨€"></textarea>
              </div>

              <div class="form-group">
                  <label>
                      <input type="checkbox" id="needReceipt" name="needReceipt" value="TRUE">
                      éœ€è¦ææ¬¾æ”¶æ“šï¼ˆå¯ç”¨æ–¼å ±ç¨…ï¼‰
                  </label>
              </div>

              <button type="submit" class="btn btn-primary">ç¢ºèªææ¬¾</button>
          </form>
      </div>

      <!-- ç®¡ç†åŠŸèƒ½ -->
      <div id="admin" class="tab-content">
          <div class="card">
              <h3>âš™ï¸ ç®¡ç†åŠŸèƒ½</h3>
              <p>ç®¡ç†å“¡å°ˆç”¨åŠŸèƒ½ï¼ŒåŒ…å«æœƒå“¡å¯©æ ¸ã€æ´»å‹•ç®¡ç†ç­‰ã€‚</p>
          </div>

          <div id="adminPanel">
              <div class="alert alert-info">
                  è«‹è¼¸å…¥æ‚¨çš„LINE IDä»¥é©—è­‰ç®¡ç†å“¡èº«ä»½
              </div>

              <div class="form-group">
                  <label for="adminLineId">ç®¡ç†å“¡LINE ID</label>
                  <input type="text" id="adminLineId" placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡LINE ID">
                  <button onclick="verifyAdmin()" class="btn btn-primary">é©—è­‰èº«ä»½</button>
              </div>

              <div id="adminFunctions" style="display: none;">
                  <h4>æœƒå“¡ç®¡ç†</h4>
                  <button onclick="showPendingUsers()" class="btn btn-secondary">å¾…å¯©æ ¸æœƒå“¡</button>
                  
                  <h4>æ´»å‹•ç®¡ç†</h4>
                  <button onclick="showCreateActivity()" class="btn btn-primary">å»ºç«‹æ–°æ´»å‹•</button>
                  
                  <div id="createActivityForm" style="display: none; margin-top: 20px;">
                      <h5>å»ºç«‹æ–°æ´»å‹•</h5>
                      <form id="newActivityForm">
                          <div class="form-group">
                              <label for="activityTitle">æ´»å‹•æ¨™é¡Œ *</label>
                              <input type="text" id="activityTitle" name="title" required>
                          </div>
                          
                          <div class="form-group">
                              <label for="activityDescription">æ´»å‹•æè¿°</label>
                              <textarea id="activityDescription" name="description" rows="3"></textarea>
                          </div>
                          
                          <div class="form-row">
                              <div class="form-group">
                                  <label for="activityDate">æ´»å‹•æ—¥æœŸ *</label>
                                  <input type="date" id="activityDate" name="date" required>
                              </div>
                              <div class="form-group">
                                  <label for="activityTime">æ´»å‹•æ™‚é–“</label>
                                  <input type="text" id="activityTime" name="time" placeholder="ä¾‹ï¼š14:00-16:00">
                              </div>
                          </div>
                          
                          <div class="form-row">
                              <div class="form-group">
                                  <label for="activityLocation">æ´»å‹•åœ°é»</label>
                                  <input type="text" id="activityLocation" name="location">
                              </div>
                              <div class="form-group">
                                  <label for="activityFee">æ´»å‹•è²»ç”¨</label>
                                  <input type="number" id="activityFee" name="fee" min="0" value="0">
                              </div>
                          </div>
                          
                          <div class="form-group">
                              <label for="maxParticipants">æœ€å¤§åƒèˆ‡äººæ•¸</label>
                              <input type="number" id="maxParticipants" name="maxParticipants" min="1" placeholder="0è¡¨ç¤ºç„¡é™åˆ¶">
                          </div>
                          
                          <button type="submit" class="btn btn-primary">å»ºç«‹æ´»å‹•</button>
                          <button type="button" onclick="hideCreateActivity()" class="btn btn-secondary">å–æ¶ˆ</button>
                      </form>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <script>
      // å…¨åŸŸè®Šæ•¸
      const API_URL = 'https://script.google.com/macros/s/AKfycbww3oJgQTkUU94Gc12TJPSmIHw9LjdNVjlmIJUUPXQU2FCYFGs5cj4rnbf3cXwHMgElbQ/exec'; // è«‹æ›¿æ›ç‚ºæ‚¨çš„GAS Web App URL
      let currentUser = null;
      let isAdmin = false;

      // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
      document.addEventListener('DOMContentLoaded', function() {
          // ç¶å®šè¡¨å–®äº‹ä»¶
          bindFormEvents();
          
          // è¼‰å…¥æ´»å‹•åˆ—è¡¨
          loadActivities();
          
          // å˜—è©¦è¼‰å…¥ç”¨æˆ¶è³‡æ–™
          const savedLineId = localStorage.getItem('lineId');
          if (savedLineId) {
              loadUserProfile(savedLineId);
          }
      });

      // ç¶å®šè¡¨å–®äº‹ä»¶
      function bindFormEvents() {
          // æœƒå“¡è¨»å†Šè¡¨å–®
          document.getElementById('registerForm').addEventListener('submit', handleRegister);
          
          // å€‹äººè³‡æ–™è¡¨å–®
          document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
          
          // ææ¬¾è¡¨å–®
          document.getElementById('donationForm').addEventListener('submit', handleDonation);
          
          // æ–°æ´»å‹•è¡¨å–®
          document.getElementById('newActivityForm').addEventListener('submit', handleCreateActivity);
      }

      // åˆ‡æ›æ¨™ç±¤é 
      function showTab(tabName) {
          // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
          const tabs = document.querySelectorAll('.tab-content');
          tabs.forEach(tab => tab.classList.remove('active'));
          
          // ç§»é™¤æ‰€æœ‰æ¨™ç±¤æŒ‰éˆ•çš„æ´»å‹•ç‹€æ…‹
          const navTabs = document.querySelectorAll('.nav-tab');
          navTabs.forEach(tab => tab.classList.remove('active'));
          
          // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
          document.getElementById(tabName).classList.add('active');
          
          // è¨­ç½®å°æ‡‰æŒ‰éˆ•ç‚ºæ´»å‹•ç‹€æ…‹
          event.target.classList.add('active');
          
          // ç‰¹æ®Šè™•ç†
          if (tabName === 'activities') {
              loadActivities();
          } else if (tabName === 'volunteer') {
              loadVolunteerNeeds();
          }
      }

      // é¡¯ç¤ºè¨Šæ¯
      function showMessage(message, type = 'info') {
          const alertDiv = document.createElement('div');
          alertDiv.className = `alert alert-${type}`;
          alertDiv.textContent = message;
          
          // æ’å…¥åˆ°ç•¶å‰æ´»å‹•æ¨™ç±¤çš„é–‹é ­
          const activeTab = document.querySelector('.tab-content.active');
          activeTab.insertBefore(alertDiv, activeTab.firstChild);
          
          // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
          setTimeout(() => {
              if (alertDiv.parentNode) {
                  alertDiv.parentNode.removeChild(alertDiv);
              }
          }, 3000);
      }

      // è™•ç†æœƒå“¡è¨»å†Š
      async function handleRegister(event) {
          event.preventDefault();
          
          const formData = new FormData(event.target);
          const userData = Object.fromEntries(formData.entries());
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'register',
                      userData: userData
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showMessage(result.message, 'success');
                  event.target.reset();
                  
                  // å„²å­˜LINE ID
                  localStorage.setItem('lineId', userData.lineId);
              } else {
                  showMessage(result.message, 'error');
              }
          } catch (error) {
              console.error('è¨»å†Šå¤±æ•—:', error);
              showMessage('è¨»å†Šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
          }
      }

      // è¼‰å…¥ç”¨æˆ¶è³‡æ–™
      async function loadUserProfile(lineId) {
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'getProfile',
                      lineId: lineId
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  currentUser = result.user;
                  displayUserProfile(result.user);
              } else {
                  document.getElementById('profileInfo').innerHTML = 
                      '<div class="alert alert-info">å°šæœªè¨»å†Šæœƒå“¡ï¼Œè«‹å…ˆå®Œæˆè¨»å†Šã€‚</div>';
              }
          } catch (error) {
              console.error('è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
              document.getElementById('profileInfo').innerHTML = 
                  '<div class="alert alert-error">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>';
          }
      }

      // é¡¯ç¤ºç”¨æˆ¶è³‡æ–™
      function displayUserProfile(user) {
          const profileInfo = document.getElementById('profileInfo');
          const profileForm = document.getElementById('profileForm');
          
          profileInfo.innerHTML = `
              <div class="card">
                  <h4>æœƒå“¡è³‡è¨Š</h4>
                  <p><strong>LINE ID:</strong> ${user.lineId}</p>
                  <p><strong>å§“å:</strong> ${user.realName}</p>
                  <p><strong>æœƒå“¡é¡åˆ¥:</strong> ${user.memberType}</p>
                  <p><strong>ç‹€æ…‹:</strong> <span class="status-badge ${getStatusClass(user.status)}">${user.status}</span></p>
                  <p><strong>åŠ å…¥æ—¥æœŸ:</strong> ${new Date(user.joinDate).toLocaleDateString('zh-TW')}</p>
              </div>
          `;
          
          // å¡«å…¥è¡¨å–®
          document.getElementById('profileLineName').value = user.lineName || '';
          document.getElementById('profileRealName').value = user.realName || '';
          document.getElementById('profilePhone').value = user.phone || '';
          document.getElementById('profileEmail').value = user.email || '';
          document.getElementById('profileAddress').value = user.address || '';
          
          profileForm.style.display = 'block';
      }

      // å–å¾—ç‹€æ…‹æ¨£å¼é¡åˆ¥
      function getStatusClass(status) {
          switch (status) {
              case 'å·²æ‰¹å‡†': return 'status-active';
              case 'å¾…å¯©æ ¸': return 'status-pending';
              default: return 'status-inactive';
          }
      }

      // è™•ç†å€‹äººè³‡æ–™æ›´æ–°
      async function handleProfileUpdate(event) {
          event.preventDefault();
          
          const lineId = localStorage.getItem('lineId');
          if (!lineId) {
              showMessage('è«‹å…ˆè¨»å†Šæœƒå“¡', 'error');
              return;
          }
          
          const formData = new FormData(event.target);
          const userData = Object.fromEntries(formData.entries());
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'updateProfile',
                      lineId: lineId,
                      userData: userData
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showMessage(result.message, 'success');
                  loadUserProfile(lineId); // é‡æ–°è¼‰å…¥è³‡æ–™
              } else {
                  showMessage(result.message, 'error');
              }
          } catch (error) {
              console.error('æ›´æ–°å¤±æ•—:', error);
              showMessage('æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
          }
      }

      // è¼‰å…¥æ´»å‹•åˆ—è¡¨
      async function loadActivities() {
          try {
              const response = await fetch(`${API_URL}?action=getActivities`);
              const result = await response.json();
              
              if (result.success) {
                  displayActivities(result.activities);
              } else {
                  document.getElementById('activitiesList').innerHTML = 
                      '<div class="alert alert-error">è¼‰å…¥æ´»å‹•å¤±æ•—</div>';
              }
          } catch (error) {
              console.error('è¼‰å…¥æ´»å‹•å¤±æ•—:', error);
              document.getElementById('activitiesList').innerHTML = 
                  '<div class="alert alert-error">è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</div>';
          }
      }

      // é¡¯ç¤ºæ´»å‹•åˆ—è¡¨
      function displayActivities(activities) {
          const container = document.getElementById('activitiesList');
          
          if (activities.length === 0) {
              container.innerHTML = '<div class="alert alert-info">ç›®å‰æ²’æœ‰é–‹æ”¾çš„æ´»å‹•</div>';
              return;
          }
          
          const activitiesHtml = activities.map(activity => `
              <div class="activity-item">
                  <h4>${activity.title}</h4>
                  <div class="meta">
                      ğŸ“… ${activity.date} ${activity.time} | ğŸ“ ${activity.location} | 
                      ğŸ’° ${activity.fee > 0 ? `$${activity.fee}` : 'å…è²»'} | 
                      ğŸ‘¥ ${activity.currentCount}/${activity.maxParticipants || 'âˆ'}
                  </div>
                  <div class="description">${activity.description}</div>
                  <span class="status-badge ${getStatusClass(activity.status)}">${activity.status}</span>
                  ${activity.status === 'é–‹æ”¾å ±å' ? 
                      `<button onclick="registerForActivity('${activity.id}')" class="btn btn-primary">ç«‹å³å ±å</button>` : 
                      ''
                  }
              </div>
          `).join('');
          
          container.innerHTML = `<div class="activity-list">${activitiesHtml}</div>`;
      }

      // å ±åæ´»å‹•
      async function registerForActivity(activityId) {
          const lineId = localStorage.getItem('lineId');
          if (!lineId) {
              showMessage('è«‹å…ˆè¨»å†Šæœƒå“¡', 'error');
              showTab('register');
              return;
          }
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'registerActivity',
                      lineId: lineId,
                      activityId: activityId
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showMessage(result.message, 'success');
                  loadActivities(); // é‡æ–°è¼‰å…¥æ´»å‹•åˆ—è¡¨
              } else {
                  showMessage(result.message, 'error');
              }
          } catch (error) {
              console.error('å ±åå¤±æ•—:', error);
              showMessage('å ±åå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
          }
      }

      // è¼‰å…¥å¿—å·¥éœ€æ±‚
      async function loadVolunteerNeeds() {
          document.getElementById('volunteerList').innerHTML = `
              <div class="activity-item">
                  <h4>ğŸ¤ æ´»å‹•å”åŠ©å¿—å·¥</h4>
                  <div class="meta">ğŸ“… 2024-12-01 13:00-17:00 | ğŸ‘¥ éœ€è¦ 5 äºº</div>
                  <div class="description">å”åŠ©å¥åº·è¬›åº§çš„ç°½åˆ°ã€æœƒå ´æ•´ç†åŠæ´»å‹•é€²è¡Œ</div>
                  <span class="status-badge status-active">é–‹æ”¾å ±å</span>
                  <button onclick="applyVolunteer('vol001')" class="btn btn-primary">ç”³è«‹æœå‹™</button>
              </div>
              <div class="activity-item">
                  <h4>ğŸ’ é™ªä¼´æœå‹™å¿—å·¥</h4>
                  <div class="meta">ğŸ“… 2024-12-08 09:30-12:30 | ğŸ‘¥ éœ€è¦ 3 äºº</div>
                  <div class="description">é™ªä¼´ç—…å‹åƒèˆ‡å¾©å¥èª²ç¨‹ï¼Œæä¾›æƒ…æ„Ÿæ”¯æŒ</div>
                  <span class="status-badge status-active">é–‹æ”¾å ±å</span>
                  <button onclick="applyVolunteer('vol002')" class="btn btn-primary">ç”³è«‹æœå‹™</button>
              </div>
          `;
      }

      // ç”³è«‹å¿—å·¥æœå‹™
      function applyVolunteer(volunteerId) {
          const lineId = localStorage.getItem('lineId');
          if (!lineId) {
              showMessage('è«‹å…ˆè¨»å†Šæœƒå“¡', 'error');
              showTab('register');
              return;
          }
          
          showMessage('å¿—å·¥ç”³è«‹åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ„Ÿè¬æ‚¨çš„æ„›å¿ƒï¼', 'info');
      }

      // è™•ç†ææ¬¾
      async function handleDonation(event) {
          event.preventDefault();
          
          const lineId = localStorage.getItem('lineId');
          if (!lineId) {
              showMessage('è«‹å…ˆè¨»å†Šæœƒå“¡', 'error');
              showTab('register');
              return;
          }
          
          const formData = new FormData(event.target);
          const donationData = Object.fromEntries(formData.entries());
          
          // è™•ç†è¤‡é¸æ¡†
          donationData.needReceipt = document.getElementById('needReceipt').checked ? 'TRUE' : 'FALSE';
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'recordDonation',
                      lineId: lineId,
                      donationData: donationData
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showMessage(result.message, 'success');
                  event.target.reset();
              } else {
                  showMessage(result.message, 'error');
              }
          } catch (error) {
              console.error('ææ¬¾è¨˜éŒ„å¤±æ•—:', error);
              showMessage('ææ¬¾è¨˜éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
          }
      }

      // é©—è­‰ç®¡ç†å“¡èº«ä»½
      function verifyAdmin() {
          const adminLineId = document.getElementById('adminLineId').value.trim();
          if (!adminLineId) {
              showMessage('è«‹è¼¸å…¥LINE ID', 'error');
              return;
          }
          
          // ç°¡å–®çš„ç®¡ç†å“¡é©—è­‰ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­æ‡‰è©²é€šéå¾Œç«¯é©—è­‰ï¼‰
          const adminUsers = ['U0987654321']; // é€™æ‡‰è©²å¾å¾Œç«¯ç²å–
          
          if (adminUsers.includes(adminLineId)) {
              isAdmin = true;
              document.getElementById('adminFunctions').style.display = 'block';
              showMessage('ç®¡ç†å“¡èº«ä»½é©—è­‰æˆåŠŸ', 'success');
          } else {
              showMessage('æ‚¨ä¸æ˜¯ç®¡ç†å“¡', 'error');
          }
      }

      // é¡¯ç¤ºå¾…å¯©æ ¸æœƒå“¡
      function showPendingUsers() {
          showMessage('å¾…å¯©æ ¸æœƒå“¡åŠŸèƒ½é–‹ç™¼ä¸­', 'info');
      }

      // é¡¯ç¤ºå»ºç«‹æ´»å‹•è¡¨å–®
      function showCreateActivity() {
          document.getElementById('createActivityForm').style.display = 'block';
      }

      // éš±è—å»ºç«‹æ´»å‹•è¡¨å–®
      function hideCreateActivity() {
          document.getElementById('createActivityForm').style.display = 'none';
          document.getElementById('newActivityForm').reset();
      }

      // è™•ç†å»ºç«‹æ–°æ´»å‹•
      async function handleCreateActivity(event) {
          event.preventDefault();
          
          const adminLineId = document.getElementById('adminLineId').value.trim();
          if (!adminLineId || !isAdmin) {
              showMessage('è«‹å…ˆé©—è­‰ç®¡ç†å“¡èº«ä»½', 'error');
              return;
          }
          
          const formData = new FormData(event.target);
          const activityData = Object.fromEntries(formData.entries());
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'createActivity',
                      lineId: adminLineId,
                      activityData: activityData
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showMessage(result.message, 'success');
                  hideCreateActivity();
                  loadActivities(); // é‡æ–°è¼‰å…¥æ´»å‹•åˆ—è¡¨
              } else {
                  showMessage(result.message, 'error');
              }
          } catch (error) {
              console.error('å»ºç«‹æ´»å‹•å¤±æ•—:', error);
              showMessage('å»ºç«‹æ´»å‹•å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
          }
      }

      // å·¥å…·å‡½æ•¸ï¼šæ ¼å¼åŒ–æ—¥æœŸ
      function formatDate(dateString) {
          if (!dateString) return '';
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW');
      }

      // å·¥å…·å‡½æ•¸ï¼šæ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
      function formatDateTime(dateString) {
          if (!dateString) return '';
          const date = new Date(dateString);
          return date.toLocaleString('zh-TW');
      }

      // åˆå§‹åŒ–é é¢
      function initializePage() {
          // æª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„LINE ID
          const savedLineId = localStorage.getItem('lineId');
          if (savedLineId) {
              document.getElementById('lineId').value = savedLineId;
          }
          
          // è¨­å®šç•¶å‰æ—¥æœŸç‚ºæ´»å‹•æ—¥æœŸçš„æœ€å°å€¼
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('activityDate').min = today;
      }

      // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>
