<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友會管理系統</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          background: white;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          overflow: hidden;
      }

      .header {
          background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
          color: white;
          padding: 30px;
          text-align: center;
      }

      .header h1 {
          font-size: 2.5em;
          margin-bottom: 10px;
      }

      .header p {
          font-size: 1.2em;
          opacity: 0.9;
      }

      .nav-tabs {
          display: flex;
          background: #f8f9fa;
          border-bottom: 1px solid #dee2e6;
          flex-wrap: wrap;
      }

      .nav-tab {
          flex: 1;
          min-width: 120px;
          padding: 15px 10px;
          background: none;
          border: none;
          cursor: pointer;
          font-size: 14px;
          font-weight: 500;
          color: #6c757d;
          transition: all 0.3s ease;
          text-align: center;
      }

      .nav-tab:hover {
          background: #e9ecef;
          color: #495057;
      }

      .nav-tab.active {
          background: white;
          color: #4CAF50;
          border-bottom: 3px solid #4CAF50;
      }

      .tab-content {
          display: none;
          padding: 30px;
      }

      .tab-content.active {
          display: block;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          font-size: 16px;
          transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          outline: none;
          border-color: #4CAF50;
      }

      .btn {
          padding: 12px 30px;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          margin-right: 10px;
          margin-bottom: 10px;
      }

      .btn-primary {
          background: #4CAF50;
          color: white;
      }

      .btn-primary:hover {
          background: #45a049;
          transform: translateY(-2px);
      }

      .btn-secondary {
          background: #6c757d;
          color: white;
      }

      .btn-secondary:hover {
          background: #5a6268;
      }

      .btn-danger {
          background: #dc3545;
          color: white;
      }

      .btn-danger:hover {
          background: #c82333;
      }

      .alert {
          padding: 15px;
          margin-bottom: 20px;
          border-radius: 8px;
          font-weight: 500;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .alert-error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .alert-info {
          background: #d1ecf1;
          color: #0c5460;
          border: 1px solid #bee5eb;
      }

      .card {
          background: white;
          border-radius: 10px;
          padding: 20px;
          margin-bottom: 20px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          border-left: 4px solid #4CAF50;
      }

      .card h3 {
          color: #333;
          margin-bottom: 15px;
          font-size: 1.3em;
      }

      .card p {
          color: #666;
          line-height: 1.6;
          margin-bottom: 10px;
      }

      .activity-list {
          display: grid;
          gap: 20px;
      }

      .activity-item {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 10px;
          border-left: 4px solid #4CAF50;
      }

      .activity-item h4 {
          color: #333;
          margin-bottom: 10px;
      }

      .activity-item .meta {
          color: #666;
          font-size: 14px;
          margin-bottom: 10px;
      }

      .activity-item .description {
          color: #555;
          margin-bottom: 15px;
          line-height: 1.5;
      }

      .loading {
          text-align: center;
          padding: 40px;
          color: #666;
      }

      .spinner {
          border: 4px solid #f3f3f3;
          border-top: 4px solid #4CAF50;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
          margin: 0 auto 20px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .form-row {
          display: flex;
          gap: 20px;
      }

      .form-row .form-group {
          flex: 1;
      }

      .status-badge {
          display: inline-block;
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
          text-transform: uppercase;
      }

      .status-active {
          background: #d4edda;
          color: #155724;
      }

      .status-pending {
          background: #fff3cd;
          color: #856404;
      }

      .status-inactive {
          background: #f8d7da;
          color: #721c24;
      }

      @media (max-width: 768px) {
          .container {
              margin: 10px;
              border-radius: 10px;
          }

          .header {
              padding: 20px;
          }

          .header h1 {
              font-size: 2em;
          }

          .nav-tabs {
              flex-direction: column;
          }

          .nav-tab {
              flex: none;
              width: 100%;
          }

          .tab-content {
              padding: 20px;
          }

          .form-row {
              flex-direction: column;
              gap: 0;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>🌟 帕金森病友會</h1>
          <p>關懷、支持、共同成長</p>
      </div>

      <div class="nav-tabs">
          <button class="nav-tab active" onclick="showTab('register')">會員註冊</button>
          <button class="nav-tab" onclick="showTab('profile')">個人資料</button>
          <button class="nav-tab" onclick="showTab('activities')">活動報名</button>
          <button class="nav-tab" onclick="showTab('volunteer')">志工服務</button>
          <button class="nav-tab" onclick="showTab('donation')">愛心捐款</button>
          <button class="nav-tab" onclick="showTab('admin')">管理功能</button>
      </div>

      <!-- 會員註冊 -->
      <div id="register" class="tab-content active">
          <div class="card">
              <h3>🎯 會員註冊</h3>
              <p>歡迎加入帕金森病友會！請填寫以下資料完成註冊。</p>
          </div>

          <form id="registerForm">
              <div class="form-row">
                  <div class="form-group">
                      <label for="lineId">LINE ID *</label>
                      <input type="text" id="lineId" name="lineId" required placeholder="請輸入您的LINE ID">
                  </div>
                  <div class="form-group">
                      <label for="lineName">LINE 暱稱</label>
                      <input type="text" id="lineName" name="lineName" placeholder="您的LINE顯示名稱">
                  </div>
              </div>

              <div class="form-row">
                  <div class="form-group">
                      <label for="realName">真實姓名 *</label>
                      <input type="text" id="realName" name="realName" required placeholder="請輸入真實姓名">
                  </div>
                  <div class="form-group">
                      <label for="memberType">會員類別 *</label>
                      <select id="memberType" name="memberType" required>
                          <option value="">請選擇</option>
                          <option value="病友">病友</option>
                          <option value="家屬">家屬</option>
                          <option value="志工">志工</option>
                          <option value="醫護">醫護人員</option>
                          <option value="支持者">支持者</option>
                      </select>
                  </div>
              </div>

              <div class="form-row">
                  <div class="form-group">
                      <label for="phone">聯絡電話</label>
                      <input type="tel" id="phone" name="phone" placeholder="09XX-XXX-XXX">
                  </div>
                  <div class="form-group">
                      <label for="email">電子郵件</label>
                      <input type="email" id="email" name="email" placeholder="example@email.com">
                  </div>
              </div>

              <div class="form-row">
                  <div class="form-group">
                      <label for="birthday">生日</label>
                      <input type="date" id="birthday" name="birthday">
                  </div>
                  <div class="form-group">
                      <label for="address">通訊地址</label>
                      <input type="text" id="address" name="address" placeholder="完整地址">
                  </div>
              </div>

              <button type="submit" class="btn btn-primary">提交註冊</button>
              <button type="reset" class="btn btn-secondary">重置表單</button>
          </form>
      </div>

      <!-- 個人資料 -->
      <div id="profile" class="tab-content">
          <div class="card">
              <h3>👤 個人資料管理</h3>
              <p>查看和更新您的個人資料。</p>
          </div>

          <div id="profileInfo">
              <div class="loading">
                  <div class="spinner"></div>
                  <p>載入中...</p>
              </div>
          </div>

          <form id="profileForm" style="display: none;">
              <div class="form-row">
                  <div class="form-group">
                      <label for="profileLineName">LINE 暱稱</label>
                      <input type="text" id="profileLineName" name="lineName">
                  </div>
                  <div class="form-group">
                      <label for="profileRealName">真實姓名</label>
                      <input type="text" id="profileRealName" name="realName">
                  </div>
              </div>

              <div class="form-row">
                  <div class="form-group">
                      <label for="profilePhone">聯絡電話</label>
                      <input type="tel" id="profilePhone" name="phone">
                  </div>
                  <div class="form-group">
                      <label for="profileEmail">電子郵件</label>
                      <input type="email" id="profileEmail" name="email">
                  </div>
              </div>

              <div class="form-group">
                  <label for="profileAddress">通訊地址</label>
                  <input type="text" id="profileAddress" name="address">
              </div>

              <button type="submit" class="btn btn-primary">更新資料</button>
          </form>
      </div>

      <!-- 活動報名 -->
      <div id="activities" class="tab-content">
          <div class="card">
              <h3>🎪 活動報名</h3>
              <p>參與我們精心安排的各種活動，與病友們一起學習成長。</p>
          </div>

          <div id="activitiesList">
              <div class="loading">
                  <div class="spinner"></div>
                  <p>載入活動列表中...</p>
              </div>
          </div>
      </div>

      <!-- 志工服務 -->
      <div id="volunteer" class="tab-content">
          <div class="card">
              <h3>🤝 志工服務</h3>
              <p>加入我們的志工行列，用愛心和行動幫助更多需要的人。</p>
          </div>

          <div id="volunteerList">
              <div class="loading">
                  <div class="spinner"></div>
                  <p>載入志工需求中...</p>
              </div>
          </div>
      </div>

      <!-- 愛心捐款 -->
      <div id="donation" class="tab-content">
          <div class="card">
              <h3>💝 愛心捐款</h3>
              <p>您的每一份愛心都將用於支持病友會的各項服務和活動。</p>
          </div>

          <form id="donationForm">
              <div class="form-row">
                  <div class="form-group">
                      <label for="donationAmount">捐款金額 *</label>
                      <input type="number" id="donationAmount" name="amount" required min="1" placeholder="請輸入捐款金額">
                  </div>
                  <div class="form-group">
                      <label for="donationCategory">捐款類別</label>
                      <select id="donationCategory" name="category">
                          <option value="一般捐款">一般捐款</option>
                          <option value="活動贊助">活動贊助</option>
                          <option value="設備購置">設備購置</option>
                          <option value="其他">其他</option>
                      </select>
                  </div>
              </div>

              <div class="form-group">
                  <label for="donationDescription">捐款說明</label>
                  <textarea id="donationDescription" name="description" rows="3" placeholder="請描述您的捐款用途或留言"></textarea>
              </div>

              <div class="form-group">
                  <label>
                      <input type="checkbox" id="needReceipt" name="needReceipt" value="TRUE">
                      需要捐款收據（可用於報稅）
                  </label>
              </div>

              <button type="submit" class="btn btn-primary">確認捐款</button>
          </form>
      </div>

      <!-- 管理功能 -->
      <div id="admin" class="tab-content">
          <div class="card">
              <h3>⚙️ 管理功能</h3>
              <p>管理員專用功能，包含會員審核、活動管理等。</p>
          </div>

          <div id="adminPanel">
              <div class="alert alert-info">
                  請輸入您的LINE ID以驗證管理員身份
              </div>

              <div class="form-group">
                  <label for="adminLineId">管理員LINE ID</label>
                  <input type="text" id="adminLineId" placeholder="請輸入管理員LINE ID">
                  <button onclick="verifyAdmin()" class="btn btn-primary">驗證身份</button>
              </div>

              <div id="adminFunctions" style="display: none;">
                  <h4>會員管理</h4>
                  <button onclick="showPendingUsers()" class="btn btn-secondary">待審核會員</button>
                  
                  <h4>活動管理</h4>
                  <button onclick="showCreateActivity()" class="btn btn-primary">建立新活動</button>
                  
                  <div id="createActivityForm" style="display: none; margin-top: 20px;">
                      <h5>建立新活動</h5>
                      <form id="newActivityForm">
                          <div class="form-group">
                              <label for="activityTitle">活動標題 *</label>
                              <input type="text" id="activityTitle" name="title" required>
                          </div>
                          
                          <div class="form-group">
                              <label for="activityDescription">活動描述</label>
                              <textarea id="activityDescription" name="description" rows="3"></textarea>
                          </div>
                          
                          <div class="form-row">
                              <div class="form-group">
                                  <label for="activityDate">活動日期 *</label>
                                  <input type="date" id="activityDate" name="date" required>
                              </div>
                              <div class="form-group">
                                  <label for="activityTime">活動時間</label>
                                  <input type="text" id="activityTime" name="time" placeholder="例：14:00-16:00">
                              </div>
                          </div>
                          
                          <div class="form-row">
                              <div class="form-group">
                                  <label for="activityLocation">活動地點</label>
                                  <input type="text" id="activityLocation" name="location">
                              </div>
                              <div class="form-group">
                                  <label for="activityFee">活動費用</label>
                                  <input type="number" id="activityFee" name="fee" min="0" value="0">
                              </div>
                          </div>
                          
                          <div class="form-group">
                              <label for="maxParticipants">最大參與人數</label>
                              <input type="number" id="maxParticipants" name="maxParticipants" min="1" placeholder="0表示無限制">
                          </div>
                          
                          <button type="submit" class="btn btn-primary">建立活動</button>
                          <button type="button" onclick="hideCreateActivity()" class="btn btn-secondary">取消</button>
                      </form>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <script>
      // 全域變數
      const API_URL = 'https://script.google.com/macros/s/AKfycbww3oJgQTkUU94Gc12TJPSmIHw9LjdNVjlmIJUUPXQU2FCYFGs5cj4rnbf3cXwHMgElbQ/exec'; // 請替換為您的GAS Web App URL
      let currentUser = null;
      let isAdmin = false;

      // 頁面載入完成後執行
      document.addEventListener('DOMContentLoaded', function() {
          // 綁定表單事件
          bindFormEvents();
          
          // 載入活動列表
          loadActivities();
          
          // 嘗試載入用戶資料
          const savedLineId = localStorage.getItem('lineId');
          if (savedLineId) {
              loadUserProfile(savedLineId);
          }
      });

      // 綁定表單事件
      function bindFormEvents() {
          // 會員註冊表單
          document.getElementById('registerForm').addEventListener('submit', handleRegister);
          
          // 個人資料表單
          document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
          
          // 捐款表單
          document.getElementById('donationForm').addEventListener('submit', handleDonation);
          
          // 新活動表單
          document.getElementById('newActivityForm').addEventListener('submit', handleCreateActivity);
      }

      // 切換標籤頁
      function showTab(tabName) {
          // 隱藏所有標籤內容
          const tabs = document.querySelectorAll('.tab-content');
          tabs.forEach(tab => tab.classList.remove('active'));
          
          // 移除所有標籤按鈕的活動狀態
          const navTabs = document.querySelectorAll('.nav-tab');
          navTabs.forEach(tab => tab.classList.remove('active'));
          
          // 顯示選中的標籤內容
          document.getElementById(tabName).classList.add('active');
          
          // 設置對應按鈕為活動狀態
          event.target.classList.add('active');
          
          // 特殊處理
          if (tabName === 'activities') {
              loadActivities();
          } else if (tabName === 'volunteer') {
              loadVolunteerNeeds();
          }
      }

      // 顯示訊息
      function showMessage(message, type = 'info') {
          const alertDiv = document.createElement('div');
          alertDiv.className = `alert alert-${type}`;
          alertDiv.textContent = message;
          
          // 插入到當前活動標籤的開頭
          const activeTab = document.querySelector('.tab-content.active');
          activeTab.insertBefore(alertDiv, activeTab.firstChild);
          
          // 3秒後自動移除
          setTimeout(() => {
              if (alertDiv.parentNode) {
                  alertDiv.parentNode.removeChild(alertDiv);
              }
          }, 3000);
      }

      // 處理會員註冊
      async function handleRegister(event) {
          event.preventDefault();
          
          const formData = new FormData(event.target);
          const userData = Object.fromEntries(formData.entries());
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'register',
                      userData: userData
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showMessage(result.message, 'success');
                  event.target.reset();
                  
                  // 儲存LINE ID
                  localStorage.setItem('lineId', userData.lineId);
              } else {
                  showMessage(result.message, 'error');
              }
          } catch (error) {
              console.error('註冊失敗:', error);
              showMessage('註冊失敗，請檢查網路連線', 'error');
          }
      }

      // 載入用戶資料
      async function loadUserProfile(lineId) {
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'getProfile',
                      lineId: lineId
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  currentUser = result.user;
                  displayUserProfile(result.user);
              } else {
                  document.getElementById('profileInfo').innerHTML = 
                      '<div class="alert alert-info">尚未註冊會員，請先完成註冊。</div>';
              }
          } catch (error) {
              console.error('載入用戶資料失敗:', error);
              document.getElementById('profileInfo').innerHTML = 
                  '<div class="alert alert-error">載入失敗，請稍後再試。</div>';
          }
      }

      // 顯示用戶資料
      function displayUserProfile(user) {
          const profileInfo = document.getElementById('profileInfo');
          const profileForm = document.getElementById('profileForm');
          
          profileInfo.innerHTML = `
              <div class="card">
                  <h4>會員資訊</h4>
                  <p><strong>LINE ID:</strong> ${user.lineId}</p>
                  <p><strong>姓名:</strong> ${user.realName}</p>
                  <p><strong>會員類別:</strong> ${user.memberType}</p>
                  <p><strong>狀態:</strong> <span class="status-badge ${getStatusClass(user.status)}">${user.status}</span></p>
                  <p><strong>加入日期:</strong> ${new Date(user.joinDate).toLocaleDateString('zh-TW')}</p>
              </div>
          `;
          
          // 填入表單
          document.getElementById('profileLineName').value = user.lineName || '';
          document.getElementById('profileRealName').value = user.realName || '';
          document.getElementById('profilePhone').value = user.phone || '';
          document.getElementById('profileEmail').value = user.email || '';
          document.getElementById('profileAddress').value = user.address || '';
          
          profileForm.style.display = 'block';
      }

      // 取得狀態樣式類別
      function getStatusClass(status) {
          switch (status) {
              case '已批准': return 'status-active';
              case '待審核': return 'status-pending';
              default: return 'status-inactive';
          }
      }

      // 處理個人資料更新
      async function handleProfileUpdate(event) {
          event.preventDefault();
          
          const lineId = localStorage.getItem('lineId');
          if (!lineId) {
              showMessage('請先註冊會員', 'error');
              return;
          }
          
          const formData = new FormData(event.target);
          const userData = Object.fromEntries(formData.entries());
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'updateProfile',
                      lineId: lineId,
                      userData: userData
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showMessage(result.message, 'success');
                  loadUserProfile(lineId); // 重新載入資料
              } else {
                  showMessage(result.message, 'error');
              }
          } catch (error) {
              console.error('更新失敗:', error);
              showMessage('更新失敗，請檢查網路連線', 'error');
          }
      }

      // 載入活動列表
      async function loadActivities() {
          try {
              const response = await fetch(`${API_URL}?action=getActivities`);
              const result = await response.json();
              
              if (result.success) {
                  displayActivities(result.activities);
              } else {
                  document.getElementById('activitiesList').innerHTML = 
                      '<div class="alert alert-error">載入活動失敗</div>';
              }
          } catch (error) {
              console.error('載入活動失敗:', error);
              document.getElementById('activitiesList').innerHTML = 
                  '<div class="alert alert-error">載入失敗，請檢查網路連線</div>';
          }
      }

      // 顯示活動列表
      function displayActivities(activities) {
          const container = document.getElementById('activitiesList');
          
          if (activities.length === 0) {
              container.innerHTML = '<div class="alert alert-info">目前沒有開放的活動</div>';
              return;
          }
          
          const activitiesHtml = activities.map(activity => `
              <div class="activity-item">
                  <h4>${activity.title}</h4>
                  <div class="meta">
                      📅 ${activity.date} ${activity.time} | 📍 ${activity.location} | 
                      💰 ${activity.fee > 0 ? `$${activity.fee}` : '免費'} | 
                      👥 ${activity.currentCount}/${activity.maxParticipants || '∞'}
                  </div>
                  <div class="description">${activity.description}</div>
                  <span class="status-badge ${getStatusClass(activity.status)}">${activity.status}</span>
                  ${activity.status === '開放報名' ? 
                      `<button onclick="registerForActivity('${activity.id}')" class="btn btn-primary">立即報名</button>` : 
                      ''
                  }
              </div>
          `).join('');
          
          container.innerHTML = `<div class="activity-list">${activitiesHtml}</div>`;
      }

      // 報名活動
      async function registerForActivity(activityId) {
          const lineId = localStorage.getItem('lineId');
          if (!lineId) {
              showMessage('請先註冊會員', 'error');
              showTab('register');
              return;
          }
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'registerActivity',
                      lineId: lineId,
                      activityId: activityId
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showMessage(result.message, 'success');
                  loadActivities(); // 重新載入活動列表
              } else {
                  showMessage(result.message, 'error');
              }
          } catch (error) {
              console.error('報名失敗:', error);
              showMessage('報名失敗，請檢查網路連線', 'error');
          }
      }

      // 載入志工需求
      async function loadVolunteerNeeds() {
          document.getElementById('volunteerList').innerHTML = `
              <div class="activity-item">
                  <h4>🤝 活動協助志工</h4>
                  <div class="meta">📅 2024-12-01 13:00-17:00 | 👥 需要 5 人</div>
                  <div class="description">協助健康講座的簽到、會場整理及活動進行</div>
                  <span class="status-badge status-active">開放報名</span>
                  <button onclick="applyVolunteer('vol001')" class="btn btn-primary">申請服務</button>
              </div>
              <div class="activity-item">
                  <h4>💝 陪伴服務志工</h4>
                  <div class="meta">📅 2024-12-08 09:30-12:30 | 👥 需要 3 人</div>
                  <div class="description">陪伴病友參與復健課程，提供情感支持</div>
                  <span class="status-badge status-active">開放報名</span>
                  <button onclick="applyVolunteer('vol002')" class="btn btn-primary">申請服務</button>
              </div>
          `;
      }

      // 申請志工服務
      function applyVolunteer(volunteerId) {
          const lineId = localStorage.getItem('lineId');
          if (!lineId) {
              showMessage('請先註冊會員', 'error');
              showTab('register');
              return;
          }
          
          showMessage('志工申請功能開發中，感謝您的愛心！', 'info');
      }

      // 處理捐款
      async function handleDonation(event) {
          event.preventDefault();
          
          const lineId = localStorage.getItem('lineId');
          if (!lineId) {
              showMessage('請先註冊會員', 'error');
              showTab('register');
              return;
          }
          
          const formData = new FormData(event.target);
          const donationData = Object.fromEntries(formData.entries());
          
          // 處理複選框
          donationData.needReceipt = document.getElementById('needReceipt').checked ? 'TRUE' : 'FALSE';
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'recordDonation',
                      lineId: lineId,
                      donationData: donationData
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showMessage(result.message, 'success');
                  event.target.reset();
              } else {
                  showMessage(result.message, 'error');
              }
          } catch (error) {
              console.error('捐款記錄失敗:', error);
              showMessage('捐款記錄失敗，請檢查網路連線', 'error');
          }
      }

      // 驗證管理員身份
      function verifyAdmin() {
          const adminLineId = document.getElementById('adminLineId').value.trim();
          if (!adminLineId) {
              showMessage('請輸入LINE ID', 'error');
              return;
          }
          
          // 簡單的管理員驗證（實際應用中應該通過後端驗證）
          const adminUsers = ['U0987654321']; // 這應該從後端獲取
          
          if (adminUsers.includes(adminLineId)) {
              isAdmin = true;
              document.getElementById('adminFunctions').style.display = 'block';
              showMessage('管理員身份驗證成功', 'success');
          } else {
              showMessage('您不是管理員', 'error');
          }
      }

      // 顯示待審核會員
      function showPendingUsers() {
          showMessage('待審核會員功能開發中', 'info');
      }

      // 顯示建立活動表單
      function showCreateActivity() {
          document.getElementById('createActivityForm').style.display = 'block';
      }

      // 隱藏建立活動表單
      function hideCreateActivity() {
          document.getElementById('createActivityForm').style.display = 'none';
          document.getElementById('newActivityForm').reset();
      }

      // 處理建立新活動
      async function handleCreateActivity(event) {
          event.preventDefault();
          
          const adminLineId = document.getElementById('adminLineId').value.trim();
          if (!adminLineId || !isAdmin) {
              showMessage('請先驗證管理員身份', 'error');
              return;
          }
          
          const formData = new FormData(event.target);
          const activityData = Object.fromEntries(formData.entries());
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'createActivity',
                      lineId: adminLineId,
                      activityData: activityData
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showMessage(result.message, 'success');
                  hideCreateActivity();
                  loadActivities(); // 重新載入活動列表
              } else {
                  showMessage(result.message, 'error');
              }
          } catch (error) {
              console.error('建立活動失敗:', error);
              showMessage('建立活動失敗，請檢查網路連線', 'error');
          }
      }

      // 工具函數：格式化日期
      function formatDate(dateString) {
          if (!dateString) return '';
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW');
      }

      // 工具函數：格式化日期時間
      function formatDateTime(dateString) {
          if (!dateString) return '';
          const date = new Date(dateString);
          return date.toLocaleString('zh-TW');
      }

      // 初始化頁面
      function initializePage() {
          // 檢查是否有儲存的LINE ID
          const savedLineId = localStorage.getItem('lineId');
          if (savedLineId) {
              document.getElementById('lineId').value = savedLineId;
          }
          
          // 設定當前日期為活動日期的最小值
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('activityDate').min = today;
      }

      // 頁面載入時初始化
      document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>
