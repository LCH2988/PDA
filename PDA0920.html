<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帕金森病友會管理系統</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
      :root {
          --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          --success-gradient: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
          --danger-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
          --warning-gradient: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
          --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }
      
      body {
          background: var(--primary-gradient);
          min-height: 100vh;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      
      .main-header {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-radius: 20px;
          padding: 20px;
          margin: 20px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.1);
          position: sticky;
          top: 20px;
          z-index: 1000;
          text-align: center;
      }
      
      .main-header h1 {
          background: var(--primary-gradient);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          margin-bottom: 10px;
      }
      
      .user-info-bar {
          background: rgba(255, 255, 255, 0.9);
          padding: 10px 20px;
          border-radius: 25px;
          display: inline-flex;
          align-items: center;
          gap: 15px;
          box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      }
      
      .user-avatar {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          border: 4px solid white;
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
          background: var(--primary-gradient);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: 600;
          font-size: 1.2rem;
      }
      
      .nav-container, .content-card {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-radius: 20px;
          padding: 20px;
          margin: 20px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.1);
          transition: all 0.3s ease;
      }
      
      .content-card:hover {
          transform: translateY(-2px);
      }
      
      .nav-pills .nav-link {
          border-radius: 15px;
          margin: 0 5px;
          transition: all 0.3s ease;
      }
      
      .nav-pills .nav-link.active {
          background: var(--primary-gradient);
      }
      
      .stat-card {
          background: var(--success-gradient);
          color: white;
          border-radius: 15px;
          padding: 20px;
          text-align: center;
          margin-bottom: 20px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      }
      
      .quick-actions {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
          gap: 12px;
          margin-bottom: 20px;
      }
      
      .quick-btn {
          background: rgba(255, 255, 255, 0.95);
          padding: 18px;
          border-radius: 15px;
          text-align: center;
          cursor: pointer;
          border: 2px solid #e2e8f0;
          transition: all 0.25s ease;
          text-decoration: none;
          color: inherit;
      }
      
      .quick-btn:hover {
          background: white;
          border-color: #667eea;
          transform: translateY(-2px);
          color: inherit;
      }
      
      .activity-item, .transaction-item {
          background: white;
          border-radius: 15px;
          padding: 16px 18px;
          margin-bottom: 15px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          border-left: 4px solid #667eea;
          transition: all 0.3s ease;
      }
      
      .activity-item:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      }
      
      .status-badge {
          display: inline-block;
          padding: 4px 10px;
          border-radius: 16px;
          font-size: 12px;
          font-weight: 600;
      }
      
      .status-開放報名, .status-open { background: #c6f6d5; color: #22543d; }
      .status-已報名 { background: #bee3f8; color: #2a4365; }
      .status-已取消 { background: #fed7d7; color: #742a2a; }
      .status-已結束 { background: #e2e8f0; color: #4a5568; }
      .status-已註冊 { background: #c6f6d5; color: #22543d; }
      .status-待審核 { background: #feebc8; color: #7b341e; }
      .status-已核准 { background: #c6f6d5; color: #22543d; }
      
      .form-control, .form-select {
          border-radius: 10px;
          border: 2px solid #e9ecef;
          padding: 12px 15px;
          transition: all 0.3s ease;
      }
      
      .form-control:focus, .form-select:focus {
          border-color: #667eea;
          box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }
      
      .btn {
          border-radius: 10px;
          font-weight: 600;
          transition: all 0.3s ease;
      }
      
      .btn-primary {
          background: var(--primary-gradient);
          border: none;
      }
      
      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }
      
      .loading-spinner {
          width: 40px;
          height: 40px;
          border: 4px solid #e2e8f0;
          border-top: 4px solid #667eea;
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }
      
      .notification {
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          border-radius: 12px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 9999;
          transform: translateX(450px);
          transition: all 0.3s ease;
          max-width: 360px;
      }
      
      .notification.show {
          transform: translateX(0);
      }
      
      .notification.success {
          background: #c6f6d5;
          color: #22543d;
          border-left: 4px solid #48bb78;
      }
      
      .notification.error {
          background: #fed7d7;
          color: #742a2a;
          border-left: 4px solid #f56565;
      }
      
      .notification.warning {
          background: #feebc8;
          color: #7b341e;
          border-left: 4px solid #ed8936;
      }
      
      .admin-only {
          display: none;
      }
      
      .admin-only.show {
          display: block;
      }
      
      .loading-screen {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: var(--primary-gradient);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          color: white;
      }
      
      .loading-content {
          text-align: center;
      }
      
      .loading-content .spinner-border {
          width: 3rem;
          height: 3rem;
          margin-bottom: 1rem;
      }
      
      .liff-status {
          background: rgba(255, 255, 255, 0.1);
          border-radius: 10px;
          padding: 10px;
          margin-bottom: 15px;
          font-size: 0.9rem;
      }
      
      .status-indicator {
          display: inline-block;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          margin-right: 8px;
      }
      
      .status-online {
          background-color: #28a745;
      }
      
      .status-offline {
          background-color: #dc3545;
      }
      
      @media (max-width: 768px) {
          .main-header, .nav-container, .content-card {
              margin: 12px;
              padding: 16px;
          }
          
          .quick-actions {
              grid-template-columns: repeat(2, 1fr);
          }
          
          .user-info-bar {
              flex-direction: column;
              gap: 10px;
          }
      }
  </style>
</head>
<body>
  <!-- 載入畫面 -->
  <div id="loadingScreen" class="loading-screen">
      <div class="loading-content">
          <div class="spinner-border" role="status"></div>
          <h4>載入中...</h4>
          <p id="loadingStatus">正在初始化系統...</p>
          <div class="liff-status">
              <span id="liffStatusIndicator" class="status-indicator status-offline"></span>
              <span id="liffStatusText">LIFF 狀態：初始化中</span>
          </div>
      </div>
  </div>

  <div class="main-header">
      <h1><i class="bi bi-hospital"></i> 帕金森病友會管理系統</h1>
      <p class="text-muted small mb-2">整合式會員 / 活動 / 財務 / 回饋平台</p>
      <div id="userInfoBar" class="user-info-bar" style="display:none;">
          <img id="userAvatar" src="" alt="用戶頭像" class="user-avatar" style="display:none;">
          <div id="userAvatarText" class="user-avatar">?</div>
          <div>
              <div class="fw-bold" id="userName">載入中...</div>
              <small class="text-muted" id="userRole">會員</small>
          </div>
          <div class="ms-auto d-flex gap-2">
              <button class="btn btn-sm btn-outline-secondary" onclick="refreshData()" title="重新整理">
                  <i class="bi bi-arrow-clockwise"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="logoutLiff()" title="登出">
                  <i class="bi bi-box-arrow-right"></i>
              </button>
          </div>
      </div>
  </div>

  <div id="notificationContainer"></div>

  <div class="nav-container">
      <ul class="nav nav-pills justify-content-center" id="mainTabs">
          <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#dashboard">
                  <i class="bi bi-speedometer2"></i> 儀表板
              </button>
          </li>
          <li class="nav-item">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#profile">
                  <i class="bi bi-person"></i> 個人資料
              </button>
          </li>
          <li class="nav-item">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#activities">
                  <i class="bi bi-calendar-event"></i> 活動管理
              </button>
          </li>
          <li class="nav-item">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#volunteer">
                  <i class="bi bi-heart"></i> 志工服務
              </button>
          </li>
          <li class="nav-item">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#finance">
                  <i class="bi bi-cash-coin"></i> 財務管理
              </button>
          </li>
          <li class="nav-item">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#feedback">
                  <i class="bi bi-chat-dots"></i> 活動回饋
              </button>
          </li>
          <li class="nav-item admin-only">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#admin">
                  <i class="bi bi-gear"></i> 系統管理
              </button>
          </li>
      </ul>
  </div>

  <div class="tab-content">
      <!-- 儀表板 -->
      <div class="tab-pane fade show active" id="dashboard">
          <div class="content-card">
              <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>系統儀表板</h5>
                  <button class="btn btn-outline-primary btn-sm" onclick="loadDashboard()">
                      <i class="bi bi-arrow-clockwise me-1"></i>刷新
                  </button>
              </div>
              
              <div class="quick-actions">
                  <div class="quick-btn" onclick="showTab('profile')">
                      <i class="bi bi-person-check"></i>
                      <div>更新資料</div>
                  </div>
                  <div class="quick-btn" onclick="showTab('activities')">
                      <i class="bi bi-calendar-plus"></i>
                      <div>報名活動</div>
                  </div>
                  <div class="quick-btn" onclick="showNewDonationModal()">
                      <i class="bi bi-heart-fill"></i>
                      <div>愛心捐款</div>
                  </div>
                  <div class="quick-btn" onclick="showTab('volunteer')">
                      <i class="bi bi-hand-thumbs-up"></i>
                      <div>志工服務</div>
                  </div>
              </div>
              
              <div class="row" id="dashboardStats">
                  <div class="col-12 text-center py-4">
                      <div class="loading-spinner mx-auto mb-2"></div>
                      <div class="text-muted">載入統計資料中...</div>
                  </div>
              </div>
              
              <div class="mt-4">
                  <h6><i class="bi bi-clock-history me-2"></i>最近活動</h6>
                  <div id="recentActivity">
                      <div class="text-center py-4">
                          <div class="loading-spinner mx-auto mb-2"></div>
                          <div class="text-muted">載入最近活動...</div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- 個人資料 -->
      <div class="tab-pane fade" id="profile">
          <div class="content-card">
              <h5><i class="bi bi-person me-2"></i>個人資料管理</h5>
              
              <!-- 註冊區段 -->
              <div id="registrationSection" style="display:none;">
                  <div class="alert alert-info mt-3">
                      <i class="bi bi-info-circle me-2"></i>請完成會員註冊以使用完整功能
                  </div>
                  <form id="registrationForm" class="row g-3 mt-1">
                      <div class="col-md-6">
                          <div class="form-floating">
                              <input type="text" class="form-control" id="realName" name="realName" required>
                              <label for="realName">真實姓名 *</label>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-floating">
                              <select class="form-select" id="memberType" name="memberType" required>
                                  <option value="">請選擇會員類別</option>
                                  <option value="病友">病友</option>
                                  <option value="家屬">家屬</option>
                                  <option value="志工">志工</option>
                                  <option value="醫護">醫護人員</option>
                                  <option value="支持者">支持者</option>
                              </select>
                              <label for="memberType">會員類別 *</label>
                          </div>
                      </div>
                      <div class="col-12">
                          <button type="submit" class="btn btn-primary">
                              <i class="bi bi-check-circle me-1"></i>完成註冊
                          </button>
                      </div>
                  </form>
              </div>

              <!-- 個人資料區段 -->
              <div id="profileSection" style="display:none;">
                  <!-- 顯示模式 -->
                  <div id="displayMode">
                      <div id="userInfoDisplay" class="mt-3">
                          <!-- 用戶資料將在這裡動態載入 -->
                      </div>
                      <div class="text-center mt-4">
                          <button type="button" class="btn btn-primary" onclick="showEditForm()">
                              <i class="bi bi-pencil-square me-2"></i>編輯資料
                          </button>
                      </div>
                  </div>

                  <!-- 編輯模式 -->
                  <div id="editMode" style="display: none;">
                      <form id="profileForm" class="row g-3 mt-2">
                          <div class="col-md-6">
                              <div class="form-floating">
                                  <input type="text" class="form-control" id="profileRealName" readonly>
                                  <label for="profileRealName">真實姓名</label>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="form-floating">
                                  <input type="text" class="form-control" id="lineName" readonly>
                                  <label for="lineName">LINE 名稱</label>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="form-floating">
                                  <input type="tel" class="form-control" id="phone" name="phone">
                                  <label for="phone">聯絡電話</label>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="form-floating">
                                  <input type="email" class="form-control" id="email" name="email">
                                  <label for="email">電子郵件</label>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="form-floating">
                                  <input type="date" class="form-control" id="birthday" name="birthday">
                                  <label for="birthday">生日</label>
                              </div>
                          </div>
                          <div class="col-md-6">
                              <div class="form-floating">
                                  <select class="form-select" id="profileMemberType" name="memberType">
                                      <option value="病友">病友</option>
                                      <option value="家屬">家屬</option>
                                      <option value="志工">志工</option>
                                      <option value="醫護">醫護人員</option>
                                      <option value="支持者">支持者</option>
                                  </select>
                                  <label for="profileMemberType">會員類別</label>
                              </div>
                          </div>
                          <div class="col-12">
                              <div class="form-floating">
                                  <textarea class="form-control" style="height:100px" id="address" name="address"></textarea>
                                  <label for="address">通訊地址</label>
                              </div>
                          </div>
                          <div class="col-12">
                              <button type="submit" class="btn btn-primary me-2">
                                  <i class="bi bi-save me-1"></i>更新資料
                              </button>
                              <button type="button" class="btn btn-secondary" onclick="hideEditForm()">
                                  <i class="bi bi-x-lg me-1"></i>取消
                              </button>
                          </div>
                      </form>
                  </div>
                  
                  <div class="mt-4">
                      <h6><i class="bi bi-bar-chart me-2"></i>個人統計</h6>
                      <div class="row g-3" id="profileStats">
                          <div class="col-12 text-muted small">載入統計資料中...</div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- 活動管理 -->
      <div class="tab-pane fade" id="activities">
          <div class="content-card">
              <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5><i class="bi bi-calendar-event me-2"></i>活動列表</h5>
                  <div class="admin-only">
                      <button class="btn btn-success btn-sm" onclick="showNewActivityModal()">
                          <i class="bi bi-plus-circle me-1"></i>新增活動
                      </button>
                  </div>
              </div>
              
              <div class="row g-3 mb-3">
                  <div class="col-md-3">
                      <div class="form-floating">
                          <select class="form-select" id="activityStatusFilter">
                              <option value="">全部狀態</option>
                              <option value="開放報名">開放報名</option>
                              <option value="報名截止">報名截止</option>
                              <option value="進行中">進行中</option>
                              <option value="已結束">已結束</option>
                          </select>
                          <label for="activityStatusFilter">狀態</label>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="form-floating">
                          <input type="date" id="activityDateFilter" class="form-control">
                          <label for="activityDateFilter">日期</label>
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="form-floating">
                          <input type="text" id="activitySearchFilter" class="form-control" placeholder="搜尋">
                          <label for="activitySearchFilter">關鍵字</label>
                      </div>
                  </div>
                  <div class="col-md-2 d-grid">
                      <button class="btn btn-outline-primary" onclick="filterActivities()">
                          <i class="bi bi-search"></i> 搜尋
                      </button>
                  </div>
              </div>
              
              <div id="activitiesList">
                  <div class="text-center py-4">
                      <div class="loading-spinner mx-auto mb-2"></div>
                      <div class="text-muted">載入活動中...</div>
                  </div>
              </div>
              
              <div class="mt-4">
                  <h6><i class="bi bi-clipboard-check me-2"></i>我的報名</h6>
                  <div id="myRegistrations">
                      <div class="text-center py-4">
                          <div class="loading-spinner mx-auto mb-2"></div>
                          <div class="text-muted">載入報名記錄...</div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- 志工服務 -->
      <div class="tab-pane fade" id="volunteer">
          <div class="content-card">
              <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5><i class="bi bi-heart me-2"></i>志工服務</h5>
                  <div class="admin-only">
                      <button class="btn btn-success btn-sm" onclick="showNewVolunteerNeedModal()">
                          <i class="bi bi-plus-circle me-1"></i>新增需求
                      </button>
                  </div>
              </div>
              
              <div class="row g-3 mb-3">
                  <div class="col-md-3">
                      <div class="stat-card" style="background:var(--info-gradient);">
                          <h3 id="volunteerHours">0</h3>
                          <p class="mb-0"><i class="bi bi-clock me-1"></i>我的時數</p>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="stat-card" style="background:var(--warning-gradient);">
                          <h3 id="volunteerActivities">0</h3>
                          <p class="mb-0"><i class="bi bi-calendar me-1"></i>參與活動</p>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="stat-card" style="background:var(--success-gradient);">
                          <h3 id="volunteerRank">-</h3>
                          <p class="mb-0"><i class="bi bi-trophy me-1"></i>排名</p>
                      </div>
                  </div>
                  <div class="col-md-3">
                      <div class="stat-card" style="background:var(--danger-gradient);">
                          <h3 id="availableNeeds">0</h3>
                          <p class="mb-0"><i class="bi bi-hand-thumbs-up me-1"></i>可報名</p>
                      </div>
                  </div>
              </div>
              
              <h6><i class="bi bi-exclamation-circle me-2"></i>志工需求</h6>
              <div id="volunteerNeeds">
                  <div class="text-center py-4">
                      <div class="loading-spinner mx-auto mb-2"></div>
                      <div class="text-muted">載入志工需求...</div>
                  </div>
              </div>
              
              <div class="mt-4">
                  <h6><i class="bi bi-journal-text me-2"></i>我的志工記錄</h6>
                  <div id="myVolunteerRecords">
                      <div class="text-center py-4">
                          <div class="loading-spinner mx-auto mb-2"></div>
                          <div class="text-muted">載入志工記錄...</div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- 財務管理 -->
      <div class="tab-pane fade" id="finance">
          <div class="content-card">
              <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5><i class="bi bi-cash-coin me-2"></i>財務管理</h5>
                  <div>
                        <button class="btn btn-success btn-sm me-2" onclick="showNewDonationModal()">
                            <i class="bi bi-heart-fill me-1"></i>捐款
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="showNewExpenseModal()">
                            <i class="bi bi-receipt me-1"></i>支出申請
                        </button>
                    </div>
                </div>
                
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <div class="stat-card" style="background:var(--success-gradient);">
                            <h3 id="myDonationAmount">0</h3>
                            <p class="mb-0"><i class="bi bi-heart-fill me-1"></i>捐款總額</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background:var(--info-gradient);">
                            <h3 id="myDonationCount">0</h3>
                            <p class="mb-0"><i class="bi bi-list-ol me-1"></i>捐款次數</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background:var(--warning-gradient);">
                            <h3 id="myExpenseAmount">0</h3>
                            <p class="mb-0"><i class="bi bi-receipt me-1"></i>支出申請</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background:var(--danger-gradient);">
                            <h3 id="pendingExpenses">0</h3>
                            <p class="mb-0"><i class="bi bi-hourglass me-1"></i>待審核</p>
                        </div>
                    </div>
                </div>
                
                <h6><i class="bi bi-heart-fill me-2"></i>我的捐款記錄</h6>
                <div id="donationHistory">
                    <div class="text-center py-4">
                        <div class="loading-spinner mx-auto mb-2"></div>
                        <div class="text-muted">載入捐款記錄...</div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6><i class="bi bi-receipt me-2"></i>我的支出申請</h6>
                    <div id="expenseHistory">
                        <div class="text-center py-4">
                            <div class="loading-spinner mx-auto mb-2"></div>
                            <div class="text-muted">載入支出記錄...</div>
                        </div>
                    </div>
                </div>
                
                <div class="admin-only mt-4">
                    <h6><i class="bi bi-graph-up me-2"></i>財務總覽（管理員）</h6>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="stat-card" style="background:var(--success-gradient);">
                                <h3 id="totalIncome">0</h3>
                                <p class="mb-0"><i class="bi bi-arrow-up-circle me-1"></i>總收入</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" style="background:var(--danger-gradient);">
                                <h3 id="totalExpense">0</h3>
                                <p class="mb-0"><i class="bi bi-arrow-down-circle me-1"></i>總支出</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" style="background:var(--info-gradient);">
                                <h3 id="currentBalance">0</h3>
                                <p class="mb-0"><i class="bi bi-wallet2 me-1"></i>目前餘額</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" style="background:var(--warning-gradient);">
                                <h3 id="monthlyDonations">0</h3>
                                <p class="mb-0"><i class="bi bi-calendar-month me-1"></i>本月捐款</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 活動回饋 -->
        <div class="tab-pane fade" id="feedback">
            <div class="content-card">
                <h5><i class="bi bi-chat-dots me-2"></i>活動回饋</h5>
                
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-plus-circle me-2"></i>新增回饋
                    </div>
                    <div class="card-body">
                        <form id="feedbackForm" class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="feedbackActivity" name="activityId" required>
                                        <option value="">請選擇活動</option>
                                    </select>
                                    <label for="feedbackActivity">活動 *</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="feedbackRating" name="rating" required>
                                        <option value="">評分</option>
                                        <option value="5">5 - 非常滿意</option>
                                        <option value="4">4 - 滿意</option>
                                        <option value="3">3 - 普通</option>
                                        <option value="2">2 - 不滿意</option>
                                        <option value="1">1 - 非常不滿意</option>
                                    </select>
                                    <label for="feedbackRating">評分 *</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" style="height:120px" id="feedbackComment" name="comment" required></textarea>
                                    <label for="feedbackComment">意見與建議 *</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <button class="btn btn-primary" type="submit">
                                    <i class="bi bi-send me-1"></i>提交回饋
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <h6><i class="bi bi-chat-left-text me-2"></i>我的回饋</h6>
                <div id="myFeedback">
                    <div class="text-center py-4">
                        <div class="loading-spinner mx-auto mb-2"></div>
                        <div class="text-muted">載入回饋...</div>
                    </div>
                </div>
                
                <div class="admin-only mt-4">
                    <h6><i class="bi bi-chat-square-dots me-2"></i>所有活動回饋（管理員）</h6>
                    <div id="allFeedback">
                        <div class="text-center py-4">
                            <div class="loading-spinner mx-auto mb-2"></div>
                            <div class="text-muted">載入所有回饋...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系統管理 -->
        <div class="tab-pane fade" id="admin">
            <div class="content-card">
                <h5><i class="bi bi-gear me-2"></i>系統管理</h5>
                
                <ul class="nav nav-tabs mb-3" id="adminTabs">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#adminMembers">會員</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#adminActivities">活動</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#adminFinance">財務</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#adminReceipts">收據</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#adminSystem">系統</button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="adminMembers">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">會員列表</h6>
                            <button class="btn btn-outline-primary btn-sm" onclick="exportMembers()">
                                <i class="bi bi-download me-1"></i>匯出
                            </button>
                        </div>
                        <div class="table-responsive" style="max-height:400px;">
                            <table class="table table-hover table-sm align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>姓名</th>
                                        <th>類別</th>
                                        <th>狀態</th>
                                        <th>加入日期</th>
                                        <th>捐款</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="memberList">
                                    <tr>
                                        <td colspan="6" class="text-center py-4 text-muted">載入中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="adminActivities">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">活動管理</h6>
                            <button class="btn btn-success btn-sm" onclick="showNewActivityModal()">
                                <i class="bi bi-plus-circle me-1"></i>新增
                            </button>
                        </div>
                        <div id="adminActivityList" class="mt-2 small"></div>
                    </div>
                    
                    <div class="tab-pane fade" id="adminFinance">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">交易管理</h6>
                            <button class="btn btn-outline-primary btn-sm" onclick="exportFinanceData()">
                                <i class="bi bi-download me-1"></i>匯出
                            </button>
                        </div>
                        <div id="adminTransactionList" class="small"></div>
                    </div>
                    
                    <div class="tab-pane fade" id="adminReceipts">
                        <h6>收據管理</h6>
                        <div id="adminReceiptsList" class="small"></div>
                    </div>
                    
                    <div class="tab-pane fade" id="adminSystem">
                        <h6>系統工具</h6>
                        <button class="btn btn-warning btn-sm me-2" onclick="triggerBackup()">
                            <i class="bi bi-download me-1"></i>立即備份
                        </button>
                        <button class="btn btn-info btn-sm" onclick="showSystemNotificationModal()">
                            <i class="bi bi-megaphone me-1"></i>發送通知
                        </button>
                        <div id="systemInfo" class="mt-3 text-muted small"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalContainer"></div>

    <script>
        /********************
         * 基本設定
         ********************/
        const CONFIG = {
            LIFF_ID: '1656516134-VaGgmaPm', // 請替換為您的實際 LIFF ID
            GAS_URL: 'https://script.google.com/macros/s/AKfycbx7qjgdFs4D-IyMntT01vn4SBoT8MEu4ZClsBx3uiDdHpZiOASk3ltLPtmmZaA6nsVq/exec', // 請替換為您的 GAS URL
            API_KEY: 'AAbb8520258185202581'
        };

        let currentUser = null;
        let userProfile = null;
        let isAdmin = false;
        let allActivitiesCache = [];
        let myRegistrationsCache = [];
        let isLiffAvailable = false;
        let isSubmitting = false;

        /********************
         * 工具函數
         ********************/
        function formatDate(d) {
            if (!d) return '-';
            const dt = new Date(d);
            if (isNaN(dt.getTime())) return '-';
            return dt.toLocaleDateString('zh-TW');
        }

        function formatDateTime(d) {
            if (!d) return '-';
            const dt = new Date(d);
            if (isNaN(dt.getTime())) return '-';
            return dt.toLocaleString('zh-TW');
        }

        function formatCurrency(n) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD',
                minimumFractionDigits: 0
            }).format(Number(n) || 0);
        }

        function showNotification(msg, type = 'success', duration = 3000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div style="white-space:pre-line;">${msg}</div>
                    <button style="background:none;border:none;font-size:18px;line-height:1;" onclick="this.closest('.notification').remove()">×</button>
                </div>
            `;
            container.appendChild(notification);
            requestAnimationFrame(() => notification.classList.add('show'));
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        function setButtonLoading(btn, loading = true) {
            if (!btn) return;
            if (loading) {
                btn.disabled = true;
                btn.classList.add('loading');
            } else {
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        }

        function showTab(id) {
            const btn = document.querySelector(`[data-bs-target="#${id}"]`);
            if (btn) btn.click();
        }

        function updateLoadingStatus(message) {
            const statusElement = document.getElementById('loadingStatus');
            if (statusElement) {
                statusElement.textContent = message;
            }
            console.log('載入狀態:', message);
        }

        function updateLiffStatus(isOnline, message) {
            const indicator = document.getElementById('liffStatusIndicator');
            const text = document.getElementById('liffStatusText');
            
            if (indicator && text) {
                indicator.className = `status-indicator ${isOnline ? 'status-online' : 'status-offline'}`;
                text.textContent = `LIFF 狀態：${message}`;
            }
        }

        /********************
         * API 呼叫
         ********************/
        function makeJSONPRequest(url, callback) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.head.removeChild(script);
                    resolve(data);
                };
                
                script.onerror = function() {
                    delete window[callbackName];
                    document.head.removeChild(script);
                    reject(new Error('JSONP request failed'));
                };
                
                script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
                document.head.appendChild(script);
                
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                        reject(new Error('JSONP request timeout'));
                    }
                }, 15000);
            });
        }

        function makeJSONPPostRequest(url, data) {
            const params = new URLSearchParams();
            Object.keys(data).forEach(key => {
                params.append(key, data[key]);
            });
            
            const fullUrl = url + '?' + params.toString();
            return makeJSONPRequest(fullUrl);
        }

        async function callAPI(action, data = {}, retries = 2) {
            const payload = {
                action,
                apiKey: CONFIG.API_KEY,
                timestamp: Date.now(),
                ...data
            };
            
            for (let i = 0; i <= retries; i++) {
                try {
                    return await makeJSONPPostRequest(CONFIG.GAS_URL, payload);
                } catch (err) {
                    if (i === retries) throw err;
                    await new Promise(r => setTimeout(r, 500 * (i + 1)));
                }
            }
        }

        /********************
         * LIFF 初始化
         ********************/
        function checkLiffAvailability() {
            return new Promise((resolve) => {
                const isInLineApp = /Line/i.test(navigator.userAgent);
                const isLiffLoaded = typeof window.liff !== 'undefined';
                
                console.log('LINE 環境檢查:', isInLineApp);
                console.log('LIFF SDK 載入:', isLiffLoaded);
                
                resolve(isLiffLoaded);
            });
        }

        async function initializeLiff() {
            try {
                updateLoadingStatus('檢查 LIFF 環境...');
                updateLiffStatus(false, '檢查中');
                
                isLiffAvailable = await checkLiffAvailability();
                
                if (!isLiffAvailable) {
                    console.log('LIFF 不可用，使用測試模式');
                    updateLiffStatus(false, '不可用（測試模式）');
                    await initializeTestMode();
                    return;
                }
                
                updateLoadingStatus('初始化 LIFF...');
                console.log('開始初始化 LIFF...');
                
                await liff.init({ liffId: CONFIG.LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    console.log('用戶未登入，導向登入頁面');
                    updateLiffStatus(false, '未登入');
                    liff.login();
                    return;
                }
                
                console.log('LIFF 初始化成功');
                updateLiffStatus(true, '已連線');
                
                userProfile = await liff.getProfile();
                
                console.log('用戶資料:', userProfile);
                
                await loadUserData();
                await loadDashboard();
                showNotification('系統初始化完成', 'success');
                
            } catch (error) {
                console.error('LIFF 初始化失敗:', error);
                updateLiffStatus(false, '初始化失敗');
                await initializeTestMode();
            }
        }

        async function initializeTestMode() {
            updateLoadingStatus('使用測試模式...');
            console.log('使用測試資料');
            
            userProfile = {
                userId: 'test-user-' + Date.now(),
                displayName: '測試用戶',
                pictureUrl: null
            };
            
            await loadUserData();
            await loadDashboard();
        }

        function logoutLiff() {
            if (liff && liff.isLoggedIn()) {
                liff.logout();
            }
            location.reload();
        }

        /********************
         * 使用者資料
         ********************/
        async function loadUserData() {
            try {
                updateLoadingStatus('載入用戶資料...');
                
                const result = await callAPI('getUserInfo', { 
                    lineId: userProfile.userId 
                });
                
                if (result.success && result.data) {
                    currentUser = result.data;
                    isAdmin = !!currentUser.isAdmin;
                    updateUserInterface();
                } else {
                    // 尚未註冊
                    document.getElementById('registrationSection').style.display = 'block';
                    document.getElementById('profileSection').style.display = 'none';
                }
                
            } catch (e) {
                console.warn('getUserInfo 失敗', e);
                document.getElementById('registrationSection').style.display = 'block';
                document.getElementById('profileSection').style.display = 'none';
            }
        }

        function updateUserInterface() {
            if (!currentUser) return;
            
            const userInfoBar = document.getElementById('userInfoBar');
            userInfoBar.style.display = 'inline-flex';
            
            // 設定用戶頭像
            const avatarImg = document.getElementById('userAvatar');
            const avatarText = document.getElementById('userAvatarText');
            
            if (userProfile.pictureUrl) {
                avatarImg.src = userProfile.pictureUrl;
                avatarImg.style.display = 'block';
                avatarText.style.display = 'none';
                avatarImg.onerror = function() {
                    this.style.display = 'none';
                    avatarText.style.display = 'flex';
                    avatarText.textContent = (currentUser.realName || userProfile.displayName || '?').substring(0, 1);
                };
            } else {
                avatarImg.style.display = 'none';
                avatarText.style.display = 'flex';
                avatarText.textContent = (currentUser.realName || userProfile.displayName || '?').substring(0, 1);
            }
            
            document.getElementById('userName').textContent = currentUser.realName || userProfile.displayName || '會員';
            document.getElementById('userRole').textContent = currentUser.memberType || '會員';
            
            // 顯示管理員功能
            document.querySelectorAll('.admin-only').forEach(el => 
                el.classList.toggle('show', isAdmin)
            );

            // 切換註冊/個資區段
            document.getElementById('registrationSection').style.display = 'none';
            document.getElementById('profileSection').style.display = 'block';

            // 填寫個人資料表單
            fillProfileForm();
        }

        function fillProfileForm() {
            if (!currentUser) return;
            
            document.getElementById('profileRealName').value = currentUser.realName || '';
            document.getElementById('lineName').value = userProfile.displayName || '';
            document.getElementById('phone').value = currentUser.phone || '';
            document.getElementById('email').value = currentUser.email || '';
            document.getElementById('birthday').value = currentUser.birthday || '';
            document.getElementById('profileMemberType').value = currentUser.memberType || '支持者';
            document.getElementById('address').value = currentUser.address || '';
        }

        function displayUserInfo() {
            if (!currentUser) return;
            
            const displayElement = document.getElementById('userInfoDisplay');
            const displayFields = [
                { key: 'realName', label: 'LINE 顯示名稱', icon: 'bi-person-badge', value: userProfile.displayName },
                { key: 'realName', label: '真實姓名', icon: 'bi-person' },
                { key: 'phone', label: '電話', icon: 'bi-telephone' },
                { key: 'email', label: '電子郵件', icon: 'bi-envelope' },
                { key: 'address', label: '地址', icon: 'bi-geo-alt' },
                { key: 'birthday', label: '生日', icon: 'bi-calendar' },
                { key: 'memberType', label: '會員類別', icon: 'bi-people' },
                { key: 'joinDate', label: '加入日期', icon: 'bi-calendar-plus' }
            ];

            let html = '';
            displayFields.forEach(field => {
                const value = field.value || currentUser[field.key] || '';
                const displayValue = value || '未填寫';
                const valueClass = value ? '' : 'empty';
                
                html += `
                    <div class="activity-item">
                        <div class="d-flex justify-content-between">
                            <div class="fw-semibold">
                                <i class="${field.icon} me-2"></i>${field.label}
                            </div>
                            <div class="text-end ${valueClass}">${displayValue}</div>
                        </div>
                    </div>
                `;
            });

            displayElement.innerHTML = html;
        }

        function showEditForm() {
            fillProfileForm();
            document.getElementById('displayMode').style.display = 'none';
            document.getElementById('editMode').style.display = 'block';
        }

        function hideEditForm() {
            document.getElementById('editMode').style.display = 'none';
            document.getElementById('displayMode').style.display = 'block';
        }

        /********************
         * 儀表板
         ********************/
        async function loadDashboard() {
            if (!userProfile) return;
            
            try {
                const res = await callAPI('getDashboardData', { 
                    lineId: userProfile.userId 
                });
                
                const d = res.data || {};
                const statsEl = document.getElementById('dashboardStats');
                
                statsEl.innerHTML = `
                    <div class="col-md-3">
                        <div class="stat-card">
                            <h3>${d.totalActivities || 0}</h3>
                            <p class="mb-0"><i class="bi bi-calendar-event me-1"></i>可報名活動</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background:var(--info-gradient);">
                            <h3>${d.myRegistrations || 0}</h3>
                            <p class="mb-0"><i class="bi bi-clipboard-check me-1"></i>我的報名</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background:var(--warning-gradient);">
                            <h3>${d.myVolunteerHours || 0}</h3>
                            <p class="mb-0"><i class="bi bi-clock me-1"></i>志工時數</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background:var(--danger-gradient);">
                            <h3>${formatCurrency(d.myDonationAmount || 0)}</h3>
                            <p class="mb-0"><i class="bi bi-heart-fill me-1"></i>捐款總額</p>
                        </div>
                    </div>
                `;
                
                updateRecentActivity(d.recentActivity || []);
                
            } catch (e) {
                document.getElementById('dashboardStats').innerHTML = 
                    `<div class="col-12 text-danger text-center">載入失敗：${e.message}</div>`;
            }
        }

        function updateRecentActivity(activities) {
            const container = document.getElementById('recentActivity');
            
            if (!activities.length) {
                container.innerHTML = '<p class="text-muted small">暫無最近活動</p>';
                return;
            }
            
            container.innerHTML = activities.map(a => `
                <div class="activity-item">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="fw-semibold">${a.title || ''}</div>
                            <div class="text-muted small mb-1">${a.description || ''}</div>
                            <small class="text-muted">
                                <i class="bi bi-calendar me-1"></i>${formatDate(a.date)}
                            </small>
                        </div>
                        <span class="status-badge status-${(a.status || '').replace(/\s/g, '')}">${a.status || ''}</span>
                    </div>
                </div>
            `).join('');
        }

        /********************
         * 表單處理
         ********************/
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (isSubmitting) return;
            
            const btn = this.querySelector('button[type="submit"]');
            setButtonLoading(btn, true);
            isSubmitting = true;
            
            try {
                const formData = new FormData(this);
                const data = {
                    lineId: userProfile.userId,
                    lineName: userProfile.displayName,
                    pictureUrl: userProfile.pictureUrl,
                    realName: formData.get('realName'),
                    memberType: formData.get('memberType')
                };
                
                const result = await callAPI('registerUser', data);
                
                if (result.success) {
                    showNotification('註冊成功！歡迎加入帕金森病友會', 'success');
                    await loadUserData();
                } else {
                    showNotification(result.message || '註冊失敗', 'error');
                }
            } catch (e) {
                showNotification('註冊失敗：' + e.message, 'error');
            } finally {
                setButtonLoading(btn, false);
                isSubmitting = false;
            }
        });

        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (isSubmitting) return;
            
            const btn = this.querySelector('button[type="submit"]');
            setButtonLoading(btn, true);
            isSubmitting = true;
            
            try {
                const formData = new FormData(this);
                const data = {
                    lineId: userProfile.userId,
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    birthday: formData.get('birthday'),
                    memberType: formData.get('memberType'),
                    address: formData.get('address')
                };
                
                const result = await callAPI('updateProfile', data);
                
                if (result.success) {
                    showNotification('資料更新成功', 'success');
                    await loadUserData();
                    hideEditForm();
                    displayUserInfo();
                } else {
                    showNotification(result.message || '更新失敗', 'error');
                }
            } catch (e) {
                showNotification('更新失敗：' + e.message, 'error');
            } finally {
                setButtonLoading(btn, false);
                isSubmitting = false;
            }
        });

        document.getElementById('feedbackForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (isSubmitting) return;
            
            const btn = this.querySelector('button[type="submit"]');
            setButtonLoading(btn, true);
            isSubmitting = true;
            
            try {
                const formData = new FormData(this);
                const data = {
                    lineId: userProfile.userId,
                    activityId: formData.get('activityId'),
                    rating: formData.get('rating'),
                    comment: formData.get('comment')
                };
                
                const result = await callAPI('submitFeedback', data);
                
                if (result.success) {
                    showNotification('回饋提交成功，感謝您的意見！', 'success');
                    this.reset();
                    loadMyFeedback();
                } else {
                    showNotification(result.message || '提交失敗', 'error');
                }
            } catch (e) {
                showNotification('提交失敗：' + e.message, 'error');
            } finally {
                setButtonLoading(btn, false);
                isSubmitting = false;
            }
        });

        /********************
         * 活動管理
         ********************/
        async function loadActivities() {
            try {
                const result = await callAPI('getActivities');
                allActivitiesCache = result.data || [];
                displayActivities(allActivitiesCache);
                
                // 載入我的報名
                if (currentUser) {
                    const myRegResult = await callAPI('getMyRegistrations', { 
                        lineId: userProfile.userId 
                    });
                    myRegistrationsCache = myRegResult.data || [];
                    displayMyRegistrations(myRegistrationsCache);
                }
                
                // 更新回饋表單的活動選項
                updateFeedbackActivityOptions();
                
            } catch (e) {
                document.getElementById('activitiesList').innerHTML = 
                    `<div class="text-danger text-center">載入失敗：${e.message}</div>`;
            }
        }

        function displayActivities(activities) {
            const container = document.getElementById('activitiesList');
            
            if (!activities.length) {
                container.innerHTML = '<p class="text-muted text-center">目前沒有活動</p>';
                return;
            }
            
            container.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-1">${activity.title || ''}</h6>
                                <span class="status-badge status-${(activity.status || '').replace(/\s/g, '')}">${activity.status || ''}</span>
                            </div>
                            <p class="text-muted small mb-2">${activity.description || ''}</p>
                            <div class="row g-2 text-muted small">
                                <div class="col-md-6">
                                    <i class="bi bi-calendar me-1"></i>${formatDate(activity.date)}
                                </div>
                                <div class="col-md-6">
                                    <i class="bi bi-clock me-1"></i>${activity.time || ''}
                                </div>
                                <div class="col-md-6">
                                    <i class="bi bi-geo-alt me-1"></i>${activity.location || ''}
                                </div>
                                <div class="col-md-6">
                                    <i class="bi bi-people me-1"></i>${activity.currentCount || 0}/${activity.maxParticipants || '不限'}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 d-flex gap-2">
                        ${activity.status === '開放報名' ? `
                            <button class="btn btn-primary btn-sm" onclick="registerActivity('${activity.id}')">
                                <i class="bi bi-clipboard-plus me-1"></i>報名
                            </button>
                        ` : ''}
                        <button class="btn btn-outline-info btn-sm" onclick="showActivityDetail('${activity.id}')">
                            <i class="bi bi-info-circle me-1"></i>詳情
                        </button>
                        ${isAdmin ? `
                            <button class="btn btn-outline-warning btn-sm" onclick="editActivity('${activity.id}')">
                                <i class="bi bi-pencil me-1"></i>編輯
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function displayMyRegistrations(registrations) {
            const container = document.getElementById('myRegistrations');
            
            if (!registrations.length) {
                container.innerHTML = '<p class="text-muted text-center">尚無報名記錄</p>';
                return;
            }
            
            container.innerHTML = registrations.map(reg => `
                <div class="activity-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${reg.activityTitle || ''}</h6>
                            <div class="text-muted small">
                                <div><i class="bi bi-calendar me-1"></i>活動日期：${formatDate(reg.activityDate)}</div>
                                <div><i class="bi bi-clock-history me-1"></i>報名時間：${formatDateTime(reg.registrationDate)}</div>
                            </div>
                        </div>
                        <span class="status-badge status-${(reg.status || '').replace(/\s/g, '')}">${reg.status || ''}</span>
                    </div>
                    ${reg.status === '已報名' ? `
                        <div class="mt-2">
                            <button class="btn btn-outline-danger btn-sm" onclick="cancelRegistration('${reg.id}')">
                                <i class="bi bi-x-circle me-1"></i>取消報名
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        async function registerActivity(activityId) {
            if (!currentUser) {
                showNotification('請先完成會員註冊', 'warning');
                return;
            }
            
            try {
                const result = await callAPI('registerActivity', {
                    lineId: userProfile.userId,
                    activityId: activityId
                });
                
                if (result.success) {
                    showNotification('報名成功！', 'success');
                    loadActivities();
                } else {
                    showNotification(result.message || '報名失敗', 'error');
                }
            } catch (e) {
                showNotification('報名失敗：' + e.message, 'error');
            }
        }

        async function cancelRegistration(registrationId) {
            if (!confirm('確定要取消報名嗎？')) return;
            
            try {
                const result = await callAPI('cancelRegistration', {
                    lineId: userProfile.userId,
                    registrationId: registrationId
                });
                
                if (result.success) {
                    showNotification('取消報名成功', 'success');
                    loadActivities();
                } else {
                    showNotification(result.message || '取消失敗', 'error');
                }
            } catch (e) {
                showNotification('取消失敗：' + e.message, 'error');
            }
        }

        function filterActivities() {
            const status = document.getElementById('activityStatusFilter').value;
            const date = document.getElementById('activityDateFilter').value;
            const search = document.getElementById('activitySearchFilter').value.toLowerCase();
            
            let filtered = allActivitiesCache;
            
            if (status) {
                filtered = filtered.filter(a => a.status === status);
            }
            
            if (date) {
                filtered = filtered.filter(a => a.date === date);
            }
            
            if (search) {
                filtered = filtered.filter(a => 
                    (a.title || '').toLowerCase().includes(search) ||
                    (a.description || '').toLowerCase().includes(search) ||
                    (a.location || '').toLowerCase().includes(search)
                );
            }
            
            displayActivities(filtered);
        }

        /********************
         * 志工服務
         ********************/
        async function loadVolunteerData() {
            try {
                const result = await callAPI('getVolunteerData', { 
                    lineId: userProfile.userId 
                });
                
                const data = result.data || {};
                
                document.getElementById('volunteerHours').textContent = data.totalHours || 0;
                document.getElementById('volunteerActivities').textContent = data.totalActivities || 0;
                document.getElementById('volunteerRank').textContent = data.rank || '-';
                document.getElementById('availableNeeds').textContent = data.availableNeeds || 0;
                
                displayVolunteerNeeds(data.needs || []);
                displayVolunteerRecords(data.records || []);
                
            } catch (e) {
                console.error('載入志工資料失敗:', e);
            }
        }

        function displayVolunteerNeeds(needs) {
            const container = document.getElementById('volunteerNeeds');
            
            if (!needs.length) {
                container.innerHTML = '<p class="text-muted text-center">目前沒有志工需求</p>';
                return;
            }
            
            container.innerHTML = needs.map(need => `
                <div class="activity-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${need.title || ''}</h6>
                            <p class="text-muted small mb-2">${need.description || ''}</p>
                            <div class="row g-2 text-muted small">
                                <div class="col-md-6">
                                    <i class="bi bi-calendar me-1"></i>${formatDate(need.date)}
                                </div>
                                <div class="col-md-6">
                                    <i class="bi bi-clock me-1"></i>${need.hours || 0} 小時
                                </div>
                                <div class="col-md-6">
                                    <i class="bi bi-people me-1"></i>需要 ${need.requiredCount || 1} 人
                                </div>
                                <div class="col-md-6">
                                    <i class="bi bi-check-circle me-1"></i>已報名 ${need.currentCount || 0} 人
                                </div>
                            </div>
                        </div>
                        <span class="status-badge status-${(need.status || '').replace(/\s/g, '')}">${need.status || ''}</span>
                    </div>
                    ${need.status === 'open' ? `
                        <div class="mt-3">
                            <button class="btn btn-primary btn-sm" onclick="applyVolunteer('${need.id}')">
                                <i class="bi bi-hand-thumbs-up me-1"></i>我要報名
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function displayVolunteerRecords(records) {
            const container = document.getElementById('myVolunteerRecords');
            
            if (!records.length) {
                container.innerHTML = '<p class="text-muted text-center">尚無志工記錄</p>';
                return;
            }
            
            container.innerHTML = records.map(record => `
                <div class="activity-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${record.title || ''}</h6>
                            <div class="text-muted small">
                                <div><i class="bi bi-calendar me-1"></i>${formatDate(record.date)}</div>
                                <div><i class="bi bi-clock me-1"></i>${record.hours || 0} 小時</div>
                            </div>
                        </div>
                        <span class="status-badge status-${(record.status || '').replace(/\s/g, '')}">${record.status || ''}</span>
                    </div>
                </div>
            `).join('');
        }

        async function applyVolunteer(needId) {
            if (!currentUser) {
                showNotification('請先完成會員註冊', 'warning');
                return;
            }
            
            try {
                const result = await callAPI('applyVolunteer', {
                    lineId: userProfile.userId,
                    needId: needId
                });
                
                if (result.success) {
                    showNotification('志工報名成功！', 'success');
                    loadVolunteerData();
                } else {
                    showNotification(result.message || '報名失敗', 'error');
                }
            } catch (e) {
                showNotification('報名失敗：' + e.message, 'error');
            }
        }

        /********************
         * 財務管理
         ********************/
        async function loadFinanceData() {
            try {
                const result = await callAPI('getFinanceData', { 
                    lineId: userProfile.userId 
                });
                
                const data = result.data || {};
                
                document.getElementById('myDonationAmount').textContent = formatCurrency(data.totalDonation || 0);
                document.getElementById('myDonationCount').textContent = data.donationCount || 0;
                document.getElementById('myExpenseAmount').textContent = formatCurrency(data.totalExpense || 0);
                document.getElementById('pendingExpenses').textContent = data.pendingExpenses || 0;
                
                displayDonationHistory(data.donations || []);
                displayExpenseHistory(data.expenses || []);
                
                if (isAdmin) {
                    document.getElementById('totalIncome').textContent = formatCurrency(data.adminData?.totalIncome || 0);
                    document.getElementById('totalExpense').textContent = formatCurrency(data.adminData?.totalExpense || 0);
                    document.getElementById('currentBalance').textContent = formatCurrency(data.adminData?.currentBalance || 0);
                    document.getElementById('monthlyDonations').textContent = formatCurrency(data.adminData?.monthlyDonations || 0);
                }
                
            } catch (e) {
                console.error('載入財務資料失敗:', e);
            }
        }

        function displayDonationHistory(donations) {
            const container = document.getElementById('donationHistory');
            
            if (!donations.length) {
                container.innerHTML = '<p class="text-muted text-center">尚無捐款記錄</p>';
                return;
            }
            
            container.innerHTML = donations.map(donation => `
                <div class="transaction-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-semibold">${formatCurrency(donation.amount)}</div>
                            <div class="text-muted small">
                                <i class="bi bi-calendar me-1"></i>${formatDateTime(donation.date)}
                            </div>
                            ${donation.note ? `<div class="text-muted small">${donation.note}</div>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="status-badge status-已完成">已完成</span>
                            ${donation.receiptUrl ? `
                                <div class="mt-1">
                                    <a href="${donation.receiptUrl}" target="_blank" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-receipt me-1"></i>收據
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayExpenseHistory(expenses) {
            const container = document.getElementById('expenseHistory');
            
            if (!expenses.length) {
                container.innerHTML = '<p class="text-muted text-center">尚無支出申請</p>';
                return;
            }
            
            container.innerHTML = expenses.map(expense => `
                <div class="transaction-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="fw-semibold">${expense.title || ''}</div>
                            <div class="text-success fw-bold">${formatCurrency(expense.amount)}</div>
                            <div class="text-muted small">
                                <i class="bi bi-calendar me-1"></i>${formatDateTime(expense.date)}
                            </div>
                            ${expense.note ? `<div class="text-muted small">${expense.note}</div>` : ''}
                        </div>
                        <span class="status-badge status-${(expense.status || '').replace(/\s/g, '')}">${expense.status || ''}</span>
                    </div>
                </div>
            `).join('');
        }

        function showNewDonationModal() {
            if (!currentUser) {
                showNotification('請先完成會員註冊', 'warning');
                return;
            }
            
            const modal = `
                <div class="modal fade" id="donationModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="bi bi-heart-fill me-2"></i>愛心捐款</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form id="donationForm">
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">捐款金額 *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">NT$</span>
                                            <input type="number" class="form-control" name="amount" min="1" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">備註</label>
                                        <textarea class="form-control" name="note" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="needReceipt" id="needReceipt">
                                            <label class="form-check-label" for="needReceipt">
                                                需要捐款收據
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="submit" class="btn btn-primary">確認捐款</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modal;
            const modalEl = new bootstrap.Modal(document.getElementById('donationModal'));
            modalEl.show();
            
            document.getElementById('donationForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                if (isSubmitting) return;
                
                const btn = this.querySelector('button[type="submit"]');
                setButtonLoading(btn, true);
                isSubmitting = true;
                
                try {
                    const formData = new FormData(this);
                    const data = {
                        lineId: userProfile.userId,
                        amount: formData.get('amount'),
                        note: formData.get('note'),
                        needReceipt: formData.has('needReceipt')
                    };
                    
                    const result = await callAPI('submitDonation', data);
                    
                    if (result.success) {
                        showNotification('捐款記錄已建立，謝謝您的愛心！', 'success');
                        modalEl.hide();
                        loadFinanceData();
                    } else {
                        showNotification(result.message || '提交失敗', 'error');
                    }
                } catch (e) {
                    showNotification('提交失敗：' + e.message, 'error');
                } finally {
                    setButtonLoading(btn, false);
                    isSubmitting = false;
                }
            });
        }

        /********************
         * 回饋管理
         ********************/
        function updateFeedbackActivityOptions() {
            const select = document.getElementById('feedbackActivity');
            select.innerHTML = '<option value="">請選擇活動</option>';
            
            // 只顯示已參加的活動
            myRegistrationsCache.forEach(reg => {
                if (reg.status === '已參加' || reg.status === '已結束') {
                    select.innerHTML += `<option value="${reg.activityId}">${reg.activityTitle}</option>`;
                }
            });
        }

        async function loadMyFeedback() {
            try {
                const result = await callAPI('getMyFeedback', { 
                    lineId: userProfile.userId 
                });
                
                displayMyFeedback(result.data || []);
                
            } catch (e) {
                document.getElementById('myFeedback').innerHTML = 
                    `<div class="text-danger">載入失敗：${e.message}</div>`;
            }
        }

        function displayMyFeedback(feedback) {
            const container = document.getElementById('myFeedback');
            
            if (!feedback.length) {
                container.innerHTML = '<p class="text-muted text-center">尚無回饋記錄</p>';
                return;
            }
            
            container.innerHTML = feedback.map(f => `
                <div class="activity-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${f.activityTitle || ''}</h6>
                            <div class="mb-2">
                                ${'★'.repeat(f.rating || 0)}${'☆'.repeat(5 - (f.rating || 0))} 
                                <span class="text-muted small">(${f.rating}/5)</span>
                            </div>
                            <p class="text-muted small mb-1">${f.comment || ''}</p>
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>${formatDateTime(f.submitDate)}
                            </small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        /********************
         * 管理員功能
         ********************/
        async function loadAdminData() {
            if (!isAdmin) return;
            
            try {
                const result = await callAPI('getAdminData');
                const data = result.data || {};
                
                displayMemberList(data.members || []);
                displayAdminActivityList(data.activities || []);
                displayAdminTransactionList(data.transactions || []);
                
            } catch (e) {
                console.error('載入管理員資料失敗:', e);
            }
        }

        function displayMemberList(members) {
            const tbody = document.getElementById('memberList');
            
            if (!members.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">暫無會員資料</td></tr>';
                return;
            }
            
            tbody.innerHTML = members.map(member => `
                <tr>
                    <td>${member.realName || member.lineName || ''}</td>
                    <td><span class="badge bg-secondary">${member.memberType || ''}</span></td>
                    <td><span class="status-badge status-${member.status || ''}">${member.status || ''}</span></td>
                    <td>${formatDate(member.joinDate)}</td>
                    <td>${formatCurrency(member.totalDonation || 0)}</td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm" onclick="viewMemberDetail('${member.lineId}')">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function displayAdminActivityList(activities) {
            const container = document.getElementById('adminActivityList');
            
            if (!activities.length) {
                container.innerHTML = '<p class="text-muted">暫無活動</p>';
                return;
            }
            
            container.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${activity.title || ''}</h6>
                            <div class="text-muted small">
                                <div><i class="bi bi-calendar me-1"></i>${formatDate(activity.date)}</div>
                                <div><i class="bi bi-people me-1"></i>${activity.currentCount || 0}/${activity.maxParticipants || '不限'}</div>
                            </div>
                        </div>
                        <span class="status-badge status-${(activity.status || '').replace(/\s/g, '')}">${activity.status || ''}</span>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-outline-warning btn-sm me-1" onclick="editActivity('${activity.id}')">
                            <i class="bi bi-pencil"></i> 編輯
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="viewActivityParticipants('${activity.id}')">
                            <i class="bi bi-people"></i> 參加者
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayAdminTransactionList(transactions) {
            const container = document.getElementById('adminTransactionList');
            
            if (!transactions.length) {
                container.innerHTML = '<p class="text-muted">暫無交易記錄</p>';
                return;
            }
            
            container.innerHTML = transactions.map(t => `
                <div class="transaction-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-semibold">${t.type === 'donation' ? '捐款' : '支出'}: ${t.title || ''}</div>
                            <div class="text-muted small">${t.memberName || ''}</div>
                            <div class="text-muted small">${formatDateTime(t.date)}</div>
                        </div>
                        <div class="text-end">
                            <div class="${t.type === 'donation' ? 'text-success' : 'text-danger'} fw-bold">
                                ${t.type === 'donation' ? '+' : '-'}${formatCurrency(t.amount)}
                            </div>
                            <span class="status-badge status-${(t.status || '').replace(/\s/g, '')}">${t.status || ''}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function exportMembers() {
            if (!isAdmin) return;
            
            callAPI('exportMembers').then(result => {
                if (result.success && result.data) {
                    const blob = new Blob([result.data], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `會員資料_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    showNotification('會員資料匯出成功', 'success');
                }
            }).catch(e => {
                showNotification('匯出失敗：' + e.message, 'error');
            });
        }

        function exportFinanceData() {
            if (!isAdmin) return;
            
            callAPI('exportFinanceData').then(result => {
                if (result.success && result.data) {
                    const blob = new Blob([result.data], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `財務資料_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    showNotification('財務資料匯出成功', 'success');
                }
            }).catch(e => {
                showNotification('匯出失敗：' + e.message, 'error');
            });
        }

        /********************
         * 頁籤切換事件
         ********************/
        document.addEventListener('shown.bs.tab', function(e) {
            const targetId = e.target.getAttribute('data-bs-target');
            
            switch(targetId) {
                case '#activities':
                    loadActivities();
                    break;
                case '#volunteer':
                    loadVolunteerData();
                    break;
                case '#finance':
                    loadFinanceData();
                    break;
                case '#feedback':
                    loadMyFeedback();
                    break;
                case '#admin':
                    if (isAdmin) loadAdminData();
                    break;
            }
        });

        /********************
         * 初始化
         ********************/
        document.addEventListener('DOMContentLoaded', function() {
            // 檢查 LIFF SDK 是否載入
            if (typeof liff === 'undefined') {
                console.log('LIFF SDK 未載入，載入中...');
                const script = document.createElement('script');
                script.src = 'https://static.line-scdn.net/liff/edge/2/sdk.js';
                script.onload = initializeLiff;
                script.onerror = () => {
                    console.error('LIFF SDK 載入失敗');
                    initializeTestMode();
                };
                document.head.appendChild(script);
            } else {
                initializeLiff();
            }

            // 設定篩選器事件
            ['activityStatusFilter', 'activityDateFilter', 'activitySearchFilter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', filterActivities);
                    element.addEventListener('input', filterActivities);
                }
            });

            // 設定個人資料切換
            const editBtn = document.querySelector('[onclick="showEditForm()"]');
            const cancelBtn = document.querySelector('[onclick="hideEditForm()"]');
            
            if (editBtn) editBtn.addEventListener('click', showEditForm);
            if (cancelBtn) cancelBtn.addEventListener('click', hideEditForm);

            // 初始顯示個人資料
            setTimeout(() => {
                if (currentUser) {
                    displayUserInfo();
                }
            }, 1000);
        });

        // 全域函數
        window.showTab = showTab;
        window.showEditForm = showEditForm;
        window.hideEditForm = hideEditForm;
        window.registerActivity = registerActivity;
        window.cancelRegistration = cancelRegistration;
        window.filterActivities = filterActivities;
        window.applyVolunteer = applyVolunteer;
        window.showNewDonationModal = showNewDonationModal;
        window.showNewExpenseModal = showNewExpenseModal;
        window.exportMembers = exportMembers;
        window.exportFinanceData = exportFinanceData;
        window.logoutLiff = logoutLiff;

        // 支出申請模態框
        function showNewExpenseModal() {
            if (!currentUser) {
                showNotification('請先完成會員註冊', 'warning');
                return;
            }
            
            const modal = `
                <div class="modal fade" id="expenseModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>支出申請</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form id="expenseForm">
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">支出項目 *</label>
                                        <input type="text" class="form-control" name="title" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">金額 *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">NT$</span>
                                            <input type="number" class="form-control" name="amount" min="1" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">說明</label>
                                        <textarea class="form-control" name="note" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">收據/發票</label>
                                        <input type="file" class="form-control" name="receipt" accept="image/*,.pdf">
                                        <div class="form-text">請上傳收據或發票圖片</div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="submit" class="btn btn-warning">提交申請</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modal;
            const modalEl = new bootstrap.Modal(document.getElementById('expenseModal'));
            modalEl.show();
            
            document.getElementById('expenseForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                if (isSubmitting) return;
                
                const btn = this.querySelector('button[type="submit"]');
                setButtonLoading(btn, true);
                isSubmitting = true;
                
                try {
                    const formData = new FormData(this);
                    const data = {
                        lineId: userProfile.userId,
                        title: formData.get('title'),
                        amount: formData.get('amount'),
                        note: formData.get('note')
                    };
                    
                    // 處理檔案上傳（簡化版）
                    const receipt = formData.get('receipt');
                    if (receipt && receipt.size > 0) {
                        data.hasReceipt = true;
                        data.receiptName = receipt.name;
                    }
                    
                    const result = await callAPI('submitExpense', data);
                    
                    if (result.success) {
                        showNotification('支出申請已提交，等待審核', 'success');
                        modalEl.hide();
                        loadFinanceData();
                    } else {
                        showNotification(result.message || '提交失敗', 'error');
                    }
                } catch (e) {
                    showNotification('提交失敗：' + e.message, 'error');
                } finally {
                    setButtonLoading(btn, false);
                    isSubmitting = false;
                }
            });
        }

        // 活動詳情模態框
        function showActivityDetail(activityId) {
            const activity = allActivitiesCache.find(a => a.id === activityId);
            if (!activity) return;
            
            const modal = `
                <div class="modal fade" id="activityDetailModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${activity.title || ''}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <strong><i class="bi bi-calendar me-2"></i>活動日期</strong>
                                        <div>${formatDate(activity.date)}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <strong><i class="bi bi-clock me-2"></i>活動時間</strong>
                                        <div>${activity.time || ''}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <strong><i class="bi bi-geo-alt me-2"></i>活動地點</strong>
                                        <div>${activity.location || ''}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <strong><i class="bi bi-people me-2"></i>參加人數</strong>
                                        <div>${activity.currentCount || 0}/${activity.maxParticipants || '不限'}</div>
                                    </div>
                                    <div class="col-12">
                                        <strong><i class="bi bi-info-circle me-2"></i>活動說明</strong>
                                        <div style="white-space: pre-line;">${activity.description || ''}</div>
                                    </div>
                                    ${activity.requirements ? `
                                    <div class="col-12">
                                        <strong><i class="bi bi-exclamation-triangle me-2"></i>注意事項</strong>
                                        <div style="white-space: pre-line;">${activity.requirements}</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                                ${activity.status === '開放報名' ? `
                                    <button type="button" class="btn btn-primary" onclick="registerActivity('${activity.id}'); bootstrap.Modal.getInstance(document.getElementById('activityDetailModal')).hide();">
                                        <i class="bi bi-clipboard-plus me-1"></i>立即報名
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modal;
            const modalEl = new bootstrap.Modal(document.getElementById('activityDetailModal'));
            modalEl.show();
        }

        // 系統通知模態框
        function showSystemNotificationModal() {
            if (!isAdmin) return;
            
            const modal = `
                <div class="modal fade" id="systemNotificationModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="bi bi-megaphone me-2"></i>發送系統通知</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form id="systemNotificationForm">
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">通知對象 *</label>
                                        <select class="form-select" name="target" required>
                                            <option value="">請選擇</option>
                                            <option value="all">所有會員</option>
                                            <option value="patients">病友</option>
                                            <option value="caregivers">照護者</option>
                                            <option value="supporters">支持者</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">通知標題 *</label>
                                        <input type="text" class="form-control" name="title" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">通知內容 *</label>
                                        <textarea class="form-control" name="message" rows="4" required></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="submit" class="btn btn-primary">發送通知</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modal;
            const modalEl = new bootstrap.Modal(document.getElementById('systemNotificationModal'));
            modalEl.show();
            
            document.getElementById('systemNotificationForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                if (isSubmitting) return;
                
                const btn = this.querySelector('button[type="submit"]');
                setButtonLoading(btn, true);
                isSubmitting = true;
                
                try {
                    const formData = new FormData(this);
                    const data = {
                        target: formData.get('target'),
                        title: formData.get('title'),
                        message: formData.get('message')
                    };
                    
                    const result = await callAPI('sendSystemNotification', data);
                    
                    if (result.success) {
                        showNotification('系統通知發送成功', 'success');
                        modalEl.hide();
                    } else {
                        showNotification(result.message || '發送失敗', 'error');
                    }
                } catch (e) {
                    showNotification('發送失敗：' + e.message, 'error');
                } finally {
                    setButtonLoading(btn, false);
                    isSubmitting = false;
                }
            });
        }

        // 備份功能
        function triggerBackup() {
            if (!isAdmin) return;
            
            if (!confirm('確定要執行系統備份嗎？')) return;
            
            callAPI('triggerBackup').then(result => {
                if (result.success) {
                    showNotification('系統備份已啟動', 'success');
                    document.getElementById('systemInfo').innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            備份時間：${formatDateTime(new Date())}
                        </div>
                    `;
                } else {
                    showNotification(result.message || '備份失敗', 'error');
                }
            }).catch(e => {
                showNotification('備份失敗：' + e.message, 'error');
            });
        }

        // 將函數加入全域範圍
        window.showNewExpenseModal = showNewExpenseModal;
        window.showActivityDetail = showActivityDetail;
        window.showSystemNotificationModal = showSystemNotificationModal;
        window.triggerBackup = triggerBackup;

        // 載入完成後隱藏載入畫面
        window.addEventListener('load', function() {
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 500);
                }
            }, 2000);
        });

        console.log('帕金森病友會管理系統已載入');
    </script>

    <!-- 通知容器 -->
    <div id="notificationContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

    <!-- 載入畫面 -->
    <div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-gradient); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; transition: opacity 0.5s;">
        <div class="loading-spinner mb-3" style="width: 60px; height: 60px;"></div>
        <h4 class="text-white mb-2">帕金森病友會</h4>
        <p class="text-white-50" id="loadingStatus">系統初始化中...</p>
        <div class="mt-3" style="background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 20px;">
            <div id="liffStatusIndicator" class="status-indicator status-offline" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px;"></div>
            <span id="liffStatusText" class="text-white-50 small">LIFF 狀態：檢查中</span>
        </div>
    </div>

</body>
</html>


