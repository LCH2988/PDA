<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會員管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root {
            --primary-color: #06C755;
            --secondary-color: #00B900;
            --accent-color: #FF6B6B;
            --text-dark: #333;
            --bg-light: #f8f9fa;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .main-container {
            background: white;
            min-height: 100vh;
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .user-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            text-align: center;
            border-radius: 24px 24px 0 0;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            object-fit: cover;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .user-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .user-subtitle {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .nav-pills {
            background: var(--bg-light);
            border-radius: 16px;
            padding: 0.5rem;
            margin: 1rem;
        }

        .nav-pills .nav-link {
            border-radius: 12px;
            color: var(--text-dark);
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 0 0.2rem;
        }

        .nav-pills .nav-link.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(6, 199, 85, 0.3);
        }

        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }

        .card-header {
            background: var(--bg-light);
            border-bottom: 1px solid #eee;
            border-radius: 16px 16px 0 0 !important;
            font-weight: 600;
            color: var(--text-dark);
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 12px;
            font-weight: 500;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            border-radius: 12px;
        }

        .btn-warning {
            border-radius: 12px;
        }

        .btn-danger {
            border-radius: 12px;
        }

        .form-control, .form-select {
            border-radius: 12px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(6, 199, 85, 0.25);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .activity-card {
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
        }

        .activity-card:hover {
            border-left-color: var(--accent-color);
        }

        .volunteer-record {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--secondary-color);
        }

        .financial-record {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #ffc107;
        }

        .financial-record.income {
            border-left-color: #28a745;
        }

        .feedback-item {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent-color);
        }

        .stats-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stats-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1080;
        }

        .modal-content {
            border-radius: 16px;
            border: none;
        }

        .modal-header {
            border-bottom: 1px solid #eee;
            border-radius: 16px 16px 0 0;
        }

        .modal-footer {
            border-top: 1px solid #eee;
            border-radius: 0 0 16px 16px;
        }

        @media (max-width: 768px) {
            .main-container {
                border-radius: 0;
            }
            
            .user-header {
                border-radius: 0;
                padding: 1.5rem;
            }
            
            .nav-pills {
                margin: 0.5rem;
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            
            .nav-pills .nav-link {
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid px-0">
        <div class="main-container">
            <!-- 用戶頭部 -->
            <div class="user-header">
                <img id="userAvatar" class="user-avatar" src="https://via.placeholder.com/80" alt="用戶頭像">
                <div class="user-name" id="userName">載入中...</div>
                <div class="user-subtitle">會員管理系統</div>
            </div>

            <!-- 導航選項卡 -->
            <ul class="nav nav-pills justify-content-center" id="mainTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="pill" href="#profile">
                        <i class="bi bi-person me-1"></i>個人資料
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="pill" href="#activities">
                        <i class="bi bi-calendar-event me-1"></i>活動
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="pill" href="#volunteer">
                        <i class="bi bi-heart me-1"></i>志工
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="pill" href="#financial">
                        <i class="bi bi-wallet2 me-1"></i>財務
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="pill" href="#feedback">
                        <i class="bi bi-chat-dots me-1"></i>回饋
                    </a>
                </li>
                <li class="nav-item" id="adminTab" style="display: none;">
                    <a class="nav-link" data-bs-toggle="pill" href="#admin">
                        <i class="bi bi-gear me-1"></i>管理
                    </a>
                </li>
            </ul>

            <!-- 內容區域 -->
            <div class="tab-content p-3">
                <!-- 個人資料 -->
                <div class="tab-pane fade show active" id="profile">
                    <div class="row">
                        <div class="col-lg-8 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-person-badge me-2"></i>基本資料
                                </div>
                                <div class="card-body">
                                    <form id="memberForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">真實姓名</label>
                                                <input type="text" class="form-control" name="真實姓名" id="realName">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">電話</label>
                                                <input type="tel" class="form-control" name="電話" id="phone">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">電子郵件</label>
                                                <input type="email" class="form-control" name="電子郵件" id="email">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">生日</label>
                                                <input type="date" class="form-control" name="生日" id="birthday">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">地址</label>
                                            <input type="text" class="form-control" name="地址" id="address">
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">緊急聯絡人</label>
                                                <input type="text" class="form-control" name="緊急聯絡人" id="emergencyContact">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">緊急聯絡電話</label>
                                                <input type="tel" class="form-control" name="緊急聯絡電話" id="emergencyPhone">
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check-circle me-1"></i>更新資料
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-info-circle me-2"></i>會員資訊
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <strong>會員等級：</strong>
                                        <span class="badge bg-primary" id="memberLevel">-</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>加入日期：</strong>
                                        <span id="joinDate">-</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>最後登入：</strong>
                                        <span id="lastLogin">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 活動 -->
                <div class="tab-pane fade" id="activities">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-event me-2"></i>活動列表
                        </h5>
                        <div class="d-flex gap-2">
                            <select id="activityStatusFilter" class="form-select form-select-sm">
                                <option value="">全部狀態</option>
                                <option value="開放報名">開放報名</option>
                                <option value="報名截止">報名截止</option>
                                <option value="進行中">進行中</option>
                                <option value="已完成">已完成</option>
                                <option value="已取消">已取消</option>
                            </select>
                            <select id="activityTypeFilter" class="form-select form-select-sm">
                                <option value="">全部類型</option>
                                <option value="教育訓練">教育訓練</option>
                                <option value="志工服務">志工服務</option>
                                <option value="聯誼活動">聯誼活動</option>
                                <option value="會議">會議</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                    <div class="row" id="activitiesList">
                        <div class="col-12 text-center">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- 志工 -->
                <div class="tab-pane fade" id="volunteer">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="bi bi-heart me-2"></i>志工服務
                        </h5>
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#volunteerModal">
                            <i class="bi bi-plus-circle me-1"></i>新增記錄
                        </button>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="stats-card">
                                <div class="stats-number" id="totalVolunteerHours">0</div>
                                <div class="stats-label">總服務時數</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stats-card">
                                <div class="stats-number" id="totalVolunteerTimes">0</div>
                                <div class="stats-label">服務次數</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="volunteerRecordsList">
                        <div class="text-center">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- 財務 -->
                <div class="tab-pane fade" id="financial">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="bi bi-wallet2 me-2"></i>財務記錄
                        </h5>
                        <div class="btn-group">
                            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#donationModal">
                                <i class="bi bi-heart-fill me-1"></i>捐款
                            </button>
                            <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#expenseModal">
                                <i class="bi bi-receipt me-1"></i>支出申請
                            </button>
                        </div>
                    </div>
                    
                    <div id="financialRecordsList">
                        <div class="text-center">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- 回饋 -->
                <div class="tab-pane fade" id="feedback">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="bi bi-chat-dots me-2"></i>回饋意見
                        </h5>
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                            <i class="bi bi-plus-circle me-1"></i>新增回饋
                        </button>
                    </div>
                    
                    <div id="feedbackList">
                        <div class="text-center">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- 管理 -->
                <div class="tab-pane fade" id="admin">
                    <h5 class="mb-3">
                        <i class="bi bi-gear me-2"></i>系統管理
                    </h5>
                    
                    <div class="row mb-4" id="adminStats">
                        <div class="col-6 col-md-3 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-people fs-2 text-primary mb-2"></i>
                                    <h4 class="mb-1" id="dashTotalMembers">0</h4>
                                    <small class="text-muted">會員總數</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-calendar-event fs-2 text-success mb-2"></i>
                                    <h4 class="mb-1" id="dashTotalActivities">0</h4>
                                    <small class="text-muted">活動總數</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-heart-fill fs-2 text-danger mb-2"></i>
                                    <h4 class="mb-1" id="dashTotalDonations">0</h4>
                                    <small class="text-muted">捐款總額</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-clock fs-2 text-warning mb-2"></i>
                                    <h4 class="mb-1" id="dashTotalVolunteerHours">0</h4>
                                    <small class="text-muted">志工時數</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">最新加入會員</div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush" id="latestMembers">
                                        <li class="list-group-item">載入中...</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">熱門活動</div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush" id="hotActivities">
                                        <li class="list-group-item">載入中...</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-clock-history me-2"></i>待處理事項
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>志工記錄待確認</span>
                                        <span class="badge bg-warning" id="pendingVolunteer">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>支出申請待審核</span>
                                        <span class="badge bg-warning" id="pendingExpense">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>回饋待處理</span>
                                        <span class="badge bg-warning" id="pendingFeedback">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8 mb-3">
                            <div class="card">
                                <div class="card-header">管理功能</div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-6 mb-2">
                                            <button class="btn btn-outline-primary w-100" onclick="performHealthCheck()">
                                                <i class="bi bi-shield-check me-1"></i>系統檢查
                                            </button>
                                        </div>
                                        <div class="col-6 mb-2">
                                            <button class="btn btn-outline-success w-100" onclick="createBackup()">
                                                <i class="bi bi-cloud-arrow-up me-1"></i>建立備份
                                            </button>
                                        </div>
                                        <div class="col-6 mb-2">
                                            <button class="btn btn-outline-info w-100" onclick="exportData()">
                                                <i class="bi bi-download me-1"></i>匯出資料
                                            </button>
                                        </div>
                                        <div class="col-6 mb-2">
                                            <button class="btn btn-outline-warning w-100" onclick="getSystemInfo()">
                                                <i class="bi bi-info-circle me-1"></i>系統資訊
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 志工記錄模態框 -->
    <div class="modal fade" id="volunteerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增志工記錄</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="volunteerForm">
                        <div class="mb-3">
                            <label class="form-label">服務項目 *</label>
                            <input type="text" class="form-control" name="服務項目" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">服務日期 *</label>
                            <input type="date" class="form-control" name="服務日期" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">服務時數 *</label>
                            <input type="number" class="form-control" name="服務時數" min="0.5" step="0.5" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">服務地點</label>
                            <input type="text" class="form-control" name="服務地點">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">服務內容</label>
                            <textarea class="form-control" name="服務內容" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" onclick="submitVolunteerRecord()">提交</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 捐款模態框 -->
    <div class="modal fade" id="donationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">愛心捐款</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="donationForm">
                        <div class="mb-3">
                            <label class="form-label">捐款項目</label>
                            <select class="form-select" name="項目">
                                <option value="一般捐款">一般捐款</option>
                                <option value="急難救助">急難救助</option>
                                <option value="教育基金">教育基金</option>
                                <option value="活動經費">活動經費</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">捐款金額 *</label>
                            <input type="number" class="form-control" name="金額" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">捐款日期</label>
                            <input type="date" class="form-control" name="日期">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">備註說明</label>
                            <textarea class="form-control" name="描述" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" onclick="submitDonation()">確認捐款</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 支出申請模態框 -->
    <div class="modal fade" id="expenseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">支出申請</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="expenseForm">
                        <div class="mb-3">
                            <label class="form-label">申請項目 *</label>
                            <input type="text" class="form-control" name="項目" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">申請金額 *</label>
                            <input type="number" class="form-control" name="金額" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">申請日期</label>
                            <input type="date" class="form-control" name="日期">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">申請說明 *</label>
                            <textarea class="form-control" name="描述" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-warning" onclick="submitExpenseRequest()">提交申請</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 回饋模態框 -->
    <div class="modal fade" id="feedbackModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">意見回饋</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="feedbackForm">
                        <div class="mb-3">
                            <label class="form-label">回饋類型</label>
                            <select class="form-select" name="類型">
                                <option value="系統建議">系統建議</option>
                                <option value="功能需求">功能需求</option>
                                <option value="問題回報">問題回報</option>
                                <option value="活動建議">活動建議</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">評分 *</label>
                            <select class="form-select" name="評分" required>
                                <option value="">請選擇評分</option>
                                <option value="5">⭐⭐⭐⭐⭐ 非常滿意</option>
                                <option value="4">⭐⭐⭐⭐ 滿意</option>
                                <option value="3">⭐⭐⭐ 普通</option>
                                <option value="2">⭐⭐ 不滿意</option>
                                <option value="1">⭐ 非常不滿意</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">意見內容 *</label>
                            <textarea class="form-control" name="內容" rows="4" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitFeedback()">提交回饋</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 活動詳情模態框 -->
    <div class="modal fade" id="activityDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="activityDetailTitle">活動詳情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="activityDetailContent">
                    <!-- 活動詳情內容將動態載入 -->
                </div>
                <div class="modal-footer" id="activityDetailFooter">
                    <!-- 按鈕將動態載入 -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 通知容器 -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-info-circle-fill text-primary me-2"></i>
                <strong class="me-auto">系統通知</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                <!-- 通知內容 -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全域變數
        let currentUser = null;
        let isAdmin = false;
        const API_URL = 'https://script.google.com/macros/s/AKfycbyryNpgFNY9EnrkjMa8KU51TA_BGC8A8b8lOrBOn4Y9EzdmGEeC5OhiB4WRoNWkigrd/exec'; // 請替換為您的 GAS URL

        // LIFF 初始化
        async function initializeLiff() {
            try {
                await liff.init({ liffId: '1656516134-VaGgmaPm' }); // 請替換為您的 LIFF ID
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // 取得用戶資料
                const profile = await liff.getProfile();
                currentUser = {
                    userId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl
                };

                // 更新 UI
                updateUserHeader();
                
                // 載入會員資料
                await loadMemberInfo();
                
                // 初始化頁面
                initializePage();
                
            } catch (error) {
                console.error('LIFF 初始化失敗:', error);
                showToast('系統初始化失敗，請重新整理頁面', 'error');
            }
        }

        // 更新用戶頭部資訊
        function updateUserHeader() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.displayName;
                if (currentUser.pictureUrl) {
                    document.getElementById('userAvatar').src = currentUser.pictureUrl;
                }
            }
        }

        // 載入會員資料
        async function loadMemberInfo() {
            try {
                const response = await callAPI('getMemberInfo', {
                    userId: currentUser.userId,
                    displayName: currentUser.displayName
                });

                if (response.success) {
                    const member = response.data.member;
                    
                    // 更新個人資料表單
                    document.getElementById('realName').value = member['真實姓名'] || '';
                    document.getElementById('phone').value = member['電話'] || '';
                    document.getElementById('email').value = member['電子郵件'] || '';
                    document.getElementById('birthday').value = member['生日'] || '';
                    document.getElementById('address').value = member['地址'] || '';
                    document.getElementById('emergencyContact').value = member['緊急聯絡人'] || '';
                    document.getElementById('emergencyPhone').value = member['緊急聯絡電話'] || '';
                    
                    // 更新會員資訊
                    document.getElementById('memberLevel').textContent = member['會員等級'] || '';
                    document.getElementById('joinDate').textContent = formatDate(member['加入日期']);
                    document.getElementById('lastLogin').textContent = formatDate(member['最後登入時間']);
                    
                    // 檢查管理員權限
                    isAdmin = ['管理員', '超級管理員'].includes(member['會員等級']);
                    if (isAdmin) {
                        document.getElementById('adminTab').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('載入會員資料失敗:', error);
                showToast('載入會員資料失敗', 'error');
            }
        }

        // 初始化頁面
        function initializePage() {
            // 綁定表單提交事件
            document.getElementById('memberForm').addEventListener('submit', updateMemberInfo);
            
            // 綁定篩選器事件
            document.getElementById('activityStatusFilter').addEventListener('change', filterActivities);
            document.getElementById('activityTypeFilter').addEventListener('change', filterActivities);
            
            // 綁定標籤切換事件
            document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    const target = e.target.getAttribute('href');
                    loadTabContent(target);
                });
            });
            
            // 載入預設標籤內容
            loadTabContent('#profile');
        }

        // 載入標籤內容
        async function loadTabContent(tabId) {
            switch(tabId) {
                case '#activities':
                    await loadActivities();
                    break;
                case '#volunteer':
                    await loadVolunteerRecords();
                    break;
                case '#financial':
                    await loadFinancialRecords();
                    break;
                case '#feedback':
                    await loadFeedbackList();
                    break;
                case '#admin':
                    if (isAdmin) {
                        await loadAdminDashboard();
                    }
                    break;
            }
        }

        // API 呼叫函數
        async function callAPI(action, data = {}) {
            try {
                const requestData = {
                    action: action,
                    userId: currentUser?.userId,
                    ...data
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API 呼叫失敗:', error);
                throw error;
            }
        }

        // 更新會員資料
        async function updateMemberInfo(event) {
            event.preventDefault();
            
            try {
                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData.entries());
                
                const response = await callAPI('updateMemberInfo', data);
                
                if (response.success) {
                    showToast('會員資料更新成功', 'success');
                } else {
                    showToast(response.message || '更新失敗', 'error');
                }
            } catch (error) {
                console.error('更新會員資料失敗:', error);
                showToast('更新失敗，請稍後再試', 'error');
            }
        }

        // 載入活動列表
        async function loadActivities() {
            try {
                document.getElementById('activitiesList').innerHTML = '<div class="col-12 text-center"><div class="loading-spinner"></div></div>';
                
                const response = await callAPI('getActivities');
                
                if (response.success) {
                    displayActivities(response.data.activities);
                } else {
                    document.getElementById('activitiesList').innerHTML = '<div class="col-12 text-center text-muted">載入活動失敗</div>';
                }
            } catch (error) {
                console.error('載入活動失敗:', error);
                document.getElementById('activitiesList').innerHTML = '<div class="col-12 text-center text-muted">載入活動失敗</div>';
            }
        }

        // 顯示活動列表
        function displayActivities(activities) {
            const container = document.getElementById('activitiesList');
            
            if (activities.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted">目前沒有活動</div>';
                return;
            }

            const html = activities.map(activity => `
                <div class="col-md-6 col-lg-4 mb-3" data-status="${activity['活動狀態']}" data-type="${activity['活動類型']}">
                    <div class="card activity-card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${activity['活動名稱']}</h6>
                            <p class="card-text text-muted small">${activity['活動描述'].substring(0, 50)}...</p>
                            <div class="mb-2">
                                <span class="badge bg-secondary">${activity['活動類型']}</span>
                                <span class="status-badge ${getStatusClass(activity['活動狀態'])}">${activity['活動狀態']}</span>
                            </div>
                            <div class="small text-muted mb-2">
                                <i class="bi bi-calendar me-1"></i>${formatDate(activity['開始時間'])}
                                <br>
                                <i class="bi bi-geo-alt me-1"></i>${activity['地點']}
                                <br>
                                <i class="bi bi-people me-1"></i>${activity['目前報名人數']}/${activity['參與人數上限']}
                            </div>
                            <button class="btn btn-primary btn-sm w-100" onclick="showActivityDetail('${activity['活動ID']}')">
                                查看詳情
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // 篩選活動
        function filterActivities() {
            const statusFilter = document.getElementById('activityStatusFilter').value;
            const typeFilter = document.getElementById('activityTypeFilter').value;
            const activities = document.querySelectorAll('#activitiesList [data-status]');
            
            activities.forEach(activity => {
                const status = activity.getAttribute('data-status');
                const type = activity.getAttribute('data-type');
                
                const statusMatch = !statusFilter || status === statusFilter;
                const typeMatch = !typeFilter || type === typeFilter;
                
                activity.style.display = statusMatch && typeMatch ? 'block' : 'none';
            });
        }

        // 顯示活動詳情
        async function showActivityDetail(activityId) {
            try {
                const response = await callAPI('getActivityDetail', { activityId });
                
                if (response.success) {
                    const activity = response.data.activity;
                    
                    document.getElementById('activityDetailTitle').textContent = activity['活動名稱'];
                    
                    document.getElementById('activityDetailContent').innerHTML = `
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <strong>活動類型：</strong>${activity['活動類型']}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>活動狀態：</strong>
                                <span class="status-badge ${getStatusClass(activity['活動狀態'])}">${activity['活動狀態']}</span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>開始時間：</strong>${formatDateTime(activity['開始時間'])}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>結束時間：</strong>${formatDateTime(activity['結束時間'])}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>活動地點：</strong>${activity['地點']}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>報名人數：</strong>${activity['目前報名人數']}/${activity['參與人數上限']}
                            </div>
                            <div class="col-12 mb-3">
                                <strong>報名截止：</strong>${formatDateTime(activity['報名截止日期'])}
                            </div>
                            <div class="col-12 mb-3">
                                <strong>活動描述：</strong>
                                <p class="mt-2">${activity['活動描述']}</p>
                            </div>
                        </div>
                    `;
                    
                    // 設定按鈕
                    let buttons = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>';
                    
                    if (activity['活動狀態'] === '開放報名' && new Date() <= new Date(activity['報名截止日期'])) {
                        const currentCount = parseInt(activity['目前報名人數']);
                        const maxCount = parseInt(activity['參與人數上限']);
                        
                        if (maxCount === 0 || currentCount < maxCount) {
                            buttons = `
                                <button type="button" class="btn btn-success" onclick="registerActivity('${activityId}')">立即報名</button>
                                ${buttons}
                            `;
                        }
                    }
                    
                    document.getElementById('activityDetailFooter').innerHTML = buttons;
                    
                    new bootstrap.Modal(document.getElementById('activityDetailModal')).show();
                }
            } catch (error) {
                console.error('載入活動詳情失敗:', error);
                showToast('載入活動詳情失敗', 'error');
            }
        }

        // 報名活動
        async function registerActivity(activityId) {
            try {
                const response = await callAPI('registerActivity', { activityId });
                
                if (response.success) {
                    showToast('報名成功！', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('activityDetailModal')).hide();
                    loadActivities(); // 重新載入活動列表
                } else {
                    showToast(response.message || '報名失敗', 'error');
                }
            } catch (error) {
                console.error('報名失敗:', error);
                showToast('報名失敗，請稍後再試', 'error');
            }
        }

        // 載入志工記錄
        async function loadVolunteerRecords() {
            try {
                document.getElementById('volunteerRecordsList').innerHTML = '<div class="text-center"><div class="loading-spinner"></div></div>';
                
                const response = await callAPI('getVolunteerRecords');
                
                if (response.success) {
                    const { records, stats } = response.data;
                    
                    // 更新統計
                    document.getElementById('totalVolunteerHours').textContent = stats.totalHours.toFixed(1);
                    document.getElementById('totalVolunteerTimes').textContent = stats.totalTimes;
                    
                    // 顯示記錄
                    displayVolunteerRecords(records);
                } else {
                    document.getElementById('volunteerRecordsList').innerHTML = '<div class="text-center text-muted">載入失敗</div>';
                }
            } catch (error) {
                console.error('載入志工記錄失敗:', error);
                document.getElementById('volunteerRecordsList').innerHTML = '<div class="text-center text-muted">載入失敗</div>';
            }
        }

        // 顯示志工記錄
        function displayVolunteerRecords(records) {
            const container = document.getElementById('volunteerRecordsList');
            
            if (records.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">尚無志工記錄</div>';
                return;
            }

            const html = records.map(record => `
                <div class="volunteer-record">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">${record['服務項目']}</h6>
                        <span class="status-badge ${getStatusClass(record['狀態'])}">${record['狀態']}</span>
                    </div>
                    <div class="small text-muted mb-2">
                        <i class="bi bi-calendar me-1"></i>${formatDate(record['服務日期'])}
                        <i class="bi bi-clock ms-3 me-1"></i>${record['服務時數']} 小時
                        <i class="bi bi-geo-alt ms-3 me-1"></i>${record['服務地點'] || '未填寫'}
                    </div>
                    <p class="small mb-0">${record['服務內容'] || '無詳細描述'}</p>
                    ${record['確認時間'] ? `<div class="small text-success mt-1">確認時間：${formatDateTime(record['確認時間'])}</div>` : ''}
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // 提交志工記錄
        async function submitVolunteerRecord() {
            try {
                const form = document.getElementById('volunteerForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                const response = await callAPI('addVolunteerRecord', data);
                
                if (response.success) {
                    showToast('志工記錄提交成功，等待審核', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('volunteerModal')).hide();
                    form.reset();
                    loadVolunteerRecords(); // 重新載入記錄
                } else {
                    showToast(response.message || '提交失敗', 'error');
                }
            } catch (error) {
                console.error('提交志工記錄失敗:', error);
                showToast('提交失敗，請稍後再試', 'error');
            }
        }

        // 載入財務記錄
        async function loadFinancialRecords() {
            try {
                document.getElementById('financialRecordsList').innerHTML = '<div class="text-center"><div class="loading-spinner"></div></div>';
                
                const response = await callAPI('getFinancialRecords');
                
                if (response.success) {
                    displayFinancialRecords(response.data.records);
                } else {
                    document.getElementById('financialRecordsList').innerHTML = '<div class="text-center text-muted">載入失敗</div>';
                }
            } catch (error) {
                console.error('載入財務記錄失敗:', error);
                document.getElementById('financialRecordsList').innerHTML = '<div class="text-center text-muted">載入失敗</div>';
            }
        }

        // 顯示財務記錄
        function displayFinancialRecords(records) {
            const container = document.getElementById('financialRecordsList');
            
            if (records.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">尚無財務記錄</div>';
                return;
            }

            const html = records.map(record => `
                <div class="financial-record ${record['類型'] === '捐款' ? 'income' : ''}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="mb-0">${record['項目']}</h6>
                            <span class="badge ${record['類型'] === '捐款' ? 'bg-success' : 'bg-warning'}">${record['類型']}</span>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold ${record['類型'] === '捐款' ? 'text-success' : 'text-warning'}">
                                ${record['類型'] === '捐款' ? '+' : ''}$${parseInt(record['金額']).toLocaleString()}
                            </div>
                            <span class="status-badge ${getStatusClass(record['狀態'])}">${record['狀態']}</span>
                        </div>
                    </div>
                    <div class="small text-muted mb-2">
                        <i class="bi bi-calendar me-1"></i>${formatDate(record['日期'])}
                        ${record['收據號碼'] ? `<i class="bi bi-receipt ms-3 me-1"></i>${record['收據號碼']}` : ''}
                    </div>
                    ${record['描述'] ? `<p class="small mb-0">${record['描述']}</p>` : ''}
                    ${record['審核時間'] ? `<div class="small text-info mt-1">審核時間：${formatDateTime(record['審核時間'])}</div>` : ''}
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // 提交捐款
        async function submitDonation() {
            try {
                const form = document.getElementById('donationForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                // 設定預設日期
                if (!data['日期']) {
                    data['日期'] = new Date().toISOString().split('T')[0];
                }
                
                const response = await callAPI('addDonation', data);
                
                if (response.success) {
                    showToast(`捐款成功！收據號碼：${response.data.receiptNumber}`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
                    form.reset();
                    loadFinancialRecords(); // 重新載入記錄
                } else {
                    showToast(response.message || '捐款失敗', 'error');
                }
            } catch (error) {
                console.error('捐款失敗:', error);
                showToast('捐款失敗，請稍後再試', 'error');
            }
        }

        // 提交支出申請
        async function submitExpenseRequest() {
            try {
                const form = document.getElementById('expenseForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                // 設定預設日期
                if (!data['日期']) {
                    data['日期'] = new Date().toISOString().split('T')[0];
                }
                
                const response = await callAPI('addExpenseRequest', data);
                
                if (response.success) {
                    showToast('支出申請提交成功，等待審核', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
                    form.reset();
                    loadFinancialRecords(); // 重新載入記錄
                } else {
                    showToast(response.message || '申請失敗', 'error');
                }
            } catch (error) {
                console.error('支出申請失敗:', error);
                showToast('申請失敗，請稍後再試', 'error');
            }
        }

        // 載入回饋列表
        async function loadFeedbackList() {
            try {
                document.getElementById('feedbackList').innerHTML = '<div class="text-center"><div class="loading-spinner"></div></div>';
                
                const response = await callAPI('getFeedbackList');
                
                if (response.success) {
                    displayFeedbackList(response.data.feedbacks);
                } else {
                    document.getElementById('feedbackList').innerHTML = '<div class="text-center text-muted">載入失敗</div>';
                }
            } catch (error) {
                console.error('載入回饋列表失敗:', error);
                document.getElementById('feedbackList').innerHTML = '<div class="text-center text-muted">載入失敗</div>';
            }
        }

        // 顯示回饋列表
        function displayFeedbackList(feedbacks) {
            const container = document.getElementById('feedbackList');
            
            if (feedbacks.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">尚無回饋記錄</div>';
                return;
            }

            const html = feedbacks.map(feedback => `
                <div class="feedback-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="mb-0">${feedback['類型']}</h6>
                            <div class="small text-warning">
                                ${'⭐'.repeat(parseInt(feedback['評分']))}
                            </div>
                        </div>
                        <span class="status-badge ${getStatusClass(feedback['狀態'])}">${feedback['狀態']}</span>
                    </div>
                    <p class="mb-2">${feedback['內容']}</p>
                    <div class="small text-muted">
                        提交時間：${formatDateTime(feedback['建立時間'])}
                    </div>
                    ${feedback['回覆'] ? `
                        <div class="mt-2 p-2 bg-light rounded">
                            <strong>回覆：</strong>${feedback['回覆']}
                            <div class="small text-muted mt-1">
                                回覆時間：${formatDateTime(feedback['回覆時間'])}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // 提交回饋
        async function submitFeedback() {
            try {
                const form = document.getElementById('feedbackForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                const response = await callAPI('addFeedback', data);
                
                if (response.success) {
                    showToast('回饋提交成功，感謝您的意見！', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
                    form.reset();
                    loadFeedbackList(); // 重新載入列表
                } else {
                    showToast(response.message || '提交失敗', 'error');
                }
            } catch (error) {
                console.error('提交回饋失敗:', error);
                showToast('提交失敗，請稍後再試', 'error');
            }
        }

        // 載入管理儀表板
        async function loadAdminDashboard() {
            try {
                const response = await callAPI('getAdminDashboard');
                
                if (response.success) {
                    const dashboard = response.data;
                    
                    // 更新統計數據
                    document.getElementById('dashTotalMembers').textContent = dashboard.stats.totalMembers;
                    document.getElementById('dashTotalActivities').textContent = dashboard.stats.totalActivities;
                    document.getElementById('dashTotalDonations').textContent = '$' + dashboard.stats.totalDonations.toLocaleString();
                    document.getElementById('dashTotalVolunteerHours').textContent = dashboard.stats.totalVolunteerHours.toFixed(1);
                    
                    // 更新最新會員
                    const latestMembersHtml = dashboard.latestMembers.map(member => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${member.name}
                            <span class="badge bg-primary">${member.level}</span>
                        </li>
                    `).join('');
                    document.getElementById('latestMembers').innerHTML = latestMembersHtml || '<li class="list-group-item text-muted">暫無資料</li>';
                    
                    // 更新熱門活動
                    const hotActivitiesHtml = dashboard.hotActivities.map(activity => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${activity.name}
                            <span class="badge bg-success">${activity.current}/${activity.max}</span>
                        </li>
                    `).join('');
                    document.getElementById('hotActivities').innerHTML = hotActivitiesHtml || '<li class="list-group-item text-muted">暫無資料</li>';
                    
                    // 更新待處理事項
                    document.getElementById('pendingVolunteer').textContent = dashboard.pendingItems.volunteerPending;
                    document.getElementById('pendingExpense').textContent = dashboard.pendingItems.expensePending;
                    document.getElementById('pendingFeedback').textContent = dashboard.pendingItems.feedbackPending;
                }
            } catch (error) {
                console.error('載入管理儀表板失敗:', error);
                showToast('載入管理儀表板失敗', 'error');
            }
        }

        // 管理功能
        async function performHealthCheck() {
            try {
                showToast('正在執行系統檢查...', 'info');
                const response = await callAPI('adminCommand', { command: 'health_check' });
                
                if (response.success) {
                    const report = response.data;
                    let message = `系統狀態：${report.status}\n`;
                    if (report.issues.length > 0) {
                        message += `發現問題：\n${report.issues.join('\n')}`;
                    } else {
                        message += '系統運作正常';
                    }
                    alert(message);
                } else {
                    showToast('系統檢查失敗', 'error');
                }
            } catch (error) {
                console.error('系統檢查失敗:', error);
                showToast('系統檢查失敗', 'error');
            }
        }

        async function createBackup() {
            try {
                showToast('正在建立備份...', 'info');
                const response = await callAPI('adminCommand', { 
                    command: 'backup_data',
                    backupSettings: {
                        description: '手動備份 - ' + new Date().toLocaleString()
                    }
                });
                
                if (response.success) {
                    showToast('備份建立成功！', 'success');
                    if (response.data.url) {
                        if (confirm('是否要開啟備份檔案？')) {
                            window.open(response.data.url, '_blank');
                        }
                    }
                } else {
                    showToast('備份建立失敗', 'error');
                }
            } catch (error) {
                console.error('建立備份失敗:', error);
                showToast('建立備份失敗', 'error');
            }
        }

        async function exportData() {
            try {
                showToast('匯出功能開發中...', 'info');
            } catch (error) {
                console.error('匯出資料失敗:', error);
                showToast('匯出資料失敗', 'error');
            }
        }

        async function getSystemInfo() {
            try {
                const response = await callAPI('adminCommand', { command: 'get_system_info' });
                
                if (response.success) {
                    const info = response.data;
                    let message = `系統資訊：\n`;
                    message += `版本：${info.version || '未知'}\n`;
                    message += `試算表：${info.spreadsheetInfo?.name || '未知'}\n`;
                    message += `工作表數量：${info.spreadsheetInfo?.sheets?.length || 0}\n`;
                    message += `觸發器數量：${info.triggerInfo?.count || 0}\n`;
                    message += `會員總數：${info.systemStats?.totalMembers || 0}\n`;
                    message += `活動總數：${info.systemStats?.totalActivities || 0}`;
                    alert(message);
                } else {
                    showToast('取得系統資訊失敗', 'error');
                }
            } catch (error) {
                console.error('取得系統資訊失敗:', error);
                showToast('取得系統資訊失敗', 'error');
            }
        }

        // 工具函數
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-TW');
            } catch (error) {
                return '-';
            }
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleString('zh-TW');
            } catch (error) {
                return '-';
            }
        }

        function getStatusClass(status) {
            const statusMap = {
                '正常': 'status-active',
                '已確認': 'status-active',
                '已核准': 'status-active',
                '開放報名': 'status-active',
                '已完成': 'status-active',
                '已回覆': 'status-active',
                '已結案': 'status-active',
                '待確認': 'status-pending',
                '待審核': 'status-pending',
                '待處理': 'status-pending',
                '處理中': 'status-pending',
                '報名截止': 'status-pending',
                '進行中': 'status-pending',
                '已取消': 'status-cancelled',
                '已拒絕': 'status-cancelled',
                '異常': 'status-cancelled'
            };
            return statusMap[status] || 'status-pending';
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('liveToast');
            const toastBody = document.getElementById('toastMessage');
            const toastHeader = toast.querySelector('.toast-header i');
            
            // 設定圖示和顏色
            const typeMap = {
                'success': { icon: 'bi-check-circle-fill', color: 'text-success' },
                'error': { icon: 'bi-exclamation-triangle-fill', color: 'text-danger' },
                'warning': { icon: 'bi-exclamation-triangle-fill', color: 'text-warning' },
                'info': { icon: 'bi-info-circle-fill', color: 'text-primary' }
            };
            
            const config = typeMap[type] || typeMap['info'];
            toastHeader.className = `${config.icon} ${config.color} me-2`;
            toastBody.textContent = message;
            
            new bootstrap.Toast(toast).show();
        }

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 檢查是否在 LINE 環境中
            if (typeof liff !== 'undefined') {
                initializeLiff();
            } else {
                // 開發環境模擬
                console.log('開發環境：模擬 LIFF');
                currentUser = {
                    userId: 'test_user_' + Date.now(),
                    displayName: '測試用戶',
                    pictureUrl: 'https://via.placeholder.com/80'
                };
                updateUserHeader();
                loadMemberInfo();
                initializePage();
            }
        });

        // 設定預設日期為今天
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value && input.name !== '生日') {
                    input.value = today;
                }
            });
        });
    </script>
</body>
</html>


