<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>個人資料</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
      body {
          font-family: 'Noto Sans TC', sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px 0;
      }
      .profile-container {
          max-width: 600px;
          margin: 0 auto;
      }
      .profile-card {
          background: white;
          border-radius: 20px;
          box-shadow: 0 15px 35px rgba(0,0,0,0.1);
          overflow: hidden;
          margin-bottom: 20px;
      }
      .profile-header {
          background: linear-gradient(135deg, #4a90e2, #2c5aa0);
          color: white;
          padding: 30px 25px;
          text-align: center;
          position: relative;
      }
      .profile-avatar {
          width: 100px;
          height: 100px;
          border-radius: 50%;
          border: 4px solid white;
          margin: 0 auto 15px;
          display: block;
          object-fit: cover;
      }
      .profile-name {
          font-size: 1.5rem;
          font-weight: bold;
          margin-bottom: 5px;
      }
      .profile-status {
          background: rgba(255,255,255,0.2);
          padding: 5px 15px;
          border-radius: 20px;
          display: inline-block;
          font-size: 0.9rem;
      }
      .profile-body {
          padding: 25px;
      }
      .info-section {
          margin-bottom: 25px;
      }
      .info-section h6 {
          color: #4a90e2;
          font-weight: bold;
          margin-bottom: 15px;
          border-bottom: 2px solid #e9ecef;
          padding-bottom: 8px;
      }
      .info-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 0;
          border-bottom: 1px solid #f8f9fa;
      }
      .info-item:last-child {
          border-bottom: none;
      }
      .info-label {
          font-weight: 600;
          color: #6c757d;
          display: flex;
          align-items: center;
      }
      .info-label i {
          margin-right: 8px;
          width: 16px;
      }
      .info-value {
          color: #495057;
          font-weight: 500;
      }
      .edit-form {
          display: none;
      }
      .form-floating {
          margin-bottom: 15px;
      }
      .form-floating .form-control, .form-floating .form-select {
          border-radius: 10px;
          border: 2px solid #e9ecef;
          transition: all 0.3s ease;
      }
      .form-floating .form-control:focus, .form-floating .form-select:focus {
          border-color: #4a90e2;
          box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
      }
      .btn-primary {
          background: linear-gradient(135deg, #4a90e2, #2c5aa0);
          border: none;
          border-radius: 10px;
          padding: 12px 25px;
          font-weight: 600;
          transition: all 0.3s ease;
      }
      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
      }
      .btn-outline-primary {
          border: 2px solid #4a90e2;
          color: #4a90e2;
          border-radius: 10px;
          padding: 12px 25px;
          font-weight: 600;
          transition: all 0.3s ease;
      }
      .btn-outline-primary:hover {
          background: #4a90e2;
          border-color: #4a90e2;
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
      }
      .stats-card {
          background: linear-gradient(135deg, #28a745, #20c997);
          color: white;
          border-radius: 15px;
          padding: 20px;
          text-align: center;
          margin-bottom: 15px;
      }
      .stats-number {
          font-size: 2rem;
          font-weight: bold;
          margin-bottom: 5px;
      }
      .stats-label {
          font-size: 0.9rem;
          opacity: 0.9;
      }
      .membership-card {
          background: linear-gradient(135deg, #ffc107, #e0a800);
          color: #212529;
          border-radius: 15px;
          padding: 20px;
          text-align: center;
          margin-bottom: 20px;
      }
      .membership-card.premium {
          background: linear-gradient(135deg, #dc3545, #c82333);
          color: white;
      }
      .loading-spinner {
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 40px;
      }
      .alert {
          border-radius: 10px;
          border: none;
      }
      .recent-activity {
          max-height: 300px;
          overflow-y: auto;
      }
      .activity-item {
          display: flex;
          align-items: center;
          padding: 12px 0;
          border-bottom: 1px solid #f8f9fa;
      }
      .activity-item:last-child {
          border-bottom: none;
      }
      .activity-icon {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-right: 15px;
          font-size: 1.2rem;
      }
      .activity-icon.donation {
          background: #d4edda;
          color: #155724;
      }
      .activity-icon.activity {
          background: #d1ecf1;
          color: #0c5460;
      }
      .activity-icon.membership {
          background: #fff3cd;
          color: #856404;
      }
      .activity-content {
          flex: 1;
      }
      .activity-title {
          font-weight: 600;
          margin-bottom: 2px;
      }
      .activity-time {
          font-size: 0.85rem;
          color: #6c757d;
      }
      .privacy-notice {
          background: #f8f9fa;
          border-radius: 10px;
          padding: 15px;
          margin-top: 20px;
          font-size: 0.9rem;
          color: #6c757d;
      }
      @media (max-width: 768px) {
          .profile-container {
              padding: 0 15px;
          }
          .profile-header {
              padding: 25px 20px;
          }
          .profile-body {
              padding: 20px;
          }
          .info-item {
              flex-direction: column;
              align-items: flex-start;
              gap: 5px;
          }
      }
  </style>
</head>
<body>
  <div class="profile-container">
      <!-- 載入中畫面 -->
      <div id="loadingScreen" class="profile-card">
          <div class="loading-spinner">
              <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">載入中...</span>
              </div>
          </div>
      </div>

      <!-- 個人資料卡片 -->
      <div id="profileCard" class="profile-card" style="display: none;">
          <div class="profile-header">
              <img id="userAvatar" src="" alt="用戶頭像" class="profile-avatar">
              <div class="profile-name" id="userName">載入中...</div>
              <div class="profile-status" id="userStatus">一般用戶</div>
          </div>
          
          <div class="profile-body">
              <!-- 會員狀態卡片 -->
              <div id="membershipStatus" class="membership-card">
                  <h6 class="mb-2">會員狀態</h6>
                  <div id="membershipInfo">載入中...</div>
              </div>

              <!-- 統計資訊 -->
              <div class="row mb-4">
                  <div class="col-6">
                      <div class="stats-card">
                          <div class="stats-number" id="totalDonations">0</div>
                          <div class="stats-label">累計捐款次數</div>
                      </div>
                  </div>
                  <div class="col-6">
                      <div class="stats-card" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                          <div class="stats-number" id="totalAmount">$0</div>
                          <div class="stats-label">累計捐款金額</div>
                      </div>
                  </div>
              </div>

              <!-- 基本資料顯示 -->
              <div id="profileView">
                  <div class="info-section">
                      <h6><i class="bi bi-person-circle me-2"></i>基本資料</h6>
                      <div class="info-item">
                          <div class="info-label">
                              <i class="bi bi-person"></i>真實姓名
                          </div>
                          <div class="info-value" id="displayRealName">未設定</div>
                      </div>
                      <div class="info-item">
                          <div class="info-label">
                              <i class="bi bi-telephone"></i>聯絡電話
                          </div>
                          <div class="info-value" id="displayPhone">未設定</div>
                      </div>
                      <div class="info-item">
                          <div class="info-label">
                              <i class="bi bi-envelope"></i>電子郵件
                          </div>
                          <div class="info-value" id="displayEmail">未設定</div>
                      </div>
                      <div class="info-item">
                          <div class="info-label">
                              <i class="bi bi-geo-alt"></i>聯絡地址
                          </div>
                          <div class="info-value" id="displayAddress">未設定</div>
                      </div>
                      <div class="info-item">
                          <div class="info-label">
                              <i class="bi bi-calendar"></i>生日
                          </div>
                          <div class="info-value" id="displayBirthday">未設定</div>
                      </div>
                      <div class="info-item">
                          <div class="info-label">
                              <i class="bi bi-person-badge"></i>身分證字號
                          </div>
                          <div class="info-value" id="displayIdNumber">未設定</div>
                      </div>
                  </div>

                  <div class="info-section">
                      <h6><i class="bi bi-heart me-2"></i>關懷資訊</h6>
                      <div class="info-item">
                          <div class="info-label">
                              <i class="bi bi-person-check"></i>是否為患者
                          </div>
                          <div class="info-value" id="displayIsPatient">未設定</div>
                      </div>
                      <div class="info-item">
                          <div class="info-label">
                              <i class="bi bi-people"></i>關係
                          </div>
                          <div class="info-value" id="displayRelationship">未設定</div>
                      </div>
                      <div class="info-item">
                          <div class="info-label">
                              <i class="bi bi-calendar-event"></i>確診時間
                          </div>
                          <div class="info-value" id="displayDiagnosisDate">未設定</div>
                      </div>
                      <div class="info-item">
                          <div class="info-label">
                              <i class="bi bi-person-hearts"></i>緊急聯絡人
                          </div>
                          <div class="info-value" id="displayEmergencyContact">未設定</div>
                      </div>
                      <div class="info-item">
                          <div class="info-label">
                              <i class="bi bi-telephone-plus"></i>緊急聯絡電話
                          </div>
                          <div class="info-value" id="displayEmergencyPhone">未設定</div>
                      </div>
                  </div>

                  <div class="info-section">
                      <h6><i class="bi bi-clock-history me-2"></i>帳戶資訊</h6>
                      <div class="info-item">
                          <div class="info-label">
                              <i class="bi bi-calendar-plus"></i>加入日期
                          </div>
                          <div class="info-value" id="displayJoinDate">載入中...</div>
                      </div>
                      <div class="info-item">
                          <div class="info-label">
                              <i class="bi bi-clock"></i>最後更新
                          </div>
                          <div class="info-value" id="displayLastUpdate">載入中...</div>
                      </div>
                      <div class="info-item">
                          <div class="info-label">
                              <i class="bi bi-cash-coin"></i>最後捐款
                          </div>
                          <div class="info-value" id="displayLastDonation">無記錄</div>
                      </div>
                  </div>

                  <div class="d-grid gap-2">
                      <button class="btn btn-primary" onclick="showEditForm()">
                          <i class="bi bi-pencil-square me-2"></i>編輯個人資料
                      </button>
                  </div>
              </div>

              <!-- 編輯表單 -->
              <div id="editForm" class="edit-form">
                  <form id="profileForm">
                      <div class="info-section">
                          <h6><i class="bi bi-person-circle me-2"></i>基本資料</h6>
                          <div class="form-floating">
                              <input type="text" class="form-control" id="realName" placeholder="真實姓名" required>
                              <label for="realName">真實姓名 *</label>
                          </div>
                          <div class="form-floating">
                              <input type="tel" class="form-control" id="phone" placeholder="聯絡電話" required>
                              <label for="phone">聯絡電話 *</label>
                          </div>
                          <div class="form-floating">
                              <input type="email" class="form-control" id="email" placeholder="電子郵件">
                              <label for="email">電子郵件</label>
                          </div>
                          <div class="form-floating">
                              <textarea class="form-control" id="address" placeholder="聯絡地址" style="height: 80px;"></textarea>
                              <label for="address">聯絡地址</label>
                          </div>
                          <div class="form-floating">
                              <input type="date" class="form-control" id="birthday" placeholder="生日">
                              <label for="birthday">生日</label>
                          </div>
                          <div class="form-floating">
                              <input type="text" class="form-control" id="idNumber" placeholder="身分證字號" pattern="[A-Z][1-2][0-9]{8}">
                              <label for="idNumber">身分證字號</label>
                              <div class="form-text">格式：A123456789</div>
                          </div>
                      </div>

                      <div class="info-section">
                          <h6><i class="bi bi-heart me-2"></i>關懷資訊</h6>
                          <div class="form-floating">
                              <select class="form-select" id="isPatient">
                                  <option value="">請選擇</option>
                                  <option value="是">是</option>
                                  <option value="否">否</option>
                              </select>
                              <label for="isPatient">是否為帕金森病患者</label>
                          </div>
                          <div class="form-floating">
                              <select class="form-select" id="relationship">
                                  <option value="">請選擇</option>
                                  <option value="患者本人">患者本人</option>
                                  <option value="配偶">配偶</option>
                                  <option value="子女">子女</option>
                                  <option value="父母">父母</option>
                                  <option value="兄弟姊妹">兄弟姊妹</option>
                                  <option value="朋友">朋友</option>
                                  <option value="照護者">照護者</option>
                                  <option value="其他">其他</option>
                              </select>
                              <label for="relationship">與患者關係</label>
                          </div>
                          <div class="form-floating">
                              <input type="date" class="form-control" id="diagnosisDate" placeholder="確診時間">
                              <label for="diagnosisDate">確診時間（如適用）</label>
                          </div>
                          <div class="form-floating">
                              <input type="text" class="form-control" id="emergencyContact" placeholder="緊急聯絡人">
                              <label for="emergencyContact">緊急聯絡人</label>
                          </div>
                          <div class="form-floating">
                              <input type="tel" class="form-control" id="emergencyPhone" placeholder="緊急聯絡電話">
                              <label for="emergencyPhone">緊急聯絡電話</label>
                          </div>
                      </div>

                      <div class="d-grid gap-2">
                          <button type="submit" class="btn btn-primary">
                              <i class="bi bi-check-circle me-2"></i>儲存變更
                          </button>
                          <button type="button" class="btn btn-outline-primary" onclick="hideEditForm()">
                              <i class="bi bi-x-circle me-2"></i>取消編輯
                          </button>
                      </div>
                  </form>
              </div>
          </div>
      </div>

      <!-- 最近活動記錄 -->
      <div id="activityCard" class="profile-card" style="display: none;">
          <div class="profile-body">
              <div class="info-section">
                  <h6><i class="bi bi-activity me-2"></i>最近活動記錄</h6>
                  <div id="recentActivity" class="recent-activity">
                      <div class="text-center p-4">
                          <div class="spinner-border spinner-border-sm" role="status"></div>
                          <div class="mt-2">載入中...</div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- 隱私聲明 -->
      <div class="privacy-notice">
          <i class="bi bi-shield-check me-2"></i>
          您的個人資料將依據個人資料保護法進行保護，僅用於協會服務及相關活動通知。
          如有任何疑問，請聯絡協會。
      </div>
  </div>

  <!-- 成功提示模態框 -->
  <div class="modal fade" id="successModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-body text-center p-4">
                  <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                  <h5 class="mt-3">資料更新成功！</h5>
                  <p class="text-muted">您的個人資料已成功更新</p>
                  <button type="button" class="btn btn-success" data-bs-dismiss="modal">確定</button>
              </div>
          </div>
      </div>
  </div>

  <!-- 錯誤提示模態框 -->
  <div class="modal fade" id="errorModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-body text-center p-4">
                  <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 3rem;"></i>
                  <h5 class="mt-3">發生錯誤</h5>
                  <p class="text-muted" id="errorMessage">請稍後再試</p>
                  <button type="button" class="btn btn-danger" data-bs-dismiss="modal">確定</button>
              </div>
          </div>
      </div>
  </div>

  <script>
      let userId = null;
      let userProfile = null;
      let userInfo = null;
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbw7b7rE_WXTceJMorsvONFV_yzKbdKqq_dTQD751f9q2BuyrTzS4_WFTgT8neSkiSeF/exec';

      // 初始化 LIFF
      liff.init({ liffId: '1656516134-VaGgmaPm' }).then(() => {
          if (!liff.isLoggedIn()) {
              liff.login();
              return;
          }
          
          liff.getProfile().then(profile => {
              userProfile = profile;
              userId = profile.userId;
              loadUserData();
          }).catch(err => {
              console.error('取得用戶資料失敗:', err);
              showError('無法取得用戶資料');
          });
      }).catch(err => {
          console.error('LIFF初始化失敗:', err);
          showError('系統初始化失敗，請重新開啟');
      });

// 修正前端的 fetch 請求函數
// 請將這些函數替換到您的 HTML 檔案中

// 修正後的載入用戶資料函數
async function loadUserData() {
  try {
      // 顯示基本 LINE 資料
      document.getElementById('userAvatar').src = userProfile.pictureUrl || 'https://via.placeholder.com/100';
      document.getElementById('userName').textContent = userProfile.displayName;

      // 使用 GET 方式請求，避免 CORS preflight
      const url = `${GAS_URL}?action=getUserInfo&userId=${encodeURIComponent(userId)}&origin=${encodeURIComponent(window.location.origin)}&_t=${Date.now()}`;
      
      console.log('請求 URL:', url);
      
      const response = await fetch(url, {
          method: 'GET',
          headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
          }
      });
      
      console.log('回應狀態:', response.status);
      
      if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('收到資料:', data);
      
      if (data.success && data.data && data.data.userInfo) {
          userInfo = data.data.userInfo;
      } else {
          // 新用戶或載入失敗，使用預設資料
          userInfo = data.data?.userInfo || {
              LINE名稱: userProfile.displayName,
              用戶ID: userId,
              是否會員: false,
              加入日期: new Date().toISOString(),
              捐款次數: 0,
              捐款總額: 0,
              真實姓名: '',
              電話: '',
              電子郵件: '',
              地址: '',
              生日: '',
              身分證字號: '',
              是否患者: '',
              與患者關係: '',
              確診時間: '',
              緊急聯絡人: '',
              緊急聯絡電話: '',
              最後更新時間: '',
              最後捐款日期: ''
          };
      }
      
      displayUserInfo();
      loadRecentActivity();
      
      // 隱藏載入畫面，顯示個人資料
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('profileCard').style.display = 'block';
      document.getElementById('activityCard').style.display = 'block';
      
  } catch (error) {
      console.error('載入用戶資料失敗:', error);
      showError('載入資料失敗：' + error.message + '。請檢查網路連線或重新整理頁面。');
      
      // 即使失敗也顯示基本介面
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('profileCard').style.display = 'block';
  }
}

// 修正後的表單提交處理
document.getElementById('profileForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>儲存中...';
  submitBtn.disabled = true;
  
  try {
      // 收集表單資料
      const formData = {
          action: 'updateUserProfile',
          userId: userId,
          真實姓名: document.getElementById('realName').value,
          電話: document.getElementById('phone').value,
          電子郵件: document.getElementById('email').value,
          地址: document.getElementById('address').value,
          生日: document.getElementById('birthday').value,
          身分證字號: document.getElementById('idNumber').value,
          是否患者: document.getElementById('isPatient').value,
          與患者關係: document.getElementById('relationship').value,
          確診時間: document.getElementById('diagnosisDate').value,
          緊急聯絡人: document.getElementById('emergencyContact').value,
          緊急聯絡電話: document.getElementById('emergencyPhone').value,
          最後更新時間: new Date().toISOString()
      };
      
      console.log('提交資料:', formData);
      
      // 使用 POST 請求
      const response = await fetch(GAS_URL, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
          },
          body: JSON.stringify(formData)
      });
      
      console.log('提交回應狀態:', response.status);
      
      if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      console.log('提交結果:', result);
      
      if (result.success) {
          // 更新本地資料
          Object.assign(userInfo, formData);
          
          // 重新顯示資料
          displayUserInfo();
          hideEditForm();
          
          // 顯示成功訊息
          showSuccess();
          
      } else {
          throw new Error(result.message || '更新失敗');
      }
      
  } catch (error) {
      console.error('更新個人資料失敗:', error);
      showError('更新失敗：' + error.message + '。請檢查網路連線後重試。');
  } finally {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
  }
});

// 修正後的載入最近活動記錄函數
async function loadRecentActivity() {
  try {
      const url = `${GAS_URL}?action=getUserActivity&userId=${encodeURIComponent(userId)}&origin=${encodeURIComponent(window.location.origin)}&_t=${Date.now()}`;
      
      const response = await fetch(url, {
          method: 'GET',
          headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
          }
      });
      
      if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const activities = await response.json();
      
      const activityContainer = document.getElementById('recentActivity');
      
      if (!activities.success || !activities.data || activities.data.length === 0) {
          activityContainer.innerHTML = `
              <div class="text-center p-4 text-muted">
                  <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                  <div class="mt-2">暫無活動記錄</div>
              </div>
          `;
          return;
      }
      
      activityContainer.innerHTML = activities.data.map(activity => {
          const iconClass = getActivityIcon(activity.類型);
          const iconBg = getActivityIconBg(activity.類型);
          
          return `
              <div class="activity-item">
                  <div class="activity-icon ${iconBg}">
                      <i class="bi ${iconClass}"></i>
                  </div>
                  <div class="activity-content">
                      <div class="activity-title">${activity.標題}</div>
                      <div class="activity-time">${formatDateTime(activity.時間)}</div>
                  </div>
              </div>
          `;
      }).join('');
      
  } catch (error) {
      console.error('載入活動記錄失敗:', error);
      document.getElementById('recentActivity').innerHTML = `
          <div class="text-center p-4 text-danger">
              <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
              <div class="mt-2">載入失敗</div>
          </div>
      `;
  }
}

// 連線測試函數
async function testConnection() {
  try {
      const url = `${GAS_URL}?action=test&_t=${Date.now()}`;
      const response = await fetch(url);
      const result = await response.json();
      console.log('連線測試結果:', result);
      return result.success;
  } catch (error) {
      console.error('連線測試失敗:', error);
      return false;
  }
}


      

     

      // 顯示用戶資訊
      function displayUserInfo() {
          // 確保 userInfo 存在
          if (!userInfo) {
              console.error('userInfo 未定義');
              return;
          }

          // 會員狀態
          const membershipCard = document.getElementById('membershipStatus');
          const membershipInfo = document.getElementById('membershipInfo');
          
          if (userInfo.是否會員) {
              membershipCard.classList.add('premium');
              membershipInfo.innerHTML = `
                  <i class="bi bi-star-fill me-2"></i>正式會員
                  <div class="mt-1" style="font-size: 0.9rem;">
                      會員編號：${userInfo.會員編號 || 'M' + userId.substring(0, 8)}
                  </div>
              `;
              document.getElementById('userStatus').textContent = '正式會員';
          } else {
              membershipCard.classList.remove('premium');
              membershipInfo.innerHTML = `
                  <i class="bi bi-person me-2"></i>一般用戶
                  <div class="mt-1" style="font-size: 0.9rem;">
                      歡迎加入我們的大家庭
                  </div>
              `;
          }

          // 統計資訊
          document.getElementById('totalDonations').textContent = userInfo.捐款次數 || 0;
          document.getElementById('totalAmount').textContent = `$${(userInfo.捐款總額 || 0).toLocaleString()}`;

          // 基本資料
          document.getElementById('displayRealName').textContent = userInfo.真實姓名 || '未設定';
          document.getElementById('displayPhone').textContent = userInfo.電話 || '未設定';
          document.getElementById('displayEmail').textContent = userInfo.電子郵件 || '未設定';
          document.getElementById('displayAddress').textContent = userInfo.地址 || '未設定';
          document.getElementById('displayBirthday').textContent = userInfo.生日 ? formatDate(userInfo.生日) : '未設定';
          document.getElementById('displayIdNumber').textContent = userInfo.身分證字號 ? maskIdNumber(userInfo.身分證字號) : '未設定';

          // 關懷資訊
          document.getElementById('displayIsPatient').textContent = userInfo.是否患者 || '未設定';
          document.getElementById('displayRelationship').textContent = userInfo.與患者關係 || '未設定';
          document.getElementById('displayDiagnosisDate').textContent = userInfo.確診時間 ? formatDate(userInfo.確診時間) : '未設定';
          document.getElementById('displayEmergencyContact').textContent = userInfo.緊急聯絡人 || '未設定';
          document.getElementById('displayEmergencyPhone').textContent = userInfo.緊急聯絡電話 || '未設定';

          // 帳戶資訊
          document.getElementById('displayJoinDate').textContent = formatDate(userInfo.加入日期);
          document.getElementById('displayLastUpdate').textContent = userInfo.最後更新時間 ? formatDate(userInfo.最後更新時間) : '從未更新';
          document.getElementById('displayLastDonation').textContent = userInfo.最後捐款日期 ? formatDate(userInfo.最後捐款日期) : '無記錄';
      }

      

      // 顯示編輯表單
      function showEditForm() {
          // 填入現有資料到表單
          document.getElementById('realName').value = userInfo.真實姓名 || '';
          document.getElementById('phone').value = userInfo.電話 || '';
          document.getElementById('email').value = userInfo.電子郵件 || '';
          document.getElementById('address').value = userInfo.地址 || '';
          document.getElementById('birthday').value = userInfo.生日 || '';
          document.getElementById('idNumber').value = userInfo.身分證字號 || '';
          document.getElementById('isPatient').value = userInfo.是否患者 || '';
          document.getElementById('relationship').value = userInfo.與患者關係 || '';
          document.getElementById('diagnosisDate').value = userInfo.確診時間 || '';
          document.getElementById('emergencyContact').value = userInfo.緊急聯絡人 || '';
          document.getElementById('emergencyPhone').value = userInfo.緊急聯絡電話 || '';

          // 切換顯示
          document.getElementById('profileView').style.display = 'none';
          document.getElementById('editForm').style.display = 'block';
          
          // 滾動到表單頂部
          document.getElementById('editForm').scrollIntoView({ behavior: 'smooth' });
      }

      // 隱藏編輯表單
      function hideEditForm() {
          document.getElementById('editForm').style.display = 'none';
          document.getElementById('profileView').style.display = 'block';
      }

      // 表單提交處理
      document.getElementById('profileForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>儲存中...';
          submitBtn.disabled = true;
          
          try {
              // 收集表單資料
              const formData = {
                  action: 'updateUserProfile',
                  userId: userId,
                  真實姓名: document.getElementById('realName').value,
                  電話: document.getElementById('phone').value,
                  電子郵件: document.getElementById('email').value,
                  地址: document.getElementById('address').value,
                  生日: document.getElementById('birthday').value,
                  身分證字號: document.getElementById('idNumber').value,
                  是否患者: document.getElementById('isPatient').value,
                  與患者關係: document.getElementById('relationship').value,
                  確診時間: document.getElementById('diagnosisDate').value,
                  緊急聯絡人: document.getElementById('emergencyContact').value,
                  緊急聯絡電話: document.getElementById('emergencyPhone').value,
                  最後更新時間: new Date().toISOString()
              };
              
              // 發送到後端
              const response = await fetch(GAS_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(formData)
              });
              
              const result = await response.json();
              
              if (result.success) {
                  // 更新本地資料
                  Object.assign(userInfo, formData);
                  
                  // 重新顯示資料
                  displayUserInfo();
                  hideEditForm();
                  
                  // 顯示成功訊息
                  showSuccess();
                  
              } else {
                  throw new Error(result.message || '更新失敗');
              }
              
          } catch (error) {
              console.error('更新個人資料失敗:', error);
              showError(error.message || '更新失敗，請稍後再試');
          } finally {
              submitBtn.innerHTML = originalText;
              submitBtn.disabled = false;
          }
      });

      // 工具函數
      function formatDate(dateString) {
          if (!dateString) return '';
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
          });
      }

      function formatDateTime(dateString) {
          if (!dateString) return '';
          const date = new Date(dateString);
          return date.toLocaleString('zh-TW', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
          });
      }

      function maskIdNumber(idNumber) {
          if (!idNumber || idNumber.length < 4) return idNumber;
          return idNumber.substring(0, 2) + '****' + idNumber.substring(idNumber.length - 2);
      }

      function getActivityIcon(type) {
          switch(type) {
              case '捐款': return 'bi-heart-fill';
              case '活動報名': return 'bi-calendar-check';
              case '會員申請': return 'bi-person-plus';
              case '資料更新': return 'bi-pencil-square';
              default: return 'bi-circle-fill';
          }
      }

      function getActivityIconBg(type) {
          switch(type) {
              case '捐款': return 'donation';
              case '活動報名': return 'activity';
              case '會員申請': return 'membership';
              case '資料更新': return 'activity';
              default: return 'activity';
          }
      }

      function showSuccess() {
          const modal = new bootstrap.Modal(document.getElementById('successModal'));
          modal.show();
      }

      function showError(message = '發生錯誤，請稍後再試') {
          document.getElementById('errorMessage').textContent = message;
          const modal = new bootstrap.Modal(document.getElementById('errorModal'));
          modal.show();
      }

      // 表單驗證
      function validateForm() {
          const form = document.getElementById('profileForm');
          const requiredFields = form.querySelectorAll('[required]');
          let isValid = true;
          
          requiredFields.forEach(field => {
              if (!field.value.trim()) {
                  field.classList.add('is-invalid');
                  isValid = false;
              } else {
                  field.classList.remove('is-invalid');
              }
          });
          
          // 驗證身分證字號格式
          const idNumber = document.getElementById('idNumber').value;
          if (idNumber && !/^[A-Z][1-2][0-9]{8}$/.test(idNumber)) {
              document.getElementById('idNumber').classList.add('is-invalid');
              isValid = false;
          }
          
          // 驗證電話號碼格式
          const phone = document.getElementById('phone').value;
          if (phone && !/^[0-9-+().\s]+$/.test(phone)) {
              document.getElementById('phone').classList.add('is-invalid');
              isValid = false;
          }
          
          // 驗證電子郵件格式
          const email = document.getElementById('email').value;
          if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
              document.getElementById('email').classList.add('is-invalid');
              isValid = false;
          }
          
          return isValid;
      }

      // 即時驗證
      document.getElementById('profileForm').addEventListener('input', (e) => {
          const field = e.target;
          
          // 移除錯誤樣式
          field.classList.remove('is-invalid');
          
          // 特定欄位驗證
          switch(field.id) {
              case 'idNumber':
                  if (field.value && !/^[A-Z][1-2][0-9]{8}$/.test(field.value)) {
                      field.classList.add('is-invalid');
                  }
                  break;
              case 'phone':
              case 'emergencyPhone':
                  if (field.value && !/^[0-9-+().\s]+$/.test(field.value)) {
                      field.classList.add('is-invalid');
                  }
                  break;
              case 'email':
                  if (field.value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(field.value)) {
                      field.classList.add('is-invalid');
                  }
                  break;
          }
      });

      // 自動格式化身分證字號
      document.getElementById('idNumber').addEventListener('input', (e) => {
          e.target.value = e.target.value.toUpperCase();
      });

      // 自動格式化電話號碼
      document.getElementById('phone').addEventListener('input', (e) => {
          let value = e.target.value.replace(/[^0-9]/g, '');
          if (value.length >= 3) {
              if (value.startsWith('09')) {
                  // 手機號碼格式：0912-345-678
                  value = value.replace(/(\d{4})(\d{3})(\d{3})/, '$1-$2-$3');
              } else if (value.startsWith('0')) {
                  // 市話格式：02-1234-5678
                  if (value.length >= 9) {
                      value = value.replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3');
                  } else if (value.length >= 6) {
                      value = value.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
                  }
              }
          }
          e.target.value = value;
      });

      // 緊急聯絡電話格式化
      document.getElementById('emergencyPhone').addEventListener('input', (e) => {
          let value = e.target.value.replace(/[^0-9]/g, '');
          if (value.length >= 3) {
              if (value.startsWith('09')) {
                  value = value.replace(/(\d{4})(\d{3})(\d{3})/, '$1-$2-$3');
              } else if (value.startsWith('0')) {
                  if (value.length >= 9) {
                      value = value.replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3');
                  } else if (value.length >= 6) {
                      value = value.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
                  }
              }
          }
          e.target.value = value;
      });

      // 頁面離開確認
      window.addEventListener('beforeunload', (e) => {
          if (document.getElementById('editForm').style.display !== 'none') {
              e.preventDefault();
              e.returnValue = '您有未儲存的變更，確定要離開嗎？';
          }
      });

      // 下拉重新整理
      let startY = 0;
      let pullDistance = 0;
      const pullThreshold = 100;

      document.addEventListener('touchstart', (e) => {
          if (window.scrollY === 0) {
              startY = e.touches[0].pageY;
          }
      });

      document.addEventListener('touchmove', (e) => {
          if (window.scrollY === 0 && startY > 0) {
              pullDistance = e.touches[0].pageY - startY;
              if (pullDistance > 0 && pullDistance < pullThreshold) {
                  e.preventDefault();
                  document.body.style.transform = `translateY(${pullDistance / 3}px)`;
              }
          }
      });

      document.addEventListener('touchend', () => {
          if (pullDistance > pullThreshold) {
              location.reload();
          } else {
              document.body.style.transform = '';
          }
          startY = 0;
          pullDistance = 0;
      });

      // 鍵盤快捷鍵
      document.addEventListener('keydown', (e) => {
          if (e.ctrlKey || e.metaKey) {
              switch(e.key) {
                  case 'e':
                      e.preventDefault();
                      if (document.getElementById('editForm').style.display === 'none') {
                          showEditForm();
                      }
                      break;
                  case 's':
                      e.preventDefault();
                      if (document.getElementById('editForm').style.display !== 'none') {
                          document.getElementById('profileForm').dispatchEvent(new Event('submit'));
                      }
                      break;
                  case 'Escape':
                      if (document.getElementById('editForm').style.display !== 'none') {
                          hideEditForm();
                      }
                      break;
              }
          }
      });

      // 錯誤處理
      window.addEventListener('error', (e) => {
          console.error('JavaScript錯誤:', e.error);
          showError('系統發生錯誤，請重新整理頁面');
      });

      // 網路狀態監控
      window.addEventListener('online', () => {
          // 網路恢復時重新載入資料
          if (userId) {
              loadUserData();
          }
      });

      window.addEventListener('offline', () => {
          showError('網路連線中斷，部分功能可能無法使用');
      });
  </script>
</body>
</html>
