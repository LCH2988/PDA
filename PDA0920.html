<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>台灣帕金森病友權益促進會</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
:root {
  --primary-color:#2E86C1;
  --secondary-color:#85C1E9;
  --success-color:#28a745;
  --warning-color:#ffc107;
  --danger-color:#dc3545;
  --info-color:#17a2b8;
  --light-color:#f8f9fa;
  --dark-color:#343a40;
}
body { background:#f5f7fa; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto; }
.navbar { background:linear-gradient(135deg,var(--primary-color),var(--secondary-color)); }
.navbar-brand,.nav-link { color:#fff!important; }
.card { border:none; border-radius:16px; box-shadow:0 4px 18px rgba(0,0,0,0.07); }
.card-header { background:linear-gradient(135deg,var(--primary-color),var(--secondary-color)); color:#fff; border-radius:16px 16px 0 0!important; }
.stat-card { background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; padding:18px; border-radius:16px; text-align:center; }
.stat-number { font-size:2.1rem; font-weight:600; }
.status-badge { padding:4px 12px; border-radius:12px; font-size:.75rem; font-weight:600; }
.status-active { background:var(--success-color); color:#fff; }
.status-pending { background:var(--warning-color); color:#222; }
.status-completed { background:var(--info-color); color:#fff; }
.page-section { display:none; animation:fade .35s ease; }
.page-section.active { display:block; }
@keyframes fade { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
.donation-amount { border:2px solid #e1e6ef; background:#fff; padding:12px; border-radius:12px; cursor:pointer; text-align:center; font-weight:600; transition:.25s; }
.donation-amount:hover,.donation-amount.selected { border-color:var(--primary-color); background:#eaf4fb; }
.alert-floating { position:fixed; top:20px; right:20px; z-index:9999; min-width:280px; }
.activity-card { border-left:5px solid var(--primary-color); }
.activity-card:hover { border-left-color:var(--success-color); }
.loading { text-align:center; padding:40px; }
.loading i { font-size:2.8rem; animation:spin 1s linear infinite; color:var(--primary-color); }
@keyframes spin { to { transform:rotate(360deg);} }
.footer { background:#111; color:#ccc; padding:24px 0; text-align:center; margin-top:60px; }
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg">
  <div class="container">
    <a class="navbar-brand" href="#" onclick="showSection('dashboard')"><i class="fas fa-heart"></i> 台灣帕金森病友權益促進會</a>
    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('dashboard')"><i class="fas fa-home"></i> 首頁</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('profile')"><i class="fas fa-user"></i> 個人資料</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('activities')"><i class="fas fa-calendar"></i> 活動</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('donations')"><i class="fas fa-donate"></i> 捐款</a></li>
      </ul>
    </div>
  </div>
</nav>

<div id="loading" class="loading">
  <i class="fas fa-spinner"></i>
  <p class="mt-3">系統載入中...</p>
</div>

<div id="main-content" class="container mt-4" style="display:none;">
  <!-- Dashboard -->
  <div id="dashboard" class="page-section active">
    <div class="row g-3">
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-number" id="memberStatus">--</div>
          <div class="small">會員狀態</div>
          <div class="mt-2">
            <button class="btn btn-sm btn-light" id="becomeMemberBtn" style="display:none;" onclick="becomeMember()">成為會員</button>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3"><div class="stat-card"><div class="stat-number" id="donationCount">0</div><div class="small">捐款次數</div></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><div class="stat-number" id="donationTotal">$0</div><div class="small">捐款總額</div></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><div class="stat-number" id="activityCount">0</div><div class="small">參與活動</div></div></div>
    </div>

    <div class="row mt-3">
      <div class="col-md-6">
        <div class="card mb-3">
          <div class="card-header"><i class="fas fa-history"></i> 最近活動</div>
          <div class="card-body" id="recentActivities"><p class="text-muted mb-0">載入中...</p></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card mb-3">
          <div class="card-header"><i class="fas fa-calendar-check"></i> 即將到來</div>
            <div class="card-body" id="upcomingActivities"><p class="text-muted mb-0">載入中...</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile -->
  <div id="profile" class="page-section">
    <div class="card">
      <div class="card-header"><i class="fas fa-user-edit"></i> 個人資料</div>
      <div class="card-body">
        <form id="profileForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">真實姓名 *</label>
              <input id="realName" type="text" class="form-control" required/>
            </div>
            <div class="col-md-6">
              <label class="form-label">聯絡電話 *</label>
              <input id="phone" type="tel" class="form-control" required/>
            </div>
            <div class="col-md-6">
              <label class="form-label">電子郵件</label>
              <input id="email" type="email" class="form-control"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">生日</label>
              <input id="birthday" type="date" class="form-control"/>
            </div>
            <div class="col-md-12">
              <label class="form-label">地址</label>
              <textarea id="address" rows="2" class="form-control"></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">是否為患者</label>
              <select id="isPatient" class="form-select">
                <option value="">請選擇</option>
                <option value="是">是</option>
                <option value="否">否</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">與患者關係</label>
              <select id="relationship" class="form-select">
                <option value="">請選擇</option>
                <option value="患者本人">患者本人</option>
                <option value="配偶">配偶</option>
                <option value="子女">子女</option>
                <option value="父母">父母</option>
                <option value="兄弟姊妹">兄弟姊妹</option>
                <option value="朋友">朋友</option>
                <option value="照護者">照護者</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">緊急聯絡人</label>
              <input id="emergencyContact" type="text" class="form-control"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">緊急聯絡電話</label>
              <input id="emergencyPhone" type="tel" class="form-control"/>
            </div>
          </div>
          <div class="text-center mt-4">
            <button class="btn btn-primary px-4" type="submit"><i class="fas fa-save"></i> 儲存</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Activities -->
  <div id="activities" class="page-section">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-calendar-alt"></i> 活動列表</span>
        <select id="activityFilter" class="form-select form-select-sm" style="width:auto;" onchange="filterActivities()">
          <option value="all">全部</option>
          <option value="報名中">報名中</option>
          <option value="進行中">進行中</option>
          <option value="已結束">已結束</option>
        </select>
      </div>
      <div class="card-body" id="activitiesList"><p class="text-muted mb-0">載入中...</p></div>
    </div>
  </div>

  <!-- Donations -->
  <div id="donations" class="page-section">
    <div class="row">
      <div class="col-lg-6">
        <div class="card mb-3">
          <div class="card-header"><i class="fas fa-hand-holding-heart"></i> 愛心捐款</div>
          <div class="card-body">
            <form id="donationForm">
              <div class="mb-3">
                <label class="form-label">快速選擇金額</label>
                <div class="row g-2">
                  [500,1000,2000,5000,10000].map
                </div>
                <div class="row g-2">
                  <div class="col-4 col-md-3">
                    <div class="donation-amount" onclick="selectCustomAmount(this)">自訂</div>
                  </div>
                </div>
                <input id="donationAmount" type="number" class="form-control mt-2" min="1" placeholder="輸入捐款金額" required/>
              </div>
              <div class="mb-3">
                <label class="form-label">捐款類型</label>
                <select id="donationType" class="form-select" required>
                  <option value="">請選擇</option>
                  <option value="一般捐款">一般捐款</option>
                  <option value="醫療補助">醫療補助</option>
                  <option value="研究贊助">研究贊助</option>
                  <option value="活動贊助">活動贊助</option>
                  <option value="設備購置">設備購置</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">付款方式</label>
                <select id="paymentMethod" class="form-select" required>
                  <option value="">請選擇</option>
                  <option value="線上轉帳">線上轉帳</option>
                  <option value="ATM轉帳">ATM轉帳</option>
                  <option value="信用卡">信用卡</option>
                  <option value="現金">現金</option>
                  <option value="支票">支票</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">備註</label>
                <textarea id="donationNote" rows="2" class="form-control" placeholder="感謝您的支持"></textarea>
              </div>
              <div class="text-center">
                <button class="btn btn-primary btn-lg" type="submit"><i class="fas fa-heart"></i> 確認捐款</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card mb-3">
          <div class="card-header"><i class="fas fa-history"></i> 我的捐款記錄</div>
          <div class="card-body" id="donationHistory"><p class="text-muted mb-0">載入中...</p></div>
        </div>
        <div class="card">
          <div class="card-header"><i class="fas fa-info-circle"></i> 捐款資訊</div>
          <div class="card-body">
            <div class="alert alert-info small">
              <strong>銀行轉帳資訊</strong><br/>
              銀行：台灣銀行<br/>
              戶名：台灣帕金森病友權益促進會<br/>
              帳號：123-456-789012<br/>
              <span class="text-muted">轉帳後請於此登記金額</span>
            </div>
            <div class="alert alert-success small">
              捐款滿 $500 可開立收據供報稅使用。<br/>
              感謝您的愛心！
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- 活動詳情 Modal -->
<div class="modal fade" id="activityModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="activityModalTitle">活動詳情</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="activityModalBody"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
        <button class="btn btn-primary" id="registerActivityBtn" onclick="registerActivity()">報名活動</button>
      </div>
    </div>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p class="mb-1">&copy; 2024 台灣帕金森病友權益促進會</p>
    <p class="small mb-0"><i class="fas fa-phone"></i> (02) 1234-5678 | <i class="fas fa-envelope"></i> info@parkinson.org.tw</p>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const CONFIG = {
  LIFF_ID: '1656516134-VaGgmaPm',
  API_URL: 'https://script.google.com/macros/s/AKfycbw3zrlIiegHXGNNYbmNtJVSKUP2c3Uo1p-IHzh6PPS_CBAEo7wveMAbvGz5JyIeDKrkSw/exec'
};

let userProfile = null;
let currentUser = null;
let selectedActivityId = null;

// -------- API 呼叫 ----------
async function apiCall(action, method='GET', data={}) {
  let url = CONFIG.API_URL;
  const options = { method, headers:{'Content-Type':'application/json'} };
  if (method === 'GET') {
    const params = new URLSearchParams({ action, ...data });
    url += '?' + params.toString();
  } else {
    options.body = JSON.stringify({ action, ...data });
  }
  const res = await fetch(url, options);
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const json = await res.json();
  if (!json.success) throw new Error(json.message || '操作失敗');
  return json.data;
}

// -------- 初始化 LIFF ----------
document.addEventListener('DOMContentLoaded', () => {
  initLiff();
  bindForms();
});

async function initLiff() {
  try {
    await liff.init({ liffId: CONFIG.LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    userProfile = await liff.getProfile();
    await loadUserData();
    showMainContent();
    loadDashboard();
  } catch (e) {
    showError('LIFF 初始化失敗: ' + e.message);
    console.error(e);
  }
}

function showMainContent() {
  document.getElementById('loading').style.display='none';
  document.getElementById('main-content').style.display='block';
}

// -------- 用戶資料 ----------
async function loadUserData() {
  try {
    const d = await apiCall('getUserInfo','GET',{ userId: userProfile.userId });
    currentUser = d.userInfo;
    updateDashboardStats();
  } catch (e) {
    currentUser = {
      用戶ID: userProfile.userId,
      LINE名稱: userProfile.displayName,
      是否會員: '否',
      捐款次數: 0,
      捐款總額: 0
    };
  }
  toggleBecomeMemberButton();
}

function toggleBecomeMemberButton() {
  const btn = document.getElementById('becomeMemberBtn');
  if (!currentUser) return;
  if (currentUser['是否會員'] === '是') btn.style.display='none';
  else btn.style.display='inline-block';
}

async function becomeMember() {
  try {
    await apiCall('becomeMember','POST',{ userId: userProfile.userId });
    showSuccess('會員申請成功！');
    await loadUserData();
  } catch (e) {
    showError('會員申請失敗：'+e.message);
  }
}

// -------- 導航 ----------
function showSection(id) {
  document.querySelectorAll('.page-section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'activities') loadActivities();
  if (id === 'donations') loadDonations();
  if (id === 'profile') loadProfile();
  if (id === 'dashboard') loadDashboard();
  const nav = document.getElementById('nav');
  if (nav.classList.contains('show')) bootstrap.Collapse.getInstance(nav).hide();
}

// -------- 儀表板 ----------
async function loadDashboard() {
  updateDashboardStats();
  loadRecentActivities();
  loadUpcomingActivities();
}

function updateDashboardStats() {
  if (!currentUser) return;
  document.getElementById('memberStatus').textContent = currentUser['是否會員']==='是' ? '會員' : '非會員';
  document.getElementById('donationCount').textContent = currentUser['捐款次數'] || 0;
  document.getElementById('donationTotal').textContent = '$' + (currentUser['捐款總額'] || 0);
  // 活動數需要重新查詢 (以最近活動數作為代表)
}

async function loadRecentActivities() {
  try {
    const list = await apiCall('getUserActivities','GET',{ userId:userProfile.userId, limit:5 });
    const c = document.getElementById('recentActivities');
    if (!list.length) {
      c.innerHTML = '<p class="text-muted mb-0">尚無活動參與記錄</p>';
      return;
    }
    document.getElementById('activityCount').textContent = list.length;
    c.innerHTML = list.map(a => `
      <div class="border rounded p-2 mb-2">
        <div class="d-flex justify-content-between">
          <div>
            <strong>${a['活動名稱'] || '活動'}</strong><br/>
            <small class="text-muted">${formatDate(a['報名時間'])}</small>
          </div>
          <span class="status-badge status-${statusClass(a['報名狀態'])}">${a['報名狀態']}</span>
        </div>
      </div>
    `).join('');
  } catch (e) {
    document.getElementById('recentActivities').innerHTML='<p class="text-danger mb-0">載入失敗</p>';
  }
}

async function loadUpcomingActivities() {
  try {
    const list = await apiCall('getUpcomingActivities','GET',{ limit:5 });
    const c = document.getElementById('upcomingActivities');
    if (!list.length) {
      c.innerHTML = '<p class="text-muted mb-0">目前沒有即將開始的活動</p>';
      return;
    }
    c.innerHTML = list.map(a => `
      <div class="border rounded p-2 mb-2 d-flex justify-content-between align-items-center">
        <div>
          <strong>${a['活動名稱']}</strong><br/>
          <small class="text-muted"><i class="fa fa-calendar"></i> ${formatDate(a['活動日期'])}</small>
        </div>
        <button class="btn btn-sm btn-outline-primary" onclick="viewActivityDetail('${a['活動ID']}')">查看</button>
      </div>
    `).join('');
  } catch (e) {
    document.getElementById('upcomingActivities').innerHTML='<p class="text-danger mb-0">載入失敗</p>';
  }
}

// -------- 個人資料 ----------
function loadProfile() {
  if (!currentUser) return;
  setVal('realName', currentUser['真實姓名']);
  setVal('phone', currentUser['電話']);
  setVal('email', currentUser['電子郵件']);
  setVal('address', currentUser['地址']);
  setVal('birthday', currentUser['生日']);
  setVal('isPatient', currentUser['是否患者']);
  setVal('relationship', currentUser['與患者關係']);
  setVal('emergencyContact', currentUser['緊急聯絡人']);
  setVal('emergencyPhone', currentUser['緊急聯絡電話']);
}
function setVal(id,v){ document.getElementById(id).value = v || ''; }

function bindForms() {
  const pf = document.getElementById('profileForm');
  pf.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = pf.querySelector('button[type=submit]');
    const old = btn.innerHTML;
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 儲存中...';
    try {
      await apiCall('updateUserInfo','POST',{
        userId: userProfile.userId,
        真實姓名: getVal('realName'),
        電話: getVal('phone'),
        電子郵件: getVal('email'),
        地址: getVal('address'),
        生日: getVal('birthday'),
        是否患者: getVal('isPatient'),
        與患者關係: getVal('relationship'),
        緊急聯絡人: getVal('emergencyContact'),
        緊急聯絡電話: getVal('emergencyPhone')
      });
      showSuccess('個人資料已更新');
      await loadUserData();
    } catch (e2) {
      showError(e2.message);
    } finally {
      btn.disabled = false; btn.innerHTML = old;
    }
  });

  const df = document.getElementById('donationForm');
  df.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const btn = df.querySelector('button[type=submit]');
    const old = btn.innerHTML;
    btn.disabled = true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> 處理中...';
    try {
      await apiCall('addDonation','POST',{
        userId: userProfile.userId,
        捐款金額: parseFloat(getVal('donationAmount')),
        捐款類型: getVal('donationType'),
        付款方式: getVal('paymentMethod'),
        備註: getVal('donationNote')
      });
      showSuccess('捐款已紀錄，感謝您的愛心！');
      df.reset();
      document.querySelectorAll('.donation-amount').forEach(el=>el.classList.remove('selected'));
      await loadDonationHistory();
      await loadUserData();
    } catch (err) {
      showError('捐款失敗：' + err.message);
    } finally {
      btn.disabled = false; btn.innerHTML = old;
    }
  });

  document.getElementById('isPatient').addEventListener('change', (e)=>{
    if (e.target.value === '是') {
      document.getElementById('relationship').value = '患者本人';
      document.getElementById('relationship').disabled = true;
    } else {
      if (document.getElementById('relationship').value === '患者本人')
        document.getElementById('relationship').value = '';
      document.getElementById('relationship').disabled = false;
    }
  });
}
function getVal(id){ return document.getElementById(id).value.trim(); }

// -------- 活動 ----------
async function loadActivities() {
  try {
    const list = await apiCall('getActivities','GET');
    renderActivities(list);
  } catch (e) {
    document.getElementById('activitiesList').innerHTML='<p class="text-danger mb-0">載入失敗</p>';
  }
}
function renderActivities(list) {
  const c = document.getElementById('activitiesList');
  if (!list.length) { c.innerHTML='<p class="text-muted mb-0">尚無活動</p>'; return; }
  c.innerHTML = list.map(a => `
    <div class="card activity-card mb-3">
      <div class="card-body">
        <div class="d-md-flex justify-content-between">
          <div class="mb-2 mb-md-0">
            <h5 class="mb-1">${a['活動名稱']}</h5>
            <small class="text-muted"><i class="fa fa-calendar"></i> ${formatDate(a['活動日期'])} ｜ <i class="fa fa-map-marker-alt"></i> ${a['活動地點']||'待定'}</small>
            <div class="mt-1 small text-muted">${a['活動描述']||''}</div>
            <div class="mt-1 small">
              <i class="fa fa-users"></i> ${a['報名人數']}/${a['人數上限']}
              <span class="ms-2 status-badge status-${statusClass(a['活動狀態'])}">${a['活動狀態']}</span>
            </div>
          </div>
          <div class="text-md-end">
            <button class="btn btn-outline-primary btn-sm me-2" onclick="viewActivityDetail('${a['活動ID']}')">
              <i class="fa fa-eye"></i> 詳情
            </button>
            ${a['活動狀態']==='報名中' ? `<button class="btn btn-primary btn-sm" onclick="quickRegisterActivity('${a['活動ID']}')"><i class="fa fa-user-plus"></i> 報名</button>`:''}
          </div>
        </div>
      </div>
    </div>
  `).join('');
}
function filterActivities() {
  const filter = document.getElementById('activityFilter').value;
  document.querySelectorAll('#activitiesList .activity-card').forEach(card => {
    const status = card.querySelector('.status-badge').textContent.trim();
    card.style.display = (filter === 'all' || status === filter) ? '' : 'none';
  });
}
async function viewActivityDetail(id) {
  try {
    const act = await apiCall('getActivityDetail','GET',{ activityId:id });
    selectedActivityId = id;
    document.getElementById('activityModalTitle').textContent = act['活動名稱'];
    document.getElementById('activityModalBody').innerHTML = `
      <div class="row">
        <div class="col-md-6">
          <p><strong>類型：</strong>${act['活動類型']||''}</p>
          <p><strong>日期：</strong>${formatDate(act['活動日期'])}</p>
          <p><strong>時間：</strong>${act['活動時間']||''}</p>
          <p><strong>地點：</strong>${act['活動地點']||''}</p>
          <p><strong>名額：</strong>${act['報名人數']}/${act['人數上限']}</p>
          <p><strong>狀態：</strong><span class="status-badge status-${statusClass(act['活動狀態'])}">${act['活動狀態']}</span></p>
        </div>
        <div class="col-md-6">
          <strong>描述</strong>
          <p class="small">${act['活動描述']||'無'}</p>
        </div>
      </div>
    `;
    const btn = document.getElementById('registerActivityBtn');
    if (act['活動狀態']==='報名中' && act['報名人數'] < act['人數上限']) btn.style.display='inline-block';
    else btn.style.display='none';
    new bootstrap.Modal(document.getElementById('activityModal')).show();
  } catch (e) {
    showError('載入活動失敗：'+e.message);
  }
}
async function quickRegisterActivity(id) {
  if (!currentUser['真實姓名'] || !currentUser['電話']) {
    showError('請先完成個人資料（姓名 / 電話）再報名');
    showSection('profile');
    return;
  }
  try {
    await apiCall('registerActivity','POST',{ userId:userProfile.userId, activityId:id });
    showSuccess('報名成功');
    loadActivities();
  } catch (e) {
    showError('報名失敗：'+e.message);
  }
}
async function registerActivity() {
  if (!selectedActivityId) return;
  await quickRegisterActivity(selectedActivityId);
  bootstrap.Modal.getInstance(document.getElementById('activityModal')).hide();
}

// -------- 捐款 ----------
async function loadDonations() {
  loadDonationHistory();
}
async function loadDonationHistory() {
  try {
    const list = await apiCall('getUserDonations','GET',{ userId:userProfile.userId });
    const c = document.getElementById('donationHistory');
    if (!list.length) { c.innerHTML='<p class="text-muted mb-0">尚無捐款</p>'; return; }
    c.innerHTML = list.map(d => `
      <div class="border rounded p-2 mb-2">
        <div class="d-flex justify-content-between">
          <div>
            <strong>$${Number(d['捐款金額']).toLocaleString()}</strong><br/>
            <small class="text-muted">${d['捐款類型']} • ${formatDate(d['捐款時間'])}</small>
          </div>
          <span class="status-badge status-${statusClass(d['處理狀態'])}">${d['處理狀態']}</span>
        </div>
      </div>
    `).join('');
  } catch (e) {
    document.getElementById('donationHistory').innerHTML='<p class="text-danger mb-0">載入失敗</p>';
  }
}

function buildQuickAmounts() {
  const row = document.querySelector('#donations .row .card .row.g-2');
  if (!row.dataset.built) {
    row.dataset.built = '1';
    const baseAmounts = [500,1000,2000,5000,10000];
    row.innerHTML = baseAmounts.map(a => `
      <div class="col-4 col-md-3">
        <div class="donation-amount" onclick="selectAmount(this,${a})">$${a.toLocaleString()}</div>
      </div>
    `).join('');
  }
}
buildQuickAmounts();

function selectAmount(el, amt) {
  document.querySelectorAll('.donation-amount').forEach(d => d.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('donationAmount').value = amt;
}
function selectCustomAmount(el) {
  document.querySelectorAll('.donation-amount').forEach(d => d.classList.remove('selected'));
  el.classList.add('selected');
  const input = document.getElementById('donationAmount');
  input.value = '';
  input.focus();
}

// -------- 工具 / UI ----------
function statusClass(s) {
  switch (s) {
    case '報名中': case '進行中': case '已報名': case '已完成': case '已完成': return 'active';
    case '待處理': case '待確認': return 'pending';
    case '已結束': case '已完成': return 'completed';
    default: return 'pending';
  }
}
function formatDate(v) {
  if (!v) return '-';
  const d = new Date(v);
  if (isNaN(d.getTime())) return v;
  return d.getFullYear() + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + String(d.getDate()).padStart(2,'0');
}

function showAlert(msg, type) {
  const old = document.querySelector('.alert-floating');
  if (old) old.remove();
  const div = document.createElement('div');
  div.className = 'alert alert-' + type + ' alert-floating';
  div.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="fas fa-${type==='success'?'check-circle':'exclamation-triangle'} me-2"></i>
      <div class="flex-grow-1">${msg}</div>
      <button class="btn-close ms-2" onclick="this.parentElement.parentElement.remove()"></button>
    </div>`;
  document.body.appendChild(div);
  setTimeout(()=>{ if (div.parentElement) div.remove(); }, 3000);
}
function showSuccess(m){ showAlert(m,'success'); }
function showError(m){ showAlert(m,'danger'); }
</script>
</body>
</html>
