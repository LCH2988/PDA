<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>會員管理系統</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
:root {
  --primary:#06C755;
  --secondary:#00B900;
  --accent:#FF6B6B;
  --bg:#f8f9fa;
}
body {
  background:linear-gradient(135deg,#667eea,#764ba2);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  min-height:100vh;
}
.main-container {
  background:#fff;
  border-radius:22px 22px 0 0;
  min-height:100vh;
  box-shadow:0 4px 18px rgba(0,0,0,.15);
}
.user-header {
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:#fff;
  padding:24px;
  border-radius:22px 22px 0 0;
  text-align:center;
}
.user-avatar {
  width:80px;height:80px;border-radius:50%;border:4px solid #fff;object-fit:cover;
  margin-bottom:10px;
}
.nav-pills .nav-link {
  border-radius:25px;
  transition:.3s;
}
.nav-pills .nav-link.active {
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  box-shadow:0 4px 12px rgba(0,185,0,.3);
}
.card { border:none; border-radius:16px; box-shadow:0 2px 10px rgba(0,0,0,.1); }
.card:hover { transform:translateY(-3px); transition:.3s; }
.status-badge {
  padding:4px 10px; border-radius:18px; font-size:.72rem; font-weight:600;
}
.status-active { background:#d4edda;color:#155724;}
.status-pending{ background:#fff3cd;color:#856404;}
.status-cancelled{background:#f8d7da;color:#721c24;}
.activity-card, .volunteer-record, .financial-record, .feedback-item {
  border-left:4px solid var(--primary);
  padding:14px;
  border-radius:12px;
  margin-bottom:16px;
  background:#fff;
}
.financial-record.income { border-left-color:#28a745; }
.financial-record.expense{ border-left-color:#ffc107; }
.stats-card {
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;
  border-radius:14px;
  padding:18px;
  text-align:center;
}
.stats-number { font-size:1.8rem;font-weight:700;margin-bottom:4px; }
.loading-spinner {
  width:48px;height:48px;border:5px solid #eee;border-top:5px solid var(--primary);
  border-radius:50%;animation:spin 1s linear infinite;margin:auto;
}
@keyframes spin { to { transform:rotate(360deg);} }
@media (max-width:768px){
  .main-container{border-radius:0;}
  .user-header{border-radius:0;}
  .nav-pills{overflow-x:auto;flex-wrap:nowrap;}
}
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container-fluid px-0">
  <div class="main-container">

    <div class="user-header">
      <img id="userAvatar" class="user-avatar" src="https://via.placeholder.com/80" alt="">
      <h5 id="userName">載入中...</h5>
      <small>會員管理系統</small>
    </div>

    <div class="p-3">
      <ul class="nav nav-pills justify-content-center mb-4" id="mainTabs">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#profile"><i class="bi bi-person-circle me-1"></i>個人資料</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#activities"><i class="bi bi-calendar-event me-1"></i>活動</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#volunteer"><i class="bi bi-heart me-1"></i>志工</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#financial"><i class="bi bi-wallet2 me-1"></i>財務</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#feedback"><i class="bi bi-chat-square-text me-1"></i>回饋</a></li>
        <li class="nav-item" id="adminTab" style="display:none;"><a class="nav-link" data-bs-toggle="pill" href="#admin"><i class="bi bi-gear me-1"></i>管理</a></li>
      </ul>

      <div class="tab-content">

        <!-- 個人資料 -->
        <div class="tab-pane fade show active" id="profile">
          <div class="row">
            <div class="col-md-8 mb-3">
              <div class="card">
                <div class="card-header"><h6 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>基本資料</h6></div>
                <div class="card-body">
                  <form id="memberForm">
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">真實姓名</label>
                        <input type="text" class="form-control" name="真實姓名" id="realName">
                      </div>
                      <div class="col-md-6 mb-3">
                        <label class="form-label">電話</label>
                        <input type="tel" class="form-control" name="電話" id="phone">
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">電子郵件</label>
                        <input type="email" class="form-control" name="電子郵件" id="email">
                      </div>
                      <div class="col-md-6 mb-3">
                        <label class="form-label">生日</label>
                        <input type="date" class="form-control" name="生日" id="birthday">
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">地址</label>
                      <input type="text" class="form-control" name="地址" id="address">
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">緊急聯絡人</label>
                        <input type="text" class="form-control" name="緊急聯絡人" id="emergencyContact">
                      </div>
                      <div class="col-md-6 mb-3">
                        <label class="form-label">緊急聯絡電話</label>
                        <input type="tel" class="form-control" name="緊急聯絡電話" id="emergencyPhone">
                      </div>
                    </div>
                    <button class="btn btn-success"><i class="bi bi-check-circle me-1"></i>更新資料</button>
                  </form>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card">
                <div class="card-header"><h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>會員資訊</h6></div>
                <div class="card-body small">
                  <p class="mb-1"><strong>會員等級：</strong><span id="memberLevel">-</span></p>
                  <p class="mb-1"><strong>加入日期：</strong><span id="joinDate">-</span></p>
                  <p class="mb-1"><strong>最後登入：</strong><span id="lastLogin">-</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 活動 -->
        <div class="tab-pane fade" id="activities">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>活動列表</h5>
            <div class="d-flex gap-2">
              <select id="activityStatusFilter" class="form-select form-select-sm">
                <option value="">全部狀態</option>
                <option value="開放報名">開放報名</option>
                <option value="報名截止">報名截止</option>
                <option value="進行中">進行中</option>
                <option value="已完成">已完成</option>
                <option value="已取消">已取消</option>
              </select>
              <select id="activityTypeFilter" class="form-select form-select-sm">
                <option value="">全部類型</option>
                <option value="教育訓練">教育訓練</option>
                <option value="志工服務">志工服務</option>
                <option value="聯誼活動">聯誼活動</option>
                <option value="會議">會議</option>
                <option value="其他">其他</option>
              </select>
            </div>
          </div>
          <div class="row" id="activitiesList"></div>
        </div>

        <!-- 志工 -->
        <div class="tab-pane fade" id="volunteer">
          <div class="d-flex justify-content-between mb-3">
            <h5 class="mb-0"><i class="bi bi-heart me-2"></i>志工服務</h5>
            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#volunteerModal"><i class="bi bi-plus-circle me-1"></i>新增記錄</button>
          </div>
          <div class="row mb-3">
            <div class="col-6">
              <div class="stats-card">
                <div class="stats-number" id="totalVolunteerHours">0</div>
                <div>總服務時數</div>
              </div>
            </div>
            <div class="col-6">
              <div class="stats-card">
                <div class="stats-number" id="totalVolunteerTimes">0</div>
                <div>服務次數</div>
              </div>
            </div>
          </div>
          <div id="volunteerRecordsList"></div>
        </div>

        <!-- 財務 -->
        <div class="tab-pane fade" id="financial">
          <div class="d-flex justify-content-between mb-3">
            <h5 class="mb-0"><i class="bi bi-wallet2 me-2"></i>財務記錄</h5>
            <div class="btn-group">
              <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#donationModal"><i class="bi bi-heart-fill me-1"></i>捐款</button>
              <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#expenseModal"><i class="bi bi-receipt me-1"></i>支出申請</button>
            </div>
          </div>
          <div id="financialRecordsList"></div>
        </div>

        <!-- 回饋 -->
        <div class="tab-pane fade" id="feedback">
          <div class="d-flex justify-content-between mb-3">
            <h5 class="mb-0"><i class="bi bi-chat-square-text me-2"></i>回饋</h5>
            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#feedbackModal"><i class="bi bi-plus-circle me-1"></i>新增回饋</button>
          </div>
          <div id="feedbackList"></div>
        </div>

        <!-- 管理 -->
        <div class="tab-pane fade" id="admin">
          <h5 class="mb-3"><i class="bi bi-gear me-2"></i>系統管理</h5>
          <div class="row" id="adminStats">
            <div class="col-6 col-md-3 mb-3">
              <div class="card text-center">
                <div class="card-body">
                  <i class="bi bi-people mb-2" style="font-size:2rem;color:var(--primary);"></i>
                  <h4 id="dashTotalMembers">0</h4>
                  <small>會員</small>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3 mb-3">
              <div class="card text-center">
                <div class="card-body">
                  <i class="bi bi-calendar-event mb-2" style="font-size:2rem;color:var(--primary);"></i>
                  <h4 id="dashTotalActivities">0</h4>
                  <small>活動</small>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3 mb-3">
              <div class="card text-center">
                <div class="card-body">
                  <i class="bi bi-heart-fill mb-2" style="font-size:2rem;color:var(--accent);"></i>
                  <h4 id="dashTotalDonations">0</h4>
                  <small>捐款</small>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3 mb-3">
              <div class="card text-center">
                <div class="card-body">
                  <i class="bi bi-clock mb-2" style="font-size:2rem;color:var(--secondary);"></i>
                  <h4 id="dashTotalVolunteerHours">0</h4>
                  <small>志工時數</small>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <h6>最新加入會員</h6>
            <ul class="list-group small" id="latestMembers"></ul>
          </div>
          <div class="mb-3">
            <h6>熱門活動</h6>
            <ul class="list-group small" id="hotActivities"></ul>
          </div>
          <div class="mb-3">
            <h6>最近捐款</h6>
            <ul class="list-group small" id="recentDonations"></ul>
          </div>
          <div class="mb-3">
            <h6>待處理項目</h6>
            <ul class="list-group small" id="pendingItems"></ul>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- 志工 Modal -->
<div class="modal fade" id="volunteerModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="volunteerForm">
        <div class="modal-header"><h5 class="modal-title">新增志工記錄</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">服務項目</label>
            <select class="form-select" name="服務項目" required>
              <option value="">選擇</option>
              <option value="環境清潔">環境清潔</option>
              <option value="長者關懷">長者關懷</option>
              <option value="兒童陪伴">兒童陪伴</option>
              <option value="教育輔導">教育輔導</option>
              <option value="活動協助">活動協助</option>
              <option value="其他">其他</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">服務日期</label>
            <input type="date" name="服務日期" class="form-control" required>
          </div>
            <div class="mb-2">
            <label class="form-label">服務時數</label>
            <input type="number" min="0.5" step="0.5" name="服務時數" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">服務地點</label>
            <input type="text" name="服務地點" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">服務內容</label>
            <textarea name="服務內容" rows="3" class="form-control" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
          <button class="btn btn-success" type="submit">提交</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 捐款 Modal -->
<div class="modal fade" id="donationModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="donationForm">
        <div class="modal-header">
          <h5 class="modal-title">新增捐款</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">金額</label>
            <input type="number" name="金額" min="1" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">日期</label>
            <input type="date" name="日期" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">項目</label>
            <select name="項目" class="form-select" required>
              <option value="一般捐款">一般捐款</option>
              <option value="活動贊助">活動贊助</option>
              <option value="設備購置">設備購置</option>
              <option value="其他">其他</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">描述</label>
            <textarea name="描述" rows="2" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
          <button class="btn btn-success" type="submit">提交</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 支出申請 Modal -->
<div class="modal fade" id="expenseModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="expenseForm">
        <div class="modal-header">
          <h5 class="modal-title">支出申請</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">金額</label>
            <input type="number" name="金額" min="1" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">日期</label>
            <input type="date" name="日期" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">項目</label>
            <input type="text" name="項目" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">描述</label>
            <textarea name="描述" rows="3" class="form-control" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
          <button class="btn btn-warning" type="submit">提交</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 回饋 Modal -->
<div class="modal fade" id="feedbackModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="feedbackForm">
        <div class="modal-header">
          <h5 class="modal-title">新增回饋</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">類型</label>
            <select name="類型" class="form-select" required>
              <option value="">選擇</option>
              <option value="活動回饋">活動回饋</option>
              <option value="系統建議">系統建議</option>
              <option value="服務評價">服務評價</option>
              <option value="其他">其他</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">評分</label>
            <select name="評分" class="form-select" required>
              <option value="">選擇</option>
              <option value="5">5 - 極好</option>
              <option value="4">4 - 好</option>
              <option value="3">3 - 普通</option>
              <option value="2">2 - 待改善</option>
              <option value="1">1 - 不滿意</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">內容</label>
            <textarea name="內容" rows="4" class="form-control" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
          <button class="btn btn-success" type="submit">提交</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4 text-center">
      <div class="loading-spinner mb-3"></div>
      <div id="loadingMessage">載入中...</div>
    </div>
  </div>
</div>

<div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer" style="z-index:1080;"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const FRONTEND_CONFIG = {
  GAS_URL: 'https://script.google.com/macros/s/AKfycbw8tmPA-XiN93R7dvR9FEsSEe5dKI_qqe7S8DKoS_868p4THStE5UAD96YeJOj9uiy3/exec',
  LIFF_ID: '1656516134-VaGgmaPm'
};

let currentUser = null;
let isAdmin = false;

async function initLiff(){
  try {
    await liff.init({ liffId: FRONTEND_CONFIG.LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login(); return;
    }
    const profile = await liff.getProfile();
    currentUser = {
      userId: profile.userId,
      displayName: profile.displayName,
      pictureUrl: profile.pictureUrl
    };
    document.getElementById('userName').textContent = profile.displayName;
    document.getElementById('userAvatar').src = profile.pictureUrl || 'https://via.placeholder.com/80';
    await loadMemberData();
    await Promise.all([loadActivities(), loadVolunteerRecords(), loadFinancialRecords(), loadFeedbackList()]);
    if (isAdmin) loadAdminDashboard();
  } catch(err){
    showToast('LIFF 初始化失敗','danger');
  } finally {
    hideLoading();
  }
}

async function callAPI(action, params={}){
  if (!currentUser) return { success:false, message:'尚未登入' };
  try {
    const res = await fetch(FRONTEND_CONFIG.GAS_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ action, userId: currentUser.userId, ...params })
    });
    return await res.json();
  } catch(err){
    return { success:false, message:'網路錯誤' };
  }
}

// 會員
async function loadMemberData(){
  showLoading('載入會員資料...');
  const res = await callAPI('getMemberInfo');
  if (res.success){
    const m = res.data.member;
    fillMemberForm(m);
    isAdmin = ['管理員','超級管理員'].includes(m['會員等級']);
    if (isAdmin) document.getElementById('adminTab').style.display='block';
  } else {
    showToast(res.message,'danger');
  }
  hideLoading();
}

function fillMemberForm(m){
  const map = {
    realName:'真實姓名', phone:'電話', email:'電子郵件', birthday:'生日',
    address:'地址', emergencyContact:'緊急聯絡人', emergencyPhone:'緊急聯絡電話'
  };
  Object.entries(map).forEach(([id,field])=>{
    document.getElementById(id).value = m[field]||'';
  });
  document.getElementById('memberLevel').textContent = m['會員等級']||'-';
  document.getElementById('joinDate').textContent = formatDate(m['加入日期']);
  document.getElementById('lastLogin').textContent = formatDateTime(m['最後登入時間']);
}

document.getElementById('memberForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = {};
  fd.forEach((v,k)=> payload[k]=v);
  showLoading('更新資料中...');
  const res = await callAPI('updateMemberInfo',payload);
  hideLoading();
  showToast(res.message, res.success?'success':'danger');
});

// 活動
async function loadActivities(){
  const res = await callAPI('getActivities');
  if (res.success){
    renderActivities(res.data.activities||[]);
  }
}

function renderActivities(list){
  const wrap = document.getElementById('activitiesList');
  if (!list.length){
    wrap.innerHTML='<div class="col-12"><div class="alert alert-info">目前沒有活動</div></div>';
    return;
  }
  const statusFilter = document.getElementById('activityStatusFilter').value;
  const typeFilter = document.getElementById('activityTypeFilter').value;
  wrap.innerHTML = list
    .filter(a=> !statusFilter || a['活動狀態']===statusFilter)
    .filter(a=> !typeFilter || a['活動類型']===typeFilter)
    .map(a=> `
    <div class="col-md-6 mb-3">
      <div class="card activity-card">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <h6 class="mb-1">${a['活動名稱']}</h6>
            <span class="status-badge status-${statusClass(a['活動狀態'])}">${a['活動狀態']}</span>
          </div>
          <div class="small text-muted mb-2">
            <i class="bi bi-calendar me-1"></i>${formatDateTime(a['開始時間'])}<br>
            <i class="bi bi-geo-alt me-1"></i>${a['地點']}<br>
            <i class="bi bi-people me-1"></i>${a['目前報名人數']}/${a['參與人數上限']}
          </div>
          <p class="small mb-2">${(a['活動描述']||'').substring(0,60)}...</p>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" onclick="viewActivity('${a['活動ID']}')"><i class="bi bi-info-circle me-1"></i>詳情</button>
            ${a['活動狀態']==='開放報名'? `<button class="btn btn-success btn-sm" onclick="registerActivity('${a['活動ID']}')">報名</button>`:''}
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

async function registerActivity(activityId){
  showLoading('報名中...');
  const res = await callAPI('registerActivity',{activityId});
  hideLoading();
  showToast(res.message, res.success?'success':'danger');
  if (res.success) loadActivities();
}

async function viewActivity(activityId){
  showLoading('載入中...');
  const res = await callAPI('getActivityDetail',{activityId});
  hideLoading();
  if (!res.success){ showToast(res.message,'danger'); return; }
  const a = res.data.activity;
  const modalHtml = `
    <div class="modal fade" id="activityDetailModal">
      <div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">${a['活動名稱']}</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body small">
          <div class="row">
            <div class="col-md-6 mb-2">
              <strong>類型：</strong>${a['活動類型']}<br>
              <strong>狀態：</strong><span class="status-badge status-${statusClass(a['活動狀態'])}">${a['活動狀態']}</span><br>
              <strong>主辦人：</strong>${a['主辦人']}<br>
              <strong>人數：</strong>${a['目前報名人數']}/${a['參與人數上限']}
            </div>
            <div class="col-md-6 mb-2">
              <strong>開始：</strong>${formatDateTime(a['開始時間'])}<br>
              <strong>結束：</strong>${formatDateTime(a['結束時間'])}<br>
              <strong>地點：</strong>${a['地點']}<br>
              <strong>截止：</strong>${formatDateTime(a['報名截止日期'])}
            </div>
          </div>
          <hr>
          <p>${a['活動描述']}</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
          ${a['活動狀態']==='開放報名'? `<button class="btn btn-success" onclick="registerActivity('${a['活動ID']}')" data-bs-dismiss="modal">報名</button>`:''}
        </div>
      </div></div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend',modalHtml);
  const modalEl = document.getElementById('activityDetailModal');
  modalEl.addEventListener('hidden.bs.modal',()=> modalEl.remove());
  new bootstrap.Modal(modalEl).show();
}

// 志工
async function loadVolunteerRecords(){
  const res = await callAPI('getVolunteerRecords');
  if (res.success){
    document.getElementById('totalVolunteerHours').textContent = res.data.stats.totalHours;
    document.getElementById('totalVolunteerTimes').textContent = res.data.stats.totalTimes;
    renderVolunteer(res.data.records);
  }
}
function renderVolunteer(list){
  const wrap = document.getElementById('volunteerRecordsList');
  if (!list.length){
    wrap.innerHTML='<div class="alert alert-info">尚無志工記錄</div>'; return;
  }
  wrap.innerHTML = list.map(r=>`
    <div class="volunteer-record">
      <div class="d-flex justify-content-between">
        <strong>${r['服務項目']}</strong>
        <span class="status-badge status-${statusClass(r['狀態'])}">${r['狀態']}</span>
      </div>
      <div class="small text-muted mb-1">
        <i class="bi bi-calendar me-1"></i>${formatDate(r['服務日期'])}
        <i class="bi bi-clock ms-2 me-1"></i>${r['服務時數']} 小時
        <i class="bi bi-geo-alt ms-2 me-1"></i>${r['服務地點']}
      </div>
      <div class="small">${r['服務內容']}</div>
    </div>
  `).join('');
}

document.getElementById('volunteerForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload={};
  fd.forEach((v,k)=> payload[k]=v);
  showLoading('提交中...');
  const res = await callAPI('addVolunteerRecord',payload);
  hideLoading();
  showToast(res.message,res.success?'success':'danger');
  if (res.success){
    bootstrap.Modal.getInstance(document.getElementById('volunteerModal')).hide();
    e.target.reset();
    loadVolunteerRecords();
  }
});

// 財務
async function loadFinancialRecords(){
  const res = await callAPI('getFinancialRecords');
  if (res.success){
    renderFinancial(res.data.records);
  }
}
function renderFinancial(list){
  const wrap = document.getElementById('financialRecordsList');
  if (!list.length){ wrap.innerHTML='<div class="alert alert-info">尚無財務記錄</div>'; return; }
  wrap.innerHTML = list.map(r=>{
    const type = r['類型']==='捐款'?'income':'expense';
    const amt = Number(r['金額'])||0;
    return `
      <div class="financial-record ${type}">
        <div class="d-flex justify-content-between">
          <strong>${r['項目']}</strong>
          <div class="text-end">
            <div class="${type==='income'?'text-success':'text-warning'} fw-bold">
              ${type==='income'?'+':'-'}$${amt.toLocaleString()}
            </div>
            <span class="status-badge status-${statusClass(r['狀態'])}">${r['狀態']}</span>
          </div>
        </div>
        <div class="small text-muted">
          <i class="bi bi-calendar me-1"></i>${formatDate(r['日期'])}
          ${r['收據號碼']?`<span class="ms-2"><i class="bi bi-receipt me-1"></i>${r['收據號碼']}</span>`:''}
        </div>
        ${r['描述']?`<div class="small mt-1">${r['描述']}</div>`:''}
      </div>
    `;
  }).join('');
}

document.getElementById('donationForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload={};
  fd.forEach((v,k)=> payload[k]=v);
  showLoading('處理捐款...');
  const res = await callAPI('addDonation',payload);
  hideLoading();
  showToast(res.message,res.success?'success':'danger');
  if (res.success){
    bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
    e.target.reset();
    loadFinancialRecords();
  }
});

document.getElementById('expenseForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload={};
  fd.forEach((v,k)=> payload[k]=v);
  showLoading('提交支出...');
  const res = await callAPI('addExpenseRequest',payload);
  hideLoading();
  showToast(res.message,res.success?'success':'danger');
  if (res.success){
    bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
    e.target.reset();
    loadFinancialRecords();
  }
});

// 回饋
async function loadFeedbackList(){
  const res = await callAPI('getFeedbackList');
  if (res.success){
    renderFeedback(res.data.feedbacks);
  }
}
function renderFeedback(list){
  const wrap = document.getElementById('feedbackList');
  if (!list.length){ wrap.innerHTML='<div class="alert alert-info">尚無回饋</div>'; return; }
  wrap.innerHTML = list.map(f=>`
    <div class="feedback-item">
      <div class="d-flex justify-content-between">
        <strong>${f['類型']}</strong>
        <div>
          <span class="me-2 text-warning">${'★'.repeat(f['評分'])}</span>
          <span class="status-badge status-${statusClass(f['狀態'])}">${f['狀態']}</span>
        </div>
      </div>
      <div class="small mt-1">${f['內容']}</div>
      <div class="text-muted small mt-1"><i class="bi bi-clock me-1"></i>${formatDateTime(f['建立時間'])}</div>
      ${f['回覆']? `<div class="mt-2 p-2 bg-light rounded small"><strong>回覆：</strong>${f['回覆']}</div>`:''}
    </div>
  `).join('');
}

document.getElementById('feedbackForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload={};
  fd.forEach((v,k)=> payload[k]=v);
  showLoading('提交回饋...');
  const res = await callAPI('addFeedback',payload);
  hideLoading();
  showToast(res.message,res.success?'success':'danger');
  if (res.success){
    bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
    e.target.reset();
    loadFeedbackList();
  }
});

// 管理儀表板
async function loadAdminDashboard(){
  showLoading('載入管理資料...');
  const res = await callAPI('getAdminDashboard');
  hideLoading();
  if (!res.success){ showToast(res.message,'danger'); return; }
  const d = res.data;
  document.getElementById('dashTotalMembers').textContent = d.stats.totalMembers;
  document.getElementById('dashTotalActivities').textContent = d.stats.totalActivities;
  document.getElementById('dashTotalDonations').textContent = d.stats.totalDonations.toLocaleString();
  document.getElementById('dashTotalVolunteerHours').textContent = d.stats.totalVolunteerHours;

  renderList('latestMembers', d.latestMembers, m=> `${m.name||'-'} (${m.level||''}) <span class="text-muted ms-1">${formatDate(m.join)}</span>`);
  renderList('hotActivities', d.hotActivities, a=> `
    ${a.name}
    <span class="text-muted ms-1">${(a.registered||a.count||0)}人</span>
    ${a.status? `<span class="badge bg-light text-dark ms-1">${a.status}</span>`:''}
  `);

  renderList('recentDonations', d.recentDonations, r=> `
    ${r.member||r.name||'匿名'}：
    <span class="text-success fw-bold">$${Number(r.amount||r.money||0).toLocaleString()}</span>
    <span class="text-muted ms-1">${formatDate(r.date)}</span>
  `);

  renderList('pendingItems', d.pendingItems, p=> `
    <strong>${p.type||'項目'}</strong>
    ${p.title||p.name||p.id||''}
    <span class="badge bg-warning text-dark ms-1">${p.status||'待處理'}</span>
  `);
}

function renderList(ulId, arr, templateFn){
  const ul = document.getElementById(ulId);
  if (!ul) return;
  if (!arr || !arr.length){
    ul.innerHTML = `<li class="list-group-item text-muted">無資料</li>`;
    return;
  }
  ul.innerHTML = arr.map(item=> `<li class="list-group-item d-flex justify-content-between align-items-start">
    <div class="me-2 flex-grow-1">${templateFn(item)}</div>
  </li>`).join('');
}

// 狀態樣式對應
function statusClass(s=''){
  if(!s) return 'pending';
  if(['開放報名','進行中','已完成','啟用','已核准','已同意','成功','有效'].includes(s)) return 'active';
  if(['已取消','取消','失敗','停用','拒絕','駁回'].includes(s)) return 'cancelled';
  return 'pending';
}

// 日期格式
function formatDate(d){
  if(!d) return '-';
  const dt = new Date(d);
  if (isNaN(dt)) return d;
  return dt.toISOString().slice(0,10);
}
function formatDateTime(d){
  if(!d) return '-';
  const dt = new Date(d);
  if (isNaN(dt)) return d;
  const pad = n=> String(n).padStart(2,'0');
  return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
}

// Loading
let loadingModalInstance = null;
function showLoading(msg='處理中...'){
  const el = document.getElementById('loadingModal');
  if (!el) return;
  document.getElementById('loadingMessage').textContent = msg;
  if (!loadingModalInstance){
    loadingModalInstance = new bootstrap.Modal(el);
  }
  loadingModalInstance.show();
}
function hideLoading(){
  if (loadingModalInstance){
    loadingModalInstance.hide();
  }
}

// Toast
function showToast(message, type='info'){
  const container = document.getElementById('toastContainer');
  if (!container) return;
  const id = 'toast_'+Date.now();
  const colorClass = {
    success:'bg-success',
    danger:'bg-danger',
    warning:'bg-warning text-dark',
    info:'bg-primary'
  }[type] || 'bg-secondary';

  container.insertAdjacentHTML('beforeend', `
    <div id="${id}" class="toast align-items-center text-white ${colorClass}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3500">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `);
  const tEl = document.getElementById(id);
  const t = new bootstrap.Toast(tEl);
  t.show();
  tEl.addEventListener('hidden.bs.toast', ()=> tEl.remove());
}

// 活動篩選重新載入
document.getElementById('activityStatusFilter').addEventListener('change', ()=> loadActivities());
document.getElementById('activityTypeFilter').addEventListener('change', ()=> loadActivities());

// 初始化
window.addEventListener('DOMContentLoaded', ()=>{
  showLoading('初始化 LIFF...');
  initLiff();
});
 </script>
</body>
</html>
